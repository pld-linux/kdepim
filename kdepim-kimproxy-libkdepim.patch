Index: Makefile.am
===================================================================
RCS file: /home/kde/kdepim/libkdepim/Makefile.am,v
retrieving revision 1.41
diff -u -5 -d -p -r1.41 Makefile.am
--- Makefile.am	2004-05-15 19:33:07.000000000 +0200	1.41
+++ Makefile.am	2004-05-16 03:49:51.634805184 +0200
@@ -33,7 +33,7 @@
 AddressBookServiceIface_DIR = $(srcdir)/interfaces
 
 libkdepim_la_LDFLAGS = $(all_libraries) -no-undefined -version-info 1:0:0
-libkdepim_la_LIBADD  = $(LIB_KIO) $(LIB_KABC) $(LIB_KDEUI)
+libkdepim_la_LIBADD  = $(LIB_KIO) $(LIB_KABC) $(LIB_KDEUI) -lkimproxy
 #               $top_builddir)/libkdepim/resources/libkpimresources.la
 
 identitymanager_DCOPIDLNG = true
Index: addresseeview.cpp
===================================================================
RCS file: /home/kde/kdepim/libkdepim/addresseeview.cpp,v
retrieving revision 1.33
diff -u -5 -d -p -r1.34 addresseeview.cpp
--- addresseeview.cpp	2004-05-12 19:18:03.000000000 +0200	1.34
+++ addresseeview.cpp	2004-05-12 22:01:41.040586696 +0200
@@ -41,6 +41,8 @@
 #include <kstringhandler.h>
 #include <ktempfile.h>
 
+#include <kdebug.h>
+
 #include "addresseeview.h"
 
 using namespace KPIM;
@@ -48,7 +50,7 @@
 AddresseeView::AddresseeView( QWidget *parent, const char *name,
                               KConfig *config )
   : KTextBrowser( parent, name ), mDefaultConfig( false ), mImageJob( 0 ),
-    mLinkMask( AddressLinks | EmailLinks | PhoneLinks | URLLinks )
+    mLinkMask( AddressLinks | EmailLinks | PhoneLinks | URLLinks | IMLinks )
 {
   setWrapPolicy( QTextEdit::AtWordBoundary );
   setLinkUnderline( false );
@@ -87,6 +89,9 @@
     mConfig = config;
 
   load();
+  
+  mKIMProxy = new ::KIMProxy( kapp->dcopClient() );
+  //connect( mKIMProxy, SIGNAL( sigContactStatusChanged( QString ) ), this, SLOT( statusChanged( ) ) );
 }
 
 AddresseeView::~AddresseeView()
@@ -100,6 +105,8 @@
   delete mActionShowEmails;
   delete mActionShowPhones;
   delete mActionShowURLs;
+  
+  delete mKIMProxy;
 }
 
 void AddresseeView::setAddressee( const KABC::Addressee& addr )
@@ -121,10 +128,11 @@
   mLinkMask = linkMask;
 }
 
-QString AddresseeView::vCardAsHTML( const KABC::Addressee& addr, int linkMask,
+QString AddresseeView::vCardAsHTML( const KABC::Addressee& addr, ::KIMProxy *proxy, int linkMask,
                                     bool internalLoading,
                                     bool showBirthday, bool showAddresses,
-                                    bool showEmails, bool showPhones, bool showURLs )
+                                    bool showEmails, bool showPhones, bool showURLs,
+                                    bool showIMAddresses )
 {
   QString name = ( addr.formattedName().isEmpty() ?
                    addr.assembledName() : addr.formattedName() );
@@ -296,7 +304,38 @@
     name = addr.organization();
     organization = QString::null;
   }
+ 
+  if ( showIMAddresses )
+  {
+    if ( proxy->isPresent( addr.uid() ) )
+    {
+      // set image source to either a QMimeSourceFactory key or a data:/ URL
+      QString imgSrc;
+      if ( internalLoading )
+      {
+        imgSrc = QString::fromLatin1( "im_status_%1_image").arg( addr.uid() );
+        QMimeSourceFactory::defaultFactory()->setPixmap( imgSrc, proxy->presenceIcon( addr.uid() ) );
+      }
+      else
+        imgSrc = pixmapAsDataUrl( proxy->presenceIcon( addr.uid() ) );
 
+      // make the status a link, if required
+      QString imStatus;
+      if ( linkMask & IMLinks )
+        imStatus = QString::fromLatin1( "<a href=\"im:\"><img src=\"%1\"> (%2)</a>" );
+      else
+        imStatus = QString::fromLatin1( "<img src=\"%1\"> (%2)" );
+      
+      // append our status to the rest of the dynamic part of the addressee
+      dynamicPart += rowFmtStr
+              .arg( i18n( "IM Status" ) )
+              .arg( imStatus
+                        .arg( imgSrc )
+                        .arg( proxy->presenceString( addr.uid() ) )
+                  );
+    }
+  }
+   
   QString strAddr = QString::fromLatin1(
     "<div>"
     "<table width=\"100%\">"
@@ -352,7 +391,7 @@
     mImageData.truncate( 0 );
   }
 
-  QString strAddr = vCardAsHTML( mAddressee, mLinkMask, true,
+  QString strAddr = vCardAsHTML( mAddressee, mKIMProxy, mLinkMask, true,
                                  mActionShowBirthday->isChecked(),
                                  mActionShowAddresses->isChecked(),
                                  mActionShowEmails->isChecked(),
@@ -390,7 +429,7 @@
         KGlobal::iconLoader()->loadIcon( "personal", KIcon::Desktop, 128 ) );
     }
   }
-
+  
   // at last display it...
   setText( strAddr );
 }
@@ -440,6 +479,11 @@
   KRun::runCommand( commandLine );
 }
 
+void AddresseeView::imAddressClicked()
+{
+  mKIMProxy->chatWithContact( mAddressee.uid() );
+}
+
 QPopupMenu *AddresseeView::createPopupMenu( const QPoint& )
 {
   QPopupMenu *menu = new QPopupMenu( this );
@@ -465,6 +509,8 @@
     faxNumberClicked( strippedNumber( url.mid( 6 ) ) );
   else if ( url.startsWith( "addr:" ) )
     emit addressClicked( url.mid( 7 ) );
+  else if ( url.startsWith( "im:" ) )
+    imAddressClicked();
   else
     urlClicked( url );
 }
@@ -491,6 +537,9 @@
   } else if ( link.startsWith( "http:" ) || link.startsWith( "https:" ) ) {
     emit urlHighlighted( link );
     emit highlightedMessage( i18n( "Open URL %1" ).arg( link ) );
+  } else if ( link.startsWith( "im:" ) ) {
+    emit highlightedMessage( i18n( "Chat with %1" ).arg( ( mAddressee.formattedName().isEmpty() ?
+                   mAddressee.assembledName() : mAddressee.formattedName() ) ) );
   } else
     emit highlightedMessage( "" );
 }
Index: addresseeview.h
===================================================================
RCS file: /home/kde/kdepim/libkdepim/addresseeview.h,v
retrieving revision 1.11
diff -u -5 -d -p -r1.11 addresseeview.h
--- addresseeview.h	3 May 2004 20:49:24 -0000	1.11
+++ addresseeview.h	9 May 2004 16:12:41 -0000
@@ -24,24 +24,26 @@
 
 #include <qcstring.h>
 
 #include <kabc/addressee.h>
 #include <ktextbrowser.h>
+#include <kimproxy.h>
 
 namespace KIO {
 class Job;
 }
 class KToggleAction;
 
 class QPopupMenu;
 
+
 namespace KPIM {
 
+
 class AddresseeView : public KTextBrowser
 {
   Q_OBJECT
-
   public:
     /**
       Constructor.
  
       @param config The config object where the settings are stored
@@ -67,11 +69,11 @@ class AddresseeView : public KTextBrowse
 
     /**
       This enums are used by enableLinks to set which kind of links shall
       be enabled.
      */
-    enum LinkMask { AddressLinks = 1, EmailLinks = 2, PhoneLinks = 4, URLLinks = 8 };
+    enum LinkMask { AddressLinks = 1, EmailLinks = 2, PhoneLinks = 4, URLLinks = 8, IMLinks = 16 };
 
     /**
       Sets which parts of the contact shall be presented as links.
       The mask can be OR'ed LinkMask. By default all links are enabled.
      */
@@ -92,22 +94,23 @@ class AddresseeView : public KTextBrowse
                       The links looks like this:
                         "addr://<addr id>" for addresses
                         "mailto:<email address>" for emails
                         "phone://<phone number>" for phone numbers
                         "http://<url>" for urls
+                        "im:<im addrss>" for instant messaging addresses
       @param internalLoading If true, the loading of internal pictures is done automatically.
       @param showBirthday If true, the birthday is included.
       @param showAddresses If true, the addresses are included.
       @param showEmails If true, the emails are included.
       @param showPhones If true, the phone numbers are included.
       @param showURLs If true, the urls are included.
      */
-    static QString vCardAsHTML( const KABC::Addressee& addr, int linkMask = true,
+    static QString vCardAsHTML( const KABC::Addressee& addr, ::KIMProxy *proxy, int linkMask = true,
                                 bool internalLoading = true,
                                 bool showBirthday = true, bool showAddresses = true,
                                 bool showEmails = true, bool showPhones = true,
-                                bool showURLs = true );
+                                bool showURLs = true, bool showIMAddresses = true );
     /**
      * Encodes a QPixmap as a PNG into a data: URL (rfc2397), readable by the data kio protocol
      * @param pixmap the pixmap to encode
      * @return a data: URL
      */
@@ -126,11 +129,12 @@ class AddresseeView : public KTextBrowse
   protected:
     virtual void urlClicked( const QString &url );
     virtual void emailClicked( const QString &mail );
     virtual void phoneNumberClicked( const QString &number );
     virtual void faxNumberClicked( const QString &number );
-
+    virtual void imAddressClicked();
+    
     virtual QPopupMenu *createPopupMenu( const QPoint& );
 
   private slots:
     void slotMailClicked( const QString&, const QString& );
     void slotUrlClicked( const QString& );
@@ -163,10 +167,11 @@ class AddresseeView : public KTextBrowse
     KABC::Addressee mAddressee;
     int mLinkMask;
 
     class AddresseeViewPrivate;
     AddresseeViewPrivate *d;
+    ::KIMProxy *mKIMProxy;
 };
 
 }
 
 #endif
