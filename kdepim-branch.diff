Index: akregator/src/akregator.desktop
===================================================================
--- akregator/src/akregator.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ akregator/src/akregator.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -98,5 +98,5 @@
 Comment[zh_CN]=KDE RSS Êñ∞ÈóªÊî∂ÈõÜÂô®
 Comment[zh_TW]=KDE ÁöÑ RSS Êî∂ÈõÜÂô®
 Terminal=false
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;News;
 X-DCOP-ServiceType=Unique
Index: kmobile/kioslave/mimetypes/mobile_notes.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -33,7 +33,7 @@
 Comment[ms]=Nota dalam Peranti Mudah Alih
 Comment[nb]=Notater i mobil enhet
 Comment[nds]=Notizen op Mobilreedschap
-Comment[ne]=‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Ø‡§®‡•ç‡§§‡•ç‡§∞ ‡§≠‡§ø‡§§‡•ç‡§∞‡§ï‡§æ ‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø
+Comment[ne]=‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Ø‡§®‡•ç‡§§‡•ç‡§∞ ‡§≠‡§ø‡§§‡•ç‡§∞‡§ï‡§æ ‡§ü‡§ø‡§™‡•ã‡§ü
 Comment[nl]=Notities in mobiel apparaat
 Comment[nn]=Notat i mobileiningar
 Comment[pl]=Notatki w urzƒÖdzeniu przeno≈õnym
Index: wizards/groupwarewizard.desktop
===================================================================
--- wizards/groupwarewizard.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ wizards/groupwarewizard.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -48,4 +48,4 @@
 Icon=kontact
 Terminal=false
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Network;Email;
Index: wizards/kmailchanges.h
===================================================================
--- wizards/kmailchanges.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ wizards/kmailchanges.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -25,6 +25,10 @@
 #include <kconfigpropagator.h>
 #include <kconfig.h>
 
+namespace KWallet {
+  class Wallet;
+}
+
 class CreateImapAccount : public KConfigPropagator::Change
 {
   public:
@@ -73,6 +77,9 @@
     void setCustomWriter( CustomWriter * );
 
   protected:
+    bool writeToWallet( const QString &type, int id );
+
+  protected:
     QString mAccountName;
 
     QString mServer;
@@ -95,6 +102,9 @@
     int mExistingTransportId;
 
     CustomWriter *mCustomWriter;
+
+  private:
+    static KWallet::Wallet *mWallet;
 };
 
 class CreateDisconnectedImapAccount : public CreateImapAccount
Index: wizards/kmailchanges.cpp
===================================================================
--- wizards/kmailchanges.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ wizards/kmailchanges.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,6 +30,8 @@
 #include <identity.h>
 #include <kdebug.h>
 #include <kstringhandler.h>
+#include <kwallet.h>
+using namespace KWallet;
 
 static const char* s_folderContentsType[] = {
   I18N_NOOP( "Calendar" ),
@@ -38,6 +40,7 @@
   I18N_NOOP( "Tasks" ),
   I18N_NOOP( "Journal" ) };
 
+Wallet* CreateImapAccount::mWallet = 0;
 
 CreateImapAccount::CreateImapAccount( const QString &accountName, const QString &title )
   : KConfigPropagator::Change( title ),
@@ -192,7 +195,14 @@
     c.writeEntry( "use-tls", true );
   }
 
+  if ( mEnableSavePassword ) {
+    if ( !writeToWallet( "account", accountId ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "store-passwd", true );
+    }
+  }
 
+
   c.setGroup( QString("Folder-%1").arg( uid ) );
   c.writeEntry( "isOpen", true );
 
@@ -219,8 +229,10 @@
   }
   c.writeEntry( "user", mUser );
   if ( mEnableSavePassword ) {
-    c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
-    c.writeEntry( "storepass", "true" );
+    if ( !writeToWallet( "transport", transportId ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "storepass", true );
+    }
   }
 
   // Write email in "default kcontrol settings", used by IdentityManager
@@ -273,22 +285,24 @@
   c.writeEntry( "Folder", uid );
   c.writeEntry( "Id", uid );
   c.writeEntry( "Type", "imap" );
-  c.writeEntry( "auth", true );
+  c.writeEntry( "auth", "*" );
   c.writeEntry( "Name", mAccountName );
   c.writeEntry( "host", mServer );
 
   c.writeEntry( "login", mUser );
 
   if ( mEnableSavePassword ) {
-    c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
-    c.writeEntry( "store-passwd", true );
+    if ( !writeToWallet( "account", accCnt+1 ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "store-passwd", true );
+    }
   }
   c.writeEntry( "port", "993" );
 
   if ( mEncryption == SSL ) {
-    c.writeEntry( "encryption", "SSL" );
+    c.writeEntry( "use-ssl", true );
   } else if ( mEncryption == TLS ) {
-    c.writeEntry( "encryption", "TLS" );
+    c.writeEntry( "use-tls", true );
   }
 
   if ( mAuthenticationSend == PLAIN ) {
@@ -310,3 +324,22 @@
   c.setGroup( QString("Folder-%1").arg( uid ) );
   c.writeEntry( "isOpen", true );
 }
+
+bool CreateImapAccount::writeToWallet(const QString & type, int id)
+{
+  if ( !Wallet::isEnabled() )
+    return false;
+  if ( !mWallet || !mWallet->isOpen() ) {
+    delete mWallet;
+    WId window = 0;
+    if ( qApp->activeWindow() )
+      window = qApp->activeWindow()->winId();
+    mWallet = Wallet::openWallet( Wallet::NetworkWallet(), window );
+    if ( !mWallet )
+      return false;
+    if ( !mWallet->hasFolder( "kmail" ) )
+      mWallet->createFolder( "kmail" );
+    mWallet->setFolder( "kmail" );
+  }
+  return mWallet->writePassword( type + "-" + QString::number( id ), mPassword );
+}
Index: kresources/egroupware/xmlrpciface.h
===================================================================
--- kresources/egroupware/xmlrpciface.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/egroupware/xmlrpciface.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -90,8 +90,8 @@
 
       template <typename T>
       void call( const QString &method, const QValueList<T> &arg,
-        QObject* obj, const char* faultSlot,
-        QObject* obj, const char* messageSlot, const QVariant &id = QVariant() );
+        QObject* obj1, const char* faultSlot,
+        QObject* obj2, const char* messageSlot, const QVariant &id = QVariant() );
 
 
     public slots:
Index: kresources/groupwise/kabc_resourcegroupwise.cpp
===================================================================
--- kresources/groupwise/kabc_resourcegroupwise.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/groupwise/kabc_resourcegroupwise.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -648,7 +648,9 @@
       return InSync;
     }
   }
-  
+  else
+    emit loadingError( this, mServer->errorText() );
+
   if ( storedFirstSequence == 0 || storedLastSequence == 0 )
   {
     kdDebug() << "  Fallthrough - no fetched SAB exists yet, refresh" << endl;
Index: kresources/groupwise/kabc_resourcegroupwise.h
===================================================================
--- kresources/groupwise/kabc_resourcegroupwise.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/groupwise/kabc_resourcegroupwise.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -73,7 +73,7 @@
     bool asyncLoad();
     bool save( Ticket * );
     bool asyncSave( Ticket * );
-    enum SABState { Stale, InSync, RefreshNeeded };
+    enum SABState { Error, Stale, InSync, RefreshNeeded };
 
     /**
      * Clears the cached data, in memory and on disk
Index: kresources/groupwise/soap/stdsoap2.h
===================================================================
--- kresources/groupwise/soap/stdsoap2.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/groupwise/soap/stdsoap2.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -547,7 +547,7 @@
 /* Portability: define SOAP_SOCKLEN_T */
 #if defined(SOCKLEN_T)
 # define SOAP_SOCKLEN_T SOCKLEN_T
-#elif defined(__socklen_t_defined) || defined(_SOCKLEN_T) || defined(CYGWIN) || defined(FREEBSD) || defined(__FreeBSD__) || defined(__QNX__) || defined(QNX) || defined(_AIX)
+#elif defined(__socklen_t_defined) || defined(_SOCKLEN_T) || defined(CYGWIN) || defined(FREEBSD) || defined(__FreeBSD__) || defined(__QNX__) || defined(QNX) || defined(_AIX) || defined(__NetBSD__) || defined(__DragonFly__)
 # define SOAP_SOCKLEN_T socklen_t
 #elif defined(IRIX) || defined(WIN32) || defined(__APPLE__) || defined(HP_UX) || defined(SUN_OS) || defined(OPENSERVER) || defined(__osf__) || defined(VXWORKS)
 # define SOAP_SOCKLEN_T int
Index: kresources/groupwise/soap/groupwiseserver.cpp
===================================================================
--- kresources/groupwise/soap/groupwiseserver.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/groupwise/soap/groupwiseserver.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -46,6 +46,7 @@
 #include "incidenceconverter.h"
 #include "kcal_resourcegroupwise.h"
 #include "soapH.h"
+#include "stdsoap2.h"
 #include "soapGroupWiseBindingProxy.h"
 #include <stdlib.h>
 #include <stdio.h>
@@ -99,7 +100,7 @@
   return (*it)->gSoapReceiveCallback( soap, s, n );
 }
 
-int GroupwiseServer::gSoapOpen( struct soap *, const char *,
+int GroupwiseServer::gSoapOpen( struct soap *soap, const char *,
   const char *host, int port )
 {
 //  kdDebug() << "GroupwiseServer::gSoapOpen()" << endl;
@@ -124,8 +125,18 @@
   m_sock->setSocketFlags( KExtendedSocket::inetSocket );
 
   m_sock->setAddress( host, port );
-  m_sock->lookup();
-  int rc = m_sock->connect();
+  int rc = m_sock->lookup();
+  if (rc != 0 ) {
+    kdError() << "gSoapOpen: lookup of " << host << " failed " << rc << endl;
+    QString errorMessage;
+    errorMessage = QString::fromLatin1( strerror( errno ) );
+    perror( 0 );
+    soap->error = SOAP_TCP_ERROR;
+    mErrorText = i18n("Connect failed: %1.").arg( errorMessage );
+    return SOAP_INVALID_SOCKET;
+  }
+
+  rc = m_sock->connect();
   if ( rc != 0 ) {
     kdError() << "gSoapOpen: connect failed " << rc << endl;
     QString errorMessage;
@@ -133,12 +144,14 @@
       errorMessage = QString::fromLatin1( strerror( errno ) );
       perror( 0 );
     }
+	//set the soap struct's error here!
     else {
       if ( rc == -3 )
         errorMessage = QString::fromLatin1( "Connection timed out.  Check host and port number" );
     }
     mErrorText = i18n("Connect failed: %1.").arg( errorMessage );
-    return SOAP_INVALID_SOCKET;
+    soap->error =SOAP_TCP_ERROR;
+   return SOAP_INVALID_SOCKET;
   }
   m_sock->enableRead( true );
   m_sock->enableWrite( true );
@@ -165,17 +178,19 @@
    return SOAP_OK;
 }
 
-int GroupwiseServer::gSoapSendCallback( struct soap *, const char *s, size_t n )
+int GroupwiseServer::gSoapSendCallback( struct soap * soap, const char *s, size_t n )
 {
 //  kdDebug() << "GroupwiseServer::gSoapSendCallback()" << endl;
 
   if ( !m_sock ) {
     kdError() << "no open connection" << endl;
+    soap->error = SOAP_TCP_ERROR;
     return SOAP_TCP_ERROR;
   }
   if ( mError ) {
     kdError() << "SSL is in error state." << endl;
-    return SOAP_SSL_ERROR;
+     soap->error = SOAP_SSL_ERROR;
+     return SOAP_SSL_ERROR;
   }
 
   if ( getenv("DEBUG_GW_RESOURCE") ) {
@@ -194,6 +209,7 @@
     if ( ret < 0 ) {
       kdError() << "Send failed: " << strerror( m_sock->systemError() )
         << " " << m_sock->socketStatus() << " " << m_sock->fd() << endl;
+      soap->error = SOAP_TCP_ERROR;
       return SOAP_TCP_ERROR;
     }
     n -= ret;
@@ -202,6 +218,7 @@
   if ( n !=0 ) {
     kdError() << "Send failed: " << strerror( m_sock->systemError() )
       << " " << m_sock->socketStatus() << " " << m_sock->fd() << endl;
+    soap->error = SOAP_TCP_ERROR;
   }
 
   m_sock->flush();
Index: kresources/groupwise/soap/Makefile.am
===================================================================
--- kresources/groupwise/soap/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/groupwise/soap/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -11,13 +11,13 @@
                    $(top_builddir)/libkdepim/libkdepim.la
 soapdebug_SOURCES = soapdebug.cpp
 
-noinst_LTLIBRARIES = libgwsoap.la
+lib_LTLIBRARIES = libgwsoap.la
 
 libgwsoap_la_SOURCES = contactconverter.cpp gwconverter.cpp incidenceconverter.cpp \
                        groupwiseserver.cpp gwjobs.cpp ksslsocket.cpp \
                        soapC.cpp soapClient.cpp stdsoap2.cpp
-libgwsoap_la_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-libgwsoap_la_LIBADD	= -lkabc
+libgwsoap_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -no-undefined
+libgwsoap_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la
 
 # the following rule does:
 # make a header file from the wsdl
Index: kresources/kolab/kabc/resourcekolab.cpp
===================================================================
--- kresources/kolab/kabc/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kabc/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -507,7 +507,8 @@
 void KABC::ResourceKolab::fromKMailAddSubresource( const QString& type,
                                                    const QString& subResource,
                                                    const QString& label,
-                                                   bool writable )
+                                                   bool writable,
+                                                   bool )
 {
   if( type != s_kmailContentsType ) return;
 
Index: kresources/kolab/kabc/resourcekolab.h
===================================================================
--- kresources/kolab/kabc/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kabc/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -107,7 +107,8 @@
 
   // Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& id,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& id );
 
   bool fromKMailAddIncidence( const QString& type, const QString& resource,
Index: kresources/kolab/knotes/resourcekolab.cpp
===================================================================
--- kresources/kolab/knotes/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/knotes/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -328,7 +328,8 @@
 void ResourceKolab::fromKMailAddSubresource( const QString& type,
                                              const QString& subResource,
                                              const QString& mimetype,
-                                             bool writable )
+                                             bool writable,
+                                             bool /*alarmRelevant*/ )
 {
   if ( type != kmailContentsType )
     // Not ours
Index: kresources/kolab/knotes/resourcekolab.h
===================================================================
--- kresources/kolab/knotes/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/knotes/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -88,7 +88,8 @@
 
   /// Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& resource,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& resource );
 
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
Index: kresources/kolab/shared/resourcekolabbase.h
===================================================================
--- kresources/kolab/shared/resourcekolabbase.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/shared/resourcekolabbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -90,7 +90,8 @@
   virtual void fromKMailAddSubresource( const QString& type,
                                         const QString& resource,
                                         const QString& label,
-                                        bool writable ) = 0;
+                                        bool writable,
+                                        bool alarmRelevant ) = 0;
   virtual void fromKMailDelSubresource( const QString& type,
                                         const QString& resource ) = 0;
 
Index: kresources/kolab/shared/subresource.cpp
===================================================================
--- kresources/kolab/shared/subresource.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/shared/subresource.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -34,13 +34,21 @@
 
 using namespace Kolab;
 
-SubResource::SubResource( bool active, bool writable, const QString& label,
+SubResource::SubResource( bool active, bool writable, 
+                          bool alarmRelevant, const QString& label,
                           int completionWeight )
-  : mActive( active ),  mWritable( writable ), mLabel( label ),
-    mCompletionWeight( completionWeight )
+  : mActive( active ),  mWritable( writable ), mAlarmRelevant( alarmRelevant ),
+    mLabel( label ), mCompletionWeight( completionWeight )
 {
 }
 
+SubResource::SubResource( bool active, bool writable, 
+                          const QString& label, int completionWeight )
+  : mActive( active ),  mWritable( writable ), mAlarmRelevant( false ),
+    mLabel( label ), mCompletionWeight( completionWeight )
+{
+}
+
 SubResource::~SubResource()
 {
 }
@@ -55,6 +63,16 @@
   return mActive;
 }
 
+void SubResource::setAlarmRelevant( bool active )
+{
+  mAlarmRelevant = active;
+}
+
+bool SubResource::alarmRelevant() const
+{
+  return mAlarmRelevant;
+}
+
 void SubResource::setWritable( bool writable )
 {
   mWritable = writable;
Index: kresources/kolab/shared/kmailconnection.h
===================================================================
--- kresources/kolab/shared/kmailconnection.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/shared/kmailconnection.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -59,7 +59,9 @@
   void fromKMailDelIncidence( const QString& type, const QString& resource,
                               const QString& xml );
   void fromKMailRefresh( const QString& type, const QString& resource );
-  void fromKMailAddSubresource( const QString& type, const QString& resource, const QString& label );
+  void fromKMailAddSubresource( const QString& type, const QString& resource, 
+                                const QString& label, bool writable, 
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& resource );
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map, const QString& type,
                                  const QString& folder );
Index: kresources/kolab/shared/subresource.h
===================================================================
--- kresources/kolab/shared/subresource.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/shared/subresource.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -50,6 +50,9 @@
 
   SubResource( bool active, bool writable, const QString& label,
                int completionWeight = 100 );
+
+  SubResource( bool active, bool writable, bool alarmRelevant,
+               const QString& label, int completionWeight = 100 );
   virtual ~SubResource();
 
   virtual void setActive( bool active );
@@ -58,6 +61,9 @@
   virtual void setWritable( bool writable );
   virtual bool writable() const;
 
+  virtual void setAlarmRelevant( bool active );
+  virtual bool alarmRelevant() const;
+
   virtual void setLabel( const QString& label );
   virtual QString label() const;
 
@@ -67,6 +73,8 @@
 private:
   bool mActive;   // Controlled by the applications
   bool mWritable; // Set if the KMail folder is writable
+  bool mAlarmRelevant; // Set if the alarms from this resource are of 
+                      // interest to the user, as per folder acls
   QString mLabel; // The GUI name of this resource
 
   // This is just for the abc plugin. But as long as only this is here,
Index: kresources/kolab/shared/kmailconnection.cpp
===================================================================
--- kresources/kolab/shared/kmailconnection.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/shared/kmailconnection.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -98,8 +98,8 @@
     if ( !connectKMailSignal( "signalRefresh(QString,QString)",
                               "fromKMailRefresh(QString,QString)" ) )
       kdError(5650) << "DCOP connection to signalRefresh failed" << endl;
-    if ( !connectKMailSignal( "subresourceAdded( QString, QString, QString )",
-                              "fromKMailAddSubresource( QString, QString, QString )" ) )
+    if ( !connectKMailSignal( "subresourceAdded( QString, QString, QString, bool, bool )",
+                              "fromKMailAddSubresource( QString, QString, QString, bool, bool )" ) )
       kdError(5650) << "DCOP connection to subresourceAdded failed" << endl;
     if ( !connectKMailSignal( "subresourceDeleted(QString,QString)",
                               "fromKMailDelSubresource(QString,QString)" ) )
@@ -144,17 +144,14 @@
 
 void KMailConnection::fromKMailAddSubresource( const QString& type,
                                                const QString& resource,
-                                               const QString& label )
+                                               const QString& label,
+                                               bool writable,
+                                               bool alarmRelevant )
 {
 //   kdDebug(5650) << "KMailConnection::fromKMailAddSubresource( " << type << ", "
 //                 << resource << " )\n";
-  bool writable = true;
-
-  // TODO: This should be told by KMail right away
-  if ( connectToKMail() )
-    writable = mKMailIcalIfaceStub->isWritableFolder( type, resource );
-
-  mResource->fromKMailAddSubresource( type, resource, label, writable );
+  mResource->fromKMailAddSubresource( type, resource, label, 
+                                      writable, alarmRelevant );
 }
 
 void KMailConnection::fromKMailDelSubresource( const QString& type,
Index: kresources/kolab/kcal/resourcekolab.cpp
===================================================================
--- kresources/kolab/kcal/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kcal/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -67,7 +67,8 @@
 
 ResourceKolab::ResourceKolab( const KConfig *config )
   : ResourceCalendar( config ), ResourceKolabBase( "ResourceKolab-libkcal" ),
-    mCalendar( QString::fromLatin1("UTC") ), mOpen( false )
+    mCalendar( QString::fromLatin1("UTC") ), mOpen( false ),mResourceChangedTimer( 0,
+        "mResourceChangedTimer" )
 {
   setType( "imap" );
   connect( &mResourceChangedTimer, SIGNAL( timeout() ),
@@ -87,11 +88,13 @@
                                            const QString& name,
                                            const QString& label,
                                            bool writable,
+                                           bool alarmRelevant,
                                            ResourceMap& subResource )
 {
   KConfigGroup group( &config, name );
   bool active = group.readBoolEntry( "Active", true );
-  subResource.insert( name, Kolab::SubResource( active, writable, label ) );
+  subResource.insert( name, Kolab::SubResource( active, writable,
+                                                alarmRelevant, label ) );
 }
 
 bool ResourceKolab::openResource( KConfig& config, const char* contentType,
@@ -104,7 +107,8 @@
   map.clear();
   QValueList<KMailICalIface::SubResource>::ConstIterator it;
   for ( it = subResources.begin(); it != subResources.end(); ++it )
-    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, map );
+    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, 
+                           (*it).alarmRelevant, map );
   return true;
 }
 
@@ -492,12 +496,12 @@
       }
     }
   } else { /* KMail told us */
-    bool ourOwnUpdate = false;
+    bool ourOwnUpdate = mUidsPendingUpdate.contains(  uid );
     /* Check if we updated this one, which means kmail deleted and added it.
      * We know the new state, so lets just not do much at all. The old incidence
      * in the calendar remains valid, but the serial number changed, so we need to
      * update that */
-    if ( ourOwnUpdate = mUidsPendingUpdate.contains( uid ) ) {
+    if ( ourOwnUpdate ) {
       mUidsPendingUpdate.remove( uid );
       mUidMap.remove( uid );
       mUidMap[ uid ] = StorageReference( subResource, sernum );
@@ -697,15 +701,41 @@
   return mCalendar.rawJournalsForDate( date );
 }
 
+KCal::Alarm::List ResourceKolab::relevantAlarms( const KCal::Alarm::List &alarms )
+{
+  KCal::Alarm::List relevantAlarms;
+  KCal::Alarm::List::ConstIterator it( alarms.begin() );
+  while ( it != alarms.end() ) {
+    KCal::Alarm *a = (*it);
+    ++it;
+    const QString &uid = a->parent()->uid();
+     if ( mUidMap.contains( uid ) ) {
+       const QString &sr = mUidMap[ uid ].resource();
+       Kolab::SubResource *subResource = 0;
+       if ( mEventSubResources.contains( sr ) )
+          subResource = &( mEventSubResources[ sr ] );
+       else if ( mTodoSubResources.contains( sr ) )
+          subResource = &( mTodoSubResources[ sr ] );
+       assert( subResource );
+       if ( subResource->alarmRelevant() )
+           relevantAlarms.append ( a );
+       else {
+         kdDebug(5650) << "Alarm skipped, not relevant." << endl;
+       }
+     }
+  }
+  return relevantAlarms;
+}
+
 KCal::Alarm::List ResourceKolab::alarms( const QDateTime& from,
                                          const QDateTime& to )
 {
-  return mCalendar.alarms( from, to );
+  return relevantAlarms( mCalendar.alarms( from, to ) );
 }
 
 KCal::Alarm::List ResourceKolab::alarmsTo( const QDateTime& to )
 {
-  return mCalendar.alarmsTo(to);
+  return relevantAlarms( mCalendar.alarmsTo(to) );
 }
 
 void ResourceKolab::setTimeZoneId( const QString& tzid )
@@ -794,7 +824,7 @@
 void ResourceKolab::fromKMailAddSubresource( const QString& type,
                                              const QString& subResource,
                                              const QString& label,
-                                             bool writable )
+                                             bool writable, bool alarmRelevant )
 {
   ResourceMap* map = 0;
   const char* mimetype = 0;
@@ -819,7 +849,8 @@
   config.setGroup( subResource );
 
   bool active = config.readBoolEntry( subResource, true );
-  (*map)[ subResource ] = Kolab::SubResource( active, writable, label );
+  (*map)[ subResource ] = Kolab::SubResource( active, writable, 
+                                              alarmRelevant, label );
   loadSubResource( subResource, mimetype );
   emit signalSubresourceAdded( this, type, subResource, label );
 }
Index: kresources/kolab/kcal/incidence.cpp
===================================================================
--- kresources/kolab/kcal/incidence.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -42,12 +42,10 @@
 using namespace Kolab;
 
 
-Incidence::Incidence( const QString& tz, KCal::Incidence* incidence )
+Incidence::Incidence( const QString& tz )
   : KolabBase( tz ), mFloatingStatus( Unset ), mHasAlarm( false ),
     mRevision( 0 )
 {
-  if ( incidence )
-    setFields( incidence );
 }
 
 Incidence::~Incidence()
Index: kresources/kolab/kcal/resourcekolab.h
===================================================================
--- kresources/kolab/kcal/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kcal/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -110,7 +110,8 @@
 
   /// Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& subResource,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& subResource );
 
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
@@ -136,6 +137,12 @@
   void useGlobalMode();
 protected slots:
    void slotEmitResourceChanged();
+protected:
+  /** 
+   * Return list of alarms which are relevant for the current user. These
+   * are the ones coming from folders which the user has "Administer" rights
+   * for, as per ACL */
+  KCal::Alarm::List relevantAlarms( const KCal::Alarm::List &alarms );
 
 private:
   void removeIncidences( const QCString& incidenceType );
@@ -167,7 +174,7 @@
                      Kolab::ResourceMap& map );
   void loadSubResourceConfig( KConfig& config, const QString& name,
                               const QString& label, bool writable,
-                              Kolab::ResourceMap& subResource );
+                              bool alarmRelevant, Kolab::ResourceMap& subResource );
   bool loadSubResource( const QString& subResource, const char* mimetype );
 
   QString configFile() const {
Index: kresources/kolab/kcal/incidence.h
===================================================================
--- kresources/kolab/kcal/incidence.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/kolab/kcal/incidence.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -73,7 +73,10 @@
     QString role;
   };
 
-  explicit Incidence( const QString& tz, KCal::Incidence* incidence = 0 );
+protected:
+  explicit Incidence( const QString& tz );
+
+public:
   virtual ~Incidence();
 
   void saveTo( KCal::Incidence* incidence );
Index: kresources/birthdays/resourcekabc.cpp
===================================================================
--- kresources/birthdays/resourcekabc.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kresources/birthdays/resourcekabc.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -200,8 +200,8 @@
         Alarm* vAlarm = ev->newAlarm();
         vAlarm->setText(summary);
         vAlarm->setTime(birthdate);
-        // 24 hours before
-        vAlarm->setStartOffset( -1440 * mAlarmDays );
+        // 24 hours before. duration is in seconds.
+        vAlarm->setStartOffset( -86400 * mAlarmDays );
         vAlarm->setEnabled(true);
       }
 
@@ -305,8 +305,8 @@
       Alarm* vAlarm = ev->newAlarm();
       vAlarm->setText(summary);
       vAlarm->setTime(anniversary);
-      // 24 hours before
-      vAlarm->setStartOffset( -1440 * mAlarmDays );
+      // 24 hours before. duration is in seconds.
+      vAlarm->setStartOffset( -86400 * mAlarmDays );
       vAlarm->setEnabled(true);
     }
 
Index: certmanager/kleopatra_import.desktop
===================================================================
--- certmanager/kleopatra_import.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ certmanager/kleopatra_import.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -9,6 +9,6 @@
 Exec=kleopatra --import-certificate %u
 #Icon=kleopatra
 NoDisplay=true
-MimeType=application/pkcs7-mime;application/x-x509-ca-cert;application/x-pkcs12
+MimeType=application/pkcs7-mime;application/x-x509-ca-cert;application/x-pkcs12;
 
 X-KDE-StartupNotify=true
Index: certmanager/certificateinfowidgetimpl.cpp
===================================================================
--- certmanager/certificateinfowidgetimpl.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ certmanager/certificateinfowidgetimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -267,6 +267,7 @@
   if ( !proc->start( KProcess::NotifyOnExit, (KProcess::Communication)(KProcess::Stdout | KProcess::Stderr) ) ) {
     QString wmsg = i18n("Failed to execute gpgsm:\n%1").arg( i18n( "program not found" ) );
     dumpView->setText( wmsg );
+    delete proc;
   }
 }
 
Index: certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -306,7 +306,7 @@
   }
   else if( rc != 0 ) // Happens due to bugs in gpgconf (e.g. issues 104/115)
   {
-    QString wmsg = i18n( "Error from gpgconf while saving configuration: %1" ).arg( strerror( rc ) );
+    QString wmsg = i18n( "Error from gpgconf while saving configuration: %1" ).arg( QString::fromLocal8Bit( strerror( rc ) ) );
     kdWarning(5150) << k_funcinfo << ":" << strerror( rc ) << endl;
     KMessageBox::error(0, wmsg);
   }
Index: certmanager/lib/ui/dnattributeorderconfigwidget.cpp
===================================================================
--- certmanager/lib/ui/dnattributeorderconfigwidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ certmanager/lib/ui/dnattributeorderconfigwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -105,9 +105,9 @@
   d->currentLV->setSorting( -1 );
   glay->addWidget( d->currentLV, row, 2 );
 
-  connect( d->availableLV, SIGNAL(selectionChanged(QListViewItem*)),
+  connect( d->availableLV, SIGNAL(clicked( QListViewItem * )),
 	   SLOT(slotAvailableSelectionChanged(QListViewItem*)) );
-  connect( d->currentLV, SIGNAL(selectionChanged(QListViewItem*)),
+  connect( d->currentLV, SIGNAL(clicked(QListViewItem*)),
 	   SLOT(slotCurrentOrderSelectionChanged(QListViewItem*)) );
 
   d->placeHolderItem = new QListViewItem( d->availableLV, "_X_", i18n("All others") );
Index: libkpgp/kpgpui.cpp
===================================================================
--- libkpgp/kpgpui.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkpgp/kpgpui.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -304,8 +304,8 @@
 
   resize( dialogSize );
 
-  mCheckSelectionTimer = new QTimer( this );
-  mStartSearchTimer = new QTimer( this );
+  mCheckSelectionTimer = new QTimer( this, "mCheckSelectionTimer" );
+  mStartSearchTimer = new QTimer( this, "mStartSearchTimer" );
 
   // load the key status icons
   mKeyGoodPix    = new QPixmap( UserIcon("key_ok") );
Index: libkmime/boolflags.cpp
===================================================================
--- libkmime/boolflags.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkmime/boolflags.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -28,7 +28,7 @@
     n=0;
   }
   else { //second byte
-    p=(1 << i-8);
+    p=(1 << ( i-8 ));
     n=1;
   }
 
Index: karm/ktimewidget.cpp
===================================================================
--- karm/ktimewidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ karm/ktimewidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,9 +30,6 @@
       if ( ! ok )
         return Invalid;
 
-      if ( str.contains('-') != 0 )
-        return Invalid;
-
       if ( _tp==MINUTE && val >= 60  )
         return Invalid;
       else
Index: karm/support/karm.desktop
===================================================================
--- karm/support/karm.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ karm/support/karm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -77,4 +77,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Multi
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Calendar;
Index: libkpimexchange/core/exchangemonitor.cpp
===================================================================
--- libkpimexchange/core/exchangemonitor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkpimexchange/core/exchangemonitor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -109,12 +109,12 @@
   }
 
   if ( mPollMode == Poll ) {
-    mPollTimer = new QTimer( this );
+    mPollTimer = new QTimer( this, "mPollTimer" );
     connect( mPollTimer, SIGNAL(timeout()), this, SLOT(slotPollTimer()) );
     mPollTimer->start( 60000 ); // 1 minute timer
   }
 
-  mRenewTimer = new QTimer( this );
+  mRenewTimer = new QTimer( this, "mRenewTimer" );
   connect( mRenewTimer, SIGNAL(timeout()), this, SLOT(slotRenewTimer()) );
   mRenewTimer->start( mSubscriptionLifetime * 900 ); // 10% early so as to be in time
 }
Index: kdgantt/KDGanttView.cpp
===================================================================
--- kdgantt/KDGanttView.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kdgantt/KDGanttView.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 Klar‰lvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -104,7 +104,6 @@
 
     connect( myListView, SIGNAL( mouseButtonClicked ( int, QListViewItem * , const QPoint &, int ) ), this, SLOT( slotmouseButtonClicked ( int , QListViewItem * , const QPoint &, int ) ) );
     connect( myListView, SIGNAL( contextMenuRequested ( QListViewItem * , const QPoint &, int  ) ), this, SLOT( slotcontextMenuRequested ( QListViewItem * , const QPoint & , int ) ) );
-    connect( myListView, SIGNAL(doubleClicked ( QListViewItem *  ) ), this, SLOT(slotdoubleClicked ( QListViewItem * ) ) );
 
   connect( myListView, SIGNAL(currentChanged( QListViewItem *  ) ), this, SLOT(slotCurrentChanged ( QListViewItem * ) ) );
   connect( myListView, SIGNAL(itemRenamed ( QListViewItem * , int , const QString &  ) ), this, SLOT(slotItemRenamed ( QListViewItem *, int , const QString &  ) ) );
@@ -486,19 +485,6 @@
 
 
 /*
-  Implements a casted pass-through of the doubleClicked() signal.
-*/
-void KDGanttView::slotdoubleClicked ( QListViewItem * item )
-{
-   {
-    KDGanttViewItem* gItem = static_cast<KDGanttViewItem*>( item );
-    emit lvItemDoubleClicked( gItem );
-    emit itemDoubleClicked( gItem );
-  }
-}
-
-
-/*
   Implements a casted pass-through of the currentChanged() signal.
 */
 void KDGanttView::slotCurrentChanged ( QListViewItem * item )
Index: kdgantt/KDGanttViewSubwidgets.cpp
===================================================================
--- kdgantt/KDGanttViewSubwidgets.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kdgantt/KDGanttViewSubwidgets.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -58,7 +58,8 @@
 #include <kcalendarsystem.h>
 #include <kdebug.h>
 
-KDTimeTableWidget:: KDTimeTableWidget( QWidget* parent,KDGanttView* myGantt):QCanvas (parent)
+KDTimeTableWidget:: KDTimeTableWidget( QWidget* parent,KDGanttView* myGantt)
+    : QCanvas (parent)
 {
     myGanttView = myGantt;
     taskLinksVisible = true;
@@ -3163,7 +3164,8 @@
 
 
 
-KDGanttCanvasView::KDGanttCanvasView( KDGanttView* sender,QCanvas* canvas, QWidget* parent,  const char* name ) : QCanvasView ( canvas, parent, name )
+KDGanttCanvasView::KDGanttCanvasView( KDGanttView* sender,QCanvas* canvas, QWidget* parent,  const
+    char* name ) : QCanvasView ( canvas, parent, name ), scrollBarTimer( 0, "scrollBarTimer" )
 {
     setHScrollBarMode (QScrollView::AlwaysOn );
     setVScrollBarMode( QScrollView::AlwaysOn );
@@ -3228,7 +3230,7 @@
     // If they needed a scrollbar timer in scrollview...
     connect( &scrollBarTimer, SIGNAL(timeout()), this, SLOT(myUpdateScrollBars() ) );
     
-    myScrollTimer = new QTimer( this );
+    myScrollTimer = new QTimer( this, "myScrollTimer" );
     connect( myScrollTimer, SIGNAL( timeout() ), SLOT( slotScrollTimer() ) );
     autoScrollEnabled = false;
 }
Index: kdgantt/KDGanttView.h
===================================================================
--- kdgantt/KDGanttView.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kdgantt/KDGanttView.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2001-2004 Klar‰lvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Kl√§rlvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -400,7 +400,6 @@
   void slotMouseButtonPressed (  int button, QListViewItem * item, const QPoint & pos, int c );
     void slotmouseButtonClicked ( int button, QListViewItem * item, const QPoint & pos, int c );
     void slotcontextMenuRequested ( QListViewItem * item, const QPoint & pos, int col );
-    void slotdoubleClicked ( QListViewItem * item );
     void slotHeaderSizeChanged();
     void addTickRight();
     void addTickLeft();
Index: kmail/kmfoldersearch.h
===================================================================
--- kmail/kmfoldersearch.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldersearch.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -173,7 +173,7 @@
   virtual int open(const char *owner);
   virtual int canAccess();
   virtual void sync();
-  virtual void close(const char *owner, bool force=FALSE);
+  virtual void reallyDoClose(const char *owner);
   virtual int create();
   virtual int compact( bool );
   virtual bool isReadOnly() const;
Index: kmail/folderstorage.h
===================================================================
--- kmail/folderstorage.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/folderstorage.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -256,7 +256,8 @@
 
   /** Close folder. If force is TRUE the files are closed even if
     others still use it (e.g. other mail reader windows). */
-  virtual void close(const char * owner,bool force=FALSE) = 0;
+  void close(const char * owner, bool force=FALSE);
+  virtual void reallyDoClose(const char * owner) = 0;
 
   /** Try releasing @p folder if possible, something is attempting an exclusive access to it.
       Currently used for KMFolderSearch and the background tasks like expiry. */
Index: kmail/kmail.antispamrc
===================================================================
--- kmail/kmail.antispamrc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmail.antispamrc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -22,8 +22,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #2]
 Ident=bogofilter
@@ -141,8 +141,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #8]
 Ident=spamassassin
@@ -165,8 +165,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #9]
 Ident=bsfilter
@@ -229,4 +229,9 @@
 UseRegExp=0
 SupportsBayes=1
 SupportsUnsure=1
+ScoreName=CRM114
+ScoreHeader=X-CRM114-Status
+ScoreType=Bool
+ScoreValueRegexp=SPAM
+ScoreThresholdRegexp=
 
Index: kmail/expirejob.cpp
===================================================================
--- kmail/expirejob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/expirejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -125,7 +125,7 @@
     const KMMsgBase *mb = storage->getMsgBase( mCurrentIndex );
     if (mb == 0)
       continue;
-    if ( ( mb->isImportant() || mb->isTodo() )
+    if ( ( mb->isImportant() || mb->isTodo() || mb->isWatched() )
       && GlobalSettings::self()->excludeImportantMailFromExpiry() )
        continue;
 
Index: kmail/imapaccountbase.cpp
===================================================================
--- kmail/imapaccountbase.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/imapaccountbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -81,6 +81,8 @@
 
   ImapAccountBase::ImapAccountBase( AccountManager * parent, const QString & name, uint id )
     : NetworkAccount( parent, name, id ),
+      mIdleTimer( 0, "mIdleTimer" ),
+      mNoopTimer( 0, "mNoopTimer" ),
       mTotal( 0 ),
       mCountUnread( 0 ),
       mCountLastUnread( 0 ),
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -52,6 +52,7 @@
 #include "accountmanager.h"
 #include "kmfoldercachedimap.h"
 #include "kmacctcachedimap.h"
+#include "acljobs.h"
 
 #include <mimelib/enum.h>
 #include <mimelib/utility.h>
@@ -412,8 +413,8 @@
        && itmime != attachmentMimetypes.end()
        && iturl != attachmentURLs.end();
        ++itname, ++iturl, ++itmime ){
-    bool bymimetype = (*itmime).startsWith( "application/x-vnd.kolab." );
-    if( !updateAttachment( *msg, *iturl, *itname, *itmime, !bymimetype ) ){
+    bool byname = !(*itmime).startsWith( "application/x-vnd.kolab." );
+    if( !updateAttachment( *msg, *iturl, *itname, *itmime, byname ) ){
       kdWarning(5006) << "Attachment error, can not add Incidence." << endl;
       bAttachOK = false;
       break;
@@ -473,6 +474,8 @@
 int KMailICalIfaceImpl::incidencesKolabCount( const QString& mimetype,
                                               const QString& resource )
 {
+  Q_UNUSED( mimetype ); // honouring that would be too slow...
+
   if( !mUseResourceIMAP )
     return 0;
 
@@ -485,7 +488,7 @@
   f->open("kolabcount");
   int n = f->count();
   f->close("kolabcount");
-  kdDebug(5006) << "KMailICalIfaceImpl::incidencesKolabCount( " << mimetype << ", "
+  kdDebug(5006) << "KMailICalIfaceImpl::incidencesKolabCount( "
                 << resource << " ) returned " << n << endl;
   return n;
 }
@@ -610,7 +613,8 @@
   // Add the default one
   KMFolder* f = folderFromType( contentsType, QString::null );
   if ( f ) {
-    subResources.append( SubResource( f->location(),  f->prettyURL(), !f->isReadOnly() ) );
+    subResources.append( SubResource( f->location(),  f->prettyURL(),
+                                      !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
     kdDebug(5006) << "Adding(1) folder " << f->location() << "    " <<
       ( f->isReadOnly() ? "readonly" : "" ) << endl;
   }
@@ -621,7 +625,8 @@
   for ( ; it.current(); ++it ){
     f = it.current()->folder;
     if ( f && f->storage()->contentsType() == t ) {
-      subResources.append( SubResource( f->location(), f->prettyURL(), !f->isReadOnly() ) );
+      subResources.append( SubResource( f->location(), f->prettyURL(),
+                                        !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
       kdDebug(5006) << "Adding(2) folder " << f->location() << "     " <<
               ( f->isReadOnly() ? "readonly" : "" ) << endl;
     }
@@ -779,8 +784,8 @@
           && itmime != attachmentMimetypes.end()
           && itname != attachmentNames.end();
           ++iturl, ++itname, ++itmime ){
-        bool bymimetype = (*itname).startsWith( "application/x-vnd.kolab." );
-        if( !updateAttachment( *newMsg, *iturl, *itname, *itmime, bymimetype ) ){
+        bool byname = !(*itmime).startsWith( "application/x-vnd.kolab." );
+        if( !updateAttachment( *newMsg, *iturl, *itname, *itmime, byname ) ){
           kdDebug(5006) << "Attachment error, can not update attachment " << *iturl << endl;
           break;
         }
@@ -1258,7 +1263,8 @@
     connectFolder( folder );
   }
   // Tell about the new resource
-  subresourceAdded( folderContentsType( contentsType ), location, folder->prettyURL() );
+  subresourceAdded( folderContentsType( contentsType ), location, folder->prettyURL(),
+                    !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 }
 
 KMFolder* KMailICalIfaceImpl::extraFolder( const QString& type,
@@ -1402,8 +1408,8 @@
     const QString contentsTypeStr = folderContentsType( folder->storage()->contentsType() );
     subresourceDeleted( contentsTypeStr, location );
 
-    subresourceAdded( contentsTypeStr, location, folder->prettyURL()  /*,
-                      !folder->isReadOnly() , folderIsAlarmRelevant( folder ) TODO */ );
+    subresourceAdded( contentsTypeStr, location, folder->prettyURL(),
+                      !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 
   }
 }
@@ -1642,11 +1648,11 @@
 
   // END TILL TODO
 
-  subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label() );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label(), true, true );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label(), true, true );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label(), true, false );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label(), true, false );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label(), true, false );
 
   reloadFolderTree();
 }
@@ -1870,6 +1876,36 @@
   }
 }
 
+/* We treat all folders as relevant wrt alarms for which we have Administer
+ * rights or for which the "Incidences relevant for everyone" annotation has
+ * been set. It can be reasonably assumed that those are "ours". All local folders
+ * must be ours anyhow. */
+bool KMailICalIfaceImpl::folderIsAlarmRelevant( const KMFolder *folder )
+{
+  bool administerRights = true;
+  bool relevantForOwner = true;
+  bool relevantForEveryone = false;
+  if ( folder->folderType() == KMFolderTypeImap ) {
+    const KMFolderImap *imapFolder = static_cast<const KMFolderImap*>( folder->storage() );
+    administerRights =
+      imapFolder->userRights() <= 0 || imapFolder->userRights() & KMail::ACLJobs::Administer;
+  }
+  if ( folder->folderType() == KMFolderTypeCachedImap ) {
+    const KMFolderCachedImap *dimapFolder = static_cast<const KMFolderCachedImap*>( folder->storage() );
+    administerRights =
+      dimapFolder->userRights() <= 0 || dimapFolder->userRights() & KMail::ACLJobs::Administer;
+    relevantForOwner = dimapFolder->incidencesFor () == KMFolderCachedImap::IncForAdmins;
+    relevantForEveryone = ( dimapFolder->incidencesFor() == KMFolderCachedImap::IncForReaders );
+  }
+#if 0
+  kdDebug(5006) << k_funcinfo << endl;
+  kdDebug(5006) << "Folder: " << folder->label() << " has administer rights: " << administerRights << endl;
+  kdDebug(5006) << "and is relevant for owner: " << relevantForOwner <<  endl;
+  kdDebug(5006) << "and relevant for everyone: "  << relevantForEveryone << endl;
+#endif
+  return ( administerRights && relevantForOwner ) || relevantForEveryone;
+}
+
 void KMailICalIfaceImpl::setResourceQuiet(bool q)
 {
   mResourceQuiet = q;
Index: kmail/kmheaders.cpp
===================================================================
--- kmail/kmheaders.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmheaders.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -2077,7 +2077,9 @@
 void KMHeaders::resetCurrentTime()
 {
     mDate.reset();
-    QTimer::singleShot( 1000, this, SLOT( resetCurrentTime() ) );
+    // only reset exactly during minute switch
+    QTimer::singleShot( ( 60-QTime::currentTime().second() ) * 1000, 
+        this, SLOT( resetCurrentTime() ) );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/khtmlparthtmlwriter.cpp
===================================================================
--- kmail/khtmlparthtmlwriter.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/khtmlparthtmlwriter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -49,7 +49,7 @@
   KHtmlPartHtmlWriter::KHtmlPartHtmlWriter( KHTMLPart * part,
 					    QObject * parent, const char * name )
     : QObject( parent, name ), HtmlWriter(),
-      mHtmlPart( part ), mState( Ended )
+      mHtmlPart( part ), mState( Ended ), mHtmlTimer( 0, "mHtmlTimer" )
   {
     assert( part );
     connect( &mHtmlTimer, SIGNAL(timeout()), SLOT(slotWriteNextHtmlChunk()) );
Index: kmail/kmail.antispamrc-HOWTO
===================================================================
--- kmail/kmail.antispamrc-HOWTO	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kmail/kmail.antispamrc-HOWTO	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,154 @@
+
+HOWTO for setting up a KMail antispam wizard configuration entry
+================================================================
+
+This is a HOWTO for setting up a KMail antispam wizard configuration
+entry. Since this possibly is more developer related, I put this as
+text file into the source SVN. Possibly some of this should go to the
+user documentation.
+
+I gathered the information from several mails and comments by Andreas
+Gungl, the original developer of the antispam wizard for KMail, and
+Ingo Kloecker.
+
+When you have questions do not hesitate to ask me, Martin Steigerwald, 
+Andreas or Ingo.
+
+
+Basics
+------
+
+The configuration file for the KMail antispam wizard "kmail.antispamrc"
+consists of one entry for each spamfilter that the antispam wizard
+shall support.
+
+At the beginning of the file in the section "General" the option "tools" 
+specifies the count of configured spam filters. Increase that by one 
+when you add a new entry:
+
+[General]
+tools=11
+
+
+A spam filter configuration entry starts with a header like this:
+
+[Spamtool #11]
+
+
+After this you place all the options for the spam filter. Please use
+an ordering that is similar to the other entries in the configuration
+file so that things are unified a bit.
+
+
+General options
+---------------
+
+- Ident: Specifies the internal identifier for the entry
+
+- Version: Specifies the version of the entry (FIXME what is this for?)
+
+- Priority: Specifies the priority of the filter. This value is used to
+  place faster filters before the slower ones in the selection list. If the
+  user chooses the top item, he gets the fastest filter. Provider sided
+  "filters" (which produce headers tough) like the GMX filter have a prio
+  at about 70, they are very fast as they don't consume time on the client
+  side. Since CRM114 is almost as fast it gets 65 ;-).
+
+- VisibleName: This is the name that is presented to the user
+
+Or:
+
+- HeadersOnly=yes: This is used for entries where KMail should just parse
+  the mail headers for the spam score display (see Razor filter and below
+  for spam score display details).
+
+
+Spam filter options
+-------------------
+
+These specify details about the spamfilter.
+
+- Executable: Specifies a test whether the executable of the spamfilter
+  can be started. You should provide something which can be run on the
+  command line and returns [ $? -eq 0 ], i.e. it doesn't wait for any input 
+  etc. It usually make sense to assume the program in the $PATH, so you
+  should better avoid /usr/bin. Set executable to "echo" for provider based 
+  filters.
+  Example: Executable=crm -v | grep "CRM114"
+
+- URL: URL to the homepage of the filter
+
+- PipeFilterName: Name of the pipe-through filter used to send mails to the
+  spamfilter and get them back with added spam filter headers.
+
+- PipeCmdDetect: Command used to pipe the mail into.
+
+- ExecCmdSpam: Command used to mark a mail as spam.
+
+- ExecCmdHam: Command used to mark a mail as ham.
+
+- SupportsBayes: Set to 1 if you have a spam filter that can learn. Only
+  in this case KMail uses ExecCmdSpam and ExecCmdHam to let the user mark
+  mail as ham or spam.
+
+
+Spam detection options
+----------------------
+
+These specify how KMail shall detect whether a mail is spam, unsure or good.
+
+- DetectionHeader: The name of the header where the spam filter puts the spam
+  status of a mail into.
+
+- DetectionPattern: The pattern the spam filter uses for marking a mail as
+  spam.
+
+- DetectionPattern2: The pattern the spam filter uses for marking a mail as
+  unsure. Set "SupportsUnsure=1" when you use this.
+
+- DetectionOnly: Don't pipe mails through the spam filter, but just use headers
+  from outside, e.g. a provider based spam filter (See GMX).
+
+- UseRegExp: Set to 1 if you need to use regular expressions in the detection
+  patterns. KMail can operate faster when they are not required.
+
+- SupportsUnsure: Set to 1 if you have a spam filter that supports
+  classying mails as unsure to tell the user to train those.
+
+
+Spam score display
+------------------
+
+Those regular expressions are used to extract the actual "spamicity" 
+score and the threshold (i.e. the upper bound for non-spam) from 
+SpamAssassin's ScoreHeader. The score and the threshold are then used 
+for showing the spam status in the message header, i.e. the small 
+colorbar.
+
+You need to specify the following values:
+
+- ScoreName: The name that will be shown in the message header.
+
+- ScoreHeader: The message header containing the score value.
+
+- ScoreType: The type of the score, cf. below.
+
+- ScoreValueRegexp: A regular expression for extracting the score from 
+  the ScoreHeader.
+
+- ScoreThresholdRegexp: A regular expression for extracting the threshold 
+  from the ScoreHeader; only needed for Adjusted type. Please set to 
+  nothing (ScoreThresholdRegexp=) if not needed.
+
+
+KMail supports the following ScoreType values:
+
+- Bool: Simple Yes or No (Razor)
+
+- Decimal: For probability between 0.0 and 1.0 (BogoFilter)
+
+- Percentage: For straight percentages between 0.0 and 100.0
+
+- Adjusted: Use this when we need to compare against a threshold
+  (SpamAssasssin)
+
Index: kmail/bodyvisitor.cpp
===================================================================
--- kmail/bodyvisitor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/bodyvisitor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -45,6 +45,7 @@
     mBasicList += "APPLICATION/PKCS7-SIGNATURE";
     // groupware
     mBasicList += "APPLICATION/MS-TNEF";
+    mBasicList += "TEXT/CALENDAR";
   }
 
   //-----------------------------------------------------------------------------
@@ -75,7 +76,7 @@
     {
       ++it;
       // skip this part if the parent part is already loading
-      if ( part->parent() && 
+      if ( part->parent() &&
            selected.contains( part->parent() ) &&
            part->loadPart() )
         continue;
@@ -91,7 +92,7 @@
         selected.append( fake );
         break;
       }
-        
+
       if ( headerCheck && !part->partSpecifier().endsWith(".HEADER") )
       {
         // this is an embedded simple message (not multipart) so we get no header part
@@ -102,15 +103,15 @@
         fake->setPartSpecifier( partId );
         fake->setOriginalContentTypeStr("");
         fake->setLoadPart( true );
-        if ( addPartToList( fake ) ) 
+        if ( addPartToList( fake ) )
           selected.append( fake );
       }
-      
+
       if ( part->originalContentTypeStr() == "MESSAGE/RFC822" )
         headerCheck = true;
       else
         headerCheck = false;
-      
+
       // check whether to load this part or not:
       // look at the basic list, ask the subclass and check the parent
       if ( mBasicList.contains( part->originalContentTypeStr() ) ||
@@ -127,7 +128,7 @@
       if ( !part->partSpecifier().endsWith(".HEADER") &&
            part->typeStr() != "MULTIPART" )
         part->setLoadHeaders( true ); // load MIME header
-      
+
       if ( part->loadHeaders() || part->loadPart() )
         selected.append( part );
     }
@@ -205,5 +206,5 @@
 
     return false;
   }
-  
+
 }
Index: kmail/kmailicalIface.h
===================================================================
--- kmail/kmailicalIface.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmailicalIface.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -51,11 +51,12 @@
   struct SubResource {
     //dcopidl barfs on those constructors, but dcopidlng works
     SubResource() {} // for QValueList
-    SubResource( const QString& loc, const QString& lab, bool rw )
-      : location( loc ), label( lab ), writable( rw ) {}
+    SubResource( const QString& loc, const QString& lab, bool rw, bool ar )
+      : location( loc ), label( lab ), writable( rw ), alarmRelevant( ar ) {}
     QString location; // unique
     QString label;    // shown to the user
     bool writable;
+    bool alarmRelevant;
   };
 
   /// The format of the mails containing other contents than actual mail
@@ -94,7 +95,7 @@
 
   /// Return the number of mails that need to be looked at by incidencesKolab.
   /// This allows to call incidencesKolab in chunks.
-  virtual int incidencesKolabCount( const QString& mimetype,
+  virtual int incidencesKolabCount( const QString& mimetype /*ignored*/,
                                     const QString& resource ) = 0;
 
   virtual QMap<Q_UINT32, QString> incidencesKolab( const QString& mimetype,
@@ -121,18 +122,18 @@
                          const QString& uid );
   void signalRefresh( const QString& type, const QString& folder );
   void subresourceAdded( const QString& type, const QString& resource,
-                         const QString& label );
+                         const QString& label, bool writable, bool alarmRelevant );
   void subresourceDeleted( const QString& type, const QString& resource );
 };
 
 inline QDataStream& operator<<( QDataStream& str, const KMailICalIface::SubResource& subResource )
 {
-  str << subResource.location << subResource.label << subResource.writable;
+  str << subResource.location << subResource.label << subResource.writable << subResource.alarmRelevant;
   return str;
 }
 inline QDataStream& operator>>( QDataStream& str, KMailICalIface::SubResource& subResource )
 {
-  str >> subResource.location >> subResource.label >> subResource.writable;
+  str >> subResource.location >> subResource.label >> subResource.writable >> subResource.alarmRelevant;
   return str;
 }
 
Index: kmail/accountmanager.h
===================================================================
--- kmail/accountmanager.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/accountmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -97,6 +97,8 @@
   void singleInvalidateIMAPFolders( KMAccount * );
 
   void intCheckMail( int, bool interactive = true );
+  /** Call processNextCheck with the false argument. **/
+  void slotProcessNextCheck();
   void processNextCheck( bool newMail );
 
   /** this slot increases the count of new mails to show a total number
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -219,22 +219,8 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMaildir::close(const char *, bool aForced)
+void KMFolderMaildir::reallyDoClose(const char *)
 {
-  if (mOpenCount <= 0) return;
-  if (mOpenCount > 0) mOpenCount--;
-
-  if (mOpenCount > 0 && !aForced) return;
-
-#if 0 // removed hack that prevented closing system folders (see kmail-devel discussion about mail expiring)
-  if ( (folder() != kmkernel->inboxFolder())
-       && folder()->isSystemFolder() && !aForced)
-  {
-     mOpenCount = 1;
-     return;
-  }
-#endif
-
   if (mAutoCreateIndex)
   {
       updateIndex();
Index: kmail/jobscheduler.cpp
===================================================================
--- kmail/jobscheduler.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/jobscheduler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -35,7 +35,7 @@
 using namespace KMail;
 
 JobScheduler::JobScheduler( QObject* parent, const char* name )
-  : QObject( parent, name ), mTimer( this ),
+  : QObject( parent, name ), mTimer( this, "mTimer" ),
     mPendingImmediateTasks( 0 ),
     mCurrentTask( 0 ), mCurrentJob( 0 )
 {
Index: kmail/kmreadermainwin.cpp
===================================================================
--- kmail/kmreadermainwin.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmreadermainwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -121,8 +121,19 @@
   mMsg = msg;
   menuBar()->show();
   toolBar( "mainToolBar" )->show();
+
+  connect ( msg->parent(), SIGNAL( destroyed( QObject* ) ), this, SLOT( slotFolderRemoved( QObject* ) ) );
+
 }
 
+void KMReaderMainWin::slotFolderRemoved( QObject* folderPtr )
+{
+  assert(mMsg);
+  assert(folderPtr == mMsg->parent());
+  if( mMsg && folderPtr == mMsg->parent() )
+    mMsg->setParent( 0 );
+}
+
 //-----------------------------------------------------------------------------
 void KMReaderMainWin::slotTrashMsg()
 {
Index: kmail/globalsettings.cpp
===================================================================
--- kmail/globalsettings.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/globalsettings.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -40,7 +40,7 @@
 
 GlobalSettings::GlobalSettings()
 {
-  mConfigSyncTimer = new QTimer( this );
+  mConfigSyncTimer = new QTimer( this, "mConfigSyncTimer" );
   connect( mConfigSyncTimer, SIGNAL( timeout() ), this, SLOT( slotSyncNow() ) );
 }
 
Index: kmail/searchwindow.cpp
===================================================================
--- kmail/searchwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/searchwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -117,7 +117,7 @@
   mSortColumn(0),
   mSortOrder(Ascending),
   mFolder(0),
-  mTimer(new QTimer(this)),
+  mTimer(new QTimer(this, "mTimer")),
   mLastFocus(0),
   mKMMainWidget(w)
 {
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -509,7 +509,10 @@
     mSelectEncodingAction( 0 ),
     mToggleFixFontAction( 0 ),
     mHtmlWriter( 0 ),
-    mSavedRelativePosition( 0 )
+    mSavedRelativePosition( 0 ),
+    updateReaderWinTimer( 0, "updateReaderWinTimer" ),
+    mResizeTimer( 0, "mResizeTimer" ),
+    mDelayedMarkTimer( 0, "mDelayedMarkTimer" )
 {
   mSplitterSizes << 180 << 100;
   mMimeTreeMode = 1;
@@ -1407,7 +1410,7 @@
 
   htmlWriter()->reset();
 
-  KMFolder* folder;
+  KMFolder* folder = 0;
   if (message(&folder))
   {
     if ( mShowColorbar )
Index: kmail/kmailicalifaceimpl.h
===================================================================
--- kmail/kmailicalifaceimpl.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmailicalifaceimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -274,6 +274,8 @@
 
   StorageFormat globalStorageFormat() const;
 
+  static bool folderIsAlarmRelevant( const KMFolder * );
+
 private:
   QGuardedPtr<KMFolder> mContacts;
   QGuardedPtr<KMFolder> mCalendar;
Index: kmail/kmaccount.cpp
===================================================================
--- kmail/kmaccount.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -324,7 +324,7 @@
   if (mInterval <= 0) return;
   if(!mTimer)
   {
-    mTimer = new QTimer();
+    mTimer = new QTimer(0, "mTimer");
     connect(mTimer,SIGNAL(timeout()),SLOT(mailCheck()));
   }
   else
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -699,6 +699,10 @@
   KMMessage *newMsg = new KMMessage( new DwMessage( *msg->asDwMessage() ) );
   newMsg->setComplete( msg->isComplete() );
 
+  // these fields need to be regenerated for the new message
+  newMsg->removeHeaderField("Date");
+  newMsg->removeHeaderField("Message-ID");
+
   KMail::Composer *win = KMail::makeComposer();
   newMsg->setTransferInProgress( false ); // From here on on, the composer owns the message.
   win->setMsg( newMsg, FALSE, TRUE );
@@ -1217,7 +1221,7 @@
     for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
       TemplateParser parser( fwdMsg, TemplateParser::Forward,
         msg->body(), false, false, false, false);
-        parser.process( msg, false, true );
+        parser.process( msg, 0, true );
 
       fwdMsg->link( msg, KMMsgStatusForwarded );
     }
@@ -1242,7 +1246,7 @@
     {
       KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
       win->setCharset( fwdMsg->codec()->mimeName(), true );
-      // win->setBody( QString::fromUtf8( msg->createForwardBody() ) );
+      win->setBody( fwdMsg->bodyToUnicode() );
       win->show();
     }
   }
@@ -1521,7 +1525,7 @@
     for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
       TemplateParser parser( fwdMsg, TemplateParser::Forward,
         msg->body(), false, false, false, false);
-        parser.process( msg, false, true );
+        parser.process( msg, 0, true );
 
       fwdMsg->link( msg, KMMsgStatusForwarded );
     }
@@ -1924,13 +1928,20 @@
   for (msgBase = mMsgList.first(); msgBase; msgBase = mMsgList.next() )
   {
     KMFolder *srcFolder = msgBase->parent();
-    if (isMessage = msgBase->isMessage())
+    if (( isMessage = msgBase->isMessage() ))
     {
       msg = static_cast<KMMessage*>(msgBase);
     } else {
       idx = srcFolder->find(msgBase);
       assert(idx != -1);
       msg = srcFolder->getMsg(idx);
+      // corrupt IMAP cache, see FolderStorage::getMsg()
+      if ( msg == 0 ) {
+        KMessageBox::error( parentWidget(), i18n("Corrupt IMAP cache detected in folder %1. "
+            "Copying of messages aborted.").arg( srcFolder->prettyURL() ) );
+        deleteLater();
+        return Failed;
+      }
     }
 
     if (srcFolder && mDestFolder &&
@@ -2056,22 +2067,25 @@
 
 KMMoveCommand::KMMoveCommand( KMFolder* destFolder,
                               const QPtrList<KMMsgBase> &msgList)
-  : mDestFolder( destFolder ), mMsgList( msgList ), mProgressItem( 0 )
+  : mDestFolder( destFolder ), mProgressItem( 0 )
 {
+  QPtrList<KMMsgBase> tmp = msgList;
+  for ( KMMsgBase *msgBase = tmp.first(); msgBase; msgBase = tmp.next() )
+    mSerNumList.append( msgBase->getMsgSerNum() );
 }
 
 KMMoveCommand::KMMoveCommand( KMFolder* destFolder,
                               KMMessage *msg )
   : mDestFolder( destFolder ), mProgressItem( 0 )
 {
-  mMsgList.append( &msg->toMsgBase() );
+  mSerNumList.append( msg->getMsgSerNum() );
 }
 
 KMMoveCommand::KMMoveCommand( KMFolder* destFolder,
                               KMMsgBase *msgBase )
   : mDestFolder( destFolder ), mProgressItem( 0 )
 {
-  mMsgList.append( msgBase );
+  mSerNumList.append( msgBase->getMsgSerNum() );
 }
 
 KMMoveCommand::KMMoveCommand( Q_UINT32 )
@@ -2102,7 +2116,6 @@
            this, SLOT( slotMoveCanceled() ) );
 
   KMMessage *msg;
-  KMMsgBase *msgBase;
   int rc = 0;
   int index;
   QPtrList<KMMessage> list;
@@ -2112,24 +2125,27 @@
   if (mDestFolder) {
     connect (mDestFolder, SIGNAL(msgAdded(KMFolder*, Q_UINT32)),
              this, SLOT(slotMsgAddedToDestFolder(KMFolder*, Q_UINT32)));
-    for ( msgBase=mMsgList.first(); msgBase; msgBase=mMsgList.next() ) {
-      mLostBoys.append( msgBase->getMsgSerNum() );
-    }
+    mLostBoys = mSerNumList;
   }
-  mProgressItem->setTotalItems( mMsgList.count() );
+  mProgressItem->setTotalItems( mSerNumList.count() );
 
-  for (msgBase=mMsgList.first(); msgBase && !rc; msgBase=mMsgList.next()) {
-    KMFolder *srcFolder = msgBase->parent();
+  for ( QValueList<Q_UINT32>::ConstIterator it = mSerNumList.constBegin(); it != mSerNumList.constEnd(); ++it ) {
+    KMFolder *srcFolder;
+    int idx = -1;
+    KMMsgDict::instance()->getLocation( *it, &srcFolder, &idx );
     if (srcFolder == mDestFolder)
       continue;
-    bool undo = msgBase->enableUndo();
-    int idx = srcFolder->find(msgBase);
     assert(idx != -1);
-    if ( msgBase->isMessage() ) {
-      msg = static_cast<KMMessage*>(msgBase);
-    } else {
-      msg = srcFolder->getMsg(idx);
+    if ( !srcFolder->isOpened() ) {
+      srcFolder->open( "kmcommand" );
+      mOpenedFolders.append( srcFolder );
     }
+    msg = srcFolder->getMsg(idx);
+    if ( !msg ) {
+      kdDebug(5006) << k_funcinfo << "No message found for serial number " << *it << endl;
+      continue;
+    }
+    bool undo = msg->enableUndo();
 
     if ( msg && msg->transferInProgress() &&
          srcFolder->folderType() == KMFolderTypeImap )
Index: kmail/messagecomposer.cpp
===================================================================
--- kmail/messagecomposer.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/messagecomposer.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -287,7 +287,24 @@
 
 MessageComposer::MessageComposer( KMComposeWin* win, const char* name )
   : QObject( win, name ), mComposeWin( win ), mCurrentJob( 0 ),
-    mKeyResolver( 0 ), mIdentityUid( 0 ), mPerformingSignOperation( false )
+    mReferenceMessage( 0 ), mKeyResolver( 0 ), 
+    mUseOpportunisticEncryption( false ),
+    mSignBody( false ), mEncryptBody( false ),
+    mSigningRequested(  false ), mEncryptionRequested( false ),
+    mDoSign( false ), mDoEncrypt( false ),
+    mAllowedCryptoMessageFormats( 0 ),
+    mDisableCrypto( false ),
+    mDisableBreaking( false ),
+    mDebugComposerCrypto( false ),
+    mAutoCharset( true ),
+    mIsRichText( false ),
+    mIdentityUid( 0 ), mRc( true ),
+    mHoldJobs( false ),
+    mNewBodyPart( 0 ),
+    mEarlyAddAttachments( false ), mAllAttachmentsAreInBody( false ),
+    mPreviousBoundaryLevel( 0 ),
+    mEncryptWithChiasmus( false ),
+    mPerformingSignOperation( false )
 {
 }
 
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -109,6 +109,7 @@
 {
   QFrame* page = plainPage();
   QVBoxLayout *topLayout = new QVBoxLayout( page, 0 );
+  // spell "lose" correctly. but don't cause a fuzzy.
   QString txt = i18n( "<p><b>Troubleshooting the IMAP cache.</b></p>"
                       "<p>If you have problems with synchronizing an IMAP "
                       "folder, you should first try rebuilding the index "
@@ -116,6 +117,14 @@
                       "not cause any problems.</p><p>If that is not enough, "
                       "you can try refreshing the IMAP cache. If you do this, "
                       "you will loose all your local changes for this folder "
+                      "and all its subfolders.</p>",
+                      "<p><b>Troubleshooting the IMAP cache.</b></p>"
+                      "<p>If you have problems with synchronizing an IMAP "
+                      "folder, you should first try rebuilding the index "
+                      "file. This will take some time to rebuild, but will "
+                      "not cause any problems.</p><p>If that is not enough, "
+                      "you can try refreshing the IMAP cache. If you do this, "
+                      "you will lose all your local changes for this folder "
                       "and all its subfolders.</p>" );
   topLayout->addWidget( new QLabel( txt, page ) );
 
@@ -203,12 +212,15 @@
 
 KMFolderCachedImap::~KMFolderCachedImap()
 {
+  if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
+}
+
+void KMFolderCachedImap::reallyDoClose( const char * owner )
+{
   if( !mFolderRemoved ) {
-    writeConfig();
     writeUidCache();
   }
-
-  if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
+  KMFolderMaildir::reallyDoClose( owner );
 }
 
 void KMFolderCachedImap::initializeFrom( KMFolderCachedImap* parent )
@@ -272,6 +284,12 @@
   if ( mImapPath.isEmpty() ) {
     mImapPathCreation = config->readEntry("ImapPathCreation");
   }
+
+  QStringList uids = config->readListEntry( "UIDSDeletedSinceLastSync" );
+//  kdDebug( 5006 ) << "READING IN UIDSDeletedSinceLastSync: " << folder()->prettyURL() << endl << uids << endl;
+  for ( QStringList::iterator it = uids.begin(); it != uids.end(); it++ ) {
+      mDeletedUIDsSinceLastSync.insert( (*it).toULong(), 0);
+  }
 }
 
 void KMFolderCachedImap::writeConfig()
@@ -287,6 +305,15 @@
     } else {
       configGroup.deleteEntry( "ImapPathCreation" );
     }
+    if ( !mDeletedUIDsSinceLastSync.isEmpty() ) {
+        QValueList<ulong> uids = mDeletedUIDsSinceLastSync.keys();
+        QStringList uidstrings;
+        for( QValueList<ulong>::iterator it = uids.begin(); it != uids.end(); it++ ) {
+            uidstrings.append(  QString::number( (*it) ) );
+        }
+        configGroup.writeEntry( "UIDSDeletedSinceLastSync", uidstrings );
+//        kdDebug( 5006 ) << "WRITING OUT UIDSDeletedSinceLastSync in: " << folder( )->prettyURL( ) << endl << uidstrings << endl;
+    }
   }
   writeConfigKeysWhichShouldNotGetOverwrittenByReadConfig();
   KMFolderMaildir::writeConfig();
@@ -361,11 +388,12 @@
       if( cacheVersion == UIDCACHE_VERSION ) {
         len = uidcache.readLine( buf, sizeof(buf) );
         if( len > 0 ) {
-          setUidValidity( QString::fromLocal8Bit( buf).stripWhiteSpace() );
+          setUidValidity( QString::fromLocal8Bit(buf).stripWhiteSpace() );
           len = uidcache.readLine( buf, sizeof(buf) );
           if( len > 0 ) {
+//            kdDebug(5006) << "Reading in last uid from cache: " << QString::fromLocal8Bit(buf).stripWhiteSpace() << " in " << folder()->prettyURL() << endl;
             // load the last known highest uid from the on disk cache
-            setLastUid( QString::fromLocal8Bit( buf).stripWhiteSpace().toULong() );
+            setLastUid( QString::fromLocal8Bit(buf).stripWhiteSpace().toULong() );
             return 0;
           }
         }
@@ -384,6 +412,7 @@
     return 0;
   }
 
+//  kdDebug(5006) << "Writing out UID cache lastuid: " << lastUid()  << " in: " << folder()->prettyURL() << endl;
   QFile uidcache( uidCacheLocation() );
   if( uidcache.open( IO_WriteOnly ) ) {
     QTextStream str( &uidcache );
@@ -425,6 +454,7 @@
 KMMessage* KMFolderCachedImap::take(int idx)
 {
   uidMapDirty = true;
+  rememberDeletion( idx );
   return KMFolderMaildir::take(idx);
 }
 
@@ -457,11 +487,21 @@
   return rc;
 }
 
+void KMFolderCachedImap::rememberDeletion( int idx )
+{
+  KMMsgBase *msg = getMsgBase( idx );
+  assert(msg);
+  ulong uid = msg->UID();
+  assert(uid>=0);
+  mDeletedUIDsSinceLastSync.insert(uid, 0);
+//  kdDebug(5006) << "Explicit delete of UID " << uid << " at index: " << idx << " in " << folder()->prettyURL();
+}
 
 /* Reimplemented from KMFolderMaildir */
 void KMFolderCachedImap::removeMsg(int idx, bool imapQuiet)
 {
   uidMapDirty = true;
+  rememberDeletion( idx );
   // Remove it from disk
   KMFolderMaildir::removeMsg(idx,imapQuiet);
 }
@@ -518,6 +558,7 @@
 
 void KMFolderCachedImap::setLastUid( ulong uid )
 {
+//  kdDebug(5006) << "Setting mLastUid to: " << uid  <<  " in " << folder()->prettyURL() << endl;
   mLastUid = uid;
   if( uidWriteTimer == -1 )
     // Write in one minute
@@ -549,6 +590,7 @@
   if( it != uidMap.end() ) {
     KMMsgBase *msg = getMsgBase( *it );
 #if MAIL_LOSS_DEBUGGING
+    kdDebug(5006) << "Folder: " << folder()->prettyURL() << endl;
     kdDebug(5006) << "UID " << uid << " is supposed to be in the map" << endl;
     kdDebug(5006) << "UID's index is to be " << *it << endl;
     kdDebug(5006) << "There is a message there? " << (msg != 0) << endl;
@@ -1538,6 +1580,9 @@
   if ( job->error() ) {
     // Skip the EXPUNGE state if deleting didn't work, no need to show two error messages
     mSyncState = SYNC_STATE_GET_MESSAGES;
+  } else {
+    // deleting on the server went fine, clear the pending deletions cache
+    mDeletedUIDsSinceLastSync.clear();
   }
   mProgress += 10;
   serverSyncInternal();
@@ -1676,14 +1721,24 @@
         // kdDebug(5006) << "KMFolderCachedImap::slotGetMessagesData() : folder "<<label()<<" already has msg="<<msg->headerField("Subject") << ", UID="<<uid << ", lastUid = " << mLastUid << endl;
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
-          if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
+//           kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should delete it" << endl;
+          // double check we deleted it since the last sync
+           if ( mDeletedUIDsSinceLastSync.contains(uid) ) {
+               if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
 #if MAIL_LOSS_DEBUGGING
-            kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+                   kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
 #endif
-            uidsForDeletionOnServer << uid;
-          } else {
-            redownload = true;
-          }
+                   uidsForDeletionOnServer << uid;
+               } else {
+                   redownload = true;
+               }
+           } else {
+//               kdDebug(5006) << "WARNING: ####### " << endl;
+//               kdDebug(5006) << "Message locally missing but not deleted in folder: " << folder()->prettyURL() << endl;
+//               kdDebug(5006) << "The missing UID: " << uid << ". It will be redownloaded " << endl;
+               redownload = true;
+           }
+
         } else {
           // if this is a read only folder, ignore status updates from the server
           // since we can't write our status back our local version is what has to
@@ -1696,6 +1751,7 @@
         // kdDebug(5006) << "message with uid " << uid << " found in the local cache. " << endl;
       }
       if ( uid > lastUid() || redownload ) {
+//      kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should download it" << endl;
         // The message is new since the last sync, but we might have just uploaded it, in which case
         // the uid map already contains it.
         if ( !uidMap.contains( uid ) ) {
@@ -1705,8 +1761,10 @@
             mUidsForDownload << uid;
         }
         // Remember the highest uid and once the download is completed, update mLastUid
-        if ( uid > mTentativeHighestUid )
+        if ( uid > mTentativeHighestUid ) {
+//          kdDebug(5006) << "Setting the tentative highest UID to: " << uid << endl;
           mTentativeHighestUid = uid;
+        }
       }
     }
     (*it).cdata.remove(0, pos);
@@ -2640,8 +2698,37 @@
 
 void KMFolderCachedImap::slotUpdateLastUid()
 {
-  if( mTentativeHighestUid != 0 )
-    setLastUid( mTentativeHighestUid );
+  if( mTentativeHighestUid != 0 ) {
+    
+      // Sanity checking:
+      // By now all new mails should be downloaded, which means
+      // that iteration over the folder should yield only UIDs
+      // lower or equal to what we think the highes ist, and the
+      // highest one as well. If not, our notion of the highest
+      // uid we've seen thus far is wrong, which is dangerous, so
+      // don't update the mLastUid, then.
+      bool sane = false;
+
+      for (int i=0;i<count(); i++ ) {
+          ulong uid = getMsgBase(i)->UID();
+          if ( uid > mTentativeHighestUid && uid > lastUid() ) {
+              kdWarning(5006) << "DANGER: Either the server listed a wrong highest uid, "
+                  "or we parsed it wrong. Send email to adam@kde.org, please, and include this log." << endl;
+              kdWarning(5006) << "uid: " << uid << " mTentativeHighestUid: " << mTentativeHighestUid << endl;
+              assert( false );
+              break;
+          } else if ( uid == mTentativeHighestUid || lastUid() ) {
+              // we've found our highest uid, all is well
+              sane = true;
+          } else {
+              // must be smaller, that's ok, let's wait for bigger fish
+          }
+      }
+      if (sane) {
+//          kdDebug(5006) << "Tentative highest UID test was sane, writing out: " << mTentativeHighestUid << endl;
+          setLastUid( mTentativeHighestUid );
+      }
+  }
   mTentativeHighestUid = 0;
 }
 
Index: kmail/renamejob.cpp
===================================================================
--- kmail/renamejob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/renamejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -51,6 +51,23 @@
 
 using namespace KMail;
 
+template <typename T> static QStringList imapPaths( FolderStorage* storage )
+{
+  QStringList rv;
+  rv.append( static_cast<T>( storage )->imapPath() );
+  KMFolderDir* dir = storage->folder()->child();
+  if ( dir ) {
+    KMFolderNode *node = dir->first();
+    while ( node ) {
+      if ( !node->isDir() ) {
+        rv += imapPaths<T>( static_cast<KMFolder*>( node )->storage() );
+      }
+      node = dir->next();
+    }
+  }
+  return rv;
+}
+
 RenameJob::RenameJob( FolderStorage* storage, const QString& newName,
     KMFolderDir* newParent )
  : FolderJob( 0, tOther, (storage ? storage->folder() : 0) ),
@@ -62,8 +79,10 @@
     mOldName = storage->name();
     if ( storage->folderType() == KMFolderTypeImap ) {
       mOldImapPath = static_cast<KMFolderImap*>(storage)->imapPath();
+//       mOldImapPaths = imapPaths<KMFolderImap*>( storage );
     } else if ( storage->folderType() == KMFolderTypeCachedImap ) {
       mOldImapPath = static_cast<KMFolderCachedImap*>(storage)->imapPath();
+      mOldImapPaths = imapPaths<KMFolderCachedImap*>( storage );
     }
   }
 }
@@ -215,8 +234,10 @@
   {
     // tell the account (see KMFolderCachedImap::listDirectory2)
     KMAcctCachedImap* acct = static_cast<KMFolderCachedImap*>(mStorage)->account();
-    if ( acct )
-      acct->addDeletedFolder( mOldImapPath );
+    if ( acct ) {
+      for ( QStringList::ConstIterator it = mOldImapPaths.constBegin(); it != mOldImapPaths.constEnd(); ++it )
+        acct->addDeletedFolder( *it );
+    }
     kmkernel->dimapFolderMgr()->remove( mStorage->folder() );
   } else if ( mStorage->folderType() == KMFolderTypeSearch )
   {
Index: kmail/index.cpp
===================================================================
--- kmail/index.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/index.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -85,7 +85,7 @@
 	mIndex( 0 ),
 #endif
 	mIndexPath( QFile::encodeName( defaultPath() ) ),
-	mTimer( new QTimer( this ) ),
+	mTimer( new QTimer( this, "mTimer" ) ),
 	//mSyncState( ss_none ),
 	//mSyncTimer( new QTimer( this ) ),
 	mSlowDown( false ) {
@@ -532,7 +532,7 @@
 
 KMMsgIndex::Search::Search( KMSearch* s ):
 	mSearch( s ),
-	mTimer( new QTimer( this ) ),
+	mTimer( new QTimer( this, "mTimer" ) ),
 	mResidual( new KMSearchPattern ),
 	mState( s_starting ) {
 	connect( mTimer, SIGNAL( timeout() ), SLOT( act() ) );
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1464,6 +1464,9 @@
     kdDebug(5006) << k_funcinfo << "foldersPath (after transferMail): '" << foldersPath << "'" << endl;
   }
 
+  // moved up here because KMMessage::stripOffPrefixes is used below
+  KMMessage::readConfig();
+
   the_undoStack     = new UndoStack(20);
   the_folderMgr     = new KMFolderMgr(foldersPath);
   the_imapFolderMgr = new KMFolderMgr( KMFolderImap::cacheLocation(), KMImapDir);
@@ -1479,8 +1482,6 @@
   the_popFilterMgr     = new KMFilterMgr(true);
   the_filterActionDict = new KMFilterActionDict;
 
-  // moved up here because KMMessage::stripOffPrefixes is used below -ta
-  KMMessage::readConfig();
   initFolders(cfg);
   the_acctMgr->readConfig();
   the_filterMgr->readConfig();
@@ -1521,7 +1522,7 @@
   connect( the_searchFolderMgr, SIGNAL( folderRemoved(KMFolder*) ),
            this, SIGNAL( folderRemoved(KMFolder*) ) );
 
-  mBackgroundTasksTimer = new QTimer( this );
+  mBackgroundTasksTimer = new QTimer( this, "mBackgroundTasksTimer" );
   connect( mBackgroundTasksTimer, SIGNAL( timeout() ), this, SLOT( slotRunBackgroundTasks() ) );
 #ifdef DEBUG_SCHEDULER // for debugging, see jobscheduler.h
   mBackgroundTasksTimer->start( 10000, true ); // 10s minute, singleshot
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -101,6 +101,9 @@
   KMFolderCachedImap(KMFolder* folder, const char* name=0);
   virtual ~KMFolderCachedImap();
 
+  /**  @reimpl */
+  void reallyDoClose( const char * owner );
+
   /** Initialize this storage from another one. Used when creating a child folder */
   void initializeFrom( KMFolderCachedImap* parent );
 
@@ -398,6 +401,7 @@
 private:
   void setReadOnly( bool readOnly );
   QString state2String( int state ) const;
+  void rememberDeletion( int );
 
   /** State variable for the synchronization mechanism */
   enum {
@@ -503,6 +507,7 @@
   int mNamespacesToCheck;
   bool mPersonalNamespacesCheckDone;
   QString mImapPathCreation;
+  QMap<ulong,void*> mDeletedUIDsSinceLastSync;
 
   QuotaInfo mQuotaInfo;
 };
Index: kmail/renamejob.h
===================================================================
--- kmail/renamejob.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/renamejob.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -84,6 +84,7 @@
   QString mNewImapPath;
   QString mOldName;
   QString mOldImapPath;
+  QStringList mOldImapPaths;
   KMFolder* mNewFolder;
   CopyFolderJob *mCopyFolderJob;
 };
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1926,7 +1926,7 @@
   // when the new folder is also an IMAP folder, because that's an
   // async operation and we don't want flicker if it results in just
   // a new splash.
-  bool newFolder = ( mFolder != aFolder );
+  bool newFolder = ( (KMFolder*)mFolder != aFolder );
   bool isNewImapFolder = aFolder && aFolder->folderType() == KMFolderTypeImap && newFolder;
   if( !mFolder
       || ( !isNewImapFolder && mShowBusySplashTimer )
@@ -3404,7 +3404,7 @@
       if(!(msg = mFolder->getMsg(aIdx)))
         return;
 
-      if (mFolder == kmkernel->outboxFolder())
+      if ((KMFolder*)mFolder == kmkernel->outboxFolder())
         mEditAction->setEnabled( !msg->transferInProgress() );
     }
 
Index: kmail/imapjob.cpp
===================================================================
--- kmail/imapjob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/imapjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -88,9 +88,7 @@
   }
   KMFolder *msg_parent = msg->parent();
   if (msg_parent) {
-    if (!folder || folder!= msg_parent->storage()) {
-      msg_parent->open("imapjobsrc");
-    }
+    msg_parent->open("imapjobsrc");
   }
   mSrcFolder = msg_parent;
   // If there is a destination folder, this is a copy, move or put to an
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -780,7 +780,7 @@
 
   void slotContinueDoSend( bool );
   void slotContinuePrint( bool );
-  void slotContinueAutoSave( bool );
+  void slotContinueAutoSave();
 
   void slotEncryptChiasmusToggled( bool );
 
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmcommands.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -770,7 +770,7 @@
   // Needed for KMDeleteCommand for "move to trash"
   KMMoveCommand( Q_UINT32 sernum );
   void setDestFolder( KMFolder* folder ) { mDestFolder = folder; }
-  void addMsg( KMMsgBase *msg ) { mMsgList.append( msg ); }
+  void addMsg( KMMsgBase *msg ) { mSerNumList.append( msg->getMsgSerNum() ); }
   QValueVector<KMFolder*> mOpenedFolders;
 
 private:
@@ -778,7 +778,7 @@
   void completeMove( Result result );
 
   KMFolder *mDestFolder;
-  QPtrList<KMMsgBase> mMsgList;
+  QValueList<Q_UINT32> mSerNumList;
   // List of serial numbers that have to be transferred to a host.
   // Ticked off as they come in via msgAdded signals.
   QValueList<Q_UINT32> mLostBoys;
@@ -858,7 +858,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListCommand( QWidget *parent, KMFolder *folder );
 private:
   virtual Result execute();
 private slots:
@@ -873,7 +873,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListPostCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListPostCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -882,7 +882,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListSubscribeCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListSubscribeCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -891,7 +891,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListUnsubscribeCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListUnsubscribeCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -900,7 +900,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListArchivesCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListArchivesCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -909,7 +909,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListHelpCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListHelpCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -709,16 +709,22 @@
 
   if ( mAutoSaveTimer )
     mAutoSaveTimer->stop();
+
   connect( this, SIGNAL( applyChangesDone( bool ) ),
-           this, SLOT( slotContinueAutoSave( bool ) ) );
+           this, SLOT( slotContinueAutoSave() ) );
   // This method is called when KMail crashed, so don't try signing/encryption
   // and don't disable controls because it is also called from a timer and
   // then the disabling is distracting.
   applyChanges( true, true );
 
   // Don't continue before the applyChanges is done!
-  qApp->enter_loop();
+}
 
+void KMComposeWin::slotContinueAutoSave()
+{
+  disconnect( this, SIGNAL( applyChangesDone( bool ) ),
+              this, SLOT( slotContinueAutoSave( bool ) ) );
+
   // Ok, it's done now - continue dead letter saving
   if ( mComposedMessages.isEmpty() ) {
     kdDebug(5006) << "Composing the message failed." << endl;
@@ -761,16 +767,9 @@
   }
 
   if ( autoSaveInterval() > 0 )
-    mAutoSaveTimer->start( autoSaveInterval() );
+    updateAutoSave();
 }
 
-void KMComposeWin::slotContinueAutoSave( bool )
-{
-  disconnect( this, SIGNAL( applyChangesDone( bool ) ),
-              this, SLOT( slotContinueAutoSave( bool ) ) );
-  qApp->exit_loop();
-}
-
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotView(void)
 {
@@ -2193,18 +2192,12 @@
 {
   kdDebug(5006) << "entering KMComposeWin::applyChanges" << endl;
 
-  if(!mMsg) {
+  if(!mMsg || mComposer) {
     kdDebug(5006) << "KMComposeWin::applyChanges() : mMsg == 0!\n" << endl;
     emit applyChangesDone( false );
     return;
   }
 
-  if( mComposer ) {
-    kdDebug(5006) << "KMComposeWin::applyChanges() : applyChanges called twice"
-                  << endl;
-    return;
-  }
-
   // Make new job and execute it
   mComposer = new MessageComposer( this );
   connect( mComposer, SIGNAL( done( bool ) ),
@@ -4623,7 +4616,7 @@
   }
   else {
     if ( !mAutoSaveTimer ) {
-      mAutoSaveTimer = new QTimer( this );
+      mAutoSaveTimer = new QTimer( this, "mAutoSaveTimer" );
       connect( mAutoSaveTimer, SIGNAL( timeout() ),
                this, SLOT( autoSaveMessage() ) );
     }
Index: kmail/kmail_view.desktop
===================================================================
--- kmail/kmail_view.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmail_view.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -16,7 +16,7 @@
 Icon=kmail
 DocPath=kmail/index.html
 NoDisplay=true
-MimeType=message/rfc822;application/mbox;application/x-mimearchive
+MimeType=message/rfc822;application/mbox;application/x-mimearchive;
 
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
Index: kmail/folderstorage.cpp
===================================================================
--- kmail/folderstorage.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/folderstorage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -78,7 +78,7 @@
   mNoContent      = false;
   mNoChildren     = false;
   mRDict = 0;
-  mDirtyTimer = new QTimer(this);
+  mDirtyTimer = new QTimer(this, "mDirtyTimer");
   connect(mDirtyTimer, SIGNAL(timeout()),
 	  this, SLOT(updateIndex()));
 
@@ -98,6 +98,14 @@
 }
 
 
+void FolderStorage::close( const char * owner, bool aForced )
+{
+  if (mOpenCount <= 0) return;
+  if (mOpenCount > 0) mOpenCount--;
+  if (mOpenCount > 0 && !aForced) return;
+    reallyDoClose( owner );
+}
+
 //-----------------------------------------------------------------------------
 QString FolderStorage::dotEscape(const QString& aStr)
 {
@@ -200,7 +208,7 @@
      * a timer is created when a folder is checked
      */
     if ( !mEmitChangedTimer) {
-      mEmitChangedTimer= new QTimer( this );
+      mEmitChangedTimer= new QTimer( this, "mEmitChangedTimer" );
       connect( mEmitChangedTimer, SIGNAL( timeout() ),
       this, SLOT( slotEmitChangedTimer() ) );
     }
Index: kmail/copyfolderjob.cpp
===================================================================
--- kmail/copyfolderjob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/copyfolderjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -59,7 +59,10 @@
   if ( mNewFolder )
     mNewFolder->setMoveInProgress( false );
   if ( mStorage )
+  {
+    mStorage->folder()->setMoveInProgress( false );
     mStorage->close("copyfolder");
+  }
 }
 
 /*
@@ -86,8 +89,10 @@
     msgList.append( msgBase );
   }
   if ( msgList.count() == 0 ) {
+    mStorage->blockSignals( false );
+    // ### be careful, after slotCopyNextChild() the source folder
+    // (including mStorage) might already be deleted!
     slotCopyNextChild(); // no contents, check subfolders
-    mStorage->blockSignals( false );
   } else {
     KMCommand *command = new KMCopyCommand( mNewFolder, msgList );
     connect( command, SIGNAL( completed( KMCommand * ) ),
@@ -221,6 +226,7 @@
   }
 
   mNewFolder->setMoveInProgress( true );
+  mStorage->folder()->setMoveInProgress( true );
 
   // inherit the folder type
   // FIXME we should probably copy over most if not all settings
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/configuredialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -4473,6 +4473,23 @@
                   "Flat Files (\"mbox\" format)")
           << i18n("continuation of \"By default, &message folders on disk are\"",
                   "Directories (\"maildir\" format)") );
+  // and now: add QWhatsThis:
+  QString msg = i18n( "what's this help",
+                      "<qt><p>This selects which mailbox format will be "
+                      "the default for local folders:</p>"
+                      "<p><b>mbox:</b> KMail's mail "
+                      "folders are represented by a single file each. "
+                      "Individual messages are separated from each other by a "
+                      "line starting with \"From \". This saves space on "
+                      "disk, but may be less robust, e.g. when moving messages "
+                      "between folders.</p>"
+                      "<p><b>maildir:</b> KMail's mail folders are "
+                      "represented by real folders on disk. Individual messages "
+                      "are separate files. This may waste a bit of space on "
+                      "disk, but should be more robust, e.g. when moving "
+                      "messages between folders.</p></qt>");
+  QWhatsThis::add( mMailboxPrefCombo, msg );
+  QWhatsThis::add( label, msg );
   hlay->addWidget( label );
   hlay->addWidget( mMailboxPrefCombo, 1 );
   connect( mMailboxPrefCombo, SIGNAL( activated( int ) ),
@@ -4520,23 +4537,6 @@
 
   vlay->addStretch( 1 );
 
-  // and now: add QWhatsThis:
-  QString msg = i18n( "what's this help",
-                      "<qt><p>This selects which mailbox format will be "
-                      "the default for local folders:</p>"
-                      "<p><b>mbox:</b> KMail's mail "
-                      "folders are represented by a single file each. "
-                      "Individual messages are separated from each other by a "
-                      "line starting with \"From \". This saves space on "
-                      "disk, but may be less robust, e.g. when moving messages "
-                      "between folders.</p>"
-                      "<p><b>maildir:</b> KMail's mail folders are "
-                      "represented by real folders on disk. Individual messages "
-                      "are separate files. This may waste a bit of space on "
-                      "disk, but should be more robust, e.g. when moving "
-                      "messages between folders.</p></qt>");
-  QWhatsThis::add( mMailboxPrefCombo, msg );
-  QWhatsThis::add( label, msg );
   // @TODO: Till, move into .kcgc file
   msg = i18n( "what's this help",
             "<qt><p>When jumping to the next unread message, it may occur "
Index: kmail/sievedebugdialog.cpp
===================================================================
--- kmail/sievedebugdialog.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/sievedebugdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -198,6 +198,7 @@
         mAccountList.append( a );
 
     mEdit = new QTextEdit( this );
+    mEdit->setReadOnly(true);
     setMainWidget( mEdit );
 
     mEdit->setText( i18n( "Collecting diagnostic information about Sieve support...\n\n" ) );
Index: kmail/kmfoldermgr.cpp
===================================================================
--- kmail/kmfoldermgr.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermgr.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -357,13 +357,14 @@
       break;
     }
   }
-  aFolder->parent()->remove(aFolder);
   // find the parent folder by stripping "." and ".directory" from the name
   QString parentName = fdir->name();
   parentName = parentName.mid( 1, parentName.length()-11 );
   KMFolderNode* parent = fdir->hasNamedFolder( parentName );
   if ( !parent && fdir->parent() ) // dimap obviously has a different structure
     parent = fdir->parent()->hasNamedFolder( parentName );
+  // aFolder will be deleted by the next call!
+  aFolder->parent()->remove(aFolder);
   // update the children state
   if ( parent )
     static_cast<KMFolder*>(parent)->storage()->updateChildrenState();
@@ -537,6 +538,8 @@
   RenameJob* job = new RenameJob( folder->storage(), newName, newParent );
   connect( job, SIGNAL( renameDone( QString, bool ) ),
       this, SLOT( slotRenameDone( QString, bool ) ) );
+  connect( job, SIGNAL( renameDone( QString, bool ) ),
+	   this, SIGNAL( folderMoveOrCopyOperationFinished() ) );
   job->start();
 }
 
@@ -545,6 +548,8 @@
 {
   kdDebug(5006) << "Copy folder: " << folder->prettyURL() << endl;
   CopyFolderJob* job = new CopyFolderJob( folder->storage(), newParent );
+  connect( job, SIGNAL( folderCopyComplete( bool ) ),
+	   this, SIGNAL( folderMoveOrCopyOperationFinished() ) );
   job->start();
 }
 
Index: kmail/kmfolderimap.cpp
===================================================================
--- kmail/kmfolderimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfolderimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -106,21 +106,13 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderImap::close(const char *owner, bool aForced)
+void KMFolderImap::reallyDoClose(const char *owner)
 {
-  if (mOpenCount > 0) mOpenCount--;
-  if (mOpenCount == 0 && isSelected() && !aForced) {
+  if ( isSelected() ) {
       kdWarning(5006) << "Trying to close the selected folder " << label() <<
         " - ignoring! " << kdBacktrace() << endl;
-      mOpenCount++;
       return;
   }
-  if (mOpenCount > 0 && !aForced) {
-    // The inherited close will decrement again, so we have to adjust.
-    mOpenCount++;
-    KMFolderMbox::close(owner, aForced);
-    return;
-  }
 
   // FIXME is this still needed?
   if (account())
@@ -136,9 +128,7 @@
 
   mCheckingValidity = false;
 
-  // The inherited close will decrement again, so we have to adjust.
-  mOpenCount++;
-  KMFolderMbox::close(owner, aForced);
+  KMFolderMbox::reallyDoClose(owner);
 }
 
 KMFolder* KMFolderImap::trashFolder() const
@@ -549,8 +539,6 @@
     QPtrList<KMMessage> temp_msgs = splitMessageList(*it, msgList);
 
     ImapJob *job = new ImapJob(temp_msgs, *it, ImapJob::tCopyMessage, this);
-    connect(job, SIGNAL(messageCopied(QPtrList<KMMessage>)),
-            SLOT(addMsgQuiet(QPtrList<KMMessage>)));
     connect(job, SIGNAL(result(KMail::FolderJob*)),
             SLOT(slotCopyMsgResult(KMail::FolderJob*)));
     job->start();
@@ -1132,6 +1120,7 @@
       // we notice when this changes
       account()->handleJobError( job, i18n("Error while querying the server status.") );
     }
+    kdDebug() << "error in slotCheckValidityResult\n";
     mContentState = imapNoInformation;
     emit folderComplete(this, FALSE);
     close("checkvalidity");
@@ -1212,6 +1201,7 @@
   mGuessedUnreadMsgs = -1;
   if (mNoContent)
   {
+    kdDebug() << "getFolder " << force << " " << mContentState << endl;
     mContentState = imapFinished;
     emit folderComplete(this, true);
     return;
@@ -1260,6 +1250,7 @@
       mMailCheckProgressItem->setStatus( i18n("Retrieving messages") );
     url.setPath(imapPath() + ";UID=" + startUid
       + ":*;SECTION=ENVELOPE");
+    kdDebug() << folder()->name() << " download " << url << endl;
     KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     ImapAccountBase::jobData jd( url.url(), folder() );
@@ -1369,6 +1360,7 @@
     KURL url = account()->getUrl();
     url.setPath(imapPath() + ";UID=" + *i + ";SECTION=ENVELOPE");
     KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
+    kdDebug() << folder()->name() << " download " << url << endl;
     jd.url = url.url();
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     account()->insertJob(newJob, jd);
@@ -1908,11 +1900,13 @@
        account()->setImapStatus(folder(), imappath, flags);
      }
   }
+  kdDebug() << folder()->name() << " setStatus " << mContentState << endl;
   if ( mContentState == imapListingInProgress ) {
     // we're currently get'ing this folder
     // to make sure that we get the latest flags abort the current listing and
     // create a new one
     kdDebug(5006) << "Set status during folder listing, restarting listing." << endl;
+    kdDebug() << "disconnct slotListFolderResult\n";
     disconnect(this, SLOT(slotListFolderResult(KIO::Job *)));
     quiet( false );
     reallyGetFolder( QString::null );
@@ -2372,6 +2366,7 @@
 
 void KMFolderImap::finishMailCheck( const char *dbg, imapState state )
 {
+  kdDebug() << folder()->name() << " finishMailCheck " << dbg << " " << state << endl;
   quiet( false );
   mContentState = state;
   emit folderComplete( this, mContentState == imapFinished );
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -55,7 +55,8 @@
 //-----------------------------------------------------------------------------
 PopAccount::PopAccount(AccountManager* aOwner, const QString& aAccountName, uint id)
   : NetworkAccount(aOwner, aAccountName, id),
-    headerIt(headersOnServer)
+    headerIt(headersOnServer),
+    processMsgsTimer( 0, "processMsgsTimer" )
 {
   init();
   job = 0;
@@ -787,7 +788,7 @@
     mSlave = 0;
     stage = Idle;
     if( mMailCheckProgressItem ) { // do this only once...
-      bool canceled = kmkernel->mailCheckAborted() || mMailCheckProgressItem->canceled();
+      bool canceled = !kmkernel || kmkernel->mailCheckAborted() || mMailCheckProgressItem->canceled();
       int numMessages = canceled ? indexOfCurrentMsg : idsOfMsgs.count();
       BroadcastStatus::instance()->setStatusMsgTransmissionCompleted(
         this->name(), numMessages, numBytes, numBytesRead, numBytesToRead, mLeaveOnServer, mMailCheckProgressItem );
@@ -1014,7 +1015,7 @@
     mSlave = 0;
   }
 
-  if (interactive) {
+  if (interactive && kmkernel) {
     KMessageBox::error(kmkernel->mainWin(), KIO::buildErrorString(error, errorMsg));
   }
 
Index: kmail/accountmanager.cpp
===================================================================
--- kmail/accountmanager.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/accountmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -122,10 +122,14 @@
     return;
   }
 
-  processNextCheck(false);
+  QTimer::singleShot(0, this, SLOT(slotProcessNextCheck()));
 }
-
 //-----------------------------------------------------------------------------
+void AccountManager::slotProcessNextCheck()
+{
+  processNextCheck( false );
+}
+//-----------------------------------------------------------------------------
 void AccountManager::processNextCheck( bool _newMail )
 {
   kdDebug(5006) << "processNextCheck, remaining " << mAcctTodo.count() << endl;
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -39,7 +39,6 @@
 #include <kprocess.h>
 #include <kconfig.h>
 
-#include <ctype.h>
 #include <stdio.h>
 #include <errno.h>
 #include <assert.h>
@@ -256,24 +255,8 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMbox::close(const char *owner, bool aForced)
+void KMFolderMbox::reallyDoClose(const char *owner)
 {
-  if (!aForced)
-     assert(mOpenCount >= 0);
-
-  if (mOpenCount <= 0 || !mStream) { mOpenCount = 0; return; }
-  if (mOpenCount > 0) mOpenCount--;
-  if (mOpenCount > 0 && !aForced) { assert(mStream); return; }
-
-#if 0 // removed hack that prevented closing system folders (see kmail-devel discussion about mail expiring)
-  if ( (folder() != kmkernel->inboxFolder())
-        && folder()->isSystemFolder() && !aForced )
-  {
-      mOpenCount = 1;
-      return;
-  }
-#endif
-
   if (mAutoCreateIndex)
   {
       if (KMFolderIndex::IndexOk != indexStatus()) {
Index: kmail/kmfolder.cpp
===================================================================
--- kmail/kmfolder.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfolder.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -288,7 +288,7 @@
 
 bool KMFolder::noContent() const
 {
-  return mStorage->noContent();
+  return mStorage ? mStorage->noContent() : true;
 }
 
 void KMFolder::setNoContent( bool aNoContent )
Index: kmail/kmfolderimap.h
===================================================================
--- kmail/kmfolderimap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfolderimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -131,10 +131,8 @@
   /** Remove the IMAP folder on the server and if successful also locally */
   virtual void remove();
 
-  /** Close folder. If force is TRUE the files are closed even if
-    others still use it (e.g. other mail reader windows). This also
-    cancels all pending jobs. */
-  virtual void close(const char *owner, bool force=FALSE);
+  /** Closes and cancels all pending jobs. */
+  virtual void reallyDoClose(const char *owner);
 
   /** Automatically expunge deleted messages when leaving the folder */
   bool autoExpunge();
Index: kmail/KMail.desktop
===================================================================
--- kmail/KMail.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/KMail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -89,4 +89,4 @@
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=kmail
 ServiceTypes=DCOP/ResourceBackend/IMAP,DCOP/Mailer
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;Office;Email;
Index: kmail/compactionjob.cpp
===================================================================
--- kmail/compactionjob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/compactionjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -51,7 +51,7 @@
 #define COMPACTIONJOB_TIMERINTERVAL 100
 
 MboxCompactionJob::MboxCompactionJob( KMFolder* folder, bool immediate )
- : ScheduledJob( folder, immediate ), mTimer( this ), mTmpFile( 0 ),
+ : ScheduledJob( folder, immediate ), mTimer( this, "mTimer" ), mTmpFile( 0 ),
    mCurrentIndex( 0 ), mFolderOpen( false ), mSilent( false )
 {
 }
@@ -194,7 +194,7 @@
 ////
 
 MaildirCompactionJob::MaildirCompactionJob( KMFolder* folder, bool immediate )
- : ScheduledJob( folder, immediate ), mTimer( this ),
+ : ScheduledJob( folder, immediate ), mTimer( this, "mTimer" ),
    mCurrentIndex( 0 ), mFolderOpen( false ), mSilent( false )
 {
 }
Index: kmail/kmfoldersearch.cpp
===================================================================
--- kmail/kmfoldersearch.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldersearch.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -80,7 +80,7 @@
     mFoundCount = 0;
     mSearchCount = 0;
 
-    mProcessNextBatchTimer = new QTimer();
+    mProcessNextBatchTimer = new QTimer(0, "mProcessNextBatchTimer");
     connect(mProcessNextBatchTimer, SIGNAL(timeout()), this, SLOT(slotProcessNextBatch()));
 }
 
@@ -367,7 +367,7 @@
     connect(kmkernel->dimapFolderMgr(), SIGNAL(msgHeaderChanged(KMFolder*,int)),
             this, SLOT(propagateHeaderChanged(KMFolder*,int)));
 
-  mExecuteSearchTimer = new QTimer();
+  mExecuteSearchTimer = new QTimer(0, "mExecuteSearchTimer");
   connect(mExecuteSearchTimer, SIGNAL(timeout()),
           this, SLOT(executeSearch()));
 }
@@ -539,12 +539,8 @@
     }
 }
 
-void KMFolderSearch::close(const char *, bool force)
+void KMFolderSearch::reallyDoClose(const char *)
 {
-    if (mOpenCount <= 0) return;
-    if (mOpenCount > 0) mOpenCount--;
-    if (mOpenCount > 0 && !force) return;
-
     if (mAutoCreateIndex) {
         if (mSearch)
             mSearch->write(location());
Index: kmail/kmacctimap.cpp
===================================================================
--- kmail/kmacctimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmacctimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -57,7 +57,8 @@
 //-----------------------------------------------------------------------------
 KMAcctImap::KMAcctImap(AccountManager* aOwner, const QString& aAccountName, uint id):
   KMail::ImapAccountBase(aOwner, aAccountName, id),
-  mCountRemainChecks( 0 )
+  mCountRemainChecks( 0 ),
+  mErrorTimer( 0, "mErrorTimer" )
 {
   mFolder = 0;
   mScheduler = 0;
Index: kmail/acljobs.cpp
===================================================================
--- kmail/acljobs.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/acljobs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -174,7 +174,7 @@
 void ACLJobs::GetACLJob::slotInfoMessage( KIO::Job*, const QString& str )
 {
   // Parse the result
-  QStringList lst = QStringList::split( " ", str );
+  QStringList lst = QStringList::split( " ", str, true );
   while ( lst.count() >= 2 ) // we take items 2 by 2
   {
     QString user = lst.front(); lst.pop_front();
Index: kmail/kmmainwidget.h
===================================================================
--- kmail/kmmainwidget.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmmainwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -23,6 +23,7 @@
 
 #include <kurl.h>
 #include <kxmlguiclient.h>
+#include <qguardedptr.h>
 #include <qlistview.h>
 #include <qvbox.h>
 #include <qvaluevector.h>
@@ -489,7 +490,7 @@
   QVBox        *mSearchAndHeaders;
   KToolBar     *mSearchToolBar;
   KMail::HeaderListQuickSearch *mQuickSearchLine;
-  KMFolder     *mFolder;
+  QGuardedPtr<KMFolder> mFolder;
   KMFolder     *mTemplateFolder;
   QPopupMenu   *mViewMenu, *mBodyPartsMenu;
   KAction       *mlistFilterAction;
Index: kmail/kmfoldertree.h
===================================================================
--- kmail/kmfoldertree.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldertree.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -264,6 +264,9 @@
   /** called, when a folder has been deleted */
   void slotFolderRemoved(KMFolder *);
 
+  /** called, when a folder has been moved or copied, successfully or not */
+  void slotFolderMoveOrCopyOperationFinished();
+
   /** Updates the folder tree (delayed), causing a "blink" */
   void refresh();
 
Index: kmail/kmfoldermaildir.h
===================================================================
--- kmail/kmfoldermaildir.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermaildir.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -68,7 +68,7 @@
 
   /** Close folder. If force is TRUE the files are closed even if
     others still use it (e.g. other mail reader windows). */
-  virtual void close(const char *owner, bool force=FALSE);
+  virtual void reallyDoClose(const char *owner);
 
   /** Create the necessary folders for a maildir folder. Usually you will
       want to use create() instead.
Index: kmail/kmfoldermgr.h
===================================================================
--- kmail/kmfoldermgr.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermgr.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -162,6 +162,9 @@
   /** Emitted when a field of the header of a specific message changed. */
   void msgHeaderChanged(KMFolder*, int idx);
 
+  /** Emitted when a folder has been moved or copied */
+  void folderMoveOrCopyOperationFinished();
+
 protected:
 
   /** Auxillary function to facilitate removal of a folder */
Index: kmail/kmreadermainwin.h
===================================================================
--- kmail/kmreadermainwin.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmreadermainwin.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -56,6 +56,8 @@
 
   void slotConfigChanged();
 
+  void slotFolderRemoved( QObject* folderPtr );
+
 private:
   void initKMReaderMainWin();
   void setupAccel();
Index: kmail/kmfoldertree.cpp
===================================================================
--- kmail/kmfoldertree.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -267,7 +267,7 @@
     return false; // nothing can be dragged into search folders
 
   if ( e->provides( KPIM::MailListDrag::format() ) ) {
-    if ( !mFolder || mFolder->isReadOnly() ||
+    if ( !mFolder || mFolder->moveInProgress() || mFolder->isReadOnly() ||
         (mFolder->noContent() && childCount() == 0) ||
         (mFolder->noContent() && isOpen()) ) {
       return false;
@@ -331,6 +331,8 @@
 KMFolderTree::KMFolderTree( KMMainWidget *mainWidget, QWidget *parent,
                             const char *name )
   : KFolderTree( parent, name )
+  , mUpdateTimer( 0, "mUpdateTimer" )
+  , autoopen_timer( 0, "autoopen_timer" )
 {
   oldSelected = 0;
   oldCurrent = 0;
@@ -339,7 +341,7 @@
   mReloading = false;
   mCutFolder = false;
 
-  mUpdateCountTimer= new QTimer( this );
+  mUpdateCountTimer= new QTimer( this, "mUpdateCountTimer" );
 
   setDragEnabled( true );
   addAcceptableDropMimetype(MailListDrag::format(), false);
@@ -379,6 +381,9 @@
   connect(kmkernel->folderMgr(), SIGNAL(folderRemoved(KMFolder*)),
           this, SLOT(slotFolderRemoved(KMFolder*)));
 
+  connect(kmkernel->folderMgr(), SIGNAL(folderMoveOrCopyOperationFinished()),
+	  this, SLOT(slotFolderMoveOrCopyOperationFinished()));
+
   connect(kmkernel->imapFolderMgr(), SIGNAL(changed()),
           this, SLOT(doFolderListChanged()));
 
@@ -775,10 +780,19 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMFolderTree::slotFolderMoveOrCopyOperationFinished()
+{
+  setDragEnabled( true );
+}
+//-----------------------------------------------------------------------------
 void KMFolderTree::slotFolderRemoved(KMFolder *aFolder)
 {
   KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>
     (indexOfFolder(aFolder));
+  if ( oldCurrent == fti )
+    oldCurrent = 0;
+  if ( oldSelected == fti )
+    oldSelected = 0;
   if (!fti || !fti->folder()) return;
   if (fti == currentItem())
   {
@@ -787,6 +801,11 @@
     doFolderSelected( qlvi );
   }
   removeFromFolderToItemMap( aFolder );
+
+  if ( dropItem == fti ) { // The removed item is the dropItem
+    dropItem = 0; // it becomes invalid
+  }
+
   delete fti;
   updateCopyActions();
 }
@@ -1378,6 +1397,9 @@
     dropItem = i;
     autoopen_timer.start( autoopenTime );
   }
+  else
+    dropItem = 0;
+
   e->accept( acceptDrag(e) );
 }
 
@@ -1443,6 +1465,20 @@
 
     QListViewItem *item = itemAt( contentsToViewport(e->pos()) );
     KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>(item);
+    // Check that each pointer is not null
+    for ( QValueList<QGuardedPtr<KMFolder> >::ConstIterator it = mCopySourceFolders.constBegin();
+	  it != mCopySourceFolders.constEnd(); ++it ) {
+      if ( ! (*it) ) {
+	fti = 0;
+	break;
+      }
+    }
+    if (fti && mCopySourceFolders.count() == 1)
+    {
+      KMFolder *source = mCopySourceFolders.first();
+      // if we are dragging to ourselves or to our parent, set fti to 0 so nothing is done
+      if (source == fti->folder() || source->parent()->owner() == fti->folder()) fti = 0;
+    }
     if (fti && acceptDrag(e) && ( fti != oldSelected || e->source() != mMainWidget->headers()->viewport() ) )
     {
       int action = -1;
@@ -1937,6 +1973,9 @@
 {
   kdDebug(5006) << k_funcinfo << "source: " << sources << " destination: " << destination << " move: " << move << endl;
 
+  // Disable drag during copy operation since it prevents from many crashes
+  setDragEnabled( false );
+
   KMFolderDir* parent = &(kmkernel->folderMgr()->dir());
   if ( destination )
     parent = destination->createChildFolder();
@@ -2023,6 +2062,12 @@
     }
   }
 
+  // de-select moved source folders (can cause crash due to unGetMsg() in KMHeaders)
+  if ( move ) {
+    doFolderSelected( indexOfFolder( destination ), false );
+    oldCurrent = currentItem();
+  }
+
   // do the actual move/copy
   for ( QValueList<QGuardedPtr<KMFolder> >::ConstIterator it = sources.constBegin(); it != sources.constEnd(); ++it ) {
     KMFolder* source = *it;
Index: kmail/kmfoldermbox.h
===================================================================
--- kmail/kmfoldermbox.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/kmfoldermbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -78,9 +78,8 @@
     fopen call otherwise (errno). */
   virtual int open(const char *owner);
 
-  /** Close folder. If force is TRUE the files are closed even if
-    others still use it (e.g. other mail reader windows). */
-  virtual void close(const char *owner, bool force=FALSE);
+  /** @reimpl */
+  virtual void reallyDoClose(const char *owner);
 
   virtual int canAccess();
 
Index: kmail/actionscheduler.cpp
===================================================================
--- kmail/actionscheduler.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kmail/actionscheduler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -81,19 +81,19 @@
   mAccount = false;
   lastCommand = 0;
   lastJob = 0;
-  finishTimer = new QTimer( this );
+  finishTimer = new QTimer( this, "finishTimer" );
   connect( finishTimer, SIGNAL(timeout()), this, SLOT(finish()));
-  fetchMessageTimer = new QTimer( this );
+  fetchMessageTimer = new QTimer( this, "fetchMessageTimer" );
   connect( fetchMessageTimer, SIGNAL(timeout()), this, SLOT(fetchMessage()));
-  tempCloseFoldersTimer = new QTimer( this );
+  tempCloseFoldersTimer = new QTimer( this, "tempCloseFoldersTimer" );
   connect( tempCloseFoldersTimer, SIGNAL(timeout()), this, SLOT(tempCloseFolders()));
-  processMessageTimer = new QTimer( this );
+  processMessageTimer = new QTimer( this, "processMessageTimer" );
   connect( processMessageTimer, SIGNAL(timeout()), this, SLOT(processMessage()));
-  filterMessageTimer = new QTimer( this );
+  filterMessageTimer = new QTimer( this, "filterMessageTimer" );
   connect( filterMessageTimer, SIGNAL(timeout()), this, SLOT(filterMessage()));
-  timeOutTimer = new QTimer( this );
+  timeOutTimer = new QTimer( this, "timeOutTimer" );
   connect( timeOutTimer, SIGNAL(timeout()), this, SLOT(timeOut()));
-  fetchTimeOutTimer = new QTimer( this );
+  fetchTimeOutTimer = new QTimer( this, "fetchTimeOutTimer" );
   connect( fetchTimeOutTimer, SIGNAL(timeout()), this, SLOT(fetchTimeOut()));
 
   QValueList<KMFilter*>::Iterator it = filters.begin();
Index: networkstatus/networkstatus.desktop
===================================================================
--- networkstatus/networkstatus.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ networkstatus/networkstatus.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -28,7 +28,7 @@
 Name[ms]=Daemon Berstatus Rangkaian
 Name[nb]=Statusnisse for nettverket
 Name[nds]=Nettwarkstatus-D√§moon
-Name[ne]=‡§∏‡§û‡•ç‡§ú‡§æ‡§≤ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§°‡•á‡§á‡§Æ‡•ã‡§®
+Name[ne]=‡§∏‡§û‡•ç‡§ú‡§æ‡§≤ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§°‡•á‡§á‡§Æ‡§®
 Name[nl]=Netwerkstatusdaemon
 Name[nn]=Statusnisse for nettverket
 Name[pl]=Us≈Çuga stanu sieci
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knode/KNode.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -82,4 +82,4 @@
 GenericName[zu]=Umfundi wezindaba
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;News;
Index: kioslaves/imap4/imapparser.cc
===================================================================
--- kioslaves/imap4/imapparser.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kioslaves/imap4/imapparser.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -59,6 +59,19 @@
 #include <kasciistricmp.h>
 #include <kasciistringtools.h>
 
+#ifdef HAVE_LIBSASL2
+static sasl_callback_t callbacks[] = {
+    { SASL_CB_ECHOPROMPT, NULL, NULL },
+    { SASL_CB_NOECHOPROMPT, NULL, NULL },
+    { SASL_CB_GETREALM, NULL, NULL },
+    { SASL_CB_USER, NULL, NULL },
+    { SASL_CB_AUTHNAME, NULL, NULL },
+    { SASL_CB_PASS, NULL, NULL },
+    { SASL_CB_CANON_USER, NULL, NULL },
+    { SASL_CB_LIST_END, NULL, NULL }
+};
+#endif
+
 imapParser::imapParser ()
 {
   sentQueue.setAutoDelete (false);
@@ -222,7 +235,7 @@
   result = sasl_client_new( "imap", /* FIXME: with cyrus-imapd, even imaps' digest-uri
                                        must be 'imap'. I don't know if it's good or bad. */
                        aFQDN.latin1(),
-                       0, 0, 0, 0, &conn );
+                       0, 0, callbacks, 0, &conn );
 
   if ( result != SASL_OK ) {
     kdDebug(7116) << "sasl_client_new failed with: " << result << endl;
@@ -1800,7 +1813,7 @@
     QString temp = (*it);
 
     int pt = temp.find ('/');
-    if (pt > 0) 
+    if (pt > 0)
     {
       if (temp.findRev ('"', pt) == -1 || temp.find('"', pt) == -1)
       {
@@ -1832,7 +1845,7 @@
     if (!_box.isEmpty () && _box[_box.length () - 1] == '/')
       _box.truncate(_box.length() - 1);
   }
-  kdDebug(7116) << "URL: box= " << _box << ", section= " << _section << ", type= " 
+  kdDebug(7116) << "URL: box= " << _box << ", section= " << _section << ", type= "
     << _type << ", uid= " << _uid << ", validity= " << _validity << ", info= " << _info << endl;
 }
 
Index: kioslaves/imap4/imap4.cc
===================================================================
--- kioslaves/imap4/imap4.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kioslaves/imap4/imap4.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -104,20 +104,6 @@
   KDE_EXPORT int kdemain (int argc, char **argv);
 }
 
-#ifdef HAVE_LIBSASL2
-static sasl_callback_t callbacks[] = {
-    { SASL_CB_ECHOPROMPT, NULL, NULL },
-    { SASL_CB_NOECHOPROMPT, NULL, NULL },
-    { SASL_CB_GETREALM, NULL, NULL },
-    { SASL_CB_USER, NULL, NULL },
-    { SASL_CB_AUTHNAME, NULL, NULL },
-    { SASL_CB_PASS, NULL, NULL },
-    { SASL_CB_GETOPT, NULL, NULL },
-    { SASL_CB_CANON_USER, NULL, NULL },
-    { SASL_CB_LIST_END, NULL, NULL }
-};
-#endif
-
 int
 kdemain (int argc, char **argv)
 {
@@ -131,7 +117,7 @@
   }
 
 #ifdef HAVE_LIBSASL2
-  if ( sasl_client_init( callbacks ) != SASL_OK ) {
+  if ( sasl_client_init( NULL ) != SASL_OK ) {
     fprintf(stderr, "SASL library initialization failed!\n");
     ::exit (-1);
   }
Index: kioslaves/imap4/imapcommand.cc
===================================================================
--- kioslaves/imap4/imapcommand.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kioslaves/imap4/imapcommand.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -396,7 +396,7 @@
 imapCommand *
 imapCommand::clientGetQuotaroot( const QString& box )
 {
-  QString parameter = rfcDecoder::toIMAP (box);
+  QString parameter = QString("\"") + rfcDecoder::toIMAP (box) + '"';
   return new imapCommand ("GETQUOTAROOT", parameter);
 }
 
Index: kioslaves/sieve/sieve.cpp
===================================================================
--- kioslaves/sieve/sieve.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kioslaves/sieve/sieve.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -14,7 +14,7 @@
  *                                                                         *
  ***************************************************************************/
 
-/** 
+/**
  * Portions adapted from the SMTP ioslave.
  * Copyright (c) 2000, 2001 Alex Zepeda <jazepeda@pacbell.net>
  * Copyright (c) 2001 Michael H‰ckel <Michael@Haeckel.Net>
@@ -60,7 +60,7 @@
 #endif
 
 #define SIEVE_DEFAULT_PORT 2000
-  
+
 static sasl_callback_t callbacks[] = {
     { SASL_CB_ECHOPROMPT, NULL, NULL },
     { SASL_CB_NOECHOPROMPT, NULL, NULL },
@@ -68,7 +68,6 @@
     { SASL_CB_USER, NULL, NULL },
     { SASL_CB_AUTHNAME, NULL, NULL },
     { SASL_CB_PASS, NULL, NULL },
-    { SASL_CB_GETOPT, NULL, NULL },
     { SASL_CB_CANON_USER, NULL, NULL },
     { SASL_CB_LIST_END, NULL, NULL }
 };
@@ -81,7 +80,7 @@
 	KDE_EXPORT int kdemain(int argc, char **argv)
 	{
 		KInstance instance("kio_sieve" );
-		
+
 		ksDebug() << "*** Starting kio_sieve " << endl;
 
 		if (argc != 4) {
@@ -89,7 +88,7 @@
 			exit(-1);
 		}
 
-    if ( sasl_client_init( callbacks ) != SASL_OK ) {
+    if ( sasl_client_init( NULL ) != SASL_OK ) {
       fprintf(stderr, "SASL library initialization failed!\n");
       ::exit (-1);
     }
@@ -230,17 +229,17 @@
 bool kio_sieveProtocol::parseCapabilities(bool requestCapabilities/* = false*/)
 {
 	ksDebug() << k_funcinfo << endl;
-	
+
 	// Setup...
 	bool ret = false;
-	
+
 	if (requestCapabilities) {
 		sendData("CAPABILITY");
 	}
 
 	while (receiveData()) {
 		ksDebug() << "Looping receive" << endl;
-		
+
 		if (r.getType() == kio_sieveResponse::ACTION) {
 			if ( r.getAction().contains("ok", false) != -1 ) {
 				ksDebug() << "Sieve server ready & awaiting authentication." << endl;
@@ -271,12 +270,12 @@
 			ksDebug() << "Server supports TLS" << endl;
 			m_supportsTLS = true;
 			setMetaData("tlsSupported", "true");
-			
+
 		} else {
 			ksDebug() << "Unrecognised key " << r.getKey() << endl;
 		}
 	}
-	
+
 	if (!m_supportsTLS) {
 		setMetaData("tlsSupported", "false");
 	}
@@ -301,7 +300,7 @@
 		if ( query.startsWith("?") ) query.remove( 0, 1 );
 		QStringList q = QStringList::split( ",", query );
 		QStringList::iterator it;
-  
+
 		for ( it = q.begin(); it != q.end(); ++it ) {
 			if ( ( (*it).section('=',0,0) ).lower() == "x-mech" ) {
 				auth = ( (*it).section('=',1) ).upper();
@@ -325,7 +324,7 @@
 bool kio_sieveProtocol::connect(bool useTLSIfAvailable)
 {
 	ksDebug() << k_funcinfo << endl;
-	
+
 	if (isConnectionValid()) return true;
 
 	infoMessage(i18n("Connecting to %1...").arg( m_sServer));
@@ -334,7 +333,7 @@
 		error(ERR_CONNECTION_BROKEN, i18n("The connection to the server was lost."));
 		return false;
 	}
-	
+
 	setBlockConnection(true);
 
 	if (!connectToHost(m_sServer, m_iPort, true)) {
@@ -358,7 +357,7 @@
 			if (retval == 1) {
 				ksDebug() << "TLS enabled successfully." << endl;
 				// reparse capabilities:
-				parseCapabilities(true);
+				parseCapabilities(false);
 			} else {
 				ksDebug() << "TLS initiation failed, code " << retval << endl;
 				disconnect(true);
@@ -406,7 +405,7 @@
 /*void kio_sieveProtocol::slave_status()
 {
 	slaveStatus(isConnectionValid() ? m_sServer : "", isConnectionValid());
-	
+
 	finished();
 }*/
 
@@ -600,7 +599,7 @@
 
 	if (operationSuccessful())
 		ksDebug() << "Script upload complete." << endl;
-	
+
 	else {
 		/* The managesieve server parses received scripts and rejects
 		 * scripts which are not syntactically correct. Here we expect
@@ -613,7 +612,7 @@
 			// send the extra message off for re-processing
 			receiveData(false, &extra);
 
-			if (r.getAction() == kio_sieveResponse::QUANTITY) {
+			if (r.getType() == kio_sieveResponse::QUANTITY) {
 				// length of the error message
 				uint len = r.getQuantity();
 
@@ -628,8 +627,13 @@
 
 				// clear the rest of the incoming data
 				receiveData();
-			} else
+			} else if (r.getType() == kio_sieveResponse::KEY_VAL_PAIR) {
 				error(ERR_INTERNAL_SERVER,
+						i18n("The script did not upload successfully.\n"
+							"This is probably due to errors in the script.\n"
+							"The server responded:\n%1").arg(r.getKey()));
+			} else 
+				error(ERR_INTERNAL_SERVER,
 					i18n("The script did not upload successfully.\n"
 						"The script may contain errors."));
 		} else
@@ -766,7 +770,7 @@
 	}
 
 	infoMessage(i18n("Done."));
-	
+
 	finished();
 }
 
@@ -783,7 +787,7 @@
     error(ERR_CANNOT_CHMOD, i18n("Cannot chmod to anything but 0700 (active) or 0600 (inactive script)."));
     return;
   }
-  
+
   finished();
 }
 
@@ -823,7 +827,7 @@
 
 		while(receiveData()) {
 			if (r.getType() == kio_sieveResponse::ACTION) {
-				if (r.getAction().contains("OK", false) == 1) 
+				if (r.getAction().contains("OK", false) == 1)
 					// Script list completed
 					break;
 
@@ -924,7 +928,7 @@
   //some mechanisms do not require username && pass, so it doesn't need a popup
   //window for getting this info
   for ( ; interact->id != SASL_CB_LIST_END; interact++ ) {
-    if ( interact->id == SASL_CB_AUTHNAME || 
+    if ( interact->id == SASL_CB_AUTHNAME ||
          interact->id == SASL_CB_PASS ) {
 
 	    if (m_sUser.isEmpty() || m_sPass.isEmpty()) {
@@ -938,7 +942,7 @@
       break;
     }
   }
-  
+
   interact = ( sasl_interact_t * ) in;
   while( interact->id != SASL_CB_LIST_END ) {
     ksDebug() << "SASL_INTERACT id: " << interact->id << endl;
@@ -993,7 +997,7 @@
 
   result = sasl_client_new( "sieve",
                        m_sServer.latin1(),
-                       0, 0, NULL, 0, &conn );
+                       0, 0, callbacks, 0, &conn );
 
   if ( result != SASL_OK ) {
     ksDebug() << "sasl_client_new failed with: " << result << endl;
@@ -1013,7 +1017,7 @@
     result = sasl_client_start(conn, strList.join(" ").latin1(), &client_interact,
                        &out, &outlen, &mechusing);
 
-    if (result == SASL_INTERACT) 
+    if (result == SASL_INTERACT)
       if ( !saslInteract( client_interact, ai ) ) {
         sasl_dispose( &conn );
         return false;
@@ -1042,15 +1046,15 @@
   ksDebug() << "firstCommand: " << firstCommand << endl;
 	if (!sendData( firstCommand.latin1() ))
 		return false;
-	
+
 	QCString command;
-	
+
 	do {
 		receiveData();
-		
+
 		if (operationResult() != OTHER)
 			break;
-		
+
 		ksDebug() << "Challenge len  " << r.getQuantity() << endl;
 
 		if (r.getType() != kio_sieveResponse::QUANTITY) {
@@ -1085,7 +1089,7 @@
                                   &client_interact,
                                   &out, &outlen);
 
-      if (result == SASL_INTERACT) 
+      if (result == SASL_INTERACT)
         if ( !saslInteract( client_interact, ai ) ) {
           sasl_dispose( &conn );
           return false;
@@ -1099,7 +1103,7 @@
       sasl_dispose( &conn );
       return false;
     }
-   
+
     tmp.setRawData( out, outlen );
     KCodecs::base64Encode( tmp, challenge );
     tmp.resetRawData( out, outlen );
@@ -1110,7 +1114,7 @@
 
 	ksDebug() << "Challenges finished." << endl;
   sasl_dispose( &conn );
-    
+
 	if (operationResult() == OK) {
 		// Authentication succeeded.
 		return true;
@@ -1185,7 +1189,7 @@
 		  {
 			// expecting {quantity}
 			start = 0;
-			end = interpret.find('}', start + 1);
+			end = interpret.find('}', start + 1)-1;
 
 			bool ok = false;
 			r.setQuantity(interpret.mid(start + 1, end - start - 1).toUInt( &ok ));
@@ -1264,6 +1268,6 @@
 			return BYE;
 		}
 	}
-	
+
 	return OTHER;
 }
Index: libkdenetwork/gpgmepp/importresult.cpp
===================================================================
--- libkdenetwork/gpgmepp/importresult.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkdenetwork/gpgmepp/importresult.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -28,6 +28,7 @@
 
 #include <gpgme.h>
 #include <cstdlib>
+#include <cstring>
 
 class GpgME::ImportResult::Private : public GpgME::Shared {
 public:
Index: libkdenetwork/gpgmepp/callbacks.cpp
===================================================================
--- libkdenetwork/gpgmepp/callbacks.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkdenetwork/gpgmepp/callbacks.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -32,6 +32,7 @@
 #include <cerrno>
 #include <unistd.h>
 #include <stdlib.h>
+#include <string.h>
 
 static inline gpg_error_t makeErrorFromErrno() {
   return gpg_err_make_from_errno( (gpg_err_source_t)22, errno );
Index: doc/karm/index.docbook
===================================================================
--- doc/karm/index.docbook	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ doc/karm/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -389,9 +389,7 @@
 totals and not the detailed task history.</para></important>
 
 <para>This report is generated for the currently selected task and all it's
-subtasks.  Unlike the totals report, this report does not give you the option
-to report on the complete task list.  You can only report on the current task
-and all it's sub-tasks.</para>
+subtasks. You also have the choice to generate it for all tasks.</para>
 
 <para>When you select the history report, &karm; first prompts you to enter the
 date range for the report:</para>
Index: kalarm/alarmevent.cpp
===================================================================
--- kalarm/alarmevent.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/alarmevent.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -43,11 +43,13 @@
 // KAlarm version which first used the current calendar/event format.
 // If this changes, KAEvent::convertKCalEvents() must be changed correspondingly.
 // The string version is the KAlarm version string used in the calendar file.
-QString KAEvent::calVersionString()  { return QString::fromLatin1("1.3.1"); }
-int     KAEvent::calVersion()        { return KAlarm::Version(1,3,1); }
+QString KAEvent::calVersionString()  { return QString::fromLatin1("1.4.14"); }
+int     KAEvent::calVersion()        { return KAlarm::Version(1,4,14); }
 
 // Custom calendar properties.
 // Note that all custom property names are prefixed with X-KDE-KALARM- in the calendar file.
+// - Event properties
+static const QCString NEXT_RECUR_PROPERTY("NEXTRECUR");     // X-KDE-KALARM-NEXTRECUR property
 // - General alarm properties
 static const QCString TYPE_PROPERTY("TYPE");    // X-KDE-KALARM-TYPE property
 static const QString FILE_TYPE                  = QString::fromLatin1("FILE");
@@ -313,7 +315,24 @@
 	}
 	mStartDateTime.set(event.dtStart(), floats);
 	mNextMainDateTime = mStartDateTime;
-	mSaveDateTime     = event.created();
+	QString prop = event.customProperty(APPNAME, NEXT_RECUR_PROPERTY);
+	if (prop.length() >= 8)
+	{
+		// The next due recurrence time is specified
+		QDate d(prop.left(4).toInt(), prop.mid(4,2).toInt(), prop.mid(6,2).toInt());
+		if (d.isValid())
+		{
+			if (floats  &&  prop.length() == 8)
+				mNextMainDateTime = d;
+			else if (!floats  &&  prop.length() == 15  &&  prop[8] == QChar('T'))
+			{
+				QTime t(prop.mid(9,2).toInt(), prop.mid(11,2).toInt(), prop.mid(13,2).toInt());
+				if (t.isValid())
+					mNextMainDateTime = QDateTime(d, t);
+			}
+		}
+	}
+	mSaveDateTime = event.created();
 	if (uidStatus() == TEMPLATE)
 		mTemplateName = event.summary();
 	if (event.statusStr() == DISABLED_STATUS)
@@ -431,16 +450,18 @@
 				alTime = mDeferralTime;
 				if (mNextMainDateTime == mDeferralTime)
 					mDeferral = CANCEL_DEFERRAL;     // it's a cancelled deferral
-				// fall through to MAIN__ALARM
-			case KAAlarm::MAIN__ALARM:
+				// fall through to AT_LOGIN__ALARM etc.
 			case KAAlarm::AT_LOGIN__ALARM:
 			case KAAlarm::REMINDER__ALARM:
 			case KAAlarm::DISPLAYING__ALARM:
+				if (!set)
+					mNextMainDateTime = alTime;
+				// fall through to MAIN__ALARM
+			case KAAlarm::MAIN__ALARM:
 				// Ensure that the basic fields are set up even if there is no main
 				// alarm in the event (if it has expired and then been deferred)
 				if (!set)
 				{
-					mNextMainDateTime = alTime;
 					mActionType = data.action;
 					mText = (mActionType == T_COMMAND) ? data.cleanText.stripWhiteSpace() : data.cleanText;
 					switch (data.action)
@@ -1049,10 +1070,21 @@
 	int      ancillaryOffset = 0; // start offset for ancillary alarms
 	if (!mMainExpired  ||  original)
 	{
+		/* The alarm offset must always be zero for the main alarm. To determine
+		 * which recurrence is due, the property X-KDE-KALARM_NEXTRECUR is used.
+		 * If the alarm offset was non-zero, exception dates and rules would not
+		 * work since they apply to the event time, not the alarm time.
+		 */
+		if (!original  &&  checkRecur() != KARecurrence::NO_RECUR)
+		{
+			QDateTime dt = mNextMainDateTime.dateTime();
+			ev.setCustomProperty(APPNAME, NEXT_RECUR_PROPERTY,
+			                     dt.toString(mNextMainDateTime.isDateOnly() ? "yyyyMMdd" : "yyyyMMddThhmmss"));
+		}
 		// Add the main alarm
-		initKcalAlarm(ev, dtMain, QStringList(), KAAlarm::MAIN_ALARM);
-		ancillaryTime = dtMain;
-		ancillaryType = dtMain.isValid() ? 1 : 0;
+		initKcalAlarm(ev, 0, QStringList(), KAAlarm::MAIN_ALARM);
+		ancillaryOffset = 0;
+		ancillaryType = dtMain.isValid() ? 2 : 0;
 	}
 
 	// Add subsidiary alarms
@@ -1086,18 +1118,36 @@
 	}
 	if (mDeferral > 0  ||  mDeferral == CANCEL_DEFERRAL && !cancelCancelledDefer)
 	{
+		DateTime nextDateTime = mNextMainDateTime;
+		if (mMainExpired && !original  &&  checkRecur() != KARecurrence::NO_RECUR)
+		{
+			// It's a deferral of an expired recurrence.
+			// Need to ensure that the alarm offset is to an occurrence
+			// which isn't excluded by an exception - otherwise, it will
+			// never be triggered. So choose the first recurrence which
+			// isn't an exception.
+			nextDateTime = mRecurrence->getNextDateTime(mStartDateTime.dateTime().addDays(-1));
+			nextDateTime.setDateOnly(mStartDateTime.isDateOnly());
+		}
+		int startOffset;
 		QStringList list;
 		if (mDeferralTime.isDateOnly())
+		{
+			startOffset = nextDateTime.secsTo(mDeferralTime);
 			list += DATE_DEFERRAL_TYPE;
+		}
 		else
+		{
+			startOffset = nextDateTime.dateTime().secsTo(mDeferralTime.dateTime());
 			list += TIME_DEFERRAL_TYPE;
+		}
 		if (mDeferral == REMINDER_DEFERRAL)
 			list += mReminderOnceOnly ? REMINDER_ONCE_TYPE : REMINDER_TYPE;
-		initKcalAlarm(ev, mDeferralTime, list);
+		initKcalAlarm(ev, startOffset, list);
 		if (!ancillaryType  &&  mDeferralTime.isValid())
 		{
-			ancillaryTime = mDeferralTime;
-			ancillaryType = 1;
+			ancillaryOffset = startOffset;
+			ancillaryType = 2;
 		}
 	}
 	if (!mTemplateName.isEmpty())
@@ -1175,9 +1225,12 @@
 	QStringList alltypes;
 	Alarm* alarm = event.newAlarm();
 	alarm->setEnabled(true);
-	// RFC2445 specifies that absolute alarm times must be stored as UTC.
-	// So, in order to store local times, set the alarm time as an offset to DTSTART.
-	alarm->setStartOffset(startOffsetSecs);
+	if (type != KAAlarm::MAIN_ALARM)
+	{
+		// RFC2445 specifies that absolute alarm times must be stored as UTC.
+		// So, in order to store local times, set the alarm time as an offset to DTSTART.
+		alarm->setStartOffset(startOffsetSecs);
+	}
 
 	switch (type)
 	{
@@ -1564,7 +1617,8 @@
 	{
 		// The alarm is repeated, and we're deferring to a time before the last repetition.
 		// Set the next scheduled repetition to the one after the deferral.
-		mNextRepeat = mNextMainDateTime.secsTo(mDeferralTime) / (mRepeatInterval * 60) + 1;
+		mNextRepeat = (mNextMainDateTime < mDeferralTime)
+		            ? mNextMainDateTime.secsTo(mDeferralTime) / (mRepeatInterval * 60) + 1 : 0;
 	}
 	mUpdated = true;
 	return result;
@@ -2601,7 +2655,8 @@
 	bool pre_1_2_1 = (version < KAlarm::Version(1,2,1));
 	bool pre_1_3_0 = (version < KAlarm::Version(1,3,0));
 	bool pre_1_3_1 = (version < KAlarm::Version(1,3,1));
-	Q_ASSERT(calVersion() == KAlarm::Version(1,3,1));
+	bool pre_1_4_14 = (version < KAlarm::Version(1,4,14));
+	Q_ASSERT(calVersion() == KAlarm::Version(1,4,14));
 
 	QDateTime dt0(QDate(1970,1,1), QTime(0,0,0));
 	QTime startOfDay = Preferences::startOfDay();
@@ -2877,6 +2932,94 @@
 			cats.append(QString("%1%2").arg(LATE_CANCEL_CATEGORY).arg(1));
 
 		event->setCategories(cats);
+
+
+		if (pre_1_4_14
+		&&  event->recurrence()  &&  event->recurrence()->doesRecur())
+		{
+			/*
+			 * It's a KAlarm pre-1.4.12 calendar file.
+			 * For recurring events, convert the main alarm offset to an absolute
+			 * time in the X-KDE-KALARM-NEXTRECUR property, and convert main
+			 * alarm offsets to zero and deferral alarm offsets to be relative to
+			 * the next recurrence.
+			 */
+			bool floats = (cats.find(DATE_ONLY_CATEGORY) != cats.end());
+			DateTime startDateTime(event->dtStart(), floats);
+			// Convert the main alarm and get the next main trigger time from it
+			DateTime nextMainDateTime;
+			bool mainExpired = true;
+			Alarm::List::ConstIterator alit;
+			for (alit = alarms.begin();  alit != alarms.end();  ++alit)
+			{
+				Alarm* alarm = *alit;
+				if (!alarm->hasStartOffset())
+					continue;
+				bool mainAlarm = true;
+				QString property = alarm->customProperty(APPNAME, TYPE_PROPERTY);
+				QStringList types = QStringList::split(QChar(','), property);
+				for (unsigned int i = 0;  i < types.count();  ++i)
+				{
+					QString type = types[i];
+					if (type == AT_LOGIN_TYPE
+					||  type == TIME_DEFERRAL_TYPE
+					||  type == DATE_DEFERRAL_TYPE
+					||  type == REMINDER_TYPE
+					||  type == REMINDER_ONCE_TYPE
+					||  type == DISPLAYING_TYPE
+					||  type == PRE_ACTION_TYPE
+					||  type == POST_ACTION_TYPE)
+						mainAlarm = false;
+				}
+				if (mainAlarm)
+				{
+					mainExpired = false;
+					nextMainDateTime = alarm->time();
+					nextMainDateTime.setDateOnly(floats);
+					if (nextMainDateTime != startDateTime)
+					{
+						QDateTime dt = nextMainDateTime.dateTime();
+						event->setCustomProperty(APPNAME, NEXT_RECUR_PROPERTY,
+						                         dt.toString(floats ? "yyyyMMdd" : "yyyyMMddThhmmss"));
+					}
+					alarm->setStartOffset(0);
+				}
+			}
+			int adjustment;
+			if (mainExpired)
+			{
+				// It's an expired recurrence.
+				// Set the alarm offset relative to the first actual occurrence
+				// (taking account of possible exceptions).
+				DateTime dt = event->recurrence()->getNextDateTime(startDateTime.dateTime().addDays(-1));
+				dt.setDateOnly(floats);
+				adjustment = startDateTime.secsTo(dt);
+			}
+			else
+				adjustment = startDateTime.secsTo(nextMainDateTime);
+			if (adjustment)
+			{
+				// Convert deferred alarms
+				for (alit = alarms.begin();  alit != alarms.end();  ++alit)
+				{
+					Alarm* alarm = *alit;
+					if (!alarm->hasStartOffset())
+						continue;
+					QString property = alarm->customProperty(APPNAME, TYPE_PROPERTY);
+					QStringList types = QStringList::split(QChar(','), property);
+					for (unsigned int i = 0;  i < types.count();  ++i)
+					{
+						QString type = types[i];
+						if (type == TIME_DEFERRAL_TYPE
+						||  type == DATE_DEFERRAL_TYPE)
+						{
+							alarm->setStartOffset(alarm->startOffset().asSeconds() - adjustment);
+							break;
+						}
+					}
+				}
+			}
+		}
 	}
 }
 
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.cpp  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -1211,7 +1211,7 @@
 		if (!mTemplate)
 			dt = mAlarmDateTime.dateTime();
 		else if (mTemplateUseTime->isOn())
-			dt.setTime(mTemplateTime->time());
+			dt = QDateTime(QDate(2000,1,1), mTemplateTime->time());
 	}
 	KAEvent::Action type = getAlarmType();
 	event.set(dt, text, mBgColourChoose->color(), mFontColourButton->fgColour(), mFontColourButton->font(),
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.12"
+#define KALARM_VERSION "1.4.14"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1071,8 +1071,7 @@
 */
 void MainWindow::slotPreferences()
 {
-	KAlarmPrefDlg prefDlg;
-	prefDlg.exec();
+	KAlarmPrefDlg::display();
 }
 
 /******************************************************************************
Index: kalarm/sounddlg.h
===================================================================
--- kalarm/sounddlg.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/sounddlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -27,6 +27,8 @@
 
 class QHBox;
 class QPushButton;
+class KArtsDispatcher;
+namespace KDE { class PlayObject; }
 class LineEdit;
 class PushButton;
 class CheckBox;
@@ -40,6 +42,7 @@
 	public:
 		SoundDlg(const QString& file, float volume, float fadeVolume, int fadeSeconds, bool repeat,
 		         const QString& caption, QWidget* parent, const char* name = 0);
+		~SoundDlg();
 		void           setReadOnly(bool);
 		bool           isReadOnly() const    { return mReadOnly; }
 		QString        getFile() const       { return mFileName; }
@@ -63,8 +66,10 @@
 		void           slotVolumeToggled(bool on);
 		void           slotFadeToggled(bool on);
 		void           playSound();
+		void           checkAudioPlay();
 
 	private:
+		void           stopPlay();
 		bool           checkFile();
 
 		QPushButton*   mFilePlay;
@@ -81,6 +86,13 @@
 		QString        mDefaultDir;     // current default directory for mFileEdit
 		QString        mFileName;
 		bool           mReadOnly;
+		// Sound file playing
+		KArtsDispatcher* mArtsDispatcher;
+		KDE::PlayObject* mPlayObject;
+		QTimer*          mPlayTimer;       // timer for playing the sound file
+		QString          mLocalAudioFile;  // local copy of audio file
+		QTime            mAudioFileStart;  // time when audio file loading started, or when play started
+		bool             mPlayStarted;      // the sound file has started playing
 };
 
 #endif
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -55,7 +55,7 @@
 {
 		Q_OBJECT
 	public:
-		KAlarmPrefDlg();
+		static void display();
 		~KAlarmPrefDlg();
 
 		FontColourPrefTab* mFontColourPage;
@@ -72,7 +72,10 @@
 		virtual void slotCancel();
 
 	private:
+		KAlarmPrefDlg();
 		void            restore();
+
+		static KAlarmPrefDlg* mInstance;
 		bool            mValid;
 };
 
Index: kalarm/kalarmd/kalarmd.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmd/kalarmd.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,7 +30,7 @@
 Name[ms]=Daemon KAlarm 
 Name[nb]=KAlarm-nisse
 Name[nds]=KAlarm-D√§moon
-Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡•ã‡§®
+Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡§®
 Name[nn]=KAlarm-nisse
 Name[pl]=Demon alarmowy
 Name[pt]=Servidor do KAlarm
Index: kalarm/kalarmd/alarmdaemon.cpp
===================================================================
--- kalarm/kalarmd/alarmdaemon.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmd/alarmdaemon.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -359,7 +359,6 @@
 		return;
 
 	QDateTime now  = QDateTime::currentDateTime();
-	QDateTime now1 = now.addSecs(1);
 	kdDebug(5901) << "  To: " << now.toString() << endl;
 	QValueList<KCal::Alarm*> alarms = cal->alarmsTo(now);
 	if (!alarms.count())
@@ -378,6 +377,29 @@
 		// The times in 'alarmtimes' corresponding to due alarms are set.
 		// The times for non-due alarms are set invalid in 'alarmtimes'.
 		bool recurs = event->doesRecur();
+		QStringList flags = QStringList::split(QString::fromLatin1(";"), event->customProperty("KALARM", "FLAGS"), false);
+		bool floats = (flags.find(QString::fromLatin1("DATE")) != flags.end());
+		QDateTime nextDateTime = event->dtStart();
+		if (recurs)
+		{
+			QString prop = event->customProperty("KALARM", "NEXTRECUR");
+			if (prop.length() >= 8)
+			{
+				// The next due recurrence time is specified
+				QDate d(prop.left(4).toInt(), prop.mid(4,2).toInt(), prop.mid(6,2).toInt());
+				if (d.isValid())
+				{
+					if (floats  &&  prop.length() == 8)
+						nextDateTime = d;
+					else if (!floats  &&  prop.length() == 15  &&  prop[8] == QChar('T'))
+					{
+						QTime t(prop.mid(9,2).toInt(), prop.mid(11,2).toInt(), prop.mid(13,2).toInt());
+						if (t.isValid())
+							nextDateTime = QDateTime(d, t);
+					}
+				}
+			}
+		}
 		QValueList<QDateTime> alarmtimes;
 		KCal::Alarm::List alarms = event->alarms();
 		for (KCal::Alarm::List::ConstIterator al = alarms.begin();  al != alarms.end();  ++al)
@@ -395,13 +417,29 @@
 					int offset = alarm->hasStartOffset() ? alarm->startOffset().asSeconds()
 					           : alarm->endOffset().asSeconds() + event->dtStart().secsTo(event->dtEnd());
 					if (offset)
-						dt1 = event->recurrence()->getPreviousDateTime(now1.addSecs(-offset));
+					{
+						dt1 = nextDateTime.addSecs(offset);
+						if (dt1 > now)
+							dt1 = QDateTime();
+					}
 				}
-				dt = alarm->previousRepetition(now1);   // get latest due repetition (if any)
-				if (!dt.isValid())
+				// Get latest due repetition, or the recurrence time if none
+				dt = nextDateTime;
+				if (nextDateTime <= now  &&  alarm->repeatCount() > 0)
+				{
+					int snoozeSecs = alarm->snoozeTime() * 60;
+					QDateTime lastRepetition = nextDateTime.addSecs(alarm->repeatCount() * snoozeSecs);
+					if (lastRepetition <= now)
+						dt = lastRepetition;
+					else
+					{
+						int repetition = nextDateTime.secsTo(now) / snoozeSecs;
+						dt = nextDateTime.addSecs(repetition * snoozeSecs);
+					}
+				}
+				if (!dt.isValid()  ||  dt > now
+				||  dt1.isValid()  &&  dt1 > dt)  // already tested dt1 <= now
 					dt = dt1;
-				else if (dt1.isValid()  &&  dt1 > dt)
-					dt = dt1;
 			}
 			alarmtimes.append(dt);
 		}
Index: kalarm/kalarmd/kalarmd.h
===================================================================
--- kalarm/kalarmd/kalarmd.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmd/kalarmd.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -25,7 +25,7 @@
 #include <config.h>
 #endif
 
-#define DAEMON_VERSION            "4.1.2"       // kalarmd version number
+#define DAEMON_VERSION            "4.1.3"       // kalarmd version number
 #define DAEMON_APP_NAME           "kalarmd"     // DCOP name of alarm daemon application
 #define DAEMON_DCOP_OBJECT        "ad"          // DCOP name of kalarmd's DCOP interface
 
Index: kalarm/kalarmd/kalarmd.autostart.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.autostart.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmd/kalarmd.autostart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,7 +30,7 @@
 Name[ms]=Daemon KAlarm 
 Name[nb]=KAlarm-nisse
 Name[nds]=KAlarm-D√§moon
-Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡•ã‡§®
+Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡§®
 Name[nn]=KAlarm-nisse
 Name[pl]=Demon alarmowy
 Name[pt]=Servidor do KAlarm
@@ -77,7 +77,7 @@
 Comment[ms]= Automula daemon penggera KAlarm semasa log masuk
 Comment[nb]=start alarmnisse ved innlogging
 Comment[nds]=KAlarm-D√§moon bi't Anmellen automaatsch starten
-Comment[ne]=‡§≤‡§ó‡§á‡§®‡§Æ‡§æ ‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡•ã‡§® ‡§∏‡•ç‡§µ‡§§: ‡§∏‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§π‡•Å‡§®‡•ç‡§õ
+Comment[ne]=‡§≤‡§ó‡§á‡§®‡§Æ‡§æ ‡§ï‡•á‡§°‡•Ä‡§à ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§∏‡§Ç‡§∏‡•Ç‡§ö‡§ï ‡§°‡•á‡§á‡§Æ‡§® ‡§∏‡•ç‡§µ‡§§: ‡§∏‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§π‡•Å‡§®‡•ç‡§õ
 Comment[nl]=KAlarm alarmdaemon automatisch starten bij login
 Comment[nn]=Start alarmnisse ved innlogging
 Comment[pl]=Demon alarmu KOrganizera uruchamiany przy zalogowaniu
Index: kalarm/kalarmd/admain.cpp
===================================================================
--- kalarm/kalarmd/admain.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmd/admain.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -41,7 +41,7 @@
 {
 	KAboutData aboutData(DAEMON_APP_NAME, I18N_NOOP("KAlarm Daemon"),
 	                     DAEMON_VERSION, I18N_NOOP("KAlarm Alarm Daemon"), KAboutData::License_GPL,
-	                     "Copyright 1997-1999 Preston Brown\nCopyright 2000-2001 Cornelius Schumacher\nCopyright 2001,2004-2006 David Jarvie", 0,
+	                     "Copyright 1997-1999 Preston Brown\nCopyright 2000-2001 Cornelius Schumacher\nCopyright 2001,2004-2007 David Jarvie", 0,
 	                     "http://www.astrojar.org.uk/kalarm");
 	aboutData.addAuthor("David Jarvie", I18N_NOOP("Maintainer"), "software@astrojar.org.uk");
 	aboutData.addAuthor("Cornelius Schumacher", I18N_NOOP("Author"), "schumacher@kde.org");
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,12 +1,21 @@
 KAlarm
 
-=== Version 1.4.12 --- 11 May 2007 ===
+=== Version 1.4.14 --- 5 August 2007 ===
+Fix handling of exception dates in recurrences.
+In sound file dialogue change Play button to a Stop button while playing a file.
+
+=== Version 1.4.13 --- 18 May 2007 ===
+Fix time value in templates not being stored.
+Expand time spin boxes to make room for all digits.
+Make Preferences dialogue non-modal.
+
+=== Version 1.4.12 (KDE 3.5.7) --- 11 May 2007 ===
 Display advance reminders for each occurrence of recurring alarms.
 Fix Undo of deletion of active alarms.
 Disable simple repetition controls if repetitions can't fit between recurrences.
 Make the system tray tooltip take account of alarm repetitions.
 Show repetition & special action status by button states in alarm edit dialogue.
-Fix reminder alarms displaying very large numbers for time until alarm is due.
+Fix reminder alarms displaying very big numbers for how long until alarm is due.
 Fix KMail omitting attachments from email alarms (if KMail is the email client).
 
 === Version 1.4.11 --- 16 April 2007 ===
Index: kalarm/kalarmapp.cpp
===================================================================
--- kalarm/kalarmapp.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarmapp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1683,11 +1683,7 @@
 				kdDebug(5950) << "KAlarmApp::execAlarm(): COMMAND: (script)" << endl;
 				QString tmpfile = createTempScriptFile(command, false, event, alarm);
 				if (tmpfile.isEmpty())
-				{
-					QStringList errmsgs(i18n("Error creating temporary script file"));
-					(new MessageWin(event, alarm.dateTime(), errmsgs))->show();
 					result = 0;
-				}
 				else
 					result = doShellCommand(tmpfile, event, &alarm, (flags | ProcData::TEMP_FILE));
 			}
Index: kalarm/sounddlg.cpp
===================================================================
--- kalarm/sounddlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/sounddlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -34,7 +34,15 @@
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kiconloader.h>
+#ifdef WITHOUT_ARTS
 #include <kaudioplayer.h>
+#else
+#include <qtimer.h>
+#include <arts/kartsdispatcher.h>
+#include <arts/kartsserver.h>
+#include <arts/kplayobjectfactory.h>
+#include <arts/kplayobject.h>
+#endif
 #include <kmessagebox.h>
 #include <kio/netaccess.h>
 #include <kdebug.h>
@@ -42,6 +50,7 @@
 #include "checkbox.h"
 #include "functions.h"
 #include "lineedit.h"
+#include "mainwindow.h"
 #include "pushbutton.h"
 #include "slider.h"
 #include "soundpicker.h"
@@ -62,7 +71,10 @@
 SoundDlg::SoundDlg(const QString& file, float volume, float fadeVolume, int fadeSeconds, bool repeat,
                    const QString& caption, QWidget* parent, const char* name)
 	: KDialogBase(parent, name, true, caption, Ok|Cancel, Ok, false),
-	  mReadOnly(false)
+	  mReadOnly(false),
+	  mArtsDispatcher(0),
+	  mPlayObject(0),
+	  mPlayTimer(0)
 {
 	QWidget* page = new QWidget(this);
 	setMainWidget(page);
@@ -179,6 +191,11 @@
 	slotVolumeToggled(volume >= 0);
 }
 
+SoundDlg::~SoundDlg()
+{
+	stopPlay();
+}
+
 /******************************************************************************
 * Set the read-only status of the dialogue.
 */
@@ -261,31 +278,125 @@
 }
 
 /******************************************************************************
-* Called when the file play button is clicked.
+* Called when the file play/stop button is clicked.
 */
 void SoundDlg::playSound()
 {
+#ifdef WITHOUT_ARTS
 	if (checkFile())
 		KAudioPlayer::play(QFile::encodeName(mFileName));
+#else
+	if (mPlayObject)
+	{
+		stopPlay();
+		return;
+	}
+	if (!checkFile())
+		return;
+	KURL url(mFileName);
+	MainWindow* mmw = MainWindow::mainMainWindow();
+	if (!url.isValid()  ||  !KIO::NetAccess::exists(url, true, mmw)
+	||  !KIO::NetAccess::download(url, mLocalAudioFile, mmw))
+	{
+		kdError(5950) << "SoundDlg::playAudio(): Open failure: " << mFileName << endl;
+		KMessageBox::error(this, i18n("Cannot open audio file:\n%1").arg(mFileName));
+		return;
+	}
+	mPlayTimer = new QTimer(this);
+	connect(mPlayTimer, SIGNAL(timeout()), SLOT(checkAudioPlay()));
+	mArtsDispatcher = new KArtsDispatcher;
+	mPlayStarted = false;
+	mAudioFileStart = QTime::currentTime();
+	KArtsServer aserver;
+	Arts::SoundServerV2 sserver = aserver.server();
+	KDE::PlayObjectFactory factory(sserver);
+	mPlayObject = factory.createPlayObject(mLocalAudioFile, true);
+	mFilePlay->setPixmap(SmallIcon("player_stop"));
+	QToolTip::add(mFilePlay, i18n("Stop sound"));
+	QWhatsThis::add(mFilePlay, i18n("Stop playing the sound"));
+	connect(mPlayObject, SIGNAL(playObjectCreated()), SLOT(checkAudioPlay()));
+	if (!mPlayObject->object().isNull())
+		checkAudioPlay();
+#endif
 }
 
 /******************************************************************************
+*  Called when the audio file has loaded and is ready to play, or on a timer
+*  when play is expected to have completed.
+*  If it is ready to play, start playing it (for the first time or repeated).
+*  If play has not yet completed, wait a bit longer.
+*/
+void SoundDlg::checkAudioPlay()
+{
+#ifndef WITHOUT_ARTS
+	if (!mPlayObject)
+		return;
+	if (mPlayObject->state() == Arts::posIdle)
+	{
+		// The file has loaded and is ready to play, or play has completed
+		if (mPlayStarted)
+		{
+			// Play has completed
+			stopPlay();
+			return;
+		}
+
+		// Start playing the file
+		kdDebug(5950) << "SoundDlg::checkAudioPlay(): start\n";
+		mPlayStarted = true;
+		mPlayObject->play();
+	}
+
+	// The sound file is still playing
+	Arts::poTime overall = mPlayObject->overallTime();
+	Arts::poTime current = mPlayObject->currentTime();
+	int time = 1000*(overall.seconds - current.seconds) + overall.ms - current.ms;
+	if (time < 0)
+		time = 0;
+	kdDebug(5950) << "SoundDlg::checkAudioPlay(): wait for " << (time+100) << "ms\n";
+	mPlayTimer->start(time + 100, true);
+#endif
+}
+
+/******************************************************************************
+*  Called when play completes, the Silence button is clicked, or the window is
+*  closed, to terminate audio access.
+*/
+void SoundDlg::stopPlay()
+{
+#ifndef WITHOUT_ARTS
+	delete mPlayObject;      mPlayObject = 0;
+	delete mArtsDispatcher;  mArtsDispatcher = 0;
+	delete mPlayTimer;       mPlayTimer = 0;
+	if (!mLocalAudioFile.isEmpty())
+	{
+		KIO::NetAccess::removeTempFile(mLocalAudioFile);   // removes it only if it IS a temporary file
+		mLocalAudioFile = QString::null;
+	}
+	mFilePlay->setPixmap(SmallIcon("player_play"));
+	QToolTip::add(mFilePlay, i18n("Test the sound"));
+	QWhatsThis::add(mFilePlay, i18n("Play the selected sound file."));
+#endif
+}
+
+/******************************************************************************
 * Check whether the specified sound file exists.
 * Note that KAudioPlayer::play() can only cope with local files.
 */
 bool SoundDlg::checkFile()
 {
-	QString file = mFileEdit->text();
+	mFileName = mFileEdit->text();
 	KURL url;
-	if (KURL::isRelativeURL(file))
+	if (KURL::isRelativeURL(mFileName))
 	{
 		// It's not an absolute URL, so check for an absolute path
-		QFileInfo f(file);
+		QFileInfo f(mFileName);
 		if (!f.isRelative())
-			url.setPath(file);
+			url.setPath(mFileName);
 	}
 	else
-		url = KURL::fromPathOrURL(file);   // it's an absolute URL
+		url = KURL::fromPathOrURL(mFileName);   // it's an absolute URL
+#ifdef WITHOUT_ARTS
 	if (!url.isEmpty())
 	{
 		// It's an absolute path or URL.
@@ -297,6 +408,9 @@
 		}
 	}
 	else
+#else
+	if (url.isEmpty())
+#endif
 	{
 		// It's a relative path.
 		// Find the first sound resource that contains files.
@@ -311,7 +425,7 @@
 				if (dir.isReadable() && dir.count() > 2)
 				{
 					url.setPath(*it);
-					url.addPath(file);
+					url.addPath(mFileName);
 					if (KIO::NetAccess::exists(url, true, this))
 					{
 						mFileName = url.path();
@@ -321,16 +435,20 @@
 			}
 		}
 		url.setPath(QDir::homeDirPath());
-		url.addPath(file);
+		url.addPath(mFileName);
 		if (KIO::NetAccess::exists(url, true, this))
 		{
 			mFileName = url.path();
 			return true;
 		}
 	}
+#ifdef WITHOUT_ARTS
 	KMessageBox::sorry(this, i18n("File not found"));
 	mFileName = QString::null;
 	return false;
+#else
+	return true;
+#endif
 }
 
 /******************************************************************************
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.cpp  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -43,6 +43,9 @@
 #include <kiconloader.h>
 #include <kcolorcombo.h>
 #include <kstdguiitem.h>
+#ifdef Q_WS_X11
+#include <kwin.h>
+#endif
 #include <kdebug.h>
 
 #include <kalarmd/kalarmd.h>
@@ -92,9 +95,31 @@
 = Class KAlarmPrefDlg
 =============================================================================*/
 
+KAlarmPrefDlg* KAlarmPrefDlg::mInstance = 0;
+
+void KAlarmPrefDlg::display()
+{
+	if (!mInstance)
+	{
+		mInstance = new KAlarmPrefDlg;
+		mInstance->show();
+	}
+	else
+	{
+#ifdef Q_WS_X11
+		KWin::WindowInfo info = KWin::windowInfo(mInstance->winId(), NET::WMGeometry | NET::WMDesktop);
+		KWin::setCurrentDesktop(info.desktop());
+#endif
+		mInstance->showNormal();   // un-minimise it if necessary
+		mInstance->raise();
+		mInstance->setActiveWindow();
+	}
+}
+
 KAlarmPrefDlg::KAlarmPrefDlg()
-	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", true, true)
+	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", false, true)
 {
+	setWFlags(Qt::WDestructiveClose);
 	setIconListAllVisible(true);
 
 	QVBox* frame = addVBoxPage(i18n("General"), i18n("General"), DesktopIcon("misc"));
@@ -118,6 +143,7 @@
 
 KAlarmPrefDlg::~KAlarmPrefDlg()
 {
+	mInstance = 0;
 }
 
 // Restore all defaults in the options...
Index: kalarm/lib/timespinbox.cpp
===================================================================
--- kalarm/lib/timespinbox.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/lib/timespinbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.cpp  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2004,2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -268,6 +268,20 @@
 	mPm = mValidator->mPm = (value >= 720);
 }
 
+QSize TimeSpinBox::sizeHint() const
+{
+	QSize sz = SpinBox2::sizeHint();
+	QFontMetrics fm(font());
+	return QSize(sz.width() + fm.width(":"), sz.height());
+}
+
+QSize TimeSpinBox::minimumSizeHint() const
+{
+	QSize sz = SpinBox2::minimumSizeHint();
+	QFontMetrics fm(font());
+	return QSize(sz.width() + fm.width(":"), sz.height());
+}
+
 /******************************************************************************
  * Validate the time spin box input.
  * The entered time must either be 4 digits, or it must contain a colon, but
Index: kalarm/lib/timespinbox.h
===================================================================
--- kalarm/lib/timespinbox.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/lib/timespinbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.h  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -52,7 +52,7 @@
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
-		TimeSpinBox(bool use24hour, QWidget* parent = 0, const char* name = 0);
+		explicit TimeSpinBox(bool use24hour, QWidget* parent = 0, const char* name = 0);
 		/** Constructor for a non-wrapping time spin box which can be used to enter a length of time.
 		 *  @param minMinute The minimum value which the spin box can hold, in minutes.
 		 *  @param maxMinute  The maximum value which the spin box can hold, in minutes.
@@ -86,6 +86,9 @@
 		 */
 		static QString  shiftWhatsThis();
 
+		virtual QSize   sizeHint() const;
+		virtual QSize   minimumSizeHint() const;
+
 	public slots:
 		/** Sets the value of the spin box.
 		 *  @param minutes The new value of the spin box, expressed in minutes.
Index: kalarm/kalarm.desktop
===================================================================
--- kalarm/kalarm.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/kalarm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -72,4 +72,4 @@
 Terminal=false
 X-DCOP-ServiceType=Unique
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;Office;Calendar;
Index: kalarm/traywindow.cpp
===================================================================
--- kalarm/traywindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kalarm/traywindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -145,8 +145,7 @@
 */
 void TrayWindow::slotPreferences()
 {
-	KAlarmPrefDlg prefDlg;
-	prefDlg.exec();
+	KAlarmPrefDlg::display();
 }
 
 /******************************************************************************
Index: korn/KOrn.desktop
===================================================================
--- korn/KOrn.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/KOrn.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -74,4 +74,4 @@
 Name[ta]=‡Æï‡Ææ‡Æ∞‡Øç‡Æ©‡Øç
 Name[zh_TW]=Korn ‰ø°‰ª∂ÈÄöÁü•
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Network;X-KDE-More;
+Categories=Qt;KDE;Network;X-KDE-More;Office;Email;
Index: korn/mailsubject.cpp
===================================================================
--- korn/mailsubject.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/mailsubject.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,8 +1,13 @@
 #include"mailsubject.h"
 
-#include<kdebug.h>
+#include <kmime_codecs.h>
+#include <kcharsets.h>
+#include <kdebug.h>
+#include <kglobal.h>
 #include <klocale.h>
 #include <qdatetime.h>
+#include <qtextcodec.h>
+#include <ctype.h>
 
 KornMailSubject::KornMailSubject() : _id(0), _drop(0), _size(-1), _date(-1), _fullMessage(false)
 {
@@ -51,3 +56,134 @@
 		+ ", " + i18n("Sender:") + " " + _sender + ", " + i18n("Size:") + " " + QString::number(_size)
 		+ ", " + i18n("Date:") + " " + date.toString(Qt::ISODate);
 }
+
+QString KornMailSubject::decodeRFC2047String(const QCString& aStr)
+{
+	if ( aStr.isEmpty() )
+		return QString::null;
+
+	const QCString str = unfold( aStr );
+
+	if ( str.isEmpty() )
+		return QString::null;
+
+	if ( str.find( "=?" ) < 0 ) {
+		// No need to decode
+		return QString(str);
+	}
+
+	QString result;
+	QCString LWSP_buffer;
+	bool lastWasEncodedWord = false;
+
+	for ( const char * pos = str.data() ; *pos ; ++pos ) {
+		// collect LWSP after encoded-words,
+		// because we might need to throw it out
+		// (when the next word is an encoded-word)
+		if ( lastWasEncodedWord && isBlank( pos[0] ) ) {
+			LWSP_buffer += pos[0];
+			continue;
+		}
+		// verbatimly copy normal text
+		if (pos[0]!='=' || pos[1]!='?') {
+			result += LWSP_buffer + pos[0];
+			LWSP_buffer = 0;
+			lastWasEncodedWord = false;
+			continue;
+		}
+		// found possible encoded-word
+		const char * const beg = pos;
+		{
+			// parse charset name
+			QCString charset;
+			int i = 2;
+			pos += 2;
+			for ( ; *pos != '?' && ( *pos==' ' || ispunct(*pos) || isalnum(*pos) ); ++i, ++pos ) {
+				charset += *pos;
+			}
+			if ( *pos!='?' || i<4 )
+				goto invalid_encoded_word;
+
+			// get encoding and check delimiting question marks
+			const char encoding[2] = { pos[1], '\0' };
+			if (pos[2]!='?' || (encoding[0]!='Q' && encoding[0]!='q' &&
+			    encoding[0]!='B' && encoding[0]!='b'))
+				goto invalid_encoded_word;
+			pos+=3; i+=3; // skip ?x?
+			const char * enc_start = pos;
+			// search for end of encoded part
+			while ( *pos && !(*pos=='?' && *(pos+1)=='=') ) {
+				i++;
+				pos++;
+			}
+			if ( !*pos )
+				goto invalid_encoded_word;
+
+			// valid encoding: decode and throw away separating LWSP
+			const KMime::Codec * c = KMime::Codec::codecForName( encoding );
+			kdFatal( !c ) << "No \"" << encoding << "\" codec!?" << endl;
+
+			QByteArray in; in.setRawData( enc_start, pos - enc_start );
+			const QByteArray enc = c->decode( in );
+			in.resetRawData( enc_start, pos - enc_start );
+
+			const QTextCodec * codec = codecForName(charset);
+			if (!codec) return QString::null;
+			result += codec->toUnicode(enc);
+			lastWasEncodedWord = true;
+
+			++pos; // eat '?' (for loop eats '=')
+			LWSP_buffer = 0;
+		}
+		continue;
+invalid_encoded_word:
+		// invalid encoding, keep separating LWSP.
+		pos = beg;
+		if ( !LWSP_buffer.isNull() )
+		result += LWSP_buffer;
+		result += "=?";
+		lastWasEncodedWord = false;
+		++pos; // eat '?' (for loop eats '=')
+		LWSP_buffer = 0;
+	}
+	return result;
+}
+
+QCString KornMailSubject::unfold( const QCString & header )
+{
+	if ( header.isEmpty() )
+		return QCString();
+
+	QCString result( header.size() ); // size() >= length()+1 and size() is O(1)
+	char * d = result.data();
+
+	for ( const char * s = header.data() ; *s ; )
+		if ( *s == '\r' ) { // ignore
+			++s;
+			continue;
+		} else if ( *s == '\n' ) { // unfold
+			while ( this->isBlank( *++s ) );
+			*d++ = ' ';
+		} else
+			*d++ = *s++;
+
+	*d++ = '\0';
+
+	result.truncate( d - result.data() );
+	return result;
+}
+
+//-----------------------------------------------------------------------------
+const QTextCodec* KornMailSubject::codecForName(const QCString& _str)
+{
+	if (_str.isEmpty()) return 0;
+		QCString codec = _str;
+	return KGlobal::charsets()->codecForName(codec);
+}
+
+void KornMailSubject::decodeHeaders()
+{
+	_subject = decodeRFC2047String( _subject.latin1() );
+	_sender = decodeRFC2047String( _sender.latin1() );
+}
+
Index: korn/password.cpp
===================================================================
--- korn/password.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/password.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -46,10 +46,10 @@
 	open();
 
 	if( !m_wallet || !m_wallet->isOpen() || m_openFailed )
-		return fallbackConfig.readEntry( "pass" );
+		return KMailDecrypt( fallbackConfig.readEntry( "pass" ) );
 
 	if( !m_wallet->hasFolder( "kmail" ) )
-		return fallbackConfig.readEntry( "pass" );
+		return KMailDecrypt( fallbackConfig.readEntry( "pass" ));
 	m_wallet->setFolder( "kmail" );
 
 	if( m_wallet->readPassword( QString( "account-%1" ).arg( accountnr ), password ) != 0 )
@@ -241,7 +241,7 @@
 {
 	QString result;
 	for (uint i = 0; i < enc.length(); i++)
-		result += (enc[i].unicode() < 0x20) ? enc[i] : QChar(0x1001F - enc[i].unicode());
+		result += (enc[i].unicode() <= 0x21) ? enc[i] : QChar(0x1001F - enc[i].unicode());
 
 	return result;
 }
Index: korn/kmail_proto.cpp
===================================================================
--- korn/kmail_proto.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/kmail_proto.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -59,7 +59,9 @@
 
 	if( type == "imap" )
 		return Protocols::getProto( "imap" );
-	if( type == "pop3" )
+        if( type == "cachedimap" )
+                return Protocols::getProto( "imap" );
+	if( type == "pop" )
 		return Protocols::getProto( "pop3" );
 	if( type == "local" )
 		return Protocols::getProto( "mbox" );
@@ -77,7 +79,7 @@
 	KConfig kmailconfig( "kmailrc", true, false );
 	QString type = getTypeAndConfig( config->readEntry( "kmailname" ), kmailconfig, id );
 
-	if( type == "imap" || type == "cachedimap" || type == "pop3" || type == "local" || type == "maildir" )
+	if( type == "imap" || type == "cachedimap" || type == "pop" || type == "local" || type == "maildir" )
 		return new KKioDrop();
 	
 	kdWarning() << "KMail configuration not found" << endl;
@@ -118,7 +120,7 @@
 		result->insert( "password", readPassword( kmailconfig.readBoolEntry( "store-passwd", false ), kmailconfig, id ) );
 		result->insert( "savepassword", kmailconfig.readEntry( "store-passwd", "false" ) );
 	}
-	if( type == "pop3" )
+	if( type == "pop" )
 	{
 		//Constructing metadata
 		if( kmailconfig.hasKey( "auth" ) )
@@ -188,7 +190,7 @@
 		kmailconfig.setGroup( QString( kmailGroupName ).arg( nummer ) );
 		type = kmailconfig.readEntry( kmailKeyType, QString::null );
 		name = kmailconfig.readEntry( kmailKeyName, QString::null );
-		if( type == "imap" || type == "cachedimap" || type == "pop3" || type == "local" )
+		if( type == "imap" || type == "cachedimap" || type == "pop" || type == "local" )
 		{
 			accountList.insert( name, name );
 		}
Index: korn/mailsubject.h
===================================================================
--- korn/mailsubject.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/mailsubject.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,6 +1,8 @@
 #ifndef MailSubject_h
 #define MailSubject_h
 
+class QTextCodec;
+
 class KMailDrop;
 
 #include "mailid.h"
@@ -147,6 +149,39 @@
 	 * Returns the KMailDrop instance of the Maildrop which owns the subject
 	 */
 	KMailDrop* getMailDrop() const { return _drop; }
+
+        /**
+         * decodes headers using decodeRFC2047String
+         */
+        void decodeHeaders();
+
+private:
+
+        /**
+         * Decode a string based on RFC2047
+         */
+        QString decodeRFC2047String(const QCString& aStr);
+
+        /**
+         * Unfolding a string (basically changing tabs to spaces
+         */
+        QCString unfold( const QCString & header );
+
+        /**
+         * Returns true if the parameter is a blank (or tab)
+         *
+         * Note from KMail's code, where this function is taken from:
+         * don't rely on isblank(), which is a GNU extension in
+         * <cctype>. But if someone wants to write a configure test for
+         * isblank(), we can then rename this function to isblank and #ifdef
+         * it's definition...
+         */
+        inline bool isBlank( char ch ) { return ch == ' ' || ch == '\t' ; }
+
+        /**
+         * ??
+         */
+        const QTextCodec* codecForName(const QCString& _str);
 };
 
 #endif
Index: korn/kio_single_subject.cpp
===================================================================
--- korn/kio_single_subject.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/kio_single_subject.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -142,6 +142,7 @@
 	} else {
 		KornMailSubject * mailSubject = new KornMailSubject( new KornStringId( *_name ), 0 );
 		parseMail( _message, mailSubject, _protocol->fullMessage() );
+		mailSubject->decodeHeaders();
 		mailSubject->setSize( _size );
 		emit readSubject( mailSubject );
 	}
Index: korn/Makefile.am
===================================================================
--- korn/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korn/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1,13 +1,14 @@
 KDE_CXXFLAGS = $(USE_RTTI)
 
-INCLUDES = $(all_includes)
+INCLUDES = -I$(top_srcdir)/libkmime \
+  	$(all_includes)
 #INCLUDES = -I$(top_srcdir)/mimelib -I$(top_srcdir)/libkmime $(all_includes)
 AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
 METASOURCES = AUTO
 
 bin_PROGRAMS = korn
-korn_LDADD = $(LIB_KIO)
+korn_LDADD = $(LIB_KIO) $(top_builddir)/libkmime/libkmime.la
 #korn_LDADD = $(top_builddir)/mimelib/libmimelib.la $(LIB_KFILE) $(LIBSOCKET) $(top_builddir)/libkmime/libkmime.la
 
 korn_SOURCES = \
Index: kaddressbook/kaddressbook.desktop
===================================================================
--- kaddressbook/kaddressbook.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/kaddressbook.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -74,7 +74,7 @@
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=kaddressbook
-MimeType=text/x-vcard;text/x-ldif
+MimeType=text/x-vcard;text/x-ldif;
 ServiceTypes=KParts/ReadOnlyPart,Browser/View,DCOP/AddressBook
 X-KDE-Library=libkaddressbookpart
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;ContactManagement;
Index: kaddressbook/editors/protocols/ircprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/ircprotocol.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/editors/protocols/ircprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -13,7 +13,7 @@
 Comment[kk]=Internet Relay Chat —Ö–∞–±–∞—Ä–ª–∞—Å—É
 Comment[km]=·ûá·ûá·üÇ·ûÄ‚Äã·ûÄ·üÜ·ûü·û∂·ûì·üí·ûè‚Äã·ûè·û∂·ûò·û¢·üä·û∏·ûì·ûí·û∫·ûé·û∑·ûè
 Comment[lt]=Estafetinis Interneto pokalbis
-Comment[ne]=‡§á‡§®‡•ç‡§ü‡§∞‡§®‡•á‡§ü‡§¨‡§æ‡§ü ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§£ ‡§ö‡•ç‡§Ø‡§æ‡§ü
+Comment[ne]=‡§á‡§®‡•ç‡§ü‡§∞‡§®‡•á‡§ü‡§¨‡§æ‡§ü ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§£ ‡§ï‡•Å‡§∞‡§æ‡§ï‡§æ‡§®‡•Ä
 Comment[pl]=IRC (Internet Relay Chat)
 Comment[pt_BR]=Protocolo de Bate-papo na Internet - IRC
 Comment[ru]=IRC
Index: kaddressbook/editors/kaddressbookimprotocol.desktop
===================================================================
--- kaddressbook/editors/kaddressbookimprotocol.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/editors/kaddressbookimprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,7 +30,7 @@
 Name[ms]=Protokol Penghantaran Mesej Segera KAddressbook 
 Name[nb]=KAdressbook lynmeldingsprotokoll
 Name[nds]=KAddressbook-Kortnarichten-Protokoll
-Name[ne]=‡§ï‡•á ‡§†‡•á‡§ó‡§æ‡§®‡§æ ‡§™‡•Å‡§∏‡•ç‡§§‡§ø‡§ï‡§æ ‡§¶‡•É‡§∑‡•ç‡§ü‡§æ‡§®‡•ç‡§§ ‡§∏‡§Ç‡§¶‡•á‡§∂‡§® ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ï‡§≤
+Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§†‡•á‡§ó‡§æ‡§®‡§æ‡§™‡•Å‡§∏‡•ç‡§§‡§ø‡§ï‡§æ ‡§¶‡•É‡§∑‡•ç‡§ü‡§æ‡§®‡•ç‡§§ ‡§∏‡§Ç‡§¶‡•á‡§∂‡§® ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ï‡§≤
 Name[nl]=KAddressbook Instant Messaging-protocol
 Name[nn]=Lynmeldingsprotokoll for KDE-adresseboka
 Name[pl]=Protok√≥≈Ç komunikacji internetowej KAddressbook
Index: kaddressbook/thumbnailcreator/ldifvcardcreator.cpp
===================================================================
--- kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -154,6 +154,8 @@
     mSplitter = new KPixmapSplitter;
     QString pixmap = locate( "data", "konqueror/pics/thumbnailfont_7x4.png" );
     if ( pixmap.isEmpty() ) {
+      delete mSplitter;
+      mSplitter=0;
       kdWarning() << "VCard_LDIFCreator: Font image \"thumbnailfont_7x4.png\" not found!\n";
       return false;
     }
Index: kaddressbook/features/distributionlistwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistwidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/features/distributionlistwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -446,8 +446,11 @@
   if ( !contactItem )
     return;
 
+  bool canceled = false;
   const QString email = EmailSelector::getEmail( contactItem->addressee().emails(),
-                                                 contactItem->email(), this );
+                                                 contactItem->email(), this, canceled);
+  if( canceled)
+     return;
   dist.removeEntry( contactItem->addressee(), contactItem->email() );
   dist.insertEntry( contactItem->addressee(), email );
 
@@ -620,7 +623,7 @@
 
 EmailSelector::EmailSelector( const QStringList &emails,
                               const QString &current, QWidget *parent )
-  : KDialogBase( KDialogBase::Plain, i18n("Select Email Address"), Ok, Ok,
+  : KDialogBase( KDialogBase::Plain, i18n("Select Email Address"), Ok|Cancel, Ok,
                parent )
 {
   QFrame *topFrame = plainPage();
@@ -654,12 +657,16 @@
 }
 
 QString EmailSelector::getEmail( const QStringList &emails,
-                                 const QString &current, QWidget *parent )
+                                 const QString &current, QWidget *parent, bool &canceled )
 {
   EmailSelector dlg( emails, current, parent );
-  dlg.exec();
-
-  return dlg.selected();
+  if(dlg.exec())
+  {
+    canceled = false;
+    return dlg.selected();
+  }
+  canceled = true;
+  return QString();
 }
 
 
Index: kaddressbook/features/distributionlistwidget.h
===================================================================
--- kaddressbook/features/distributionlistwidget.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kaddressbook/features/distributionlistwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -130,7 +130,7 @@
     QString selected() const;
 
     static QString getEmail( const QStringList &emails, const QString &current,
-                             QWidget *parent );
+                             QWidget *parent, bool &canceled );
 
   private:
     QButtonGroup *mButtonGroup;
Index: libkholidays/parseholiday.c
===================================================================
--- libkholidays/parseholiday.c	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkholidays/parseholiday.c	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -167,10 +167,6 @@
 
 #include <limits.h>
 
-#ifdef HAVE_MALLOC_H
-#include <malloc.h>
-#endif
-
 /*** Macro definitions and constants ***/
 /*
  * Before you mail and complain that the following macro is incorrect,
Index: libkholidays/parseholiday.y
===================================================================
--- libkholidays/parseholiday.y	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkholidays/parseholiday.y	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -32,10 +32,6 @@
 
 #include <limits.h>
 
-#ifdef HAVE_MALLOC_H
-#include <malloc.h>
-#endif
-
 /*** Macro definitions and constants ***/
 /*
  * Before you mail and complain that the following macro is incorrect,
Index: libkholidays/holidays/holiday_ua
===================================================================
--- libkholidays/holidays/holiday_ua	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkholidays/holidays/holiday_ua	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -9,9 +9,9 @@
 small	"–ù–æ–≤–∏–π –†—ñ–∫" weekend on 1.1
 small	"–†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ" weekend on 7.1
 small	"8 –ë–µ—Ä–µ–∑–Ω—è - –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –ñ—ñ–Ω–æ—á–∏–π –î–µ–Ω—å" weekend on 8.3
-small	"–í–µ–ª–∏–∫–¥–µ–Ω—å" weekend on easter
+small	"–í–µ–ª–∏–∫–¥–µ–Ω—å" weekend on pascha
 small	"1 –¢—Ä–∞–≤–Ω—è - –î–µ–Ω—å –ü—Ä–∞—Ü—ñ" weekend on 1.5 length 2 days
 small	"–î–µ–Ω—å –ü–µ—Ä–µ–º–æ–≥–∏" weekend on 9.5
-small	"–¢—Ä—ñ–π—Ü—è" weekend on easter plus 46 days
+small	"–¢—Ä—ñ–π—Ü—è" weekend on pascha plus 46 days
 small	"–î–µ–Ω—å –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü—ñ—ó –£–∫—Ä–∞—ó–Ω–∏" weekend on 28.6
 small	"–î–µ–Ω—å –ù–µ–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏" weekend on 24.8
Index: kitchensync/src/configguijescs.cpp
===================================================================
--- kitchensync/src/configguijescs.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguijescs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,98 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#include "configguijescs.h"
+
+#include <qcheckbox.h>
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiJescs::ConfigGuiJescs( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiJescs::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "url" ) {
+      mUrl->setText( element.text() );
+    } else if ( element.tagName() == "username" ) {
+      mUsername->setText( element.text() );
+    } else if ( element.tagName() == "password" ) {
+      mPassword->setText( element.text() );
+    } else if ( element.tagName() == "del_notify" ) {
+      mDelNotify->setChecked( element.text() == "1" );
+    }
+  }
+}
+
+QString ConfigGuiJescs::save() const
+{
+  int delNotifyState;
+  QString config = "<config>\n";
+
+  config += QString( "<url>%1</url>\n" ).arg( mUrl->text() );
+  config += QString( "<username>%1</username>\n" ).arg( mUsername->text() );
+  config += QString( "<password>%1</password>\n" ).arg( mPassword->text() );
+  if ( mDelNotify->isChecked() ) { delNotifyState = 1;
+  }  else { delNotifyState = 0;
+  }
+  config += QString( "<del_notify>%1</del_notify>\n" ).arg( delNotifyState );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiJescs::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "URL:" ), this ), 0, 0 );
+  mUrl = new KLineEdit( this );
+  layout->addMultiCellWidget( mUrl, 0, 0, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Username:" ), this ), 1, 0 );
+  mUsername = new KLineEdit( this );
+  layout->addMultiCellWidget( mUsername, 1, 1, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Password:" ), this ), 2, 0 );
+  mPassword = new KLineEdit( this );
+  mPassword->setEchoMode( KLineEdit::Password );
+  layout->addMultiCellWidget( mPassword, 2, 2, 1, 2 );
+
+  mDelNotify = new QCheckBox( this );
+  mDelNotify->setText( "Notify attendees about event/task deletion" );
+  layout->addMultiCellWidget( mDelNotify, 3, 3, 0, 2 );
+}
Index: kitchensync/src/configgui.cpp
===================================================================
--- kitchensync/src/configgui.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configgui.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -33,6 +33,11 @@
 #include "configguisyncmlhttp.h"
 #include "configguisyncmlobex.h"
 #include "configguigcalendar.h"
+#include "configguijescs.h"
+#include "configguievo2.h"
+#include "configguimoto.h"
+#include "configguisynce.h"
+#include "configguisunbird.h"
 
 #include "memberinfo.h"
 
@@ -96,6 +101,16 @@
     return new ConfigGuiLdap( member, parent );
   } else if ( name == "kdepim-sync" ) {
     return new ConfigGuiBlank( member, parent ); 
+  } else if ( name == "jescs-sync" ) {
+    return new ConfigGuiJescs( member, parent );
+  } else if ( name == "evo2-sync" ) {
+    return new ConfigGuiEvo2( member, parent );
+  } else if ( name == "moto-sync" ) {
+    return new ConfigGuiMoto( member, parent );
+  } else if ( name == "synce-plugin" ) {
+    return new ConfigGuiSynce( member, parent );
+  } else if ( name == "sunbird-sync" ) {
+    return new ConfigGuiSunbird( member, parent );
   } else {
     return new ConfigGuiXml( member, parent );
   }
@@ -114,7 +129,7 @@
   mTextEdit->setText( xml );
 }
 
-QString ConfigGuiXml::save()
+QString ConfigGuiXml::save() const
 {
   return mTextEdit->text();
 }
Index: kitchensync/src/configguignokii.h
===================================================================
--- kitchensync/src/configguignokii.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguignokii.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -39,7 +39,7 @@
     ConfigGuiGnokii( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QComboBox *mConnection;
Index: kitchensync/src/configguiblank.h
===================================================================
--- kitchensync/src/configguiblank.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiblank.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -29,7 +29,7 @@
     ConfigGuiBlank( const QSync::Member &member, QWidget *parent = 0 );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 };
 
 #endif
Index: kitchensync/src/configguipalm.h
===================================================================
--- kitchensync/src/configguipalm.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguipalm.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -36,7 +36,7 @@
     ConfigGuiPalm( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     void initGUI();
Index: kitchensync/src/configguiirmc.h
===================================================================
--- kitchensync/src/configguiirmc.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiirmc.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -42,7 +42,7 @@
     ConfigGuiIRMC( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   protected slots:
     void connectionTypeChanged( int type );
Index: kitchensync/src/configguisyncmlhttp.cpp
===================================================================
--- kitchensync/src/configguisyncmlhttp.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguisyncmlhttp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -186,7 +186,7 @@
   }
 }
 
-QString ConfigGuiSyncmlHttp::save()
+QString ConfigGuiSyncmlHttp::save() const
 {
   QString xml;
   xml = "<config>\n";
Index: kitchensync/src/configguisunbird.h
===================================================================
--- kitchensync/src/configguisunbird.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisunbird.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,130 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Tobias Koenig <tokoe@kde.org>
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#ifndef CONFIGGUISUNBIRD_H
+#define CONFIGGUISUNBIRD_H
+
+#include "configgui.h"
+
+class QWidget;
+class QSpinBox;
+class QCheckBox;
+class QVBoxLayout;
+class QSpacerItem;
+class QSignalMapper;
+
+class KURLRequester;
+class KPushButton;
+class KLineEdit;
+
+class LocalCalendar : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    LocalCalendar( QWidget *parent = 0 );
+    LocalCalendar( const QString &path,
+                   const QString &defaultcal,
+                   const QString &days, QWidget *parent = 0 );
+
+    KURLRequester *mPathRequester;
+    QCheckBox *mDaysCheckBox;
+    QSpinBox *mDaysSpinBox;
+    QCheckBox *mDefaultCheckBox;
+
+  signals:
+    void deleteRequest( LocalCalendar* );
+
+  private slots:
+    void deleteWidget();
+    void toggleDays( bool days );
+
+  private:
+    void initGui();
+};
+
+class WebdavCalendar : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    WebdavCalendar( QWidget *parent = 0 );
+    WebdavCalendar( const QString &username,
+                    const QString &password,
+                    const QString &url,
+                    const QString &defaultcal,
+                    const QString &days, QWidget *parent = 0 );
+
+    KLineEdit *mUrl;
+    QCheckBox *mDaysCheckBox;
+    QSpinBox *mDaysSpinBox;
+    QCheckBox *mDefaultCheckBox;
+    KLineEdit *mUsername;
+    KLineEdit *mPassword;
+
+  signals:
+    void deleteRequest( WebdavCalendar* );
+
+  private slots:
+    void deleteWidget();
+    void toggleDays( bool state );
+
+  private:
+    void initGui();
+};
+
+class ConfigGuiSunbird : public ConfigGui
+{
+  Q_OBJECT
+
+  public:
+    ConfigGuiSunbird( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  public slots:
+    void addLocalCalendar();
+    void addWebdavCalendar();
+
+    void delLocalCalendar( LocalCalendar* );
+    void delWebdavCalendar( WebdavCalendar* );
+
+  private:
+    QValueList<LocalCalendar*> mLocalList;
+    QValueList<WebdavCalendar*> mWebdavList;
+
+    QWidget *mLocalWidget;
+    QWidget *mWebdavWidget;
+
+    QVBoxLayout *mLocalLayout;
+    QVBoxLayout *mWebdavLayout;
+
+    KPushButton *mLocalAddButton;
+    KPushButton *mWebdavAddButton;
+
+    QSpacerItem *mLocalSpacer;
+    QSpacerItem *mWebdavSpacer;
+};
+
+#endif
Index: kitchensync/src/configguigpe.cpp
===================================================================
--- kitchensync/src/configguigpe.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguigpe.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -64,7 +64,7 @@
   }
 }
 
-QString ConfigGuiGpe::save()
+QString ConfigGuiGpe::save() const
 {
   QString config = "<config>";
 
Index: kitchensync/src/configguijescs.h
===================================================================
--- kitchensync/src/configguijescs.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguijescs.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,48 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#ifndef CONFIGGUIJESCS_H
+#define CONFIGGUIJESCS_H
+
+#include "configgui.h"
+
+class KLineEdit;
+class QCheckBox;
+
+class ConfigGuiJescs : public ConfigGui
+{
+  public:
+    ConfigGuiJescs( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KLineEdit *mUrl;
+    KLineEdit *mUsername;
+    KLineEdit *mPassword;
+    QCheckBox *mDelNotify;
+};
+
+#endif
Index: kitchensync/src/configguifile.cpp
===================================================================
--- kitchensync/src/configguifile.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguifile.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -66,7 +66,7 @@
   }
 }
 
-QString ConfigGuiFile::save()
+QString ConfigGuiFile::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/configguignokii.cpp
===================================================================
--- kitchensync/src/configguignokii.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguignokii.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -188,7 +188,7 @@
   }
 }
 
-QString ConfigGuiGnokii::save()
+QString ConfigGuiGnokii::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/configgui.h
===================================================================
--- kitchensync/src/configgui.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configgui.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -44,7 +44,7 @@
     QString instanceName() const;
 
     virtual void load( const QString &xml ) = 0;
-    virtual QString save() = 0;
+    virtual QString save() const = 0;
 
     QSync::Member member() const { return mMember; }
 
@@ -63,7 +63,7 @@
     ConfigGuiXml( const QSync::Member &, QWidget *parent );
 
     void load( const QString & );
-    QString save();
+    QString save() const;
 
   private:
     QTextEdit *mTextEdit;
Index: kitchensync/src/configguigcalendar.h
===================================================================
--- kitchensync/src/configguigcalendar.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguigcalendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -32,7 +32,7 @@
     ConfigGuiGoogleCalendar( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QLineEdit *mUsername;
Index: kitchensync/src/configguildap.h
===================================================================
--- kitchensync/src/configguildap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguildap.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -23,11 +23,13 @@
 #define CONFIGGUILDAP_H
 
 #include "configgui.h"
+#include "kabc/ldapconfigwidget.h"
 
 class QCheckBox;
 class QLabel;
 class QSpinBox;
 
+class KABC::LdapConfigWidget;
 class KComboBox;
 class KLineEdit;
 
@@ -39,36 +41,18 @@
     ConfigGuiLdap( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
-  private slots:
-    void bindModeChanged( bool );
-
   private:
     void initGUI();
 
-    KLineEdit *mServerName;
-    QSpinBox *mPort;
-
-    QLabel *mBindLabel;
-    QLabel *mPasswordLabel;
-    KLineEdit *mBindDn;
-    KLineEdit *mPassword;
-    QCheckBox *mAnonymousBind;
-
-    KLineEdit *mSearchBase;
-    KLineEdit *mSearchFilter;
-    KLineEdit *mStoreBase;
-
+    KABC::LdapConfigWidget *mLdapWidget;
     KLineEdit *mKeyAttribute;
-
     KComboBox *mSearchScope;
-    KComboBox *mAuthMech;
-
     QCheckBox *mEncryption;
-
     QCheckBox *mReadLdap;
     QCheckBox *mWriteLdap;
+
 };
 
 #endif
Index: kitchensync/src/configguiirmc.cpp
===================================================================
--- kitchensync/src/configguiirmc.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiirmc.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -91,7 +91,7 @@
   mCableWidget->load( docElement );
 }
 
-QString ConfigGuiIRMC::save()
+QString ConfigGuiIRMC::save() const
 {
   QDomDocument doc;
   QDomElement config = doc.createElement( "config" );
Index: kitchensync/src/configguisunbird.cpp
===================================================================
--- kitchensync/src/configguisunbird.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisunbird.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,367 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Tobias Koenig <tokoe@kde.org>
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#include "configguisunbird.h"
+
+#include <qdom.h>
+#include <qtabwidget.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qbuttongroup.h>
+#include <qcheckbox.h>
+#include <qsizepolicy.h>
+#include <qptrlist.h>
+#include <qspinbox.h>
+#include <qwidget.h>
+
+#include <kurlrequester.h>
+#include <klineedit.h>
+#include <kpushbutton.h>
+#include <kdialog.h>
+#include <klocale.h>
+#include <kfile.h>
+
+ConfigGuiSunbird::ConfigGuiSunbird( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  QTabWidget *tabWidget = new QTabWidget( this );
+  topLayout()->addWidget( tabWidget );
+
+  mLocalWidget = new QWidget( tabWidget );
+  mLocalLayout = new QVBoxLayout( mLocalWidget, KDialog::spacingHint() );
+
+  mWebdavWidget = new QWidget( tabWidget );
+  mWebdavLayout = new QVBoxLayout( mWebdavWidget, KDialog::spacingHint() );
+
+  tabWidget->addTab( mLocalWidget, i18n( "Local Calendars" ) );
+  tabWidget->addTab( mWebdavWidget, i18n( "WebDAV Calendars" ) );
+
+  KPushButton *mLocalAddButton = new KPushButton( mLocalWidget );
+  mLocalAddButton->setText( i18n( "Add new calendar" ) );
+  mLocalAddButton->setSizePolicy( QSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed ) );
+  mLocalLayout->addWidget( mLocalAddButton );
+  connect( mLocalAddButton, SIGNAL( clicked() ),
+           this, SLOT( addLocalCalendar() ) );
+
+  KPushButton *mWebdavAddButton = new KPushButton( mWebdavWidget );
+  mWebdavAddButton->setText( i18n( "Add new calendar" ) );
+  mWebdavAddButton->setSizePolicy( QSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed ) );
+  mWebdavLayout->addWidget( mWebdavAddButton );
+  connect( mWebdavAddButton, SIGNAL( clicked() ),
+           this, SLOT( addWebdavCalendar() ) );
+
+  mLocalSpacer = new QSpacerItem( 20, 40, QSizePolicy::Expanding );
+  mLocalLayout->addItem( mLocalSpacer );
+  mWebdavSpacer = new QSpacerItem( 20, 40, QSizePolicy::Expanding );
+  mWebdavLayout->addItem( mWebdavSpacer );
+}
+
+void ConfigGuiSunbird::load( const QString &xml )
+{
+  QString path;
+  QString url;
+  QString username;
+  QString password;
+  QString defaultcal;
+  QString days;
+
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "file" ) {
+      QDomAttr pathAttr = element.attributeNode( "path" );
+      path = pathAttr.value();
+      QDomAttr defaultAttr = element.attributeNode( "default" );
+      defaultcal = defaultAttr.value();
+      QDomAttr daysAttr = element.attributeNode( "deletedaysold" );
+      days = daysAttr.value();
+
+      LocalCalendar *cal = new LocalCalendar( path, defaultcal, days, mLocalWidget );
+      mLocalLayout->removeItem( mLocalSpacer );
+      cal->setSizePolicy( QSizePolicy( QSizePolicy::Expanding, QSizePolicy::Fixed ) );
+      mLocalLayout->addWidget( cal );
+      mLocalLayout->addItem( mLocalSpacer );
+      mLocalList.append( cal );
+
+      connect( cal, SIGNAL( deleteRequest( LocalCalendar* ) ), SLOT( delLocalCalendar( LocalCalendar* ) ) );
+      cal->show();
+    } else if ( element.tagName() == "webdav" ) {
+      QDomAttr urlAttr = element.attributeNode( "url" );
+      url = urlAttr.value();
+      QDomAttr unameAttr = element.attributeNode( "username" );
+      username = unameAttr.value();
+      QDomAttr pwordAttr = element.attributeNode( "password" );
+      password = pwordAttr.value();
+      QDomAttr defaultAttr = element.attributeNode( "default" );
+      defaultcal = defaultAttr.value();
+      QDomAttr daysAttr = element.attributeNode( "deletedaysold" );
+      days = daysAttr.value();
+
+      WebdavCalendar *cal = new WebdavCalendar( username, password,
+                                                url, defaultcal, days, mWebdavWidget );
+      mWebdavLayout->removeItem( mWebdavSpacer );
+      cal->setSizePolicy( QSizePolicy( QSizePolicy::Expanding, QSizePolicy::Fixed ) );
+      mWebdavLayout->addWidget( cal );
+      mWebdavLayout->addItem( mWebdavSpacer );
+      mWebdavList.append( cal );
+
+      connect( cal, SIGNAL( deleteRequest( WebdavCalendar* ) ), SLOT( delWebdavCalendar( WebdavCalendar* ) ) );
+      cal->show();
+    }
+  }
+}
+
+QString ConfigGuiSunbird::save() const
+{
+  QString config = "<config>\n";
+
+  for ( uint i = 0; i < mLocalList.count(); ++i ) {
+    LocalCalendar *lcal = mLocalList[ i ];
+    config += QString( "<file " );
+    config += QString( "path=\"%1\" " ).arg( lcal->mPathRequester->url() );
+
+    if ( lcal->mDaysCheckBox->isChecked() ) {
+      config += QString( "deletedaysold=\"%1\" " ).arg( lcal->mDaysSpinBox->value() );
+    }
+    if ( lcal->mDefaultCheckBox->isChecked() ) {
+      config += QString( "default=\"1\" " );
+    }
+    config += QString( "/>\n" );
+  }
+
+  for ( uint i = 0; i < mWebdavList.count(); ++i ) {
+    WebdavCalendar *wcal = mWebdavList[ i ];
+    config += QString( "<webdav " );
+    config += QString( "username=\"%1\" " ).arg( wcal->mUsername->text() );
+    config += QString( "password=\"%1\" " ).arg( wcal->mPassword->text() );
+    config += QString( "url=\"%1\" " ).arg( wcal->mUrl->text() );
+
+    if ( wcal->mDaysCheckBox->isChecked() ) {
+      config += QString( "deletedaysold=\"%1\" " ).arg( wcal->mDaysSpinBox->value() );
+    }
+    if ( wcal->mDefaultCheckBox->isChecked() ) {
+      config += QString( "default=\"1\" " );
+    }
+    config += QString( "/>\n" );
+  }
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiSunbird::addLocalCalendar()
+{
+  LocalCalendar *cal = new LocalCalendar( mLocalWidget );
+  mLocalLayout->removeItem( mLocalSpacer );
+  cal->setSizePolicy( QSizePolicy( QSizePolicy::Expanding, QSizePolicy::Fixed ) );
+  mLocalLayout->addWidget( cal );
+  mLocalLayout->addItem( mLocalSpacer );
+  mLocalList.append( cal );
+
+  connect( cal, SIGNAL( deleteRequest( LocalCalendar* ) ), SLOT( delLocalCalendar( LocalCalendar* ) ) );
+  cal->show();
+}
+
+void ConfigGuiSunbird::delLocalCalendar( LocalCalendar *calendar )
+{
+  mLocalList.remove( calendar );
+  calendar->deleteLater();
+}
+
+void ConfigGuiSunbird::addWebdavCalendar()
+{
+  WebdavCalendar *cal = new WebdavCalendar( mWebdavWidget );
+  mWebdavLayout->removeItem( mWebdavSpacer );
+  cal->setSizePolicy( QSizePolicy( QSizePolicy::Expanding, QSizePolicy::Fixed ) );
+  mWebdavLayout->addWidget( cal );
+  mWebdavLayout->addItem( mWebdavSpacer );
+  mWebdavList.append( cal );
+
+  connect( cal, SIGNAL( deleteRequest( WebdavCalendar* ) ), SLOT( delWebdavCalendar( WebdavCalendar* ) ) );
+  cal->show();
+}
+
+void ConfigGuiSunbird::delWebdavCalendar( WebdavCalendar *calendar )
+{
+  mWebdavList.remove( calendar );
+  calendar->deleteLater();
+}
+
+LocalCalendar::LocalCalendar( QWidget *parent )
+  : QWidget( parent )
+{
+  initGui();
+}
+
+LocalCalendar::LocalCalendar( const QString &path, const QString &defaultcal, const QString &days, QWidget *parent )
+  : QWidget( parent )
+{
+  initGui();
+
+  mPathRequester->setURL( path );
+  mDefaultCheckBox->setChecked( defaultcal.toInt() == 1 );
+
+  if ( !days.isEmpty() ) {
+    mDaysCheckBox->setChecked( true );
+    mDaysSpinBox->setEnabled( true );
+    mDaysSpinBox->setValue( days.toInt() );
+  }
+}
+
+void LocalCalendar::initGui()
+{
+  QBoxLayout *bottomLayout = new QHBoxLayout();
+
+  mDaysCheckBox = new QCheckBox( this );
+  mDaysCheckBox->setText( i18n( "Sync only events newer than" ) );
+
+  mDaysSpinBox = new QSpinBox( this );
+  mDaysSpinBox->setDisabled( true );
+  mDaysSpinBox->setSizePolicy( QSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed ) );
+
+  connect( mDaysCheckBox, SIGNAL( toggled( bool ) ),
+           this, SLOT( toggleDays( bool ) ) );
+
+  bottomLayout->addWidget( mDaysCheckBox );
+  bottomLayout->addWidget( mDaysSpinBox );
+  bottomLayout->addWidget( new QLabel( i18n( "day(s)" ), this ) );
+
+  QGridLayout *localLayout = new QGridLayout( this );
+
+  mPathRequester = new KURLRequester( this );
+
+  KPushButton *removeButton = new KPushButton( this );
+  removeButton->setSizePolicy( QSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed ) );
+  removeButton->setText( i18n( "Remove" ) );
+  connect( removeButton, SIGNAL( clicked() ),
+           this, SLOT( deleteWidget() ) );
+
+  mDefaultCheckBox = new QCheckBox( this );
+  mDefaultCheckBox->setText( i18n( "Set as Default" ) );
+
+  localLayout->addItem( new QSpacerItem( 40, 20, QSizePolicy::Expanding ), 0, 0 );
+  localLayout->addWidget( new QLabel( i18n( "Location:" ), this ), 1, 0 );
+  localLayout->addWidget( mPathRequester, 1, 1 );
+  localLayout->addItem( new QSpacerItem( 40, 20, QSizePolicy::Fixed ), 1, 2 );
+  localLayout->addWidget( removeButton, 1, 3 );
+  localLayout->addMultiCellLayout( bottomLayout, 2, 2, 0, 2 );
+  localLayout->addWidget( mDefaultCheckBox, 2, 3 ); 
+}
+
+void LocalCalendar::deleteWidget()
+{
+  emit deleteRequest( this );
+}
+
+WebdavCalendar::WebdavCalendar( QWidget *parent )
+  : QWidget( parent )
+{
+  initGui();
+};
+
+WebdavCalendar::WebdavCalendar( const QString &username, const QString &password, const QString &url,
+                                const QString &defaultcal, const QString &days, QWidget *parent )
+  : QWidget( parent )
+{
+  initGui();
+
+  mUsername->setText( username );
+  mPassword->setText( password );
+  mUrl->setText( url );
+  mDefaultCheckBox->setChecked( defaultcal.toInt() == 1 );
+
+  if ( !days.isEmpty() ) {
+    mDaysCheckBox->setChecked( true );
+    mDaysSpinBox->setEnabled( true );
+    mDaysSpinBox->setValue( days.toInt() );
+  }
+}
+
+void WebdavCalendar::initGui()
+{
+  QBoxLayout *bottomLayout = new QHBoxLayout();
+
+  mDaysCheckBox = new QCheckBox( this );
+  mDaysCheckBox->setText( i18n( "Sync only events newer than" ) );
+
+  mDaysSpinBox = new QSpinBox( this );
+  mDaysSpinBox->setDisabled( true );
+  mDaysSpinBox->setSizePolicy( QSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed ) );
+
+  connect( mDaysCheckBox, SIGNAL( toggled( bool ) ),
+           this, SLOT( toggleDays( bool ) ) );
+
+  bottomLayout->addWidget( mDaysCheckBox );
+  bottomLayout->addWidget( mDaysSpinBox );
+  bottomLayout->addWidget( new QLabel( i18n( "day(s)" ), this ) );
+
+  QGridLayout *webdavLayout = new QGridLayout();
+
+  mUrl = new KLineEdit( this );
+  mUsername = new KLineEdit( this );
+  mPassword = new KLineEdit( this );
+  mPassword->setEchoMode( KLineEdit::Password );
+
+  KPushButton *removeButton = new KPushButton( this );
+  removeButton->setText( i18n( "Remove" ) );
+  connect( removeButton, SIGNAL( clicked() ),
+           this, SLOT( deleteWidget() ) );
+
+  mDefaultCheckBox = new QCheckBox( this );
+  mDefaultCheckBox->setText( i18n( "Set as Default" ) );
+
+  webdavLayout->addWidget( new QLabel( i18n( "Location:" ), this ), 0, 0 );
+  webdavLayout->addWidget( mUrl, 0, 1 );
+  webdavLayout->addItem( new QSpacerItem( 40, 20, QSizePolicy::Fixed ), 0, 2 );
+  webdavLayout->addWidget( removeButton, 0, 3 );
+  webdavLayout->addMultiCellLayout( bottomLayout, 1, 1, 0, 1 );
+  webdavLayout->addWidget( mDefaultCheckBox, 1, 3 );
+
+  QGridLayout *mainLayout = new QGridLayout( this );
+  mainLayout->addItem( new QSpacerItem( 40, 20, QSizePolicy::Fixed ), 0, 0 );
+  mainLayout->addMultiCellLayout( webdavLayout, 1, 1, 0, 4 );
+  mainLayout->addWidget( new QLabel( i18n( "Username:" ), this ), 2, 0 );
+  mainLayout->addWidget( mUsername, 2, 1 );
+  mainLayout->addItem( new QSpacerItem( 40, 20, QSizePolicy::Fixed ), 2, 2 );
+  mainLayout->addWidget( new QLabel( i18n( "Password:" ), this ), 2, 3 );
+  mainLayout->addWidget( mPassword, 2, 4 );
+}
+
+void WebdavCalendar::deleteWidget()
+{
+  emit deleteRequest( this );
+}
+
+void LocalCalendar::toggleDays( bool state )
+{
+  mDaysSpinBox->setEnabled( state );
+}
+
+void WebdavCalendar::toggleDays( bool state )
+{
+  mDaysSpinBox->setEnabled( state );
+}
+
+#include "configguisunbird.moc"
Index: kitchensync/src/configguisyncmlhttp.h
===================================================================
--- kitchensync/src/configguisyncmlhttp.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguisyncmlhttp.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -41,7 +41,7 @@
     ConfigGuiSyncmlHttp( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QGridLayout *mGridLayout;
Index: kitchensync/src/configguievo2.cpp
===================================================================
--- kitchensync/src/configguievo2.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguievo2.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,91 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#include "configguievo2.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qstring.h>
+
+#include <kurlrequester.h>
+#include <kurl.h>
+#include <kfile.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiEvo2::ConfigGuiEvo2( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiEvo2::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "address_path" ) {
+      mAddressPath->setURL( element.text() );
+    } else if ( element.tagName() == "calendar_path" ) {
+      mCalendarPath->setURL( element.text() ) ;
+    } else if ( element.tagName() == "tasks_path" ) {
+      mTasksPath->setURL( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiEvo2::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<address_path>%1</address_path>\n" ).arg( mAddressPath->url() );
+  config += QString( "<calendar_path>%1</calendar_path>\n" ).arg( mCalendarPath->url() );
+  config += QString( "<tasks_path>%1</tasks_path>\n" ).arg( mTasksPath->url() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiEvo2::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "Address Book location:" ), this ), 0, 0 );
+  mAddressPath = new KURLRequester( this );
+  mAddressPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mAddressPath, 0, 0, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Calendar location:" ), this ), 1, 0 );
+  mCalendarPath = new KURLRequester( this );
+  mCalendarPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mCalendarPath, 1, 1, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Task list location:" ), this ), 2, 0 );
+  mTasksPath = new KURLRequester( this );
+  mTasksPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mTasksPath, 2, 2, 1, 2 );
+}
Index: kitchensync/src/configguigcalendar.cpp
===================================================================
--- kitchensync/src/configguigcalendar.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguigcalendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -80,7 +80,7 @@
   }
 }
 
-QString ConfigGuiGoogleCalendar::save()
+QString ConfigGuiGoogleCalendar::save() const
 {
   QDomDocument doc;
   QDomElement root = doc.createElement("config");
Index: kitchensync/src/configguigpe.h
===================================================================
--- kitchensync/src/configguigpe.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguigpe.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -35,7 +35,7 @@
     ConfigGuiGpe( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     void initGUI();
Index: kitchensync/src/configguildap.cpp
===================================================================
--- kitchensync/src/configguildap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguildap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -37,13 +37,9 @@
 {
   initGUI();
 
-  bindModeChanged( false );
-
   mSearchScope->insertItem( i18n( "Base" ) );
   mSearchScope->insertItem( i18n( "One" ) );
   mSearchScope->insertItem( i18n( "Sub" ) );
-
-  mAuthMech->insertItem( i18n( "Simple" ) );
 }
 
 void ConfigGuiLdap::load( const QString &xml )
@@ -55,43 +51,36 @@
   for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
     QDomElement element = node.toElement();
     if ( element.tagName() == "servername" ) {
-      mServerName->setText( element.text() );
+      mLdapWidget->setHost( element.text() );
     } else if ( element.tagName() == "serverport" ) {
-      mPort->setValue( element.text().toInt() );
+      mLdapWidget->setPort( element.text().toInt() );
     } else if ( element.tagName() == "binddn" ) {
-      mBindDn->setText( element.text() );
+      mLdapWidget->setBindDN( element.text() );
     } else if ( element.tagName() == "password" ) {
-      mPassword->setText( element.text() );
-    } else if ( element.tagName() == "anonymous" ) {
-      mAnonymousBind->setChecked( element.text().toInt() == 1 );
+      mLdapWidget->setPassword( element.text() );
+    } else if ( element.tagName() == "anonymous" ) { 
+        mLdapWidget->setAuthAnon( element.text().toInt() == 1 );
     } else if ( element.tagName() == "searchbase" ) {
-      mSearchBase->setText( element.text() );
+      mLdapWidget->setDn( element.text() );
     } else if ( element.tagName() == "searchfilter" ) {
-      mSearchFilter->setText( element.text() );
+      mLdapWidget->setFilter( element.text() );
     } else if ( element.tagName() == "storebase" ) {
-      mStoreBase->setText( element.text() );
+      mLdapWidget->setDn( element.text() );
     } else if ( element.tagName() == "keyattr" ) {
       mKeyAttribute->setText( element.text() );
     } else if ( element.tagName() == "scope" ) {
       QStringList list;
       list << "base" << "one" << "sub";
-
       for ( uint i = 0; i < list.count(); ++i )
         if ( list[ i ] == element.text() )
           mSearchScope->setCurrentItem( i );
 
     } else if ( element.tagName() == "authmech" ) {
-      QStringList list;
-      list << "SIMPLE";
-
-      for ( uint i = 0; i < list.count(); ++i )
-        if ( list[ i ] == element.text() )
-          mAuthMech->setCurrentItem( i );
-
+      if ( element.text() == "SIMPLE" ) {
+        mLdapWidget->setAuthSimple( true );
+      }
     } else if ( element.tagName() == "encryption" ) {
-      mEncryption->setChecked( element.text().toInt() == 1 );
-    } else if ( element.tagName() == "encryption" ) {
-      mEncryption->setChecked( element.text().toInt() == 1 );
+        mEncryption->setChecked( element.text().toInt() == 1 );
     } else if ( element.tagName() == "ldap_read" ) {
       mReadLdap->setChecked( element.text().toInt() == 1 );
     } else if ( element.tagName() == "ldap_write" ) {
@@ -100,110 +89,65 @@
   }
 }
 
-QString ConfigGuiLdap::save()
+QString ConfigGuiLdap::save() const
 {
-  QString config = "<config>";
+  QString config = "<config>\n";
 
-  config += QString( "<servername>%1</servername>" ).arg( mServerName->text() );
-  config += QString( "<serverport>%1</serverport>" ).arg( mPort->value() );
-  config += QString( "<binddn>%1</binddn>" ).arg( mBindDn->text() );
-  config += QString( "<password>%1</password>" ).arg( mPassword->text() );
-  config += QString( "<anonymous>%1</anonymous>" ).arg( mAnonymousBind->isChecked() ? "1" : "0" );
-  config += QString( "<searchbase>%1</searchbase>" ).arg( mSearchBase->text() );
-  config += QString( "<searchfilter>%1</searchfilter>" ).arg( mSearchFilter->text() );
-  config += QString( "<storebase>%1</storebase>" ).arg( mStoreBase->text() );
-  config += QString( "<keyattr>%1</keyattr>" ).arg( mKeyAttribute->text() );
+  config += QString( "<servername>%1</servername>\n" ).arg( mLdapWidget->host() );
+  config += QString( "<serverport>%1</serverport>\n" ).arg( mLdapWidget->port() );
+  config += QString( "<binddn>%1</binddn>\n" ).arg( mLdapWidget->bindDN() );
+  config += QString( "<password>%1</password>\n" ).arg( mLdapWidget->password() );
+  config += QString( "<anonymous>%1</anonymous>\n" ).arg( mLdapWidget->isAuthAnon() ? "1" : "0" );
+  config += QString( "<searchbase>%1</searchbase>\n" ).arg( mLdapWidget->dn() );
+  config += QString( "<searchfilter>%1</searchfilter>\n" ).arg( mLdapWidget->filter() );
+  config += QString( "<storebase>%1</storebase>\n" ).arg( mLdapWidget->dn() );
+  config += QString( "<keyattr>%1</keyattr>\n" ).arg( mKeyAttribute->text() );
 
   QStringList scopes;
   scopes << "base" << "one" << "sub";
 
-  config += QString( "<scope>%1</scope>" ).arg( scopes[ mSearchScope->currentItem() ] );
+  config += QString( "<scope>%1</scope>\n" ).arg( scopes[ mSearchScope->currentItem() ] );
 
-  QStringList authMechs;
-  authMechs << "SIMPLE";
+  config += QString( "<authmech>SIMPLE</authmech>\n" );
+  config += QString( "<encryption>%1</encryption>\n" ).arg( mEncryption->isChecked() ? "1" : "0" );
 
-  config += QString( "<authmech>%1</authmech>" ).arg( authMechs[ mAuthMech->currentItem() ] );
-  config += QString( "<encryption>%1</encryption>" ).arg( mEncryption->isChecked() ? "1" : "0" );
+  config += QString( "<ldap_read>%1</ldap_read>\n" ).arg( mReadLdap->isChecked() ? "1" : "0" );
+  config += QString( "<ldap_write>%1</ldap_write>\n" ).arg( mWriteLdap->isChecked() ? "1" : "0" );
 
-  config += QString( "<ldap_read>%1</ldap_read>" ).arg( mReadLdap->isChecked() ? "1" : "0" );
-  config += QString( "<ldap_write>%1</ldap_write>" ).arg( mWriteLdap->isChecked() ? "1" : "0" );
-
   config += "</config>";
 
   return config;
 }
 
-void ConfigGuiLdap::bindModeChanged( bool checked )
-{
-  mBindLabel->setEnabled( !checked );
-  mBindDn->setEnabled( !checked );
-
-  mPasswordLabel->setEnabled( !checked );
-  mPassword->setEnabled( !checked );
-}
-
 void ConfigGuiLdap::initGUI()
 {
   QGridLayout *layout = new QGridLayout( topLayout(), 12, 4, KDialog::spacingHint() );
   layout->setMargin( KDialog::marginHint() );
 
-  layout->addWidget( new QLabel( i18n( "Server:" ), this ), 0, 0 );
-  mServerName = new KLineEdit( this );
-  layout->addWidget( mServerName, 0, 1 );
+  mLdapWidget = new KABC::LdapConfigWidget( KABC::LdapConfigWidget::W_HOST |
+                                            KABC::LdapConfigWidget::W_PORT |
+                                            KABC::LdapConfigWidget::W_USER |
+                                            KABC::LdapConfigWidget::W_PASS |
+                                            KABC::LdapConfigWidget::W_BINDDN |
+                                            KABC::LdapConfigWidget::W_DN |
+                                            KABC::LdapConfigWidget::W_FILTER |
+                                            KABC::LdapConfigWidget::W_AUTHBOX, this );
 
-  layout->addWidget( new QLabel( i18n( "Port:" ), this ), 0, 2, Qt::AlignRight );
-  mPort = new QSpinBox( 1, 65536, 1, this );
-  layout->addWidget( mPort, 0, 3 );
-
-  mAnonymousBind = new QCheckBox( i18n( "Use anonymous bind" ), this );
-  layout->addMultiCellWidget( mAnonymousBind, 1, 1, 0, 1 );
-
-  connect( mAnonymousBind, SIGNAL( toggled( bool ) ),
-           this, SLOT( bindModeChanged( bool ) ) );
-
-  mBindLabel = new QLabel( i18n( "Bind Dn:" ), this );
-  layout->addWidget( mBindLabel, 2, 0 );
-  mBindDn = new KLineEdit( this );
-  layout->addMultiCellWidget( mBindDn, 2, 2, 1, 3 );
-
-  mPasswordLabel = new QLabel( i18n( "Password:" ), this );
-  layout->addWidget( mPasswordLabel, 3, 0 );
-  mPassword = new KLineEdit( this );
-  mPassword->setEchoMode( QLineEdit::Password );
-  layout->addMultiCellWidget( mPassword, 3, 3, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Search Base:" ), this ), 4, 0 );
-  mSearchBase = new KLineEdit( this );
-  layout->addMultiCellWidget( mSearchBase, 4, 4, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Search Filter:" ), this ), 5, 0 );
-  mSearchFilter = new KLineEdit( this );
-  layout->addMultiCellWidget( mSearchFilter, 5, 5, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Storage Base:" ), this ), 6, 0 );
-  mStoreBase = new KLineEdit( this );
-  layout->addMultiCellWidget( mStoreBase, 6, 6, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Key Attribute:" ), this ), 7, 0 );
   mKeyAttribute = new KLineEdit( this );
-  layout->addMultiCellWidget( mKeyAttribute, 7, 7, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Search Scope:" ), this ), 8, 0 );
   mSearchScope = new KComboBox( this );
-  layout->addMultiCellWidget( mSearchScope, 8, 8, 1, 3 );
-
-  layout->addWidget( new QLabel( i18n( "Authentication Mechanism:" ), this ), 9, 0 );
-  mAuthMech = new KComboBox( this );
-  layout->addMultiCellWidget( mAuthMech, 9, 9, 1, 3 );
-
   mEncryption = new QCheckBox( i18n( "Use encryption" ), this );
-  layout->addMultiCellWidget( mEncryption, 10, 10, 0, 3 );
-
   mReadLdap = new QCheckBox( i18n( "Load data from LDAP" ), this );
-  layout->addMultiCellWidget( mReadLdap, 11, 11, 0, 1 );
-
   mWriteLdap = new QCheckBox( i18n( "Save data to LDAP" ), this );
-  layout->addMultiCellWidget( mWriteLdap, 11, 11, 2, 3 );
+
+  layout->addMultiCellWidget( mLdapWidget, 0, 9, 0, 3 );
+  layout->addWidget( new QLabel( i18n( "Key Attribute:" ), this ), 10, 0 );
+  layout->addMultiCellWidget( mKeyAttribute, 10, 10, 1, 2 );
+  layout->addWidget( new QLabel( i18n( "Search Scope:" ), this ), 11, 0 );
+  layout->addMultiCellWidget( mSearchScope, 11, 11, 1, 2 );
+  layout->addWidget( mEncryption, 12, 0 );
+  layout->addWidget( mReadLdap, 13, 0 );
+  layout->addWidget( mWriteLdap, 13, 3 );
+
 }
 
 #include "configguildap.moc"
Index: kitchensync/src/configguisynce.cpp
===================================================================
--- kitchensync/src/configguisynce.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisynce.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,93 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#include "configguisynce.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qcheckbox.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiSynce::ConfigGuiSynce( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiSynce::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "contact" ) {
+      mContacts->setChecked( element.text().toInt() == 1 );
+    } else if ( element.tagName() == "todos" ) {
+      mTodos->setChecked( element.text().toInt() == 1 );
+    } else if ( element.tagName() == "calendar" ) {
+      mCalendar->setChecked( element.text().toInt() == 1 );
+    } else if ( element.tagName() == "file" ) {
+      mFile->setText( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiSynce::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<contact>%1</contact>\n" ).arg( mContacts->isChecked() ? "1" : "0" );
+  config += QString( "<todos>%1</todos>\n" ).arg( mTodos->isChecked() ? "1" : "0" );
+  config += QString( "<calendar>%1</calendar>\n" ).arg( mCalendar->isChecked() ? "1" : "0" );
+  config += QString( "<file>%1</file>\n" ).arg( mFile->text() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiSynce::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 2, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  mContacts = new QCheckBox( this );
+  mContacts->setText( "Sync Contacts" );
+  layout->addMultiCellWidget( mContacts, 0, 0, 0, 1 );
+
+  mTodos = new QCheckBox( this );
+  mTodos->setText( "Sync \'Todo\' items" );
+  layout->addMultiCellWidget( mTodos, 1, 1, 0, 1 );
+
+  mCalendar = new QCheckBox( this );
+  mCalendar->setText( "Sync Calendar" );
+  layout->addMultiCellWidget( mCalendar, 2, 2, 0, 1 );
+
+  layout->addWidget( new QLabel( i18n( "File:" ), this ), 3, 0 );
+  mFile = new KLineEdit( this );
+  layout->addWidget( mFile, 3, 1 );
+}
Index: kitchensync/src/configguisyncmlobex.cpp
===================================================================
--- kitchensync/src/configguisyncmlobex.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguisyncmlobex.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -237,7 +237,7 @@
   }
 }
 
-QString ConfigGuiSyncmlObex::save()
+QString ConfigGuiSyncmlObex::save() const
 {
   QString xml;
   xml = "<config>\n";
Index: kitchensync/src/configguimoto.h
===================================================================
--- kitchensync/src/configguimoto.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguimoto.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,43 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#ifndef CONFIGGUIMOTO_H
+#define CONFIGGUIMOTO_H
+
+#include "configgui.h"
+
+class KLineEdit;
+
+class ConfigGuiMoto : public ConfigGui
+{
+  public:
+    ConfigGuiMoto( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KLineEdit *mDeviceString;
+};
+
+#endif
Index: kitchensync/src/configguifile.h
===================================================================
--- kitchensync/src/configguifile.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguifile.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -32,7 +32,7 @@
     ConfigGuiFile( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     KURLRequester *mFilename;
Index: kitchensync/src/memberinfo.cpp
===================================================================
--- kitchensync/src/memberinfo.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/memberinfo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -64,7 +64,8 @@
     nameMap.insert( "google-calendar", i18n( "Google Calendar" ) );
     nameMap.insert( "gpe-sync", i18n( "Handheld" ) );
     nameMap.insert( "sunbird-sync", i18n( "Sunbird Calendar" ) );
-
+    nameMap.insert( "jescs-sync", i18n( "Java Enterprise System Calendar" ) );
+    nameMap.insert( "synce-plugin", i18n( "WinCE Devices" ) );
   }
 
   if ( mMember.name().isEmpty() )
@@ -82,6 +83,7 @@
   if ( pluginName == "irmc-sync" ) return "mobile_phone";
   if ( pluginName == "evo2-sync" ) return "evolution";
   if ( pluginName == "opie-sync" ) return "pda_blue";
+  if ( pluginName == "synce-plugin" ) return "pda_blue";
   if ( pluginName == "ldap-sync" ) return "contents2";
   if ( pluginName == "syncml-obex-client" ) return "mobile_phone";
   if ( pluginName == "syncml-http-server" ) return "pda_blue";
@@ -90,6 +92,7 @@
   if ( pluginName == "google-calendar" ) return "www";
   if ( pluginName == "gpe-sync" ) return "pda_blue";
   if ( pluginName == "sunbird-sync" ) return "www";
+  if ( pluginName == "jescs-sync" ) return "www";
 
 
   return QString::null;
Index: kitchensync/src/configguiopie.h
===================================================================
--- kitchensync/src/configguiopie.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiopie.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -33,7 +33,7 @@
     ConfigGuiOpie( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QLineEdit *mDeviceIP;
Index: kitchensync/src/configguimoto.cpp
===================================================================
--- kitchensync/src/configguimoto.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguimoto.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,71 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#include "configguimoto.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiMoto::ConfigGuiMoto( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiMoto::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "device" ) {
+      mDeviceString->setText( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiMoto::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<device>%1</device>\n" ).arg( mDeviceString->text() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiMoto::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "Device String:" ), this ), 0, 0 );
+  mDeviceString = new KLineEdit( this );
+  layout->addMultiCellWidget( mDeviceString, 0, 0, 1, 2 );
+}
Index: kitchensync/src/configguievo2.h
===================================================================
--- kitchensync/src/configguievo2.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguievo2.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,46 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#ifndef CONFIGGUIEVO2_H
+#define CONFIGGUIEVO2_H
+
+#include "configgui.h"
+
+class KURLRequester;
+
+class ConfigGuiEvo2 : public ConfigGui
+{
+  public:
+    ConfigGuiEvo2( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KURLRequester *mAddressPath;
+    KURLRequester *mCalendarPath;
+    KURLRequester *mTasksPath;
+};
+
+#endif
Index: kitchensync/src/configguisynce.h
===================================================================
--- kitchensync/src/configguisynce.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisynce.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -0,0 +1,49 @@
+/*
+    This file is part of KitchenSync.
+
+    Copyright (c) 2007 Anirudh Ramesh <abattoir@abattoir.in>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
+    USA.
+*/
+
+#ifndef CONFIGGUISYNCE_H
+#define CONFIGGUISYNCE_H
+
+#include "configgui.h"
+
+class QCheckBox;
+
+class KLineEdit;
+
+class ConfigGuiSynce : public ConfigGui
+{
+  public:
+    ConfigGuiSynce( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    QCheckBox *mContacts;
+    QCheckBox *mTodos;
+    QCheckBox *mCalendar;
+    KLineEdit *mFile;
+};
+
+#endif
Index: kitchensync/src/configguiblank.cpp
===================================================================
--- kitchensync/src/configguiblank.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiblank.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -37,7 +37,7 @@
 {
 }
 
-QString ConfigGuiBlank::save()
+QString ConfigGuiBlank::save() const
 {
   QString xml = "<config></config>";
   return xml;
Index: kitchensync/src/configguisyncmlobex.h
===================================================================
--- kitchensync/src/configguisyncmlobex.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguisyncmlobex.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -43,7 +43,7 @@
     ConfigGuiSyncmlObex( const QSync::Member &, QWidget *parent = 0 );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   public slots:
      void slotConnectionChanged( int pos );
Index: kitchensync/src/configguipalm.cpp
===================================================================
--- kitchensync/src/configguipalm.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguipalm.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -88,7 +88,7 @@
   }
 }
 
-QString ConfigGuiPalm::save()
+QString ConfigGuiPalm::save() const
 {
   QString config = "<config>";
 
Index: kitchensync/src/configguiopie.cpp
===================================================================
--- kitchensync/src/configguiopie.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/configguiopie.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -119,7 +119,7 @@
   }
 }
 
-QString ConfigGuiOpie::save()
+QString ConfigGuiOpie::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/Makefile.am
===================================================================
--- kitchensync/src/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kitchensync/src/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -28,7 +28,9 @@
                             htmldiffalgodisplay.cpp genericdiffalgo.cpp multiconflictdialog.cpp \
                             configguiirmc.cpp \
                             configguisyncmlobex.cpp configguisyncmlhttp.cpp configguiopie.cpp  \
-                            configguignokii.cpp configguigcalendar.cpp configguildap.cpp configguigpe.cpp
+                            configguignokii.cpp configguigcalendar.cpp configguildap.cpp configguigpe.cpp \
+                            configguijescs.cpp configguievo2.cpp configguimoto.cpp configguisynce.cpp \
+                            configguisunbird.cpp
 libkitchensync_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -no-undefined
 libkitchensync_la_LIBADD = $(LIB_KIO) $(LIB_KHTML) $(top_builddir)/kitchensync/libqopensync/libqopensync.la \
                            $(LIB_KABC) $(top_builddir)/libkdepim/libkdepim.la $(top_builddir)/libkcal/libkcal.la
Index: libkdepim/recentaddresses.cpp
===================================================================
--- libkdepim/recentaddresses.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkdepim/recentaddresses.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -28,6 +28,7 @@
  *  your version.
  */
 #include "recentaddresses.h"
+#include "libemailfunctions/email.h"
 
 #include <kstaticdeleter.h>
 #include <kconfig.h>
@@ -98,24 +99,33 @@
 
 void RecentAddresses::add( const QString& entry )
 {
-    if ( !entry.isEmpty() && m_maxCount > 0 ) {
-        QString email;
-        QString fullName;
-        KABC::Addressee addr;
+  if ( !entry.isEmpty() && m_maxCount > 0 ) {
+    QStringList list = KPIM::splitEmailAddrList( entry );
+    for( QStringList::const_iterator e_it = list.begin(); e_it != list.end(); ++e_it ) {
+      KPIM::EmailParseResult errorCode = KPIM::isValidEmailAddress( *e_it );
+      if ( errorCode != KPIM::AddressOk ) 
+        continue;
+      QString email;
+      QString fullName;
+      KABC::Addressee addr;
 
-        KABC::Addressee::parseEmailAddress( entry, fullName, email );
+      KABC::Addressee::parseEmailAddress( *e_it, fullName, email );
 
-        for ( KABC::Addressee::List::Iterator it = m_addresseeList.begin();
-              it != m_addresseeList.end(); ++it )
-        {
-            if ( email == (*it).preferredEmail() )
-                return;//already inside
+      for ( KABC::Addressee::List::Iterator it = m_addresseeList.begin();
+          it != m_addresseeList.end(); ++it )
+      {
+        if ( email == (*it).preferredEmail() ) {
+          //already inside, remove it here and add it later at pos==1
+          m_addresseeList.remove( it );
+          break;
         }
-        addr.setNameFromString( fullName );
-        addr.insertEmail( email, true );
-        m_addresseeList.prepend( addr );
-        adjustSize();
+      }
+      addr.setNameFromString( fullName );
+      addr.insertEmail( email, true );
+      m_addresseeList.prepend( addr );
+      adjustSize();
     }
+  }
 }
 
 void RecentAddresses::setMaxCount( int count )
Index: libkcal/kcal_manager.desktop
===================================================================
--- libkcal/kcal_manager.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/kcal_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -51,6 +51,7 @@
 Name[sv]=Kalender
 Name[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø
 Name[tg]=–¢–∞“õ–≤–∏–º
+Name[th]=‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 Name[tr]=Takvim
 Name[uk]=–ö–∞–ª–µ–Ω–¥–∞—Ä
 Name[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä
Index: libkcal/vcalformat.cpp
===================================================================
--- libkcal/vcalformat.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/vcalformat.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -182,7 +182,10 @@
   // TODO: Use all data.
   Event::List events = calendar->events();
   Event *event = events.first();
-  if ( !event ) return QString::null;
+  if ( !event ) {
+    cleanVObject( vcal );
+    return QString::null;
+  }
 
   VObject *vevent = eventToVEvent( event );
 

Zmiany atrybut√≥w dla: libkcal/libical/zoneinfo
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: libkcal/icalformatimpl.cpp
===================================================================
--- libkcal/icalformatimpl.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/icalformatimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1982,7 +1982,13 @@
   while (c) {
 //    kdDebug(5800) << "----Todo found" << endl;
     Todo *todo = readTodo(c);
-    if (todo && !cal->todo(todo->uid())) cal->addTodo(todo);
+    if (todo) {
+      if (!cal->todo(todo->uid())) {
+        cal->addTodo(todo);
+      } else {
+        delete todo;
+      }
+    }
     c = icalcomponent_get_next_component(calendar,ICAL_VTODO_COMPONENT);
   }
 
@@ -1991,7 +1997,13 @@
   while (c) {
 //    kdDebug(5800) << "----Event found" << endl;
     Event *event = readEvent(c, ctz);
-    if (event && !cal->event(event->uid())) cal->addEvent(event);
+    if (event) {
+      if (!cal->event(event->uid())) {
+        cal->addEvent(event);
+      } else {
+        delete event;
+      }
+    }
     c = icalcomponent_get_next_component(calendar,ICAL_VEVENT_COMPONENT);
   }
 
@@ -2000,7 +2012,13 @@
   while (c) {
 //    kdDebug(5800) << "----Journal found" << endl;
     Journal *journal = readJournal(c);
-    if (journal && !cal->journal(journal->uid())) cal->addJournal(journal);
+    if (journal) {
+      if (!cal->journal(journal->uid())) {
+        cal->addJournal(journal);
+      } else {
+        delete journal;
+      }
+    }
     c = icalcomponent_get_next_component(calendar,ICAL_VJOURNAL_COMPONENT);
   }
 
Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -161,7 +161,7 @@
 QDateTime Todo::dtStart( bool first ) const
 {
   if ( doesRecur() && !first )
-    return mDtRecurrence.addDays( dtDue( true ).daysTo( IncidenceBase::dtStart() ) );
+    return mDtRecurrence.addDays( dtDue( first ).daysTo( IncidenceBase::dtStart() ) );
   else
     return IncidenceBase::dtStart();
 }
Index: libkcal/resourcecached.cpp
===================================================================
--- libkcal/resourcecached.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/resourcecached.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -44,9 +44,10 @@
 
 ResourceCached::ResourceCached( const KConfig* config )
   : ResourceCalendar( config ), mCalendar( QString::fromLatin1( "UTC" ) ),
-    mReloadPolicy( ReloadNever ),  mReloadInterval( 10 ), mReloaded( false ),
+    mReloadPolicy( ReloadNever ),  mReloadInterval( 10 ), 
+    mReloadTimer( 0, "mReloadTimer" ), mReloaded( false ),
     mSavePolicy( SaveNever ), mSaveInterval( 10 ),
-    mIdMapper( "kcal/uidmaps/" )
+    mSaveTimer( 0, "mSaveTimer" ), mIdMapper( "kcal/uidmaps/" )
 {
   connect( &mReloadTimer, SIGNAL( timeout() ), SLOT( slotReload() ) );
   connect( &mSaveTimer, SIGNAL( timeout() ), SLOT( slotSave() ) );
Index: libkcal/incidence.cpp
===================================================================
--- libkcal/incidence.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -321,9 +321,12 @@
 }
 
 void Incidence::removeRelation(Incidence *event)
+// Remove the relation of our incident. E.g. if you have a task t and a
+// subtask, the subtask will have its relation to the task t.
 {
   mRelations.removeRef(event);
 //  if (event->getRelatedTo() == this) event->setRelatedTo(0);
+  mRelatedToUid=QString();
 }
 
 
Index: libkcal/versit/vcc.y
===================================================================
--- libkcal/versit/vcc.y	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/versit/vcc.y	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -99,9 +99,6 @@
 #endif
 
 #include <string.h>
-#if !defined(__FreeBSD__) && !defined(__APPLE__)
-#include <malloc.h>
-#endif
 #include <stdio.h>
 #include <stdlib.h>
 #include <ctype.h>
Index: libkcal/versit/vcc.c
===================================================================
--- libkcal/versit/vcc.c	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ libkcal/versit/vcc.c	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -198,9 +198,6 @@
 #endif
 
 #include <string.h>
-#if !defined(__FreeBSD__) && !defined(__APPLE__)
-#include <malloc.h>
-#endif
 #include <stdio.h>
 #include <stdlib.h>
 #include <ctype.h>
Index: kpilot/conduits/timeconduit/time_conduit.desktop
===================================================================
--- kpilot/conduits/timeconduit/time_conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/timeconduit/time_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -30,7 +30,7 @@
 Comment[ms]=Saluran ini mengeset waktu pada komputer telapak anda dari jam PC.
 Comment[nb]=Denne kanalen stiller klokka p√• PDA-en fra PC-klokka.
 Comment[nds]=Synkroniseert stellt Handreekner-Klock na de PC-Klock.
-Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§™‡•Ä‡§∏‡•Ä ‡§ò‡§°‡§ø‡§¨‡§æ‡§ü ‡§π‡•ç‡§Ø‡§æ‡§®‡•ç‡§°‡§π‡•á‡§≤‡•ç‡§°‡§Æ‡§æ ‡§∏‡§Æ‡§Ø ‡§∏‡•á‡§ü ‡§ó‡§∞‡•ç‡§¶‡§õ ‡•§
+Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§™‡•Ä‡§∏‡•Ä ‡§ò‡§°‡•Ä‡§¨‡§æ‡§ü ‡§π‡•ç‡§Ø‡§æ‡§®‡•ç‡§°‡§π‡•á‡§≤‡•ç‡§°‡§Æ‡§æ ‡§∏‡§Æ‡§Ø ‡§∏‡•á‡§ü ‡§ó‡§∞‡•ç‡§¶‡§õ ‡•§
 Comment[nl]=Dit conduit stelt de tijd van uw handheld in aan de hand van de pc-klok.
 Comment[nn]=Denne koplinga set tida p√• den handheldte eininga di fr√• PC-klokka.
 Comment[pl]=Ten ≈ÇƒÖcznik ustawia zegar na palmtopie zgodnie z zegarem komputera.
Index: kpilot/conduits/docconduit/kpalmdoc.desktop
===================================================================
--- kpilot/conduits/docconduit/kpalmdoc.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/docconduit/kpalmdoc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -61,4 +61,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-File;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-File;Office;PDA;
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -93,6 +93,7 @@
 Name[sv]=Brev
 Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
 Name[tg]=–ú–∞–∫—Ç—É–±
+Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Name[tr]=Posta
 Name[uk]=–ü–æ—à—Ç–∞
 Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
Index: kpilot/conduits/recordconduit/record-conduit.desktop
===================================================================
--- kpilot/conduits/recordconduit/record-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/recordconduit/record-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -65,7 +65,7 @@
 Comment[ms]=Saluran ini tidak berbuat apa-apa.
 Comment[nb]=Denne kanalen gj√∏r ingenting.
 Comment[nds]=Disse Kanaal deit gor nix.
-Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§ï‡•á‡§π‡§ø ‡§™‡§®‡§ø ‡§ó‡§∞‡•ç‡§¶‡•à‡§® ‡•§
+Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§ï‡•á‡§π‡•Ä ‡§™‡§®‡§ø ‡§ó‡§∞‡•ç‡§¶‡•à‡§® ‡•§
 Comment[nl]=Dit conduit doet niets.
 Comment[nn]=Denne koplinga gjer ingenting.
 Comment[pl]=Ten ≈ÇƒÖcznik nic nie robi.
Index: kpilot/conduits/null/null-conduit.desktop
===================================================================
--- kpilot/conduits/null/null-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/null/null-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -39,7 +39,7 @@
 Comment[ms]=Saluran ini tidak berbuat apa-apa.
 Comment[nb]=Denne kanalen gj√∏r ingenting.
 Comment[nds]=Disse Kanaal deit gor nix.
-Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§ï‡•á‡§π‡§ø ‡§™‡§®‡§ø ‡§ó‡§∞‡•ç‡§¶‡•à‡§® ‡•§
+Comment[ne]=‡§Ø‡•ã ‡§ï‡§®‡•ç‡§°‡•ç‡§Ø‡•Å‡§ü‡§≤‡•á ‡§ï‡•á‡§π‡•Ä ‡§™‡§®‡§ø ‡§ó‡§∞‡•ç‡§¶‡•à‡§® ‡•§
 Comment[nl]=Dit conduit doet niets.
 Comment[nn]=Denne koplinga gjer ingenting.
 Comment[pl]=Ten ≈ÇƒÖcznik nic nie robi.
Index: kpilot/conduits/vcalconduit/vcal-conduitbase.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -605,18 +605,18 @@
 {
 	KPILOT_DELETE( fState );
 	fState = s;
-};
+}
 
 /* virtual */ void VCalConduitBase::postSync( )
 {
 	FUNCTIONSETUP;
 	if (fCtrPC && fP)
 		fCtrPC->setEndCount(fP->count());
-};
+}
 
 /* virtual */ void VCalConduitBase::preSync( )
 {
 	FUNCTIONSETUP;
 	if (fCtrPC && fP)
 		fCtrPC->setStartCount(fP->count());
-};
+}
Index: kpilot/conduits/abbrowserconduit/abbrowser-conduit.h
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser-conduit.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/abbrowserconduit/abbrowser-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -110,10 +110,10 @@
 	void _getAppInfo();
 	void _setAppInfo();
 
+	void _cleanupAddreessBookPointer();
 
 
 
-
 /*********************************************************************
               G E N E R A L   S Y N C   F U N C T I O N
          These functions modify the Handheld and the addressbook
@@ -208,6 +208,7 @@
 	*   at all.
 	*/
 	Ticket *fTicket;
+	bool fCreatedBook;
 
 	/** if we add a resource from the addressbook, track it to remove it
 	 *  later...
Index: kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -107,7 +107,6 @@
 
 AddressBook *AbbrowserConduit::aBook=0L;
 
-
 /*********************************************************************
                         C O N S T R U C T O R
  *********************************************************************/
@@ -123,6 +122,7 @@
 		syncedIds(),
 		abiter(),
 		fTicket(0L),
+		fCreatedBook(false),
 		fBookResource(0L)
 {
 	FUNCTIONSETUP;
@@ -142,9 +142,7 @@
 		fTicket=0L;
 	}
 
-	DEBUGKPILOT << fname << ": Deleting addressbook" << endl;
-	KPILOT_DELETE(aBook);
-
+	_cleanupAddreessBookPointer();
 	// unused function warnings.
 	compile_time_check();
 }
@@ -285,6 +283,7 @@
 		case AbbrowserSettings::eAbookResource:
 			DEBUGKPILOT<<"Loading standard addressbook"<<endl;
 			aBook = StdAddressBook::self( true );
+			fCreatedBook=false;
 			break;
 		case AbbrowserSettings::eAbookFile:
 		{ // initialize the abook with the given file
@@ -318,6 +317,7 @@
 				stopTickle();
 				return false;
 			}
+			fCreatedBook=true;
 			break;
 		}
 		default: break;
@@ -331,7 +331,7 @@
 		emit logError(i18n("Unable to initialize and load the addressbook for the sync.") );
 		addSyncLogEntry(i18n("Unable to initialize and load the addressbook for the sync.") );
 		WARNINGKPILOT << "Unable to initialize the addressbook for the sync." << endl;
-		KPILOT_DELETE(aBook);
+		_cleanupAddreessBookPointer();
 		stopTickle();
 		return false;
 	}
@@ -343,7 +343,7 @@
 		WARNINGKPILOT << "Unable to lock addressbook for writing " << endl;
 		emit logError(i18n("Unable to lock addressbook for writing.  Can't sync!"));
 		addSyncLogEntry(i18n("Unable to lock addressbook for writing.  Can't sync!"));
-		KPILOT_DELETE(aBook);
+		_cleanupAddreessBookPointer();
 		stopTickle();
 		return false;
 	}
@@ -442,11 +442,22 @@
 }
 
 
+void AbbrowserConduit::_cleanupAddreessBookPointer()
+{
+        if (fCreatedBook)
+        {
+                KPILOT_DELETE(aBook);
+                fCreatedBook=false;
+        }
+        else
+        {
+                aBook=0L;
+	}												         
+}
 
 
 
 
-
 /*********************************************************************
                      D E B U G   O U T P U T
  *********************************************************************/
Index: kpilot/kpilot/kpilot.desktop
===================================================================
--- kpilot/kpilot/kpilot.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/kpilot/kpilot.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -84,4 +84,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;Office;PDA;
Index: kpilot/kpilot/kpilotdaemon.desktop
===================================================================
--- kpilot/kpilot/kpilotdaemon.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/kpilot/kpilotdaemon.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -20,7 +20,7 @@
 Name[lv]=KPilotDƒìmons
 Name[ms]=Daemon KPilot
 Name[nds]=KPilot-D√§moon
-Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§™‡§æ‡§á‡§≤‡§ü ‡§°‡•á‡§á‡§Æ‡•ã‡§®
+Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§™‡§æ‡§á‡§≤‡§ü ‡§°‡•á‡§á‡§Æ‡§®
 Name[nso]=Daemon ya KPilot
 Name[pl]=demon KPilota
 Name[pt_BR]=Servidor do KPilot
@@ -40,4 +40,4 @@
 Type=Application
 Terminal=false
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;
+Categories=Qt;KDE;Utility;Office;PDA;
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/lib/options.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -140,7 +140,7 @@
 #define FUNCTIONSETUPL(a) const int fname = a; Q_UNUSED(fname);
 #endif
 
-#define KPILOT_VERSION	"4.9.1 (rabid dolphin)"
+#define KPILOT_VERSION	"4.9.2-358 (moribund alleycat)"
 
 
 // Function to expand newlines in rich text to <br>\n
Index: kpilot/lib/kpilotdevicelink.cc
===================================================================
--- kpilot/lib/kpilotdevicelink.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/lib/kpilotdevicelink.cc	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -397,8 +397,8 @@
 		e = errno;
 		msg = i18n("Cannot create socket for communicating "
 			"with the Pilot (%1)").arg(errorMessage(e));
-		WARNINGKPILOT << msg << endl;
-		WARNINGKPILOT << "(" << strerror(e) << ")" << endl;
+		DEBUGKPILOT << msg << endl;
+		DEBUGKPILOT << "(" << strerror(e) << ")" << endl;
 	
 		link()->fLinkStatus = PilotLinkError;
 		
@@ -426,8 +426,8 @@
 		e = errno;
 		msg = i18n("Cannot open Pilot port \"%1\". ").arg(link()->fRealPilotPath);
 		
-		WARNINGKPILOT << msg << endl;
-		WARNINGKPILOT << "(" << strerror(e) << ")" << endl;
+		DEBUGKPILOT << msg << endl;
+		DEBUGKPILOT << "(" << strerror(e) << ")" << endl;
 	
 		link()->fLinkStatus = PilotLinkError;
 		
@@ -574,7 +574,7 @@
 
 void DeviceCommThread::close()
 {
-	FUNCTIONSETUP;
+	FUNCTIONSETUPL(2);
 
 	pi_close(fTempSocket);
 
Index: kpilot/lib/plugin.h
===================================================================
--- kpilot/lib/plugin.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kpilot/lib/plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -407,7 +407,7 @@
 	*/
 	unsigned long pluginVersion(const KLibrary *);
 	QString pluginVersionString(const KLibrary *);
-} ;
+}
 
 /**
 * All KPilot conduits should subclass KLibFactory like this.
Index: knotes/local.desktop
===================================================================
--- knotes/local.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knotes/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -33,7 +33,7 @@
 Name[ms]=Nota dalam fail setempat
 Name[nb]=Notater i lokal fil
 Name[nds]=Notizen in lokaal Datei
-Name[ne]=‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§´‡§æ‡§á‡§≤‡§ï‡§æ ‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø
+Name[ne]=‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§´‡§æ‡§á‡§≤‡§ï‡§æ ‡§ü‡§ø‡§™‡•ã‡§ü
 Name[nl]=Notities in lokaal bestand
 Name[nn]=Notat i lokal fil
 Name[pl]=Notatki w pliku lokalnym
Index: knotes/knotesnetrecv.cpp
===================================================================
--- knotes/knotesnetrecv.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knotes/knotesnetrecv.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -77,7 +77,7 @@
     m_sock->enableRead( true );
 
     // Setup the timer
-    m_timer = new QTimer( this );
+    m_timer = new QTimer( this, "m_timer" );
     connect( m_timer, SIGNAL(timeout()), SLOT(slotReceptionTimeout()) );
     m_timer->start( MAXTIME, true );
 }
Index: knotes/knotesalarm.cpp
===================================================================
--- knotes/knotesalarm.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knotes/knotesalarm.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -44,7 +44,8 @@
 
 KNotesAlarm::KNotesAlarm( KNotesResourceManager *manager, QObject *parent, const char *name )
   : QObject( parent, name ),
-    m_manager( manager )
+    m_manager( manager ),
+    m_checkTimer( 0, "m_checkTimer" )
 {
     // TODO: fix timezone stuff?
 
Index: knotes/knotes_manager.desktop
===================================================================
--- knotes/knotes_manager.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knotes/knotes_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -32,7 +32,7 @@
 Name[mk]=–ë–µ–ª–µ—à–∫–∏
 Name[ms]=Nota
 Name[nds]=Notizen
-Name[ne]=‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø
+Name[ne]=‡§ü‡§ø‡§™‡•ã‡§ü
 Name[nl]=Notities
 Name[nn]=Notat
 Name[pl]=Notatki
@@ -48,6 +48,7 @@
 Name[sv]=Anteckningar
 Name[ta]=‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç
 Name[tg]=–ê—Ö–±–æ—Ä–æ—Ç
+Name[th]=‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥
 Name[tr]=Notlar
 Name[uk]=–ü—Ä–∏–º—ñ—Ç–∫–∏
 Name[uz]=–Å–∑–º–∞ —Ö–æ—Ç–∏—Ä–∞
Index: knotes/knotes.desktop
===================================================================
--- knotes/knotes.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ knotes/knotes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -42,7 +42,7 @@
 GenericName[mt]=Noti ≈ºgƒßar
 GenericName[nb]=Oppsprett-notater
 GenericName[nds]=Opduk-Notizen
-GenericName[ne]=‡§™‡§™‡§Ö‡§™ ‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø
+GenericName[ne]=‡§™‡§™‡§Ö‡§™ ‡§ü‡§ø‡§™‡•ã‡§ü
 GenericName[nl]=Notities
 GenericName[nn]=Oppsprettnotat
 GenericName[nso]=Ditshwao tsa Thlarogo
@@ -88,4 +88,4 @@
 
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Desktop;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Desktop;Office;
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -110,6 +110,7 @@
 Name[sr]=–í—Ä–µ–º–µ
 Name[sr@Latn]=Vreme
 Name[sv]=V√§derleksprognos
+Name[th]=‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
 Name[tr]=Hava Durumu Servisi
 Name[uk]=–°–ª—É–∂–±–∞ –ø–æ–≥–æ–¥–∏
 Name[uz]=–û–±-“≥–∞–≤–æ —Ö–∏–∑–º–∞—Ç–∏
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -117,6 +117,7 @@
 Name[sv]=Nyheter
 Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç
 Name[tg]=–ê—Ö–±–æ—Ä–æ—Ç
+Name[th]=‡∏Ç‡πà‡∏≤‡∏ß
 Name[tr]=Haberler
 Name[uk]=–ù–æ–≤–∏–Ω–∏
 Name[uz]=–Ø–Ω–≥–∏–ª–∏–∫–ª–∞—Ä
Index: kontact/plugins/specialdates/kcmsdsummary.desktop
===================================================================
--- kontact/plugins/specialdates/kcmsdsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/specialdates/kcmsdsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -54,6 +54,7 @@
 Name[sr@Latn]=Posebni datumi
 Name[sv]=Speciella datum
 Name[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç
+Name[th]=‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
 Name[tr]=√ñzel Tarihler
 Name[uk]=–û—Å–æ–±–ª–∏–≤—ñ –¥–∞—Ç–∏
 Name[uz]=–ú–∞—Ö—Å—É—Å –∫—É–Ω–ª–∞—Ä
@@ -100,6 +101,7 @@
 Comment[sr@Latn]=Pode≈°avanje sa≈æetka posebnih datuma
 Comment[sv]=Inst√§llning av √∂versikt av speciella datum
 Comment[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ
+Comment[th]=‡∏ï‡πâ‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
 Comment[tr]=√ñzel Tarih √ñzeti Yapƒ±landƒ±rmasƒ±
 Comment[uk]=–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—É –æ—Å–æ–±–ª–∏–≤–∏—Ö –¥–∞—Ç
 Comment[zh_CN]=ÁâπÊÆäÊó•ÊúüÊëòË¶ÅËÆæÁΩÆ
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -57,6 +57,7 @@
 Name[sr@Latn]=Posebni datumi
 Name[sv]=Speciella datum
 Name[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç
+Name[th]=‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
 Name[tr]=√ñzel Tarihler
 Name[uk]=–û—Å–æ–±–ª–∏–≤—ñ –¥–∞—Ç–∏
 Name[uz]=–ú–∞—Ö—Å—É—Å –∫—É–Ω–ª–∞—Ä
@@ -103,6 +104,7 @@
 Comment[sr@Latn]=Prikljuƒçak za posebne datume
 Comment[sv]=Insticksprogram f√∂r speciella datum
 Comment[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
+Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
 Comment[tr]=√ñzel Tarihler Eklentisi
 Comment[uk]=–í—Ç—É–ª–æ–∫ –æ—Å–æ–±–ª–∏–≤–∏—Ö –¥–∞—Ç
 Comment[zh_CN]=ÁâπÊÆäÊó•ÊúüÊèí‰ª∂
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -47,7 +47,7 @@
 Comment[ms]=Plugin KNotes Kontact KNotes 
 Comment[nb]=Kontact programtillegg for KNotes
 Comment[nds]=KNotes-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
+Comment[ne]=‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•á‡§°‡•Ä‡§à ‡§ü‡§ø‡§™‡•ã‡§ü ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Comment[nl]=Kontact KNotes-plugin
 Comment[nn]=Kontact-programtillegg for KNotes
 Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KNotes
@@ -98,7 +98,7 @@
 Name[mk]=–ë–µ–ª–µ—à–∫–∏
 Name[ms]=Nota
 Name[nds]=Notizen
-Name[ne]=‡§¶‡•ç‡§∞‡§∑‡•ç‡§ü‡§µ‡•ç‡§Ø
+Name[ne]=‡§ü‡§ø‡§™‡•ã‡§ü
 Name[nl]=Notities
 Name[nn]=Notat
 Name[pl]=Notatki
@@ -114,6 +114,7 @@
 Name[sv]=Anteckningar
 Name[ta]=‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç
 Name[tg]=–ê—Ö–±–æ—Ä–æ—Ç
+Name[th]=‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥
 Name[tr]=Notlar
 Name[uk]=–ü—Ä–∏–º—ñ—Ç–∫–∏
 Name[uz]=–Å–∑–º–∞ —Ö–æ—Ç–∏—Ä–∞
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -119,6 +119,7 @@
 Name[sv]=Kontakter
 Name[ta]=‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç
 Name[tg]=–ê–ª–æ“õ–æ—Ç
+Name[th]=‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
 Name[tr]=Baƒülantƒ±lar
 Name[uk]=–ö–æ–Ω—Ç–∞–∫—Ç–∏
 Name[uz]=–ê–ª–æ“õ–∞–ª–∞—Ä
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -49,6 +49,7 @@
 Name[sr]=–°–∞—Å—Ç–∞–Ω—Ü–∏ –∏ –æ–±–∞–≤–µ–∑–µ
 Name[sr@Latn]=Sastanci i obaveze
 Name[sv]=M√∂ten och uppgifter
+Name[th]=‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥
 Name[uk]=–ó—É—Å—Ç—Ä—ñ—á—ñ —ñ –∑–∞–≤–¥–∞–Ω–Ω—è
 Name[zh_CN]=Á∫¶‰ºöÂíåÂæÖÂäû
 Name[zh_TW]=Á¥ÑÊúÉËàáÂæÖËæ¶‰∫ãÈ†Ö
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -104,6 +104,7 @@
 Name[sr@Latn]=Lista poslova
 Name[sv]=Uppgiftslista
 Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡Æø‡ÆØ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç
+Name[th]=‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥
 Name[tr]=Yapƒ±lacaklar Listesi
 Name[uk]=–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å
 Name[uz]=–í–∞–∑–∏—Ñ–∞–ª–∞—Ä
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -42,7 +42,7 @@
 Comment[ms]=Plugin Jurnal KOrganizer Kontact 
 Comment[nb]=Kontact programtillegg for KOrganizer dagbok
 Comment[nds]=KOrganizer-Daagbookmoduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§ú‡§∞‡•ç‡§®‡§≤ ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
+Comment[ne]=‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§ú‡§∞‡•ç‡§®‡§≤ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Comment[nl]=Kontact KOrganizer Journaalplugin
 Comment[nn]=Kontact-programtillegg for KOrganizer-dagb√∏ker
 Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z dziennikiem KOrganizera
@@ -96,6 +96,7 @@
 Name[sk]=≈Ωurn√°l
 Name[sl]=Dnevnik
 Name[ta]=‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æø‡Æï‡Øà
+Name[th]=‡∏ß‡∏≤‡∏£‡∏™‡∏≤‡∏£
 Name[tr]=G√ºnl√ºk
 Name[uk]=–ñ—É—Ä–Ω–∞–ª
 Name[uz]=–ö—É–Ω–¥–∞–ª–∏–∫
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -120,6 +120,7 @@
 Name[sv]=Kalender
 Name[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø
 Name[tg]=–¢–∞“õ–≤–∏–º
+Name[th]=‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 Name[tr]=Takvim
 Name[uk]=–ö–∞–ª–µ–Ω–¥–∞—Ä
 Name[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -121,6 +121,7 @@
 Name[sv]=Brev
 Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
 Name[tg]=–ú–∞–∫—Ç—É–±
+Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Name[tr]=Posta
 Name[uk]=–ü–æ—à—Ç–∞
 Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
Index: kontact/plugins/kmail/kcmkmailsummary.desktop
===================================================================
--- kontact/plugins/kmail/kcmkmailsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/kmail/kcmkmailsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -61,6 +61,7 @@
 Name[sv]=Brev
 Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
 Name[tg]=–ú–∞–∫—Ç—É–±
+Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Name[tr]=Posta
 Name[uk]=–ü–æ—à—Ç–∞
 Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
@@ -111,6 +112,7 @@
 Comment[sv]=Inst√§llning av post√∂versikt
 Comment[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ
 Comment[tg]=–¢–∞–Ω–∑–∏–º–æ—Ç–∏ –¥–∞–π–¥–∂–µ—Å—Ç–∏ –ø–æ—á—Ç–∞
+Comment[th]=‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Comment[tr]=E-posta √ñzeti Yapƒ±landƒ±rmasƒ±
 Comment[uk]=–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—É –ø–æ—à—Ç–∏
 Comment[zh_CN]=ÈÇÆ‰ª∂ÊëòË¶ÅËÆæÁΩÆ
Index: kontact/plugins/summary/kcmkontactsummary.desktop
===================================================================
--- kontact/plugins/summary/kcmkontactsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/summary/kcmkontactsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -54,6 +54,7 @@
 Name[sr@Latn]=Komponente
 Name[sv]=Komponenter
 Name[ta]=‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øç
+Name[th]=‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
 Name[tr]=Bile≈üenler
 Name[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
 Name[uz]=“ö–∏—Å–º–ª–∞—Ä
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -110,6 +110,7 @@
 Name[sv]=√ñversikt
 Name[ta]=‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç
 Name[tg]=–î–∞–π–¥–∂–µ—Å—Ç
+Name[th]=‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
 Name[tr]=√ñzet
 Name[uk]=–ó–≤–µ–¥–µ–Ω–Ω—è
 Name[uz]=“≤–∏—Å–æ–±–æ—Ç
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -93,5 +93,6 @@
 Name[sl]=Prikazovalnik novic
 Name[sv]=Nyhets√∂vervakare
 Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Øç
+Name[th]=‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡πà‡∏≤‡∏ß
 Name[tr]=Haberƒ∞zleyici
 Name[zh_CN]=Êñ∞ÈóªÁÇπÁÇπÈÄö
Index: kontact/src/kontact.setdlg
===================================================================
--- kontact/src/kontact.setdlg	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/src/kontact.setdlg	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -48,6 +48,7 @@
 Name[sv]=√ñversikt
 Name[ta]=‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç
 Name[tg]=–î–∞–π–¥–∂–µ—Å—Ç
+Name[th]=‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
 Name[tr]=√ñzet
 Name[uk]=–ó–≤–µ–¥–µ–Ω–Ω—è
 Name[uz]=“≤–∏—Å–æ–±–æ—Ç
@@ -153,6 +154,7 @@
 Name[sv]=Brev
 Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
 Name[tg]=–ú–∞–∫—Ç—É–±
+Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Name[tr]=Posta
 Name[uk]=–ü–æ—à—Ç–∞
 Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
@@ -260,6 +262,7 @@
 Name[sv]=Kontakter
 Name[ta]=‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç
 Name[tg]=–ê–ª–æ“õ–æ—Ç
+Name[th]=‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
 Name[tr]=Baƒülantƒ±lar
 Name[uk]=–ö–æ–Ω—Ç–∞–∫—Ç–∏
 Name[uz]=–ê–ª–æ“õ–∞–ª–∞—Ä
@@ -357,6 +360,7 @@
 Name[sr@Latn]=Sa≈æetak posebnih datuma
 Name[sv]=√ñversikt av speciella datum
 Name[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Æø‡Æ©‡Øç ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç
+Name[th]=‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
 Name[tr]=√ñzel Tarihler √ñzeti
 Name[uk]=–ö–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –æ—Å–æ–±–ª–∏–≤–∏—Ö –¥–∞—Ç
 Name[zh_CN]=ÁâπÊÆäÊó•ÊúüÊëòË¶Å
@@ -460,6 +464,7 @@
 Name[sv]=Kalender
 Name[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø
 Name[tg]=–¢–∞“õ–≤–∏–º
+Name[th]=‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 Name[tr]=Takvim
 Name[uk]=–ö–∞–ª–µ–Ω–¥–∞—Ä
 Name[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä
@@ -565,6 +570,7 @@
 Name[sv]=Nyheter
 Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç
 Name[tg]=–ê—Ö–±–æ—Ä–æ—Ç
+Name[th]=‡∏Ç‡πà‡∏≤‡∏ß
 Name[tr]=Haberler
 Name[uk]=–ù–æ–≤–∏–Ω–∏
 Name[uz]=–Ø–Ω–≥–∏–ª–∏–∫–ª–∞—Ä
@@ -670,6 +676,7 @@
 Name[sv]=V√§der
 Name[ta]=‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà
 Name[tg]=–ü–µ—à–≥”Ø–∏–∏ “≥–∞–≤–æ
+Name[th]=‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
 Name[tr]=Hava Durumu
 Name[uk]=–ü–æ–≥–æ–¥–∞
 Name[uz]=–û–±-“≥–∞–≤–æ
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -787,7 +787,8 @@
 
 void MainWindow::slotNewToolbarConfig()
 {
-  createGUI( mCurrentPlugin->part() );
+  if ( mCurrentPlugin && mCurrentPlugin->part() )
+    createGUI( mCurrentPlugin->part() );
   applyMainWindowSettings( KGlobal::config(), "MainWindow" );
 }
 
Index: kontact/src/Kontact.desktop
===================================================================
--- kontact/src/Kontact.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kontact/src/Kontact.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -65,5 +65,5 @@
 GenericName[zh_TW]=ÂÄã‰∫∫Ë≥áË®äÁÆ°ÁêÜËÄÖ
 Terminal=false
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;Network;Email;
 DocPath=kontact/index.html
Index: kandy/src/kandy.desktop
===================================================================
--- kandy/src/kandy.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ kandy/src/kandy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -117,4 +117,4 @@
 GenericName[zu]=Ithuluzi Lamakhala ekhukhwini
 Terminal=false
 X-DCOP-ServiceType=Multi
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;Network;Telephony;
Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -5,6 +5,7 @@
 GenericName=TNEF File Viewer
 GenericName[af]=TNEF l√™er leser
 GenericName[bg]=–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ TNEF
+GenericName[br]=Gweler restr TNEF
 GenericName[ca]=Visor de fitxers TNEF
 GenericName[cs]=Prohl√≠≈æeƒç TNEF soubor≈Ø
 GenericName[cy]=Syllwr Ffeil TNEF
@@ -103,4 +104,4 @@
 Comment[zh_TW]=TNEF Ê™îÊ°àÊ™¢Ë¶ñÂô®
 Terminal=false
 MimeType=application/ms-tnef;
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Network;Email;
Index: korganizer/kogroupware.cpp
===================================================================
--- korganizer/kogroupware.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/kogroupware.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -87,17 +87,34 @@
   incomingDirChanged( locateLocal( "data", "korganizer/income.tentative/" ) );
   incomingDirChanged( locateLocal( "data", "korganizer/income.cancel/" ) );
   incomingDirChanged( locateLocal( "data", "korganizer/income.reply/" ) );
-}
 
-FreeBusyManager *KOGroupware::freeBusyManager()
-{
   if ( !mFreeBusyManager ) {
     mFreeBusyManager = new FreeBusyManager( this, "freebusymanager" );
     mFreeBusyManager->setCalendar( mCalendar );
     connect( mCalendar, SIGNAL( calendarChanged() ),
              mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
+    connect( mView, SIGNAL( newIncidenceChanger( IncidenceChangerBase* ) ),
+             this, SLOT( slotViewNewIncidenceChanger( IncidenceChangerBase* ) ) );
+    slotViewNewIncidenceChanger( mView->incidenceChanger() );
   }
 
+}
+
+void KOGroupware::slotViewNewIncidenceChanger( IncidenceChangerBase* changer )
+{
+    // Call slot perhapsUploadFB if an incidence was added, changed or removed
+    connect( changer, SIGNAL( incidenceAdded( Incidence* ) ),
+             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
+    connect( changer, SIGNAL( incidenceChanged( Incidence*, Incidence*, int ) ),
+             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
+    connect( changer, SIGNAL( incidenceChanged( Incidence*, Incidence* ) ),
+             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) ) ;
+    connect( changer, SIGNAL( incidenceDeleted( Incidence * ) ),
+             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
+}
+
+FreeBusyManager *KOGroupware::freeBusyManager()
+{
   return mFreeBusyManager;
 }
 
Index: korganizer/komailclient.cpp
===================================================================
--- korganizer/komailclient.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/komailclient.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -196,7 +196,8 @@
       int idx = attachment.find("METHOD");
       if (idx>=0) {
         idx = attachment.find(':',idx)+1;
-        meth = attachment.mid(idx,attachment.find('\n',idx)-idx);
+        const int newline = attachment.find('\n',idx);
+        meth = attachment.mid(idx, newline - idx - 1);
         meth = meth.lower().stripWhiteSpace();
       } else {
         meth = "publish";
Index: korganizer/datechecker.cpp
===================================================================
--- korganizer/datechecker.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/datechecker.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -54,7 +54,7 @@
     case FollowDay:
     case FollowMonth:
       if ( !mUpdateTimer ) {
-        mUpdateTimer = new QTimer( this );
+        mUpdateTimer = new QTimer( this, "mUpdateTimer" );
         connect( mUpdateTimer, SIGNAL( timeout() ),
                  SLOT( possiblyPastMidnight() ) );
       }
Index: korganizer/koeventeditor.cpp
===================================================================
--- korganizer/koeventeditor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koeventeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -25,6 +25,7 @@
 
 #include <qtooltip.h>
 #include <qframe.h>
+#include <qguardedptr.h>
 #include <qpixmap.h>
 #include <qlayout.h>
 #include <qwidgetstack.h>
@@ -254,6 +255,8 @@
 
   if ( !validateInput() || !mChanger ) return false;
 
+  QGuardedPtr<KOEditorFreeBusy> freeBusy( mFreeBusy );
+
   if ( mEvent ) {
     bool rc = true;
     Event *oldEvent = mEvent->clone();
@@ -286,9 +289,9 @@
       return false;
     }
   }
+  // if "this" was deleted, freeBusy is 0 (being a guardedptr)
+  if ( freeBusy ) freeBusy->cancelReload();
 
-  if ( mFreeBusy ) mFreeBusy->cancelReload();
-
   return true;
 }
 
Index: korganizer/koeditorfreebusy.cpp
===================================================================
--- korganizer/koeditorfreebusy.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koeditorfreebusy.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -91,10 +91,10 @@
     void setUpdateTimerID( int id ) { mTimerID = id; }
     int updateTimerID() const { return mTimerID; }
 
-    void startDownload() {
+    void startDownload( bool forceDownload ) {
       mIsDownloading = true;
       FreeBusyManager *m = KOGroupware::instance()->freeBusyManager();
-      if ( !m->retrieveFreeBusy( attendee()->email() ) )
+      if ( !m->retrieveFreeBusy( attendee()->email(), forceDownload ) )
         mIsDownloading = false;
     }
     void setIsDownloading( bool d ) { mIsDownloading = d; }
@@ -199,7 +199,7 @@
   QWhatsThis::add( label, whatsThis );
   controlLayout->addWidget( label );
 
-  scaleCombo = new QComboBox( this ); 
+  scaleCombo = new QComboBox( this );
   QWhatsThis::add( scaleCombo, whatsThis );
   scaleCombo->insertItem( i18n( "Hour" ) );
   scaleCombo->insertItem( i18n( "Day" ) );
@@ -241,7 +241,7 @@
 		   i18n("Reloads Free/Busy data for all attendees from "
 		   	"the corresponding servers.") );
   controlLayout->addWidget( button );
-  connect( button, SIGNAL( clicked() ), SLOT( reload() ) );
+  connect( button, SIGNAL( clicked() ), SLOT( manualReload() ) );
 
   mGanttView = new KDGanttView( this, "mGanttView" );
   QWhatsThis::add( mGanttView,
@@ -290,7 +290,7 @@
   connect( m, SIGNAL( freeBusyRetrieved( KCal::FreeBusy *, const QString & ) ),
            SLOT( slotInsertFreeBusy( KCal::FreeBusy *, const QString & ) ) );
 
-  connect( &mReloadTimer, SIGNAL( timeout() ), SLOT( reload() ) );
+  connect( &mReloadTimer, SIGNAL( timeout() ), SLOT( autoReload() ) );
 }
 
 KOEditorFreeBusy::~KOEditorFreeBusy()
@@ -406,7 +406,7 @@
   while( item ) {
     if( item->updateTimerID() == event->timerId() ) {
       item->setUpdateTimerID( 0 );
-      item->startDownload();
+      item->startDownload( mForceDownload );
       return;
     }
     item = static_cast<FreeBusyItem *>( item->nextSibling() );
@@ -466,7 +466,7 @@
   if( success ) {
     if ( start == mDtStart && end == mDtEnd ) {
       KMessageBox::information( this,
-          i18n( "The meeting already has suitable start/end times." ), QString::null, 
+          i18n( "The meeting already has suitable start/end times." ), QString::null,
           "MeetingTimeOKFreeBusy" );
     } else {
       emit dateTimesChanged( start, end );
@@ -631,13 +631,29 @@
   mReloadTimer.stop();
 }
 
+void KOEditorFreeBusy::manualReload()
+{
+  mForceDownload = true;
+  reload();
+}
+
+void KOEditorFreeBusy::autoReload()
+{
+  mForceDownload = false;
+  reload();
+}
+
 void KOEditorFreeBusy::reload()
 {
   kdDebug(5850) << "KOEditorFreeBusy::reload()" << endl;
 
   FreeBusyItem *item = static_cast<FreeBusyItem *>( mGanttView->firstChild() );
   while( item ) {
-    updateFreeBusyData( item );
+    if (  mForceDownload )
+      item->startDownload( mForceDownload );
+    else
+      updateFreeBusyData( item );
+
     item = static_cast<FreeBusyItem *>( item->nextSibling() );
   }
 }
Index: korganizer/actionmanager.cpp
===================================================================
--- korganizer/actionmanager.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/actionmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -43,6 +43,7 @@
 #include "importdialog.h"
 #include "eventarchiver.h"
 #include "stdcalendar.h"
+#include "freebusymanager.h"
 
 #include <libkcal/calendarlocal.h>
 #include <libkcal/calendarresources.h>
@@ -1251,6 +1252,8 @@
 
   if ( mResourceView )
     mResourceView->updateView();
+
+  KOGroupware::instance()->freeBusyManager()->setBrokenUrl( false );
 }
 
 void ActionManager::setDestinationPolicy()
Index: korganizer/kogroupware.h
===================================================================
--- korganizer/kogroupware.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/kogroupware.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -53,6 +53,12 @@
 class CalendarView;
 class FreeBusyManager;
 
+namespace KOrg {
+class IncidenceChangerBase;
+}
+
+using namespace KOrg;
+
 class KOGroupware : public QObject
 {
     Q_OBJECT
@@ -80,6 +86,8 @@
     /** Handle iCals given by KMail. */
     void incomingDirChanged( const QString& path );
 
+    /** Updates some slot connections when the view incidence changer changes */
+    void slotViewNewIncidenceChanger( IncidenceChangerBase* changer );
   protected:
     KOGroupware( CalendarView*, KCal::CalendarResources* );
 
Index: korganizer/korgac/korgac.desktop
===================================================================
--- korganizer/korgac/korgac.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/korgac/korgac.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -71,7 +71,7 @@
 GenericName[lt]=KOrganizer priminim≈≥ tarnybos klientas
 GenericName[nb]=KOrganizer klient for p√•minningstjenesten
 GenericName[nds]=Client f√∂r den Anst√∂tend√§moon vun KOrganizer
-GenericName[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§∞‡§ø‡§Æ‡§æ‡§á‡§®‡•ç‡§°‡§∞ ‡§°‡•á‡§á‡§Æ‡•ã‡§® ‡§ï‡•ç‡§≤‡§æ‡§á‡§®‡•ç‡§ü
+GenericName[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§∞‡§ø‡§Æ‡§æ‡§á‡§®‡•ç‡§°‡§∞ ‡§°‡•á‡§á‡§Æ‡§® ‡§ï‡•ç‡§≤‡§æ‡§á‡§®‡•ç‡§ü
 GenericName[nl]=KOrganizer herinneringsdaemon
 GenericName[nn]=Alarmnisseklient for KOrganizer
 GenericName[pl]=Klient demona przypominania KOrganizera
Index: korganizer/interfaces/calendar/calendarplugin.desktop
===================================================================
--- korganizer/interfaces/calendar/calendarplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/interfaces/calendar/calendarplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -58,7 +58,7 @@
 Comment[sv]=Insticksprogram f√∂r kalender
 Comment[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
 Comment[tg]=–ú–æ–¥—É–ª –±–∞—Ä–æ–∏ —Ç–∞“õ–≤–∏–º–æ—Ç
-Comment[th]=‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
+Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 Comment[tr]=Takvim Eklentisi
 Comment[uk]=–í—Ç—É–ª–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
 Comment[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä –ø–ª–∞–≥–∏–Ω–∏
Index: korganizer/interfaces/calendar/calendardecoration.desktop
===================================================================
--- korganizer/interfaces/calendar/calendardecoration.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/interfaces/calendar/calendardecoration.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -55,7 +55,7 @@
 Comment[sv]=Insticksprogram f√∂r kalenderdekoration
 Comment[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø ‡ÆÖ‡Æ≤‡Æô‡Øç‡Æï‡Ææ‡Æ∞ ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
 Comment[tg]=–ú–æ–¥—É–ª –±–∞—Ä–æ–∏ –æ—Ä–æ–∏—à –¥–æ–¥–∞–Ω–∏ —Ç–∞“õ–≤–∏–º–æ—Ç
-Comment[th]=‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
+Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 Comment[tr]=Takvim Dekorasyon Eklentisi
 Comment[uk]=–í—Ç—É–ª–æ–∫ –ø—Ä–∏–∫—Ä–∞—Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è
 Comment[ven]=Pulagini yo khavhisiwaho ya khalenda
Index: korganizer/koagenda.cpp
===================================================================
--- korganizer/koagenda.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koagenda.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1044,6 +1044,7 @@
   setCursor( arrowCursor );
   bool multiModify = false;
   // FIXME: do the cloning here...
+  Incidence* inc = mActionItem->incidence();
 
   if ( mItemMoved ) {
     bool modify = true;
@@ -1146,7 +1147,7 @@
       emit itemModified( modif );
     }
     // FIXME: If the change failed, we need to update the view!
-    mChanger->endChange( mActionItem->incidence() );
+    mChanger->endChange( inc );
   }
 
   mActionItem = 0;
Index: korganizer/koeditorfreebusy.h
===================================================================
--- korganizer/koeditorfreebusy.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koeditorfreebusy.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -77,7 +77,10 @@
     void slotZoomToTime();
     void slotPickDate();
 
-    void reload();
+    // Force the download of FB informations
+    void manualReload();
+    // Only download FB if the auto-download option is set in config
+    void autoReload();
 
   protected:
     void timerEvent( QTimerEvent* );
@@ -90,7 +93,7 @@
     bool tryDate( FreeBusyItem *attendee,
                   QDateTime &tryFrom, QDateTime &tryTo );
     void updateStatusSummary();
-
+    void reload();
     KDGanttView *mGanttView;
     QLabel *mStatusSummaryLabel;
     bool mIsOrganizer;
@@ -99,6 +102,8 @@
     QDateTime mDtStart, mDtEnd;
 
     QTimer mReloadTimer;
+
+    bool mForceDownload;
 };
 
 #endif
Index: korganizer/plugins/hebrew/hebrew.cpp
===================================================================
--- korganizer/plugins/hebrew/hebrew.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/plugins/hebrew/hebrew.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -108,4 +108,5 @@
   ConfigDialog *dlg = new ConfigDialog(parent);        //parent?
 
   dlg->exec();
+  delete dlg;
 }
Index: korganizer/koagendaitem.cpp
===================================================================
--- korganizer/koagendaitem.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koagendaitem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -160,6 +160,7 @@
                             lastItem );
   }
   delete mMultiItemInfo;
+  mMultiItemInfo = 0;
   return true;
 }
 
Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -54,7 +54,7 @@
 Comment[sv]=Kalender- och schemal√§ggningsprogram
 Comment[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æø‡Æü‡Øç‡Æü ‡Æ®‡Æø‡Æ∞‡Æ≤‡Øç
 Comment[tg]=–¢–∞“õ–≤–∏–º–æ—Ç –≤–∞ “∑–∞–¥–≤–∞–ª–∏ —à–∞—Ö—Å”£
-Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
+Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
 Comment[tr]=Takvim ve Zamanlama Programƒ±
 Comment[uk]=–ü—Ä–æ–≥—Ä–∞–º–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Ç–∞ —Ä–æ–∑–∫–ª–∞–¥—É
 Comment[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä –≤–∞ —Ä–µ–∂–∞–ª–∞—à—Ç–∏—Ä–∏—à –¥–∞—Å—Ç—É—Ä–∏
@@ -143,4 +143,4 @@
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=korganizer
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;ProjectManagement;
Index: korganizer/koincidenceeditor.cpp
===================================================================
--- korganizer/koincidenceeditor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koincidenceeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -24,6 +24,7 @@
 
 #include <qtooltip.h>
 #include <qframe.h>
+#include <qguardedptr.h>
 #include <qpixmap.h>
 #include <qlayout.h>
 #include <qwidgetstack.h>
@@ -117,7 +118,11 @@
 
 void KOIncidenceEditor::slotOk()
 {
-  if ( processInput() ) accept();
+  // "this" can be deleted before processInput() returns (processInput() opens 
+  // a non-modal dialog when Kolab is used). So accept should only be executed
+  // when "this" is still valid
+  QGuardedPtr<QWidget> ptr( this );
+  if ( processInput() && ptr ) accept();
 }
 
 void KOIncidenceEditor::updateCategoryConfig()
Index: korganizer/freebusymanager.h
===================================================================
--- korganizer/freebusymanager.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/freebusymanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -94,7 +94,7 @@
 
       Return true if a download is initiated, and false otherwise
     */
-    bool retrieveFreeBusy( const QString &email );
+    bool retrieveFreeBusy( const QString &email, bool forceDownload );
 
     void cancelRetrieval();
 
@@ -120,6 +120,12 @@
     */
     QString freeBusyDir();
 
+    /**
+      Change the broken Url status
+      mBrokenUrl is used to show the 'broken url popup' only once
+     */
+    void setBrokenUrl( bool isBroken );
+
   public slots:
     // When something changed in the calendar, we get this called
     void slotPerhapsUploadFB();
@@ -164,6 +170,8 @@
     QDateTime mNextUploadTime;
     int mTimerID;
     bool mUploadingFreeBusy;
+    bool mBrokenUrl;
+
 };
 
 #endif
Index: korganizer/koagendaview.cpp
===================================================================
--- korganizer/koagendaview.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/koagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -1174,15 +1174,15 @@
     td->setDtDue( endDt );
   }
 
-  mChanger->changeIncidence( oldIncidence, incidence );
-  mChanger->endChange(incidence);
-  delete oldIncidence;
-
   item->setItemDate( startDt.date() );
 
   KOIncidenceToolTip::remove( item );
   KOIncidenceToolTip::add( item, incidence, KOAgendaItem::toolTipGroup() );
 
+  mChanger->changeIncidence( oldIncidence, incidence );
+  mChanger->endChange(incidence);
+  delete oldIncidence;
+
   // don't update the agenda as the item already has the correct coordinates.
   // an update would delete the current item and recreate it, but we are still
   // using a pointer to that item! => CRASH
Index: korganizer/freebusymanager.cpp
===================================================================
--- korganizer/freebusymanager.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 700909)
+++ korganizer/freebusymanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 700909)
@@ -109,15 +109,15 @@
     mManager->saveFreeBusy( fb, p );
   }
   emit freeBusyDownloaded( fb, mEmail );
-  // PENDING(steffen): Is this safe?
-  //job->deleteLater();
-  delete this;
+  deleteLater();
 }
 
+////
 
 FreeBusyManager::FreeBusyManager( QObject *parent, const char *name )
   : QObject( parent, name ),
-    mCalendar( 0 ), mTimerID( 0 ), mUploadingFreeBusy( false )
+    mCalendar( 0 ), mTimerID( 0 ), mUploadingFreeBusy( false ),
+    mBrokenUrl( false )
 {
 }
 
@@ -159,7 +159,7 @@
 
 void FreeBusyManager::slotPerhapsUploadFB()
 {
-  // user has automtic uploading disabled, bail out
+  // user has automatic uploading disabled, bail out
   if ( !KOPrefs::instance()->freeBusyPublishAuto() ||
        KOPrefs::instance()->freeBusyPublishUrl().isEmpty() )
      return;
@@ -207,6 +207,11 @@
   publishFreeBusy();
 }
 
+void FreeBusyManager::setBrokenUrl( bool isBroken )
+{
+  mBrokenUrl = isBroken;
+}
+
 /*!
   This method is called when the user has selected to publish its
   free/busy list or when the delay have passed.
@@ -226,6 +231,15 @@
             "</qt>" ), i18n("No Free/Busy Upload URL") );
     return;
   }
+  if ( mBrokenUrl ) // Url is invalid, don't try again
+    return;
+  if ( !targetURL.isValid() ) {
+     KMessageBox::sorry( 0,
+      i18n( "<qt>The target URL '%1' provided is invalid."
+            "</qt>" ).arg( targetURL.prettyURL() ), i18n("Invalid URL") );
+    mBrokenUrl = true;
+    return;
+  }
   targetURL.setUser( KOPrefs::instance()->mFreeBusyPublishUser );
   targetURL.setPass( KOPrefs::instance()->mFreeBusyPublishPassword );
 
@@ -326,7 +340,7 @@
     mUploadingFreeBusy = false;
 }
 
-bool FreeBusyManager::retrieveFreeBusy( const QString &email )
+bool FreeBusyManager::retrieveFreeBusy( const QString &email, bool forceDownload )
 {
   kdDebug(5850) << "FreeBusyManager::retrieveFreeBusy(): " << email << endl;
   if ( email.isEmpty() ) return false;
@@ -345,7 +359,7 @@
   }
 
   // Don't download free/busy if the user does not want it.
-  if( !KOPrefs::instance()->mFreeBusyRetrieveAuto )
+  if( !KOPrefs::instance()->mFreeBusyRetrieveAuto && !forceDownload)
     return false;
 
   mRetrieveQueue.append( email );
@@ -364,7 +378,7 @@
 
   KURL sourceURL = freeBusyUrl( email );
 
-  kdDebug(5850) << "FreeBusyManager::processRetrieveQueue(): url: " << sourceURL.url()
+  kdDebug(5850) << "FreeBusyManager::processRetrieveQueue(): url: " << sourceURL
             << endl;
 
   if ( !sourceURL.isValid() ) {
@@ -400,7 +414,7 @@
   cfg.setGroup( email );
   QString url = cfg.readEntry( "url" );
   if ( !url.isEmpty() ) {
-    kdDebug(5850) << "found cached url: " << url << endl; 
+    kdDebug(5850) << "found cached url: " << url << endl;
     return KURL( url );
   }
   // Try with the url configurated by preferred email in kaddressbook
@@ -414,16 +428,19 @@
         "Preferred email of " << email << " is " << pref << endl;
       cfg.setGroup( pref );
       url = cfg.readEntry ( "url" );
-      if ( !url.isEmpty() )
+      if ( !url.isEmpty() ) {
         kdDebug( 5850 ) << "FreeBusyManager::freeBusyUrl():" <<
           "Taken url from preferred email:" << url << endl;
         return KURL( url );
+      }
     }
   }
   // None found. Check if we do automatic FB retrieving then
-  if ( !KOPrefs::instance()->mFreeBusyRetrieveAuto )
+  if ( !KOPrefs::instance()->mFreeBusyRetrieveAuto ) {
+    kdDebug( 5850 ) << "no auto retrieving" << endl;
     // No, so no FB list here
     return KURL();
+  }
 
   // Sanity check: Don't download if it's not a correct email
   // address (this also avoids downloading for "(empty email)").
@@ -449,7 +466,7 @@
       << email << '\'' << endl;
     return KURL();
 }
-  kdDebug(5850) << "Server FreeBusy url: " << sourceURL.url() << endl;
+  kdDebug(5850) << "Server FreeBusy url: " << sourceURL << endl;
   if ( KOPrefs::instance()->mFreeBusyFullDomainRetrieval )
     sourceURL.setFileName( email + ".ifb" );
   else
@@ -457,7 +474,7 @@
   sourceURL.setUser( KOPrefs::instance()->mFreeBusyRetrieveUser );
   sourceURL.setPass( KOPrefs::instance()->mFreeBusyRetrievePassword );
 
-  kdDebug(5850) << "Results in generated: " << sourceURL.url() << endl;
+  kdDebug(5850) << "Results in generated: " << sourceURL << endl;
   return sourceURL;
 }
 

Zmiany atrybut√≥w dla: .
___________________________________________________________________
Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


