Index: akregator/src/librss/loader.h
===================================================================
--- akregator/src/librss/loader.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ akregator/src/librss/loader.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -227,7 +227,7 @@
 	 * 'OutputRetriever' will make it execute the script
 	 * '/home/myself/some-script.py' and assume whatever that script prints to
 	 * stdout is RSS markup. This is e.g. handy for conversion scripts, which
-	 * download a HTML file and convert it's contents into RSS markup.
+	 * download an HTML file and convert it's contents into RSS markup.
 	 *
 	 * No matter what kind of retrieval algorithm you employ, your
 	 * 'slotLoadingComplete' method might look like this:
Index: akregator/src/akregator.desktop
===================================================================
--- akregator/src/akregator.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ akregator/src/akregator.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -23,7 +23,7 @@
 GenericName[hu]=RSS hírolvasó
 GenericName[is]=RSS fréttaforrit
 GenericName[it]=Lettore Fonti RSS
-GenericName[ja]=RSS ニュースリーダ
+GenericName[ja]=RSS ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​មតិព័ត៌មាន RSS
 GenericName[lt]=RSS kanalų skaityklė
 GenericName[ms]= Pembaca Suapan RSS 
Index: akregator/src/eventsrc
===================================================================
--- akregator/src/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ akregator/src/eventsrc	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -15,7 +15,7 @@
 Name[es]=Origen añadido
 Name[et]=Kanal lisatud
 Name[eu]=Iturria gehituta
-Name[fa]=خوراندن اضافه شده‌
+Name[fa]=خوراندن اضافه‌شده
 Name[fi]=Syöte lisätty
 Name[fr]=Flux ajouté
 Name[ga]=Cuireadh fotha leis
Index: kmobile/devices/gammu/libkmobile_gammu.desktop
===================================================================
--- kmobile/devices/gammu/libkmobile_gammu.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmobile/devices/gammu/libkmobile_gammu.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -14,7 +14,7 @@
 Name[es]=Teléfono móvil u organizador (gammu)
 Name[et]=Mobiiltelefon või Organizer (gammu)
 Name[eu]=Mugikorra edo antolatzailea (gammu)
-Name[fa]=تلفن همراه یا سازمان دهنده (gammu)
+Name[fa]=تلفن همراه یا سازمان‌دهنده (gammu)
 Name[fi]=Matkapuhelin tai organisaattori (gammu)
 Name[fr]=Téléphone portable ou organiseur (gammu)
 Name[ga]=Fón Póca nó Eagraí (gammu)
Index: certmanager/lib/libkleopatrarc.desktop
===================================================================
--- certmanager/lib/libkleopatrarc.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ certmanager/lib/libkleopatrarc.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -99,7 +99,7 @@
 Name[es]=Clave revocada
 Name[et]=Tühistatud võti
 Name[eu]=Errebokatutako gakoa
-Name[fa]=کلید لغو شده‌
+Name[fa]=کلید لغو‌شده‌
 Name[fi]=Peruutettu avain
 Name[fr]=Clé révoquée
 Name[he]=מפתח לא קביל
Index: libkmime/kmime_message.cpp
===================================================================
--- libkmime/kmime_message.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkmime/kmime_message.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -62,6 +62,10 @@
   if( (h=to(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //Cc
+  if( (h=cc(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Reply-To
   if( (h=replyTo(false))!=0 )
     newHead+=h->as7BitString()+"\n";
@@ -78,6 +82,10 @@
   if( (h=organization(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //UserAgent
+  if( (h=userAgent(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Mime-Version
   newHead+="MIME-Version: 1.0\n";
 
Index: libkmime/kmime_newsarticle.h
===================================================================
--- libkmime/kmime_newsarticle.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkmime/kmime_newsarticle.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -43,7 +43,6 @@
   virtual KMime::Headers::Newsgroups* newsgroups(bool create=true)      { KMime::Headers::Newsgroups *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::FollowUpTo* followUpTo(bool create=true)      { KMime::Headers::FollowUpTo *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::Lines* lines(bool create=true)                { if(!create && l_ines.isEmpty()) return 0; return &l_ines; }
-  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
 
 
 protected:
Index: libkmime/kmime_message.h
===================================================================
--- libkmime/kmime_message.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkmime/kmime_message.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -51,6 +51,7 @@
   virtual KMime::Headers::CC* cc(bool create=true)                      { KMime::Headers::CC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::BCC* bcc(bool create=true)                    { KMime::Headers::BCC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::References* references(bool create=true)      { KMime::Headers::References *p=0; return getHeaderInstance(p, create); }
+  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
   
 protected:
   //hardcoded headers
Index: kmail/kmfilterdlg.cpp
===================================================================
--- kmail/kmfilterdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmfilterdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -226,6 +226,7 @@
       gl->addMultiCellWidget( keyButtonLabel, 7, 7, 2, 2 );
       mKeyButton = new KKeyButton( adv_w, "FilterShortcutSelector" );
       gl->addMultiCellWidget( mKeyButton, 7, 7, 3, 3 );
+      mKeyButton->setEnabled( false );
       mConfigureToolbar = new QCheckBox( i18n("Additionally add this filter to the toolbar"), adv_w );
       gl->addMultiCellWidget( mConfigureToolbar, 8, 8, 0, 3 );
       mConfigureToolbar->setEnabled( false );
@@ -497,6 +498,7 @@
 {
   if ( mFilter ) {
     mFilter->setConfigureShortcut( aChecked );
+    mKeyButton->setEnabled( aChecked );
     mConfigureToolbar->setEnabled( aChecked );
     mFilterActionIconButton->setEnabled( aChecked );
     mFilterActionLabel->setEnabled( aChecked );
Index: kmail/expirejob.cpp
===================================================================
--- kmail/expirejob.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/expirejob.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -125,7 +125,7 @@
     const KMMsgBase *mb = storage->getMsgBase( mCurrentIndex );
     if (mb == 0)
       continue;
-    if ( mb->isImportant()
+    if ( ( mb->isImportant() || mb->isTodo() )
       && GlobalSettings::self()->excludeImportantMailFromExpiry() )
        continue;
 
Index: kmail/application_octetstream.desktop
===================================================================
--- kmail/application_octetstream.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/application_octetstream.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -39,7 +39,7 @@
 Comment[es]=Un accesorio de formato para el cuerpo de application/octet-stream
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile application/octet-stream)
 Comment[eu]=Gorputz-zati formateatzaile plugin bat aplikazio/zortikote-jarioentzat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای کاربرد/octet-stream
+Comment[fa]=یک وصلۀ قالب‌دهندۀ بخش بدنه برای کاربرد/octet-stream
 Comment[fi]=Muokkainliitännäinen application/octet-stream-muodolle
 Comment[fr]=Un module formateur de corps pour application (flux d'octets)
 Comment[hu]=Formázómodul application/octet-stream típusú adatfolyamokhoz
Index: kmail/kmail_config_composer.desktop
===================================================================
--- kmail/kmail_config_composer.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmail_config_composer.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Composer
+Name[ar]=المحرر
 Name[bg]=Редактор
 Name[br]=Skridaozer
 Name[bs]=Sastavljač
@@ -70,7 +71,7 @@
 Comment[es]=Frases y comportamiento general
 Comment[et]=Väljendid ja üldine käitumine
 Comment[eu]=Esaldiak eta portamolde orokorra
-Comment[fa]=عبارات و رفتار کلی
+Comment[fa]=عبارات و رفتار عمومی
 Comment[fi]=Ilmaukset ja yleiset asetukset
 Comment[fr]=Phrases et comportement général
 Comment[gl]=Frases e comportamento xeral
Index: kmail/kmail_config_identity.desktop
===================================================================
--- kmail/kmail_config_identity.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmail_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Identities
+Name[ar]=الهويات
 Name[be]=Увасабленьні
 Name[bg]=Самоличност
 Name[br]=Anvelezhioù
@@ -60,6 +61,7 @@
 Name[zh_CN]=身份
 Name[zh_TW]=身份
 Comment=Manage Identities
+Comment[ar]=تدبير الهويات
 Comment[be]=Кіраваньне увасабленьнямі
 Comment[bg]=Настройки на самоличността
 Comment[br]=Merañ an anvelezhioù
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -811,22 +811,28 @@
     assert( idx >= 0 );
     msg = p->getMsg(idx);
 
-    if (msg->transferInProgress()) {
-      QByteArray data = QByteArray();
-      mJob->sendAsyncData( data );
-    }
-    msg->setTransferInProgress( true );
-    if (msg->isComplete() ) {
-      slotMessageRetrievedForSaving(msg);
-    } else {
+    if ( msg ) {
+      if ( msg->transferInProgress() ) {
+        QByteArray data = QByteArray();
+        mJob->sendAsyncData( data );
+      }
+      msg->setTransferInProgress( true );
+      if (msg->isComplete() ) {
+        slotMessageRetrievedForSaving( msg );
+      } else {
       // retrieve Message first
-      if (msg->parent()  && !msg->isComplete() ) {
-        FolderJob *job = msg->parent()->createJob(msg);
-        job->setCancellable( false );
-        connect(job, SIGNAL(messageRetrieved(KMMessage*)),
-            this, SLOT(slotMessageRetrievedForSaving(KMMessage*)));
-        job->start();
+        if ( msg->parent()  && !msg->isComplete() ) {
+          FolderJob *job = msg->parent()->createJob( msg );
+          job->setCancellable( false );
+          connect(job, SIGNAL( messageRetrieved( KMMessage* ) ),
+                  this, SLOT( slotMessageRetrievedForSaving( KMMessage* ) ) );
+          job->start();
+        }
       }
+    } else {
+      mJob->slotError( KIO::ERR_ABORTED,
+                       i18n("The message was removed while saving it. "
+                            "It has not been saved.") );
     }
   } else {
     if ( mStandAloneMessage ) {
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -75,6 +75,7 @@
 #include <globalsettings.h>
 
 #define UIDCACHE_VERSION 1
+#define MAIL_LOSS_DEBUGGING 0
 
 static QString incidencesForToString( KMFolderCachedImap::IncidencesFor r ) {
   switch (r) {
@@ -150,10 +151,22 @@
     mFolderRemoved( false ),
     /*mHoldSyncs( false ),*/ mRecurse( true ),
     mStatusChangedLocally( false ), mAnnotationFolderTypeChanged( false ),
-    mIncidencesForChanged( false ), mPersonalNamespacesCheckDone( true )
+    mIncidencesForChanged( false ), mPersonalNamespacesCheckDone( true ),
+    mFoundAnIMAPDigest( false )
 {
   setUidValidity("");
-  readUidCache();
+  // if we fail to read a uid file but there is one, nuke it
+  if ( readUidCache() == -1 ) {
+    if ( QFile::exists( uidCacheLocation() ) ) {
+        KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be read. There "
+              "could be a problem with file system permission, or it is corrupted."
+              ).arg( folder->prettyURL() ) );
+        // try to unlink it, in case it was corruped. If it couldn't be read 
+        // because of permissions, this will fail, which is fine
+        unlink( QFile::encodeName( uidCacheLocation() ) );
+    }
+  }
 
   mProgress = 0;
 }
@@ -306,7 +319,7 @@
   if( uidValidity().isEmpty() || uidValidity() == "INVALID" ) {
     // No info from the server yet, remove the file.
     if( QFile::exists( uidCacheLocation() ) )
-      unlink( QFile::encodeName( uidCacheLocation() ) );
+      return unlink( QFile::encodeName( uidCacheLocation() ) );
     return 0;
   }
 
@@ -317,17 +330,23 @@
     str << uidValidity() << endl;
     str << lastUid() << endl;
     uidcache.flush();
-    fsync( uidcache.handle() ); /* this is probably overkill */
-    uidcache.close();
-    return 0;
-  } else {
-    return errno; /* does QFile set errno? */
+    if ( uidcache.status() == IO_Ok ) {
+      fsync( uidcache.handle() ); /* this is probably overkill */
+      uidcache.close();
+      if ( uidcache.status() == IO_Ok )
+        return 0;
+    }
   }
+  KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be written. There "
+              "could be a problem with file system permission." ).arg( folder()->prettyURL() ) );
+
+  return -1;
 }
 
 void KMFolderCachedImap::reloadUidMap()
 {
-  kdDebug(5006) << "Reloading Uid Map " << endl;
+  //kdDebug(5006) << "Reloading Uid Map " << endl;
   uidMap.clear();
   open();
   for( int i = 0; i < count(); ++i ) {
@@ -448,7 +467,8 @@
 {
   killTimer( uidWriteTimer );
   uidWriteTimer = -1;
-  writeUidCache();
+  if ( writeUidCache() == -1 )
+    unlink( QFile::encodeName( uidCacheLocation() ) );
 }
 
 ulong KMFolderCachedImap::lastUid()
@@ -467,10 +487,22 @@
   QMap<ulong,int>::Iterator it = uidMap.find( uid );
   if( it != uidMap.end() ) {
     KMMsgBase *msg = getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
+    kdDebug(5006) << "UID " << uid << " is supposed to be in the map" << endl;
+    kdDebug(5006) << "UID's index is to be " << *it << endl;
+    kdDebug(5006) << "There is a message there? " << (msg != 0) << endl;
+    if ( msg ) {
+      kdDebug(5006) << "Its UID is: " << msg->UID() << endl;
+    }
+#endif
+
     if( msg && msg->UID() == uid )
       return msg;
+    kdDebug(5006) << "########## Didn't find uid: " << uid << "in cache athough it's supposed to be there!" << endl;
   } else {
+#if MAIL_LOSS_DEBUGGING
     kdDebug(5006) << "Didn't find uid: " << uid << "in cache!" << endl;
+#endif
   }
   // Not found by now
  // if( mapReloaded )
@@ -482,8 +514,10 @@
   if( it != uidMap.end() )
     // Since the uid map is just rebuilt, no need for the sanity check
     return getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
   else
     kdDebug(5006) << "Reloaded, but stil didn't find uid: " << uid << endl;
+#endif
   // Then it's not here
   return 0;
 }
@@ -841,9 +875,14 @@
            to be deleted on the server has been deleted, adjust our local notion of the
            highes uid seen thus far. */
         slotUpdateLastUid();
-        if( mLastUid == 0 && uidWriteTimer == -1 )
+        if( mLastUid == 0 && uidWriteTimer == -1 ) {
           // This is probably a new and empty folder. Write the UID cache
-          writeUidCache();
+          if ( writeUidCache() == -1 ) {
+            resetSyncState();
+            emit folderComplete( this, false );
+            return;
+          }
+        }
       }
     }
 
@@ -1209,9 +1248,10 @@
 void KMFolderCachedImap::slotImapStatusChanged(KMFolder* folder, const QString&, bool cont)
 {
   if ( mSyncState == SYNC_STATE_INITIAL ){
-      kdDebug(5006) << "IMAP status changed but reset " << endl;
+      //kdDebug(5006) << "IMAP status changed but reset " << endl;
       return; // we were reset
   }
+  //kdDebug(5006) << "IMAP status changed for folder: " << folder->prettyURL() << endl;
   if ( folder->storage() == this ) {
     --mStatusFlagsJobs;
     if ( mStatusFlagsJobs == 0 || !cont ) // done or aborting
@@ -1220,6 +1260,7 @@
     if ( mStatusFlagsJobs == 0 && cont ) {
       mProgress += 5;
       serverSyncInternal();
+      //kdDebug(5006) << "Proceeding with mailcheck." << endl;
     }
   }
 }
@@ -1288,15 +1329,24 @@
   // them one by one because the index list can get resized under
   // us. So use msg pointers instead
 
+  QStringList uids;
   QMap<ulong,int>::const_iterator it = uidMap.constBegin();
   for( ; it != uidMap.end(); it++ ) {
     ulong uid ( it.key() );
-    if( uid!=0 && !uidsOnServer.find( uid ) )
+    if( uid!=0 && !uidsOnServer.find( uid ) ) {
+      uids << QString::number( uid );
       msgsForDeletion.append( getMsg( *it ) );
+    }
   }
 
   if( !msgsForDeletion.isEmpty() ) {
-    removeMsg( msgsForDeletion );
+#if MAIL_LOSS_DEBUGGING
+      if ( KMessageBox::warningYesNo(
+             0, i18n( "<qt><p>Mails on the server in folder <b>%1</b> were deleted. "
+                 "Do you want to delete them locally?<br>UIDs: %2</p></qt>" )
+             .arg( folder()->prettyURL() ).arg( uids.join(",") ) ) == KMessageBox::Yes )
+#endif
+        removeMsg( msgsForDeletion );
   }
 
   /* Delete messages from the server that we dont have anymore */
@@ -1370,6 +1420,8 @@
   uidsForDeletionOnServer.clear();
   mMsgsForDownload.clear();
   mUidsForDownload.clear();
+  // listing is only considered successful if saw a syntactically correct imapdigest
+  mFoundAnIMAPDigest = false;
 
   CachedImapJob* job = new CachedImapJob( FolderJob::tListMessages, this );
   connect( job, SIGNAL( result(KMail::FolderJob *) ),
@@ -1415,6 +1467,7 @@
       setReadOnly( access == "Read only" );
     }
     (*it).cdata.remove(0, pos);
+    mFoundAnIMAPDigest = true;
   }
   pos = (*it).cdata.find("\r\n--IMAPDIGEST", 1);
   // Start with something largish when rebuilding the cache
@@ -1432,7 +1485,7 @@
       if( uid != 0 ) {
         if ( uidsOnServer.count() == uidsOnServer.size() ) {
           uidsOnServer.resize( KMail::nextPrime( uidsOnServer.size() * 2 ) );
-          kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
+          //kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
         }
         uidsOnServer.insert( uid, &v );
       }
@@ -1451,7 +1504,9 @@
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
           if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
-            // kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#if MAIL_LOSS_DEBUGGING
+            kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#endif
             uidsForDeletionOnServer << uid;
           } else {
             redownload = true;
@@ -1490,6 +1545,13 @@
 void KMFolderCachedImap::getMessagesResult( KMail::FolderJob *job, bool lastSet )
 {
   mProgress += 10;
+  if ( !job->error() && !mFoundAnIMAPDigest ) {
+      kdWarning(5006) << "######## Folderlisting did not complete, but there was no error! "
+          "Aborting sync of folder: " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+      kmkernel->emergencyExit( i18n("Folder listing failed in interesting ways." ) );
+#endif
+  }
   if( job->error() ) { // error listing messages but the user chose to continue
     mContentState = imapNoInformation;
     mSyncState = SYNC_STATE_HANDLE_INBOX; // be sure not to continue in this folder
@@ -1741,7 +1803,7 @@
   KMFolderNode *node;
   bool root = ( this == mAccount->rootFolder() );
   if ( root && !mAccount->hasInbox() ) {
-    kdDebug(5006) << "check INBOX" << endl;
+    //kdDebug(5006) << "check INBOX" << endl;
     // create the INBOX
     for (node = folder()->child()->first(); node; node = folder()->child()->next())
       if (!node->isDir() && node->name() == "INBOX") break;
@@ -2216,7 +2278,7 @@
 void
 KMFolderCachedImap::slotAnnotationChanged( const QString& entry, const QString& attribute, const QString& value )
 {
-  kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
+  //kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
   if ( entry == KOLAB_FOLDERTYPE )
     mAnnotationFolderTypeChanged = false;
   else if ( entry == KOLAB_INCIDENCESFOR ) {
Index: kmail/eventsrc
===================================================================
--- kmail/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/eventsrc	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -9,6 +9,7 @@
 
 [new-mail-arrived]
 Name=New Mail Arrived
+Name[ar]=وصل بريد جديد
 Name[bg]=Имате ново писмо
 Name[br]=Deuet eo ur postel nevez
 Name[bs]=Stigla vam je nova pošta
@@ -55,6 +56,7 @@
 Name[zh_CN]=新邮件到达
 Name[zh_TW]=您有新郵件
 Comment=New mail arrived
+Comment[ar]=وصل بريد جديد
 Comment[bg]=Имате ново писмо
 Comment[br]=Deuet eo ur postel nevez
 Comment[bs]=Stigla vam je nova pošta
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -192,6 +192,7 @@
 bool KMKernel::handleCommandLine( bool noArgsOpensReader )
 {
   QString to, cc, bcc, subj, body;
+  QCStringList customHeaders;
   KURL messageFile;
   KURL::List attachURLs;
   bool mailto = false;
@@ -252,6 +253,8 @@
          attachURLs += KURL( QString::fromLocal8Bit( *it ) );
   }
 
+  customHeaders = args->getOptionList("header");
+
   if (args->isSet("composer"))
     mailto = true;
 
@@ -302,7 +305,7 @@
     viewMessage( messageFile );
   else
     action( mailto, checkMail, to, cc, bcc, subj, body, messageFile,
-            attachURLs );
+            attachURLs, customHeaders );
   return true;
 }
 
@@ -366,7 +369,8 @@
                             const QString &bcc, const QString &subject,
                             const QString &body, int hidden,
                             const KURL &messageFile,
-                            const KURL::List &attachURLs)
+                            const KURL::List &attachURLs,
+                            const QCStringList &customHeaders)
 {
   kdDebug(5006) << "KMKernel::openComposer called" << endl;
   KMMessage *msg = new KMMessage;
@@ -389,6 +393,23 @@
   else if (!body.isEmpty())
     msg->setBody(body.utf8());
 
+  if (!customHeaders.isEmpty())
+  {
+    for ( QCStringList::ConstIterator it = customHeaders.begin() ; it != customHeaders.end() ; ++it )
+      if ( !(*it).isEmpty() )
+      {
+        const int pos = (*it).find( ':' );
+        if ( pos > 0 )
+        {
+          QCString header, value;
+          header = (*it).left( pos ).stripWhiteSpace();
+          value = (*it).mid( pos+1 ).stripWhiteSpace();
+          if ( !header.isEmpty() && !value.isEmpty() )
+            msg->setHeaderField( header, value );
+        }
+      }
+  }
+
   KMail::Composer * cWin = KMail::makeComposer( msg );
   cWin->setCharset("", TRUE);
   for ( KURL::List::ConstIterator it = attachURLs.begin() ; it != attachURLs.end() ; ++it )
@@ -1802,14 +1823,15 @@
                       const QString &cc, const QString &bcc,
                       const QString &subj, const QString &body,
                       const KURL &messageFile,
-                      const KURL::List &attachURLs)
+                      const KURL::List &attachURLs,
+                      const QCStringList &customHeaders)
 {
-  if (mailto)
-    openComposer (to, cc, bcc, subj, body, 0, messageFile, attachURLs);
+  if ( mailto )
+    openComposer( to, cc, bcc, subj, body, 0, messageFile, attachURLs, customHeaders );
   else
     openReader( check );
 
-  if (check)
+  if ( check )
     checkMail();
   //Anything else?
 }
@@ -2247,9 +2269,15 @@
   if ( !Wallet::isEnabled() || walletOpenFailed )
     return 0;
 
+  // find an appropriate parent window for the wallet dialog
+  WId window = 0;
+  if ( qApp->activeWindow() )
+    window = qApp->activeWindow()->winId();
+  else if ( getKMMainWidget() )
+    window = getKMMainWidget()->topLevelWidget()->winId();
+
   delete mWallet;
-  mWallet = Wallet::openWallet( Wallet::NetworkWallet(),
-        getKMMainWidget() ? getKMMainWidget()->topLevelWidget()->winId() : 0 );
+  mWallet = Wallet::openWallet( Wallet::NetworkWallet(), window );
 
   if ( !mWallet ) {
     walletOpenFailed = true;
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/headerstyle.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -527,6 +527,40 @@
       userHTML = "&nbsp;";
     }
 
+    if( photoURL.isEmpty() ) {
+      // no photo, look for a Face header
+      QString faceheader = message->headerField( "Face" );
+      if ( !faceheader.isEmpty() ) {
+        QImage faceimage;
+
+        kdDebug( 5006 ) << "Found Face: header" << endl;
+
+        QCString facestring = faceheader.utf8();
+        // Spec says header should be less than 998 bytes
+        // Face: is 5 characters
+        if ( facestring.length() < 993 ) {
+          QByteArray facearray;
+          KCodecs::base64Decode(facestring, facearray);
+    
+          QImage faceimage;
+          if ( faceimage.loadFromData( facearray, "png" ) ) {
+            // Spec says image must be 48x48 pixels
+            if ( (48 == faceimage.width()) && (48 == faceimage.height()) ) {
+              photoURL = imgToDataUrl( faceimage );
+              photoWidth = 48;
+              photoHeight = 48;
+            } else {
+              kdDebug( 5006 ) << "Face: header image is" << faceimage.width() << "by" << faceimage.height() <<"not 48x48 Pixels" << endl;
+            }
+          } else {
+            kdDebug( 5006 ) << "Failed to load decoded png from Face: header" << endl;
+          }
+        } else {
+          kdDebug( 5006 ) << "Face: header too long at " << facestring.length() << endl;
+        }
+      }
+    }
+
     if( photoURL.isEmpty() )
     {
       // no photo, look for a X-Face header
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -445,6 +445,11 @@
       mLastUid. See above for details. */
   ulong mTentativeHighestUid;
 
+  /** Used to determine whether listing messages yielded a sensible result.
+   * Only then is the deletion o messages (which relies on succesful
+   * listing) attempted, during the sync.  */
+  bool mFoundAnIMAPDigest;
+
   int mUserRights;
   ACLList mACLList;
 
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -846,6 +846,10 @@
     }
   }
 
+  // update folder menus in case some mail got filtered to trash/current folder
+  // and we can enable "empty trash/move all to trash" action etc.
+  updateFolderMenu();
+
   if ( !showNotification )
     return;
 
@@ -1013,6 +1017,10 @@
     BroadcastStatus::instance()->setStatusMsg(i18n("Moved all messages to the trash"));
 
   updateMessageActions();
+
+  // Disable empty trash/move all to trash action - we've just deleted/moved all folder
+  // contents.
+  mEmptyFolderAction->setEnabled( false );
 }
 
 
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -398,8 +398,8 @@
   void slotAttachRemove();
   void slotAttachSave();
   void slotAttachProperties();
+  void slotAttachOpenWith();
 
-
   /**
    * Select an email from the addressbook and add it to the line
    * the pressed button belongs to.
@@ -546,9 +546,9 @@
   virtual bool queryExit ();
 
   /**
-   * Open the attachment with the given index.
+   * Open the attachment with the given index and with ("Open with")
    */
-  void openAttach( int index );
+  void openAttach( int index, bool with );
 
   /**
    * View the attachment with the given index.
@@ -649,6 +649,14 @@
    */
   static bool validateAddresses( QWidget * parent, const QString & addresses );
 
+  /**
+   * Sets the transport combobox to @p transport. If @p transport is empty
+   * then the combobox remains unchanged. If @p transport is neither a known transport
+   * nor a custom transport then the combobox is set to the default transport.
+   * @param transport the transport the combobox should be set to
+   */
+  void setTransport( const QString & transport );
+
 private slots:
    /**
     * Compress an attachemnt with the given index
@@ -688,7 +696,7 @@
   QPtrList<QListViewItem> mAtmItemList;
   QPtrList<KMMessagePart> mAtmList;
   QPopupMenu *mAttachMenu;
-  int mOpenId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
+  int mOpenId, mOpenWithId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
   bool mAutoDeleteMsg;
   bool mSigningAndEncryptionExplicitlyDisabled;
   bool mLastSignActionState, mLastEncryptActionState;
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -333,7 +333,7 @@
 
   connect( mAtmListView,
            SIGNAL( doubleClicked( QListViewItem* ) ),
-           SLOT( slotAttachProperties() ) );
+           SLOT( slotAttachOpen() ) );
   connect( mAtmListView,
            SIGNAL( rightButtonPressed( QListViewItem*, const QPoint&, int ) ),
            SLOT( slotAttachPopupMenu( QListViewItem*, const QPoint&, int ) ) );
@@ -620,18 +620,11 @@
   while ( transportHistory.count() > (uint)GlobalSettings::self()->maxTransportEntries() )
     transportHistory.remove( transportHistory.last() );
   mTransport->insertStringList( transportHistory );
-  if (mBtnTransport->isChecked() && !currentTransport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == currentTransport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( currentTransport );
+  mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+  if ( mBtnTransport->isChecked() ) {
+    setTransport( currentTransport );
   }
 
-  if ( !mBtnTransport->isChecked() ) {
-    mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
-  }
-
   QString fccName = "";
   if ( mBtnFcc->isChecked() ) {
     fccName = GlobalSettings::self()->previousFcc();
@@ -1659,6 +1652,37 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::setTransport( const QString & transport )
+{
+  kdDebug(5006) << "KMComposeWin::setTransport( \"" << transport << "\" )" << endl;
+  // Don't change the transport combobox if transport is empty
+  if ( transport.isEmpty() )
+    return;
+
+  bool transportFound = false;
+  for ( int i = 0; i < mTransport->count(); ++i ) {
+    if ( mTransport->text(i) == transport ) {
+      transportFound = true;
+      mTransport->setCurrentItem(i);
+      kdDebug(5006) << "transport found, it's no. " << i << " in the list" << endl;
+      break;
+    }
+  }
+  if ( !transportFound ) { // unknown transport
+    kdDebug(5006) << "unknown transport \"" << transport << "\"" << endl;
+    if ( transport.startsWith("smtp://") || transport.startsWith("smtps://") ||
+         transport.startsWith("file://") ) {
+      // set custom transport
+      mTransport->setEditText( transport );
+    }
+    else {
+      // neither known nor custom transport -> use default transport
+      mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 void KMComposeWin::setMsg(KMMessage* newMsg, bool mayAutoSign,
                           bool allowDecryption, bool isModified)
 {
@@ -1778,12 +1802,7 @@
 
   QString transport = newMsg->headerField("X-KMail-Transport");
   if (!mBtnTransport->isChecked() && !transport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == transport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( transport );
-  }
+    setTransport( transport );
 
   if (!mBtnFcc->isChecked())
   {
@@ -2898,6 +2917,8 @@
 
      mOpenId = mAttachMenu->insertItem(i18n("to open", "Open"), this,
                              SLOT(slotAttachOpen()));
+     mOpenWithId = mAttachMenu->insertItem(i18n("Open with..."), this,
+                             SLOT(slotAttachOpenWith()));
      mViewId = mAttachMenu->insertItem(i18n("to view", "View"), this,
                              SLOT(slotAttachView()));
      mRemoveId = mAttachMenu->insertItem(i18n("Remove"), this, SLOT(slotAttachRemove()));
@@ -3142,12 +3163,23 @@
   int i = 0;
   for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
     if ( (*it)->isSelected() ) {
-      openAttach( i );
+      openAttach( i, false );
     }
   }
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::slotAttachOpenWith()
+{
+  int i = 0;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
+    if ( (*it)->isSelected() ) {
+      openAttach( i, true );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 bool KMComposeWin::inlineSigningEncryptionSelected() {
   if ( !mSignAction->isChecked() && !mEncryptAction->isChecked() )
     return false;
@@ -3175,7 +3207,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::openAttach( int index )
+void KMComposeWin::openAttach( int index, bool with )
 {
   KMMessagePart* msgPart = mAtmList.at(index);
   const QString contentTypeStr =
@@ -3202,7 +3234,7 @@
   KService::Ptr offer =
     KServiceTypeProfile::preferredService( mimetype->name(), "Application" );
 
-  if ( !offer || mimetype->name() == "application/octet-stream" ) {
+  if ( with || !offer || mimetype->name() == "application/octet-stream" ) {
     if ( ( !KRun::displayOpenWithDialog( url, autoDelete ) ) && autoDelete ) {
       QFile::remove(url.path());
     }
@@ -4280,24 +4312,11 @@
     if ( transp.isEmpty() )
     {
       mMsg->removeHeaderField("X-KMail-Transport");
-      transp = mTransport->text(0);
+      transp = GlobalSettings::self()->defaultTransport();
     }
     else
       mMsg->setHeaderField("X-KMail-Transport", transp);
-    bool found = false;
-    int i;
-    for (i = 0; i < mTransport->count(); i++) {
-      if (mTransport->text(i) == transp) {
-        found = true;
-        mTransport->setCurrentItem(i);
-        break;
-      }
-    }
-    if (found == false) {
-      if (i == mTransport->maxCount()) mTransport->setMaxCount(i + 1);
-      mTransport->insertItem(transp,i);
-      mTransport->setCurrentItem(i);
-    }
+    setTransport( transp );
   }
 
   mDictionaryCombo->setCurrentByDictionary( ident.dictionary() );
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -489,12 +489,12 @@
     mUidlFinished = TRUE;
 
     if ( mLeaveOnServer && mUidForIdMap.isEmpty() &&
-         mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
-      KMessageBox::sorry(0, i18n("Your POP3 server does not support the UIDL "
-      "command: this command is required to determine, in a reliable way, "
-      "which of the mails on the server KMail has already seen before;\n"
-      "the feature to leave the mails on the server will therefore not "
-      "work properly."));
+        mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
+      KMessageBox::sorry(0, i18n("Your POP3 server (Account: %1) does not support "
+      "the UIDL command: this command is required to determine, in a reliable way, " 
+      "which of the mails on the server KMail has already seen before;\n" 
+      "the feature to leave the mails on the server will therefore not " 
+      "work properly.").arg(NetworkAccount::name()) );
       // An attempt to work around buggy pop servers, these seem to be popular.
       mUidsOfNextSeenMsgsDict = mUidsOfSeenMsgsDict;
     }
Index: kmail/kmfolder.cpp
===================================================================
--- kmail/kmfolder.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmfolder.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -700,6 +700,7 @@
 {
   if (units >= expireNever && units < expireMaxUnits)
     mUnreadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 void KMFolder::setReadExpireAge( int age )
@@ -714,6 +715,7 @@
 {
   if (units >= expireNever && units <= expireMaxUnits)
     mReadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 
Index: kmail/kmkernel.h
===================================================================
--- kmail/kmkernel.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmkernel.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -96,10 +96,19 @@
   /** returns id of composer if more are opened */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
-                    const KURL &messageFile, const KURL::List &attachURLs);
+                    const KURL &messageFile, const KURL::List &attachURLs,
+                    const QCStringList &customHeaders);
   /** For backward compatibility */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
+                    const KURL &messageFile, const KURL::List &attachURLs)
+  {
+    QCStringList noCustomHeaders;
+    return openComposer(to, cc, bcc, subject, body, hidden, messageFile, attachURLs, noCustomHeaders);
+  }
+  /** For backward compatibility */
+  int openComposer (const QString &to, const QString &cc, const QString &bcc,
+                    const QString &subject, const QString &body, int hidden,
                     const KURL &messageFile, const KURL& attachURL)
   {
     return openComposer(to, cc, bcc, subject, body, hidden, messageFile, KURL::List(attachURL));
@@ -245,7 +254,8 @@
   void setFirstInstance(bool value) { the_firstInstance = value; }
   void action (bool mailto, bool check, const QString &to, const QString &cc,
                const QString &bcc, const QString &subj, const QString &body,
-	       const KURL &messageFile, const KURL::List &attach);
+               const KURL &messageFile, const KURL::List &attach,
+               const QCStringList &customHeaders);
   void byteArrayToRemoteFile(const QByteArray&, const KURL&,
 			     bool overwrite = FALSE);
   bool folderIsDraftOrOutbox(const KMFolder *);
Index: kmail/Mainpage.dox
===================================================================
--- kmail/Mainpage.dox	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/Mainpage.dox	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -793,7 +793,7 @@
 
   - @em BodyPartFormatter
 	the formatter interface. Contains a single method format()
-	that takes a BodyPart to process and a HTMLWriter to write the
+	that takes a BodyPart to process and an HTMLWriter to write the
 	generated HTML to and returns a result code with which it can
 	request more information or delegate the formatting back to
 	some default processor. BodyPartFormatters are meant to be
Index: kmail/kmail_config_accounts.desktop
===================================================================
--- kmail/kmail_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kmail/kmail_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
@@ -61,6 +62,7 @@
 Name[zh_CN]=账户
 Name[zh_TW]=帳號
 Comment=Setup for Sending and Receiving Messages
+Comment[ar]=تعيينات إرسال و إستقبال الرسائل
 Comment[bg]=Настройки на мрежата, сървърите и сметките
 Comment[bs]=Postavke za slanje i prijem poruka
 Comment[ca]=Configuració per enviar i rebre missatges
Index: knode/articlewidget.h
===================================================================
--- knode/articlewidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ knode/articlewidget.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -145,7 +145,7 @@
       FancyFormatting = 2,
       AllowROT13 = 4
     };
-    /// convert the given string into a HTML string
+    /// convert the given string into an HTML string
     QString toHtmlString( const QString &line, int flags = ParseURL );
     /// convert the given image into a data:/ URL
     static QString imgToDataUrl( const QImage &image, const char* fmt );
Index: knode/knode_config_accounts.desktop
===================================================================
--- knode/knode_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ knode/knode_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KNode
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ knode/KNode.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -42,7 +42,7 @@
 GenericName[id]=Pembaca Berita
 GenericName[is]=Fréttaforrit
 GenericName[it]=Lettore newsgroup
-GenericName[ja]=ニュースリーダ
+GenericName[ja]=ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​ព័ត៌មាន
 GenericName[lt]=Naujienų skaityklė
 GenericName[lv]=Ziņu Lasītājs
Index: doc/kalarm/mainwindow.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: doc/kalarm/editwindow.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: doc/kalarm/index.docbook
===================================================================
--- doc/kalarm/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ doc/kalarm/index.docbook	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,5 +1,5 @@
 <?xml version="1.0" ?>
-<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.1.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
+<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
   <!ENTITY kappname "&kalarm;">
   <!ENTITY package "kdepim">
   <!ENTITY % addindex "IGNORE">
@@ -16,7 +16,6 @@
 <authorgroup>
 <author>
 <firstname>David</firstname>
-<othername></othername>
 <surname>Jarvie</surname>
 <affiliation>
 <address><email>software@astrojar.org.uk</email></address>
@@ -42,8 +41,8 @@
 
 <!-- Don't change format of date and version of the documentation -->
 
-<date>2006-04-09</date>
-<releaseinfo>1.04.03</releaseinfo>
+<date>2006-10-21</date>
+<releaseinfo>1.04.06</releaseinfo>
 
 <abstract>
 <para>&kalarm; is a personal alarm message, command and email scheduler for &kde;.</para>
@@ -617,7 +616,7 @@
 <guimenuitem>Import Alarms...</guimenuitem></menuchoice>. The
 import function scans the selected calendar file for events containing
 alarms, and copies them (with new unique IDs) into &kalarm;'s calendar.
-Events without alarms, and other types of calendar entry, are
+Events without alarms, and calendar entries other than events, are
 ignored.</para>
 
 <warning><para>If you import alarms from calendar files which were
@@ -734,17 +733,15 @@
 
 <itemizedlist>
 <listitem>
-<para>The <guilabel>Confirm acknowledgment</guilabel> checkbox lets
-you specify whether you will be prompted for confirmation when you
-close the alarm message window. This may be used as a safeguard
-against accidental acknowledgment of alarms.</para>
-</listitem>
+<para>The <guilabel>Sound</guilabel> option allows you to select
+whether an audible alarm should sound when the alarm message is
+displayed. Choose:</para>
 
+<itemizedlist>
 <listitem>
-<para>Check <guilabel>Sound</guilabel> if you want an audible alarm
-to sound when the alarm message is displayed. Choose:</para>
+<para><guilabel>None</guilabel> to display the alarm silently.</para>
+</listitem>
 
-<itemizedlist>
 <listitem>
 <para><guilabel>Beep</guilabel> to sound a beep.</para>
 </listitem>
@@ -758,11 +755,11 @@
 </listitem>
 
 <listitem>
-<para><guilabel>File</guilabel> to play an audio file. Use the button
-on the right to display the Sound File dialog which lets you select a
-file to play and set volume and repetition options. If you hover the
-mouse over the button, a tooltip will display the audio file currently
-selected.</para>
+<para><guilabel>Sound file</guilabel> to play an audio file. Use the
+button on the right to display the Sound File dialog which lets you
+select a file to play and set volume and repetition options. If you
+hover the mouse over the button, a tooltip will display the audio file
+currently selected.</para>
 
 <note><para>&kalarm; uses the &arts; sound server for repetition and
 volume control. If &kalarm; has been built without &arts; support,
@@ -817,25 +814,6 @@
 </listitem>
 
 <listitem>
-<para>Check <guilabel>Reminder</guilabel> if you want to display a
-reminder in advance of the main alarm and of each of its recurrences
-(if any). Enter how long in advance using the edit controls beside
-the checkbox.</para>
-
-<note><para>You can only display a reminder before each repetition of
-an alarm if the repetitions are set up using the
-<guilabel>Recurrence</guilabel> tab. If the
-<guibutton>Simple Repetition</guibutton> button is used instead, a
-reminder will be displayed before the first occurrence
-only.</para></note>
-
-<para>If the alarm recurs, check <guilabel>Reminder for first
-recurrence only</guilabel> if you only want a reminder before the
-alarm's first recurrence. If this is not checked, the reminder period
-is limited to being less than the recurrence interval.</para>
-</listitem>
-
-<listitem>
 <para>Select the background color for the alarm message window.
 (The color selection list can be configured in the
 <link linkend="preferences-fontcolour">Preferences dialog</link>.)</para>
@@ -1029,6 +1007,28 @@
 </sect2>
 
 <sect2>
+<title>Reminder</title>
+
+<para>For a display alarm, check <guilabel>Reminder</guilabel> if you
+want to display a reminder in advance of the main alarm and of each of
+its recurrences (if any). Enter how long in advance using the edit
+controls beside the checkbox.</para>
+
+<note><para>You can only display a reminder before each repetition of
+an alarm if the repetitions are set up using the
+<guilabel>Recurrence</guilabel> tab. If the
+<guibutton>Simple Repetition</guibutton> button is used instead, a
+reminder will be displayed before the first occurrence
+only.</para></note>
+
+<para>If the alarm recurs, check <guilabel>Reminder for first
+recurrence only</guilabel> if you only want a reminder before the
+alarm's first recurrence. If this is not checked, the reminder period
+is limited to being less than the recurrence interval.</para>
+
+</sect2>
+
+<sect2>
 <title>Cancelation</title>
 
 <para>The late-cancelation options determine how an alarm is treated
@@ -1236,6 +1236,12 @@
 <sect2>
 <title>Other controls</title>
 
+<para>For display alarms, the
+<guilabel>Confirm acknowledgment</guilabel> checkbox lets you specify
+whether you will be prompted for confirmation when you close the alarm
+message window. This may be used as a safeguard against accidental
+acknowledgment of alarms.</para>
+
 <para>Select <guilabel>Show in &korganizer;</guilabel> to add the
 alarm to &korganizer;'s active calendar, where it will appear as an
 event without an alarm. This option allows you to track alarms in
@@ -1701,22 +1707,6 @@
 &kalarm;'s overall behavior:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
-This starts alarm monitoring at KDE session login, by starting the
-<application>alarm daemon</application>. Note that in order for alarms
-to be activated, you also need to select appropriate options in the
-<guilabel>Run Mode</guilabel> group box.</para>
-
-<warning><para>This option should always be checked unless you intend
-to discontinue use of &kalarm;.</para></warning>
-
-<note><para>This option is automatically reselected whenever &kalarm;
-is run. So if you have unchecked this option and want to continue to
-prevent the <application>alarm daemon</application> from running at
-login, you need to uncheck this option again each time you run
-&kalarm;.</para></note>
-</listitem>
-
 <listitem><para><guilabel>Run Mode</guilabel> group box: These options
 control &kalarm;'s system tray icon, and also allow some control over
 &kalarm;'s use of system resources by specifying whether or not to run
@@ -1730,6 +1720,13 @@
 monitors the alarm list and triggers alarms.</para>
 
 <itemizedlist>
+<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
+is run only when an alarm is triggered, if you run it manually, or
+while its system tray icon is displayed. In this mode the system tray
+icon can still be displayed, but closing the system tray icon has no
+effect on any &kalarm; windows.</para>
+</listitem>
+
 <listitem><para><guilabel>Run continuously in system tray</guilabel>:
 &kalarm; runs continuously and the system tray icon is always
 displayed while it is running. In this mode, closing the system tray
@@ -1738,10 +1735,6 @@
 are:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Autostart at login</guilabel>: This starts
-&kalarm; at &kde; session login, ensuring that &kalarm; runs at all
-times unless you manually quit.</para>
-</listitem>
 <listitem><para><guilabel>Disable alarms while not running</guilabel>:
 Selecting this option has the effect that alarms will be disabled
 whenever &kalarm;'s system tray icon is not visible.</para>
@@ -1759,22 +1752,37 @@
 </listitem>
 </itemizedlist>
 
+<!--
 <para>In this mode, if no system tray exists, &kalarm; runs
 continuously in the background and alarms are always enabled.</para>
+-->
 </listitem>
 
-<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
-is run only when an alarm is triggered, if you run it manually, or
-while its system tray icon is displayed. In this mode the system tray
-icon can still be displayed, but closing the system tray icon has no
-effect on any &kalarm; windows.</para>
+<listitem><para><guilabel>Autostart at login</guilabel>: In continuous
+mode, this starts &kalarm; at &kde; session login, ensuring that
+&kalarm; runs at all times unless you manually quit.</para>
+</listitem>
 
-<itemizedlist>
 <listitem><para><guilabel>Autostart system tray icon at
-login</guilabel>: This displays &kalarm;'s system tray icon at login.
-&kalarm; will run until the system tray icon is closed.</para>
+login</guilabel>: In on-demand mode, this displays &kalarm;'s system
+tray icon at login. &kalarm; will run until the system tray icon is
+closed.</para>
 </listitem>
-</itemizedlist>
+
+<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
+This starts alarm monitoring at KDE session login, by starting the
+<application>alarm daemon</application>. Note that in order for alarms
+to be activated, you also need to select appropriate options in the
+<guilabel>Run Mode</guilabel> group box.</para>
+
+<warning><para>This option should always be checked unless you intend
+to discontinue use of &kalarm;.</para></warning>
+
+<note><para>This option is automatically reselected whenever &kalarm;
+is run. So if you have unchecked this option and want to continue to
+prevent the <application>alarm daemon</application> from running at
+login, you need to uncheck this option again each time you run
+&kalarm;.</para></note>
 </listitem>
 </itemizedlist>
 </listitem>
@@ -1823,17 +1831,20 @@
 options control the storage of expired alarms.</para>
 <itemizedlist>
 <listitem><para><guilabel>Keep alarms after expiry</guilabel>:
-Select this option to store expired alarms. Deselect it to keep no
-record of alarms once they have expired.</para>
+Select this option to store expired and deleted alarms. Deselect it
+to keep no record of alarms once they cease to be active. Note that
+deleted alarms are only stored if they have previously been
+triggered. If you delete an alarm before it ever triggers, it is
+discarded.</para>
 </listitem>
 
 <listitem><para><guilabel>Discard expired alarms after</guilabel>:
-Set the number of days to store expired alarms after their last
-activation.</para>
+Set the number of days to store expired and deleted alarms, after which
+they are permanently deleted.</para>
 </listitem>
 
 <listitem><para><guibutton>Clear expired alarms</guibutton>: This
-button discards all currently stored  expired alarms. This has no
+button discards all currently stored expired alarms. This has no
 effect on alarms which subsequently expire; they will continue to be
 stored according to the selected options.</para>
 </listitem>
@@ -2149,9 +2160,8 @@
 </listitem>
 
 <listitem><para>Set the default sound options. Note that a default
-sound file may be specified even if <guilabel>Sound</guilabel> is
-unchecked, or if <guilabel>Beep</guilabel> or
-<guilabel>Speak</guilabel> is checked.</para>
+sound file may be specified even if the sound type is not set to
+<guilabel>Sound file</guilabel>.</para>
 </listitem>
 </itemizedlist>
 
@@ -4030,16 +4040,16 @@
 
 <!-- TRANS:CREDIT_FOR_TRANSLATORS -->
 
+&underFDL;               <!-- FDL: do not remove -->
+
+&underGPL;        	 <!-- GPL License -->
+
 <para>Thanks go to the author of the &kde; 1 KAlarm application,
 Stefan Nikolaus <email>stefan.nikolaus@stuco.uni-oldenburg.de</email>,
 who kindly agreed to allow the name &kalarm; to be used by this
 &kde; 2 / &kde; 3 application.
 </para>
 
-&underFDL;               <!-- FDL: do not remove -->
-
-&underGPL;        	 <!-- GPL License -->
-
 </chapter>
 
 <appendix id="installation">
Index: kalarm/messagewin.cpp
===================================================================
--- kalarm/messagewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/messagewin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1437,18 +1437,18 @@
 		if (AlarmCalendar::activeCalendar()->event(mEventID))
 		{
 			// The old alarm hasn't expired yet, so replace it
-			status = KAlarm::modifyEvent(mEvent, event, 0);
+			status = KAlarm::modifyEvent(mEvent, event, 0, &editDlg);
 			Undo::saveEdit(mEvent, event);
 		}
 		else
 		{
 			// The old event has expired, so simply create a new one
-			status = KAlarm::addEvent(event, 0);
+			status = KAlarm::addEvent(event, 0, &editDlg);
 			Undo::saveAdd(event);
 		}
 
 		if (status == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_MODIFY, 1);
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
 
 		// Close the alarm window
@@ -1524,7 +1524,7 @@
 			KAEvent event(*kcalEvent);
 			bool repeat = event.defer(dateTime, (mAlarmType & KAAlarm::REMINDER_ALARM), true);
 			event.setDeferDefaultMinutes(delayMins);
-			KAlarm::updateEvent(event, 0, true, !repeat);
+			KAlarm::updateEvent(event, 0, true, !repeat, mDeferDlg);
 		}
 		else
 		{
@@ -1546,7 +1546,7 @@
 			event.setDeferDefaultMinutes(delayMins);
 			// Add the event back into the calendar file, retaining its ID
 			// and not updating KOrganizer
-			KAlarm::addEvent(event, 0, true, false);
+			KAlarm::addEvent(event, 0, true, false, mDeferDlg);
 			if (kcalEvent)
 			{
 				event.setUid(KAEvent::EXPIRED);
Index: kalarm/undo.cpp
===================================================================
--- kalarm/undo.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/undo.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -57,7 +57,7 @@
 		virtual UndoItem* restore() = 0;
 		virtual bool      deleteID(const QString& /*id*/)  { return false; }
 
-		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_EXPIRED };
+		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_TEMPLATE, ERR_EXPIRED };
 		enum Warning { WARN_NONE, WARN_KORG_ADD, WARN_KORG_MODIFY, WARN_KORG_DELETE };
 		static int        mLastId;
 		static Error      mRestoreError;         // error code valid only if restore() returns 0
@@ -337,7 +337,7 @@
 	{
 		case UndoItem::ERR_NONE:
 		{
-			KAlarm::UpdateError errcode;
+			KAlarm::KOrgUpdateError errcode;
 			switch (UndoItem::mRestoreWarning)
 			{
 				case UndoItem::WARN_KORG_ADD:     errcode = KAlarm::KORG_ERR_ADD;  break;
@@ -352,6 +352,7 @@
 		}
 		case UndoItem::ERR_NOT_FOUND:  err = i18n("Alarm not found");  break;
 		case UndoItem::ERR_CREATE:     err = i18n("Error recreating alarm");  break;
+		case UndoItem::ERR_TEMPLATE:   err = i18n("Error recreating alarm template");  break;
 		case UndoItem::ERR_EXPIRED:    err = i18n("Cannot reactivate expired alarm");  break;
 		case UndoItem::ERR_PROG:       err = i18n("Program error");  break;
 		default:                       err = i18n("Unknown error");  break;
@@ -733,14 +734,24 @@
 			if (setArchive)
 				event.setArchive();
 			// Archive it if it has already triggered
-			if (KAlarm::deleteEvent(event, true) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::deleteEvent(event, true))
 			{
-				mRestoreWarning = WARN_KORG_DELETE;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_DELETE;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::deleteTemplate(event);
+			if (KAlarm::deleteTemplate(event) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // redoing the deletion of an expired alarm
 			KAlarm::deleteEvent(event);
@@ -814,14 +825,24 @@
 	switch (calendar())
 	{
 		case KAEvent::ACTIVE:
-			if (KAlarm::modifyEvent(newEvent, *mOldEvent, 0) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::modifyEvent(newEvent, *mOldEvent, 0))
 			{
-				mRestoreWarning = WARN_KORG_MODIFY;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_MODIFY;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::updateTemplate(*mOldEvent, 0);
+			if (KAlarm::updateTemplate(*mOldEvent, 0) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // editing of expired events is not allowed
 		default:
@@ -890,6 +911,8 @@
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_EXPIRED;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -905,6 +928,8 @@
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_CREATE;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -913,7 +938,7 @@
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			if (!KAlarm::addTemplate(*mEvent, 0))
+			if (KAlarm::addTemplate(*mEvent, 0) != KAlarm::UPDATE_OK)
 			{
 				mRestoreError = ERR_CREATE;
 				return 0;
Index: kalarm/preferences.h
===================================================================
--- kalarm/preferences.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/preferences.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  preferences.h  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -60,7 +60,6 @@
 		static const QFont&      messageFont()                    { return mMessageFont; }
 		static const QTime&      startOfDay()                     { return mStartOfDay; }
 		static bool              hasStartOfDayChanged()           { return mStartOfDayChanged; }
-		static bool              autostartDaemon()                { return mAutostartDaemon; }
 		static bool              runInSystemTray()                { return mRunInSystemTray; }
 		static bool              disableAlarmsIfStopped()         { return mDisableAlarmsIfStopped; }
 		static bool              quitWarn()                       { return notifying(QUIT_WARN); }
@@ -90,7 +89,6 @@
 		static QColor            disabledColour()                 { return mDisabledColour; }
 		static QColor            expiredColour()                  { return mExpiredColour; }
 		static int               expiredKeepDays()                { return mExpiredKeepDays; }
-		static bool              defaultSound()                   { return mDefaultSound; }
 		static SoundPicker::Type defaultSoundType()               { return mDefaultSoundType; }
 		static const QString&    defaultSoundFile()               { return mDefaultSoundFile; }
 		static float             defaultSoundVolume()             { return mDefaultSoundVolume; }
@@ -123,7 +121,6 @@
 		static const QColor                     default_defaultFgColour;
 		static const QFont&                     default_messageFont()  { return mDefault_messageFont; };
 		static const QTime                      default_startOfDay;
-		static const bool                       default_autostartDaemon;
 		static const bool                       default_runInSystemTray;
 		static const bool                       default_disableAlarmsIfStopped;
 		static const bool                       default_quitWarn;
@@ -154,7 +151,6 @@
 		static const int                        default_defaultLateCancel;
 		static const bool                       default_defaultAutoClose;
 		static const bool                       default_defaultCopyToKOrganizer;
-		static const bool                       default_defaultSound;
 		static const SoundPicker::Type          default_defaultSoundType;
 		static const bool                       default_defaultSoundRepeat;
 		static const bool                       default_defaultConfirmAck;
@@ -201,7 +197,6 @@
 		static QColor              mDefaultBgColour;
 		static QFont               mMessageFont;
 		static QTime               mStartOfDay;
-		static bool                mAutostartDaemon;
 		static bool                mRunInSystemTray;
 		static bool                mDisableAlarmsIfStopped;
 		static bool                mAutostartTrayIcon;
@@ -229,7 +224,6 @@
 		static int                 mDefaultLateCancel;
 		static bool                mDefaultAutoClose;
 		static bool                mDefaultCopyToKOrganizer;
-		static bool                mDefaultSound;
 		static SoundPicker::Type   mDefaultSoundType;
 		static bool                mDefaultSoundRepeat;
 		static bool                mDefaultConfirmAck;
@@ -245,7 +239,6 @@
 		// Change tracking
 		static QTime               mOldStartOfDay;       // previous start-of-day time
 		static bool                mStartOfDayChanged;   // start-of-day check value doesn't tally with mStartOfDay
-		static bool                mOldAutostartDaemon;  // previous daemon autostart value
 };
 
 #endif // PREFERENCES_H
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -163,7 +163,7 @@
  */
 EditAlarmDlg::EditAlarmDlg(bool Template, const QString& caption, QWidget* parent, const char* name,
                            const KAEvent* event, bool readOnly)
-	: KDialogBase(parent, name, true, caption,
+	: KDialogBase(parent, (name ? name : Template ? "TemplEditDlg" : "EditDlg"), true, caption,
 	              (readOnly ? Cancel|Try : Template ? Ok|Cancel|Try : Ok|Cancel|Try|Default),
 	              (readOnly ? Cancel : Ok)),
 	  mMainPageShown(false),
@@ -225,8 +225,9 @@
 	mActionGroup = new ButtonGroup(i18n("Action"), mainPage, "actionGroup");
 	connect(mActionGroup, SIGNAL(buttonSet(int)), SLOT(slotAlarmTypeChanged(int)));
 	topLayout->addWidget(mActionGroup, 1);
-	QGridLayout* grid = new QGridLayout(mActionGroup, 3, 5, marginHint(), spacingHint());
-	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
+	QBoxLayout* layout = new QVBoxLayout(mActionGroup, marginHint(), spacingHint());
+	layout->addSpacing(fontMetrics().lineSpacing()/2);
+	QGridLayout* grid = new QGridLayout(layout, 1, 5);
 
 	// Message radio button
 	mMessageRadio = new RadioButton(i18n("Te&xt"), mActionGroup, "messageButton");
@@ -260,14 +261,11 @@
 	grid->addWidget(mEmailRadio, 1, 6);
 
 	initDisplayAlarms(mActionGroup);
+	layout->addWidget(mDisplayAlarmsFrame);
 	initCommand(mActionGroup);
+	layout->addWidget(mCommandFrame);
 	initEmail(mActionGroup);
-	mAlarmTypeStack = new QWidgetStack(mActionGroup);
-	grid->addMultiCellWidget(mAlarmTypeStack, 2, 2, 0, 6);
-	grid->setRowStretch(2, 1);
-	mAlarmTypeStack->addWidget(mDisplayAlarmsFrame, 0);
-	mAlarmTypeStack->addWidget(mCommandFrame, 1);
-	mAlarmTypeStack->addWidget(mEmailFrame, 2);
+	layout->addWidget(mEmailFrame);
 
 	// Deferred date/time: visible only for a deferred recurring event.
 	mDeferGroup = new QGroupBox(1, Qt::Vertical, i18n("Deferred Alarm"), mainPage, "deferGroup");
@@ -282,7 +280,7 @@
 	QWhatsThis::add(mDeferChangeButton, i18n("Change the alarm's deferred time, or cancel the deferral"));
 	mDeferGroup->addSpace(0);
 
-	QBoxLayout* layout = new QHBoxLayout(topLayout);
+	layout = new QHBoxLayout(topLayout);
 
 	// Date and time entry
 	if (mTemplate)
@@ -367,7 +365,6 @@
 	      i18n("How often the alarm recurs.\nThe times shown are those configured in the Recurrence tab and in the Simple Repetition dialog."));
 	box->setFixedHeight(box->sizeHint().height());
 	layout->addWidget(box);
-	layout->addStretch();
 
 	// Simple repetition button
 	mSimpleRepetition = new RepetitionButton(i18n("Simple Repetition"), true, mainPage);
@@ -390,13 +387,21 @@
 	mLateCancel = new LateCancelSelector(true, mainPage);
 	topLayout->addWidget(mLateCancel, 0, Qt::AlignAuto);
 
+	// Acknowledgement confirmation required - default = no confirmation
+	layout = new QHBoxLayout(topLayout, 0);
+	mConfirmAck = createConfirmAckCheckbox(mainPage);
+	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
+	layout->addWidget(mConfirmAck);
+	layout->addSpacing(2*spacingHint());
+	layout->addStretch();
+
 	if (theApp()->korganizerEnabled())
 	{
 		// Show in KOrganizer checkbox
 		mShowInKorganizer = new CheckBox(i18n_ShowInKOrganizer(), mainPage);
 		mShowInKorganizer->setFixedSize(mShowInKorganizer->sizeHint());
 		QWhatsThis::add(mShowInKorganizer, i18n("Check to copy the alarm into KOrganizer's calendar"));
-		topLayout->addWidget(mShowInKorganizer);
+		layout->addWidget(mShowInKorganizer);
 	}
 
 	setButtonWhatsThis(Ok, i18n("Schedule the alarm at the specified time."));
@@ -458,7 +463,7 @@
 	mBgColourChoose->setFixedSize(mBgColourChoose->sizeHint());
 	connect(mBgColourChoose, SIGNAL(highlighted(const QColor&)), SLOT(slotBgColourSelected(const QColor&)));
 	layout->addWidget(box);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	// Font and colour choice drop-down list
@@ -468,16 +473,11 @@
 	layout->addWidget(mFontColourButton);
 
 	// Sound checkbox and file selector
+	layout = new QHBoxLayout(frameLayout);
 	mSoundPicker = new SoundPicker(mDisplayAlarmsFrame);
 	mSoundPicker->setFixedSize(mSoundPicker->sizeHint());
-	frameLayout->addWidget(mSoundPicker, 0, Qt::AlignAuto);
-
-	// Acknowledgement confirmation required - default = no confirmation
-	layout = new QHBoxLayout(frameLayout);
-	mConfirmAck = createConfirmAckCheckbox(mDisplayAlarmsFrame);
-	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
-	layout->addWidget(mConfirmAck);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addWidget(mSoundPicker);
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	if (ShellProcess::authorised())    // don't display if shell commands not allowed (e.g. kiosk mode)
@@ -789,11 +789,12 @@
 		mSimpleRepetition->set(event->repeatInterval(), event->repeatCount());
 		mRecurrenceText->setText(recurText(*event));
 		mRecurrenceEdit->set(*event);   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
-		SoundPicker::Type soundType = event->speak()                                ? SoundPicker::SPEAK
-		                            : event->beep() || event->audioFile().isEmpty() ? SoundPicker::BEEP
-		                            :                                                 SoundPicker::PLAY_FILE;
-		mSoundPicker->set((soundType != SoundPicker::BEEP || event->beep()), soundType, event->audioFile(),
-		                  event->soundVolume(), event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
+		SoundPicker::Type soundType = event->speak()                ? SoundPicker::SPEAK
+		                            : event->beep()                 ? SoundPicker::BEEP
+		                            : !event->audioFile().isEmpty() ? SoundPicker::PLAY_FILE
+		                            :                                 SoundPicker::NONE;
+		mSoundPicker->set(soundType, event->audioFile(), event->soundVolume(),
+		                  event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
 		CmdLogType logType = event->commandXterm()       ? EXEC_IN_TERMINAL
 		                   : !event->logFile().isEmpty() ? LOG_TO_FILE
 		                   :                               DISCARD_OUTPUT;
@@ -843,7 +844,7 @@
 		slotRecurFrequencyChange();      // update the Recurrence text
 		mReminder->setMinutes(0, false);
 		mReminder->enableOnceOnly(mRecurrenceEdit->isTimedRepeatType());   // must be called after mRecurrenceEdit is set up
-		mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+		mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 		                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 		mCmdTypeScript->setChecked(Preferences::defaultCmdScript());
 		mCmdLogFileEdit->setText(Preferences::defaultCmdLogFile());    // set file name before setting radio button
@@ -1031,8 +1032,7 @@
 		mSavedTemplateAfterTime = mTemplateTimeAfter->value();
 	}
 	mSavedTypeRadio        = mActionGroup->selected();
-	mSavedSound            = mSoundPicker->sound();
-	mSavedSoundType        = mSoundPicker->type();
+	mSavedSoundType        = mSoundPicker->sound();
 	mSavedSoundFile        = mSoundPicker->file();
 	mSavedSoundVolume      = mSoundPicker->volume(mSavedSoundFadeVolume, mSavedSoundFadeSeconds);
 	mSavedRepeatSound      = mSoundPicker->repeat();
@@ -1106,7 +1106,7 @@
 		return true;
 	if (mMessageRadio->isOn()  ||  mFileRadio->isOn())
 	{
-		if (mSavedSound      != mSoundPicker->sound()
+		if (mSavedSoundType  != mSoundPicker->sound()
 		||  mSavedConfirmAck != mConfirmAck->isChecked()
 		||  mSavedFont       != mFontColourButton->font()
 		||  mSavedFgColour   != mFontColourButton->fgColour()
@@ -1121,24 +1121,19 @@
 			||  mSavedPostAction != mSpecialActionsButton->postAction())
 				return true;
 		}
-		if (mSavedSound)
+		if (mSavedSoundType == SoundPicker::PLAY_FILE)
 		{
-			if (mSavedSoundType != mSoundPicker->type())
+			if (mSavedSoundFile != mSoundPicker->file())
 				return true;
-			if (mSavedSoundType == SoundPicker::PLAY_FILE)
+			if (!mSavedSoundFile.isEmpty())
 			{
-				if (mSavedSoundFile != mSoundPicker->file())
+				float fadeVolume;
+				int   fadeSecs;
+				if (mSavedRepeatSound != mSoundPicker->repeat()
+				||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
+				||  mSavedSoundFadeVolume != fadeVolume
+				||  mSavedSoundFadeSeconds != fadeSecs)
 					return true;
-				if (!mSavedSoundFile.isEmpty())
-				{
-					float fadeVolume;
-					int   fadeSecs;
-					if (mSavedRepeatSound != mSoundPicker->repeat()
-					||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
-					||  mSavedSoundFadeVolume != fadeVolume
-					||  mSavedSoundFadeSeconds != fadeSecs)
-						return true;
-				}
 			}
 		}
 	}
@@ -1297,8 +1292,8 @@
 	bool displayAlarm = mMessageRadio->isOn() || mFileRadio->isOn();
 	bool cmdAlarm     = mCommandRadio->isOn();
 	bool emailAlarm   = mEmailRadio->isOn();
-	return (displayAlarm && mSoundPicker->beep()                                 ? KAEvent::BEEP : 0)
-	     | (displayAlarm && mSoundPicker->speak()                                ? KAEvent::SPEAK : 0)
+	return (displayAlarm && mSoundPicker->sound() == SoundPicker::BEEP           ? KAEvent::BEEP : 0)
+	     | (displayAlarm && mSoundPicker->sound() == SoundPicker::SPEAK          ? KAEvent::SPEAK : 0)
 	     | (displayAlarm && mSoundPicker->repeat()                               ? KAEvent::REPEAT_SOUND : 0)
 	     | (displayAlarm && mConfirmAck->isChecked()                             ? KAEvent::CONFIRM_ACK : 0)
 	     | (displayAlarm && mLateCancel->isAutoClose()                           ? KAEvent::AUTO_CLOSE : 0)
@@ -1599,7 +1594,7 @@
 
 	bool deferred = mDeferDateTime.isValid();
 	DeferAlarmDlg deferDlg(i18n("Defer Alarm"), (deferred ? mDeferDateTime : DateTime(now.addSecs(60))),
-	                       deferred, this, "deferDlg");
+	                       deferred, this, "EditDeferDlg");
 	if (limit)
 	{
 		// Don't allow deferral past the next recurrence
@@ -1832,10 +1827,13 @@
 		mFilePadding->hide();
 		mTextMessageEdit->show();
 		mFontColourButton->show();
+		mSoundPicker->showSpeak(true);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(true);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the alarm message now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		focus = mTextMessageEdit;
 		displayAlarm = true;
 	}
@@ -1845,27 +1843,36 @@
 		mFileBox->show();
 		mFilePadding->show();
 		mFontColourButton->hide();
+		mSoundPicker->showSpeak(false);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(false);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the file now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		mFileMessageEdit->setNoSelect();
 		focus = mFileMessageEdit;
 		displayAlarm = true;
 	}
 	else if (mCommandRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->show();
+		mEmailFrame->hide();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Execute the specified command now"));
-		mAlarmTypeStack->raiseWidget(mCommandFrame);
 		mCmdCommandEdit->setNoSelect();
 		focus = mCmdCommandEdit;
 	}
 	else if (mEmailRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->hide();
+		mEmailFrame->show();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Send the email to the specified addressees now"));
-		mAlarmTypeStack->raiseWidget(mEmailFrame);
 		mEmailToEdit->setNoSelect();
 		focus = mEmailToEdit;
 	}
Index: kalarm/functions.h
===================================================================
--- kalarm/functions.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/functions.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -45,14 +45,20 @@
 
 /** Return codes from fileType() */
 enum FileType { Unknown, TextPlain, TextFormatted, TextApplication, Image };
-/** Return codes from calendar update functions */
+/** Return codes from calendar update functions.
+ *  The codes are ordered by severity.
+ */
 enum UpdateStatus {
 	UPDATE_OK,          // update succeeded
-	UPDATE_ERROR,       // update failed completely
-	UPDATE_KORG_ERR     // update succeeded, but KOrganizer update failed
+	UPDATE_KORG_ERR,    // update succeeded, but KOrganizer update failed
+	UPDATE_ERROR,       // update failed partially
+	UPDATE_FAILED,      // update failed completely
+	SAVE_FAILED         // calendar was updated in memory, but save failed
 };
+/** Error codes supplied as parameter to displayUpdateError() */
+enum UpdateError { ERR_ADD, ERR_REACTIVATE, ERR_TEMPLATE };
 /** Error codes supplied as parameter to displayKOrgUpdateError() */
-enum UpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
+enum KOrgUpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
 
 
 /** Display a main window with the specified event selected */
@@ -88,18 +94,19 @@
 QString             runKMail(bool minimise);
 bool                runProgram(const QCString& program, const QCString& windowName, QCString& dcopName, QString& errorMessage);
 
-UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false, bool allowKOrgUpdate = true);
+UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false, bool allowKOrgUpdate = true, QWidget* errmsgParent = 0);
 bool                addExpiredEvent(KAEvent&);
-bool                addTemplate(KAEvent&, TemplateListView* selectionView);
-UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView);
-void                updateEvent(KAEvent&, AlarmListView* selectionView, bool archiveOnDelete = true, bool incRevision = true);
-void                updateTemplate(const KAEvent&, TemplateListView* selectionView);
-UpdateStatus        deleteEvent(KAEvent&, bool archive = true);
-void                deleteTemplate(const KAEvent&);
+UpdateStatus        addTemplate(KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        updateEvent(KAEvent&, AlarmListView* selectionView, bool archiveOnDelete = true, bool incRevision = true, QWidget* errmsgParent = 0);
+UpdateStatus        updateTemplate(const KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        deleteEvent(KAEvent&, bool archive = true, QWidget* errmsgParent = 0);
+UpdateStatus        deleteTemplate(const KAEvent&);
 void                deleteDisplayEvent(const QString& eventID);
 UpdateStatus        reactivateEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false);
-void                enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
-void                displayKOrgUpdateError(QWidget* parent, UpdateError, int nAlarms);
+UpdateStatus        enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
+void                displayUpdateError(QWidget* parent, UpdateStatus, UpdateError, int nAlarms);
+void                displayKOrgUpdateError(QWidget* parent, KOrgUpdateError, int nAlarms);
 
 QString             stripAccel(const QString&);
 
Index: kalarm/alarmcalendar.h
===================================================================
--- kalarm/alarmcalendar.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/alarmcalendar.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -43,16 +43,16 @@
 		bool                  open();
 		int                   load();
 		bool                  reload();
-		void                  save();
+		bool                  save();
 		void                  close();
 		void                  startUpdate();
-		void                  endUpdate();
+		bool                  endUpdate();
 		KCal::Event*          event(const QString& uniqueID);
 		KCal::Event::List     events();
 		KCal::Event::List     eventsWithAlarms(const QDateTime& from, const QDateTime& to);
 		KCal::Event*          addEvent(KAEvent&, bool useEventID = false);
 		void                  updateEvent(const KAEvent&);
-		void                  deleteEvent(const QString& eventID, bool save = false);
+		bool                  deleteEvent(const QString& eventID, bool save = false);
 		void                  emitEmptyStatus();
 		void                  purgeAll()                          { purge(0); }
 		void                  setPurgeDays(int days);
Index: kalarm/soundpicker.h
===================================================================
--- kalarm/soundpicker.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/soundpicker.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.h  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,10 +25,9 @@
 #include <qstring.h>
 #include <kurl.h>
 
-class ButtonGroup;
-class CheckBox;
+class QHBox;
+class ComboBox;
 class PushButton;
-class RadioButton;
 
 
 class SoundPicker : public QFrame
@@ -36,19 +35,19 @@
 		Q_OBJECT
 	public:
 		/** Sound options which can be selected for when the alarm is displayed.
+		 *  @li NONE      - silence.
 		 *  @li BEEP      - a beep will be sounded.
-		 *  @li SPEAK     - the message will be spoken.
 		 *  @li PLAY_FILE - a sound file will be played.
+		 *  @li SPEAK     - the message text will be spoken.
 		 */
-		enum Type { BEEP = 1, SPEAK, PLAY_FILE };
+		enum Type { NONE = 0, BEEP, PLAY_FILE, SPEAK };
 		/** Constructor.
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
 		SoundPicker(QWidget* parent, const char* name = 0);
 		/** Initialises the widget's state.
-		 *  @param sound    True to enable sound.
-		 *  @param defaultType The default option to select when sound is enabled.
+		 *  @param type     The option to select.
 		 *  @param filename The full path or URL of the sound file to select. If the 'file' option is
 		 *                  not initially selected, @p filename provides the default should 'file'
 		 *                  later be selected by the user.
@@ -65,7 +64,7 @@
 		 *                  selected, @p repeat provides the default should 'file' later be selected by
 		 *                  the user.
 		 */
-		void           set(bool sound, Type defaultType, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
+		void           set(Type type, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
 		/** Returns true if the widget is read only for the user. */
 		bool           isReadOnly() const          { return mReadOnly; }
 		/** Sets whether the widget can be changed the user.
@@ -76,14 +75,8 @@
 		 *  If it is to be hidden and it is currently selected, sound is turned off.
 		 */
 		void           showSpeak(bool show);
-		/** Returns true if sound is selected. */
-		bool           sound() const;
 		/** Returns the selected option. */
-		Type           type() const;
-		/** Returns true if 'beep' is selected. */
-		bool           beep() const;
-		/** Returns true if 'speak' is selected. */
-		bool           speak() const;
+		Type           sound() const;
 		/** If the 'file' option is selected, returns the URL of the chosen file.
 		 *  Otherwise returns a null string.
 		 */
@@ -112,28 +105,21 @@
 		 */
 		static QString browseFile(QString& initialDir, const QString& initialFile = QString::null);
 
-		static QString i18n_Sound();       // plain text of Sound checkbox
-		static QString i18n_s_Sound();     // text of Sound checkbox, with 'S' shortcut
-		static QString i18n_Beep();        // plain text of Beep radio button
-		static QString i18n_b_Beep();      // text of Beep radio button, with 'B' shortcut
-		static QString i18n_Speak();       // plain text of Speak radio button
-		static QString i18n_p_Speak();     // text of Speak radio button, with 'P' shortcut
-		static QString i18n_File();        // plain text of File radio button
+		static QString i18n_Sound();       // plain text of Sound label
+		static QString i18n_None();        // plain text of None combo box item
+		static QString i18n_Beep();        // plain text of Beep combo box item
+		static QString i18n_Speak();       // plain text of Speak combo box item
+		static QString i18n_File();        // plain text of File combo box item
 
 
 	private slots:
-		void           slotSoundToggled(bool on);
-		void           slotTypeChanged(int id);
+		void           slotTypeSelected(int id);
 		void           slotPickFile();
-		void           setLastType();
 
 	private:
 
-		CheckBox*      mCheckbox;
-		ButtonGroup*   mTypeGroup;
-		RadioButton*   mBeepRadio;
-		RadioButton*   mSpeakRadio;
-		RadioButton*   mFileRadio;
+		ComboBox*      mTypeCombo;
+		QHBox*         mTypeBox;
 		PushButton*    mFilePicker;
 		QString        mDefaultDir;
 		QString        mFile;         // sound file to play when alarm is triggered
@@ -141,7 +127,7 @@
 		float          mFadeVolume;   // initial volume for file, or < 0 for no fading
 		int            mFadeSeconds;  // fade interval in seconds
 		Type           mLastType;     // last selected sound option
-		bool           mRevertType;   // reverting to last selected sound option
+		bool           mSpeakShowing; // Speak option is shown in combo box
 		bool           mRepeat;       // repeat the sound file
 		bool           mReadOnly;
 };
Index: kalarm/preferences.cpp
===================================================================
--- kalarm/preferences.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/preferences.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  preferences.cpp  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -46,7 +46,6 @@
 const QColor                     Preferences::default_defaultFgColour(Qt::black);
 QFont                            Preferences::mDefault_messageFont;    // initialised in constructor
 const QTime                      Preferences::default_startOfDay(0, 0);
-const bool                       Preferences::default_autostartDaemon         = true;
 const bool                       Preferences::default_runInSystemTray         = true;
 const bool                       Preferences::default_disableAlarmsIfStopped  = true;
 const bool                       Preferences::default_quitWarn                = true;
@@ -72,7 +71,6 @@
 const int                        Preferences::default_defaultLateCancel       = 0;
 const bool                       Preferences::default_defaultAutoClose        = false;
 const bool                       Preferences::default_defaultCopyToKOrganizer = false;
-const bool                       Preferences::default_defaultSound            = false;
 const bool                       Preferences::default_defaultSoundRepeat      = false;
 const SoundPicker::Type          Preferences::default_defaultSoundType        = SoundPicker::BEEP;
 const bool                       Preferences::default_defaultConfirmAck       = false;
@@ -99,7 +97,6 @@
 QColor                     Preferences::mDefaultBgColour;
 QFont                      Preferences::mMessageFont;
 QTime                      Preferences::mStartOfDay;
-bool                       Preferences::mAutostartDaemon;
 bool                       Preferences::mRunInSystemTray;
 bool                       Preferences::mDisableAlarmsIfStopped;
 bool                       Preferences::mAutostartTrayIcon;
@@ -130,7 +127,6 @@
 int                        Preferences::mDefaultLateCancel;
 bool                       Preferences::mDefaultAutoClose;
 bool                       Preferences::mDefaultCopyToKOrganizer;
-bool                       Preferences::mDefaultSound;
 SoundPicker::Type          Preferences::mDefaultSoundType;
 bool                       Preferences::mDefaultSoundRepeat;
 bool                       Preferences::mDefaultConfirmAck;
@@ -145,7 +141,6 @@
 // Change tracking
 QTime                      Preferences::mOldStartOfDay;
 bool                       Preferences::mStartOfDayChanged;
-bool                       Preferences::mOldAutostartDaemon;
 
 
 static const QString defaultFeb29RecurType    = QString::fromLatin1("Mar1");
@@ -186,7 +181,6 @@
 static const QString DEF_AUTO_CLOSE           = QString::fromLatin1("DefAutoClose");
 static const QString DEF_CONFIRM_ACK          = QString::fromLatin1("DefConfirmAck");
 static const QString DEF_COPY_TO_KORG         = QString::fromLatin1("DefCopyKOrg");
-static const QString DEF_SOUND                = QString::fromLatin1("DefSound");
 static const QString DEF_SOUND_TYPE           = QString::fromLatin1("DefSoundType");
 static const QString DEF_SOUND_FILE           = QString::fromLatin1("DefSoundFile");
 static const QString DEF_SOUND_VOLUME         = QString::fromLatin1("DefSoundVolume");
@@ -199,10 +193,6 @@
 static const QString DEF_REMIND_UNITS         = QString::fromLatin1("DefRemindUnits");
 static const QString DEF_PRE_ACTION           = QString::fromLatin1("DefPreAction");
 static const QString DEF_POST_ACTION          = QString::fromLatin1("DefPostAction");
-// Obsolete - compatibility with pre-1.2.1
-static const QString EMAIL_ADDRESS            = QString::fromLatin1("EmailAddress");
-static const QString EMAIL_USE_CONTROL_CENTRE = QString::fromLatin1("EmailUseControlCenter");
-static const QString EMAIL_BCC_USE_CONTROL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
 
 // Values for EmailFrom entry
 static const QString FROM_CONTROL_CENTRE      = QString::fromLatin1("@ControlCenter");
@@ -329,9 +319,8 @@
 	mDefaultAutoClose         = config->readBoolEntry(DEF_AUTO_CLOSE, default_defaultAutoClose);
 	mDefaultConfirmAck        = config->readBoolEntry(DEF_CONFIRM_ACK, default_defaultConfirmAck);
 	mDefaultCopyToKOrganizer  = config->readBoolEntry(DEF_COPY_TO_KORG, default_defaultCopyToKOrganizer);
-	mDefaultSound             = config->readBoolEntry(DEF_SOUND, default_defaultSound);
 	int soundType             = config->readNumEntry(DEF_SOUND_TYPE, default_defaultSoundType);
-	mDefaultSoundType         = (soundType < SoundPicker::BEEP || soundType > SoundPicker::PLAY_FILE)
+	mDefaultSoundType         = (soundType < 0 || soundType > SoundPicker::SPEAK)
 	                          ? default_defaultSoundType : (SoundPicker::Type)soundType;
 	mDefaultSoundVolume       = static_cast<float>(config->readDoubleNumEntry(DEF_SOUND_VOLUME, default_defaultSoundVolume));
 #ifdef WITHOUT_ARTS
@@ -356,8 +345,6 @@
 	                          ? default_defaultReminderUnits : (TimePeriod::Units)reminderUnits;
 	mDefaultPreAction         = config->readEntry(DEF_PRE_ACTION, default_defaultPreAction);
 	mDefaultPostAction        = config->readEntry(DEF_POST_ACTION, default_defaultPostAction);
-	mAutostartDaemon          = Daemon::autoStart(default_autostartDaemon);
-	mOldAutostartDaemon       = mAutostartDaemon;
 	mInstance->emitPreferencesChanged();
 	mStartOfDayChanged = (mStartOfDay != mOldStartOfDay);
 	if (mStartOfDayChanged)
@@ -409,7 +396,6 @@
 	config->writeEntry(DEF_AUTO_CLOSE, mDefaultAutoClose);
 	config->writeEntry(DEF_CONFIRM_ACK, mDefaultConfirmAck);
 	config->writeEntry(DEF_COPY_TO_KORG, mDefaultCopyToKOrganizer);
-	config->writeEntry(DEF_SOUND, mDefaultSound);
 	config->writeEntry(DEF_SOUND_TYPE, mDefaultSoundType);
 	config->writePathEntry(DEF_SOUND_FILE, mDefaultSoundFile);
 	config->writeEntry(DEF_SOUND_VOLUME, static_cast<double>(mDefaultSoundVolume));
@@ -425,12 +411,6 @@
 	config->writeEntry(DEF_POST_ACTION, mDefaultPostAction);
 	if (syncToDisc)
 		config->sync();
-	if (mAutostartDaemon != mOldAutostartDaemon)
-	{
-		// The alarm daemon autostart setting has changed.
-		Daemon::enableAutoStart(mAutostartDaemon);
-		mOldAutostartDaemon = mAutostartDaemon;
-	}
 	mInstance->emitPreferencesChanged();
 	if (mStartOfDay != mOldStartOfDay)
 	{
@@ -565,42 +545,55 @@
 	KConfig* config = KGlobal::config();
 	config->setGroup(GENERAL_SECTION);
 	int version = KAlarm::getVersionNumber(config->readEntry(VERSION_NUM));
-	if (version >= KAlarm::Version(1,3,0))
+	if (version >= KAlarm::Version(1,4,6))
 		return;     // config format is up to date
 
-	bool sync = false;
-	QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
-	if (entries.find(EMAIL_FROM) == entries.end()
-	&&  entries.find(EMAIL_USE_CONTROL_CENTRE) != entries.end())
-	{
-		// Preferences were written by KAlarm pre-1.2.1
-		config->setGroup(GENERAL_SECTION);
-		bool useCC = false;
-		bool bccUseCC = false;
-		const bool default_emailUseControlCentre    = true;
-		const bool default_emailBccUseControlCentre = true;
-		useCC = config->readBoolEntry(EMAIL_USE_CONTROL_CENTRE, default_emailUseControlCentre);
-		// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
-		bccUseCC = config->hasKey(EMAIL_BCC_USE_CONTROL_CENTRE)
-		         ? config->readBoolEntry(EMAIL_BCC_USE_CONTROL_CENTRE, default_emailBccUseControlCentre)
-			 : useCC;
-		config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
-		config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
-		config->deleteEntry(EMAIL_ADDRESS);
-		config->deleteEntry(EMAIL_BCC_USE_CONTROL_CENTRE);
-		config->deleteEntry(EMAIL_USE_CONTROL_CENTRE);
-		sync = true;
-	}
-	// Convert KAlarm 1.2 preferences
-	static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
+	// Convert KAlarm 1.4.5 preferences
+	static const QString DEF_SOUND = QString::fromLatin1("DefSound");
 	config->setGroup(DEFAULTS_SECTION);
-	if (config->hasKey(DEF_CMD_XTERM))
+	bool sound = config->readBoolEntry(DEF_SOUND, false);
+	if (!sound)
+		config->writeEntry(DEF_SOUND_TYPE, SoundPicker::NONE);
+	config->deleteEntry(DEF_SOUND);
+
+	if (version < KAlarm::Version(1,3,0))
 	{
-		config->writeEntry(DEF_CMD_LOG_TYPE,
-			(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
-		config->deleteEntry(DEF_CMD_XTERM);
-		sync = true;
+		// Convert KAlarm pre-1.3 preferences
+		static const QString EMAIL_ADDRESS             = QString::fromLatin1("EmailAddress");
+		static const QString EMAIL_USE_CTRL_CENTRE     = QString::fromLatin1("EmailUseControlCenter");
+		static const QString EMAIL_BCC_USE_CTRL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
+		QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
+		if (entries.find(EMAIL_FROM) == entries.end()
+		&&  entries.find(EMAIL_USE_CTRL_CENTRE) != entries.end())
+		{
+			// Preferences were written by KAlarm pre-1.2.1
+			config->setGroup(GENERAL_SECTION);
+			bool useCC = false;
+			bool bccUseCC = false;
+			const bool default_emailUseControlCentre    = true;
+			const bool default_emailBccUseControlCentre = true;
+			useCC = config->readBoolEntry(EMAIL_USE_CTRL_CENTRE, default_emailUseControlCentre);
+			// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
+			bccUseCC = config->hasKey(EMAIL_BCC_USE_CTRL_CENTRE)
+			         ? config->readBoolEntry(EMAIL_BCC_USE_CTRL_CENTRE, default_emailBccUseControlCentre)
+				 : useCC;
+			config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
+			config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
+			config->deleteEntry(EMAIL_ADDRESS);
+			config->deleteEntry(EMAIL_BCC_USE_CTRL_CENTRE);
+			config->deleteEntry(EMAIL_USE_CTRL_CENTRE);
+		}
+		// Convert KAlarm 1.2 preferences
+		static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
+		config->setGroup(DEFAULTS_SECTION);
+		if (config->hasKey(DEF_CMD_XTERM))
+		{
+			config->writeEntry(DEF_CMD_LOG_TYPE,
+				(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
+			config->deleteEntry(DEF_CMD_XTERM);
+		}
 	}
-	if (sync)
-		config->sync();
+	config->setGroup(GENERAL_SECTION);
+	config->writeEntry(VERSION_NUM, KALARM_VERSION);
+	config->sync();
 }
Index: kalarm/templatedlg.cpp
===================================================================
--- kalarm/templatedlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/templatedlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  templatedlg.cpp  -  dialogue to create, edit and delete alarm templates
  *  Program:  kalarm
- *  Copyright (c) 2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -144,14 +144,14 @@
 */
 void TemplateDlg::createTemplate(const KAEvent* event, QWidget* parent, TemplateListView* view)
 {
-	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, "editDlg", event);
+	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, 0, event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent event;
 		editDlg.getEvent(event);
 
 		// Add the template to the displayed lists and to the calendar file
-		KAlarm::addTemplate(event, view);
+		KAlarm::addTemplate(event, view, &editDlg);
 		Undo::saveAdd(event);
 	}
 }
@@ -166,7 +166,7 @@
 	if (item)
 	{
 		KAEvent event = item->event();
-		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, "editDlg", &event);
+		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, 0, &event);
 		if (editDlg.exec() == QDialog::Accepted)
 		{
 			KAEvent newEvent;
@@ -175,7 +175,7 @@
 			newEvent.setEventID(id);
 
 			// Update the event in the displays and in the calendar file
-			KAlarm::updateTemplate(newEvent, mTemplateList);
+			KAlarm::updateTemplate(newEvent, mTemplateList, &editDlg);
 			Undo::saveEdit(event, newEvent);
 		}
 	}
@@ -195,16 +195,29 @@
 		    != KMessageBox::Continue)
 		return;
 
+	int warnErr = 0;
+	KAlarm::UpdateStatus status = KAlarm::UPDATE_OK;
 	QValueList<KAEvent> events;
 	AlarmCalendar::templateCalendar()->startUpdate();    // prevent multiple saves of the calendar until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
 	{
 		TemplateListViewItem* item = (TemplateListViewItem*)(*it);
 		events.append(item->event());
-		KAlarm::deleteTemplate(item->event());
+		KAlarm::UpdateStatus st = KAlarm::deleteTemplate(item->event());
+		if (st != KAlarm::UPDATE_OK)
+		{
+			status = st;
+			++warnErr;
+		}
 	}
-	AlarmCalendar::templateCalendar()->endUpdate();    // save the calendar now
+	if (!AlarmCalendar::templateCalendar()->endUpdate())    // save the calendar now
+	{
+		status = KAlarm::SAVE_FAILED;
+		warnErr = items.count();
+	}
 	Undo::saveDeletes(events);
+	if (warnErr)
+		displayUpdateError(this, status, KAlarm::ERR_TEMPLATE, warnErr);
 }
 
 /******************************************************************************
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.5"
+#define KALARM_VERSION "1.4.6"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -114,7 +114,7 @@
 }
 
 MainWindow::MainWindow(bool restored)
-	: MainWindowBase(0, 0, WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
+	: MainWindowBase(0, "MainWin", WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
 	  mMinuteTimerActive(false),
 	  mHiddenTrayParent(false),
 	  mShowExpired(Preferences::showExpiredAlarms()),
@@ -567,7 +567,7 @@
 */
 void MainWindow::executeNew(MainWindow* win, const KAEvent* evnt, KAEvent::Action action, const AlarmText& text)
 {
-	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, "editDlg", evnt);
+	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, 0, evnt);
 	if (!text.isEmpty())
 		editDlg.setAction(action, text);
 	if (editDlg.exec() == QDialog::Accepted)
@@ -576,8 +576,8 @@
 		editDlg.getEvent(event);
 
 		// Add the alarm to the displayed lists and to the calendar file
-		if (KAlarm::addEvent(event, (win ? win->mListView : 0)) == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_ADD, 1);
+		if (KAlarm::addEvent(event, (win ? win->mListView : 0), &editDlg) == KAlarm::UPDATE_KORG_ERR)
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_ADD, 1);
 		Undo::saveAdd(event);
 
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
@@ -637,7 +637,7 @@
 */
 void MainWindow::executeEdit(KAEvent& event, MainWindow* win)
 {
-	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, "editDlg", &event);
+	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, 0, &event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent newEvent;
@@ -648,12 +648,13 @@
 		if (changeDeferral)
 		{
 			// The only change has been to an existing deferral
-			KAlarm::updateEvent(newEvent, view, true, false);   // keep the same event ID
+			if (KAlarm::updateEvent(newEvent, view, true, false, &editDlg) != KAlarm::UPDATE_OK)   // keep the same event ID
+				return;   // failed to save event
 		}
 		else
 		{
-			if (KAlarm::modifyEvent(event, newEvent, view) == KAlarm::UPDATE_KORG_ERR)
-				KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_MODIFY, 1);
+			if (KAlarm::modifyEvent(event, newEvent, view, &editDlg) == KAlarm::UPDATE_KORG_ERR)
+				KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		}
 		Undo::saveEdit(event, newEvent);
 
@@ -673,7 +674,7 @@
 		KAEvent event = item->event();
 		EditAlarmDlg editDlg(false, (event.expired() ? i18n("Expired Alarm") + " [" + i18n("read-only") + "]"
 		                                             : i18n("View Alarm")),
-		                     this, "editDlg", &event, true);
+		                     this, 0, &event, true);
 		editDlg.exec();
 	}
 }
@@ -697,6 +698,7 @@
 			return;
 	}
 
+	int warnErr = 0;
 	int warnKOrg = 0;
 	QValueList<KAEvent> events;
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
@@ -708,14 +710,28 @@
 
 		// Delete the event from the calendar and displays
 		events.append(event);
-		if (KAlarm::deleteEvent(event) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::deleteEvent(event))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveDeletes(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_DELETE, warnKOrg);
 }
 
@@ -725,6 +741,7 @@
 */
 void MainWindow::slotReactivate()
 {
+	int warnErr = 0;
 	int warnKOrg = 0;
 	QValueList<KAEvent> events;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
@@ -737,14 +754,28 @@
 		AlarmListViewItem* item = (AlarmListViewItem*)(*it);
 		KAEvent event = item->event();
 		events.append(event);
-		if (KAlarm::reactivateEvent(event, mListView, true) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::reactivateEvent(event, mListView, true))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveReactivates(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_REACTIVATE, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 }
 
@@ -755,6 +786,7 @@
 void MainWindow::slotEnable()
 {
 	bool enable = mActionEnableEnable;    // save since changed in response to KAlarm::enableEvent()
+	int warnErr = 0;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
@@ -763,9 +795,13 @@
 		KAEvent event = item->event();
 
 		// Enable the alarm in the displayed lists and in the calendar file
-		KAlarm::enableEvent(event, mListView, enable);
+		if (KAlarm::enableEvent(event, mListView, enable) != KAlarm::UPDATE_OK)
+			++warnErr;
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
 }
 
 /******************************************************************************
@@ -830,14 +866,28 @@
 		if (events.count())
 		{
 			mListView->clearSelection();
+			int warnErr = 0;
 			int warnKOrg = 0;
 			for (QValueList<KAEvent>::Iterator ev = events.begin();  ev != events.end();  ++ev)
 			{
 				// Add alarm to the displayed lists and to the calendar file
-				if (KAlarm::addEvent(*ev, mListView) == KAlarm::UPDATE_KORG_ERR)
-					++warnKOrg;
+				switch (KAlarm::addEvent(*ev, mListView))
+				{
+					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
+						++warnErr;
+						break;
+					case KAlarm::UPDATE_KORG_ERR:
+						++warnKOrg;
+						break;
+					default:
+						break;
+				}
 			}
-			if (warnKOrg)
+			if (warnErr)
+				KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
+			else if (warnKOrg)
 				KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 			KAlarm::outputAlarmWarnings(&dlg);
 		}
Index: kalarm/editdlg.h
===================================================================
--- kalarm/editdlg.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/editdlg.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.h  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -233,7 +233,6 @@
 		int                 mSavedTemplateAfterTime; // mTemplateAfterTime value
 		QButton*            mSavedTypeRadio;      // mMessageRadio, etc
 		SoundPicker::Type   mSavedSoundType;      // mSoundPicker sound type
-		bool                mSavedSound;          // mSoundPicker sound status
 		bool                mSavedRepeatSound;    // mSoundPicker repeat status
 		QString             mSavedSoundFile;      // mSoundPicker sound file
 		float               mSavedSoundVolume;    // mSoundPicker volume
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright (c) 2001-2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,6 +28,7 @@
 
 #include "preferences.h"
 #include "recurrenceedit.h"
+#include "soundpicker.h"
 
 class QButtonGroup;
 class QCheckBox;
@@ -126,8 +127,7 @@
 		QRadioButton*  mRunOnDemand;
 		QCheckBox*     mDisableAlarmsIfStopped;
 		QCheckBox*     mQuitWarn;
-		QCheckBox*     mAutostartTrayIcon1;
-		QCheckBox*     mAutostartTrayIcon2;
+		QCheckBox*     mAutostartTrayIcon;
 		QCheckBox*     mConfirmAlarmDeletion;
 		QCheckBox*     mKeepExpired;
 		QCheckBox*     mPurgeExpired;
@@ -192,8 +192,6 @@
 		void         slotBrowseSoundFile();
 
 	private:
-		void         setSoundType(SoundPicker::Type);
-
 		QCheckBox*      mAutoClose;
 		QCheckBox*      mConfirmAck;
 		QComboBox*      mReminderUnits;
@@ -201,10 +199,7 @@
 		QCheckBox*      mCmdScript;
 		QCheckBox*      mCmdXterm;
 		QCheckBox*      mEmailBcc;
-		QRadioButton*   mBeep;
-		QRadioButton*   mSpeak;
-		QRadioButton*   mFile;
-		QCheckBox*      mSound;
+		QComboBox*      mSound;
 		QLabel*         mSoundFileLabel;
 		QLineEdit*      mSoundFile;
 		QPushButton*    mSoundFileBrowse;
@@ -214,6 +209,7 @@
 		QComboBox*      mRecurPeriod;
 		QButtonGroup*   mFeb29;
 
+		static int soundIndex(SoundPicker::Type);
 		static int recurIndex(RecurrenceEdit::RepeatType);
 };
 
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,5 +1,12 @@
 KAlarm
 
+=== Version 1.4.6 --- 21 October 2006 ===
+Fix "Start alarm monitoring at login" value shown in preferences dialogue.
+Fix deselecting "Start alarm monitoring at login" when daemon not running.
+Tidy up preferences dialogue Run mode options.
+Tidy up alarm edit/preferences dialogue sound type options into a combo box.
+Add context help for sound file fade options.
+
 === Version 1.4.5 (KDE 3.5.5) --- 29 September 2006 ===
 Improve edit dialogue layout (Reminder controls moved to below Time box).
 
Index: kalarm/daemon.h
===================================================================
--- kalarm/daemon.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/daemon.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -46,7 +46,7 @@
 		static bool      reregister()            { return registerWith(true); }
 		static bool      reset();
 		static bool      stop();
-		static bool      autoStart(bool defaultSetting);
+		static bool      autoStart();
 		static void      enableAutoStart(bool enable);
 		static void      setAlarmsEnabled()      { mInstance->setAlarmsEnabled(true); }
 		static void      checkStatus()           { checkIfRunning(); }
Index: kalarm/sounddlg.cpp
===================================================================
--- kalarm/sounddlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/sounddlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  sounddlg.cpp  -  sound file selection and configuration dialog
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -134,7 +134,7 @@
 	label->setBuddy(mFadeTime);
 	label = new QLabel(i18n("seconds"), mFadeBox);
 	label->setFixedSize(label->sizeHint());
-	QWhatsThis::add(box, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
+	QWhatsThis::add(mFadeBox, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
 
 	// Fade slider
 	mFadeVolumeBox = new QHBox(group);
@@ -147,7 +147,7 @@
 	mFadeSlider->setTickInterval(10);
 	mFadeSlider->setSizePolicy(QSizePolicy(QSizePolicy::Expanding, QSizePolicy::Fixed));
 	label->setBuddy(mFadeSlider);
-	QWhatsThis::add(box, i18n("Choose the initial volume for playing the sound file."));
+	QWhatsThis::add(mFadeVolumeBox, i18n("Choose the initial volume for playing the sound file."));
 
 	// Restore the dialogue size from last time
 	QSize s;
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -48,6 +48,7 @@
 
 #include "alarmcalendar.h"
 #include "alarmtimewidget.h"
+#include "daemon.h"
 #include "editdlg.h"
 #include "fontcolour.h"
 #include "functions.h"
@@ -91,7 +92,7 @@
 =============================================================================*/
 
 KAlarmPrefDlg::KAlarmPrefDlg()
-	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, 0, true, true)
+	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", true, true)
 {
 	setIconListAllVisible(true);
 
@@ -225,26 +226,25 @@
 	// Get alignment to use in QGridLayout (AlignAuto doesn't work correctly there)
 	int alignment = QApplication::reverseLayout() ? Qt::AlignRight : Qt::AlignLeft;
 
-	// Autostart alarm daemon
-	QHBox* itemBox = new QHBox(mPage);   // this is to allow left adjustment
-	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), itemBox, "startDaemon");
-	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
-	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
-	QWhatsThis::add(mAutostartDaemon,
-	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
-	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
-	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
-	itemBox->setStretchFactor(new QWidget(itemBox), 1);    // left adjust the controls
-
 	QGroupBox* group = new QButtonGroup(i18n("Run Mode"), mPage, "modeGroup");
-	QGridLayout* grid = new QGridLayout(group, 6, 3, KDialog::marginHint(), KDialog::spacingHint());
+	QGridLayout* grid = new QGridLayout(group, 6, 2, KDialog::marginHint(), KDialog::spacingHint());
 	grid->setColStretch(2, 1);
 	grid->addColSpacing(0, indentWidth());
 	grid->addColSpacing(1, indentWidth());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	int row = 1;
 
-	// Run-in-system-tray radio button has an ID of 0
+	// Run-on-demand radio button
+	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
+	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
+	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
+	QWhatsThis::add(mRunOnDemand,
+	      i18n("Check to run KAlarm only when required.\n\n"
+	           "Notes:\n"
+	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
+	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
+	grid->addMultiCellWidget(mRunOnDemand, 1, 1, 0, 2, alignment);
+
+	// Run-in-system-tray radio button
 	mRunInSystemTray = new QRadioButton(i18n("Run continuously in system &tray"), group, "runTray");
 	mRunInSystemTray->setFixedSize(mRunInSystemTray->sizeHint());
 	connect(mRunInSystemTray, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
@@ -254,58 +254,42 @@
 	           "1. With this option selected, closing the system tray icon will quit KAlarm.\n"
 	           "2. You do not need to select this option in order for alarms to be displayed, since alarm monitoring is done by the alarm daemon."
 	           " Running in the system tray simply provides easy access and a status indication."));
-	grid->addMultiCellWidget(mRunInSystemTray, row, row, 0, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mRunInSystemTray, 2, 2, 0, 2, alignment);
 
-	mAutostartTrayIcon1 = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
-	mAutostartTrayIcon1->setFixedSize(mAutostartTrayIcon1->sizeHint());
-#ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon1, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
-#endif
-	QWhatsThis::add(mAutostartTrayIcon1,
-	      i18n("Check to run KAlarm whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon1, row, row, 1, 2, alignment);
-	++row;
-
+	// Run continuously options
 	mDisableAlarmsIfStopped = new QCheckBox(i18n("Disa&ble alarms while not running"), group, "disableAl");
 	mDisableAlarmsIfStopped->setFixedSize(mDisableAlarmsIfStopped->sizeHint());
 	connect(mDisableAlarmsIfStopped, SIGNAL(toggled(bool)), SLOT(slotDisableIfStoppedToggled(bool)));
 	QWhatsThis::add(mDisableAlarmsIfStopped,
 	      i18n("Check to disable alarms whenever KAlarm is not running. Alarms will only appear while the system tray icon is visible."));
-	grid->addMultiCellWidget(mDisableAlarmsIfStopped, row, row, 1, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mDisableAlarmsIfStopped, 3, 3, 1, 2, alignment);
 
 	mQuitWarn = new QCheckBox(i18n("Warn before &quitting"), group, "disableAl");
 	mQuitWarn->setFixedSize(mQuitWarn->sizeHint());
 	QWhatsThis::add(mQuitWarn,
 	      i18n("Check to display a warning prompt before quitting KAlarm."));
-	grid->addWidget(mQuitWarn, row, 2, alignment);
-	++row;
+	grid->addWidget(mQuitWarn, 4, 2, alignment);
 
-	// Run-on-demand radio button has an ID of 3
-	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
-	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
-	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
-	QWhatsThis::add(mRunOnDemand,
-	      i18n("Check to run KAlarm only when required.\n\n"
-	           "Notes:\n"
-	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
-	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
-	grid->addMultiCellWidget(mRunOnDemand, row, row, 0, 2, alignment);
-	++row;
-
-	mAutostartTrayIcon2 = new QCheckBox(i18n("Autostart system tray &icon at login"), group, "autoRun");
-	mAutostartTrayIcon2->setFixedSize(mAutostartTrayIcon2->sizeHint());
+	mAutostartTrayIcon = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
 #ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon2, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
+	connect(mAutostartTrayIcon, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
 #endif
-	QWhatsThis::add(mAutostartTrayIcon2,
-	      i18n("Check to display the system tray icon whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon2, row, row, 1, 2, alignment);
+	grid->addMultiCellWidget(mAutostartTrayIcon, 5, 5, 0, 2, alignment);
+
+	// Autostart alarm daemon
+	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), group, "startDaemon");
+	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
+	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
+	QWhatsThis::add(mAutostartDaemon,
+	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
+	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
+	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
+	grid->addMultiCellWidget(mAutostartDaemon, 6, 6, 0, 2, alignment);
+
 	group->setFixedHeight(group->sizeHint().height());
 
 	// Start-of-day time
-	itemBox = new QHBox(mPage);
+	QHBox* itemBox = new QHBox(mPage);
 	QHBox* box = new QHBox(itemBox);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	QLabel* label = new QLabel(i18n("&Start of day for date-only alarms:"), box);
@@ -370,7 +354,7 @@
 	      i18n("Choose which application to use when a command alarm is executed in a terminal window"));
 	grid = new QGridLayout(group, 1, 3, KDialog::marginHint(), KDialog::spacingHint());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	row = 0;
+	int row = 0;
 
 	mXtermType = new QButtonGroup(group);
 	mXtermType->hide();
@@ -413,14 +397,13 @@
 
 void MiscPrefTab::restore()
 {
-	mAutostartDaemon->setChecked(Preferences::mAutostartDaemon);
+	mAutostartDaemon->setChecked(Daemon::autoStart());
 	bool systray = Preferences::mRunInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::mDisableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::quitWarn());
-	mAutostartTrayIcon1->setChecked(Preferences::mAutostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::mAutostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::mAutostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::confirmAlarmDeletion());
 	mStartOfDay->setValue(Preferences::mStartOfDay);
 	setExpiredControls(Preferences::mExpiredKeepDays);
@@ -468,12 +451,14 @@
 	Preferences::mDisableAlarmsIfStopped = mDisableAlarmsIfStopped->isChecked();
 	if (mQuitWarn->isEnabled())
 		Preferences::setQuitWarn(mQuitWarn->isChecked());
-	Preferences::mAutostartTrayIcon = systray ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
+	Preferences::mAutostartTrayIcon = mAutostartTrayIcon->isChecked();
 #ifdef AUTOSTART_BY_KALARMD
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
+	bool newAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
 #else
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked();
+	bool newAutostartDaemon = mAutostartDaemon->isChecked();
 #endif
+	if (newAutostartDaemon != Daemon::autoStart())
+		Daemon::enableAutoStart(newAutostartDaemon);
 	Preferences::setConfirmAlarmDeletion(mConfirmAlarmDeletion->isChecked());
 	int sod = mStartOfDay->value();
 	Preferences::mStartOfDay.setHMS(sod/60, sod%60, 0);
@@ -485,14 +470,13 @@
 
 void MiscPrefTab::setDefaults()
 {
-	mAutostartDaemon->setChecked(Preferences::default_autostartDaemon);
+	mAutostartDaemon->setChecked(true);
 	bool systray = Preferences::default_runInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::default_disableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::default_quitWarn);
-	mAutostartTrayIcon1->setChecked(Preferences::default_autostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::default_autostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::default_autostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::default_confirmAlarmDeletion);
 	mStartOfDay->setValue(Preferences::default_startOfDay);
 	setExpiredControls(Preferences::default_expiredKeepDays);
@@ -513,9 +497,10 @@
 
 void MiscPrefTab::slotRunModeToggled(bool)
 {
-	bool systray = (mRunInSystemTray->isOn());
-	mAutostartTrayIcon2->setEnabled(!systray);
-	mAutostartTrayIcon1->setEnabled(systray);
+	bool systray = mRunInSystemTray->isOn();
+	mAutostartTrayIcon->setText(systray ? i18n("Autostart at &login") : i18n("Autostart system tray &icon at login"));
+	QWhatsThis::add(mAutostartTrayIcon, (systray ? i18n("Check to run KAlarm whenever you start KDE.")
+	                                             : i18n("Check to display the system tray icon whenever you start KDE.")));
 	mDisableAlarmsIfStopped->setEnabled(systray);
 	slotDisableIfStoppedToggled(true);
 }
@@ -527,8 +512,7 @@
 void MiscPrefTab::slotAutostartToggled(bool)
 {
 #ifdef AUTOSTART_BY_KALARMD
-	bool autostart = mRunInSystemTray->isChecked() ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
-	mAutostartDaemon->setEnabled(!autostart);
+	mAutostartDaemon->setEnabled(!mAutostartTrayIcon->isChecked());
 #endif
 }
 
@@ -926,37 +910,25 @@
 	layout = new QVBoxLayout(bgroup, KDialog::marginHint(), KDialog::spacingHint());
 	layout->addSpacing(groupTopMargin);
 
-	mSound = new QCheckBox(SoundPicker::i18n_s_Sound(), bgroup, "defSound");
+	QBoxLayout* hlayout = new QHBoxLayout(layout, KDialog::spacingHint());
+	mSound = new QComboBox(false, bgroup, "defSound");
+	mSound->insertItem(SoundPicker::i18n_None());         // index 0
+	mSound->insertItem(SoundPicker::i18n_Beep());         // index 1
+	mSound->insertItem(SoundPicker::i18n_File());         // index 2
+	if (theApp()->speechEnabled())
+		mSound->insertItem(SoundPicker::i18n_Speak());  // index 3
 	mSound->setMinimumSize(mSound->sizeHint());
 	QWhatsThis::add(mSound, defsetting.arg(SoundPicker::i18n_Sound()));
-	layout->addWidget(mSound, 0, Qt::AlignAuto);
+	hlayout->addWidget(mSound);
+	hlayout->addStretch(1);
 
-	box = new QHBox(bgroup);
-	box->setSpacing(KDialog::spacingHint());
-	layout->addWidget(box, 0, Qt::AlignAuto);
+#ifndef WITHOUT_ARTS
+	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
+	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
+	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
+	hlayout->addWidget(mSoundRepeat);
+#endif
 
-	mBeep = new QRadioButton(SoundPicker::i18n_b_Beep(), box, "defBeep");
-	bgroup->insert(mBeep);
-	mBeep->setMinimumSize(mBeep->sizeHint());
-	QWhatsThis::add(mBeep,
-	      soundSetting.arg(SoundPicker::i18n_Beep()).arg(SoundPicker::i18n_Sound()));
-	mFile = new QRadioButton(SoundPicker::i18n_File(), box, "defFile");
-	bgroup->insert(mFile);
-	mFile->setMinimumSize(mFile->sizeHint());
-	QWhatsThis::add(mFile,
-	      soundSetting.arg(SoundPicker::i18n_File()).arg(SoundPicker::i18n_Sound()));
-	if (theApp()->speechEnabled())
-	{
-		mSpeak = new QRadioButton(SoundPicker::i18n_Speak(), box, "defSpeak");
-		mSpeak->setMinimumSize(mSpeak->sizeHint());
-		QWhatsThis::add(mSpeak,
-		      soundSetting.arg(SoundPicker::i18n_Speak()).arg(SoundPicker::i18n_Sound()));
-		bgroup->insert(mSpeak);
-	}
-	else
-		mSpeak = 0;
-	box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
-
 	box = new QHBox(bgroup);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	mSoundFileLabel = new QLabel(i18n("Sound &file:"), box);
@@ -972,13 +944,6 @@
 	      i18n("Enter the default sound file to use in the alarm edit dialog."));
 	box->setFixedHeight(box->sizeHint().height());
 	layout->addWidget(box);
-
-#ifndef WITHOUT_ARTS
-	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
-	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
-	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
-	layout->addWidget(mSoundRepeat, 0, Qt::AlignAuto);
-#endif
 	bgroup->setFixedHeight(bgroup->sizeHint().height());
 
 	// COMMAND ALARMS
@@ -1076,8 +1041,7 @@
 	mConfirmAck->setChecked(Preferences::mDefaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::mDefaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::mDefaultPreAction, Preferences::mDefaultPostAction);
-	mSound->setChecked(Preferences::mDefaultSound);
-	setSoundType(Preferences::mDefaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::mDefaultSoundType));
 	mSoundFile->setText(Preferences::mDefaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::mDefaultSoundRepeat);
@@ -1098,11 +1062,15 @@
 	Preferences::mDefaultReminderUnits    = static_cast<TimePeriod::Units>(mReminderUnits->currentItem());
 	Preferences::mDefaultPreAction        = mSpecialActionsButton->preAction();
 	Preferences::mDefaultPostAction       = mSpecialActionsButton->postAction();
-	Preferences::mDefaultSound            = mSound->isChecked();
+	switch (mSound->currentItem())
+	{
+		case 3:  Preferences::mDefaultSoundType = SoundPicker::SPEAK;      break;
+		case 2:  Preferences::mDefaultSoundType = SoundPicker::PLAY_FILE;  break;
+		case 1:  Preferences::mDefaultSoundType = SoundPicker::BEEP;       break;
+		case 0:
+		default: Preferences::mDefaultSoundType = SoundPicker::NONE;       break;
+	}
 	Preferences::mDefaultSoundFile        = mSoundFile->text();
-	Preferences::mDefaultSoundType        = mSpeak && mSpeak->isOn() ? SoundPicker::SPEAK
-	                                      : mFile->isOn()            ? SoundPicker::PLAY_FILE
-	                                      :                            SoundPicker::BEEP;
 #ifndef WITHOUT_ARTS
 	Preferences::mDefaultSoundRepeat      = mSoundRepeat->isChecked();
 #endif
@@ -1133,8 +1101,7 @@
 	mConfirmAck->setChecked(Preferences::default_defaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::default_defaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::default_defaultPreAction, Preferences::default_defaultPostAction);
-	mSound->setChecked(Preferences::default_defaultSound);
-	setSoundType(Preferences::default_defaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::default_defaultSoundType));
 	mSoundFile->setText(Preferences::default_defaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::default_defaultSoundRepeat);
@@ -1156,6 +1123,18 @@
 		mSoundFile->setText(url);
 }
 
+int EditPrefTab::soundIndex(SoundPicker::Type type)
+{
+	switch (type)
+	{
+		case SoundPicker::SPEAK:      return 3;
+		case SoundPicker::PLAY_FILE:  return 2;
+		case SoundPicker::BEEP:       return 1;
+		case SoundPicker::NONE:
+		default:                      return 0;
+	}
+}
+
 int EditPrefTab::recurIndex(RecurrenceEdit::RepeatType type)
 {
 	switch (type)
@@ -1171,30 +1150,9 @@
 	}
 }
 
-void EditPrefTab::setSoundType(SoundPicker::Type type)
-{
-	switch (type)
-	{
-		case SoundPicker::PLAY_FILE:
-			mFile->setChecked(true);
-			break;
-		case SoundPicker::SPEAK:
-			if (mSpeak)
-			{
-				mSpeak->setChecked(true);
-				break;
-			}
-			// fall through to BEEP
-		case SoundPicker::BEEP:
-		default:
-			mBeep->setChecked(true);
-			break;
-	}
-}
-
 QString EditPrefTab::validate()
 {
-	if (mFile->isOn()  &&  mSoundFile->text().isEmpty())
+	if (mSound->currentItem() == SoundPicker::PLAY_FILE  &&  mSoundFile->text().isEmpty())
 	{
 		mSoundFile->setFocus();
 		return i18n("You must enter a sound file when %1 is selected as the default sound type").arg(SoundPicker::i18n_File());;
Index: kalarm/daemon.cpp
===================================================================
--- kalarm/daemon.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/daemon.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -374,24 +374,23 @@
 	// Tell the alarm daemon in case it is running.
 	AlarmDaemonIface_stub s(DAEMON_APP_NAME, DAEMON_DCOP_OBJECT);
 	s.enableAutoStart(enable);
-	if (!s.ok())
-	{
-		// Failure - the daemon probably isn't running, so rewrite its config file for it
-		KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
-		adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-		adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
-		adconfig.sync();
-	}
+
+	// The return status doesn't report failure even if the daemon isn't running,
+	// so in case of failure, rewrite the config file in any case.
+	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
+	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
+	adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
+	adconfig.sync();
 }
 
 /******************************************************************************
 * Read the alarm daemon's autostart-at-login setting.
 */
-bool Daemon::autoStart(bool defaultAutoStart)
+bool Daemon::autoStart()
 {
 	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
 	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), defaultAutoStart);
+	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), true);
 }
 
 /******************************************************************************
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/functions.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -127,27 +127,37 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, bool useEventID, bool allowKOrgUpdate)
+UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, bool useEventID, bool allowKOrgUpdate, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::addEvent(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 	if (!theApp()->checkCalendarDaemon())    // ensure calendar is open and daemon started
-		return UPDATE_ERROR;
-
-	// Save the event details in the calendar file, and get the new event ID
-	AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-	cal->addEvent(event, useEventID);
-	cal->save();
-
-	UpdateStatus ret = UPDATE_OK;
-	if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		return UPDATE_FAILED;
+	else
 	{
-		if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-			ret = UPDATE_KORG_ERR;
+		// Save the event details in the calendar file, and get the new event ID
+		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
+		if (!cal->addEvent(event, useEventID))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
 	}
+	if (status == UPDATE_OK)
+	{
+		if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		{
+			if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
+				status = UPDATE_KORG_ERR;
+		}
 
-	// Update the window lists
-	AlarmListView::addEvent(event, selectionView);
-	return ret;
+		// Update the window lists
+		AlarmListView::addEvent(event, selectionView);
+		return status;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -181,21 +191,29 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-bool addTemplate(KAEvent& event, TemplateListView* selectionView)
+UpdateStatus addTemplate(KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::addTemplate(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 
 	// Add the template to the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (!cal)
-		return false;
-	cal->addEvent(event);
-	cal->save();
-	cal->emitEmptyStatus();
+	if (!cal  ||  !cal->addEvent(event))
+		status = UPDATE_FAILED;
+	else if (!cal->save())
+		status = SAVE_FAILED;
+	else
+	{
+		cal->emitEmptyStatus();
 
-	// Update the window lists
-	TemplateListView::addEvent(event, selectionView);
-	return true;
+		// Update the window lists
+		TemplateListView::addEvent(event, selectionView);
+		return UPDATE_OK;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -205,15 +223,18 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * modified event in that listView instance.
 */
-UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView)
+UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::modifyEvent(): '" << oldEvent.id() << endl;
 
+	UpdateStatus status = UPDATE_OK;
 	if (!newEvent.valid())
-		return deleteEvent(oldEvent, true);
+	{
+		deleteEvent(oldEvent, true);
+		status = UPDATE_FAILED;
+	}
 	else
 	{
-		UpdateStatus ret = UPDATE_OK;
 		if (oldEvent.copyToKOrganizer())
 		{
 			// Tell KOrganizer to delete its old event.
@@ -224,20 +245,28 @@
 
 		// Update the event in the calendar file, and get the new event ID
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(oldEvent.id());
-		cal->addEvent(const_cast<KAEvent&>(newEvent), true);
-		cal->save();
+		if (!cal->deleteEvent(oldEvent.id())
+		||  !cal->addEvent(const_cast<KAEvent&>(newEvent), true))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
+		if (status == UPDATE_OK)
+		{
+			if (newEvent.copyToKOrganizer())
+			{
+				if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
+					status = UPDATE_KORG_ERR;
+			}
 
-		if (newEvent.copyToKOrganizer())
-		{
-			if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
-				ret = UPDATE_KORG_ERR;
+			// Update the window lists
+			AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
+			return status;
 		}
+	}
 
-		// Update the window lists
-		AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
-		return ret;
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -249,7 +278,7 @@
 * The event is not updated in KOrganizer, since this function is called when an
 * existing alarm is rescheduled (due to recurrence or deferral).
 */
-void updateEvent(KAEvent& event, AlarmListView* selectionView, bool archiveOnDelete, bool incRevision)
+UpdateStatus updateEvent(KAEvent& event, AlarmListView* selectionView, bool archiveOnDelete, bool incRevision, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::updateEvent(): " << event.id() << endl;
 
@@ -262,11 +291,17 @@
 			event.incrementRevision();    // ensure alarm daemon sees the event has changed
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+		{
+			if (errmsgParent)
+				displayUpdateError(errmsgParent, SAVE_FAILED, ERR_ADD, 1);
+			return SAVE_FAILED;
+		}
 
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -274,23 +309,34 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void updateTemplate(const KAEvent& event, TemplateListView* selectionView)
+UpdateStatus updateTemplate(const KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
+	UpdateStatus status = UPDATE_OK;
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
+	if (!cal)
+		status = UPDATE_FAILED;
+	else
 	{
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			status = SAVE_FAILED;
+		else
+		{
+			TemplateListView::modifyEvent(event.id(), event, selectionView);
+			return UPDATE_OK;
+		}
+	}
 
-		TemplateListView::modifyEvent(event.id(), event, selectionView);
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete an alarm from the calendar file and from every main window instance.
 * If the event is archived, the event's ID is changed to an expired ID if necessary.
 */
-UpdateStatus deleteEvent(KAEvent& event, bool archive)
+UpdateStatus deleteEvent(KAEvent& event, bool archive, QWidget* errmsgParent)
 {
 	QString id = event.id();
 	kdDebug(5950) << "KAlarm::deleteEvent(): " << id << endl;
@@ -298,14 +344,15 @@
 	// Update the window lists
 	AlarmListView::deleteEvent(id);
 
-	UpdateStatus ret = UPDATE_OK;
+	UpdateStatus status = UPDATE_OK;
+	AlarmCalendar* cal;
 
 	// Delete the event from the calendar file
 	if (KAEvent::uidStatus(id) == KAEvent::EXPIRED)
 	{
-		AlarmCalendar* cal = AlarmCalendar::expiredCalendarOpen();
-		if (cal)
-			cal->deleteEvent(id, true);   // save calendar after deleting
+		cal = AlarmCalendar::expiredCalendarOpen();
+		if (!cal)
+			status = UPDATE_FAILED;
 	}
 	else
 	{
@@ -315,33 +362,40 @@
 			// delete it. Note that an error could occur if the user
 			// manually deleted it from KOrganizer since it was set up.
 			if (!deleteFromKOrganizer(event.id()))
-				ret = UPDATE_KORG_ERR;
+				status = UPDATE_KORG_ERR;
 		}
 		if (archive  &&  event.toBeArchived())
 			addExpiredEvent(event);     // this changes the event ID to an expired ID
-		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(id, true);    // save calendar after deleting
+		cal = AlarmCalendar::activeCalendar();
 	}
-	return ret;
+	if (status != UPDATE_FAILED)
+	{
+		if (!cal->deleteEvent(id, true))   // save calendar after deleting
+			status = SAVE_FAILED;
+	}
+	if (status > UPDATE_KORG_ERR  &&  errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete a template from the calendar file and from every template list view.
 */
-void deleteTemplate(const KAEvent& event)
+UpdateStatus deleteTemplate(const KAEvent& event)
 {
 	QString id = event.id();
 
 	// Delete the template from the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
-	{
-		cal->deleteEvent(id, true);    // save calendar after deleting
-		cal->emitEmptyStatus();
-	}
+	if (!cal)
+		return UPDATE_FAILED;
+	if (!cal->deleteEvent(id, true))    // save calendar after deleting
+		return SAVE_FAILED;
+	cal->emitEmptyStatus();
 
 	// Update the window lists
 	TemplateListView::deleteEvent(id);
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -382,14 +436,16 @@
 
 			// Save the event details in the calendar file, and get the new event ID
 			AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-			cal->addEvent(event, useEventID);
-			cal->save();
+			if (!cal->addEvent(event, useEventID))
+				return UPDATE_FAILED;
+			if (!cal->save())
+				return SAVE_FAILED;
 
-			UpdateStatus ret = UPDATE_OK;
+			UpdateStatus status = UPDATE_OK;
 			if (event.copyToKOrganizer())
 			{
 				if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-					ret = UPDATE_KORG_ERR;
+					status = UPDATE_KORG_ERR;
 			}
 
 			// Update the window lists
@@ -398,10 +454,10 @@
 			cal = AlarmCalendar::expiredCalendarOpen();
 			if (cal)
 				cal->deleteEvent(id, true);   // save calendar after deleting
-			return ret;
+			return status;
 		}
 	}
-	return UPDATE_ERROR;
+	return UPDATE_FAILED;
 }
 
 /******************************************************************************
@@ -410,7 +466,7 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
+UpdateStatus enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
 {
 	kdDebug(5950) << "KAlarm::enableEvent(" << enable << "): " << event.id() << endl;
 
@@ -421,7 +477,8 @@
 		// Update the event in the calendar file
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			return SAVE_FAILED;
 
 		// If we're disabling a display alarm, close any message window
 		if (!enable  &&  event.displayAction())
@@ -433,12 +490,36 @@
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
+* Display an error message about an error saving an event.
+*/
+void displayUpdateError(QWidget* parent, UpdateStatus, UpdateError code, int nAlarms)
+{
+	QString errmsg;
+	switch (code)
+	{
+		case ERR_ADD:
+			errmsg = (nAlarms > 1) ? i18n("Error saving alarms")
+			                       : i18n("Error saving alarm");
+			break;
+		case ERR_REACTIVATE:
+			errmsg = (nAlarms > 1) ? i18n("Error saving reactivated alarms")
+			                       : i18n("Error saving reactivated alarm");
+			break;
+		case ERR_TEMPLATE:
+			errmsg = i18n("Error saving alarm template");
+			break;
+	}
+	KMessageBox::error(parent, errmsg);
+}
+
+/******************************************************************************
 * Display an error message corresponding to a specified alarm update error code.
 */
-void displayKOrgUpdateError(QWidget* parent, UpdateError code, int nAlarms)
+void displayKOrgUpdateError(QWidget* parent, KOrgUpdateError code, int nAlarms)
 {
 	QString errmsg;
 	switch (code)
Index: kalarm/alarmcalendar.cpp
===================================================================
--- kalarm/alarmcalendar.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/alarmcalendar.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -578,26 +578,30 @@
 * Flag the end of a group of calendar update calls.
 * The calendar is saved if appropriate.
 */
-void AlarmCalendar::endUpdate()
+bool AlarmCalendar::endUpdate()
 {
 	if (mUpdateCount > 0)
 		--mUpdateCount;
 	if (!mUpdateCount)
 	{
 		if (mUpdateSave)
-			saveCal();
+			return saveCal();
 	}
+	return true;
 }
 
 /******************************************************************************
 * Save the calendar, or flag it for saving if in a group of calendar update calls.
 */
-void AlarmCalendar::save()
+bool AlarmCalendar::save()
 {
 	if (mUpdateCount)
+	{
 		mUpdateSave = true;
+		return true;
+	}
 	else
-		saveCal();
+		return saveCal();
 }
 
 #if 0
@@ -780,7 +784,7 @@
 * Delete the specified event from the calendar, if it exists.
 * The calendar is then optionally saved.
 */
-void AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
+bool AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
 {
 	if (mOpen)
 	{
@@ -791,12 +795,13 @@
 			if (mType == KAEvent::ACTIVE)
 				Daemon::savingEvent(eventID);
 			if (saveit)
-				save();
-			return;
+				return save();
+			return true;
 		}
 	}
 	if (mType == KAEvent::ACTIVE)
 		Daemon::eventHandled(eventID, false);
+	return false;
 }
 
 /******************************************************************************
Index: kalarm/soundpicker.cpp
===================================================================
--- kalarm/soundpicker.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/soundpicker.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.cpp  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -18,13 +18,13 @@
  *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-#include <config.h>
 #include "kalarm.h"
 
 #include <qlayout.h>
 #include <qregexp.h>
 #include <qtooltip.h>
 #include <qtimer.h>
+#include <qlabel.h>
 #include <qhbox.h>
 #include <qwhatsthis.h>
 
@@ -38,12 +38,10 @@
 #endif
 #include <kdebug.h>
 
-#include "buttongroup.h"
-#include "checkbox.h"
+#include "combobox.h"
 #include "functions.h"
 #include "kalarmapp.h"
 #include "pushbutton.h"
-#include "radiobutton.h"
 #include "sounddlg.h"
 #include "soundpicker.moc"
 
@@ -51,75 +49,46 @@
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
 QString SoundPicker::i18n_Sound()       { return i18n("An audio sound", "Sound"); }
-QString SoundPicker::i18n_s_Sound()     { return i18n("An audio sound", "&Sound"); }
+QString SoundPicker::i18n_None()        { return i18n("None"); }
 QString SoundPicker::i18n_Beep()        { return i18n("Beep"); }
-QString SoundPicker::i18n_b_Beep()      { return i18n("&Beep"); }
 QString SoundPicker::i18n_Speak()       { return i18n("Speak"); }
-QString SoundPicker::i18n_p_Speak()     { return i18n("S&peak"); }
-QString SoundPicker::i18n_File()        { return i18n("File"); }
+QString SoundPicker::i18n_File()        { return i18n("Sound file"); }
 
 
 SoundPicker::SoundPicker(QWidget* parent, const char* name)
-	: QFrame(parent, name),
-	  mRevertType(false)
+	: QFrame(parent, name)
 {
-	// Sound checkbox
 	setFrameStyle(QFrame::NoFrame);
-	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, 2*KDialog::spacingHint());
-	soundLayout->setAlignment(Qt::AlignVCenter);
-	mCheckbox = new CheckBox(i18n_s_Sound(), this);
-	mCheckbox->setFixedSize(mCheckbox->sizeHint());
-	connect(mCheckbox, SIGNAL(toggled(bool)), SLOT(slotSoundToggled(bool)));
-	QWhatsThis::add(mCheckbox,
-	      i18n("Check to enable sound when the message is displayed. Select the type of sound from the displayed options."));
-	soundLayout->addWidget(mCheckbox);
+	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, KDialog::spacingHint());
+	mTypeBox = new QHBox(this);    // this is to control the QWhatsThis text display area
+	mTypeBox->setSpacing(KDialog::spacingHint());
 
-	// Sound type
-	mTypeGroup = new ButtonGroup(this);
-	mTypeGroup->hide();
-	connect(mTypeGroup, SIGNAL(buttonSet(int)), SLOT(slotTypeChanged(int)));
+	QLabel* label = new QLabel(i18n("An audio sound", "&Sound:"), mTypeBox);
+	label->setFixedSize(label->sizeHint());
 
-	// Beep radio button
-	mBeepRadio = new RadioButton(i18n_Beep(), this, "beepButton");
-	mBeepRadio->setFixedSize(mBeepRadio->sizeHint());
-	QWhatsThis::add(mBeepRadio, i18n("If checked, a beep will sound when the alarm is displayed."));
-	mTypeGroup->insert(mBeepRadio, BEEP);
-	soundLayout->addWidget(mBeepRadio);
+	// Sound type combo box
+	// The order of combo box entries must correspond with the 'Type' enum.
+	mTypeCombo = new ComboBox(false, mTypeBox);
+	mTypeCombo->insertItem(i18n_None());     // index NONE
+	mTypeCombo->insertItem(i18n_Beep());     // index BEEP
+	mTypeCombo->insertItem(i18n_File());     // index PLAY_FILE
+	mSpeakShowing = !theApp()->speechEnabled();
+	showSpeak(!mSpeakShowing);              // index SPEAK (only displayed if appropriate)
+	connect(mTypeCombo, SIGNAL(activated(int)), SLOT(slotTypeSelected(int)));
+	label->setBuddy(mTypeCombo);
+	soundLayout->addWidget(mTypeBox);
 
-	// File radio button
-	QHBox* box = new QHBox(this);
-	mFileRadio = new RadioButton(i18n_File(), box, "audioFileButton");
-	mFileRadio->setFixedSize(mFileRadio->sizeHint());
-	QWhatsThis::add(mFileRadio, i18n("If checked, a sound file will be played when the alarm is displayed."));
-	mTypeGroup->insert(mFileRadio, PLAY_FILE);
-
 	// Sound file picker button
-	mFilePicker = new PushButton(box);
+	mFilePicker = new PushButton(this);
 	mFilePicker->setPixmap(SmallIcon("playsound"));
 	mFilePicker->setFixedSize(mFilePicker->sizeHint());
 	connect(mFilePicker, SIGNAL(clicked()), SLOT(slotPickFile()));
 	QWhatsThis::add(mFilePicker, i18n("Configure a sound file to play when the alarm is displayed."));
-	box->setFixedSize(box->sizeHint());
-	soundLayout->addWidget(box);
-	box->setFocusProxy(mFileRadio);
+	soundLayout->addWidget(mFilePicker);
 
-	// Speak radio button
-	mSpeakRadio = new RadioButton(i18n_p_Speak(), this, "speakButton");
-	mSpeakRadio->setFixedSize(mSpeakRadio->sizeHint());
-	QWhatsThis::add(mSpeakRadio, i18n("If checked, the message will be spoken when the alarm is displayed."));
-	mTypeGroup->insert(mSpeakRadio, SPEAK);
-	soundLayout->addWidget(mSpeakRadio);
-
-	if (!theApp()->speechEnabled())
-		mSpeakRadio->hide();     // speech capability is not installed
-
-	setTabOrder(mCheckbox, mBeepRadio);
-	setTabOrder(mBeepRadio, mFileRadio);
-	setTabOrder(mFileRadio, mFilePicker);
-	setTabOrder(mFilePicker, mSpeakRadio);
-
 	// Initialise the file picker button state and tooltip
-	slotSoundToggled(false);
+	mTypeCombo->setCurrentItem(NONE);
+	mFilePicker->setEnabled(false);
 }
 
 /******************************************************************************
@@ -127,13 +96,10 @@
 */
 void SoundPicker::setReadOnly(bool readOnly)
 {
-	mCheckbox->setReadOnly(readOnly);
-	mBeepRadio->setReadOnly(readOnly);
-	mFileRadio->setReadOnly(readOnly);
+	mTypeCombo->setReadOnly(readOnly);
 #ifdef WITHOUT_ARTS
 	mFilePicker->setReadOnly(readOnly);
 #endif
-	mSpeakRadio->setReadOnly(readOnly);
 	mReadOnly = readOnly;
 }
 
@@ -143,58 +109,40 @@
 void SoundPicker::showSpeak(bool show)
 {
 	if (!theApp()->speechEnabled())
-		return;     // speech capability is not installed
-
-	bool shown = !mSpeakRadio->isHidden();
-	if (show  &&  !shown)
-		mSpeakRadio->show();
-	else if (!show  &&  shown)
+		show = false;    // speech capability is not installed
+	if (show == mSpeakShowing)
+		return;    // no change
+	QString whatsThis = "<p>" + i18n("Choose a sound to play when the message is displayed.")
+	                  + "<br>" + i18n("%1: the message is displayed silently.").arg("<b>" + i18n_None() + "</b>")
+	                  + "<br>" + i18n("%1: a simple beep is sounded.").arg("<b>" + i18n_Beep() + "</b>")
+	                  + "<br>" + i18n("%1: an audio file is played. You will be prompted to choose the file and set play options.").arg("<b>" + i18n_File() + "</b>");
+	if (!show  &&  mTypeCombo->currentItem() == SPEAK)
+		mTypeCombo->setCurrentItem(NONE);
+	mTypeCombo->removeItem(SPEAK);    // precaution in case of mix-ups
+	if (show)
 	{
-		if (mSpeakRadio->isOn())
-			mCheckbox->setChecked(false);
-		mSpeakRadio->hide();
+		mTypeCombo->insertItem(i18n_Speak());
+		whatsThis += "<br>" + i18n("%1: the message text is spoken.").arg("<b>" + i18n_Speak() + "</b>") + "</p>";
 	}
+	QWhatsThis::add(mTypeBox, whatsThis + "</p>");
+	mSpeakShowing = show;
 }
 
 /******************************************************************************
-* Return whether sound is selected.
-*/
-bool SoundPicker::sound() const
-{
-	return mCheckbox->isChecked();
-}
-
-/******************************************************************************
 * Return the currently selected option.
 */
-SoundPicker::Type SoundPicker::type() const
+SoundPicker::Type SoundPicker::sound() const
 {
-	return static_cast<SoundPicker::Type>(mTypeGroup->selectedId());
+	return static_cast<SoundPicker::Type>(mTypeCombo->currentItem());
 }
 
 /******************************************************************************
-* Return whether beep is selected.
+* Return the selected sound file, if the File option is selected.
+* Returns null string if File is not currently selected.
 */
-bool SoundPicker::beep() const
-{
-	return mCheckbox->isChecked()  &&  mBeepRadio->isOn();
-}
-
-/******************************************************************************
-* Return whether speech is selected.
-*/
-bool SoundPicker::speak() const
-{
-	return mCheckbox->isChecked()  &&  !mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn();
-}
-
-/******************************************************************************
-* Return the selected sound file, if the main checkbox is checked.
-* Returns null string if beep is currently selected.
-*/
 QString SoundPicker::file() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() ? mFile : QString::null;
+	return (mTypeCombo->currentItem() == PLAY_FILE) ? mFile : QString::null;
 }
 
 /******************************************************************************
@@ -203,7 +151,7 @@
 */
 float SoundPicker::volume(float& fadeVolume, int& fadeSeconds) const
 {
-	if (mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty())
+	if (mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty())
 	{
 		fadeVolume  = mFadeVolume;
 		fadeSeconds = mFadeSeconds;
@@ -223,49 +171,34 @@
 */
 bool SoundPicker::repeat() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty() && mRepeat;
+	return mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty()  &&  mRepeat;
 }
 
 /******************************************************************************
 * Initialise the widget's state.
 */
-void SoundPicker::set(bool sound, SoundPicker::Type defaultType, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
+void SoundPicker::set(SoundPicker::Type type, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
 {
-	if (defaultType == PLAY_FILE  &&  f.isEmpty())
-		defaultType = BEEP;
-	mLastType    = static_cast<Type>(0);
+	if (type == PLAY_FILE  &&  f.isEmpty())
+		type = BEEP;
 	mFile        = f;
 	mVolume      = volume;
 	mFadeVolume  = fadeVolume;
 	mFadeSeconds = fadeSeconds;
 	mRepeat      = repeat;
 	QToolTip::add(mFilePicker, mFile);
-	mCheckbox->setChecked(sound);
-	mTypeGroup->setButton(defaultType);
+	mTypeCombo->setCurrentItem(type);  // this doesn't trigger slotTypeSelected()
+	mFilePicker->setEnabled(type == PLAY_FILE);
+	mLastType = type;
 }
 
 /******************************************************************************
-* Called when the sound checkbox is toggled.
-*/
-void SoundPicker::slotSoundToggled(bool on)
-{
-	mBeepRadio->setEnabled(on);
-	mSpeakRadio->setEnabled(on);
-	mFileRadio->setEnabled(on);
-	mFilePicker->setEnabled(on && mFileRadio->isOn());
-	if (on  &&  mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn())
-		mBeepRadio->setChecked(true);
-	if (on)
-		mBeepRadio->setFocus();
-}
-
-/******************************************************************************
 * Called when the sound option is changed.
 */
-void SoundPicker::slotTypeChanged(int id)
+void SoundPicker::slotTypeSelected(int id)
 {
 	Type newType = static_cast<Type>(id);
-	if (newType == mLastType  ||  mRevertType)
+	if (newType == mLastType)
 		return;
 	if (mLastType == PLAY_FILE)
 		mFilePicker->setEnabled(false);
@@ -277,7 +210,7 @@
 			if (mFile.isEmpty())
 				return;    // revert to previously selected type
 		}
-		mFilePicker->setEnabled(mCheckbox->isChecked());
+		mFilePicker->setEnabled(true);
 	}
 	mLastType = newType;
 }
@@ -317,23 +250,12 @@
 	QToolTip::add(mFilePicker, mFile);
 	if (mFile.isEmpty())
 	{
-		// No audio file is selected, so revert to 'beep'.
-		// But wait a moment until setting the radio button, or it won't work.
-		mRevertType = true;   // prevent sound dialogue popping up twice
-		QTimer::singleShot(0, this, SLOT(setLastType()));
+		// No audio file is selected, so revert to previously selected option
+		mTypeCombo->setCurrentItem(mLastType);
 	}
 }
 
 /******************************************************************************
-* Select the previously selected sound type.
-*/
-void SoundPicker::setLastType()
-{
-	mTypeGroup->setButton(mLastType);
-	mRevertType = false;
-}
-
-/******************************************************************************
 * Display a dialogue to choose a sound file, initially highlighting any
 * specified file. 'initialFile' must be a full path name or URL.
 * 'defaultDir' is updated to the directory containing the chosen file.
@@ -351,7 +273,8 @@
 #ifdef WITHOUT_ARTS
 	QString filter = QString::fromLatin1("*.wav *.mp3 *.ogg|%1\n*|%2").arg(i18n("Sound Files")).arg(i18n("All Files"));
 #else
-	QString filter = KDE::PlayObjectFactory::mimeTypes().join(" ");
+	QStringList filters = KDE::PlayObjectFactory::mimeTypes();
+	QString filter = filters.join(" ");
 #endif
 	return KAlarm::browseFile(i18n("Choose Sound File"), defaultDir, initialFile, filter, KFile::ExistingOnly, 0, "pickSoundFile");
 }
Index: kalarm/birthdaydlg.cpp
===================================================================
--- kalarm/birthdaydlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kalarm/birthdaydlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,7 +1,7 @@
 /*
  *  birthdaydlg.cpp  -  dialog to pick birthdays from address book
  *  Program:  kalarm
- *  Copyright (c) 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -71,7 +71,7 @@
 
 
 BirthdayDlg::BirthdayDlg(QWidget* parent)
-	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent),
+	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent, "BirthdayDlg"),
 	  mSpecialActionsButton(0)
 {
 	QWidget* topWidget = plainPage();
@@ -194,7 +194,7 @@
 	mBgColourChoose->setColour(Preferences::defaultBgColour());     // set colour before setting alarm type buttons
 	mLateCancel->setMinutes(Preferences::defaultLateCancel(), true, TimePeriod::DAYS);
 	mConfirmAck->setChecked(Preferences::defaultConfirmAck());
-	mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+	mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 	                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 	if (mSpecialActionsButton)
 		mSpecialActionsButton->setActions(Preferences::defaultPreAction(), Preferences::defaultPostAction());
@@ -352,11 +352,11 @@
 	config->writeEntry(QString::fromLatin1("BirthdaySuffix"), mSuffix->text());
 	config->sync();
 
-	mFlags = (mSoundPicker->beep()             ? KAEvent::BEEP : 0)
-	       | (mSoundPicker->repeat()           ? KAEvent::REPEAT_SOUND : 0)
-	       | (mConfirmAck->isChecked()         ? KAEvent::CONFIRM_ACK : 0)
-	       | (mFontColourButton->defaultFont() ? KAEvent::DEFAULT_FONT : 0)
-	       |                                     KAEvent::ANY_TIME;
+	mFlags = (mSoundPicker->sound() == SoundPicker::BEEP ? KAEvent::BEEP : 0)
+	       | (mSoundPicker->repeat()                     ? KAEvent::REPEAT_SOUND : 0)
+	       | (mConfirmAck->isChecked()                   ? KAEvent::CONFIRM_ACK : 0)
+	       | (mFontColourButton->defaultFont()           ? KAEvent::DEFAULT_FONT : 0)
+	       |                                               KAEvent::ANY_TIME;
 	KDialogBase::slotOk();
 }
 
Index: kaddressbook/features/distributionlistwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kaddressbook/features/distributionlistwidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -327,6 +327,7 @@
 #else
   KABC::DistributionList *list = mManager->list( oldName );
   list->setName( newName );
+  mManager->save();
   updateNameCombo();
 #endif
 
Index: libkholidays/holidays/holiday_gr
===================================================================
--- libkholidays/holidays/holiday_gr	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ libkholidays/holidays/holiday_gr	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -0,0 +1,309 @@
+:
+: Greek holiday file.
+:
+: Author: capthookb (praktoreio2002@yahoo.gr)
+:
+: "weekend" or "red" indicate a "proper" holiday (i.e. you do not work)
+:  Other colours (black, green, yellow, blue, magenta, cyan, white)
+: can be used to distinguish between minor anniversaries or not-so-real
+: holidays, when you go working anyway.
+: "small" holidays are not as "invasive" in the month view in KOrganizer,
+: and do not take as much space.
+
+: Ονομαστικές εορτές
+
+small black "Βασίλης, Βασιλική, Βασιλεία, Βίβιαν" on 1.1
+small black "Συλβέστρος" on 2.1
+small black "Θεώνη" on 5.1
+small black "Άγια Θεοφάνεια (Αργία)" on 6.1
+small black "Φώτης, Φωτεινή, Θεοφάνης, Θεοφανία, Φανή, Ιορδάνης, Θεανώ, Ουρανία, Θεοπούλα" on 6.1
+small black "Ιωάννης, Ιωάννα, Πρόδρομος" on 7.1
+small black "Αγάθων, Δομινίκη, Παρθένα, Κύρος" on 8.1
+small black "Θεοδόσης, Θεοδοσία" on 11.1
+small black "Τατιάνα, Τατιανή" on 12.1
+small black "Αντώνης, Αντωνία" on 17.1
+small black "Αθανάσιος, Αθανασία, Κύριλλος" on 18.1
+small black "Μακάριος" on 19.1
+small black "Ευθύμης, Ευθυμία, Φαβιανός" on 20.1
+small black "Αγνή, Μάξιμος, Νεόφυτος, Πάτροκλος" on 21.1
+small black "Τιμόθεος, Αναστάσιος, Αναστασία" on 22.1
+small black "Αγαθάγγελος" on 23.1
+small black "Ξένη, Φίλωνας, Ζωσιμάς" on 24.1
+small black "Γρηγόρης, Γρηγορία, Μαργαρίτα" on 25.1
+small black "Ξενοφών" on 26.1
+small black "Χάρις, Παλλάδιος" on 28.1
+small black "Μαύρος, Χρυσή, Τριών Ιεραρχών (Σχολική Αργία)" on 30.1
+small black "Ευδοξία, Κύρος" on 31.1
+small black "Τρύφωνας" on 1.2
+small black "Υπαπαντή" on 2.2
+small black "Σταμάτ-ης/ία, Συμεώ-ν/νή, Σιμώνη, Ασημάκης, Ασημίνα, Μαλαματή" on 3.2
+small black "Ισίδωρος, Ιάσιμος, Ιασίμη" on 4.2
+small black "Αγαθή" on 5.2
+small black "Φώτης" on 6.2
+small black "Παρθένιος, Παρθενία" on 7.2
+small black "Ζαχαρίας, Ζαχαρούλα" on 8.2
+small black "Μάρκελος, Νικηφόρος, Νίκη" on 9.2
+small black "Χαράλαμπος, Χαραλαμπία, Χαρίκλεια, Χαρίλαος, Χαρούλα" on 10.2
+small black "Βλάσης, Βλασία, Θοδωρής, Θοδώρα, Αυγή " on 11.2
+small black "Μελέτης, Πλωτίνος" on 12.2
+small black "Πρίσκιλλα" on 13.2
+small black "Βαλεντίνος, Βαλεντίνη, Παγκόσμια Ημέρα Ερωτευμένων" on 14.2
+small black "Ευσέβιος, Ευσεβία" on 15.2
+small black "Πάμφιλος, Παμφίλη, Σέλευκος, Σελεύκη" on 16.2
+small black "Λέων, Αγαπητός" on 18.2
+small black "Φιλοθέη, Χλόη" on 19.2
+small black "Ανθούσα" on 22.2
+small black "Πολύκαρπος" on 23.2
+small black "Πορφύρης, Φωτεινή" on 26.2
+small black "Μαριάννα, Ασκληπιός" on 28.2
+small black "Ευδοκία, Χαρίσιος" on 1.3
+small black "Ευθαλία" on 2.3
+small black "Κλεόνικος, Κλεονίκη" on 3.3
+small black "Αρχέλαος, Eυλόγιος" on 5.3
+small black "Ησύχιος" on 6.3
+small black "Ευγένιος, Ευγενία" on 7.3
+small black "Ερμής, Θεοφύλακτος, Παγκόσμια Ημέρα της Γυναίκας" on 8.3
+small black "Σμάραγδος, Σμαράγδα, Ηλιάνα, Λεόντιος, Λεοντία, Λυσίμαχος Λυσιμαχη" on 9.3
+small black "Ξάνθος, Ξανθούλα, Σαράντης Σαραντούλα, Φιλοκτήμων" on 9.3
+small black "Θεόδωρος Θεοδώρα, Θώδος, Θώδη, Θαλλής, Θάλεια, Σωφρόνιος, Σωφρονία" on 11.3
+small black "Λωξάντρα, Ρωξάνη, Oρθοδόξης," on 12.3
+small black "Λέανδρος" on 13.3
+small black "Βενέδικτος, Βενεδίκτη" on 14.3
+small black "Αγάπιος" on 15.3
+small black "Χριστόδουλος, Ιουλιανός" on 16.3
+small black "Αλέξιος, Αλεξία" on 17.3
+small black "Χρύσανθος, Χρυσάνθη" on 19.3
+small black "Δρόσος, Δροσούλα" on 22.3
+small black "Ευαγγελισμός της Θεοτόκου " on 25.3
+small black "Ευάγγελος, Ευαγγελία" on 25.3
+small black "Πούλιος, Σύλας, Σύλια" on 26.3
+small black "Λυδία, Μακεδόνιος, Μακεδονούλα" on 27.3
+small black "Ευτύχιος, Ευτυχία" on 6.4
+small black "Ιωσήφ, Ιωσηφίνα" on 9.4
+small black "Δημοσθένης, Ηρακλής, Μιλτιάδης, Περικλής, Σοφοκλής, Επαμεινώνδας" on 10.4
+small black "Όμηρος, Πελοπίδας, Παρμενίων, Πολύβιος, Αναξιμένης, Φοιλοποίμην, Φίλης" on 10.4
+small black "Αρίσταρχος, Θωμαΐς" on 14.4
+small black "Λεωνίδας, Λάζαρος" on 15.4
+small black "Βάϊος, Βάϊα, Δάφνη, Γαλήνη, Χιονία" on 16.4
+small black "Ναθαναήλ, Νέαρχος, Νιάρχος" on 22.4
+small black "Αναστάσιος, Αναστασία, Λάμπρος, Λαμπρινή, Πασχάλης " on 23.4
+small black "Γεώργιος, Γεωργία, Ελισάβετ, Αχιλλέας" on 24.4
+small black "Μάρκος, Νίκη, Ραφαήλ" on 25.4
+small black "Ζωή, Πηγή" on 28.4
+small black "Ιάσωνας" on 29.4
+small black "Ιάκωβος, Θωμάς, Θωμαή, Ασημίνα" on 30.4
+weekend "Ιερεμίας" on 1.5
+small black "Έσπερος, Εσπέρια" on 2.5
+small black "Ροδόπη" on 3.5
+small black "Ειρήνη, Eιρηναίος, Ευφραίμ" on 5.5
+small black "Μυροφόρα" on 7.5
+small black "Θεολόγος" on 8.5
+small black "Χριστόφορος, Ησαΐας" on 9.5
+small black "Σίμων" on 10.5
+small black "Aρμόδιος,Μεθόδιος, Ολυμπία" on 11.5
+small black "Επιφάνειος" on 12.5
+small black "Γλυκερία" on 13.5
+small black "Γιορτή της Μητέρας, Αριστοτέλης" on 14.5
+small black "Καλή" on 15.5
+small black "Ανδρόνικος, Ανδρονίκη, Ιουνία" on 17.5
+small black "Ιουλία, Γαλάτεια" on 18.5
+small black "Θεόκτιστος, Μαγδαληνή, Πατρίκιος" on 19.5
+small black "Λυδία" on 20.5
+small black "Κωνσταντίνος, Κωνσταντίνα, Ελένη" on 21.5
+small black "Αιμίλιος, Αιμιλία, Έμυ" on 22.5
+small black "Μαρκιανή" on 24.5
+small black "Θεοδοσία" on 29.5
+small black "Πύρρος, Νεφέλη, Ιουστίνος, Ανάληψη" on 1.6
+small black "Νικηφόρος, Μαρίνος" on 2.6
+small black "Υπάτιος, Υπατία" on 3.6
+small black "Μάρθα" on 4.6
+small black "Aπόλλων, Δωρόθεος, Δωροθέα, Σελήνη, Νίκανδρος" on 5.6
+small black "Καλλιόπη" on 8.6
+small black "Ροδάνθη" on 9.6
+small black "Βαρθολομαίος, Βαρνάβας" on 11.6
+small black "Ονούφριος, Ζήνων,Κορίνα, Αγίου Πνεύματος" on 12.6
+small black "Ελισαίος" on 14.6
+small black "Αυγουστίνος, Αυγούστα, Ιερώνυμος, Μόνικα, Ορτανσία" on 15.6
+small black "Γιορτή του πατέρα" on 16.6
+small black "Έρασμος, Ερασμία, Aγίων Πάντων" on 18.6
+small black "Παΐσιος, Ζωσιμάς, Ζήσης" on 19.6
+small black "Ευσέβιος, Ευσεβία" on 22.6
+small black "Αριστοκλής" on 23.6
+small black "Φεβρωνία, Έρωτας" on 25.6
+small black "Γερμανός" on 28.6
+small black "Πέτρος, Πέτρα, Παύλος, Παυλίνα" on 29.6
+small black "Απόστολος, Αποστολία, Μελίτων" on 30.6
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.7
+small black "Υάκινθος, Ζουμπουλία" on 3.7
+small black "Λουκία" on 4.7
+small black "Λυκίας, Λύκιος, Λυκία, " on 6.7
+small black "Κυριακή" on 7.7
+small black "Θεόφιλος, Προκόπιος" on 8.7
+small black "Ευφημία, Όλγα" on 11.7
+small black "Βερονίκη, Βερενίκη " on 12.7
+small black "Σάρα" on 13.7
+small black "Ακύλας, Νικόδημος" on 14.7
+small black "Βλαδίμηρος, Ιουλίττα, Κήρυκος" on 15.7
+small black "Μαρίνα" on 17.7
+small black "Αιμίλιος, Αιμιλία" on 18.7
+small black "Ηλίας, Ηλιάνα" on 20.7
+small black "Μαγδαληνή, Μαρκέλλα, Μαριλένα" on 22.7
+small black "Φωκάς" on 23.7
+small black "Αθηναγόρας" on 24.7
+small black "Άννα, Ολυμπία" on 25.7
+small black "Παρασκευή, Παρασκευάς, Έρση" on 26.7
+small black "Παντελής" on 27.7
+small black "Ειρήνη, Χρυσοβαλάντης, Βαλάντης, Χρυσοβαλάντου, Ακάκιος" on 28.7
+small black "Καλλίνικος" on 29.7
+small black "Ανδρόνικος, Ανδρονίκη" on 30.7
+small black "Ιωσήφ, Ιωσηφίνα" on 31.7
+small black "Μάρκελος" on 1.8
+small black "Σωτήρης, Σωτηρία, Ευμορφία, Έμμυ, Μορφούλα" on 6.8
+small black "Αστέριος, Αστερία" on 7.8
+small black "Τριαντάφυλλος, Τριανταφυλλιά" on 8.8
+small black "Ρωμανός" on 9.8
+small black "Λαυρέντης, Λαυρεντία, Ευλαμπία, Ιππόλυτος, Ηρώ " on 10.8
+weekend "Κοίμηση της Θεοτόκου (Αργία)" on 15.8
+weekend "Μαρία, Μάριος, Παναγιώτης, Παναγιώτα, Δέσποινα, Θεοτόκης" on 15.8
+small black "Γεράσιμος, Αλκιβιάδης, Διομήδης, Σαράντης" on 16.8
+small black "Λευκοθέα, Μύρων, Μίρκα" on 17.8
+small black "Φλώρα" on 18.8
+small black "Σαμουήλ, Θεοχάρης" on 20.8
+small black "Aγαθόνικος" on 22.8
+small black "Κοσμάς" on 24.8
+small black "Βαρθολομαίος, Τίτος" on 25.8
+small black "Ναταλία, Ανδριανός, Ανδριανή" on 26.8
+small black "Φανούριος, Φανουρία, Αρκαδία" on 27.8
+small black "Θεοπίστη" on 29.8
+small black "Αλέξανδρος" on 30.8
+small black "Αδαμάντιος, Αδαμαντία, Αθηνά, Αντιγόνη, Ασπασία, Αφροδίτη, Δωδώνη" on 1.9
+small black "Ελπινίκη, Ερασμία, Ερατώ, Ευτέρπη, Θάλεια, Θεανώ, Καλλίστη, Κλειώ, Κλεονίκη" on 1.9
+small black "Κλεοπάτρα, Κοραλία, Μαργαρίτα, Μαριάνθη, Μελέτιος, Μελπομένη, Ουρανία" on 1.9
+small black "Πανδώρα, Πηνελόπη, Πολυμνία, Πολυνίκη, Σαπφώ, Συμεών, Τερψιχόρη, Χάιδω" on 1.9
+small black "Άνθιμος, Πολύδωρος, Φοίβη" on 3.9
+small black "Ερμιόνη, Μωυσής" on 4.9
+small black "Ζαχαρίας" on 5.9
+small black "Κασσιανή, Σώζων" on 7.9
+small black "Ιωακείμ" on 9.9
+small black "Εράστη, Εράστος, Μητροδώρα, Πουλχερία" on 10.9
+small black "Ευανθία" on 11.9
+small black "Αριστείδης, Κορνήλιος" on 13.9
+small black "Σταύρος, Σταυρούλα" on 14.9
+small black "Νικήτας, Βησσαρίων" on 15.9
+small black "Ευφημία" on 16.9
+small black "Σοφία, Ελπίδα, Αγάπη, Πίστη, Σόνια" on 17.9
+small black "Αριάδνη" on 18.9
+small black "Ευστάθιος, Ευσταθία" on 20.9
+small black "Ίωνας" on 21.9
+small black "Φωκάς, Ζωγραφιά" on 22.9
+small black "Πολυξένη, Ξανθίππη, Ξάνθιππος" on 23.9
+small black "Θέκλα, Μυρσίνη, Μυρτώ" on 24.9
+small black "Ευφροσύνη" on 25.9
+small black "Ζήνων" on 27.9
+small black "Κυριάκος, Κυριακή" on 29.9
+small black "Θηρεσία" on 1.10
+small black "Κυπριανός" on 2.10
+small black "Διονύσης, Διονυσία" on 3.10
+small black "Ιερόθεος, Φραγκίσκος" on 4.10
+small black "Χαριτινή" on 5.10
+small black "Σέργιος, Πολυχρόνης, Χρόνης" on 7.10
+small black "Πελαγία" on 8.10
+small black "Ευλάμπιος, Ευλαμπία" on 10.10
+small black "Ανδρομάχη, Ανδρόμαχος" on 12.10
+small black "Αγαθονίκη, Φλωρέντιος, Φλωρεντία" on 13.10
+small black "Λουκιανός" on 15.10
+small black "Λουκάς" on 18.10
+small black "Γεράσιμος, Αρτέμιος" on 20.10
+small black "Σωκράτης, Χριστόδουλος, Όυρσουλα" on 21.10
+small black "Αβέρκιος" on 22.10
+small black "Ιάκωβος" on 23.10
+small black "Χρυσάφης" on 25.10
+small black "Δημήτριος, Δήμητρα, Δανάη" on 26.10
+small black "Νέστορας" on 27.10
+small black "Ζηνοβία, Κλεόπας, Μαρκιανός" on 30.10
+small black "Αριστόβουλος" on 31.10
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.11
+small black "Αφθόνιος, Αφθονία" on 2.11
+small black "Ιωαννίκη" on 4.11
+small black "Λίνος" on 5.11
+small black "Λεονάρδος" on 6.11
+small black "Αθηνόδωρος" on 7.11
+small black "Σταμάτιος, Σταματία, Μιχάλης, Γαβριήλ, Γαβριέλα" on 8.11
+small black "Ταξιάρχης, Άγγελος, Αγγελική, Ματίνα, Σεραφείμ" on 8.11
+small black "Νεκτάριος, Νεκταρία" on 9.11
+small black "Ορέστης" on 10.11
+small black "Μηνάς, Mήνα, Βίκτωρ, Βικτωρία" on 11.11
+small black "Χρυσόστομος" on 13.11
+small black "Φίλιππος" on 14.11
+small black "Ματθαίος, Ιφιγένεια" on 16.11
+small black "Πλάτωνας" on 18.11
+small black "Μαρία, Μάριος" on 21.11
+small black "Φιλήμων" on 22.11
+small black "Μερώπη" on 23.11
+small black "Κατερίνα, Μερκούριος" on 25.11
+small black "Στέλιος, Στέλλα, Στέργιος" on 26.11
+small black "Φαίδρα" on 29.11
+small black "Ανδρέας, Ανδριάνα" on 30.11
+small black "Θεόκλητος, Ιακώβ" on 1.12
+small black "Βαρβάρα, Δαμασκηνός" on 4.12
+small black "Σάββας, Σαββούλα, Διογένης" on 5.12
+small black "Νίκος, Νικολέττα" on 6.12
+small black "Αμβρόσιος" on 7.12
+small black "Άννα" on 9.12
+small black "Ααρών, Αδάμ, Δαυίδ, Δανάη, Εύα, Ισαάκ, Ιώβ, Ραχήλ, Ρουμπίνη" on 11.12
+small black "Σπύρος, Σπυριδούλα" on 12.12
+small black "Ευστράτιος, Λουκάς, Λουκία, Άρης" on 13.12
+small black "Ελευθέριος, Ελευθερία, Ανθή, Σύλβια" on 15.12
+small black "Διονύσης, Διονυσία, Δανιήλ, Ρεβέκα, Σεβαστιανός, Σεβαστή" on 17.12
+small black "Ααρών, Αδάμ, Ισαάκ, Ραχήλ, Σάρα" on 17.12
+small black "Αγλαΐα" on 19.12
+small black "Ιγνάτιος" on 20.12
+small black "Θεμιστοκλής, Ιουλία" on 21.12
+small black "Αναστασία" on 22.12
+small black "Ευγένιος, Ευγενία" on 24.12
+small black "Χρήστος, Χριστίνα, Χρύσα" on 25.12
+weekend "Σύναξις Θεοτόκου (Αργία)" on 26.12
+weekend "Μανώλης, Εμμανουέλα, Δαβίδ" on 26.12
+small black "Στέφανος, Στεφανία" on 27.12
+small black "Δόμνα" on 28.12
+small black "Ιωσήφ" on 30.12
+weekend "Χριστούγεννα (Αργία)" on 25.12
+
+
+: Αργίες - Επέτειοι
+weekend "Πρωτοχρονιά (Αργία)" on 1.1
+weekend "Πρωτομαγιά (Αργία)" on 1.5
+weekend "Επέτειος του ΟΧΙ (Αργία)" 28.10
+weekend "Επέτειος της επανάστασης του 1821 (Αργία)" on 25.3
+small black "Εξέγερση του Πολυτεχνείου (Σχολική Αργία)" on 17.11
+
+: Κινητές εορτές
+
+small black "Τελώνου και Φαρισαίου - Αρχή Τριωδίου" on easter minus 70 days
+small black "Του Ασώτου" on easter minus 63 days
+small black "Τσικνοπέμπτη" on easter minus 59 days
+small black "Κυριακή των Απόκρεω" on easter minus 56 days
+small black "Τυροφάγου" on easter minus 49 days
+small black "Καθαρή Δευτέρα (Αργία)" on easter minus 48 days
+small black "Θεόδωρος, Θεοδώρα, Δώρα, Θώδης, Θώδος, Δώρης" on easter minus 43 days
+small black "Κυριακή της Ορθοδοξίας" on easter minus 42 days
+small black "Σάββατο του Λαζάρου" on easter minus 8 days
+small black "Κυριακή των Βαΐων" on easter minus 7 days
+small black "Μεγάλη Δευτέρα" on easter minus 6 days
+small black "Μεγάλη Τρίτη" on easter minus 5 days
+small black "Μεγάλη Τετάρτη" on easter minus 4 days
+small black "Μεγάλη Πέμπτη" on easter minus 3 days
+weekend "Μεγάλη Παρασκευή (Αργία)" on easter minus 2 days
+weekend "Μεγάλο Σάββατο" on easter minus 1 days
+weekend "Το Άγιον Πάσχα" on easter
+weekend "Δευτέρα του Πάσχα (Αργία)" on easter plus 1 days
+small black "Πηγή, Ζήσης, Ζησούλα, Ζήσιμος, Ζωή, Ζώης" on easter plus 5 days
+small black "Του Θωμά" on easter plus 7 days
+small black "Ανάληψη του Χριστού" on easter plus 39 days
+small black "Πεντηκοστή" on easter plus 49 days
+small black "Αγ. Πνεύματος" on easter plus 50 days
+small black "Αγ. Πάντων" on easter plus 56 days
+
+: Αλλαγή ώρας
+small black "Αλλαγή ώρας (1 ώρα πίσω)" on last sunday in october
+small black "Αλλαγή ώρας (1 ώρα μπροστά) " on last sunday in march
Index: libkholidays/holidays/Makefile.am
===================================================================
--- libkholidays/holidays/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkholidays/holidays/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -5,13 +5,13 @@
                 holiday_ca holiday_catalan holiday_co \
                 holiday_ch holiday_cz holiday_de holiday_dk holiday_ee \
                 holiday_es holiday_fi holiday_fr holiday_frswiss holiday_gb \
-                holiday_gt \
+                holiday_gr holiday_gt \
                 holiday_hu holiday_is holiday_il holiday_it holiday_ja \
                 holiday_lt holiday_mx \
                 holiday_nl \
                 holiday_no holiday_nz holiday_pl holiday_pt holiday_py \
                 holiday_quebec \
-                holiday_ro holiday_ru \ 
+                holiday_ro holiday_ru \
 		holiday_se holiday_si holiday_th holiday_us \
                 holiday_uy holiday_ie \
                 holiday_Suedtirol
Index: libkdepim/categoryeditdialog.cpp
===================================================================
--- libkdepim/categoryeditdialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkdepim/categoryeditdialog.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -76,6 +76,7 @@
   }
   mWidget->mButtonRemove->setEnabled( categoriesExist );
   mWidget->mCategories->setSelected( mWidget->mCategories->firstChild(), true );
+  mWidget->mEdit->setText( mWidget->mCategories->currentItem()->text( 0 ) );
 }
 
 void CategoryEditDialog::slotTextChanged(const QString &text)
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -660,6 +660,8 @@
             completionBox->setCurrentItem( item );
             completionBox->setSelected( item, wasSelected );
             completionBox->blockSignals( false );
+          } else {
+            completionBox->clearSelection();
           }
         }
         else // completion box not visible yet -> show it
@@ -821,7 +823,7 @@
       // to ignore. If so, go one further
       QListBoxItem *itemAbove = completionBox()->item( currentIndex - 1 );
       if ( itemAbove && !itemAbove->text().startsWith( s_completionItemIndentString ) ) {
-        // there is a header above is, check if there is even further up
+        // there is a header above us, check if there is even further up
         // and if so go one up, so it'll be selected
         if ( currentIndex > 1 && completionBox()->item( currentIndex - 2 ) ) {
           //kdDebug() << "EVENTFILTER: Key_Up -> skipping " << currentIndex - 1 << endl;
@@ -831,6 +833,7 @@
             // nothing to skip to, let's stay where we are, but make sure the
             // first header becomes visible, if we are the first real entry
             completionBox()->ensureVisible( 0, 0 );
+            completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
@@ -845,9 +848,14 @@
           completionBox()->setSelected( currentIndex + 2, true );
         } else {
           // nothing to skip to, let's stay where we are
+          completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
+      // special case of the last and only item in the list needing selection
+      if ( !itemBelow && currentIndex == 1 ) {
+        completionBox()->setSelected( currentIndex, true );
+      }
       // special case of the initial selection, which is unfortunately a header.
       // Setting it to selected tricks KCompletionBox into not treating is special
       // and selecting making it current, instead of the one below.
Index: libkcal/localdir.desktop
===================================================================
--- libkcal/localdir.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkcal/localdir.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -34,7 +34,7 @@
 Name[pt]=Calendário numa Directoria Local
 Name[pt_BR]=Calendário em Diretório Local
 Name[ro]=Calendar în director local
-Name[ru]=Календарь в локальном каталоге
+Name[ru]=Календарь в локальной папке
 Name[sk]=Kalendár v lokálnom priečinku
 Name[sl]=Koledar v krajevnem imeniku
 Name[sr]=Календар у локалном директоријуму
Index: libkcal/calendarresources.cpp
===================================================================
--- libkcal/calendarresources.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkcal/calendarresources.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -106,6 +106,8 @@
 {
   close();
   delete mManager;
+  delete mStandardPolicy;
+  delete mAskPolicy;
 }
 
 void CalendarResources::readConfig( KConfig *config )
Index: libkcal/libical/src/libical/sspm.c
===================================================================
--- libkcal/libical/src/libical/sspm.c	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkcal/libical/src/libical/sspm.c	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1171,7 +1171,7 @@
 			     char *src,
 			     size_t *size)
 {
-    int cc;
+    int cc = 0;
     char buf[4] = {0,0,0,0};  
     int p = 0;
     int valid_data = 0;
Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -275,11 +275,17 @@
 
     if ( ( r->duration() == -1 || ( nextDate.isValid() && endDateTime.isValid()
            && nextDate <= endDateTime ) ) ) {
-      setDtDue( nextDate );
-      while ( !recursAt( dtDue() ) || dtDue() <= QDateTime::currentDateTime() ) {
-        setDtDue( r->getNextDateTime( dtDue() ) );
+
+      while ( !recursAt( nextDate ) || nextDate <= QDateTime::currentDateTime() ) {
+
+        if ( !nextDate.isValid() || nextDate > endDateTime ) {
+          return false;
+        }
+
+        nextDate = r->getNextDateTime( nextDate );
       }
 
+      setDtDue( nextDate );
       setCompleted( false );
       setRevision( revision() + 1 );
 
Index: libkcal/htmlexport.h
===================================================================
--- libkcal/htmlexport.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ libkcal/htmlexport.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -37,7 +37,7 @@
 namespace KCal {
 
 /**
-  This class provides the functions to export a calendar as a HTML page.
+  This class provides the functions to export a calendar as an HTML page.
 */
 class KDE_EXPORT HtmlExport
 {
Index: kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -99,7 +99,7 @@
                                     <bool>true</bool>
                                 </property>
                                 <property name="whatsThis" stdset="0">
-                                    <string>&lt;qt&gt;Select this option to output the system information data as a HTML document.&lt;/qt&gt;</string>
+                                    <string>&lt;qt&gt;Select this option to output the system information data as an HTML document.&lt;/qt&gt;</string>
                                 </property>
                             </widget>
                             <widget class="QRadioButton" row="1" column="0" rowspan="1" colspan="2">
Index: kpilot/conduits/memofileconduit/memofile-conduit.desktop
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -47,7 +47,7 @@
 Comment[es]=Este conducto sincroniza las notas de su agenda electrónica con el directorio local.
 Comment[et]=See kanal sünkroniseerib pihuarvutis ja arvutis olevad memod.
 Comment[eu]=Kanal honek zure agendako oharrak direktorio lokal batekin sinkronizatzen ditu.
-Comment[fa]=این لوله، memo‌های دستی خود را با یک فهرست راهنمای محلی همگام‌سازی کنید.
+Comment[fa]=این لوله، memo‌های دستی خود را با یک فهرست راهنمای محلی همگام‌سازی می‌کند.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen muistiot paikalliseen kansioon.
 Comment[fr]=Ce canal synchronise les mémos du Palm avec ceux de KDE.
 Comment[hu]=Ezzel a csatolóval egy kézi számítógép memóit lehet szinkronizálni a helyi címjegyzékkel.
Index: kpilot/conduits/docconduit/doc_conduit.desktop
===================================================================
--- kpilot/conduits/docconduit/doc_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kpilot/conduits/docconduit/doc_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -17,7 +17,7 @@
 Comment[hu]=Szöveges fájlok hozzáadása a kézi számítógéphez, DOC-olvasók számára.
 Comment[is]=Bætir textaskrám, sem hægt er að lesa í DOC lesara, við lófatölvuna þína.
 Comment[it]=Aggiunge file di testo al tuo Pilot, adatti per lettori DOC.
-Comment[ja]=テキストファイルを DOC リーダに適した形式でハンドヘルドに追加します。
+Comment[ja]=テキストファイルを DOC リーダーに適した形式でハンドヘルドに追加します。
 Comment[km]=បន្ថែម​ឯកសារ​អត្ថបទ​ទៅ​ឧបករណ៍​យួរ​ដៃ​របស់​អ្នក (សមស្រប​សម្រាប់​កម្មវិធី​អាន DOC) ។
 Comment[lt]=Prideda teksto bylas prie Jūsų nešiojamos knygelės, tinka DOC skaityklėms.
 Comment[ms]=Menambah fail teks ke komputer telapak, sesuai dengan pembaca DOC.
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -65,7 +65,7 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
Index: kontact/plugins/akregator/akregatorplugin3.2.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -64,7 +64,7 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
Index: kontact/interfaces/kontactplugin.desktop
===================================================================
--- kontact/interfaces/kontactplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kontact/interfaces/kontactplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -15,7 +15,7 @@
 Name[es]=Plugin Kontact
 Name[et]=Kontacti plugin
 Name[eu]=Kontact plugin-a
-Name[fa]=وصلۀ 
+Name[fa]=وصلۀ Kontact
 Name[fi]=Kontact-liitännäinen
 Name[fr]=Module Kontact
 Name[ga]=Breiseán Kontact
Index: kontact/src/kcmkontact.cpp
===================================================================
--- kontact/src/kcmkontact.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kontact/src/kcmkontact.cpp	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -104,6 +104,7 @@
 {
   mItem = item;
   mPluginCombo = new QComboBox( parent );
+  connect( mPluginCombo, SIGNAL( activated( int ) ), SIGNAL( changed() ) );
 }
 
 PluginSelection::~PluginSelection()
@@ -140,12 +141,6 @@
   mItem->setValue( ptr->property("X-KDE-PluginInfo-Name").toString() );
 }
 
-void PluginSelection::itemClicked( QListViewItem *item )
-{
-  if ( item )
-    emit changed();
-}
-
 QValueList<QWidget *> PluginSelection::widgets() const
 {
   QValueList<QWidget *> widgets;
Index: kontact/src/kcmkontact.h
===================================================================
--- kontact/src/kcmkontact.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ kontact/src/kcmkontact.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -60,9 +60,6 @@
     QValueList<QWidget *> widgets() const;
     QComboBox *comboBox() const { return mPluginCombo; }
 
-  private slots:
-    void itemClicked( QListViewItem* );
-
   private:
     QComboBox *mPluginCombo;
     QValueList<KService::Ptr> mPluginList;
Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -57,7 +57,7 @@
 Comment[es]=A visor/extractor para archivos TNEF
 Comment[et]=TNEF-failide näitaja/ekstraktija
 Comment[eu]=TNEF fitxategien ikustaile/erauzlea
-Comment[fa]=یک مشاهده‌گر/استخراجگر برای پرونده‌های TNEF
+Comment[fa]=یک مشاهده‌گر/استخراج‌گر برای پرونده‌های TNEF
 Comment[fi]=Näytin/purkaja TNEF-tiedostoille
 Comment[fr]=Pour afficher / extraire des fichiers TNEF
 Comment[hi]=टीएनईएफ फ़ाइलों के लिए एक प्रदर्शक/एक्सट्रेक्टर
Index: korganizer/Makefile.am
===================================================================
--- korganizer/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -171,7 +171,7 @@
 	$(XGETTEXT) `find . -name "*.cpp" -o -name "*.h"` -o $(podir)/korganizer.pot
 	rm -f tips.cpp
 
-xdg_apps_DATA = korganizer.desktop
+xdg_apps_DATA = korganizer.desktop korganizer-import.desktop
 
 kde_kcfg_DATA = korganizer.kcfg
 
Index: korganizer/korganizer.kcfg
===================================================================
--- korganizer/korganizer.kcfg	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ korganizer/korganizer.kcfg	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -74,7 +74,7 @@
 
     <entry type="Bool" key="Html With Save">
       <label>Export to HTML with every save</label>
-      <whatsthis>Check this box to export the calendar to a HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
+      <whatsthis>Check this box to export the calendar to an HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
       <default>false</default>
     </entry>
     <entry type="Enum" key="Destination" name="Destination">
@@ -158,7 +158,7 @@
   <group name="Views">
     <entry type="Int" key="Hour Size">
       <label>Hour size</label>
-      <whatsthis>Select on this spin box the the height of the hour rows in the schedule view.</whatsthis>
+      <whatsthis>Select on this spin box the height of the hour rows in the schedule view.</whatsthis>
       <default>10</default>
       <min>4</min>
       <max>30</max>
@@ -272,7 +272,7 @@
 
     <entry type="Int" key="Next X Days">
       <label>Next x days</label>
-      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
+      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
       <default>3</default>
     </entry>
 
@@ -315,7 +315,7 @@
     </entry>
     <entry type="Bool" key="Use Groupware Communication">
       <label>Use Groupware communication</label>
-      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
+      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
       <default>true</default>
     </entry>
 
Index: korganizer/kotodoeditor.h
===================================================================
--- korganizer/kotodoeditor.h	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ korganizer/kotodoeditor.h	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -95,7 +95,7 @@
   protected:
     void loadTemplate( /*const*/ CalendarLocal& );
     QStringList& templates() const;
-    QString type() { return "ToDo"; }
+    QString type() { return "Todo"; }
     void setupGeneral();
     void setupRecurrence();
     int msgItemDelete();

Property changes on: korganizer/pixmaps
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -1,6 +1,5 @@
 [Desktop Entry]
 Encoding=UTF-8
-MimeType=text/calendar;text/x-vcalendar;
 Comment=Calendar and Scheduling Program
 Comment[af]=Kalender en Skedulering Program
 Comment[ar]=برنامج الجدولة والتقويم
@@ -61,7 +60,7 @@
 Comment[zh_CN]=日历和日程安排程序
 Comment[zh_TW]=行事曆與排程軟體
 Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
-Exec=korganizer --import %u
+Exec=korganizer
 Icon=korganizer
 Path=
 DocPath=korganizer/index.html
Index: korganizer/korganizer_configgroupautomation.desktop
===================================================================
--- korganizer/korganizer_configgroupautomation.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 600145)
+++ korganizer/korganizer_configgroupautomation.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -25,7 +25,7 @@
 Name[es]=Automatización del grupo
 Name[et]=Grupitöö
 Name[eu]=Talde automatizazioa
-Name[fa]=خودکار سازی گروه
+Name[fa]=خودکارسازی گروه
 Name[fi]=Ryhmän automatisointi
 Name[fr]=Automatisation des groupes
 Name[gl]=Automatización de Grupo
Index: korganizer/korganizer-import.desktop
===================================================================
--- korganizer/korganizer-import.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ korganizer/korganizer-import.desktop	(.../branches/KDE/3.5/kdepim)	(revision 600145)
@@ -0,0 +1,137 @@
+[Desktop Entry]
+Encoding=UTF-8
+MimeType=text/calendar;text/x-vcalendar;
+Comment=Calendar and Scheduling Program
+Comment[af]=Kalender en Skedulering Program
+Comment[ar]=برنامج الجدولة والتقويم
+Comment[bg]=Програма за календар и разписание
+Comment[bs]=Kalendar i rokovnik
+Comment[ca]=Un programa de calendari i planificació
+Comment[cs]=Kalendářový a plánovací program
+Comment[cy]=Rhaglen Galendr a Drefnlennu
+Comment[da]=Kalender- og planlægningsprogram
+Comment[de]=Ein Kalender und Zeitplaner
+Comment[el]=Πρόγραμμα ημερολογίου και προγραμματισμού
+Comment[eo]=Kalendara kaj plana programo
+Comment[es]=Calendario y planificador
+Comment[et]=Kalendri ja ajakava haldamise rakendus
+Comment[eu]=Egutegi eta antolaketa progrmaa
+Comment[fa]=تقویم و برنامۀ زمان‌بندی
+Comment[fi]=Kalenteri ja ajanhallintaohjelma
+Comment[fr]=Calendrier et agenda personnel
+Comment[gl]=Programa de Calendario e Axenda
+Comment[he]=תוכניות לוח שנה ותזמון משימות
+Comment[hi]=कैलेन्डर तथा समय-सारणी प्रोग्राम
+Comment[hr]=Kalendar i rokovnik
+Comment[hu]=Határidőnapló és eseményszervező
+Comment[is]=Dagbók og skipulag
+Comment[it]=Programma di calendario e di agenda
+Comment[ja]=カレンダーとスケジュール管理プログラム
+Comment[km]=កម្មវិធី​ប្រតិទិន និង កាលវិភាគ
+Comment[lt]=Kalendoriaus ir planavimo programa
+Comment[lv]=Kalendāra un Plānošanas Programma
+Comment[mk]=Календар и роковник
+Comment[ms]=Kalendar dan Program Penjadualan 
+Comment[mt]=Programm b' kalendarju w skeda
+Comment[nb]=Et kalender- og tidsplanleggingsprogram
+Comment[nds]=Kalenner un Tietplaner
+Comment[nl]=Agenda- en afsprakenprogramma
+Comment[nn]=Kalender- og planleggingsprogram
+Comment[nso]=Lenaneo la Peakanyo ya Tshupamabaka
+Comment[pl]=Kalendarz i terminarz
+Comment[pt]=Calendário e Programa de Escalonamento
+Comment[pt_BR]=Programa de Calendário e Agenda
+Comment[ro]=Program de planificare şi calendar
+Comment[ru]=Календарь и личное расписание
+Comment[se]=Kaleandar- ja plánenprográmma
+Comment[sk]=Kalendár a plánovací program
+Comment[sl]=Program za koledar in razporejanje
+Comment[sr]=Календарски и планерски програм
+Comment[sr@Latn]=Kalendarski i planerski program
+Comment[sv]=Kalender- och schemaläggningsprogram
+Comment[ta]=நாள்காட்டி மற்றும் திட்ட நிரல்
+Comment[tg]=Тақвимот ва ҷадвали шахсӣ
+Comment[th]=โปรแกรมจัดการปฏิทินและตารางการนัดหมาย
+Comment[tr]=Takvim ve Zamanlama Programı
+Comment[uk]=Програма календаря та розкладу
+Comment[uz]=Календар ва режалаштириш дастури
+Comment[ven]=Khalenda na mbekanyamushumo ya u shedula
+Comment[vi]=Chương trình lịch và kế hoạch
+Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
+Comment[zh_CN]=日历和日程安排程序
+Comment[zh_TW]=行事曆與排程軟體
+Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
+Exec=korganizer --import %u
+Icon=korganizer
+Path=
+DocPath=korganizer/index.html
+Type=Application
+Terminal=false
+Name=KOrganizer
+Name[af]=Korganizer
+Name[ar]=منظم كيدي
+Name[be]=K Арганізатар
+Name[cy]=KTrefnydd
+Name[eo]=Organizilo
+Name[hi]=के-आर्गेनाइज़र
+Name[lv]=KOrganaizers
+Name[mk]=Организатор
+Name[nso]=KMokopanyi
+Name[pl]=Organizator
+Name[sv]=Korganizer
+Name[ta]=கேஅமைப்பாளர்
+Name[ven]=Mulugisi wa K
+Name[zh_TW]=KOrganizer 行事曆
+GenericName=Personal Organizer
+GenericName[be]=Пэрсанальны арганізатар
+GenericName[bg]=Организатор
+GenericName[bs]=Lični organizer
+GenericName[ca]=Organitzador personal
+GenericName[cs]=Osobní organizér
+GenericName[cy]=Trefnydd Personol
+GenericName[da]=Personlig organisering
+GenericName[de]=Persönliche Daten organisieren
+GenericName[el]=Προσωπικός οργανωτής
+GenericName[en_GB]=Personal Organiser
+GenericName[es]=Organizador personal
+GenericName[et]=Personaalne ajaarvestus
+GenericName[eu]=Antolatzaile pertsonala
+GenericName[fa]=سازمان‌دهندۀ شخصی‌
+GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
+GenericName[fr]=Organiseur personnel
+GenericName[gl]=Organizador Persoal
+GenericName[he]=מנהל זמן אישי
+GenericName[hi]=निजी प्रबंधक
+GenericName[hu]=Határidőnapló
+GenericName[is]=Persónuleg skipulagsbók
+GenericName[it]=Organizzatore personale
+GenericName[ja]=個人向けスケジュール管理
+GenericName[km]=កម្មវិធី​រៀបចំ​ផ្ទាល់​ខ្លួន
+GenericName[lt]=Asmeninės informacijos tvarkyklė
+GenericName[ms]=Penyusun Peribadi
+GenericName[nb]=Personlig planlegger
+GenericName[nds]=Persöönlich Mötenkalenner
+GenericName[nl]=Persoonlijke organizer
+GenericName[nn]=Personleg organiserar
+GenericName[pl]=Osobisty organizator
+GenericName[pt]=Organizador Pessoal
+GenericName[pt_BR]=Organizador Pessoal
+GenericName[ro]=Organizator personal
+GenericName[ru]=Персональный органайзер
+GenericName[sk]=Osobný plánovač
+GenericName[sl]=Osebni organizator
+GenericName[sr]=Лични планер
+GenericName[sr@Latn]=Lični planer
+GenericName[sv]=Filofax
+GenericName[ta]=தனிப்பயன் அமைப்பாளர்
+GenericName[tg]=Органайзери инфиродӣ
+GenericName[tr]=Kişisel Bilgi Yöneticisi
+GenericName[uk]=Персональний тижневик
+GenericName[uz]=Шахсий органайзер
+GenericName[zh_CN]=个人日程安排
+GenericName[zh_TW]=個人行程組織軟體
+ServiceTypes=Browser/View,DCOP/Organizer
+X-KDE-Library=libkorganizerpart
+X-KDE-StartupNotify=true
+X-DCOP-ServiceType=Unique
+X-DCOP-ServiceName=korganizer

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


