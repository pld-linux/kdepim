Index: kmobile/devices/gnokii/libkmobile_gnokii.desktop
===================================================================
--- kmobile/devices/gnokii/libkmobile_gnokii.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmobile/devices/gnokii/libkmobile_gnokii.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -86,7 +86,7 @@
 Comment[ne]=यो ड्राइभरले जिनोकी लाइब्रेरीबाट धेरै नोकिया र अन्य मोबाइल फोन समर्थन गर्छ
 Comment[nl]=Dit stuurprogramma biedt ondersteuning voor veel Nokia- en andere mobiele telefoons via de gnokii-bibliotheek
 Comment[nn]=Denne drivaren støttar mange NOKIA og andre mobiltelefonar via gnokii-biblioteket
-Comment[pl]=Ten sterownik obsługuje wiele telefonów komórkowychNokia i innych za pomocą biblioteki gnokii
+Comment[pl]=Ten sterownik obsługuje wiele telefonów komórkowych Nokia i innych za pomocą biblioteki gnokii
 Comment[pt]=Este controlador suportar muitos NOKIAs, bem como outros telemóveis, com a biblioteca 'gnokii'
 Comment[pt_BR]=Este driver suporta muitos telefones móveis, NOKIA e outros, via biblioteca gnokii
 Comment[ru]=Этот драйвер поддерживает множество моделей мобильных телефонов Nokia и других производителей через библиотеку gnokii
Index: kmobile/devices/gammu/libkmobile_gammu.desktop
===================================================================
--- kmobile/devices/gammu/libkmobile_gammu.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmobile/devices/gammu/libkmobile_gammu.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -86,7 +86,7 @@
 Comment[ne]=यो ड्राइभरले गामु लाइब्रेरीबाट धेरै नोकिया र अन्य मोबाइल फोन समर्थन गर्छ
 Comment[nl]=Dit stuurprogramma biedt ondersteuning voor veel Nokia- en andere mobiele telefoons via de gammu-bibliotheek
 Comment[nn]=Denne drivaren støttar mange NOKIA og andre mobiltelefonar via gammu-biblioteket
-Comment[pl]=Ten sterownik obsługuje wiele telefonów komórkowychNokia i innych za pomocą biblioteki gammu
+Comment[pl]=Ten sterownik obsługuje wiele telefonów komórkowych Nokia i innych za pomocą biblioteki gammu
 Comment[pt]=Este controlador suportar muitos NOKIAs, bem como outros telemóveis, com a biblioteca 'gammu'
 Comment[pt_BR]=Este driver suporta muitos telefones móveis, NOKIA e outros, via biblioteca gammu
 Comment[ru]=Этот драйвер поддерживает множество моделей мобильных телефонов Nokia и других производителей через библиотеку gammu
Index: kresources/scalix/kabc/scalix.desktop
===================================================================
--- kresources/scalix/kabc/scalix.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/scalix/kabc/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -7,14 +7,17 @@
 Name[de]=Adressbuch auf einem Scalix-Server via KMail
 Name[el]=Βιβλίο διευθύνσεων σε εξυπηρετητή Scalix μέσω του KMail
 Name[et]=Aadressiraamat Scalix-serveris (KMaili vahendusel)
+Name[fr]=Carnet d'adresses sur serveur Scalix via KMail
 Name[it]=Rubrica indirizzi su server Scalix via KMail
 Name[ja]=KMail 経由 Scalix サーバのアドレス帳
 Name[nds]=Adressbook op Scalix-Server över KMail
 Name[nl]=Adresboek op Scalix-server via KMail
+Name[pl]=Książka adresowa na serwerze Scalix za pośrednictwem KMaila
 Name[sk]=Adresár na Scalix serveri pomocou KMail
 Name[sr]=Адресар на Scalix серверу преко KMail-а
 Name[sr@Latn]=Adresar na Scalix serveru preko KMail-a
 Name[sv]=Adressbok på Scalix-server via Kmail
+Name[tr]=KMail Aracılığı ile Scalix Sunucusunda Adres Defteri
 Name[zh_CN]=通过 KMail 访问 Scalix 服务器上的地址簿
 Name[zh_TW]=透過 KMail 取得 Scalix 伺服器上的通訊錄
 X-KDE-Library=kabc_scalix
Index: kresources/scalix/knotes/scalix.desktop
===================================================================
--- kresources/scalix/knotes/scalix.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/scalix/knotes/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -7,14 +7,17 @@
 Name[de]=Notizen auf einem Scalix-Server via KMail
 Name[el]=Σημειώσεις σε εξυπηρετητή Scalix μέσω του KMail
 Name[et]=Kalender Scalix-serveris (KMaili vahendusel)
+Name[fr]=Notes sur serveur Scalix via KMail
 Name[it]=Note su server Scalix via KMail
 Name[ja]=KMail 経由 Scalix サーバのメモ
 Name[nds]=Notizen op Scalix-Server över KMail
 Name[nl]=Notities op Scalix-server via KMail
+Name[pl]=Notatki na serwerze Scalix za pośrednictwem KMaila
 Name[sk]=Poznámky na Scalix serveri pomocou KMail
 Name[sr]=Белешке на Scalix серверу преко KMail-а
 Name[sr@Latn]=Beleške na Scalix serveru preko KMail-a
 Name[sv]=Anteckningar på Scalix-server via Kmail
+Name[tr]=KMail Aracılığı ile Scalix Sunucusunda Takvim
 Name[zh_CN]=通过 KMail 访问 Scalix 服务器上的日历
 Name[zh_TW]=透過 KMail 取得 Scalix 伺服器上的便條
 X-KDE-Library=knotes_scalix
Index: kresources/scalix/shared/resourcescalixbase.cpp
===================================================================
--- kresources/scalix/shared/resourcescalixbase.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/scalix/shared/resourcescalixbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -33,6 +33,8 @@
 #include "resourcescalixbase.h"
 #include "kmailconnection.h"
 
+#include <folderselectdialog.h>
+
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kinputdialog.h>
@@ -160,10 +162,10 @@
     return possible.begin().data(); // yes this is the subresource key, i.e. location
 
   // Several found, ask the user
-  QString chosenLabel = KInputDialog::getItem( i18n( "Select Resource Folder" ),
-                                               i18n( "You have more than one writable resource folder. "
-                                                     "Please select the one you want to write to." ),
-                                               possible.keys() );
+  QString chosenLabel = KPIM::FolderSelectDialog::getItem( i18n( "Select Resource Folder" ),
+                                                           i18n( "You have more than one writable resource folder. "
+                                                                 "Please select the one you want to write to." ),
+                                                           possible.keys() );
   if ( chosenLabel.isEmpty() ) // cancelled
     return QString::null;
   return possible[chosenLabel];
Index: kresources/scalix/shared/Makefile.am
===================================================================
--- kresources/scalix/shared/Makefile.am	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/scalix/shared/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,4 +1,4 @@
-INCLUDES = -I$(top_srcdir) $(all_includes)
+INCLUDES = -I$(top_srcdir) -I$(top_srcdir)/kresources/lib $(all_includes)
 
 noinst_HEADERS = resourcescalixbase.h scalixbase.h subresource.h
 
@@ -9,7 +9,7 @@
   subresource.cpp \
 	kmailconnection.skel kmailicalIface.stub
 libresourcescalixshared_la_METASOURCES = AUTO
-libresourcescalixshared_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la
+libresourcescalixshared_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la ../../lib/libkgroupwaredav.la
 libresourcescalixshared_la_LDFLAGS = -no-undefined
 
 kmailicalIface_DCOPIDLNG = true
Index: kresources/scalix/kcal/scalix.desktop
===================================================================
--- kresources/scalix/kcal/scalix.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/scalix/kcal/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -7,14 +7,17 @@
 Name[de]=Kalender auf einem Scalix-Server via KMail
 Name[el]=Ημερολόγιο σε εξυπηρετητή Scalix μέσω του KMail
 Name[et]=Kalender Scalix-serveris (KMaili vahendusel)
+Name[fr]=Agenda sur serveur Scalix via KMail
 Name[it]=Calendario su server Scalix via KMail
 Name[ja]=KMail 経由 Scalix サーバのカレンダー
 Name[nds]=Kalenner op Scalix-Server över KMail
 Name[nl]=Agenda op Scalix-server via KMail
+Name[pl]=Kalendarz na serwerze Scalix za pośrednictwem KMaila
 Name[sk]=Kalendár na Scalix serveri pomocou KMail
 Name[sr]=Календар на Scalix серверу преко KMail-а
 Name[sr@Latn]=Kalendar na Scalix serveru preko KMail-a
 Name[sv]=Kalender på Scalix-server via Kmail
+Name[tr]=KMail Aracılığı ile Scalix Sunucusunda Takvim
 Name[zh_CN]=通过 KMail 访问 Scalix 服务器上的日历
 Name[zh_TW]=透過 KMail 取得 Scalix 伺服器上的行事曆
 X-KDE-Library=kcal_scalix
Index: kresources/kolab/shared/Makefile.am
===================================================================
--- kresources/kolab/shared/Makefile.am	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/kolab/shared/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,4 +1,4 @@
-INCLUDES = -I$(top_srcdir) $(all_includes)
+INCLUDES = -I$(top_srcdir) -I$(top_srcdir)/kresources/lib $(all_includes)
 
 noinst_HEADERS = resourcekolabbase.h kolabbase.h subresource.h
 
@@ -9,7 +9,7 @@
         subresource.cpp \
 	kmailconnection.skel kmailicalIface.stub
 libresourcekolabshared_la_METASOURCES = AUTO
-libresourcekolabshared_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la
+libresourcekolabshared_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la ../../lib/libkgroupwarebase.la
 libresourcekolabshared_la_LDFLAGS = -no-undefined
 
 kmailicalIface_DCOPIDLNG = true
Index: kresources/kolab/shared/resourcekolabbase.cpp
===================================================================
--- kresources/kolab/shared/resourcekolabbase.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/kolab/shared/resourcekolabbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -34,6 +34,8 @@
 #include "resourcekolabbase.h"
 #include "kmailconnection.h"
 
+#include <folderselectdialog.h>
+
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kinputdialog.h>
@@ -238,8 +240,8 @@
           "Please select the one you want to write to." );
 
   // Several found, ask the user
-  QString chosenLabel = KInputDialog::getItem( i18n( "Select Resource Folder" ),
-                                               t, possible.keys() );
+  QString chosenLabel = KPIM::FolderSelectDialog::getItem( i18n( "Select Resource Folder" ),
+                                                           t, possible.keys() );
   if ( chosenLabel.isEmpty() ) // cancelled
     return QString::null;
   return possible[chosenLabel];
Index: kresources/lib/folderselectdialog.h
===================================================================
--- kresources/lib/folderselectdialog.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kresources/lib/folderselectdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,58 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2008 Kevin Ottens <ervin@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef FOLDERSELECTDIALOG_H
+#define FOLDERSELECTDIALOG_H
+
+#include <kdialogbase.h>
+
+namespace KPIM {
+
+class FolderSelectDialog : public KDialogBase
+{
+private:
+  FolderSelectDialog( const QString& caption, const QString& label,
+                      const QStringList& list );
+
+public:
+  static QString getItem( const QString& caption, const QString& label,
+                          const QStringList& list );
+
+protected:
+  virtual void closeEvent(QCloseEvent *event);
+private:
+  KListBox* mListBox;
+};
+
+}
+
+#endif // FOLDERSELECTDIALOG_H
Index: kresources/lib/Makefile.am
===================================================================
--- kresources/lib/Makefile.am	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kresources/lib/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -5,7 +5,7 @@
 
 lib_LTLIBRARIES = libkgroupwarebase.la libkgroupwaredav.la
 
-libkgroupwarebase_la_SOURCES = folderlister.cpp folderconfig.cpp folderlistview.cpp \
+libkgroupwarebase_la_SOURCES = folderlister.cpp folderconfig.cpp folderlistview.cpp folderselectdialog.cpp \
   groupwaredataadaptor.cpp groupwaredownloadjob.cpp \
   calendaradaptor.cpp addressbookadaptor.cpp groupwareresourcejob.cpp \
   groupwareuploadjob.cpp kcal_resourcegroupwarebase.cpp kabc_resourcegroupwarebase.cpp \
Index: kresources/lib/folderselectdialog.cpp
===================================================================
--- kresources/lib/folderselectdialog.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kresources/lib/folderselectdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,83 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2008 Kevin Ottens <ervin@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "folderselectdialog.h"
+
+#include <qlayout.h>
+#include <qlabel.h>
+
+using namespace KPIM;
+
+FolderSelectDialog::FolderSelectDialog( const QString& caption, const QString& label,
+                                        const QStringList& list )
+  : KDialogBase(0, 0, true, caption, Ok, Ok, true)
+{
+  QFrame* frame = makeMainWidget();
+  QVBoxLayout* layout = new QVBoxLayout( frame, 0, spacingHint() );
+
+  QLabel* labelWidget = new QLabel( label, frame );
+  layout->addWidget( labelWidget );
+
+  mListBox = new KListBox( frame );
+  mListBox->insertStringList( list );
+  mListBox->setSelected( 0, true );
+  mListBox->ensureCurrentVisible();
+  layout->addWidget( mListBox, 10 );
+
+  connect( mListBox, SIGNAL( doubleClicked( QListBoxItem * ) ),
+           SLOT( slotOk() ) );
+  connect( mListBox, SIGNAL( returnPressed( QListBoxItem * ) ),
+           SLOT( slotOk() ) );
+
+  mListBox->setFocus();
+
+  layout->addStretch();
+
+  setMinimumWidth( 320 );
+}
+
+QString FolderSelectDialog::getItem( const QString &caption, const QString &label,
+                                     const QStringList& list )
+{
+  FolderSelectDialog dlg( caption, label, list );
+
+  QString result;
+  if ( dlg.exec() == Accepted )
+    result = dlg.mListBox->currentText();
+
+  return result;
+}
+
+void FolderSelectDialog::closeEvent(QCloseEvent *event)
+{
+  event->ignore();
+}
Index: certmanager/conf/kleopatra_config_dirserv.desktop
===================================================================
--- certmanager/conf/kleopatra_config_dirserv.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ certmanager/conf/kleopatra_config_dirserv.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -80,7 +80,7 @@
 Comment[eu]=LDAP direktorio zerbitzuen konfigurazioa
 Comment[fa]=پیکربندی خدمات فهرست راهنمای LDAP
 Comment[fi]=Hakemistopalveluiden asetukset
-Comment[fr]=Configuration des répertoires LDAP
+Comment[fr]=Configuration des services du répertoire LDAP
 Comment[fy]=Konfiguraasje foar LDAP-tsjinsten
 Comment[gl]=Configuración dos servicios de directorio LDAP
 Comment[he]=תצורה של שירותי ספרייה עבור LDAP
@@ -150,7 +150,7 @@
 Keywords[nds]=LDAP,Verteken,Deensten
 Keywords[ne]=ldap,डाइरेक्टरी,कार्य
 Keywords[nn]=ldap,katalog,tenester
-Keywords[pl]=ldap,katalog,usługi katalogowe,usługi,LDAP
+Keywords[pl]=katalog,usługi katalogowe,usługi,LDAP
 Keywords[pt]=ldap,directório,serviços
 Keywords[pt_BR]=ldap,diretório,serviços
 Keywords[ru]=LDAP,службы каталогов
Index: certmanager/lib/cryptplug.h
===================================================================
--- certmanager/lib/cryptplug.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ certmanager/lib/cryptplug.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -408,7 +408,7 @@
    \note This function <b>must</b> be implemented by each plug-in using
    this API specification.
 */
-bool hasFeature( Feature );
+bool hasFeature( ::Feature );
 
 /*! \ingroup groupSignCryptAct
    \brief Information record returned by signing and by encrypting
Index: certmanager/lib/cryptplugwrapper.h
===================================================================
--- certmanager/lib/cryptplugwrapper.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ certmanager/lib/cryptplugwrapper.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -718,7 +718,7 @@
 
         \return  whether the relative feature is implemented or not
     */
-    bool hasFeature( Feature );
+    bool hasFeature( ::Feature );
 
 
     /* \ingroup groupSignAct
Index: karm/ktimewidget.h
===================================================================
--- karm/ktimewidget.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/ktimewidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -14,7 +14,7 @@
 {
   public:
     KArmTimeWidget( QWidget* parent = 0, const char* name = 0 );
-    void setTime( int hour, int minute );
+    void setTime( long minutes );
     long time() const;
 
   private:
Index: karm/idletimedetector.cpp
===================================================================
--- karm/idletimedetector.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/idletimedetector.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -10,15 +10,18 @@
 IdleTimeDetector::IdleTimeDetector(int maxIdle)
 // Trigger a warning after maxIdle minutes
 {
-  kdDebug(5970) << "IdleTimeDetector::IdleTimeDetector" << endl;
+  kdDebug(5970) << "Entering IdleTimeDetector::IdleTimeDetector" << endl;
   _maxIdle = maxIdle;
 
 #ifdef HAVE_LIBXSS
+  kdDebug(5970) << "IdleTimeDetector: LIBXSS detected @ compile time" << endl;
   int event_base, error_base;
-  if(XScreenSaverQueryExtension(qt_xdisplay(), &event_base, &error_base)) {
+  if(XScreenSaverQueryExtension(qt_xdisplay(), &event_base, &error_base)) 
+  {
     _idleDetectionPossible = true;
   }
-  else {
+  else 
+  {
     _idleDetectionPossible = false;
   }
 
@@ -43,9 +46,9 @@
   {
     _mit_info = XScreenSaverAllocInfo ();
     XScreenSaverQueryInfo(qt_xdisplay(), qt_xrootwin(), _mit_info);
-    int idleMinutes = (_mit_info->idle/1000)/secsPerMinute;
-    if (idleMinutes >= _maxIdle)
-      informOverrun(idleMinutes);
+    int idleSeconds = (_mit_info->idle/1000);
+    if (idleSeconds >= _maxIdle)
+      informOverrun(idleSeconds);
   }
 #endif // HAVE_LIBXSS
 }
@@ -56,38 +59,38 @@
 }
 
 #ifdef HAVE_LIBXSS
-void IdleTimeDetector::informOverrun(int idleMinutes)
+void IdleTimeDetector::informOverrun(int idleSeconds)
 {
+  kdDebug(5970) << "Entering IdleTimeDetector::informOverrun" << endl;
   if (!_overAllIdleDetect)
     return; // preferences say the user does not want idle detection.
 
   _timer->stop();
 
-  QDateTime start = QDateTime::currentDateTime();
-  QDateTime idleStart = start.addSecs(-60 * _maxIdle);
-  QString backThen = KGlobal::locale()->formatTime(idleStart.time());
+  QDateTime idleStart = QDateTime::currentDateTime().addSecs(-idleSeconds);
+  QString idleStartQString = KGlobal::locale()->formatTime(idleStart.time());
 
   int id =  QMessageBox::warning( 0, i18n("Idle Detection"),
                                      i18n("Desktop has been idle since %1."
-                                          " What should we do?").arg(backThen),
+                                          " What should we do?").arg(idleStartQString),
                                      i18n("Revert && Stop"),
                                      i18n("Revert && Continue"),
                                      i18n("Continue Timing"),0,2);
   QDateTime end = QDateTime::currentDateTime();
-  int diff = start.secsTo(end)/secsPerMinute;
+  int diff = idleStart.secsTo(end)/secsPerMinute;
 
   if (id == 0) 
   {
     // Revert And Stop
     kdDebug(5970) << "Now it is " << QDateTime::currentDateTime() << endl;
     kdDebug(5970) << "Reverting timer to " << KGlobal::locale()->formatTime(idleStart.time()).ascii() << endl;
-    emit(extractTime(idleMinutes+diff)); // we need to subtract the time that has been added during idleness.
+    emit(extractTime(idleSeconds/60+diff)); // we need to subtract the time that has been added during idleness.
     emit(stopAllTimersAt(idleStart));
   }
   else if (id == 1) 
   {
     // Revert and Continue
-    emit(extractTime(idleMinutes+diff));
+    emit(extractTime(idleSeconds/60+diff));
     _timer->start(testInterval);
   }
   else 
Index: karm/ktimewidget.cpp
===================================================================
--- karm/ktimewidget.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/ktimewidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -8,6 +8,7 @@
 #include <qwidget.h>
 
 #include <klocale.h>            // i18n
+#include <kglobal.h>
 #include "ktimewidget.h"
 
 enum ValidatorType { HOUR, MINUTE };
@@ -97,15 +98,19 @@
   setFocusProxy( _hourLE );
 }
 
-void KArmTimeWidget::setTime( int hour, int minute )
+void KArmTimeWidget::setTime( long minutes )
 {
   QString dummy;
+  long hourpart = labs(minutes) / 60;
+  long minutepart = labs(minutes) % 60;
 
-  dummy.setNum( hour );
+  dummy.setNum( hourpart );
+  if (minutes < 0)
+    dummy = KGlobal::locale()->negativeSign() + dummy;
   _hourLE->setText( dummy );
 
-  dummy.setNum( abs(minute) );
-  if (abs(minute) < 10 ) {
+  dummy.setNum( minutepart );
+  if (minutepart < 10 ) {
     dummy = QString::fromLatin1( "0" ) + dummy;
   }
   _minuteLE->setText( dummy );
@@ -113,12 +118,12 @@
 
 long KArmTimeWidget::time() const
 {
-  bool ok;
+  bool ok, isNegative;
   int h, m;
 
-  h = _hourLE->text().toInt( &ok );
+  h = abs(_hourLE->text().toInt( &ok ));
   m = _minuteLE->text().toInt( &ok );
+  isNegative = _hourLE->text().startsWith(KGlobal::locale()->negativeSign());
 
-  // if h is negative, we have to *subtract* m
-  return h * 60 + ( ( h < 0) ? -1 : 1 ) * m;
+  return (h * 60 + m) * ((isNegative) ? -1 : 1);
 }
Index: karm/task.cpp
===================================================================
--- karm/task.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/task.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -62,13 +62,13 @@
 
   if (icons == 0) {
     icons = new QPtrVector<QPixmap>(8);
-    KIconLoader* kil = new KIconLoader("karm"); // always load icons from the KArm application
+    KIconLoader kil("karm"); // always load icons from the KArm application
     for (int i=0; i<8; i++)
     {
       QPixmap *icon = new QPixmap();
       QString name;
       name.sprintf("watch-%d.xpm",i);
-      *icon = kil->loadIcon( name, KIcon::User );
+      *icon = kil.loadIcon( name, KIcon::User );
       icons->insert(i,icon);
     }
   }
Index: karm/edittaskdialog.cpp
===================================================================
--- karm/edittaskdialog.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/edittaskdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -298,8 +298,8 @@
 {
   _name->setText( name );
   
-  _timeTW->setTime( time / 60, time % 60 );
-  _sessionTW->setTime( session / 60, session % 60 );
+  _timeTW->setTime( time );
+  _sessionTW->setTime( session );
   origTime = time;
   origSession = session;
 }
Index: karm/karmutility.cpp
===================================================================
--- karm/karmutility.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ karm/karmutility.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -14,7 +14,9 @@
     time.sprintf("%.2f", minutes / 60.0);
     time.replace( '.', KGlobal::locale()->decimalSymbol() );
   }
-  else time.sprintf("%ld:%02ld", minutes / 60, labs(minutes % 60));
+  else time.sprintf("%s%ld:%02ld",
+    (minutes < 0) ? KGlobal::locale()->negativeSign().utf8().data() : "",
+    labs(minutes / 60), labs(minutes % 60));
   return time;
 }
 
Index: kdgantt/KDGanttViewTaskItem.h
===================================================================
--- kdgantt/KDGanttViewTaskItem.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kdgantt/KDGanttViewTaskItem.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -60,8 +60,10 @@
     void setStartTime( const QDateTime& start );
     void setEndTime( const QDateTime& end );
 
+protected:
+    void showItem( bool show = true, int coordY = 0 );
+
 private:
-    void showItem( bool show = true, int coordY = 0 );
     void initItem();
     void hideMe();
     QBrush myBrush, undefinedBrush;
Index: kdgantt/KDGanttViewSubwidgets.cpp
===================================================================
--- kdgantt/KDGanttViewSubwidgets.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kdgantt/KDGanttViewSubwidgets.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1252,7 +1252,7 @@
     computeTicks();
     // Since we have disconnected autoupdate of scrollbars, we must do it ourselves
     if (myGanttView && myGanttView->myCanvasView)
-        myGanttView->myCanvasView->updateScrollBars();
+        myGanttView->myCanvasView->updateHorScrollBar();
 }
 
 
Index: kmail/snippet_widget.h
===================================================================
--- kmail/snippet_widget.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/snippet_widget.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,95 +0,0 @@
-/***************************************************************************
- *   snippet feature from kdevelop/plugins/snippet/                        *
- *                                                                         * 
- *   Copyright (C) 2007 by Robert Gruber                                   *
- *   rgruber@users.sourceforge.net                                         *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-#ifndef __SNIPPET_WIDGET_H__
-#define __SNIPPET_WIDGET_H__
-
-#include <qwidget.h>
-#include <qstring.h>
-#include <klistview.h>
-#include <qtooltip.h>
-#include <qrect.h>
-
-#include <ktexteditor/editinterface.h>
-#include <ktexteditor/view.h>
-#include "snippetconfig.h"
-
-class KDevProject;
-class SnippetPart;
-class QPushButton;
-class KListView;
-class QListViewItem;
-class QPoint;
-class SnippetDlg;
-class SnippetItem;
-class KTextEdit;
-class KConfig;
-class KMEdit;
-class KActionCollection;
-
-/**
-This is the widget which gets added to the right TreeToolView.
-It inherits KListView and QToolTip which is needed for showing the
-tooltips which contains the text of the snippet
-@author Robert Gruber
-*/
-class SnippetWidget : public KListView, public QToolTip
-{
-  Q_OBJECT
-
-public:
-    SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent = 0);
-    ~SnippetWidget();
-    QPtrList<SnippetItem> * getList() { return (&_list); }
-    void writeConfig();
-    SnippetConfig *  getSnippetConfig() { return (&_SnippetConfig); }
-
-
-private slots:
-    void initConfig();
-
-protected:
-    void maybeTip( const QPoint & );
-    bool acceptDrag (QDropEvent *event) const;
-
-private:
-    void insertIntoActiveView( const QString &text );
-    QString parseText(QString text, QString del="$");
-    bool showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
-                            int & iWidth, int & iBasicHeight, int & iOneHeight);
-    QString showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize);
-    SnippetItem* makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut );
-
-    QPtrList<SnippetItem> _list;
-    QMap<QString, QString> _mapSaved;
-    KConfig * _cfg;
-    SnippetConfig _SnippetConfig;
-    KMEdit* mEditor;
-    KActionCollection* mActionCollection;
-
-public slots:
-    void slotRemove();
-    void slotEdit( QListViewItem* item_ = 0 );
-    void slotEditGroup();
-    void slotAdd();
-    void slotAddGroup();
-    void slotExecute();
-
-protected slots:
-    void showPopupMenu( QListViewItem * item, const QPoint & p, int );
-    void slotExecuted(QListViewItem * item =  0);
-    void slotDropped(QDropEvent *e, QListViewItem *after);
-    void startDrag();
-};
-
-
-#endif
Index: kmail/snippet_widget.cpp
===================================================================
--- kmail/snippet_widget.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/snippet_widget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,957 +0,0 @@
-/***************************************************************************
- *   snippet feature from kdevelop/plugins/snippet/                        *
- *                                                                         * 
- *   Copyright (C) 2007 by Robert Gruber                                   *
- *   rgruber@users.sourceforge.net                                         *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- ***************************************************************************/
-
-#include <kurl.h>
-#include <kdebug.h>
-#include <klocale.h>
-#include <qlayout.h>
-#include <kpushbutton.h>
-#include <klistview.h>
-#include <qheader.h>
-#include <klineedit.h>
-#include <ktextedit.h>
-#include <kmessagebox.h>
-#include <kconfig.h>
-#include <qtooltip.h>
-#include <kpopupmenu.h>
-#include <qregexp.h>
-#include <qinputdialog.h>
-#include <qlabel.h>
-#include <qcheckbox.h>
-#include <qwhatsthis.h>
-#include <qdragobject.h>
-#include <qtimer.h>
-#include <kcombobox.h>
-#include <kmedit.h>
-#include <kiconloader.h>
-#include <kshortcut.h>
-#include <kaction.h>
-#include <kkeybutton.h>
-
-#include "snippetdlg.h"
-#include "snippetitem.h"
-#include "snippet_widget.h"
-
-#include <cassert>
-
-SnippetWidget::SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent)
-		: KListView(parent, "snippet widget"), QToolTip( viewport() ),
-		mEditor( editor ), mActionCollection( actionCollection )
-{
-    // init the QPtrList
-    _list.setAutoDelete(TRUE);
-
-    // init the KListView
-    setSorting( -1 );
-    addColumn( "" );
-    setFullWidth(true);
-    header()->hide();
-    setAcceptDrops(true);
-    setDragEnabled(true);
-    setDropVisualizer(false);
-    setRootIsDecorated(true);
-
-    //connect the signals
-    connect( this, SIGNAL( contextMenuRequested ( QListViewItem *, const QPoint & , int ) ),
-             this, SLOT( showPopupMenu(QListViewItem *, const QPoint & , int ) ) );
-
-    connect( this, SIGNAL( doubleClicked (QListViewItem *) ),
-             this, SLOT( slotEdit( QListViewItem *) ) );
-    connect( this, SIGNAL( returnPressed (QListViewItem *) ),
-             this, SLOT( slotExecuted( QListViewItem *) ) );
-
-    connect( this, SIGNAL( dropped(QDropEvent *, QListViewItem *) ),
-             this, SLOT( slotDropped(QDropEvent *, QListViewItem *) ) );
-
-    connect( editor, SIGNAL( insertSnippet() ), this, SLOT( slotExecute() ));
-
-    _cfg = 0;
-
-    QTimer::singleShot(0, this, SLOT(initConfig()));
-}
-
-SnippetWidget::~SnippetWidget()
-{
-  writeConfig();
-  delete _cfg;
-
-  /* We need to delete the child items before the parent items
-     otherwise KDevelop would crash on exiting */
-  SnippetItem * item;
-  while (_list.count() > 0) {
-    for (item=_list.first(); item; item=_list.next()) {
-      if (item->childCount() == 0)
-          _list.remove(item);
-    }
-  }
-}
-
-
-/*!
-    \fn SnippetWidget::slotAdd()
-    Opens the dialog to add a snippet
- */
-void SnippetWidget::slotAdd()
-{
-  //kdDebug(5006) << "Ender slotAdd()" << endl;
-  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
-
-  /*check if the user clicked a SnippetGroup
-    If not, we set the group variable to the SnippetGroup
-    which the selected item is a child of*/
-  SnippetGroup * group = dynamic_cast<SnippetGroup*>(selectedItem());
-  if ( !group && selectedItem() )
-    group = dynamic_cast<SnippetGroup*>(selectedItem()->parent());
-
-  /* still no group, let's make a default one */
-  if (!group ) {
-    if ( _list.isEmpty() ) {
-      group = new SnippetGroup(this, i18n("General"), SnippetGroup::getMaxId() );
-      _list.append( group );
-    } else {
-      group = dynamic_cast<SnippetGroup*>( _list.first() );
-    }
-  }
-  assert( group );
-
-  /*fill the combobox with the names of all SnippetGroup entries*/
-  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
-    if (dynamic_cast<SnippetGroup*>(it)) {
-      dlg.cbGroup->insertItem(it->getName());
-    }
-  }
-  dlg.cbGroup->setCurrentText(group->getName());
-
-  if (dlg.exec() == QDialog::Accepted) {
-      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
-      _list.append( makeItem( group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
-  }
-}
-
-/*!
-    \fn SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text )
-    Helper factory method.
- */
-SnippetItem* SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut )
-{
-    SnippetItem * item = new SnippetItem(parent, name, text);
-    const QString actionName = i18n("Snippet %1").arg(name);
-    const QString normalizedName = QString(actionName).replace(" ", "_");
-    if ( !mActionCollection->action(normalizedName.utf8() ) ) {
-        KAction * action = new KAction( actionName, shortcut, item,
-                                        SLOT( slotExecute() ), mActionCollection,
-                                        normalizedName.utf8() );
-        item->setAction(action);
-        connect( item, SIGNAL( execute( QListViewItem* ) ),
-                 this, SLOT( slotExecuted( QListViewItem* ) ) );
-    }
-    return item;
-}
-
-/*!
-    \fn SnippetWidget::slotAddGroup()
-    Opens the didalog to add a snippet
- */
-void SnippetWidget::slotAddGroup()
-{
-  //kdDebug(5006) << "Ender slotAddGroup()" << endl;
-  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
-  dlg.setShowShortcut( false );
-  dlg.snippetText->setEnabled(false);
-  dlg.snippetText->setText("GROUP");
-  dlg.setCaption(i18n("Add Group"));
-  dlg.cbGroup->insertItem(i18n("All"));
-  dlg.cbGroup->setCurrentText(i18n("All"));
-
-  if (dlg.exec() == QDialog::Accepted) {
-    _list.append( new SnippetGroup(this, dlg.snippetName->text(), SnippetGroup::getMaxId() ) );
-  }
-}
-
-
-/*!
-    \fn SnippetWidget::slotRemove()
-    Removes the selected snippet
- */
-void SnippetWidget::slotRemove()
-{
-  //get current data
-  QListViewItem * item = currentItem();
-  SnippetItem *snip = dynamic_cast<SnippetItem*>( item );
-  SnippetGroup *group = dynamic_cast<SnippetGroup*>( item );
-  if (!snip)
-    return;
-
-  if (group) {
-    if (group->childCount() > 0 &&
-        KMessageBox::warningContinueCancel(this, i18n("Do you really want to remove this group and all its snippets?"),QString::null,KStdGuiItem::del())
-        == KMessageBox::Cancel)
-      return;
-
-    SnippetItem *it=_list.first();
-    while ( it ) {
-      if (it->getParent() == group->getId()) {
-        SnippetItem *doomed = it;
-        it = _list.next();
-        //kdDebug(5006) << "remove " << doomed->getName() << endl;
-        _list.remove(doomed);
-      } else {
-        it = _list.next();
-      }
-    }
-  }
-
-  //kdDebug(5006) << "remove " << snip->getName() << endl;
-  _list.remove(snip);
-}
-
-
-
-/*!
-    \fn SnippetWidget::slotEdit()
-    Opens the dialog of editing the selected snippet
- */
-void SnippetWidget::slotEdit( QListViewItem* item )
-{
-    if( item == 0 ) {
-	item = currentItem();
-    }
-
-  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>(item);
-  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
-  if (!pSnippet || pGroup) /*selected item must be a SnippetItem but MUST not be a SnippetGroup*/
-    return;
-
-  //init the dialog
-  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
-  dlg.snippetName->setText(pSnippet->getName());
-  dlg.snippetText->setText(pSnippet->getText());
-  dlg.keyButton->setShortcut( pSnippet->getAction()->shortcut(), false );
-  dlg.btnAdd->setText(i18n("&Apply"));
-
-  dlg.setCaption(i18n("Edit Snippet"));
-  /*fill the combobox with the names of all SnippetGroup entries*/
-  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
-    if (dynamic_cast<SnippetGroup*>(it)) {
-      dlg.cbGroup->insertItem(it->getName());
-    }
-  }
-  dlg.cbGroup->setCurrentText(SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName());
-
-  if (dlg.exec() == QDialog::Accepted) {
-    //update the KListView and the SnippetItem
-    item->setText( 0, dlg.snippetName->text() );
-    pSnippet->setName( dlg.snippetName->text() );
-    pSnippet->setText( dlg.snippetText->text() );
-    pSnippet->getAction()->setShortcut( dlg.keyButton->shortcut());
-
-    /* if the user changed the parent we need to move the snippet */
-    if ( SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName() != dlg.cbGroup->currentText() ) {
-      SnippetGroup * newGroup = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
-      pSnippet->parent()->takeItem(pSnippet);
-      newGroup->insertItem(pSnippet);
-      pSnippet->resetParent();
-    }
-
-    setSelected(item, TRUE);
-  }
-}
-
-/*!
-    \fn SnippetWidget::slotEditGroup()
-    Opens the dialog of editing the selected snippet-group
- */
-void SnippetWidget::slotEditGroup()
-{
-  //get current data
-  QListViewItem * item = currentItem();
-
-  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>( item );
-  if (!pGroup) /*selected item MUST be a SnippetGroup*/
-    return;
-
-  //init the dialog
-  SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
-  dlg.setShowShortcut( false );
-  dlg.snippetName->setText(pGroup->getName());
-  dlg.snippetText->setText(pGroup->getText());
-  dlg.btnAdd->setText(i18n("&Apply"));
-  dlg.snippetText->setEnabled(FALSE);
-  dlg.setCaption(i18n("Edit Group"));
-  dlg.cbGroup->insertItem(i18n("All"));
-
-  if (dlg.exec() == QDialog::Accepted) {
-    //update the KListView and the SnippetGroup
-    item->setText( 0, dlg.snippetName->text() );
-    pGroup->setName( dlg.snippetName->text() );
-
-    setSelected(item, TRUE);
-  }
-}
-
-void SnippetWidget::slotExecuted(QListViewItem * item)
-{
-    if( item == 0 )
-    {
-	item = currentItem();
-    }
-
-  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
-  if (!pSnippet || dynamic_cast<SnippetGroup*>(item))
-      return;
-
-  //process variables if any, then insert into the active view
-  insertIntoActiveView( parseText(pSnippet->getText(), _SnippetConfig.getDelimiter()) );
-}
-
-
-/*!
-    \fn SnippetWidget::insertIntoActiveView(QString text)
-    Inserts the parameter text into the activ view
- */
-void SnippetWidget::insertIntoActiveView( const QString &text )
-{
-    mEditor->insert( text );
-}
-
-
-/*!
-    \fn SnippetWidget::writeConfig()
-    Write the cofig file
- */
-void SnippetWidget::writeConfig()
-{
-  if( !_cfg )
-    return;
-  _cfg->deleteGroup("SnippetPart");  //this is neccessary otherwise delete entries will stay in list until
-                                     //they get overwritten by a more recent entry
-  _cfg->setGroup("SnippetPart");
-
-  QString strKeyName="";
-  QString strKeyText="";
-  QString strKeyId="";
-
-  int iSnipCount = 0;
-  int iGroupCount = 0;
-
-  SnippetItem* item=_list.first();
-  while ( item != 0) {
-
-    //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
-    //kdDebug(5006) << "SnippetWidget::writeConfig() " << item->getName() << endl;
-    SnippetGroup * group = dynamic_cast<SnippetGroup*>(item);
-    if (group) {
-      //kdDebug(5006) << "-->GROUP " << item->getName() << group->getId() << " " << iGroupCount<< endl;
-      strKeyName=QString("snippetGroupName_%1").arg(iGroupCount);
-      strKeyId=QString("snippetGroupId_%1").arg(iGroupCount);
-
-      _cfg->writeEntry(strKeyName, group->getName());
-      _cfg->writeEntry(strKeyId, group->getId());
-
-      iGroupCount++;
-    } else if (dynamic_cast<SnippetItem*>(item)) {
-      //kdDebug(5006) << "-->ITEM " << item->getName() << item->getParent() << " " << iSnipCount << endl;
-      strKeyName=QString("snippetName_%1").arg(iSnipCount);
-      strKeyText=QString("snippetText_%1").arg(iSnipCount);
-      strKeyId=QString("snippetParent_%1").arg(iSnipCount);
-
-      _cfg->writeEntry(strKeyName, item->getName());
-      _cfg->writeEntry(strKeyText, item->getText());
-      _cfg->writeEntry(strKeyId, item->getParent());
-
-      KAction * action = item->getAction();
-      assert( action );
-      const KShortcut& sc = action->shortcut();
-      if (!sc.isNull() ) {
-          _cfg->writeEntry( QString("snippetShortcut_%1").arg(iSnipCount), sc.toString() );
-      }
-      iSnipCount++;
-    } else {
-      //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
-    }
-    item = _list.next();
-  }
-  _cfg->writeEntry("snippetCount", iSnipCount);
-  _cfg->writeEntry("snippetGroupCount", iGroupCount);
-
-  int iCount = 1;
-  QMap<QString, QString>::Iterator it;
-  for ( it = _mapSaved.begin(); it != _mapSaved.end(); ++it ) {  //write the saved variable values
-    if (it.data().length()<=0) continue;  //is the saved value has no length -> no need to save it
-
-    strKeyName=QString("snippetSavedName_%1").arg(iCount);
-    strKeyText=QString("snippetSavedVal_%1").arg(iCount);
-
-    _cfg->writeEntry(strKeyName, it.key());
-    _cfg->writeEntry(strKeyText, it.data());
-
-    iCount++;
-  }
-  _cfg->writeEntry("snippetSavedCount", iCount-1);
-
-
-  _cfg->writeEntry( "snippetDelimiter", _SnippetConfig.getDelimiter() );
-  _cfg->writeEntry( "snippetVarInput", _SnippetConfig.getInputMethod() );
-  _cfg->writeEntry( "snippetToolTips", _SnippetConfig.useToolTips() );
-  _cfg->writeEntry( "snippetGroupAutoOpen", _SnippetConfig.getAutoOpenGroups() );
-
-  _cfg->writeEntry("snippetSingleRect", _SnippetConfig.getSingleRect() );
-  _cfg->writeEntry("snippetMultiRect", _SnippetConfig.getMultiRect() );
-
-  _cfg->sync();
-}
-
-/*!
-    \fn SnippetWidget::initConfig()
-    Initial read the cofig file
- */
-void SnippetWidget::initConfig()
-{
-  if (_cfg == NULL)
-    _cfg = new KConfig("kmailsnippetrc", false, false);
-
-  _cfg->setGroup("SnippetPart");
-
-  QString strKeyName="";
-  QString strKeyText="";
-  QString strKeyId="";
-  SnippetItem *item;
-  SnippetGroup *group;
-
-  //kdDebug(5006) << "SnippetWidget::initConfig() " << endl;
-
-  //if entry doesn't get found, this will return -1 which we will need a bit later
-  int iCount = _cfg->readNumEntry("snippetGroupCount", -1);
-
-  for ( int i=0; i<iCount; i++) {  //read the group-list
-    strKeyName=QString("snippetGroupName_%1").arg(i);
-    strKeyId=QString("snippetGroupId_%1").arg(i);
-
-    QString strNameVal="";
-    int iIdVal=-1;
-
-    strNameVal = _cfg->readEntry(strKeyName, "");
-    iIdVal = _cfg->readNumEntry(strKeyId, -1);
-    //kdDebug(5006) << "Read group "  << " " << iIdVal << endl;
-
-    if (strNameVal != "" && iIdVal != -1) {
-      group = new SnippetGroup(this, strNameVal, iIdVal);
-      //kdDebug(5006) << "Created group " << group->getName() << " " << group->getId() << endl;
-      _list.append(group);
-    }
-  }
-
-  /* Check if the snippetGroupCount property has been found
-     if iCount is -1 this means, that the user has his snippets
-     stored without groups. Therefore we will call the
-     initConfigOldVersion() function below */
-  // should not happen since this function has been removed
-
-  if (iCount != -1) {
-    iCount = _cfg->readNumEntry("snippetCount", 0);
-    for ( int i=0; i<iCount; i++) {  //read the snippet-list
-        strKeyName=QString("snippetName_%1").arg(i);
-        strKeyText=QString("snippetText_%1").arg(i);
-        strKeyId=QString("snippetParent_%1").arg(i);
-
-        QString strNameVal="";
-        QString strTextVal="";
-        int iParentVal = -1;
-
-        strNameVal = _cfg->readEntry(strKeyName, "");
-        strTextVal = _cfg->readEntry(strKeyText, "");
-        iParentVal = _cfg->readNumEntry(strKeyId, -1);
-        //kdDebug(5006) << "Read item " << strNameVal << " " << iParentVal << endl;
-
-        if (strNameVal != "" && strTextVal != "" && iParentVal != -1) {
-            KShortcut shortcut( _cfg->readEntry( QString("snippetShortcut_%1").arg(i), QString() ) );
-            item = makeItem( SnippetItem::findGroupById(iParentVal, _list), strNameVal, strTextVal, shortcut );
-            //kdDebug(5006) << "Created item " << item->getName() << " " << item->getParent() << endl;
-            _list.append(item);
-        }
-    }
-  } else {
-      //kdDebug() << "iCount is not -1";
-  }
-
-  iCount = _cfg->readNumEntry("snippetSavedCount", 0);
-
-  for ( int i=1; i<=iCount; i++) {  //read the saved-values and store in QMap
-    strKeyName=QString("snippetSavedName_%1").arg(i);
-    strKeyText=QString("snippetSavedVal_%1").arg(i);
-
-    QString strNameVal="";
-    QString strTextVal="";
-
-    strNameVal = _cfg->readEntry(strKeyName, "");
-    strTextVal = _cfg->readEntry(strKeyText, "");
-
-    if (strNameVal != "" && strTextVal != "") {
-      _mapSaved[strNameVal] = strTextVal;
-    }
-  }
-
-
-  _SnippetConfig.setDelimiter( _cfg->readEntry("snippetDelimiter", "$") );
-  _SnippetConfig.setInputMethod( _cfg->readNumEntry("snippetVarInput", 0) );
-  _SnippetConfig.setToolTips( _cfg->readBoolEntry("snippetToolTips", true) );
-  _SnippetConfig.setAutoOpenGroups( _cfg->readNumEntry("snippetGroupAutoOpen", 1) );
-
-  _SnippetConfig.setSingleRect( _cfg->readRectEntry("snippetSingleRect", 0L) );
-  _SnippetConfig.setMultiRect( _cfg->readRectEntry("snippetMultiRect", 0L) );
-}
-
-/*!
-    \fn SnippetWidget::maybeTip( const QPoint & p )
-    Shows the Snippet-Text as ToolTip
- */
-void SnippetWidget::maybeTip( const QPoint & p )
-{
-	SnippetItem * item = dynamic_cast<SnippetItem*>( itemAt( p ) );
-	if (!item)
-	  return;
-
-	QRect r = itemRect( item );
-
-	if (r.isValid() &&
-        _SnippetConfig.useToolTips() )
-	{
-	    tip( r, item->getText() );  //show the snippet's text
-	}
-}
-
-/*!
-    \fn SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
-    Shows the Popup-Menu depending item is a valid pointer
-*/
-void SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
-{
-    KPopupMenu popup;
-
-    SnippetItem * selectedItem = static_cast<SnippetItem *>(item);
-    if ( item ) {
-        popup.insertTitle( selectedItem->getName() );
-        if (dynamic_cast<SnippetGroup*>(item)) {
-            popup.insertItem( i18n("Edit &group..."), this, SLOT( slotEditGroup() ) );
-        } else {
-            popup.insertItem( SmallIconSet("editpaste"), i18n("&Paste"), this, SLOT( slotExecuted() ) );
-            popup.insertItem( SmallIconSet("edit"), i18n("&Edit..."), this, SLOT( slotEdit() ) );
-        }
-        popup.insertItem( SmallIconSet("editdelete"), i18n("&Remove"), this, SLOT( slotRemove() ) );
-        popup.insertSeparator();
-    } else {
-        popup.insertTitle(i18n("Text Snippets"));
-    }
-    popup.insertItem( i18n("&Add Snippet..."), this, SLOT( slotAdd() ) );
-    popup.insertItem( i18n("Add G&roup..."), this, SLOT( slotAddGroup() ) );
-
-    popup.exec(p);
-}
-
-
-//  fn SnippetWidget::parseText(QString text, QString del)
-/*!
-    This function is used to parse the given QString for variables. If found the user will be prompted
-    for a replacement value. It returns the string text with all replacements made
- */
-QString SnippetWidget::parseText(QString text, QString del)
-{
-  QString str = text;
-  QString strName = "";
-  QString strNew = "";
-  QString strMsg="";
-  int iFound = -1;
-  int iEnd = -1;
-  QMap<QString, QString> mapVar;
-  int iInMeth = _SnippetConfig.getInputMethod();
-  QRect rSingle = _SnippetConfig.getSingleRect();
-  QRect rMulti = _SnippetConfig.getMultiRect();
-
-  do {
-    iFound = text.find(QRegExp("\\"+del+"[A-Za-z-_0-9\\s]*\\"+del), iEnd+1);  //find the next variable by this QRegExp
-    if (iFound >= 0) {
-      iEnd = text.find(del, iFound+1)+1;
-      strName = text.mid(iFound, iEnd-iFound);
-
-      if ( strName != del+del  ) {  //if not doubel-delimiter
-        if (iInMeth == 0) { //if input-method "single" is selected
-          if ( mapVar[strName].length() <= 0 ) {  // and not already in map
-            strMsg=i18n("Please enter the value for <b>%1</b>:").arg(strName);
-            strNew = showSingleVarDialog( strName, &_mapSaved, rSingle );
-            if (strNew=="")
-              return ""; //user clicked Cancle
-          } else {
-            continue; //we have already handled this variable
-          }
-        } else {
-          strNew = ""; //for inputmode "multi" just reset new valaue
-        }
-      } else {
-        strNew = del; //if double-delimiter -> replace by single character
-      }
-
-      if (iInMeth == 0) {  //if input-method "single" is selected
-        str.replace(strName, strNew);
-      }
-
-      mapVar[strName] = strNew;
-    }
-  } while (iFound != -1);
-
-  if (iInMeth == 1) {  //check config, if input-method "multi" is selected
-    int w, bh, oh;
-    w = rMulti.width();
-    bh = rMulti.height();
-    oh = rMulti.top();
-    if (showMultiVarDialog( &mapVar, &_mapSaved, w, bh, oh )) {  //generate and show the dialog
-      QMap<QString, QString>::Iterator it;
-      for ( it = mapVar.begin(); it != mapVar.end(); ++it ) {  //walk through the map and do the replacement
-        str.replace(it.key(), it.data());
-      }
-    } else {
-      return "";
-    }
-
-    rMulti.setWidth(w);   //this is a hack to save the dialog's dimensions in only one QRect
-    rMulti.setHeight(bh);
-    rMulti.setTop(oh);
-    rMulti.setLeft(0);
-     _SnippetConfig.setMultiRect(rMulti);
-  }
-
-  _SnippetConfig.setSingleRect(rSingle);
-
-  return str;
-}
-
-
-//  fn SnippetWidget::showMultiVarDialog()
-/*!
-    This function constructs a dialog which contains a label and a linedit for every
-    variable that is stored in the given map except the double-delimiter entry
-    It return true if everything was ok and false if the user hit cancel
- */
-bool SnippetWidget::showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
-                                       int & iWidth, int & iBasicHeight, int & iOneHeight)
-{
-  //if no var -> no need to show
-  if (map->count() == 0)
-    return true;
-
-  //if only var is the double-delimiter -> no need to show
-  QMap<QString, QString>::Iterator it = map->begin();
-  if ( map->count() == 1 && it.data()==_SnippetConfig.getDelimiter()+_SnippetConfig.getDelimiter() )
-    return true;
-
-  QMap<QString, KTextEdit *> mapVar2Te;  //this map will help keeping track which TEXTEDIT goes with which variable
-  QMap<QString, QCheckBox *> mapVar2Cb;  //this map will help keeping track which CHECKBOX goes with which variable
-
-  // --BEGIN-- building a dynamic dialog
-  QDialog dlg(this);
-  dlg.setCaption(i18n("Enter Values for Variables"));
-
-  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
-  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
-  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
-  QGridLayout * layoutBtn = new QGridLayout( 0, 1, 1, 0, 6, "layoutBtn");
-
-  KTextEdit *te = NULL;
-  QLabel * labTop = NULL;
-  QCheckBox * cb = NULL;
-
-  labTop = new QLabel( &dlg, "label" );
-  labTop->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
-                         labTop->sizePolicy().hasHeightForWidth() ) );
-  labTop->setText(i18n("Enter the replacement values for these variables:"));
-  layoutTop->addWidget(labTop, 0, 0);
-  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
-
-
-  int i = 0;                                           //walk through the variable map and add
-  for ( it = map->begin(); it != map->end(); ++it ) {  //a checkbox, a lable and a lineedit to the main layout
-    if (it.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
-      continue;
-
-    cb = new QCheckBox( &dlg, "cbVar" );
-    cb->setChecked( FALSE );
-    cb->setText(it.key());
-    layoutVar->addWidget( cb, i ,0, Qt::AlignTop );
-
-    te = new KTextEdit( &dlg, "teVar" );
-    layoutVar->addWidget( te, i, 1, Qt::AlignTop );
-
-    if ((*mapSave)[it.key()].length() > 0) {
-      cb->setChecked( TRUE );
-      te->setText((*mapSave)[it.key()]);
-    }
-
-    mapVar2Te[it.key()] = te;
-    mapVar2Cb[it.key()] = cb;
-
-    QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
-    QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
-                              "If you use the same variable later, even in another snippet, the value entered to the right "
-			      "will be the default value for that variable.") );
-
-    i++;
-  }
-  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
-
-  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
-  btn1->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
-                         btn1->sizePolicy().hasHeightForWidth() ) );
-  layoutBtn->addWidget( btn1, 0, 0 );
-
-  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
-  btn2->setDefault( TRUE );
-  btn2->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
-                         btn2->sizePolicy().hasHeightForWidth() ) );
-  layoutBtn->addWidget( btn2, 0, 1 );
-
-  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
-  // --END-- building a dynamic dialog
-
-  //connect the buttons to the QDialog default slots
-  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
-  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
-
-  //prepare to execute the dialog
-  bool bReturn = false;
-  //resize the textedits
-  if (iWidth > 1) {
-    QRect r = dlg.geometry();
-    r.setHeight(iBasicHeight + iOneHeight*mapVar2Te.count());
-    r.setWidth(iWidth);
-    dlg.setGeometry(r);
-  }
-  if ( i > 0 && // only if there are any variables
-    dlg.exec() == QDialog::Accepted ) {
-
-    QMap<QString, KTextEdit *>::Iterator it2;
-    for ( it2 = mapVar2Te.begin(); it2 != mapVar2Te.end(); ++it2 ) {
-      if (it2.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
-        continue;
-      (*map)[it2.key()] = it2.data()->text();    //copy the entered values back to the given map
-
-      if (mapVar2Cb[it2.key()]->isChecked())     //if the checkbox is on; save the values for later
-        (*mapSave)[it2.key()] = it2.data()->text();
-      else
-        (*mapSave).erase(it2.key());
-    }
-    bReturn = true;
-
-    iBasicHeight = dlg.geometry().height() - layoutVar->geometry().height();
-    iOneHeight = layoutVar->geometry().height() / mapVar2Te.count();
-    iWidth = dlg.geometry().width();
-  }
-
-  //do some cleanup
-  QMap<QString, KTextEdit *>::Iterator it1;
-  for (it1 = mapVar2Te.begin(); it1 != mapVar2Te.end(); ++it1)
-    delete it1.data();
-  mapVar2Te.clear();
-  QMap<QString, QCheckBox *>::Iterator it2;
-  for (it2 = mapVar2Cb.begin(); it2 != mapVar2Cb.end(); ++it2)
-    delete it2.data();
-  mapVar2Cb.clear();
-  delete layoutTop;
-  delete layoutVar;
-  delete layoutBtn;
-  delete layout;
-
-  if (i==0) //if nothing happened this means, that there are no variables to translate
-    return true; //.. so just return OK
-
-  return bReturn;
-//  return true;
-}
-
-
-//  fn SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave)
-/*!
-    This function constructs a dialog which contains a label and a linedit for the given variable
-    It return either the entered value or an empty string if the user hit cancel
- */
-QString SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize)
-{
-  // --BEGIN-- building a dynamic dialog
-  QDialog dlg(this);
-  dlg.setCaption(i18n("Enter Values for Variables"));
-
-  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
-  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
-  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
-  QGridLayout * layoutBtn = new QGridLayout( 0, 2, 1, 0, 6, "layoutBtn");
-
-  KTextEdit *te = NULL;
-  QLabel * labTop = NULL;
-  QCheckBox * cb = NULL;
-
-  labTop = new QLabel( &dlg, "label" );
-  layoutTop->addWidget(labTop, 0, 0);
-  labTop->setText(i18n("Enter the replacement values for %1:").arg( var ));
-  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
-
-
-  cb = new QCheckBox( &dlg, "cbVar" );
-  cb->setChecked( FALSE );
-  cb->setText(i18n( "Make value &default" ));
-
-  te = new KTextEdit( &dlg, "teVar" );
-  layoutVar->addWidget( te, 0, 1, Qt::AlignTop);
-  layoutVar->addWidget( cb, 1, 1, Qt::AlignTop);
-  if ((*mapSave)[var].length() > 0) {
-    cb->setChecked( TRUE );
-    te->setText((*mapSave)[var]);
-  }
-
-  QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
-  QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
-                            "If you use the same variable later, even in another snippet, the value entered to the right "
-                            "will be the default value for that variable.") );
-
-  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
-
-  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
-  layoutBtn->addWidget( btn1, 0, 0 );
-
-  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
-  btn2->setDefault( TRUE );
-  layoutBtn->addWidget( btn2, 0, 1 );
-
-  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
-  te->setFocus();
-  // --END-- building a dynamic dialog
-
-  //connect the buttons to the QDialog default slots
-  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
-  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
-
-  //execute the dialog
-  QString strReturn = "";
-  if (dlgSize.isValid())
-    dlg.setGeometry(dlgSize);
-  if ( dlg.exec() == QDialog::Accepted ) {
-    if (cb->isChecked())     //if the checkbox is on; save the values for later
-      (*mapSave)[var] = te->text();
-    else
-      (*mapSave).erase(var);
-
-    strReturn = te->text();    //copy the entered values back the the given map
-
-    dlgSize = dlg.geometry();
-  }
-
-  //do some cleanup
-  delete cb;
-  delete te;
-  delete labTop;
-  delete btn1;
-  delete btn2;
-  delete layoutTop;
-  delete layoutVar;
-  delete layoutBtn;
-  delete layout;
-
-  return strReturn;
-}
-
-//  fn SnippetWidget::acceptDrag (QDropEvent *event) const
-/*!
-    Reimplementation from KListView.
-    Check here if the data the user is about to drop fits our restrictions.
-    We only accept dropps of plaintext, because from the dropped text
-    we will create a snippet.
- */
-bool SnippetWidget::acceptDrag (QDropEvent *event) const
-{
-  //kdDebug(5006) << "Format: " << event->format() << "" << event->pos() << endl;
-
-  QListViewItem * item = itemAt(event->pos());
-
-  if (item &&
-      QString(event->format()).startsWith("text/plain") &&
-      static_cast<SnippetWidget *>(event->source()) != this) {
-    ///kdDebug(5006) << "returning TRUE " << endl;
-    return TRUE;
-  } else if(item &&
-      QString(event->format()).startsWith("x-kmailsnippet") &&
-      static_cast<SnippetWidget *>(event->source()) != this)
-  {
-    //kdDebug(5006) << "returning TRUE " << endl;
-    return TRUE;
-  } else {
-    //kdDebug(5006) << "returning FALSE" << endl;
-    event->acceptAction(FALSE);
-    return FALSE;
-  }
-}
-
-//  fn SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *after)
-/*!
-    This slot is connected to the dropped signal.
-    If it is emitted, we need to construct a new snippet entry with
-    the data given
- */
-void SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *)
-{
-  QListViewItem * item2 = itemAt(e->pos());
-
-  SnippetGroup *group = dynamic_cast<SnippetGroup *>(item2);
-  if (!group)
-    group = dynamic_cast<SnippetGroup *>(item2->parent());
-
-  QCString dropped;
-  QByteArray data = e->encodedData("text/plain");
-  if ( e->provides("text/plain") && data.size()>0 ) {
-    //get the data from the event...
-    QString encData(data.data());
-    //kdDebug(5006) << "encData: " << encData << endl;
-
-    //... then fill the dialog with the given data
-    SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
-    dlg.snippetName->clear();
-    dlg.snippetText->setText(encData);
-
-    /*fill the combobox with the names of all SnippetGroup entries*/
-    for (SnippetItem *it=_list.first(); it; it=_list.next()) {
-      if (dynamic_cast<SnippetGroup*>(it)) {
-        dlg.cbGroup->insertItem(it->getName());
-      }
-    }
-    dlg.cbGroup->setCurrentText(group->getName());
-
-    if (dlg.exec() == QDialog::Accepted) {
-      /* get the group that the user selected with the combobox */
-      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
-      _list.append( makeItem(group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
-    }
-  }
-}
-
-void SnippetWidget::startDrag()
-{
-    QString text = dynamic_cast<SnippetItem*>( currentItem() )->getText();
-    QTextDrag *drag = new QTextDrag(text, this);
-    drag->setSubtype("x-textsnippet");
-    drag->drag();
-}
-
-void SnippetWidget::slotExecute()
-{
-    slotExecuted(currentItem());
-}
-
-
-#include "snippet_widget.moc"
-
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1301,7 +1301,8 @@
 
     // French
     folderNames[2][KFolderTreeItem::Calendar] = QString::fromLatin1("Calendrier");
-    folderNames[2][KFolderTreeItem::Tasks] = QString::fromLatin1("Tâches");
+    // Tasks = Tâches (â == 0xE2 in latin1)
+    folderNames[2][KFolderTreeItem::Tasks] = QString::fromLatin1("T\342ches");
     folderNames[2][KFolderTreeItem::Journals] = QString::fromLatin1("Journal");
     folderNames[2][KFolderTreeItem::Contacts] = QString::fromLatin1("Contacts");
     folderNames[2][KFolderTreeItem::Notes] = QString::fromLatin1("Notes");
Index: kmail/encodingdetector.h
===================================================================
--- kmail/encodingdetector.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/encodingdetector.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,166 @@
+/*
+    This file was taken from the KDE 4.x libraries and backported to Qt 3.
+
+    Copyright (C) 1999 Lars Knoll (knoll@mpi-hd.mpg.de)
+    Copyright (C) 2007 Nick Shaforostoff (shafff@ukr.net)
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+*/
+#ifndef ENCODINGDETECTOR_H
+#define ENCODINGDETECTOR_H
+
+#include <qstring.h>
+
+class QTextCodec;
+class QTextDecoder;
+class EncodingDetectorPrivate;
+
+/**
+ * @short Provides encoding detection capabilities.
+ *
+ * Searches for encoding declaration inside raw data -- meta and xml tags. 
+ * In the case it can't find it, uses heuristics for specified language.
+ *
+ * If it finds unicode BOM marks, it changes encoding regardless of what the user has told
+ *
+ * Intended lifetime of the object: one instance per document.
+ *
+ * Typical use:
+ * \code
+ * QByteArray data;
+ * ...
+ * EncodingDetector detector;
+ * detector.setAutoDetectLanguage(EncodingDetector::Cyrillic);
+ * QString out=detector.decode(data);
+ * \endcode
+ *
+ *
+ * Do not mix decode() with decodeWithBuffering()
+ *
+ * @short Guess encoding of char array
+ *
+ */
+class EncodingDetector
+{
+public:
+    enum EncodingChoiceSource
+    {
+        DefaultEncoding,
+        AutoDetectedEncoding,
+        BOM,
+        EncodingFromXMLHeader,
+        EncodingFromMetaTag,
+        EncodingFromHTTPHeader,
+        UserChosenEncoding
+    };
+
+    enum AutoDetectScript
+    {
+        None,
+        SemiautomaticDetection,
+        Arabic,
+        Baltic,
+        CentralEuropean,
+        ChineseSimplified,
+        ChineseTraditional,
+        Cyrillic,
+        Greek,
+        Hebrew,
+        Japanese,
+        Korean,
+        NorthernSaami,
+        SouthEasternEurope,
+        Thai,
+        Turkish,
+        Unicode,
+        WesternEuropean
+    };
+
+    /**
+     * Default codec is latin1 (as html spec says), EncodingChoiceSource is default, AutoDetectScript=Semiautomatic
+     */
+    EncodingDetector();
+
+    /**
+     * Allows to set Default codec, EncodingChoiceSource, AutoDetectScript
+     */
+    EncodingDetector(QTextCodec* codec, EncodingChoiceSource source, AutoDetectScript script=None);
+    ~EncodingDetector();
+
+    //const QTextCodec* codec() const;
+
+    /**
+    * @returns true if specified encoding was recognized
+    */
+    bool setEncoding(const char *encoding, EncodingChoiceSource type);
+
+    /**
+    * Convenience method.
+    * @returns mime name of detected encoding
+    */
+    const char* encoding() const;
+
+    bool visuallyOrdered() const;
+
+//     void setAutoDetectLanguage( const QString& );
+//     const QString& autoDetectLanguage() const;
+
+    void setAutoDetectLanguage( AutoDetectScript );
+    AutoDetectScript autoDetectLanguage() const;
+
+    EncodingChoiceSource encodingChoiceSource() const;
+
+    /**
+    * Analyze text data.
+    * @returns true if there was enough data for accurate detection
+    */
+    bool analyze( const char *data, int len );
+
+    /**
+    * Analyze text data.
+    * @returns true if there was enough data for accurate detection
+    */
+    bool analyze( const QByteArray &data );
+
+    /**
+     * Takes lang name _after_ it were i18n()'ed
+     */
+    static AutoDetectScript scriptForName(const QString& lang);
+    static QString nameForScript(AutoDetectScript);
+    static AutoDetectScript scriptForLanguageCode(const QString &lang);
+    static bool hasAutoDetectionForScript(AutoDetectScript);
+
+protected:
+    /**
+     * Check if we are really utf8. Taken from kate
+     *
+     * @returns true if current encoding is utf8 and the text cannot be in this encoding
+     *
+     * Please somebody read http://de.wikipedia.org/wiki/UTF-8 and check this code...
+     */
+    bool errorsIfUtf8 (const char* data, int length);
+
+    /**
+    * @returns QTextDecoder for detected encoding
+    */
+    QTextDecoder* decoder();
+
+private:
+    EncodingDetectorPrivate* const d;
+};
+
+#endif
Index: kmail/kmmessage.h
===================================================================
--- kmail/kmmessage.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmmessage.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -627,9 +627,6 @@
   /** Delete all body parts. */
   void deleteBodyParts();
 
-  /** Removes the given body part. */
-  void removeBodyPart( DwBodyPart * dwPart );
-
   /** Set "Status" and "X-Status" fields of the message from the
    * internal message status. */
   void setStatusFields();
Index: kmail/newfolderdialog.cpp
===================================================================
--- kmail/newfolderdialog.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/newfolderdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -148,7 +148,7 @@
     }
     if ( mFolder->folderType() == KMFolderTypeCachedImap ) {
       ImapAccountBase* ai = static_cast<KMFolderCachedImap*>(mFolder->storage())->account();
-      if ( mFolder->storage() == ai->rootFolder() ) {
+      if ( ai && mFolder->storage() == ai->rootFolder() ) {
         rootFolder = true;
         namespaces = ai->namespaces()[ImapAccountBase::PersonalNS];
       }
@@ -212,10 +212,12 @@
     QString delimiter;
     if ( mFolder->folderType() == KMFolderTypeImap ) {
       KMAcctImap* ai = static_cast<KMFolderImap*>( mFolder->storage() )->account();
-      delimiter = ai->delimiterForFolder( mFolder->storage() );
+      if ( ai )
+        delimiter = ai->delimiterForFolder( mFolder->storage() );
     } else {
       KMAcctCachedImap* ai = static_cast<KMFolderCachedImap*>( mFolder->storage() )->account();
-      delimiter = ai->delimiterForFolder( mFolder->storage() );
+      if ( ai )
+        delimiter = ai->delimiterForFolder( mFolder->storage() );
     }
     if ( !delimiter.isEmpty() && fldName.find( delimiter ) != -1 ) {
       KMessageBox::error( this, i18n( "Your IMAP server does not allow the character '%1'; please choose another folder name." ).arg( delimiter ) );
Index: kmail/kmreadermainwin.cpp
===================================================================
--- kmail/kmreadermainwin.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmreadermainwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -496,6 +496,7 @@
   f.setFamily( font );
   mReaderWin->cssHelper()->setBodyFont( f );
   mReaderWin->cssHelper()->setPrintFont( f );
+  mReaderWin->saveRelativePosition();
   mReaderWin->update();
 }
 
@@ -505,6 +506,7 @@
   f.setPointSize( size );
   mReaderWin->cssHelper()->setBodyFont( f );
   mReaderWin->cssHelper()->setPrintFont( f );
+  mReaderWin->saveRelativePosition();
   mReaderWin->update();
 }
 
Index: kmail/encodingdetector_ja_p.h
===================================================================
--- kmail/encodingdetector_ja_p.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/encodingdetector_ja_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,126 @@
+/*
+ * This file is part of the KDE libraries
+ *
+ * Copyright 2000-2003 Shiro Kawai <shiro@acm.org>, All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ *  1. Redistributions of source code must retain the above copyright
+ *     notice, this list of conditions and the following disclaimer.
+ *
+ *  2. Redistributions in binary form must reproduce the above copyright
+ *     notice, this list of conditions and the following disclaimer in the
+ *     documentation and/or other materials provided with the distribution.
+ *
+ *  3. Neither the name of the authors nor the names of its contributors
+ *     may be used to endorse or promote products derived from this
+ *     software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+ * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+ * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+ * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ */
+/*
+ * original code is here.
+ * http://cvs.sourceforge.net/viewcvs.py/gauche/Gauche/ext/charconv/guess.c?view=markup
+ */
+#ifndef GUESS_JA_H
+#define GUESS_JA_H
+
+#include <qglobal.h>
+#ifdef Q_WS_WIN
+#undef UNICODE
+#endif 
+namespace khtml {
+    class guess_arc {
+    public:
+        unsigned int next;          /* next state */
+        double score;               /* score */
+    };
+}
+
+using namespace khtml;
+
+typedef signed char dfa_table[256];
+
+/* DFA tables declared in guess_ja.cpp */
+extern const dfa_table guess_eucj_st[];
+extern guess_arc guess_eucj_ar[7];
+extern const dfa_table guess_sjis_st[];
+extern guess_arc guess_sjis_ar[6];
+extern const dfa_table guess_utf8_st[];
+extern guess_arc guess_utf8_ar[11];
+
+namespace khtml {
+
+    class guess_dfa {
+    public:
+        const dfa_table *states;
+        const guess_arc *arcs;
+        int state;
+        double score;
+
+        guess_dfa (const dfa_table stable[], const guess_arc *atable) :
+            states(stable), arcs(atable)
+        {
+            state = 0;
+            score = 1.0;
+        }
+    };
+
+    class JapaneseCode
+    {
+    public:
+        enum Type {ASCII, JIS, EUC, SJIS, UNICODE, UTF8 };
+        enum Type guess_jp(const char* buf, int buflen);
+
+        JapaneseCode () {
+            eucj = new guess_dfa(guess_eucj_st, guess_eucj_ar);
+            sjis = new guess_dfa(guess_sjis_st, guess_sjis_ar);
+            utf8 = new guess_dfa(guess_utf8_st, guess_utf8_ar);
+            last_JIS_escape = false;
+        }
+
+        ~JapaneseCode () {
+            if (eucj) delete eucj;
+            if (sjis) delete sjis;
+            if (utf8) delete utf8;
+        }
+
+    protected:
+        guess_dfa *eucj;
+        guess_dfa *sjis;
+        guess_dfa *utf8;
+
+        bool last_JIS_escape;
+    };
+}
+
+#define DFA_NEXT(dfa, ch)                               \
+    do {                                                \
+        int arc__;                                      \
+        if (dfa->state >= 0) {                          \
+            arc__ = dfa->states[dfa->state][ch];        \
+            if (arc__ < 0) {                            \
+                dfa->state = -1;                        \
+            } else {                                    \
+                dfa->state = dfa->arcs[arc__].next;     \
+                dfa->score *= dfa->arcs[arc__].score;   \
+            }                                           \
+        }                                               \
+    } while (0)
+
+#define DFA_ALIVE(dfa)  (dfa->state >= 0)
+
+#endif  /* GUESS_JA_H */
Index: kmail/Makefile.am
===================================================================
--- kmail/Makefile.am	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -69,7 +69,8 @@
                 kmsystemtray.cpp kmacctlocal.cpp kmfolderdir.cpp \
                 kmfoldermgr.cpp kmfoldernode.cpp kmsender.cpp \
                 kmacctseldlg.cpp kmfiltermgr.cpp kmsearchpatternedit.cpp \
-		filterimporterexporter.cpp \
+                filterimporterexporter.cpp \
+                encodingdetector.cpp encodingdetector_ja.cpp \
                 kmfilteraction.cpp kmsearchpattern.cpp \
                 kmfolderseldlg.cpp kmfilter.cpp kmfilterdlg.cpp \
                 kmmsgbase.cpp kmmsglist.cpp kmaddrbook.cpp  \
@@ -141,7 +142,7 @@
                 favoritefolderview.cpp \
                 foldertreebase.cpp \
                 snippetdlgbase.ui \
-                snippet_widget.cpp \
+                snippetwidget.cpp \
                 snippetconfig.cpp \
                 snippetdlg.cpp \
                 snippetitem.cpp \
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -764,10 +764,9 @@
 void KMReaderWin::slotLevelQuote( int l )
 {
   kdDebug( 5006 ) << "Old Level: " << mLevelQuote << " New Level: " << l << endl;
-	mLevelQuote = l;
-  QScrollView * scrollview = static_cast<QScrollView *>(mViewer->widget());
-  mSavedRelativePosition = (float)scrollview->contentsY() / scrollview->contentsHeight();
 
+  mLevelQuote = l;
+  saveRelativePosition();
   update(true);
 }
 
@@ -1461,7 +1460,8 @@
   if (mSavedRelativePosition)
   {
     QScrollView * scrollview = static_cast<QScrollView *>(mViewer->widget());
-    scrollview->setContentsPos ( 0, qRound(  scrollview->contentsHeight() * mSavedRelativePosition ) );
+    scrollview->setContentsPos( 0,
+      qRound( scrollview->contentsHeight() * mSavedRelativePosition ) );
     mSavedRelativePosition = 0;
   }
 }
@@ -2049,10 +2049,8 @@
 //-----------------------------------------------------------------------------
 void KMReaderWin::slotToggleFixedFont()
 {
-  QScrollView * scrollview = static_cast<QScrollView *>(mViewer->widget());
-  mSavedRelativePosition = (float)scrollview->contentsY() / scrollview->contentsHeight();
-
   mUseFixedFont = !mUseFixedFont;
+  saveRelativePosition();
   update(true);
 }
 
@@ -2419,6 +2417,15 @@
 
 
 //-----------------------------------------------------------------------------
+void KMReaderWin::saveRelativePosition()
+{
+  const QScrollView * scrollview = static_cast<QScrollView *>( mViewer->widget() );
+  mSavedRelativePosition =
+    static_cast<float>( scrollview->contentsY() ) / scrollview->contentsHeight();
+}
+
+
+//-----------------------------------------------------------------------------
 void KMReaderWin::update( bool force )
 {
   KMMessage* msg = message();
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmmessage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -3126,12 +3126,6 @@
   mMsg->Body().DeleteBodyParts();
 }
 
-void KMMessage::removeBodyPart(DwBodyPart * dwPart)
-{
-  mMsg->Body().RemoveBodyPart( dwPart );
-  mNeedsAssembly = true;
-}
-
 //-----------------------------------------------------------------------------
 DwBodyPart* KMMessage::createDWBodyPart(const KMMessagePart* aPart)
 {
Index: kmail/snippetwidget.h
===================================================================
--- kmail/snippetwidget.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/snippetwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,95 @@
+/***************************************************************************
+ *   snippet feature from kdevelop/plugins/snippet/                        *
+ *                                                                         * 
+ *   Copyright (C) 2007 by Robert Gruber                                   *
+ *   rgruber@users.sourceforge.net                                         *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+#ifndef __SNIPPET_WIDGET_H__
+#define __SNIPPET_WIDGET_H__
+
+#include <qwidget.h>
+#include <qstring.h>
+#include <klistview.h>
+#include <qtooltip.h>
+#include <qrect.h>
+
+#include <ktexteditor/editinterface.h>
+#include <ktexteditor/view.h>
+#include "snippetconfig.h"
+
+class KDevProject;
+class SnippetPart;
+class QPushButton;
+class KListView;
+class QListViewItem;
+class QPoint;
+class SnippetDlg;
+class SnippetItem;
+class KTextEdit;
+class KConfig;
+class KMEdit;
+class KActionCollection;
+
+/**
+This is the widget which gets added to the right TreeToolView.
+It inherits KListView and QToolTip which is needed for showing the
+tooltips which contains the text of the snippet
+@author Robert Gruber
+*/
+class SnippetWidget : public KListView, public QToolTip
+{
+  Q_OBJECT
+
+public:
+    SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent = 0);
+    ~SnippetWidget();
+    QPtrList<SnippetItem> * getList() { return (&_list); }
+    void writeConfig();
+    SnippetConfig *  getSnippetConfig() { return (&_SnippetConfig); }
+
+
+private slots:
+    void initConfig();
+
+protected:
+    void maybeTip( const QPoint & );
+    bool acceptDrag (QDropEvent *event) const;
+
+private:
+    void insertIntoActiveView( const QString &text );
+    QString parseText(QString text, QString del="$");
+    bool showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
+                            int & iWidth, int & iBasicHeight, int & iOneHeight);
+    QString showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize);
+    SnippetItem* makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut );
+
+    QPtrList<SnippetItem> _list;
+    QMap<QString, QString> _mapSaved;
+    KConfig * _cfg;
+    SnippetConfig _SnippetConfig;
+    KMEdit* mEditor;
+    KActionCollection* mActionCollection;
+
+public slots:
+    void slotRemove();
+    void slotEdit( QListViewItem* item_ = 0 );
+    void slotEditGroup();
+    void slotAdd();
+    void slotAddGroup();
+    void slotExecute();
+
+protected slots:
+    void showPopupMenu( QListViewItem * item, const QPoint & p, int );
+    void slotExecuted(QListViewItem * item =  0);
+    void slotDropped(QDropEvent *e, QListViewItem *after);
+    void startDrag();
+};
+
+
+#endif
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/messageactions.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -70,7 +70,7 @@
     this, SLOT(slotNoQuoteReplyToMsg()), mActionCollection, "noquotereply" );
 
 
-  mCreateTodoAction = new KAction( i18n("Create Task..."), "mail_todo",
+  mCreateTodoAction = new KAction( i18n("Create Task/Reminder..."), "mail_todo",
                                    0, this, SLOT(slotCreateTodo()), mActionCollection,
                                    "create_todo" );
 
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -3369,7 +3369,29 @@
   deleteLater();
 }
 
+DwBodyPart * AttachmentModifyCommand::findPart(KMMessage* msg, int index)
+{
+  int accu = 0;
+  return findPartInternal( msg->getTopLevelPart(), index, accu );
+}
 
+DwBodyPart * AttachmentModifyCommand::findPartInternal(DwEntity * root, int index, int & accu)
+{
+  accu++;
+  if ( index < accu ) // should not happen
+    return 0;
+  DwBodyPart *current = dynamic_cast<DwBodyPart*>( root );
+  if ( index == accu )
+    return current;
+  DwBodyPart *rv = 0;
+  if ( root->Body().FirstBodyPart() )
+    rv = findPartInternal( root->Body().FirstBodyPart(), index, accu );
+  if ( !rv && current && current->Next() )
+    rv = findPartInternal( current->Next(), index, accu );
+  return rv;
+}
+
+
 KMDeleteAttachmentCommand::KMDeleteAttachmentCommand(partNode * node, KMMessage * msg, QWidget * parent) :
     AttachmentModifyCommand( node, msg, parent )
 {
@@ -3385,15 +3407,18 @@
 {
   KMMessage *msg = retrievedMessage();
   KMMessagePart part;
-  // -2 because partNode counts root and body of the message as well
-  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  DwBodyPart *dwpart = findPart( msg, mPartIndex );
   if ( !dwpart )
     return Failed;
   KMMessage::bodyPart( dwpart, &part, true );
   if ( !part.isComplete() )
      return Failed;
-  msg->removeBodyPart( dwpart );
 
+  DwBody *parentNode = dynamic_cast<DwBody*>( dwpart->Parent() );
+  if ( !parentNode )
+    return Failed;
+  parentNode->RemoveBodyPart( dwpart );
+
   // add dummy part to show that a attachment has been deleted
   KMMessagePart dummyPart;
   dummyPart.duplicate( part );
@@ -3409,7 +3434,9 @@
   } else if ( cd.isEmpty() ) {
     dummyPart.setContentDisposition( "attachment" );
   }
-  msg->addBodyPart( &dummyPart );
+  DwBodyPart* newDwPart = msg->createDWBodyPart( &dummyPart );
+  parentNode->AddBodyPart( newDwPart );
+  msg->getTopLevelPart()->Assemble();
 
   KMMessage *newMsg = new KMMessage();
   newMsg->fromDwString( msg->asDwString() );
@@ -3435,14 +3462,16 @@
 {
   KMMessage *msg = retrievedMessage();
   KMMessagePart part;
-  // -2 because partNode counts root and body of the message as well
-  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  DwBodyPart *dwpart = findPart( msg, mPartIndex );
   if ( !dwpart )
     return Failed;
   KMMessage::bodyPart( dwpart, &part, true );
   if ( !part.isComplete() )
      return Failed;
 
+  if( !dynamic_cast<DwBody*>( dwpart->Parent() ) )
+    return Failed;
+
   mTempFile.file()->writeBlock( part.bodyDecodedBinary() );
   mTempFile.file()->flush();
 
@@ -3472,16 +3501,21 @@
   // build the new message
   KMMessage *msg = retrievedMessage();
   KMMessagePart part;
-  // -2 because partNode counts root and body of the message as well
-  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  DwBodyPart *dwpart = findPart( msg, mPartIndex );
   KMMessage::bodyPart( dwpart, &part, true );
-  msg->removeBodyPart( dwpart );
 
+  DwBody *parentNode = dynamic_cast<DwBody*>( dwpart->Parent() );
+  assert( parentNode );
+  parentNode->RemoveBodyPart( dwpart );
+
   KMMessagePart att;
   att.duplicate( part );
   att.setBodyEncodedBinary( data );
-  msg->addBodyPart( &att );
 
+  DwBodyPart* newDwPart = msg->createDWBodyPart( &att );
+  parentNode->AddBodyPart( newDwPart );
+  msg->getTopLevelPart()->Assemble();
+
   KMMessage *newMsg = new KMMessage();
   newMsg->fromDwString( msg->asDwString() );
   newMsg->setStatus( msg->status() );
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -484,8 +484,15 @@
     uidMapDirty = true;
   }
 
+  KMFolderOpener openThis(folder(), "KMFolderCachedImap::addMsgInternal");
+  int rc = openThis.openResult();
+  if ( rc ) {
+    kdDebug(5006) << k_funcinfo << "open: " << rc << " of folder: " << label() << endl;
+    return rc;
+  }
+
   // Add the message
-  int rc = KMFolderMaildir::addMsg(msg, index_return);
+  rc = KMFolderMaildir::addMsg(msg, index_return);
 
   if( newMail && ( imapPath() == "/INBOX/" || ( !GlobalSettings::self()->filterOnlyDIMAPInbox()
       && (userRights() <= 0 || userRights() & ACLJobs::Administer )
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/headerstyle.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -894,7 +894,7 @@
     // kmail icon
     if(topLevel) {
         headerStr +=
-        "<div class=\"noprint\" style=\"position: absolute; top: -14px; left: 0px; width: 95%; height: 200px;\">\n"
+        "<div class=\"noprint\" style=\"position: absolute; top: -14px; left: 0px; width: 95%; height: 135px;\">\n"
         "<img style=\"float: right;\" src=\""+imgpath+"icon.png\">\n"
         "</div>\n";
 
Index: kmail/composercryptoconfiguration.ui
===================================================================
--- kmail/composercryptoconfiguration.ui	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/composercryptoconfiguration.ui	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -56,7 +56,7 @@
                         <cstring>mEncToSelf</cstring>
                     </property>
                     <property name="text">
-                        <string>Always encr&amp;ypt to self</string>
+                        <string>When encrypting emails, always also encr&amp;ypt to the certificate of my own identity</string>
                     </property>
                     <property name="whatsThis" stdset="0">
                         <string>When this option is enabled, the message/file will not only be encrypted with the receiver's public key, but also with your key. This will enable you to decrypt the message/file at a later time. This is generally a good idea.</string>
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -152,6 +152,7 @@
     mQuickSearchLine( 0 ),
     mShowBusySplashTimer( 0 ),
     mShowingOfflineScreen( false ),
+    mMsgActions( 0 ),
     mVacationIndicatorActive( false )
 {
   // must be the first line of the constructor:
@@ -642,6 +643,9 @@
 
   if (mReaderWindowActive) {
     mMsgView = new KMReaderWin(messageParent, this, actionCollection(), 0 );
+    if ( mMsgActions ) {
+      mMsgActions->setMessageView( mMsgView );
+    }
 
     connect(mMsgView, SIGNAL(replaceMsgByUnencryptedVersion()),
         this, SLOT(slotReplaceMsgByUnencryptedVersion()));
Index: kmail/encodingdetector_ja.cpp
===================================================================
--- kmail/encodingdetector_ja.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/encodingdetector_ja.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,376 @@
+/*
+ * This file is part of the KDE libraries
+ *
+ * Copyright 2000-2003 Shiro Kawai <shiro@acm.org>, All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ *  1. Redistributions of source code must retain the above copyright
+ *     notice, this list of conditions and the following disclaimer.
+ *
+ *  2. Redistributions in binary form must reproduce the above copyright
+ *     notice, this list of conditions and the following disclaimer in the
+ *     documentation and/or other materials provided with the distribution.
+ *
+ *  3. Neither the name of the authors nor the names of its contributors
+ *     may be used to endorse or promote products derived from this
+ *     software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+ * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+ * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+ * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ */
+/*
+ * original code is here.
+ * http://cvs.sourceforge.net/viewcvs.py/gauche/Gauche/ext/charconv/guess.c?view=markup
+ */
+
+/*
+ * Maybe we should use QTextCodec::heuristicContentMatch()
+ * But it fails detection. It's not useful.
+ */
+#include "encodingdetector_ja_p.h"
+
+/* DFA tables */
+const dfa_table guess_eucj_st[] = {
+ { /* state init */
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1,  2,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3, -1,
+ },
+ { /* state jis0201_kana */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,
+  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,
+  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,
+  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+ { /* state jis0213_1 */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5, -1,
+ },
+ { /* state jis0213_2 */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6, -1,
+ },
+};
+
+guess_arc guess_eucj_ar[7] = {
+ {  0, 1.0   }, /* init -> init */
+ {  1, 0.8   }, /* init -> jis0201_kana */
+ {  3, 0.95  }, /* init -> jis0213_2 */
+ {  2, 1.0   }, /* init -> jis0213_1 */
+ {  0, 1.0   }, /* jis0201_kana -> init */
+ {  0, 1.0   }, /* jis0213_1 -> init */
+ {  0, 1.0   }, /* jis0213_2 -> init */
+};
+
+const dfa_table guess_sjis_st[] = {
+ { /* state init */
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
+  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
+ -1,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
+  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
+  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
+  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
+ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
+  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  4,  4,  4,
+ },
+ { /* state jis0213 */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5, -1,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,
+  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5, -1, -1, -1,
+ },
+};
+
+guess_arc guess_sjis_ar[6] = {
+ {  0, 1.0   }, /* init -> init */
+ {  1, 1.0   }, /* init -> jis0213 */
+ {  0, 0.8   }, /* init -> init */
+ {  1, 0.95  }, /* init -> jis0213 */
+ {  0, 0.8   }, /* init -> init */
+ {  0, 1.0   }, /* jis0213 -> init */
+};
+
+const dfa_table guess_utf8_st[] = {
+ { /* state init */
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
+  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
+  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
+  3,  3,  3,  3,  3,  3,  3,  3,  4,  4,  4,  4,  5,  5, -1, -1,
+ },
+ { /* state 1byte_more */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+ { /* state 2byte_more */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
+  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
+  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
+  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+ { /* state 3byte_more */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,
+  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,
+  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,
+  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+ { /* state 4byte_more */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
+  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
+  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
+  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+ { /* state 5byte_more */
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
+ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
+ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
+ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
+ },
+};
+
+guess_arc guess_utf8_ar[11] = {
+ {  0, 1.0   }, /* init -> init */
+ {  1, 1.0   }, /* init -> 1byte_more */
+ {  2, 1.0   }, /* init -> 2byte_more */
+ {  3, 1.0   }, /* init -> 3byte_more */
+ {  4, 1.0   }, /* init -> 4byte_more */
+ {  5, 1.0   }, /* init -> 5byte_more */
+ {  0, 1.0   }, /* 1byte_more -> init */
+ {  1, 1.0   }, /* 2byte_more -> 1byte_more */
+ {  2, 1.0   }, /* 3byte_more -> 2byte_more */
+ {  3, 1.0   }, /* 4byte_more -> 3byte_more */
+ {  4, 1.0   }, /* 5byte_more -> 4byte_more */
+};
+
+/* Guessing Routine */
+enum JapaneseCode::Type JapaneseCode::guess_jp(const char *buf, int buflen)
+{
+    int i;
+    guess_dfa *top = 0;
+
+    for (i=0; i<buflen; i++) {
+        int c = (unsigned char)buf[i];
+
+        /* special treatment of jis escape sequence */
+        if (c == 0x1b || last_JIS_escape) {
+            if (i < buflen-1) {
+                if (last_JIS_escape)
+                    c = (unsigned char)buf[i];
+                else
+                    c = (unsigned char)buf[++i];
+                last_JIS_escape = false;
+
+                if (c == '$' || c == '(') {
+                    return JapaneseCode::JIS;
+                }
+            } else {
+                last_JIS_escape = true;
+            }
+        }
+
+        if (DFA_ALIVE(eucj)) {
+            if (!DFA_ALIVE(sjis) && !DFA_ALIVE(utf8)) return JapaneseCode::EUC;
+            DFA_NEXT(eucj, c);
+        }
+        if (DFA_ALIVE(sjis)) {
+            if (!DFA_ALIVE(eucj) && !DFA_ALIVE(utf8)) return JapaneseCode::SJIS;
+            DFA_NEXT(sjis, c);
+        }
+        if (DFA_ALIVE(utf8)) {
+            if (!DFA_ALIVE(sjis) && !DFA_ALIVE(eucj)) return JapaneseCode::UTF8;
+            DFA_NEXT(utf8, c);
+        }
+
+        if (!DFA_ALIVE(eucj) && !DFA_ALIVE(sjis) && !DFA_ALIVE(utf8)) {
+            /* we ran out the possibilities */
+            return JapaneseCode::ASCII;
+        }
+    }
+
+    /* ascii code check */
+    if (eucj->score == 1.0 && sjis->score == 1.0 && utf8->score == 1.0)
+        return JapaneseCode::ASCII;
+
+    /* Now, we have ambigous code.  Pick the highest score.  If more than
+       one candidate tie, pick the default encoding. */
+    if (DFA_ALIVE(eucj)) top = eucj;
+    if (DFA_ALIVE(utf8)) {
+        if (top) {
+            if (top->score <  utf8->score) top = utf8;
+        } else {
+            top = utf8;
+        }
+    }
+    if (DFA_ALIVE(sjis)) {
+        if (top) {
+            if (top->score <= sjis->score) top = sjis;
+        } else {
+            top = sjis;
+        }
+    }
+
+    if (top == eucj) return JapaneseCode::EUC;
+    if (top == utf8) return JapaneseCode::UTF8;
+    if (top == sjis) return JapaneseCode::SJIS;
+
+    return JapaneseCode::ASCII;
+}
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -348,7 +348,7 @@
   /**
    * Read settings from app's config file.
    */
-  void readConfig(void);
+  void readConfig( bool reload = false );
   /**
    * Change window title to given string.
    */
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmcommands.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -32,6 +32,8 @@
 class KMMsgBase;
 class KMReaderWin;
 class partNode;
+class DwBodyPart;
+class DwEntity;
 namespace KIO { class Job; }
 namespace KMail {
   class Composer;
@@ -1038,6 +1040,7 @@
 
   protected:
     void storeChangedMessage( KMMessage* msg );
+    DwBodyPart* findPart( KMMessage* msg, int index );
     virtual Result doAttachmentModify() = 0;
 
   protected:
@@ -1046,6 +1049,7 @@
 
   private:
     Result execute();
+    DwBodyPart* findPartInternal( DwEntity* root, int index, int &accu );
 
   private slots:
     void messageStoreResult( KMFolderImap* folder, bool success );
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -30,6 +30,7 @@
 #include "kmcommands.h"
 #include "kcursorsaver.h"
 #include "partNode.h"
+#include "encodingdetector.h"
 #include "attachmentlistview.h"
 #include "transportmanager.h"
 using KMail::AttachmentListView;
@@ -142,7 +143,7 @@
 
 #include "kmcomposewin.moc"
 
-#include "snippet_widget.h"
+#include "snippetwidget.h"
 
 KMail::Composer * KMail::makeComposer( KMMessage * msg, uint identitiy ) {
   return KMComposeWin::create( msg, identitiy );
@@ -646,7 +647,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::readConfig(void)
+void KMComposeWin::readConfig( bool reload /* = false */ )
 {
   mDefCharset = KMMessage::defaultCharset();
   mBtnIdentity->setChecked( GlobalSettings::self()->stickyIdentity() );
@@ -689,20 +690,21 @@
   }
   mEdtSubject->setFont(mBodyFont);
 
-  QSize siz = GlobalSettings::self()->composerSize();
-  if (siz.width() < 200) siz.setWidth(200);
-  if (siz.height() < 200) siz.setHeight(200);
-  resize(siz);
+  if ( !reload ) {
+    QSize siz = GlobalSettings::self()->composerSize();
+    if (siz.width() < 200) siz.setWidth(200);
+    if (siz.height() < 200) siz.setHeight(200);
+    resize(siz);
 
-  if ( !GlobalSettings::self()->snippetSplitterPosition().isEmpty() ) {
-    mSnippetSplitter->setSizes( GlobalSettings::self()->snippetSplitterPosition() );
-  } else {
-    QValueList<int> defaults;
-    defaults << (int)(width() * 0.8) << (int)(width() * 0.2);
-    mSnippetSplitter->setSizes( defaults );
+    if ( !GlobalSettings::self()->snippetSplitterPosition().isEmpty() ) {
+      mSnippetSplitter->setSizes( GlobalSettings::self()->snippetSplitterPosition() );
+    } else {
+      QValueList<int> defaults;
+      defaults << (int)(width() * 0.8) << (int)(width() * 0.2);
+      mSnippetSplitter->setSizes( defaults );
+    }
   }
 
-
   mIdentity->setCurrentIdentity( mId );
 
   kdDebug(5006) << "KMComposeWin::readConfig. " << mIdentity->currentIdentityName() << endl;
@@ -2749,9 +2751,18 @@
       emit attachmentAdded(attachURL, true);
     return;
   }
-  const QCString partCharset = (*it).url.fileEncoding().isEmpty()
-                             ? mCharset
-                             : QCString((*it).url.fileEncoding().latin1());
+  QCString partCharset;
+  if ( !( *it ).url.fileEncoding().isEmpty() ) {
+    partCharset = QCString( ( *it ).url.fileEncoding().latin1() );
+  } else {
+    EncodingDetector ed;
+    KLocale *loc = KGlobal::locale();
+    ed.setAutoDetectLanguage( EncodingDetector::scriptForLanguageCode ( loc->language() ) );
+    ed.analyze( (*it).data );
+    partCharset = ed.encoding();
+    if ( partCharset.isEmpty() ) //shouldn't happen
+      partCharset = mCharset;
+  }
 
   KMMessagePart* msgPart;
 
@@ -2785,7 +2796,8 @@
 
   QCString encoding = KMMsgBase::autoDetectCharset(partCharset,
     KMMessage::preferredCharsets(), name);
-  if (encoding.isEmpty()) encoding = "utf-8";
+  if ( encoding.isEmpty() )
+    encoding = "utf-8";
 
   QCString encName;
   if ( GlobalSettings::self()->outlookCompatibleAttachments() )
@@ -4917,9 +4929,10 @@
 
 void KMComposeWin::slotConfigChanged()
 {
-  readConfig();
+  readConfig( true /*reload*/);
   updateAutoSave();
   rethinkFields();
+  slotWordWrapToggled( mWordWrapAction->isChecked() );
 }
 
 /*
Index: kmail/kmreaderwin.h
===================================================================
--- kmail/kmreaderwin.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmreaderwin.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -162,6 +162,10 @@
   /** Clear the reader and discard the current message. */
   void clear(bool force = false) { setMsg(0, force); }
 
+  /** Saves the relative position of the scroll view. Call this before calling update()
+      if you want to preserve the current view. */
+  void saveRelativePosition();
+
   /** Re-parse the current message. */
   void update(bool force = false);
 
Index: kmail/popaccount.h
===================================================================
--- kmail/popaccount.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/popaccount.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -150,6 +150,7 @@
   QMap<QString, int> mTimeOfNextSeenMsgsMap; // map of uid to times of seen messages
   QDict<int> mSizeOfNextSeenMsgsDict;
   QStringList idsOfMsgsToDelete;
+  QStringList idsOfForcedDeletes;
   int indexOfCurrentMsg;
 
   QValueList<KMMessage*> msgsAwaitingProcessing;
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -389,6 +389,8 @@
   idsOfMsgs.clear();
   mUidForIdMap.clear();
   idsOfMsgsToDelete.clear();
+  idsOfForcedDeletes.clear();
+
   //delete any headers if there are some this have to be done because of check again
   headersOnServer.clear();
   headers = false;
@@ -735,6 +737,12 @@
         idsOfMsgsToDelete.remove( it.key().second );
       }
     }
+
+    if ( !idsOfForcedDeletes.isEmpty() ) {
+      idsOfMsgsToDelete += idsOfForcedDeletes;
+      idsOfForcedDeletes.clear();
+    }
+
     // If there are messages to delete then delete them
     if ( !idsOfMsgsToDelete.isEmpty() ) {
       stage = Dele;
@@ -923,8 +931,8 @@
   QString qdata = data;
   qdata = qdata.simplifyWhiteSpace(); // Workaround for Maillennium POP3/UNIBOX
   int spc = qdata.find( ' ' );
-  if (spc > 0) {
-    if (stage == List) {
+  if ( stage == List ) {
+    if ( spc > 0 ) {
       QString length = qdata.mid(spc+1);
       if (length.find(' ') != -1) length.truncate(length.find(' '));
       int len = length.toInt();
@@ -933,46 +941,76 @@
       idsOfMsgs.append( id );
       mMsgsPendingDownload.insert( id, len );
     }
-    else { // stage == Uidl
-      const QString id = qdata.left(spc);
-      const QString uid = qdata.mid(spc + 1);
-      int *size = new int; //malloc(size_of(int));
-      *size = mMsgsPendingDownload[id];
-      mSizeOfNextSeenMsgsDict.insert( uid, size );
-      if ( mUidsOfSeenMsgsDict.find( uid ) != 0 ) {
+    else {
+      stage = Idle;
+      if ( job ) job->kill();
+      job = 0;
+      mSlave = 0;
+      KMessageBox::error( 0, i18n( "Unable to complete LIST operation." ),
+                             i18n( "Invalid Response From Server") );
+      return;
+    }
+  }
+  else { // stage == Uidl
+    Q_ASSERT ( stage == Uidl);
 
-        if ( mMsgsPendingDownload.contains( id ) ) {
-          mMsgsPendingDownload.remove( id );
-        }
-        else
-          kdDebug(5006) << "PopAccount::slotData synchronization failure." << endl;
-        idsOfMsgsToDelete.append( id );
-        mUidsOfNextSeenMsgsDict.insert( uid, (const int *)1 );
-        if ( mTimeOfSeenMsgsVector.empty() ) {
-          mTimeOfNextSeenMsgsMap.insert( uid, time(0) );
-        }
-        else {
-          // cast the int* with a long to can convert it to a int, BTW
-          // works with g++-4.0 and amd64
-          mTimeOfNextSeenMsgsMap.insert( uid,
-            mTimeOfSeenMsgsVector[(int)( long )mUidsOfSeenMsgsDict[uid] - 1] );
-        }
+    QString id;
+    QString uid;
+
+    if ( spc <= 0 ) {
+      // an invalid uidl line. we might just need to skip it, but
+      // some servers generate invalid uids with valid ids. in that
+      // case we will just make up a uid - which will cause us to
+      // not cache the document, but we will be able to interoperate
+
+      int testid = atoi ( qdata.ascii() );
+      if ( testid < 1 ) {
+        // we'll just have to skip this
+        kdDebug(5006) << "PopAccount::slotData skipping UIDL entry due to parse error "
+                      << endl << qdata.ascii() << endl;
+        return;
       }
-      mUidForIdMap.insert( id, uid );
+      id.setNum (testid, 10);
+
+      QString datestring, serialstring;
+
+      serialstring.setNum ( ++dataCounter, 10 );
+      datestring.setNum ( time(NULL),10 );
+      uid = QString( "uidlgen" ) + datestring + QString( "." ) + serialstring;
+      kdDebug(5006) << "PopAccount::slotData message " << id.ascii()
+                    <<  "%d has bad UIDL, cannot keep a copy on server" << endl;
+      idsOfForcedDeletes.append( id );
     }
+    else {
+      id = qdata.left( spc );
+      uid = qdata.mid( spc + 1 );
+    }
+
+    int *size = new int; //malloc(size_of(int));
+    *size = mMsgsPendingDownload[id];
+    mSizeOfNextSeenMsgsDict.insert( uid, size );
+    if ( mUidsOfSeenMsgsDict.find( uid ) != 0 ) {
+      if ( mMsgsPendingDownload.contains( id ) ) {
+        mMsgsPendingDownload.remove( id );
+      }
+      else
+        kdDebug(5006) << "PopAccount::slotData synchronization failure." << endl;
+      idsOfMsgsToDelete.append( id );
+      mUidsOfNextSeenMsgsDict.insert( uid, (const int *)1 );
+      if ( mTimeOfSeenMsgsVector.empty() ) {
+        mTimeOfNextSeenMsgsMap.insert( uid, time(0) );
+      }
+      else {
+        // cast the int* with a long to can convert it to a int, BTW
+        // works with g++-4.0 and amd64
+        mTimeOfNextSeenMsgsMap.insert( uid, mTimeOfSeenMsgsVector[(int)( long )
+                                                 mUidsOfSeenMsgsDict[uid] - 1] );
+      }
+    }
+    mUidForIdMap.insert( id, uid );
   }
-  else {
-    stage = Idle;
-    if (job) job->kill();
-    job = 0;
-    mSlave = 0;
-    KMessageBox::error(0, i18n( "Unable to complete LIST operation." ),
-                          i18n("Invalid Response From Server"));
-    return;
-  }
 }
 
-
 //-----------------------------------------------------------------------------
 void PopAccount::slotResult( KIO::Job* )
 {
Index: kmail/encodingdetector.cpp
===================================================================
--- kmail/encodingdetector.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/encodingdetector.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,1377 @@
+/*
+    This file was taken from the KDE 4.x libraries and backported to Qt 3.
+
+    Copyright (C) 1999 Lars Knoll (knoll@kde.org)
+    Copyright (C) 2003 Dirk Mueller (mueller@kde.org)
+    Copyright (C) 2003 Apple Computer, Inc.
+    Copyright (C) 2007 Nick Shaforostoff (shafff@ukr.net)
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+//----------------------------------------------------------------------------
+//
+// decoder for input stream
+
+#include "encodingdetector.h"
+
+#undef DECODE_DEBUG
+//#define DECODE_DEBUG
+
+#define MAX_BUFFER 16*1024
+
+#include <assert.h>
+#include <stdlib.h>
+
+#include "encodingdetector_ja_p.h"
+
+#include <qregexp.h>
+#include <qtextcodec.h>
+
+#include <kglobal.h>
+#include <kcharsets.h>
+#include <kdebug.h>
+#include <klocale.h>
+
+#include <ctype.h>
+
+// The following table was taken from libpango 1.19.3 and slightly modified.
+// Multiple scripts per language were removed and the entries were reordered so
+// that simple substring matching will work. For example, bam was put before ba
+// so that the first match will be likely the right match. Otherwise "ba" would
+// match "bam" but we would have to search on to find "bam" which is what we want.
+// The original file is called pango-script-lang-table.h
+
+/* pango-script-lang-table.h:
+ * 
+ * Generated by gen-script-for-lang-new.c
+ * Date: 2007-10-26
+ * Source: fontconfig-2.4.91
+ * 
+ * Do not edit. // I did. Sue me ;)
+ */
+typedef struct _PangoScriptForLang {
+  const char lang[6];
+  EncodingDetector::AutoDetectScript scripts[1];
+} PangoScriptForLang;
+
+//Unfortunately EncodingDetector does not know all scripts that Pango knows.
+//Also, using EncodingDetector::CentralEuropean for the appropriate countries
+//might give better results in some cases.
+//One especially important (many speakers/literates) omission is the lack of
+//Indian scripts.
+
+#define PANGO_SCRIPT_ARMENIAN EncodingDetector::None
+#define PANGO_SCRIPT_BENGALI EncodingDetector::None
+#define PANGO_SCRIPT_CANADIAN_ABORIGINAL EncodingDetector::None
+#define PANGO_SCRIPT_CHEROKEE EncodingDetector::None
+#define PANGO_SCRIPT_DEVANAGARI EncodingDetector::None
+#define PANGO_SCRIPT_ETHIOPIC EncodingDetector::None
+#define PANGO_SCRIPT_GUJARATI EncodingDetector::None
+#define PANGO_SCRIPT_GURMUKHI EncodingDetector::None
+#define PANGO_SCRIPT_KANNADA EncodingDetector::None
+#define PANGO_SCRIPT_KHMER EncodingDetector::None
+#define PANGO_SCRIPT_LAO EncodingDetector::None
+#define PANGO_SCRIPT_MALAYALAM EncodingDetector::None
+#define PANGO_SCRIPT_MONGOLIAN EncodingDetector::None
+#define PANGO_SCRIPT_MYANMAR EncodingDetector::None
+#define PANGO_SCRIPT_ORIYA EncodingDetector::None
+#define PANGO_SCRIPT_SINHALA EncodingDetector::None
+#define PANGO_SCRIPT_SYRIAC EncodingDetector::None
+#define PANGO_SCRIPT_TAGALOG EncodingDetector::None
+#define PANGO_SCRIPT_TAMIL EncodingDetector::None
+#define PANGO_SCRIPT_TIBETAN EncodingDetector::None
+#define PANGO_SCRIPT_TELUGU EncodingDetector::None
+
+//Instead of changing the table even more...
+#define PANGO_SCRIPT_ARABIC EncodingDetector::Arabic
+#define PANGO_SCRIPT_CYRILLIC EncodingDetector::Cyrillic
+#define PANGO_SCRIPT_GEORGIAN EncodingDetector::SouthEasternEurope
+#define PANGO_SCRIPT_GREEK EncodingDetector::Greek
+#define PANGO_SCRIPT_HEBREW EncodingDetector::Hebrew
+#define PANGO_SCRIPT_LATIN EncodingDetector::WesternEuropean
+#define PANGO_SCRIPT_THAI EncodingDetector::Thai
+
+
+static const PangoScriptForLang pango_script_for_lang[] = {
+  { "aa",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "ab",    { PANGO_SCRIPT_CYRILLIC/*90*/ } },
+  { "af",    { PANGO_SCRIPT_LATIN/*69*/ } },
+  { "am",    { PANGO_SCRIPT_ETHIOPIC/*218*/ } },
+  { "ar",    { PANGO_SCRIPT_ARABIC/*125*/ } },
+  { "as",    { PANGO_SCRIPT_BENGALI/*89*/ } },
+  { "ast",   { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "ava",   { PANGO_SCRIPT_CYRILLIC/*67*/ } },
+  { "ay",    { PANGO_SCRIPT_LATIN/*60*/ } },
+  { "az-ir", { PANGO_SCRIPT_ARABIC/*129*/ } },
+  { "az",    { PANGO_SCRIPT_CYRILLIC/*80*/ } }, //, PANGO_SCRIPT_LATIN/*68*/ } },
+  { "bam",   { PANGO_SCRIPT_LATIN/*60*/ } },
+  { "ba",    { PANGO_SCRIPT_CYRILLIC/*82*/ } },
+  { "be",    { PANGO_SCRIPT_CYRILLIC/*68*/ } },
+  { "bg",    { PANGO_SCRIPT_CYRILLIC/*60*/ } },
+  { "bh",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "bho",   { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "bi",    { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "bin",   { PANGO_SCRIPT_LATIN/*76*/ } },
+  { "bn",    { PANGO_SCRIPT_BENGALI/*89*/ } },
+  { "bo",    { PANGO_SCRIPT_TIBETAN/*95*/ } },
+  { "br",    { PANGO_SCRIPT_LATIN/*64*/ } },
+  { "bs",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "bua",   { PANGO_SCRIPT_CYRILLIC/*70*/ } },
+  { "ca",    { PANGO_SCRIPT_LATIN/*74*/ } },
+  { "ce",    { PANGO_SCRIPT_CYRILLIC/*67*/ } },
+  { "chm",   { PANGO_SCRIPT_CYRILLIC/*76*/ } },
+  { "chr",   { PANGO_SCRIPT_CHEROKEE/*85*/ } },
+  { "ch",    { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "co",    { PANGO_SCRIPT_LATIN/*84*/ } },
+  { "cs",    { PANGO_SCRIPT_LATIN/*82*/ } },
+  { "cu",    { PANGO_SCRIPT_CYRILLIC/*103*/ } },
+  { "cv",    { PANGO_SCRIPT_CYRILLIC/*72*/ } }, //, PANGO_SCRIPT_LATIN/*2*/ } },
+  { "cy",    { PANGO_SCRIPT_LATIN/*78*/ } },
+  { "da",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "de",    { PANGO_SCRIPT_LATIN/*59*/ } },
+  { "dz",    { PANGO_SCRIPT_TIBETAN/*95*/ } },
+  { "el",    { PANGO_SCRIPT_GREEK/*69*/ } },
+  { "en",    { PANGO_SCRIPT_LATIN/*72*/ } },
+  { "eo",    { PANGO_SCRIPT_LATIN/*64*/ } },
+  { "es",    { PANGO_SCRIPT_LATIN/*66*/ } },
+//  { "et",    { PANGO_SCRIPT_LATIN/*64*/ } },
+  { "et",    { EncodingDetector::Baltic } },
+  { "eu",    { PANGO_SCRIPT_LATIN/*56*/ } },
+  { "fa",    { PANGO_SCRIPT_ARABIC/*129*/ } },
+  { "fi",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "fj",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "fo",    { PANGO_SCRIPT_LATIN/*68*/ } },
+  { "fr",    { PANGO_SCRIPT_LATIN/*84*/ } },
+  { "ful",   { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "fur",   { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "fy",    { PANGO_SCRIPT_LATIN/*75*/ } },
+  { "ga",    { PANGO_SCRIPT_LATIN/*80*/ } },
+  { "gd",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "gez",   { PANGO_SCRIPT_ETHIOPIC/*218*/ } },
+  { "gl",    { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "gn",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "gu",    { PANGO_SCRIPT_GUJARATI/*78*/ } },
+  { "gv",    { PANGO_SCRIPT_LATIN/*54*/ } },
+  { "ha",    { PANGO_SCRIPT_LATIN/*60*/ } },
+  { "haw",   { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "he",    { PANGO_SCRIPT_HEBREW/*27*/ } },
+  { "hi",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "ho",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "hr",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "hu",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "hy",    { PANGO_SCRIPT_ARMENIAN/*77*/ } },
+  { "ia",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "ibo",   { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "id",    { PANGO_SCRIPT_LATIN/*54*/ } },
+  { "ie",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "ik",    { PANGO_SCRIPT_CYRILLIC/*68*/ } },
+  { "io",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "is",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "it",    { PANGO_SCRIPT_LATIN/*72*/ } },
+  { "iu",    { PANGO_SCRIPT_CANADIAN_ABORIGINAL/*161*/ } },
+//  { "ja",    { PANGO_SCRIPT_HAN/*6356*/, PANGO_SCRIPT_KATAKANA/*88*/, PANGO_SCRIPT_HIRAGANA/*85*/ } },
+  { "ja",    { EncodingDetector::Japanese } },
+  { "kaa",   { PANGO_SCRIPT_CYRILLIC/*78*/ } },
+  { "ka",    { PANGO_SCRIPT_GEORGIAN/*33*/ } },
+  { "ki",    { PANGO_SCRIPT_LATIN/*56*/ } },
+  { "kk",    { PANGO_SCRIPT_CYRILLIC/*77*/ } },
+  { "kl",    { PANGO_SCRIPT_LATIN/*81*/ } },
+  { "km",    { PANGO_SCRIPT_KHMER/*70*/ } },
+  { "kn",    { PANGO_SCRIPT_KANNADA/*80*/ } },
+//  { "ko",    { PANGO_SCRIPT_HANGUL/*2443*/ } },
+  { "ko",    { EncodingDetector::Korean } },
+  { "kok",   { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "ks",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "ku-ir", { PANGO_SCRIPT_ARABIC/*32*/ } },
+  { "ku",    { PANGO_SCRIPT_CYRILLIC/*60*/ } }, //, PANGO_SCRIPT_LATIN/*4*/ } },
+  { "kum",   { PANGO_SCRIPT_CYRILLIC/*66*/ } },
+  { "kv",    { PANGO_SCRIPT_CYRILLIC/*70*/ } },
+  { "kw",    { PANGO_SCRIPT_LATIN/*64*/ } },
+  { "ky",    { PANGO_SCRIPT_CYRILLIC/*70*/ } },
+  { "la",    { PANGO_SCRIPT_LATIN/*68*/ } },
+  { "lb",    { PANGO_SCRIPT_LATIN/*75*/ } },
+  { "lez",   { PANGO_SCRIPT_CYRILLIC/*67*/ } },
+  { "ln",    { PANGO_SCRIPT_LATIN/*78*/ } },
+  { "lo",    { PANGO_SCRIPT_LAO/*65*/ } },
+//  { "lt",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "lt",    { EncodingDetector::Baltic } },
+//  { "lv",    { PANGO_SCRIPT_LATIN/*78*/ } },
+  { "lv",    { EncodingDetector::Baltic } },
+  { "mg",    { PANGO_SCRIPT_LATIN/*56*/ } },
+  { "mh",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "mi",    { PANGO_SCRIPT_LATIN/*64*/ } },
+  { "mk",    { PANGO_SCRIPT_CYRILLIC/*42*/ } },
+  { "ml",    { PANGO_SCRIPT_MALAYALAM/*78*/ } },
+  { "mn",    { PANGO_SCRIPT_MONGOLIAN/*130*/ } },
+  { "mo",    { PANGO_SCRIPT_CYRILLIC/*66*/ } }, //, PANGO_SCRIPT_LATIN/*62*/ } },
+  { "mr",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "mt",    { PANGO_SCRIPT_LATIN/*72*/ } },
+  { "my",    { PANGO_SCRIPT_MYANMAR/*48*/ } },
+  { "nb",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "nds",   { PANGO_SCRIPT_LATIN/*59*/ } },
+  { "ne",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "nl",    { PANGO_SCRIPT_LATIN/*82*/ } },
+  { "nn",    { PANGO_SCRIPT_LATIN/*76*/ } },
+  { "no",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "nr",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "nso",   { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "ny",    { PANGO_SCRIPT_LATIN/*54*/ } },
+  { "oc",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "om",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "or",    { PANGO_SCRIPT_ORIYA/*79*/ } },
+  { "os",    { PANGO_SCRIPT_CYRILLIC/*66*/ } },
+  { "pa",    { PANGO_SCRIPT_GURMUKHI/*63*/ } },
+  { "pl",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "ps-af", { PANGO_SCRIPT_ARABIC/*49*/ } },
+  { "ps-pk", { PANGO_SCRIPT_ARABIC/*49*/ } },
+  { "pt",    { PANGO_SCRIPT_LATIN/*82*/ } },
+  { "rm",    { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "ro",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "ru",    { PANGO_SCRIPT_CYRILLIC/*66*/ } },
+  { "sah",   { PANGO_SCRIPT_CYRILLIC/*76*/ } },
+  { "sa",    { PANGO_SCRIPT_DEVANAGARI/*68*/ } },
+  { "sco",   { PANGO_SCRIPT_LATIN/*56*/ } },
+  { "sel",   { PANGO_SCRIPT_CYRILLIC/*66*/ } },
+  { "se",    { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "sh",    { PANGO_SCRIPT_CYRILLIC/*76*/ } },
+  { "si",    { PANGO_SCRIPT_SINHALA/*77*/ } },
+  { "sk",    { PANGO_SCRIPT_LATIN/*86*/ } },
+  { "sl",    { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "sma",   { PANGO_SCRIPT_LATIN/*60*/ } },
+  { "smj",   { PANGO_SCRIPT_LATIN/*60*/ } },
+  { "smn",   { PANGO_SCRIPT_LATIN/*68*/ } },
+  { "sms",   { PANGO_SCRIPT_LATIN/*80*/ } },
+  { "sm",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "so",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "sq",    { PANGO_SCRIPT_LATIN/*56*/ } },
+  { "sr",    { PANGO_SCRIPT_CYRILLIC/*76*/ } },
+  { "ss",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "st",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "sv",    { PANGO_SCRIPT_LATIN/*68*/ } },
+  { "sw",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "syr",   { PANGO_SCRIPT_SYRIAC/*45*/ } },
+  { "ta",    { PANGO_SCRIPT_TAMIL/*48*/ } },
+  { "te",    { PANGO_SCRIPT_TELUGU/*80*/ } },
+  { "tg",    { PANGO_SCRIPT_CYRILLIC/*78*/ } },
+  { "th",    { PANGO_SCRIPT_THAI/*86*/ } },
+  { "ti-er", { PANGO_SCRIPT_ETHIOPIC/*255*/ } },
+  { "ti-et", { PANGO_SCRIPT_ETHIOPIC/*255*/ } },
+  { "tig",   { PANGO_SCRIPT_ETHIOPIC/*221*/ } },
+  { "tk",    { PANGO_SCRIPT_CYRILLIC/*74*/ } },
+  { "tl",    { PANGO_SCRIPT_TAGALOG/*19*/ } },
+  { "tn",    { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "to",    { PANGO_SCRIPT_LATIN/*52*/ } },
+//  { "tr",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "tr",    { EncodingDetector::Turkish } },
+  { "ts",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "tt",    { PANGO_SCRIPT_CYRILLIC/*76*/ } },
+  { "tw",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "tyv",   { PANGO_SCRIPT_CYRILLIC/*70*/ } },
+  { "ug",    { PANGO_SCRIPT_ARABIC/*125*/ } },
+  { "uk",    { PANGO_SCRIPT_CYRILLIC/*72*/ } },
+  { "ur",    { PANGO_SCRIPT_ARABIC/*145*/ } },
+  { "uz",    { PANGO_SCRIPT_CYRILLIC/*68*/ } },
+  { "ven",   { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "vi",    { PANGO_SCRIPT_LATIN/*186*/ } },
+  { "vot",   { PANGO_SCRIPT_LATIN/*62*/ } },
+  { "vo",    { PANGO_SCRIPT_LATIN/*54*/ } },
+  { "wa",    { PANGO_SCRIPT_LATIN/*70*/ } },
+  { "wen",   { PANGO_SCRIPT_LATIN/*76*/ } },
+  { "wo",    { PANGO_SCRIPT_LATIN/*66*/ } },
+  { "xh",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "yap",   { PANGO_SCRIPT_LATIN/*58*/ } },
+  { "yi",    { PANGO_SCRIPT_HEBREW/*27*/ } },
+  { "yo",    { PANGO_SCRIPT_LATIN/*114*/ } },
+//  { "zh-cn", { PANGO_SCRIPT_HAN/*6763*/ } },
+  { "zh-cn", { EncodingDetector::ChineseSimplified } },
+//  { "zh-hk", { PANGO_SCRIPT_HAN/*2213*/ } },
+  { "zh-hk", { EncodingDetector::ChineseTraditional } },
+//  { "zh-mo", { PANGO_SCRIPT_HAN/*2213*/ } },
+  { "zh-mo", { EncodingDetector::ChineseTraditional } },
+//  { "zh-sg", { PANGO_SCRIPT_HAN/*6763*/ } },
+  { "zh-sg", { EncodingDetector::ChineseSimplified } },
+//  { "zh-tw", { PANGO_SCRIPT_HAN/*13063*/ } },
+  { "zh-tw", { EncodingDetector::ChineseTraditional } },
+  { "zu",    { PANGO_SCRIPT_LATIN/*52*/ } },
+  { "\x00",    { EncodingDetector::None } }      //end mark
+};
+
+enum MIB
+{
+    MibLatin1  = 4,
+    Mib8859_8  = 85,
+    MibUtf8    = 106,
+    MibUcs2    = 1000,
+    MibUtf16   = 1015,
+    MibUtf16BE = 1013,
+    MibUtf16LE = 1014
+};
+
+static bool is16Bit(QTextCodec* codec)
+{
+    switch (codec->mibEnum())
+    {
+    case MibUtf16:
+    case MibUtf16BE:
+    case MibUtf16LE:
+    case MibUcs2:
+        return true;
+    default:
+        return false;
+    }
+}
+
+class EncodingDetectorPrivate
+{
+public:
+    QTextCodec *m_codec;
+    QTextDecoder *m_decoder; // utf16
+    QTextCodec *m_defaultCodec;
+    QCString  m_storeDecoderName;
+
+    EncodingDetector::EncodingChoiceSource m_source;
+    EncodingDetector::AutoDetectScript m_autoDetectLanguage;
+
+    bool m_visualRTL : 1;
+    bool m_seenBody : 1;
+    bool m_writtingHappened : 1;
+    bool m_analyzeCalled : 1; //for decode()
+    int m_multiByte;
+
+    QCString m_bufferForDefferedEncDetection;
+
+    EncodingDetectorPrivate()
+            : m_codec(QTextCodec::codecForMib(MibLatin1))
+            , m_decoder(m_codec->makeDecoder())
+            , m_defaultCodec(m_codec)
+            , m_source(EncodingDetector::DefaultEncoding)
+            , m_autoDetectLanguage(EncodingDetector::SemiautomaticDetection)
+            , m_visualRTL(false)
+            , m_seenBody(false)
+            , m_writtingHappened(false)
+            , m_analyzeCalled(false)
+            , m_multiByte(0)
+    {
+    }
+
+    EncodingDetectorPrivate(QTextCodec* codec,EncodingDetector::EncodingChoiceSource source, EncodingDetector::AutoDetectScript script)
+            : m_codec(codec)
+            , m_decoder(m_codec->makeDecoder())
+            , m_defaultCodec(m_codec)
+            , m_source(source)
+            , m_autoDetectLanguage(script)
+            , m_visualRTL(false)
+            , m_seenBody(false)
+            , m_writtingHappened(false)
+            , m_analyzeCalled(false)
+            , m_multiByte(0)
+    {
+    }
+
+    ~EncodingDetectorPrivate()
+    {
+        delete m_decoder;
+    }
+};
+
+
+static QCString automaticDetectionForArabic( const unsigned char* ptr, int size )
+{
+    for ( int i = 0; i < size; ++i ) {
+        if ( ( ptr[ i ] >= 0x80 && ptr[ i ] <= 0x9F ) || ptr[ i ] == 0xA1 || ptr[ i ] == 0xA2 || ptr[ i ] == 0xA3
+             || ( ptr[ i ] >= 0xA5 && ptr[ i ] <= 0xAB ) || ( ptr[ i ] >= 0xAE && ptr[ i ] <= 0xBA )
+             || ptr[ i ] == 0xBC || ptr[ i ] == 0xBD || ptr[ i ] == 0xBE || ptr[ i ] == 0xC0
+             || ( ptr[ i ] >= 0xDB && ptr[ i ] <= 0xDF ) || ( ptr[ i ] >= 0xF3 ) ) {
+            return "cp1256";
+        }
+    }
+
+    return "iso-8859-6";
+}
+
+static QCString automaticDetectionForBaltic( const unsigned char* ptr, int size )
+{
+    for ( int i = 0; i < size; ++i ) {
+        if ( ( ptr[ i ] >= 0x80 && ptr[ i ] <= 0x9E ) )
+             return "cp1257";
+
+        if ( ptr[ i ] == 0xA1 || ptr[ i ] == 0xA5 )
+            return "iso-8859-13";
+    }
+
+    return "iso-8859-13";
+}
+
+static QCString automaticDetectionForCentralEuropean(const unsigned char* ptr, int size )
+{
+    QCString charset;
+    for ( int i = 0; i < size; ++i ) {
+        if ( ptr[ i ] >= 0x80 && ptr[ i ] <= 0x9F ) {
+            if ( ptr[ i ] == 0x81 || ptr[ i ] == 0x83 || ptr[ i ] == 0x90 || ptr[ i ] == 0x98 )
+                return "ibm852";
+
+            if ( i + 1 > size )
+                return "cp1250";
+            else { // maybe ibm852 ?
+                charset = "cp1250";
+                continue;
+            }
+        }
+        if ( ptr[ i ] == 0xA5 || ptr[ i ] == 0xAE || ptr[ i ] == 0xBE || ptr[ i ] == 0xC3 || ptr[ i ] == 0xD0 || ptr[ i ] == 0xE3 || ptr[ i ] == 0xF0 ) {
+            if ( i + 1 > size )
+                return "iso-8859-2";
+            else {  // maybe ibm852 ?
+                if ( charset.isNull() )
+                    charset = "iso-8859-2";
+                continue;
+            }
+        }
+    }
+
+    if ( charset.isNull() )
+        charset = "iso-8859-3";
+
+    return charset.data();
+}
+
+static QCString automaticDetectionForCyrillic( const unsigned char* ptr, int size)
+{
+#ifdef DECODE_DEBUG
+        kWarning() << "EncodingDetector: Cyr heuristics";
+#endif
+
+//     if (ptr[0]==0xef && ptr[1]==0xbb && ptr[2]==0xbf)
+//         return "utf8";
+    int utf8_mark=0;
+    int koi_score=0;
+    int cp1251_score=0;
+
+    int koi_st=0;
+    int cp1251_st=0;
+
+//     int koi_na=0;
+//     int cp1251_na=0;
+
+    int koi_o_capital=0;
+    int koi_o=0;
+    int cp1251_o_capital=0;
+    int cp1251_o=0;
+
+    int koi_a_capital=0;
+    int koi_a=0;
+    int cp1251_a_capital=0;
+    int cp1251_a=0;
+
+    int koi_s_capital=0;
+    int koi_s=0;
+    int cp1251_s_capital=0;
+    int cp1251_s=0;
+
+    int koi_i_capital=0;
+    int koi_i=0;
+    int cp1251_i_capital=0;
+    int cp1251_i=0;
+
+    int cp1251_small_range=0;
+    int koi_small_range=0;
+    int ibm866_small_range=0;
+
+    int i;
+    for (i=1; (i<size) && (cp1251_small_range+koi_small_range<1000) ;++i)
+    {
+        if (ptr[i]>0xdf)
+        {
+            ++cp1251_small_range;
+
+            if (ptr[i]==0xee)//small o
+                ++cp1251_o;
+            else if (ptr[i]==0xe0)//small a
+                ++cp1251_a;
+            else if (ptr[i]==0xe8)//small i
+                ++cp1251_i;
+            else if (ptr[i]==0xf1)//small s
+                ++cp1251_s;
+            else if (ptr[i]==0xf2 && ptr[i-1]==0xf1)//small st
+                ++cp1251_st;
+
+            else if (ptr[i]==0xef)
+                ++koi_o_capital;
+            else if (ptr[i]==0xe1)
+                ++koi_a_capital;
+            else if (ptr[i]==0xe9)
+                ++koi_i_capital;
+            else if (ptr[i]==0xf3)
+                ++koi_s_capital;
+
+        }
+        else if (ptr[i]>0xbf)
+        {
+            ++koi_small_range;
+
+            if (ptr[i]==0xd0||ptr[i]==0xd1)//small o
+                ++utf8_mark;
+            else if (ptr[i]==0xcf)//small o
+                ++koi_o;
+            else if (ptr[i]==0xc1)//small a
+                ++koi_a;
+            else if (ptr[i]==0xc9)//small i
+                ++koi_i;
+            else if (ptr[i]==0xd3)//small s
+                ++koi_s;
+            else if (ptr[i]==0xd4 && ptr[i-1]==0xd3)//small st
+                ++koi_st;
+
+            else if (ptr[i]==0xce)
+                ++cp1251_o_capital;
+            else if (ptr[i]==0xc0)
+                ++cp1251_a_capital;
+            else if (ptr[i]==0xc8)
+                ++cp1251_i_capital;
+            else if (ptr[i]==0xd1)
+                ++cp1251_s_capital;
+        }
+        else if (ptr[i]>0x9f && ptr[i]<0xb0) //first 16 letterz is 60%
+            ++ibm866_small_range;
+
+    }
+
+    //cannot decide?
+    if (cp1251_small_range+koi_small_range+ibm866_small_range<8)
+    {
+        return "";
+    }
+
+    if (3*utf8_mark>cp1251_small_range+koi_small_range+ibm866_small_range)
+    {
+#ifdef DECODE_DEBUG
+        kWarning() << "Cyr Enc Detection: UTF8";
+#endif
+        return "UTF-8";
+    }
+
+    if (ibm866_small_range>cp1251_small_range+koi_small_range)
+        return "ibm866";
+
+//     QCString koi_string = "koi8-u";
+//     QCString cp1251_string = "cp1251";
+
+    if (cp1251_st==0 && koi_st>1)
+        koi_score+=10;
+    else if (koi_st==0 && cp1251_st>1)
+        cp1251_score+=10;
+
+    if (cp1251_st && koi_st)
+    {
+        if (cp1251_st/koi_st>2)
+            cp1251_score+=20;
+        else if (koi_st/cp1251_st>2)
+            koi_score+=20;
+    }
+
+    if (cp1251_a>koi_a)
+        cp1251_score+=10;
+    else if (cp1251_a || koi_a)
+        koi_score+=10;
+
+    if (cp1251_o>koi_o)
+        cp1251_score+=10;
+    else if (cp1251_o || koi_o)
+        koi_score+=10;
+
+    if (cp1251_i>koi_i)
+        cp1251_score+=10;
+    else if (cp1251_i || koi_i)
+        koi_score+=10;
+
+    if (cp1251_s>koi_s)
+        cp1251_score+=10;
+    else if (cp1251_s || koi_s)
+        koi_score+=10;
+
+    if (cp1251_a_capital>koi_a_capital)
+        cp1251_score+=9;
+    else if (cp1251_a_capital || koi_a_capital)
+        koi_score+=9;
+
+    if (cp1251_o_capital>koi_o_capital)
+        cp1251_score+=9;
+    else if (cp1251_o_capital || koi_o_capital)
+        koi_score+=9;
+
+    if (cp1251_i_capital>koi_i_capital)
+        cp1251_score+=9;
+    else if (cp1251_i_capital || koi_i_capital)
+        koi_score+=9;
+
+    if (cp1251_s_capital>koi_s_capital)
+        cp1251_score+=9;
+    else if (cp1251_s_capital || koi_s_capital)
+        koi_score+=9;
+#ifdef DECODE_DEBUG
+    kWarning()<<"koi_score " << koi_score << " cp1251_score " << cp1251_score;
+#endif
+    if (abs(koi_score-cp1251_score)<10)
+    {
+        //fallback...
+        cp1251_score=cp1251_small_range;
+        koi_score=koi_small_range;
+    }
+    if (cp1251_score>koi_score)
+        return "cp1251";
+    else
+        return "koi8-u";
+
+
+//     if (cp1251_score>koi_score)
+//         setEncoding("cp1251",AutoDetectedEncoding);
+//     else
+//         setEncoding("koi8-u",AutoDetectedEncoding);
+//     return true;
+
+}
+
+static QCString automaticDetectionForGreek( const unsigned char* ptr, int size )
+{
+    for ( int i = 0; i < size; ++i ) {
+        if ( ptr[ i ] == 0x80 || ( ptr[ i ] >= 0x82 && ptr[ i ] <= 0x87 ) || ptr[ i ] == 0x89 || ptr[ i ] == 0x8B
+             || ( ptr[ i ] >= 0x91 && ptr[ i ] <= 0x97 ) || ptr[ i ] == 0x99 || ptr[ i ] == 0x9B || ptr[ i ] == 0xA4
+             || ptr[ i ] == 0xA5 || ptr[ i ] == 0xAE ) {
+            return "cp1253";
+        }
+    }
+
+    return "iso-8859-7";
+}
+
+static QCString automaticDetectionForHebrew( const unsigned char* ptr, int size )
+{
+    for ( int i = 0; i < size; ++i ) {
+        if ( ptr[ i ] == 0x80 || ( ptr[ i ] >= 0x82 && ptr[ i ] <= 0x89 ) || ptr[ i ] == 0x8B
+             || ( ptr[ i ] >= 0x91 && ptr[ i ] <= 0x99 ) || ptr[ i ] == 0x9B || ptr[ i ] == 0xA1 || ( ptr[ i ] >= 0xBF && ptr[ i ] <= 0xC9 )
+             || ( ptr[ i ] >= 0xCB && ptr[ i ] <= 0xD8 ) ) {
+            return "cp1255";
+        }
+
+        if ( ptr[ i ] == 0xDF )
+            return "iso-8859-8-i";
+    }
+
+    return "iso-8859-8-i";
+}
+
+static QCString automaticDetectionForJapanese( const unsigned char* ptr, int size )
+{
+    JapaneseCode kc;
+
+    switch ( kc.guess_jp( (const char*)ptr, size ) ) {
+    case JapaneseCode::JIS:
+        return "jis7";
+    case JapaneseCode::EUC:
+        return "eucjp";
+    case JapaneseCode::SJIS:
+        return "sjis";
+     case JapaneseCode::UTF8:
+        return "utf8";
+    default:
+        break;
+    }
+
+    return "";
+}
+
+static QCString automaticDetectionForTurkish( const unsigned char* ptr, int size )
+{
+    for ( int i = 0; i < size; ++i ) {
+        if ( ptr[ i ] == 0x80 || ( ptr[ i ] >= 0x82 && ptr[ i ] <= 0x8C ) || ( ptr[ i ] >= 0x91 && ptr[ i ] <= 0x9C ) || ptr[ i ] == 0x9F ) {
+            return "cp1254";
+        }
+    }
+
+    return "iso-8859-9";
+}
+
+static QCString automaticDetectionForWesternEuropean( const unsigned char* ptr, int size )
+{
+    uint nonansi_count=0;
+    for (int i=0; i<size; ++i)
+    {
+        if (ptr[i]>0x79)
+        {
+             ++nonansi_count;
+            if ( ptr[i]>0xc1 && ptr[i]<0xf0 && i+1<size && ptr[i+1]>0x7f && ptr[i+1]<0xc0)
+            {
+                return "UTF-8";
+            }
+            if (ptr[i] >= 0x78 && ptr[i] <= 0x9 )
+            {
+                return "cp1252";
+            }
+        }
+
+    }
+
+    if (nonansi_count>0)
+        return "iso-8859-15";
+
+    return "";
+}
+
+// Other browsers allow comments in the head section, so we need to also.
+// It's important not to look for tags inside the comments.
+static void skipComment(const char *&ptr, const char *pEnd)
+{
+    const char *p = ptr;
+    // Allow <!-->; other browsers do.
+    if (*p=='>')
+    {
+        p++;
+    }
+    else
+    {
+        while (p!=pEnd)
+        {
+            if (*p=='-')
+            {
+                // This is the real end of comment, "-->".
+                if (p[1]=='-' && p[2]=='>')
+                {
+                    p += 3;
+                    break;
+                }
+                // This is the incorrect end of comment that other browsers allow, "--!>".
+                if (p[1] == '-' && p[2] == '!' && p[3] == '>')
+                {
+                    p += 4;
+                    break;
+                }
+            }
+            p++;
+        }
+    }
+    ptr=p;
+}
+
+// Returns the position of the encoding string.
+static int findXMLEncoding(const QCString &str, int &encodingLength)
+{
+    int len = str.length();
+    int pos = str.find("encoding");
+    if (pos == -1)
+        return -1;
+    pos += 8;
+
+    // Skip spaces and stray control characters.
+    while (pos<len && str[pos]<=' ')
+        ++pos;
+
+    //Bail out if nothing after
+    // Skip equals sign.
+    if (pos>=len || str[pos] != '=')
+        return -1;
+    ++pos;
+
+    // Skip spaces and stray control characters.
+    while (pos<len && str[pos]<=' ')
+        ++pos;
+
+    //Bail out if nothing after
+    if (pos >= len)
+        return -1;
+
+    // Skip quotation mark.
+    char quoteMark = str[pos];
+    if (quoteMark != '"' && quoteMark != '\'')
+        return -1;
+    ++pos;
+
+    // Find the trailing quotation mark.
+    int end=pos;
+    while (end<len && str[end]!=quoteMark)
+        ++end;
+
+    if (end>=len)
+        return -1;
+
+    encodingLength = end-pos;
+    return pos;
+}
+
+
+bool EncodingDetector::errorsIfUtf8 (const char* data, int length)
+{
+    if (d->m_codec->mibEnum()!=MibUtf8)
+        return false; //means no errors
+// #define highest1Bits (unsigned char)0x80
+// #define highest2Bits (unsigned char)0xC0
+// #define highest3Bits (unsigned char)0xE0
+// #define highest4Bits (unsigned char)0xF0
+// #define highest5Bits (unsigned char)0xF8
+static const unsigned char highest1Bits = 0x80;
+static const unsigned char highest2Bits = 0xC0;
+static const unsigned char highest3Bits = 0xE0;
+static const unsigned char highest4Bits = 0xF0;
+static const unsigned char highest5Bits = 0xF8;
+
+    for (int i=0; i<length; ++i)
+    {
+        unsigned char c = data[i];
+
+        if (d->m_multiByte>0)
+        {
+            if ((c & highest2Bits) == 0x80)
+            {
+                --(d->m_multiByte);
+                continue;
+            }
+#ifdef DECODE_DEBUG
+            kWarning() << "EncDetector: Broken UTF8";
+#endif
+            return true;
+        }
+
+        // most significant bit zero, single char
+        if ((c & highest1Bits) == 0x00)
+            continue;
+
+        // 110xxxxx => init 1 following bytes
+        if ((c & highest3Bits) == 0xC0)
+        {
+            d->m_multiByte = 1;
+            continue;
+        }
+
+        // 1110xxxx => init 2 following bytes
+        if ((c & highest4Bits) == 0xE0)
+        {
+            d->m_multiByte = 2;
+            continue;
+        }
+
+        // 11110xxx => init 3 following bytes
+        if ((c & highest5Bits) == 0xF0)
+        {
+            d->m_multiByte = 3;
+            continue;
+        }
+#ifdef DECODE_DEBUG
+        kWarning() << "EncDetector:_Broken UTF8";
+#endif
+        return true;
+    }
+    return false;
+}
+
+EncodingDetector::EncodingDetector() : d(new EncodingDetectorPrivate)
+{
+}
+
+EncodingDetector::EncodingDetector(QTextCodec* codec, EncodingChoiceSource source, AutoDetectScript script) :
+    d(new EncodingDetectorPrivate(codec,source,script))
+{
+}
+
+EncodingDetector::~EncodingDetector()
+{
+    delete d;
+}
+
+void EncodingDetector::setAutoDetectLanguage( EncodingDetector::AutoDetectScript lang)
+{
+    d->m_autoDetectLanguage=lang;
+}
+EncodingDetector::AutoDetectScript EncodingDetector::autoDetectLanguage() const
+{
+    return d->m_autoDetectLanguage;
+}
+
+EncodingDetector::EncodingChoiceSource EncodingDetector::encodingChoiceSource() const
+{
+    return d->m_source;
+}
+
+const char* EncodingDetector::encoding() const
+{
+    d->m_storeDecoderName = d->m_codec->name();
+    return d->m_storeDecoderName.data();
+}
+
+bool EncodingDetector::visuallyOrdered() const
+{
+    return d->m_visualRTL;
+}
+
+// const QTextCodec* EncodingDetector::codec() const
+// {
+//     return d->m_codec;
+// }
+
+QTextDecoder* EncodingDetector::decoder()
+{
+    return d->m_decoder;
+}
+
+bool EncodingDetector::setEncoding(const char *_encoding, EncodingChoiceSource type)
+{
+    QTextCodec *codec;
+    QCString enc(_encoding);
+    if(/*enc.isNull() || */enc.isEmpty())
+    {
+        if (type==DefaultEncoding)
+            codec=d->m_defaultCodec;
+        else
+            return false;
+    }
+    else
+    {
+        //QString->QTextCodec
+
+        enc = enc.lower();
+         // hebrew visually ordered
+        if(enc=="visual")
+            enc="iso8859-8";
+        bool b;
+        codec = KGlobal::charsets()->codecForName(enc, b);
+        if (!b)
+        return false;
+    }
+
+    if (d->m_codec->mibEnum()==codec->mibEnum())
+        return true;
+
+    if ((type==EncodingFromMetaTag || type==EncodingFromXMLHeader) && is16Bit(codec))
+    {
+        //Sometimes the codec specified is absurd, i.e. UTF-16 despite
+        //us decoding a meta tag as ASCII. In that case, ignore it.
+        return false;
+    }
+
+    if (codec->mibEnum() == Mib8859_8)
+    {
+        //We do NOT want to use Qt's QHebrewCodec, since it tries to reorder itself.
+        codec = QTextCodec::codecForName("iso8859-8-i");
+
+        // visually ordered unless one of the following
+        if(!(enc=="iso-8859-8-i"||enc=="iso_8859-8-i"||enc=="csiso88598i"||enc=="logical"))
+            d->m_visualRTL = true;
+    }
+
+    d->m_codec = codec;
+    d->m_source = type;
+    delete d->m_decoder;
+    d->m_decoder = d->m_codec->makeDecoder();
+#ifdef DECODE_DEBUG
+    kDebug(6005) << "EncodingDetector::encoding used is" << d->m_codec->name();
+#endif
+    return true;
+}
+
+bool EncodingDetector::analyze(const QByteArray &data)
+{
+    return analyze( data.data(), data.size() );
+}
+
+bool EncodingDetector::analyze(const char *data, int len)
+{
+    // Check for UTF-16 or UTF-8 BOM mark at the beginning, which is a sure sign of a Unicode encoding.
+    // maximumBOMLength = 10
+    // Even if the user has chosen utf16 we still need to auto-detect the endianness
+    if (len >= 10 && ((d->m_source != UserChosenEncoding) || is16Bit(d->m_codec)))
+    {
+        // Extract the first three bytes.
+        const uchar *udata = (const uchar *)data;
+        uchar c1 = *udata++;
+        uchar c2 = *udata++;
+        uchar c3 = *udata++;
+
+        // Check for the BOM
+        const char *autoDetectedEncoding;
+        if ((c1 == 0xFE && c2 == 0xFF) || (c1 == 0xFF && c2 == 0xFE))
+        {
+            autoDetectedEncoding = "ISO-10646-UCS-2";
+        }
+        else if (c1 == 0xEF && c2 == 0xBB && c3 == 0xBF)
+        {
+            autoDetectedEncoding = "UTF-8";
+        }
+        else if (c1 == 0x00 || c2 == 0x00)
+        {
+            uchar c4 = *udata++;
+            uchar c5 = *udata++;
+            uchar c6 = *udata++;
+            uchar c7 = *udata++;
+            uchar c8 = *udata++;
+            uchar c9 = *udata++;
+            uchar c10 = *udata++;
+
+            int nul_count_even = (c2 != 0) + (c4 != 0) + (c6 != 0) + (c8 != 0) + (c10 != 0);
+            int nul_count_odd = (c1 != 0) + (c3 != 0) + (c5 != 0) + (c7 != 0) + (c9 != 0);
+            if ((nul_count_even==0 && nul_count_odd==5) || (nul_count_even==5 && nul_count_odd==0))
+                autoDetectedEncoding = "ISO-10646-UCS-2";
+            else
+                autoDetectedEncoding = 0;
+        }
+        else
+        {
+            autoDetectedEncoding = 0;
+        }
+
+        // If we found a BOM, use the encoding it implies.
+        if (autoDetectedEncoding != 0)
+        {
+            d->m_source = BOM;
+            d->m_codec = QTextCodec::codecForName(autoDetectedEncoding);
+            assert(d->m_codec);
+            //enc = d->m_codec->name();
+            delete d->m_decoder;
+            d->m_decoder = d->m_codec->makeDecoder();
+#ifdef DECODE_DEBUG
+            kWarning() << "Detection by BOM";
+#endif
+            if (is16Bit(d->m_codec) && c2==0x00)
+            {
+                // utf16LE, we need to put the decoder in LE mode
+                char reverseUtf16[3] = {(char)0xFF, (char)0xFE, 0x00};
+                d->m_decoder->toUnicode(reverseUtf16, 2);
+            }
+            return true;
+        }
+    }
+
+    //exit from routine in case it was called to only detect byte order for utf-16
+    if (d->m_source==UserChosenEncoding)
+    {
+#ifdef DECODE_DEBUG
+        kWarning() << "EncodingDetector: UserChosenEncoding exit ";
+#endif
+
+        if (errorsIfUtf8(data, len))
+            setEncoding("",DefaultEncoding);
+        return true;
+    }
+#if 0  //This is for plaintext, so don't try to parse HTML headers -- ahartmetz
+    if (!d->m_seenBody)
+    {
+        // we still don't have an encoding, and are in the head
+        // the following tags are allowed in <head>:
+        // SCRIPT|STYLE|META|LINK|OBJECT|TITLE|BASE
+        const char *ptr = data;
+        const char *pEnd = data+len;
+
+        while(ptr != pEnd)
+        {
+            if(*ptr!='<')
+            {
+                ++ptr;
+                continue;
+            }
+            ++ptr;
+            // Handle comments.
+            if (ptr[0] == '!' && ptr[1] == '-' && ptr[2] == '-')
+            {
+                ptr += 3;
+                skipComment(ptr, pEnd);
+                continue;
+            }
+
+            // Handle XML header, which can have encoding in it.
+            if (ptr[0]=='?' && ptr[1]=='x' && ptr[2]=='m' && ptr[3]=='l')
+            {
+                const char *end = ptr;
+                while (*end != '>' && end < pEnd)
+                    end++;
+                if (*end == '\0' || end == pEnd)
+                    break;
+                QCString str(ptr, end - ptr + 1);
+                int length;
+                int pos = findXMLEncoding(str, length);
+                // also handles the case when specified encoding aint correct
+                if (pos!=-1 && setEncoding(str.mid(pos, length), EncodingFromXMLHeader))
+                {
+                    return true;
+                }
+            }
+
+            //look for <meta>, stop if we reach <body>
+            while (
+                        !((*ptr >= 'a') && (*ptr <= 'z') ||
+                        (*ptr >= 'A') && (*ptr <= 'Z'))
+                        && ptr < pEnd
+                )
+                ++ptr;
+
+            char tmp[5];
+            int length=0;
+            const char* max=ptr+4;
+            if (pEnd<max)
+                max=pEnd;
+            while (
+                        ((*ptr >= 'a') && (*ptr <= 'z') ||
+                        (*ptr >= 'A') && (*ptr <= 'Z') ||
+                        (*ptr >= '0') && (*ptr <= '9'))
+                        && ptr < max
+                )
+            {
+                tmp[length] = tolower( *ptr );
+                ++ptr;
+                ++length;
+            }
+            tmp[length] = 0;
+            if (tmp[0]=='m'&&tmp[1]=='e'&&tmp[2]=='t'&&tmp[3]=='a')
+            {
+                // found a meta tag...
+                const char* end = ptr;
+                while(*end != '>' && *end != '\0' && end<pEnd)
+                    end++;
+                //if ( *end == '\0' ) break;
+                QCString str( ptr, (end-ptr)+1);
+                str = str.lower();
+                int pos=0;
+                        //if( (pos = str.find("http-equiv", pos)) == -1) break;
+                        //if( (pos = str.find("content-type", pos)) == -1) break;
+                if( (pos = str.find("charset")) == -1)
+                    continue;
+                pos+=6;
+                // skip to '='
+                if( (pos = str.find('=', pos)) == -1)
+                    continue;
+
+                // skip whitespace before encoding itself
+                while (pos < (int)str.length() && str[pos] <= ' ')
+                    ++pos;
+                if ( pos == (int)str.length())
+                    continue;
+
+                int endpos = pos;
+                while( endpos < str.length() &&
+                        (str[endpos] != ' ' && str[endpos] != '"' && str[endpos] != '\''
+                                    && str[endpos] != ';' && str[endpos] != '>') )
+                    ++endpos;
+    #ifdef DECODE_DEBUG
+                kDebug( 6005 ) << "EncodingDetector: found charset in <meta>: " << str.mid(pos,endpos-pos).data();
+    #endif
+                if (setEncoding(str.mid(pos,endpos-pos), EncodingFromMetaTag))
+                    return true;
+            }
+            else if (tmp[0]=='b'&&tmp[1]=='o'&&tmp[2]=='d'&&tmp[3]=='y')
+            {
+                d->m_seenBody=true;
+                break;
+            }
+        }
+    }
+
+    if (d->m_source==EncodingFromHTTPHeader)
+        return true;
+#endif
+    //if (len<20)     //make a guess even if the file is short -- ahartmetz
+    if (len < 1)
+    {
+        setEncoding("",DefaultEncoding);
+        return false;
+    }
+#ifdef DECODE_DEBUG
+    kDebug( 6005 ) << "EncodingDetector: using heuristics (" << strlen(data) << ")";
+#endif
+
+    switch ( d->m_autoDetectLanguage )
+    {
+        case EncodingDetector::Arabic:
+            return setEncoding(automaticDetectionForArabic( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::Baltic:
+            return setEncoding(automaticDetectionForBaltic( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::CentralEuropean:
+            return setEncoding(automaticDetectionForCentralEuropean( (const unsigned char*) data, len ), AutoDetectedEncoding);
+            break;
+        case EncodingDetector::Cyrillic:
+            return setEncoding(automaticDetectionForCyrillic( (const unsigned char*) data, len), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::Greek:
+            return setEncoding(automaticDetectionForGreek( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::Hebrew:
+            return setEncoding(automaticDetectionForHebrew( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::Japanese:
+            return setEncoding(automaticDetectionForJapanese( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::Turkish:
+            return setEncoding(automaticDetectionForTurkish( (const unsigned char*) data, len ), AutoDetectedEncoding);
+//             break;
+        case EncodingDetector::WesternEuropean:
+            if (setEncoding(automaticDetectionForWesternEuropean( (const unsigned char*) data, len ), AutoDetectedEncoding))
+                return true;
+            else if (d->m_defaultCodec->mibEnum()==MibLatin1) //detection for khtml
+            {
+                return setEncoding("iso-8859-15",AutoDetectedEncoding);
+            }
+            else //use default provided by eg katepart
+            {
+                return setEncoding("",DefaultEncoding);
+            }
+//             break;
+        case EncodingDetector::SemiautomaticDetection:
+        case EncodingDetector::ChineseSimplified:
+        case EncodingDetector::ChineseTraditional:
+        case EncodingDetector::Korean:
+        case EncodingDetector::Thai:
+        case EncodingDetector::Unicode:
+        case EncodingDetector::NorthernSaami:
+        case EncodingDetector::SouthEasternEurope:
+        case EncodingDetector::None:
+            // huh. somethings broken in this code ### FIXME
+            //enc = 0; //Reset invalid codec we tried, so we get back to latin1 fallback.
+            break;
+        }
+
+        setEncoding("",DefaultEncoding);
+        return true;
+}
+
+
+EncodingDetector::AutoDetectScript EncodingDetector::scriptForName(const QString& lang)
+{
+    if (lang.isEmpty())
+        return EncodingDetector::None;
+    else if (lang==i18n("@item Text character set", "Unicode"))
+        return EncodingDetector::Unicode;
+    else if (lang==i18n("@item Text character set", "Cyrillic"))
+        return EncodingDetector::Cyrillic;
+    else if (lang==i18n("@item Text character set", "Western European"))
+        return EncodingDetector::WesternEuropean;
+    else if (lang==i18n("@item Text character set", "Central European"))
+        return EncodingDetector::CentralEuropean;
+    else if (lang==i18n("@item Text character set", "Greek"))
+        return EncodingDetector::Greek;
+    else if (lang==i18n("@item Text character set", "Hebrew"))
+        return EncodingDetector::Hebrew;
+    else if (lang==i18n("@item Text character set", "Turkish"))
+        return EncodingDetector::Turkish;
+    else if (lang==i18n("@item Text character set", "Japanese"))
+        return EncodingDetector::Japanese;
+    else if (lang==i18n("@item Text character set", "Baltic"))
+        return EncodingDetector::Baltic;
+    else if (lang==i18n("@item Text character set", "Arabic"))
+        return EncodingDetector::Arabic;
+
+    return EncodingDetector::None;
+}
+
+bool EncodingDetector::hasAutoDetectionForScript(EncodingDetector::AutoDetectScript script)
+{
+    switch (script)
+    {
+        case EncodingDetector::Arabic:
+            return true;
+        case EncodingDetector::Baltic:
+            return true;
+        case EncodingDetector::CentralEuropean:
+            return true;
+        case EncodingDetector::Cyrillic:
+            return true;
+        case EncodingDetector::Greek:
+            return true;
+        case EncodingDetector::Hebrew:
+            return true;
+        case EncodingDetector::Japanese:
+            return true;
+        case EncodingDetector::Turkish:
+            return true;
+        case EncodingDetector::WesternEuropean:
+            return true;
+        case EncodingDetector::ChineseTraditional:
+            return true;
+        case EncodingDetector::ChineseSimplified:
+            return true;
+        case EncodingDetector::Unicode:
+            return true;
+            break;
+        default:
+            return false;
+    }
+}
+
+QString EncodingDetector::nameForScript(EncodingDetector::AutoDetectScript script)
+{
+    switch (script)
+    {
+        case EncodingDetector::Arabic:
+            return i18n("@item Text character set", "Arabic");
+            break;
+        case EncodingDetector::Baltic:
+            return i18n("@item Text character set", "Baltic");
+            break;
+        case EncodingDetector::CentralEuropean:
+            return i18n("@item Text character set", "Central European");
+            break;
+        case EncodingDetector::Cyrillic:
+            return i18n("@item Text character set", "Cyrillic");
+            break;
+        case EncodingDetector::Greek:
+            return i18n("@item Text character set", "Greek");
+            break;
+        case EncodingDetector::Hebrew:
+            return i18n("@item Text character set", "Hebrew");
+            break;
+        case EncodingDetector::Japanese:
+            return i18n("@item Text character set", "Japanese");
+            break;
+        case EncodingDetector::Turkish:
+            return i18n("@item Text character set", "Turkish");
+            break;
+        case EncodingDetector::WesternEuropean:
+            return i18n("@item Text character set", "Western European");
+            break;
+        case EncodingDetector::ChineseTraditional:
+            return i18n("@item Text character set", "Chinese Traditional");
+            break;
+        case EncodingDetector::ChineseSimplified:
+            return i18n("@item Text character set", "Chinese Simplified");
+            break;
+        case EncodingDetector::Korean:
+            return i18n("@item Text character set", "Korean");
+            break;
+        case EncodingDetector::Thai:
+            return i18n("@item Text character set", "Thai");
+            break;
+        case EncodingDetector::Unicode:
+            return i18n("@item Text character set", "Unicode");
+            break;
+        //case EncodingDetector::SemiautomaticDetection:
+        default:
+            return QString();
+
+        }
+}
+
+EncodingDetector::AutoDetectScript EncodingDetector::scriptForLanguageCode(const QString &lc)
+{
+  // It might make sense to do something special if the locale ends with
+  // ".UTF-8" or "@utf8"
+  const char *langStr = pango_script_for_lang[0].lang;
+  // There is obvious optimization potential...
+  for ( int i = 0; langStr; i++ ) {
+     langStr = pango_script_for_lang[i].lang;
+     // startsWith() works for empty strings: every string "starts with" an empty string.
+     if ( lc.startsWith( QString::fromAscii( langStr ) ) )
+       return pango_script_for_lang[i].scripts[0];
+  }
+  return None;
+}
+
+#undef DECODE_DEBUG
+
Index: kmail/snippetwidget.cpp
===================================================================
--- kmail/snippetwidget.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 0)
+++ kmail/snippetwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -0,0 +1,957 @@
+/***************************************************************************
+ *   snippet feature from kdevelop/plugins/snippet/                        *
+ *                                                                         * 
+ *   Copyright (C) 2007 by Robert Gruber                                   *
+ *   rgruber@users.sourceforge.net                                         *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ ***************************************************************************/
+
+#include <kurl.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <qlayout.h>
+#include <kpushbutton.h>
+#include <klistview.h>
+#include <qheader.h>
+#include <klineedit.h>
+#include <ktextedit.h>
+#include <kmessagebox.h>
+#include <kconfig.h>
+#include <qtooltip.h>
+#include <kpopupmenu.h>
+#include <qregexp.h>
+#include <qinputdialog.h>
+#include <qlabel.h>
+#include <qcheckbox.h>
+#include <qwhatsthis.h>
+#include <qdragobject.h>
+#include <qtimer.h>
+#include <kcombobox.h>
+#include <kmedit.h>
+#include <kiconloader.h>
+#include <kshortcut.h>
+#include <kaction.h>
+#include <kkeybutton.h>
+
+#include "snippetdlg.h"
+#include "snippetitem.h"
+#include "snippetwidget.h"
+
+#include <cassert>
+
+SnippetWidget::SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent)
+		: KListView(parent, "snippet widget"), QToolTip( viewport() ),
+		mEditor( editor ), mActionCollection( actionCollection )
+{
+    // init the QPtrList
+    _list.setAutoDelete(TRUE);
+
+    // init the KListView
+    setSorting( -1 );
+    addColumn( "" );
+    setFullWidth(true);
+    header()->hide();
+    setAcceptDrops(true);
+    setDragEnabled(true);
+    setDropVisualizer(false);
+    setRootIsDecorated(true);
+
+    //connect the signals
+    connect( this, SIGNAL( contextMenuRequested ( QListViewItem *, const QPoint & , int ) ),
+             this, SLOT( showPopupMenu(QListViewItem *, const QPoint & , int ) ) );
+
+    connect( this, SIGNAL( doubleClicked (QListViewItem *) ),
+             this, SLOT( slotEdit( QListViewItem *) ) );
+    connect( this, SIGNAL( returnPressed (QListViewItem *) ),
+             this, SLOT( slotExecuted( QListViewItem *) ) );
+
+    connect( this, SIGNAL( dropped(QDropEvent *, QListViewItem *) ),
+             this, SLOT( slotDropped(QDropEvent *, QListViewItem *) ) );
+
+    connect( editor, SIGNAL( insertSnippet() ), this, SLOT( slotExecute() ));
+
+    _cfg = 0;
+
+    QTimer::singleShot(0, this, SLOT(initConfig()));
+}
+
+SnippetWidget::~SnippetWidget()
+{
+  writeConfig();
+  delete _cfg;
+
+  /* We need to delete the child items before the parent items
+     otherwise KDevelop would crash on exiting */
+  SnippetItem * item;
+  while (_list.count() > 0) {
+    for (item=_list.first(); item; item=_list.next()) {
+      if (item->childCount() == 0)
+          _list.remove(item);
+    }
+  }
+}
+
+
+/*!
+    \fn SnippetWidget::slotAdd()
+    Opens the dialog to add a snippet
+ */
+void SnippetWidget::slotAdd()
+{
+  //kdDebug(5006) << "Ender slotAdd()" << endl;
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+
+  /*check if the user clicked a SnippetGroup
+    If not, we set the group variable to the SnippetGroup
+    which the selected item is a child of*/
+  SnippetGroup * group = dynamic_cast<SnippetGroup*>(selectedItem());
+  if ( !group && selectedItem() )
+    group = dynamic_cast<SnippetGroup*>(selectedItem()->parent());
+
+  /* still no group, let's make a default one */
+  if (!group ) {
+    if ( _list.isEmpty() ) {
+      group = new SnippetGroup(this, i18n("General"), SnippetGroup::getMaxId() );
+      _list.append( group );
+    } else {
+      group = dynamic_cast<SnippetGroup*>( _list.first() );
+    }
+  }
+  assert( group );
+
+  /*fill the combobox with the names of all SnippetGroup entries*/
+  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+    if (dynamic_cast<SnippetGroup*>(it)) {
+      dlg.cbGroup->insertItem(it->getName());
+    }
+  }
+  dlg.cbGroup->setCurrentText(group->getName());
+
+  if (dlg.exec() == QDialog::Accepted) {
+      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      _list.append( makeItem( group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
+  }
+}
+
+/*!
+    \fn SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text )
+    Helper factory method.
+ */
+SnippetItem* SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut )
+{
+    SnippetItem * item = new SnippetItem(parent, name, text);
+    const QString actionName = i18n("Snippet %1").arg(name);
+    const QString normalizedName = QString(actionName).replace(" ", "_");
+    if ( !mActionCollection->action(normalizedName.utf8() ) ) {
+        KAction * action = new KAction( actionName, shortcut, item,
+                                        SLOT( slotExecute() ), mActionCollection,
+                                        normalizedName.utf8() );
+        item->setAction(action);
+        connect( item, SIGNAL( execute( QListViewItem* ) ),
+                 this, SLOT( slotExecuted( QListViewItem* ) ) );
+    }
+    return item;
+}
+
+/*!
+    \fn SnippetWidget::slotAddGroup()
+    Opens the didalog to add a snippet
+ */
+void SnippetWidget::slotAddGroup()
+{
+  //kdDebug(5006) << "Ender slotAddGroup()" << endl;
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+  dlg.setShowShortcut( false );
+  dlg.snippetText->setEnabled(false);
+  dlg.snippetText->setText("GROUP");
+  dlg.setCaption(i18n("Add Group"));
+  dlg.cbGroup->insertItem(i18n("All"));
+  dlg.cbGroup->setCurrentText(i18n("All"));
+
+  if (dlg.exec() == QDialog::Accepted) {
+    _list.append( new SnippetGroup(this, dlg.snippetName->text(), SnippetGroup::getMaxId() ) );
+  }
+}
+
+
+/*!
+    \fn SnippetWidget::slotRemove()
+    Removes the selected snippet
+ */
+void SnippetWidget::slotRemove()
+{
+  //get current data
+  QListViewItem * item = currentItem();
+  SnippetItem *snip = dynamic_cast<SnippetItem*>( item );
+  SnippetGroup *group = dynamic_cast<SnippetGroup*>( item );
+  if (!snip)
+    return;
+
+  if (group) {
+    if (group->childCount() > 0 &&
+        KMessageBox::warningContinueCancel(this, i18n("Do you really want to remove this group and all its snippets?"),QString::null,KStdGuiItem::del())
+        == KMessageBox::Cancel)
+      return;
+
+    SnippetItem *it=_list.first();
+    while ( it ) {
+      if (it->getParent() == group->getId()) {
+        SnippetItem *doomed = it;
+        it = _list.next();
+        //kdDebug(5006) << "remove " << doomed->getName() << endl;
+        _list.remove(doomed);
+      } else {
+        it = _list.next();
+      }
+    }
+  }
+
+  //kdDebug(5006) << "remove " << snip->getName() << endl;
+  _list.remove(snip);
+}
+
+
+
+/*!
+    \fn SnippetWidget::slotEdit()
+    Opens the dialog of editing the selected snippet
+ */
+void SnippetWidget::slotEdit( QListViewItem* item )
+{
+    if( item == 0 ) {
+	item = currentItem();
+    }
+
+  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>(item);
+  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
+  if (!pSnippet || pGroup) /*selected item must be a SnippetItem but MUST not be a SnippetGroup*/
+    return;
+
+  //init the dialog
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+  dlg.snippetName->setText(pSnippet->getName());
+  dlg.snippetText->setText(pSnippet->getText());
+  dlg.keyButton->setShortcut( pSnippet->getAction()->shortcut(), false );
+  dlg.btnAdd->setText(i18n("&Apply"));
+
+  dlg.setCaption(i18n("Edit Snippet"));
+  /*fill the combobox with the names of all SnippetGroup entries*/
+  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+    if (dynamic_cast<SnippetGroup*>(it)) {
+      dlg.cbGroup->insertItem(it->getName());
+    }
+  }
+  dlg.cbGroup->setCurrentText(SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName());
+
+  if (dlg.exec() == QDialog::Accepted) {
+    //update the KListView and the SnippetItem
+    item->setText( 0, dlg.snippetName->text() );
+    pSnippet->setName( dlg.snippetName->text() );
+    pSnippet->setText( dlg.snippetText->text() );
+    pSnippet->getAction()->setShortcut( dlg.keyButton->shortcut());
+
+    /* if the user changed the parent we need to move the snippet */
+    if ( SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName() != dlg.cbGroup->currentText() ) {
+      SnippetGroup * newGroup = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      pSnippet->parent()->takeItem(pSnippet);
+      newGroup->insertItem(pSnippet);
+      pSnippet->resetParent();
+    }
+
+    setSelected(item, TRUE);
+  }
+}
+
+/*!
+    \fn SnippetWidget::slotEditGroup()
+    Opens the dialog of editing the selected snippet-group
+ */
+void SnippetWidget::slotEditGroup()
+{
+  //get current data
+  QListViewItem * item = currentItem();
+
+  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>( item );
+  if (!pGroup) /*selected item MUST be a SnippetGroup*/
+    return;
+
+  //init the dialog
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
+  dlg.setShowShortcut( false );
+  dlg.snippetName->setText(pGroup->getName());
+  dlg.snippetText->setText(pGroup->getText());
+  dlg.btnAdd->setText(i18n("&Apply"));
+  dlg.snippetText->setEnabled(FALSE);
+  dlg.setCaption(i18n("Edit Group"));
+  dlg.cbGroup->insertItem(i18n("All"));
+
+  if (dlg.exec() == QDialog::Accepted) {
+    //update the KListView and the SnippetGroup
+    item->setText( 0, dlg.snippetName->text() );
+    pGroup->setName( dlg.snippetName->text() );
+
+    setSelected(item, TRUE);
+  }
+}
+
+void SnippetWidget::slotExecuted(QListViewItem * item)
+{
+    if( item == 0 )
+    {
+	item = currentItem();
+    }
+
+  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
+  if (!pSnippet || dynamic_cast<SnippetGroup*>(item))
+      return;
+
+  //process variables if any, then insert into the active view
+  insertIntoActiveView( parseText(pSnippet->getText(), _SnippetConfig.getDelimiter()) );
+}
+
+
+/*!
+    \fn SnippetWidget::insertIntoActiveView(QString text)
+    Inserts the parameter text into the activ view
+ */
+void SnippetWidget::insertIntoActiveView( const QString &text )
+{
+    mEditor->insert( text );
+}
+
+
+/*!
+    \fn SnippetWidget::writeConfig()
+    Write the cofig file
+ */
+void SnippetWidget::writeConfig()
+{
+  if( !_cfg )
+    return;
+  _cfg->deleteGroup("SnippetPart");  //this is neccessary otherwise delete entries will stay in list until
+                                     //they get overwritten by a more recent entry
+  _cfg->setGroup("SnippetPart");
+
+  QString strKeyName="";
+  QString strKeyText="";
+  QString strKeyId="";
+
+  int iSnipCount = 0;
+  int iGroupCount = 0;
+
+  SnippetItem* item=_list.first();
+  while ( item != 0) {
+
+    //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
+    //kdDebug(5006) << "SnippetWidget::writeConfig() " << item->getName() << endl;
+    SnippetGroup * group = dynamic_cast<SnippetGroup*>(item);
+    if (group) {
+      //kdDebug(5006) << "-->GROUP " << item->getName() << group->getId() << " " << iGroupCount<< endl;
+      strKeyName=QString("snippetGroupName_%1").arg(iGroupCount);
+      strKeyId=QString("snippetGroupId_%1").arg(iGroupCount);
+
+      _cfg->writeEntry(strKeyName, group->getName());
+      _cfg->writeEntry(strKeyId, group->getId());
+
+      iGroupCount++;
+    } else if (dynamic_cast<SnippetItem*>(item)) {
+      //kdDebug(5006) << "-->ITEM " << item->getName() << item->getParent() << " " << iSnipCount << endl;
+      strKeyName=QString("snippetName_%1").arg(iSnipCount);
+      strKeyText=QString("snippetText_%1").arg(iSnipCount);
+      strKeyId=QString("snippetParent_%1").arg(iSnipCount);
+
+      _cfg->writeEntry(strKeyName, item->getName());
+      _cfg->writeEntry(strKeyText, item->getText());
+      _cfg->writeEntry(strKeyId, item->getParent());
+
+      KAction * action = item->getAction();
+      assert( action );
+      const KShortcut& sc = action->shortcut();
+      if (!sc.isNull() ) {
+          _cfg->writeEntry( QString("snippetShortcut_%1").arg(iSnipCount), sc.toString() );
+      }
+      iSnipCount++;
+    } else {
+      //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
+    }
+    item = _list.next();
+  }
+  _cfg->writeEntry("snippetCount", iSnipCount);
+  _cfg->writeEntry("snippetGroupCount", iGroupCount);
+
+  int iCount = 1;
+  QMap<QString, QString>::Iterator it;
+  for ( it = _mapSaved.begin(); it != _mapSaved.end(); ++it ) {  //write the saved variable values
+    if (it.data().length()<=0) continue;  //is the saved value has no length -> no need to save it
+
+    strKeyName=QString("snippetSavedName_%1").arg(iCount);
+    strKeyText=QString("snippetSavedVal_%1").arg(iCount);
+
+    _cfg->writeEntry(strKeyName, it.key());
+    _cfg->writeEntry(strKeyText, it.data());
+
+    iCount++;
+  }
+  _cfg->writeEntry("snippetSavedCount", iCount-1);
+
+
+  _cfg->writeEntry( "snippetDelimiter", _SnippetConfig.getDelimiter() );
+  _cfg->writeEntry( "snippetVarInput", _SnippetConfig.getInputMethod() );
+  _cfg->writeEntry( "snippetToolTips", _SnippetConfig.useToolTips() );
+  _cfg->writeEntry( "snippetGroupAutoOpen", _SnippetConfig.getAutoOpenGroups() );
+
+  _cfg->writeEntry("snippetSingleRect", _SnippetConfig.getSingleRect() );
+  _cfg->writeEntry("snippetMultiRect", _SnippetConfig.getMultiRect() );
+
+  _cfg->sync();
+}
+
+/*!
+    \fn SnippetWidget::initConfig()
+    Initial read the cofig file
+ */
+void SnippetWidget::initConfig()
+{
+  if (_cfg == NULL)
+    _cfg = new KConfig("kmailsnippetrc", false, false);
+
+  _cfg->setGroup("SnippetPart");
+
+  QString strKeyName="";
+  QString strKeyText="";
+  QString strKeyId="";
+  SnippetItem *item;
+  SnippetGroup *group;
+
+  //kdDebug(5006) << "SnippetWidget::initConfig() " << endl;
+
+  //if entry doesn't get found, this will return -1 which we will need a bit later
+  int iCount = _cfg->readNumEntry("snippetGroupCount", -1);
+
+  for ( int i=0; i<iCount; i++) {  //read the group-list
+    strKeyName=QString("snippetGroupName_%1").arg(i);
+    strKeyId=QString("snippetGroupId_%1").arg(i);
+
+    QString strNameVal="";
+    int iIdVal=-1;
+
+    strNameVal = _cfg->readEntry(strKeyName, "");
+    iIdVal = _cfg->readNumEntry(strKeyId, -1);
+    //kdDebug(5006) << "Read group "  << " " << iIdVal << endl;
+
+    if (strNameVal != "" && iIdVal != -1) {
+      group = new SnippetGroup(this, strNameVal, iIdVal);
+      //kdDebug(5006) << "Created group " << group->getName() << " " << group->getId() << endl;
+      _list.append(group);
+    }
+  }
+
+  /* Check if the snippetGroupCount property has been found
+     if iCount is -1 this means, that the user has his snippets
+     stored without groups. Therefore we will call the
+     initConfigOldVersion() function below */
+  // should not happen since this function has been removed
+
+  if (iCount != -1) {
+    iCount = _cfg->readNumEntry("snippetCount", 0);
+    for ( int i=0; i<iCount; i++) {  //read the snippet-list
+        strKeyName=QString("snippetName_%1").arg(i);
+        strKeyText=QString("snippetText_%1").arg(i);
+        strKeyId=QString("snippetParent_%1").arg(i);
+
+        QString strNameVal="";
+        QString strTextVal="";
+        int iParentVal = -1;
+
+        strNameVal = _cfg->readEntry(strKeyName, "");
+        strTextVal = _cfg->readEntry(strKeyText, "");
+        iParentVal = _cfg->readNumEntry(strKeyId, -1);
+        //kdDebug(5006) << "Read item " << strNameVal << " " << iParentVal << endl;
+
+        if (strNameVal != "" && strTextVal != "" && iParentVal != -1) {
+            KShortcut shortcut( _cfg->readEntry( QString("snippetShortcut_%1").arg(i), QString() ) );
+            item = makeItem( SnippetItem::findGroupById(iParentVal, _list), strNameVal, strTextVal, shortcut );
+            //kdDebug(5006) << "Created item " << item->getName() << " " << item->getParent() << endl;
+            _list.append(item);
+        }
+    }
+  } else {
+      //kdDebug() << "iCount is not -1";
+  }
+
+  iCount = _cfg->readNumEntry("snippetSavedCount", 0);
+
+  for ( int i=1; i<=iCount; i++) {  //read the saved-values and store in QMap
+    strKeyName=QString("snippetSavedName_%1").arg(i);
+    strKeyText=QString("snippetSavedVal_%1").arg(i);
+
+    QString strNameVal="";
+    QString strTextVal="";
+
+    strNameVal = _cfg->readEntry(strKeyName, "");
+    strTextVal = _cfg->readEntry(strKeyText, "");
+
+    if (strNameVal != "" && strTextVal != "") {
+      _mapSaved[strNameVal] = strTextVal;
+    }
+  }
+
+
+  _SnippetConfig.setDelimiter( _cfg->readEntry("snippetDelimiter", "$") );
+  _SnippetConfig.setInputMethod( _cfg->readNumEntry("snippetVarInput", 0) );
+  _SnippetConfig.setToolTips( _cfg->readBoolEntry("snippetToolTips", true) );
+  _SnippetConfig.setAutoOpenGroups( _cfg->readNumEntry("snippetGroupAutoOpen", 1) );
+
+  _SnippetConfig.setSingleRect( _cfg->readRectEntry("snippetSingleRect", 0L) );
+  _SnippetConfig.setMultiRect( _cfg->readRectEntry("snippetMultiRect", 0L) );
+}
+
+/*!
+    \fn SnippetWidget::maybeTip( const QPoint & p )
+    Shows the Snippet-Text as ToolTip
+ */
+void SnippetWidget::maybeTip( const QPoint & p )
+{
+	SnippetItem * item = dynamic_cast<SnippetItem*>( itemAt( p ) );
+	if (!item)
+	  return;
+
+	QRect r = itemRect( item );
+
+	if (r.isValid() &&
+        _SnippetConfig.useToolTips() )
+	{
+	    tip( r, item->getText() );  //show the snippet's text
+	}
+}
+
+/*!
+    \fn SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
+    Shows the Popup-Menu depending item is a valid pointer
+*/
+void SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
+{
+    KPopupMenu popup;
+
+    SnippetItem * selectedItem = static_cast<SnippetItem *>(item);
+    if ( item ) {
+        popup.insertTitle( selectedItem->getName() );
+        if (dynamic_cast<SnippetGroup*>(item)) {
+            popup.insertItem( i18n("Edit &group..."), this, SLOT( slotEditGroup() ) );
+        } else {
+            popup.insertItem( SmallIconSet("editpaste"), i18n("&Paste"), this, SLOT( slotExecuted() ) );
+            popup.insertItem( SmallIconSet("edit"), i18n("&Edit..."), this, SLOT( slotEdit() ) );
+        }
+        popup.insertItem( SmallIconSet("editdelete"), i18n("&Remove"), this, SLOT( slotRemove() ) );
+        popup.insertSeparator();
+    } else {
+        popup.insertTitle(i18n("Text Snippets"));
+    }
+    popup.insertItem( i18n("&Add Snippet..."), this, SLOT( slotAdd() ) );
+    popup.insertItem( i18n("Add G&roup..."), this, SLOT( slotAddGroup() ) );
+
+    popup.exec(p);
+}
+
+
+//  fn SnippetWidget::parseText(QString text, QString del)
+/*!
+    This function is used to parse the given QString for variables. If found the user will be prompted
+    for a replacement value. It returns the string text with all replacements made
+ */
+QString SnippetWidget::parseText(QString text, QString del)
+{
+  QString str = text;
+  QString strName = "";
+  QString strNew = "";
+  QString strMsg="";
+  int iFound = -1;
+  int iEnd = -1;
+  QMap<QString, QString> mapVar;
+  int iInMeth = _SnippetConfig.getInputMethod();
+  QRect rSingle = _SnippetConfig.getSingleRect();
+  QRect rMulti = _SnippetConfig.getMultiRect();
+
+  do {
+    iFound = text.find(QRegExp("\\"+del+"[A-Za-z-_0-9\\s]*\\"+del), iEnd+1);  //find the next variable by this QRegExp
+    if (iFound >= 0) {
+      iEnd = text.find(del, iFound+1)+1;
+      strName = text.mid(iFound, iEnd-iFound);
+
+      if ( strName != del+del  ) {  //if not doubel-delimiter
+        if (iInMeth == 0) { //if input-method "single" is selected
+          if ( mapVar[strName].length() <= 0 ) {  // and not already in map
+            strMsg=i18n("Please enter the value for <b>%1</b>:").arg(strName);
+            strNew = showSingleVarDialog( strName, &_mapSaved, rSingle );
+            if (strNew=="")
+              return ""; //user clicked Cancle
+          } else {
+            continue; //we have already handled this variable
+          }
+        } else {
+          strNew = ""; //for inputmode "multi" just reset new valaue
+        }
+      } else {
+        strNew = del; //if double-delimiter -> replace by single character
+      }
+
+      if (iInMeth == 0) {  //if input-method "single" is selected
+        str.replace(strName, strNew);
+      }
+
+      mapVar[strName] = strNew;
+    }
+  } while (iFound != -1);
+
+  if (iInMeth == 1) {  //check config, if input-method "multi" is selected
+    int w, bh, oh;
+    w = rMulti.width();
+    bh = rMulti.height();
+    oh = rMulti.top();
+    if (showMultiVarDialog( &mapVar, &_mapSaved, w, bh, oh )) {  //generate and show the dialog
+      QMap<QString, QString>::Iterator it;
+      for ( it = mapVar.begin(); it != mapVar.end(); ++it ) {  //walk through the map and do the replacement
+        str.replace(it.key(), it.data());
+      }
+    } else {
+      return "";
+    }
+
+    rMulti.setWidth(w);   //this is a hack to save the dialog's dimensions in only one QRect
+    rMulti.setHeight(bh);
+    rMulti.setTop(oh);
+    rMulti.setLeft(0);
+     _SnippetConfig.setMultiRect(rMulti);
+  }
+
+  _SnippetConfig.setSingleRect(rSingle);
+
+  return str;
+}
+
+
+//  fn SnippetWidget::showMultiVarDialog()
+/*!
+    This function constructs a dialog which contains a label and a linedit for every
+    variable that is stored in the given map except the double-delimiter entry
+    It return true if everything was ok and false if the user hit cancel
+ */
+bool SnippetWidget::showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
+                                       int & iWidth, int & iBasicHeight, int & iOneHeight)
+{
+  //if no var -> no need to show
+  if (map->count() == 0)
+    return true;
+
+  //if only var is the double-delimiter -> no need to show
+  QMap<QString, QString>::Iterator it = map->begin();
+  if ( map->count() == 1 && it.data()==_SnippetConfig.getDelimiter()+_SnippetConfig.getDelimiter() )
+    return true;
+
+  QMap<QString, KTextEdit *> mapVar2Te;  //this map will help keeping track which TEXTEDIT goes with which variable
+  QMap<QString, QCheckBox *> mapVar2Cb;  //this map will help keeping track which CHECKBOX goes with which variable
+
+  // --BEGIN-- building a dynamic dialog
+  QDialog dlg(this);
+  dlg.setCaption(i18n("Enter Values for Variables"));
+
+  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
+  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
+  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
+  QGridLayout * layoutBtn = new QGridLayout( 0, 1, 1, 0, 6, "layoutBtn");
+
+  KTextEdit *te = NULL;
+  QLabel * labTop = NULL;
+  QCheckBox * cb = NULL;
+
+  labTop = new QLabel( &dlg, "label" );
+  labTop->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         labTop->sizePolicy().hasHeightForWidth() ) );
+  labTop->setText(i18n("Enter the replacement values for these variables:"));
+  layoutTop->addWidget(labTop, 0, 0);
+  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
+
+
+  int i = 0;                                           //walk through the variable map and add
+  for ( it = map->begin(); it != map->end(); ++it ) {  //a checkbox, a lable and a lineedit to the main layout
+    if (it.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
+      continue;
+
+    cb = new QCheckBox( &dlg, "cbVar" );
+    cb->setChecked( FALSE );
+    cb->setText(it.key());
+    layoutVar->addWidget( cb, i ,0, Qt::AlignTop );
+
+    te = new KTextEdit( &dlg, "teVar" );
+    layoutVar->addWidget( te, i, 1, Qt::AlignTop );
+
+    if ((*mapSave)[it.key()].length() > 0) {
+      cb->setChecked( TRUE );
+      te->setText((*mapSave)[it.key()]);
+    }
+
+    mapVar2Te[it.key()] = te;
+    mapVar2Cb[it.key()] = cb;
+
+    QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
+    QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
+                              "If you use the same variable later, even in another snippet, the value entered to the right "
+			      "will be the default value for that variable.") );
+
+    i++;
+  }
+  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
+
+  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
+  btn1->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         btn1->sizePolicy().hasHeightForWidth() ) );
+  layoutBtn->addWidget( btn1, 0, 0 );
+
+  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
+  btn2->setDefault( TRUE );
+  btn2->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         btn2->sizePolicy().hasHeightForWidth() ) );
+  layoutBtn->addWidget( btn2, 0, 1 );
+
+  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
+  // --END-- building a dynamic dialog
+
+  //connect the buttons to the QDialog default slots
+  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
+  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
+
+  //prepare to execute the dialog
+  bool bReturn = false;
+  //resize the textedits
+  if (iWidth > 1) {
+    QRect r = dlg.geometry();
+    r.setHeight(iBasicHeight + iOneHeight*mapVar2Te.count());
+    r.setWidth(iWidth);
+    dlg.setGeometry(r);
+  }
+  if ( i > 0 && // only if there are any variables
+    dlg.exec() == QDialog::Accepted ) {
+
+    QMap<QString, KTextEdit *>::Iterator it2;
+    for ( it2 = mapVar2Te.begin(); it2 != mapVar2Te.end(); ++it2 ) {
+      if (it2.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
+        continue;
+      (*map)[it2.key()] = it2.data()->text();    //copy the entered values back to the given map
+
+      if (mapVar2Cb[it2.key()]->isChecked())     //if the checkbox is on; save the values for later
+        (*mapSave)[it2.key()] = it2.data()->text();
+      else
+        (*mapSave).erase(it2.key());
+    }
+    bReturn = true;
+
+    iBasicHeight = dlg.geometry().height() - layoutVar->geometry().height();
+    iOneHeight = layoutVar->geometry().height() / mapVar2Te.count();
+    iWidth = dlg.geometry().width();
+  }
+
+  //do some cleanup
+  QMap<QString, KTextEdit *>::Iterator it1;
+  for (it1 = mapVar2Te.begin(); it1 != mapVar2Te.end(); ++it1)
+    delete it1.data();
+  mapVar2Te.clear();
+  QMap<QString, QCheckBox *>::Iterator it2;
+  for (it2 = mapVar2Cb.begin(); it2 != mapVar2Cb.end(); ++it2)
+    delete it2.data();
+  mapVar2Cb.clear();
+  delete layoutTop;
+  delete layoutVar;
+  delete layoutBtn;
+  delete layout;
+
+  if (i==0) //if nothing happened this means, that there are no variables to translate
+    return true; //.. so just return OK
+
+  return bReturn;
+//  return true;
+}
+
+
+//  fn SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave)
+/*!
+    This function constructs a dialog which contains a label and a linedit for the given variable
+    It return either the entered value or an empty string if the user hit cancel
+ */
+QString SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize)
+{
+  // --BEGIN-- building a dynamic dialog
+  QDialog dlg(this);
+  dlg.setCaption(i18n("Enter Values for Variables"));
+
+  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
+  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
+  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
+  QGridLayout * layoutBtn = new QGridLayout( 0, 2, 1, 0, 6, "layoutBtn");
+
+  KTextEdit *te = NULL;
+  QLabel * labTop = NULL;
+  QCheckBox * cb = NULL;
+
+  labTop = new QLabel( &dlg, "label" );
+  layoutTop->addWidget(labTop, 0, 0);
+  labTop->setText(i18n("Enter the replacement values for %1:").arg( var ));
+  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
+
+
+  cb = new QCheckBox( &dlg, "cbVar" );
+  cb->setChecked( FALSE );
+  cb->setText(i18n( "Make value &default" ));
+
+  te = new KTextEdit( &dlg, "teVar" );
+  layoutVar->addWidget( te, 0, 1, Qt::AlignTop);
+  layoutVar->addWidget( cb, 1, 1, Qt::AlignTop);
+  if ((*mapSave)[var].length() > 0) {
+    cb->setChecked( TRUE );
+    te->setText((*mapSave)[var]);
+  }
+
+  QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
+  QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
+                            "If you use the same variable later, even in another snippet, the value entered to the right "
+                            "will be the default value for that variable.") );
+
+  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
+
+  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
+  layoutBtn->addWidget( btn1, 0, 0 );
+
+  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
+  btn2->setDefault( TRUE );
+  layoutBtn->addWidget( btn2, 0, 1 );
+
+  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
+  te->setFocus();
+  // --END-- building a dynamic dialog
+
+  //connect the buttons to the QDialog default slots
+  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
+  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
+
+  //execute the dialog
+  QString strReturn = "";
+  if (dlgSize.isValid())
+    dlg.setGeometry(dlgSize);
+  if ( dlg.exec() == QDialog::Accepted ) {
+    if (cb->isChecked())     //if the checkbox is on; save the values for later
+      (*mapSave)[var] = te->text();
+    else
+      (*mapSave).erase(var);
+
+    strReturn = te->text();    //copy the entered values back the the given map
+
+    dlgSize = dlg.geometry();
+  }
+
+  //do some cleanup
+  delete cb;
+  delete te;
+  delete labTop;
+  delete btn1;
+  delete btn2;
+  delete layoutTop;
+  delete layoutVar;
+  delete layoutBtn;
+  delete layout;
+
+  return strReturn;
+}
+
+//  fn SnippetWidget::acceptDrag (QDropEvent *event) const
+/*!
+    Reimplementation from KListView.
+    Check here if the data the user is about to drop fits our restrictions.
+    We only accept dropps of plaintext, because from the dropped text
+    we will create a snippet.
+ */
+bool SnippetWidget::acceptDrag (QDropEvent *event) const
+{
+  //kdDebug(5006) << "Format: " << event->format() << "" << event->pos() << endl;
+
+  QListViewItem * item = itemAt(event->pos());
+
+  if (item &&
+      QString(event->format()).startsWith("text/plain") &&
+      static_cast<SnippetWidget *>(event->source()) != this) {
+    ///kdDebug(5006) << "returning TRUE " << endl;
+    return TRUE;
+  } else if(item &&
+      QString(event->format()).startsWith("x-kmailsnippet") &&
+      static_cast<SnippetWidget *>(event->source()) != this)
+  {
+    //kdDebug(5006) << "returning TRUE " << endl;
+    return TRUE;
+  } else {
+    //kdDebug(5006) << "returning FALSE" << endl;
+    event->acceptAction(FALSE);
+    return FALSE;
+  }
+}
+
+//  fn SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *after)
+/*!
+    This slot is connected to the dropped signal.
+    If it is emitted, we need to construct a new snippet entry with
+    the data given
+ */
+void SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *)
+{
+  QListViewItem * item2 = itemAt(e->pos());
+
+  SnippetGroup *group = dynamic_cast<SnippetGroup *>(item2);
+  if (!group)
+    group = dynamic_cast<SnippetGroup *>(item2->parent());
+
+  QCString dropped;
+  QByteArray data = e->encodedData("text/plain");
+  if ( e->provides("text/plain") && data.size()>0 ) {
+    //get the data from the event...
+    QString encData(data.data());
+    //kdDebug(5006) << "encData: " << encData << endl;
+
+    //... then fill the dialog with the given data
+    SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
+    dlg.snippetName->clear();
+    dlg.snippetText->setText(encData);
+
+    /*fill the combobox with the names of all SnippetGroup entries*/
+    for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+      if (dynamic_cast<SnippetGroup*>(it)) {
+        dlg.cbGroup->insertItem(it->getName());
+      }
+    }
+    dlg.cbGroup->setCurrentText(group->getName());
+
+    if (dlg.exec() == QDialog::Accepted) {
+      /* get the group that the user selected with the combobox */
+      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      _list.append( makeItem(group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
+    }
+  }
+}
+
+void SnippetWidget::startDrag()
+{
+    QString text = dynamic_cast<SnippetItem*>( currentItem() )->getText();
+    QTextDrag *drag = new QTextDrag(text, this);
+    drag->setSubtype("x-textsnippet");
+    drag->drag();
+}
+
+void SnippetWidget::slotExecute()
+{
+    slotExecuted(currentItem());
+}
+
+
+#include "snippetwidget.moc"
+
Index: kmail/snippetsettings.cpp
===================================================================
--- kmail/snippetsettings.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/snippetsettings.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -17,7 +17,7 @@
 #include <qbuttongroup.h>
 
 #include "snippetsettings.h"
-#include "snippet_widget.h"
+#include "snippetwidget.h"
 
 
 SnippetSettings::SnippetSettings(QWidget *parent, const char *name)
Index: kmail/kmfoldertree.cpp
===================================================================
--- kmail/kmfoldertree.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/kmfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1540,8 +1540,8 @@
   {
     KMFolderImap *folder = static_cast<KMFolderImap*>( fti->folder()->storage() );
     // if we should list all folders we limit this to the root folder
-    if ( !folder->account()->listOnlyOpenFolders() &&
-         fti->parent() )
+    if ( !folder->account() || ( !folder->account()->listOnlyOpenFolders() &&
+         fti->parent() ) )
       return;
     if ( folder->getSubfolderState() == KMFolderImap::imapNoInformation )
     {
Index: kmail/objecttreeparser.cpp
===================================================================
--- kmail/objecttreeparser.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kmail/objecttreeparser.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -2086,7 +2086,7 @@
   url.setPath( "showAuditLog" );
   url.addQueryItem( "log", auditLog );
 
-  return "<a href=\"" + url.htmlURL() + "\">" + i18n("Show Audit Log") + "</a>";
+  return "<a href=\"" + url.htmlURL() + "\">" + i18n("The Audit Log is a detailed error log from the gnupg backend", "Show Audit Log") + "</a>";
 }
 
 static QString endVerboseSigstatHeader( const PartMetaData & pmd )
@@ -2230,11 +2230,9 @@
                     QString msgFrom( KPIM::getEmailAddress(fromAddress) );
                     QString certificate;
                     if( block.keyId.isEmpty() )
-                        certificate = "certificate";
+                        certificate = i18n("certificate");
                     else
-                        certificate = QString("%1%2</a>")
-                                      .arg( startKeyHREF,
-                                            "certificate" );
+                        certificate = startKeyHREF + i18n("certificate") + "</a>"; 
                     if( !blockAddrs.empty() ){
                         if( blockAddrs.grep(
                                 msgFrom,
Index: kioslaves/imap4/imapparser.cc
===================================================================
--- kioslaves/imap4/imapparser.cc	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kioslaves/imap4/imapparser.cc	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -280,7 +280,7 @@
   while ( true )
   {
     //read the next line
-    while (parseLoop() == 0);
+    while (parseLoop() == 0) ;
     if ( cmd->isComplete() ) break;
 
     if (!continuation.isEmpty())
@@ -895,6 +895,8 @@
 
 void imapParser::parseAddressList (parseString & inWords, QPtrList<mailAddress>& list)
 {
+  if (inWords.isEmpty())
+    return;
   if (inWords[0] != '(')
   {
     parseOneWordC (inWords);     // parse NIL
@@ -915,7 +917,7 @@
       }
     }
 
-    if (inWords[0] == ')')
+    if (!inWords.isEmpty() && inWords[0] == ')')
       inWords.pos++;
     skipWS (inWords);
   }
@@ -931,7 +933,7 @@
   retVal.setUser(parseLiteralC(inWords));
   retVal.setHost(parseLiteralC(inWords));
 
-  if (inWords[0] == ')')
+  if (!inWords.isEmpty() && inWords[0] == ')')
     inWords.pos++;
   skipWS (inWords);
 
@@ -1004,7 +1006,7 @@
       parseLiteralC (inWords);
   }
 
-  if (inWords[0] == ')')
+  if (!inWords.isEmpty() && inWords[0] == ')')
     inWords.pos++;
   skipWS (inWords);
 
@@ -1531,7 +1533,7 @@
             parseBodyStructure (inWords, section, envelope);
           QByteArray data;
           QDataStream stream( data, IO_WriteOnly );
-          body->serialize(stream);
+          if (body) body->serialize(stream);
           parseRelay(data);
 
           delete body;
@@ -1613,7 +1615,7 @@
       parseLiteralC(inWords);
   }
 
-  if (inWords[0] != ')')
+  if (inWords.isEmpty() || inWords[0] != ')')
     return;
   inWords.pos++;
   skipWS (inWords);
@@ -1906,7 +1908,7 @@
 
 QCString imapParser::parseLiteralC(parseString & inWords, bool relay, bool stopAtBracket, int *outlen) {
 
-  if (inWords[0] == '{')
+  if (!inWords.isEmpty() && inWords[0] == '{')
   {
     QCString retVal;
     ulong runLen = inWords.find ('}', 1);
Index: kioslaves/imap4/imap4.cc
===================================================================
--- kioslaves/imap4/imap4.cc	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kioslaves/imap4/imap4.cc	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -313,7 +313,7 @@
         cmd = sendCommand (imapCommand::clientFetch (aSequence, mySection));
         do
         {
-          while (!parseLoop ());
+          while (!parseLoop ()) ;
         }
         while (!cmd->isComplete ());
         completeQueue.removeRef (cmd);
@@ -332,7 +332,7 @@
       aUpper = aSection.upper();
       do
       {
-        while (!(res = parseLoop()));
+        while (!(res = parseLoop())) ;
         if (res == -1) break;
 
         mailHeader *lastone = 0;
@@ -595,7 +595,7 @@
         imapCache *cache;
         do
         {
-          while (!parseLoop ());
+          while (!parseLoop ()) ;
 
           cache = getLastHandled ();
 
@@ -824,7 +824,7 @@
 
     imapCommand *cmd =
       sendCommand (imapCommand::clientAppend (aBox, aSection, length));
-    while (!parseLoop ());
+    while (!parseLoop ()) ;
 
     // see if server is waiting
     if (!cmd->isComplete () && !getContinuation ().isEmpty ())
@@ -1603,7 +1603,7 @@
   if ( type == 'E' ) {
     kdDebug(7116) << "IMAP4Protocol::specialCustomCommand: extended mode" << endl;
     imapCommand *cmd = sendCommand (imapCommand::clientCustom( command, QString() ));
-    while ( !parseLoop () );
+    while ( !parseLoop () ) ;
 
     // see if server is waiting
     if (!cmd->isComplete () && !getContinuation ().isEmpty ())
@@ -1626,7 +1626,7 @@
 
     do
     {
-      while (!parseLoop ());
+      while (!parseLoop ()) ;
     }
     while (!cmd->isComplete ());
 
@@ -2032,7 +2032,7 @@
     imapCommand *cmd;
 
     unhandled.clear ();
-    if (!alreadyConnected) while (!parseLoop ());    //get greeting
+    if (!alreadyConnected) while (!parseLoop ()) ;    //get greeting
     QString greeting;
     if (!unhandled.isEmpty()) greeting = unhandled.first().stripWhiteSpace();
     unhandled.clear ();       //get rid of it
Index: kioslaves/sieve/sieve.cpp
===================================================================
--- kioslaves/sieve/sieve.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kioslaves/sieve/sieve.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -17,7 +17,7 @@
 /**
  * Portions adapted from the SMTP ioslave.
  * Copyright (c) 2000, 2001 Alex Zepeda <jazepeda@pacbell.net>
- * Copyright (c) 2001 Michael Hckel <Michael@Haeckel.Net>
+ * Copyright (c) 2001 Michael Häckel <Michael@Haeckel.Net>
  * All rights reserved.
  *
  * Policy: the function where the error occurs calls error(). A result of
@@ -41,6 +41,7 @@
 #include <kglobal.h>
 
 #include <qcstring.h>
+#include <qregexp.h>
 
 #include <cstdlib>
 using std::exit;
@@ -252,6 +253,7 @@
 				ksDebug() << "Connected to Sieve server: " << r.getVal() << endl;
 				ret = true;
 				setMetaData("implementation", r.getVal());
+				m_implementation = r.getVal();
 			}
 
 		} else if (r.getKey() == "SASL") {
@@ -357,7 +359,7 @@
 			if (retval == 1) {
 				ksDebug() << "TLS enabled successfully." << endl;
 				// reparse capabilities:
-				parseCapabilities(false);
+				parseCapabilities( requestCapabilitiesAfterStartTLS() );
 			} else {
 				ksDebug() << "TLS initiation failed, code " << retval << endl;
 				disconnect(true);
@@ -393,8 +395,11 @@
 	if (!forcibly) {
 		sendData("LOGOUT");
 
-		if (!operationSuccessful())
-			ksDebug() << "Server did not logout cleanly." << endl;
+		// This crashes under certain conditions as described in
+		// http://intevation.de/roundup/kolab/issue2442
+		// Fixing KIO::TCPSlaveBase::atEnd() for !fd would also work but 3.x is on life support.
+		//if (!operationSuccessful())
+		//	ksDebug() << "Server did not logout cleanly." << endl;
 	}
 
 	closeDescriptor();
@@ -1188,7 +1193,10 @@
 		  {
 			// expecting {quantity}
 			start = 0;
-			end = interpret.find('}', start + 1)-1;
+			end = interpret.find("+}", start + 1);
+			// some older versions of Cyrus enclose the literal size just in { } instead of { +}
+			if ( end == -1 )
+				end = interpret.find('}', start + 1);
 
 			bool ok = false;
 			r.setQuantity(interpret.mid(start + 1, end - start - 1).toUInt( &ok ));
@@ -1270,3 +1278,21 @@
 
 	return OTHER;
 }
+
+bool kio_sieveProtocol::requestCapabilitiesAfterStartTLS() const
+{
+  // Cyrus didn't send CAPABILITIES after STARTTLS until 2.3.11, which is
+  // not standard conform, but we need to support that anyway.
+  // m_implementation looks like this 'Cyrus timsieved v2.2.12' for Cyrus btw.
+  QRegExp regExp( "Cyrus\\stimsieved\\sv(\\d+)\\.(\\d+)\\.(\\d+)", false );
+  if ( regExp.search( m_implementation ) >= 0 ) {
+    const int major = regExp.cap( 1 ).toInt();
+    const int minor = regExp.cap( 2 ).toInt();
+    const int patch = regExp.cap( 3 ).toInt();
+    if ( major < 2 || (major == 2 && (minor < 3 || (major == 3 && patch < 11))) ) {
+      ksDebug() << k_funcinfo << "Enabling compat mode for Cyrus < 2.3.11" << endl;
+      return true;
+    }
+  }
+  return false;
+}
Index: kioslaves/sieve/sieve.h
===================================================================
--- kioslaves/sieve/sieve.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kioslaves/sieve/sieve.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -122,6 +122,11 @@
 	QString				m_sPass;
 	QString				m_sAuth;
 	bool				m_shouldBeConnected;
+
+private:
+	bool requestCapabilitiesAfterStartTLS() const;
+
+	QString m_implementation;
 };
 
 #endif
Index: doc/kaddressbook/index.docbook
===================================================================
--- doc/kaddressbook/index.docbook	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ doc/kaddressbook/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1134,6 +1134,34 @@
 <userinput><option>--help-qt</option></userinput>.</para>
 </chapter>
 
+<chapter id="configure-non-gui-options">
+<title>Options Without a User Interface Representation</title>
+<para>
+Apart from the options presented in the configuration dialog, some options
+can only be set directly in the configuration file ($KDEHOME/share/config/kaddressbookrc)
+or through KIOSK.
+</para>
+
+<variablelist>
+
+<varlistentry>
+<term><guilabel>ContactListAboveExtensions</guilabel></term>
+<listitem>
+<para>
+If enabled, extensions (e.g. the distribution list editor) are shown below the contact list, 
+not in an separate column. By default, this option is disabled.
+
+To enable this option, add a line reading (under [MainWindow] section):
+</para>
+<programlisting>ContactListAboveExtensions=true
+</programlisting>
+</listitem>
+</varlistentry>
+
+</variablelist>
+
+</chapter>
+
 <chapter id="credits">
 <title>Credits and License</title>
 
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1403,7 +1403,6 @@
 		int reminder = mReminder->minutes();
 		if (reminder  &&  !mReminder->isOnceOnly())
 		{
-			getEvent(recurEvent);     // this may adjust mAlarmDateTime
 			mRecurrenceEdit->updateEvent(recurEvent, false);
 			longestRecurInterval = recurEvent.longestRecurrenceInterval();
 			if (longestRecurInterval  &&  reminder >= longestRecurInterval)
@@ -1419,11 +1418,11 @@
 		{
 			if (longestRecurInterval < 0)
 			{
-				getEvent(recurEvent);     // this may adjust mAlarmDateTime
 				mRecurrenceEdit->updateEvent(recurEvent, false);
 				longestRecurInterval = recurEvent.longestRecurrenceInterval();
 			}
-			if (recurEvent.repeatInterval() * recurEvent.repeatCount() >= longestRecurInterval - reminder)
+			if (longestRecurInterval > 0
+			&&  recurEvent.repeatInterval() * recurEvent.repeatCount() >= longestRecurInterval - reminder)
 			{
 				KMessageBox::sorry(this, i18n("The duration of a repetition within the recurrence must be less than the recurrence interval minus any reminder period"));
 				mRecurrenceEdit->activateSubRepetition();   // display the alarm repetition dialog again
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.5.1"
+#define KALARM_VERSION "1.5.3"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/kalarmd/kalarmd.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/kalarmd/kalarmd.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -52,3 +52,4 @@
 Type=Application
 Terminal=false
 X-DCOP-ServiceType=Unique
+NoDisplay=true
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,8 +1,13 @@
 KAlarm Change Log
 
+=== Version 1.5.3 --- 10 March 2008 ===
+- Prevent invalid negative values appearing in 'Time from now' edit field.
+
+=== Version 1.5.2 --- 13 February 2008 ===
+- Prevent repetition duration error message when saving alarm which never recurs.
+
 === Version 1.5.1 (KDE 3.5.9) --- 13 February 2008 ===
 - Fix inability to set up sub-repetitions for simple yearly recurrences.
-- Fix wrong error message when changing recurrence frequency.
 
 === Version 1.5.0 --- 27 January 2008 ===
 - Replace simple repetitions with recurrence sub-repetitions, to save confusion.
Index: kalarm/repetition.cpp
===================================================================
--- kalarm/repetition.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/repetition.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -96,8 +96,10 @@
 */
 void RepetitionButton::initialise(int interval, int count, bool dateOnly, int maxDuration)
 {
-	mInterval    = (maxDuration > 0 && interval > maxDuration) ? 1 : interval;
+	if (maxDuration > 0 && interval > maxDuration)
+		count = 0;
 	mCount       = count;
+	mInterval    = interval;
 	mMaxDuration = maxDuration;
 	mDateOnly    = dateOnly;
 	if (mDialog)
Index: kalarm/lib/timespinbox.cpp
===================================================================
--- kalarm/lib/timespinbox.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/lib/timespinbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -205,12 +205,12 @@
 		if (value() < mMinimumValue)
 			SpinBox2::setValue(mMinimumValue);
 		setSpecialValueText(QString());
-		setMinValue(mMinimumValue);
+		SpinBox2::setMinValue(mMinimumValue);
 	}
 	else if (!valid  &&  !mInvalid)
 	{
 		mInvalid = true;
-		setMinValue(mMinimumValue - 1);
+		SpinBox2::setMinValue(mMinimumValue - 1);
 		setSpecialValueText(QString::fromLatin1("**:**"));
 		SpinBox2::setValue(mMinimumValue - 1);
 	}
@@ -221,8 +221,8 @@
 */
 void TimeSpinBox::setMinValue(int minutes)
 {
-        mMinimumValue = minutes;
-        SpinBox2::setMinValue(mMinimumValue - (mInvalid ? 1 : 0));
+	mMinimumValue = minutes;
+	SpinBox2::setMinValue(mMinimumValue - (mInvalid ? 1 : 0));
 }
 
 /******************************************************************************
@@ -242,7 +242,7 @@
 			{
 				mInvalid = false;
 				setSpecialValueText(QString());
-				setMinValue(mMinimumValue);
+				SpinBox2::setMinValue(mMinimumValue);
 			}
 			SpinBox2::setValue(minutes);
 			mEnteredSetValue = false;
Index: kalarm/lib/spinbox2.h
===================================================================
--- kalarm/lib/spinbox2.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/lib/spinbox2.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -138,9 +138,9 @@
 		/** Returns the maximum value of the spin box. */
 		int                 maxValue() const            { return mMaxValue; }
 		/** Sets the minimum value of the spin box. */
-		void                setMinValue(int val);
+		virtual void        setMinValue(int val);
 		/** Sets the maximum value of the spin box. */
-		void                setMaxValue(int val);
+		virtual void        setMaxValue(int val);
 		/** Sets the minimum and maximum values of the spin box. */
 		void                setRange(int minValue, int maxValue)   { setMinValue(minValue);  setMaxValue(maxValue); }
 		/** Returns the current value of the spin box. */
Index: kalarm/lib/timespinbox.h
===================================================================
--- kalarm/lib/timespinbox.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kalarm/lib/timespinbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -117,7 +117,7 @@
 	private:
 		class TimeValidator;
 		TimeValidator*  mValidator;
-		int             mMinimumValue;
+		int             mMinimumValue;       // real minimum value, excluding special value for "**:**"
 		bool            m12Hour;             // use 12-hour clock
 		bool            mPm;                 // use PM for manually entered values (with 12-hour clock)
 		bool            mInvalid;            // value is currently invalid (asterisks)
Index: kaddressbook/extensionmanager.cpp
===================================================================
--- kaddressbook/extensionmanager.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/extensionmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -46,10 +46,10 @@
 
 ExtensionManager::ExtensionManager( QWidget* extensionBar, QWidgetStack* detailsStack, KAB::Core *core, QObject *parent,
                                     const char *name )
-    : QObject( parent, name ), mExtensionBar( extensionBar ), mCore( core ), 
+    : QObject( parent, name ), mExtensionBar( extensionBar ), mCore( core ),
       mMapper( 0 ), mDetailsStack( detailsStack ), mActiveDetailsWidget( 0 )
 {
-  Q_ASSERT( mExtensionBar ); 
+  Q_ASSERT( mExtensionBar );
   QVBoxLayout* layout = new QVBoxLayout( mExtensionBar );
   mSplitter = new QSplitter( mExtensionBar );
   mSplitter->setOrientation( QSplitter::Vertical );
@@ -68,7 +68,7 @@
 }
 
 
-void ExtensionManager::restoreSettings() 
+void ExtensionManager::restoreSettings()
 {
   const QStringList activeExtensions = KABPrefs::instance()->activeExtensions();
 
@@ -110,7 +110,7 @@
   for ( QStringList::ConstIterator it = mActiveExtensions.begin(), end = mActiveExtensions.end(); it != end; ++it ) {
     if ( mExtensionMap.contains( *it ) && mExtensionMap[*it].widget )
       mExtensionMap[*it].widget->contactsSelectionChanged();
-  } 
+  }
 }
 
 void ExtensionManager::activationToggled( const QString &extid )
@@ -127,7 +127,7 @@
   if ( !mExtensionMap.contains( extid ) )
     return;
   if ( mActiveExtensions.contains( extid ) == active )
-    return; 
+    return;
   const ExtensionData data = mExtensionMap[ extid ];
   if ( active ) {
     mActiveExtensions.append( extid );
@@ -152,7 +152,7 @@
   }
   mExtensionBar->setShown( !mActiveExtensions.isEmpty() );
 }
- 
+
 void ExtensionManager::createActions()
 {
   mCore->guiClient()->unplugActionList( "extensions_list" );
@@ -178,6 +178,7 @@
       data.action->setChecked( true );
   }
 
+  mActionList.append( new KActionSeparator( mActionCollection ) );
   mCore->guiClient()->plugActionList( "extensions_list", mActionList );
 }
 
@@ -235,6 +236,8 @@
 
     wdg = extensionFactory->extension( mCore, mSplitter );
     if ( wdg ) {
+      if ( wdg->identifier() == "distribution_list_editor_ng" )
+          mSplitter->moveToFirst( wdg );
       wdg->hide();
       connect( wdg, SIGNAL( modified( const KABC::Addressee::List& ) ),
                SIGNAL( modified( const KABC::Addressee::List& ) ) );
Index: kaddressbook/kaddressbookui.rc
===================================================================
--- kaddressbook/kaddressbookui.rc	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/kaddressbookui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="kaddressbook" version="22">
+<kpartgui name="kaddressbook" version="23">
 
   <MenuBar>
     <Menu name="file" noMerge="1"><text>&amp;File</text>
@@ -47,6 +47,8 @@
       <Action name="view_modify"/>
       <Action name="view_delete"/>
       <Separator/>
+      <ActionList name="extensions_list"/>
+      <Separator/>
       <Action name="view_refresh"/>
     </Menu>
 
@@ -56,9 +58,6 @@
 
     <Menu name="settings" noMerge="1"><text>&amp;Settings</text>
       <Merge name="StandardToolBarMenuHandler" />
-      <Menu name="show_extensions_menu"><text>Show Extension</text>
-        <ActionList name="extensions_list"/>
-      </Menu>
       <Action name="options_show_jump_bar"/>
       <Action name="options_show_details"/>
       <Action name="options_show_statusbar"/>
Index: kaddressbook/distributionlisteditor_p.h
===================================================================
--- kaddressbook/distributionlisteditor_p.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/distributionlisteditor_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -26,8 +26,11 @@
 #include <libkdepim/addresseelineedit.h>
 #include <libkdepim/distributionlist.h>
 
+#include <qpushbutton.h>
 #include <qstring.h>
 
+class QToolButton;
+
 namespace KABC {
     class Addressee;
     class AddressBook;
@@ -52,7 +55,8 @@
 
     void setEntry( const KPIM::DistributionList::Entry& entry );
     KPIM::DistributionList::Entry entry() const; 
-
+    void setFocusToLineEdit();
+    
 signals:
     void cleared();
     void textChanged();
@@ -67,6 +71,7 @@
     QString m_uid;
     QString m_initialText;
     LineEdit* m_lineEdit;
+    QToolButton* m_clearButton;
     KABC::AddressBook* m_addressBook;
 };
 
Index: kaddressbook/kaddressbook_part.rc
===================================================================
--- kaddressbook/kaddressbook_part.rc	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/kaddressbook_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="kaddressbook" version="22">
+<kpartgui name="kaddressbook" version="23">
 
   <MenuBar>
     <Menu name="file" noMerge="1"><text>&amp;File</text>
@@ -47,6 +47,8 @@
       <Action name="view_modify"/>
       <Action name="view_delete"/>
       <Separator/>
+      <ActionList name="extensions_list"/>
+      <Separator/>
       <Action name="view_refresh"/>
     </Menu>
 
@@ -56,9 +58,6 @@
 
     <Menu name="settings" noMerge="1"><text>&amp;Settings</text>
       <Merge name="StandardToolBarMenuHandler" />
-      <Menu name="show_extensions_menu"><text>Show Extension</text>
-        <ActionList name="extensions_list"/>
-      </Menu>
       <Action name="options_show_jump_bar"/>
       <Action name="options_show_details"/>
       <Action name="options_show_statusbar"/>
Index: kaddressbook/kabcore.cpp
===================================================================
--- kaddressbook/kabcore.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/kabcore.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -224,6 +224,9 @@
   }
   mDetailsSplitter->setSizes( splitterSize );
 
+  const QValueList<int> leftSplitterSizes = KABPrefs::instance()->leftSplitter();
+  if ( !leftSplitterSizes.isEmpty() )    
+      mLeftSplitter->setSizes( leftSplitterSizes );
 }
 
 void KABCore::saveSettings()
@@ -231,7 +234,8 @@
   KABPrefs::instance()->setJumpButtonBarVisible( mActionJumpBar->isChecked() );
   KABPrefs::instance()->setDetailsPageVisible( mActionDetails->isChecked() );
   KABPrefs::instance()->setDetailsSplitter( mDetailsSplitter->sizes() );
-
+  KABPrefs::instance()->setLeftSplitter( mLeftSplitter->sizes() );
+  
   mExtensionManager->saveSettings();
   mViewManager->saveSettings();
 
@@ -1094,18 +1098,23 @@
            SLOT( incrementalTextSearch( const QString& ) ) );
 
   mDetailsSplitter = new QSplitter( mWidget );
+
+  mLeftSplitter = new QSplitter( mDetailsSplitter );
+  mLeftSplitter->setOrientation( KABPrefs::instance()->contactListAboveExtensions() ? Qt::Vertical : Qt::Horizontal );
+
   topLayout->addWidget( searchTB );
   topLayout->addWidget( mDetailsSplitter );
-
+  
   mDetailsStack = new QWidgetStack( mDetailsSplitter );
-  mExtensionManager = new ExtensionManager( new QWidget( mDetailsSplitter ), mDetailsStack, this, this );
+  mExtensionManager = new ExtensionManager( new QWidget( mLeftSplitter ), mDetailsStack, this, this );
   connect( mExtensionManager, SIGNAL( detailsWidgetDeactivated( QWidget* ) ), 
            this, SLOT( deactivateDetailsWidget( QWidget* ) ) );
   connect( mExtensionManager, SIGNAL( detailsWidgetActivated( QWidget* ) ), 
            this, SLOT( activateDetailsWidget( QWidget* ) ) );
-
   
-  QWidget *viewWidget = new QWidget( mDetailsSplitter );
+  QWidget *viewWidget = new QWidget( mLeftSplitter );
+  if ( KABPrefs::instance()->contactListAboveExtensions() )
+    mLeftSplitter->moveToFirst( viewWidget );
   QVBoxLayout *viewLayout = new QVBoxLayout( viewWidget );
   viewLayout->setSpacing( KDialog::spacingHint() );
 
@@ -1544,7 +1553,7 @@
     return;
   QGuardedPtr<KPIM::DistributionListEditor::EditorWidget> dlg = new KPIM::DistributionListEditor::EditorWidget( addressBook(), widget() );
   dlg->setDistributionList( dist );
-  if ( dlg->exec() == QDialog::Accepted ) {
+  if ( dlg->exec() == QDialog::Accepted && dlg ) {
     const KPIM::DistributionList newDist = dlg->distributionList();
     if ( newDist != dist ) {
       addressBook()->insertAddressee( newDist );
Index: kaddressbook/distributionlisteditor.cpp
===================================================================
--- kaddressbook/distributionlisteditor.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/distributionlisteditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -56,7 +56,7 @@
     QVBoxLayout* addresseeLayout;
     QValueList<KPIM::DistributionListEditor::Line*> addressees;
     KPIM::DistributionList distributionList;
-    void addLineForEntry( const KPIM::DistributionList::Entry& entry );
+    KPIM::DistributionListEditor::Line* addLineForEntry( const KPIM::DistributionList::Entry& entry );
     int lastLineId;
 };
 
@@ -70,21 +70,26 @@
     connect( m_lineEdit, SIGNAL( textChanged( const QString& ) ),
              this, SLOT( textChanged( const QString& ) ) );
     layout->addWidget( m_lineEdit );
-    QToolButton *button = new QToolButton( this );
-    button->setIconSet( KApplication::reverseLayout() ? SmallIconSet("locationbar_erase") : SmallIconSet( "clear_left" ) );
- 
-
-    layout->addWidget( button );
-    connect( button, SIGNAL( clicked() ), m_lineEdit, SLOT( clear() ) );
+    m_clearButton = new QToolButton( this );
+    m_clearButton->setIconSet( KApplication::reverseLayout() ? SmallIconSet("locationbar_erase") : SmallIconSet( "clear_left" ) );
+    m_clearButton->setEnabled( false );
+    layout->addWidget( m_clearButton );
+    connect( m_clearButton, SIGNAL( clicked() ), m_lineEdit, SLOT( clear() ) );
 }
 
 void KPIM::DistributionListEditor::Line::textChanged( const QString& text )
 {
+    m_clearButton->setEnabled( !text.isEmpty() );
     if ( text.isEmpty() )
         emit cleared();
     emit textChanged();
 }
 
+void KPIM::DistributionListEditor::Line::setFocusToLineEdit()
+{
+    m_lineEdit->setFocus();
+}
+
 void KPIM::DistributionListEditor::Line::setEntry( const KPIM::DistributionList::Entry& entry )
 {
     m_uid = entry.addressee.uid();
@@ -155,13 +160,12 @@
              this, SLOT( lineTextChanged( int ) ) ); 
     setCaption( i18n( "Edit Distribution List" ) );
     QWidget* main = new QWidget( this );
-    QGridLayout* mainLayout = new QGridLayout( main );
+    QVBoxLayout* mainLayout = new QVBoxLayout( main );
     mainLayout->setMargin( KDialog::marginHint() );
     mainLayout->setSpacing( KDialog::spacingHint() );
 
     QHBoxLayout* nameLayout = new QHBoxLayout;
     nameLayout->setSpacing( KDialog::spacingHint() );
-
     d->nameLabel = new QLabel( main );
     d->nameLabel->setText( i18n( "Name:" ) );
     nameLayout->addWidget( d->nameLabel );
@@ -169,15 +173,16 @@
     d->nameLineEdit = new KLineEdit( main );
     nameLayout->addWidget( d->nameLineEdit );
 
-    mainLayout->addLayout( nameLayout, 0, 0 );
+    mainLayout->addLayout( nameLayout );
+    mainLayout->addSpacing( 30 );
 
     d->memberListLabel = new QLabel( main );
     d->memberListLabel->setText( i18n( "Distribution list members:" ) );
-    mainLayout->addWidget( d->memberListLabel, 1, 0 );
+    mainLayout->addWidget( d->memberListLabel );
 
     d->scrollView = new QScrollView( main );
     d->scrollView->setFrameShape( QFrame::NoFrame );
-    mainLayout->addWidget( d->scrollView, 2, 0 );
+    mainLayout->addWidget( d->scrollView );
     d->memberListWidget = new QWidget( d->scrollView->viewport() );
     d->memberListWidget->setSizePolicy( QSizePolicy::MinimumExpanding, QSizePolicy::MinimumExpanding );
     QVBoxLayout* memberLayout = new QVBoxLayout( d->memberListWidget );
@@ -190,7 +195,9 @@
     
     setMainWidget( main );
 
-    d->addLineForEntry( KPIM::DistributionList::Entry() );
+    KPIM::DistributionListEditor::Line* const last = d->addLineForEntry( KPIM::DistributionList::Entry() );
+    const QSize hint = sizeHint();
+    resize( hint.width() * 1.5, hint.height() );
 }
 
 KPIM::DistributionListEditor::EditorWidget::~EditorWidget()
@@ -226,10 +233,11 @@
     {
         d->addLineForEntry( *it );
     }
-    d->addLineForEntry( Entry() );
+    KPIM::DistributionListEditor::Line* const last = d->addLineForEntry( Entry() );
+    last->setFocusToLineEdit();
 }
 
-void KPIM::DistributionListEditor::EditorWidgetPrivate::addLineForEntry( const KPIM::DistributionList::Entry& entry )
+KPIM::DistributionListEditor::Line* KPIM::DistributionListEditor::EditorWidgetPrivate::addLineForEntry( const KPIM::DistributionList::Entry& entry )
 {  
     KPIM::DistributionListEditor::Line* line = new KPIM::DistributionListEditor::Line( addressBook, memberListWidget );
     line->setEntry( entry );
@@ -239,6 +247,7 @@
                       mapper, SLOT( map() ) );
     mapper->setMapping( line, ++lastLineId );
     line->setShown( true );
+    return line;
 }
 
 void KPIM::DistributionListEditor::EditorWidget::slotOk()
Index: kaddressbook/common/kaddressbook.kcfg
===================================================================
--- kaddressbook/common/kaddressbook.kcfg	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/common/kaddressbook.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -50,17 +50,24 @@
     <entry type="Bool" name="DetailsPageVisible">
       <default>true</default>
     </entry>
-    <entry type="IntList" name="ExtensionsSplitter">
-    </entry>
     <entry type="IntList" name="DetailsSplitter">
     </entry>
+    <entry type="IntList" name="LeftSplitter">
+    </entry>
+    <entry type="Bool" name="ContactListAboveExtensions">
+      <default>true</default>
+       <whatsthis>If true, the contact list will be placed above the extensions on the left (distribution list editor etc.) instead of in the middle of the main window</whatsthis>
+
+    </entry>
   </group>
 
   <group name="ExtensionsGeneral">
     <entry type="String" name="CurrentExtension">
       <default>resourceselection</default>
     </entry>
-    <entry type="StringList" name="activeExtensions"/>
+    <entry type="StringList" name="activeExtensions">
+      <default>distribution_list_editor_ng,resourceselection</default>
+    </entry>
     <entry type="IntList" name="ExtensionsSplitterSizes"/>
   </group>
 
Index: kaddressbook/kabcore.h
===================================================================
--- kaddressbook/kabcore.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/kabcore.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -455,6 +455,7 @@
     QWidget *mDetailsWidget;
     QHBoxLayout *mDetailsLayout;
     QSplitter *mDetailsSplitter;
+    QSplitter *mLeftSplitter;
     QWidgetStack *mDetailsStack;
     LDAPSearchDialog *mLdapSearchDialog;
     QDict<AddresseeEditorDialog> mEditorDict;
Index: kaddressbook/features/distributionlistng.desktop
===================================================================
--- kaddressbook/features/distributionlistng.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/features/distributionlistng.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -8,14 +8,17 @@
 Name[de]=Verteilerlisten-Modul für neues Adressbuch
 Name[el]=Πρόσθετο επόμενης γενιάς λίστας διανομής του KAB
 Name[et]=KAB postiloendi järgmise põlvkonna plugin
+Name[fr]=Module de liste de diffusion nouvelle génération pour KAB
 Name[it]=Plugin lista di distribuzione KAB di nuova generazione
 Name[ja]=KAB 配布リスト次世代プラグイン
 Name[nds]=Verbetert Verdeellist-Moduul för KAdressbook
 Name[nl]=Plugin voor KAB Distributielijst (Nieuwe Generatie)
+Name[pl]=Wtyczka KAB do obsługi list wysyłkowych
 Name[sk]=KAB plugin distribučného zoznamu ďaľšej generácie
 Name[sr]=Прикључак KAB-а наредне генерације за дистрибуционе листе
 Name[sr@Latn]=Priključak KAB-a naredne generacije za distribucione liste
 Name[sv]=Adressbokens nästa generation insticksprogram för distributionslistor
+Name[tr]=KAB Dağıtım Listesi Sonraki Kuşak Eklentisi
 Name[zh_CN]=KAB 分发列表生成插件
 Name[zh_TW]=KAB 分派清單下一代外掛程式
 Comment=Plugin for managing distribution lists
Index: kaddressbook/features/Makefile.am
===================================================================
--- kaddressbook/features/Makefile.am	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kaddressbook/features/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -4,6 +4,8 @@
 if compile_newdistrlists
 TARGET_DISTRIBUTIONLISTNG=libkaddrbk_distributionlistng.la
 DISTRIBUTIONLISTNG_DESKTOPFILE=distributionlistng.desktop
+else
+DISTRIBUTIONLIST_DESKTOPFILE=distributionlist.desktop
 endif
 
 kde_module_LTLIBRARIES = $(TARGET_DISTRIBUTIONLISTNG) libkaddrbk_distributionlist.la libkaddrbk_resourceselection.la
@@ -11,14 +13,15 @@
 XXLIBS = $(top_builddir)/kaddressbook/interfaces/libkabinterfaces.la \
          $(top_builddir)/libkdepim/libkdepim.la
 
-libkaddrbk_distributionlist_la_SOURCES = distributionlistwidget.cpp
-libkaddrbk_distributionlist_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
-libkaddrbk_distributionlist_la_LIBADD = $(XXLIBS)
 
 if compile_newdistrlists
 libkaddrbk_distributionlistng_la_SOURCES = distributionlistngwidget.cpp
 libkaddrbk_distributionlistng_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
 libkaddrbk_distributionlistng_la_LIBADD = $(XXLIBS)
+else
+libkaddrbk_distributionlist_la_SOURCES = distributionlistwidget.cpp
+libkaddrbk_distributionlist_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
+libkaddrbk_distributionlist_la_LIBADD = $(XXLIBS)
 endif
 
 libkaddrbk_resourceselection_la_SOURCES = resourceselection.cpp
@@ -30,4 +33,4 @@
 METASOURCES = AUTO
 
 servicedir  = $(kde_servicesdir)/kaddressbook
-service_DATA = $(DISTRIBUTIONLISTNG_DESKTOPFILE) distributionlist.desktop resourceselection.desktop
+service_DATA = $(DISTRIBUTIONLISTNG_DESKTOPFILE) $(DISTRIBUTIONLIST_DESKTOPFILE)  resourceselection.desktop
Index: libkholidays/holidays/holiday_nz
===================================================================
--- libkholidays/holidays/holiday_nz	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkholidays/holidays/holiday_nz	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -4,6 +4,7 @@
 : Author: Miles Leonard-Taylor (m.leonardtaylor@irl.cri.nz)
 : 13 September 2000 (first version)
 : 24 September 2004 (update with spelling corrections)
+: 11 February  2008 (change to daylight-savings rules by government)
 : Thanks to various people for pointing out all my spelling mistakes...
 
 : Holidays as defined by the government's "Holidays Acts, 1981-1991"
@@ -35,8 +36,9 @@
 small "Melbourne Cup" on first tuesday in november
 
 : Daylight Savings Reminders, defined by Internal Affairs
-small "Clocks Forward" on first sunday in october
-small "Clocks Back" on third sunday in march
+: see http://www.dia.govt.nz/diawebsite.nsf/wpg_URL/Services-Daylight-Saving-Index?OpenDocument
+small "Clocks Forward" on last sunday in september
+small "Clocks Back" on first sunday in april
 
 : Additional Easter dates and other Solemneties, defined by Catholic Church
 :small "Epiphany on sunday after january 2
Index: libkdepim/configure.in.in
===================================================================
--- libkdepim/configure.in.in	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkdepim/configure.in.in	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,20 +1,14 @@
 AC_MSG_CHECKING([whether to use new-style distribution lists])
 AC_ARG_ENABLE(newdistrlists,
-[AC_HELP_STRING([--enable-newdistrlists],
-                [Whether to use new distribution lists, to store them like normal contacts; useful for Kolab])],
-[case "${enableval}" in
-        yes)
-                AC_MSG_RESULT([yes])
-                AC_DEFINE(KDEPIM_NEW_DISTRLISTS, 1, [Define to 1 if you want to use the new distribution lists])
-                enable_new_distrlists="yes"
-                ;;
-        no)
-                AC_MSG_RESULT([no])
-                ;;
-        *)
-                AC_MSG_ERROR([bad value ${enableval} for --enable-newdistrlists])
-                ;;
-esac
-], [AC_MSG_RESULT([no])])
+AC_HELP_STRING([--disable-newdistrlists],
+                [Disables the new distribution lists (which are saved as addressee in the address book as normal contacts, useful for Kolab)]),
+                [ enable_new_distrlists=$enableval], [enable_new_distrlists=yes])dnl
+if test "$enable_new_distrlists" = "yes" ; then
+  AC_DEFINE_UNQUOTED(KDEPIM_NEW_DISTRLISTS, 1, [Define if you want to use the new distribution lists])
+  AC_MSG_RESULT(yes)
+else
+  AC_MSG_RESULT(no)
+fi
 
 AM_CONDITIONAL(compile_newdistrlists, test "x$enable_new_distrlists" = "xyes")
+
Index: libkcal/resourcelocaldir.cpp
===================================================================
--- libkcal/resourcelocaldir.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkcal/resourcelocaldir.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,6 +23,7 @@
 #include <stdlib.h>
 
 #include <qdatetime.h>
+#include <qfileinfo.h>
 #include <qstring.h>
 #include <qptrlist.h>
 
@@ -112,39 +113,50 @@
   delete mLock;
 }
 
+bool ResourceLocalDir::doOpen()
+{
+  QFileInfo dirInfo( mURL.path() );
+  return dirInfo.isDir() && dirInfo.isReadable() &&
+         ( dirInfo.isWritable() || readOnly() );
+}
+
 bool ResourceLocalDir::doLoad()
 {
   kdDebug(5800) << "ResourceLocalDir::load()" << endl;
 
   mCalendar.close();
   QString dirName = mURL.path();
-  bool success = true;
 
   if ( !( KStandardDirs::exists( dirName ) || KStandardDirs::exists( dirName + "/") ) ) {
-    kdDebug(5800) << "ResourceLocalDir::load(): Directory '" << dirName << "' doesn't exist yet. Creating it..." << endl;
-
+    kdDebug(5800) << "ResourceLocalDir::load(): Directory '" << dirName 
+                  << "' doesn't exist yet. Creating it..." << endl;
     // Create the directory. Use 0775 to allow group-writable if the umask
     // allows it (permissions will be 0775 & ~umask). This is desired e.g. for
     // group-shared directories!
-    success = KStandardDirs::makeDir( dirName, 0775 );
-  } else {
+    return KStandardDirs::makeDir( dirName, 0775 );
+  }
 
-    kdDebug(5800) << "ResourceLocalDir::load(): '" << dirName << "'" << endl;
-    QDir dir( dirName );
+  // The directory exists. Now try to open (the files in) it.
+  kdDebug(5800) << "ResourceLocalDir::load(): '" << dirName << "'" << endl;
+  QFileInfo dirInfo( dirName );
+  if ( !( dirInfo.isDir() && dirInfo.isReadable() && 
+          ( dirInfo.isWritable() || readOnly() ) ) )
+    return false;
 
-    QStringList entries = dir.entryList( QDir::Files | QDir::Readable );
+  QDir dir( dirName );
+  QStringList entries = dir.entryList( QDir::Files | QDir::Readable );
 
-    QStringList::ConstIterator it;
-    for( it = entries.begin(); it != entries.end(); ++it ) {
-      if ( (*it).endsWith( "~" ) ) // is backup file, ignore it
-        continue;
+  bool success = true;
+  QStringList::ConstIterator it;
+  for( it = entries.constBegin(); it != entries.constEnd(); ++it ) {
+    if ( (*it).endsWith( "~" ) ) // is backup file, ignore it
+      continue;
 
-      QString fileName = dirName + "/" + *it;
-      kdDebug(5800) << " read '" << fileName << "'" << endl;
-      CalendarLocal cal( mCalendar.timeZoneId() );
-      if ( !doFileLoad( cal, fileName ) ) {
-        success = false;
-      }
+    QString fileName = dirName + "/" + *it;
+    kdDebug(5800) << " read '" << fileName << "'" << endl;
+    CalendarLocal cal( mCalendar.timeZoneId() );
+    if ( !doFileLoad( cal, fileName ) ) {
+      success = false;
     }
   }
 
Index: libkcal/calendarresources.cpp
===================================================================
--- libkcal/calendarresources.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkcal/calendarresources.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -183,12 +183,12 @@
 {
   return mDestinationPolicy->parent();
 }
+
 void CalendarResources::setDialogParentWidget( QWidget *parent )
 {
   mDestinationPolicy->setParent( parent );
 }
 
-
 void CalendarResources::close()
 {
   kdDebug(5800) << "CalendarResources::close" << endl;
Index: libkcal/resourcelocaldir.h
===================================================================
--- libkcal/resourcelocaldir.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkcal/resourcelocaldir.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -77,6 +77,7 @@
     void reload( const QString & );
 
   protected:
+    virtual bool doOpen();
     virtual bool doLoad();
     virtual bool doSave();
     bool doSave( Incidence * );
Index: libkcal/resourcecalendar.cpp
===================================================================
--- libkcal/resourcecalendar.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ libkcal/resourcecalendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -109,8 +109,6 @@
   return true;
 }
 
-
-
 bool ResourceCalendar::load()
 {
   kdDebug(5800) << "Loading resource " + resourceName() << endl;
@@ -118,12 +116,14 @@
   mReceivedLoadError = false;
 
   bool success = true;
-  if ( !isOpen() ) success = open();
-  if ( success ) {
+  if ( !isOpen() )
+    success = open();
+  if ( success )
     success = doLoad();
-  }
-  if ( !success && !mReceivedLoadError ) loadError();
 
+  if ( !success && !mReceivedLoadError )
+    loadError();
+
   // If the resource is read-only, we need to set its incidences to read-only,
   // too. This can't be done at a lower-level, since the read-only setting
   // happens at this level
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -21,13 +21,16 @@
 Comment[de]=News-Leser (Akregator-Modul)
 Comment[el]=Συστατικό ανάγνωσης ροών (Πρόσθετο του Akregator)
 Comment[et]=Uudistevoogude plugin (Akregator)
+Comment[fr]=Composant du lecteur de flux (Module pour Akregator)
 Comment[it]=Componente lettore fonti (plugin Akregator)
 Comment[ja]=フィードリーダーコンポーネント (Akregator プラグイン)
 Comment[nds]=Stroomleser-Komponent (Akregator-Moduul)
 Comment[nl]=Component om feeds te lezen (Akregator-plugin)
+Comment[pl]=Składnik do czytania kanałów RSS (wtyczka Akregator)
 Comment[sr]=Компонента читања довода (прикључак Akregator-а)
 Comment[sr@Latn]=Komponenta čitanja dovoda (priključak Akregator-a)
 Comment[sv]=Komponent för läsning av kanaler (Akregator-insticksprogram)
+Comment[tr]=Kaynak Okuyucu Bileşeni (Akregator Eklentisi)
 Comment[zh_CN]=新闻源阅读器组件(Akregator 插件)
 Comment[zh_TW]=Feed 閱讀器組件（Akregator 外掛程式）
 Name=Feeds
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Wetter-Komponente für Kontact
 Comment[el]=Συστατικό καιρού του Kontact
 Comment[et]=Kontacti ilmaplugin
+Comment[fr]=Composant météo pour Kontact
 Comment[it]=Componente meteorologico di Kontact
 Comment[ja]=Kontact 気象情報コンポーネント
 Comment[nds]=Kontact-Wederkomponent
 Comment[nl]=Kontact Weercomponent
+Comment[pl]=Składnik Kontaktu wiadomości o pogodzie
 Comment[sr]=Компонента времена за Kontact
 Comment[sr@Latn]=Komponenta vremena za Kontact
 Comment[sv]=Kontacts väderkomponent
+Comment[tr]=Kontact Hava Durumu Bileşeni
 Comment[zh_CN]=Kontact 天气插件
 Comment[zh_TW]=Kontact 天氣組件
 Name=Weather Service
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -21,13 +21,16 @@
 Comment[de]=News-Komponente (KNode-Modul)
 Comment[el]=Συστατικό ανάγνωσης νέων (Πρόσθετο του KNode)
 Comment[et]=Uudistelugeja plugin (KNode)
+Comment[fr]=Composant de lecteur de nouvelles (Module pour KNode)
 Comment[it]=Componente lettore di news (plugin KNode)
 Comment[ja]=ニュースリーダーコンポーネント (KNode プラグイン)
 Comment[nds]=Narichtenkieker-Komponent (KNode-Moduul)
 Comment[nl]=Nieuwscomponent (KNode-plugin)
+Comment[pl]=Składnik wiadomości (wtyczka KNode)
 Comment[sr]=Компонента вести (прикључак KNode-а)
 Comment[sr@Latn]=Komponenta vesti (priključak KNode-a)
 Comment[sv]=Komponent för läsning av diskussionsgrupper (Knode-insticksprogram)
+Comment[tr]=Haber Okuyucu Bileşeni (KNode Eklentisi)
 Comment[zh_CN]=新闻组阅读器组件(KNode 插件)
 Comment[zh_TW]=新聞閱讀器組件（KNode 外掛程式）
 Name=News
Index: kontact/plugins/specialdates/kcmsdsummary.desktop
===================================================================
--- kontact/plugins/specialdates/kcmsdsummary.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/specialdates/kcmsdsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -18,13 +18,16 @@
 Name[de]=Übersicht über besondere Termine
 Name[el]=Επισκόπηση σημαντικών ημερομηνιών
 Name[et]=Tähtpäevade ülevaade
+Name[fr]=Aperçu des dates importantes
 Name[it]=Panoramica delle date speciali
 Name[ja]=特別な日の要約
 Name[nds]=Översicht besünner Daten
 Name[nl]=Overzicht van speciale data
+Name[pl]=Daty specjalne
 Name[sr]=Преглед посебних датума
 Name[sr@Latn]=Pregled posebnih datuma
 Name[sv]=Översikt av speciella datum
+Name[tr]=Özel Tarihlere Genel Bakış
 Name[zh_CN]=特殊日期概览
 Name[zh_TW]=特殊日期概觀
 Comment=Special Dates Summary Setup
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -30,7 +30,7 @@
 Name[eu]=Data bereziak
 Name[fa]=تاریخهای ویژه
 Name[fi]=Erikoispäivät
-Name[fr]=Dates particulières
+Name[fr]=Dates importantes
 Name[fy]=Spesjale datums
 Name[ga]=Dátaí Speisialta
 Name[gl]=Datas Especiais
@@ -72,12 +72,15 @@
 Comment[de]=Komponente für Übersicht über besondere Termine
 Comment[el]=Συστατικό σημαντικών ημερομηνιών
 Comment[et]=Tähtpäevade plugin
+Comment[fr]=Composant des dates importantes
 Comment[it]=Componente per le date speciali
 Comment[ja]=特別な日コンポーネント
 Comment[nds]=Komponent för besünner Daten
 Comment[nl]=Component voor overzicht van speciale data
+Comment[pl]=Składnik dat specjalnych
 Comment[sr]=Компонента посебних датума
 Comment[sr@Latn]=Komponenta posebnih datuma
 Comment[sv]=Speciella datumkomponent
+Comment[tr]=Özel Tarihler Bileşeni
 Comment[zh_CN]=特殊日期组件
 Comment[zh_TW]=特殊日期組件
Index: kontact/plugins/kitchensync/kitchensync.desktop
===================================================================
--- kontact/plugins/kitchensync/kitchensync.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/kitchensync/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -20,13 +20,16 @@
 Comment[de]=Abgleich-Komponente (KitchenSync-Modul)
 Comment[el]=Συστατικό συγχρονισμού (Πρόσθετο του Kitchensynk)
 Comment[et]=Sünkroniseerimise plugin (KitchenSync)
+Comment[fr]=Composant de synchronisation (Module KitchenSync)
 Comment[it]=Componente di sincronizzazione (plugin KitchenSync)
 Comment[ja]=同期コンポーネント (KitchenSync プラグイン)
 Comment[nds]=Synkroniseer-Komponent (Kitchensynk-Moduul)
 Comment[nl]=Synchronisatiecomponent (Kitchensynk-plugin)
+Comment[pl]=Składnik synchronizacji (wtyczka KitchenSync)
 Comment[sr]=Компонента синхронизације (прикључак KitchenSync-а)
 Comment[sr@Latn]=Komponenta sinhronizacije (priključak KitchenSync-a)
 Comment[sv]=Synkroniseringskomponent (Kitchensynk-insticksprogram)
+Comment[tr]=Eşzamanlama Eklentisi (Kitchensynk Eklentisi)
 Comment[zh_CN]=同步组件(KitchenSync 插件)
 Comment[zh_TW]=同步組件（KitchenSynk 外掛程式）
 Name=Sync
@@ -34,7 +37,9 @@
 Name[de]=Abgleich
 Name[el]=Συγχρονισμός
 Name[et]=Sünkroniseerimine
+Name[fr]=Synchroniser
 Name[ja]=同期
 Name[nds]=Synkroniseren
+Name[pl]=Synchronizacja
 Name[sv]=Synkronisering
 Name[zh_TW]=同步
Index: kontact/plugins/kpilot/kpilotplugin.desktop
===================================================================
--- kontact/plugins/kpilot/kpilotplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/kpilot/kpilotplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Palm-Komponente (KPilot-Modul)
 Comment[el]=Συστατικό εργαλείων Palm (Πρόσθετο του KPilot)
 Comment[et]=Palmi tööriistade plugin (KPilot)
+Comment[fr]=Composant d'outils pour Palms (Module KPilot)
 Comment[it]=Componente strumenti Palm (plugin KPilot)
 Comment[ja]=Palm ツールコンポーネント (KPilot プラグイン)
 Comment[nds]=Palmreekner-Warktüüchkomponent (KPilot-Moduul)
 Comment[nl]=Component met hulpmiddelen voor PalmOS(tm)-apparaten (KPilot-plugin)
+Comment[pl]=Składnik narzędzi Palma (wtyczka KPilot)
 Comment[sr]=Компонента алата за Palm (прикључак KPilot-а)
 Comment[sr@Latn]=Komponenta alata za Palm (priključak KPilot-a)
 Comment[sv]=Palm Pilot-verktygskomponent (Kpilot-insticksprogram)
+Comment[tr]=Palm Araçları Bileşeni (KPilot Eklentisi)
 Comment[zh_CN]=Palm 工具组件(KPilot 插件)
 Comment[zh_TW]=Palm 工具組件（KPilot 外掛程式）
 Name=Palm
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -21,13 +21,16 @@
 Comment[de]=Notizen-Komponente (KNotes-Modul)
 Comment[el]=Συσταικό σημειώσεων (Πρόσθετο του KNotes)
 Comment[et]=Märkmete plugin (KNotes)
+Comment[fr]=Composant de notes (Module KNotes)
 Comment[it]=Componente note (plugin KNotes)
 Comment[ja]=メモコンポーネント (KNotes プラグイン)
 Comment[nds]=Notizen-Komponent (KNotes-Moduul)
 Comment[nl]=Notitiecomponent (KNotes-plugin)
+Comment[pl]=Składnik notatek (wtyczka KNotes)
 Comment[sr]=Компонента белешки (прикључак KNotes-а)
 Comment[sr@Latn]=Komponenta beleški (priključak KNotes-a)
 Comment[sv]=Anteckningskomponent (Knotes-insticksprogram)
+Comment[tr]=Notlar Bileşeni (KNotes Eklentisi)
 Comment[zh_CN]=便笺组件(KNotes 插件)
 Comment[zh_TW]=便條組件（KNotes 外掛程式）
 Name=Notes
Index: kontact/plugins/karm/karmplugin.desktop
===================================================================
--- kontact/plugins/karm/karmplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/karm/karmplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -20,13 +20,16 @@
 Comment[de]=Zeitplaner-Komponente (KArm-Modul)
 Comment[el]=Συστατικό γραμμής χρόνου (Πρόσθετο του KArm)
 Comment[et]=Ajaarvestaja plugin (KArm)
+Comment[fr]=Composant de suivi temporel (Module pour KArm)
 Comment[it]=Componente segna-tempo (plugin Karm)
 Comment[ja]=タイムトラッカーコンポーネント (KArm プラグイン)
 Comment[nds]=Tietlogbook-Komponent (KArm-Moduul)
 Comment[nl]=Tijdsregistratiecomponent (KArm-plugin)
+Comment[pl]=Składnik śledzenia czasu (wtyczka KArm)
 Comment[sr]=Компонента праћења времена (прикључак KArm-а)
 Comment[sr@Latn]=Komponenta praćenja vremena (priključak KArm-a)
 Comment[sv]=Komponent för tidmätning (Karm-insticksprogram)
+Comment[tr]=Zaman İzleyici Bileşeni (KArm Eklentisi)
 Comment[zh_CN]=时间追踪组件(KArm 插件)
 Comment[zh_TW]=時間追蹤器組件（KArm 外掛程式）
 
@@ -36,9 +39,11 @@
 Name[de]=Stoppuhr
 Name[el]=Χρονόμετρο
 Name[et]=Ajaarvestaja
+Name[fr]=Minuteur
 Name[ja]=タイマー
 Name[nds]=Tietgever
 Name[nl]=Tijdklok
+Name[pl]=Stoper
 Name[sr]=Тајмер
 Name[sr@Latn]=Tajmer
 Name[sv]=Tidmätning
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Kontakte-Komponente (Adressbuch-Modul)
 Comment[el]=Συστατικό επαφών (Πρόσθετο του KAdressbook)
 Comment[et]=Kontaktide plugin (KDE aadressiraamat)
+Comment[fr]=Composant des contacts (module externe KAdressBook)
 Comment[it]=Componente contatti (plugin KAddressbook)
 Comment[ja]=アドレス帳コンポーネント (KAddressbook プラグイン)
 Comment[nds]=Kontakten-Komponent (KAddressbook-Moduul)
 Comment[nl]=Adresboekcomponent (KAddressbook-plugin)
+Comment[pl]=Składnik wizytówek (wtyczka KAddressBook)
 Comment[sr]=Компонента контаката (прикључак KAddressBook-а)
 Comment[sr@Latn]=Komponenta kontakata (priključak KAddressBook-a)
 Comment[sv]=Kontaktkomponent (adressboksinsticksprogram)
+Comment[tr]=Kişiler Bileşeni (KAdresDefteri Eklentisi)
 Comment[zh_CN]=联系人组件(KAddressbook 插件)
 Comment[zh_TW]=聯絡人組件（KAddressBook 外掛程式）
 Name=Contacts
@@ -85,7 +88,7 @@
 Name[ta]=தொடர்புகள்
 Name[tg]=Алоқот
 Name[th]=ที่อยู่ติดต่อ
-Name[tr]=Bağlantılar
+Name[tr]=Kişiler
 Name[uk]=Контакти
 Name[uz]=Алоқалар
 Name[zh_CN]=联系人
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -18,13 +18,16 @@
 Name[de]=Übersicht über Termine und Aufgaben
 Name[el]=Επισκόπηση ραντεβού και προς υλοποίηση εργασιών
 Name[et]=Kohtumised ja ülesannete ülevaade
+Name[fr]=Apercu des rendez-vous et des tâches
 Name[it]=Panoramica appuntamenti e cose da fare
 Name[ja]=約束と To-Do の要約
 Name[nds]=Termin- un Opgaven-Översicht
 Name[nl]=Overzicht van evenementen en taken
+Name[pl]=Spotkania i zadania
 Name[sr]=Преглед састанака и обавеза
 Name[sr@Latn]=Pregled sastanaka i obaveza
 Name[sv]=Översikt av möten och uppgifter
+Name[tr]=Randevulara ve Yapılacaklara Genel Bakış
 Name[zh_CN]=约会和待办概览
 Name[zh_TW]=約會與待辦事項概觀
 Comment=Appointments and To-dos Summary Setup
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Aufgabenlisten-Komponente (KOrganizer-Modul)
 Comment[el]=Συστατικό λίστα προς υλοποίηση εργασιών (Πρόσθετο του KOrganizer)
 Comment[et]=Ülesannete nimekirja plugin (KOrganizer)
+Comment[fr]=Composant de la liste des tâches (Module KOrganizer)
 Comment[it]=Componente elenco delle cose da fare (plugin KOrganizer)
 Comment[ja]=To-Do リストコンポーネント (KOrganizer プラグイン)
 Comment[nds]=Opgavenlist-Komponent (KOrganizer-Moduul)
 Comment[nl]=Takenlijstcomponent (KOrganizer-plugin)
+Comment[pl]=Składnik zadań (wtyczka KOrganizer)
 Comment[sr]=Прикључак листе обавеза (прикључак KOrganizer-а)
 Comment[sr@Latn]=Priključak liste obaveza (priključak KOrganizer-a)
 Comment[sv]=Uppgiftslistkomponent (Korganizer-insticksprogram)
+Comment[tr]=Yapılacak İşler Bileşeni (KOrganizer eklentisi)
 Comment[zh_CN]=待办清单组件(KOrganizer 插件)
 Comment[zh_TW]=待辦事項清單組件（KOrganizer 外掛程式）
 Name=To-do
@@ -39,12 +42,15 @@
 Name[de]=Aufgaben
 Name[el]=Προς υλοποίηση εργασίες
 Name[et]=Ülesanded
+Name[fr]=Tâches
 Name[it]=Cose da fare
 Name[ja]=To-Do
 Name[nds]=Opgaav
 Name[nl]=Takenlijst
+Name[pl]=Lista zadań
 Name[sr]=Обавезе
 Name[sr@Latn]=Obaveze
 Name[sv]=Uppgift
+Name[tr]=Yapılacak Ögeleri
 Name[zh_CN]=待办清单
 Name[zh_TW]=待辦事項
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Journal-Komponente (KOrganizer-Modul)
 Comment[el]=Συστατικό χρονικών (Πρόσθετο του KOrganizer)
 Comment[et]=Päevikuplugin (KOrganizer)
+Comment[fr]= Composant de journal (Module KOrganizer)
 Comment[it]=Componente diario (plugin KOrganizer)
 Comment[ja]=ジャーナルコンポーネント (KOrganizer プラグイン)
 Comment[nds]=Daagböker-Komponent (KOrganizer-Moduul)
 Comment[nl]=Journaalcomponent (KOrganizer-plugin)
+Comment[pl]=Składnik dziennika (wtyczka Korganizer)
 Comment[sr]=Компонента дневника (прикључак KOrganizer-а)
 Comment[sr@Latn]=Komponenta dnevnika (priključak KOrganizer-a)
 Comment[sv]=Journalkomponent (Korganizer-insticksprogram)
+Comment[tr]=Günlük Bileşeni (KOrganizer Eklentisi)
 Comment[zh_CN]=日记组件(KOrganizer 插件)
 Comment[zh_TW]=日誌組件（KOrganizer 外掛程式）
 Name=Journal
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -23,13 +23,16 @@
 Comment[de]=Kalender-Komponente (KOrganizer-Modul)
 Comment[el]=Συστατικό ημερολογίου (Πρόσθετο του KOrganizer)
 Comment[et]=Kalendriplugin (KOrganizer)
+Comment[fr]= Composant de calendrier (Module KOrganizer)
 Comment[it]=Componente calendario (plugin KOrganizer)
 Comment[ja]=カレンダーコンポーネント (KOrganizer プラグイン)
 Comment[nds]=Kalenner-Komponent (KOrganizer-Moduul)
 Comment[nl]=Agendacomponent (KOrganizer-plugin)
+Comment[pl]=Składnik kalendarza (wtyczka KOrganizer)
 Comment[sr]=Компонента календара (прикључак KOrganizer-а)
 Comment[sr@Latn]=Komponenta kalendara (priključak KOrganizer-a)
 Comment[sv]=Kalenderkomponent (Korganizer-insticksprogram)
+Comment[tr]=Takvim Bileşeni (KOrganizer Eklentisi)
 Comment[zh_CN]=日历组件(KOrganizer 插件)
 Comment[zh_TW]=行事曆組件（KOrganizer 外掛程式）
 Name=Calendar
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -24,13 +24,16 @@
 Comment[de]=E-Mail-Komponente (KMail-Modul)
 Comment[el]=Συστατικό αλληλογραφίας (Πρόσθετο του KMail)
 Comment[et]=E-posti plugin (KMail)
+Comment[fr]=Composant de courrier (Module pour KMail)
 Comment[it]=Componente posta elettronica (plugin KMail)
 Comment[ja]=メールコンポーネント (KMail プラグイン)
 Comment[nds]=Nettpost-Komponent (KMail-Moduul)
 Comment[nl]=E-mailcomponent (KMail-plugin)
+Comment[pl]=Składnik poczty (wtyczka KMail)
 Comment[sr]=Компонента е-поште (прикључак KMail-а)
 Comment[sr@Latn]=Komponenta e-pošte (priključak KMail-a)
 Comment[sv]=E-postkomponent (Kmail-insticksprogram)
+Comment[tr]=E-Posta Bileşeni (KMail Eklentisi)
 Comment[zh_CN]=邮件组件(KMail 插件)
 Comment[zh_TW]=電子郵件組件（KMail 外掛程式）
 Name=E-Mail
@@ -39,12 +42,15 @@
 Name[da]=E-mail
 Name[el]=Αλληλογραφία
 Name[et]=E-post
+Name[fr]=Courrier
 Name[it]=Posta elettronica
 Name[ja]=メール
 Name[nds]=Nettpost
 Name[nl]=E-mail
+Name[pl]=E-mail
 Name[sr]=Е-пошта
 Name[sr@Latn]=E-pošta
 Name[sv]=E-post
+Name[tr]=E-Posta
 Name[zh_CN]=邮件
 Name[zh_TW]=電子郵件
Index: kontact/plugins/kmail/kcmkmailsummary.desktop
===================================================================
--- kontact/plugins/kmail/kcmkmailsummary.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/kmail/kcmkmailsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -18,13 +18,16 @@
 Name[de]=E-Mail-Übersicht
 Name[el]=Επισκόπηση αλληλογραφίας
 Name[et]=E-posti ülevaade
+Name[fr]=Apercu du courrier
 Name[it]=Panoramica posta elettronica
 Name[ja]=メールの要約
 Name[nds]=Nettpost-Översicht
 Name[nl]=E-mailoverzicht
+Name[pl]=Poczta
 Name[sr]=Преглед е-поште
 Name[sr@Latn]=Pregled e-pošte
 Name[sv]=E-postöversikt
+Name[tr]=E-Postalara Genel Bakış
 Name[zh_CN]=邮件概览
 Name[zh_TW]=郵件概要
 Comment=E-Mail Summary Setup
@@ -34,13 +37,16 @@
 Comment[de]=Einstellungen für E-Mail-Übersicht
 Comment[el]=Ρύθμιση σύνοψης αλληλογραφίας
 Comment[et]=E-posti kokkuvõtte seadistus
+Comment[fr]=Configuration du résumé des méls
 Comment[it]=Impostazioni sommario posta elettronica
 Comment[ja]=メール要約の設定
 Comment[nds]=Instellen för Nettpost-Översicht
 Comment[nl]=Instellingen voor e-mailoverzicht
+Comment[pl]=Ustawienia podsumowania e-maili
 Comment[sr]=Подешавање сажетка е-поште
 Comment[sr@Latn]=Podešavanje sažetka e-pošte
 Comment[sv]=Inställning av e-postöversikt
+Comment[tr]=E-Posta Özet Yapılandırması
 Comment[zh_CN]=邮件摘要设置
 Comment[zh_TW]=郵件摘要設定
 Keywords=email, summary, configure, settings
@@ -75,7 +81,7 @@
 Keywords[ne]=इमेल, सारांश, कन्फिगर, सेटिङ
 Keywords[nl]=email,e-mail,overzicht,samenvatting,instellingen,configuratie
 Keywords[nn]=e-post,samandrag,oppsett,innstillingar
-Keywords[pl]=email,list,podsumowanie,konfiguracja,ustawienia
+Keywords[pl]=e-mail,list,podsumowanie,konfiguracja,ustawienia
 Keywords[pt]=e-mail, sumário, configurar, configuração
 Keywords[pt_BR]=e-mail, resumo, configurar, configurações
 Keywords[ru]=email,summary,configure,settings,настройки,дайджест,почта
Index: kontact/plugins/summary/kcmkontactsummary.desktop
===================================================================
--- kontact/plugins/summary/kcmkontactsummary.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/summary/kcmkontactsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -14,6 +14,7 @@
 Name=Summary View Items
 Name[bg]=Обобщение
 Name[ca]=Vista resum d'elements
+Name[da]=Elementer i opsummeringsvisning
 Name[de]=Elemente der Zusammenfassungsansicht
 Name[el]=Αντικείμενα προβολής σύνοψης
 Name[et]=Kokkuvõttevaate elemendid
@@ -24,7 +25,9 @@
 Name[sr]=Ставке приказа сажетка
 Name[sr@Latn]=Stavke prikaza sažetka
 Name[sv]=Objekt i översiktsvy
+Name[tr]=Özet Görünüm Ögeleri
 Name[zh_CN]=摘要视图项目
+Name[zh_TW]=摘要檢視項目
 Comment=General Configuration of Kontact's Summary View
 Comment[af]=Algemene opstelling van Kontact se opsomming aansig
 Comment[bg]=Настройка на обобщението
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -19,13 +19,16 @@
 Comment[de]=Zusammenfassungsansicht-Komponente
 Comment[el]=Συστατικό προβολής σύνοψης
 Comment[et]=Kokkuvõttevaate plugin
+Comment[fr]=Composant de la vue résumée
 Comment[it]=Componente vista sommario
 Comment[ja]=要約ビューコンポーネント
 Comment[nds]=Översicht-Komponent
 Comment[nl]=Overzichtsweergaveitem
+Comment[pl]=Składnik widoku podsumowania
 Comment[sr]=Компонента приказа сажетка
 Comment[sr@Latn]=Komponenta prikaza sažetka
 Comment[sv]=Översiktsvykomponent
+Comment[tr]=Özet Görünüm Bileşeni
 Comment[zh_CN]=摘要视图组件
 Comment[zh_TW]=摘要檢視組件
 Name=Summary
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -22,13 +22,16 @@
 Comment[de]=Newsticker-Komponente
 Comment[el]=Συστατικό προβολέα ειδήσεων
 Comment[et]=Uudistejälgija plugin
+Comment[fr]=Composant Newsticker
 Comment[it]=Componente ticker notizie
 Comment[ja]=ニュースティッカーコンポーネント
 Comment[nds]=Narichtentelegraaf-Komponent
 Comment[nl]=Nieuwstickercomponent
+Comment[pl]=Składnik paska wiadomości
 Comment[sr]=Компонента откуцавача вести
 Comment[sr@Latn]=Komponenta otkucavača vesti
 Comment[sv]=Nyhetsövervakningskomponent
+Comment[tr]=Haber İzleyici Bileşeni
 Comment[zh_CN]=新闻点点通组件
 Comment[zh_TW]=新聞顯示組件
 Name=News
Index: kontact/interfaces/kontactplugin.desktop
===================================================================
--- kontact/interfaces/kontactplugin.desktop	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/interfaces/kontactplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -37,7 +37,7 @@
 Name[nds]=Kontact-Moduul
 Name[ne]=सम्पर्क प्लगइन
 Name[nn]=Kontact-programtillegg
-Name[pl]=Wtyczka Kontact
+Name[pl]=Wtyczka Kontakt
 Name[pt]='Plugin' do Kontact
 Name[pt_BR]=Plug-in do Kontact
 Name[ro]=Modul Kontact
Index: kontact/src/kontact.setdlg
===================================================================
--- kontact/src/kontact.setdlg	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ kontact/src/kontact.setdlg	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -6,13 +6,16 @@
 Name[de]=Übersicht
 Name[el]=Προβολή σύνοψης
 Name[et]=Kokkuvõttevaade
+Name[fr]=Vue résumée
 Name[it]=Vista sommario
 Name[ja]=要約ビュー
 Name[nds]=Översicht
 Name[nl]=Overzichtsweergave
+Name[pl]=Podsumowanie
 Name[sr]=Приказ сажетка
 Name[sr@Latn]=Prikaz sažetka
 Name[sv]=Översiktsvy
+Name[tr]=Özet Görünümü
 Name[zh_CN]=摘要视图
 Name[zh_TW]=摘要檢視
 Comment=Configuration of Kontact's <b>Summary View</b>. Some plugins provide <i>Summary View</i> items, choose the ones you would like to list.
@@ -22,10 +25,12 @@
 Comment[de]=Einrichtung der <b>Zusammenfassungsansicht</b> von Kontact. Einige Kontact-Module stellen Elemente für die <i>Zusammenfassungsansicht</i> zur Verfügung. Wählen Sie hier, welche Elemente angezeigt werden sollen.
 Comment[el]=Ρύθμιση της <b>Προβολής σύνοψης</b> του  Kontact. Κάποια πρόσθετα παρέχουν αντικείμενα <i>Προβολή σύνοψης</i>· επιλέξτε αυτά που θέλετε να εμφανίζονται.
 Comment[et]=Kontacti <b>kokkuvõttevaate</b> seadistamine. Mõned pluginad pakuvad <i>kokkuvõttevaate</i> elemente. Vali nimekirjas need, mida soovid näha.
+Comment[fr]=Configuration de Kontact <b> Vue résumée</b>. Certains modules fournissent des éléments de <i>Vue Résumée</i>, choisissez ceux que vous voulez voir listés.
 Comment[it]=Configurazione della <b>vista sommario</b> di Kontact. Alcuni plugin forniscono elementi di <i>vista sommario</i>, scegli quelli che desideri vedere nell'elenco.
 Comment[ja]=Kontact の要約ビューの設定。要約ビューの項目を提供するプラグインがいくつかあります。要約ビューに表示させる項目を選択してください。
 Comment[nds]=Kontact sien <b>Översicht</b> instellen. En Reeg Modulen stellt Indrääg för de <i>Översicht</i> praat. Hier kannst Du de utsöken, de Du hebben wullt.
 Comment[nl]=Configuratie van Kontacts <b>Overzichtsweergave</b>. Sommige plugins bieden ook items aan voor de <i>Overzichtweergave</i>, kies welke u wilt zien.
+Comment[pl]=Konfiguracja <b>Podsumowania</b> Kontaktu. Niektóre wtyczki zapewniają elementy <i>Widok podsumowania</i>, wybierz te które chcesz zobaczyć.
 Comment[sr]=Подешавање Kontact-овог <b>приказа сажетка</b>. Неки прикључци дају ставке <i>приказа сажетка</i>, изаберите оне које желите.
 Comment[sr@Latn]=Podešavanje Kontact-ovog <b>prikaza sažetka</b>. Neki priključci daju stavke <i>prikaza sažetka</i>, izaberite one koje želite.
 Comment[sv]=Inställning av Kontacts <b>översiktsvy</b>. Vissa insticksprogram tillhandahåller objekt för <i>översiktsvyn</i>. Välj de du skulle vilja visa.
@@ -41,13 +46,16 @@
 Name[da]=E-mail
 Name[el]=Αλληλογραφία
 Name[et]=E-post
+Name[fr]=Courrier
 Name[it]=Posta elettronica
 Name[ja]=メール
 Name[nds]=Nettpost
 Name[nl]=E-mail
+Name[pl]=E-mail
 Name[sr]=Е-пошта
 Name[sr@Latn]=E-pošta
 Name[sv]=E-post
+Name[tr]=E-Posta
 Name[zh_CN]=邮件
 Name[zh_TW]=電子郵件
 Comment=Configuration of Kontact's E-Mail Plugin <b>KMail</b>, includes a <i>Summary View Item</i> and represents a <i>Kontact Component</i>.
@@ -57,9 +65,11 @@
 Comment[de]=Einrichtung des E-Mail-Moduls <b>KMail</b> für Kontact. Die E-Mail-Komponente kann als <i>Kontact-Komponente<i> in die <i>Zusammenfassungsansicht</i> integriert werden.
 Comment[el]=Η ρύθμιση του προσθέτου αλληλογραφίας <b>KMail</b> του Kontact, περιέχει ένα <i>Αντικείμενο προβολής σύνοψης</i> και αντιπροσωπεύει ένα <i>Συστατικό του Kontact</i>.
 Comment[et]=Kontacti e-posti plugina <b>KMaili</b> seadistamine, mis sisaldab <i>kokkuvõttevaate elementi</i>.
+Comment[fr]=Configuration du Module de Courrier de Kontact <b>KMail</b>, inclut un <i>Élément de Vue Résumée</i> et correspond à un <i>Composant de Kontact</i>.
 Comment[it]=Configurazione del plugin di posta elettronica <b>KMail</b> di Kontact, include una <i>vista sommario</i> e rappresenta un <i>componente Kontact</i>. 
 Comment[nds]=Kontact sien Nettpost-Moduul <b>KMail</b> instellen. Stellt en <i>Översicht-Indrag</i> praat un is en <i>Kontact-Komponent</i>.
 Comment[nl]=Instellingen voor Kontacts e-mailplugin <b>KMail</b>. Bevat een <i>Overzichtsweergaveplugin</i> en een <i>Kontact-component</i>.
+Comment[pl]=Konfiguracja wtyczki poczty Kontaktu <b>KMail</b>, zawiera <i>element Podsumowanie</i> i jest <i>Składnikiem Kontaktu</i>.
 Comment[sr]=Подешавање Kontact-овог прикључка за е-пошту преко <b>KMail-</b>, укључујући <i>приказ сажетка</i>, и дат као <i>компонента Kontact-а</i>.
 Comment[sr@Latn]=Podešavanje Kontact-ovog priključka za e-poštu preko <b>KMail-</b>, uključujući <i>prikaz sažetka</i>, i dat kao <i>komponenta Kontact-a</i>.
 Comment[sv]=Inställning av Kontacts e-postinsticksprogram <b>Kmail</b>, omfattar ett objekt för <i>översiktsvyn</i> och representerar en <i>Kontactkomponent</i>.
@@ -122,7 +132,7 @@
 Name[ta]=தொடர்புகள்
 Name[tg]=Алоқот
 Name[th]=ที่อยู่ติดต่อ
-Name[tr]=Bağlantılar
+Name[tr]=Kişiler
 Name[uk]=Контакти
 Name[uz]=Алоқалар
 Name[zh_CN]=联系人
@@ -134,9 +144,11 @@
 Comment[de]=Einrichtung des Adressbuch-Moduls für Kontact, welches eine <i>Kontact-Komponente</i> repräsentiert.
 Comment[el]=Ρύθμιση του πρόσθετου βιβλίου διευθύνσεων <b>KAdressbook</b> του Kontact που αντιπροσωπεύει ένα <i>Συστατικό του Kontact</i>.
 Comment[et]=Kontacti aadressiraamatu plugina <b>KAdressbook</b> seaditamine.
+Comment[fr]=Configuration du Module de Carnet d'Adresses de Kontact <b> KAdressbook</b> qui correspond à un <i>Composant de Kontact</i>.
 Comment[it]=Configurazione del plugin rubrica di <b>KAddressbook</b> che rappresenta un <i>componente Kontact</i>.
 Comment[nds]=Kontact sien Adressbook-Moduul <b>KAddressbook</b> instellende, dat en <i>Kontact-Komponent</i> is.
 Comment[nl]=Instellingen voor Kontacts adresboekplugin <b>KMail</b>. Bevat een <i>Kontact-component</i>.
+Comment[pl]=Konfiguracja wtyczki książki adresowej Kontaktu <b>KAddressBook</b>, która jest <i>Składnikiem Kontaktu</i>.
 Comment[sr]=Подешавање Kontact-овог прикључка за адресар преко <b>KAdressbook</b> у облику <i>компоненте Kontact-а</i>.
 Comment[sr@Latn]=Podešavanje Kontact-ovog priključka za adresar preko <b>KAdressbook</b> u obliku <i>komponente Kontact-a</i>.
 Comment[sv]=Inställning av Kontacts adressboksinsticksprogram <b>Kaddressbook</b>, som representerar en <i>Kontactkomponent</i>.
@@ -309,9 +321,11 @@
 Comment[de]=Einrichtung des Kalender-Moduls <b>KOrganizer</b> für Kontact, einschließlich der <i>Zusammenfassungsansicht</i>; repräsentiert eine <i>Kontact-Komponente</i>
 Comment[el]=Η ρύθμιση του προσθέτου ημερολογίου του <b>KOrganizer</b> του Kontact, περιέχει ένα <i>Αντικείμενο προβολής σύνοψης</i> και αντιπροσωπεύει ένα <i>Συστατικό του Kontact</i>.
 Comment[et]=Kontacti kalendriplugina <b>KOrganizeri</b> seadistamine, mis sisaldab <i>kokkuvõttevaate elementi</i>.
+Comment[fr]=Configuration du Module de Calendrier de Kontact <b>KOrganizer</b>, inclut un <i>Élément de Vue Résumée</i> et correspond à un <i>Composant de Kontact</i>.
 Comment[it]=Configurazione del plugin calendario <b>KOrganizer</b> di Kontact, include una <i>vista sommario</i> e rappresenta un <i>componente Kontact</i>.
 Comment[nds]=Kontact sien Kalenner-Moduul <b>KOrganizer</b> instellen. Stellt en <i>Översicht-Indrag</i> praat un is en <i>Kontact-Komponent</i>.
 Comment[nl]=Instellingen voor Kontacts agendaplugin <b>KOrganizer</b>. Bevat een <i>Overzichtsweergaveplugin</i> en een <i>Kontact-component</i>.
+Comment[pl]=Konfiguracja wtyczki kalendarza Kontaktu <b>KOrganizer</b>, zawiera <i>element Podsumowanie</i> i jest <i>Składnikiem Kontaktu</i>.
 Comment[sr]=Подешавање Kontact-овог прикључка за календар преко <b>KOrganizer-а</b>, укључујући <i>приказ сажетка</i>, и дат као <i>компонента Kontact-а</i>.
 Comment[sr@Latn]=Podešavanje Kontact-ovog priključka za kalendar preko <b>KOrganizer-a</b>, uključujući <i>prikaz sažetka</i>, i dat kao <i>komponenta Kontact-a</i>.
 Comment[sv]=Inställning av Kontacts kalenderinsticksprogram <b>Korganizer</b>, omfattar ett objekt för <i>översiktsvyn</i> och representerar en <i>Kontactkomponent</i>.
@@ -386,9 +400,11 @@
 Comment[de]=Einrichtung des News-Moduls <b>KNode</b> für Kontact; repräsentiert eine <i>Kontact-Komponente</i>
 Comment[el]=Ρύθμιση του πρόσθετου νέων <b>KNode</b> του Kontact που αντιπροσωπεύει ένα <i>Συστατικό του Kontact</i>.
 Comment[et]=Kontacti uudisteplugina <b>KNode</b> seadistamine.
+Comment[fr]=Configuration du Module de Nouvelles de Kontact <b>KNode</b> qui correspond à un <i>Composant de Kontact</i>.
 Comment[it]=Configurazione del plugin notizie <b>KNode</b> di Kontact, che rappresenta un <i>componente Kontact</i>.
 Comment[nds]=Kontact sien Narichten-Moduul <b>KNode</b> instellen, dat en <i>Kontact-Komponent</i> is.
 Comment[nl]=Instellingen voor Kontacts nieuwsplugin <b>KNode</b>. Bevat een <i>Kontact-component</i>.
+Comment[pl]=Konfiguracja wtyczki wiadomości Kontaktu <b>KNode</b>, która jest <i>składnikiem Kontaktu</i>.
 Comment[sr]=Подешавање Kontact-овог прикључка за вести преко <b>KNode-а</b> у облику <i>компненте Kontact-а</i>.
 Comment[sr@Latn]=Podešavanje Kontact-ovog priključka za vesti preko <b>KNode-a</b> u obliku <i>kompnente Kontact-a</i>.
 Comment[sv]=Inställning av Kontacts nyhetsinsticksprogram <b>Knode</b>, som representerar en <i>Kontactkomponent</i>.
@@ -463,13 +479,16 @@
 Comment[de]=Komponente für Wetterinformationen
 Comment[el]=Συστατικό πληροφοριών καιρού
 Comment[et]=Ilmateate komponent
+Comment[fr]=Composant d'Informations météorologiques
 Comment[it]=Informazioni meteorologiche
 Comment[ja]=気象情報コンポーネント
 Comment[nds]=Wederinformatschonen-Komponent
 Comment[nl]=Weerinformatiecomponent
+Comment[pl]=Składnik informacji o pogodzie
 Comment[sr]=Компонента информација о времену
 Comment[sr@Latn]=Komponenta informacija o vremenu
 Comment[sv]=Komponent med väderrapport
+Comment[tr]=Hava Durumu Bilgisi Bileşeni
 Comment[zh_CN]=天气信息组件
 Comment[zh_TW]=天氣資訊組件
 Weight=1000
Index: korganizer/koeventview.cpp
===================================================================
--- korganizer/koeventview.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeventview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -71,6 +71,8 @@
                      SIGNAL(cutIncidenceSignal(Incidence *)));
   connect(eventPopup,SIGNAL(copyIncidenceSignal(Incidence *)),
                      SIGNAL(copyIncidenceSignal(Incidence *)));
+  connect(eventPopup,SIGNAL(pasteIncidenceSignal()),
+                     SIGNAL(pasteIncidenceSignal()));
   connect(eventPopup,SIGNAL(toggleAlarmSignal(Incidence *)),
                      SIGNAL(toggleAlarmSignal(Incidence*)));
   connect(eventPopup,SIGNAL(dissociateOccurrenceSignal( Incidence *, const QDate & )),
Index: korganizer/koeditorgeneral.cpp
===================================================================
--- korganizer/koeditorgeneral.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeditorgeneral.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -304,6 +304,12 @@
   mAlarmEditButton->setEnabled( enable );
 }
 
+
+void KOEditorGeneral::toggleAlarm( bool on )
+{
+    mAlarmButton->setChecked( on );
+}
+
 void KOEditorGeneral::setCategories( const QStringList &categories )
 {
   mCategoriesLabel->setText( categories.join(",") );
Index: korganizer/koeditorfreebusy.cpp
===================================================================
--- korganizer/koeditorfreebusy.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeditorfreebusy.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -254,13 +254,6 @@
   connect( button, SIGNAL( clicked() ), SLOT( slotCenterOnStart() ) );
   controlLayout->addWidget( button );
 
-  button = new QPushButton( i18n( "Zoom to Fit" ), this );
-  QWhatsThis::add( button,
-		   i18n("Zooms the Gantt chart so that you can see the "
-			"entire duration of the event on it.") );
-  connect( button, SIGNAL( clicked() ), SLOT( slotZoomToTime() ) );
-  controlLayout->addWidget( button );
-
   controlLayout->addStretch( 1 );
 
   button = new QPushButton( i18n( "Pick Date" ), this );
@@ -294,7 +287,7 @@
   }
   mGanttView->setHeaderVisible( true );
   mGanttView->setScale( KDGanttView::Hour );
-  mGanttView->setShowHeaderPopupMenu( true, true, true, false, false, true );
+  mGanttView->setShowHeaderPopupMenu( false, false, false, false, false, false );
   // Initially, show 15 days back and forth
   // set start to even hours, i.e. to 12:AM 0 Min 0 Sec
   QDateTime horizonStart = QDateTime( QDateTime::currentDateTime()
Index: korganizer/koeditorgeneral.h
===================================================================
--- korganizer/koeditorgeneral.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeditorgeneral.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -86,6 +86,7 @@
     bool validateInput() { return true; }
 
     void enableAlarm( bool enable );
+    void toggleAlarm( bool on );
 
     void setSummary( const QString & );
     void setDescription( const QString & );
Index: korganizer/timelineitem.cpp
===================================================================
--- korganizer/timelineitem.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/timelineitem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -119,13 +119,13 @@
     y = coordY;
   else
     y = getCoordY();
-  int startX = myGanttView->myTimeHeader->getCoordX(myStartTime);
-  int endX = myGanttView->myTimeHeader->getCoordX(myEndTime);
+  int startX = myGanttView->timeHeaderWidget()->getCoordX(myStartTime);
+  int endX = myGanttView->timeHeaderWidget()->getCoordX(myEndTime);
 
   const int mw = QMAX( 1, QMIN( 4, endX - startX ) );
   if ( !mLeft || mw != mMarkerWidth ) {
     if ( !mLeft ) {
-      mLeft = new KDCanvasPolygon( myGanttView->myTimeTable, this, Type_is_KDGanttViewItem );
+      mLeft = new KDCanvasPolygon( myGanttView->timeTableWidget(), this, Type_is_KDGanttViewItem );
       mLeft->setBrush( Qt::black );
     }
     QPointArray a = QPointArray( 4 );
@@ -137,7 +137,7 @@
   }
   if ( !mRight || mw != mMarkerWidth ) {
     if ( !mRight ) {
-      mRight = new KDCanvasPolygon( myGanttView->myTimeTable, this, Type_is_KDGanttViewItem );
+      mRight = new KDCanvasPolygon( myGanttView->timeTableWidget(), this, Type_is_KDGanttViewItem );
       mRight->setBrush( Qt::black );
     }
     QPointArray a = QPointArray( 4 );
Index: korganizer/calendarview.h
===================================================================
--- korganizer/calendarview.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/calendarview.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -302,6 +302,11 @@
       Copies the selected incidence using the edit_copy() method
     */
     void copyIncidence( Incidence *);
+    /**
+      Pastes the curren incidence using the edit_paste() method
+    */
+    void pasteIncidence();
+
     /** Delete the supplied todo and all sub-todos */
     void deleteSubTodosIncidence ( Todo *todo );
     /**
Index: korganizer/multiagendaview.cpp
===================================================================
--- korganizer/multiagendaview.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/multiagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -112,6 +112,8 @@
              SIGNAL(cutIncidenceSignal(Incidence*)) );
     connect( agenda, SIGNAL(copyIncidenceSignal(Incidence*)),
              SIGNAL(copyIncidenceSignal(Incidence*)) );
+    connect( agenda, SIGNAL(pasteIncidenceSignal()),
+             SIGNAL(pasteIncidenceSignal()) );
     connect( agenda, SIGNAL(toggleAlarmSignal(Incidence*)),
              SIGNAL(toggleAlarmSignal(Incidence*)) );
     connect( agenda, SIGNAL(dissociateOccurrenceSignal(Incidence*, const QDate&)),
Index: korganizer/koeventpopupmenu.h
===================================================================
--- korganizer/koeventpopupmenu.h	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeventpopupmenu.h	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -51,6 +51,7 @@
   protected slots:
     void popupShow();
     void popupEdit();
+    void popupPaste();
     void print();
     void popupDelete();
     void popupCut();
@@ -66,6 +67,7 @@
     void deleteIncidenceSignal(Incidence *);
     void cutIncidenceSignal(Incidence *);
     void copyIncidenceSignal(Incidence *);
+    void pasteIncidenceSignal();
     void toggleAlarmSignal(Incidence *);
     void dissociateOccurrenceSignal( Incidence *, const QDate & );
     void dissociateFutureOccurrenceSignal( Incidence *, const QDate & );
Index: korganizer/kotodoeditor.cpp
===================================================================
--- korganizer/kotodoeditor.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/kotodoeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -47,7 +47,6 @@
 #include "koeditorgeneraltodo.h"
 #include "koeditordetails.h"
 #include "koeditorrecurrence.h"
-#include "koeditoralarms.h"
 
 #include "kotodoeditor.h"
 #include "kocore.h"
@@ -117,8 +116,7 @@
     mGeneral->initCompletion(topFrame2,completionLayout);
 
     mGeneral->initAlarm(topFrame,topLayout);
-    mGeneral->enableAlarm( false );
-
+ 
     mGeneral->initSecrecy( topFrame2, topLayout2 );
     mGeneral->initDescription(topFrame2,topLayout2);
   } else {
@@ -132,7 +130,6 @@
     mGeneral->initStatus(topFrame,topLayout);
     QBoxLayout *alarmLineLayout = new QHBoxLayout(topLayout);
     mGeneral->initAlarm(topFrame,alarmLineLayout);
-    mGeneral->enableAlarm( false );
     alarmLineLayout->addStretch( 1 );
     mGeneral->initDescription(topFrame,topLayout);
     mGeneral->initAttachments(topFrame,topLayout);
@@ -141,9 +138,7 @@
     connect( this, SIGNAL( signalAddAttachments( const QStringList&, const QStringList&, bool ) ),
              mGeneral, SLOT( addAttachments( const QStringList&, const QStringList&, bool ) ) );
   }
-  // By default, the To-do has no time associated and
-  // neither a start nor end time.
-  mGeneral->setDefaults( QDateTime(), false );
+  mGeneral->enableAlarm( true );
 
   mGeneral->finishSetup();
 }
@@ -185,6 +180,7 @@
   mTodo = 0;
   mCalendar = 0;
   setCaption( i18n("New To-do") );
+  loadDefaults();
 }
 
 void KOTodoEditor::setTexts( const QString &summary, const QString &description )
@@ -205,6 +201,7 @@
 {
   kdDebug(5850) << k_funcinfo << endl;
   setDates( QDateTime::currentDateTime().addDays(7), true, 0 );
+  mGeneral->toggleAlarm( true );
 }
 
 bool KOTodoEditor::processInput()
@@ -287,7 +284,6 @@
   kdDebug(5850)<<"read todo"<<endl;
   mGeneral->readTodo( todo, calendar );
   mDetails->readEvent( todo );
-//  mAlarms->readIncidence( todo );
   mRecurrence->readIncidence( todo );
 
   createEmbeddedURLPages( todo );
Index: korganizer/kodaymatrix.cpp
===================================================================
--- korganizer/kodaymatrix.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/kodaymatrix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -54,6 +54,7 @@
 #include <qcursor.h>
 #include <kpopupmenu.h>
 #include <X11/Xlib.h>
+#undef FocusIn
 #undef KeyPress
 #undef None
 #undef Status
Index: korganizer/calendarview.cpp
===================================================================
--- korganizer/calendarview.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/calendarview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1015,7 +1015,6 @@
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
   todoEditor->newTodo();
-  todoEditor->setDates( QDateTime(), false );
   todoEditor->setTexts( summary, description );
   todoEditor->addAttachments( attachments, attachmentMimetypes, inlineAttachment );
   todoEditor->addAttendees( attendees );
@@ -1884,6 +1883,11 @@
   edit_copy();
 }
 
+void CalendarView::pasteIncidence()
+{
+  edit_paste();
+}
+
 void CalendarView::showIncidence( Incidence *incidence )
 {
   KOEventViewerDialog *eventViewer = new KOEventViewerDialog( this );
Index: korganizer/resourceview.cpp
===================================================================
--- korganizer/resourceview.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/resourceview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -359,22 +359,35 @@
   KRES::ConfigDialog *dlg = new KRES::ConfigDialog( this, QString("calendar"), resource,
                           "KRES::ConfigDialog" );
 
-  if ( dlg && dlg->exec() ) {
+  bool success = true;
+  if ( !dlg || !dlg->exec() )
+    success = false;
+
+  if ( success ) {
     resource->setTimeZoneId( KOPrefs::instance()->mTimeZoneId );
-    if ( resource->isActive() ) {
-      resource->open();
-      resource->load();
+    if ( resource->isActive() && ( !resource->open() || !resource->load() ) ) {
+      // ### There is a resourceLoadError() signal declared in ResourceCalendar
+      //     but no subclass seems to make use of it. We could do better.
+      KMessageBox::error( this, i18n("Unable to create the resource.")
+                                .arg( type ) );
+      success = false;
     }
+  }
+
+  if ( success ) {
     manager->add( resource );
     // we have to call resourceAdded manually, because for in-process changes
     // the dcop signals are not connected, so the resource's signals would not
     // be connected otherwise
     mCalendar->resourceAdded( resource );
-  } else {
+  }
+
+  if ( !success )
     delete resource;
-    resource = 0;
-  }
-  if ( dlg ) delete dlg;
+
+  delete dlg;
+
+  //### maybe only do this if ( success )
   emitResourcesChanged();
 }
 
Index: korganizer/korganizer_part.rc
===================================================================
--- korganizer/korganizer_part.rc	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/korganizer_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="korganizer" version="42">
+<kpartgui name="korganizer" version="43">
 
   <MenuBar>
     <Menu name="file"><text>&amp;File</text>
@@ -167,7 +167,7 @@
     <Action name="new_event"/>
     <Action name="new_todo"/>
     <Separator/>
-    <Action name="edit_paste"/>
+    <Action name="korganizer_paste"/>
     <Merge/>
   </Menu>
 
Index: korganizer/koeventpopupmenu.cpp
===================================================================
--- korganizer/koeventpopupmenu.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koeventpopupmenu.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -64,6 +64,9 @@
   mEditOnlyItems.append(
     insertItem( KOGlobals::self()->smallIcon("editcopy"), i18n("&Copy"),
                 this, SLOT( popupCopy() ) ) );
+  // paste is always possible
+  insertItem( KOGlobals::self()->smallIcon("editpaste"), i18n("&Paste"),
+                this, SLOT( popupPaste() ) );
   mEditOnlyItems.append(
     insertItem( KOGlobals::self()->smallIcon("editdelete"), i18n("&Delete"),
                 this, SLOT( popupDelete() ) ) );
@@ -158,7 +161,12 @@
   if (mCurrentIncidence) emit copyIncidenceSignal(mCurrentIncidence);
 }
 
+void KOEventPopupMenu::popupPaste()
+{
+  emit pasteIncidenceSignal();
+}
 
+
 void KOEventPopupMenu::popupAlarm()
 {
   if (mCurrentIncidence) emit toggleAlarmSignal( mCurrentIncidence );
Index: korganizer/koviewmanager.cpp
===================================================================
--- korganizer/koviewmanager.cpp	(.../tags/KDE/3.5.9/kdepim)	(wersja 793728)
+++ korganizer/koviewmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 793728)
@@ -184,6 +184,8 @@
           mMainView, SLOT(copyIncidence(Incidence *)));
   connect(view, SIGNAL(cutIncidenceSignal(Incidence *)),
           mMainView, SLOT(cutIncidence(Incidence *)));
+  connect(view, SIGNAL(pasteIncidenceSignal()),
+          mMainView, SLOT(pasteIncidence()));
   connect(view, SIGNAL(toggleAlarmSignal(Incidence *)),
           mMainView, SLOT(toggleAlarm(Incidence *)));
   connect(view,SIGNAL(dissociateOccurrenceSignal( Incidence *, const QDate & )),

Zmiany atrybutów dla: .
___________________________________________________________________
Nazwa: svnmerge-blocked
   - /branches/kdepim/enterprise/kdepim:703472,703877,703925,704210,704221,704225-704226,704228-704229,704237,704988,704991-704992,704995,705006-705008,705190,705626,705751,705754-705758,705836,705995,706309,706493,706548-706549,706556,706560,706564,706572,706775,706802,767041,767555,767557
   + /branches/kdepim/enterprise/kdepim:703472,703877,703925,704210,704221,704225-704226,704228-704229,704237,704988,704991-704992,704995,705006-705008,705190,705626,705751,705754-705758,705836,705995,706309,706493,706548-706549,706556,706560,706564,706572,706775,706802,767041,767555,767557,767947,769319,769355,771106,771252,772312,772317,775195,775203,775205-775206,775212,778002,778005-778006,778008-778009,778012,778030,778728,779449,779483,779506,779853,784427
Nazwa: svnmerge-integrated
   - /branches/kdepim/enterprise/kdepim:1-767022,767233-767554,767556,767558-767946,767948-768069,768071-768401,768403-768683,768685-768705,768707-768737,768739-768793,768795-768898,768900-768902,768904-768928,768930-769032,769034,769036-769040,769043-769044,769046,769048-769050,769052-769057,769059-769139,769142-769318,769320-769354,769356-769462,769464-769924,769926-771105,771107-771251,771253-771345,771705,772039,774162
   + /branches/kdepim/enterprise/kdepim:1-767022,767033,767233-767554,767556,767558-767946,767948-769318,769320-769354,769356-771105,771107-771251,771253-772311,772313-772316,772318-775194,775196-775202,775204,775207-775211,775213-778001,778003-778004,778007,778010-778011,778013-778029,778031-778727,778729-779448,779450-779482,779484-779505,779507-779852,779854-779994,782647-783127,783129-783243,783245,783248-783477,783479-783847,784547,787827
Nazwa: svn:mergeinfo
   - 
Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


