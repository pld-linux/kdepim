Index: akregator/ChangeLog
===================================================================
--- akregator/ChangeLog	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/ChangeLog	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,17 @@
-Akregator ChangeLog
+#Akregator ChangeLog
 ===================
 (c) 2004-2006 the Akregator authors.
 
+Changes after 1.2.5:
+-----------------------------
+
+Bug fixes:
+ 2006/11/30 Use "firefox %u" as default for the alternative browser command (#115777)
+ 2006/11/24 Add session management for browser tabs (#100964) Patch by Carsten Pfeiffer <pfeiffer at kde.org> -fo
+ 2006/11/10 Fix crash in Konqueror icon plugin sometimes happening when switching parts (#134929) -fo
+ 2006/10/31 Fix group name encoding bug when adding feeds from commandline (e.g., using the Konq plugin) (#136559)
+            Patch by Andrey Cherepanov.
+
 Changes after 1.2.4:
 -----------------------------
 
Index: akregator/src/aboutdata.cpp
===================================================================
--- akregator/src/aboutdata.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/aboutdata.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,6 +41,7 @@
     addAuthor( "Gary Cramblitt", I18N_NOOP("Contributor"), "garycramblitt@comcast.net");
     addAuthor( "Stephan Binner", I18N_NOOP("Contributor"), "binner@kde.org" );
     addAuthor( "Christof Musik", I18N_NOOP("Contributor"), "christof@freenet.de" );
+    addCredit( "Anne-Marie Mahfouf", I18N_NOOP("Handbook"), "annma@kde.org" );
     addCredit( "Frerich Raabe", I18N_NOOP("Author of librss"), "raabe@kde.org" );
     addCredit( "Eckhart Woerner", I18N_NOOP("Bug tracker management, Usability improvements"), "kde@ewsoftware.de");
     addCredit( "Heinrich Wendel", I18N_NOOP("Tons of bug fixes"), "h_wendel@cojobo.net");
Index: akregator/src/akregator.kcfg
===================================================================
--- akregator/src/akregator.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/akregator.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -154,7 +154,7 @@
   </entry>
   <entry key="External Browser Custom Command" type="String" >
    <whatsthis>Command to launch external browser.  URL will substitute for %u.</whatsthis>
-   <default>firefox -remote 'openURL(%u,new-tab)'</default>
+   <default>firefox %u</default>
   </entry>
   <entry key="LMB Behaviour" type="Enum" >
    <whatsthis>What the click with left mouse button should do.</whatsthis>
Index: akregator/src/librss/loader.h
===================================================================
--- akregator/src/librss/loader.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/librss/loader.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -227,7 +227,7 @@
 	 * 'OutputRetriever' will make it execute the script
 	 * '/home/myself/some-script.py' and assume whatever that script prints to
 	 * stdout is RSS markup. This is e.g. handy for conversion scripts, which
-	 * download a HTML file and convert it's contents into RSS markup.
+	 * download an HTML file and convert it's contents into RSS markup.
 	 *
 	 * No matter what kind of retrieval algorithm you employ, your
 	 * 'slotLoadingComplete' method might look like this:
Index: akregator/src/mk4storage/akregator_mk4storage_plugin.desktop
===================================================================
--- akregator/src/mk4storage/akregator_mk4storage_plugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/mk4storage/akregator_mk4storage_plugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fa]=پشتیبان ذخیره‌گاه Metakit
 Name[fi]=Metakit-tallennusajuri
 Name[fr]=Stockage avec Metakit
+Name[gl]=Manexador do almacenador Metakit
 Name[hu]=Metakit tároló
 Name[is]=Metakit geymslu bakendi
 Name[it]=Backend archiviazione metakit
@@ -49,6 +50,7 @@
 Comment[fi]=Liitännäinen Akregatoriin
 Comment[fr]=Module pour Akregator
 Comment[ga]=Breiseán Akregator
+Comment[gl]=Extensión para Akregator
 Comment[he]=תוסף עבור Akregator
 Comment[hu]=Akregator bővítőmodul
 Comment[is]=Íforrit fyrir Akregator
Index: akregator/src/akregator_plugin.desktop
===================================================================
--- akregator/src/akregator_plugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/akregator_plugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Comment[fi]=Liitännäinen Akregatoriin
 Comment[fr]=Module pour Akregator
 Comment[ga]=Breiseán Akregator
+Comment[gl]=Extensión para Akregator
 Comment[he]=תוסף עבור Akregator
 Comment[hu]=Akregator bővítőmodul
 Comment[is]=Íforrit fyrir Akregator
Index: akregator/src/akregator.desktop
===================================================================
--- akregator/src/akregator.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/akregator.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,7 +4,7 @@
 Exec=akregator %i %m -caption "%c"
 Icon=akregator
 Type=Application
-DocPath=akregator/akregator.html
+DocPath=akregator/index.html
 GenericName=RSS Feed Reader
 GenericName[bg]=Четец на новости RSS
 GenericName[ca]=Lector d'enllaços RSS
@@ -19,11 +19,12 @@
 GenericName[fi]=RSS-syötelukija
 GenericName[fr]=Lecteur de flux RSS
 GenericName[ga]=Léitheoir na bhFothaí RSS
+GenericName[gl]=Lector de Novas por RSS
 GenericName[he]=קורא חדשות (RSS)
 GenericName[hu]=RSS hírolvasó
 GenericName[is]=RSS fréttaforrit
 GenericName[it]=Lettore Fonti RSS
-GenericName[ja]=RSS ニュースリーダ
+GenericName[ja]=RSS ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​មតិព័ត៌មាន RSS
 GenericName[lt]=RSS kanalų skaityklė
 GenericName[ms]= Pembaca Suapan RSS 
@@ -56,10 +57,11 @@
 Comment[es]=Un agregador de RSS para KDE
 Comment[et]=KDE RSS-kanalite lugemisvahend
 Comment[eu]=KDE-ren RSS gehitzailea
-Comment[fa]=یک انبوهه‌ساز RSS برای KDE
+Comment[fa]=انبوهه‌ساز RSSای برای KDE
 Comment[fi]=RSS-syötelukija
 Comment[fr]=Un lecteur de flux RSS pour KDE
 Comment[ga]=Comhbhailitheoir RSS le haghaidh KDE
+Comment[gl]=Un agregador de RSS para KDE
 Comment[hu]=KDE-s hírolvasó RSS hírcsatornákhoz
 Comment[is]=RSS fréttaforrit fyrir KDE
 Comment[it]=Un concentratore KDE per RSS
Index: akregator/src/tabwidget.cpp
===================================================================
--- akregator/src/tabwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/tabwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -127,6 +127,19 @@
     return w ? d->frames[w] : 0;
 }
 
+QPtrList<Frame> TabWidget::frames() const
+{
+    QPtrList<Frame> result;
+    QPtrDictIterator<Frame> it(d->frames);
+    while (it.current())
+    {
+        result.append(it.current());
+        ++it;
+    }
+
+    return result;
+}
+
 void TabWidget::slotTabChanged(QWidget *w)
 {
     // FIXME: Don't hardcode the tab position of main frame
Index: akregator/src/main.cpp
===================================================================
--- akregator/src/main.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -65,7 +65,9 @@
       akr.send("openStandardFeedList");
     }
 
-    QString addFeedGroup = !args->getOption("group").isEmpty() ? args->getOption("group") : i18n("Imported Folder");
+    QString addFeedGroup = !args->getOption("group").isEmpty() 
+         ? QString::fromLocal8Bit(args->getOption("group")) 
+         : i18n("Imported Folder");
 
     QCStringList feeds = args->getOptionList("addfeed");
     QStringList feedsToAdd;
Index: akregator/src/eventsrc
===================================================================
--- akregator/src/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/eventsrc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,10 +15,11 @@
 Name[es]=Origen añadido
 Name[et]=Kanal lisatud
 Name[eu]=Iturria gehituta
-Name[fa]=خوراندن اضافه شده‌
+Name[fa]=خوراندن اضافه‌شده
 Name[fi]=Syöte lisätty
 Name[fr]=Flux ajouté
 Name[ga]=Cuireadh fotha leis
+Name[gl]=Engadiuse unha fonte
 Name[he]=נוסף ערוץ
 Name[hu]=Hírforrás felvéve
 Name[is]=Straum bætt við
@@ -56,9 +57,10 @@
 Comment[es]=Se ha añadido remotamente un origen a Akregator
 Comment[et]=Akregatorile lisati väljastpoolt uus kanal
 Comment[eu]=Iturri berri bat gehitu da urrunetik Akregator-era
-Comment[fa]=یک خوراندن جدید که به صورت دور به Akregator اضافه شده بود
+Comment[fa]=خوراندن جدیدی که به صورت دور به Akregator اضافه شد
 Comment[fi]=Uusi syöte lisättiin Akregatoriin ulkopuolelta
 Comment[fr]=Un flux a été ajouté à distance à Akregator
+Comment[gl]=Engadiuse remotamente unha nova fonte a Akregator
 Comment[he]=נוסף ערוץ ל־Akregator מרחוק
 Comment[hu]=Egy hírforrást távolról felvettek az Akregatorba
 Comment[is]=Nýjum straum var bætt við Akregator
@@ -104,6 +106,7 @@
 Name[fi]=Uudet artikkelit
 Name[fr]=Nouveaux articles
 Name[ga]=Altanna Nua
+Name[gl]=Novos Artigos
 Name[he]=מאמרים חדשים
 Name[hu]=Hírekk
 Name[is]=Nýjar greinar
@@ -142,10 +145,11 @@
 Comment[es]=Se obtuvieron los artículos nuevos
 Comment[et]=Tõmmati uued artiklid
 Comment[eu]=Artikulu berriak eskuratu dira
-Comment[fa]=مقالات جدید واکشی شده بود
+Comment[fa]=مقالات جدید واکشی شدند
 Comment[fi]=Uutta postia saapunut
 Comment[fr]=Les nouveaux articles ont été relevés
 Comment[ga]=Fuarthas ailt nua
+Comment[gl]=Obtivéronse novos artigos
 Comment[he]=הורדו מאמרים נוספים
 Comment[hu]=Új hírek lettek letöltve
 Comment[is]=Nýjar greinar voru sóttar
Index: akregator/src/akregator_view.cpp
===================================================================
--- akregator/src/akregator_view.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/akregator_view.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -93,6 +93,7 @@
 #include <qlayout.h>
 #include <qmultilineedit.h>
 #include <qpopupmenu.h>
+#include <qptrlist.h>
 #include <qstylesheet.h>
 #include <qtextstream.h>
 #include <qtimer.h>
@@ -1467,6 +1468,15 @@
         if (selNode)
             m_listTabWidget->activeView()->setSelectedNode(selNode);
     }
+
+    QStringList urls = config->readListEntry("FeedBrowserURLs");
+    QStringList::ConstIterator it = urls.begin();
+    for (; it != urls.end(); ++it)
+    {
+        KURL url = KURL::fromPathOrURL(*it);
+        if (url.isValid())
+            slotOpenNewTab(url, true); // open in background
+    }
 }
 
 void View::saveProperties(KConfig* config)
@@ -1481,6 +1491,25 @@
     {
         config->writeEntry("selectedNodeID", sel->id() );
     }
+
+    // save browser URLs
+    QStringList urls;
+    QPtrList<Frame> frames = m_tabs->frames();
+    QPtrList<Frame>::ConstIterator it = frames.begin();
+    for (; it != frames.end(); ++it)
+    {
+        Frame *frame = *it;
+        KParts::ReadOnlyPart *part = frame->part();
+        PageViewer *pageViewer = dynamic_cast<PageViewer*>(part); // don't save the ArticleViewer
+        if (pageViewer)
+        {
+            KURL url = pageViewer->url();
+            if (url.isValid())
+                urls.append(url.prettyURL());
+        }
+    }
+
+    config->writeEntry("FeedBrowserURLs", urls);
 }
 
 void View::connectToFeedList(FeedList* feedList)
Index: akregator/src/tabwidget.h
===================================================================
--- akregator/src/tabwidget.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ akregator/src/tabwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -25,6 +25,7 @@
 #ifndef TABWIDGET_H
 #define TABWIDGET_H
 
+#include <qptrlist.h>
 #include <ktabwidget.h>
 
 class QString;
@@ -45,6 +46,7 @@
         void addFrame(Frame *f);
         Frame* currentFrame();
         void removeFrame(Frame *f);
+        QPtrList<Frame> frames() const;
 
     public slots:
 
Index: kmobile/libkmobile.desktop
===================================================================
--- kmobile/libkmobile.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/libkmobile.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Name[es]=Manejador de dispositivos hardware móviles de bajo nivel para KDE
 Name[et]=KDE mobiilide riistvara süvataseme draiver
 Name[eu]=KDE-ren dispositibo mugikorren behe-mailako hardware kontrolatzailea
-Name[fa]=گردانندۀ سخت افزاری سطح پایین دستگاه سیار KDE
+Name[fa]=گردانندۀ سخت‌افزاری سطح پایین دستگاه تلفن همراه KDE
 Name[fi]=KDE:n matkapuhelimen matalan tason laiteajuri
 Name[fr]=Pilote matériel de bas niveau des périphériques mobiles pour KDE
 Name[ga]=Tiománaí crua-earraí íseal-leibhéil do ghléasanna móibíleacha KDE
Index: kmobile/devices/gnokii/libkmobile_gnokii.desktop
===================================================================
--- kmobile/devices/gnokii/libkmobile_gnokii.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/devices/gnokii/libkmobile_gnokii.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -51,7 +51,7 @@
 Comment=This driver supports many NOKIA and other mobile phones via the gnokii library
 Comment[bg]=Драйвер за поддръжка на мобилни телефони, предимно Нокия, чрез библиотеката gnokii
 Comment[bs]=Ovaj drajver podržava mnoge NOKIA i druge mobilne telefone putem gnokii biblioteke
-Comment[ca]=Aquest controlador suporta la gran majoria de NOKIA i d'altres telèfons mòbil mitjançant la biblioteca «gnokii»
+Comment[ca]=Aquest controlador acepta molts NOKIA i d'altres telèfons mòbils mitjançant la biblioteca «gnokii»
 Comment[cs]=Tento ovladač podporuje mnoho mobilních telefonů NOKIA a dalších pomocí knihovny gnokii
 Comment[cy]=Cynhala'r gyrrydd yma lawer o ffoniau NOKIA a ffoniau symudol eraill drwy'r rhaglengell gnokii
 Comment[da]=Denne driver understøtter mange NOKIA og andre mobiltelefoner via gnokii-biblioteket
Index: kmobile/devices/skeleton/libkmobile_skeleton.desktop
===================================================================
--- kmobile/devices/skeleton/libkmobile_skeleton.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/devices/skeleton/libkmobile_skeleton.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,7 +28,7 @@
 Name[lt]=Įrenginio skeletas
 Name[ms]=Peranti Rangka
 Name[nb]=Ramme-enhet
-Name[nds]=Reedschap-Geripp
+Name[nds]=Skeleton-Reedschap
 Name[nl]=Voorbeeldapparaat
 Name[nn]=Skjeletteining
 Name[pl]=Urządzenie szkieletowe
@@ -59,10 +59,11 @@
 Comment[es]=Dispositivo móvil Skeleton
 Comment[et]=Mobiili mallseade
 Comment[eu]=Skeleton dispositibo mugikorra
-Comment[fa]=دستگاه Skeleton سیار
+Comment[fa]=دستگاه Skeleton تلفن همراه
 Comment[fi]=Matkapuhelimen luurankolaite
 Comment[fr]=Modèle de périphérique mobile
 Comment[ga]=Creatghléas Móibíleach
+Comment[gl]=Dispositivo de Esqueleto Móbil
 Comment[he]=התקן נייד דמה
 Comment[hi]=मोबाइल स्केलेटन उपकरण
 Comment[hu]=Hordozható skeleton eszköz
@@ -73,7 +74,7 @@
 Comment[lt]=Mobilaus įrenginio skeletas
 Comment[ms]=Peranti Rangka Mudah Alih
 Comment[nb]=Mobil ramme-enhet
-Comment[nds]=Geripp vun en mobile Reedschap
+Comment[nds]=Mobil Skeleton-Reedschap
 Comment[nl]=Mobiel voorbeeldapparaat
 Comment[nn]=Mobil skjeletteining
 Comment[pl]=Szkieletowe urządzenie przenośne
Index: kmobile/devices/gammu/libkmobile_gammu.desktop
===================================================================
--- kmobile/devices/gammu/libkmobile_gammu.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/devices/gammu/libkmobile_gammu.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,7 +14,7 @@
 Name[es]=Teléfono móvil u organizador (gammu)
 Name[et]=Mobiiltelefon või Organizer (gammu)
 Name[eu]=Mugikorra edo antolatzailea (gammu)
-Name[fa]=تلفن همراه یا سازمان دهنده (gammu)
+Name[fa]=تلفن همراه یا سازمان‌دهنده (gammu)
 Name[fi]=Matkapuhelin tai organisaattori (gammu)
 Name[fr]=Téléphone portable ou organiseur (gammu)
 Name[ga]=Fón Póca nó Eagraí (gammu)
@@ -51,7 +51,7 @@
 Comment=This driver supports many NOKIA and other mobile phones via the gammu library
 Comment[bg]=Драйвер за поддръжка на мобилни телефони, предимно Нокия, чрез библиотеката gammu
 Comment[bs]=Ovaj drajver podržava mnoge NOKIA i druge mobilne telefone putem gammu biblioteke
-Comment[ca]=Aquest controlador suporta la gran majoria de NOKIA i d'altres telèfons mòbil mitjançant la biblioteca «gammu»
+Comment[ca]=Aquest controlador accepta molts NOKIA i d'altres telèfons mòbils mitjançant la biblioteca «gammu»
 Comment[cs]=Tento ovladač podporuje mnoho mobilních telefonů NOKIA a dalších pomocí knihovny gammu
 Comment[cy]=Cynhala'r gyrrydd yma lawer o ffoniau NOKIA a ffoniau symudol eraill drwy'r rhaglengell gammu
 Comment[da]=Denne driver understøtter mange NOKIA og andre mobiltelefoner via gammu-biblioteket
Index: kmobile/devices/digicam/libkmobile_digicam.desktop
===================================================================
--- kmobile/devices/digicam/libkmobile_digicam.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/devices/digicam/libkmobile_digicam.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,7 +14,7 @@
 Name[es]=Cámara digital
 Name[et]=Digitaalkaamera
 Name[eu]=Kamera digitala
-Name[fa]=دوربین رقمی‌
+Name[fa]=دوربین رقمی
 Name[fi]=digitaalikamera
 Name[fr]=Appareil photo numérique
 Name[ga]=Ceamara Digiteach
@@ -54,7 +54,7 @@
 Comment=This driver supports many digital cameras
 Comment[bg]=Драйвер за поддръжка на цифрови фотоапарати и камери
 Comment[bs]=Ovaj drajver podržava mnoge digitalne kamere
-Comment[ca]=Aquest controlador suporta la gran majoria de càmeres digitals
+Comment[ca]=Aquest controlador accepta moltes càmeres digitals
 Comment[cs]=Tento ovladač podporuje mnoho digitálních fotoaparátů
 Comment[cy]=Cynhala'r gyrrydd yma lawer o gamerau digidol
 Comment[da]=Denne driver understøtter mange digitale kameraer
Index: kmobile/kmobile.desktop
===================================================================
--- kmobile/kmobile.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/kmobile.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,7 +28,7 @@
 GenericName[es]=Gestiona dispositivos móviles
 GenericName[et]=Mobiilihaldur
 GenericName[eu]=Dispositibo mugikorrak kudeatu
-GenericName[fa]=مدیریت دستگاههای سیار
+GenericName[fa]=مدیریت دستگاههای تلفن همراه
 GenericName[fi]=Hallitse matkapuhelinlaitteita
 GenericName[fr]=Gérer les périphériques mobiles
 GenericName[ga]=Bainistigh Gléasanna Móibíleacha
@@ -77,7 +77,7 @@
 Comment[es]=A gestor de dispositivos móviles para KDE
 Comment[et]=KDE mobiilihaldur
 Comment[eu]=KDE-ren dispositibo mugikorren kudeatzailea
-Comment[fa]=یک مدیر دستگاههای سیار KDE
+Comment[fa]=مدیر دستگاههای تلفن همراه KDE
 Comment[fi]=KDE:n matkapuhelinlaitteiden hallinta
 Comment[fr]=Un gestionnaire de périphériques mobiles pour KDE
 Comment[ga]=Bainisteoir Gléasanna Móibíleacha KDE
Index: kmobile/kioslave/mimetypes/mobile_addressbook.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_addressbook.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/kioslave/mimetypes/mobile_addressbook.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Comment[es]=Contactos del dispositivo móvil
 Comment[et]=Mobiili kontaktid
 Comment[eu]=Kontaktuak dispositibo mugikorrean
-Comment[fa]=تماسها در دستگاه سیار
+Comment[fa]=تماسها در دستگاه تلفن همراه
 Comment[fi]=Mobiililaitteen yhteystiedot
 Comment[fr]=Contacts dans le périphérique mobile
 Comment[ga]=Teagmhálacha i nGléas Móibíleach
Index: kmobile/kioslave/mimetypes/mobile_notes.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Comment[es]=Notas del dispositivo móvil
 Comment[et]=Mobiili märkmed (Notes)
 Comment[eu]=Oharrak dispositibo mugikorrean
-Comment[fa]=یادداشتها در دستگاه سیار
+Comment[fa]=یادداشتها در دستگاه تلفن همراه
 Comment[fi]=Mobiililaitteen muistio
 Comment[fr]=Notes dans un périphérique mobile
 Comment[ga]=Nótaí i nGléas Móibíleach
Index: kmobile/kioslave/mimetypes/mobile_calendar.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_calendar.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/kioslave/mimetypes/mobile_calendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Comment[es]=Calendario del dispositivo móvil
 Comment[et]=Mobiili kalender
 Comment[eu]=Egutegia dispositibo mugikorrean
-Comment[fa]=تقویم در دستگاه سیار
+Comment[fa]=تقویم در دستگاه تلفن همراه
 Comment[fi]=Mobiililaitteen kalenteri
 Comment[fr]=Calendrier dans un périphérique mobile
 Comment[ga]=Féilire i nGléas Móibíleach
Index: kmobile/kioslave/mimetypes/mobile_device.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_device.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmobile/kioslave/mimetypes/mobile_device.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,7 +14,7 @@
 Comment[es]=Dispositivo móvil
 Comment[et]=Mobiil
 Comment[eu]=Dispositibo mugikorra
-Comment[fa]=دستگاه سیار
+Comment[fa]=دستگاه تلفن همراه
 Comment[fi]=Mobiililaite
 Comment[fr]=Périphérique mobile
 Comment[ga]=Gléas Móibíleach
Index: wizards/groupwarewizard.desktop
===================================================================
--- wizards/groupwarewizard.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ wizards/groupwarewizard.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KDE Groupware Wizard
+Name[ar]=مرشد KDE للبرمجيات الجماعية
 Name[bg]=Помощник за Groupware
 Name[br]=Skoazeller strollant evit KDE
 Name[ca]=Assistent de Groupware KDE
@@ -15,6 +16,7 @@
 Name[fi]=KDE Groupwaren ohjattu toiminto
 Name[fr]=Assistant KDE de travail collaboratif
 Name[ga]=Draoi Groupware KDE
+Name[gl]=Asistente de Traballo en Grupo de KDE
 Name[hu]=KDE csoportmunka-varázsló
 Name[is]=KDE hópvinnukerfisálfur
 Name[it]=Assistente configurazione di KDE Groupware
Index: kresources/egroupware/kabc_xmlrpc.desktop
===================================================================
--- kresources/egroupware/kabc_xmlrpc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/egroupware/kabc_xmlrpc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=eGroupware-palvelin (XML-RPC kautta)
 Name[fr]=Serveur eGroupware (via XML-RPC)
 Name[ga]=Freastalaí eGroupware (via XML-RPC)
+Name[gl]=Servidor eGroupware (mediante XML-RPC)
 Name[hu]=eGroupware-kiszolgáló (XML-RPC-n keresztül)
 Name[is]=eGroupware þjónn (gegnum XML-RPC)
 Name[it]=Server eGroupware (via XML-RPC)
Index: kresources/egroupware/knotes_xmlrpc.desktop
===================================================================
--- kresources/egroupware/knotes_xmlrpc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/egroupware/knotes_xmlrpc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=eGroupware-palvelin (XML-RPC kautta)
 Name[fr]=Serveur eGroupware (via XML-RPC)
 Name[ga]=Freastalaí eGroupware (via XML-RPC)
+Name[gl]=Servidor eGroupware (mediante XML-RPC)
 Name[hu]=eGroupware-kiszolgáló (XML-RPC-n keresztül)
 Name[is]=eGroupware þjónn (gegnum XML-RPC)
 Name[it]=Server eGroupware (via XML-RPC)
Index: kresources/egroupware/kcal_xmlrpc.desktop
===================================================================
--- kresources/egroupware/kcal_xmlrpc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/egroupware/kcal_xmlrpc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=eGroupware-palvelin (XML-RPC kautta)
 Name[fr]=Serveur eGroupware (via XML-RPC)
 Name[ga]=Freastalaí eGroupware (via XML-RPC)
+Name[gl]=Servidor eGroupware (mediante XML-RPC)
 Name[hu]=eGroupware-kiszolgáló (XML-RPC-n keresztül)
 Name[is]=eGroupware þjónn (gegnum XML-RPC)
 Name[it]=Server eGroupware (via XML-RPC)
Index: kresources/tvanytime/kcal_tvanytime.desktop
===================================================================
--- kresources/tvanytime/kcal_tvanytime.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/tvanytime/kcal_tvanytime.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -10,10 +10,11 @@
 Name[es]=Programación de TV
 Name[et]=Telekavad
 Name[eu]=TB planifikazioak
-Name[fa]=زمان‌بندیهای تلویزیون‌
+Name[fa]=زمان‌بندیهای تلویزیون
 Name[fi]=TV-ohjelmat
 Name[fr]=Programmes TV
 Name[ga]=Sceidil Teilifíse
+Name[gl]=Programación de TV
 Name[hu]=TV-műsorok
 Name[is]=Sjónvarpsdagskrár
 Name[it]=Programmi TV
Index: kresources/exchange/exchange.desktop
===================================================================
--- kresources/exchange/exchange.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/exchange/exchange.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -20,6 +20,7 @@
 Name[fi]=Exchange 2000 -palvelin
 Name[fr]=Serveur Exchange2000
 Name[ga]=Freastalaí Exchange 2000
+Name[gl]=Servidor Exchange 2000
 Name[hu]=Exchange 2000-kiszolgáló
 Name[is]=Exchange 2000 þjónn
 Name[it]=Server Exchange 2000
Index: kresources/exchange/exchange_deprecated.desktop
===================================================================
--- kresources/exchange/exchange_deprecated.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/exchange/exchange_deprecated.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=Exchange 2000 -palvelin (vanhentunut)
 Name[fr]=Serveur Exchange2000 (désuet)
 Name[ga]=Freastalaí Exchange 2000 (as dáta)
+Name[gl]=Servidor Exchange 2000 (desaprobado)
 Name[hu]=Exchange 2000-kiszolgáló (elavult)
 Name[is]=Exchange 2000 þjónn (úrelt)
 Name[it]=Server Exchange 2000 (deprecato)
Index: kresources/exchange/resourceexchange.cpp
===================================================================
--- kresources/exchange/resourceexchange.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/exchange/resourceexchange.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -403,12 +403,30 @@
   return list;
 }
 
+/* Invoked by korgac when checking alarms. Always updates the cache. */
 Alarm::List ResourceExchange::alarms( const QDateTime &from, const QDateTime &to )
 {
   kdDebug(5800) << "ResourceExchange::alarms(" << from.toString() << " - " << to.toString() << ")\n";
   Alarm::List list;
-  if ( mCache )
-  	list = mCache->alarms( from, to );
+
+  QDate start = from.date();
+  QDate end = to.date();
+
+  if ( mCache ) {
+
+    /* Clear the cache */
+    Event::List oldEvents = mCache->rawEvents( start, end, false );
+
+    Event::List::ConstIterator it;
+    for( it = oldEvents.begin(); it != oldEvents.end(); ++it ) {
+      mCache->deleteEvent( *it );
+    }
+
+    /* Fetch events */
+    mClient->downloadSynchronous( mCache, start, end, false );
+
+    list = mCache->alarms( from, to );
+  }
   return list;
 }
 
Index: kresources/groupwise/kresources_kabc_groupwise.kcfg
===================================================================
--- kresources/groupwise/kresources_kabc_groupwise.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kresources_kabc_groupwise.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -38,14 +38,18 @@
   <entry key="SystemAddressBook" type="String" >
    <label>ID of System Address Book</label>
   </entry>
-  <entry key="LastTimePORebuild" type="Int" >
+  <entry key="LastTimePORebuild" type="UInt64" >
     <label>Last time the Post Office was rebuilt</label>
   </entry>
-  <entry key="firstSequenceNumber" type="Int" >
+  <entry key="firstSequenceNumber" type="UInt64" >
     <label>The first sequence number of the GW System Address Book held locally</label>
   </entry>
-  <entry key="lastSequenceNumber" type="Int" >
+  <entry key="lastSequenceNumber" type="UInt64" >
     <label>The last sequence number of the GW System Address Book held locally</label>
   </entry>
+  <entry key="SystemAddressBookWhiteList" type="StringList">
+    <label>Applications which should load the System Address Book</label>
+    <default>kmail,kaddressbook,kontact</default>
+  </entry>
  </group>
 </kcfg>
Index: kresources/groupwise/kcal_groupwise.desktop
===================================================================
--- kresources/groupwise/kcal_groupwise.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kcal_groupwise.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Novell GroupWise -palvelin
 Name[fr]=Serveur de travail collaboratif GroupWise de Novell
 Name[ga]=Freastalaí Novell GroupWise
+Name[gl]=Servidor Novell GroupWise
 Name[hu]=Novell GroupWise kiszolgáló
 Name[is]=Novell GroupWise þjónn
 Name[it]=Server Novell GroupWise
Index: kresources/groupwise/kabc_resourcegroupwise.cpp
===================================================================
--- kresources/groupwise/kabc_resourcegroupwise.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kabc_resourcegroupwise.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,7 +43,6 @@
   if ( config ) {
     readConfig( config );
   }
-
   initGroupwise();
 }
 
@@ -69,11 +68,15 @@
 
 void ResourceGroupwise::init()
 {
-  mDownloadJob = 0;
+  mJob = 0;
   mProgress = 0;
-  mUpdateSystemAddressBook = false;
+  mSABProgress = 0;
+  mUABProgress = 0;
+  mServerFirstSequence = 0;
+  mServerLastSequence = 0;
+  mServerLastPORebuildTime = 0;
   mPrefs = new GroupwisePrefs;
-
+  mState = Start;
   setType( "groupwise" );
 }
 
@@ -81,10 +84,6 @@
 {
   mServer = new GroupwiseServer( mPrefs->url(), mPrefs->user(),
                                  mPrefs->password(), this );
-
-  // TODO: find out what this was meant to do.  the ReadAddressBooksJob could cause the server to emit this job when its run() ends
-  // connect( mServer, SIGNAL( readAddressBooksFinished() ),
-  //         SLOT( loadFinished() ) );
 }
 
 ResourceGroupwise::~ResourceGroupwise()
@@ -197,7 +196,7 @@
     }
   }
   else
-    emit loadingError( this, server.error() );
+    emit loadingError( this, server.errorText() );
 }
 
 Ticket *ResourceGroupwise::requestSaveTicket()
@@ -227,87 +226,6 @@
   cancelLoad();
 }
 
-bool ResourceGroupwise::load()
-{
-  return asyncLoad();
-}
-
-bool ResourceGroupwise::asyncLoad()
-{
-  kdDebug() << "ResourceGroupwise::asyncLoad()" << endl;
-
-  if ( mDownloadJob ) {
-    kdDebug() << "Download still in progress" << endl;
-    return true;
-  }
-
-  loadCache();
-
-  if ( addressBooks().isEmpty() ) {
-    kdDebug() << "Retrieving default addressbook list." << endl;
-    retrieveAddressBooks();
-    writeAddressBooks();
-  }
-
-  QStringList ids = mPrefs->readAddressBooks(); // start with all the address books
-
-  // check if we are fetching the SAB and we previously fetched it
-  if ( ( ids.find( mPrefs->systemAddressBook() ) != ids.end() ) &&
-     mPrefs->lastSequenceNumber() != 0 ) 
-  {
-    kdDebug() << "ResourceGroupwise::asyncLoad() - Found previous sequence number, updating SAB" << endl;
-    ids.remove( mPrefs->systemAddressBook() ); // we don't need to read this one again
-    mUpdateSystemAddressBook = true;
-    if ( ids.isEmpty() )
-    {
-      kdDebug() << "ResourceGroupwise::asyncLoad() - No user addressbooks specified, just updating SAB" << endl;
-      updateAddressBooks();
-      mUpdateSystemAddressBook = false;
-      return true; 
-    }
-  }
-
-  KURL url( prefs()->url() );
-  if ( url.protocol() == "http" ) 
-    url.setProtocol( "groupwise" );
-  else 
-    url.setProtocol( "groupwises" );
-
-  url.setPath( url.path() + "/addressbook/" );
-  url.setUser( prefs()->user() );
-  url.setPass( prefs()->password() );
-
-  QString query = "?";
-  QStringList::ConstIterator it;
-  for( it = ids.begin(); it != ids.end(); ++it ) {
-    if ( *it == mPrefs->systemAddressBook() )
-      kdDebug() << "fetching SAB" << (ids.size() > 1 ? ", and user addressbooks" : ", and only SAB" ) << endl;
-    if ( it != ids.begin() ) query += "&";
-    query += "addressbookid=" + *it;
-  }
-  url.setQuery( query );
-
-  kdDebug() << "Download URL: " << url << endl;
-
-  mJobData = QString::null;
-
-  mDownloadJob = KIO::get( url, false, false );
-  connect( mDownloadJob, SIGNAL( result( KIO::Job * ) ),
-           SLOT( slotFetchJobResult( KIO::Job * ) ) );
-  connect( mDownloadJob, SIGNAL( data( KIO::Job *, const QByteArray & ) ),
-           SLOT( slotReadJobData( KIO::Job *, const QByteArray & ) ) );
-  connect( mDownloadJob, SIGNAL( percent( KIO::Job *, unsigned long ) ),
-           SLOT( slotJobPercent( KIO::Job *, unsigned long ) ) );
-
-  mProgress = KPIM::ProgressManager::instance()->createProgressItem(
-    KPIM::ProgressManager::getUniqueID(), i18n("Downloading addressbook") );
-  connect( mProgress,
-           SIGNAL( progressItemCanceled( KPIM::ProgressItem * ) ),
-           SLOT( cancelLoad() ) );
-
-  return true;
-}
-
 bool ResourceGroupwise::save( Ticket *ticket )
 {
   return asyncSave( ticket );
@@ -339,6 +257,7 @@
       clearChange( *it );
   }
 
+  if ( appIsWhiteListedForSAB() )
   saveCache();
 
   mServer->logout();
@@ -346,141 +265,239 @@
   return true;
 }
 
-void ResourceGroupwise::slotFetchJobResult( KIO::Job *job )
+bool ResourceGroupwise::load()
 {
-  kdDebug() << "ResourceGroupwise::slotFetchJobResult() " << endl;
+  return asyncLoad();
+}
 
-  if ( job->error() ) {
-    kdError() << job->errorString() << endl;
-    emit loadingError( this, job->errorString() );
+bool ResourceGroupwise::asyncLoad()
+{
+  kdDebug() << "ResourceGroupwise::asyncLoad()" << endl;
+  //mPrefs->readConfig();  TODO: remove if the system addressbook is not read when disabled in config
+
+  if ( mState != Start )
+  {
+     kdDebug() << "  Download still in progress" << endl;
+     return true;
   }
 
-  saveCache();
+  if ( appIsWhiteListedForSAB() )
+    loadCache();
 
-  mDownloadJob = 0;
-  if ( mProgress ) mProgress->setComplete();
-  mProgress = 0;
+  if ( !mProgress )
+  {
+    mProgress = KPIM::ProgressManager::instance()->createProgressItem(
+      KPIM::ProgressManager::getUniqueID(), i18n( "Loading GroupWise resource %1" ).arg( resourceName() ), QString::null, true /*CanBeCancelled*/, mPrefs->url().startsWith("https" ) );
+    connect( mProgress, SIGNAL( progressItemCanceled( KPIM::ProgressItem * ) ),
+               SLOT( cancelLoad() ) );
+  }
 
-  // now we fetched addressbooks, if we are using the SAB,  update it with deltas
-  QStringList ids = mPrefs->readAddressBooks();
-  if ( ids.find( mPrefs->systemAddressBook() ) != ids.end() )
+  if ( addressBooks().isEmpty() ) {
+    kdDebug() << "  Retrieving default addressbook list." << endl;
+    retrieveAddressBooks();
+    writeAddressBooks();
+  }
+
+  SABState sabState = systemAddressBookState();
+  if ( shouldFetchSystemAddressBook() )
   {
-    if ( mUpdateSystemAddressBook )
+    if ( sabState == RefreshNeeded )
     {
-      kdDebug() << "updating system addressbook" << endl;
-      updateAddressBooks();
-      mUpdateSystemAddressBook = false;
+      kdDebug() << "  Fetching system addressbook" << endl;
+      fetchAddressBooks( System );
+      return true;
     }
-    else // we just fetched the entire SAB, now get the delta info so we know the last sequence number we have.
+    else if ( sabState == Stale )
     {
-      kdDebug() << "fetched whole SAB, now fetching delta info" << endl;
-      if ( mServer->login() )
-      {
-        GroupWise::DeltaInfo deltaInfo = mServer->getDeltaInfo( mPrefs->systemAddressBook() );
-        mServer->logout();
-    
-        kdDebug() << "storing delta info to prefs" << endl;
-        mPrefs->setFirstSequenceNumber( deltaInfo.firstSequence );
-        mPrefs->setLastSequenceNumber( deltaInfo.lastSequence );
-        mPrefs->writeConfig();
-        emit loadingFinished( this );
-        addressBook()->emitAddressBookChanged();
-      }
+      kdDebug() << "  Updating system addressbook" << endl;
+      updateSystemAddressBook(); // we then fetch the user address books after doing this
+      return true;
     }
   }
+  else if ( shouldFetchUserAddressBooks() )
+  {
+    kdDebug() << "  Fetching user addressbook" << endl;
+    fetchAddressBooks( User );
+    return true;
+  }
+  return true;
 }
 
-void ResourceGroupwise::slotUpdateJobResult( KIO::Job *job )
+void ResourceGroupwise::fetchAddressBooks( const BookType bookType )
 {
-  kdDebug() << "ResourceGroupwise::slotUpdateJobResult() " << endl;
+  KURL url = createAccessUrl( bookType, Fetch );
+  if ( !url.isValid() )
+    return;
 
+  kdDebug() << k_funcinfo << ( bookType == System ? " System" : " User" ) << " URL: " << url << endl;
+  // sanity check
+  if ( bookType == User && !( mState == SABUptodate || mState == Start ) )
+  {
+    kdDebug() << "  **ERROR** - fetchAddressBooks( User ) called when SAB not up to date" << endl;
+    return;
+  }
+
+  mState = ( bookType == System ? FetchingSAB : FetchingUAB );
+  mJobData = QString::null;
+
+  if ( mJob )
+  {
+    kdDebug() << "  **ERROR** - fetchAddressBooks() called when a job was already running!" << endl;
+    return;
+  }
+
+  mJob = KIO::get( url, false, false );  // TODO: make the GW jobs call finished if the URL 
+                                         // contains no address book IDs
+  kdDebug() << "  Job address: " << mJob << endl;
+  connect( mJob, SIGNAL( data( KIO::Job *, const QByteArray & ) ),
+           SLOT( slotReadJobData( KIO::Job *, const QByteArray & ) ) );
+  connect( mJob, SIGNAL( percent( KIO::Job *, unsigned long ) ),
+           SLOT( slotJobPercent( KIO::Job *, unsigned long ) ) );
+
+  if ( bookType == System )
+  {
+    connect( mJob, SIGNAL( result( KIO::Job * ) ),
+           SLOT( fetchSABResult( KIO::Job * ) ) );
+    mSABProgress = KPIM::ProgressManager::instance()->createProgressItem(
+        mProgress, KPIM::ProgressManager::getUniqueID(),
+        i18n( "Fetching System Address Book" ), QString::null,
+        false /*CannotBeCancelled*/,
+        mPrefs->url().startsWith("https" ) );
+  }
+  else
+  {
+    connect( mJob, SIGNAL( result( KIO::Job * ) ),
+           SLOT( fetchUABResult( KIO::Job * ) ) );
+    mUABProgress = KPIM::ProgressManager::instance()->createProgressItem(
+        mProgress, KPIM::ProgressManager::getUniqueID(),
+        i18n( "Fetching User Address Books" ), QString::null,
+        false /*CannotBeCancelled*/,
+        mPrefs->url().startsWith("https" ) );
+  }
+
+  return;
+}
+
+void ResourceGroupwise::fetchSABResult( KIO::Job *job )
+{
+  kdDebug() << "ResourceGroupwise::fetchSABResult() " << endl;
+
   if ( job->error() ) {
     kdError() << job->errorString() << endl;
     emit loadingError( this, job->errorString() );
+    // TODO kill the rest of the load sequence as well
   }
-  saveCache();
 
-  emit loadingFinished( this );
-  addressBook()->emitAddressBookChanged();
-  mDownloadJob = 0;
-  if ( mProgress ) mProgress->setComplete();
-  mProgress = 0;
+  mJob->disconnect( this );
+  mJob = 0;
+  mState = SABUptodate;
+  if ( mSABProgress )
+    mSABProgress->setComplete();
 
+  storeDeltaInfo();
+
+  if ( shouldFetchUserAddressBooks() )
+    fetchAddressBooks( User );
+  else
+    loadCompleted();
 }
 
-bool ResourceGroupwise::updateAddressBooks()
+void ResourceGroupwise::fetchUABResult( KIO::Job *job )
 {
-  kdDebug() << "ResourceGroupwise::updateAddressBooks() - Updating address books." << endl;
-    
-  if ( mDownloadJob ) {
-    kdWarning() << "Download still in progress" << endl;
-    return false;
+  kdDebug() << "ResourceGroupwise::fetchUABResult() " << endl;
+
+  if ( job->error() ) {
+    kdError() << job->errorString() << endl;
+    emit loadingError( this, job->errorString() );
   }
 
+  mJob->disconnect( this );
+  mJob = 0;
+  mState = Uptodate;
+  if ( mUABProgress )
+    mUABProgress->setComplete();
+  loadCompleted();
+}
+
+void ResourceGroupwise::updateSystemAddressBook()
+{
+  kdDebug() << "ResourceGroupwise::updateSystemAddressBook()" << endl;
+
+  if ( mState != Start ) {
+    kdWarning() << "  Action already in progress" << endl;
+    return;
+  }
+
   if ( addressBooks().isEmpty() ) {
-    kdDebug() << "Retrieving default addressbook list." << endl;
+    kdDebug() << "  Retrieving default addressbook list." << endl;
     retrieveAddressBooks();
     writeAddressBooks();
   }
 
-  QStringList ids;
-  ids.append( mPrefs->systemAddressBook() );
+  KURL url = createAccessUrl( System, Update, mPrefs->lastSequenceNumber(), mPrefs->lastTimePORebuild() );
+  kdDebug() << "  Update URL: " << url << endl;
 
-  KURL url( prefs()->url() );
-  if ( url.protocol() == "http" ) 
-    url.setProtocol( "groupwise" );
-  else 
-    url.setProtocol( "groupwises" );
+  mJobData = QString::null;
+  mSABProgress = KPIM::ProgressManager::instance()->createProgressItem(
+      mProgress, KPIM::ProgressManager::getUniqueID(),
+      i18n( "Updating System Address Book" ), QString::null,
+      false /*CannotBeCancelled*/,
+      mPrefs->url().startsWith("https" ) );
 
-  url.setPath( url.path() + "/addressbook/" );
-  url.setUser( prefs()->user() );
-  url.setPass( prefs()->password() );
+  mJob = KIO::get( url, false, false );
+  mJob->setInteractive( false );
+  connect( mJob, SIGNAL( result( KIO::Job * ) ),
+           SLOT( updateSABResult( KIO::Job * ) ) );
+  connect( mJob, SIGNAL( data( KIO::Job *, const QByteArray & ) ),
+           SLOT( slotUpdateJobData( KIO::Job *, const QByteArray & ) ) );
+  connect( mJob, SIGNAL( percent( KIO::Job *, unsigned long ) ),
+           SLOT( slotJobPercent( KIO::Job *, unsigned long ) ) );
 
-  QString query = "?";
-  QStringList::ConstIterator it;
-  for( it = ids.begin(); it != ids.end(); ++it ) {
-    if ( it != ids.begin() ) query += "&";
-    query += "addressbookid=" + *it;
-  }
-  query += "&update=true";
-  query += QString::fromLatin1( "&lastSeqNo=%1" ).arg( mPrefs->lastSequenceNumber() );
+  return;
+}
 
-  url.setQuery( query );
+void ResourceGroupwise::updateSABResult( KIO::Job *job )
+{
+  kdDebug() << "ResourceGroupwise::updateSABResult() " << endl;
 
-  kdDebug() << "Update URL: " << url << endl;
+  mSABProgress->setComplete();
+  mSABProgress = 0;
+  mJob->disconnect( this );
+  mJob = 0;
 
-  mJobData = QString::null;
+  int errorCode = job->error();
+  if ( errorCode != 0 ) {
+    if ( errorCode == KIO::ERR_NO_CONTENT ) // we need to refresh the SAB
+    {
+      kdDebug() << "  update SAB failed, fetching all of it again" << endl;
+      mPrefs->setLastSequenceNumber( 0 );
+      mPrefs->setFirstSequenceNumber( 0 );
+      fetchAddressBooks( System );
+      return;
+    }
+  }
 
-  mDownloadJob = KIO::get( url, false, false );
-  connect( mDownloadJob, SIGNAL( result( KIO::Job * ) ),
-           SLOT( slotUpdateJobResult( KIO::Job * ) ) );
-  connect( mDownloadJob, SIGNAL( data( KIO::Job *, const QByteArray & ) ),
-           SLOT( slotUpdateJobData( KIO::Job *, const QByteArray & ) ) );
-  connect( mDownloadJob, SIGNAL( percent( KIO::Job *, unsigned long ) ),
-           SLOT( slotJobPercent( KIO::Job *, unsigned long ) ) );
+  mState = SABUptodate;
+  storeDeltaInfo();
 
-  mProgress = KPIM::ProgressManager::instance()->createProgressItem(
-    KPIM::ProgressManager::getUniqueID(), i18n("Updating System Address Book") );
-  connect( mProgress,
-           SIGNAL( progressItemCanceled( KPIM::ProgressItem * ) ),
-           SLOT( cancelLoad() ) );
-
-  return true;
+  if ( shouldFetchUserAddressBooks() )
+    fetchAddressBooks( User );
+  else
+    loadCompleted();
 }
 
-void ResourceGroupwise::slotReadJobData( KIO::Job *, const QByteArray &data )
+void ResourceGroupwise::slotReadJobData( KIO::Job *job , const QByteArray &data )
 {
   kdDebug() << "ResourceGroupwise::slotReadJobData()" << endl;
+  Q_UNUSED( job );
 
   mJobData.append( data.data() );
-  //mAddrMap.clear(); //ideally we would remove all the contacts from the personal addressbooks and keep the ones from the SAB
-  // for the moment we will just have to deal with double removal.
 
   KABC::VCardConverter conv;
   QTime profile;
   profile.start();
   Addressee::List addressees = conv.parseVCards( mJobData );
-  kdDebug() << "ResourceGroupwise::slotReadJobData() - parsed " << addressees.count() << " contacts in "  << profile.elapsed() << "ms, now adding to resource..." << endl;
+ // kdDebug() << "  parsed " << addressees.count() << " contacts in "  << profile.elapsed() << "ms, now adding to resource..." << endl;
 
   Addressee::List::ConstIterator it;
   for( it = addressees.begin(); it != addressees.end(); ++it ) {
@@ -503,9 +520,13 @@
   mJobData = QString::null;
 }
 
-void ResourceGroupwise::slotUpdateJobData( KIO::Job *, const QByteArray &data )
+void ResourceGroupwise::slotUpdateJobData( KIO::Job *job, const QByteArray &data )
 {
+  kdDebug() << "ResourceGroupwise::slotUpdateJobData()" << endl;
+  kdDebug() << "  Job address: " << job << endl;
   KABC::VCardConverter conv;
+  mJobData.append( data.data() );
+
   Addressee::List addressees = conv.parseVCards( mJobData );
   Addressee::List::ConstIterator it;
 
@@ -541,26 +562,180 @@
             removeAddressee( addrToDelete );
           }
         }
-        else 
+        else
           kdError() << "Addressee to delete did not have a remote UID, unable to find the corresponding local contact" << endl;
       }
     }
   }
+  mJobData = QString::null;
 }
 
+void ResourceGroupwise::loadCompleted()
+{
+  kdDebug() << "ResourceGroupwise::loadCompleted()" << endl;
+  if ( mProgress )
+    mProgress->setComplete();
+  mProgress = 0;
+  mSABProgress = 0;
+  mUABProgress = 0;
+  mState = Start;
+  if ( appIsWhiteListedForSAB() )
+    saveCache();
+  emit loadingFinished( this );
+  addressBook()->emitAddressBookChanged();
+}
+
 void ResourceGroupwise::slotJobPercent( KIO::Job *, unsigned long percent )
 {
+  // TODO: make this act on the correct progress item
   kdDebug() << "ResourceGroupwise::slotJobPercent() " << percent << endl;
   if ( mProgress ) mProgress->setProgress( percent );
 }
 
 void ResourceGroupwise::cancelLoad()
 {
-  if ( mDownloadJob ) mDownloadJob->kill();
-  mDownloadJob = 0;
+  if ( mJob )
+  {
+    mJob->disconnect( this );
+    mJob->kill();
+  }
+  mJob = 0;
   if ( mProgress ) mProgress->setComplete();
   mProgress = 0;
+  mState = Start;
 }
 
+ResourceGroupwise::SABState ResourceGroupwise::systemAddressBookState()
+{
+  unsigned long storedFirstSequence = mPrefs->firstSequenceNumber();
+  unsigned long storedLastSequence = mPrefs->lastSequenceNumber();
+  unsigned long storedLastPORebuildTime = mPrefs->lastTimePORebuild();
 
+  kdDebug() << "ResourceGroupwise::systemAddressBookState()" << endl;
+  kdDebug() << "  Stored first seq no: " << storedFirstSequence  << endl;
+  kdDebug() << "  Stored last seq no: " << storedLastSequence << endl;
+  kdDebug() << "  Stored last PO Rebuild time: " << storedLastPORebuildTime << endl;
+
+  kdDebug() << "  Fetching delta info to check if update possible" << endl;
+  if ( mServer->login() )
+  {
+    GroupWise::DeltaInfo deltaInfo = mServer->getDeltaInfo( mPrefs->systemAddressBook() );
+    mServer->logout();
+
+    mServerFirstSequence = deltaInfo.firstSequence;
+    mServerLastSequence = deltaInfo.lastSequence;
+    mServerLastPORebuildTime = deltaInfo.lastTimePORebuild;
+
+    kdDebug() << "  Server first seq no: " << mServerFirstSequence  << endl;
+    kdDebug() << "  Server last seq no: " << mServerLastSequence << endl;
+    kdDebug() << "  Server last PO Rebuild time: " << mServerLastPORebuildTime << endl;
+
+    if ( storedFirstSequence == 0 || storedLastSequence == 0 )
+    {
+      kdDebug() << "  no fetched SAB exists yet, can't update" << endl;
+      return RefreshNeeded;
+    }
+
+    if ( mServerFirstSequence > storedLastSequence || storedLastPORebuildTime != mServerLastPORebuildTime)
+    {
+      kdDebug() << "  New entries since the last fetch are no longer available as deltas, or the PO was rebuilt, refresh needed" << endl;
+      return RefreshNeeded;
+    }
+    
+    if ( mServerLastSequence == storedLastSequence )
+    {
+      kdDebug() << "  The local data is up to date" << endl;
+      return InSync;
+    }
+  }
+  
+  if ( storedFirstSequence == 0 || storedLastSequence == 0 )
+  {
+    kdDebug() << "  Fallthrough - no fetched SAB exists yet, refresh" << endl;
+    return RefreshNeeded;
+  }
+  else
+    kdDebug() << "  Fallthrough  - returning Stale" << endl;
+  return Stale;
+}
+
+bool ResourceGroupwise::shouldFetchSystemAddressBook()
+{
+  
+  QStringList ids = mPrefs->readAddressBooks();
+  return ( appIsWhiteListedForSAB() && ids.find( mPrefs->systemAddressBook() ) != ids.end() );
+}
+
+bool ResourceGroupwise::shouldFetchUserAddressBooks()
+{
+  QStringList ids = mPrefs->readAddressBooks();
+  return ( ids.count() > 1 || ids.find( mPrefs->systemAddressBook() ) == ids.end() );
+}
+
+KURL ResourceGroupwise::createAccessUrl( BookType bookType, AccessMode mode, unsigned long lastSequenceNumber, unsigned long lastPORebuildTime )
+{
+  // set up list of address book IDs to fetch
+  QStringList ids;
+  if ( bookType == System )
+    ids.append( mPrefs->systemAddressBook() );
+  else
+  {
+    ids = mPrefs->readAddressBooks();
+    ids.remove( mPrefs->systemAddressBook() );
+  }
+
+  if ( ids.isEmpty() )
+    return KURL();
+
+  KURL url( prefs()->url() );
+  if ( url.protocol() == "http" ) 
+    url.setProtocol( "groupwise" );
+  else 
+    url.setProtocol( "groupwises" );
+
+  url.setPath( url.path() + "/addressbook/" );
+  url.setUser( prefs()->user() );
+  url.setPass( prefs()->password() );
+
+  QString query = "?";
+  QStringList::ConstIterator it;
+  for( it = ids.begin(); it != ids.end(); ++it ) {
+    if ( it != ids.begin() ) query += "&";
+    query += "addressbookid=" + *it;
+  }
+
+  if ( mode == Update && lastSequenceNumber > 0 && lastPORebuildTime > 0 )
+  {
+    query += QString::fromLatin1( "&update=true&lastSeqNo=%1&PORebuildTime=%2" ).arg( lastSequenceNumber ).arg( lastPORebuildTime );;
+  }
+  url.setQuery( query );
+  return url;
+}
+
+void ResourceGroupwise::storeDeltaInfo()
+{
+  // update SAB delta info
+  kdDebug() << "ResourceGroupwise::storeDeltaInfo()" << endl;
+  kdDebug() << "  Server first seq no: " << mServerFirstSequence  << endl;
+  kdDebug() << "  Server last seq no: " << mServerLastSequence << endl;
+  kdDebug() << "  Server last PO Rebuild time: " << mServerLastPORebuildTime << endl;
+
+  if ( mServerFirstSequence == 0 || mServerLastSequence == 0 || mServerLastPORebuildTime == 0 )
+    return;
+  mPrefs->setFirstSequenceNumber( mServerFirstSequence );
+  mPrefs->setLastSequenceNumber( mServerLastSequence );
+  mPrefs->setLastTimePORebuild( mServerLastPORebuildTime );
+  mPrefs->writeConfig();
+}
+
+bool ResourceGroupwise::appIsWhiteListedForSAB()
+{
+  if ( !mPrefs->systemAddressBookWhiteList().contains( qApp->argv()[ 0 ] ) )
+  {
+    kdDebug() << "Application " << qApp->argv()[ 0 ] << " is _blacklisted_ to load the SAB" << endl;
+    return false;
+  }
+  return true;
+}
+
 #include "kabc_resourcegroupwise.moc"
Index: kresources/groupwise/kabc_resourcegroupwise.h
===================================================================
--- kresources/groupwise/kabc_resourcegroupwise.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kabc_resourcegroupwise.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -73,35 +73,94 @@
     bool asyncLoad();
     bool save( Ticket * );
     bool asyncSave( Ticket * );
-    bool updateAddressBooks();
+    enum SABState { Stale, InSync, RefreshNeeded };
 
     /**
      * Clears the cached data, in memory and on disk
      */
     void clearCache();
   protected:
+    enum ResourceState { Start, FetchingSAB, SABUptodate, FetchingUAB, Uptodate };
+    enum BookType { System, User };
+    enum AccessMode { Fetch, Update };
     void init();
     void initGroupwise();
 
+    /* STATE CHANGING METHODS */
+    /**
+    * Begin asynchronously fetching the system address book , replacing the cached copy
+    */
+    void fetchAddressBooks( const BookType booktype );
+    /**
+    *  Asynchronously update the system address book
+    */
+    void updateSystemAddressBook();
+    /**
+    * Wrap up the load sequence
+    */
+    void loadCompleted();
+
+    /** HELPER METHODS **/
+    /**
+    * Check to see if a local download of the SAB already exists
+    */
+    SABState systemAddressBookState();
+    /**
+    * Check if the resource is configured to download the SAB
+    */
+    bool shouldFetchSystemAddressBook();
+    /**
+    * Check if the resource is configured to download personal address
+    * books
+    */
+    bool shouldFetchUserAddressBooks();
+
+    /**
+    * Create a URL for a single addressbook access.
+    * To fetch an address book completely, use mode = Fetch
+    * To just update an addressbook, use mode = Update and give the ast sequence number already held
+    * If Update is given without a sequence number, the mode falls back to Fetch
+    */
+    KURL createAccessUrl( BookType bookType, AccessMode mode, unsigned long lastSequenceNumber = 0, unsigned long lastPORebuildTime = 0 );
+
+    /**
+    * Persist the last known delta info.  Call after the SAB is up to date.
+    */
+    void storeDeltaInfo();
+
+    /**
+    * Check if the application which has loaded this resource is whitelisted
+    * to load the System Address Book (time-consuming)
+    */
+    bool appIsWhiteListedForSAB();
+
   private slots:
-    void slotFetchJobResult( KIO::Job * );
-    void slotUpdateJobResult( KIO::Job * );
+    /** STATE CHANGING SLOTS **/
+    void fetchSABResult( KIO::Job * );
+    void fetchUABResult( KIO::Job * );
+    void updateSABResult( KIO::Job * );
+    /** DATA PROCESSING SLOTS **/
     void slotReadJobData( KIO::Job *, const QByteArray & );
     void slotUpdateJobData( KIO::Job *, const QByteArray & );
+    /** HELPER SLOT **/
     void slotJobPercent( KIO::Job *job, unsigned long percent );
 
     void cancelLoad();
-
   private:
     GroupwisePrefs *mPrefs;
     GroupWise::AddressBook::List mAddressBooks;
 
     GroupwiseServer *mServer;
 
-    KIO::TransferJob *mDownloadJob;
+    KIO::TransferJob *mJob;
     KPIM::ProgressItem *mProgress;
+    KPIM::ProgressItem *mSABProgress;
+    KPIM::ProgressItem *mUABProgress;
     QString mJobData;
-    bool mUpdateSystemAddressBook;
+    ResourceState mState;
+    unsigned long mServerFirstSequence, mServerLastSequence, mServerLastPORebuildTime;
+
+    bool mLimitedMode;
 };
 
 }
Index: kresources/groupwise/soap/gwjobs.h
===================================================================
--- kresources/groupwise/soap/gwjobs.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/gwjobs.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -46,11 +46,13 @@
 {
   public:
     GWJob( GroupwiseServer *server, struct soap *soap, const QString &url, const std::string &session );
+    int error() const { return mError; }
   protected:
     GroupwiseServer *mServer;
     struct soap *mSoap;
     QString mUrl;
     const std::string mSession;
+    int mError;
 };
 
 class ReadAddressBooksJob : public GWJob
@@ -106,10 +108,14 @@
     void setAddressBookIds( const QStringList& );
 
     /**
-     * set the sequence number to start reading deltas from (usually the last sequenec number
-     * we have in the local copy of the System Address Book).
-     */
-    void setStartSequenceNumber( const int startSeqNo );
+    * set the sequence number to start reading deltas from (usually the last sequenec number
+    * we have in the local copy of the System Address Book).
+    */
+    void setStartSequenceNumber( const unsigned long startSeqNo );
+    /**
+    * set the time of the last server (PO) rebuild
+    */
+    void setLastPORebuildTime( const unsigned long lastPORebuildTime);
 
     void run();
   protected:
@@ -119,7 +125,8 @@
     QStringList mAddressBookIds;
     KABC::Resource *mResource;
     int mProgress;
-    int mStartSequenceNumber; // first and last sequence numbers define the current state of the system addressbook
+    unsigned long mLastPORebuildTime;
+    unsigned long mStartSequenceNumber; // first and last sequence numbers define the current state of the system addressbook
                               // and are used to determine which deltas to download
 };
 
Index: kresources/groupwise/soap/stdsoap2.h
===================================================================
--- kresources/groupwise/soap/stdsoap2.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/stdsoap2.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -507,7 +507,7 @@
 # endif
 #endif
 
-/*#define DEBUG*/  /* Uncomment to debug sending (in file SENT.log) receiving (in file RECV.log) and messages (in file TEST.log) */
+#define DEBUG  /* Uncomment to debug sending (in file SENT.log) receiving (in file RECV.log) and messages (in file TEST.log) */
 
 #ifdef __cplusplus
 extern "C" {
Index: kresources/groupwise/soap/incidenceconverter.cpp
===================================================================
--- kresources/groupwise/soap/incidenceconverter.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/incidenceconverter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -610,24 +610,24 @@
 
 void IncidenceConverter::getAttendees( ngwt__CalendarItem *item, KCal::Incidence *incidence )
 {
-//   kdDebug() << "IncidenceConverter::getAttendees()" << ( item->subject ? item->subject->c_str() : "no subject" )
-//     << endl;
+  kdDebug() << "IncidenceConverter::getAttendees()" << ( item->subject ? item->subject->c_str() : "no subject" )
+    << endl;
 
   if ( item->distribution && item->distribution->from ) {
-/*    kdDebug() << "-- from" << endl;*/
+    kdDebug() << "-- from" << endl;
     KCal::Person organizer( stringToQString( item->distribution->from->displayName ),
                             stringToQString( item->distribution->from->email ) );
     incidence->setOrganizer( organizer );
   }
 
   if ( item->distribution && item->distribution->recipients ) {
-/*    kdDebug() << "-- recipients" << endl;*/
+    kdDebug() << "-- recipients" << endl;
     std::vector<ngwt__Recipient*> recipients = item->distribution->recipients->recipient;
     std::vector<ngwt__Recipient*>::const_iterator it;
 
     for ( it = recipients.begin(); it != recipients.end(); ++it ) {
-/*      kdDebug() << "---- recipient " << endl;
- */   ngwt__Recipient *recipient = *it;
+      kdDebug() << "---- recipient " << endl;
+    ngwt__Recipient *recipient = *it;
       KCal::Attendee *attendee = new KCal::Attendee(
         stringToQString( recipient->displayName ),
         stringToQString( recipient->email ) );
@@ -636,6 +636,10 @@
       if ( *(recipient->email) == *(qStringToString( mFromEmail )) )
         if ( item->status->accepted )
           attendee->setStatus( ( *item->status->accepted ) ? KCal::Attendee::Accepted : KCal::Attendee::NeedsAction );
+        else 
+          kdDebug() << "---- not accepted" << endl;
+      else
+        kdDebug() << "---- '" << recipient->email->c_str() << "' != '" << (qStringToString( mFromEmail ))->c_str() << "'" << endl;
 
       incidence->addAttendee( attendee );
     }
Index: kresources/groupwise/soap/groupwiseserver.cpp
===================================================================
--- kresources/groupwise/soap/groupwiseserver.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/groupwiseserver.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -117,7 +117,7 @@
   } else {
     m_sock = new KExtendedSocket();
   }
-  mError = QString::null;
+  mErrorText = QString::null;
 
   m_sock->reset();
   m_sock->setBlockingMode( false );
@@ -137,7 +137,7 @@
       if ( rc == -3 )
         errorMessage = QString::fromLatin1( "Connection timed out.  Check host and port number" );
     }
-    mError = i18n("Connect failed: %1.").arg( errorMessage );
+    mErrorText = i18n("Connect failed: %1.").arg( errorMessage );
     return SOAP_INVALID_SOCKET;
   }
   m_sock->enableRead( true );
@@ -173,7 +173,7 @@
     kdError() << "no open connection" << endl;
     return SOAP_TCP_ERROR;
   }
-  if ( !mError.isEmpty() ) {
+  if ( mError ) {
     kdError() << "SSL is in error state." << endl;
     return SOAP_SSL_ERROR;
   }
@@ -219,7 +219,7 @@
     soap->error = SOAP_FAULT;
     return 0;
   }
-  if ( !mError.isEmpty() ) {
+  if ( mError ) {
     kdError() << "SSL is in error state." << endl;
     soap->error = SOAP_SSL_ERROR;
     return 0;
@@ -250,7 +250,8 @@
                                   const QString &password, QObject *parent )
   : QObject( parent, "GroupwiseServer" ),
     mUrl( url ), mUser( user ), mPassword( password ),
-    mSSL( url.left(6)=="https:" ), m_sock( 0 )
+    mSSL( url.left(6)=="https:" ), m_sock( 0 ),
+    mError( 0 )
 {
   mBinding = new GroupWiseBinding;
   mSoap = mBinding->soap;
@@ -323,7 +324,7 @@
   if ( mSession.size() == 0 ) // workaround broken loginResponse error reporting
   {
     kdDebug() << "Login failed but the server didn't report an error" << endl;
-    mError = i18n( "Login failed, but the GroupWise server did not report an error" );
+    mErrorText = i18n( "Login failed, but the GroupWise server did not report an error" );
     return false;
   }
 
@@ -704,7 +705,7 @@
 bool GroupwiseServer::readAddressBooksSynchronous( const QStringList &addrBookIds )
 {
   if ( mSession.empty() ) {
-    kdError() << "GroupwiseServer::readAddressBooks(): no session." << endl;
+    kdError() << "GroupwiseServer::readAddressBooksSynchronous(): no session." << endl;
     return false;
   }
 
@@ -717,7 +718,7 @@
   return true;
 }
 
-bool GroupwiseServer::updateAddressBooks( const QStringList &addrBookIds, const unsigned int startSequenceNumber )
+bool GroupwiseServer::updateAddressBooks( const QStringList &addrBookIds, const unsigned long startSequenceNumber, const unsigned long lastPORebuildTime )
 {
   if ( mSession.empty() ) {
     kdError() << "GroupwiseServer::updateAddressBooks(): no session." << endl;
@@ -727,9 +728,15 @@
   UpdateAddressBooksJob * job = new UpdateAddressBooksJob( this, mSoap, mUrl, mSession );
   job->setAddressBookIds( addrBookIds );
   job->setStartSequenceNumber( startSequenceNumber );
+  job->setLastPORebuildTime( lastPORebuildTime );
 
   job->run();
-
+  if ( job->error() == GroupWise::RefreshNeeded )
+  {
+    mError = 1;
+    mErrorText = "The System Address Book must be refreshed";
+    return false;
+  }
   return true;
 }
 
@@ -1085,7 +1092,7 @@
     if ( status->description ) {
       msg += " ";
       msg += status->description->c_str();
-      mError = status->description->c_str();
+      mErrorText = status->description->c_str();
     }
     kdError() << msg << endl;
     return false;
@@ -1420,7 +1427,7 @@
 {
   kdDebug() << "********************** SSL ERROR" << endl;
 
-  mError = i18n("SSL Error");
+  mErrorText = i18n("SSL Error");
 }
 
 void GroupwiseServer::emitReadAddressBookTotalSize( int s )
Index: kresources/groupwise/soap/ksslsocket.cpp
===================================================================
--- kresources/groupwise/soap/ksslsocket.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/ksslsocket.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -99,7 +99,7 @@
 //  kdDebug() << "KSSLSocket::slotConnected() " << (void*)this << endl;
 	if( KSSL::doesSSLWork() )
 	{
-		kdDebug(0) << k_funcinfo << "Trying SSL connection..." << endl;
+//		kdDebug(0) << k_funcinfo << "Trying SSL connection..." << endl;
 		if( !d->kssl )
 		{
 			d->kssl = new KSSL();
@@ -109,7 +109,7 @@
 			d->kssl->reInitialize();
 		}
 		d->kssl->setPeerHost(host());
-                kdDebug() << "SOCKET STATUS: " << socketStatus() << endl;
+//        kdDebug() << "SOCKET STATUS: " << socketStatus() << endl;
 		int rc = d->kssl->connect( sockfd );
                 if ( rc <= 0 ) {
                   kdError() << "Error connecting KSSL: " << rc << endl;
Index: kresources/groupwise/soap/gwjobs.cpp
===================================================================
--- kresources/groupwise/soap/gwjobs.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/gwjobs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,12 +35,12 @@
 
 #include "gwjobs.h"
 
-#define READ_ADDRESS_FOLDER_CHUNK_SIZE 250
+#define READ_ADDRESS_FOLDER_CHUNK_SIZE 50
 #define READ_CALENDAR_FOLDER_CHUNK_SIZE 50
 
 GWJob::GWJob( GroupwiseServer *server, struct soap *soap, const QString &url,
   const std::string &session )
-  : mServer( server ), mSoap( soap ), mUrl( url ), mSession( session )
+  : mServer( server ), mSoap( soap ), mUrl( url ), mSession( session ), mError( GroupWise::NoError )
 {
 }
 
@@ -61,6 +61,8 @@
 {
   kdDebug() << "ReadAddressBooksJob::run()" << endl;
 
+// alternate read logic added on 20061209, uses the list of address books provided by the job starter instead of asking the server for the address book list again.  Risk might be that the list of address books is stale.
+#if 0
   mSoap->header->ngwt__session = mSession;
   _ngwm__getAddressBookListRequest addressBookListRequest;
   _ngwm__getAddressBookListResponse addressBookListResponse;
@@ -89,6 +91,17 @@
       }
     }
   }
+#else
+  GWConverter conv( mSoap );
+  QStringList::Iterator it = mAddressBookIds.begin();
+  const QStringList::Iterator end = mAddressBookIds.end();
+  for ( ; it != end; ++it )
+  {
+    std::string* id = conv.qStringToString( *it );
+    readAddressBook( *id );
+    mProgress += 100;
+  }
+#endif
 }
 
 void ReadAddressBooksJob::readAddressBook( std::string &id )
@@ -171,35 +184,50 @@
 #else
   unsigned int readItems = 0;
   unsigned int readChunkSize = READ_ADDRESS_FOLDER_CHUNK_SIZE;
-  
-  int cursor;
 
+  int cursor = 0;
+
   _ngwm__createCursorRequest cursorRequest;
   _ngwm__createCursorResponse cursorResponse;
 
   cursorRequest.container = id;
   cursorRequest.view = 0;
-  // filter for Contacts until we support Groups
-  cursorRequest.filter = soap_new_ngwt__Filter( mSoap, -1 );
-  ngwt__FilterEntry * fe = soap_new_ngwt__FilterEntry( mSoap, -1 );
-  fe->op = isOf;
-  fe->field = soap_new_std__string( mSoap, -1 );
-  fe->field->append( "@type" );
-  fe->value = soap_new_std__string( mSoap, -1 );
-  fe->value->append( "Contact" );
-  fe->custom = 0;
-  fe->date = 0;
-
-  cursorRequest.filter->element = fe;
-
+  if ( id.find( "GroupWiseSystemAddressBook" ) == 0 )
+  {
+    kdDebug() << "  Book: " << id.c_str() << " is a SAB " << endl;
+    // filter for Contacts until we support Groups
+    cursorRequest.filter = soap_new_ngwt__Filter( mSoap, -1 );
+    ngwt__FilterEntry * fe = soap_new_ngwt__FilterEntry( mSoap, -1 );
+    fe->op = isOf;
+    fe->field = soap_new_std__string( mSoap, -1 );
+    fe->field->append( "@type" );
+    fe->value = soap_new_std__string( mSoap, -1 );
+    fe->value->append( "Contact" );
+    fe->custom = 0;
+    fe->date = 0;
+    cursorRequest.filter->element = fe;
+  }
+  else
+  {
+    kdDebug() << "  Book: " << id.c_str() << " is a personal address book " << endl;
+    cursorRequest.filter = 0;
+  }
+  
   mSoap->header->ngwt__session = mSession;
   soap_call___ngw__createCursorRequest( mSoap, mUrl.latin1(), 0,
                                         &cursorRequest,
                                         &cursorResponse );
   if ( cursorResponse.cursor )
     cursor = *(cursorResponse.cursor);
-  else /* signal error? */
-    return;
+  else
+  {
+    if ( cursorResponse.status && cursorResponse.status->code != 0 )
+    {
+      kdDebug() << "  Couldn't read " << GWConverter::stringToQString(id ) << " : " << GWConverter::stringToQString(cursorResponse.status->description) << endl;
+      //mError = GroupWise::RefreshNeeded;
+    }
+  return;
+  }
 
   _ngwm__readCursorRequest readCursorRequest;
 
@@ -237,7 +265,7 @@
       for( it = readCursorResponse.items->item.begin(); it != readCursorResponse.items->item.end(); ++it ) {
         ngwt__Item *item = *it;
 
-#if 1
+#if 0
         if ( item )
           if ( item->name )
             kdDebug() << "ITEM: " << item->name->c_str() << endl;
@@ -617,71 +645,86 @@
   kdDebug() << "ADDR IDS: " << ids.join( "," ) << endl;
 }
 
-void UpdateAddressBooksJob::setStartSequenceNumber( const int startSeqNo )
+void UpdateAddressBooksJob::setStartSequenceNumber( const unsigned long startSeqNo )
 {
   mStartSequenceNumber = startSeqNo;
 }
 
+void UpdateAddressBooksJob::setLastPORebuildTime( const unsigned long lastPORebuildTime)
+{
+  mLastPORebuildTime = lastPORebuildTime;
+}
+
 void UpdateAddressBooksJob::run()
 {
   kdDebug() << "UpdateAddressBooksJob::run()" << endl;
 
-  mSoap->header->ngwt__session = mSession;
-  _ngwm__getDeltasRequest request;
-  _ngwm__getDeltasResponse response;
+  while ( true )
+  {
+    mSoap->header->ngwt__session = mSession;
+    _ngwm__getDeltasRequest request;
+    _ngwm__getDeltasResponse response;
 
-  GWConverter conv( mSoap );
-  request.container.append( mAddressBookIds.first().latin1() );
-  request.deltaInfo = soap_new_ngwt__DeltaInfo( mSoap, -1 );
-  request.deltaInfo->count = (int*)soap_malloc( mSoap, sizeof(int) );
-  *( request.deltaInfo->count ) = -1;
- /* request.deltaInfo->count = 0;*/
-  request.deltaInfo->lastTimePORebuild = 0;
-  request.deltaInfo->firstSequence = (unsigned long*)soap_malloc( mSoap, sizeof(unsigned long) );
-  *(request.deltaInfo->firstSequence) = mStartSequenceNumber;
-  request.deltaInfo->lastSequence = 0; /*(unsigned long*)soap_malloc( mSoap, sizeof(unsigned long) );*/
-  /* *(request.deltaInfo->lastSequence) = mLastSequenceNumber; */
-  //request.view = soap_new_std__string( mSoap, -1 );
-  //request.view->append("id name version modified ItemChanges");
-  request.view = 0;
-  soap_call___ngw__getDeltasRequest( mSoap, mUrl.latin1(),
-                                              NULL, &request, &response);
-  soap_print_fault( mSoap, stderr );
-  response.items->item;
-  
-  
-  if ( response.items ) {
-    std::vector<class ngwt__Item * > items = response.items->item;
+    GWConverter conv( mSoap );
+    request.container.append( mAddressBookIds.first().latin1() );
+    request.deltaInfo = soap_new_ngwt__DeltaInfo( mSoap, -1 );
+    request.deltaInfo->count = (int*)soap_malloc( mSoap, sizeof(int) );
+    *( request.deltaInfo->count ) = READ_ADDRESS_FOLDER_CHUNK_SIZE;
+    request.deltaInfo->lastTimePORebuild = mLastPORebuildTime;
+    request.deltaInfo->firstSequence = (unsigned long*)soap_malloc( mSoap, sizeof(unsigned long) );
+    *(request.deltaInfo->firstSequence) = mStartSequenceNumber;
+    request.deltaInfo->lastSequence = 0; /*(unsigned long*)soap_malloc( mSoap, sizeof(unsigned long) );*/
+    //request.view = soap_new_std__string( mSoap, -1 );
+    //request.view->append("id name version modified ItemChanges");
+    request.view = 0;
+    soap_call___ngw__getDeltasRequest( mSoap, mUrl.latin1(),
+                                                NULL, &request, &response);
+    soap_print_fault( mSoap, stderr );
+
+    if ( response.items ) {
+      std::vector<class ngwt__Item * > items = response.items->item;
 #if 1
-    kdDebug() << "ReadAddressBooksJob::UpdateAddressBooksJob() - got " << items.size() << "contacts" << endl;
+      kdDebug() << "  - got " << items.size() << "contacts" << endl;
 #endif
-    KABC::Addressee::List contacts;
-    ContactConverter converter( mSoap );
+      KABC::Addressee::List contacts;
+      ContactConverter converter( mSoap );
 
-    std::vector<class ngwt__Item * >::const_iterator it;
-    for ( it = items.begin(); it != items.end(); ++it ) {
-      ngwt__Item *item = *it;
+      std::vector<class ngwt__Item * >::const_iterator it;
+      for ( it = items.begin(); it != items.end(); ++it ) {
+        ngwt__Item *item = *it;
 
-#if 1
-    if ( item )
-      if ( item->name )
-        kdDebug() << "ITEM: " << item->name->c_str() << endl;
-      if ( item->id )
-        kdDebug() << "ITEM: ID (" << item->id->c_str()
-        << ")" << endl;
-    else 
-      kdDebug() << "ITEM is null" << endl;
+#if 0
+      if ( item )
+        if ( item->name )
+          kdDebug() << "ITEM: " << item->name->c_str() << endl;
+        if ( item->id )
+          kdDebug() << "ITEM: ID (" << item->id->c_str()
+          << ")" << endl;
+      else 
+        kdDebug() << "ITEM is null" << endl;
 #endif
 
-      ngwt__Contact *contact = dynamic_cast<ngwt__Contact *>( item );
+        ngwt__Contact *contact = dynamic_cast<ngwt__Contact *>( item );
 
-      KABC::Addressee addr = converter.convertFromContact( contact );
-      if ( !addr.isEmpty() )
-        contacts.append( addr );
+        KABC::Addressee addr = converter.convertFromContact( contact );
+        if ( !addr.isEmpty() )
+          contacts.append( addr );
+      }
+      mServer->emitGotAddressees( contacts );
+
+      // now stop if we got less items than we asked for.
+      if ( items.size() < READ_ADDRESS_FOLDER_CHUNK_SIZE )
+        break;
+      else
+        mStartSequenceNumber += READ_ADDRESS_FOLDER_CHUNK_SIZE;
     }
-    mServer->emitGotAddressees( contacts );
+    else if ( response.status && response.status->code == 0xD716 )
+    {
+      kdDebug() << "The cached address book is too old, we have to refresh the whole thing." << endl;
+      mError = GroupWise::RefreshNeeded;
+      return;
+    }
+    else
+      return;
   }
-
-//   if ( addressBookListResponse.books ) { 
-//     std::vector<class ngwt__AddressBook * > *addressBooks = &addressBookListResponse.books->book;
 }
Index: kresources/groupwise/soap/groupwiseserver.h
===================================================================
--- kresources/groupwise/soap/groupwiseserver.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/groupwiseserver.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -64,6 +64,8 @@
 
 namespace GroupWise {
 
+enum ErrorCode { NoError, RefreshNeeded };
+
 class AddressBook
 {
   public:
@@ -100,7 +102,8 @@
                      const QString &password, QObject *parent );
     ~GroupwiseServer();
 
-    QString error() const { return mError; }
+    int error() const { return mError; }
+    QString errorText() const { return mErrorText; }
 
     bool login();
     bool logout();
@@ -148,7 +151,7 @@
 
     bool readAddressBooksSynchronous( const QStringList &addrBookIds );
     bool updateAddressBooks( const QStringList &addrBookIds,
-      const unsigned int startSequenceNumber );
+    const unsigned long startSequenceNumber, const unsigned long lastPORebuildTime );
 
     bool insertAddressee( const QString &addrBookId, KABC::Addressee& );
     bool changeAddressee( const KABC::Addressee& );
@@ -234,7 +237,8 @@
     
     KExtendedSocket *m_sock;
 
-    QString mError;
+    int mError;
+    QString mErrorText;
 
     QString mLogFile;
 };
Index: kresources/groupwise/soap/contactconverter.cpp
===================================================================
--- kresources/groupwise/soap/contactconverter.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/soap/contactconverter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -215,7 +215,7 @@
 
 KABC::Addressee ContactConverter::convertFromAddressBookItem( ngwt__AddressBookItem * addrBkItem )
 {
-  kdDebug() << "ContactConverter::convertFromAddressBookItem()" << endl;
+  //kdDebug() << "ContactConverter::convertFromAddressBookItem()" << endl;
   KABC::Addressee addr;
   if ( !addrBkItem )
   {
@@ -234,7 +234,7 @@
 
 KABC::Addressee ContactConverter::convertFromResource( ngwt__Resource* resource )
 {
-  kdDebug() << "ContactConverter::convertFromResource()" << endl;
+  //kdDebug() << "ContactConverter::convertFromResource()" << endl;
   KABC::Addressee addr = convertFromAddressBookItem( resource );
   if ( !resource )
   {
@@ -254,7 +254,7 @@
 
 KABC::Addressee ContactConverter::convertFromGroup( ngwt__Group* group)
 {
-  kdDebug() << "ContactConverter::convertFromGroup()" << endl;
+//  kdDebug() << "ContactConverter::convertFromGroup()" << endl;
   KABC::Addressee addr = convertFromAddressBookItem( group );
   if ( !group )
   {
@@ -267,7 +267,7 @@
 
 KABC::Addressee ContactConverter::convertFromContact( ngwt__Contact* contact )
 {
-  kdDebug() << "ContactConverter::convertFromContact()" << endl;
+//  kdDebug() << "ContactConverter::convertFromContact()" << endl;
 
   KABC::Addressee addr = convertFromAddressBookItem( contact );
 
Index: kresources/groupwise/kcal_resourcegroupwise.cpp
===================================================================
--- kresources/groupwise/kcal_resourcegroupwise.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kcal_resourcegroupwise.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -245,7 +245,7 @@
 
   if ( !server.login() ) {
     kdError() << "Unable to login to server" << endl;
-    emit resourceSaveError( this, i18n( "Unable to login to server: " ) + server.error() );
+    emit resourceSaveError( this, i18n( "Unable to login to server: " ) + server.errorText() );
     return false;
   }
 
Index: kresources/groupwise/kabc_groupwise.desktop
===================================================================
--- kresources/groupwise/kabc_groupwise.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kabc_groupwise.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Novell GroupWise -palvelin
 Name[fr]=Serveur de travail collaboratif GroupWise de Novell
 Name[ga]=Freastalaí Novell GroupWise
+Name[gl]=Servidor Novell GroupWise
 Name[hu]=Novell GroupWise kiszolgáló
 Name[is]=Novell GroupWise þjónn
 Name[it]=Server Novell GroupWise
Index: kresources/groupwise/kioslave/groupwise.cpp
===================================================================
--- kresources/groupwise/kioslave/groupwise.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupwise/kioslave/groupwise.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -34,6 +34,7 @@
 #include <kabc/vcardconverter.h>
 
 #include <kinstance.h>
+#include <kio/global.h>
 #include <kdebug.h>
 #include <klocale.h>
 #include <ktempfile.h>
@@ -198,11 +199,11 @@
       kdDebug() << "Login" << endl;
 
       if ( !server.login() ) {
-        errorMessage( i18n("Unable to login: ") + server.error() );
+        errorMessage( i18n("Unable to login: ") + server.errorText() );
       } else {
         kdDebug() << "Read free/busy" << endl;
         if ( !server.readFreeBusy( email, start, end, fb ) ) {
-          errorMessage( i18n("Unable to read free/busy data: ") + server.error() );
+          errorMessage( i18n("Unable to read free/busy data: ") + server.errorText() );
         }
         kdDebug() << "Read free/busy" << endl;
         server.logout();
@@ -244,11 +245,11 @@
 
   kdDebug() << "Login" << endl;
   if ( !server.login() ) {
-    errorMessage( i18n("Unable to login: ") + server.error() );
+    errorMessage( i18n("Unable to login: ") + server.errorText() );
   } else {
     kdDebug() << "Read calendar" << endl;
     if ( !server.readCalendarSynchronous( &calendar ) ) {
-      errorMessage( i18n("Unable to read calendar data: ") + server.error() );
+      errorMessage( i18n("Unable to read calendar data: ") + server.errorText() );
     }
     kdDebug() << "Logout" << endl;
     server.logout();
@@ -305,11 +306,11 @@
 
     kdDebug() << "Login" << endl;
     if ( !server.login() ) {
-      errorMessage( i18n("Unable to login: ") + server.error() );
+      errorMessage( i18n("Unable to login: ") + server.errorText() );
     } else {
       kdDebug() << "Read Addressbook" << endl;
       if ( !server.readAddressBooksSynchronous( ids ) ) {
-        errorMessage( i18n("Unable to read addressbook data: ") + server.error() );
+        errorMessage( i18n("Unable to read addressbook data: ") + server.errorText() );
       }
       kdDebug() << "Logout" << endl;
       server.logout();
@@ -330,6 +331,7 @@
 
 void Groupwise::updateAddressbook( const KURL &url )
 {
+  kdDebug() << "Groupwise::updateAddressbook() " << url << endl;
   QString u = soapUrl( url );
 
   QString user = url.user();
@@ -341,7 +343,8 @@
 
   QString query = url.query();
 
-  unsigned int lastSequenceNumber = 0;
+  unsigned long lastSequenceNumber = 0;
+  unsigned long lastPORebuildTime = 0;
 
   if ( query.isEmpty() || query == "?" ) {
     errorMessage( i18n("No addressbook IDs given.") );
@@ -357,8 +360,10 @@
       if ( item.count() == 2 && item[ 0 ] == "addressbookid" ) {
         ids.append( item[ 1 ] );
       }
-       if ( item.count() == 2 && item[ 0 ] == "lastSeqNo" )
-        lastSequenceNumber = item[ 1 ].toInt();
+      if ( item.count() == 2 && item[ 0 ] == "lastSeqNo" )
+        lastSequenceNumber = item[ 1 ].toULong();
+      if ( item.count() == 2 && item[ 0 ] == "PORebuildTime" )
+        lastPORebuildTime = item[ 1 ].toULong();
     }
     
     debugMessage( "update IDs: " + ids.join( "," ) );
@@ -369,15 +374,17 @@
     connect( &server, SIGNAL( gotAddressees( const KABC::Addressee::List ) ),
       SLOT( slotReadReceiveAddressees( const KABC::Addressee::List ) ) );
 
-    kdDebug() << "Login" << endl;
+    kdDebug() << "  Login" << endl;
     if ( !server.login() ) {
-      errorMessage( i18n("Unable to login: ") + server.error() );
+      errorMessage( i18n("Unable to login: ") + server.errorText() );
     } else {
-      kdDebug() << "Update Addressbook" << endl;
-      if ( !server.updateAddressBooks( ids, lastSequenceNumber ) ) {
-        errorMessage( i18n("Unable to update addressbook data: ") + server.error() );
+      kdDebug() << "  Updating Addressbook" << endl;
+      if ( !server.updateAddressBooks( ids, lastSequenceNumber + 1, lastPORebuildTime ) )
+      {
+        error( KIO::ERR_NO_CONTENT, server.errorText() );
+        //errorMessage( i18n("Unable to update addressbook data: ") + server.errorText() );
       }
-      kdDebug() << "Logout" << endl;
+      kdDebug() << "  Logout" << endl;
       server.logout();
       finished();
     }
Index: kresources/slox/kcal_slox.desktop
===================================================================
--- kresources/slox/kcal_slox.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/slox/kcal_slox.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Suse Linux Openexchange -palvelin
 Name[fr]=Serveur SUSE Linux Openexchange
 Name[ga]=Freastalaí Openexchange SUSE LINUX
+Name[gl]=Servidor SUSE LINUX Openexchange
 Name[hu]=SUSE LINUX Openexchange-kiszolgáló
 Name[is]=SUSE LINUX Openexchange þjónn
 Name[it]=Server SUSE LINUX Openexchange
Index: kresources/slox/kcal_ox.desktop
===================================================================
--- kresources/slox/kcal_ox.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/slox/kcal_ox.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fi]=OpenXchange-palvelin
 Name[fr]=Serveur OpenXchange
 Name[ga]=Freastalaí Openexchange
+Name[gl]=Servidor OpenXchange
 Name[hu]=OpenXchange-kiszolgáló
 Name[is]=OpenXchange þjónn
 Name[ja]=OpenXchange サーバ
Index: kresources/slox/kabc_slox.desktop
===================================================================
--- kresources/slox/kabc_slox.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/slox/kabc_slox.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Suse Linux Openexchange -palvelin
 Name[fr]=Serveur SUSE Linux Openexchange
 Name[ga]=Freastalaí Openexchange SUSE LINUX
+Name[gl]=Servidor SUSE LINUX Openexchange
 Name[hu]=SUSE LINUX Openexchange-kiszolgáló
 Name[is]=SUSE LINUX Openexchange þjónn
 Name[it]=Server SUSE LINUX Openexchange
Index: kresources/slox/kabc_ox.desktop
===================================================================
--- kresources/slox/kabc_ox.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/slox/kabc_ox.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fi]=OpenXchange-palvelin
 Name[fr]=Serveur OpenXchange
 Name[ga]=Freastalaí Openexchange
+Name[gl]=Servidor OpenXchange
 Name[hu]=OpenXchange-kiszolgáló
 Name[is]=OpenXchange þjónn
 Name[ja]=OpenXchange サーバ
Index: kresources/featureplan/kcal_resourcefeatureplan.desktop
===================================================================
--- kresources/featureplan/kcal_resourcefeatureplan.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/featureplan/kcal_resourcefeatureplan.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,13 +11,14 @@
 Name[fa]=نقشۀ ویژگی XML
 Name[fi]=XML-ominaisuussuunnitelma
 Name[fr]=Plan de fonctionnalités XML
+Name[gl]=Plan de Características en XML
 Name[hu]=XML FeaturePlan
 Name[is]=XML fídusa áætlun
 Name[it]=Piano caratteristiche XML
 Name[km]=គ្រោង​លក្ខណៈ​ពិសេស XML
 Name[lt]=XML bruožų planas
 Name[ms]=Pelan Cirian XML 
-Name[nds]=XML-Funktschonenplaan
+Name[nds]=XML-Funkschonenplaan
 Name[nl]=Functionaliteitsplanning in XML
 Name[pl]=Plan funkcjonalności XML
 Name[pt]=Plano de Funcionalidades em XML
Index: kresources/groupdav/kabc_groupdav.desktop
===================================================================
--- kresources/groupdav/kabc_groupdav.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupdav/kabc_groupdav.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=GroupDAV-palvelin (esim. OpenGroupware)
 Name[fr]=GroupDAV Serveur (ex. OpenGroupware)
 Name[ga]=Freastalaí GroupDAV (m.sh. OpenGroupware)
+Name[gl]=Servidor GroupDAV (e.g. OpenGroupware)
 Name[hu]=GroupDAV-kiszolgáló (pl. OpenGroupware)
 Name[is]=GroupDAV þjónn (t.d. OpenGroupware)
 Name[it]=Server GroupDAV (per es. OpenGroupware)
Index: kresources/groupdav/kcal_groupdav.desktop
===================================================================
--- kresources/groupdav/kcal_groupdav.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupdav/kcal_groupdav.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=GroupDAV-palvelin (esim. OpenGroupware)
 Name[fr]=GroupDAV Serveur (ex. OpenGroupware)
 Name[ga]=Freastalaí GroupDAV (m.sh. OpenGroupware)
+Name[gl]=Servidor GroupDAV (e.g. OpenGroupware)
 Name[hu]=GroupDAV-kiszolgáló (pl. OpenGroupware)
 Name[is]=GroupDAV þjónn (t.d. OpenGroupware)
 Name[it]=Server GroupDAV (per es. OpenGroupware)
Index: kresources/blogging/blogging.desktop
===================================================================
--- kresources/blogging/blogging.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/blogging/blogging.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -12,6 +12,7 @@
 Name[fa]=نشریه‌ها به عنوان وب‌نوشتها روی یک کارساز
 Name[fi]=Päiväkirjat blogeina palvelimella
 Name[fr]=Journaux (blogs) sur un serveur
+Name[gl]=Xornais como Bitácoras nun Servidor
 Name[hu]=Naplók blogként tárolása a kiszolgálón
 Name[is]=Dagbækur sem blogg á þjóni
 Name[it]=Diari come blog su un server
Index: kresources/kolab/kabc/kolab.desktop
===================================================================
--- kresources/kolab/kabc/kolab.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/kolab/kabc/kolab.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=Osoitekirja IMAP-palvelimella KMailin avulla
 Name[fr]=Carnet d'adresse sur serveur IMAP (via KMail)
 Name[ga]=Leabhar Seoltaí ar Fhreastalaí IMAP via KMail
+Name[gl]=Caderno de enderezos nun servidor IMAP mediante KMail
 Name[hu]=IMAP-kiszolgálón tárolt címjegyzék a KMailen keresztül
 Name[is]=Vistfangaskrá á IMAP þjóni gegnum KMail
 Name[it]=Rubrica indirizzi su server IMAP via KMail
Index: kresources/kolab/knotes/kolabresource.desktop
===================================================================
--- kresources/kolab/knotes/kolabresource.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/kolab/knotes/kolabresource.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=IMAP-palvelin KMailin avulla
 Name[fr]=Serveur IMAP (via KMail)
 Name[ga]=Freastalaí IMAP via KMail
+Name[gl]=Servidor MAP mediante KMail
 Name[hu]=IMAP-kiszolgáló a KMailen keresztül
 Name[is]=IMAP þjónn gegnum KMail
 Name[it]=Server IMAP via KMail
Index: kresources/kolab/kcal/kolab.desktop
===================================================================
--- kresources/kolab/kcal/kolab.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/kolab/kcal/kolab.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=Kalenteri IMAP-palvelimella KMailin avulla
 Name[fr]=Agenda sur serveur IMAP (via KMail)
 Name[ga]=Féilire ar Fhreastalaí IMAP via KMail
+Name[gl]=Calendario no servidor IMAP mediante KMail
 Name[hu]=IMAP-kiszolgálón tárolt naptár a KMailen keresztül
 Name[is]=Dagatal á IMAP þjóni gegnum KMail
 Name[it]=Calendario su server IMAP via KMail
Index: kresources/birthdays/resourcekabc.cpp
===================================================================
--- kresources/birthdays/resourcekabc.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/birthdays/resourcekabc.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -270,7 +270,7 @@
     }
 
     Event *ev = new Event();
-      ev->setUid( (*it).uid()+"_KABC_Anniversary");
+      ev->setUid( uid_1+"_KABC_Anniversary" );
 
     ev->setDtStart(anniversary);
     ev->setDtEnd(anniversary);
@@ -281,7 +281,7 @@
 
     ev->setCustomProperty( "KABC", "BIRTHDAY", "YES" );
 
-    ev->setCustomProperty( "KABC", "UID-1", (*it).uid() );
+    ev->setCustomProperty( "KABC", "UID-1", uid_1 );
     ev->setCustomProperty( "KABC", "NAME-1", name_1 );
     ev->setCustomProperty( "KABC", "EMAIL-1", email_1 );
     ev->setCustomProperty( "KABC", "ANNIVERSARY", "YES" );
Index: kresources/groupware/kabc_groupware.desktop
===================================================================
--- kresources/groupware/kabc_groupware.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupware/kabc_groupware.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Groupware Server
+Name[ar]=خادم البرمجيات الجماعية
 Name[bg]=Сървър Groupware
 Name[br]=Servijer strollant
 Name[ca]=Servidor Groupware
@@ -9,10 +10,11 @@
 Name[es]=Servidor de Groupware
 Name[et]=Grupitöö server
 Name[eu]=Groupware zerbitzaria
-Name[fa]=کارساز Groupware 
+Name[fa]=کارساز Groupware
 Name[fi]=Groupware-palvelin
 Name[fr]=Serveur de travail collaboratif
 Name[ga]=Freastalaí Groupware
+Name[gl]=Servidor de Traballo en Grupo
 Name[hu]=Groupware kiszolgáló
 Name[is]=Groupware þjónn
 Name[it]=Server Groupware
Index: kresources/groupware/kcal_groupware.desktop
===================================================================
--- kresources/groupware/kcal_groupware.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/groupware/kcal_groupware.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Groupware Server
+Name[ar]=خادم البرمجيات الجماعية
 Name[bg]=Сървър Groupware
 Name[br]=Servijer strollant
 Name[ca]=Servidor Groupware
@@ -9,10 +10,11 @@
 Name[es]=Servidor de Groupware
 Name[et]=Grupitöö server
 Name[eu]=Groupware zerbitzaria
-Name[fa]=کارساز Groupware 
+Name[fa]=کارساز Groupware
 Name[fi]=Groupware-palvelin
 Name[fr]=Serveur de travail collaboratif
 Name[ga]=Freastalaí Groupware
+Name[gl]=Servidor de Traballo en Grupo
 Name[hu]=Groupware kiszolgáló
 Name[is]=Groupware þjónn
 Name[it]=Server Groupware
Index: kresources/remote/remote.desktop
===================================================================
--- kresources/remote/remote.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/remote/remote.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fi]=Kalenteri etätiedostossa
 Name[fr]=Calendrier dans un fichier distant
 Name[ga]=Féilire i gCianchomhad
+Name[gl]=Calendario en ficheiro remoto
 Name[hi]=रिमोट फ़ाइल में कैलेन्डर
 Name[hu]=Távoli fájlban tárolt naptár
 Name[is]=Dagatal í fjarlægri skrá
Index: kresources/newexchange/kabc_newexchange.desktop
===================================================================
--- kresources/newexchange/kabc_newexchange.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/newexchange/kabc_newexchange.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Osoitekirja Exchange-palvelimella (kokeellinen)
 Name[fr]=Carnet d'adresse sur un serveur Exchange (expérimental)
 Name[ga]=Leabhar Seoltaí ar Fhreastalaí Exchange (trialach)
+Name[gl]=Caderno de enderezos no Servidor Exchange2000 (experimental)
 Name[hu]=Exchange-kiszolgáló címjegyzéke (kísérleti)
 Name[is]=Vistfangaskrá Exchange þjóni (á tilraunarstigi)
 Name[it]=Rubrica indirizzi su un server Exchange (sperimentale)
Index: kresources/newexchange/kabc_newexchange_final.desktop
===================================================================
--- kresources/newexchange/kabc_newexchange_final.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/newexchange/kabc_newexchange_final.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,10 +11,11 @@
 Name[es]=Libreta de direcciones en un servidor Exchange
 Name[et]=Aadressiraamat Exchange-serveris
 Name[eu]=Helbide-liburua Exchange zerbitzari (esperimentala)
-Name[fa]=کتاب نشانی روی یک کارساز مبادله‌
+Name[fa]=کتاب نشانی روی یک کارساز مبادله
 Name[fi]=Osoitekirja Exchange-palvelimella
 Name[fr]=Carnet d'adresse sur un serveur Exchange
 Name[ga]=Leabhar Seoltaí ar Fhreastalaí Exchange
+Name[gl]=Caderno de enderezos nun Servidor Exchange
 Name[he]=פנקס כתובות בשרת Exchange
 Name[hu]=Exchange-kiszolgáló címjegyzéke
 Name[is]=Vistfangaskrá á Exchange þjóni
Index: kresources/newexchange/kcal_newexchange.desktop
===================================================================
--- kresources/newexchange/kcal_newexchange.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/newexchange/kcal_newexchange.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Kalenteri Exchange-palvelimella (kokeellinen)
 Name[fr]=Agenda sur un serveur Exchange (expérimental)
 Name[ga]=Féilire ar Fhreastalaí Exchange (trialach)
+Name[gl]=Calendario nun servidor Exchange (experimental)
 Name[hu]=Exchange 2000-kiszolgáló naptára (kísérleti)
 Name[is]=Dagatal á Exchange þjóni (á tilraunarstigi)
 Name[it]=Calendario su un server Exchange (sperimentale)
Index: kresources/newexchange/kcal_newexchange_final.desktop
===================================================================
--- kresources/newexchange/kcal_newexchange_final.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kresources/newexchange/kcal_newexchange_final.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -12,10 +12,11 @@
 Name[es]=Calendario en un servidor Exchange
 Name[et]=Kalender Exchange-serveris
 Name[eu]=Egutegia Exchange zerbitzari batean
-Name[fa]=تقویم روی یک کارساز مبادله‌
+Name[fa]=تقویم روی یک کارساز مبادله
 Name[fi]=Kalenteri Exchange-palvelimella
 Name[fr]=Agenda sur un serveur Exchange
 Name[ga]=Féilire ar Fhreastalaí Exchange
+Name[gl]=Calendario nun servidor Exchange
 Name[hu]=Exchange 2000-kiszolgáló naptára
 Name[is]=Dagatal á Exchange þjóni
 Name[it]=Calendario su un server Exchange
Index: certmanager/conf/kleopatra_config_appear.desktop
===================================================================
--- certmanager/conf/kleopatra_config_appear.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ certmanager/conf/kleopatra_config_appear.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -124,7 +124,7 @@
 Keywords[es]=color, tipografía, configuración
 Keywords[et]=värv, font, seadistamine
 Keywords[eu]=kolore,letra-tipo, konfigurazioa
-Keywords[fa]=رنگ،قلم،پیکربندی‌
+Keywords[fa]=رنگ، قلم، پیکربندی
 Keywords[fi]=värit,kirjasimet,asetukset
 Keywords[fr]=couleur,police,configuration,paramètres,réglages,couleurs,polices
 Keywords[ga]=dath,cló,cumraíocht
Index: certmanager/conf/kleopatra_config_dnorder.desktop
===================================================================
--- certmanager/conf/kleopatra_config_dnorder.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ certmanager/conf/kleopatra_config_dnorder.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -67,7 +67,7 @@
 Comment[es]=Configura el orden en el que se muestran los atributos DN
 Comment[et]=DN-atribuutide näitamise järjekorra seadistamine
 Comment[eu]=Konfiguratu DN atributuak zein ordenetan erakutsiko diren
-Comment[fa]=پیکربندی ترتیبی که خصیصه‌های DN با آن نمایش داده می‌شوند
+Comment[fa]=پیکربندی ترتیبی که خصیصه‌های DN طبق آن نمایش داده می‌شوند
 Comment[fi]=Määrittele missä järjestyksessä DN-attribuutit näytetään
 Comment[fr]=Configurer l'ordre dans lequel les attributs DN sont affichés
 Comment[gl]=Configurar a orde en que se amosan os atributos DN
@@ -111,7 +111,7 @@
 Keywords[es]=DN,orden,RDN,atributo
 Keywords[et]=DN,järjekord,RDN,atribuut
 Keywords[eu]=DN, ordena, RDN, atributua
-Keywords[fa]=DN،ترتیب،RDN،خصیصه‌
+Keywords[fa]=DN، ترتیب، RDN، خصیصه
 Keywords[fi]=DN,järjestys,RDN,attribuutti
 Keywords[fr]=DN,ordre,RDN,attribut
 Keywords[ga]=DN,ord,RDN,aitreabúid
Index: certmanager/conf/kleopatra_config_dirserv.desktop
===================================================================
--- certmanager/conf/kleopatra_config_dirserv.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ certmanager/conf/kleopatra_config_dirserv.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -114,7 +114,7 @@
 Keywords[es]=ldap,directorio,servicios
 Keywords[et]=ldap,kataloog,teenused
 Keywords[eu]=Idap, direktorio, zerbitzuak
-Keywords[fa]=ldap،فهرست راهنما،خدمات‌‌
+Keywords[fa]=ldap، فهرست راهنما، خدمات
 Keywords[fi]=ldap,hakemisto,palvelut
 Keywords[fr]=ldap,dossier,dossiers,service,services
 Keywords[ga]=ldap,eolaire,seirbhísí
Index: certmanager/lib/libkleopatrarc.desktop
===================================================================
--- certmanager/lib/libkleopatrarc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ certmanager/lib/libkleopatrarc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,10 +13,11 @@
 Name[fa]=کلید بدون اعتبار
 Name[fi]=Varmistamaton avain
 Name[fr]=Clé non validée
+Name[gl]=Non hai Chave Validada
 Name[he]=מפתח לא מוודא
 Name[hu]=Nem ellenőrzött kulcs
 Name[is]=Ekki staðfestur lykill
-Name[it]=Chiave non validata
+Name[it]=Chiave non convalidata
 Name[ja]=認証されていない鍵
 Name[km]=កូនសោ​គ្មាន​សុពលភាព
 Name[lt]=Nevaliduotas raktas
@@ -56,9 +57,10 @@
 Name[es]=Clave caducada
 Name[et]=Aegunud võti
 Name[eu]=Iraungitako gakoa
-Name[fa]=کلید منقضی‌
+Name[fa]=کلید منقضی
 Name[fi]=Vanhentunut avain
 Name[fr]=Clé expirée
+Name[gl]=Chave caducada
 Name[he]=מפתח לא תקף
 Name[hu]=Lejárt kulcs
 Name[is]=Útrunninn lykill
@@ -99,9 +101,10 @@
 Name[es]=Clave revocada
 Name[et]=Tühistatud võti
 Name[eu]=Errebokatutako gakoa
-Name[fa]=کلید لغو شده‌
+Name[fa]=کلید لغو‌شده
 Name[fi]=Peruutettu avain
 Name[fr]=Clé révoquée
+Name[gl]=Chave revocada
 Name[he]=מפתח לא קביל
 Name[hu]=Visszavont kulcs
 Name[is]=Afturkallaður lykill
@@ -143,9 +146,10 @@
 Name[es]=Certificado raíz de confianza
 Name[et]=Usaldusväärne juursertifikaat
 Name[eu]=Konfidantzazko erro ziurtagiria
-Name[fa]=گواهینامۀ معتبر کاربر ارشد
+Name[fa]=گواهی‌نامۀ معتبر کاربر ارشد
 Name[fi]=Luotettu juurivarmenne
 Name[fr]=Certificat racine de confiance
+Name[gl]=Certificado raiz autentificado
 Name[hu]=Megbízható gyökértanúsítvány
 Name[is]=Treyst rótarskilríki
 Name[it]=Certificato radice affidabile
@@ -186,9 +190,10 @@
 Name[es]=Certificado raíz no de confianza
 Name[et]=Ebausaldusväärne juursertifikaat
 Name[eu]=Konfidantza gabeko erro ziurtagiria
-Name[fa]=گواهینامۀ بدون اعتبار کاربر ارشد
+Name[fa]=گواهی‌نامۀ بدون اعتبار کاربر ارشد
 Name[fi]=Ei-luotettu juurivarmenne
 Name[fr]=Certificat racine non fiable
+Name[gl]=Certificado raiz non autentificado
 Name[hu]=Nem megbízható gyökértanúsítvány
 Name[is]=Ekki traust rótarskilríki
 Name[it]=Certificato radice non affidabile
@@ -232,6 +237,7 @@
 Name[fi]=Muut avaimet
 Name[fr]=Autres clés
 Name[ga]=Eochracha Eile
+Name[gl]=Outras chaves
 Name[he]=מפתחות אחרים
 Name[hu]=Egyéb kulcsok
 Name[is]=Aðrir lyklar
Index: libkmime/kmime_parsers.cpp
===================================================================
--- libkmime/kmime_parsers.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_parsers.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -72,7 +72,7 @@
         pos2=-1; //break;
       }
       else {
-        part=s_rc.mid(pos1, pos2-pos1);
+        part=s_rc.mid(pos1, pos2-pos1 - 1 ); // pos2 - 1 (\n) is part of the boundary (see RFC 2046, section 5.1.1)
         p_arts.append(part);
         pos2+=blen; //pos2 points now to the first charakter after the boundary
         if(s_rc[pos2]=='-' && s_rc[pos2+1]=='-') { //end-boundary
Index: libkmime/kmime_message.cpp
===================================================================
--- libkmime/kmime_message.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_message.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -62,6 +62,10 @@
   if( (h=to(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //Cc
+  if( (h=cc(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Reply-To
   if( (h=replyTo(false))!=0 )
     newHead+=h->as7BitString()+"\n";
@@ -78,6 +82,10 @@
   if( (h=organization(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //UserAgent
+  if( (h=userAgent(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Mime-Version
   newHead+="MIME-Version: 1.0\n";
 
Index: libkmime/kmime_content.cpp
===================================================================
--- libkmime/kmime_content.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_content.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -345,7 +345,7 @@
   }
   else if(c_ontents && !c_ontents->isEmpty()) { //this is a multipart message
     Headers::ContentType *ct=contentType();
-    QCString boundary="--"+ct->boundary();
+    QCString boundary="\n--"+ct->boundary();
 
     //add all (encoded) contents separated by boundaries
     for(Content *c=c_ontents->first(); c; c=c_ontents->next()) {
Index: libkmime/kmime_headers_obs.h
===================================================================
--- libkmime/kmime_headers_obs.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_headers_obs.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -166,6 +166,8 @@
 
     void addAddress(const AddressField &a);
     void emails(QStrList *l);
+    void names(QStringList *l);
+    void displayNames(QStringList *l);
 
   protected:
     ObsAddressList *a_ddrList;
Index: libkmime/kmime_newsarticle.h
===================================================================
--- libkmime/kmime_newsarticle.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_newsarticle.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,7 +43,6 @@
   virtual KMime::Headers::Newsgroups* newsgroups(bool create=true)      { KMime::Headers::Newsgroups *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::FollowUpTo* followUpTo(bool create=true)      { KMime::Headers::FollowUpTo *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::Lines* lines(bool create=true)                { if(!create && l_ines.isEmpty()) return 0; return &l_ines; }
-  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
 
 
 protected:
Index: libkmime/kmime_message.h
===================================================================
--- libkmime/kmime_message.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_message.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -51,6 +51,7 @@
   virtual KMime::Headers::CC* cc(bool create=true)                      { KMime::Headers::CC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::BCC* bcc(bool create=true)                    { KMime::Headers::BCC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::References* references(bool create=true)      { KMime::Headers::References *p=0; return getHeaderInstance(p, create); }
+  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
   
 protected:
   //hardcoded headers
Index: libkmime/kmime_headers.cpp
===================================================================
--- libkmime/kmime_headers.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkmime/kmime_headers.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -257,7 +257,7 @@
   QString maybeDotAtom;
   if ( !parseDotAtom( scursor, send, maybeDotAtom, isCRLF ) )
     return false;
-  
+
   mDotAtom = maybeDotAtom;
 
   eatCFWS( scursor, send, isCRLF );
@@ -298,7 +298,7 @@
 
   //
   // type
-  // 
+  //
 
   QPair<const char*,int> maybeMimeType;
   if ( !parseToken( scursor, send, maybeMimeType, false /* no 8Bit */ ) )
@@ -328,10 +328,10 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return true; // no parameters
-  
+
   if ( *scursor != ';' ) return false;
   scursor++;
-  
+
   if ( !parseParameterList( scursor, send, mParameterHash, isCRLF ) )
     return false;
 
@@ -356,7 +356,7 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return false;
-  
+
   QPair<const char*,int> maybeToken;
   if ( !parseToken( scursor, send, maybeToken, false /* no 8Bit */ ) )
     return false;
@@ -369,10 +369,10 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return true; // no parameters
-  
+
   if ( *scursor != ';' ) return false;
   scursor++;
-  
+
   if ( !parseParameterList( scursor, send, mParameterHash, isCRLF ) )
     return false;
 
@@ -445,7 +445,7 @@
 //-----<ReturnPath>-------------------------
 
 bool ReturnPath::parse( const char* & scursor, const char * const send, bool isCRLF ) {
-  
+
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return false;
 
@@ -460,7 +460,7 @@
     eatCFWS( scursor, send, isCRLF );
     if ( scursor == send || *scursor != '>' ) return false;
     scursor++;
-    
+
     // prepare a Null mailbox:
     AddrSpec emptyAddrSpec;
     maybeMailbox.displayName = QString::null;
@@ -604,7 +604,7 @@
         pos1=pos2+1;
         pos2=s.find('>', pos1);
         if(pos2!=-1)
-          e_mail=s.mid(pos1, pos2-pos1);
+          e_mail=s.mid(pos1, pos2-pos1).stripWhiteSpace();
       }
       else return;
     break;
@@ -922,6 +922,23 @@
       l->append( it->email() );
 }
 
+void To::names(QStringList *l)
+{
+    l->clear();
+
+    for (AddressField *it=a_ddrList->first(); it != 0 ; it=a_ddrList->next() )
+        if( it->hasName() )
+            l->append( it->name() );
+}
+
+void To::displayNames(QStringList *l)
+{
+    l->clear();
+
+    for (AddressField *it=a_ddrList->first(); it != 0 ; it=a_ddrList->next() )
+            l->append( it->asUnicodeString() );
+}
+
 //-----</To>-----------------------------------
 #endif
 
Index: karm/taskview.h
===================================================================
--- karm/taskview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/taskview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -10,6 +10,7 @@
 #include "desktoplist.h"
 #include "resourcecalendar.h"
 #include "karmstorage.h"
+#include "mainwindow.h"
 #include "reportcriteria.h"
 #include <qtimer.h>
 //#include "desktoptracker.h"
@@ -96,6 +97,9 @@
     /** Stop all running timers.  */
     void stopAllTimers();
 
+    /** Stop all running timers as if it was qdt */
+    void stopAllTimersAt(QDateTime qdt);
+
     /** Calls newTask dialog with caption "New Task".  */
     void newTask();
 
@@ -173,12 +177,17 @@
 	 IF YOU DO NOT KNOW WHAT YOU ARE DOING, CALL stopAllTimers INSTEAD */
     void clearActiveTasks();
 
-    /** User has picked a new iCalendar file on preferences screen. */
+    /** User might have picked a new iCalendar file on preferences screen. 
+        Verify the file is not the same as before and load the new one. 
+        This is not iCalFileModified. */
     void iCalFileChanged(QString file);
 
     /** Copy totals for current and all sub tasks to clipboard. */
     void clipTotals();
 
+    /** Copy session times for current and all sub tasks to clipboard */
+    void clipSession();
+
     /** Copy history for current and all sub tasks to clipboard. */
     void clipHistory();
 
@@ -188,6 +197,7 @@
     void timersActive();
     void timersInactive();
     void tasksChanged( QPtrList<Task> activeTasks );
+    void setStatusBar( QString );
 
   private: // member variables
     IdleTimeDetector *_idleTimeDetector;
@@ -218,6 +228,7 @@
     void minuteUpdate();
     /** item state stores if a task is expanded so you can see the subtasks */
     void itemStateChanged( QListViewItem *item );
+    /** React on another process having modified the iCal file we rely on. */
     void iCalFileModified(ResourceCalendar *);
 };
 
Index: karm/idletimedetector.cpp
===================================================================
--- karm/idletimedetector.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/idletimedetector.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -8,7 +8,9 @@
 #include <klocale.h>    // i18n
 
 IdleTimeDetector::IdleTimeDetector(int maxIdle)
+// Trigger a warning after maxIdle minutes
 {
+  kdDebug(5970) << "IdleTimeDetector::IdleTimeDetector" << endl;
   _maxIdle = maxIdle;
 
 #ifdef HAVE_LIBXSS
@@ -35,6 +37,7 @@
 
 void IdleTimeDetector::check()
 {
+  kdDebug(5970) << "Entering IdleTimeDetector::check" << endl;
 #ifdef HAVE_LIBXSS
   if (_idleDetectionPossible)
   {
@@ -76,8 +79,9 @@
 
   if (id == 0) {
     // Revert And Stop
-    emit(extractTime(idleMinutes+diff));
-    emit(stopAllTimers());
+    kdDebug(5970) << "Now it is " << KGlobal::locale()->formatTime(QDateTime::currentDateTime().time()).ascii() << endl;
+    kdDebug(5970) << "Reverting timer to " << KGlobal::locale()->formatTime(idleStart.time()).ascii() << endl;
+    emit(stopAllTimersAt(idleStart));
   }
   else if (id == 1) {
     // Revert and Continue
@@ -93,7 +97,9 @@
 
 void IdleTimeDetector::startIdleDetection()
 {
+  kdDebug(5970) << "Entering IdleTimeDetector::startIdleDetection" << endl; 
 #ifdef HAVE_LIBXSS
+  kdDebug(5970) << "Starting Timer" << endl;
   if (!_timer->isActive())
     _timer->start(testInterval);
 #endif //HAVE_LIBXSS
Index: karm/taskview.cpp
===================================================================
--- karm/taskview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/taskview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -81,8 +81,8 @@
   _idleTimeDetector = new IdleTimeDetector( _preferences->idlenessTimeout() );
   connect( _idleTimeDetector, SIGNAL( extractTime(int) ),
            this, SLOT( extractTime(int) ));
-  connect( _idleTimeDetector, SIGNAL( stopAllTimers() ),
-           this, SLOT( stopAllTimers() ));
+  connect( _idleTimeDetector, SIGNAL( stopAllTimersAt(QDateTime) ),
+           this, SLOT( stopAllTimersAt(QDateTime) ));
   connect( _preferences, SIGNAL( idlenessTimeout(int) ),
            _idleTimeDetector, SLOT( setMaxIdle(int) ));
   connect( _preferences, SIGNAL( detectIdleness(bool) ),
@@ -352,38 +352,20 @@
 
 void TaskView::scheduleSave()
 {
-    _manualSaveTimer->start( 10, true /*single-shot*/ );
+  kdDebug(5970) << "Entering TaskView::scheduleSave" << endl;
+  // save changes a little while after they happen
+  _manualSaveTimer->start( 10, true /*single-shot*/ );
 }
 
 Preferences* TaskView::preferences() { return _preferences; }
 
 QString TaskView::save()
+// This saves the not-running tasks.
 {
-    // DF: this code created a new event for the running task(s),
-    // at every call (very frequent with autosave) !!!
-    // -> if one wants autosave to save the current event, then
-    // Task needs to store the "current event" and we need to update
-    // it before calling save.
-#if 0
-  // Stop then start all timers so history entries are written.  This is
-  // inefficient if more than one task running, but it is correct.  It is
-  // inefficient because the iCalendar file is saved every time a task's
-  // setRunning(false, ...) is called.  For a big ics file, this could be a
-  // drag.  However, it does ensure that the data will be consistent.  And
-  // if the most common use case is that one task is running most of the time,
-  // it won't make any difference.
-  for (unsigned int i = 0; i < activeTasks.count(); i++)
-  {
-    activeTasks.at(i)->setRunning(false, _storage);
-    activeTasks.at(i)->setRunning(true, _storage);
-  }
-
-  // If there was an active task, the iCal file has already been saved.
-  if (activeTasks.count() == 0)
-#endif
-  {
-    return _storage->save(this);
-  }
+  kdDebug(5970) << "Entering TaskView::save" << endl;
+  QString err = _storage->save(this);
+  emit(setStatusBar(err));
+  return err;
 }
 
 void TaskView::startCurrentTimer()
@@ -419,6 +401,7 @@
 
 void TaskView::stopAllTimers()
 {
+  kdDebug(5970) << "Entering TaskView::stopAllTimers()" << endl;
   for ( unsigned int i = 0; i < activeTasks.count(); i++ )
     activeTasks.at(i)->setRunning(false, _storage);
 
@@ -426,9 +409,27 @@
   activeTasks.clear();
   emit updateButtons();
   emit timersInactive();
-  emit tasksChanged( activeTasks);
+  emit tasksChanged( activeTasks );
 }
 
+void TaskView::stopAllTimersAt(QDateTime qdt)
+// stops all timers for the time qdt. This makes sense, if the idletimedetector detected
+// the last work has been done 50 minutes ago.
+{
+  kdDebug(5970) << "Entering TaskView::stopAllTimersAt" << endl;
+  for ( unsigned int i = 0; i < activeTasks.count(); i++ )
+  {
+    activeTasks.at(i)->setRunning(false, _storage, qdt, qdt);
+    kdDebug() << activeTasks.at(i)->name() << endl;
+  }
+
+  _idleTimeDetector->stopIdleDetection();
+  activeTasks.clear();
+  emit updateButtons();
+  emit timersInactive();
+  emit tasksChanged( activeTasks );
+}
+
 void TaskView::startNewSession()
 {
   QListViewItemIterator item( first_child());
@@ -449,6 +450,7 @@
 
 void TaskView::stopTimerFor(Task* task)
 {
+  kdDebug(5970) << "Entering stopTimerFor. task = " << task->name() << endl;
   if ( task != 0 && activeTasks.findRef(task) != -1 ) {
     activeTasks.removeRef(task);
     task->setRunning(false, _storage);
@@ -690,6 +692,7 @@
 
 void TaskView::extractTime(int minutes)
 {
+  kdDebug(5970) << "Entering extractTime" << endl;
   addTimeToActiveTasks(-minutes);
 }
 
@@ -748,11 +751,16 @@
 }
 
 void TaskView::iCalFileChanged(QString file)
+// User might have picked a new file in the preferences dialog.
+// This is not iCalFileModified.
 {
   kdDebug(5970) << "TaskView:iCalFileChanged: " << file << endl;
-  stopAllTimers();
-  _storage->save(this);
-  load();
+  if (_storage->icalfile() != file)
+  {
+    stopAllTimers();
+    _storage->save(this);
+    load();
+  }
 }
 
 QValueList<HistoryEvent> TaskView::getHistory(const QDate& from,
@@ -794,18 +802,42 @@
         i18n("Copy totals for just this task and its subtasks, or copy totals for all tasks?"),
         i18n("Copy Totals to Clipboard"),
         i18n("Copy This Task"), i18n("Copy All Tasks") );
+    if (response == KMessageBox::Yes) // This task only
+    {
+      KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::TotalTime));
+    }
+    else // All tasks
+    {
+      KApplication::clipboard()->setText(t.totalsAsText(this, false, TimeKard::TotalTime));
+    }
+  }
+  else
+  {
+    KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::TotalTime));
+  }
+}
+
+void TaskView::clipSession()
+{
+  TimeKard t;
+  if (current_item() && current_item()->isRoot())
+  {
+    int response = KMessageBox::questionYesNo( 0,
+        i18n("Copy session time for just this task and its subtasks, or copy session time for all tasks?"),
+        i18n("Copy Session Time to Clipboard"),
+        i18n("Copy This Task"), i18n("Copy All Tasks") );
     if (response == KMessageBox::Yes) // this task only
     {
-      KApplication::clipboard()->setText(t.totalsAsText(this));
+      KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::SessionTime));
     }
     else // only task
     {
-      KApplication::clipboard()->setText(t.totalsAsText(this, false));
+      KApplication::clipboard()->setText(t.totalsAsText(this, false, TimeKard::SessionTime));
     }
   }
   else
   {
-    KApplication::clipboard()->setText(t.totalsAsText(this));
+    KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::SessionTime));
   }
 }
 
Index: karm/preferences.cpp
===================================================================
--- karm/preferences.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/preferences.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -182,7 +182,7 @@
 
 void Preferences::slotOk()
 {
-
+  kdDebug(5970) << "Entering Preferences::slotOk" << endl;
   // storage
   _iCalFileV = _iCalFileW->lineEdit()->text();
 
@@ -209,6 +209,7 @@
 
 void Preferences::slotCancel()
 {
+  kdDebug(5970) << "Entering Preferences::slotCancel" << endl;
   KDialogBase::slotCancel();
 }
 
@@ -224,6 +225,7 @@
 
 void Preferences::emitSignals()
 {
+  kdDebug(5970) << "Entering Preferences::emitSignals" << endl;
   emit iCalFile( _iCalFileV );
   emit detectIdleness( _doIdleDetectionV );
   emit idlenessTimeout( _idleDetectValueV );
Index: karm/karmui.rc
===================================================================
--- karm/karmui.rc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/karmui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-<!DOCTYPE kpartgui ><kpartgui name="karm" version="4" >
+<!DOCTYPE kpartgui ><kpartgui name="karm" version="5" >
 <MenuBar>
   <Menu name="file" >
     <text>&amp;File</text>
@@ -63,6 +63,7 @@
   <Separator />
   <Action name="clip_totals" />
   <Action name="clip_history" />
+  <Action name="clip_session" />
 </Menu>
 
 <State name="readonly">
Index: karm/mainwindow.cpp
===================================================================
--- karm/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -36,7 +36,7 @@
 
 MainWindow::MainWindow( const QString &icsfile )
   : DCOPObject ( "KarmDCOPIface" ),
-    KParts::MainWindow(), 
+    KParts::MainWindow(0,Qt::WStyle_ContextHelp), 
     _accel     ( new KAccel( this ) ),
     _watcher   ( new KAccelMenuWatch( _accel, this ) ),
     _totalSum  ( 0 ),
@@ -63,6 +63,8 @@
            this, SLOT(slotSelectionChanged()));
   connect( _taskView, SIGNAL( updateButtons() ),
            this, SLOT(slotSelectionChanged()));
+  connect( _taskView, SIGNAL( setStatusBar( QString ) ),
+           this, SLOT(setStatusBar( QString )));
 
   loadGeometry();
 
@@ -132,6 +134,11 @@
 //  actionAddComment->setEnabled( on );
 //}
 
+void MainWindow::setStatusBar(QString qs)
+{
+  statusBar()->message(i18n(qs.ascii()));
+}
+
 bool MainWindow::save()
 {
   kdDebug(5970) << "Saving time data to disk." << endl;
@@ -329,6 +336,14 @@
       SLOT( clipTotals() ),
       actionCollection(),
       "clip_totals");
+  // actionClipTotals will never be used again, overwrite it
+  actionClipTotals = new KAction( i18n("&Copy Session Time to Clipboard"),
+      QString::fromLatin1("klipper"),
+      0,
+      _taskView,
+      SLOT( clipSession() ),
+      actionCollection(),
+      "clip_session");
   actionClipHistory = new KAction( i18n("Copy &History to Clipboard"),
       QString::fromLatin1("klipper"),
       CTRL+ALT+Key_C,
Index: karm/karm.kdevelop
===================================================================
--- karm/karm.kdevelop	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ karm/karm.kdevelop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,142 @@
+<?xml version = '1.0'?>
+<kdevelop>
+  <general>
+    <author>root</author>
+    <email>root@duffman</email>
+    <version>$VERSION$</version>
+    <projectmanagement>KDevKDEAutoProject</projectmanagement>
+    <primarylanguage>C++</primarylanguage>
+    <keywords>
+      <keyword>Qt</keyword>
+      <keyword>KDE</keyword>
+    </keywords>
+    <projectdirectory>.</projectdirectory>
+    <absoluteprojectpath>false</absoluteprojectpath>
+    <description/>
+    <ignoreparts/>
+  </general>
+  <kdevfileview>
+    <groups>
+      <group pattern="*.cpp;*.cxx;*.h" name="Sources" />
+      <group pattern="*.ui" name="User Interface" />
+      <group pattern="*.png" name="Icons" />
+      <group pattern="*.po;*.ts" name="Translations" />
+      <group pattern="*" name="Others" />
+      <hidenonprojectfiles>false</hidenonprojectfiles>
+      <hidenonlocation>false</hidenonlocation>
+    </groups>
+    <tree>
+      <hidepatterns>*.o,*.lo,CVS</hidepatterns>
+      <hidenonprojectfiles>false</hidenonprojectfiles>
+    </tree>
+  </kdevfileview>
+  <kdevdoctreeview>
+    <ignoretocs>
+      <toc>ada</toc>
+      <toc>ada_bugs_gcc</toc>
+      <toc>bash</toc>
+      <toc>bash_bugs</toc>
+      <toc>clanlib</toc>
+      <toc>fortran_bugs_gcc</toc>
+      <toc>gnome1</toc>
+      <toc>gnustep</toc>
+      <toc>gtk</toc>
+      <toc>gtk_bugs</toc>
+      <toc>haskell</toc>
+      <toc>haskell_bugs_ghc</toc>
+      <toc>java_bugs_gcc</toc>
+      <toc>java_bugs_sun</toc>
+      <toc>opengl</toc>
+      <toc>pascal_bugs_fp</toc>
+      <toc>php</toc>
+      <toc>php_bugs</toc>
+      <toc>perl</toc>
+      <toc>perl_bugs</toc>
+      <toc>python</toc>
+      <toc>python_bugs</toc>
+      <toc>ruby</toc>
+      <toc>ruby_bugs</toc>
+      <toc>sdl</toc>
+      <toc>stl</toc>
+      <toc>sw</toc>
+      <toc>w3c-dom-level2-html</toc>
+      <toc>w3c-svg</toc>
+      <toc>w3c-uaag10</toc>
+      <toc>wxwidgets_bugs</toc>
+    </ignoretocs>
+    <ignoreqt_xml>
+      <toc>qmake User Guide</toc>
+    </ignoreqt_xml>
+  </kdevdoctreeview>
+  <kdevdebugger>
+    <general>
+      <dbgshell>libtool</dbgshell>
+      <programargs/>
+      <gdbpath/>
+      <configGdbScript/>
+      <runShellScript/>
+      <runGdbScript/>
+      <breakonloadinglibs>true</breakonloadinglibs>
+      <separatetty>false</separatetty>
+      <floatingtoolbar>false</floatingtoolbar>
+    </general>
+    <display>
+      <staticmembers>false</staticmembers>
+      <demanglenames>true</demanglenames>
+      <outputradix>10</outputradix>
+    </display>
+  </kdevdebugger>
+  <kdevfilecreate>
+    <useglobaltypes>
+      <type ext="ui" />
+      <type ext="cpp" />
+      <type ext="h" />
+    </useglobaltypes>
+  </kdevfilecreate>
+  <kdevautoproject>
+    <make>
+      <envvars>
+        <envvar value="1" name="WANT_AUTOCONF_2_5" />
+        <envvar value="1" name="WANT_AUTOMAKE_1_6" />
+      </envvars>
+    </make>
+    <run>
+      <directoryradio>executable</directoryradio>
+      <customdirectory>/</customdirectory>
+      <mainprogram>karm</mainprogram>
+      <programargs/>
+      <terminal>false</terminal>
+      <autocompile>true</autocompile>
+      <envvars/>
+    </run>
+  </kdevautoproject>
+  <cppsupportpart>
+    <filetemplates>
+      <interfacesuffix>.h</interfacesuffix>
+      <implementationsuffix>.cpp</implementationsuffix>
+    </filetemplates>
+  </cppsupportpart>
+  <kdevcppsupport>
+    <codecompletion>
+      <includeGlobalFunctions>true</includeGlobalFunctions>
+      <includeTypes>true</includeTypes>
+      <includeEnums>true</includeEnums>
+      <includeTypedefs>false</includeTypedefs>
+      <automaticCodeCompletion>true</automaticCodeCompletion>
+      <automaticArgumentsHint>true</automaticArgumentsHint>
+      <automaticHeaderCompletion>true</automaticHeaderCompletion>
+      <codeCompletionDelay>250</codeCompletionDelay>
+      <argumentsHintDelay>400</argumentsHintDelay>
+      <headerCompletionDelay>250</headerCompletionDelay>
+    </codecompletion>
+    <creategettersetter>
+      <prefixGet/>
+      <prefixSet>set</prefixSet>
+      <prefixVariable>m_,_</prefixVariable>
+      <parameterName>theValue</parameterName>
+      <inlineGet>true</inlineGet>
+      <inlineSet>true</inlineSet>
+    </creategettersetter>
+    <references/>
+  </kdevcppsupport>
+</kdevelop>
Index: karm/idletimedetector.h
===================================================================
--- karm/idletimedetector.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/idletimedetector.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -3,6 +3,8 @@
 
 #include <qobject.h>
 #include "config.h"     // HAVE_LIBXSS
+#include <qdatetime.h>
+#include <kdebug.h>
 
 class QTimer;
 
@@ -50,11 +52,12 @@
   **/
   void extractTime(int minutes);
 
-  /**
-      Tells the listener to stop timing
-   **/
+  /** Tells the listener to stop timing **/
   void stopAllTimers();
 
+  /** Tells the listener to stop timing for QDateTime **/
+  void stopAllTimersAt(QDateTime qdt);
+
 public slots:
   /**
      Sets the maximum allowed idle.
Index: karm/timekard.cpp
===================================================================
--- karm/timekard.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/timekard.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,8 +45,10 @@
 
 const QString cr = QString::fromLatin1("\n");
 
-QString TimeKard::totalsAsText(TaskView* taskview, bool justThisTask)
+QString TimeKard::totalsAsText(TaskView* taskview, bool justThisTask, WhichTime which)
+// Print the total Times as text. If justThisTask, use activeTask, else, all tasks
 {
+  kdDebug(5970) << "Entering TimeKard::totalsAsText" << endl;
   QString retval;
   QString line;
   QString buf;
@@ -71,18 +73,20 @@
     if (justThisTask)
     {
       // a task's total time includes the sum of all subtask times
-      sum = taskview->current_item()->totalTime();
-      printTask(taskview->current_item(), retval, 0);
+      sum = which == TotalTime ? taskview->current_item()->totalTime() : taskview->current_item()->sessionTime();
+      printTask(taskview->current_item(), retval, 0, which);
     }
     else
     {
       sum = 0;
-      for (Task* task= taskview->current_item(); task;
+      for (Task* task= taskview->item_at_index(0); task;
           task= task->nextSibling())
       {
-        sum += task->totalTime();
-        if ( task->totalTime() )
-          printTask(task, retval, 0);
+        kdDebug(5970) << "Copying task " << task->name() << endl;
+        int time = which == TotalTime ? task->totalTime() : task->totalSessionTime();
+        sum += time;
+        if ( time || task->firstChild() )
+                printTask(task, retval, 0, which);
       }
     }
 
@@ -100,13 +104,13 @@
 }
 
 // Print out "<indent for level> <task total> <task>", for task and subtasks. Used by totalsAsText.
-void TimeKard::printTask(Task *task, QString &s, int level)
+void TimeKard::printTask(Task *task, QString &s, int level, WhichTime which)
 {
   QString buf;
 
   s += buf.fill(' ', level);
   s += QString(QString::fromLatin1("%1    %2"))
-    .arg(formatTime(task->totalTime()), timeWidth)
+    .arg(formatTime(which == TotalTime?task->totalTime():task->totalSessionTime()), timeWidth)
     .arg(task->name());
   s += cr;
 
@@ -114,8 +118,9 @@
       subTask;
       subTask = subTask->nextSibling())
   {
-    if ( subTask->totalTime() ) // to avoid 00:00 entries
-      printTask(subTask, s, level+1);
+    int time = which == TotalTime ? subTask->totalTime() : subTask->totalSessionTime();
+    if (time)
+      printTask(subTask, s, level+1, which);
   }
 }
 
Index: karm/task.cpp
===================================================================
--- karm/task.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/task.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -94,8 +94,10 @@
   delete _timer;
 }
 
-void Task::setRunning( bool on, KarmStorage* storage, QDateTime whenStarted  )
+void Task::setRunning( bool on, KarmStorage* storage, QDateTime whenStarted, QDateTime whenStopped  )
+// Sets a task running or stopped. If the task is to be stopped, whenStarted is not evaluated.
 {
+  kdDebug(5970) << "Entering Task::setRunning" << endl;
   if ( on ) {
     if (isComplete()) return; // don't start if its marked complete
     if (!_timer->isActive()) {
@@ -110,7 +112,7 @@
     if (_timer->isActive()) {
       _timer->stop();
       if ( ! _removing ) {
-        storage->stopTimer(this);
+        storage->stopTimer(this, whenStopped);
         setPixmap(1, UserIcon(QString::fromLatin1("empty-watch.xpm")));
       }
     }
Index: karm/mainwindow.h
===================================================================
--- karm/mainwindow.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -75,15 +75,20 @@
     /** @reimp from KarmDCOPIface::getError */
     QString getError( int karmErrorNumber ) const;
     int totalMinutesForTaskId( const QString& taskId );
+    /** start the timer for taskname */
     QString starttimerfor( const QString &taskname );
+    /** stop the timer for taskname */
     QString stoptimerfor( const QString &taskname );
     QString deletetodo();
+    /** shall there be a "really delete" question */
     bool    getpromptdelete();
+    /** set if there will be a "really delete" question */
     QString setpromptdelete( bool prompt );
     QString exportcsvfile( QString filename, QString from, QString to, int type, bool decimalMinutes, bool allTasks, QString delimiter, QString quote );
     QString importplannerfile( QString filename );
 
   public slots:
+    void setStatusBar( QString );
     void quit();
 
   protected slots:
Index: karm/karmstorage.h
===================================================================
--- karm/karmstorage.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/karmstorage.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -102,6 +102,16 @@
      */
     QString load(TaskView* taskview, const Preferences* preferences, QString fileName="" );
 
+    /*
+     * Return the name of the iCal file
+     */
+    QString icalfile();
+
+    /*
+     * Build up the taskview.
+     *
+     * This is needed if the iCal file has been modified
+     */
     QString buildTaskView(KCal::ResourceCalendar *rc, TaskView *view);
     
     /* Close calendar and clear view.  Release lock if holding one. */
@@ -150,7 +160,7 @@
      */
     QString report( TaskView *taskview, const ReportCriteria &rc );
 
-    /*
+    /**
      * Log the change in a task's time.
      *
      * We create an iCalendar event to store each change.  The event start
@@ -229,7 +239,7 @@
      *
      * @param task   The task the timer was stopped for.
      */
-    void stopTimer(const Task* task);
+    void stopTimer(const Task* task, QDateTime when=QDateTime::currentDateTime());
 
     /**
      * Log a new comment for this task.
Index: karm/test/example.ics
===================================================================
--- karm/test/example.ics	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ karm/test/example.ics	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,173 @@
+BEGIN:VCALENDAR
+PRODID:-//K Desktop Environment//NONSGML libkcal 3.5//EN
+VERSION:2.0
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:0
+X-KDE-karm-totalTaskTime:0
+CREATED:20061118T183926Z
+UID:libkcal-1156600660.458
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:customer BÄR
+CLASS:PUBLIC
+PRIORITY:3
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:0
+X-KDE-karm-totalTaskTime:0
+CREATED:20061118T183934Z
+UID:libkcal-1923273586.967
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:documenting
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:90
+X-KDE-karm-totalTaskTime:90
+CREATED:20061118T184032Z
+UID:libkcal-61950406.193
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:analysis
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:184
+X-KDE-karm-totalTaskTime:184
+CREATED:20061118T184044Z
+UID:libkcal-1755408865.833
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:156
+X-KDE-karm-totalTaskTime:156
+CREATED:20061118T184054Z
+UID:libkcal-1177224330.526
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:phone with mother
+CLASS:PUBLIC
+PRIORITY:3
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:9360
+CREATED:20061118T184102Z
+UID:libkcal-733807033.405
+SEQUENCE:0
+LAST-MODIFIED:20061118T184102Z
+SUMMARY:phone with mother
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1177224330.526
+DTSTART:20061118T184054Z
+DTEND:20061118T211654Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:5400
+CREATED:20061118T184114Z
+UID:libkcal-552065854.752
+SEQUENCE:0
+LAST-MODIFIED:20061118T184114Z
+SUMMARY:analysis
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-61950406.193
+DTSTART:20061118T184032Z
+DTEND:20061118T201032Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:10920
+CREATED:20061118T184125Z
+UID:libkcal-691043213.294
+SEQUENCE:0
+LAST-MODIFIED:20061118T184125Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1755408865.833
+DTSTART:20061118T184044Z
+DTEND:20061118T214244Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:2
+CREATED:20061118T183930Z
+UID:libkcal-251324967.864
+SEQUENCE:0
+LAST-MODIFIED:20061118T183930Z
+SUMMARY:cr
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1156600660.458
+DTSTART:20061118T183928Z
+DTEND:20061118T183930Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:95
+CREATED:20061118T184306Z
+UID:libkcal-729762004.89
+SEQUENCE:0
+LAST-MODIFIED:20061118T184306Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1755408865.833
+DTSTART:20061118T184130Z
+DTEND:20061118T184305Z
+TRANSP:OPAQUE
+END:VEVENT
+
+END:VCALENDAR
+
Index: karm/timekard.h
===================================================================
--- karm/timekard.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/timekard.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -87,6 +87,8 @@
   public:
     TimeKard() {};
 
+    enum WhichTime { TotalTime, SessionTime };
+
     /**
      * Generates ascii text of task totals, for current task on down.
      *
@@ -99,7 +101,7 @@
      * print the task subtree for a root task and when they want to print
      * all tasks.
      */
-    QString totalsAsText(TaskView* taskview, bool justThisTask = true);
+    QString totalsAsText(TaskView* taskview, bool justThisTask, WhichTime which);
 
     /**
      * Generates ascii text of weekly task history, for current task on down.
@@ -110,7 +112,7 @@
         const QDate& to, bool justThisTask, bool perWeek, bool totalsOnly);
 
 private:
-    void printTask(Task *t, QString &s, int level);
+    void printTask(Task *t, QString &s, int level, WhichTime which);
 
     void printTaskHistory(const Task *t, const QMap<QString, long>& datamap,
                           QMap<QString, long>& daytotals,
Index: karm/task.h
===================================================================
--- karm/task.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/task.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -183,7 +183,7 @@
 				    been changed by another program and being reloaded
  				    the task is set to running with another start date
        */
-      void setRunning( bool on, KarmStorage* storage, QDateTime whenStarted= QDateTime::currentDateTime());
+      void setRunning( bool on, KarmStorage* storage, QDateTime whenStarted=QDateTime::currentDateTime(), QDateTime whenStopped=QDateTime::currentDateTime());
 
       /** return the state of a task - if it's running or not
        *  @return         true or false depending on whether the task is running
Index: karm/karmstorage.cpp
===================================================================
--- karm/karmstorage.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/karmstorage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -213,6 +213,12 @@
   return err;
 }
 
+QString KarmStorage::icalfile()
+{
+  kdDebug(5970) << "Entering KarmStorage::icalfile" << endl;
+  return _icalfile;
+}
+
 QString KarmStorage::buildTaskView(KCal::ResourceCalendar *rc, TaskView *view)
 // makes *view contain the tasks out of *rc.
 {
@@ -273,7 +279,7 @@
   // restart tasks that have been running with their start times
   for ( int i=0; i<view->count(); i++)
   {
-    for ( int n=0; n<runningTasks.size(); n++)
+    for ( unsigned int n=0; n<runningTasks.size(); n++)
     {
       if ( runningTasks[n] == view->item_at_index(i)->uid() )
       {
@@ -1043,9 +1049,10 @@
   return err;
 }
 
-void KarmStorage::stopTimer(const Task* task)
+void KarmStorage::stopTimer(const Task* task, QDateTime when)
 {
-  long delta = task->startTime().secsTo(QDateTime::currentDateTime());
+  kdDebug(5970) << "Entering KarmStorage::stopTimer" << endl;
+  long delta = task->startTime().secsTo(when);
   changeTime(task, delta);
 }
 
@@ -1071,6 +1078,7 @@
 
 void KarmStorage::changeTime(const Task* task, const long deltaSeconds)
 {
+  kdDebug(5970) << "Entering KarmStorage::changeTime ( " << task->name() << "," << deltaSeconds <<  " )" << endl;
   KCal::Event* e;
   QDateTime end;
 
@@ -1211,6 +1219,12 @@
 {
   kdDebug(5970) << "KarmStorage::saveCalendar" << endl;
 
+  Event::List evl=_calendar->rawEvents();
+  kdDebug(5970) << "summary - dtStart - dtEnd" << endl;
+  for (unsigned int i=0; i<evl.count(); i++) 
+  {
+    kdDebug() << evl[i]->summary() << evl[i]->dtStart() << evl[i]->dtEnd() << endl;
+  }
   KABC::Lock *lock = _calendar->lock();
   if ( !lock || !lock->lock() )
     return false;
Index: karm/support/karm.desktop
===================================================================
--- karm/support/karm.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ karm/support/karm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,7 +2,6 @@
 Encoding=UTF-8
 Name=KArm
 Name[af]=Karm
-Name[ar]=كارم
 Name[eo]=Tempomezurilo
 Name[hi]=के-आर्म
 Name[mk]=КРака
@@ -12,7 +11,6 @@
 Name[zh_TW]=KArm 個人時程紀錄
 GenericName=Personal Time Tracker
 GenericName[af]=Persoonlike Tyd Volger
-GenericName[ar]=جدول المواعيد
 GenericName[az]=Şəxsi Saat İzləyici
 GenericName[bg]=Отчитане на времето
 GenericName[br]=Roudenner amzer personel
@@ -27,7 +25,7 @@
 GenericName[es]=Cronómetro personal
 GenericName[et]=Personaalne ajaarvestus
 GenericName[eu]=Kronometro pertsonala
-GenericName[fa]=ردیاب زمان شخصی 
+GenericName[fa]=ردیاب شخصی زمان
 GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
 GenericName[fr]=Chronomètre individuel de tâches
 GenericName[gl]=Xestor Persoal de Proxectos
Index: libkpimexchange/core/exchangedownload.cpp
===================================================================
--- libkpimexchange/core/exchangedownload.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkpimexchange/core/exchangedownload.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -91,7 +91,7 @@
     //kdDebug() << "Creating progress dialog" << endl;
     mProgress = new ExchangeProgress();
     mProgress->show();
-  
+
     connect( this, SIGNAL( startDownload() ), mProgress,
              SLOT( slotTransferStarted() ) );
     connect( this, SIGNAL(finishDownload() ), mProgress,
@@ -100,7 +100,7 @@
   }
 
   QString sql = dateSelectQuery( start, end.addDays( 1 ) );
- 
+
   kdDebug() << "Exchange download query: " << endl << sql << endl;
 
   increaseDownloads();
@@ -125,13 +125,13 @@
     //kdDebug() << "Creating progress dialog" << endl;
     mProgress = new ExchangeProgress();
     mProgress->show();
-  
+
     connect( this, SIGNAL(startDownload()), mProgress, SLOT(slotTransferStarted()) );
     connect( this, SIGNAL(finishDownload()), mProgress, SLOT(slotTransferFinished()) );
   }
 
   QString sql = dateSelectQuery( start, end.addDays( 1 ) );
- 
+
   increaseDownloads();
 
   KIO::DavJob *job = KIO::davSearch( mAccount->calendarURL(), "DAV:", "sql", sql, false );
@@ -148,7 +148,7 @@
   startString.sprintf("%04i/%02i/%02i",start.year(),start.month(),start.day());
   QString endString;
   endString.sprintf("%04i/%02i/%02i",end.year(),end.month(),end.day());
-  QString sql = 
+  QString sql =
         "SELECT \"DAV:href\", \"urn:schemas:calendar:instancetype\", \"urn:schemas:calendar:uid\"\r\n"
         "FROM Scope('shallow traversal of \"\"')\r\n"
         "WHERE \"urn:schemas:calendar:dtend\" > '" + startString + "'\r\n"
@@ -166,7 +166,7 @@
   QString endString;
   endString.sprintf( "%04i-%02i-%02iT23:59:59Z", end.year(), end.month(),
                      end.day() );
-  QString sql = 
+  QString sql =
         "SELECT \"DAV:href\", \"urn:schemas:calendar:instancetype\", "
         "\"urn:schemas:calendar:uid\"\r\n"
         "FROM Scope('shallow traversal of \"\"')\r\n"
@@ -193,7 +193,7 @@
   kdDebug() << "Search result: " << endl << response.toString() << endl;
 
   handleAppointments( response, true );
-  
+
   decreaseDownloads();
 }
 
@@ -210,7 +210,7 @@
   kdDebug() << "Search (master) result: " << endl << response.toString() << endl;
 
   handleAppointments( response, false );
-  
+
   decreaseDownloads();
 }
 
@@ -231,7 +231,7 @@
        item = item.nextSibling().toElement() ) {
     //kdDebug() << "Current item:" << item.tagName() << endl;
     QDomNodeList propstats = item.elementsByTagNameNS( "DAV:", "propstat" );
-    // kdDebug() << "Item has " << propstats.count() << " propstat children" << endl; 
+    // kdDebug() << "Item has " << propstats.count() << " propstat children" << endl;
     for( uint i=0; i < propstats.count(); i++ ) {
       QDomElement propstat = propstats.item(i).toElement();
       QDomElement prop = propstat.namedItem( "prop" ).toElement();
@@ -247,7 +247,7 @@
       }
       int instanceType = instancetypeElement.text().toInt();
       //kdDebug() << "Instance type: " << instanceType << endl;
-    
+
       if ( recurrence && instanceType > 0 ) {
         QDomElement uidElement = prop.namedItem( "uid" ).toElement();
         if ( uidElement.isNull() ) {
@@ -286,7 +286,7 @@
 void ExchangeDownload::handleRecurrence( QString uid )
 {
   // kdDebug() << "Handling recurrence info for uid=" << uid << endl;
-  QString query = 
+  QString query =
         "SELECT \"DAV:href\", \"urn:schemas:calendar:instancetype\"\r\n"
         "FROM Scope('shallow traversal of \"\"')\r\n"
         "WHERE \"urn:schemas:calendar:uid\" = '" + uid + "'\r\n"
@@ -333,7 +333,7 @@
   addElement( doc, prop, "urn:schemas:calendar:", "exdate" );
   addElement( doc, prop, "urn:schemas:mailheader:", "sensitivity" );
   addElement( doc, prop, "urn:schemas:calendar:", "reminderoffset" );
-  
+
   addElement( doc, prop, "urn:schemas-microsoft-com:office:office",
               "Keywords" );
 
@@ -357,7 +357,7 @@
 {
   kdDebug() << "slotPropFindResult" << endl;
 
-  int error = job->error(); 
+  int error = job->error();
   if ( error ) {
     job->showErrorDialog( 0 );
     finishUp( ExchangeClient::CommunicationError, job );
@@ -370,7 +370,7 @@
 
   QDomElement prop = response.documentElement().namedItem( "response" )
                      .namedItem( "propstat" ).namedItem( "prop" ).toElement();
- 
+
   KCal::Event* event = new KCal::Event();
 
   QDomElement uidElement = prop.namedItem( "uid" ).toElement();
@@ -485,7 +485,7 @@
   QString rrule = prop.namedItem( "rrule" ).toElement().text();
   kdDebug() << "Got rrule: " << rrule << endl;
   if ( !rrule.isEmpty() ) {
-    // Timezone should be handled automatically 
+    // Timezone should be handled automatically
     // because we used mFormat->setTimeZone() earlier
     KCal::RecurrenceRule *rr = event->recurrence()->defaultRRule( true );
 
@@ -522,7 +522,7 @@
   // 2 Private
   // 3 Company Confidential
   QString sensitivity = prop.namedItem( "sensitivity" ).toElement().text();
-  if ( ! sensitivity.isNull() ) 
+  if ( ! sensitivity.isNull() )
   switch( sensitivity.toInt() ) {
     case 0: event->setSecrecy( KCal::Incidence::SecrecyPublic ); break;
     case 1: event->setSecrecy( KCal::Incidence::SecrecyPrivate ); break;
@@ -540,6 +540,7 @@
     KCal::Duration offset( - reminder.toInt() );
     KCal::Alarm *alarm = event->newAlarm();
     alarm->setStartOffset( offset );
+    alarm->setDisplayAlarm("");
     alarm->setEnabled( true );
     // TODO: multiple alarms; alarm->setType( KCal::Alarm::xxxx );
   }
@@ -555,7 +556,7 @@
 
     /** set the list of attachments/associated files for this event */
     //void setAttachments(const QStringList &attachments);
- 
+
      /** set resources used, such as Office, Car, etc. */
     //void setResources(const QStringList &resources);
 
Index: kmail/kmmsginfo.h
===================================================================
--- kmail/kmmsginfo.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmsginfo.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -46,6 +46,7 @@
 		    KMMsgEncryptionState encryptionState,
 		    KMMsgSignatureState signatureState,
 		    KMMsgMDNSentState mdnSentState,
+                    const QCString& prefCharset,
 		    off_t folderOffset=0, size_t msgSize=0,
             size_t msgSizeServer = 0, ulong UID = 0);
 
@@ -60,7 +61,8 @@
 		    KMMsgEncryptionState encryptionState,
 		    KMMsgSignatureState signatureState,
 		    KMMsgMDNSentState mdnSentState,
-		    size_t msgSize=0,
+		    const QCString& prefCharset,
+                    size_t msgSize=0,
             size_t msgSizeServer = 0, ulong UID = 0);
 
   /** Inherited methods (see KMMsgBase for description): */
Index: kmail/kmfilterdlg.cpp
===================================================================
--- kmail/kmfilterdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfilterdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -226,6 +226,7 @@
       gl->addMultiCellWidget( keyButtonLabel, 7, 7, 2, 2 );
       mKeyButton = new KKeyButton( adv_w, "FilterShortcutSelector" );
       gl->addMultiCellWidget( mKeyButton, 7, 7, 3, 3 );
+      mKeyButton->setEnabled( false );
       mConfigureToolbar = new QCheckBox( i18n("Additionally add this filter to the toolbar"), adv_w );
       gl->addMultiCellWidget( mConfigureToolbar, 8, 8, 0, 3 );
       mConfigureToolbar->setEnabled( false );
@@ -497,6 +498,7 @@
 {
   if ( mFilter ) {
     mFilter->setConfigureShortcut( aChecked );
+    mKeyButton->setEnabled( aChecked );
     mConfigureToolbar->setEnabled( aChecked );
     mFilterActionIconButton->setEnabled( aChecked );
     mFilterActionLabel->setEnabled( aChecked );
Index: kmail/customtemplates_kfg.kcfg
===================================================================
--- kmail/customtemplates_kfg.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/customtemplates_kfg.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<kcfg xmlns="http://www.kde.org/standards/kcfg/1.0"
+      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+      xsi:schemaLocation="http://www.kde.org/standards/kcfg/1.0
+      http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
+  <kcfgfile name="kmailrc">
+    <parameter name="name" />
+  </kcfgfile>
+
+  <group name="CTemplates #$(name)">
+    <entry name="Content" type="String" key="Content">
+      <label>Template content</label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="Shortcut" type="String" key="Shortcut">
+      <label>Template shortcut</label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="Type" type="Int" key="Type">
+      <label>Template type</label>
+      <whatsthis></whatsthis>
+      <default>0</default>
+    </entry>
+  </group>
+
+</kcfg>
Index: kmail/templatesconfiguration_kfg.kcfgc
===================================================================
--- kmail/templatesconfiguration_kfg.kcfgc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesconfiguration_kfg.kcfgc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,5 @@
+File=templatesconfiguration_kfg.kcfg
+ClassName=Templates
+Mutators=true
+ItemAccessors=true
+SetUserTexts=true
Index: kmail/kmail.antispamrc
===================================================================
--- kmail/kmail.antispamrc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail.antispamrc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,5 @@
 [General]
-tools=10
+tools=11
 
 [Spamtool #1]
 Ident=spamassassin
@@ -210,3 +210,23 @@
 ScoreType=Decimal
 ScoreValueRegexp=([\d\.]+)\s*
 ScoreConfidenceRegexp=([\d\.]+)\s*
+
+[Spamtool #11]
+Ident=crm114
+Version=1
+Priority=65
+VisibleName=CRM114
+Executeable=crm -v | grep "CRM114"
+URL=http://crm114.sourceforge.net
+PipeFilterName=CRM114 Check
+PipeCmdDetect=crm -u $HOME/.crm114 mailreaver.crm
+ExecCmdSpam=crm -u $HOME/.crm114 mailreaver.crm --spam
+ExecCmdHam=crm -u $HOME/.crm114 mailreaver.crm --good
+DetectionHeader=X-CRM114-Status
+DetectionPattern=SPAM
+DetectionPattern2=UNSURE
+DetectionOnly=0
+UseRegExp=0
+SupportsBayes=1
+SupportsUnsure=1
+
Index: kmail/kmmainwin.rc
===================================================================
--- kmail/kmmainwin.rc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmainwin.rc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,13 +2,14 @@
      the same menu entries at the same place in KMail and Kontact  -->
 
 <!DOCTYPE kpartgui>
-<kpartgui version="89" name="kmmainwin" >
+<kpartgui version="92" name="kmmainwin" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
    <Menu name="file_new" >
      <text>New</text>
      <Action name="new_message" />
+     <Action name="new_from_template" />
      <Separator/>
      <!-- Action name="new_todo" />
         etc -->
@@ -129,11 +130,7 @@
    <Action name="move_to" />
    <Separator/> 
    <Action name="set_status" />
-   <Menu name="menubar_message_mark_thread_as">
-     <text>Mark Thread as</text>
-     <Action name="thread_watched" />
-     <Action name="thread_ignored" />
-   </Menu>
+   <Action name="thread_status" />
    <Separator/>
    <Action name="create_filter"/>
    <Menu name="apply_filter_actions" >
Index: kmail/expirejob.cpp
===================================================================
--- kmail/expirejob.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/expirejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -125,7 +125,7 @@
     const KMMsgBase *mb = storage->getMsgBase( mCurrentIndex );
     if (mb == 0)
       continue;
-    if ( mb->isImportant()
+    if ( ( mb->isImportant() || mb->isTodo() )
       && GlobalSettings::self()->excludeImportantMailFromExpiry() )
        continue;
 
Index: kmail/templateparser.cpp
===================================================================
--- kmail/templateparser.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templateparser.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,1100 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov <dmiceman@mail.ru>
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#include <qstring.h>
+#include <qdatetime.h>
+#include <klocale.h>
+#include <kcalendarsystem.h>
+#include <kmime_util.h>
+#include <kglobal.h>
+#include <kprocess.h>
+#include <qregexp.h>
+#include <qfile.h>
+#include <kmessagebox.h>
+#include <kshell.h>
+#include <qfileinfo.h>
+
+#include "kmmessage.h"
+#include "kmmsgbase.h"
+#include "kmfolder.h"
+#include "templatesconfiguration.h"
+#include "templatesconfiguration_kfg.h"
+#include "customtemplates_kfg.h"
+#include "globalsettings_base.h"
+#include "kmkernel.h"
+#include <libkpimidentities/identity.h>
+#include <libkpimidentities/identitymanager.h>
+
+#include "templateparser.h"
+
+TemplateParser::TemplateParser( KMMessage *amsg, const Mode amode,
+                                const QString aselection,
+                                bool asmartQuote, bool anoQuote,
+                                bool aallowDecryption, bool aselectionIsBody ) :
+  mMode( amode ), mFolder( 0 ), mIdentity( 0 ), mSelection( aselection ),
+  mSmartQuote( asmartQuote ), mNoQuote( anoQuote ),
+  mAllowDecryption( aallowDecryption ), mSelectionIsBody( aselectionIsBody ),
+  mDebug( false ), mQuoteString( "> " ), mAppend( false )
+{
+  mMsg = amsg;
+}
+
+int TemplateParser::parseQuotes( const QString &prefix, const QString &str,
+                                 QString &quote ) const
+{
+  int pos = prefix.length();
+  int len;
+  int str_len = str.length();
+  QChar qc = '"';
+  QChar prev = 0;
+
+  pos++;
+  len = pos;
+
+  while ( pos < str_len ) {
+    QChar c = str[pos];
+
+    pos++;
+    len++;
+
+    if ( prev ) {
+      quote.append( c );
+      prev = 0;
+    } else {
+      if ( c == '\\' ) {
+        prev = c;
+      } else if ( c == qc ) {
+        break;
+      } else {
+        quote.append( c );
+      }
+    }
+  }
+
+  return len;
+}
+
+QString TemplateParser::getFName( const QString &str )
+{
+  // simple logic:
+  // if there is ',' in name, than format is 'Last, First'
+  // else format is 'First Last'
+  // last resort -- return 'name' from 'name@domain'
+  int sep_pos;
+  QString res;
+  if ( ( sep_pos = str.find( '@' ) ) > 0 ) {
+    int i;
+    for ( i = (sep_pos - 1); i >= 0; --i ) {
+      QChar c = str[i];
+      if ( c.isLetterOrNumber() ) {
+        res.prepend( c );
+      } else {
+        break;
+      }
+    }
+  } else if ( ( sep_pos = str.find(',') ) > 0 ) {
+    unsigned int i;
+    bool begin = false;
+    for ( i = sep_pos; i < str.length(); ++i ) {
+      QChar c = str[i];
+      if ( c.isLetterOrNumber() ) {
+        begin = true;
+        res.append( c );
+      } else if ( begin ) {
+        break;
+      }
+    }
+  } else {
+    unsigned int i;
+    for ( i = 0; i < str.length(); ++i ) {
+      QChar c = str[i];
+      if ( c.isLetterOrNumber() ) {
+        res.append( c );
+      } else {
+        break;
+      }
+    }
+  }
+  return res;
+}
+
+QString TemplateParser::getLName( const QString &str )
+{
+  // simple logic:
+  // if there is ',' in name, than format is 'Last, First'
+  // else format is 'First Last'
+  int sep_pos;
+  QString res;
+  if ( ( sep_pos = str.find(',') ) > 0 ) {
+    int i;
+    for ( i = sep_pos; i >= 0; --i ) {
+      QChar c = str[i];
+      if ( c.isLetterOrNumber() ) {
+        res.prepend( c );
+      } else {
+        break;
+      }
+    }
+  } else {
+    if ( ( sep_pos = str.find( ' ' ) ) > 0 ) {
+      unsigned int i;
+      bool begin = false;
+      for ( i = sep_pos; i < str.length(); ++i ) {
+        QChar c = str[i];
+        if ( c.isLetterOrNumber() ) {
+          begin = true;
+          res.append( c );
+        } else if ( begin ) {
+          break;
+        }
+      }
+    }
+  }
+  return res;
+}
+
+void TemplateParser::process( KMMessage *aorig_msg, KMFolder *afolder, bool append )
+{
+  mAppend = append;
+  mOrigMsg = aorig_msg;
+  mFolder = afolder;
+  QString tmpl = findTemplate();
+  return processWithTemplate( tmpl );
+}
+
+void TemplateParser::process( const QString &tmplName, KMMessage *aorig_msg,
+                              KMFolder *afolder, bool append )
+{
+  mAppend = append;
+  mOrigMsg = aorig_msg;
+  mFolder = afolder;
+  QString tmpl = findCustomTemplate( tmplName );
+  return processWithTemplate( tmpl );
+}
+
+void TemplateParser::processWithTemplate( const QString &tmpl )
+{
+  QString body;
+  int tmpl_len = tmpl.length();
+  bool dnl = false;
+  for ( int i = 0; i < tmpl_len; ++i ) {
+    QChar c = tmpl[i];
+    // kdDebug() << "Next char: " << c << endl;
+    if ( c == '%' ) {
+      QString cmd = tmpl.mid( i + 1 );
+
+      if ( cmd.startsWith( "-" ) ) {
+        // dnl
+        kdDebug() << "Command: -" << endl;
+        dnl = true;
+        i += 1;
+
+      } else if ( cmd.startsWith( "REM=" ) ) {
+        // comments
+        kdDebug() << "Command: REM=" << endl;
+        QString q;
+        int len = parseQuotes( "REM=", cmd, q );
+        i += len;
+
+      } else if ( cmd.startsWith( "INSERT=" ) ) {
+        // insert content of specified file as is
+        kdDebug() << "Command: INSERT=" << endl;
+        QString q;
+        int len = parseQuotes( "INSERT=", cmd, q );
+        i += len;
+        QString path = KShell::tildeExpand( q );
+        QFileInfo finfo( path );
+        if (finfo.isRelative() ) {
+          path = KShell::homeDir( "" );
+          path += '/';
+          path += q;
+        }
+        QFile file( path );
+        if ( file.open( IO_ReadOnly ) ) {
+          QByteArray content = file.readAll();
+          QString str = QString::fromLocal8Bit( content, content.size() );
+          body.append( str );
+        } else if ( mDebug ) {
+          KMessageBox::error( 0,
+                              i18n( "Cannot insert content from file %1: %2" ).
+                              arg( path ).arg( file.errorString() ) );
+        }
+
+      } else if ( cmd.startsWith( "SYSTEM=" ) ) {
+        // insert content of specified file as is
+        kdDebug() << "Command: SYSTEM=" << endl;
+        QString q;
+        int len = parseQuotes( "SYSTEM=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        QString str = pipe( pipe_cmd, "" );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "PUT=" ) ) {
+        // insert content of specified file as is
+        kdDebug() << "Command: PUT=" << endl;
+        QString q;
+        int len = parseQuotes( "PUT=", cmd, q );
+        i += len;
+        QString path = KShell::tildeExpand( q );
+        QFileInfo finfo( path );
+        if (finfo.isRelative() ) {
+          path = KShell::homeDir( "" );
+          path += '/';
+          path += q;
+        }
+        QFile file( path );
+        if ( file.open( IO_ReadOnly ) ) {
+          QByteArray content = file.readAll();
+          body.append( QString::fromLocal8Bit( content, content.size() ) );
+        } else if ( mDebug ) {
+          KMessageBox::error( 0,
+                              i18n( "Cannot insert content from file %1: %2").
+                              arg( path ).arg(file.errorString() ));
+        }
+
+      } else if ( cmd.startsWith( "QUOTEPIPE=" ) ) {
+        // pipe message body throw command and insert it as quotation
+        kdDebug() << "Command: QUOTEPIPE=" << endl;
+        QString q;
+        int len = parseQuotes( "QUOTEPIPE=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        if ( mOrigMsg && !mNoQuote ) {
+          QString str = pipe( pipe_cmd, mSelection );
+          QString quote = mOrigMsg->asQuotedString( "", mQuoteString, str,
+                                                    mSmartQuote, mAllowDecryption );
+          body.append( quote );
+        }
+
+      } else if ( cmd.startsWith( "QUOTE" ) ) {
+        kdDebug() << "Command: QUOTE" << endl;
+        i += strlen( "QUOTE" );
+        if ( mOrigMsg && !mNoQuote ) {
+          QString quote = mOrigMsg->asQuotedString( "", mQuoteString, mSelection,
+                                                    mSmartQuote, mAllowDecryption );
+          body.append( quote );
+        }
+
+      } else if ( cmd.startsWith( "QHEADERS" ) ) {
+        kdDebug() << "Command: QHEADERS" << endl;
+        i += strlen( "QHEADERS" );
+        if ( mOrigMsg && !mNoQuote ) {
+          QString quote = mOrigMsg->asQuotedString( "", mQuoteString,
+                                                    mOrigMsg->headerAsSendableString(),
+                                                    mSmartQuote, false );
+          body.append( quote );
+        }
+
+      } else if ( cmd.startsWith( "HEADERS" ) ) {
+        kdDebug() << "Command: HEADERS" << endl;
+        i += strlen( "HEADERS" );
+        if ( mOrigMsg && !mNoQuote ) {
+          QString str = mOrigMsg->headerAsSendableString();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "TEXTPIPE=" ) ) {
+        // pipe message body throw command and insert it as is
+        kdDebug() << "Command: TEXTPIPE=" << endl;
+        QString q;
+        int len = parseQuotes( "TEXTPIPE=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        if ( mOrigMsg ) {
+          QString str = pipe(pipe_cmd, mSelection );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "MSGPIPE=" ) ) {
+        // pipe full message throw command and insert result as is
+        kdDebug() << "Command: MSGPIPE=" << endl;
+        QString q;
+        int len = parseQuotes( "MSGPIPE=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        if ( mOrigMsg ) {
+          QString str = pipe(pipe_cmd, mOrigMsg->asString() );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "BODYPIPE=" ) ) {
+        // pipe message body generated so far throw command and insert result as is
+        kdDebug() << "Command: BODYPIPE=" << endl;
+        QString q;
+        int len = parseQuotes( "BODYPIPE=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        QString str = pipe( pipe_cmd, body );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "CLEARPIPE=" ) ) {
+        // pipe message body generated so far throw command and
+        // insert result as is replacing current body
+        kdDebug() << "Command: CLEARPIPE=" << endl;
+        QString q;
+        int len = parseQuotes( "CLEARPIPE=", cmd, q );
+        i += len;
+        QString pipe_cmd = q;
+        QString str = pipe( pipe_cmd, body );
+        body = str;
+        mMsg->setCursorPos( 0 );
+
+      } else if ( cmd.startsWith( "TEXT" ) ) {
+        kdDebug() << "Command: TEXT" << endl;
+        i += strlen( "TEXT" );
+        if ( mOrigMsg ) {
+          QString quote = mOrigMsg->asPlainText( false, mAllowDecryption );
+          kdDebug() << "TEXT: " << quote << endl;
+          body.append( quote );
+        }
+
+      } else if ( cmd.startsWith( "OTEXTSIZE" ) ) {
+        kdDebug() << "Command: OTEXTSIZE" << endl;
+        i += strlen( "OTEXTSIZE" );
+        if ( mOrigMsg ) {
+          QString str = QString( "%1" ).arg( mOrigMsg->body().length() );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTEXT" ) ) {
+        kdDebug() << "Command: OTEXT" << endl;
+        i += strlen( "OTEXT" );
+        if ( mOrigMsg ) {
+          QString quote = mOrigMsg->asPlainText( false, mAllowDecryption );
+          body.append( quote );
+        }
+
+      } else if ( cmd.startsWith( "CCADDR" ) ) {
+        kdDebug() << "Command: CCADDR" << endl;
+        i += strlen( "CCADDR" );
+        QString str = mMsg->cc();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "CCNAME" ) ) {
+        kdDebug() << "Command: CCNAME" << endl;
+        i += strlen( "CCNAME" );
+        QString str = mMsg->ccStrip();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "CCFNAME" ) ) {
+        kdDebug() << "Command: CCFNAME" << endl;
+        i += strlen( "CCFNAME" );
+        QString str = mMsg->ccStrip();
+        body.append( getFName( str ) );
+
+      } else if ( cmd.startsWith( "CCLNAME" ) ) {
+        kdDebug() << "Command: CCLNAME" << endl;
+        i += strlen( "CCLNAME" );
+        QString str = mMsg->ccStrip();
+        body.append( getLName( str ) );
+
+      } else if ( cmd.startsWith( "TOADDR" ) ) {
+        kdDebug() << "Command: TOADDR" << endl;
+        i += strlen( "TOADDR" );
+        QString str = mMsg->to();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "TONAME" ) ) {
+        kdDebug() << "Command: TONAME" << endl;
+        i += strlen( "TONAME" );
+        QString str = mMsg->toStrip();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "TOFNAME" ) ) {
+        kdDebug() << "Command: TOFNAME" << endl;
+        i += strlen( "TOFNAME" );
+        QString str = mMsg->toStrip();
+        body.append( getFName( str ) );
+
+      } else if ( cmd.startsWith( "TOLNAME" ) ) {
+        kdDebug() << "Command: TOLNAME" << endl;
+        i += strlen( "TOLNAME" );
+        QString str = mMsg->toStrip();
+        body.append( getLName( str ) );
+
+      } else if ( cmd.startsWith( "TOLIST" ) ) {
+        kdDebug() << "Command: TOLIST" << endl;
+        i += strlen( "TOLIST" );
+        QString str = mMsg->to();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "FROMADDR" ) ) {
+        kdDebug() << "Command: FROMADDR" << endl;
+        i += strlen( "FROMADDR" );
+        QString str = mMsg->from();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "FROMNAME" ) ) {
+        kdDebug() << "Command: FROMNAME" << endl;
+        i += strlen( "FROMNAME" );
+        QString str = mMsg->fromStrip();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "FROMFNAME" ) ) {
+        kdDebug() << "Command: FROMFNAME" << endl;
+        i += strlen( "FROMFNAME" );
+        QString str = mMsg->fromStrip();
+        body.append( getFName( str ) );
+
+      } else if ( cmd.startsWith( "FROMLNAME" ) ) {
+        kdDebug() << "Command: FROMLNAME" << endl;
+        i += strlen( "FROMLNAME" );
+        QString str = mMsg->fromStrip();
+        body.append( getLName( str ) );
+
+      } else if ( cmd.startsWith( "FULLSUBJECT" ) ) {
+        kdDebug() << "Command: FULLSUBJECT" << endl;
+        i += strlen( "FULLSUBJECT" );
+        QString str = mMsg->subject();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "FULLSUBJ" ) ) {
+        kdDebug() << "Command: FULLSUBJ" << endl;
+        i += strlen( "FULLSUBJ" );
+        QString str = mMsg->subject();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "MSGID" ) ) {
+        kdDebug() << "Command: MSGID" << endl;
+        i += strlen( "MSGID" );
+        QString str = mMsg->id();
+        body.append( str );
+
+      } else if ( cmd.startsWith( "OHEADER=" ) ) {
+        // insert specified content of header from original message
+        kdDebug() << "Command: OHEADER=" << endl;
+        QString q;
+        int len = parseQuotes( "OHEADER=", cmd, q );
+        i += len;
+        if ( mOrigMsg ) {
+          QString hdr = q;
+          QString str = mOrigMsg->headerFields(hdr.local8Bit() ).join( ", " );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "HEADER=" ) ) {
+        // insert specified content of header from current message
+        kdDebug() << "Command: HEADER=" << endl;
+        QString q;
+        int len = parseQuotes( "HEADER=", cmd, q );
+        i += len;
+        QString hdr = q;
+        QString str = mMsg->headerFields(hdr.local8Bit() ).join( ", " );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "HEADER( " ) ) {
+        // insert specified content of header from current message
+        kdDebug() << "Command: HEADER( " << endl;
+        QRegExp re = QRegExp( "^HEADER\\((.+)\\)" );
+        re.setMinimal( true );
+        int res = re.search( cmd );
+        if ( res != 0 ) {
+          // something wrong
+          i += strlen( "HEADER( " );
+        } else {
+          i += re.matchedLength();
+          QString hdr = re.cap( 1 );
+          QString str = mMsg->headerFields( hdr.local8Bit() ).join( ", " );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OCCADDR" ) ) {
+        kdDebug() << "Command: OCCADDR" << endl;
+        i += strlen( "OCCADDR" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->cc();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OCCNAME" ) ) {
+        kdDebug() << "Command: OCCNAME" << endl;
+        i += strlen( "OCCNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->ccStrip();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OCCFNAME" ) ) {
+        kdDebug() << "Command: OCCFNAME" << endl;
+        i += strlen( "OCCFNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->ccStrip();
+          body.append( getFName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OCCLNAME" ) ) {
+        kdDebug() << "Command: OCCLNAME" << endl;
+        i += strlen( "OCCLNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->ccStrip();
+          body.append( getLName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OTOADDR" ) ) {
+        kdDebug() << "Command: OTOADDR" << endl;
+        i += strlen( "OTOADDR" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->to();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTONAME" ) ) {
+        kdDebug() << "Command: OTONAME" << endl;
+        i += strlen( "OTONAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->toStrip();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTOFNAME" ) ) {
+        kdDebug() << "Command: OTOFNAME" << endl;
+        i += strlen( "OTOFNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->toStrip();
+          body.append( getFName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OTOLNAME" ) ) {
+        kdDebug() << "Command: OTOLNAME" << endl;
+        i += strlen( "OTOLNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->toStrip();
+          body.append( getLName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OTOLIST" ) ) {
+        kdDebug() << "Command: OTOLIST" << endl;
+        i += strlen( "OTOLIST" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->to();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTO" ) ) {
+        kdDebug() << "Command: OTO" << endl;
+        i += strlen( "OTO" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->to();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OFROMADDR" ) ) {
+        kdDebug() << "Command: OFROMADDR" << endl;
+        i += strlen( "OFROMADDR" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->from();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OFROMNAME" ) ) {
+        kdDebug() << "Command: OFROMNAME" << endl;
+        i += strlen( "OFROMNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->fromStrip();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OFROMFNAME" ) ) {
+        kdDebug() << "Command: OFROMFNAME" << endl;
+        i += strlen( "OFROMFNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->fromStrip();
+          body.append( getFName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OFROMLNAME" ) ) {
+        kdDebug() << "Command: OFROMLNAME" << endl;
+        i += strlen( "OFROMLNAME" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->fromStrip();
+          body.append( getLName( str ) );
+        }
+
+      } else if ( cmd.startsWith( "OFULLSUBJECT" ) ) {
+        kdDebug() << "Command: OFULLSUBJECT" << endl;
+        i += strlen( "OFULLSUBJECT" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->subject();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OFULLSUBJ" ) ) {
+        kdDebug() << "Command: OFULLSUBJ" << endl;
+        i += strlen( "OFULLSUBJ" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->subject();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OMSGID" ) ) {
+        kdDebug() << "Command: OMSGID" << endl;
+        i += strlen( "OMSGID" );
+        if ( mOrigMsg ) {
+          QString str = mOrigMsg->id();
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "DATEEN" ) ) {
+        kdDebug() << "Command: DATEEN" << endl;
+        i += strlen( "DATEEN" );
+        QDateTime date = QDateTime::currentDateTime();
+        KLocale locale( "C" );
+        QString str = QString( "%1, %2 %3, %4" )
+          .arg(locale.calendar()->weekDayName(date.date(), false) )
+          .arg(locale.calendar()->monthName(date.date(), false) )
+          .arg(date.date().day() )
+          .arg(date.date().year() );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "DATESHORT" ) ) {
+        kdDebug() << "Command: DATESHORT" << endl;
+        i += strlen( "DATESHORT" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = date.date().toString(Qt::LocalDate);
+        body.append( str );
+
+      } else if ( cmd.startsWith( "DATE" ) ) {
+        kdDebug() << "Command: DATE" << endl;
+        i += strlen( "DATE" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = date.date().toString(Qt::TextDate);
+        body.append( str );
+
+      } else if ( cmd.startsWith( "DOW" ) ) {
+        kdDebug() << "Command: DOW" << endl;
+        i += strlen( "DOW" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = QDate::longDayName(date.date().dayOfWeek() );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "TIMELONGEN" ) ) {
+        kdDebug() << "Command: TIMELONGEN" << endl;
+        i += strlen( "TIMELONGEN" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = date.time().toString( "hh:mm:ss AP" );
+        body.append( str );
+
+      } else if ( cmd.startsWith( "TIMELONG" ) ) {
+        kdDebug() << "Command: TIMELONG" << endl;
+        i += strlen( "TIMELONG" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = date.time().toString(Qt::TextDate);
+        body.append( str );
+
+      } else if ( cmd.startsWith( "TIME" ) ) {
+        kdDebug() << "Command: TIME" << endl;
+        i += strlen( "TIME" );
+        QDateTime date = QDateTime::currentDateTime();
+        QString str = date.time().toString(Qt::LocalDate);
+        body.append( str );
+
+      } else if ( cmd.startsWith( "ODATEEN" ) ) {
+        kdDebug() << "Command: ODATEEN" << endl;
+        i += strlen( "ODATEEN" );
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          KLocale locale( "C");
+          QString str = QString( "%1, %2 %3, %4")
+            .arg(locale.calendar()->weekDayName(date.date(), false) )
+            .arg(locale.calendar()->monthName(date.date(), false) )
+            .arg(date.date().day() )
+            .arg(date.date().year() );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "ODATESHORT") ) {
+        kdDebug() << "Command: ODATESHORT" << endl;
+        i += strlen( "ODATESHORT");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = date.date().toString(Qt::LocalDate);
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "ODATE") ) {
+        kdDebug() << "Command: ODATE" << endl;
+        i += strlen( "ODATE");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = date.date().toString(Qt::TextDate);
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "ODOW") ) {
+        kdDebug() << "Command: ODOW" << endl;
+        i += strlen( "ODOW");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = QDate::longDayName(date.date().dayOfWeek() );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTIMELONGEN") ) {
+        kdDebug() << "Command: OTIMELONGEN" << endl;
+        i += strlen( "OTIMELONGEN");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = date.time().toString( "hh:mm:ss AP");
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTIMELONG") ) {
+        kdDebug() << "Command: OTIMELONG" << endl;
+        i += strlen( "OTIMELONG");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = date.time().toString(Qt::TextDate);
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "OTIME") ) {
+        kdDebug() << "Command: OTIME" << endl;
+        i += strlen( "OTIME");
+        if ( mOrigMsg ) {
+          QDateTime date;
+          date.setTime_t( mOrigMsg->date() );
+          QString str = date.time().toString( Qt::LocalDate );
+          body.append( str );
+        }
+
+      } else if ( cmd.startsWith( "BLANK" ) ) {
+        // do nothing
+        kdDebug() << "Command: BLANK" << endl;
+        i += strlen( "BLANK" );
+
+      } else if ( cmd.startsWith( "NOP" ) ) {
+        // do nothing
+        kdDebug() << "Command: NOP" << endl;
+        i += strlen( "NOP" );
+
+      } else if ( cmd.startsWith( "CLEAR" ) ) {
+        // clear body buffer; not too useful yet
+        kdDebug() << "Command: CLEAR" << endl;
+        i += strlen( "CLEAR" );
+        body = "";
+        mMsg->setCursorPos( 0 );
+
+      } else if ( cmd.startsWith( "DEBUGOFF" ) ) {
+        // turn off debug
+        kdDebug() << "Command: DEBUGOFF" << endl;
+        i += strlen( "DEBUGOFF" );
+        mDebug = false;
+
+      } else if ( cmd.startsWith( "DEBUG" ) ) {
+        // turn on debug
+        kdDebug() << "Command: DEBUG" << endl;
+        i += strlen( "DEBUG" );
+        mDebug = true;
+
+      } else if ( cmd.startsWith( "CURSOR" ) ) {
+        // turn on debug
+        kdDebug() << "Command: CURSOR" << endl;
+        i += strlen( "CURSOR" );
+        mMsg->setCursorPos( body.length() );
+
+      } else {
+        // wrong command, do nothing
+        body.append( c );
+      }
+
+    } else if ( dnl && ( c == '\n' || c == '\r') ) {
+      // skip
+      if ( ( c == '\n' && tmpl[i + 1] == '\r' ) ||
+           ( c == '\r' && tmpl[i + 1] == '\n' ) ) {
+        // skip one more
+        i += 1;
+      }
+      dnl = false;
+    } else {
+      body.append( c );
+    }
+  }
+
+  // kdDebug() << "Message body: " << body << endl;
+
+  if ( mAppend ) {
+    QCString msg_body = mMsg->body();
+    msg_body.append( body.utf8() );
+    mMsg->setBody( msg_body );
+  } else {
+    mMsg->setBodyFromUnicode( body );
+  }
+}
+
+QString TemplateParser::findCustomTemplate( const QString &tmplName )
+{
+  CTemplates t( tmplName );
+  QString content = t.content();
+  if ( !content.isEmpty() ) {
+    return content;
+  } else {
+    return findTemplate();
+  }
+}
+
+QString TemplateParser::findTemplate()
+{
+  // import 'Phrases' if it not done yet
+  if ( !GlobalSettings::self()->phrasesConverted() ) {
+    TemplatesConfiguration::importFromPhrases();
+  }
+
+  // kdDebug() << "Trying to find template for mode " << mode << endl;
+
+  QString tmpl;
+
+  if ( !mFolder ) { // find folder message belongs to
+    mFolder = mMsg->parent();
+    if ( !mFolder ) {
+      if ( mOrigMsg ) {
+        mFolder = mOrigMsg->parent();
+      }
+      if ( !mFolder ) {
+        kdDebug(5006) << "Oops! No folder for message" << endl;
+      }
+    }
+  }
+  kdDebug(5006) << "Folder found: " << mFolder << endl;
+
+  if ( mFolder )  // only if a folder was found
+  {
+    QString fid = mFolder->idString();
+    Templates fconf( fid );
+    if ( fconf.useCustomTemplates() ) {   // does folder use custom templates?
+      switch( mMode ) {
+      case NewMessage:
+        tmpl = fconf.templateNewMessage();
+        break;
+      case Reply:
+        tmpl = fconf.templateReply();
+        break;
+      case ReplyAll:
+        tmpl = fconf.templateReplyAll();
+        break;
+      case Forward:
+        tmpl = fconf.templateForward();
+        break;
+      default:
+        kdDebug(5006) << "Unknown message mode: " << mMode << endl;
+        return "";
+      }
+      mQuoteString = fconf.quoteString();
+      if ( !tmpl.isEmpty() ) {
+        return tmpl;  // use folder-specific template
+      }
+    }
+  }
+
+  if ( !mIdentity ) { // find identity message belongs to
+    mIdentity = mMsg->identityUoid();
+    if ( !mIdentity && mOrigMsg ) {
+      mIdentity = mOrigMsg->identityUoid();
+    }
+    mIdentity = kmkernel->identityManager()->identityForUoidOrDefault( mIdentity ).uoid();
+    if ( !mIdentity ) {
+      kdDebug(5006) << "Oops! No identity for message" << endl;
+    }
+  }
+  kdDebug(5006) << "Identity found: " << mIdentity << endl;
+
+  QString iid;
+  if ( mIdentity ) {
+    iid = QString("IDENTITY_%1").arg( mIdentity );	// templates ID for that identity
+  }
+  else {
+    iid = "IDENTITY_NO_IDENTITY"; // templates ID for no identity
+  }
+
+  Templates iconf( iid );
+  if ( iconf.useCustomTemplates() ) { // does identity use custom templates?
+    switch( mMode ) {
+    case NewMessage:
+      tmpl = iconf.templateNewMessage();
+      break;
+    case Reply:
+      tmpl = iconf.templateReply();
+      break;
+    case ReplyAll:
+      tmpl = iconf.templateReplyAll();
+      break;
+    case Forward:
+      tmpl = iconf.templateForward();
+      break;
+    default:
+      kdDebug(5006) << "Unknown message mode: " << mMode << endl;
+      return "";
+    }
+    mQuoteString = iconf.quoteString();
+    if ( !tmpl.isEmpty() ) {
+      return tmpl;  // use identity-specific template
+    }
+  }
+
+  switch( mMode ) { // use the global template
+  case NewMessage:
+    tmpl = GlobalSettings::self()->templateNewMessage();
+    break;
+  case Reply:
+    tmpl = GlobalSettings::self()->templateReply();
+    break;
+  case ReplyAll:
+    tmpl = GlobalSettings::self()->templateReplyAll();
+    break;
+  case Forward:
+    tmpl = GlobalSettings::self()->templateForward();
+    break;
+  default:
+    kdDebug(5006) << "Unknown message mode: " << mMode << endl;
+    return "";
+  }
+
+  mQuoteString = GlobalSettings::self()->quoteString();
+  return tmpl;
+}
+
+QString TemplateParser::pipe( const QString &cmd, const QString &buf )
+{
+  mPipeOut = "";
+  mPipeErr = "";
+  mPipeRc = 0;
+
+  KProcess proc;
+  QCString data = buf.local8Bit();
+
+  // kdDebug() << "Command data: " << data << endl;
+
+  proc << KShell::splitArgs( cmd, KShell::TildeExpand );
+  proc.setUseShell( true );
+  connect( &proc, SIGNAL( receivedStdout( KProcess *, char *, int ) ),
+           this, SLOT( onReceivedStdout( KProcess *, char *, int ) ) );
+  connect( &proc, SIGNAL( receivedStderr( KProcess *, char *, int ) ),
+           this, SLOT( onReceivedStderr( KProcess *, char *, int ) ) );
+  connect( &proc, SIGNAL( wroteStdin( KProcess * ) ),
+           this, SLOT( onWroteStdin( KProcess * ) ) );
+
+  if ( proc.start( KProcess::NotifyOnExit, KProcess::All ) ) {
+
+    bool pipe_filled = proc.writeStdin( data, data.length() );
+    if ( pipe_filled ) {
+      proc.closeStdin();
+
+      bool exited = proc.wait( PipeTimeout );
+      if ( exited ) {
+
+        if ( proc.normalExit() ) {
+
+          mPipeRc = proc.exitStatus();
+          if ( mPipeRc != 0 && mDebug ) {
+            if ( mPipeErr.isEmpty() ) {
+              KMessageBox::error( 0,
+                                  i18n( "Pipe command exit with status %1: %2").
+                                  arg( mPipeRc ).arg( cmd ) );
+            } else {
+              KMessageBox::detailedError( 0,
+                                          i18n( "Pipe command exit with status %1: %2" ).
+                                          arg( mPipeRc ).arg( cmd ), mPipeErr );
+            }
+          }
+
+        } else {
+
+          mPipeRc = -( proc.exitSignal() );
+          if ( mPipeRc != 0 && mDebug ) {
+            if ( mPipeErr.isEmpty() ) {
+              KMessageBox::error( 0,
+                                  i18n( "Pipe command killed by signal %1: %2" ).
+                                  arg( -(mPipeRc) ).arg( cmd ) );
+            } else {
+              KMessageBox::detailedError( 0,
+                                          i18n( "Pipe command killed by signal %1: %2" ).
+                                          arg( -(mPipeRc) ).arg( cmd ), mPipeErr );
+            }
+          }
+        }
+
+      } else {
+        // process does not exited after TemplateParser::PipeTimeout seconds, kill it
+        proc.kill();
+        proc.detach();
+        if ( mDebug ) {
+          KMessageBox::error( 0,
+                              i18n( "Pipe command did not finish within %1 seconds: %2" ).
+                              arg( PipeTimeout ).arg( cmd ) );
+        }
+      }
+
+    } else {
+      // can`t write to stdin of process
+      proc.kill();
+      proc.detach();
+      if ( mDebug ) {
+        if ( mPipeErr.isEmpty() ) {
+          KMessageBox::error( 0,
+                              i18n( "Cannot write to process stdin: %1" ).arg( cmd ) );
+        } else {
+          KMessageBox::detailedError( 0,
+                                      i18n( "Cannot write to process stdin: %1" ).
+                                      arg( cmd ), mPipeErr );
+        }
+      }
+    }
+
+  } else if ( mDebug ) {
+    KMessageBox::error( 0,
+                        i18n( "Cannot start pipe command from template: %1" ).
+                        arg( cmd ) );
+  }
+
+  return mPipeOut;
+}
+
+void TemplateParser::onProcessExited( KProcess *proc )
+{
+  Q_UNUSED( proc );
+  // do nothing for now
+}
+
+void TemplateParser::onReceivedStdout( KProcess *proc, char *buffer, int buflen )
+{
+  Q_UNUSED( proc );
+  mPipeOut += QString::fromLocal8Bit( buffer, buflen );
+}
+
+void TemplateParser::onReceivedStderr( KProcess *proc, char *buffer, int buflen )
+{
+  Q_UNUSED( proc );
+  mPipeErr += QString::fromLocal8Bit( buffer, buflen );
+}
+
+void TemplateParser::onWroteStdin( KProcess *proc )
+{
+  proc->closeStdin();
+}
+
+#include "templateparser.moc"
Index: kmail/customtemplates.h
===================================================================
--- kmail/customtemplates.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/customtemplates.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,92 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#ifndef CUSTOMTEMPLATES_H
+#define CUSTOMTEMPLATES_H
+
+#include "customtemplates_base.h"
+#include "templatesinsertcommand.h"
+
+struct CustomTemplateItem;
+typedef QDict<CustomTemplateItem> CustomTemplateItemList;
+class KShortcut;
+
+class CustomTemplates : public CustomTemplatesBase
+{
+  Q_OBJECT
+
+  public:
+
+    enum Type { TUniversal, TReply, TReplyAll, TForward };
+
+  public:
+
+    CustomTemplates( QWidget *parent = 0, const char *name = 0 );
+    ~CustomTemplates();
+
+    void load();
+    void save();
+
+    QString indexToType( int index );
+
+  public slots:
+
+    void slotInsertCommand( QString cmd, int adjustCursor = 0 );
+
+    void slotTextChanged();
+
+    void slotAddClicked();
+    void slotRemoveClicked();
+    void slotListSelectionChanged();
+    void slotTypeActivated( int index );
+    void slotShortcutCaptured( const KShortcut &shortcut );
+
+  signals:
+
+    void changed();
+
+  protected:
+
+    QListViewItem *mCurrentItem;
+    CustomTemplateItemList mItemList;
+
+    QPixmap mReplyPix;
+    QPixmap mReplyAllPix;
+    QPixmap mForwardPix;
+
+};
+
+struct CustomTemplateItem
+{
+  CustomTemplateItem() {}
+  CustomTemplateItem( const QString &name,
+                      const QString &content,
+                      KShortcut &shortcut,
+                      CustomTemplates::Type type ) :
+    mName( name ), mContent( content ), mShortcut(shortcut), mType( type ) {}
+
+  QString mName, mContent;
+  KShortcut mShortcut;
+  CustomTemplates::Type mType;
+};
+
+#endif // CUSTOMTEMPLATES_H
Index: kmail/kmcomposerui.rc
===================================================================
--- kmail/kmcomposerui.rc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmcomposerui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-<!DOCTYPE kpartgui ><kpartgui version="28" name="kmcomposer" >
+<!DOCTYPE kpartgui ><kpartgui version="30" name="kmcomposer" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;Message</text>
@@ -10,6 +10,7 @@
    <Action name="send_alternative" />
    <Action name="send_alternative_via" />
    <Action name="save_in_drafts" />
+   <Action name="save_in_templates" />
    <Separator/>
    <Action name="insert_file" />
    <Action name="insert_file_recent" />
Index: kmail/kmheaders.cpp
===================================================================
--- kmail/kmheaders.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmheaders.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,10 +17,13 @@
 #include "kmfoldertree.h"
 #include "folderjob.h"
 using KMail::FolderJob;
+#include "actionscheduler.h"
+using KMail::ActionScheduler;
 #include "broadcaststatus.h"
 using KPIM::BroadcastStatus;
-#include "actionscheduler.h"
-using KMail::ActionScheduler;
+#include "progressmanager.h"
+using KPIM::ProgressManager;
+using KPIM::ProgressItem;
 #include <maillistdrag.h>
 #include "globalsettings.h"
 using namespace KPIM;
@@ -672,12 +675,14 @@
     mSortInfo.removed = 0;
     mFolder = aFolder;
     mSortInfo.dirty = true;
-    mOwner->editAction()->setEnabled(mFolder ?
-        (kmkernel->folderIsDraftOrOutbox(mFolder)): false );
-    mOwner->replyListAction()->setEnabled(mFolder ?
-        mFolder->isMailingListEnabled() : false);
-    if (mFolder)
-    {
+    mOwner->editAction()->setEnabled( mFolder ?
+                         ( kmkernel->folderIsDraftOrOutbox( mFolder ) ||
+                           kmkernel->folderIsTemplates( mFolder ) ) : false );
+    mOwner->useAction()->setEnabled( mFolder ?
+                         ( kmkernel->folderIsTemplates( mFolder ) ) : false );
+    mOwner->replyListAction()->setEnabled( mFolder ?
+                         mFolder->isMailingListEnabled() : false );
+    if ( mFolder ) {
       connect(mFolder, SIGNAL(msgHeaderChanged(KMFolder*,int)),
               this, SLOT(msgHeaderChanged(KMFolder*,int)));
       connect(mFolder, SIGNAL(msgAdded(int)),
@@ -1149,7 +1154,7 @@
 //-----------------------------------------------------------------------------
 void KMHeaders::setMsgStatus (KMMsgStatus status, bool toggle)
 {
-  kdDebug() << k_funcinfo << endl;
+  //  kdDebug() << k_funcinfo << endl;
   SerNumList serNums;
   QListViewItemIterator it(this, QListViewItemIterator::Selected|QListViewItemIterator::Visible);
   while( it.current() ) {
@@ -1357,9 +1362,14 @@
     KCursorSaver busy( KBusyPtr::busy() );
     int msgCount = 0;
     int msgCountToFilter = msgList->count();
+    ProgressItem* progressItem =
+      ProgressManager::createProgressItem( "filter"+ProgressManager::getUniqueID(),
+                                           i18n( "Filtering messages" ) );
+    progressItem->setTotalItems( msgCountToFilter );
     for (KMMsgBase* msgBase=msgList->first(); msgBase; msgBase=msgList->next()) {
       int diff = msgCountToFilter - ++msgCount;
       if ( diff < 10 || !( msgCount % 20 ) || msgCount <= 10 ) {
+        progressItem->updateProgress();
         QString statusMsg = i18n("Filtering message %1 of %2");
         statusMsg = statusMsg.arg( msgCount ).arg( msgCountToFilter );
         KPIM::BroadcastStatus::instance()->setStatusMsg( statusMsg );
@@ -1379,7 +1389,10 @@
       } else {
         if (slotFilterMsg(msg) == 2) break;
       }
+      progressItem->incCompletedItems();
     }
+    progressItem->setComplete();
+    progressItem = 0;
     END_TIMER(filter);
     SHOW_TIMER(filter);
   }
@@ -1463,9 +1476,9 @@
 void KMHeaders::finalizeMove( HeaderItem *item, int contentX, int contentY )
 {
   emit selected( 0 );
+  clearSelection();
 
   if ( item ) {
-    clearSelection();
     setCurrentItem( item );
     setSelected( item, true );
     setSelectionAnchor( currentItem() );
@@ -2280,17 +2293,22 @@
 
   mOwner->updateMessageMenu();
 
-  bool out_folder = kmkernel->folderIsDraftOrOutbox(mFolder);
-  if ( out_folder )
-     mOwner->editAction()->plug(menu);
-  else {
-     // show most used actions
-     if( !mFolder->isSent() )
-       mOwner->replyMenu()->plug(menu);
-     mOwner->forwardMenu()->plug(menu);
-     if(mOwner->sendAgainAction()->isEnabled()) {
-       mOwner->sendAgainAction()->plug(menu);
-     }
+  bool out_folder = kmkernel->folderIsDraftOrOutbox( mFolder );
+  bool tem_folder = kmkernel->folderIsTemplates( mFolder );
+  if ( out_folder ) {
+    mOwner->editAction()->plug(menu);
+  } else if ( tem_folder ) {
+     mOwner->useAction()->plug( menu );
+     mOwner->editAction()->plug( menu );
+  } else {
+    // show most used actions
+    if( !mFolder->isSent() ) {
+      mOwner->replyMenu()->plug( menu );
+    }
+    mOwner->forwardMenu()->plug( menu );
+    if( mOwner->sendAgainAction()->isEnabled() ) {
+      mOwner->sendAgainAction()->plug( menu );
+    }
   }
   menu->insertSeparator();
 
@@ -2314,21 +2332,16 @@
     mOwner->threadStatusMenu()->plug( menu ); // Mark Thread menu
   }
 
-  if (!out_folder && !mFolder->isSent() && mOwner->watchThreadAction()->isEnabled() ) {
-    mOwner->watchThreadAction()->plug(menu);
-    mOwner->ignoreThreadAction()->plug(menu);
-  }
-
-  if ( !out_folder ) {
+  if ( !out_folder && !tem_folder ) {
     menu->insertSeparator();
     mOwner->filterMenu()->plug( menu ); // Create Filter menu
-    mOwner->action("apply_filter_actions")->plug(menu);
+    mOwner->action( "apply_filter_actions" )->plug( menu );
   }
 
   menu->insertSeparator();
+  mOwner->printAction()->plug(menu);
   mOwner->saveAsAction()->plug(menu);
   mOwner->saveAttachmentsAction()->plug(menu);
-  mOwner->printAction()->plug(menu);
   menu->insertSeparator();
   if ( mFolder->isTrash() ) {
     mOwner->deleteAction()->plug(menu);
Index: kmail/templatesconfiguration_base.ui
===================================================================
--- kmail/templatesconfiguration_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesconfiguration_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,332 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>TemplatesConfigurationBase</class>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>TemplatesConfigurationBase</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>400</width>
+            <height>316</height>
+        </rect>
+    </property>
+    <property name="sizePolicy">
+        <sizepolicy>
+            <hsizetype>7</hsizetype>
+            <vsizetype>7</vsizetype>
+            <horstretch>3</horstretch>
+            <verstretch>3</verstretch>
+        </sizepolicy>
+    </property>
+    <property name="minimumSize">
+        <size>
+            <width>400</width>
+            <height>300</height>
+        </size>
+    </property>
+    <property name="caption">
+        <string>TemplatesConfiguration</string>
+    </property>
+    <vbox>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="QToolBox">
+            <property name="name">
+                <cstring>toolBox1</cstring>
+            </property>
+            <property name="sizePolicy">
+                <sizepolicy>
+                    <hsizetype>7</hsizetype>
+                    <vsizetype>7</vsizetype>
+                    <horstretch>3</horstretch>
+                    <verstretch>3</verstretch>
+                </sizepolicy>
+            </property>
+            <property name="minimumSize">
+                <size>
+                    <width>0</width>
+                    <height>0</height>
+                </size>
+            </property>
+            <property name="frameShape">
+                <enum>Panel</enum>
+            </property>
+            <property name="frameShadow">
+                <enum>Sunken</enum>
+            </property>
+            <property name="currentIndex">
+                <number>3</number>
+            </property>
+            <widget class="QWidget">
+                <property name="name">
+                    <cstring>page_new</cstring>
+                </property>
+                <property name="backgroundMode">
+                    <enum>PaletteBackground</enum>
+                </property>
+                <attribute name="label">
+                    <string>New Message</string>
+                </attribute>
+                <hbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <widget class="QTextEdit">
+                        <property name="name">
+                            <cstring>textEdit_new</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>7</hsizetype>
+                                <vsizetype>7</vsizetype>
+                                <horstretch>3</horstretch>
+                                <verstretch>3</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="minimumSize">
+                            <size>
+                                <width>0</width>
+                                <height>0</height>
+                            </size>
+                        </property>
+                        <property name="font">
+                            <font>
+                                <family>Monospace</family>
+                            </font>
+                        </property>
+                        <property name="resizePolicy">
+                            <enum>Manual</enum>
+                        </property>
+                        <property name="vScrollBarMode">
+                            <enum>Auto</enum>
+                        </property>
+                        <property name="hScrollBarMode">
+                            <enum>Auto</enum>
+                        </property>
+                        <property name="textFormat">
+                            <enum>PlainText</enum>
+                        </property>
+                        <property name="wordWrap">
+                            <enum>NoWrap</enum>
+                        </property>
+                        <property name="autoFormatting">
+                            <set>AutoNone</set>
+                        </property>
+                    </widget>
+                </hbox>
+            </widget>
+            <widget class="QWidget">
+                <property name="name">
+                    <cstring>page_reply</cstring>
+                </property>
+                <property name="backgroundMode">
+                    <enum>PaletteBackground</enum>
+                </property>
+                <attribute name="label">
+                    <string>Reply to Sender</string>
+                </attribute>
+                <hbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <widget class="QTextEdit">
+                        <property name="name">
+                            <cstring>textEdit_reply</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>3</hsizetype>
+                                <vsizetype>3</vsizetype>
+                                <horstretch>0</horstretch>
+                                <verstretch>0</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="font">
+                            <font>
+                                <family>Monospace</family>
+                            </font>
+                        </property>
+                        <property name="textFormat">
+                            <enum>PlainText</enum>
+                        </property>
+                        <property name="wordWrap">
+                            <enum>NoWrap</enum>
+                        </property>
+                        <property name="autoFormatting">
+                            <set>AutoNone</set>
+                        </property>
+                    </widget>
+                </hbox>
+            </widget>
+            <widget class="QWidget">
+                <property name="name">
+                    <cstring>page_reply_all</cstring>
+                </property>
+                <property name="backgroundMode">
+                    <enum>PaletteBackground</enum>
+                </property>
+                <attribute name="label">
+                    <string>Reply to All / Reply to List</string>
+                </attribute>
+                <hbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <widget class="QTextEdit">
+                        <property name="name">
+                            <cstring>textEdit_reply_all</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>3</hsizetype>
+                                <vsizetype>3</vsizetype>
+                                <horstretch>0</horstretch>
+                                <verstretch>0</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="font">
+                            <font>
+                                <family>Monospace</family>
+                            </font>
+                        </property>
+                        <property name="textFormat">
+                            <enum>PlainText</enum>
+                        </property>
+                        <property name="wordWrap">
+                            <enum>NoWrap</enum>
+                        </property>
+                        <property name="autoFormatting">
+                            <set>AutoNone</set>
+                        </property>
+                    </widget>
+                </hbox>
+            </widget>
+            <widget class="QWidget">
+                <property name="name">
+                    <cstring>page_forward</cstring>
+                </property>
+                <property name="backgroundMode">
+                    <enum>PaletteBackground</enum>
+                </property>
+                <attribute name="label">
+                    <string>Forward Message</string>
+                </attribute>
+                <hbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <widget class="QTextEdit">
+                        <property name="name">
+                            <cstring>textEdit_forward</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>3</hsizetype>
+                                <vsizetype>3</vsizetype>
+                                <horstretch>0</horstretch>
+                                <verstretch>0</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="font">
+                            <font>
+                                <family>Monospace</family>
+                            </font>
+                        </property>
+                        <property name="textFormat">
+                            <enum>PlainText</enum>
+                        </property>
+                        <property name="wordWrap">
+                            <enum>NoWrap</enum>
+                        </property>
+                        <property name="autoFormatting">
+                            <set>AutoNone</set>
+                        </property>
+                    </widget>
+                </hbox>
+            </widget>
+        </widget>
+        <widget class="KActiveLabel">
+            <property name="name">
+                <cstring>mHelp</cstring>
+            </property>
+            <property name="text">
+                <string>How does this work?</string>
+            </property>
+        </widget>
+        <widget class="QLayoutWidget">
+            <property name="name">
+                <cstring>layout5</cstring>
+            </property>
+            <hbox>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="TemplatesInsertCommand">
+                    <property name="name">
+                        <cstring>mInsertCommand</cstring>
+                    </property>
+                </widget>
+                <widget class="QLabel">
+                    <property name="name">
+                        <cstring>textLabel1</cstring>
+                    </property>
+                    <property name="sizePolicy">
+                        <sizepolicy>
+                            <hsizetype>5</hsizetype>
+                            <vsizetype>5</vsizetype>
+                            <horstretch>2</horstretch>
+                            <verstretch>0</verstretch>
+                        </sizepolicy>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Quote indicator:</string>
+                    </property>
+                    <property name="alignment">
+                        <set>AlignVCenter|AlignRight</set>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>lineEdit_quote</cstring>
+                    </property>
+                </widget>
+                <widget class="QLineEdit">
+                    <property name="name">
+                        <cstring>lineEdit_quote</cstring>
+                    </property>
+                </widget>
+            </hbox>
+        </widget>
+    </vbox>
+</widget>
+<customwidgets>
+    <customwidget>
+        <class>TemplatesInsertCommand</class>
+        <header location="local">templatesinsertcommand.h</header>
+        <sizehint>
+            <width>50</width>
+            <height>10</height>
+        </sizehint>
+        <container>0</container>
+        <sizepolicy>
+            <hordata>5</hordata>
+            <verdata>5</verdata>
+            <horstretch>0</horstretch>
+            <verstretch>0</verstretch>
+        </sizepolicy>
+        <pixmap>image0</pixmap>
+        <signal>insertCommand(int)</signal>
+    </customwidget>
+</customwidgets>
+<images>
+    <image name="image0">
+        <data format="PNG" length="807">89504e470d0a1a0a0000000d49484452000000100000001008060000001ff3ff61000002ee49444154388d7d93cd6b5c6514c67fe7bdef9d8f24d349c66412a203b1b4282d21140918824816418a0b454d75e1a28ab8c8dfe1c25d70e34e0812ea4644d13610c43a1121b5d84cab6943486227499d869ae6633e32f7de79ef71d58644f0593dabdf39cf7938a2aa4c4f4f9b300c0b954ae56ca55249876128aa2a9c90738eadadada0542afd954ea7cb636363a19d9f9f4755cff6f4a53e4d67ed78f7b37ebb8b05e3810818017d0a68f1dcc36463a7ea8a4b8bdb9fcccdcdddf6eaf5bae4f3f9f7bb7a773faee94fed81b983a6d6d9ab6eb2f5f73affec6de1a536c9e4d7497696c9f63cf237d66b85b5e570cf3977c7aeaeae9a42a130d03d506bdbaddda3d1805faec6dc5a68e2a208e30124187a39c9ebefa6c8f544f84949a9ea69e75cd60641c0e1e1a1b8b849142ac51f226ece1f32fc4a86f31732f86db076178ad70e20765cfae8142207009eaafac639270022c2fd15a1b470c8f81b59defed0637024c44596c269cb3b1fe4585c68f2c76f0e23064000639e5c5804caab2d8c24187ed5c3265adc5bf4b9f2f91e377eae73fe254b6fbfc7ea7283588f9a314756089b31ed5925dd61b87b2bc5d75fd4a91d843c7fa68d5caf23fb4c8246fdc9f01300e3412e9f60f7313c285b6edf0c696bf338f3620773df3de2ea15d8de0ce92f2448f8472bd8a700515e18146e5c3714afd5197f3343ae3b463ce1cbcf94efbf7a48b6cb303462595c3801505514280c182ebed5ce37333bec3f8e387721859f80da7e8c114714097b3be65804eb799e562a95e641358e4d47cb8cbc66c9f5f6f1eb8f55967eafa140bedfe7e27b7dac2c4588a7ec6cb7622004629b4c2629954a7fda6c6b3f5f08baac1f61bd2683c3867a358931865339c8e69a9c1b323cb87fc0fa72d81091351189646262426667677b620e2fabea25942e504144fef34d80735a752daeab9a6f7ddf5f9162b1c8e4e4a45f2e974f0541d0a3aa19c03f16f4b862a061adddc96432bba2aaccccccc8d4d494b7b1b1910c8220a1aae6ff00d6da56676767303a3a1afd0b29d2596f22d0b7b20000000049454e44ae426082</data>
+    </image>
+</images>
+<layoutdefaults spacing="6" margin="11"/>
+<includehints>
+    <includehint>kactivelabel.h</includehint>
+    <includehint>templatesinsertcommand.h</includehint>
+</includehints>
+</UI>
Index: kmail/dcopimap.desktop
===================================================================
--- kmail/dcopimap.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/dcopimap.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,9 +15,10 @@
 Comment[es]=Programa de correo con un interfaz DCOP
 Comment[et]=E-posti rakendus DCOP-liidesega
 Comment[eu]=DCOP interfazedun posta programa
-Comment[fa]=برنامۀ نامه با یک واسط DCOP
+Comment[fa]=برنامۀ نامه با واسط DCOP
 Comment[fi]=Sähköpostisovellus DCOP-rajapinnalla
 Comment[fr]=Programme de messagerie avec une interface DCOP
+Comment[gl]=Programa de correo-e cunha interface DCOP
 Comment[hi]=डीकॉप इंटरफेस सहित एक डाक प्रोग्राम
 Comment[hu]=Levelezőprogram DCOP felülettel
 Comment[is]=Póstforrit með DCOP viðmóti
Index: kmail/profiles/profile-high-contrast-rc.desktop
===================================================================
--- kmail/profiles/profile-high-contrast-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/profiles/profile-high-contrast-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -48,7 +48,7 @@
 Name[zh_CN]=高对比
 Name[zh_TW]=高反差
 Comment=Increased font sizes for visually impaired users
-Comment[ar]=خطوط بأحجام أكبر لضعاف البصر
+Comment[ar]=محارف بقياسات أكبر للمستخدمين ذوي البصر الضعيف
 Comment[az]=Görmə pozuqluğu olanlar üçün böyüdülmüş yazı növləri
 Comment[bg]=Увеличаване на размера на шрифта за потребители със зрителни увреждания
 Comment[bs]=Povećane dimenzije fontova za korisnike sa vizuelnim nedostacima
@@ -62,7 +62,7 @@
 Comment[es]=Tamaños grandes de tipografía para usuarios con deficiencias visuales
 Comment[et]=Suured fondid halva nägemisega kasutajatele
 Comment[eu]=Letra-tipo handiagoak ikusmen arazoak dituzten erabiltzaileentzat
-Comment[fa]=اندزه قلمهای افزایش یافته برای کاربرانی که از نظر تصویری زیان دیده‌اند
+Comment[fa]=اندازۀ قلمهای افزایش یافته برای کاربرانی که از نظر تصویری زیان دیده‌اند
 Comment[fi]=Suurennettu kirjasinkoko heikkonäköisille käyttäjille
 Comment[fr]=Des polices de caractères plus grandes pour les malvoyants
 Comment[gl]=Tamaños de fonte aumentados para usuarios con discapacidade visual
Index: kmail/profiles/profile-default-rc.desktop
===================================================================
--- kmail/profiles/profile-default-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/profiles/profile-default-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,6 @@
 [KMail Profile]
 Name=Default
-Name[ar]=افتراضي
+Name[ar]=الإفتراضي
 Name[az]=Əsas
 Name[be]=Па ўмаўчаньні
 Name[bg]=Стандартен
@@ -16,7 +16,7 @@
 Name[es]=Predeterminado
 Name[et]=Vaikimisi
 Name[eu]=Lehenetsia
-Name[fa]=پیش‌فرض‌
+Name[fa]=پیش‌فرض
 Name[fi]=Oletus
 Name[fr]=Défaut
 Name[ga]=Réamhshocrú
@@ -64,7 +64,6 @@
 Name[zh_TW]=預設
 Name[zu]=Engaqedekanga
 Comment=Standard profile
-Comment[ar]=التشكيل القياسي
 Comment[az]=Standard profil
 Comment[be]=Стандартны профіль
 Comment[bg]=Стандартен профил
Index: kmail/profiles/profile-html-rc.desktop
===================================================================
--- kmail/profiles/profile-html-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/profiles/profile-html-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,7 +17,7 @@
 Comment[es]=Perfil estándar con las vista HTML activada - menos seguro
 Comment[et]=Standardprofiil HTML-i eelvaatlusega - pole nii turvaline!
 Comment[eu]=HTML aurrebista gaituta duen profil estandarra - sekuritate gutxiago du
-Comment[fa]=profile استاندارد با پیش‌نمایش زنگام فعال شده - با ایمنی کمتر!
+Comment[fa]=profile استاندارد با پیش‌نمایش زنگام فعال‌شده - با ایمنی کمتر!
 Comment[fi]=Normaali profiili HTML-esikatselua käyttäville - vähemmän turvallinen.
 Comment[fr]=Profil standard avec l'aperçu HTML activé - Moins sécurisé !
 Comment[gl]=Perfil estándar con previsualización HTML activada - menos seguro!
Index: kmail/profiles/profile-purist-rc.desktop
===================================================================
--- kmail/profiles/profile-purist-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/profiles/profile-purist-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -7,7 +7,7 @@
 Name[eo]=Puristo
 Name[es]=Purista
 Name[eu]=Purista
-Name[fa]=سَره گرا
+Name[fa]=سَره‌گرا
 Name[fi]=Puristi
 Name[fr]=Puriste
 Name[gl]=Purista
@@ -71,7 +71,7 @@
 Comment[lv]=Vairums īpašību izslēgtas, tiek izmantoti KDE globālie uzstādījumi
 Comment[ms]=Kebanyakan cirian ditutup, seting global KDE digunakan
 Comment[nb]=De fleste funksjoner slått av, KDEs globale innstillinger er i bruk
-Comment[nds]=Mehrste Funktschonen utmaakt, globaal KDE-Vörinstellen warrt bruukt
+Comment[nds]=Mehrste Funkschonen utmaakt, globaal KDE-Vörinstellen warrt bruukt
 Comment[nl]=Meeste mogelijkheden uitgezet, de globale KDE-instellingen worden gebruikt
 Comment[nn]=Dei fleste funksjonar er slått av, globale KDE-innstillingar vert brukt
 Comment[pl]=Większość opcji wyłączona, używane są domyślne ustawienia KDE
Index: kmail/profiles/profile-secure-rc.desktop
===================================================================
--- kmail/profiles/profile-secure-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/profiles/profile-secure-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,7 +11,7 @@
 Name[es]=Más seguro
 Name[et]=Kõige turvalisem
 Name[eu]=Seguruena
-Name[fa]=بیشترین امنیت‌
+Name[fa]=بیشترین امنیت
 Name[fi]=Turvallisin
 Name[fr]=Le plus sécurisé
 Name[gl]=O máis seguro
Index: kmail/application_octetstream.desktop
===================================================================
--- kmail/application_octetstream.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/application_octetstream.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -9,6 +9,7 @@
 Name[fa]=Octetstream کاربرد
 Name[fi]=Octetstream-sovellus
 Name[fr]=Application (flux d'octets)
+Name[gl]=Aplicación Octetstream
 Name[hu]=Alkalmazás-adatfolyam
 Name[ja]=アプリケーション オクテット ストリーム
 Name[km]=Octetstream កម្មវិធី
@@ -39,9 +40,10 @@
 Comment[es]=Un accesorio de formato para el cuerpo de application/octet-stream
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile application/octet-stream)
 Comment[eu]=Gorputz-zati formateatzaile plugin bat aplikazio/zortikote-jarioentzat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای کاربرد/octet-stream
+Comment[fa]=وصلۀ قالب‌دهندۀ بخش بدنه برای کاربرد/octet-stream
 Comment[fi]=Muokkainliitännäinen application/octet-stream-muodolle
 Comment[fr]=Un module formateur de corps pour application (flux d'octets)
+Comment[gl]=Unha extensión formateadora do corpo para aplicacións/octet-stream
 Comment[hu]=Formázómodul application/octet-stream típusú adatfolyamokhoz
 Comment[is]=Sniðmátstól fyrir application/octet-stream
 Comment[it]=Un plugin per formattare application/octet-stream
Index: kmail/kmmsgpart.cpp
===================================================================
--- kmail/kmmsgpart.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmsgpart.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -386,8 +386,19 @@
 {
   QCString mimeType( mType + "/" + mSubtype );
   KPIM::kAsciiToLower( mimeType.data() );
+
   QString fileName =
     KMimeType::mimeType( mimeType )->icon( QString::null, false );
+  if ( fileName.isEmpty() )
+  {
+    fileName = this->fileName();
+    if ( fileName.isEmpty() ) fileName = this->name();
+    if ( !fileName.isEmpty() )
+    {
+      fileName = KMimeType::findByPath( "/tmp/"+fileName, 0, true )->icon( QString::null, true );
+    }
+  }
+
   fileName =
     KGlobal::instance()->iconLoader()->iconPath( fileName, KIcon::Desktop );
   return fileName;
@@ -476,7 +487,7 @@
 //-----------------------------------------------------------------------------
 QString KMMessagePart::contentDescription(void) const
 {
-  return KMMsgBase::decodeRFC2047String(mContentDescription);
+  return KMMsgBase::decodeRFC2047String(mContentDescription, charset());
 }
 
 
@@ -527,7 +538,7 @@
   if (bRFC2231encoded)
     return KMMsgBase::decodeRFC2231String(str);
   else
-    return KMMsgBase::decodeRFC2047String(str);
+    return KMMsgBase::decodeRFC2047String(str, charset());
 }
 
 
Index: kmail/kmedit.cpp
===================================================================
--- kmail/kmedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -732,4 +732,14 @@
   }
 }
 
+void KMEdit::setCursorPositionFromStart( unsigned int pos ) {
+  unsigned int l = 0;
+  unsigned int c = 0;
+  posToRowCol( pos, l, c );
+  // kdDebug() << "Num lines: " << numLines() << endl;
+  // kdDebug() << "Position " << pos << " converted to " << l << ":" << c << endl;
+  setCursorPosition( l, c );
+  ensureCursorVisible();
+}
+
 #include "kmedit.moc"
Index: kmail/kmmessage.h
===================================================================
--- kmail/kmmessage.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmessage.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -162,7 +162,8 @@
       is not stored in any folder. Marks this message as replied. */
   KMMessage* createReply( KMail::ReplyStrategy replyStrategy = KMail::ReplySmart,
                           QString selection=QString::null, bool noQuote=FALSE,
-                          bool allowDecryption=TRUE, bool selectionIsBody=FALSE);
+                          bool allowDecryption=TRUE, bool selectionIsBody=FALSE,
+                          const QString &tmpl = QString::null );
 
   /** Create a new message that is a redirect to this message, filling all
     required header fields with the proper values. The returned message
@@ -179,7 +180,7 @@
   /** Create a new message that is a forward of this message, filling all
     required header fields with the proper values. The returned message
     is not stored in any folder. Marks this message as forwarded. */
-  KMMessage* createForward();
+  KMMessage* createForward( const QString &tmpl = QString::null );
 
   /** Create a new message that is a delivery receipt of this message,
       filling required header fileds with the proper values. The
@@ -308,26 +309,30 @@
 
   /** Get or set the 'ReplyTo' header field */
   QString replyTo() const;
-  void setReplyTo(const QString& aStr);
+  void setReplyTo( const QString &aStr );
   void setReplyTo(KMMessage*);
 
   /** Get or set the 'Cc' header field */
   QString cc() const;
-  void setCc(const QString& aStr);
+  void setCc( const QString &aStr );
   QString ccStrip() const;
 
   /** Get or set the 'Bcc' header field */
   QString bcc() const;
-  void setBcc(const QString& aStr);
+  void setBcc( const QString &aStr );
 
   /** Get or set the 'Fcc' header field */
   QString fcc() const;
-  void setFcc(const QString& aStr);
+  void setFcc( const QString &aStr );
 
   /** Get or set the 'Drafts' folder */
   QString drafts() const { return mDrafts; }
-  void setDrafts(const QString& aStr);
+  void setDrafts( const QString &aStr );
 
+  /** Get or set the 'Templates' folder */
+  QString templates() const { return mTemplates; }
+  void setTemplates( const QString &aStr );
+
   /** Get or set the 'From' header field */
   QString from() const;
   void setFrom(const QString& aStr);
@@ -842,6 +847,12 @@
   /** Return the textual content of the message as plain text,
       converting HTML to plain text if necessary. */
   QString asPlainText( bool stripSignature, bool allowDecryption ) const;
+
+  /** Get stored cursor position */
+  int getCursorPos() { return mCursorPos; };
+  /** Set cursor position as offset from message start */
+  void setCursorPos(int pos) { mCursorPos = pos; };
+
 private:
 
   /** Initialization shared by the ctors. */
@@ -850,6 +861,7 @@
   void assign( const KMMessage& other );
 
   QString mDrafts;
+  QString mTemplates;
   mutable DwMessage* mMsg;
   mutable bool       mNeedsAssembly :1;
   bool mDecodeHTML :1;
@@ -868,6 +880,7 @@
   KMMsgMDNSentState mMDNSentState;
   KMMessage* mUnencryptedMsg;
   DwBodyPart* mLastUpdated;
+  int mCursorPos;
 };
 
 
Index: kmail/kmail_config_misc.desktop
===================================================================
--- kmail/kmail_config_misc.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_misc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,7 +56,7 @@
 Name[ta]=இதர
 Name[tg]=Ғайра
 Name[tr]=Çeşitli
-Name[uk]=Різн
+Name[uk]=Різне
 Name[uz]=Ҳар хил
 Name[zh_CN]=杂项
 Name[zh_TW]=其他
@@ -143,6 +143,6 @@
 Keywords[ta]=கேஅஞ்சல், இதர
 Keywords[tg]=kmail,misc,ғайра,дигар
 Keywords[tr]=kmail,çeşitli
-Keywords[uk]=kmail,різн
+Keywords[uk]=kmail,різне
 Keywords[uz]=kmail,ҳар хил
 Keywords[zh_CN]=kmail,misc,杂项
Index: kmail/templatesconfiguration.cpp
===================================================================
--- kmail/templatesconfiguration.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesconfiguration.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,561 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#include <klocale.h>
+#include <kglobal.h>
+#include <qpopupmenu.h>
+#include <qpushbutton.h>
+#include <qtextedit.h>
+#include <qlineedit.h>
+#include <qtoolbox.h>
+#include <kdebug.h>
+#include <qfont.h>
+#include <kactivelabel.h>
+
+#include "templatesconfiguration_base.h"
+#include "templatesconfiguration_kfg.h"
+#include "globalsettings.h"
+#include "replyphrases.h"
+
+#include "templatesconfiguration.h"
+
+TemplatesConfiguration::TemplatesConfiguration( QWidget *parent, const char *name )
+  :TemplatesConfigurationBase( parent, name )
+{
+  QFont f = KGlobalSettings::fixedFont();
+  textEdit_new->setFont( f );
+  textEdit_reply->setFont( f );
+  textEdit_reply_all->setFont( f );
+  textEdit_forward->setFont( f );
+
+  setSizePolicy( QSizePolicy::Expanding, QSizePolicy::Expanding );
+  sizeHint();
+
+  connect( textEdit_new, SIGNAL( textChanged() ),
+           this, SLOT( slotTextChanged( void ) ) );
+  connect( textEdit_reply, SIGNAL( textChanged() ),
+           this, SLOT( slotTextChanged( void ) ) );
+  connect( textEdit_reply_all, SIGNAL( textChanged() ),
+           this, SLOT( slotTextChanged( void ) ) );
+  connect( textEdit_forward, SIGNAL( textChanged() ),
+           this, SLOT( slotTextChanged( void ) ) );
+  connect( lineEdit_quote, SIGNAL( textChanged( const QString & ) ),
+           this, SLOT( slotTextChanged( void ) ) );
+
+  connect( mInsertCommand, SIGNAL( insertCommand(QString, int) ),
+           this, SLOT( slotInsertCommand(QString, int) ) );
+
+  QString help;
+  if ( QString( name ) == "folder-templates" ) {
+    help =
+      i18n( "<qt>"
+            "<p>Here you can create message templates to use when you "
+            "compose new messages or replies, or when you forward messages.</p>"
+            "<p>The message templates support substitution commands "
+            "by simple typing them or selecting them from menu "
+            "<i>Insert command</i>.</p>"
+            "<p>Templates specified here are folder-specific. "
+            "They override both global templates and per-identity "
+            "templates if they are specified.</p>"
+            "</qt>" );
+  } else if ( QString( name ) == "identity-templates" ) {
+    help =
+      i18n( "<qt>"
+            "<p>Here you can create message templates to use when you "
+            "compose new messages or replies, or when you forward messages.</p>"
+            "<p>The message templates support substitution commands "
+            "by simple typing them or selecting them from menu "
+            "<i>Insert command</i>.</p>"
+            "<p>Templates specified here are mail identity-wide. "
+            "They override global templates and are being overridden by per-folder "
+            "templates if they are specified.</p>"
+            "</qt>" );
+  } else {
+    help =
+      i18n( "<qt>"
+            "<p>Here you can create message templates to use when you "
+            "compose new messages or replies, or when you forward messages.</p>"
+            "<p>The message templates support substitution commands "
+            "by simple typing them or selecting them from menu "
+            "<i>Insert command</i>.</p>"
+            "<p>This is a global (default) template. They can be overridden "
+            "by per-identity templates and by per-folder templates "
+            "if they are specified.</p>"
+            "</qt>" );
+  }
+  mHelp->setText( i18n( "<a href=\"whatsthis:%1\">How does this work?</a>" ).arg( help ) );
+}
+
+void TemplatesConfiguration::slotTextChanged()
+{
+  emit changed();
+}
+
+void TemplatesConfiguration::loadFromGlobal()
+{
+  if ( !GlobalSettings::self()->phrasesConverted() ) {
+    kdDebug() << "Phrases to templates conversion" << endl;
+    importFromPhrases();
+  }
+
+  QString str;
+  str = GlobalSettings::self()->templateNewMessage();
+  if ( str.isEmpty() ) {
+    textEdit_new->setText( defaultNewMessage() );
+  } else {
+    textEdit_new->setText(str);
+  }
+  str = GlobalSettings::self()->templateReply();
+  if ( str.isEmpty() ) {
+    textEdit_reply->setText( defaultReply() );
+  } else {
+    textEdit_reply->setText( str );
+  }
+  str = GlobalSettings::self()->templateReplyAll();
+  if ( str.isEmpty() ) {
+    textEdit_reply_all->setText( defaultReplyAll() );
+  } else {
+    textEdit_reply_all->setText( str );
+  }
+  str = GlobalSettings::self()->templateForward();
+  if ( str.isEmpty() ) {
+    textEdit_forward->setText( defaultForward() );
+  } else {
+    textEdit_forward->setText( str );
+  }
+  str = GlobalSettings::self()->quoteString();
+  if ( str.isEmpty() ) {
+    lineEdit_quote->setText( defaultQuoteString() );
+  } else {
+    lineEdit_quote->setText( str );
+  }
+}
+
+void TemplatesConfiguration::saveToGlobal()
+{
+  GlobalSettings::self()->setTemplateNewMessage( strOrBlank( textEdit_new->text() ) );
+  GlobalSettings::self()->setTemplateReply( strOrBlank( textEdit_reply->text() ) );
+  GlobalSettings::self()->setTemplateReplyAll( strOrBlank( textEdit_reply_all->text() ) );
+  GlobalSettings::self()->setTemplateForward( strOrBlank( textEdit_forward->text() ) );
+  GlobalSettings::self()->setQuoteString( lineEdit_quote->text() );
+  GlobalSettings::self()->setPhrasesConverted( true );
+  GlobalSettings::self()->writeConfig();
+}
+
+void TemplatesConfiguration::loadFromIdentity( uint id )
+{
+  Templates t( QString("IDENTITY_%1").arg( id ) );
+
+  QString str;
+
+  str = t.templateNewMessage();
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateNewMessage();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultNewMessage();
+  }
+  textEdit_new->setText( str );
+
+  str = t.templateReply();
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateReply();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultReply();
+  }
+  textEdit_reply->setText( str );
+
+  str = t.templateReplyAll();
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateReplyAll();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultReplyAll();
+  }
+  textEdit_reply_all->setText( str );
+
+  str = t.templateForward();
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateForward();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultForward();
+  }
+  textEdit_forward->setText( str );
+
+  str = t.quoteString();
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->quoteString();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultQuoteString();
+  }
+  lineEdit_quote->setText( str );
+}
+
+void TemplatesConfiguration::saveToIdentity( uint id )
+{
+  Templates t( QString("IDENTITY_%1").arg( id ) );
+
+  t.setTemplateNewMessage( strOrBlank( textEdit_new->text() ) );
+  t.setTemplateReply( strOrBlank( textEdit_reply->text() ) );
+  t.setTemplateReplyAll( strOrBlank( textEdit_reply_all->text() ) );
+  t.setTemplateForward( strOrBlank( textEdit_forward->text() ) );
+  t.setQuoteString( lineEdit_quote->text() );
+  t.writeConfig();
+}
+
+void TemplatesConfiguration::loadFromFolder( QString id, uint identity )
+{
+  Templates t( id );
+  Templates* tid = 0;
+
+  if ( identity ) {
+    tid = new Templates( QString("IDENTITY_%1").arg( identity ) );
+  }
+
+  QString str;
+
+  str = t.templateNewMessage();
+  if ( str.isEmpty() && tid ) {
+    str = tid->templateNewMessage();
+  }
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateNewMessage();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultNewMessage();
+  }
+  textEdit_new->setText( str );
+
+  str = t.templateReply();
+  if ( str.isEmpty() && tid ) {
+    str = tid->templateReply();
+  }
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateReply();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultReply();
+  }
+  textEdit_reply->setText( str );
+
+  str = t.templateReplyAll();
+  if ( str.isEmpty() && tid ) {
+    str = tid->templateReplyAll();
+  }
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateReplyAll();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultReplyAll();
+  }
+  textEdit_reply_all->setText( str );
+
+  str = t.templateForward();
+  if ( str.isEmpty() && tid ) {
+    str = tid->templateForward();
+  }
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->templateForward();
+  }
+  if ( str.isEmpty() ) {
+    str = defaultForward();
+  }
+  textEdit_forward->setText( str );
+
+  str = t.quoteString();
+  if ( str.isEmpty() && tid ) {
+    str = tid->quoteString();
+  }
+  if ( str.isEmpty() ) {
+    str = GlobalSettings::self()->quoteString();
+  }
+  if ( str.isEmpty() ) {
+      str = defaultQuoteString();
+  }
+  lineEdit_quote->setText( str );
+
+  delete(tid);
+}
+
+void TemplatesConfiguration::saveToFolder( QString id )
+{
+  Templates t( id );
+
+  t.setTemplateNewMessage( strOrBlank( textEdit_new->text() ) );
+  t.setTemplateReply( strOrBlank( textEdit_reply->text() ) );
+  t.setTemplateReplyAll( strOrBlank( textEdit_reply_all->text() ) );
+  t.setTemplateForward( strOrBlank( textEdit_forward->text() ) );
+  t.setQuoteString( lineEdit_quote->text() );
+  t.writeConfig();
+}
+
+void TemplatesConfiguration::loadFromPhrases()
+{
+  int currentNr = GlobalSettings::self()->replyCurrentLanguage();
+
+  ReplyPhrases replyPhrases( QString::number( currentNr ) );
+
+  textEdit_new->setText( defaultNewMessage() );
+
+  QString str;
+
+  str = replyPhrases.phraseReplySender();
+  if ( !str.isEmpty() ) {
+    textEdit_reply->setText( convertPhrases( str ) + "\n%QUOTE\n%CURSOR\n" );
+  }
+  else {
+    textEdit_reply->setText( defaultReply() );
+  }
+
+  str = replyPhrases.phraseReplyAll();
+  if ( !str.isEmpty() ) {
+    textEdit_reply_all->setText( convertPhrases( str ) + "\n%QUOTE\n%CURSOR\n" );
+  }
+  else {
+    textEdit_reply_all->setText( defaultReplyAll() );
+  }
+
+  str = replyPhrases.phraseForward();
+  if ( !str.isEmpty() ) {
+    textEdit_forward->setText( QString( i18n(
+    "%REM=\"Default forward template\"%-\n"
+    "----------  %1  ----------\n"
+    "%TEXT\n"
+    "-------------------------------------------------------\n"
+    ) ).arg( convertPhrases( str ) ) );
+  }
+  else {
+    textEdit_forward->setText( defaultForward() );
+  }
+
+  str = replyPhrases.indentPrefix();
+  if ( !str.isEmpty() ) {
+    // no need to convert indentPrefix() because it is passed to KMMessage::asQuotedString() as is
+    lineEdit_quote->setText( str );
+  }
+  else {
+    lineEdit_quote->setText( defaultQuoteString() );
+  }
+}
+
+void TemplatesConfiguration::importFromPhrases()
+{
+  kdDebug() << "TemplatesConfiguration::importFromPhrases()" << endl;
+
+  int currentNr = GlobalSettings::self()->replyCurrentLanguage();
+
+  ReplyPhrases replyPhrases( QString::number( currentNr ) );
+
+  QString str;
+
+  str = replyPhrases.phraseReplySender();
+  if ( !str.isEmpty() ) {
+    GlobalSettings::self()->setTemplateReply( convertPhrases( str ) + "\n%QUOTE\n%CURSOR\n" );
+  }
+  else {
+    GlobalSettings::self()->setTemplateReply( defaultReply() );
+  }
+
+  str = replyPhrases.phraseReplyAll();
+  if ( !str.isEmpty() ) {
+    GlobalSettings::self()->setTemplateReplyAll( convertPhrases( str ) + "\n%QUOTE\n%CURSOR\n" );
+  }
+  else {
+    GlobalSettings::self()->setTemplateReplyAll( defaultReplyAll() );
+  }
+
+  str = replyPhrases.phraseForward();
+  if ( !str.isEmpty() ) {
+    GlobalSettings::self()->setTemplateForward( QString( i18n(
+    "%REM=\"Default forward template\"%-\n"
+    "\n"
+    "----------  %1  ----------\n"
+    "\n"
+    "Subject: %OFULLSUBJECT\n"
+    "Date: %ODATE\n"
+    "From: %OFROMADDR\n"
+    "To: %OTOADDR\n"
+    "\n"
+    "%TEXT\n"
+    "-------------------------------------------------------\n"
+    ) ).arg( convertPhrases( str ) ) );
+  }
+  else {
+    GlobalSettings::self()->setTemplateForward( defaultForward() );
+  }
+
+  str = replyPhrases.indentPrefix();
+  if ( !str.isEmpty() ) {
+    // no need to convert indentPrefix() because it is passed to KMMessage::asQuotedString() as is
+    GlobalSettings::self()->setQuoteString( str );
+  }
+  else {
+    GlobalSettings::self()->setQuoteString( defaultQuoteString() );
+  }
+
+  GlobalSettings::self()->setPhrasesConverted( true );
+  GlobalSettings::self()->writeConfig();
+}
+
+QString TemplatesConfiguration::convertPhrases( QString &str )
+{
+  QString result;
+  QChar ch;
+
+  unsigned int strLength( str.length() );
+  for ( uint i = 0; i < strLength; ) {
+    ch = str[i++];
+    if ( ch == '%' ) {
+      ch = str[i++];
+      switch ( (char)ch ) {
+      case 'D':
+        result += "%ODATE";
+        break;
+      case 'e':
+        result += "%OFROMADDR";
+        break;
+      case 'F':
+        result += "%OFROMNAME";
+        break;
+      case 'f':
+        // is this used for something like FIDO quotes, like "AB>" ?
+        // not supported right now
+        break;
+      case 'T':
+        result += "%OTONAME";
+        break;
+      case 't':
+        result += "%OTOADDR";
+        break;
+      case 'C':
+        result += "%OCCNAME";
+        break;
+      case 'c':
+        result += "%OCCADDR";
+        break;
+      case 'S':
+        result += "%OFULLSUBJECT";
+        break;
+      case '_':
+        result += ' ';
+        break;
+      case 'L':
+        result += "\n";
+        break;
+      case '%':
+        result += "%%";
+        break;
+      default:
+        result += '%';
+        result += ch;
+        break;
+      }
+    } else
+      result += ch;
+  }
+  return result;
+}
+
+void TemplatesConfiguration::slotInsertCommand( QString cmd, int adjustCursor )
+{
+  QTextEdit* edit;
+
+  if( toolBox1->currentItem() == page_new ) {
+    edit = textEdit_new;
+  } else if( toolBox1->currentItem() == page_reply ) {
+    edit = textEdit_reply;
+  } else if( toolBox1->currentItem() == page_reply_all ) {
+    edit = textEdit_reply_all;
+  } else if( toolBox1->currentItem() == page_forward ) {
+    edit = textEdit_forward;
+  } else {
+    kdDebug() << "Unknown current page in TemplatesConfiguration!" << endl;
+    return;
+  }
+
+  // kdDebug() << "Insert command: " << cmd << endl;
+
+  int para, index;
+  edit->getCursorPosition( &para, &index );
+  edit->insertAt( cmd, para, index );
+
+  index += adjustCursor;
+
+  edit->setCursorPosition( para, index + cmd.length() );
+}
+
+QString TemplatesConfiguration::defaultNewMessage() {
+  return i18n(
+    "%REM=\"Default new message template\"%-\n"
+    "%BLANK"
+    );
+}
+
+QString TemplatesConfiguration::defaultReply() {
+  return i18n(
+    "%REM=\"Default reply template\"%-\n"
+    "On %ODATEEN %OTIMELONGEN you wrote:\n"
+    "%QUOTE\n"
+    "%CURSOR\n"
+    );
+}
+
+QString TemplatesConfiguration::defaultReplyAll() {
+  return i18n(
+    "%REM=\"Default reply all template\"%-\n"
+    "On %ODATEEN %OTIMELONGEN %OFROMNAME wrote:\n"
+    "%QUOTE\n"
+    "%CURSOR\n"
+    );
+}
+
+QString TemplatesConfiguration::defaultForward() {
+  return i18n(
+    "%REM=\"Default forward template\"%-\n"
+    "\n"
+    "----------  Forwarded Message  ----------\n"
+    "\n"
+    "Subject: %OFULLSUBJECT\n"
+    "Date: %ODATE\n"
+    "From: %OFROMADDR\n"
+    "To: %OTOADDR\n"
+    "\n"
+    "%TEXT\n"
+    "-------------------------------------------------------\n"
+    );
+}
+
+QString TemplatesConfiguration::defaultQuoteString() {
+  return "> ";
+}
+
+QString TemplatesConfiguration::strOrBlank( QString str ) {
+  if ( str.stripWhiteSpace().isEmpty() ) {
+    return QString( "%BLANK" );
+  }
+  return str;
+}
+
+#include "templatesconfiguration.moc"
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -426,7 +426,7 @@
   tmp_file += filename;
 
   if (!KPIM::kCStringToFile(msgText, tmp_file, false, false, false))
-    kmkernel->emergencyExit( i18n("Message could not be added to the folder, possibly disk space is low.") ); 
+    kmkernel->emergencyExit( i18n("Message could not be added to the folder, possibly disk space is low.") );
 
   QFile file(tmp_file);
   size = msgText.length();
@@ -477,10 +477,10 @@
   }
   ++mTotalMsgs;
 
-  if ( aMsg->attachmentState() == KMMsgAttachmentUnknown && 
+  if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
     aMsg->updateAttachmentState();
-  
+
   // store information about the position in the folder file in the message
   aMsg->setParent(folder());
   aMsg->setMsgSize(size);
@@ -653,6 +653,7 @@
   QCString dateStr, fromStr, toStr, subjStr;
   QCString xmarkStr, replyToIdStr, msgIdStr, referencesStr;
   QCString statusStr, replyToAuxIdStr, uidStr;
+  QCString contentTypeStr, charset;
 
   // iterate through this file until done
   while (!atEof)
@@ -725,6 +726,29 @@
           status |= KMMsgStatusFlag;
       }
 
+      contentTypeStr = contentTypeStr.stripWhiteSpace();
+      charset = "";
+      if ( !contentTypeStr.isEmpty() )
+      {
+        int cidx = contentTypeStr.find( "charset=" );
+        if ( cidx != -1 ) {
+          charset = contentTypeStr.mid( cidx + 8 );
+          if ( charset[0] == '"' ) {
+            charset = charset.mid( 1 );
+          }
+          cidx = 0;
+          while ( (unsigned int) cidx < charset.length() ) {
+            if ( charset[cidx] == '"' || ( !isalnum(charset[cidx]) &&
+                 charset[cidx] != '-' && charset[cidx] != '_' ) )
+              break;
+            ++cidx;
+          }
+          charset.truncate( cidx );
+          // kdDebug() << "KMFolderMaildir::readFileHeaderIntern() charset found: " <<
+          //              charset << " from " << contentTypeStr << endl;
+        }
+      }
+
       KMMsgInfo *mi = new KMMsgInfo(folder());
       mi->init( subjStr.stripWhiteSpace(),
                 fromStr.stripWhiteSpace(),
@@ -734,7 +758,7 @@
                 replyToIdStr, replyToAuxIdStr, msgIdStr,
 				file.local8Bit(),
                 KMMsgEncryptionStateUnknown, KMMsgSignatureStateUnknown,
-                KMMsgMDNStateUnknown, f.size() );
+                KMMsgMDNStateUnknown, charset, f.size() );
 
       dateStr = dateStr.stripWhiteSpace();
       if (!dateStr.isEmpty())
@@ -823,6 +847,11 @@
       uidStr = QCString(line+6);
       lastStr = &uidStr;
     }
+    else if (strncasecmp(line, "Content-Type:", 13) == 0)
+    {
+      contentTypeStr = QCString(line+13);
+      lastStr = &contentTypeStr;
+    }
 
   }
 
Index: kmail/kmreadermainwin.cpp
===================================================================
--- kmail/kmreadermainwin.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmreadermainwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -285,6 +285,9 @@
   //                             this, SLOT( slotSaveMsg() ),
   //                             actionCollection(), "file_save_as" );
 
+  mSaveAsAction = KStdAction::saveAs( mReaderWin, SLOT( slotSaveMsg() ),
+				      actionCollection() );
+  mSaveAsAction->setShortcut( KStdAccel::shortcut( KStdAccel::Save ) );
   mPrintAction = KStdAction::print( this, SLOT( slotPrintMsg() ),
                                     actionCollection() );
 
@@ -423,6 +426,9 @@
   if(mReaderWin && !mReaderWin->copyText().isEmpty()) {
     if ( urlMenuAdded )
       menu->insertSeparator();
+    mReplyActionMenu->plug( menu );
+    menu->insertSeparator();
+
     mReaderWin->copyAction()->plug( menu );
     mReaderWin->selectAllAction()->plug( menu );
   } else if ( !urlMenuAdded )
@@ -435,9 +441,14 @@
       return;
     }
 
-    if ( ! ( aMsg.parent() && ( aMsg.parent()->isSent() || aMsg.parent()->isDrafts() ) ) ) {
-      // add the reply and forward actions only if we are not in a sent-mail or drafts
-      // folder
+    if ( ! ( aMsg.parent() && ( aMsg.parent()->isSent() ||
+                                aMsg.parent()->isDrafts() ||
+                                aMsg.parent()->isTemplates() ) ) ) {
+      // add the reply and forward actions only if we are not in a sent-mail,
+      // templates or drafts folder
+      //
+      // FIXME: needs custom templates added to menu
+      // (see KMMainWidget::updateCustomTemplateMenus)
       mReplyActionMenu->plug( menu );
       mForwardActionMenu->plug( menu );
       menu->insertSeparator();
@@ -454,7 +465,7 @@
     mReaderWin->toggleFixFontAction()->plug( menu );
     menu->insertSeparator();
     mPrintAction->plug( menu );
-    menu->insertItem(  SmallIcon("filesaveas"), i18n( "Save &As..." ), mReaderWin, SLOT( slotSaveMsg() ) );
+    mSaveAsAction->plug( menu );
     menu->insertItem( i18n("Save Attachments..."), mReaderWin, SLOT(slotSaveAttachments()) );
   }
   menu->exec(aPoint, 0);
Index: kmail/Makefile.am
===================================================================
--- kmail/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -124,7 +124,12 @@
                 mailinglistpropertiesdialog.cpp newfolderdialog.cpp \
                 accountwizard.cpp textsource.cpp \
                 managesievescriptsdialog.cpp chiasmuskeyselector.cpp \
-                util.cpp
+                util.cpp templatesinsertcommand.cpp \
+                customtemplates_base.ui customtemplates.cpp \
+                customtemplates_kfg.kcfgc \
+                templatesconfiguration_base.ui templatesconfiguration.cpp \
+                templatesconfiguration_kfg.kcfgc \
+                templateparser.cpp
 
 kmail_SOURCES = main.cpp
 
@@ -196,7 +201,8 @@
 	$(XGETTEXT) -ktranslate *.cpp *.h -o $(podir)/kmail.pot
 	rm -f tips.cpp
 
-kde_kcfg_DATA = kmail.kcfg replyphrases.kcfg custommimeheader.kcfg
+kde_kcfg_DATA = kmail.kcfg replyphrases.kcfg custommimeheader.kcfg \
+		templatesconfiguration_kfg.kcfg customtemplates_kfg.kcfg
 
 DOXYGEN_REFERENCES = kdeui
 include $(top_srcdir)/admin/Doxyfile.am
Index: kmail/kmpopfiltercnfrmdlg.cpp
===================================================================
--- kmail/kmpopfiltercnfrmdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmpopfiltercnfrmdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -266,13 +266,9 @@
 QString KMPopHeadersViewItem::key(int col, bool) const
 {
   if (col == 3) return KMMsgBase::skipKeyword(text(col).lower());
-  if (col == 5) return text(7);
-  if (col == 6)
-  {
-    QString st = text(col);
-    while (st.length() < 10) st = "0" + st;
-    return st;
-  }
+  if (col == 6) return text(8);
+  if (col == 7)
+    return text(col).rightJustify( 10, '0', false);
   return text(col);
 }
 
Index: kmail/kmail_config_composer.desktop
===================================================================
--- kmail/kmail_config_composer.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_composer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Composer
+Name[ar]=المحرر
 Name[bg]=Редактор
 Name[br]=Skridaozer
 Name[bs]=Sastavljač
@@ -58,49 +59,28 @@
 Name[uk]=Редактор листів
 Name[zh_CN]=编写器
 Name[zh_TW]=編寫器
-Comment=Phrases & General Behavior
-Comment[bg]=Настройки на редактора
-Comment[bs]=Fraze i opšte ponašanje
-Comment[ca]=Frases i comportament general
-Comment[cs]=Stylizace a obecné chování
-Comment[da]=Udtryk & Generel opførsel
-Comment[de]=Redewendungen & allgemeines Verhalten
-Comment[el]=Φράσεις & γενική Συμπεριφορά
-Comment[en_GB]=Phrases & General Behaviour
-Comment[es]=Frases y comportamiento general
-Comment[et]=Väljendid ja üldine käitumine
-Comment[eu]=Esaldiak eta portamolde orokorra
-Comment[fa]=عبارات و رفتار کلی
-Comment[fi]=Ilmaukset ja yleiset asetukset
-Comment[fr]=Phrases et comportement général
-Comment[gl]=Frases e comportamento xeral
-Comment[hu]=Kifejezések, általános működési jellemzők
-Comment[is]=Setningar & almenn hegðun
-Comment[it]=Frasi e comportamento generale
-Comment[ja]=表現 & 全般的な動作
-Comment[km]=ឃ្លា & ឥរិយាបថ​ទូទៅ
-Comment[lt]=Frazės ir bendroji elgsena
-Comment[ms]=Frasa & Peri Laku Umum
-Comment[nb]=Fraser & generell oppførsel
-Comment[nds]=Snacks un allgemeen Bedregen
-Comment[nl]=Zinnen & Algemeen gedrag
-Comment[nn]=Frasar og generell åtferd
-Comment[pl]=Wyrażenia i ogólne zachowanie
-Comment[pt]=Frases e Comportamento Geral
-Comment[pt_BR]=Frases & Comportamento Geral
-Comment[ru]=Фразы и общие параметры
-Comment[se]=Frásat ja oppalaš láhtten
-Comment[sk]=Frázy a všeobecné správanie
-Comment[sl]=Fraze in splošno obnašanje
-Comment[sr]=Фразе и опште понашање
-Comment[sr@Latn]=Fraze i opšte ponašanje
-Comment[sv]=Fraser och allmänt uppträdande
-Comment[ta]=சொற்றொடர்கள் & பொதுவான நடப்பு
-Comment[tg]=Ибораҳо ва параметрҳои умумӣ
-Comment[tr]=Tümcecik ve Genel Davranış
-Comment[uk]=Фрази і загальні параметри
-Comment[zh_CN]=短语和一般行为
-Comment[zh_TW]=片語與一般行為
+Comment=Templates & General Behavior
+Comment[ca]=Plantilles i comportament general
+Comment[cs]=Šablony a obecné chování
+Comment[da]=Skabeloner & Generel opførsel
+Comment[de]=Vorlagen und allgemeines Verhalten
+Comment[el]=Πρότυπα & γενική Συμπεριφορά
+Comment[es]=Plantilla y comportamiento general
+Comment[et]=Mallid ja üldine käitumine
+Comment[fa]=عبارتها و رفتار عمومی
+Comment[gl]=Planteis e Comportamento Xeral
+Comment[hu]=Sablonok, általános működési jellemzők
+Comment[it]=Modelli e comportamento generale
+Comment[ja]=テンプレートと全般的な動作
+Comment[km]= ពុម្ព & ឥរិយាបថ​ទូទៅ
+Comment[nds]=Vörlagen un allgemeen Bedregen
+Comment[nl]=Sjablonen en algemeen gedrag
+Comment[pt]=Modelos e Comportamento Geral
+Comment[pt_BR]=Modelos e Comportamento Geral
+Comment[ru]=Шаблоны и общие параметры
+Comment[sv]=Mallar och allmänt uppträdande
+Comment[uk]=Шаблони та загальна поведінка
+Comment[zh_TW]=樣本與一般行為
 Keywords=kmail,composer
 Keywords[bg]=пощенски, клиент, е-поща, редактор, съставител, форматиране, текст, kmail, komposer
 Keywords[bs]=kmail,composer,sastavljač
@@ -112,7 +92,7 @@
 Keywords[es]=kmail,editor
 Keywords[et]=kmail,koostaja
 Keywords[eu]=kmail,editorea
-Keywords[fa]=kmail،مؤلف
+Keywords[fa]=kmail، مؤلف
 Keywords[fi]=kmail,kirjoitus
 Keywords[fr]=KMail,éditeur
 Keywords[gl]=kmail,editor
@@ -120,7 +100,7 @@
 Keywords[hu]=kmail,szerkesztő
 Keywords[is]=kmail,ritill
 Keywords[it]=kmail,compositore
-Keywords[km]=kmail,កម្មវិធី​តែង
+Keywords[km]=kmail កម្មវិធី​តែង
 Keywords[lt]=kmail,composer,redaktorius
 Keywords[ms]=kmail,penggubah
 Keywords[nb]=kmail,komposer
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1096,7 +1096,7 @@
     }
     else {
       QStringList encodings = mSelectEncodingAction->items();
-      int i = 0;
+      uint i = 0;
       for ( QStringList::const_iterator it = encodings.begin(), end = encodings.end(); it != end; ++it, ++i ) {
         if ( KGlobal::charsets()->encodingForName( *it ) == encoding ) {
           mSelectEncodingAction->setCurrentItem( i );
@@ -2080,16 +2080,18 @@
   } else {
     htmlWriter()->begin( mCSSHelper->cssDefinitions( isFixedFont() ) );
     htmlWriter()->queue( mCSSHelper->htmlHead( isFixedFont() ) );
+    htmlWriter()->queue( "<pre>" );
 
     QString str = aMsgPart->bodyDecoded();
     // A QString cannot handle binary data. So if it's shorter than the
     // attachment, we assume the attachment is binary:
     if( str.length() < (unsigned) aMsgPart->decodedSize() ) {
-      str += QString::fromLatin1("\n") + i18n("[KMail: Attachment contains binary data. Trying to show first character.]",
+      str.prepend( i18n("[KMail: Attachment contains binary data. Trying to show first character.]",
           "[KMail: Attachment contains binary data. Trying to show first %n characters.]",
-          str.length());
+          str.length()) + QChar('\n') );
     }
-    htmlWriter()->write( QStyleSheet::escape( str ) );
+    htmlWriter()->queue( QStyleSheet::escape( str ) );
+    htmlWriter()->queue( "</pre>" );
     htmlWriter()->queue("</body></html>");
     htmlWriter()->flush();
     mMainWindow->setCaption(i18n("View Attachment: %1").arg(pname));
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmessage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -23,6 +23,7 @@
 using KMail::HeaderStrategy;
 #include "kmaddrbook.h"
 #include "kcursorsaver.h"
+#include "templateparser.h"
 
 #include <libkpimidentities/identity.h>
 #include <libkpimidentities/identitymanager.h>
@@ -155,6 +156,7 @@
   mDate    = 0;
   mUnencryptedMsg = 0;
   mLastUpdated = 0;
+  mCursorPos = 0;
 }
 
 void KMMessage::assign( const KMMessage& other )
@@ -183,6 +185,7 @@
   else
     mUnencryptedMsg = 0;
   setDrafts( other.drafts() );
+  setTemplates( other.templates() );
   //mFileName = ""; // we might not want to copy the other messages filename (?)
   //KMMsgBase::assign( &other );
 }
@@ -842,12 +845,14 @@
                                    QString selection /* = QString::null */,
                                    bool noQuote /* = false */,
                                    bool allowDecryption /* = true */,
-                                   bool selectionIsBody /* = false */)
+                                   bool selectionIsBody /* = false */,
+                                   const QString &tmpl /* = QString::null */ )
 {
   KMMessage* msg = new KMMessage;
   QString str, replyStr, mailingListStr, replyToStr, toStr;
   QStringList mailingListAddresses;
   QCString refStr, headerName;
+  bool replyAll = true;
 
   msg->initFromMessage(this);
 
@@ -887,6 +892,7 @@
       // doesn't seem to be a mailing list, reply to From: address
       toStr = from();
       replyStr = sReplyStr; // reply to author, so use "On ... you wrote:"
+      replyAll = false;
     }
     // strip all my addresses from the list of recipients
     QStringList recipients = KPIM::splitEmailAddrList( toStr );
@@ -1016,6 +1022,7 @@
       toStr = from();
     }
     replyStr = sReplyStr; // reply to author, so use "On ... you wrote:"
+    replyAll = false;
     break;
   }
   case KMail::ReplyNone : {
@@ -1031,18 +1038,26 @@
   //In-Reply-To = original msg-id
   msg->setReplyToId(msgId());
 
-  if (!noQuote) {
-    if( selectionIsBody ){
-      QCString cStr = selection.latin1();
-      msg->setBody( cStr );
-    }else{
-      msg->setBody(asQuotedString(replyStr + "\n", sIndentPrefixStr, selection,
-				  sSmartQuote, allowDecryption).utf8());
-    }
-  }
+//   if (!noQuote) {
+//     if( selectionIsBody ){
+//       QCString cStr = selection.latin1();
+//       msg->setBody( cStr );
+//     }else{
+//       msg->setBody(asQuotedString(replyStr + "\n", sIndentPrefixStr, selection,
+// 				  sSmartQuote, allowDecryption).utf8());
+//     }
+//   }
 
   msg->setSubject( replySubject() );
 
+  TemplateParser parser( msg, (replyAll ? TemplateParser::ReplyAll : TemplateParser::Reply),
+    selection, sSmartQuote, noQuote, allowDecryption, selectionIsBody );
+  if ( !tmpl.isEmpty() ) {
+    parser.process( tmpl, this );
+  } else {
+    parser.process( this );
+  }
+
   // setStatus(KMMsgStatusReplied);
   msg->link(this, KMMsgStatusReplied);
 
@@ -1170,7 +1185,7 @@
 }
 
 //-----------------------------------------------------------------------------
-KMMessage* KMMessage::createForward()
+KMMessage* KMMessage::createForward( const QString &tmpl /* = QString::null */ )
 {
   KMMessage* msg = new KMMessage();
   QString id;
@@ -1234,12 +1249,26 @@
     msg->mNeedsAssembly = true;
     msg->cleanupHeader();
   }
-  QString st = QString::fromUtf8(createForwardBody());
-  QCString encoding = autoDetectCharset(charset(), sPrefCharsets, st);
-  if (encoding.isEmpty()) encoding = "utf-8";
-  msg->setCharset(encoding);
+  // QString st = QString::fromUtf8(createForwardBody());
 
   msg->setSubject( forwardSubject() );
+
+  TemplateParser parser( msg, TemplateParser::Forward,
+    asPlainText( false, false ),
+    false, false, false, false);
+  if ( !tmpl.isEmpty() ) {
+    parser.process( tmpl, this );
+  } else {
+    parser.process( this );
+  }
+
+  // QCString encoding = autoDetectCharset(charset(), sPrefCharsets, msg->body());
+  // if (encoding.isEmpty()) encoding = "utf-8";
+  // msg->setCharset(encoding);
+
+  // force utf-8
+  // msg->setCharset( "utf-8" );
+
   msg->link(this, KMMsgStatusForwarded);
   return msg;
 }
@@ -1592,20 +1621,26 @@
   else
     setHeaderField("X-KMail-Identity", QString::number( ident.uoid() ));
 
-  if (ident.transport().isEmpty())
-    removeHeaderField("X-KMail-Transport");
+  if ( ident.transport().isEmpty() )
+    removeHeaderField( "X-KMail-Transport" );
   else
-    setHeaderField("X-KMail-Transport", ident.transport());
+    setHeaderField( "X-KMail-Transport", ident.transport() );
 
-  if (ident.fcc().isEmpty())
+  if ( ident.fcc().isEmpty() )
     setFcc( QString::null );
   else
     setFcc( ident.fcc() );
 
-  if (ident.drafts().isEmpty())
+  if ( ident.drafts().isEmpty() )
     setDrafts( QString::null );
   else
     setDrafts( ident.drafts() );
+
+  if ( ident.templates().isEmpty() )
+    setTemplates( QString::null );
+  else
+    setTemplates( ident.templates() );
+
 }
 
 //-----------------------------------------------------------------------------
@@ -1790,7 +1825,8 @@
 //-----------------------------------------------------------------------------
 QString KMMessage::to() const
 {
-  return KPIM::normalizeAddressesAndDecodeIDNs( headerField("To") );
+  // handle To same as Cc below, bug 80747
+  return KPIM::normalizeAddressesAndDecodeIDNs( headerFields( "To" ).join( ", " ) );
 }
 
 
@@ -1871,18 +1907,24 @@
 
 
 //-----------------------------------------------------------------------------
-void KMMessage::setFcc(const QString& aStr)
+void KMMessage::setFcc( const QString &aStr )
 {
   setHeaderField( "X-KMail-Fcc", aStr );
 }
 
 //-----------------------------------------------------------------------------
-void KMMessage::setDrafts(const QString& aStr)
+void KMMessage::setDrafts( const QString &aStr )
 {
   mDrafts = aStr;
 }
 
 //-----------------------------------------------------------------------------
+void KMMessage::setTemplates( const QString &aStr )
+{
+  mTemplates = aStr;
+}
+
+//-----------------------------------------------------------------------------
 QString KMMessage::who() const
 {
   if (mParent)
@@ -2174,7 +2216,9 @@
   if ( !mMsg->Headers().FindField( aName ) )
     return QString::null;
 
-  return decodeRFC2047String( mMsg->Headers().FieldBody( aName.data() ).AsString().c_str() );
+  return decodeRFC2047String( mMsg->Headers().FieldBody( aName.data() ).AsString().c_str(),
+                              charset() );
+
 }
 
 QStringList KMMessage::headerFields( const QCString& field ) const
@@ -2185,7 +2229,7 @@
   std::vector<DwFieldBody*> v = mMsg->Headers().AllFieldBodies( field.data() );
   QStringList headerFields;
   for ( uint i = 0; i < v.size(); ++i ) {
-    headerFields.append( decodeRFC2047String( v[i]->AsString().c_str() ) );
+    headerFields.append( decodeRFC2047String( v[i]->AsString().c_str(), charset() ) );
   }
 
   return headerFields;
Index: kmail/configuredialog_p.h
===================================================================
--- kmail/configuredialog_p.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/configuredialog_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,6 +45,18 @@
 class ComposerCryptoConfiguration;
 class WarningConfiguration;
 class SMimeConfiguration;
+class TemplatesConfiguration;
+class CustomTemplates;
+class QGroupBox;
+class QVGroupBox;
+#include <qdict.h>
+class QLineEdit;
+class KMMsgTagDesc;
+class KListBox;
+class KColorCombo;
+class KFontRequester;
+class KIconButton;
+class KKeyButton;
 
 namespace Kpgp {
   class Config;
@@ -632,6 +644,40 @@
   LanguageItemList mLanguageList;
 };
 
+class ComposerPageTemplatesTab : public ConfigModuleTab {
+  Q_OBJECT
+public:
+  ComposerPageTemplatesTab( QWidget * parent=0, const char * name=0 );
+  QString helpAnchor() const;
+
+  void save();
+
+private slots:
+
+private:
+  virtual void doLoadFromGlobalSettings();
+
+private:
+    TemplatesConfiguration* mWidget;
+};
+
+class ComposerPageCustomTemplatesTab : public ConfigModuleTab {
+  Q_OBJECT
+public:
+  ComposerPageCustomTemplatesTab( QWidget * parent=0, const char * name=0 );
+  QString helpAnchor() const;
+
+  void save();
+
+private slots:
+
+private:
+  virtual void doLoadFromGlobalSettings();
+
+private:
+    CustomTemplates* mWidget;
+};
+
 class ComposerPageSubjectTab : public ConfigModuleTab {
   Q_OBJECT
 public:
@@ -734,6 +780,8 @@
   // hrmpf. moc doesn't like nested classes with slots/signals...:
   typedef ComposerPageGeneralTab GeneralTab;
   typedef ComposerPagePhrasesTab PhrasesTab;
+  typedef ComposerPageTemplatesTab TemplatesTab;
+  typedef ComposerPageCustomTemplatesTab CustomTemplatesTab;
   typedef ComposerPageSubjectTab SubjectTab;
   typedef ComposerPageCharsetTab CharsetTab;
   typedef ComposerPageHeadersTab HeadersTab;
@@ -742,6 +790,8 @@
 private:
   GeneralTab  *mGeneralTab;
   PhrasesTab  *mPhrasesTab;
+  TemplatesTab  *mTemplatesTab;
+  CustomTemplatesTab  *mCustomTemplatesTab;
   SubjectTab  *mSubjectTab;
   CharsetTab  *mCharsetTab;
   HeadersTab  *mHeadersTab;
Index: kmail/templateparser.h
===================================================================
--- kmail/templateparser.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templateparser.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,90 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov <dmiceman@mail.ru>
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#ifndef __KMAIL_TEMPLATEPARSER_H__
+#define __KMAIL_TEMPLATEPARSER_H__
+
+#include <qobject.h>
+
+class KMMessage;
+class QString;
+class KMFolder;
+class QObject;
+class KProcess;
+
+class TemplateParser : public QObject
+{
+  Q_OBJECT
+
+  public:
+    enum Mode {
+      NewMessage,
+      Reply,
+      ReplyAll,
+      Forward
+    };
+
+    static const int PipeTimeout = 15;
+
+  public:
+    TemplateParser( KMMessage *amsg, const Mode amode, const QString aselection,
+                    bool aSmartQuote, bool anoQuote, bool aallowDecryption,
+                    bool aselectionIsBody );
+
+    virtual void process( KMMessage *aorig_msg, KMFolder *afolder = NULL, bool append = false );
+    virtual void process( const QString &tmplName, KMMessage *aorig_msg,
+                          KMFolder *afolder = NULL, bool append = false );
+    virtual void processWithTemplate( const QString &tmpl );
+    virtual QString findTemplate();
+    virtual QString findCustomTemplate( const QString &tmpl );
+    virtual QString pipe( const QString &cmd, const QString &buf );
+
+    virtual QString getFName( const QString &str );
+    virtual QString getLName( const QString &str );
+
+  protected:
+    Mode mMode;
+    KMFolder *mFolder;
+    uint mIdentity;
+    KMMessage *mMsg;
+    KMMessage *mOrigMsg;
+    QString mSelection;
+    bool mSmartQuote;
+    bool mNoQuote;
+    bool mAllowDecryption;
+    bool mSelectionIsBody;
+    int mPipeRc;
+    QString mPipeOut;
+    QString mPipeErr;
+    bool mDebug;
+    QString mQuoteString;
+    bool mAppend;
+
+    int parseQuotes( const QString &prefix, const QString &str,
+                     QString &quote ) const;
+
+  protected slots:
+    void onProcessExited( KProcess *proc );
+    void onReceivedStdout( KProcess *proc, char *buffer, int buflen );
+    void onReceivedStderr( KProcess *proc, char *buffer, int buflen );
+    void onWroteStdin( KProcess *proc );
+};
+
+#endif // __KMAIL_TEMPLATEPARSER_H__
Index: kmail/templatesconfiguration_kfg.kcfg
===================================================================
--- kmail/templatesconfiguration_kfg.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesconfiguration_kfg.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<kcfg xmlns="http://www.kde.org/standards/kcfg/1.0"
+      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+      xsi:schemaLocation="http://www.kde.org/standards/kcfg/1.0
+      http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
+  <kcfgfile name="kmailrc">
+    <parameter name="folder" />
+  </kcfgfile>
+
+  <group name="Templates #$(folder)">
+    <entry name="UseCustomTemplates" type="Bool" key="UseCustomTemplates">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default>false</default>
+    </entry>
+    <entry name="TemplateNewMessage" type="String" key="TemplateNewMessage">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="TemplateReply" type="String" key="TemplateReply">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="TemplateReplyAll" type="String" key="TemplateReplyAll">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="TemplateForward" type="String" key="TemplateForward">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+    <entry name="QuoteString" type="String" key="QuoteString">
+      <label></label>
+      <whatsthis></whatsthis>
+      <default></default>
+    </entry>
+  </group>
+
+</kcfg>
Index: kmail/kmail_config_identity.desktop
===================================================================
--- kmail/kmail_config_identity.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Identities
+Name[ar]=الهويات
 Name[be]=Увасабленьні
 Name[bg]=Самоличност
 Name[br]=Anvelezhioù
@@ -60,6 +61,7 @@
 Name[zh_CN]=身份
 Name[zh_TW]=身份
 Comment=Manage Identities
+Comment[ar]=تدبير الهويات
 Comment[be]=Кіраваньне увасабленьнямі
 Comment[bg]=Настройки на самоличността
 Comment[br]=Merañ an anvelezhioù
@@ -117,7 +119,7 @@
 Keywords[es]=kmail,identidad
 Keywords[et]=kmail,identiteet
 Keywords[eu]=kmail,identitatea
-Keywords[fa]=kmail،هویت
+Keywords[fa]=kmail، هویت
 Keywords[fi]=kmail,henkilöllisyys
 Keywords[fr]=KMail,identités
 Keywords[ga]=kmail,aitheantas
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -109,6 +109,7 @@
 #include "redirectdialog.h"
 using KMail::RedirectDialog;
 #include "util.h"
+#include "templateparser.h"
 
 #include "broadcaststatus.h"
 #include "globalsettings.h"
@@ -655,12 +656,13 @@
 KMCommand::Result KMEditMsgCommand::execute()
 {
   KMMessage *msg = retrievedMessage();
-  if (!msg || !msg->parent() ||
-      !kmkernel->folderIsDraftOrOutbox( msg->parent() ))
+  if ( !msg || !msg->parent() ||
+       ( !kmkernel->folderIsDraftOrOutbox( msg->parent() ) &&
+         !kmkernel->folderIsTemplates( msg->parent() ) ) )
     return Failed;
 
   // Remember the old parent, we need it a bit further down to be able
-  // to put the unchanged messsage back in the drafts folder if the nth
+  // to put the unchanged messsage back in the original folder if the nth
   // edit is discarded, for n > 1.
   KMFolder *parent = msg->parent();
   if ( parent )
@@ -675,7 +677,31 @@
   return OK;
 }
 
+KMUseTemplateCommand::KMUseTemplateCommand( QWidget *parent, KMMessage *msg )
+  :KMCommand( parent, msg )
+{
+}
 
+KMCommand::Result KMUseTemplateCommand::execute()
+{
+  KMMessage *msg = retrievedMessage();
+  if ( !msg || !msg->parent() ||
+       !kmkernel->folderIsTemplates( msg->parent() ) )
+    return Failed;
+
+  // Take a copy of the original message, which remains unchanged.
+  KMMessage *newMsg = new KMMessage;
+  newMsg->setComplete( msg->isComplete() );
+  newMsg->fromString( msg->asString() );
+
+  KMail::Composer *win = KMail::makeComposer();
+  newMsg->setTransferInProgress( false ); // From here on on, the composer owns the message.
+  win->setMsg( newMsg, FALSE, TRUE );
+  win->show();
+
+  return OK;
+}
+
 KMShowMsgSrcCommand::KMShowMsgSrcCommand( QWidget *parent,
   KMMessage *msg, bool fixedFont )
   :KMCommand( parent, msg ), mFixedFont( fixedFont )
@@ -811,22 +837,28 @@
     assert( idx >= 0 );
     msg = p->getMsg(idx);
 
-    if (msg->transferInProgress()) {
-      QByteArray data = QByteArray();
-      mJob->sendAsyncData( data );
-    }
-    msg->setTransferInProgress( true );
-    if (msg->isComplete() ) {
-      slotMessageRetrievedForSaving(msg);
+    if ( msg ) {
+      if ( msg->transferInProgress() ) {
+        QByteArray data = QByteArray();
+        mJob->sendAsyncData( data );
+      }
+      msg->setTransferInProgress( true );
+      if (msg->isComplete() ) {
+      slotMessageRetrievedForSaving( msg );
+      } else {
+        // retrieve Message first
+        if ( msg->parent()  && !msg->isComplete() ) {
+          FolderJob *job = msg->parent()->createJob( msg );
+          job->setCancellable( false );
+          connect(job, SIGNAL( messageRetrieved( KMMessage* ) ),
+                  this, SLOT( slotMessageRetrievedForSaving( KMMessage* ) ) );
+          job->start();
+        }
+      }
     } else {
-      // retrieve Message first
-      if (msg->parent()  && !msg->isComplete() ) {
-        FolderJob *job = msg->parent()->createJob(msg);
-        job->setCancellable( false );
-        connect(job, SIGNAL(messageRetrieved(KMMessage*)),
-            this, SLOT(slotMessageRetrievedForSaving(KMMessage*)));
-        job->start();
-      }
+      mJob->slotError( KIO::ERR_ABORTED,
+                       i18n("The message was removed while saving it. "
+                            "It has not been saved.") );
     }
   } else {
     if ( mStandAloneMessage ) {
@@ -1144,14 +1176,14 @@
   if (msgList.count() >= 2) { // Multiple forward
 
     uint id = 0;
-    QCString msgText = "";
+    // QCString msgText = "";
     QPtrList<KMMessage> linklist;
     for ( KMMessage *msg = msgList.first(); msg; msg = msgList.next() ) {
       // set the identity
       if (id == 0)
         id = msg->headerField( "X-KMail-Identity" ).stripWhiteSpace().toUInt();
 
-      msgText += msg->createForwardBody();
+      // msgText += msg->createForwardBody();
       linklist.append( msg );
     }
     if ( id == 0 )
@@ -1160,10 +1192,15 @@
     fwdMsg->initHeader( id );
     fwdMsg->setAutomaticFields( true );
     fwdMsg->setCharset( "utf-8" );
-    fwdMsg->setBody( msgText );
+    // fwdMsg->setBody( msgText );
 
-    for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() )
+    for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
+      TemplateParser parser( fwdMsg, TemplateParser::Forward,
+        msg->body(), false, false, false, false);
+        parser.process( msg, false, true );
+
       fwdMsg->link( msg, KMMsgStatusForwarded );
+    }
 
     KCursorSaver busy( KBusyPtr::busy() );
     KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
@@ -1185,7 +1222,7 @@
     {
       KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
       win->setCharset( fwdMsg->codec()->mimeName(), true );
-      win->setBody( QString::fromUtf8( msg->createForwardBody() ) );
+      // win->setBody( QString::fromUtf8( msg->createForwardBody() ) );
       win->show();
     }
   }
@@ -1374,6 +1411,124 @@
 }
 
 
+KMCustomReplyToCommand::KMCustomReplyToCommand( QWidget *parent, KMMessage *msg,
+                                                const QString &selection,
+                                                const QString &tmpl )
+  : KMCommand( parent, msg ), mSelection( selection ), mTemplate( tmpl )
+{
+}
+
+KMCommand::Result KMCustomReplyToCommand::execute()
+{
+  KCursorSaver busy(KBusyPtr::busy());
+  KMMessage *msg = retrievedMessage();
+  KMMessage *reply = msg->createReply( KMail::ReplySmart, mSelection,
+                                       false, true, false, mTemplate );
+  KMail::Composer * win = KMail::makeComposer( reply );
+  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setReplyFocus();
+  win->show();
+
+  return OK;
+}
+
+
+KMCustomReplyAllToCommand::KMCustomReplyAllToCommand( QWidget *parent, KMMessage *msg,
+                                                      const QString &selection,
+                                                      const QString &tmpl )
+  : KMCommand( parent, msg ), mSelection( selection ), mTemplate( tmpl )
+{
+}
+
+KMCommand::Result KMCustomReplyAllToCommand::execute()
+{
+  KCursorSaver busy(KBusyPtr::busy());
+  KMMessage *msg = retrievedMessage();
+  KMMessage *reply = msg->createReply( KMail::ReplyAll, mSelection,
+                                       false, true, false, mTemplate );
+  KMail::Composer * win = KMail::makeComposer( reply );
+  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setReplyFocus();
+  win->show();
+
+  return OK;
+}
+
+
+KMCustomForwardCommand::KMCustomForwardCommand( QWidget *parent,
+  const QPtrList<KMMsgBase> &msgList, uint identity, const QString &tmpl )
+  : KMCommand( parent, msgList ),
+    mIdentity( identity ), mTemplate( tmpl )
+{
+}
+
+KMCustomForwardCommand::KMCustomForwardCommand( QWidget *parent,
+  KMMessage *msg, uint identity, const QString &tmpl )
+  : KMCommand( parent, msg ),
+    mIdentity( identity ), mTemplate( tmpl )
+{
+}
+
+KMCommand::Result KMCustomForwardCommand::execute()
+{
+  QPtrList<KMMessage> msgList = retrievedMsgs();
+
+  if (msgList.count() >= 2) { // Multiple forward
+
+    uint id = 0;
+    // QCString msgText = "";
+    QPtrList<KMMessage> linklist;
+    for ( KMMessage *msg = msgList.first(); msg; msg = msgList.next() ) {
+      // set the identity
+      if (id == 0)
+        id = msg->headerField( "X-KMail-Identity" ).stripWhiteSpace().toUInt();
+
+      // msgText += msg->createForwardBody();
+      linklist.append( msg );
+    }
+    if ( id == 0 )
+      id = mIdentity; // use folder identity if no message had an id set
+    KMMessage *fwdMsg = new KMMessage;
+    fwdMsg->initHeader( id );
+    fwdMsg->setAutomaticFields( true );
+    fwdMsg->setCharset( "utf-8" );
+    // fwdMsg->setBody( msgText );
+
+    for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
+      TemplateParser parser( fwdMsg, TemplateParser::Forward,
+        msg->body(), false, false, false, false);
+        parser.process( msg, false, true );
+
+      fwdMsg->link( msg, KMMsgStatusForwarded );
+    }
+
+    KCursorSaver busy( KBusyPtr::busy() );
+    KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
+    win->setCharset("");
+    win->show();
+
+  } else { // forward a single message at most
+
+    KMMessage *msg = msgList.getFirst();
+    if ( !msg || !msg->codec() )
+      return Failed;
+
+    KCursorSaver busy( KBusyPtr::busy() );
+    KMMessage *fwdMsg = msg->createForward( mTemplate );
+
+    uint id = msg->headerField( "X-KMail-Identity" ).stripWhiteSpace().toUInt();
+    if ( id == 0 )
+      id = mIdentity;
+    {
+      KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
+      win->setCharset( fwdMsg->codec()->mimeName(), true );
+      win->show();
+    }
+  }
+  return OK;
+}
+
+
 KMPrintCommand::KMPrintCommand( QWidget *parent,
   KMMessage *msg, bool htmlOverride, bool htmlLoadExtOverride,
   bool useFixedFont, const QString & encoding )
@@ -1477,37 +1632,46 @@
                                               KMFilter *filter )
   : KMCommand( parent, msgList ), mFilter( filter  )
 {
+  QPtrListIterator<KMMsgBase> it(msgList);
+  while ( it.current() ) {
+    serNumList.append( (*it)->getMsgSerNum() );
+    ++it;
+  }
 }
 
 KMCommand::Result KMFilterActionCommand::execute()
 {
   KCursorSaver busy( KBusyPtr::busy() );
-  QPtrList<KMMessage> msgList = retrievedMsgs();
 
-  for (KMMessage *msg = msgList.first(); msg; msg = msgList.next())
-    if( msg->parent() )
-      kmkernel->filterMgr()->tempOpenFolder(msg->parent());
-
   int msgCount = 0;
-  int msgCountToFilter = msgList.count();
-  for (KMMessage *msg = msgList.first(); msg; msg = msgList.next()) {
+  int msgCountToFilter = serNumList.count();
+  ProgressItem* progressItem =
+    ProgressManager::createProgressItem ( "filter"+ProgressManager::getUniqueID(),
+                                          i18n( "Filtering messages" ) );
+  progressItem->setTotalItems( msgCountToFilter );
+  QValueList<Q_UINT32>::const_iterator it;
+  for ( it = serNumList.begin(); it != serNumList.end(); it++ ) {
+    Q_UINT32 serNum = *it;
     int diff = msgCountToFilter - ++msgCount;
     if ( diff < 10 || !( msgCount % 20 ) || msgCount <= 10 ) {
+      progressItem->updateProgress();
       QString statusMsg = i18n("Filtering message %1 of %2");
       statusMsg = statusMsg.arg( msgCount ).arg( msgCountToFilter );
       KPIM::BroadcastStatus::instance()->setStatusMsg( statusMsg );
       KApplication::kApplication()->eventLoop()->processEvents( QEventLoop::ExcludeUserInput, 50 );
     }
-    msg->setTransferInProgress(false);
-    int filterResult = kmkernel->filterMgr()->process(msg, mFilter);
+
+    int filterResult = kmkernel->filterMgr()->process( serNum, mFilter );
     if (filterResult == 2) {
       // something went horribly wrong (out of space?)
       perror("Critical error");
       kmkernel->emergencyExit( i18n("Not enough free disk space?" ));
     }
-    msg->setTransferInProgress(true);
+    progressItem->incCompletedItems();
   }
 
+  progressItem->setComplete();
+  progressItem = 0;
   return OK;
 }
 
@@ -1539,8 +1703,9 @@
     for (KMMsgBase *msg = msgList.first(); msg; msg = msgList.next())
       scheduler->execFilters( msg );
   } else {
-    KMCommand *filterCommand = new KMFilterActionCommand( mMainWidget,
-    *mHeaders->selectedMsgs(), mFilter);
+    KMCommand *filterCommand =
+      new KMFilterActionCommand( mMainWidget,
+                                 *mHeaders->selectedMsgs(), mFilter );
     filterCommand->start();
     int contentX, contentY;
     HeaderItem *item = mHeaders->prepareMove( &contentX, &contentY );
Index: kmail/kmatmlistview.cpp
===================================================================
--- kmail/kmatmlistview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmatmlistview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,147 +1,30 @@
 // -*- mode: C++; c-file-style: "gnu" -*-
-// kmcomposewin.cpp
+// kmatmlistview.cpp
 // Author: Markus Wuebben <markus.wuebben@kde.org>
 // This code is published under the GPL.
 
 #include <config.h>
 
 #include "kmatmlistview.h"
-
-#include "kmmainwin.h"
-#include "kmreadermainwin.h"
-#include "messagesender.h"
-#include "kmmsgpartdlg.h"
-#include <kpgpblock.h>
-#include <kaddrbook.h>
-#include "kmaddrbook.h"
-#include "kmmsgdict.h"
-#include "kmfolderimap.h"
-#include "kmfoldermgr.h"
-#include "kmfoldercombobox.h"
-#include "kmtransport.h"
-#include "kmcommands.h"
-#include "kcursorsaver.h"
-#include "partNode.h"
-#include "attachmentlistview.h"
-#include "transportmanager.h"
-using KMail::AttachmentListView;
-#include "dictionarycombobox.h"
-using KMail::DictionaryComboBox;
-#include "addressesdialog.h"
-using KPIM::AddressesDialog;
-#include "addresseeemailselection.h"
-using KPIM::AddresseeEmailSelection;
-using KPIM::AddresseeSelectorDialog;
-#include <maillistdrag.h>
-using KPIM::MailListDrag;
-#include "recentaddresses.h"
-using KRecentAddress::RecentAddresses;
-#include "kleo_util.h"
-#include "stl_util.h"
-#include "recipientseditor.h"
-
-#include "attachmentcollector.h"
-#include "objecttreeparser.h"
-
-#include "kmfoldermaildir.h"
-
-#include <libkpimidentities/identitymanager.h>
-#include <libkpimidentities/identitycombo.h>
-#include <libkpimidentities/identity.h>
-#include <libkdepim/kfileio.h>
-#include <libemailfunctions/email.h>
-#include <kleo/cryptobackendfactory.h>
-#include <kleo/exportjob.h>
-#include <ui/progressdialog.h>
-#include <ui/keyselectiondialog.h>
-
-#include <gpgmepp/context.h>
-#include <gpgmepp/key.h>
-
-#include <kabc/vcardconverter.h>
-#include <libkdepim/kvcarddrag.h>
-#include <kio/netaccess.h>
-
-
-#include "klistboxdialog.h"
-
-#include "messagecomposer.h"
-
-#include <kcharsets.h>
-#include <kcompletionbox.h>
-#include <kcursor.h>
-#include <kcombobox.h>
-#include <kstdaccel.h>
-#include <kpopupmenu.h>
-#include <kedittoolbar.h>
-#include <kkeydialog.h>
-#include <kdebug.h>
-#include <kfiledialog.h>
-#include <kwin.h>
-#include <kinputdialog.h>
-#include <kmessagebox.h>
-#include <kurldrag.h>
-#include <kio/scheduler.h>
-#include <ktempfile.h>
-#include <klocale.h>
-#include <kapplication.h>
-#include <kstatusbar.h>
-#include <kaction.h>
-#include <kstdaction.h>
-#include <kdirwatch.h>
-#include <kstdguiitem.h>
-#include <kiconloader.h>
-#include <kpushbutton.h>
-#include <kuserprofile.h>
-#include <krun.h>
-#include <ktempdir.h>
-//#include <keditlistbox.h>
-#include "globalsettings.h"
-#include "replyphrases.h"
-
-#include <kspell.h>
-#include <kspelldlg.h>
-#include <spellingfilter.h>
-#include <ksyntaxhighlighter.h>
-#include <kcolordialog.h>
-#include <kzip.h>
-#include <ksavefile.h>
-
-#include <qtabdialog.h>
-#include <qregexp.h>
-#include <qbuffer.h>
-#include <qtooltip.h>
-#include <qtextcodec.h>
+#include <qcheckbox.h>
 #include <qheader.h>
-#include <qwhatsthis.h>
-#include <qfontdatabase.h>
 
-#include <mimelib/mimepp.h>
-
-#include <algorithm>
-
-#include <sys/stat.h>
-#include <sys/types.h>
-#include <stdlib.h>
-#include <unistd.h>
-#include <errno.h>
-#include <fcntl.h>
-#include <assert.h>
-
-KMAtmListViewItem::KMAtmListViewItem(QListView *parent)
+KMAtmListViewItem::KMAtmListViewItem( QListView *parent )
   : QObject(),
-    QListViewItem( parent ),
-    mListview( parent ),
-    mCBSignEnabled( false ),
-    mCBEncryptEnabled( false )
+    QListViewItem( parent )
 {
-  mCBEncrypt = new QCheckBox( mListview->viewport() );
-  mCBSign = new QCheckBox( mListview->viewport() );
-  mCBCompress = new QCheckBox( mListview->viewport() );
-  connect( mCBCompress, SIGNAL( clicked() ), this, SLOT( slotCompress() ) );
+  mCBCompress = new QCheckBox( listView()->viewport() );
+  mCBEncrypt = new QCheckBox( listView()->viewport() );
+  mCBSign = new QCheckBox( listView()->viewport() );
+  mCBCompress->setShown( true );
+  updateAllCheckBoxes();
 
-  mCBEncrypt->hide();
-  mCBSign->hide();
+  connect( mCBCompress, SIGNAL( clicked() ), this, SLOT( slotCompress() ) );
+  connect( listView()->header(), SIGNAL( sizeChange(int, int, int) ),
+           SLOT( slotHeaderChange( int, int, int ) ) );
+  connect( listView()->header(), SIGNAL( indexChange(int, int, int) ),
+           SLOT( slotHeaderChange( int, int, int ) ) );
+  connect( listView()->header(), SIGNAL( clicked( int ) ), SLOT( slotHeaderClick( int ) ) );
 }
 
 KMAtmListViewItem::~KMAtmListViewItem()
@@ -154,118 +37,110 @@
   mCBCompress = 0;
 }
 
-void KMAtmListViewItem::paintCell( QPainter * p, const QColorGroup & cg,
-                                  int column, int width, int align )
+void KMAtmListViewItem::updateCheckBox( int headerSection, QCheckBox *cb )
 {
-  // this is also called for the encrypt/sign columns to assure that the
-  // background is cleared
-  QListViewItem::paintCell( p, cg, column, width, align );
-  if ( 4 == column ) {
-    QRect r = mListview->itemRect( this );
-    if ( !r.size().isValid() ) {
-        mListview->ensureItemVisible( this );
-        mListview->repaintContents( FALSE );
-        r = mListview->itemRect( this );
-    }
-    int colWidth = mListview->header()->sectionSize( column );
-    r.setX( mListview->header()->sectionPos( column )
-            - mListview->header()->offset()
-            + colWidth / 2
-            - r.height() / 2
-            - 1 );
-    r.setY( r.y() + 1 );
-    r.setWidth(  r.height() - 2 );
-    r.setHeight( r.height() - 2 );
-    r = QRect( mListview->viewportToContents( r.topLeft() ), r.size() );
+  //Calculate some values to determine the x-position where the checkbox
+  //will be drawn
+  int sectionWidth = listView()->header()->sectionSize( headerSection );
+  int sectionPos = listView()->header()->sectionPos( headerSection );
+  int sectionOffset = sectionWidth / 2 - height() / 4;
 
-    mCBCompress->resize( r.size() );
-    mListview->moveChild( mCBCompress, r.x(), r.y() );
+  //Resize and move the checkbox
+  cb->resize( sectionWidth - sectionOffset - 1, height() - 2 );
+  listView()->moveChild( cb, sectionPos + sectionOffset, itemPos() + 1 );
 
-    QColor bg;
-    if (isSelected())
-      bg = cg.highlight();
-    else
-      bg = cg.base();
-
-    mCBCompress->setPaletteBackgroundColor(bg);
-    mCBCompress->show();
+  //Set the correct background color
+  QColor bg;
+  if ( isSelected() ) {
+    bg = listView()->colorGroup().highlight();
+  } else {
+    bg = listView()->colorGroup().base();
   }
-  if( 5 == column || 6 == column ) {
-    QRect r = mListview->itemRect( this );
-    if ( !r.size().isValid() ) {
-        mListview->ensureItemVisible( this );
-        mListview->repaintContents( FALSE );
-        r = mListview->itemRect( this );
-    }
-    int colWidth = mListview->header()->sectionSize( column );
-    r.setX( mListview->header()->sectionPos( column )
-            + colWidth / 2
-            - r.height() / 2
-            - 1 );
-    r.setY( r.y() + 1 );
-    r.setWidth(  r.height() - 2 );
-    r.setHeight( r.height() - 2 );
-    r = QRect( mListview->viewportToContents( r.topLeft() ), r.size() );
+  cb->setPaletteBackgroundColor( bg );
+}
 
-    QCheckBox* cb = (5 == column) ? mCBEncrypt : mCBSign;
-    cb->resize( r.size() );
-    mListview->moveChild( cb, r.x(), r.y() );
+void KMAtmListViewItem::updateAllCheckBoxes()
+{
+  updateCheckBox( 4, mCBCompress );
+  updateCheckBox( 5, mCBEncrypt );
+  updateCheckBox( 6, mCBSign );
+}
 
-    QColor bg;
-    if (isSelected())
-      bg = cg.highlight();
-    else
-      bg = cg.base();
-
-    bool enabled = (5 == column) ? mCBEncryptEnabled : mCBSignEnabled;
-    cb->setPaletteBackgroundColor(bg);
-    if (enabled) cb->show();
+// Each time a cell is about to be painted, the item's checkboxes are updated
+// as well. This is necessary to keep the positions of the checkboxes
+// up-to-date. The signals which are, in the constructor of this class,
+// connected to the update slots are not sufficent because unfortunatly,
+// Qt does not provide a signal for changed item positions, e.g. during
+// deleting or adding items. The problem with this is that this function does
+// not catch updates which are off-screen, which means under some circumstances
+// checkboxes have invalid positions. This should not happen anymore, but was
+// the cause of bug 113458. Therefore, both the signals connected in the
+// constructor and this function are necessary to keep the checkboxes'
+// positions in sync, and hopefully is enough.
+void KMAtmListViewItem::paintCell ( QPainter * p, const QColorGroup &cg,
+                                    int column, int width, int align )
+{
+  switch ( column ) {
+    case 4: updateCheckBox( 4, mCBCompress ); break;
+    case 5: updateCheckBox( 5, mCBEncrypt ); break;
+    case 6: updateCheckBox( 6, mCBSign ); break;
   }
+
+  QListViewItem::paintCell( p, cg, column, width, align );
 }
 
-void KMAtmListViewItem::enableCryptoCBs(bool on)
+int KMAtmListViewItem::compare( QListViewItem *i, int col, bool ascending ) const
 {
-  if( mCBEncrypt ) {
-    mCBEncryptEnabled = on;
-    mCBEncrypt->setEnabled( on );
-    mCBEncrypt->setShown( on );
+  if ( col != 1 ) {
+    return QListViewItem::compare( i, col, ascending );
   }
-  if( mCBSign ) {
-    mCBSignEnabled = on;
-    mCBSign->setEnabled( on );
-    mCBSign->setShown( on );
-  }
+
+  return mAttachmentSize -
+    (static_cast<KMAtmListViewItem*>(i))->mAttachmentSize;
 }
 
-void KMAtmListViewItem::setEncrypt(bool on)
+void KMAtmListViewItem::enableCryptoCBs( bool on )
 {
-  if( mCBEncrypt )
+  // Show/Hide the appropriate checkboxes.
+  // This should not be necessary because the caller hides the columns
+  // containing the checkboxes anyway.
+  mCBEncrypt->setShown( on );
+  mCBSign->setShown( on );
+}
+
+void KMAtmListViewItem::setEncrypt( bool on )
+{
+  if ( mCBEncrypt ) {
     mCBEncrypt->setChecked( on );
+  }
 }
 
 bool KMAtmListViewItem::isEncrypt()
 {
-  if( mCBEncrypt )
+  if ( mCBEncrypt ) {
     return mCBEncrypt->isChecked();
-  else
+  } else {
     return false;
+  }
 }
 
-void KMAtmListViewItem::setSign(bool on)
+void KMAtmListViewItem::setSign( bool on )
 {
-  if( mCBSign )
+  if ( mCBSign ) {
     mCBSign->setChecked( on );
+  }
 }
 
 bool KMAtmListViewItem::isSign()
 {
-  if( mCBSign )
+  if ( mCBSign ) {
     return mCBSign->isChecked();
-  else
+  } else {
     return false;
+  }
 }
 
-void KMAtmListViewItem::setCompress(bool on)
+void KMAtmListViewItem::setCompress( bool on )
 {
   mCBCompress->setChecked( on );
 }
@@ -277,10 +152,24 @@
 
 void KMAtmListViewItem::slotCompress()
 {
-    if ( mCBCompress->isChecked() )
-        emit compress( itemPos() );
-    else
-        emit uncompress( itemPos() );
+  if ( mCBCompress->isChecked() ) {
+    emit compress( itemPos() );
+  } else {
+    emit uncompress( itemPos() );
+  }
 }
 
+// Update the item's checkboxes when the position of those change
+// due to different column positions
+void KMAtmListViewItem::slotHeaderChange ( int, int, int )
+{
+  updateAllCheckBoxes();
+}
+
+//Update the item's checkboxes when the list is being sorted
+void KMAtmListViewItem::slotHeaderClick( int )
+{
+  updateAllCheckBoxes();
+}
+
 #include "kmatmlistview.moc"
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -75,6 +75,7 @@
 #include <globalsettings.h>
 
 #define UIDCACHE_VERSION 1
+#define MAIL_LOSS_DEBUGGING 0
 
 static QString incidencesForToString( KMFolderCachedImap::IncidencesFor r ) {
   switch (r) {
@@ -146,6 +147,7 @@
     mIsSelected( false ),
     mCheckFlags( true ), mReadOnly( false ), mAccount( NULL ), uidMapDirty( true ),
     uidWriteTimer( -1 ), mLastUid( 0 ), mTentativeHighestUid( 0 ),
+    mFoundAnIMAPDigest( false ),
     mUserRights( 0 ), mSilentUpload( false ),
     mFolderRemoved( false ),
     /*mHoldSyncs( false ),*/ mRecurse( true ),
@@ -153,7 +155,18 @@
     mIncidencesForChanged( false ), mPersonalNamespacesCheckDone( true )
 {
   setUidValidity("");
-  readUidCache();
+  // if we fail to read a uid file but there is one, nuke it
+  if ( readUidCache() == -1 ) {
+    if ( QFile::exists( uidCacheLocation() ) ) {
+        KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be read. There "
+              "could be a problem with file system permission, or it is corrupted."
+              ).arg( folder->prettyURL() ) );
+        // try to unlink it, in case it was corruped. If it couldn't be read
+        // because of permissions, this will fail, which is fine
+        unlink( QFile::encodeName( uidCacheLocation() ) );
+    }
+  }
 
   mProgress = 0;
 }
@@ -306,7 +319,7 @@
   if( uidValidity().isEmpty() || uidValidity() == "INVALID" ) {
     // No info from the server yet, remove the file.
     if( QFile::exists( uidCacheLocation() ) )
-      unlink( QFile::encodeName( uidCacheLocation() ) );
+      return unlink( QFile::encodeName( uidCacheLocation() ) );
     return 0;
   }
 
@@ -317,17 +330,23 @@
     str << uidValidity() << endl;
     str << lastUid() << endl;
     uidcache.flush();
-    fsync( uidcache.handle() ); /* this is probably overkill */
-    uidcache.close();
-    return 0;
-  } else {
-    return errno; /* does QFile set errno? */
+    if ( uidcache.status() == IO_Ok ) {
+      fsync( uidcache.handle() ); /* this is probably overkill */
+      uidcache.close();
+      if ( uidcache.status() == IO_Ok )
+        return 0;
+    }
   }
+  KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be written. There "
+              "could be a problem with file system permission." ).arg( folder()->prettyURL() ) );
+
+  return -1;
 }
 
 void KMFolderCachedImap::reloadUidMap()
 {
-  kdDebug(5006) << "Reloading Uid Map " << endl;
+  //kdDebug(5006) << "Reloading Uid Map " << endl;
   uidMap.clear();
   open();
   for( int i = 0; i < count(); ++i ) {
@@ -448,7 +467,8 @@
 {
   killTimer( uidWriteTimer );
   uidWriteTimer = -1;
-  writeUidCache();
+  if ( writeUidCache() == -1 )
+    unlink( QFile::encodeName( uidCacheLocation() ) );
 }
 
 ulong KMFolderCachedImap::lastUid()
@@ -467,10 +487,22 @@
   QMap<ulong,int>::Iterator it = uidMap.find( uid );
   if( it != uidMap.end() ) {
     KMMsgBase *msg = getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
+    kdDebug(5006) << "UID " << uid << " is supposed to be in the map" << endl;
+    kdDebug(5006) << "UID's index is to be " << *it << endl;
+    kdDebug(5006) << "There is a message there? " << (msg != 0) << endl;
+    if ( msg ) {
+      kdDebug(5006) << "Its UID is: " << msg->UID() << endl;
+    }
+#endif
+
     if( msg && msg->UID() == uid )
       return msg;
+    kdDebug(5006) << "########## Didn't find uid: " << uid << "in cache athough it's supposed to be there!" << endl;
   } else {
+#if MAIL_LOSS_DEBUGGING
     kdDebug(5006) << "Didn't find uid: " << uid << "in cache!" << endl;
+#endif
   }
   // Not found by now
  // if( mapReloaded )
@@ -482,8 +514,10 @@
   if( it != uidMap.end() )
     // Since the uid map is just rebuilt, no need for the sanity check
     return getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
   else
     kdDebug(5006) << "Reloaded, but stil didn't find uid: " << uid << endl;
+#endif
   // Then it's not here
   return 0;
 }
@@ -841,9 +875,14 @@
            to be deleted on the server has been deleted, adjust our local notion of the
            highes uid seen thus far. */
         slotUpdateLastUid();
-        if( mLastUid == 0 && uidWriteTimer == -1 )
+        if( mLastUid == 0 && uidWriteTimer == -1 ) {
           // This is probably a new and empty folder. Write the UID cache
-          writeUidCache();
+          if ( writeUidCache() == -1 ) {
+            resetSyncState();
+            emit folderComplete( this, false );
+            return;
+          }
+        }
       }
     }
 
@@ -1209,9 +1248,10 @@
 void KMFolderCachedImap::slotImapStatusChanged(KMFolder* folder, const QString&, bool cont)
 {
   if ( mSyncState == SYNC_STATE_INITIAL ){
-      kdDebug(5006) << "IMAP status changed but reset " << endl;
+      //kdDebug(5006) << "IMAP status changed but reset " << endl;
       return; // we were reset
   }
+  //kdDebug(5006) << "IMAP status changed for folder: " << folder->prettyURL() << endl;
   if ( folder->storage() == this ) {
     --mStatusFlagsJobs;
     if ( mStatusFlagsJobs == 0 || !cont ) // done or aborting
@@ -1220,6 +1260,7 @@
     if ( mStatusFlagsJobs == 0 && cont ) {
       mProgress += 5;
       serverSyncInternal();
+      //kdDebug(5006) << "Proceeding with mailcheck." << endl;
     }
   }
 }
@@ -1288,15 +1329,24 @@
   // them one by one because the index list can get resized under
   // us. So use msg pointers instead
 
+  QStringList uids;
   QMap<ulong,int>::const_iterator it = uidMap.constBegin();
   for( ; it != uidMap.end(); it++ ) {
     ulong uid ( it.key() );
-    if( uid!=0 && !uidsOnServer.find( uid ) )
+    if( uid!=0 && !uidsOnServer.find( uid ) ) {
+      uids << QString::number( uid );
       msgsForDeletion.append( getMsg( *it ) );
+    }
   }
 
   if( !msgsForDeletion.isEmpty() ) {
-    removeMsg( msgsForDeletion );
+#if MAIL_LOSS_DEBUGGING
+      if ( KMessageBox::warningYesNo(
+             0, i18n( "<qt><p>Mails on the server in folder <b>%1</b> were deleted. "
+                 "Do you want to delete them locally?<br>UIDs: %2</p></qt>" )
+             .arg( folder()->prettyURL() ).arg( uids.join(",") ) ) == KMessageBox::Yes )
+#endif
+        removeMsg( msgsForDeletion );
   }
 
   /* Delete messages from the server that we dont have anymore */
@@ -1370,6 +1420,8 @@
   uidsForDeletionOnServer.clear();
   mMsgsForDownload.clear();
   mUidsForDownload.clear();
+  // listing is only considered successful if saw a syntactically correct imapdigest
+  mFoundAnIMAPDigest = false;
 
   CachedImapJob* job = new CachedImapJob( FolderJob::tListMessages, this );
   connect( job, SIGNAL( result(KMail::FolderJob *) ),
@@ -1415,6 +1467,7 @@
       setReadOnly( access == "Read only" );
     }
     (*it).cdata.remove(0, pos);
+    mFoundAnIMAPDigest = true;
   }
   pos = (*it).cdata.find("\r\n--IMAPDIGEST", 1);
   // Start with something largish when rebuilding the cache
@@ -1432,7 +1485,7 @@
       if( uid != 0 ) {
         if ( uidsOnServer.count() == uidsOnServer.size() ) {
           uidsOnServer.resize( KMail::nextPrime( uidsOnServer.size() * 2 ) );
-          kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
+          //kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
         }
         uidsOnServer.insert( uid, &v );
       }
@@ -1451,7 +1504,9 @@
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
           if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
-            // kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#if MAIL_LOSS_DEBUGGING
+            kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#endif
             uidsForDeletionOnServer << uid;
           } else {
             redownload = true;
@@ -1490,6 +1545,13 @@
 void KMFolderCachedImap::getMessagesResult( KMail::FolderJob *job, bool lastSet )
 {
   mProgress += 10;
+  if ( !job->error() && !mFoundAnIMAPDigest ) {
+      kdWarning(5006) << "######## Folderlisting did not complete, but there was no error! "
+          "Aborting sync of folder: " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+      kmkernel->emergencyExit( i18n("Folder listing failed in interesting ways." ) );
+#endif
+  }
   if( job->error() ) { // error listing messages but the user chose to continue
     mContentState = imapNoInformation;
     mSyncState = SYNC_STATE_HANDLE_INBOX; // be sure not to continue in this folder
@@ -1741,7 +1803,7 @@
   KMFolderNode *node;
   bool root = ( this == mAccount->rootFolder() );
   if ( root && !mAccount->hasInbox() ) {
-    kdDebug(5006) << "check INBOX" << endl;
+    //kdDebug(5006) << "check INBOX" << endl;
     // create the INBOX
     for (node = folder()->child()->first(); node; node = folder()->child()->next())
       if (!node->isDir() && node->name() == "INBOX") break;
@@ -2216,7 +2278,9 @@
 void
 KMFolderCachedImap::slotAnnotationChanged( const QString& entry, const QString& attribute, const QString& value )
 {
-  kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
+  Q_UNUSED( attribute );
+  Q_UNUSED( value );
+  //kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
   if ( entry == KOLAB_FOLDERTYPE )
     mAnnotationFolderTypeChanged = false;
   else if ( entry == KOLAB_INCIDENCESFOR ) {
Index: kmail/kmail_part.rc
===================================================================
--- kmail/kmail_part.rc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,13 +2,14 @@
      the same menu entries at the same place in KMail and Kontact  -->
 
 <!DOCTYPE kpartgui>
-<kpartgui version="7" name="kmail_part" >
+<kpartgui version="11" name="kmail_part" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
    <Menu name="file_new" >
      <text>New</text>
      <Action name="new_message" />
+     <Action name="new_from_template" />
      <Separator/>
      <!-- Action name="new_todo" />
         etc -->
@@ -126,11 +127,7 @@
    <Action name="move_to" />
    <Separator/> 
    <Action name="set_status" />
-   <Menu name="menubar_message_mark_thread_as">
-     <text>Mark Thread as</text>
-     <Action name="thread_watched" />
-     <Action name="thread_ignored" />
-   </Menu>
+   <Action name="thread_status" />
    <Separator/>
    <Action name="create_filter"/>
    <Menu name="apply_filter_actions" >
Index: kmail/eventsrc
===================================================================
--- kmail/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/eventsrc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -9,6 +9,7 @@
 
 [new-mail-arrived]
 Name=New Mail Arrived
+Name[ar]=وصل بريد جديد
 Name[bg]=Имате ново писмо
 Name[br]=Deuet eo ur postel nevez
 Name[bs]=Stigla vam je nova pošta
@@ -55,6 +56,7 @@
 Name[zh_CN]=新邮件到达
 Name[zh_TW]=您有新郵件
 Comment=New mail arrived
+Comment[ar]=وصل بريد جديد
 Comment[bg]=Имате ново писмо
 Comment[br]=Deuet eo ur postel nevez
 Comment[bs]=Stigla vam je nova pošta
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,6 +52,7 @@
 #include "folderIface.h"
 using KMail::FolderIface;
 #include "jobscheduler.h"
+#include "templateparser.h"
 
 #include <kapplication.h>
 #include <kmessagebox.h>
@@ -111,6 +112,7 @@
   the_sentFolder = 0;
   the_trashFolder = 0;
   the_draftsFolder = 0;
+  the_templatesFolder = 0;
 
   the_folderMgr = 0;
   the_imapFolderMgr = 0;
@@ -192,6 +194,7 @@
 bool KMKernel::handleCommandLine( bool noArgsOpensReader )
 {
   QString to, cc, bcc, subj, body;
+  QCStringList customHeaders;
   KURL messageFile;
   KURL::List attachURLs;
   bool mailto = false;
@@ -252,6 +255,8 @@
          attachURLs += KURL( QString::fromLocal8Bit( *it ) );
   }
 
+  customHeaders = args->getOptionList("header");
+
   if (args->isSet("composer"))
     mailto = true;
 
@@ -302,7 +307,7 @@
     viewMessage( messageFile );
   else
     action( mailto, checkMail, to, cc, bcc, subj, body, messageFile,
-            attachURLs );
+            attachURLs, customHeaders );
   return true;
 }
 
@@ -330,7 +335,7 @@
 
 void KMKernel::openReader( bool onlyCheck )
 {
-  KMMainWin *mWin = 0;
+  mWin = 0;
   KMainWindow *ktmw = 0;
   kdDebug(5006) << "KMKernel::openReader called" << endl;
 
@@ -346,8 +351,7 @@
     activate = !onlyCheck; // existing window: only activate if not --check
     if ( activate )
        mWin->show();
-  }
-  else {
+  } else {
     mWin = new KMMainWin;
     mWin->show();
     activate = false; // new window: no explicit activation (#73591)
@@ -366,7 +370,8 @@
                             const QString &bcc, const QString &subject,
                             const QString &body, int hidden,
                             const KURL &messageFile,
-                            const KURL::List &attachURLs)
+                            const KURL::List &attachURLs,
+                            const QCStringList &customHeaders)
 {
   kdDebug(5006) << "KMKernel::openComposer called" << endl;
   KMMessage *msg = new KMMessage;
@@ -383,12 +388,42 @@
   if (!subject.isEmpty()) msg->setSubject(subject);
   if (!messageFile.isEmpty() && messageFile.isLocalFile()) {
     QCString str = KPIM::kFileToString( messageFile.path(), true, false );
-    if( !str.isEmpty() )
+    if( !str.isEmpty() ) {
       msg->setBody( QString::fromLocal8Bit( str ).utf8() );
+    } else {
+      TemplateParser parser( msg, TemplateParser::NewMessage,
+	"", false, false, false, false );
+      parser.process( NULL, NULL );
+    }
   }
   else if (!body.isEmpty())
+  {
     msg->setBody(body.utf8());
+  }
+  else
+  {
+    TemplateParser parser( msg, TemplateParser::NewMessage,
+      "", false, false, false, false );
+    parser.process( NULL, NULL );
+  }
 
+  if (!customHeaders.isEmpty())
+  {
+    for ( QCStringList::ConstIterator it = customHeaders.begin() ; it != customHeaders.end() ; ++it )
+      if ( !(*it).isEmpty() )
+      {
+        const int pos = (*it).find( ':' );
+        if ( pos > 0 )
+        {
+          QCString header, value;
+          header = (*it).left( pos ).stripWhiteSpace();
+          value = (*it).mid( pos+1 ).stripWhiteSpace();
+          if ( !header.isEmpty() && !value.isEmpty() )
+            msg->setHeaderField( header, value );
+        }
+      }
+  }
+
   KMail::Composer * cWin = KMail::makeComposer( msg );
   cWin->setCharset("", TRUE);
   for ( KURL::List::ConstIterator it = attachURLs.begin() ; it != attachURLs.end() ; ++it )
@@ -448,7 +483,13 @@
   if ( !bcc.isEmpty() ) msg->setBcc(bcc);
   if ( !subject.isEmpty() ) msg->setSubject(subject);
   if ( !to.isEmpty() ) msg->setTo(to);
-  if ( !body.isEmpty() ) msg->setBody(body.utf8());
+  if ( !body.isEmpty() ) {
+    msg->setBody(body.utf8());
+  } else {
+    TemplateParser parser( msg, TemplateParser::NewMessage,
+      "", false, false, false, false );
+    parser.process( NULL, NULL );
+  }
 
   bool iCalAutoSend = false;
   bool noWordWrap = false;
@@ -543,7 +584,13 @@
   if (!bcc.isEmpty()) msg->setBcc(bcc);
   if (!subject.isEmpty()) msg->setSubject(subject);
   if (!to.isEmpty()) msg->setTo(to);
-  if (!body.isEmpty()) msg->setBody(body.utf8());
+  if (!body.isEmpty()) {
+    msg->setBody(body.utf8());
+  } else {
+    TemplateParser parser( msg, TemplateParser::NewMessage,
+      "", false, false, false, false );
+    parser.process( NULL, NULL );
+  }
 
   KMail::Composer * cWin = KMail::makeComposer( msg );
   cWin->setCharset("", TRUE);
@@ -569,16 +616,16 @@
 {
   KMail::Composer * win = 0;
   KMMessage *msg = new KMMessage;
+  KMFolder *folder = NULL;
+  uint id;
 
   if ( useFolderId ) {
     //create message with required folder identity
-    KMFolder *folder = currentFolder();
-    uint id = folder ? folder->identity() : 0;
+    folder = currentFolder();
+    id = folder ? folder->identity() : 0;
     msg->initHeader( id );
-    win = makeComposer( msg, id );
   } else {
     msg->initHeader();
-    win = makeComposer( msg );
   }
   msg->setCharset("utf-8");
   //set basic headers
@@ -586,10 +633,23 @@
   if (!cc.isEmpty()) msg->setCc(cc);
   if (!bcc.isEmpty()) msg->setBcc(bcc);
 
+  if ( useFolderId ) {
+    TemplateParser parser( msg, TemplateParser::NewMessage,
+      "", false, false, false, false );
+    parser.process( NULL, folder );
+    win = makeComposer( msg, id );
+  } else {
+    TemplateParser parser( msg, TemplateParser::NewMessage,
+      "", false, false, false, false );
+    parser.process( NULL, folder );
+    win = makeComposer( msg );
+  }
+
   //Add the attachment if we have one
   if(!attachURL.isEmpty() && attachURL.isValid()) {
     win->addAttach(attachURL);
   }
+
   //only show window when required
   if(!hidden) {
     win->show();
@@ -761,8 +821,7 @@
               tmp_fname = "/" + *it;
             }
             else return -1;
-          }
-          else {
+          } else {
             subfolder = folder->createChildFolder();
             tmp_fname += "/" + *it;
             if(!the_folderMgr->getFolderByURL( tmp_fname )) {
@@ -776,8 +835,7 @@
         mAddMsgCurrentFolder = the_folderMgr->getFolderByURL( tmp_fname );
         if(!folder) return -1;
 
-      }
-      else {
+      } else {
         mAddMsgCurrentFolder = the_folderMgr->findOrCreate(_foldername, false);
       }
     }
@@ -941,8 +999,7 @@
               tmp_fname = "/" + *it;
             }
             else return -1;
-          }
-          else {
+          } else {
             subfolder = folder->createChildFolder();
             tmp_fname += "/" + *it;
             if(!the_folderMgr->getFolderByURL( tmp_fname )) {
@@ -955,8 +1012,7 @@
       mAddMsgCurrentFolder = the_folderMgr->getFolderByURL( tmp_fname );
       if(!folder) return -1;
 
-      }
-      else {
+      } else {
         mAddMsgCurrentFolder = the_folderMgr->findOrCreate(_foldername, false);
       }
     }
@@ -1354,7 +1410,7 @@
   if (the_trashFolder->canAccess() != 0) {
     emergencyExit( i18n("You do not have read/write permission to your trash folder.") );
   }
-  the_trashFolder->setSystemFolder(TRUE);
+  the_trashFolder->setSystemFolder( TRUE );
   if ( the_trashFolder->userWhoField().isEmpty() )
     the_trashFolder->setUserWhoField( QString::null );
   // the_trashFolder->open();
@@ -1363,10 +1419,21 @@
   if (the_draftsFolder->canAccess() != 0) {
     emergencyExit( i18n("You do not have read/write permission to your drafts folder.") );
   }
-  the_draftsFolder->setSystemFolder(TRUE);
+  the_draftsFolder->setSystemFolder( TRUE );
   if ( the_draftsFolder->userWhoField().isEmpty() )
     the_draftsFolder->setUserWhoField( QString::null );
   the_draftsFolder->open();
+
+  the_templatesFolder =
+    the_folderMgr->findOrCreate( cfg->readEntry( "templatesFolder",
+                                                 I18N_NOOP("templates") ) );
+  if ( the_templatesFolder->canAccess() != 0 ) {
+    emergencyExit( i18n("You do not have read/write permission to your templates folder.") );
+  }
+  the_templatesFolder->setSystemFolder( TRUE );
+  if ( the_templatesFolder->userWhoField().isEmpty() )
+    the_templatesFolder->setUserWhoField( QString::null );
+  the_templatesFolder->open();
 }
 
 
@@ -1652,7 +1719,8 @@
   the_searchFolderMgr = 0;
   delete mConfigureDialog;
   mConfigureDialog = 0;
-  delete mWin;
+  // do not delete, because mWin may point to an existing window
+  // delete mWin;
   mWin = 0;
 
   if ( RecentAddresses::exists() )
@@ -1709,8 +1777,7 @@
                 "files now?</strong></qt>" )
           .arg( kmailName, kmailName, kmailName )
           .arg( dir, destinationDir, dir, destinationDir );
-  }
-  else {
+  } else {
     msg = i18n( "%1-%3 is the application name, %4-%6 are folder path",
                 "<qt>The <i>%4</i> folder exists. "
                 "%1 now uses the <i>%5</i> folder for "
@@ -1802,14 +1869,15 @@
                       const QString &cc, const QString &bcc,
                       const QString &subj, const QString &body,
                       const KURL &messageFile,
-                      const KURL::List &attachURLs)
+                      const KURL::List &attachURLs,
+                      const QCStringList &customHeaders)
 {
-  if (mailto)
-    openComposer (to, cc, bcc, subj, body, 0, messageFile, attachURLs);
+  if ( mailto )
+    openComposer( to, cc, bcc, subj, body, 0, messageFile, attachURLs, customHeaders );
   else
     openReader( check );
 
-  if (check)
+  if ( check )
     checkMail();
   //Anything else?
 }
@@ -1937,8 +2005,7 @@
   QString mesg;
   if ( reason.length() == 0 ) {
     mesg = i18n("KMail encountered a fatal error and will terminate now");
-  }
-  else {
+  } else {
     mesg = i18n("KMail encountered a fatal error and will "
                       "terminate now.\nThe error was:\n%1").arg( reason );
   }
@@ -1967,15 +2034,35 @@
     return true;
 
   QString idString = folder->idString();
-  if ( idString.isEmpty() ) return false;
+  if ( idString.isEmpty() )
+    return false;
 
   // search the identities if the folder matches the drafts-folder
-  const KPIM::IdentityManager * im = identityManager();
-  for( KPIM::IdentityManager::ConstIterator it = im->begin(); it != im->end(); ++it )
-    if ( (*it).drafts() == idString ) return true;
+  const KPIM::IdentityManager *im = identityManager();
+  for ( KPIM::IdentityManager::ConstIterator it=im->begin(); it != im->end(); ++it )
+    if ( (*it).drafts() == idString )
+      return true;
   return false;
 }
 
+bool KMKernel::folderIsTemplates( const KMFolder *folder )
+{
+  assert( folder );
+  if ( folder == the_templatesFolder )
+    return true;
+
+  QString idString = folder->idString();
+  if ( idString.isEmpty() )
+    return false;
+
+  // search the identities if the folder matches the templates-folder
+  const KPIM::IdentityManager *im = identityManager();
+  for ( KPIM::IdentityManager::ConstIterator it=im->begin(); it != im->end(); ++it )
+    if ( (*it).templates() == idString )
+      return true;
+  return false;
+}
+
 bool KMKernel::folderIsTrash(KMFolder * folder)
 {
   assert(folder);
@@ -2247,9 +2334,15 @@
   if ( !Wallet::isEnabled() || walletOpenFailed )
     return 0;
 
+  // find an appropriate parent window for the wallet dialog
+  WId window = 0;
+  if ( qApp->activeWindow() )
+    window = qApp->activeWindow()->winId();
+  else if ( getKMMainWidget() )
+    window = getKMMainWidget()->topLevelWidget()->winId();
+
   delete mWallet;
-  mWallet = Wallet::openWallet( Wallet::NetworkWallet(),
-        getKMMainWidget() ? getKMMainWidget()->topLevelWidget()->winId() : 0 );
+  mWallet = Wallet::openWallet( Wallet::NetworkWallet(), window );
 
   if ( !mWallet ) {
     walletOpenFailed = true;
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/headerstyle.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -527,6 +527,40 @@
       userHTML = "&nbsp;";
     }
 
+    if( photoURL.isEmpty() ) {
+      // no photo, look for a Face header
+      QString faceheader = message->headerField( "Face" );
+      if ( !faceheader.isEmpty() ) {
+        QImage faceimage;
+
+        kdDebug( 5006 ) << "Found Face: header" << endl;
+
+        QCString facestring = faceheader.utf8();
+        // Spec says header should be less than 998 bytes
+        // Face: is 5 characters
+        if ( facestring.length() < 993 ) {
+          QByteArray facearray;
+          KCodecs::base64Decode(facestring, facearray);
+    
+          QImage faceimage;
+          if ( faceimage.loadFromData( facearray, "png" ) ) {
+            // Spec says image must be 48x48 pixels
+            if ( (48 == faceimage.width()) && (48 == faceimage.height()) ) {
+              photoURL = imgToDataUrl( faceimage );
+              photoWidth = 48;
+              photoHeight = 48;
+            } else {
+              kdDebug( 5006 ) << "Face: header image is" << faceimage.width() << "by" << faceimage.height() <<"not 48x48 Pixels" << endl;
+            }
+          } else {
+            kdDebug( 5006 ) << "Failed to load decoded png from Face: header" << endl;
+          }
+        } else {
+          kdDebug( 5006 ) << "Face: header too long at " << facestring.length() << endl;
+        }
+      }
+    }
+
     if( photoURL.isEmpty() )
     {
       // no photo, look for a X-Face header
Index: kmail/kmail.kcfg
===================================================================
--- kmail/kmail.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,6 +5,7 @@
       http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
   <include>kmglobal.h</include>
   <include>qtextcodec.h</include>
+  <include>templatesconfiguration.h</include>
   <kcfgfile name="kmailrc"/>
     <group name="Behaviour">
       <entry name="DelayedMarkAsRead"  type="Bool">
@@ -360,6 +361,7 @@
         <label>Maximum number of recipient editor lines.</label>
         <default>200</default>
       </entry>
+      <entry name="CustomTemplates" type="StringList" key="CustomTemplates" />
     </group>
 <!-- Composer -->
 
@@ -451,4 +453,37 @@
       </entry>
     </group>
 
+  <group name="GlobalTemplates">
+    <entry name="PhrasesConverted" type="Bool" key="PhrasesConverted">
+      <label>Phrases has been converted to templates</label>
+      <whatsthis>Old phrases have been converted to templates</whatsthis>
+      <default>false</default>
+    </entry>
+    <entry name="TemplateNewMessage" type="String" key="TemplateNewMessage">
+      <label>Message template for new message</label>
+      <whatsthis></whatsthis>
+      <default code="true">TemplatesConfiguration::defaultNewMessage()</default>
+    </entry>
+    <entry name="TemplateReply" type="String" key="TemplateReply">
+      <label>Message template for reply</label>
+      <whatsthis></whatsthis>
+      <default code="true">TemplatesConfiguration::defaultReply()</default>
+    </entry>
+    <entry name="TemplateReplyAll" type="String" key="TemplateReplyAll">
+      <label>Message template for reply to all</label>
+      <whatsthis></whatsthis>
+      <default code="true">TemplatesConfiguration::defaultReplyAll()</default>
+    </entry>
+    <entry name="TemplateForward" type="String" key="TemplateForward">
+      <label>Message template for forward</label>
+      <whatsthis></whatsthis>
+      <default code="true">TemplatesConfiguration::defaultForward()</default>
+    </entry>
+    <entry name="QuoteString" type="String" key="QuoteString">
+      <label>Quote characters</label>
+      <whatsthis></whatsthis>
+      <default code="true">TemplatesConfiguration::defaultQuoteString()</default>
+    </entry>
+  </group>
+
 </kcfg>
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -445,6 +445,11 @@
       mLastUid. See above for details. */
   ulong mTentativeHighestUid;
 
+  /** Used to determine whether listing messages yielded a sensible result.
+   * Only then is the deletion o messages (which relies on succesful
+   * listing) attempted, during the sync.  */
+  bool mFoundAnIMAPDigest;
+
   int mUserRights;
   ACLList mACLList;
 
Index: kmail/kmmsgbase.cpp
===================================================================
--- kmail/kmmsgbase.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmsgbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -646,7 +646,7 @@
 
 
 //-----------------------------------------------------------------------------
-QString KMMsgBase::decodeRFC2047String(const QCString& aStr)
+QString KMMsgBase::decodeRFC2047String(const QCString& aStr, QCString prefCharset)
 {
   if ( aStr.isEmpty() )
     return QString::null;
@@ -656,9 +656,19 @@
   if ( str.isEmpty() )
     return QString::null;
 
-  if ( str.find( "=?" ) < 0 )
-    return KMMsgBase::codecForName( GlobalSettings::self()->
-                                    fallbackCharacterEncoding().latin1() )->toUnicode( str );
+  if ( str.find( "=?" ) < 0 ) {
+    if ( !prefCharset.isEmpty() ) {
+      if ( prefCharset == "us-ascii" ) {
+        // isn`t this foolproof?
+        return KMMsgBase::codecForName( "utf-8" )->toUnicode( str );
+      } else {
+        return KMMsgBase::codecForName( prefCharset )->toUnicode( str );
+      }
+    } else {
+      return KMMsgBase::codecForName( GlobalSettings::self()->
+                                      fallbackCharacterEncoding().latin1() )->toUnicode( str );
+    }
+  }
 
   QString result;
   QCString LWSP_buffer;
Index: kmail/customtemplates_base.ui
===================================================================
--- kmail/customtemplates_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/customtemplates_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,303 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>CustomTemplatesBase</class>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>Form1</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>600</width>
+            <height>480</height>
+        </rect>
+    </property>
+    <vbox>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="QSplitter">
+            <property name="name">
+                <cstring>splitter2</cstring>
+            </property>
+            <property name="orientation">
+                <enum>Horizontal</enum>
+            </property>
+            <widget class="QLayoutWidget">
+                <property name="name">
+                    <cstring>layout9</cstring>
+                </property>
+                <vbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <property name="margin">
+                        <number>0</number>
+                    </property>
+                    <widget class="QLayoutWidget">
+                        <property name="name">
+                            <cstring>layout8</cstring>
+                        </property>
+                        <hbox>
+                            <property name="name">
+                                <cstring>unnamed</cstring>
+                            </property>
+                            <property name="margin">
+                                <number>0</number>
+                            </property>
+                            <widget class="KLineEdit">
+                                <property name="name">
+                                    <cstring>mName</cstring>
+                                </property>
+                                <property name="sizePolicy">
+                                    <sizepolicy>
+                                        <hsizetype>3</hsizetype>
+                                        <vsizetype>0</vsizetype>
+                                        <horstretch>0</horstretch>
+                                        <verstretch>0</verstretch>
+                                    </sizepolicy>
+                                </property>
+                                <property name="minimumSize">
+                                    <size>
+                                        <width>100</width>
+                                        <height>0</height>
+                                    </size>
+                                </property>
+                            </widget>
+                            <widget class="KPushButton">
+                                <property name="name">
+                                    <cstring>mAdd</cstring>
+                                </property>
+                                <property name="text">
+                                    <string></string>
+                                </property>
+                            </widget>
+                            <widget class="KPushButton">
+                                <property name="name">
+                                    <cstring>mRemove</cstring>
+                                </property>
+                                <property name="text">
+                                    <string></string>
+                                </property>
+                            </widget>
+                        </hbox>
+                    </widget>
+                    <widget class="QListView">
+                        <column>
+                            <property name="text">
+                                <string>Type</string>
+                            </property>
+                            <property name="clickable">
+                                <bool>true</bool>
+                            </property>
+                            <property name="resizable">
+                                <bool>true</bool>
+                            </property>
+                        </column>
+                        <column>
+                            <property name="text">
+                                <string>Name</string>
+                            </property>
+                            <property name="clickable">
+                                <bool>true</bool>
+                            </property>
+                            <property name="resizable">
+                                <bool>true</bool>
+                            </property>
+                        </column>
+                        <property name="name">
+                            <cstring>mList</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>5</hsizetype>
+                                <vsizetype>7</vsizetype>
+                                <horstretch>0</horstretch>
+                                <verstretch>0</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="allColumnsShowFocus">
+                            <bool>true</bool>
+                        </property>
+                    </widget>
+                </vbox>
+            </widget>
+            <widget class="QFrame">
+                <property name="name">
+                    <cstring>mEditFrame</cstring>
+                </property>
+                <property name="sizePolicy">
+                    <sizepolicy>
+                        <hsizetype>7</hsizetype>
+                        <vsizetype>5</vsizetype>
+                        <horstretch>12</horstretch>
+                        <verstretch>0</verstretch>
+                    </sizepolicy>
+                </property>
+                <property name="frameShape">
+                    <enum>NoFrame</enum>
+                </property>
+                <property name="frameShadow">
+                    <enum>Raised</enum>
+                </property>
+                <vbox>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <property name="margin">
+                        <number>0</number>
+                    </property>
+                    <widget class="QTextEdit">
+                        <property name="name">
+                            <cstring>mEdit</cstring>
+                        </property>
+                        <property name="sizePolicy">
+                            <sizepolicy>
+                                <hsizetype>7</hsizetype>
+                                <vsizetype>7</vsizetype>
+                                <horstretch>3</horstretch>
+                                <verstretch>1</verstretch>
+                            </sizepolicy>
+                        </property>
+                        <property name="textFormat">
+                            <enum>PlainText</enum>
+                        </property>
+                        <property name="wordWrap">
+                            <enum>NoWrap</enum>
+                        </property>
+                    </widget>
+                    <widget class="QLayoutWidget">
+                        <property name="name">
+                            <cstring>layout4</cstring>
+                        </property>
+                        <grid>
+                            <property name="name">
+                                <cstring>unnamed</cstring>
+                            </property>
+                            <widget class="QComboBox" row="1" column="2">
+                                <item>
+                                    <property name="text">
+                                        <string>Universal</string>
+                                    </property>
+                                </item>
+                                <item>
+                                    <property name="text">
+                                        <string>Reply</string>
+                                    </property>
+                                </item>
+                                <item>
+                                    <property name="text">
+                                        <string>Reply to All</string>
+                                    </property>
+                                </item>
+                                <item>
+                                    <property name="text">
+                                        <string>Forward</string>
+                                    </property>
+                                </item>
+                                <property name="name">
+                                    <cstring>mType</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="0" column="1">
+                                <property name="name">
+                                    <cstring>textLabel1_2</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>Shortc&amp;ut:</string>
+                                </property>
+                                <property name="alignment">
+                                    <set>AlignVCenter|AlignRight</set>
+                                </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>mKeyButton</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="1" column="1">
+                                <property name="name">
+                                    <cstring>textLabel1</cstring>
+                                </property>
+                                <property name="sizePolicy">
+                                    <sizepolicy>
+                                        <hsizetype>5</hsizetype>
+                                        <vsizetype>5</vsizetype>
+                                        <horstretch>1</horstretch>
+                                        <verstretch>0</verstretch>
+                                    </sizepolicy>
+                                </property>
+                                <property name="text">
+                                    <string>&amp;Template type:</string>
+                                </property>
+                                <property name="alignment">
+                                    <set>AlignVCenter|AlignRight</set>
+                                </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>mType</cstring>
+                                </property>
+                            </widget>
+                            <widget class="TemplatesInsertCommand" row="1" column="0">
+                                <property name="name">
+                                    <cstring>mInsertCommand</cstring>
+                                </property>
+                            </widget>
+                            <widget class="KKeyButton" row="0" column="2">
+                                <property name="name">
+                                    <cstring>mKeyButton</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>None</string>
+                                </property>
+                            </widget>
+                            <widget class="KActiveLabel" row="0" column="0">
+                                <property name="name">
+                                    <cstring>mHelp</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>How does this work?</string>
+                                </property>
+                            </widget>
+                        </grid>
+                    </widget>
+                </vbox>
+            </widget>
+        </widget>
+    </vbox>
+</widget>
+<customwidgets>
+    <customwidget>
+        <class>TemplatesInsertCommand</class>
+        <header location="local">templatesinsertcommand.h</header>
+        <sizehint>
+            <width>50</width>
+            <height>10</height>
+        </sizehint>
+        <container>0</container>
+        <sizepolicy>
+            <hordata>5</hordata>
+            <verdata>5</verdata>
+            <horstretch>0</horstretch>
+            <verstretch>0</verstretch>
+        </sizepolicy>
+        <pixmap>image0</pixmap>
+        <signal>insertCommand(int)</signal>
+    </customwidget>
+</customwidgets>
+<images>
+    <image name="image0">
+        <data format="PNG" length="807">89504e470d0a1a0a0000000d49484452000000100000001008060000001ff3ff61000002ee49444154388d7d93cd6b5c6514c67fe7bdef9d8f24d349c66412a203b1b4282d21140918824816418a0b454d75e1a28ab8c8dfe1c25d70e34e0812ea4644d13610c43a1121b5d84cab6943486227499d869ae6633e32f7de79ef71d58644f0593dabdf39cf7938a2aa4c4f4f9b300c0b954ae56ca55249876128aa2a9c90738eadadada0542afd954ea7cb636363a19d9f9f4755cff6f4a53e4d67ed78f7b37ebb8b05e3810818017d0a68f1dcc36463a7ea8a4b8bdb9fcccdcdddf6eaf5bae4f3f9f7bb7a773faee94fed81b983a6d6d9ab6eb2f5f73affec6de1a536c9e4d7497696c9f63cf237d66b85b5e570cf3977c7aeaeae9a42a130d03d506bdbaddda3d1805faec6dc5a68e2a208e30124187a39c9ebefa6c8f544f84949a9ea69e75cd60641c0e1e1a1b8b849142ac51f226ece1f32fc4a86f31732f86db076178ad70e20765cfae8142207009eaafac639270022c2fd15a1b470c8f81b59defed0637024c44596c269cb3b1fe4585c68f2c76f0e23064000639e5c5804caab2d8c24187ed5c3265adc5bf4b9f2f91e377eae73fe254b6fbfc7ea7283588f9a314756089b31ed5925dd61b87b2bc5d75fd4a91d843c7fa68d5caf23fb4c8246fdc9f01300e3412e9f60f7313c285b6edf0c696bf338f3620773df3de2ea15d8de0ce92f2448f8472bd8a700515e18146e5c3714afd5197f3343ae3b463ce1cbcf94efbf7a48b6cb303462595c3801505514280c182ebed5ce37333bec3f8e387721859f80da7e8c114714097b3be65804eb799e562a95e641358e4d47cb8cbc66c9f5f6f1eb8f55967eafa140bedfe7e27b7dac2c4588a7ec6cb7622004629b4c2629954a7fda6c6b3f5f08baac1f61bd2683c3867a358931865339c8e69a9c1b323cb87fc0fa72d81091351189646262426667677b620e2fabea25942e504144fef34d80735a752daeab9a6f7ddf5f9162b1c8e4e4a45f2e974f0541d0a3aa19c03f16f4b862a061adddc96432bba2aaccccccc8d4d494b7b1b1910c8220a1aae6ff00d6da56676767303a3a1afd0b29d2596f22d0b7b20000000049454e44ae426082</data>
+    </image>
+</images>
+<slots>
+    <slot>mAdd_clicked()</slot>
+    <slot>mRemove_clicked()</slot>
+</slots>
+<layoutdefaults spacing="6" margin="11"/>
+<includehints>
+    <includehint>klineedit.h</includehint>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>templatesinsertcommand.h</includehint>
+    <includehint>kkeybutton.h</includehint>
+    <includehint>kactivelabel.h</includehint>
+</includehints>
+</UI>
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,7 +39,10 @@
 #include <dcopclient.h>
 #include <kaddrbook.h>
 #include <kaccel.h>
+#include <kstringhandler.h>
 
+#include <qvaluevector.h>
+
 #include "globalsettings.h"
 #include "kcursorsaver.h"
 #include "broadcaststatus.h"
@@ -73,6 +76,8 @@
 #include "vacation.h"
 using KMail::Vacation;
 
+#include <qsignalmapper.h>
+
 #include "subscriptiondialog.h"
 using KMail::SubscriptionDialog;
 #include "attachmentstrategy.h"
@@ -93,12 +98,16 @@
 using KMail::HeaderListQuickSearch;
 #include "kmheaders.h"
 #include "mailinglistpropertiesdialog.h"
+#include "templateparser.h"
 
 #if !defined(NDEBUG)
     #include "sievedebugdialog.h"
     using KMail::SieveDebugDialog;
 #endif
 
+#include <libkpimidentities/identity.h>
+#include <libkpimidentities/identitymanager.h>
+
 #include <assert.h>
 #include <kstatusbar.h>
 #include <kstaticdeleter.h>
@@ -115,6 +124,9 @@
 #include "managesievescriptsdialog.h"
 #include <qstylesheet.h>
 
+#include "customtemplates.h"
+#include "customtemplates_kfg.h"
+
 #include "kmmainwidget.moc"
 
 QValueList<KMMainWidget*>* KMMainWidget::s_mainWidgetList = 0;
@@ -134,6 +146,7 @@
   mSearchWin = 0;
   mIntegrated  = TRUE;
   mFolder = 0;
+  mTemplateFolder = 0;
   mFolderThreadPref = false;
   mFolderThreadSubjPref = true;
   mReaderWindowActive = true;
@@ -151,6 +164,14 @@
   mJob = 0;
   mConfig = config;
   mGUIClient = aGUIClient;
+
+  mCustomReplyActionMenu = 0;
+  mCustomReplyAllActionMenu = 0;
+  mCustomForwardActionMenu = 0;
+  mCustomReplyMapper = 0;
+  mCustomReplyAllMapper = 0;
+  mCustomForwardMapper = 0;
+
   // FIXME This should become a line separator as soon as the API
   // is extended in kdelibs.
   mToolbarActionSeparator = new KActionSeparator( actionCollection );
@@ -846,6 +867,10 @@
     }
   }
 
+  // update folder menus in case some mail got filtered to trash/current folder
+  // and we can enable "empty trash/move all to trash" action etc.
+  updateFolderMenu();
+
   if ( !showNotification )
     return;
 
@@ -881,9 +906,15 @@
 
   if ( mFolder ) {
       msg->initHeader( mFolder->identity() );
+      TemplateParser parser( msg, TemplateParser::NewMessage,
+	"", false, false, false, false );
+      parser.process( NULL, mFolder );
       win = KMail::makeComposer( msg, mFolder->identity() );
   } else {
       msg->initHeader();
+      TemplateParser parser( msg, TemplateParser::NewMessage,
+	"", false, false, false, false );
+      parser.process( NULL, NULL );
       win = KMail::makeComposer( msg );
   }
 
@@ -891,8 +922,48 @@
 
 }
 
+//-----------------------------------------------------------------------------
+// TODO: do we want the list sorted alphabetically?
+void KMMainWidget::slotShowNewFromTemplate()
+{
+  if ( mFolder ) {
+    const KPIM::Identity & ident =
+      kmkernel->identityManager()->identityForUoidOrDefault( mFolder->identity() );
+    mTemplateFolder = kmkernel->folderMgr()->findIdString( ident.templates() );
+  }
+  else mTemplateFolder = kmkernel->templatesFolder();
+  if ( !mTemplateFolder )
+    return;
 
+  mTemplateMenu->popupMenu()->clear();
+  for ( int idx = 0; idx<mTemplateFolder->count(); ++idx ) {
+    KMMsgBase *mb = mTemplateFolder->getMsgBase( idx );
+
+    QString subj = mb->subject();
+    if ( subj.isEmpty() ) subj = i18n("No Subject");
+    mTemplateMenu->popupMenu()->insertItem(
+      KStringHandler::rsqueeze( subj.replace( "&", "&&" ) ), idx );
+  }
+}
+
 //-----------------------------------------------------------------------------
+void KMMainWidget::slotNewFromTemplate( int id )
+{
+  if ( !mTemplateFolder )
+    return;
+  newFromTemplate(mTemplateFolder->getMsg( id ) );
+}
+
+//-----------------------------------------------------------------------------
+void KMMainWidget::newFromTemplate( KMMessage *msg )
+{
+  if ( !msg )
+    return;
+  KMCommand *command = new KMUseTemplateCommand( this, msg );
+  command->start();
+}
+
+//-----------------------------------------------------------------------------
 void KMMainWidget::slotPostToML()
 {
   if ( mFolder && mFolder->isMailingListEnabled() ) {
@@ -1013,6 +1084,10 @@
     BroadcastStatus::instance()->setStatusMsg(i18n("Moved all messages to the trash"));
 
   updateMessageActions();
+
+  // Disable empty trash/move all to trash action - we've just deleted/moved all folder
+  // contents.
+  mEmptyFolderAction->setEnabled( false );
 }
 
 
@@ -1329,6 +1404,12 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMMainWidget::slotUseTemplate()
+{
+  newFromTemplate( mHeaders->currentMsg() );
+}
+
+//-----------------------------------------------------------------------------
 void KMMainWidget::slotResendMsg()
 {
   KMCommand *command = new KMResendMessageCommand( this, mHeaders->currentMsg() );
@@ -1406,7 +1487,54 @@
   command->start();
 }
 
+
 //-----------------------------------------------------------------------------
+void KMMainWidget::slotCustomReplyToMsg( int tid )
+{
+  QString text = mMsgView? mMsgView->copyText() : "";
+  QString tmpl = mCustomTemplates[ tid ];
+  kdDebug() << "Reply with template: " << tmpl << " (" << tid << ")" << endl;
+  KMCommand *command = new KMCustomReplyToCommand( this,
+                                                   mHeaders->currentMsg(),
+                                                   text,
+                                                   tmpl );
+  command->start();
+}
+
+
+//-----------------------------------------------------------------------------
+void KMMainWidget::slotCustomReplyAllToMsg( int tid )
+{
+  QString text = mMsgView? mMsgView->copyText() : "";
+  QString tmpl = mCustomTemplates[ tid ];
+  kdDebug() << "Reply to All with template: " << tmpl << " (" << tid << ")" << endl;
+  KMCommand *command = new KMCustomReplyAllToCommand( this,
+                                                   mHeaders->currentMsg(),
+                                                   text,
+                                                   tmpl );
+  command->start();
+}
+
+
+//-----------------------------------------------------------------------------
+void KMMainWidget::slotCustomForwardMsg( int tid )
+{
+  QString tmpl = mCustomTemplates[ tid ];
+  kdDebug() << "Forward with template: " << tmpl << " (" << tid << ")" << endl;
+  KMMessageList* selected = mHeaders->selectedMsgs();
+  KMCommand *command = 0L;
+  if(selected && !selected->isEmpty()) {
+    command = new KMCustomForwardCommand( this, *selected,
+                                          mFolder->identity(), tmpl );
+  } else {
+    command = new KMCustomForwardCommand( this, mHeaders->currentMsg(),
+                                          mFolder->identity(), tmpl );
+  }
+  command->start();
+}
+
+
+//-----------------------------------------------------------------------------
 void KMMainWidget::slotNoQuoteReplyToMsg()
 {
   KMCommand *command = new KMNoQuoteReplyToCommand( this, mHeaders->currentMsg() );
@@ -2120,20 +2248,22 @@
 void KMMainWidget::slotMsgActivated(KMMessage *msg)
 {
   if ( !msg ) return;
-  if (msg->parent() && !msg->isComplete())
-  {
-    FolderJob *job = msg->parent()->createJob(msg);
-    connect(job, SIGNAL(messageRetrieved(KMMessage*)),
-            SLOT(slotMsgActivated(KMMessage*)));
+  if ( msg->parent() && !msg->isComplete() ) {
+    FolderJob *job = msg->parent()->createJob( msg );
+    connect( job, SIGNAL( messageRetrieved( KMMessage* ) ),
+             SLOT( slotMsgActivated( KMMessage* ) ) );
     job->start();
     return;
   }
 
-  if (kmkernel->folderIsDraftOrOutbox(mFolder))
-  {
+  if (kmkernel->folderIsDraftOrOutbox( mFolder ) ) {
     slotEditMsg();
     return;
   }
+  if ( kmkernel->folderIsTemplates( mFolder ) ) {
+    slotUseTemplate();
+    return;
+  }
 
   assert( msg != 0 );
   KMReaderMainWin *win = new KMReaderMainWin( mFolderHtmlPref, mFolderHtmlLoadExtPref );
@@ -2221,12 +2351,14 @@
 
     if ( mFolder->isDrafts() || mFolder->isOutbox() ) {
       mEditAction->plug(menu);
+    } else if ( mFolder->isTemplates() ) {
+      mUseAction->plug( menu );
+      mEditAction->plug( menu );
+    } else {
+      if ( !mFolder->isSent() )
+        mReplyActionMenu->plug( menu );
+      mForwardActionMenu->plug( menu );
     }
-    else {
-      if( !mFolder->isSent() )
-        mReplyActionMenu->plug(menu);
-      mForwardActionMenu->plug(menu);
-    }
     menu->insertSeparator();
 
     mCopyActionMenu->plug( menu );
@@ -2284,6 +2416,154 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMMainWidget::updateCustomTemplateMenus()
+{
+  if ( !mCustomTemplateActions.isEmpty() ) {
+    QPtrList<KAction>::iterator ait = mCustomTemplateActions.begin();
+    for ( ; ait != mCustomTemplateActions.end() ; ++ait ) {
+      (*ait)->unplugAll();
+      delete (*ait);
+    }
+    mCustomTemplateActions.clear();
+  }
+
+  delete mCustomReplyActionMenu;
+  delete mCustomReplyAllActionMenu;
+  delete mCustomForwardActionMenu;
+
+  delete mCustomReplyMapper;
+  delete mCustomReplyAllMapper;
+  delete mCustomForwardMapper;
+
+  mCustomForwardActionMenu =
+    new KActionMenu( i18n("Forward with custom template"),
+                     "mail_custom_forward",
+                     actionCollection(), "custom_forward" );
+  QSignalMapper *mCustomForwardMapper = new QSignalMapper( this );
+  connect( mCustomForwardMapper, SIGNAL( mapped( int ) ),
+           this, SLOT( slotCustomForwardMsg( int ) ) );
+  mForwardActionMenu->insert( mCustomForwardActionMenu );
+
+  mCustomReplyActionMenu =
+    new KActionMenu( i18n("Reply with custom template"), "mail_custom_reply",
+                     actionCollection(), "custom_reply" );
+  QSignalMapper *mCustomReplyMapper = new QSignalMapper( this );
+  connect( mCustomReplyMapper, SIGNAL( mapped( int ) ),
+           this, SLOT( slotCustomReplyToMsg( int ) ) );
+  mReplyActionMenu->insert( mCustomReplyActionMenu );
+
+  mCustomReplyAllActionMenu =
+    new KActionMenu( i18n("Reply to All with custom template"),
+                     "mail_custom_reply_all",
+                     actionCollection(), "custom_reply_all" );
+  QSignalMapper *mCustomReplyAllMapper = new QSignalMapper( this );
+  connect( mCustomReplyAllMapper, SIGNAL( mapped( int ) ),
+           this, SLOT( slotCustomReplyAllToMsg( int ) ) );
+  mReplyActionMenu->insert( mCustomReplyAllActionMenu );
+
+  mCustomTemplates.clear();
+
+  QStringList list = GlobalSettingsBase::self()->customTemplates();
+  QStringList::iterator it = list.begin();
+  int idx = 0;
+  int replyc = 0;
+  int replyallc = 0;
+  int forwardc = 0;
+  for ( ; it != list.end(); ++it ) {
+    CTemplates t( *it );
+    mCustomTemplates.append( *it );
+
+    KAction *action;
+    switch ( t.type() ) {
+    case CustomTemplates::TReply:
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut( t.shortcut() ),
+                            mCustomReplyMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomReplyMapper->setMapping( action, idx );
+      mCustomReplyActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++replyc;
+      break;
+    case CustomTemplates::TReplyAll:
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut( t.shortcut() ),
+                            mCustomReplyAllMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomReplyAllMapper->setMapping( action, idx );
+      mCustomReplyAllActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++replyallc;
+      break;
+    case CustomTemplates::TForward:
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut( t.shortcut() ),
+                            mCustomForwardMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomForwardMapper->setMapping( action, idx );
+      mCustomForwardActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++forwardc;
+      break;
+    case CustomTemplates::TUniversal:
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut::null(),
+                            mCustomReplyMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomReplyMapper->setMapping( action, idx );
+      mCustomReplyActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++replyc;
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut::null(),
+                            mCustomReplyAllMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomReplyAllMapper->setMapping( action, idx );
+      mCustomReplyAllActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++replyallc;
+      action = new KAction( (*it).replace( "&", "&&" ),
+                            KShortcut::null(),
+                            mCustomForwardMapper,
+                            SLOT( map() ),
+                            actionCollection(),
+                            (*it).utf8() );
+      mCustomForwardMapper->setMapping( action, idx );
+      mCustomForwardActionMenu->insert( action, idx );
+      mCustomTemplateActions.append( action );
+      ++forwardc;
+      break;
+    }
+
+    ++idx;
+  }
+  if ( !replyc ) {
+      mCustomReplyActionMenu->popupMenu()->insertItem( i18n( "(no custom templates)" ), 0 );
+      mCustomReplyActionMenu->popupMenu()->setItemEnabled( 0, false );
+  }
+  if ( !replyallc ) {
+      mCustomReplyAllActionMenu->popupMenu()->insertItem( i18n( "(no custom templates)" ), 0 );
+      mCustomReplyAllActionMenu->popupMenu()->setItemEnabled( 0, false );
+  }
+  if ( !forwardc ) {
+      mCustomForwardActionMenu->popupMenu()->insertItem( i18n( "(no custom templates)" ), 0 );
+      mCustomForwardActionMenu->popupMenu()->setItemEnabled( 0, false );
+  }
+
+}
+
+
+//-----------------------------------------------------------------------------
 void KMMainWidget::setupActions()
 {
   //----- File Menu
@@ -2420,7 +2700,7 @@
   mModifyFolderAction = new KAction( i18n("&Properties"), "configure", 0, this,
 		      SLOT(slotModifyFolder()), actionCollection(), "modify" );
 
-  mFolderMailingListPropertiesAction = new KAction( i18n("&Mailing List Management"),
+  mFolderMailingListPropertiesAction = new KAction( i18n("&Mailing List Management..."),
       /*"folder_mailinglist_properties",*/ 0, this, SLOT( slotFolderMailingListProperties() ),
       actionCollection(), "folder_mailinglist_properties" );
 
@@ -2466,6 +2746,14 @@
   //----- Message Menu
   (void) new KAction( i18n("&New Message..."), "mail_new", KStdAccel::shortcut(KStdAccel::New), this,
 		      SLOT(slotCompose()), actionCollection(), "new_message" );
+  mTemplateMenu =
+    new KActionMenu( i18n("New Message From &Template"), "filenew",
+                     actionCollection(), "new_from_template" );
+  mTemplateMenu->setDelayed( true );
+  connect( mTemplateMenu->popupMenu(), SIGNAL( aboutToShow() ), this,
+           SLOT( slotShowNewFromTemplate() ) );
+  connect( mTemplateMenu->popupMenu(), SIGNAL( activated(int) ), this,
+           SLOT( slotNewFromTemplate(int) ) );
 
   (void) new KAction( i18n("New Message t&o Mailing-List..."), "mail_post_to",
                       CTRL+SHIFT+Key_N, this,
@@ -2503,7 +2791,6 @@
                                  "message_forward_redirect" );
   mForwardActionMenu->insert( redirectAction() );
 
-
   mSendAgainAction = new KAction( i18n("Send A&gain..."), 0, this,
 		      SLOT(slotResendMsg()), actionCollection(), "send_again" );
 
@@ -2566,6 +2853,10 @@
   mEditAction = new KAction( i18n("&Edit Message"), "edit", Key_T, this,
                             SLOT(slotEditMsg()), actionCollection(), "edit" );
   mEditAction->plugAccel( actionCollection()->kaccel() );
+  mUseAction = new KAction( i18n("New Message From &Template"), "filenew",
+                            Key_N, this, SLOT( slotUseTemplate() ),
+                            actionCollection(), "use_template" );
+  mUseAction->plugAccel( actionCollection()->kaccel() );
 
   //----- "Mark Message" submenu
   mStatusMenu = new KActionMenu ( i18n( "Mar&k Message" ),
@@ -2601,12 +2892,6 @@
   mToggleTodoAction->setCheckedState( i18n("Remove &To-do Message Mark") );
   mStatusMenu->insert( mToggleTodoAction );
 
-  mToggleSentAction = new KToggleAction(i18n("Mark Message as &Sent"), "kmmsgsent",
-                                 0, this, SLOT(slotSetMsgStatusSent()),
-                                 actionCollection(), "status_sent");
-  mToggleSentAction->setCheckedState( i18n("Remove &Sent Mark") );
-
-
   //----- "Mark Thread" submenu
   mThreadStatusMenu = new KActionMenu ( i18n( "Mark &Thread" ),
                                        actionCollection(), "thread_status" );
@@ -2653,6 +2938,10 @@
                                        0, this, SLOT(slotSetThreadStatusIgnored()),
                                        actionCollection(), "thread_ignored");
 
+  mThreadStatusMenu->insert( new KActionSeparator( this ) );
+  mThreadStatusMenu->insert( mWatchThreadAction );
+  mThreadStatusMenu->insert( mIgnoreThreadAction );
+
   mSaveAttachmentsAction = new KAction( i18n("Save A&ttachments..."), "attach",
                                 0, this, SLOT(slotSaveAttachments()),
                                 actionCollection(), "file_save_attachments" );
@@ -2837,6 +3126,7 @@
 
   initializeIMAPActions( false ); // don't set state, config not read yet
   updateMessageActions();
+  updateCustomTemplateMenus();
 }
 
 //-----------------------------------------------------------------------------
@@ -3008,7 +3298,6 @@
 
     if (mFolder && mHeaders && mHeaders->currentMsg()) {
       mToggleTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
-      mToggleSentAction->setChecked(mHeaders->currentMsg()->isSent());
       mToggleFlagAction->setChecked(mHeaders->currentMsg()->isImportant());
       if (thread_actions) {
         mToggleThreadTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
@@ -3031,7 +3320,10 @@
 
     bool single_actions = count == 1;
     mEditAction->setEnabled( single_actions &&
-    kmkernel->folderIsDraftOrOutbox(mFolder));
+                             ( kmkernel->folderIsDraftOrOutbox( mFolder ) ||
+                               kmkernel->folderIsTemplates( mFolder ) ) );
+    mUseAction->setEnabled( single_actions &&
+                            kmkernel->folderIsTemplates( mFolder ) );
     replyMenu()->setEnabled( single_actions );
     filterMenu()->setEnabled( single_actions );
     replyAction()->setEnabled( single_actions );
Index: kmail/kmfiltermgr.h
===================================================================
--- kmail/kmfiltermgr.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfiltermgr.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -66,13 +66,13 @@
 
   /**
    * Returns whether at least one filter applies to this account,
-   * which means that mail must be downloaded in order to be filtered, 
+   * which means that mail must be downloaded in order to be filtered,
    * for example;
    * */
   bool atLeastOneFilterAppliesTo( unsigned int accountID ) const;
   /**
    * Returns whether at least one incoming filter applies to this account,
-   * which means that mail must be downloaded in order to be filtered, 
+   * which means that mail must be downloaded in order to be filtered,
    * for example;
    * */
   bool atLeastOneIncomingFilterAppliesTo( unsigned int accountID ) const;
@@ -105,20 +105,26 @@
       @param msg The message to process.
       @param aSet Select the filter set to use.
       @param account true if an account id is specified else false
-      @param accountId The id of the KMAccount that the message was 
+      @param accountId The id of the KMAccount that the message was
              retrieved from
       @return 2 if a critical error occurred (eg out of disk space)
       1 if the caller is still owner of the message and
       0 otherwise. If the caller does not any longer own the message
       he *must* not delete the message or do similar stupid things. ;-)
   */
-  int process( KMMessage * msg, FilterSet aSet = Inbound, 
+  int process( KMMessage * msg, FilterSet aSet = Inbound,
 	       bool account = false, uint accountId = 0 );
 
   /** For ad-hoc filters. Applies @p filter to @p msg. Return codes
-      are as with the above method. */
+      are as with the above method.
+      @deprecated Use int process( quint32, const KMFilter * )
+  */
   int process( KMMessage * msg, const KMFilter * filter );
 
+  /** For ad-hoc filters. Applies @p filter to message with @p serNum .
+      Return codes are as with the above method. */
+  int process( Q_UINT32 serNum, const KMFilter * filter );
+
   void cleanup();
   /** Increment the reference count for the filter manager.
       Call this method before processing messages with process() */
@@ -174,7 +180,9 @@
   void filterListUpdated();
 
 private:
-  int processPop( KMMessage * msg ) const;
+  int processPop( KMMessage *msg ) const;
+  /** Find out if a message matches the filter criteria */
+  bool isMatching( Q_UINT32 serNum, const KMFilter *filter );
 
   QGuardedPtr<KMFilterDlg> mEditDialog;
   QValueVector<KMFolder *> mOpenFolders;
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -266,6 +266,7 @@
    * Returns true when saving was successful.
    */
   void slotSaveDraft();
+  void slotSaveTemplate();
   void slotNewComposer();
   void slotNewMailReader();
   void slotClose();
@@ -398,8 +399,8 @@
   void slotAttachRemove();
   void slotAttachSave();
   void slotAttachProperties();
+  void slotAttachOpenWith();
 
-
   /**
    * Select an email from the addressbook and add it to the line
    * the pressed button belongs to.
@@ -546,9 +547,9 @@
   virtual bool queryExit ();
 
   /**
-   * Open the attachment with the given index.
+   * Open the attachment with the given index and with ("Open with")
    */
-  void openAttach( int index );
+  void openAttach( int index, bool with );
 
   /**
    * View the attachment with the given index.
@@ -614,12 +615,19 @@
    * This function is for example used to restore the unencrypted/unsigned
    * message text for editting.
    */
-   static void decryptOrStripOffCleartextSignature( QCString& );
+  static void decryptOrStripOffCleartextSignature( QCString& );
 
   /**
+   * Save the message into the Drafts or Templates folder.
+   */
+  bool saveDraftOrTemplate( const QString &folderName, KMMessage *msg );
+
+  /**
    * Send the message. Returns true if the message was sent successfully.
    */
-  void doSend( KMail::MessageSender::SendMethod method=KMail::MessageSender::SendDefault, bool saveInDrafts = false);
+  enum SaveIn { None, Drafts, Templates };
+  void doSend( KMail::MessageSender::SendMethod method=KMail::MessageSender::SendDefault,
+               KMComposeWin::SaveIn saveIn = KMComposeWin::None );
 
   /**
    * Returns the autosave interval in milliseconds (as needed for QTimer).
@@ -649,6 +657,14 @@
    */
   static bool validateAddresses( QWidget * parent, const QString & addresses );
 
+  /**
+   * Sets the transport combobox to @p transport. If @p transport is empty
+   * then the combobox remains unchanged. If @p transport is neither a known transport
+   * nor a custom transport then the combobox is set to the default transport.
+   * @param transport the transport the combobox should be set to
+   */
+  void setTransport( const QString & transport );
+
 private slots:
    /**
     * Compress an attachemnt with the given index
@@ -688,7 +704,7 @@
   QPtrList<QListViewItem> mAtmItemList;
   QPtrList<KMMessagePart> mAtmList;
   QPopupMenu *mAttachMenu;
-  int mOpenId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
+  int mOpenId, mOpenWithId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
   bool mAutoDeleteMsg;
   bool mSigningAndEncryptionExplicitlyDisabled;
   bool mLastSignActionState, mLastEncryptActionState;
@@ -793,7 +809,7 @@
 
   // These are for passing on methods over the applyChanges calls
   KMail::MessageSender::SendMethod mSendMethod;
-  bool mSaveInDrafts;
+  KMComposeWin::SaveIn mSaveIn;
 
   KToggleAction *mEncryptChiasmusAction;
   bool mEncryptWithChiasmus;
Index: kmail/recipientseditor.h
===================================================================
--- kmail/recipientseditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/recipientseditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -158,6 +158,7 @@
     void slotTypeModified();
 
   private:
+    friend class RecipientsView;
     QComboBox *mCombo;
     RecipientLineEdit *mEdit;
     QPushButton *mRemoveButton;
@@ -206,6 +207,7 @@
     int setFirstColumnWidth( int );
 
   public slots:
+    void setCompletionMode( KGlobalSettings::Completion );
     RecipientLine *addLine();
 
     void setFocus();
@@ -217,6 +219,7 @@
     void focusUp();
     void focusDown();
     void focusRight();
+    void completionModeChanged( KGlobalSettings::Completion );
 
   protected:
     void viewportResizeEvent( QResizeEvent * );
@@ -237,6 +240,7 @@
     int mLineHeight;
     int mFirstColumnWidth;
     bool mModified;
+    KGlobalSettings::Completion mCompletionMode;
 };
 
 class RecipientsToolTip : public QToolTip
@@ -328,6 +332,11 @@
       */
     int setFirstColumnWidth( int );
 
+    /**
+      * Set completion mode for all lines
+      */
+    void setCompletionMode( KGlobalSettings::Completion );
+
   public slots:
     void setFocus();
     void setFocusTop();
@@ -339,6 +348,7 @@
   signals:
     void focusUp();
     void focusDown();
+    void completionModeChanged( KGlobalSettings::Completion );
 
   protected slots:
     void slotPickedRecipient( const Recipient & );
Index: kmail/kmfiltermgr.cpp
===================================================================
--- kmail/kmfiltermgr.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfiltermgr.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,9 +13,10 @@
 using KMail::FilterLog;
 #include "kmfilterdlg.h"
 #include "kmfolderindex.h"
+#include "kmfoldermgr.h"
+#include "kmmsgdict.h"
 #include "messageproperty.h"
 using KMail::MessageProperty;
-#include "kmfoldermgr.h"
 
 // other KDE headers
 #include <kdebug.h>
@@ -57,7 +58,7 @@
 void KMFilterMgr::clear()
 {
   mDirtyBufferedFolderTarget = true;
-  for ( QValueListIterator<KMFilter*> it = mFilters.begin() ; 
+  for ( QValueListIterator<KMFilter*> it = mFilters.begin() ;
         it != mFilters.end() ; ++it ) {
     delete *it;
   }
@@ -113,7 +114,7 @@
   // Now, write out the new stuff:
   int i = 0;
   QString grpName;
-  for ( QValueListConstIterator<KMFilter*> it = mFilters.constBegin() ; 
+  for ( QValueListConstIterator<KMFilter*> it = mFilters.constBegin() ;
         it != mFilters.constEnd() ; ++it ) {
     if ( !(*it)->isEmpty() ) {
       if ( bPopFilter )
@@ -200,7 +201,7 @@
 
   if (filter->pattern()->matches( msg )) {
     if ( FilterLog::instance()->isLogging() ) {
-      FilterLog::instance()->add( i18n( "<b>Filter rules have matched.</b>" ), 
+      FilterLog::instance()->add( i18n( "<b>Filter rules have matched.</b>" ),
                                   FilterLog::patternResult );
     }
     if (filter->execActions( msg, stopIt ) == KMFilter::CriticalError)
@@ -220,6 +221,63 @@
   return result;
 }
 
+int KMFilterMgr::process( Q_UINT32 serNum, const KMFilter *filter )
+{
+  bool stopIt = false;
+  int result = 1;
+
+  if ( !filter )
+    return 1;
+
+  if ( isMatching( serNum, filter ) ) {
+    KMFolder *folder = 0;
+    int idx = -1;
+    // get the message with the serNum
+    KMMsgDict::instance()->getLocation( serNum, &folder, &idx );
+    if ( !folder || ( idx == -1 ) || ( idx >= folder->count() ) ) {
+      return 1;
+    }
+    bool opened = folder->isOpened();
+    if ( !opened )
+      folder->open();
+    KMMsgBase *msgBase = folder->getMsgBase( idx );
+    bool unGet = !msgBase->isMessage();
+    KMMessage *msg = folder->getMsg( idx );
+    // do the actual filtering stuff
+    if ( !msg || !beginFiltering( msg ) ) {
+      if ( unGet )
+        folder->unGetMsg( idx );
+      if ( !opened )
+        folder->close();
+      return 1;
+    }
+    if ( filter->execActions( msg, stopIt ) == KMFilter::CriticalError ) {
+      if ( unGet )
+        folder->unGetMsg( idx );
+      if ( !opened )
+        folder->close();
+      return 2;
+    }
+
+    KMFolder *targetFolder = MessageProperty::filterFolder( msg );
+
+    endFiltering( msg );
+    if ( targetFolder ) {
+      tempOpenFolder( targetFolder );
+      msg->setTransferInProgress( false );
+      result = targetFolder->moveMsg( msg );
+      msg->setTransferInProgress( true );
+    }
+    if ( unGet )
+      folder->unGetMsg( idx );
+    if ( !opened )
+      folder->close();
+  } else {
+    result = 1;
+  }
+  return result;
+}
+
 int KMFilterMgr::process( KMMessage * msg, FilterSet set,
 			  bool account, uint accountId ) {
   if ( bPopFilter )
@@ -240,7 +298,7 @@
         !stopIt && it != mFilters.constEnd() ; ++it ) {
 
     if ( ( ( (set&Inbound) && (*it)->applyOnInbound() ) &&
-	   ( !account || 
+	   ( !account ||
 	     ( account && (*it)->applyOnAccount( accountId ) ) ) ) ||
          ( (set&Outbound)  && (*it)->applyOnOutbound() ) ||
          ( (set&Explicit) && (*it)->applyOnExplicit() ) ) {
@@ -254,7 +312,7 @@
       if ( (*it)->pattern()->matches( msg ) ) {
         // filter matches
         if ( FilterLog::instance()->isLogging() ) {
-          FilterLog::instance()->add( i18n( "<b>Filter rules have matched.</b>" ), 
+          FilterLog::instance()->add( i18n( "<b>Filter rules have matched.</b>" ),
                                       FilterLog::patternResult );
         }
         atLeastOneRuleMatched = true;
@@ -266,8 +324,8 @@
   }
 
   KMFolder *folder = MessageProperty::filterFolder( msg );
-  /* endFilter does a take() and addButKeepUID() to ensure the changed 
-   * message is on disk. This is unnessecary if nothing matched, so just 
+  /* endFilter does a take() and addButKeepUID() to ensure the changed
+   * message is on disk. This is unnessecary if nothing matched, so just
    * reset state and don't update the listview at all. */
   if ( atLeastOneRuleMatched )
     endFiltering( msg );
@@ -281,6 +339,23 @@
   return 1;
 }
 
+bool KMFilterMgr::isMatching( Q_UINT32 serNum, const KMFilter *filter )
+{
+  bool result = false;
+  if ( FilterLog::instance()->isLogging() ) {
+    QString logText( i18n( "<b>Evaluating filter rules:</b> " ) );
+    logText.append( filter->pattern()->asString() );
+    FilterLog::instance()->add( logText, FilterLog::patternDesc );
+  }
+  if ( filter->pattern()->matches( serNum ) ) {
+    if ( FilterLog::instance()->isLogging() ) {
+      FilterLog::instance()->add( i18n( "<b>Filter rules have matched.</b>" ),
+                                  FilterLog::patternResult );
+    }
+    result = true;
+  }
+  return result;
+}
 
 bool KMFilterMgr::atLeastOneFilterAppliesTo( unsigned int accountID ) const
 {
@@ -308,9 +383,9 @@
 {
   if (!mDirtyBufferedFolderTarget)
     return mBufferedFolderTarget;
-  
+
   mDirtyBufferedFolderTarget = false;
-      
+
   QValueListConstIterator<KMFilter*> it = mFilters.constBegin();
   for ( ; it != mFilters.constEnd() ; ++it ) {
     KMFilter *filter = *it;
@@ -375,7 +450,7 @@
     // We can't use the parent as long as the dialog is modeless
     // and there is one shared dialog for all top level windows.
     //
-    mEditDialog = new KMFilterDlg( 0, "filterdialog", bPopFilter, 
+    mEditDialog = new KMFilterDlg( 0, "filterdialog", bPopFilter,
                                    checkForEmptyFilterList );
   }
   mEditDialog->show();
@@ -396,7 +471,7 @@
   QString uniqueName = name;
   int counter = 0;
   bool found = true;
-  
+
   while ( found ) {
     found = false;
     for ( QValueListConstIterator<KMFilter*> it = mFilters.constBegin();
@@ -405,7 +480,7 @@
         found = true;
         ++counter;
         uniqueName = name;
-        uniqueName += QString( " (" ) + QString::number( counter ) 
+        uniqueName += QString( " (" ) + QString::number( counter )
                     + QString( ")" );
         break;
       }
@@ -456,7 +531,7 @@
   bool rem = false;
   QValueListConstIterator<KMFilter*> it = mFilters.constBegin();
   for ( ; it != mFilters.constEnd() ; ++it )
-    if ( (*it)->folderRemoved(aFolder, aNewFolder) ) 
+    if ( (*it)->folderRemoved(aFolder, aNewFolder) )
       rem = true;
 
   return rem;
@@ -467,7 +542,7 @@
 #ifndef NDEBUG
 void KMFilterMgr::dump(void) const
 {
-  
+
   QValueListConstIterator<KMFilter*> it = mFilters.constBegin();
   for ( ; it != mFilters.constEnd() ; ++it ) {
     kdDebug(5006) << (*it)->asString() << endl;
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmcommands.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -284,6 +284,17 @@
   virtual Result execute();
 };
 
+class KDE_EXPORT KMUseTemplateCommand : public KMCommand
+{
+  Q_OBJECT
+
+public:
+  KMUseTemplateCommand( QWidget *parent, KMMessage *msg );
+
+private:
+  virtual Result execute();
+};
+
 class KDE_EXPORT KMShowMsgSrcCommand : public KMCommand
 {
   Q_OBJECT
@@ -522,6 +533,57 @@
   virtual Result execute();
 };
 
+class KDE_EXPORT KMCustomReplyToCommand : public KMCommand
+{
+  Q_OBJECT
+
+public:
+  KMCustomReplyToCommand( QWidget *parent, KMMessage *msg,
+                          const QString &selection,
+                          const QString &tmpl );
+
+private:
+  virtual Result execute();
+
+private:
+  QString mSelection;
+  QString mTemplate;
+};
+
+class KDE_EXPORT KMCustomReplyAllToCommand : public KMCommand
+{
+  Q_OBJECT
+
+public:
+  KMCustomReplyAllToCommand( QWidget *parent, KMMessage *msg,
+                          const QString &selection,
+                          const QString &tmpl );
+
+private:
+  virtual Result execute();
+
+private:
+  QString mSelection;
+  QString mTemplate;
+};
+
+class KDE_EXPORT KMCustomForwardCommand : public KMCommand
+{
+  Q_OBJECT
+
+public:
+  KMCustomForwardCommand( QWidget *parent, const QPtrList<KMMsgBase> &msgList,
+                          uint identity, const QString &tmpl );
+  KMCustomForwardCommand( QWidget *parent, KMMessage * msg,
+                          uint identity, const QString &tmpl );
+
+private:
+  virtual Result execute();
+
+  uint mIdentity;
+  QString mTemplate;
+};
+
 class KDE_EXPORT KMPrintCommand : public KMCommand
 {
   Q_OBJECT
@@ -586,7 +648,7 @@
 
 private:
   virtual Result execute();
-
+  QValueList<Q_UINT32> serNumList;
   KMFilter *mFilter;
 };
 
Index: kmail/identitydialog.cpp
===================================================================
--- kmail/identitydialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/identitydialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -46,6 +46,8 @@
 #include "kleo_util.h"
 #include "kmmainwidget.h"
 #include "kmfolder.h"
+#include "templatesconfiguration.h"
+#include "templatesconfiguration_kfg.h"
 
 // other kdepim headers:
 // libkdepim
@@ -64,6 +66,7 @@
 #include <kfileitem.h>
 #include <kurl.h>
 #include <kdebug.h>
+#include <kpushbutton.h>
 
 // Qt headers:
 #include <qtabwidget.h>
@@ -285,9 +288,9 @@
     row = -1;
     tab = new QWidget( tabWidget );
     tabWidget->addTab( tab, i18n("&Advanced") );
-    glay = new QGridLayout( tab, 7, 2, marginHint(), spacingHint() );
+    glay = new QGridLayout( tab, 8, 2, marginHint(), spacingHint() );
     // the last (empty) row takes all the remaining space
-    glay->setRowStretch( 7-1, 1 );
+    glay->setRowStretch( 8-1, 1 );
     glay->setColStretch( 1, 1 );
 
     // "Reply-To Address" line edit and label:
@@ -352,6 +355,15 @@
     glay->addWidget( new QLabel( mDraftsCombo, i18n("&Drafts folder:"), tab ),
                      row, 0 );
 
+    // "Templates Folder" combo box and label:
+    ++row;
+    mTemplatesCombo = new FolderRequester( tab,
+        kmkernel->getKMMainWidget()->folderTree() );
+    mTemplatesCombo->setShowOutbox( false );
+    glay->addWidget( mTemplatesCombo, row, 1 );
+    glay->addWidget( new QLabel( mTemplatesCombo, i18n("&Templates folder:"), tab ),
+                     row, 0 );
+
     // "Special transport" combobox and label:
     ++row;
     mTransportCheck = new QCheckBox( i18n("Special &transport:"), tab );
@@ -364,7 +376,29 @@
              mTransportCombo, SLOT(setEnabled(bool)) );
 
     // the last row is a spacer
-
+    
+    // 
+    // Tab Widget: Templates
+    // 
+		tab = new QWidget( tabWidget );
+    tabWidget->addTab( tab, i18n("&Templates") );
+    vlay = new QVBoxLayout( tab, marginHint(), spacingHint() );
+		mCustom = new QCheckBox( i18n("&Use custom message templates"), tab );
+		vlay->addWidget( mCustom );
+		mWidget = new TemplatesConfiguration( tab , "identity-templates" );
+		mWidget->setEnabled( false );
+		vlay->addWidget( mWidget );
+		QHBoxLayout *btns = new QHBoxLayout( vlay, spacingHint() );
+		mCopyGlobal = new KPushButton( i18n("&Copy global templates"), tab );
+		mCopyGlobal->setEnabled( false );
+		btns->addWidget( mCopyGlobal );
+		connect( mCustom, SIGNAL( toggled( bool ) ),
+					mWidget, SLOT( setEnabled( bool ) ) );
+		connect( mCustom, SIGNAL( toggled( bool ) ),
+					mCopyGlobal, SLOT( setEnabled( bool ) ) );
+		connect( mCopyGlobal, SIGNAL(clicked()),
+					this, SLOT(slotCopyGlobal()) );
+		
     //
     // Tab Widget: Signature
     //
@@ -401,6 +435,10 @@
       mSMIMESigningKeyRequester->setInitialQuery( email );
     }
   }
+  
+  void IdentityDialog::slotCopyGlobal() {
+    mWidget->loadFromGlobal();
+  }
 
   namespace {
     struct DoesntMatchEMailAddress {
@@ -584,7 +622,25 @@
       mDraftsCombo->setFolder( kmkernel->draftsFolder() );
     else
       mDraftsCombo->setFolder( ident.drafts() );
-
+    
+    if ( ident.templates().isEmpty() ||
+         !checkFolderExists( ident.templates(),
+                             i18n("The custom templates folder for identity "
+                                  "\"%1\" does not exist (anymore); "
+                                  "therefore, the default templates folder "
+                                  "will be used.")
+                             .arg( ident.identityName() ) ) )
+      mTemplatesCombo->setFolder( kmkernel->templatesFolder() );
+    else
+      mTemplatesCombo->setFolder( ident.templates() );
+    
+    // "Templates" tab:
+    uint identity = ident.uoid();
+		QString iid = QString("IDENTITY_%1").arg( identity );
+		Templates t( iid );
+		mCustom->setChecked(t.useCustomTemplates());
+		mWidget->loadFromIdentity( identity );
+    
     // "Signature" tab:
     mSignatureConfigurator->setSignature( ident.signature() );
     mXFaceConfigurator->setXFace( ident.xface() );
@@ -613,6 +669,16 @@
                   mFccCombo->folder()->idString() : QString::null );
     ident.setDrafts( mDraftsCombo->folder() ?
                      mDraftsCombo->folder()->idString() : QString::null );
+    ident.setTemplates( mTemplatesCombo->folder() ?
+                     mTemplatesCombo->folder()->idString() : QString::null );
+    // "Templates" tab:
+    uint identity = ident.uoid();
+    QString iid = QString("IDENTITY_%1").arg( identity );
+    Templates t( iid );
+		kdDebug() << "use custom templates for identity " << identity << ": " << mCustom->isChecked() << endl;
+		t.setUseCustomTemplates(mCustom->isChecked());
+		t.writeConfig();
+		mWidget->saveToIdentity( identity );
     // "Signature" tab:
     ident.setSignature( mSignatureConfigurator->signature() );
     ident.setXFace( mXFaceConfigurator->xface() );
Index: kmail/kmfilteraction.cpp
===================================================================
--- kmail/kmfilteraction.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfilteraction.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,6 +26,7 @@
 #include "folderrequester.h"
 using KMail::FolderRequester;
 #include "kmmsgbase.h"
+#include "templateparser.h"
 #include "messageproperty.h"
 #include "actionscheduler.h"
 using KMail::MessageProperty;
@@ -1452,14 +1453,19 @@
 
   msg->initFromMessage( aMsg );
 
-  QString st = QString::fromUtf8( aMsg->createForwardBody() );
+  // QString st = QString::fromUtf8( aMsg->createForwardBody() );
+  
+  TemplateParser parser( msg, TemplateParser::Forward, 
+    aMsg->body(), false, false, false, false);
+  parser.process( aMsg );
+  
   QCString
     encoding = KMMsgBase::autoDetectCharset( aMsg->charset(),
                                              KMMessage::preferredCharsets(),
-                                             st );
+                                             msg->body() );
   if( encoding.isEmpty() )
     encoding = "utf-8";
-  QCString str = KMMsgBase::codecForName( encoding )->fromUnicode( st );
+  QCString str = KMMsgBase::codecForName( encoding )->fromUnicode( msg->body() );
 
   msg->setCharset( encoding );
   msg->setTo( mParameter );
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -255,6 +255,9 @@
     //mBtnFrom = 0;
 
     mRecipientsEditor = new RecipientsEditor( mMainWidget );
+    connect( mRecipientsEditor,
+             SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+             SLOT( slotCompletionModeChanged( KGlobalSettings::Completion ) ) );
 
     mRecipientsEditor->setFocus();
   }
@@ -333,7 +336,7 @@
 
   connect( mAtmListView,
            SIGNAL( doubleClicked( QListViewItem* ) ),
-           SLOT( slotAttachProperties() ) );
+           SLOT( slotAttachOpen() ) );
   connect( mAtmListView,
            SIGNAL( rightButtonPressed( QListViewItem*, const QPoint&, int ) ),
            SLOT( slotAttachPopupMenu( QListViewItem*, const QPoint&, int ) ) );
@@ -581,6 +584,8 @@
     mEdtCc->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
     mEdtBcc->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
   }
+  else
+    mRecipientsEditor->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
 
   readColorConfig();
 
@@ -620,18 +625,11 @@
   while ( transportHistory.count() > (uint)GlobalSettings::self()->maxTransportEntries() )
     transportHistory.remove( transportHistory.last() );
   mTransport->insertStringList( transportHistory );
-  if (mBtnTransport->isChecked() && !currentTransport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == currentTransport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( currentTransport );
+  mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+  if ( mBtnTransport->isChecked() ) {
+    setTransport( currentTransport );
   }
 
-  if ( !mBtnTransport->isChecked() ) {
-    mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
-  }
-
   QString fccName = "";
   if ( mBtnFcc->isChecked() ) {
     fccName = GlobalSettings::self()->previousFcc();
@@ -1155,9 +1153,12 @@
 
 
 
-  (void) new KAction (i18n("Save in &Drafts Folder"), "filesave", 0,
+  (void) new KAction (i18n("Save as &Draft"), "filesave", 0,
                       this, SLOT(slotSaveDraft()),
                       actionCollection(), "save_in_drafts");
+  (void) new KAction (i18n("Save as &Template"), "filesave", 0,
+                      this, SLOT(slotSaveTemplate()),
+                      actionCollection(), "save_in_templates");
   (void) new KAction (i18n("&Insert File..."), "fileopen", 0,
                       this,  SLOT(slotInsertFile()),
                       actionCollection(), "insert_file");
@@ -1457,7 +1458,7 @@
   // up KMail's config dialog. That's sensible, though, so fix the label.
   KAction* configureAction = actionCollection()->action("options_configure" );
   if ( configureAction )
-    configureAction->setText( i18n("Configure KMail" ) );
+    configureAction->setText( i18n("Configure KMail..." ) );
 }
 
 //-----------------------------------------------------------------------------
@@ -1659,6 +1660,37 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::setTransport( const QString & transport )
+{
+  kdDebug(5006) << "KMComposeWin::setTransport( \"" << transport << "\" )" << endl;
+  // Don't change the transport combobox if transport is empty
+  if ( transport.isEmpty() )
+    return;
+
+  bool transportFound = false;
+  for ( int i = 0; i < mTransport->count(); ++i ) {
+    if ( mTransport->text(i) == transport ) {
+      transportFound = true;
+      mTransport->setCurrentItem(i);
+      kdDebug(5006) << "transport found, it's no. " << i << " in the list" << endl;
+      break;
+    }
+  }
+  if ( !transportFound ) { // unknown transport
+    kdDebug(5006) << "unknown transport \"" << transport << "\"" << endl;
+    if ( transport.startsWith("smtp://") || transport.startsWith("smtps://") ||
+         transport.startsWith("file://") ) {
+      // set custom transport
+      mTransport->setEditText( transport );
+    }
+    else {
+      // neither known nor custom transport -> use default transport
+      mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 void KMComposeWin::setMsg(KMMessage* newMsg, bool mayAutoSign,
                           bool allowDecryption, bool isModified)
 {
@@ -1778,12 +1810,7 @@
 
   QString transport = newMsg->headerField("X-KMail-Transport");
   if (!mBtnTransport->isChecked() && !transport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == transport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( transport );
-  }
+    setTransport( transport );
 
   if (!mBtnFcc->isChecked())
   {
@@ -1947,6 +1974,9 @@
     QTimer::singleShot( 200, this, SLOT(slotAppendSignature()) );
   }
   setModified( isModified );
+
+  // do this even for new messages
+  mEditor->setCursorPositionFromStart( (unsigned int) mMsg->getCursorPos() );
 }
 
 
@@ -2002,22 +2032,34 @@
 {
   if ( !mEditor->checkExternalEditorFinished() )
     return false;
-  if (kmkernel->shuttingDown() || kapp->sessionSaving())
+  if ( kmkernel->shuttingDown() || kapp->sessionSaving() )
     return true;
 
   if ( isModified() ) {
-    const int rc = KMessageBox::warningYesNoCancel(this,
+    bool istemplate = ( mFolder!=0 && mFolder->isTemplates() );
+    const QString savebut = ( istemplate ?
+                              i18n("Re&save as Template") :
+                              i18n("&Save as Draft") );
+    const QString savetext = ( istemplate ?
+                               i18n("Resave this message in the Templates folder. "
+                                    "It can then be used at a later time.") :
+                               i18n("Save this message in the Drafts folder. "
+                                    "It can then be edited and sent at a later time.") );
+
+    const int rc = KMessageBox::warningYesNoCancel( this,
            i18n("Do you want to save the message for later or discard it?"),
            i18n("Close Composer"),
-           KGuiItem(i18n("&Save as Draft"), "filesave", QString::null,
-                  i18n("Save this message in the Drafts folder. It can "
-                  "then be edited and sent at a later time.")),
+           KGuiItem(savebut, "filesave", QString::null, savetext),
            KStdGuiItem::discard() );
-    if (rc == KMessageBox::Cancel)
+    if ( rc == KMessageBox::Cancel )
       return false;
-    else if (rc == KMessageBox::Yes) {
+    else if ( rc == KMessageBox::Yes ) {
       // doSend will close the window. Just return false from this method
-      slotSaveDraft();
+      if ( istemplate ) {
+        slotSaveTemplate();
+      } else {
+        slotSaveDraft();
+      }
       return false;
     }
   }
@@ -2254,6 +2296,7 @@
   lvi->setText(1, KIO::convertSize( msgPart->decodedSize()));
   lvi->setText(2, msgPart->contentTransferEncodingStr());
   lvi->setText(3, prettyMimeType(msgPart->typeStr() + "/" + msgPart->subtypeStr()));
+  lvi->setAttachmentSize(msgPart->decodedSize());
 
   if ( loadDefaults ) {
     if( canSignEncryptAttachments() ) {
@@ -2898,6 +2941,8 @@
 
      mOpenId = mAttachMenu->insertItem(i18n("to open", "Open"), this,
                              SLOT(slotAttachOpen()));
+     mOpenWithId = mAttachMenu->insertItem(i18n("Open With..."), this,
+                             SLOT(slotAttachOpenWith()));
      mViewId = mAttachMenu->insertItem(i18n("to view", "View"), this,
                              SLOT(slotAttachView()));
      mRemoveId = mAttachMenu->insertItem(i18n("Remove"), this, SLOT(slotAttachRemove()));
@@ -2917,6 +2962,7 @@
   }
 
   mAttachMenu->setItemEnabled( mOpenId, selectedCount > 0 );
+  mAttachMenu->setItemEnabled( mOpenWithId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mViewId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mRemoveId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mSaveAsId, selectedCount == 1 );
@@ -3142,12 +3188,23 @@
   int i = 0;
   for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
     if ( (*it)->isSelected() ) {
-      openAttach( i );
+      openAttach( i, false );
     }
   }
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::slotAttachOpenWith()
+{
+  int i = 0;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
+    if ( (*it)->isSelected() ) {
+      openAttach( i, true );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 bool KMComposeWin::inlineSigningEncryptionSelected() {
   if ( !mSignAction->isChecked() && !mEncryptAction->isChecked() )
     return false;
@@ -3175,7 +3232,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::openAttach( int index )
+void KMComposeWin::openAttach( int index, bool with )
 {
   KMMessagePart* msgPart = mAtmList.at(index);
   const QString contentTypeStr =
@@ -3202,7 +3259,7 @@
   KService::Ptr offer =
     KServiceTypeProfile::preferredService( mimetype->name(), "Application" );
 
-  if ( !offer || mimetype->name() == "application/octet-stream" ) {
+  if ( with || !offer || mimetype->name() == "application/octet-stream" ) {
     if ( ( !KRun::displayOpenWithDialog( url, autoDelete ) ) && autoDelete ) {
       QFile::remove(url.path());
     }
@@ -3454,7 +3511,7 @@
 #undef KeyPress
 #endif
 
-  QKeyEvent k(QEvent::KeyPress, Key_C , 0 , ControlButton);
+  QKeyEvent k(QEvent::KeyPress, Key_C, 0, ControlButton);
   kapp->notify(fw, &k);
 }
 
@@ -3474,7 +3531,7 @@
 #undef KeyPress
 #endif
 
-    QKeyEvent k(QEvent::KeyPress, Key_V , 0 , ControlButton);
+    QKeyEvent k(QEvent::KeyPress, Key_V, 0, ControlButton);
     kapp->notify(fw, &k);
   }
 
@@ -3681,7 +3738,8 @@
 }
 
 //----------------------------------------------------------------------------
-void KMComposeWin::doSend( KMail::MessageSender::SendMethod method, bool saveInDrafts)
+void KMComposeWin::doSend( KMail::MessageSender::SendMethod method,
+                           KMComposeWin::SaveIn saveIn )
 {
   if ( method != KMail::MessageSender::SendLater && kmkernel->isOffline() ) {
     KMessageBox::information( this,
@@ -3692,10 +3750,9 @@
   } else {
     mSendMethod = method;
   }
-  mSaveInDrafts = saveInDrafts;
+  mSaveIn = saveIn;
 
-  if (!saveInDrafts)
-  {
+  if ( saveIn == KMComposeWin::None ) {
     if ( KPIM::getFirstEmailAddress( from() ).isEmpty() ) {
       if ( !( mShowHeaders & HDR_FROM ) ) {
         mShowHeaders |= HDR_FROM;
@@ -3765,9 +3822,9 @@
       (!hf.isEmpty() && (hf != mTransport->text(0))))
     mMsg->setHeaderField("X-KMail-Transport", mTransport->currentText());
 
-  mDisableBreaking = saveInDrafts;
+  mDisableBreaking = ( saveIn != KMComposeWin::None );
 
-  const bool neverEncrypt = ( saveInDrafts && GlobalSettings::self()->neverEncryptDrafts() )
+  const bool neverEncrypt = ( mDisableBreaking && GlobalSettings::self()->neverEncryptDrafts() )
                            || mSigningAndEncryptionExplicitlyDisabled;
   connect( this, SIGNAL( applyChangesDone( bool ) ),
            SLOT( slotContinueDoSend( bool ) ) );
@@ -3807,6 +3864,59 @@
   applyChanges( neverEncrypt );
 }
 
+bool KMComposeWin::saveDraftOrTemplate( const QString &folderName,
+                                        KMMessage *msg )
+{
+  KMFolder *theFolder = 0, *imapTheFolder = 0;
+  // get the draftsFolder
+  if ( !folderName.isEmpty() ) {
+    theFolder = kmkernel->folderMgr()->findIdString( folderName );
+    if ( theFolder == 0 )
+      // This is *NOT* supposed to be "imapDraftsFolder", because a
+      // dIMAP folder works like a normal folder
+      theFolder = kmkernel->dimapFolderMgr()->findIdString( folderName );
+    if ( theFolder == 0 )
+      imapTheFolder = kmkernel->imapFolderMgr()->findIdString( folderName );
+    if ( !theFolder && !imapTheFolder ) {
+      const KPIM::Identity & id = kmkernel->identityManager()
+        ->identityForUoidOrDefault( msg->headerField( "X-KMail-Identity" ).stripWhiteSpace().toUInt() );
+      KMessageBox::information( 0,
+                                i18n("The custom drafts or templates folder for "
+                                     "identify \"%1\" does not exist (anymore); "
+                                     "therefore, the default drafts or templates "
+                                     "folder will be used.")
+                                .arg( id.identityName() ) );
+    }
+  }
+  if ( imapTheFolder && imapTheFolder->noContent() )
+    imapTheFolder = 0;
+
+  if ( theFolder == 0 ) {
+    theFolder = ( mSaveIn==KMComposeWin::Drafts ?
+                  kmkernel->draftsFolder() : kmkernel->templatesFolder() );
+  } else {
+    theFolder->open();
+  }
+  kdDebug(5006) << k_funcinfo << "theFolder=" << theFolder->name() << endl;
+  if ( imapTheFolder )
+    kdDebug(5006) << k_funcinfo << "imapTheFolder=" << imapTheFolder->name() << endl;
+
+  bool sentOk = !( theFolder->addMsg( msg ) );
+
+  // Ensure the message is correctly and fully parsed
+  theFolder->unGetMsg( theFolder->count() - 1 );
+  msg = theFolder->getMsg( theFolder->count() - 1 );
+  // Does that assignment needs to be propagated out to the caller?
+  // Assuming the send is OK, the iterator is set to 0 immediately afterwards.
+  if ( imapTheFolder ) {
+    // move the message to the imap-folder and highlight it
+    imapTheFolder->moveMsg( msg );
+    (static_cast<KMFolderImap*>( imapTheFolder->storage() ))->getFolder();
+  }
+
+  return sentOk;
+}
+
 void KMComposeWin::slotContinueDoSend( bool sentOk )
 {
   kdDebug(5006) << "KMComposeWin::slotContinueDoSend( " << sentOk << " )"
@@ -3827,52 +3937,10 @@
     // needed for imap
     (*it)->setComplete( true );
 
-    if (mSaveInDrafts) {
-      KMFolder* draftsFolder = 0, *imapDraftsFolder = 0;
-      // get the draftsFolder
-      if ( !(*it)->drafts().isEmpty() ) {
-        draftsFolder = kmkernel->folderMgr()->findIdString( (*it)->drafts() );
-        if ( draftsFolder == 0 )
-          // This is *NOT* supposed to be "imapDraftsFolder", because a
-          // dIMAP folder works like a normal folder
-          draftsFolder = kmkernel->dimapFolderMgr()->findIdString( (*it)->drafts() );
-        if ( draftsFolder == 0 )
-          imapDraftsFolder = kmkernel->imapFolderMgr()->findIdString( (*it)->drafts() );
-        if ( !draftsFolder && !imapDraftsFolder ) {
-          const KPIM::Identity & id = kmkernel->identityManager()
-            ->identityForUoidOrDefault( (*it)->headerField( "X-KMail-Identity" ).stripWhiteSpace().toUInt() );
-          KMessageBox::information(0, i18n("The custom drafts folder for identity "
-                                           "\"%1\" does not exist (anymore); "
-                                           "therefore, the default drafts folder "
-                                           "will be used.")
-                                   .arg( id.identityName() ) );
-        }
-      }
-      if (imapDraftsFolder && imapDraftsFolder->noContent())
-	imapDraftsFolder = 0;
-
-      if ( draftsFolder == 0 ) {
-	draftsFolder = kmkernel->draftsFolder();
-      } else {
-	draftsFolder->open();
-      }
-      kdDebug(5006) << "saveindrafts: drafts=" << draftsFolder->name() << endl;
-      if (imapDraftsFolder)
-	kdDebug(5006) << "saveindrafts: imapdrafts="
-		      << imapDraftsFolder->name() << endl;
-
-      sentOk = !(draftsFolder->addMsg((*it)));
-
-      //Ensure the drafts message is correctly and fully parsed
-      draftsFolder->unGetMsg(draftsFolder->count() - 1);
-      (*it) = draftsFolder->getMsg(draftsFolder->count() - 1);
-
-      if (imapDraftsFolder) {
-	// move the message to the imap-folder and highlight it
-	imapDraftsFolder->moveMsg((*it));
-	(static_cast<KMFolderImap*>(imapDraftsFolder->storage()))->getFolder();
-      }
-
+    if ( mSaveIn==KMComposeWin::Drafts ) {
+      sentOk = saveDraftOrTemplate( (*it)->drafts(), (*it) );
+    } else if ( mSaveIn==KMComposeWin::Templates ) {
+      sentOk = saveDraftOrTemplate( (*it)->templates(), (*it) );
     } else {
       (*it)->setTo( KMMessage::expandAliases( to() ));
       (*it)->setCc( KMMessage::expandAliases( cc() ));
@@ -3917,9 +3985,14 @@
 //----------------------------------------------------------------------------
 void KMComposeWin::slotSaveDraft() {
   if ( mEditor->checkExternalEditorFinished() )
-    doSend( KMail::MessageSender::SendLater, true );
+    doSend( KMail::MessageSender::SendLater, KMComposeWin::Drafts );
 }
 
+//----------------------------------------------------------------------------
+void KMComposeWin::slotSaveTemplate() {
+  if ( mEditor->checkExternalEditorFinished() )
+    doSend( KMail::MessageSender::SendLater, KMComposeWin::Templates );
+}
 
 //----------------------------------------------------------------------------
 void KMComposeWin::slotSendNowVia( int item )
@@ -3963,7 +4036,6 @@
     doSend( KMail::MessageSender::SendImmediate );
 }
 
-
 //----------------------------------------------------------------------------
 void KMComposeWin::slotAppendSignature()
 {
@@ -3976,7 +4048,8 @@
   {
     mEditor->append(mOldSigText);
     mEditor->setModified(mod);
-    mEditor->setContentsPos( 0, 0 );
+    // mEditor->setContentsPos( 0, 0 );
+    mEditor->setCursorPositionFromStart( (unsigned int) mMsg->getCursorPos() );
     mEditor->sync();
   }
 }
@@ -4280,24 +4353,11 @@
     if ( transp.isEmpty() )
     {
       mMsg->removeHeaderField("X-KMail-Transport");
-      transp = mTransport->text(0);
+      transp = GlobalSettings::self()->defaultTransport();
     }
     else
       mMsg->setHeaderField("X-KMail-Transport", transp);
-    bool found = false;
-    int i;
-    for (i = 0; i < mTransport->count(); i++) {
-      if (mTransport->text(i) == transp) {
-        found = true;
-        mTransport->setCurrentItem(i);
-        break;
-      }
-    }
-    if (found == false) {
-      if (i == mTransport->maxCount()) mTransport->setMaxCount(i + 1);
-      mTransport->insertItem(transp,i);
-      mTransport->setCurrentItem(i);
-    }
+    setTransport( transp );
   }
 
   mDictionaryCombo->setCurrentByDictionary( ident.dictionary() );
@@ -4422,8 +4482,13 @@
 void KMComposeWin::setReplyFocus( bool hasMessage )
 {
   mEditor->setFocus();
-  if ( hasMessage )
-    mEditor->setCursorPosition( 1, 0 );
+  if ( hasMessage ) {
+    if( mMsg->getCursorPos() ) {
+      mEditor->setCursorPositionFromStart( (unsigned int) mMsg->getCursorPos() );
+    } else {
+      mEditor->setCursorPosition( 1, 0 );
+    }
+  }
 }
 
 void KMComposeWin::setFocusToSubject()
@@ -4494,7 +4559,8 @@
     mEdtTo->setCompletionMode( mode );
     mEdtCc->setCompletionMode( mode );
     mEdtBcc->setCompletionMode( mode );
-  }
+  }else
+    mRecipientsEditor->setCompletionMode( mode );
 }
 
 void KMComposeWin::slotConfigChanged()
@@ -4510,6 +4576,7 @@
 */
 void KMComposeWin::slotFolderRemoved(KMFolder* folder)
 {
+  // TODO: need to handle templates here?
   if ( (mFolder) && (folder->idString() == mFolder->idString()) )
   {
     mFolder = kmkernel->draftsFolder();
Index: kmail/kmail_view.desktop
===================================================================
--- kmail/kmail_view.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_view.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,6 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KMail
-Name[ar]=البريد
 Name[be]=K Пошта
 Name[eo]=Retpoŝto
 Name[hi]=के-मेल
Index: kmail/kmfolderdia.cpp
===================================================================
--- kmail/kmfolderdia.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfolderdia.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,6 +56,7 @@
 #include <kconfig.h>
 #include <kdebug.h>
 #include <klistview.h>
+#include <kpushbutton.h>
 
 #include <qcheckbox.h>
 #include <qlayout.h>
@@ -69,7 +70,11 @@
 #include <assert.h>
 #include <qhbuttongroup.h>
 #include <qradiobutton.h>
+#include <qtextedit.h>
 
+#include "templatesconfiguration.h"
+#include "templatesconfiguration_kfg.h"
+
 #include "kmfolderdia.moc"
 
 using namespace KMail;
@@ -115,6 +120,9 @@
   box = addVBoxPage( i18n("General") );
   tab = new FolderDiaGeneralTab( this, aName, box );
   addTab( tab );
+  box = addVBoxPage( i18n("Templates") );
+  tab = new FolderDiaTemplatesTab( this, aName, box );
+  addTab( tab );
 
   KMFolder* refFolder = mFolder ? mFolder : mParentFolder;
   KMFolderType folderType = refFolder ? refFolder->folderType() : KMFolderTypeUnknown;
@@ -647,3 +655,93 @@
 {
     mUnreadIconButton->setIcon( icon );
 }
+
+//----------------------------------------------------------------------------
+KMail::FolderDiaTemplatesTab::FolderDiaTemplatesTab( KMFolderDialog* dlg,
+                                                 const QString& aName,
+                                                 QWidget* parent, const char* name )
+  : FolderDiaTab( parent, name ), mDlg( dlg )
+{
+
+  mIsLocalSystemFolder = mDlg->folder()->isSystemFolder() &&
+       mDlg->folder()->folderType() != KMFolderTypeImap &&
+       mDlg->folder()->folderType() != KMFolderTypeCachedImap;
+
+  QVBoxLayout *topLayout = new QVBoxLayout( this, 0, KDialog::spacingHint() );
+  
+  mCustom = new QCheckBox( i18n("&Use custom message templates"), this );
+  topLayout->addWidget( mCustom );
+  
+  mWidget = new TemplatesConfiguration( this , "folder-templates" );
+  mWidget->setEnabled( false );
+  topLayout->addWidget( mWidget );
+  
+  QHBoxLayout *btns = new QHBoxLayout( topLayout, KDialog::spacingHint() );
+  mCopyGlobal = new KPushButton( i18n("&Copy global templates"), this );
+  mCopyGlobal->setEnabled( false );
+  btns->addWidget( mCopyGlobal );
+  
+  connect( mCustom, SIGNAL(toggled(bool)),
+        mWidget, SLOT(setEnabled(bool)) );
+  connect( mCustom, SIGNAL(toggled(bool)),
+        mCopyGlobal, SLOT(setEnabled(bool)) );
+  
+  connect( mCopyGlobal, SIGNAL(clicked()),
+        this, SLOT(slotCopyGlobal()) );
+
+  initializeWithValuesFromFolder( mDlg->folder() );
+
+  connect( mWidget, SIGNAL( changed() ),
+           this, SLOT( slotEmitChanged( void ) ) );
+}
+
+void FolderDiaTemplatesTab::load()
+{
+  
+}
+
+void FolderDiaTemplatesTab::initializeWithValuesFromFolder( KMFolder* folder ) {
+  if ( !folder )
+    return;
+  
+  mFolder = folder;
+
+  QString fid = folder->idString();
+  
+  Templates t( fid );
+
+  mCustom->setChecked(t.useCustomTemplates());
+  
+  mIdentity = folder->identity();
+  
+  mWidget->loadFromFolder( fid, mIdentity );
+}
+
+//-----------------------------------------------------------------------------
+bool FolderDiaTemplatesTab::save()
+{
+  KMFolder* folder = mDlg->folder();
+  
+  QString fid = folder->idString();
+  Templates t(fid);
+  
+  kdDebug() << "use custom templates for folder " << fid << ": " << mCustom->isChecked() << endl;
+  t.setUseCustomTemplates(mCustom->isChecked());
+  t.writeConfig();
+  
+  mWidget->saveToFolder(fid);
+  
+  return true;
+}
+
+
+void FolderDiaTemplatesTab::slotEmitChanged() {}
+
+void FolderDiaTemplatesTab::slotCopyGlobal() {
+  if ( mIdentity ) {
+    mWidget->loadFromIdentity( mIdentity );
+  }
+  else {
+    mWidget->loadFromGlobal();
+  }
+}
Index: kmail/templatesinsertcommand.cpp
===================================================================
--- kmail/templatesinsertcommand.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesinsertcommand.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,402 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov <dmiceman@mail.ru>
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#include <qpushbutton.h>
+#include <kaction.h>
+#include <kactionclasses.h>
+#include <kpopupmenu.h>
+#include <klocale.h>
+#include <qsignalmapper.h>
+#include <kdebug.h>
+
+#include "templatesinsertcommand.h"
+
+TemplatesInsertCommand::TemplatesInsertCommand( QWidget *parent,
+                                                const char *name )
+  : QPushButton( parent, name )
+{
+  setText( i18n( "&Insert command..." ) );
+  connect( this, SIGNAL( clicked() ),
+           this, SLOT( slotClicked() ) );
+
+  KAction *action;
+  KActionMenu *menu;
+
+  QSignalMapper *mapper = new QSignalMapper( this );
+  connect( mapper, SIGNAL( mapped(int) ),
+           this, SLOT( slotMapped(int) ) );
+
+  mMenu = new KActionMenu( i18n( "Insert command" ), this );
+
+  // ******************************************************
+  menu = new KActionMenu( i18n( "Original message" ), mMenu );
+  mMenu->insert( menu );
+
+  action = new KAction( i18n("Quoted message"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CQuote );
+  menu->insert( action );
+  action = new KAction( i18n("Message text as is"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CText );
+  menu->insert( action );
+  action = new KAction( i18n("Message id"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COMsgId );
+  menu->insert( action );
+  action = new KAction( i18n("Date"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CODate );
+  menu->insert( action );
+  action = new KAction( i18n("Date in short format"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CODateShort );
+  menu->insert( action );
+  action = new KAction( i18n("Date in C locale"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CODateEn );
+  menu->insert( action );
+  action = new KAction( i18n("Day of week"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CODow );
+  menu->insert( action );
+  action = new KAction( i18n("Time"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COTime );
+  menu->insert( action );
+  action = new KAction( i18n("Time in long format"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COTimeLong );
+  menu->insert( action );
+  action = new KAction( i18n("Time in C locale"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COTimeLongEn );
+  menu->insert( action );
+  action = new KAction( i18n("To field address"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COToAddr );
+  menu->insert( action );
+  action = new KAction( i18n("To field name"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COToName );
+  menu->insert( action );
+  action = new KAction( i18n("To field first name"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COToFName );
+  menu->insert( action );
+  action = new KAction( i18n("To field last name"),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COToLName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field address" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COCCAddr );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COCCName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field first name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COCCFName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field last name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COCCLName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field address" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COFromAddr );
+  menu->insert( action );
+  action = new KAction( i18n( "From field name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COFromName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field first name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COFromFName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field last name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COFromLName );
+  menu->insert( action );
+  action = new KAction( i18n( "Subject" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COFullSubject );
+  menu->insert( action );
+  action = new KAction( i18n( "Quoted headers" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CQHeaders );
+  menu->insert( action );
+  action = new KAction( i18n( "Headers as is" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CHeaders );
+  menu->insert( action );
+  action = new KAction( i18n( "Header content" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, COHeader );
+  menu->insert( action );
+
+  // ******************************************************
+  menu = new KActionMenu( i18n( "Current message" ), mMenu );
+  mMenu->insert( menu );
+
+  action = new KAction( i18n( "Message id" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CMsgId );
+  menu->insert( action );
+  action = new KAction( i18n( "Date" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDate );
+  menu->insert( action );
+  action = new KAction( i18n( "Date in short format" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDateShort );
+  menu->insert( action );
+  action = new KAction( i18n( "Date in C locale" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDateEn );
+  menu->insert( action );
+  action = new KAction( i18n( "Day of week" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDow );
+  menu->insert( action );
+  action = new KAction( i18n( "Time" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CTime );
+  menu->insert( action );
+  action = new KAction( i18n( "Time in long format" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CTimeLong );
+  menu->insert( action );
+  action = new KAction( i18n( "Time in C locale" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CTimeLongEn );
+  menu->insert( action );
+  action = new KAction( i18n( "To field address" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CToAddr );
+  menu->insert( action );
+  action = new KAction( i18n( "To field name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CToName );
+  menu->insert( action );
+  action = new KAction( i18n( "To field first name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CToFName );
+  menu->insert( action );
+  action = new KAction( i18n( "To field last name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CToLName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field address" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CCCAddr );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CCCName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field first name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CCCFName );
+  menu->insert( action );
+  action = new KAction( i18n( "CC field last name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CCCLName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field address" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CFromAddr );
+  menu->insert( action );
+  action = new KAction( i18n( "From field name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CFromName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field first name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CFromFName );
+  menu->insert( action );
+  action = new KAction( i18n( "From field last name" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CFromLName );
+  menu->insert( action );
+  action = new KAction( i18n( "Subject" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CFullSubject );
+  menu->insert( action );
+  action = new KAction( i18n( "Header content" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CHeader );
+  menu->insert( action );
+
+  // ******************************************************
+  menu = new KActionMenu( i18n( "Process with external programs" ), mMenu );
+  mMenu->insert( menu );
+
+  action = new KAction( i18n( "Insert result of command" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CSystem );
+  menu->insert( action );
+  action = new KAction( i18n( "Pipe original message body and insert result as quoted text" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CQuotePipe );
+  menu->insert( action );
+  action = new KAction( i18n( "Pipe original message body and insert result as is" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CTextPipe );
+  menu->insert( action );
+  action = new KAction( i18n( "Pipe original message with headers and insert result as is" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CMsgPipe );
+  menu->insert( action );
+  action = new KAction( i18n( "Pipe current message body and insert result as is" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CBodyPipe );
+  menu->insert( action );
+  action = new KAction( i18n( "Pipe current message body and replace with result" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CClearPipe );
+  menu->insert( action );
+
+  // ******************************************************
+  menu = new KActionMenu( i18n( "Miscellaneous" ), mMenu );
+  mMenu->insert( menu );
+
+  action = new KAction( i18n( "Set cursor position" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CCursor );
+  menu->insert( action );
+  action = new KAction( i18n( "Insert file content" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CInsert );
+  menu->insert( action );
+  action = new KAction( i18n( "DNL" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDnl );
+  menu->insert( action );
+  action = new KAction( i18n( "Template comment" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CRem );
+  menu->insert( action );
+  action = new KAction( i18n( "No operation" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CNop );
+  menu->insert( action );
+  action = new KAction( i18n( "Clear generated message" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CClear );
+  menu->insert( action );
+  action = new KAction( i18n( "Turn debug on" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDebug );
+  menu->insert( action );
+  action = new KAction( i18n( "Turn debug off" ),
+                        0, mapper, SLOT( map() ), menu );
+  mapper->setMapping( action, CDebugOff );
+  menu->insert( action );
+}
+
+TemplatesInsertCommand::~TemplatesInsertCommand()
+{
+}
+
+void TemplatesInsertCommand::slotClicked()
+{
+  QSize ps = mMenu->popupMenu()->sizeHint();
+  mMenu->popup( mapToGlobal( QPoint( 0, -(ps.height()) ) ) );
+}
+
+void TemplatesInsertCommand::slotMapped( int cmd )
+{
+  emit insertCommand( static_cast<Command>( cmd ) );
+
+  switch( cmd ) {
+  case TemplatesInsertCommand::CQuote: emit insertCommand("%QUOTE"); break;
+  case TemplatesInsertCommand::CText: emit insertCommand("%TEXT"); break;
+  case TemplatesInsertCommand::COMsgId: emit insertCommand("%OMSGID"); break;
+  case TemplatesInsertCommand::CODate: emit insertCommand("%ODATE"); break;
+  case TemplatesInsertCommand::CODateShort: emit insertCommand("%ODATESHORT"); break;
+  case TemplatesInsertCommand::CODateEn: emit insertCommand("%ODATEEN"); break;
+  case TemplatesInsertCommand::CODow: emit insertCommand("%ODOW"); break;
+  case TemplatesInsertCommand::COTime: emit insertCommand("%OTIME"); break;
+  case TemplatesInsertCommand::COTimeLong: emit insertCommand("%OTIMELONG"); break;
+  case TemplatesInsertCommand::COTimeLongEn: emit insertCommand("%OTIMELONGEN"); break;
+  case TemplatesInsertCommand::COToAddr: emit insertCommand("%OTOADDR"); break;
+  case TemplatesInsertCommand::COToName: emit insertCommand("%OTONAME"); break;
+  case TemplatesInsertCommand::COToFName: emit insertCommand("%OTOFNAME"); break;
+  case TemplatesInsertCommand::COToLName: emit insertCommand("%OTOLNAME"); break;
+  case TemplatesInsertCommand::COCCAddr: emit insertCommand("%OCCADDR"); break;
+  case TemplatesInsertCommand::COCCName: emit insertCommand("%OCCNAME"); break;
+  case TemplatesInsertCommand::COCCFName: emit insertCommand("%OCCFNAME"); break;
+  case TemplatesInsertCommand::COCCLName: emit insertCommand("%OCCLNAME"); break;
+  case TemplatesInsertCommand::COFromAddr: emit insertCommand("%OFROMADDR"); break;
+  case TemplatesInsertCommand::COFromName: emit insertCommand("%OFROMNAME"); break;
+  case TemplatesInsertCommand::COFromFName: emit insertCommand("%OFROMFNAME"); break;
+  case TemplatesInsertCommand::COFromLName: emit insertCommand("%OFROMLNAME"); break;
+  case TemplatesInsertCommand::COFullSubject: emit insertCommand("%OFULLSUBJECT"); break;
+  case TemplatesInsertCommand::CQHeaders: emit insertCommand("%QHEADERS"); break;
+  case TemplatesInsertCommand::CHeaders: emit insertCommand("%HEADERS"); break;
+  case TemplatesInsertCommand::COHeader: emit insertCommand("%OHEADER=\"\"", -1); break;
+  case TemplatesInsertCommand::CMsgId: emit insertCommand("%MSGID"); break;
+  case TemplatesInsertCommand::CDate: emit insertCommand("%DATE"); break;
+  case TemplatesInsertCommand::CDateShort: emit insertCommand("%DATESHORT"); break;
+  case TemplatesInsertCommand::CDateEn: emit insertCommand("%DATEEN"); break;
+  case TemplatesInsertCommand::CDow: emit insertCommand("%DOW"); break;
+  case TemplatesInsertCommand::CTime: emit insertCommand("%TIME"); break;
+  case TemplatesInsertCommand::CTimeLong: emit insertCommand("%TIMELONG"); break;
+  case TemplatesInsertCommand::CTimeLongEn: emit insertCommand("%TIMELONGEN"); break;
+  case TemplatesInsertCommand::CToAddr: emit insertCommand("%TOADDR"); break;
+  case TemplatesInsertCommand::CToName: emit insertCommand("%TONAME"); break;
+  case TemplatesInsertCommand::CToFName: emit insertCommand("%TOFNAME"); break;
+  case TemplatesInsertCommand::CToLName: emit insertCommand("%TOLNAME"); break;
+  case TemplatesInsertCommand::CCCAddr: emit insertCommand("%CCADDR"); break;
+  case TemplatesInsertCommand::CCCName: emit insertCommand("%CCNAME"); break;
+  case TemplatesInsertCommand::CCCFName: emit insertCommand("%CCFNAME"); break;
+  case TemplatesInsertCommand::CCCLName: emit insertCommand("%CCLNAME"); break;
+  case TemplatesInsertCommand::CFromAddr: emit insertCommand("%FROMADDR"); break;
+  case TemplatesInsertCommand::CFromName: emit insertCommand("%FROMNAME"); break;
+  case TemplatesInsertCommand::CFromFName: emit insertCommand("%FROMFNAME"); break;
+  case TemplatesInsertCommand::CFromLName: emit insertCommand("%FROMLNAME"); break;
+  case TemplatesInsertCommand::CFullSubject: emit insertCommand("%FULLSUBJECT"); break;
+  case TemplatesInsertCommand::CHeader: emit insertCommand("%HEADER=\"\"", -1); break;
+  case TemplatesInsertCommand::CSystem: emit insertCommand("%SYSTEM=\"\"", -1); break;
+  case TemplatesInsertCommand::CQuotePipe: emit insertCommand("%QUOTEPIPE=\"\"", -1); break;
+  case TemplatesInsertCommand::CTextPipe: emit insertCommand("%TEXTPIPE=\"\"", -1); break;
+  case TemplatesInsertCommand::CMsgPipe: emit insertCommand("%MSGPIPE=\"\"", -1); break;
+  case TemplatesInsertCommand::CBodyPipe: emit insertCommand("%BODYPIPE=\"\"", -1); break;
+  case TemplatesInsertCommand::CClearPipe: emit insertCommand("%CLEARPIPE=\"\"", -1); break;
+  case TemplatesInsertCommand::CCursor: emit insertCommand("%CURSOR"); break;
+  case TemplatesInsertCommand::CInsert: emit insertCommand("%INSERT=\"\"", -1); break;
+  case TemplatesInsertCommand::CDnl: emit insertCommand("%-"); break;
+  case TemplatesInsertCommand::CRem: emit insertCommand("%REM=\"\"", -1); break;
+  case TemplatesInsertCommand::CNop: emit insertCommand("%NOP"); break;
+  case TemplatesInsertCommand::CClear: emit insertCommand("%CLEAR"); break;
+  case TemplatesInsertCommand::CDebug: emit insertCommand("%DEBUG"); break;
+  case TemplatesInsertCommand::CDebugOff: emit insertCommand("%DEBUGOFF"); break;
+  default:
+      kdDebug() << "Unknown template command index: " << cmd << endl;
+      break;
+  }
+}
+
+#include "templatesinsertcommand.moc"
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/configuredialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,6 +29,7 @@
 
 #include "globalsettings.h"
 #include "replyphrases.h"
+#include "templatesconfiguration_kfg.h"
 
 // other KMail headers:
 #include "kmkernel.h"
@@ -49,6 +50,8 @@
 #include <composercryptoconfiguration.h>
 #include <warningconfiguration.h>
 #include <smimeconfiguration.h>
+#include "templatesconfiguration.h"
+#include "customtemplates.h"
 #include "folderrequester.h"
 using KMail::FolderRequester;
 #include "accountcombobox.h"
@@ -841,6 +844,8 @@
   QListViewItem *item = mTransportList->selectedItem();
   if ( !item ) return;
 
+  const QString& originalTransport = item->text(0);
+
   QPtrListIterator<KMTransportInfo> it( mTransportInfoList );
   for ( it.toFirst() ; it.current() ; ++it )
     if ( (*it)->name == item->text(0) ) break;
@@ -869,6 +874,24 @@
   // and insert the new name at the position of the old in the list of
   // strings; then broadcast the new list:
   transportNames.insert( transportNames.at( entryLocation ), (*it)->name );
+  const QString& newTransportName = (*it)->name;
+
+  QStringList changedIdents;
+  KPIM::IdentityManager * im = kmkernel->identityManager();
+  for ( KPIM::IdentityManager::Iterator it = im->modifyBegin(); it != im->modifyEnd(); ++it ) {
+    if ( originalTransport == (*it).transport() ) {
+      (*it).setTransport( newTransportName );
+      changedIdents += (*it).identityName();
+    }
+  }
+
+  if ( !changedIdents.isEmpty() ) {
+    QString information = i18n( "This identity has been changed to use the modified transport:",
+                          "These %n identities have been changed to use the modified transport:",
+                          changedIdents.count() );
+    KMessageBox::informationList( this, information, changedIdents );
+  }
+
   emit transportListChanged( transportNames );
   emit changed( true );
 }
@@ -2299,7 +2322,7 @@
   encodings.prepend( i18n( "Auto" ) );
   QStringList::Iterator it( encodings.begin() );
   QStringList::Iterator end( encodings.end() );
-  int i = 0;
+  uint i = 0;
   for( ; it != end; ++it)
   {
     if( KGlobal::charsets()->encodingForName(*it) == currentOverrideEncoding )
@@ -2446,10 +2469,22 @@
   //
   // "Phrases" tab:
   //
-  mPhrasesTab = new PhrasesTab();
-  addTab( mPhrasesTab, i18n("&Phrases") );
+  // mPhrasesTab = new PhrasesTab();
+  // addTab( mPhrasesTab, i18n("&Phrases") );
 
   //
+  // "Templates" tab:
+  //
+  mTemplatesTab = new TemplatesTab();
+  addTab( mTemplatesTab, i18n("&Templates") );
+
+  //
+  // "Custom Templates" tab:
+  //
+  mCustomTemplatesTab = new CustomTemplatesTab();
+  addTab( mCustomTemplatesTab, i18n("&Custom Templates") );
+
+  //
   // "Subject" tab:
   //
   mSubjectTab = new SubjectTab();
@@ -2903,6 +2938,54 @@
   }
 }
 
+QString ComposerPage::TemplatesTab::helpAnchor() const {
+  return QString::fromLatin1("configure-composer-templates");
+}
+
+ComposerPageTemplatesTab::ComposerPageTemplatesTab( QWidget * parent, const char * name )
+  : ConfigModuleTab ( parent, name )
+{
+  QVBoxLayout* vlay = new QVBoxLayout( this, 0, KDialog::spacingHint() );
+
+  mWidget = new TemplatesConfiguration( this );
+  vlay->addWidget( mWidget );
+
+  connect( mWidget, SIGNAL( changed() ),
+           this, SLOT( slotEmitChanged( void ) ) );
+}
+
+void ComposerPage::TemplatesTab::doLoadFromGlobalSettings() {
+    mWidget->loadFromGlobal();
+}
+
+void ComposerPage::TemplatesTab::save() {
+    mWidget->saveToGlobal();
+}
+
+QString ComposerPage::CustomTemplatesTab::helpAnchor() const {
+  return QString::fromLatin1("configure-composer-custom-templates");
+}
+
+ComposerPageCustomTemplatesTab::ComposerPageCustomTemplatesTab( QWidget * parent, const char * name )
+  : ConfigModuleTab ( parent, name )
+{
+  QVBoxLayout* vlay = new QVBoxLayout( this, 0, KDialog::spacingHint() );
+
+  mWidget = new CustomTemplates( this );
+  vlay->addWidget( mWidget );
+
+  connect( mWidget, SIGNAL( changed() ),
+           this, SLOT( slotEmitChanged( void ) ) );
+}
+
+void ComposerPage::CustomTemplatesTab::doLoadFromGlobalSettings() {
+    mWidget->load();
+}
+
+void ComposerPage::CustomTemplatesTab::save() {
+    mWidget->save();
+}
+
 QString ComposerPage::SubjectTab::helpAnchor() const {
   return QString::fromLatin1("configure-composer-subject");
 }
Index: kmail/kmfolder.h
===================================================================
--- kmail/kmfolder.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfolder.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -72,7 +72,7 @@
 public:
 
   /**
-   * Constructs a new Folder object. 
+   * Constructs a new Folder object.
    * @param parent The directory in the folder storage hierarchy under which
    * the folder's storage will be found or created.
    * @param name If name of the folder. In case there is no parent directory, because
@@ -99,21 +99,26 @@
   bool isOutbox() {
     return this == KMKernel::self()->outboxFolder();
   }
-  /** Retuns true if this folder is the sent-mail box of the local account,
+  /** Returns true if this folder is the sent-mail box of the local account,
     or is configured to be the sent mail box of any of the users identities */
   bool isSent() {
     return KMKernel::self()->folderIsSentMailFolder( this );
   }
-  /** Retuns true if this folder is configured as a trash folder, localy or
+  /** Returns true if this folder is configured as a trash folder, locally or
     for one of the accounts. */
   bool isTrash() {
     return KMKernel::self()->folderIsTrash( this );
   }
-  /** Retuns true if this folder is the drafts box of the local account,
+  /** Returns true if this folder is the drafts box of the local account,
     or is configured to be the drafts box of any of the users identities */
   bool isDrafts() {
     return KMKernel::self()->folderIsDrafts( this );
   }
+  /** Returns true if this folder is the templates folder of the local account,
+    or is configured to be the templates folder of any of the users identities */
+  bool isTemplates() {
+    return KMKernel::self()->folderIsTemplates( this );
+  }
 
   void setAcctList( AccountList* list ) { mAcctList = list; }
   AccountList* acctList() { return mAcctList; }
@@ -353,9 +358,9 @@
   bool isReadOnly() const;
 
   /** Returns true if the folder is a kmail system folder. These are
-    the folders 'inbox', 'outbox', 'sent', 'trash'. The name of these
-    folders is nationalized in the folder display and they cannot have
-    accounts associated. Deletion is also forbidden. Etc. */
+    the folders 'inbox', 'outbox', 'sent', 'trash', 'drafts', 'templates'.
+    The name of these folders is nationalized in the folder display and
+    they cannot have accounts associated. Deletion is also forbidden. Etc. */
   bool isSystemFolder() const { return mIsSystemFolder; }
   void setSystemFolder(bool itIs) { mIsSystemFolder=itIs; }
 
@@ -617,9 +622,9 @@
   /** Mailing list attributes */
   bool                mMailingListEnabled;
   MailingList         mMailingList;
-  
+
   AccountList* mAcctList;
-  
+
   uint mIdentity;
 
   /** name of the field that is used for "From" in listbox */
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -489,12 +489,12 @@
     mUidlFinished = TRUE;
 
     if ( mLeaveOnServer && mUidForIdMap.isEmpty() &&
-         mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
-      KMessageBox::sorry(0, i18n("Your POP3 server does not support the UIDL "
-      "command: this command is required to determine, in a reliable way, "
+        mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
+      KMessageBox::sorry(0, i18n("Your POP3 server (Account: %1) does not support "
+      "the UIDL command: this command is required to determine, in a reliable way, "
       "which of the mails on the server KMail has already seen before;\n"
       "the feature to leave the mails on the server will therefore not "
-      "work properly."));
+      "work properly.").arg(NetworkAccount::name()) );
       // An attempt to work around buggy pop servers, these seem to be popular.
       mUidsOfNextSeenMsgsDict = mUidsOfSeenMsgsDict;
     }
@@ -811,7 +811,9 @@
   processMsgsTimer.stop();
 
   stage = Quit;
-  kmkernel->folderMgr()->syncAllFolders();
+  if ( kmkernel && kmkernel->folderMgr() ) {
+    kmkernel->folderMgr()->syncAllFolders();
+  }
 }
 
 
Index: kmail/kmmsgbase.h
===================================================================
--- kmail/kmmsgbase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmsgbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,7 +32,7 @@
 class KMFolder;
 class KMFolderIndex;
 
-/** The new status format. These can be or'd together. 
+/** The new status format. These can be or'd together.
     Note, that the KMMsgStatusIgnored implies the
     status to be Read even if the flags are set
     to Unread or New. This is done in KMMsgBase::isRead()
@@ -341,7 +341,7 @@
 
   /** This function handles both encodings described in RFC2047:
     Base64 ("=?iso-8859-1?b?...?=") and quoted-printable */
-  static QString decodeRFC2047String(const QCString& aStr);
+  static QString decodeRFC2047String(const QCString& aStr, const QCString prefCharset = "");
 
   /** Encode given string as described in RFC2047:
     using quoted-printable. */
Index: kmail/templatesinsertcommand.h
===================================================================
--- kmail/templatesinsertcommand.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesinsertcommand.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,61 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov <dmiceman@mail.ru>
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#ifndef TEMPLATESINSERTCOMMAND_H
+#define TEMPLATESINSERTCOMMAND_H
+
+#include <qpushbutton.h>
+
+class KActionMenu;
+
+class TemplatesInsertCommand : public QPushButton
+{
+  Q_OBJECT
+
+  public:
+    TemplatesInsertCommand( QWidget *parent, const char *name = 0 );
+    ~TemplatesInsertCommand();
+
+  public:
+    enum Command {CDnl = 1, CRem, CInsert, CSystem, CQuotePipe, CQuote, CQHeaders, CHeaders, 
+                  CTextPipe, CMsgPipe, CBodyPipe, CClearPipe, CText, 
+                  CToAddr, CToName, CFromAddr, CFromName, CFullSubject, CMsgId, 
+                  COHeader, CHeader, COToAddr, COToName, COFromAddr, COFromName, COFullSubject, 
+                  COMsgId, CDateEn, CDateShort, CDate, CDow, CTimeLongEn, CTimeLong, CTime, 
+                  CODateEn, CODateShort, CODate, CODow, COTimeLongEn, COTimeLong, COTime, 
+                  CBlank, CNop, CClear, CDebug, CDebugOff, CToFName, CToLName, CFromFName, CFromLName, 
+                  COToFName, COToLName, COFromFName, COFromLName, CCursor, 
+                  CCCAddr, CCCName, CCCFName, CCCLName, COCCAddr, COCCName, COCCFName, COCCLName };
+
+  signals:
+    void insertCommand( TemplatesInsertCommand::Command cmd );
+    void insertCommand( QString cmd, int adjustCursor = 0 );
+
+  public slots:
+    void slotClicked();
+    void slotMapped( int cmd );
+
+  protected:
+    KActionMenu *mMenu;
+};
+
+#endif // TEMPLATESINSERTCOMMAND_H
Index: kmail/kmail_config_appearance.desktop
===================================================================
--- kmail/kmail_config_appearance.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_appearance.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -75,7 +75,7 @@
 Comment[es]=Apariencia visual personalizada
 Comment[et]=Välimuse seadistused
 Comment[eu]=Pertsonalizatu itxura
-Comment[fa]=سفارشی کردن ظاهر تصویری‌
+Comment[fa]=سفارشی کردن ظاهر تصویری
 Comment[fi]=Ulkonäköasetukset
 Comment[fr]=Personnalisation de l'apparence
 Comment[gl]=Personalizar a apariencia visual
@@ -120,7 +120,7 @@
 Keywords[es]=kmail,apariencia
 Keywords[et]=kmail,välimus
 Keywords[eu]=kmail,itxura
-Keywords[fa]=kmail،ظاهر
+Keywords[fa]=kmail، ظاهر
 Keywords[fi]=kmail,ulkonäkö
 Keywords[fr]=KMail,apparence
 Keywords[ga]=kmail,cuma
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -552,6 +552,7 @@
   QCString subjStr, dateStr, fromStr, toStr, xmarkStr, *lastStr=0;
   QCString replyToIdStr, replyToAuxIdStr, referencesStr, msgIdStr;
   QCString sizeServerStr, uidStr;
+  QCString contentTypeStr, charset;
   bool atEof = false;
   bool inHeader = true;
   KMMsgInfo* mi;
@@ -652,6 +653,29 @@
               replyToAuxIdStr.truncate( rightAngle + 1 );
           }
 
+          contentTypeStr = contentTypeStr.stripWhiteSpace();
+          charset = "";
+          if ( !contentTypeStr.isEmpty() )
+          {
+            int cidx = contentTypeStr.find( "charset=" );
+            if ( cidx != -1 ) {
+              charset = contentTypeStr.mid( cidx + 8 );
+              if ( charset[0] == '"' ) {
+                charset = charset.mid( 1 );
+              }
+              cidx = 0;
+              while ( (unsigned int) cidx < charset.length() ) {
+                if ( charset[cidx] == '"' || ( !isalnum(charset[cidx]) &&
+                    charset[cidx] != '-' && charset[cidx] != '_' ) )
+                  break;
+                ++cidx;
+              }
+              charset.truncate( cidx );
+              // kdDebug() << "KMFolderMaildir::readFileHeaderIntern() charset found: " <<
+              //              charset << " from " << contentTypeStr << endl;
+            }
+          }
+
           mi = new KMMsgInfo(folder());
           mi->init( subjStr.stripWhiteSpace(),
                     fromStr.stripWhiteSpace(),
@@ -660,7 +684,7 @@
                     xmarkStr.stripWhiteSpace(),
                     replyToIdStr, replyToAuxIdStr, msgIdStr,
                     KMMsgEncryptionStateUnknown, KMMsgSignatureStateUnknown,
-                    KMMsgMDNStateUnknown, offs, size, sizeServer, uid );
+                    KMMsgMDNStateUnknown, charset, offs, size, sizeServer, uid );
           mi->setStatus(status, xstatus);
           mi->setDate( dateStr.stripWhiteSpace() );
           mi->setDirty(false);
@@ -766,6 +790,11 @@
       uid = uidStr.toULong();
       lastStr = &uidStr;
     }
+    else if (strncasecmp(line, "Content-Type:", 13) == 0)
+    {
+      contentTypeStr = QCString(line+13);
+      lastStr = &contentTypeStr;
+    }
   }
 
   if (mAutoCreateIndex)
@@ -1071,10 +1100,10 @@
   }
   ++mTotalMsgs;
 
-  if ( aMsg->attachmentState() == KMMsgAttachmentUnknown && 
+  if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
     aMsg->updateAttachmentState();
-  
+
   // store information about the position in the folder file in the message
   aMsg->setParent(folder());
   aMsg->setFolderOffset(offs);
Index: kmail/templatesconfiguration.h
===================================================================
--- kmail/templatesconfiguration.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/templatesconfiguration.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,75 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#ifndef TEMPLATESCONFIGURATION_H
+#define TEMPLATESCONFIGURATION_H
+
+#include "templatesconfiguration_base.h"
+#include "templatesinsertcommand.h"
+
+class TemplatesConfiguration : public TemplatesConfigurationBase
+{
+  Q_OBJECT
+
+  public:
+
+    TemplatesConfiguration( QWidget *parent = 0, const char *name = 0 );
+
+    void loadFromGlobal();
+    void saveToGlobal();
+    void loadFromIdentity( uint id );
+    void saveToIdentity( uint id );
+    void loadFromFolder( QString id, uint identity = 0 );
+    void saveToFolder( QString id );
+
+    /** Do import settings from 'Phrases' configuration. */
+    void loadFromPhrases();
+
+    /** Do import 'Phrases' settings and store them as global templates. */
+    static void importFromPhrases();
+
+    /** Convert 'Phrases'-like placeholders into 'Templates' compatible. */
+    static QString convertPhrases( QString &str );
+
+    static QString defaultNewMessage();
+    static QString defaultReply();
+    static QString defaultReplyAll();
+    static QString defaultForward();
+    static QString defaultQuoteString();
+
+  public slots:
+
+    void slotInsertCommand( QString cmd, int adjustCursor = 0 );
+
+    void slotTextChanged();
+
+  signals:
+
+    void changed();
+
+  protected:
+
+    QString strOrBlank( QString str );
+
+};
+
+#endif // TEMPLATESCONFIGURATION_H
Index: kmail/kmfolder.cpp
===================================================================
--- kmail/kmfolder.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfolder.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -700,6 +700,7 @@
 {
   if (units >= expireNever && units < expireMaxUnits)
     mUnreadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 void KMFolder::setReadExpireAge( int age )
@@ -714,6 +715,7 @@
 {
   if (units >= expireNever && units <= expireMaxUnits)
     mReadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 
Index: kmail/kmatmlistview.h
===================================================================
--- kmail/kmatmlistview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmatmlistview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,5 @@
 /* -*- mode: C++; c-file-style: "gnu" -*-
- * KMComposeWin Header File
+ * KMAtmListViewItem Header File
  * Author: Markus Wuebben <markus.wuebben@kde.org>
  */
 #ifndef __KMAIL_KMATMLISTVIEW_H__
@@ -15,48 +15,57 @@
 class KMAtmListViewItem : public QObject, public QListViewItem
 {
   Q_OBJECT
-  friend class ::KMComposeWin;
-  friend class ::MessageComposer;
 
 public:
-  KMAtmListViewItem(QListView * parent);
+  KMAtmListViewItem( QListView *parent );
   virtual ~KMAtmListViewItem();
-  virtual void paintCell( QPainter * p, const QColorGroup & cg,
-                          int column, int width, int align );
 
+  //A custom compare function is needed because the size column is
+  //human-readable and therefore doesn't sort correctly.
+  virtual int compare( QListViewItem *i, int col, bool ascending ) const;
+
+  virtual void paintCell ( QPainter * p, const QColorGroup & cg, int column, int width, int align );
+
   void setUncompressedMimeType( const QCString & type, const QCString & subtype ) {
     mType = type; mSubtype = subtype;
   }
+  void setAttachmentSize( int numBytes ) {
+    mAttachmentSize = numBytes;
+  }
   void uncompressedMimeType( QCString & type, QCString & subtype ) const {
     type = mType; subtype = mSubtype;
   }
-  void setUncompressedCodec( const QCString & codec ) { mCodec = codec; }
+  void setUncompressedCodec( const QCString &codec ) { mCodec = codec; }
   QCString uncompressedCodec() const { return mCodec; }
 
+  void enableCryptoCBs( bool on );
+  void setEncrypt( bool on );
+  bool isEncrypt();
+  void setSign( bool on );
+  bool isSign();
+  void setCompress( bool on );
+  bool isCompress();
+
 signals:
   void compress( int );
   void uncompress( int );
 
-protected:
-  void enableCryptoCBs(bool on);
-  void setEncrypt(bool on);
-  bool isEncrypt();
-  void setSign(bool on);
-  bool isSign();
-  void setCompress(bool on);
-  bool isCompress();
-
 private slots:
   void slotCompress();
+  void slotHeaderChange( int, int, int );
+  void slotHeaderClick( int );
 
+protected:
+
+  void updateCheckBox( int headerSection, QCheckBox *cb );
+  void updateAllCheckBoxes();
+
 private:
-  QListView* mListview;
-  QCheckBox* mCBEncrypt;
-  QCheckBox* mCBSign;
-  QCheckBox* mCBCompress;
-  bool mCBSignEnabled, mCBEncryptEnabled;
+  QCheckBox *mCBEncrypt;
+  QCheckBox *mCBSign;
+  QCheckBox *mCBCompress;
   QCString mType, mSubtype, mCodec;
+  int mAttachmentSize;
 };
 
-
 #endif // __KMAIL_KMATMLISTVIEW_H__
Index: kmail/recipientseditor.cpp
===================================================================
--- kmail/recipientseditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/recipientseditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -321,6 +321,7 @@
   : QScrollView( parent ), mCurDelLine( 0 ), mModified( false ),
     mFirstColumnWidth( 0 ), mLineHeight( 0 )
 {
+  mCompletionMode = KGlobalSettings::completionMode();
   setHScrollBarMode( AlwaysOff );
   setLineWidth( 0 );
 
@@ -348,6 +349,7 @@
 {
   RecipientLine *line = new RecipientLine( viewport() );
   addChild( line, 0, mLines.count() * mLineHeight );
+  line->mEdit->setCompletionMode( mCompletionMode );
   line->show();
   connect( line, SIGNAL( returnPressed( RecipientLine * ) ),
     SLOT( slotReturnPressed( RecipientLine * ) ) );
@@ -361,6 +363,8 @@
   connect( line, SIGNAL( countChanged() ), SLOT( calculateTotal() ) );
   connect( line, SIGNAL( typeModified( RecipientLine * ) ),
     SLOT( slotTypeModified( RecipientLine * ) ) );
+  connect( line->mEdit, SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+    SLOT( setCompletionMode( KGlobalSettings::Completion ) ) );
 
   if ( mLines.last() ) {
     if ( mLines.count() == 1 ) {
@@ -574,6 +578,23 @@
   return recipients;
 }
 
+void RecipientsView::setCompletionMode ( KGlobalSettings::Completion mode )
+{
+  if ( mCompletionMode == mode )
+    return;
+  mCompletionMode = mode;
+
+  QPtrListIterator<RecipientLine> it( mLines );
+  RecipientLine *line;
+  while( ( line = it.current() ) ) {
+    line->mEdit->blockSignals( true );
+    line->mEdit->setCompletionMode( mode );
+    line->mEdit->blockSignals( false );
+    ++it;
+  }
+  emit completionModeChanged( mode ); //report change to RecipientsEditor
+}
+
 void RecipientsView::removeRecipient( const QString & recipient,
                                       Recipient::Type type )
 {
@@ -804,6 +825,8 @@
   topLayout->addWidget( mRecipientsView );
   connect( mRecipientsView, SIGNAL( focusUp() ), SIGNAL( focusUp() ) );
   connect( mRecipientsView, SIGNAL( focusDown() ), SIGNAL( focusDown() ) );
+  connect( mRecipientsView, SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+    SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ) );
 
   mSideWidget = new SideWidget( mRecipientsView, this );
   topLayout->addWidget( mSideWidget );
@@ -944,4 +967,8 @@
   mSideWidget->pickRecipient();
 }
 
+void RecipientsEditor::setCompletionMode( KGlobalSettings::Completion mode )
+{
+  mRecipientsView->setCompletionMode( mode );
+}
 #include "recipientseditor.moc"
Index: kmail/accountwizard.cpp
===================================================================
--- kmail/accountwizard.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/accountwizard.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -409,6 +409,19 @@
   for ( uint i = 0 ; i < mTransportInfoList.count() ; i++ )
     mTransportInfo->writeConfig( i + 1 );
 
+    // No default transport? => set the first transport as the default
+  if ( GlobalSettings::self()->defaultTransport().isEmpty() ) {
+    KConfigGroup general( KMKernel::config(), "General" );
+
+    if ( mTransportInfoList.count() > 0 ) {
+      KMTransportInfo info;
+      info.readConfig( 1 );
+      KConfigGroup composer( KMKernel::config(), "Composer" );
+      GlobalSettings::self()->setDefaultTransport( info.name );
+      GlobalSettings::self()->setCurrentTransport( info.name );
+    }
+  }
+
   mTransportInfoList.setAutoDelete( true );
   mTransportInfoList.clear();
 
Index: kmail/kmkernel.h
===================================================================
--- kmail/kmkernel.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmkernel.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -96,10 +96,19 @@
   /** returns id of composer if more are opened */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
-                    const KURL &messageFile, const KURL::List &attachURLs);
+                    const KURL &messageFile, const KURL::List &attachURLs,
+                    const QCStringList &customHeaders);
   /** For backward compatibility */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
+                    const KURL &messageFile, const KURL::List &attachURLs)
+  {
+    QCStringList noCustomHeaders;
+    return openComposer(to, cc, bcc, subject, body, hidden, messageFile, attachURLs, noCustomHeaders);
+  }
+  /** For backward compatibility */
+  int openComposer (const QString &to, const QString &cc, const QString &bcc,
+                    const QString &subject, const QString &body, int hidden,
                     const KURL &messageFile, const KURL& attachURL)
   {
     return openComposer(to, cc, bcc, subject, body, hidden, messageFile, KURL::List(attachURL));
@@ -159,7 +168,7 @@
   int sendCertificate( const QString& to, const QByteArray& certData );
 
   void openReader() { openReader( false ); }
-  
+
   int dcopAddMessage(const QString & foldername, const QString & messagefile,
                      const QString & MsgStatusFlags = QString());
   int dcopAddMessage(const QString & foldername, const KURL & messagefile,
@@ -170,7 +179,7 @@
                                 const QString & MsgStatusFlags = QString());
   int dcopAddMessage_fastImport(const QString & foldername, const KURL & messagefile,
                                 const QString & MsgStatusFlags = QString());
-  
+
   QStringList folderList() const;
   DCOPRef getFolder( const QString& vpath );
   void selectFolder( QString folder );
@@ -193,9 +202,9 @@
   */
   virtual void resumeBackgroundJobs();
 
-  /** 
-   * Stops all network related jobs and enter offline mode 
-   * New network jobs cannot be started. 
+  /**
+   * Stops all network related jobs and enter offline mode
+   * New network jobs cannot be started.
   */
   void stopNetworkJobs();
 
@@ -213,7 +222,7 @@
   static bool askToGoOnline();
 
   /** Checks if the current network state is online or offline
-   * @return true if the network state is offline 
+   * @return true if the network state is offline
    * @return false if the network state is online
    */
   static bool isOffline();
@@ -245,12 +254,14 @@
   void setFirstInstance(bool value) { the_firstInstance = value; }
   void action (bool mailto, bool check, const QString &to, const QString &cc,
                const QString &bcc, const QString &subj, const QString &body,
-	       const KURL &messageFile, const KURL::List &attach);
+               const KURL &messageFile, const KURL::List &attach,
+               const QCStringList &customHeaders);
   void byteArrayToRemoteFile(const QByteArray&, const KURL&,
 			     bool overwrite = FALSE);
-  bool folderIsDraftOrOutbox(const KMFolder *);
-  bool folderIsDrafts(const KMFolder *);
-  bool folderIsTrash(KMFolder *);
+  bool folderIsDraftOrOutbox( const KMFolder * );
+  bool folderIsDrafts( const KMFolder * );
+  bool folderIsTemplates( const KMFolder * );
+  bool folderIsTrash( KMFolder * );
   /**
    * Returns true if the folder is one of the sent-mail folders.
    */
@@ -268,6 +279,7 @@
   KMFolder *sentFolder() { return the_sentFolder; }
   KMFolder *trashFolder() { return the_trashFolder; }
   KMFolder *draftsFolder() { return the_draftsFolder; }
+  KMFolder *templatesFolder() { return the_templatesFolder; }
 
   KMFolderMgr *folderMgr() { return the_folderMgr; }
   KMFolderMgr *imapFolderMgr() { return the_imapFolderMgr; }
@@ -391,7 +403,7 @@
 
   void slotShowConfigurationDialog();
   void slotRunBackgroundTasks();
-  
+
   void slotConfigChanged();
 
 protected slots:
@@ -413,6 +425,7 @@
   KMFolder *the_sentFolder;
   KMFolder *the_trashFolder;
   KMFolder *the_draftsFolder;
+  KMFolder *the_templatesFolder;
 
   KMFolderMgr *the_folderMgr;
   KMFolderMgr *the_imapFolderMgr;
Index: kmail/KMail.desktop
===================================================================
--- kmail/KMail.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/KMail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,6 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KMail
-Name[ar]=البريد
 Name[be]=K Пошта
 Name[eo]=Retpoŝto
 Name[hi]=के-मेल
@@ -16,7 +15,7 @@
 Icon=kmail
 DocPath=kmail/index.html
 GenericName=Mail Client
-GenericName[ar]=البريد الألكتروني
+GenericName[ar]=زبون البريد
 GenericName[az]=Poçt Alıcısı
 GenericName[be]=Паштовы кліент
 GenericName[bg]=Пощенски клиент
@@ -32,7 +31,7 @@
 GenericName[es]=Cliente de correo
 GenericName[et]=E-posti klient
 GenericName[eu]=Posta bezeroa
-GenericName[fa]=کارخواه نامه
+GenericName[fa]=کارخواه‌نامه
 GenericName[fi]=Sähköpostiohjelma
 GenericName[fr]=Logiciel de messagerie électronique
 GenericName[ga]=Cliant Ríomhphoist
Index: kmail/Mainpage.dox
===================================================================
--- kmail/Mainpage.dox	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/Mainpage.dox	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -793,7 +793,7 @@
 
   - @em BodyPartFormatter
 	the formatter interface. Contains a single method format()
-	that takes a BodyPart to process and a HTMLWriter to write the
+	that takes a BodyPart to process and an HTMLWriter to write the
 	generated HTML to and returns a result code with which it can
 	request more information or delegate the formatting back to
 	some default processor. BodyPartFormatters are meant to be
Index: kmail/kmailIface.h
===================================================================
--- kmail/kmailIface.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmailIface.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -97,10 +97,10 @@
         =-4, Message already exists in folder.
   */
   virtual int dcopAddMessage(const QString & foldername,
-                             const QString & messagefile, 
+                             const QString & messagefile,
                              const QString & MsgStatusFlags = QString()) = 0;
   virtual int dcopAddMessage(const QString & foldername,
-                             const KURL & messagefile, 
+                             const KURL & messagefile,
                              const QString & MsgStatusFlags = QString()) = 0;
 
   virtual QStringList folderList() const =0;
@@ -144,16 +144,16 @@
   void unreadCountChanged( const QString& folderURL, int numUnread );
 
 k_dcop_hidden:
-  /** DCOP call which is used by the Kontact plugin to create a new message. 
+  /** DCOP call which is used by the Kontact plugin to create a new message.
    *
    *  @TODO Rename to newMessageInternal()
-   *  @TODO Merge this and the various openComposer methods for better code reuse 
+   *  @TODO Merge this and the various openComposer methods for better code reuse
   */
-  virtual DCOPRef newMessage(const QString &to, 
-                             const QString &cc, 
-                             const QString& bcc, 
-                             bool hidden, 
-                             bool useFolderId, 
+  virtual DCOPRef newMessage(const QString &to,
+                             const QString &cc,
+                             const QString& bcc,
+                             bool hidden,
+                             bool useFolderId,
                              const KURL &messageFile,
                              const KURL &attachURL) = 0;
 
@@ -174,6 +174,7 @@
    * not handled (due to noArgsOpensReader==false).
    */
   virtual bool handleCommandLine( bool noArgsOpensReader ) = 0;
+  virtual bool firstStart() = 0;
   /**
    *
    * DCOP-enabled for use in kaddressbook drop
@@ -201,10 +202,10 @@
         =-4, Message already exists in folder.
   */
   virtual int dcopAddMessage_fastImport(const QString & foldername,
-                                        const QString & messagefile, 
+                                        const QString & messagefile,
                                         const QString & MsgStatusFlags = QString()) = 0;
   virtual int dcopAddMessage_fastImport(const QString & foldername,
-                                        const KURL & messagefile, 
+                                        const KURL & messagefile,
                                         const QString & MsgStatusFlags = QString()) = 0;
 
   /** Clears the list of added message ids which is used to filter out
Index: kmail/customtemplates_kfg.kcfgc
===================================================================
--- kmail/customtemplates_kfg.kcfgc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/customtemplates_kfg.kcfgc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,5 @@
+File=customtemplates_kfg.kcfg
+ClassName=CTemplates
+Mutators=true
+ItemAccessors=true
+SetUserTexts=true
Index: kmail/identitydialog.h
===================================================================
--- kmail/identitydialog.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/identitydialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,6 +40,8 @@
 class QComboBox;
 class QString;
 class QStringList;
+class TemplatesConfiguration;
+class KPushButton;
 namespace Kleo {
   class EncryptionKeyRequester;
   class SigningKeyRequester;
@@ -73,6 +75,8 @@
     void slotAboutToShow( QWidget * w );
     /*! \reimp */
     void slotOk();
+    // copy default templates to identity templates
+    void slotCopyGlobal();
 
   private:
     bool checkFolderExists( const QString & folder, const QString & msg );
@@ -96,8 +100,13 @@
     KMail::DictionaryComboBox    *mDictionaryCombo;
     FolderRequester              *mFccCombo;
     FolderRequester              *mDraftsCombo;
+    FolderRequester              *mTemplatesCombo;
     QCheckBox                    *mTransportCheck;
     QComboBox                    *mTransportCombo; // should be a KMTransportCombo...
+    // "templates" tab:
+    TemplatesConfiguration       *mWidget;
+    QCheckBox                    *mCustom;
+    KPushButton                  *mCopyGlobal;
     // "signature" tab:
     KMail::SignatureConfigurator *mSignatureConfigurator;
     // "X-Face" tab:
Index: kmail/dcopmail.desktop
===================================================================
--- kmail/dcopmail.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/dcopmail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,9 +15,10 @@
 Comment[es]=Programa de correo con un interfaz DCOP
 Comment[et]=E-posti rakendus DCOP-liidesega
 Comment[eu]=DCOP interfazedun posta programa
-Comment[fa]=برنامۀ نامه با یک واسط DCOP
+Comment[fa]=برنامۀ نامه با واسط DCOP
 Comment[fi]=Sähköpostisovellus DCOP-rajapinnalla
 Comment[fr]=Programme de messagerie avec une interface DCOP
+Comment[gl]=Programa de correo-e cunha interface DCOP
 Comment[hi]=डीकॉप इंटरफेस सहित एक डाक प्रोग्राम
 Comment[hu]=Levelezőprogram DCOP felülettel
 Comment[is]=Póstforrit með DCOP viðmóti
Index: kmail/kmedit.h
===================================================================
--- kmail/kmedit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -69,6 +69,9 @@
   void deleteAutoSpellChecking();
 
   unsigned int lineBreakColumn() const;
+  
+  /** set cursor to absolute position pos */
+  void setCursorPositionFromStart(unsigned int pos);
 
 signals:
   void spellcheck_done(int result);
Index: kmail/kmmainwidget.h
===================================================================
--- kmail/kmmainwidget.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmainwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -25,6 +25,7 @@
 #include <kxmlguiclient.h>
 #include <qlistview.h>
 #include <qvbox.h>
+#include <qvaluevector.h>
 
 #include "kmreaderwin.h" //for inline actions
 #include "kmkernel.h" // for access to config
@@ -32,6 +33,7 @@
 
 class QVBoxLayout;
 class QSplitter;
+class QSignalMapper;
 
 class KActionMenu;
 class KActionCollection;
@@ -110,12 +112,15 @@
   KAction *replyAuthorAction() const { return mReplyAuthorAction; }
   KAction *replyAllAction() const { return mReplyAllAction; }
   KAction *replyListAction() const { return mReplyListAction; }
+  KActionMenu *customReplyAction() const { return mCustomReplyActionMenu; }
+  KActionMenu *customReplyAllAction() const { return mCustomReplyAllActionMenu; }
   KActionMenu * replyMenu() const { return mReplyActionMenu; }
   KActionMenu *forwardMenu() const { return mForwardActionMenu; }
   KAction *forwardInlineAction() const { return mForwardInlineAction; }
   KAction *forwardAttachedAction() const { return mForwardAttachedAction; }
   KAction *forwardDigestAction() const { return mForwardDigestAction; }
   KAction *redirectAction() const { return mRedirectAction; }
+  KActionMenu *customForwardAction() const { return mCustomForwardActionMenu; }
   KAction *noQuoteReplyAction() const { return mNoQuoteReplyAction; }
   KActionMenu *filterMenu() const { return mFilterMenu; }
   KAction *printAction() const { return mPrintAction; }
@@ -125,6 +130,7 @@
   KAction *deleteThreadAction() const { return mDeleteThreadAction; }
   KAction *saveAsAction() const { return mSaveAsAction; }
   KAction *editAction() const { return mEditAction; }
+  KAction *useAction() const { return mUseAction; }
   KAction *sendAgainAction() const { return mSendAgainAction; }
   KAction *applyAllFiltersAction() const { return mApplyAllFiltersAction; }
   KAction *findInMessageAction() const { return mFindInMessageAction; }
@@ -221,6 +227,8 @@
   /** Add, remove or adjust the folder's shortcut. */
   void slotShortcutChanged( KMFolder *folder );
 
+  void updateCustomTemplateMenus();
+
 signals:
   void messagesTransfered( bool );
   void captionChangeRequest( const QString & caption );
@@ -229,8 +237,9 @@
   void setupActions();
   void createWidgets();
   void activatePanners();
-  void showMsg(KMReaderWin *win, KMMessage *msg);
+  void showMsg( KMReaderWin *win, KMMessage *msg );
   void updateFileMenu();
+  void newFromTemplate( KMMessage *msg );
 
   KActionCollection * actionCollection() const { return mActionCollection; }
 
@@ -273,6 +282,7 @@
   void slotToggleSubjectThreading();
   void slotMessageQueuedOrDrafted();
   void slotEditMsg();
+  void slotUseTemplate();
   //void slotTrashMsg();   // move to trash
   void slotDeleteMsg( bool confirmDelete = true );  // completely delete message
   void slotTrashThread();
@@ -343,8 +353,11 @@
 
   /** etc. */
   void slotDisplayCurrentMessage();
-  void slotMsgActivated(KMMessage*);
+  void slotMsgActivated( KMMessage* );
 
+  void slotShowNewFromTemplate();
+  void slotNewFromTemplate( int );
+
   /** Update the undo action */
   void slotUpdateUndo();
 
@@ -374,10 +387,13 @@
   void slotReplyAuthorToMsg();
   void slotReplyListToMsg();
   void slotReplyAllToMsg();
+  void slotCustomReplyToMsg( int tid );
+  void slotCustomReplyAllToMsg( int tid );
   void slotForwardInlineMsg();
   void slotForwardAttachedMsg();
   void slotForwardDigestMsg();
   void slotRedirectMsg();
+  void slotCustomForwardMsg( int tid );
   void slotNoQuoteReplyToMsg();
   void slotSubjectFilter();
   void slotMailingListFilter();
@@ -404,22 +420,31 @@
 private:
   // Message actions
   KAction *mTrashAction, *mDeleteAction, *mTrashThreadAction,
-    *mDeleteThreadAction, *mSaveAsAction, *mEditAction,
+    *mDeleteThreadAction, *mSaveAsAction, *mEditAction, *mUseAction,
     *mSendAgainAction, *mApplyAllFiltersAction, *mFindInMessageAction,
     *mSaveAttachmentsAction, *mOpenAction, *mViewSourceAction;
   // Composition actions
   KAction *mPrintAction, *mReplyAction, *mReplyAllAction, *mReplyAuthorAction,
     *mReplyListAction,
     *mForwardInlineAction, *mForwardAttachedAction, *mForwardDigestAction,
-    *mRedirectAction,
-    *mNoQuoteReplyAction;
+    *mRedirectAction, *mNoQuoteReplyAction;
   KActionMenu *mReplyActionMenu;
   KActionMenu *mForwardActionMenu;
   // Filter actions
   KActionMenu *mFilterMenu;
   KAction *mSubjectFilterAction, *mFromFilterAction, *mToFilterAction,
       *mListFilterAction;
+  KActionMenu *mTemplateMenu;
 
+  // Custom template actions menu
+  KActionMenu *mCustomReplyActionMenu,
+              *mCustomReplyAllActionMenu,
+              *mCustomForwardActionMenu;
+  // Signal mappers for custom template actions
+  QSignalMapper *mCustomReplyMapper,
+                *mCustomReplyAllMapper,
+                *mCustomForwardMapper;
+
   KActionMenu *mStatusMenu, *mThreadStatusMenu,
     *mMoveActionMenu, *mCopyActionMenu, *mApplyFilterActionsMenu;
   KAction *mMarkThreadAsNewAction;
@@ -428,7 +453,6 @@
   KToggleAction *mToggleThreadTodoAction;
   KToggleAction *mToggleThreadFlagAction;
   KToggleAction *mToggleTodoAction;
-  KToggleAction *mToggleSentAction;
   KToggleAction *mToggleFlagAction;
 
   KToggleAction *mWatchThreadAction, *mIgnoreThreadAction;
@@ -448,6 +472,7 @@
   KToolBar     *mSearchToolBar;
   KMail::HeaderListQuickSearch *mQuickSearchLine;
   KMFolder     *mFolder;
+  KMFolder     *mTemplateFolder;
   QPopupMenu   *mViewMenu, *mBodyPartsMenu;
   KAction       *mlistFilterAction;
   bool		mIntegrated;
@@ -498,6 +523,9 @@
   QDict<FolderShortcutCommand> mFolderShortcutCommands;
   QGuardedPtr <KMail::FolderJob> mJob;
 
+  QValueVector<QString> mCustomTemplates;
+  QPtrList<KAction> mCustomTemplateActions;
+
   KMSystemTray  *mSystemTray;
   KConfig *mConfig;
   KXMLGUIClient *mGUIClient;
Index: kmail/kmfolderdia.h
===================================================================
--- kmail/kmfolderdia.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfolderdia.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -51,6 +51,8 @@
 class KMFolderDialog;
 class KMFolderTree;
 template <typename T> class QGuardedPtr;
+class TemplatesConfiguration;
+class KPushButton;
 
 namespace KMail {
   class FolderRequester; 
@@ -150,6 +152,41 @@
   bool mIsLocalSystemFolder;
 };
 
+/**
+ * "Templates" tab in the folder dialog
+ * Internal class, only used by KMFolderDialog
+ */
+class FolderDiaTemplatesTab : public FolderDiaTab
+{
+  Q_OBJECT
+
+public:
+  FolderDiaTemplatesTab( KMFolderDialog* dlg,
+                       const QString& aName,
+                       QWidget* parent, const char* name = 0 );
+
+  virtual void load();
+  virtual bool save();
+
+public slots:
+  void slotEmitChanged(); // do nothing for now
+  
+  void slotCopyGlobal();
+
+private:
+  void initializeWithValuesFromFolder( KMFolder* folder );
+
+private:
+  QCheckBox* mCustom;
+  TemplatesConfiguration* mWidget;
+  KPushButton* mCopyGlobal;
+  KMFolder* mFolder;
+  uint mIdentity;
+
+  KMFolderDialog* mDlg;
+  bool mIsLocalSystemFolder;
+};
+
 } // end of namespace KMail
 
 /**
Index: kmail/customtemplates.cpp
===================================================================
--- kmail/customtemplates.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kmail/customtemplates.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,375 @@
+/*   -*- mode: C++; c-file-style: "gnu" -*-
+ *   kmail: KDE mail client
+ *   This file: Copyright (C) 2006 Dmitry Morozhnikov
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ */
+
+#include <config.h>
+
+#include <klocale.h>
+#include <kglobal.h>
+#include <qpopupmenu.h>
+#include <qpushbutton.h>
+#include <qtextedit.h>
+#include <qlineedit.h>
+#include <qtoolbox.h>
+#include <kdebug.h>
+#include <qfont.h>
+#include <kiconloader.h>
+#include <kpushbutton.h>
+#include <klistview.h>
+#include <klineedit.h>
+#include <qcombobox.h>
+#include <kshortcut.h>
+#include <kmessagebox.h>
+#include <kkeybutton.h>
+#include <kactivelabel.h>
+
+#include "customtemplates_base.h"
+#include "customtemplates_kfg.h"
+#include "globalsettings.h"
+#include "kmkernel.h"
+#include "kmmainwidget.h"
+
+#include "customtemplates.h"
+
+CustomTemplates::CustomTemplates( QWidget *parent, const char *name )
+  :CustomTemplatesBase( parent, name ), mCurrentItem( 0 )
+{
+  QFont f = KGlobalSettings::fixedFont();
+  mEdit->setFont( f );
+
+  mAdd->setIconSet( BarIconSet( "add", KIcon::SizeSmall ) );
+  mRemove->setIconSet( BarIconSet( "remove", KIcon::SizeSmall ) );
+
+  mList->setColumnWidth( 0, 50 );
+  mList->setColumnWidth( 1, 100 );
+
+  mEditFrame->setEnabled( false );
+
+  connect( mEdit, SIGNAL( textChanged() ),
+           this, SLOT( slotTextChanged( void ) ) );
+
+  connect( mInsertCommand, SIGNAL( insertCommand(QString, int) ),
+           this, SLOT( slotInsertCommand(QString, int) ) );
+
+  connect( mAdd, SIGNAL( clicked() ),
+           this, SLOT( slotAddClicked() ) );
+  connect( mRemove, SIGNAL( clicked() ),
+           this, SLOT( slotRemoveClicked() ) );
+  connect( mList, SIGNAL( selectionChanged() ),
+           this, SLOT( slotListSelectionChanged() ) );
+  connect( mType, SIGNAL( activated( int ) ),
+           this, SLOT( slotTypeActivated( int ) ) );
+
+  connect( mKeyButton, SIGNAL( capturedShortcut( const KShortcut& ) ),
+           this, SLOT( slotShortcutCaptured( const KShortcut& ) ) );
+
+  mReplyPix = KIconLoader().loadIcon( "mail_reply", KIcon::Small );
+  mReplyAllPix = KIconLoader().loadIcon( "mail_replyall", KIcon::Small );
+  mForwardPix = KIconLoader().loadIcon( "mail_forward", KIcon::Small );
+
+  mType->clear();
+  mType->insertItem( QPixmap(), i18n( "Message->", "Universal" ), TUniversal );
+  mType->insertItem( mReplyPix, i18n( "Message->", "Reply" ), TReply );
+  mType->insertItem( mReplyAllPix, i18n( "Message->", "Reply to All" ), TReplyAll );
+  mType->insertItem( mForwardPix, i18n( "Message->", "Forward" ), TForward );
+
+  QString help =
+      i18n( "<qt>"
+            "<p>Here you can add, edit, and delete custom message "
+            "templates to use when you compose a reply or forwarding message. "
+            "Create the custom template by selecting it using the right mouse "
+            " button menu or toolbar menu. Also, you can bind a keyboard "
+            "combination to the template for faster operations.</p>"
+            "<p>Message templates support substitution commands "
+            "by simple typing them or selecting them from menu "
+            "<i>Insert command</i>.</p>"
+            "<p>There are four types of custom templates: used to "
+            "<i>Reply</i>, <i>Reply to All</i>, <i>Forward</i>, and "
+            "<i>Universal</i> which can be used for all kind of operations. "
+            "You cannot bind keyboard shortcut to <i>Universal</i> templates.</p>"
+            "</qt>" );
+  mHelp->setText( i18n( "<a href=\"whatsthis:%1\">How does this work?</a>" ).arg( help ) );
+}
+
+CustomTemplates::~CustomTemplates()
+{
+  QDictIterator<CustomTemplateItem> it(mItemList);
+  for ( ; it.current() ; ++it ) {
+    CustomTemplateItem *vitem = mItemList.take( it.currentKey() );
+    if ( vitem ) {
+      delete vitem;
+    }
+  }
+}
+
+QString CustomTemplates::indexToType( int index )
+{
+  QString typeStr;
+  switch ( index ) {
+  case TUniversal:
+    // typeStr = i18n( "Any" ); break;
+    break;
+/*  case TNewMessage:
+    typeStr = i18n( "New Message" ); break;*/
+  case TReply:
+    typeStr = i18n( "Message->", "Reply" ); break;
+  case TReplyAll:
+    typeStr = i18n( "Message->", "Reply to All" ); break;
+  case TForward:
+    typeStr = i18n( "Message->", "Forward" ); break;
+  default:
+    typeStr = i18n( "Message->", "Unknown" ); break;
+  }
+  return typeStr;
+}
+
+void CustomTemplates::slotTextChanged()
+{
+  emit changed();
+}
+
+void CustomTemplates::load()
+{
+  QStringList list = GlobalSettings::self()->customTemplates();
+  for ( QStringList::iterator it = list.begin(); it != list.end(); ++it ) {
+    CTemplates t(*it);
+    // QString typeStr = indexToType( t.type() );
+    QString typeStr;
+    KShortcut shortcut( t.shortcut() );
+    CustomTemplateItem *vitem =
+      new CustomTemplateItem( *it, t.content(),
+        shortcut,
+        static_cast<Type>( t.type() ) );
+    mItemList.insert( *it, vitem );
+    QListViewItem *item = new QListViewItem( mList, typeStr, *it, t.content() );
+    switch ( t.type() ) {
+    case TReply:
+      item->setPixmap( 0, mReplyPix );
+      break;
+    case TReplyAll:
+      item->setPixmap( 0, mReplyAllPix );
+      break;
+    case TForward:
+      item->setPixmap( 0, mForwardPix );
+      break;
+    default:
+      item->setPixmap( 0, QPixmap() );
+      item->setText( 0, indexToType( t.type() ) );
+      break;
+    };
+  }
+}
+
+void CustomTemplates::save()
+{
+  if ( mCurrentItem ) {
+    CustomTemplateItem *vitem = mItemList[ mCurrentItem->text( 1 ) ];
+    if ( vitem ) {
+      vitem->mContent = mEdit->text();
+      vitem->mShortcut = mKeyButton->shortcut();
+    }
+  }
+  QStringList list;
+  QListViewItemIterator lit( mList );
+  while ( lit.current() ) {
+    list.append( (*lit)->text( 1 ) );
+    ++lit;
+  }
+  QDictIterator<CustomTemplateItem> it( mItemList );
+  for ( ; it.current() ; ++it ) {
+    // list.append( (*it)->mName );
+    CTemplates t( (*it)->mName );
+    QString &content = (*it)->mContent;
+    if ( content.stripWhiteSpace().isEmpty() ) {
+      content = "%BLANK";
+    }
+    t.setContent( content );
+    t.setShortcut( (*it)->mShortcut.toString() );
+    t.setType( (*it)->mType );
+    t.writeConfig();
+  }
+  GlobalSettings::self()->setCustomTemplates( list );
+  GlobalSettings::self()->writeConfig();
+
+  // update kmail menus related to custom templates
+  if ( kmkernel->getKMMainWidget() )
+    kmkernel->getKMMainWidget()->updateCustomTemplateMenus();
+}
+
+void CustomTemplates::slotInsertCommand( QString cmd, int adjustCursor )
+{
+  int para, index;
+  mEdit->getCursorPosition( &para, &index );
+  mEdit->insertAt( cmd, para, index );
+
+  index += adjustCursor;
+
+  mEdit->setCursorPosition( para, index + cmd.length() );
+}
+
+void CustomTemplates::slotAddClicked()
+{
+  QString str = mName->text();
+  if ( !str.isEmpty() ) {
+    CustomTemplateItem *vitem = mItemList[ str ];
+    if ( !vitem ) {
+      vitem = new CustomTemplateItem( str, "", KShortcut::null(), TUniversal );
+      mItemList.insert( str, vitem );
+      QListViewItem *item =
+        new QListViewItem( mList, indexToType( TUniversal ), str, "" );
+      mList->setSelected( item, true );
+      mKeyButton->setEnabled( false );
+      emit changed();
+    }
+  }
+}
+
+void CustomTemplates::slotRemoveClicked()
+{
+  if ( mCurrentItem ) {
+    CustomTemplateItem *vitem = mItemList.take( mCurrentItem->text( 1 ) );
+    if ( vitem ) {
+      delete vitem;
+    }
+    delete mCurrentItem;
+    mCurrentItem = 0;
+    emit changed();
+  }
+}
+
+void CustomTemplates::slotListSelectionChanged()
+{
+  if ( mCurrentItem ) {
+    CustomTemplateItem *vitem = mItemList[ mCurrentItem->text( 1 ) ];
+    if ( vitem ) {
+      vitem->mContent = mEdit->text();
+      vitem->mShortcut = mKeyButton->shortcut();
+    }
+  }
+  QListViewItem *item = mList->selectedItem();
+  if ( item ) {
+    mEditFrame->setEnabled( true );
+    mCurrentItem = item;
+    CustomTemplateItem *vitem = mItemList[ mCurrentItem->text( 1 ) ];
+    if ( vitem ) {
+      // avoid emit changed()
+      disconnect( mEdit, SIGNAL( textChanged() ),
+                  this, SLOT( slotTextChanged( void ) ) );
+
+      mEdit->setText( vitem->mContent );
+      mKeyButton->setShortcut( vitem->mShortcut, false );
+      mType->setCurrentItem( vitem->mType );
+
+      connect( mEdit, SIGNAL( textChanged() ),
+              this, SLOT( slotTextChanged( void ) ) );
+
+      if ( vitem->mType == TUniversal )
+      {
+        mKeyButton->setEnabled( false );
+      } else {
+        mKeyButton->setEnabled( true );
+      }
+    }
+  } else {
+    mEditFrame->setEnabled( false );
+    mCurrentItem = 0;
+    mEdit->clear();
+    mKeyButton->setShortcut( KShortcut::null(), false );
+    mType->setCurrentItem( 0 );
+  }
+}
+
+void CustomTemplates::slotTypeActivated( int index )
+{
+  if ( mCurrentItem ) {
+    // mCurrentItem->setText( 0, indexToType( index ) );
+    CustomTemplateItem *vitem = mItemList[ mCurrentItem->text( 1 ) ];
+    if ( vitem ) {
+      vitem->mType = static_cast<Type>(index);
+    }
+    switch ( vitem->mType ) {
+    case TReply:
+      mCurrentItem->setPixmap( 0, mReplyPix );
+      break;
+    case TReplyAll:
+      mCurrentItem->setPixmap( 0, mReplyAllPix );
+      break;
+    case TForward:
+      mCurrentItem->setPixmap( 0, mForwardPix );
+      break;
+    default:
+      mCurrentItem->setPixmap( 0, QPixmap() );
+      break;
+    };
+    if ( index == TUniversal )
+    {
+      mKeyButton->setEnabled( false );
+    } else {
+      mKeyButton->setEnabled( true );
+    }
+    emit changed();
+  }
+}
+
+void CustomTemplates::slotShortcutCaptured( const KShortcut &shortcut )
+{
+  KShortcut sc( shortcut );
+  if ( sc == mKeyButton->shortcut() )
+    return;
+  if ( sc.isNull() || sc.toString().isEmpty() )
+    sc.clear();
+  bool assign = true;
+  bool customused = false;
+  // check if shortcut is already used for custom templates
+  QDictIterator<CustomTemplateItem> it(mItemList);
+  for ( ; it.current() ; ++it ) {
+    if ( !mCurrentItem || (*it)->mName != mCurrentItem->text( 1 ) )
+    {
+      if ( (*it)->mShortcut == sc )
+      {
+        QString title( I18N_NOOP("Key Conflict") );
+        QString msg( I18N_NOOP("The selected shortcut is already used "
+              "for another custom template, "
+              "would you still like to continue with the assignment?" ) );
+        assign = ( KMessageBox::warningYesNo( this, msg, title )
+                    == KMessageBox::Yes );
+        if ( assign )
+        {
+          (*it)->mShortcut = KShortcut::null();
+        }
+        customused = true;
+      }
+    }
+  }
+  // check if shortcut is used somewhere else
+  if ( !customused && !sc.isNull() &&
+       !( kmkernel->getKMMainWidget()->shortcutIsValid( sc ) ) ) {
+    QString title( I18N_NOOP("Key Conflict") );
+    QString msg( I18N_NOOP("The selected shortcut is already used, "
+          "would you still like to continue with the assignment?" ) );
+    assign = ( KMessageBox::warningYesNo( this, msg, title )
+                == KMessageBox::Yes );
+  }
+  if ( assign ) {
+    mKeyButton->setShortcut( sc, false );
+    emit changed();
+  }
+}
+
+#include "customtemplates.moc"
Index: kmail/kmreadermainwin.h
===================================================================
--- kmail/kmreadermainwin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmreadermainwin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -65,8 +65,8 @@
   KURL mUrl;
   QMap<int,KMFolder*> mMenuToFolder;
   // a few actions duplicated from kmmainwidget
-  KAction *mTrashAction, *mPrintAction, *mReplyAction, *mReplyAllAction, *mReplyAuthorAction,
-          *mReplyListAction, *mForwardInlineAction,
+  KAction *mTrashAction, *mPrintAction, *mSaveAsAction, *mReplyAction,
+          *mReplyAllAction, *mReplyAuthorAction, *mReplyListAction, *mForwardInlineAction,
           *mForwardAttachedAction, *mForwardDigestAction, *mRedirectAction,
           *mViewSourceAction;
   KActionMenu *mReplyActionMenu;
Index: kmail/kmfoldertree.cpp
===================================================================
--- kmail/kmfoldertree.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -119,6 +119,7 @@
       case SentMail: icon = "folder_sent_mail"; break;
       case Trash: icon = "trashcan_empty"; break;
       case Drafts: icon = "edit"; break;
+      case Templates: icon = "filenew"; break;
       default: icon = kmkernel->iCalIface().folderPixmap( type() ); break;
     }
     // non-root search folders
@@ -151,9 +152,10 @@
 {
   QPixmap pm;
 
-  if ( !mFolder || depth() == 0 || mFolder->isSystemFolder()
-    || kmkernel->folderIsTrash( mFolder )
-    || kmkernel->folderIsDraftOrOutbox( mFolder ) )
+  if ( !mFolder || depth() == 0 || mFolder->isSystemFolder() ||
+       kmkernel->folderIsTrash( mFolder ) ||
+       kmkernel->folderIsTemplates( mFolder ) ||
+       kmkernel->folderIsDraftOrOutbox( mFolder ) )
     pm = normalIcon( size );
 
   KIconLoader * il = KGlobal::instance()->iconLoader();
@@ -202,6 +204,8 @@
       setType( SentMail );
     else if ( kmkernel->folderIsTrash( mFolder ) )
       setType( Trash );
+    else if ( kmkernel->folderIsTemplates( mFolder ) )
+      setType( Templates );
     else if( kmkernel->iCalIface().isResourceFolder(mFolder) )
       setType( kmkernel->iCalIface().folderType(mFolder) );
     // System folders on dimap or imap which are not resource folders are
@@ -810,11 +814,12 @@
       return false;
 
     if (confirm) {
-      // Skip drafts and sent mail as well, when reading mail with the space bar
-      // but not when changing into the next folder with unread mail via ctrl+ or
-      // ctrl- so we do this only if (confirm == true), which means we are doing
-      // readOn.
+      // Skip drafts, sent mail and templates as well, when reading mail with
+      // the space bar but not when changing into the next folder with unread
+      // mail via ctrl+ or ctrl- so we do this only if (confirm == true),
+      // which means we are doing readOn.
       if ( fti->type() == KFolderTreeItem::Drafts ||
+           fti->type() == KFolderTreeItem::Templates ||
            fti->type() == KFolderTreeItem::SentMail )
         return false;
 
@@ -1020,11 +1025,10 @@
       mMainWidget->action("compact")->plug(folderMenu);
 
       folderMenu->insertSeparator();
+      mMainWidget->action("empty")->plug(folderMenu);
       if ( !fti->folder()->isSystemFolder() ) {
         mMainWidget->action("delete_folder")->plug(folderMenu);
-        folderMenu->insertSeparator();
       }
-      mMainWidget->action("empty")->plug(folderMenu);
       folderMenu->insertSeparator();
     }
   }
@@ -1549,7 +1553,7 @@
   if (folder && folder->noContent()) // always empty
     count = -1;
   else {
-    if ( fti->folder() ) 
+    if ( fti->folder() )
       count = fti->folder()->countUnread();
   }
 
Index: kmail/kmmsginfo.cpp
===================================================================
--- kmail/kmmsginfo.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmmsginfo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -186,6 +186,7 @@
                      KMMsgEncryptionState encryptionState,
                      KMMsgSignatureState signatureState,
                      KMMsgMDNSentState mdnSentState,
+                     const QCString& prefCharset,
              off_t aFolderOffset, size_t aMsgSize,
              size_t aMsgSizeServer, ulong aUID)
 {
@@ -194,9 +195,9 @@
     if(!kd)
         kd = new KMMsgInfoPrivate;
     kd->modifiers = KMMsgInfoPrivate::ALL_SET;
-    kd->subject = decodeRFC2047String(aSubject);
-    kd->from = decodeRFC2047String( KMMessage::stripEmailAddr( aFrom ) );
-    kd->to = decodeRFC2047String( KMMessage::stripEmailAddr( aTo ) );
+    kd->subject = decodeRFC2047String(aSubject, prefCharset);
+    kd->from = decodeRFC2047String( KMMessage::stripEmailAddr( aFrom ), prefCharset );
+    kd->to = decodeRFC2047String( KMMessage::stripEmailAddr( aTo ), prefCharset );
     kd->replyToIdMD5 = base64EncodedMD5( replyToId );
     kd->replyToAuxIdMD5 = base64EncodedMD5( replyToAuxId );
     kd->strippedSubjectMD5 = base64EncodedMD5( KMMessage::stripOffPrefixes( kd->subject ), true /*utf8*/ );
@@ -224,12 +225,13 @@
                      KMMsgEncryptionState encryptionState,
                      KMMsgSignatureState signatureState,
                      KMMsgMDNSentState mdnSentState,
+                     const QCString& prefCharset,
                      size_t aMsgSize,
              size_t aMsgSizeServer, ulong aUID)
 {
   // use the "normal" init for most stuff
   init( aSubject, aFrom, aTo, aDate, aStatus, aXMark, replyToId, replyToAuxId,
-        msgId, encryptionState, signatureState, mdnSentState,
+        msgId, encryptionState, signatureState, mdnSentState, prefCharset,
         (unsigned long)0, aMsgSize, aMsgSizeServer, aUID );
   kd->file = aFileName;
 }
Index: kmail/kmail_config_security.desktop
===================================================================
--- kmail/kmail_config_security.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_security.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -66,7 +66,7 @@
 Comment[bg]=Настройки на сигурността
 Comment[br]=Kefluniadur surentez ar buhez prevez
 Comment[bs]=Postavke sigurnosti i privatnosti
-Comment[ca]=Arranjament de seguretat i privacitat
+Comment[ca]=Arranjament de seguretat i privadesa
 Comment[cs]=Nastavení soukromí a zabezpečení
 Comment[da]=Sikkerheds- & Privathedsindstillinger
 Comment[de]=Einstellungen zu Sicherheit und Privatsphäre
@@ -74,7 +74,7 @@
 Comment[es]=Opciones de seguridad y privacidad
 Comment[et]=Turvalisus- ja privaatsusseadistused
 Comment[eu]=Sekuritate & pribakortasun ezarpenak
-Comment[fa]=امنیت و تنظیمات محرمانگی‌
+Comment[fa]=امنیت و تنظیمات محرمانگی
 Comment[fi]=Turvallisuus- ja yksityisyysasetukset
 Comment[fr]=Paramètres de sécurité et de confidentialité
 Comment[gl]=Opcións de Seguridade e Intimidade
@@ -119,7 +119,7 @@
 Keywords[es]=kmail,seguridad
 Keywords[et]=kmail,turvalisus
 Keywords[eu]=kmail,sekuritate
-Keywords[fa]=kmail،امنیت
+Keywords[fa]=kmail، امنیت
 Keywords[fi]=kmail,turvallisuus
 Keywords[fr]=KMail,sécurité
 Keywords[ga]=kmail,slándáil
Index: kmail/objecttreeparser.cpp
===================================================================
--- kmail/objecttreeparser.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/objecttreeparser.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1734,6 +1734,7 @@
 
     QString comment = msgPart->contentDescription();
     comment = KMMessage::quoteHtmlChars( comment, true );
+    if ( label == comment ) comment = QString::null;
 
     QString fileName = mReader->writeMessagePartToTempFile( msgPart, partNum );
 
Index: kmail/kmail_config_accounts.desktop
===================================================================
--- kmail/kmail_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kmail/kmail_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
@@ -61,6 +62,7 @@
 Name[zh_CN]=账户
 Name[zh_TW]=帳號
 Comment=Setup for Sending and Receiving Messages
+Comment[ar]=تعيينات إرسال و إستقبال الرسائل
 Comment[bg]=Настройки на мрежата, сървърите и сметките
 Comment[bs]=Postavke za slanje i prijem poruka
 Comment[ca]=Configuració per enviar i rebre missatges
@@ -74,6 +76,7 @@
 Comment[fa]=برپایی برای ارسال و دریافت پیامها
 Comment[fi]=Viestien lähetys- ja vastaanottoasetukset
 Comment[fr]=Configuration de l'envoi et de la réception de messages
+Comment[gl]=Configuración para Enviar e Recibir Mensaxes
 Comment[hu]=Küldési és fogadási beállítások
 Comment[is]=Uppsetning fyrir sendingu og móttöku af tölvupósti
 Comment[it]=Impostazioni per spedire e ricevere messaggi
@@ -112,10 +115,11 @@
 Keywords[es]=kmail,cuentas
 Keywords[et]=kmail,kontod
 Keywords[eu]=kmail,kontuak
-Keywords[fa]=kmail،حسابها
+Keywords[fa]=kmail، حسابها
 Keywords[fi]=kmail,tilit
 Keywords[fr]=KMail,comptes
 Keywords[ga]=kmail,cuntais
+Keywords[gl]=kmail,contas
 Keywords[he]=kmail,accounts,דוא"ל, חשבון, חשבונות
 Keywords[hu]=kmail,azonosítók
 Keywords[is]=kmail,accounts,tengingar
Index: networkstatus/networkstatus.desktop
===================================================================
--- networkstatus/networkstatus.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ networkstatus/networkstatus.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,14 +5,15 @@
 Name[ca]=Dimoni de l'estat de la xarxa
 Name[cs]=Démon stavu sítě
 Name[da]=Netværkstatusdæmon
-Name[de]=Netzwerkstatus-Programm
+Name[de]=Überwachung des Netzwerkstatus
 Name[el]=Δαίμονας κατάστασης δικτύου
 Name[es]=Daemon de estado de la red
 Name[et]=Võrguoleku deemon
 Name[eu]=Sarearen egoera deabrua
-Name[fa]=شبح وضعیت شبکه‌
+Name[fa]=شبح وضعیت شبکه
 Name[fi]=Verkkotilan tarkkailija
 Name[fr]=Suivi de l'état du réseau
+Name[gl]=Daemon do Estado da Rede
 Name[hu]=Hálózati állapotjelző szolgáltatás
 Name[is]=Netstöðupúki
 Name[it]=Demone dello stato della rete
@@ -35,7 +36,7 @@
 Name[sv]=Nätverksstatusdemon
 Name[ta]=வலைப்பின்னல் நிலை டெமான்
 Name[tr]=Ağ Durum İzleyici
-Name[uk]=Даемон стану мережі
+Name[uk]=Демон стану мережі
 Name[zh_CN]=网络状态守护程序
 Name[zh_TW]=網路狀態守護程式
 Comment=Tracks status of network interfaces and provides notification to applications using the network.
@@ -43,7 +44,7 @@
 Comment[ca]=Monitoritza l'estat de les interfícies de xarxa i proporciona notificacions a les aplicacions que usen la xarxa.
 Comment[cs]=Zjiš'tuje stav síťových rozhraní a upozorňuje v případě přístupu aplikací k síti.
 Comment[da]=Sporer status af netværksgrænseflade og sørger for meddelelser til programmer der bruger netværket.
-Comment[de]=Überprüft den Status von Netzwerkschnittstellen und erzeugt Benachrichtigungen an Anwendungen, die das Netzwerk benutzen wollen.
+Comment[de]=Überprüft den Netzwerk-Status und benachrichtigt anfragende Anwendungen
 Comment[el]=Παρακολουθεί την κατάσταση του δικτύου και παρέχει ειδοποιήσεις σε εφαρμογές που χρησιμοποιούν το δίκτυο.
 Comment[es]=Sigue la pista de las interfaces de red y proporciona notificaciones a las aplicaciones que están usando la red.
 Comment[et]=Jälgib võrguliideste olekut ja annab sellest võrgu vahendusel rakendustele teada.
@@ -51,6 +52,7 @@
 Comment[fa]=وضعیت واسطهای شبکه را شیار داده و با استفاده از شبکه، برای کاربردها اخطار فراهم می‌کند.
 Comment[fi]=Tarkkailee verkkoliitäntöjen tilaa ja varoittaa verkkoa käyttäviä sovelluksia.
 Comment[fr]=Surveille l'état des interfaces réseaux et fournit des notifications aux applications qui utilisent le réseau
+Comment[gl]=Monitoriza o estado das interfaces de rede e fornece notificacións ás aplicacións que usen a rede.
 Comment[hu]=Figyeli a hálózati csatolók állapotát és értesítési lehetőséget biztosít hálózati alkalmazások számára.
 Comment[is]=Fylgist með stöðu netkorta og sendir tilkynningar til forrita sem nota netið.
 Comment[it]=Controlla lo stato delle interfacce di rete e fornisce notifiche alle applicazioni che usano al rete.
Index: knode/knode_config_identity.desktop
===================================================================
--- knode/knode_config_identity.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/knode_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -25,7 +25,7 @@
 Name[es]=Identidad
 Name[et]=Identiteet
 Name[eu]=Identitatea
-Name[fa]=هویت‌
+Name[fa]=هویت
 Name[fi]=Henkilöllisyys
 Name[fr]=Identité
 Name[ga]=Aitheantas
Index: knode/articlewidget.h
===================================================================
--- knode/articlewidget.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/articlewidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -145,7 +145,7 @@
       FancyFormatting = 2,
       AllowROT13 = 4
     };
-    /// convert the given string into a HTML string
+    /// convert the given string into an HTML string
     QString toHtmlString( const QString &line, int flags = ParseURL );
     /// convert the given image into a data:/ URL
     static QString imgToDataUrl( const QImage &image, const char* fmt );
Index: knode/knode_config_accounts.desktop
===================================================================
--- knode/knode_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/knode_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KNode
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
Index: knode/knode_config_privacy.desktop
===================================================================
--- knode/knode_config_privacy.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/knode_config_privacy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -23,7 +23,7 @@
 Name[es]=Firmar/Verificar
 Name[et]=Signeerimine/kontroll
 Name[eu]=Sinadura/Egiaztapena
-Name[fa]=امضا/وارسی‌
+Name[fa]=امضا/وارسی
 Name[fi]=Allekirjoittaminen/tarkistaminen
 Name[fr]=Signature/Vérification
 Name[gl]=Asinando/Verificando
@@ -57,7 +57,7 @@
 Comment=Protect your privacy by signing and verifying postings
 Comment[bg]=Защита на личната кореспонденция чрез подписване и проверка на съобщенията
 Comment[bs]=Zaštitite vašu privatnost potpisivanjem i provjerom postinga
-Comment[ca]=Protegiu la vostra privacitat signant i verificant els missatges
+Comment[ca]=Protegiu la vostra privadesa signant i verificant els missatges
 Comment[cs]=Chraňte své soukromí pomocí podepisování a ověřování podpisů
 Comment[da]=Beskyt dine private oplysninger ved at underskrive og verificere indsendelser
 Comment[de]=Schutz der Privatsphäre durch Signieren und Verifizieren von Beiträgen.
@@ -68,6 +68,7 @@
 Comment[fa]=حفظ محرمانگی خود با امضا و وارسی ارسالهای سریع
 Comment[fi]=Suojele yksityisyyttäsi allekirjoittamalla ja varmentamalla posti
 Comment[fr]=Protection de votre vie privée lors de la signature et vérification des envois
+Comment[gl]=Protexe a súa intimidade asinando e verificando as entradas
 Comment[hu]=Az adatok védelme az üzenetek elektronikus aláírásával, titkosításával
 Comment[is]=Verndaðu einkalífið þitt með því að undirrita og staðfesta sendingar
 Comment[it]=Proteggi la tua privacy firmando e verificando i messaggi
Index: knode/knode_config_cleanup.desktop
===================================================================
--- knode/knode_config_cleanup.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/knode_config_cleanup.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -23,7 +23,7 @@
 Name[es]=Limpiar
 Name[et]=Puhastamine
 Name[eu]=Garbiketa
-Name[fa]=پاک‌سازی‌
+Name[fa]=پاک‌سازی
 Name[fi]=Siivoaminen
 Name[fr]=Nettoyage
 Name[ga]=Glan
Index: knode/knode_config_appearance.desktop
===================================================================
--- knode/knode_config_appearance.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/knode_config_appearance.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -75,7 +75,7 @@
 Comment[es]=Apariencia visual personalizada
 Comment[et]=Välimuse seadistused
 Comment[eu]=Pertsonalizatu itxura
-Comment[fa]=سفارشی کردن ظاهر تصویری‌
+Comment[fa]=سفارشی کردن ظاهر تصویری
 Comment[fi]=Ulkonäköasetukset
 Comment[fr]=Personnalisation de l'apparence
 Comment[gl]=Personalizar a apariencia visual
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knode/KNode.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -6,7 +6,6 @@
 Terminal=false
 DocPath=knode/index.html
 Name=KNode
-Name[ar]=قارئ الأخبار
 Name[eo]=Diskutrondoj
 Name[hi]=के-नोड
 Name[ro]=Ştiri Internet
@@ -42,7 +41,7 @@
 GenericName[id]=Pembaca Berita
 GenericName[is]=Fréttaforrit
 GenericName[it]=Lettore newsgroup
-GenericName[ja]=ニュースリーダ
+GenericName[ja]=ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​ព័ត៌មាន
 GenericName[lt]=Naujienų skaityklė
 GenericName[lv]=Ziņu Lasītājs
Index: kioslaves/sieve/draft-showalter-sieve-vacation-04.txt
===================================================================
--- kioslaves/sieve/draft-showalter-sieve-vacation-04.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-showalter-sieve-vacation-04.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,396 +1 @@
-
-
-
-
-
-
-Network Working Group                                       T. Showalter
-Internet Draft: Sieve: Vacation Extension                      Mirapoint
-Document: draft-showalter-sieve-vacation-04.txt           August 8, 2000
-Expire in six months
-
-
-                       Sieve: Vacation Extension
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is in full conformance with
-   all provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as Internet-
-   Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six months
-   and may be updated, replaced, or obsoleted by other documents at any
-   time.  It is inappropriate to use Internet-Drafts as reference
-   material or to cite them other than as "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/ietf/1id-abstracts.txt
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-Copyright
-
-   Copyright (C) The Internet Society 2000.  All Rights Reserved.
-
-Abstract
-
-   This document describes an extension to the Sieve mail filtering
-   language for an autoresponder similar to that of the Unix "vacation"
-   command for replying to messages with certain safety features to
-   prevent problems.
-
-
-
-
-
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 1]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-0. Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-0.1. Discussion
-
-   This draft is intended to be an extension to the Sieve mail filtering
-   language, avaliable from the Internet-Drafts repository as
-   <ftp://ftp.ietf.org/internet-drafts/draft-showalter-sieve-10.txt>
-   (where 10 is the version number, which is currently 10).
-
-   This draft and the Sieve language itself are being discussed on the
-   MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-   requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-   email message with the word "subscribe" in the body).  More
-   information on the mailing list along with a WWW archive of back
-   messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-1. Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE] for
-   notification that messages will not be immediately answered.
-
-   Conventions for notations are as in [SIEVE] section 1.1.
-
-   The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", "CAN", and
-   "MAY" in this document are to be interpreted as defined in
-   [KEYWORDS].
-
-2. Capability Identifier
-
-   Sieve implementations that implement vacation have an identifier of
-   "vacation" for use with the capability mechanism.
-
-3. Vacation Action
-
-   Syntax:   vacation [":days" number] [":addresses" string-list]
-             [":subject" string] [":mime"] <reason: string>
-
-   The "vacation" action implements a vacation autoresponder similar to
-   the vacation command  available under many versions of Unix.  Its
-   purpose is to provide correspondents with notification that the user
-   is away for an extended period of time and that they should not
-   expect quick responses.
-
-   "Vacation" is used to respond to a message with another message.
-   Vacation's messages are always addressed to the Return-Path address
-
-
-
-Showalter                 Expire in Six Months                  [Page 2]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   (that is, the envelope from address) of the message being responded
-   to.
-
-3.1. Days Parameter
-
-   The ":days" argument is used to specify the period in which addresses
-   are kept and are not responded to, and is always specified in days.
-   The minimum value used for this parameter is 1.  Sites MAY define a
-   different minimum value.  Sites MAY also define a maximum days value,
-   which MUST be greater than 7, and SHOULD be greater than 30.
-
-   If ":days" is omitted, the default value is either 7 or the minimum
-   value (as defined above), whichever is greater.
-
-   If the parameter given to ":days" is less than the minimum value,
-   then the minimum value is used instead.
-
-   If ":days" exceeds the site-defined maximum, the site-defined maximum
-   is used instead.
-
-3.2. Previous Response Tracking
-
-   "Vacation" keeps track of all of the addresses that it has responded
-   to in some period (as specified by the :days optional argument).  If
-   vacation has not previously responded to this address within that
-   time period, it sends the "reason" argument to the Return-Path
-   address of the message that is being responded to.
-
-   Vacation responses are not just per address, but are per address per
-   vacation command.  For instance, If coyote@desert sends mail to
-   roadrunner@acme, once with the subject "Cyrus bug" and once with the
-   subject "come over for dinner", and roadrunner@acme has the script
-   below, coyote@desert would receive two responses, once with the first
-   message, once with the second.
-
-   Example:  require "vacation";
-             if subject :contains "cyrus" {
-                        vacation "I'm out -- send mail to cyrus-bugs";
-             } else {
-                        vacation "I'm out -- call me at 304 555 1212";
-             }
-
-
-   Note that coyote@desert gets the second message despite having gotten
-   the first one because separate vacation responses have been
-   triggered.  This behavior is REQUIRED.
-
-   If a sieve script changes, implementations MAY reset the records of
-
-
-
-Showalter                 Expire in Six Months                  [Page 3]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   who has been responded to and when they have been responded to.
-   Alternatively, implementations can store records of who has received
-   which message, perhaps by storing a hash of the message and the
-   recipient.
-
-3.3. Subject Parameter
-
-   Users can specify the subject of the reply with the ":subject"
-   parameter.  If the :subject parameter is not supplied, then the
-   subject is generated as follows: The subject is set to the characters
-   "Re: " followed by the original subject with all leading occurrence
-   of the characters "Re: " stripped off.
-
-3.4. MIME Parameter
-
-   The ":mime" parameter, if supplied, specifies that the reason string
-   is, in fact, a MIME part, including MIME headers (see section 2.4.2.4
-   of [SIEVE]).
-
-   If the optional :mime parameter is not supplied, the reason string is
-   considered to be a UTF-8 string.
-
-3.5. In-Reply-To
-
-   Replies MUST have the In-Reply-To field set to the Message-ID of the
-   original message.
-
-3.6. Address Parameter and Limiting Replies to Personal Messages
-
-   "Vacation" MUST NOT respond to a message unless the user's email
-   address is in the "To", "Cc", or "Bcc" line of the original message.
-   Implementations are assumed to know the user's email address, but
-   users may have additional addresses beyond the control of the local
-   mail system.
-
-   Users can supply additional mail addresses that are theirs with the
-   ":addresses" argument, which takes a string-list listing additional
-   addresses that a user might have.  These addresses are considered in
-   addition to the addresses that the implementation knows.
-
-3.7. Restricting Replies to Automated Processes and Mailing Lists
-
-   Implementations MUST have a list of addresses that "vacation" MUST
-   NOT send mail to.  However, the contents of this list are
-   implementation defined.  The purpose of this list is to stop mail
-   from going to addresses used by system daemons that would not care if
-   the user is actually reading her mail.
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 4]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   Implementations are encouraged, however, to include well-known
-   addresses like "MAILER-DAEMON", "LISTSERV", "majordomo", and other
-   addresses typically used only by automated systems.  Additionally,
-   addresses ending in "-request" or beginning in "owner-", i.e.,
-   reserved for mailing list software, are also suggested.
-
-   Implementors may take guidance from [MAILBOXNAMES], but should be
-   careful.  Some addresses, like "POSTMASTER", are generally actually
-   managed by people, and people do care if the user is going to be
-   unavailable.
-
-   Implementations SHOULD NOT not to respond to any message with a
-   header that begins with "List-".
-
-3.8. Interaction with Other Sieve Actions
-
-   Vacation does not affect the implicit keep.
-
-   Vacation can only be executed once per script.  If vacation  is  used
-   with another vacation, the script fails.
-
-   Implementations MUST NOT consider vacation used with  discard,  keep,
-   fileinto, or redirect an error.
-
-3.9. Examples
-
-   Here is a simple use of vacation.
-
-   Example:  require "vacation";
-             vacation :days 23
-                :addresses                           ["tjs@example.edu",
-                "ts4z@landru.example.edu"]
-                "I'm away until October 19.
-                If it's an emergency, call 911, I guess." ;
-
-   By mingling vacation with other rules, users can  do  something  more
-   selective.
-
-   Example:  require "vacation";
-             if header :contains "from" "boss@example.edu" {
-                redirect "pleeb@isp.example.org";
-             } else {
-                vacation "Sorry, I'm away, I'll read your message
-                   when I get around to it.";
-             }
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 5]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-4. Security Considerations
-   It is critical that implementations correctly implement the
-   limitations described above.  Replies MUST NOT be sent out in
-   response to messages not sent directly to the user, and replies MUST
-   NOT be sent out more often than the :days argument states.
-
-5. Author's Address
-
-   Tim Showalter
-   Mirapoint, Inc.
-   909 Hermosa Court
-   Sunnyvale, CA 94085
-
-   E-Mail: tjs@mirapoint.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 6]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-Appendix A.  References
-
-   [IMAIL] Crocker, D., "Standard for the Format of ARPA  Internet  Text
-   Messages", STD 11, RFC 822, University of Delaware, August 1982.
-
-   [KEYWORDS] Bradner, S., "Key  words  for  use  in  RFCs  to  Indicate
-   Requirement Levels", RFC 2119, Harvard University, March 1997.
-
-   [MAILBOXNAMES] Crocker, D. "Mailbox Names for Common Services, Roles,
-   and Functions", RFC 2142, Internet Mail Consortium, May, 1997.
-
-   [MIME] Freed, N., and  N.  Borenstein,  "Multipurpose  Internet  Mail
-   Extensions  (MIME)  Part One: Format of Internet Message Bodies", RFC
-   2045, Innosoft and First Virtual, November 1996.
-
-   [SIEVE]  Showalter,  T.,   "Sieve:  A   Mail   Filtering   Language",
-   Mirapoint, Inc., Work in Progress.
-
-Appendix B. Full Copyright Statement
-
-   Copyright (C) The Internet Society 2000. All Rights Reserved.
-
-   This document and translations of it may be copied and  furnished  to
-   others,  and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be  prepared,  copied,  published
-   and  distributed,  in  whole  or  in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included  on  all  such  copies  and derivative works.  However, this
-   document itself may not be modified in any way, such as  by  removing
-   the  copyright  notice or references to the Internet Society or other
-   Internet  organizations,  except  as  needed  for  the   purpose   of
-   developing  Internet  standards  in  which  case  the  procedures for
-   copyrights  defined  in  the  Internet  Standards  process  must   be
-   followed,  or  as  required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will  not  be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on  an
-   "AS  IS"  basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS  OR  IMPLIED,  INCLUDING
-   BUT  NOT  LIMITED  TO  ANY  WARRANTY  THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS  OR  ANY  IMPLIED  WARRANTIES  OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 7]
-
-
+http://ktown.kde.org/~dirk/sieve/draft-showalter-sieve-vacation-04.txt
Index: kioslaves/sieve/draft-murchison-sieve-regex-06.txt
===================================================================
--- kioslaves/sieve/draft-murchison-sieve-regex-06.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-murchison-sieve-regex-06.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,452 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                        K. Murchison
-Document: draft-murchison-sieve-regex-06.txt           Oceana Matrix Ltd.
-Expires January 5, 2003                                      30 June 2002
-
-
-                    Sieve -- Regular Expression Extension
-
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are working
-    documents of the Internet Engineering Task Force (IETF), its areas,
-    and its working groups.  Note that other groups may also distribute
-    working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six months
-    and may be updated, replaced, or obsoleted by other documents at any
-    time.  It is inappropriate to use Internet-Drafts as reference
-    material or to cite them other than as "work in progress."
-
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-Copyright Notice
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-
-Abstract
-
-    In some cases, it is desirable to have a string matching mechanism
-    which is more powerful than a simple exact match, a substring match
-    or a glob-style wildcard match.  The regular expression matching
-    mechanism defined in this draft should allow users to isolate just
-    about any string or address in a message header or envelope.
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 1]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Copyright Notice . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-0.     Meta-information on this draft  . . . . . . . . . . . . . . .   3
-
-0.1.   Discussion  . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.   Noted Changes . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.1  since -05 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.2  since -04 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.3.   Open Issues . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   4
-
-3.     Regex Match Type  . . . . . . . . . . . . . . . . . . . . . .   4
-
-4.     Security Considerations . . . . . . . . . . . . . . . . . . .   6
-
-5.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   6
-
-6.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix A.  References  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix B.  Full Copyright Statement  . . . . . . . . . . . . . . .   8
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 2]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-
-0.     Meta-information on this draft
-
-    This information is intended to facilitate discussion.  It will be
-    removed when this document leaves the Internet-Draft stage.
-
-
-0.1.   Discussion
-
-    This draft is intended to be an extension to the Sieve mail filtering
-    language, available from the RFC repository as
-    <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-    This draft and the Sieve language itself are being discussed on the
-    MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-    requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-    email message with the word "subscribe" in the body).  More
-    information on the mailing list along with a WWW archive of back
-    messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.   Noted Changes
-
-
-0.2.1  since -05
-
-    Added open issue regarding localization/internationalization.
-
-    Added that implementations SHOULD reject regexes not supported by
-    this extension.
-
-    Editorial changes.
-
-
-0.2.2  since -04
-
-    Editorial changes.
-
-
-0.3.   Open Issues
-
-    The major open issue with this draft is what to do, if anything,
-    about localization/internationalization.  Are [POSIX.2] collating
-    sequences and character equivalents sufficient?
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 3]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-1.  Introduction
-
-    This is an extension to the Sieve language defined by [SIEVE] for
-    comparing strings to regular expressions.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "regex".
-
-
-3.  Regex Match Type
-
-    Commands that support matching may take the optional tagged argument
-    ":regex" to specify that a regular expression match should be
-    performed.  The ":regex" match type is subject to the same rules and
-    restrictions as the standard match types defined in [SIEVE].  For
-    convenience, the "MATCH-TYPE" syntax element defined in [SIEVE] is
-    augmented here as follows:
-
-         MATCH-TYPE  =/  ":regex"
-
-    Example:
-
-          require "regex";
-
-          # Try to catch unsolicited email.
-          if anyof (
-            # if a message is not to me (with optional +detail),
-            not address :regex ["to", "cc", "bcc"]
-              "me(\\+.*)?@company\\.com",
-
-            # or the subject is all uppercase (no lowercase)
-            header :regex :comparator "i;octet" "subject"
-              "^[^:lower:]+$" ) {
-
-            discard;     # junk it
-          }
-
-    The ":regex" match type is compatible with both the "i;octet" and
-    "i;ascii-casemap" comparators and may be used with them.
-
-    Implementations MUST support extended regular expressions (EREs) as
-    defined by [POSIX.2].  Any regular expression not defined by
-
-
-
-Expires January 5, 2003       Murchison                         [Page 4]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-    [POSIX.2], as well as [POSIX.2] basic regular expressions, word
-    boundaries and backreferences are not supported by this extension.
-    Implementations SHOULD reject regular expressions that are
-    unsupported by this specification as a syntax error.
-
-    The following table provides a brief summary of the regular
-    expressions that MUST be supported.  This table is presented here
-    only as a guideline.  [POSIX.2] should be used as the definitive
-    reference.
-
-
-    +------------+-----------------------------------------------------+
-    | Expression |  Pattern                                            |
-    +------------+-----------------------------------------------------+
-    |                Items to match a single character                 |
-    +------------+-----------------------------------------------------+
-    |     .      |  Match any single character except newline.         |
-    |    [ ]     |  Bracket expression.  Match any one of the enclosed |
-    |            |  characters.  A hypen (-) indicates a range of      |
-    |            |  consecutive characters.                            |
-    |   [^  ]    |  Negated bracket expression.  Match any one         |
-    |            |  character NOT in the enclosed list.  A hypen (-)   |
-    |            |  indicates a range of consecutive characters.       |
-    |    \\      |  Escape the following special character (match      |
-    |            |  the literal character).  Undefined for other       |
-    |            |  characters.                                        |
-    |            |  NOTE: Unlike [POSIX.2], a double-backslash is      |
-    |            |  required as per section 2.4.2 of [SIEVE].          |
-    +------------+-----------------------------------------------------+
-    |   Items to be used within a bracket expression (localization)    |
-    +------------+-----------------------------------------------------+
-    |   [: :]    |  Character class (alnum, alpha, blank, cntrl,       |
-    |            |  digit, graph, lower, print, punct, space,          |
-    |            |  upper, xdigit).                                    |
-    |   [= =]    |  Character equivalents.                             |
-    |   [. .]    |  Collating sequence.                                |
-    +------------+-----------------------------------------------------+
-    |  Quantifiers - Items to count the preceding regular expression   |
-    +------------+-----------------------------------------------------+
-    |     ?      |  Match zero or one instances.                       |
-    |     *      |  Match zero or more instances.                      |
-    |     +      |  Match one or more instances.                       |
-    |   {n,m}    |  Match any number of instances between              |
-    |            |  n and m (inclusive).  {n} matches exactly n        |
-    |            |  instances.  {n,} matches n or more instances.      |
-    +------------+-----------------------------------------------------+
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 5]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-    +------------+-----------------------------------------------------+
-    | Expression |  Pattern                                            |
-    +------------+-----------------------------------------------------+
-    |              Anchoring - Items to match positions                |
-    +------------+-----------------------------------------------------+
-    |     ^      |  Match the beginning of the line or string.         |
-    |     $      |  Match the end of the line or string.               |
-    +------------+-----------------------------------------------------+
-    |                        Other constructs                          |
-    +------------+-----------------------------------------------------+
-    |     |      |  Alternation.  Match either of the separated        |
-    |            |  regular expressions.                               |
-    |    ( )     |  Group the enclosed regular expression(s).          |
-    +------------+-----------------------------------------------------+
-
-
-4.  Security Considerations
-
-    Security considerations are discussed in [SIEVE].  It is believed
-    that this extension doesn't introduce any additional security
-    concerns.
-
-    However, a poor implementation COULD introduce security problems
-    ranging from degradation of performance to denial of service.  If an
-    implementation uses a third-party regular expression library, that
-    library should be checked for potentially problematic regular
-    expressions, such as "(.*)*".
-
-
-5.  Acknowledgments
-
-    Thanks to Tim Showalter, Alexey Melnikov, Tony Hansen, Phil Pennock
-    and Jutta Degener for their help with this document.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 6]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-6.  Author's Address
-
-    Kenneth Murchison
-    Oceana Matrix Ltd.
-    21 Princeton Place
-    Orchard Park, NY 14127
-
-    Phone: (716) 662-8973
-    EMail: ken@oceana.com
-
-
-Appendix A.  References
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-         Requirement Levels", Harvard University, RFC 2119, March, 1997.
-
-
-     [SIEVE] Showalter, T., "Sieve: A Mail Filtering Language", Mira
-         point, Inc., RFC 3028, January 2001.
-
-
-     [POSIX.2], "Portable Operating System Interface (POSIX). Part 2,
-         Shell and utilities", National Institute of Standards and Tech
-         nology (U.S.).
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 7]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-
-Appendix B.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of develop-
-    ing Internet standards in which case the procedures for copyrights
-    defined in the Internet Standards process must be followed, or as
-    required to translate it into languages other than English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/draft-murchison-sieve-regex-06.txt
Index: kioslaves/sieve/draft-degener-sieve-editheader.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-editheader.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-degener-sieve-editheader.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,287 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: October 2003                                          April 2003
-
-
-                      Sieve -- "editheader" extension
-		  <draft-degener-sieve-editheader-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines three new actions for the "sieve"
-   language that add, delete, and change e-mail header fields.
-
-
-1. Introduction
-
-   Email headers are a flexible and easy to understand means
-   of communication between email processors.
-   This extension enables sieve scripts to interact with other
-   components that consume or produce header fields by allowing
-   the script to delete, modify, and add header fields itself.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "editheader".
-
-
-3. Action addheader
-
-   Syntax:
-   	"addheader" <name: string> <value: string>
-
-   The addheader action appends a header field to the existing
-   message header.  The name MUST be a valid 7-bit US-ASCII header
-   field name as described by RFC 2822 "field-name" nonterminal.
-
-   If the specified field value does not match the RFC 2822
-   "unstructured" nonterminal or exceeds a length limit set by
-   the implementation, the implementation MUST either flag an
-   error or encode the field using folding white space and the
-   encodings described in RFC 2047 or RFC 2231 to be compliant
-   with RFC 2822.
-
-   The header field MUST be added at the end of the existing
-   header.
-
-   An implementation MAY impose a length limit onto the size of
-   the encoded header field; such a limit MUST NOT be less
-   than 998 characters, not including the terminating CRLF
-   supplied by the implementation.
-
-   Example:
-	/* Don't redirect if we already redirected */
-	if not header :contains "X-Sieve-Filtered"
-		["<kim@job.tld>", "<kim@home.tld>"]
-	{
-   		addheader "X-Sieve-Filtered" "<kim@job.tld>";
-		redirect "kim@home.tld";
-	}
-
-
-4. Action deleteheader
-
-   Syntax:
-   	"deleteheader"
-		[":index" <fieldno: number> [":last"]]
-		[COMPARATOR] [MATCH-TYPE]
-		<field-name: string>
-		[<value-patterns: string-list>]
-
-   By default, the deleteheader action deletes all occurrences
-   of the named header field.
-
-   The field-name is mandatory and always matched as a
-   case-insensitive us-ascii string.  The value-patterns,
-   if specified, are matched according to the match type and
-   comparator.  If none are specified, all values match.
-
-   The field-name MUST be a valid 7-bit header field name as
-   described by the RFC 2822 "field-name" nonterminal.
-
-   If :index <fieldno> is specified, the attempts to match 
-   a value are limited to the header field <fieldno> (beginning
-   at 1, the first named header field).  If :last is specified,
-   the count is backwards; 1 denotes the last named header field,
-   2 the second to last, and so on.  The counting happens
-   before the <value-patterns> match, if any;
-   
-   	deleteheader :index 2 :contains "Received" "via carrier-pigeon"
-
-   deletes the second "Received:" header field if it contains
-   the string "via carrier-pigeon" (not the second Received: field
-   that contains "via carrier-pigeon").
-
-
-5. Action replaceheader
-
-   Syntax:
-   	"replaceheader" 
-		[":index" <fieldno: number> [":last"]]
-		[":newname" <newname: string>]
-		[":newvalue" <newvalue: string>]
-		[COMPARATOR] [MATCH-TYPE] <field-name: string>
-		[<value-patterns: string-list>]
-
-   The replaceheader action replaces all or parts of a header
-   field, in some or all occurrences of that header field.
-
-   If :index <fieldno> is specified, the attempts to match 
-   a value are limited to the named header field <fieldno> (beginning
-   at 1, the first named header field).  If :last is specified,
-   the count is backwards; 1 denotes the last named header field,
-   2 the second to last, and so on.  As with "deleteheader",
-   the counting happens before the <value-patterns> match, if any.
-
-   The header field names in the field-name and in the ":newname"
-   argument, if specified, MUST be valid 7-bit header field names
-   as described by the RFC 2822 "field-name" nonterminal.
-
-   The field-name is mandatory and always matched as a
-   case-insensitive us-ascii string.  The value-patterns,
-   if specified, are matched according to the match type and
-   comparator.   (If no value-patterns are specified, they
-   always match.)
-
-   If :newname <newname> is specified, the action changes the
-   name of all matching header fields to <newname>.
-
-   If :newvalue <newvalue> is specified, the action changes the
-   value of all matching header fields to to <newvalue>.
-   If the [VARIABLES] extension is present and the MATCH-TYPE
-   is a type that interacts with the [VARIABLES] extension,
-   variable references to ${1}...${N} in the replacement string
-   following ":newvalue" are evaluated according to the matched
-   substring in the header field that is being replaced.
-
-   For example,
-
-   	replaceheader :newvalue "[ADV] ${1}" :matches "Subject" "*";
-
-   would insert an "[ADV]" tag before the value of the
-   "Subject" header field, changing
-   	
-	Subject: Make Money Fast!!
-  to 	Subject: [ADV] Make Money Fast!!
-
-   If neither :newname nor :newvalue are specified, the operation
-   still matches its argument and, in the presence of the
-   [VARIABLES] extension and a match type that interacts with it,
-   sets the ${1}...${N} variables to the last header matched.
-
-
-6. Interaction with Other Sieve Extensions
-
-   Tests and actions such as "exist" or "header" that examine
-   headers MUST examine the current state of a header as modified
-   by any actions that have taken place so far.
-
-   Actions that create messages in storage or in transport to
-   MTAs MUST store and send messages with the current set of
-   header fields.
-
-
-7. Security Considerations
-
-   Someone with write access to a user's script storage may use this
-   extension to generate headers that a user would otherwise be
-   shielded from (by a gateway MTA that removes them).
-
-   A sieve filter that removes headers may unwisely destroy
-   evidence about the path a header has taken.
-
-   Any change in a message content may interfere with digital
-   signature mechanisms that include the header in the signed
-   material.
-
-   Any decision mechanism in a user's filter that is based
-   on headers is vulnerable to header spoofing.  For example,
-   if the user adds an APPROVED header or tag, a malicious sender
-   may add that tag or header themselves.  One way to guard against
-   this is to delete or rename any such headers or stamps prior
-   to processing the message.
-
-
-8. Acknowledgments
-
-   Thanks to Eric Allman, Philip Guenther, Will Lee, Chris Markle,
-   Randall Schwartz, and Rand Wacker for extensive corrections
-   and suggestions.
-
-
-9. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-10. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-Appendices
-
-Appendix A.  References
-
-   [SIEVE]     Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-               January 2001.
-
-   [KEYWORDS]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", RFC 2119, March 1997.
-
-   [VARIABLES] Homme, K.T., "Sieve -- Variables Extension",
-               draft-homme-sieve-variables-01.txt, April 2003.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-editheader.txt
Index: kioslaves/sieve/draft-daboo-sieve-include.txt
===================================================================
--- kioslaves/sieve/draft-daboo-sieve-include.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-daboo-sieve-include.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,514 +1 @@
-Network Working Group                                          C. Daboo
-Internet Draft: SIEVE Include Extension
-Document: draft-daboo-sieve-include-01.txt                 October 2003
-
-                        SIEVE Include Extension
-    
-Status of this Memo
-    
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.
-    
-    Internet-Drafts are working documents of the Internet Engineering
-    Task Force (IETF), its areas, and its working groups.  Note that
-    other groups may also distribute working documents as
-    Internet-Drafts.
-    
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet-Drafts as
-    reference material or to cite them other than as "work in progress."
-    
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt.
-    
-    The list of Internet- Draft Shadow Directories can be accessed at
-    http://www.ietf.org/shadow.html.
-    
-    
-Copyright Notice
-    
-     Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 1]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    Abstract
-    
-    The SIEVE [SIEVE] "include" extension permits users to include one
-    SIEVE script inside another.  This can make managing large scripts
-    or multiple sets of scripts much easier, as well as supporting
-    common 'libraries' of scripts.  Users are able to include their own
-    personal scripts or site-wide scripts provided by the local SIEVE
-    implementation.
-    
-Change History (to be removed prior to publication as an RFC)
-    
-    Changes from -00 to -01:
-    1   Added IPR boiler plate.
-    2   Re-ordered sections at start to conform to RFC style.
-    3   Moved recursion comment into General Considerations section.
-    4   Switched to using optional parameter to indicate personal vs
-        global.
-    5   Explicitly state that an error occurs when a missing script is
-        included.
-        
-        
-                           Table of Contents
-     1  Introduction and Overview . . . . . . . . . . . . . . . . . .  2
-     2  Conventions Used in This Document  . . . . . . . . . . . . . . 2
-     3  SIEVE Include Extension . . . . . . . . . . . . . . . . . . .  3
-       3.1  General Considerations . . . . . . . . . . . . . . . . . . 3
-       3.2  Control Structure Include . . . . . . . . . . . . . . . .  3
-       3.3  Control Structure Return . . . . . . . . . . . . . . . . . 6
-     4  Security Considerations . . . . . . . . . . . . . . . . . . .  7
-     5  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 7
-       5.1  include registration  . . . . . . . . . . . . . . . . . .  7
-     6  Normative References . . . . . . . . . . . . . . . . . . . . . 7
-     7  Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .  7
-     8  Author's Address . . . . . . . . . . . . . . . . . . . . . . . 8
-     9  Intellectual Property Rights Statement  . . . . . . . . . . .  8
-    10  Full Copyright Statement . . . . . . . . . . . . . . . . . . . 8
-        
-1 Introduction and Overview
-    
-    Its convenient to be able to break SIEVE scripts down into smaller
-    components which can be reused in a variety of different
-    circumstances.  For example, users may want to have a default script
-    and a special 'vacation' script, the later being activated when the
-    user goes on vacation.  In that case the default actions should
-    continue to be run, but a vacation command should be executed first.
-    One option is to edit the default script to add or remove the
-    vacation command as needed.  Another is to have a vacation script
-    that simply has a vacation command and then includes the default
-    script.
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 2]
-Internet Draft           SIEVE Include Extension           October 2003
-
-2 Conventions Used in This Document
-    
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-    
-3 SIEVE Include Extension
-    
-3.1 General Considerations
-    
-    SIEVE implementations that implement the "include" and "return"
-    control structures described below have an identifier of "include"
-    for use with the capability mechanism.  If either of the "include"
-    or "return" control structures are used in a script, the "include"
-    capability MUST be listed in the "require" statement in that script.
-    
-    SIEVE implementations must track the use of actions in included
-    scripts so that implicit "keep" behaviour can be properly determined
-    based on whether any actions have executed in any script.
-    
-    SIEVE implementations are allowed to limit the total number of
-    nested included scripts, but MUST provide for a total of at least
-    three levels of nested scripts including the top-level script.  An
-    error MUST be generated either when the script is uploaded to the
-    SIEVE repository, or when the script is executed, if any nesting
-    limit is exceeded.  If such an error is detected whilst processing a
-    SIEVE script, an implicit "keep" action MUST be executed to prevent
-    loss of any messages.
-    
-    SIEVE implementations MUST ensure that recursive includes are not
-    possible. i.e. if script "A" includes script "B", and script "B"
-    includes script "A" an error MUST be generated either when the
-    script is uploaded to the SIEVE repository, or when the script is
-    executed.  If such an error is detected whilst processing a SIEVE
-    script, an implicit "keep" action MUST be executed to prevent loss
-    of any messages.
-    
-    SIEVE implementations MUST handle missing scripts being referenced
-    via an includes in an existing script.  An error MUST be generated
-    when a missing included script is descovered during execution.  If
-    such an error is detected an implicit "keep" action MUST be executed
-    to prevent loss of any messages.
-    
-3.2 Control Structure Include
-    
-        Syntax: include [LOCATION] <value: string>
-    
-    The "include" control structure includes an optional parameter, and
-    a single string argument representing the name of the script to
-    include in the main script at that point.
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 3]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    [LOCATION] is an optional parameter that has one of two values:
-    
-   Syntax:
-   	  ":personal"
-	/ ":global"
-
-   If the [LOCATION] parameter is not present, the location defaults to :personal.
-    
-    The location has the following meanings:
-    
-        :personal
-            Indicates that the named script is stored in the user's own
-            personal (private) SIEVE repository.
-            
-        :global
-            Indicates that the named script is stored in a site-wide
-            SIEVE repository, accessible to all users of the SIEVE
-            system.
-    
-    The included script MUST be a valid SIEVE script, including having
-    necessary "require" statements for all optional capabilities used by
-    the script.  The scope of a "require" statement in an included
-    script is for that script only, not the including script. e.g. if
-    script "A" includes script "B", and script "B" uses the "fileinto"
-    extension, script "B" must have a "require" statement for
-    "fileinto", irrespective of whether script "A" has one.  In
-    addition, if script "A" does not have a "require" statement for
-    "fileinto", "fileinto" cannot be used anywhere in script "A", even
-    after inclusion of script "B".
-    
-    A "stop" control statement in an included script MUST stop all
-    script processing, including the processing of the scripts that
-    include the current one.  The "return" control statement (described
-    below) stops processing of the current script only, and allows the
-    scripts that include it to continue.
-    
-    Examples:
-    
-    In the examples below, script content is indicated by a '|' as the
-    first non-space character on a line for clarity.  The '|' characters
-    are not part of the script itself.
-    
-    The user has four scripts stored in their personal repository:
-    
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 4]
-Internet Draft           SIEVE Include Extension           October 2003
-
-        "default"
-
-        This is the default active script that includes several others.
-            
-		|   require ["include"];
-	    |   
-		|   include :personal "always_allow";
-		|   include :global "spam_tests";
-		|   include :personal "my_spam_tests";
-		|   include :personal "mailing_lists";
-            
-        "always_allow"
-
-        This script special cases some correspondent email addresses and
-        makes sure any message containing those addresses are always
-        kept.
-            
-		|   if header :is "From" "boss@example.com"
-		|   {
-		|   	keep;
-		|   }
-		|   elsif header :is "From" "ceo@example.com"
-		|   {
-		|   	keep;
-		|   }
-            
-        "my_spam_tests"
-
-        This script does some user-specific spam tests to catch spam
-        messages not caught by the site-wide spam tests.
-            
-		|   require ["reject"];
-	    |   
-		|   if header :contains "Subject" "XXXX"
-		|   {
-		|   	reject;
-		|   }
-		|   elsif header :is "From" "money@example.com"
-		|   {
-		|   	reject;
-		|   }
-            
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 5]
-Internet Draft           SIEVE Include Extension           October 2003
-
-        "mailing_lists"
-
-        This script looks for messages from different mailing lists and
-        files each into a mailbox specific to the mailing list.
-            
-		|   require ["fileinto"];
-	    |   
-		|   if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-		|   {
-		|   	fileinto "lists.sieve";
-		|   }
-		|   elsif header :is "Sender" "owner-ietf-imapext@imc.org"
-		|   {
-		|   	fileinto "lists.imapext";
-		|   }
-            
-    There is one script stored in the global repository:
-    
-        "spam_tests"
-
-        This script does some site-wide spam tests which any user at the
-        site can include in their own scripts at a suitable point.  The
-        script content is kept up to date by the site administrator.
-            
-		|   require ["reject"];
-	    |   
-		|   if anyof (header :contains "Subject" "$$",
-		|   		  header :contains "Subject" "Make money")
-		|   {
-		|   	reject;
-		|   }
-            
-    The "include" control structure may appear anywhere in the script
-    where a control structure is legal.
-    
-    Example:
-    
-		|   require ["include"];
-	    |   
-		|   if anyof (header :contains "Subject" "$$",
-		|   		  header :contains "Subject" "Make money")
-		|   {
-		|       include "my_reject_script";
-		|   }
-    
-3.3 Control Structure Return
-    
-        Syntax: return
-    
-    The "return" control structure stops processing of the currently
-    included script only and returns processing control to the script
-    which includes it.  If used in the main script (i.e. not in an
-
-
-Daboo                    Expires April 2004                    [Page 6]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    included script), it has the same effect as the "stop" control
-    structure, including the appropriate "keep" action if no other
-    actions have been executed up to that point.
-    
-4 Security Considerations
-    
-    SIEVE implementations MUST ensure adequate security for the global
-    script repository to prevent unauthorized changes to global scripts.
-    
-    Beyond that, the "include" extension does not raise any security
-    considerations that are not present in the base [SIEVE] protocol,
-    and these issues are discussed in [SIEVE].
-    
-    
-5 IANA Considerations
-    
-    The following template specifies the IANA registration of the Sieve
-    extension specified in this document:
-    
-5.1 include registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: include
-    Capability keyword: include
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780,
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-    
-6 Normative References
-    
-    [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-    Requirement Levels", RFC 2119, March 1997.
-    
-    [SIEVE] Showalter, "Sieve:  A Mail Filtering Language", RFC 3028,
-    January 2001.
-    
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 7]
-Internet Draft           SIEVE Include Extension           October 2003
-
-7 Acknowledgments
-    
-    Thanks to Ken Murchison, Rob Siemborski, Alexey Melnikov, Marc Mutz
-    and Kjetil Torgrim Homme for comments and corrections.
-    
-    
-8 Author's Address
-    
-    Cyrus Daboo
-    Cyrusoft International, Inc.
-    5001 Baum Blvd., Suite 780,
-    Pittsburgh, PA 15213
-    U.S.A.
-
-    <mailto:daboo@cyrusoft.com>
-    
-9 Intellectual Property Rights Statement
-    
-    The IETF takes no position regarding the validity or scope of any
-    intellectual property or other rights that might be claimed to
-    pertain to the implementation or use of the technology described in
-    this document or the extent to which any license under such rights
-    might or might not be available; neither does it represent that it
-    has made any effort to identify any such rights.  Information on the
-    IETF's procedures with respect to rights in standards-track and
-    standards-related documentation can be found in BCP-11.  Copies of
-    claims of rights made available for publication and any assurances
-    of licenses to be made available, or the result of an attempt made
-    to obtain a general license or permission for the use of such
-    proprietary rights by implementors or users of this specification
-    can be obtained from the IETF Secretariat.
-    
-    
-10 Full Copyright Statement
-    
-    Copyright (C) The Internet Society 2003.  All Rights Reserved.
-    
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 8]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-    
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 9]
\ brakuje znaku końca linii na końcu pliku 
+http://ktown.kde.org/~dirk/sieve/draft-daboo-sieve-include.txt
Index: kioslaves/sieve/draft-homme-sieve-variables.txt
===================================================================
--- kioslaves/sieve/draft-homme-sieve-variables.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-homme-sieve-variables.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,594 +1 @@
-
-
-
-
-
-
-Network Working Group                                        K. T. Homme
-Document: draft-homme-sieve-variables-01.txt          University of Oslo
-Expires October 17, 2003                                     17 Apr 2003
-
-
-
-                      Sieve -- Variables Extension
-
-
-
-Status of this Memo
-
-
-   This document is an Internet-Draft and is subject to all provisions
-   of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as Internet-
-   Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six months
-   and may be updated, replaced, or obsoleted by other documents at any
-   time.  It is inappropriate to use Internet-Drafts as reference mate
-   rial or to cite them other than as "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/ietf/1id-abstracts.txt
-
-   To view the list Internet-Draft Shadow Directories, see
-   http://www.ietf.org/shadow.html.
-
-   Distribution of this memo is unlimited.
-
-
-Abstract
-
-   In advanced filtering rule sets, it is useful to keep state or con
-   figuration details across rules.  This extension adds an action to
-   store data in variables, an action to retrieve the current time,
-   changes the interpolation of strings, and supplies a new test so that
-   the value of a string can be examined.
-
-
-0.  Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-
-0.1.  Discussion
-
-   This draft is intended to be an extension to the Sieve mail filtering
-   language, available from the RFC repository as
-
-
-
-Homme                                                           [Page 1]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-   <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-   This draft and the Sieve language itself are being discussed on the
-   MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-   requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-   email message with the word "subscribe" in the body).  More informa
-   tion on the mailing list along with a WWW archive of back messages is
-   available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.  Noted Changes
-
-0.2.1.  Changes since -00
-
-a)   allow generic time zone names, without requiring implementations to
-     support it.  added a "${timezone}" variable so that the user can
-     check if the implementation does support the time zone name he
-     wants.  the default time zone was changed to localtime again.
-
-b)   allow back references from :matches as well as :regex.
-
-c)   added a section on implementation limits.
-
-d)   clarified global scope so that it spans include.
-
-e)   clarified that this draft only affects scripts which require "vari
-     ables".
-
-f)   changed modifiers into being tagged arguments for SET, added prece
-     dence table.
-
-g)   added optional COMPARATOR to SET to solve the internationalisation
-     problem with :lower etc.
-
-h)   the name of the variable being SET is passed in a string to conform
-     with overall Sieve grammar.  this string is explicitly disallowed
-     from containing variable references.
-
-
-0.3.  Open Issues
-
-a)   should we include more predefined variables to access the time?
-     (weekday, week number (US, EU and/or ISO?), name of month, name of
-     weekday, ...)  could use strftime(3c) as a list of what to offer,
-     but the names should be in English.
-
-b)   this extension is particularily useful if fileinto creates new
-     folders on demand.  [SIEVE] doesn't prohibit this, and currently
-     some implementations will create new folders automatically, others
-     won't.
-
-c)   the NOTIFY draft has variables, too.  it would be nice if the syn
-     tax for the two extensions agreed.  a changed NOTIFY can be used on
-     its own without the variables extension, the user simply won't be
-
-
-
-Homme                                                           [Page 2]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-     able to configure the notification message to include different
-     snippets from the message.
-
-
-1.  Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE].  It
-   adds support for storing and referencing data in string variables.
-   The mechanisms detailed in this document will only apply to Sieve
-   scripts which include a require clause for the "variables" extension.
-   The require clauses themselves are not affected by this extension.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-   The capability string associated with the extension defined in this
-   document is "variables".
-
-
-3.  Interpretation of strings
-
-   This extension changes the semantics of quoted-string, multi-line-
-   literal and multi-line-dotstuff found in [SIEVE] to enable the inclu
-   sion of the value of variables.  The syntax follows [ABNF].
-
-      variable-ref        =  "${" variable-name "}"
-      variable-name       =  num-variable / identifier
-      num-variable        =  1*DIGIT
-
-   When the string is evaluated, substrings matching variable-ref shall
-   be replaced by the value of variable-name.  Only one pass through the
-   string shall be done.  Variable names are case insensitive.  Unknown
-   variables are replaced by the empty string.  As per the grammar,
-   illegal variable names leaves the would-be variable-ref verbatim,
-   since it doesn't match the variable-ref syntax.
-
-   Examples:
-      "&%${}!"     => unchanged, as the empty string is an illegal
-                      identifier
-      "${doh!}"    => unchanged, as "!" is illegal in identifiers
-
-      The variable company holds the value "ACME".  No other variables
-      are set.
-
-         "${full}"    => the empty string
-         "${company}" => "ACME"
-         "${President, ${Company} Inc.}"
-                      => "${President, ACME Inc.}"
-
-   The expanded string MUST use the variable values which are current
-   when control reaches the statement the string is part of.
-
-
-
-Homme                                                           [Page 3]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-3.1.  Quoting
-
-   The semantics of quoting using backslash are not changed: backslash
-   quoting is resolved before doing variable substitution.
-
-   Examples:
-      "${fo\o}"  => ${foo}  => the expansion of variable foo.
-      "${fo\\o}" => ${fo\o} => illegal identifier => left verbatim.
-      "\${foo}"  => ${foo}  => the expansion of variable foo.
-      "\\${foo}" => \${foo} => a backslash character followed by the
-                               expansion of variable foo.
-
-   If it is required to include a character sequence such as "${beep}"
-   verbatim in a text literal, the user can define a variable to circum
-   vent expansion to the empty string.
-
-   Example:
-      set dollar "$"
-      set text "regarding ${dollar}{beep}"
-
-
-3.2.  Numeric variables
-
-   The decimal value of the numeric variable name will index the list of
-   matching strings from the most recently evaluated match of type
-   ":matches" or ":regex".  The list is empty if the match was unsuc
-   cessful.
-
-   For ":matches", the list will contain one string for each wildcard in
-   the match pattern.  Each string holds what the corresponding wildcard
-   expands to, possibly the empty string.  The wildcards expand greed
-   ily.
-
-   For ":regex", the list will contain the strings corresponding to the
-   group operators.  The groups are ordered by the position of the open
-   ing parenthesis, from left to right.
-
-   The first string in the list has index 1.  If the index is out of
-   range, the empty string will be substituted.  Index 0 returns the
-   number of strings in the list.
-
-   Example:
-      require [ "fileinto", "regex", "variables" ];
-
-      if header :regex "List-ID" "<(.*)@" {
-          fileinto "lists.${1}"; stop;
-      }
-
-      # this is equivalent to the above:
-      if header :matches "List-ID" "<*@" {
-          fileinto "lists.${1}"; stop;
-      }
-
-      if header :matches [ "To", "Cc" ] "coyote@**.com" {
-
-
-
-Homme                                                           [Page 4]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-          # ${0} is always "2", and ${2} is always the empty string.
-          fileinto "business.${1}"; stop;
-      } else {
-          # ${0} is always "0"
-          stop;
-      }
-
-
-4.  Action Commands
-
-   This extension defines two actions, "set" and "setdate", both of
-   which MUST be supported by an implementation of this extension.
-
-
-4.1.  Action set
-
-   Syntax:   set [MODIFIER] [COMPARATOR] <name: string> <value: string>
-
-   The "set" action stores the specified value in the variable called
-   name.  name MUST be a constant string without variable references.
-   The contents of name MUST conform to the syntax of identifier.  An
-   illegal name MUST cause a syntax error.
-
-   The default comparator is "i;ascii-casemap".
-
-   All variables have global scope: they are visible until processing
-   stops.  Variable names are case insensitive.
-
-   Example:
-      set "honorific"  "Mr";
-      set "first_name" "Wile";
-      set "last_name"  "Coyote";
-      set "vacation" text:
-      Dear ${HONORIFIC} ${last_name},
-      I'm out, please leave a message after the meep.
-      .
-      ;
-
-   "set" does not affect the implicit keep.
-
-
-4.1.1.  Modifiers
-
-   Modifiers are applied on value before it is stored in the variable.
-   Modifier names are case insensitive.  Unknown modifiers MUST yield a
-   syntax error.  More than one modifier can be specified, in which case
-   they are applied according to this precedence list, highest value
-   first:
-
-
-
-
-
-
-
-
-
-Homme                                                           [Page 5]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-                        Precedence     Modifier
-                       -----------------------------
-                            1          :length
-                       -----------------------------
-                            2          :lowerfirst
-                                       :upperfirst
-                       -----------------------------
-                            3          :lower
-                                       :upper
-
-
-   If two or more modifiers of the same precedence are used, they can be
-   applied in any order.
-
-   Examples:
-      set "var" "juMBlEd lETteRS"           => "juMBlEd lETteRS"
-      set :length "var" "${var}"            => "15"
-      set :lower "var" "${var}"             => "jumbled letters"
-      set :upperfirst "var" "${var}"        => "JuMBlEd lETteRS"
-      set :upperfirst :lower "var" "{$var}" => "Jumbled letters"
-
-
-4.1.1.1.  Modifier ":length"
-
-   The value is the decimal number of letters in the expansion, con
-   verted to a string.
-
-
-4.1.1.2.  Case modifiers
-
-   These modifiers change the letters of the text from upper to lower
-   case or vice versa.  The implementation MUST support US-ASCII, but is
-   not required to handle the entire Unicode repertoire.  The comparator
-   specified SHOULD be consulted to establish which locale to use.
-
-
-4.1.1.2.1.  Modifier ":upper"
-
-   All lower case letters are converted to their upper case counterpart.
-
-
-4.1.1.2.2.  Modifier ":lower"
-
-   All upper case letters are converted to their lower case counterpart.
-
-
-4.1.1.2.3.  Modifier ":upperfirst"
-
-   The first character of the string is converted to upper case if it is
-   a letter and set in lower case.  The rest of the string is left
-   unchanged.
-
-
-
-
-
-
-Homme                                                           [Page 6]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-4.1.1.2.4.  Modifier ":lowerfirst"
-
-   The first character of the string is converted to lower case if it is
-   a letter and set in upper case.  The rest of the string is left
-   unchanged.
-
-
-4.2.  Action setdate
-
-   Syntax: setdate [ <time-zone: string> ]
-
-   The value of time-zone SHOULD be a well-known name, or an offset rel
-   ative to UTC.  All implementations MUST support the time-offset syn
-   tax
-
-           time-offset  =  ( "+" / "-" ) 4DIGIT
-
-   time-offset should be interpreted the same way as "zone" in [IMAIL].
-
-
-     Note: There is currently no registry for time zones.  If IETF
-     establishes one, its names SHOULD be used.  In the absence of
-     such a registry, [TZ] is the most widespread collection of
-     time zone definitions and its use as a reference is RECOM
-     MENDED.
-
-   If the time-zone is left out or not recognised, the local time zone
-   SHOULD be used.
-
-   The action setdate initialises a few variables:
-
-      ${year}     => the current year, "0000" .. "9999"
-      ${month}    => the current month, "01" .. "12"
-      ${day}      => the current day, "01" .. "31"
-      ${hour}     => the current hour, "00" .. "23"
-      ${minute}   => the current hour, "00" .. "59"
-      ${second}   => the current second, "00" .. "59"
-      ${timezone} => the time zone in use.  If the user specified a
-                     time zone which was recognised, ${timezone} will
-                     contain the name given.  Otherwise, the value
-                     MUST be the server's default time zone in offset
-                     format.
-
-   These variables SHOULD reference the time when execution of the Sieve
-   script reaches the statement.  All calls to setdate MUST refer to the
-   same point in time.
-
-   "setdate" does not affect the implicit keep.
-
-
-5.  Test string
-
-   Syntax: string [MATCH-TYPE] [COMPARATOR]
-           <source: string-list> <key-list: string-list>
-
-
-
-Homme                                                           [Page 7]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-   The "string" test evaluates to true if any of the strings matches any
-   key.  The type of match defaults to ":is".
-
-
-6.  Implementation Limits
-
-   An implementation of this draft MUST support at least 128 distinct
-   variables.  The supported length of variable names MUST be at least
-   32 characters.  Each variable MUST be able to hold at least 4000
-   characters.  Attempts to set the variable to a value larger than what
-   the implementation supports MUST be treated as an error.
-
-   Numeric variables ${1} through ${9} MUST be supported.  Referencing
-   higher indices than is supported is a syntax error which MUST be dis
-   covered at compile-time.  If the string matching a wildcard or a
-   regex group operator exceeds the maximum variable size, the implemen
-   tation SHOULD truncate it and MUST NOT treat it as an error.
-
-
-7.  Security Considerations
-
-   When combined with the regex extension, strings can contain arbitrary
-   values controlled by the sender of the e-mail if the author of the
-   script isn't careful.
-
-   The introduction of variables makes advanced decision making easier
-   to write, but since no looping construct is provided, all Sieve
-   scripts will terminate orderly.
-
-
-8.  Acknowledgments
-
-   Thanks to Jutta Degener, Ned Freed, Lawrence Greenfield, Peder Stray
-   and Nigel Swinson for valuable feedback.
-
-
-9.  Author's Address
-
-   Kjetil T. Homme
-   Frydens g 5B
-   0564 Oslo, Norway
-
-   Phone: +47 9366 0091
-   E-mail: kjetilho@ifi.uio.no
-
-
-Appendix A.  References
-
-
-     [ABNF]     D. Crocker, Ed., "Augmented BNF for Syntax Specifica
-                tions: ABNF", Internet Mail Consortium, RFC 2234, Novem
-                ber 1997
-
-
-
-
-
-Homme                                                           [Page 8]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-     [IMAIL]    P. Resnick, Ed., "Internet Message Format", QUALCOMM
-                Incorporated, April 2001.
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-                Requirement Levels", Harvard University, RFC 2119, March
-                1997.
-
-     [SIEVE]    Showalter, T., "Sieve: A Mail Filtering Language", Mira
-                point, RFC 3028, January 2001.
-
-     [TZ]       Olson, A.D., et al, Time zone code and data,
-                ftp://elsie.nci.nih.gov/pub/, updated periodically.
-
-
-
-Appendix B.  Full Copyright Statement
-
-   Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this doc
-   ument itself may not be modified in any way, such as by removing the
-   copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of develop
-   ing Internet standards in which case the procedures for copyrights
-   defined in the Internet Standards process must be followed, or as
-   required to translate it into languages other than English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF MER
-   CHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Homme                                                           [Page 9]
-
-
+http://ktown.kde.org/~dirk/sieve/draft-homme-sieve-variables.txt
Index: kioslaves/sieve/draft-martin-sieve-notify-01.txt
===================================================================
--- kioslaves/sieve/draft-martin-sieve-notify-01.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-martin-sieve-notify-01.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,457 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                         Tim Martin
-Document: draft-martin-sieve-notify-01.txt            Wolfgang Segmuller
-Expires December 6, 2001                                     1 June 2001
-
-
-         Sieve -- An extension for providing instant notifications
-
-                      <draft-ietf-sieve-notify-01.txt>
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are
-    working documents of the Internet Engineering Task Force (IETF), its
-    areas, and its working groups.  Note that other groups may also
-    distribute working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet- Drafts as
-    reference material or to cite them other than as "work in progress."
-
-   
-     The list of current Internet-Drafts can be accessed at
-     http://www.ietf.org/1id-abstracts.html
-
-     The list of Internet-Draft Shadow Directories can be accessed at
-     http://www.ietf.org/shadow.html.
-
-
-    Distribution of this memo is unlimited.
-
-
-Abstract
-
-    Users go to great lengths to be notified as quickly as possible that
-    they have received new mail. Most of these methods involve polling
-    to check for new messages periodically. A push method handled by the
-    final delivery agent gives users quicker notifications and saves
-    server resources. This document does not specify the notification
-    method but is expected that using existing instant messaging
-    infrastructure such as Zephyr, ICQ, or SMS messages will be popular.
-    This draft describes an extension to the Sieve mail filtering
-    language that allows users to give specific preferences for
-    notification of Sieve actions.
-
-
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 1]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-                           TTaabbllee ooff CCoonntteennttss
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.1.   Conventions Used in This Document . . . . . . . . . . . . . .   3
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   3
-
-3.     Actions . . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-3.1.   Notify action . . . . . . . . . . . . . . . . . . . . . . . .   3
-3.2.   Denotify Action . . . . . . . . . . . . . . . . . . . . . . .   5
-
-4.     Interaction with Other Sieve Actions  . . . . . . . . . . . .   6
-
-5.     Security Considerations . . . . . . . . . . . . . . . . . . .   7
-
-6.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   7
-
-7.     Copyright . . . . . . . . . . . . . . . . . . . . . . . . . .   7
-
-8.     References  . . . . . . . . . . . . . . . . . . . . . . . . .   8
-
-9.     Author's Addresses  . . . . . . . . . . . . . . . . . . . . .   8
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 2]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-1.  Introduction
-
-    This is an extension to the Sieve language defined by [SIEVE] for
-    providing instant notifications of sieve actions that have been
-    preformed. It defines the new action "notify".
-
-    This document does not dictate the notification method used.
-    Examples of possible notification methods are Zephyr and ICQ. The
-    method shall be site-defined.
-
-    Sieve interpreters for which notifications are impractical or is not
-    possible SHOULD ignore this extension.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-1.1.  Conventions Used in This Document
-    The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-    "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
-    document are to be interpreted as described in [KEYWORDS].
-
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "notify".
-
-
-
-3.  Actions
-
-
-
-
-3.1.  Notify action
-
-    Syntax:   notify [":method" string]
-               [":id" string]
-               [":options" 1*(string-list / number)]
-               [<":low" / ":normal" / ":high">]
-               ["message:" string]
-
-    The Notify action specifies that a notification should be sent to
-    the user upon successful handling of this message.
-
-    The format of the notification is implementation-defined. However,
-
-
-
-Expires December 6, 2001        Martin                          [Page 3]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    all content specified in the notify action, including Sieve actions
-    taken on the message, SHOULD be included. If errors occurred in
-    another action they SHOULD be reported in the notification. In
-    addition, if the notification method does not provide a timestamp,
-    one SHOULD be appended to the notification. Implementations SHOULD
-    NOT include extraneous information.
-
-    The :method tag identifies the notification method that will be
-    used. If the :method tag is not specified, the default
-    implementation defined notification method MUST be used.  The
-    possible values of this will be site-specific.  If a method is
-    specified that the implementation does not support, the notification
-    MUST be ignored. An implementation treats this as a warning
-    condition and execution of the sieve script MUST continue.
-
-    The :id tag can be used to give the notify action an unique
-    identifier. This identifier can be used later in the script to
-    cancel the specific notify. The string may have any value and SHOULD
-    NOT be included in the notification.
-
-    The :options tag is used to send parameters to the notification
-    method. This might be the phone number for an SMS message or a
-    user's ICQ identifier.
-
-    The priority parameter specifies the importance of the notification.
-    The priority parameter has the following values: ":high" (very
-    important), ":normal", and ":low" (not very important). If no
-    priority is given, a default priority of ":normal" SHOULD be
-    assumed. Some notification methods allow users to specify their
-    state of activity (for example "busy" or "away from keyboard"). If
-    the notification method provides this information it SHOULD be used
-    to selectively send notifications.  If, for example, the user marks
-    herself as "busy", an implementation SHOULD NOT send a notification
-    for a new mailing list message with a priority of :low, however the
-    user should be notified of a high priority action.  If the
-    notification method allows users to filter messages based upon
-    certain parameters in the message, users should be able to filter
-    based upon priority. If the notification method does not support
-    priority, then this parameter MUST be ignored.
-
-    The :message tag specifies the message data to be included in the
-    notification. The entirety of the string SHOULD be sent but
-    implementations MAY shorten the message for technical or aesthetic
-    reasons. Message may include the message variables defined below. If
-    the message parameter is absent, a default message of "$from$:
-    $subject$" will be used.
-
-         $from$     - the display name or address of the RFC 822 from
-
-
-
-Expires December 6, 2001        Martin                          [Page 4]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-         $env-from$ - the address of the RFC 821 from
-
-         $subject$  - the subject of the message
-
-         $text$     - the first text/* part
-
-         $text[n]$  - the first n bytes of the first text/* part
-
-    If there are errors sending the notification, the Sieve interpreter
-    SHOULD ignore the notification and not retry indefinitely.
-
-    This action MUST NOT cancel the implicit keep.
-
-    Example:
-         require ["notify","fileinto"];
-
-            if header :contains "from" "boss@example.org" {
-                notify :high "This is probably very important";
-            }
-
-            if header :contains "to" "sievemailinglist@example.org" {
-                notify :low "[SIEVE] $from$: $subject$";
-                fileinto "INBOX.sieve";
-            }
-
-
-
-
-3.2.  Denotify Action
-
-    Syntax: denotify [MATCH-TYPE string] [<":low" / ":normal" /
-    ":high">]
-
-    The denotify action can be used to cancel a previous notification.
-    If the priority, ":low" / ":normal" / ":high", is specified, then
-    only cancel those notifications with the specified priority.  If a
-    MATCH-TYPE with a string is specified, then only those notifications
-    whose :id tag matches the specified string using the match-type
-    operator are canceled.  The ascii-casemap comparator MUST be used.
-
-    If no notifications exist that match the search criteria, then the
-    denotify has no effect.  A denotify only cancels notifications that
-    have already been requested.  It is not possible to preemptively
-    cancel a notification.
-
-    The sequence:
-
-      denotify;
-
-
-
-Expires December 6, 2001        Martin                          [Page 5]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-      notify;
-
-    will still generate a notification.  The denotify does not cancel
-    the notify.
-
-    The following table shows which notifies would get cancelled:
-
-                                        # what is cancelled
-      denotify                          # all notifications
-      denotify :matches "*"             # all notifications with :id tag
-      denotify :high                    # all high priority notifications
-      denotify :is "foobar"             # all notifications with id "foobar"
-      denotify :matches "foo*" :normal  # all normal priority notifications
-                                        #   with id that starts with "foo"
-
-    Example:
-             require "notify";
-
-             notify :method "sms" :options "408-555-1212" :id "foobar";
-             if header :contains "from" "boss@example.org" {
-                notify :method "sms" :options "408-555-1212" :id "foobar" :high
-                       :message "BOSS: $subject$";
-             }
-
-             if header :contains "to" "sievemailinglist@example.org" {
-                denotify :is "foobar";
-             }
-
-             if header :contains "subject" "FYI:" {
-                # don't need high priority notification for
-                # a 'for your information'
-                denotify :is "foobar" :high;
-             }
-
-
-
-
-4.  Interaction with Other Sieve Actions
-
-    Notifications MUST be sent in all cases, unless a reject action is
-    also executed. Users may wish to be notified of a message being
-    discarded, for example. The reject action is given an exception
-    because implementations may wish to restrict users from seeing the
-    contents of a rejected message. However, notifications MAY be
-    modified to not include any data from the original rejected message.
-
-    The notify action MUST NOT cancel the implicit keep.
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 6]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    The denotify action MUST NOT affect any actions other than the
-    notify action.
-
-    Failures of other actions MAY be reported in the notification.
-
-
-
-
-
-5.  Security Considerations
-
-    Security considerations are discussed in [SIEVE]. Additionally
-    implementations must be careful to follow the security
-    considerations of the specific notification methods. It is believed
-    that this extension does not introduce any additional security
-    concerns.
-
-    The notify action is potentially very dangerous.  The path the
-    notification takes through the network may not be secure.  An error
-    in the options string may cause the message to be transmitted to
-    someone it was not intended for.
-
-    Just because a notification is received doesn't mean it was sent by
-    the sieve implementation.  It might be possible to forge
-    notifications with some notification methods.
-
-
-6.  Acknowledgments
-
-    Thanks to Larry Greenfield, Sarah Robeson, Tim Showalter, and Barry
-    Leiba for help with this document.
-
-
-
-7.  Copyright
-
-    Copyright (C) The Internet Society 1999. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-
-
-
-Expires December 6, 2001        Martin                          [Page 7]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-8.  References
-
-    [ABNF] Crocker, Overell, "Augmented BNF for Syntax Specifications:
-    ABNF", RFC 2234, Internet Mail Consortium, Demon Internet Ltd,
-    November 1997.
-
-    [SIEVE]; Showalter, T.; "Sieve: A Mail Filtering Language"; RFC
-    3028; Mirapoint, Inc.; January 2001
-
-
-9.  Author's Addresses
-
-    Tim Martin
-    Mirapoint Inc.
-    909 Hermosa Court
-    Sunnyvale, CA 94085
-
-    Phone: (408) 720-3835
-    EMail: tmartin@mirapoint.com
-
-    Wolfgang Segmuller
-    IBM T.J. Watson Research Center
-    30 Saw Mill River Rd
-    Hawthorne, NY  10532
-
-    Phone: (914) 784-7408
-    Email: whs@watson.ibm.com
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/draft-martin-sieve-notify-01.txt
Index: kioslaves/sieve/rfc3431.txt
===================================================================
--- kioslaves/sieve/rfc3431.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/rfc3431.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,451 +1 @@
-
-
-
-
-
-
-Network Working Group                                       W. Segmuller
-Request for Comment: 3431                IBM T.J. Watson Research Center
-Category: Standards Track                                  December 2002
-
-
-                   Sieve Extension: Relational Tests
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2002).  All Rights Reserved.
-
-Abstract
-
-   This document describes the RELATIONAL extension to the Sieve mail
-   filtering language defined in RFC 3028.  This extension extends
-   existing conditional tests in Sieve to allow relational operators.
-   In addition to testing their content, it also allows for testing of
-   the number of entities in header and envelope fields.
-
-1 Introduction
-
-   Sieve [SIEVE] is a language for filtering e-mail messages at the time
-   of final delivery.  It is designed to be implementable on either a
-   mail client or mail server.  It is meant to be extensible, simple,
-   and independent of access protocol, mail architecture, and operating
-   system.  It is suitable for running on a mail server where users may
-   not be allowed to execute arbitrary programs, such as on black box
-   Internet Messages Access Protocol (IMAP) servers, as it has no
-   variables, loops, nor the ability to shell out to external programs.
-
-   The RELATIONAL extension provides relational operators on the
-   address, envelope, and header tests.  This extension also provides a
-   way of counting the entities in a message header or address field.
-
-   With this extension, the sieve script may now determine if a field is
-   greater than or less than a value instead of just equivalent.  One
-   use is for the x-priority field: move messages with a priority
-   greater than 3 to the "work on later" folder.  Mail could also be
-   sorted by the from address.  Those userids that start with 'a'-'m' go
-   to one folder, and the rest go to another folder.
-
-
-
-Segmuller                   Standards Track                     [Page 1]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-   The sieve script can also determine the number of fields in the
-   header, or the number of addresses in a recipient field.  For
-   example:  are there more than 5 addresses in the to and cc fields.
-
-2 Conventions used in this document
-
-   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-   "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this
-   document are to be interpreted as described in BCP 14, RFC 2119.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   the use of [KEYWORDS] and "Syntax:" label for the definition of
-   action and tagged arguments syntax, and the use of [ABNF].
-
-   The capability string associated with extension defined in this
-   document is "relational".
-
-3 Comparators
-
-   This document does not define any comparators or exempt any
-   comparators from the require clause.  Any comparator used, other than
-   "i;octet" and "i;ascii-casemap", MUST be declared a require clause as
-   defined in [SIEVE].
-
-   The "i;ascii-numeric" comparator, as defined in [ACAP], MUST be
-   supported for any implementation of this extension.  The comparator
-   "i;ascii-numeric" MUST support at least 32 bit unsigned integers.
-
-   Larger integers MAY be supported.  Note: the "i;ascii-numeric"
-   comparator does not support negative numbers.
-
-4 Match Type
-
-   This document defines two new match types.  They are the VALUE match
-   type and the COUNT match type.
-
-     The syntax is:
-
-        MATCH-TYPE =/ COUNT / VALUE
-
-        COUNT = ":count" relational-match
-
-        VALUE = ":value" relational-match
-
-        relational-match = DQUOTE ( "gt" / "ge" / "lt"
-                                    / "le" / "eq" / "ne" ) DQUOTE
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 2]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-4.1  Match Type Value
-
-   The VALUE match type does a relational comparison between strings.
-
-   The VALUE match type may be used with any comparator which returns
-   sort information.
-
-   Leading and trailing white space MUST be removed from the value of
-   the message for the comparison.  White space is defined as
-
-                             SP / HTAB / CRLF
-
-   A value from the message is considered the left side of the relation.
-   A value from the test expression, the key-list for address, envelope,
-   and header tests, is the right side of the relation.
-
-   If there are multiple values on either side or both sides, the test
-   is considered true, if any pair is true.
-
-4.2  Match Type Count
-
-   The COUNT match type first determines the number of the specified
-   entities in the message and does a relational comparison of the
-   number of entities to the values specified in the test expression.
-
-   The COUNT match type SHOULD only be used with numeric comparators.
-
-   The Address Test counts the number of recipients in the specified
-   fields.  Group names are ignored.
-
-   The Envelope Test counts the number of recipients in the specified
-   envelope parts.  The envelope "to" will always have only one entry,
-   which is the address of the user for whom the sieve script is
-   running.  There is no way a sieve script can determine if the message
-   was actually sent to someone else using this test.  The envelope
-   "from" will be 0 if the MAIL FROM is blank, or 1 if MAIL FROM is not
-   blank.
-
-   The Header Test counts the total number of instances of the specified
-   fields.  This does not count individual addresses in the "to", "cc",
-   and other recipient fields.
-
-   In all cases, if more than one field name is specified, the counts
-   for all specified fields are added together to obtain the number for
-   comparison.  Thus, specifying ["to", "cc"] in an address COUNT test,
-   comparing the total number of "to" and "cc" addresses; if separate
-   counts are desired, they must be done in two comparisons, perhaps
-   joined by "allof" or "anyof".
-
-
-
-Segmuller                   Standards Track                     [Page 3]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-5 Security Considerations
-
-   Security considerations are discussed in [SIEVE].
-
-   An implementation MUST ensure that the test for envelope "to" only
-   reflects the delivery to the current user.  It MUST not be possible
-   for a user to determine if this message was delivered to someone else
-   using this test.
-
-6 Example
-
-   Using the message:
-
-      received: ...
-      received: ...
-      subject: example
-      to: foo@example.com.invalid, baz@example.com.invalid
-      cc: qux@example.com.invalid
-
-   The test:
-
-        address :count "ge" :comparator "i;ascii-numeric" ["to", "cc"]
-      ["3"]
-
-      would be true and the test
-
-         anyof ( address :count "ge" :comparator "i;ascii-numeric"
-                         ["to"] ["3"],
-                 address :count "ge" :comparator "i;ascii-numeric"
-                         ["cc"] ["3"] )
-
-      would be false.
-
-      To check the number of received fields in the header, the
-      following test may be used:
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                        ["received"] ["3"]
-
-      This would return false.  But
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                          ["received", "subject"] ["3"]
-
-      would return true.
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 4]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-   The test:
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                       ["to", "cc"] ["3"]
-
-   will always return false on an RFC 2822 compliant message [RFC2822],
-   since a message can have at most one "to" field and at most one "cc"
-   field.  This test counts the number of fields, not the number of
-   addresses.
-
-7 Extended Example
-
-   require ["relational", "comparator-i;ascii-numeric"];
-
-   if header :value "lt" :comparator "i;ascii-numeric"
-             ["x-priority"] ["3"]
-   {
-      fileinto "Priority";
-   }
-
-   elseif address :count "gt" :comparator "i;ascii-numeric"
-              ["to"] ["5"]
-   {
-      # everything with more than 5 recipients in the "to" field
-      # is considered SPAM
-      fileinto "SPAM";
-   }
-
-   elseif address :value "gt" :all :comparator "i;ascii-casemap"
-              ["from"] ["M"]
-   {
-      fileinto "From N-Z";
-   } else {
-      fileinto "From A-M";
-   }
-
-   if allof ( address :count "eq" :comparator "i;ascii-numeric"
-                      ["to", "cc"] ["1"] ,
-              address :all :comparator "i;ascii-casemap"
-                      ["to", "cc"] ["me@foo.example.com.invalid"]
-   {
-      fileinto "Only me";
-   }
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 5]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-8 IANA Considerations
-
-   The following template specifies the IANA registration of the Sieve
-   extension specified in this document:
-
-   To: iana@iana.org
-   Subject: Registration of new Sieve extension
-
-   Capability name: RELATIONAL
-   Capability keyword: relational
-   Capability arguments: N/A
-   Standards Track/IESG-approved experimental RFC number: this RFC
-   Person and email address to contact for further information:
-    Wolfgang Segmuller
-    IBM T.J. Watson Research Center
-    30 Saw Mill River Rd
-    Hawthorne, NY 10532
-
-    Email: whs@watson.ibm.com
-
-   This information should be added to the list of sieve extensions
-   given on http://www.iana.org/assignments/sieve-extensions.
-
-9 References
-
-9.1 Normative References
-
-   [SIEVE]     Showalter, T., "Sieve: A Mail Filtering Language", RFC
-               3028, January 2001.
-
-   [Keywords]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", BCP 14, RFC 2119, March 1997.
-
-   [ABNF]      Crocker, D., "Augmented BNF for Syntax Specifications:
-               ABNF", RFC 2234, November 1997.
-
-   [RFC2822]   Resnick, P., "Internet Message Format", RFC 2822, April
-               2001.
-
-9.2 Non-Normative References
-
-   [ACAP]      Newman, C. and J. G. Myers, "ACAP -- Application
-               Configuration Access Protocol", RFC 2244, November 1997.
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 6]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-10 Author's Address
-
-   Wolfgang Segmuller
-   IBM T.J. Watson Research Center
-   30 Saw Mill River Rd
-   Hawthorne, NY  10532
-
-   EMail: whs@watson.ibm.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 7]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-11 Full Copyright Statement
-
-   Copyright (C) The Internet Society (2002).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/rfc3431.txt
Index: kioslaves/sieve/rfc3028.txt
===================================================================
--- kioslaves/sieve/rfc3028.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/rfc3028.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,2019 +1 @@
-
-
-
-
-
-
-Network Working Group                                       T. Showalter
-Request for Comments: 3028                               Mirapoint, Inc.
-Category: Standards Track                                   January 2001
-
-
-                    Sieve: A Mail Filtering Language
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2001).  All Rights Reserved.
-
-Abstract
-
-   This document describes a language for filtering e-mail messages at
-   time of final delivery.  It is designed to be implementable on either
-   a mail client or mail server.  It is meant to be extensible, simple,
-   and independent of access protocol, mail architecture, and operating
-   system.  It is suitable for running on a mail server where users may
-   not be allowed to execute arbitrary programs, such as on black box
-   Internet Message Access Protocol (IMAP) servers, as it has no
-   variables, loops, or ability to shell out to external programs.
-
-Table of Contents
-
-   1.      Introduction ...........................................   3
-   1.1.     Conventions Used in This Document .....................   4
-   1.2.     Example mail messages .................................   4
-   2.      Design .................................................   5
-   2.1.     Form of the Language ..................................   5
-   2.2.     Whitespace ............................................   5
-   2.3.     Comments ..............................................   6
-   2.4.     Literal Data ..........................................   6
-   2.4.1.   Numbers ...............................................   6
-   2.4.2.   Strings ...............................................   7
-   2.4.2.1. String Lists ..........................................   7
-   2.4.2.2. Headers ...............................................   8
-   2.4.2.3. Addresses .............................................   8
-   2.4.2.4. MIME Parts ............................................   9
-   2.5.     Tests .................................................   9
-   2.5.1.   Test Lists ............................................   9
-
-
-
-Showalter                   Standards Track                     [Page 1]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   2.6.     Arguments .............................................   9
-   2.6.1.   Positional Arguments ..................................   9
-   2.6.2.   Tagged Arguments ......................................  10
-   2.6.3.   Optional Arguments ....................................  10
-   2.6.4.   Types of Arguments ....................................  10
-   2.7.     String Comparison .....................................  11
-   2.7.1.   Match Type ............................................  11
-   2.7.2.   Comparisons Across Character Sets .....................  12
-   2.7.3.   Comparators ...........................................  12
-   2.7.4.   Comparisons Against Addresses .........................  13
-   2.8.     Blocks ................................................  14
-   2.9.     Commands ..............................................  14
-   2.10.    Evaluation ............................................  15
-   2.10.1.  Action Interaction ....................................  15
-   2.10.2.  Implicit Keep .........................................  15
-   2.10.3.  Message Uniqueness in a Mailbox .......................  15
-   2.10.4.  Limits on Numbers of Actions ..........................  16
-   2.10.5.  Extensions and Optional Features ......................  16
-   2.10.6.  Errors ................................................  17
-   2.10.7.  Limits on Execution ...................................  17
-   3.      Control Commands .......................................  17
-   3.1.     Control Structure If ..................................  18
-   3.2.     Control Structure Require .............................  19
-   3.3.     Control Structure Stop ................................  19
-   4.      Action Commands ........................................  19
-   4.1.     Action reject .........................................  20
-   4.2.     Action fileinto .......................................  20
-   4.3.     Action redirect .......................................  21
-   4.4.     Action keep ...........................................  21
-   4.5.     Action discard ........................................  22
-   5.      Test Commands ..........................................  22
-   5.1.     Test address ..........................................  23
-   5.2.     Test allof ............................................  23
-   5.3.     Test anyof ............................................  24
-   5.4.     Test envelope .........................................  24
-   5.5.     Test exists ...........................................  25
-   5.6.     Test false ............................................  25
-   5.7.     Test header ...........................................  25
-   5.8.     Test not ..............................................  26
-   5.9.     Test size .............................................  26
-   5.10.    Test true .............................................  26
-   6.      Extensibility ..........................................  26
-   6.1.     Capability String .....................................  27
-   6.2.     IANA Considerations ...................................  28
-   6.2.1.   Template for Capability Registrations .................  28
-   6.2.2.   Initial Capability Registrations ......................  28
-   6.3.     Capability Transport ..................................  29
-   7.      Transmission ...........................................  29
-
-
-
-Showalter                   Standards Track                     [Page 2]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   8.      Parsing ................................................  30
-   8.1.     Lexical Tokens ........................................  30
-   8.2.     Grammar ...............................................  31
-   9.      Extended Example .......................................  32
-   10.     Security Considerations ................................  34
-   11.     Acknowledgments ........................................  34
-   12.     Author's Address .......................................  34
-   13.     References .............................................  34
-   14.     Full Copyright Statement ...............................  36
-
-1.      Introduction
-
-   This memo documents a language that can be used to create filters for
-   electronic mail.  It is not tied to any particular operating system or
-   mail architecture.  It requires the use of [IMAIL]-compliant
-   messages, but should otherwise generalize to many systems.
-
-   The language is powerful enough to be useful but limited in order to
-   allow for a safe server-side filtering system.  The intention is to
-   make it impossible for users to do anything more complex (and
-   dangerous) than write simple mail filters, along with facilitating
-   the use of GUIs for filter creation and manipulation.  The language is
-   not Turing-complete: it provides no way to write a loop or a function
-   and variables are not provided.
-
-   Scripts written in Sieve are executed during final delivery, when the
-   message is moved to the user-accessible mailbox.  In systems where
-   the MTA does final delivery, such as traditional Unix mail, it is
-   reasonable to sort when the MTA deposits mail into the user's
-   mailbox.
-
-   There are a number of reasons to use a filtering system.  Mail
-   traffic for most users has been increasing due to increased usage of
-   e-mail, the emergence of unsolicited email as a form of advertising,
-   and increased usage of mailing lists.
-
-   Experience at Carnegie Mellon has shown that if a filtering system is
-   made available to users, many will make use of it in order to file
-   messages from specific users or mailing lists.  However, many others
-   did not make use of the Andrew system's FLAMES filtering language
-   [FLAMES] due to difficulty in setting it up.
-
-   Because of the expectation that users will make use of filtering if
-   it is offered and easy to use, this language has been made simple
-   enough to allow many users to make use of it, but rich enough that it
-   can be used productively.  However, it is expected that GUI-based
-   editors will be the preferred way of editing filters for a large
-   number of users.
-
-
-
-Showalter                   Standards Track                     [Page 3]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-1.1.     Conventions Used in This Document
-
-   In the sections of this document that discuss the requirements of
-   various keywords and operators, the following conventions have been
-   adopted.
-
-   The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and
-   "MAY" in this document are to be interpreted as defined in
-   [KEYWORDS].
-
-   Each section on a command (test, action, or control structure) has a
-   line labeled "Syntax:".  This line describes the syntax of the
-   command, including its name and its arguments.  Required arguments
-   are listed inside angle brackets ("<" and ">").  Optional arguments
-   are listed inside square brackets ("[" and "]").  Each argument is
-   followed by its type, so "<key: string>" represents an argument
-   called "key" that is a string.  Literal strings are represented with
-   double-quoted strings.  Alternatives are separated with slashes, and
-   parenthesis are used for grouping, similar to [ABNF].
-
-   In the "Syntax" line, there are three special pieces of syntax that
-   are frequently repeated, MATCH-TYPE, COMPARATOR, and ADDRESS-PART.
-   These are discussed in sections 2.7.1, 2.7.3, and 2.7.4,
-   respectively.
-
-   The formal grammar for these commands in section 10 and is the
-   authoritative reference on how to construct commands, but the formal
-   grammar does not specify the order, semantics, number or types of
-   arguments to commands, nor the legal command names.  The intent is to
-   allow for extension without changing the grammar.
-
-1.2.     Example mail messages
-
-   The following mail messages will be used throughout this document in
-   examples.
-
-   Message A
-   -----------------------------------------------------------
-   Date: Tue, 1 Apr 1997 09:06:31 -0800 (PST)
-   From: coyote@desert.example.org
-   To: roadrunner@acme.example.com
-   Subject: I have a present for you
-
-   Look, I'm sorry about the whole anvil thing, and I really
-   didn't mean to try and drop it on you from the top of the
-   cliff.  I want to try to make it up to you.  I've got some
-   great birdseed over here at my place--top of the line
-
-
-
-
-Showalter                   Standards Track                     [Page 4]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   stuff--and if you come by, I'll have it all wrapped up
-   for you.  I'm really sorry for all the problems I've caused
-   for you over the years, but I know we can work this out.
-   --
-   Wile E. Coyote   "Super Genius"   coyote@desert.example.org
-   -----------------------------------------------------------
-
-   Message B
-   -----------------------------------------------------------
-   From: youcouldberich!@reply-by-postal-mail.invalid
-   Sender: b1ff@de.res.example.com
-   To: rube@landru.example.edu
-   Date:  Mon, 31 Mar 1997 18:26:10 -0800
-   Subject: $$$ YOU, TOO, CAN BE A MILLIONAIRE! $$$
-
-   YOU MAY HAVE ALREADY WON TEN MILLION DOLLARS, BUT I DOUBT
-   IT!  SO JUST POST THIS TO SIX HUNDRED NEWSGROUPS!  IT WILL
-   GUARANTEE THAT YOU GET AT LEAST FIVE RESPONSES WITH MONEY!
-   MONEY! MONEY! COLD HARD CASH!  YOU WILL RECEIVE OVER
-   $20,000 IN LESS THAN TWO MONTHS!  AND IT'S LEGAL!!!!!!!!!
-   !!!!!!!!!!!!!!!!!!111111111!!!!!!!11111111111!!1  JUST
-   SEND $5 IN SMALL, UNMARKED BILLS TO THE ADDRESSES BELOW!
-   -----------------------------------------------------------
-
-2.      Design
-
-2.1.     Form of the Language
-
-   The language consists of a set of commands.  Each command consists of
-   a set of tokens delimited by whitespace.  The command identifier is
-   the first token and it is followed by zero or more argument tokens.
-   Arguments may be literal data, tags, blocks of commands, or test
-   commands.
-
-   The language is represented in UTF-8, as specified in [UTF-8].
-
-   Tokens in the ASCII range are considered case-insensitive.
-
-2.2.     Whitespace
-
-   Whitespace is used to separate tokens.  Whitespace is made up of
-   tabs, newlines (CRLF, never just CR or LF), and the space character.
-   The amount of whitespace used is not significant.
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                     [Page 5]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.3.     Comments
-
-   Two types of comments are offered.  Comments are semantically
-   equivalent to whitespace and can be used anyplace that whitespace is
-   (with one exception in multi-line strings, as described in the
-   grammar).
-
-   Hash comments begin with a "#" character that is not contained within
-   a string and continue until the next CRLF.
-
-   Example:  if size :over 100K { # this is a comment
-                discard;
-             }
-
-   Bracketed comments begin with the token "/*" and end with "*/" outside
-   of a string.  Bracketed comments may span multiple lines. Bracketed
-   comments do not nest.
-
-   Example:  if size :over 100K { /* this is a comment
-                this is still a comment */ discard /* this is a comment
-                */ ;
-             }
-
-2.4.     Literal Data
-
-   Literal data means data that is not executed, merely evaluated "as
-   is", to be used as arguments to commands.  Literal data is limited to
-   numbers and strings.
-
-2.4.1.   Numbers
-
-   Numbers are given as ordinary decimal numbers.  However, those
-   numbers that have a tendency to be fairly large, such as message
-   sizes, MAY have a "K", "M", or "G" appended to indicate a multiple of
-   a power of two.  To be comparable with the power-of-two-based
-   versions of SI units that computers frequently use, K specifies
-   kibi-, or 1,024 (2^10) times the value of the number; M specifies
-   mebi-, or 1,048,576 (2^20) times the value of the number; and G
-   specifies tebi-, or 1,073,741,824 (2^30) times the value of the
-   number [BINARY-SI].
-
-   Implementations MUST provide 31 bits of magnitude in numbers, but MAY
-   provide more.
-
-   Only positive integers are permitted by this specification.
-
-
-
-
-
-
-Showalter                   Standards Track                     [Page 6]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.4.2.   Strings
-
-   Scripts involve large numbers of strings as they are used for pattern
-   matching, addresses, textual bodies, etc.  Typically, short quoted
-   strings suffice for most uses, but a more convenient form is provided
-   for longer strings such as bodies of messages.
-
-   A quoted string starts and ends with a single double quote (the <">
-   character, ASCII 34).  A backslash ("\", ASCII 92) inside of a quoted
-   string is followed by either another backslash or a double quote.
-   This two-character sequence represents a single backslash or double-
-   quote within the string, respectively.
-
-   No other characters should be escaped with a single backslash.
-
-   An undefined escape sequence (such as "\a" in a context where "a" has
-   no special meaning) is interpreted as if there were no backslash (in
-   this case, "\a" is just "a").
-
-   Non-printing characters such as tabs, CR and LF, and control
-   characters are permitted in quoted strings.  Quoted strings MAY span
-   multiple lines.  NUL (ASCII 0) is not allowed in strings.
-
-   For entering larger amounts of text, such as an email message, a
-   multi-line form is allowed.  It starts with the keyword "text:",
-   followed by a CRLF, and ends with the sequence of a CRLF, a single
-   period, and another CRLF.  In order to allow the message to contain
-   lines with a single-dot, lines are dot-stuffed.  That is, when
-   composing a message body, an extra `.' is added before each line
-   which begins with a `.'.  When the server interprets the script,
-   these extra dots are removed.  Note that a line that begins with a
-   dot followed by a non-dot character is not interpreted dot-stuffed;
-   that is, ".foo" is interpreted as ".foo".  However, because this is
-   potentially ambiguous, scripts SHOULD be properly dot-stuffed so such
-   lines do not appear.
-
-   Note that a hashed comment or whitespace may occur in between the
-   "text:" and the CRLF, but not within the string itself.  Bracketed
-   comments are not allowed here.
-
-2.4.2.1. String Lists
-
-   When matching patterns, it is frequently convenient to match against
-   groups of strings instead of single strings.  For this reason, a list
-   of strings is allowed in many tests, implying that if the test is
-   true using any one of the strings, then the test is true.
-   Implementations are encouraged to use short-circuit evaluation in
-   these cases.
-
-
-
-Showalter                   Standards Track                     [Page 7]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   For instance, the test `header :contains ["To", "Cc"]
-   ["me@example.com", "me00@landru.example.edu"]' is true if either the
-   To header or Cc header of the input message contains either of the
-   e-mail addresses "me@example.com" or "me00@landru.example.edu".
-
-   Conversely, in any case where a list of strings is appropriate, a
-   single string is allowed without being a member of a list: it is
-   equivalent to a list with a single member.  This means that the test
-   `exists "To"' is equivalent to the test `exists ["To"]'.
-
-2.4.2.2. Headers
-
-   Headers are a subset of strings.  In the Internet Message
-   Specification [IMAIL] [RFC1123], each header line is allowed to have
-   whitespace nearly anywhere in the line, including after the field
-   name and before the subsequent colon.  Extra spaces between the
-   header name and the ":" in a header field are ignored.
-
-   A header name never contains a colon.  The "From" header refers to a
-   line beginning "From:" (or "From   :", etc.).  No header will match
-   the string "From:" due to the trailing colon.
-
-   Folding of long header lines (as described in [IMAIL] 3.4.8) is
-   removed prior to interpretation of the data.  The folding syntax (the
-   CRLF that ends a line plus any leading whitespace at the beginning of
-   the next line that indicates folding) are interpreted as if they were
-   a single space.
-
-2.4.2.3. Addresses
-
-   A number of commands call for email addresses, which are also a
-   subset of strings.  When these addresses are used in outbound
-   contexts, addresses must be compliant with [IMAIL], but are further
-   constrained.  Using the symbols defined in [IMAIL], section 6.1, the
-   syntax of an address is:
-
-   sieve-address = addr-spec                ; simple address
-                 / phrase "<" addr-spec ">" ; name & addr-spec
-
-   That is, routes and group syntax are not permitted.  If multiple
-   addresses are required, use a string list.  Named groups are not used
-   here.
-
-   Implementations MUST ensure that the addresses are syntactically
-   valid, but need not ensure that they actually identify an email
-   recipient.
-
-
-
-
-
-Showalter                   Standards Track                     [Page 8]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.4.2.4. MIME Parts
-
-   In a few places, [MIME] body parts are represented as strings.  These
-   parts include MIME headers and the body.  This provides a way of
-   embedding typed data within a Sieve script so that, among other
-   things, character sets other than UTF-8 can be used for output
-   messages.
-
-2.5.     Tests
-
-   Tests are given as arguments to commands in order to control their
-   actions.  In this document, tests are given to if/elsif/else to
-   decide which block of code is run.
-
-   Tests MUST NOT have side effects.  That is, a test cannot affect the
-   state of the filter or message.  No tests in this specification have
-   side effects, and side effects are forbidden in extension tests as
-   well.
-
-   The rationale for this is that tests with side effects impair
-   readability and maintainability and are difficult to represent in a
-   graphic interface for generating scripts.  Side effects are confined
-   to actions where they are clearer.
-
-2.5.1.   Test Lists
-
-   Some tests ("allof" and "anyof", which implement logical "and" and
-   logical "or", respectively) may require more than a single test as an
-   argument.  The test-list syntax element provides a way of grouping
-   tests.
-
-   Example:  if anyof (not exists ["From", "Date"],
-                   header :contains "from" "fool@example.edu") {
-                discard;
-             }
-
-2.6.     Arguments
-
-   In order to specify what to do, most commands take arguments.  There
-   are three types of arguments: positional, tagged, and optional.
-
-2.6.1.   Positional Arguments
-
-   Positional arguments are given to a command which discerns their
-   meaning based on their order.  When a command takes positional
-   arguments, all positional arguments must be supplied and must be in
-   the order prescribed.
-
-
-
-
-Showalter                   Standards Track                     [Page 9]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.6.2.   Tagged Arguments
-
-   This document provides for tagged arguments in the style of
-   CommonLISP.  These are also similar to flags given to commands in
-   most command-line systems.
-
-   A tagged argument is an argument for a command that begins with ":"
-   followed by a tag naming the argument, such as ":contains".  This
-   argument means that zero or more of the next tokens have some
-   particular meaning depending on the argument.  These next tokens may
-   be numbers or strings but they are never blocks.
-
-   Tagged arguments are similar to positional arguments, except that
-   instead of the meaning being derived from the command, it is derived
-   from the tag.
-
-   Tagged arguments must appear before positional arguments, but they
-   may appear in any order with other tagged arguments.  For simplicity
-   of the specification, this is not expressed in the syntax definitions
-   with commands, but they still may be reordered arbitrarily provided
-   they appear before positional arguments.  Tagged arguments may be
-   mixed with optional arguments.
-
-   To simplify this specification, tagged arguments SHOULD NOT take
-   tagged arguments as arguments.
-
-2.6.3.   Optional Arguments
-
-   Optional arguments are exactly like tagged arguments except that they
-   may be left out, in which case a default value is implied.  Because
-   optional arguments tend to result in shorter scripts, they have been
-   used far more than tagged arguments.
-
-   One particularly noteworthy case is the ":comparator" argument, which
-   allows the user to specify which [ACAP] comparator will be used to
-   compare two strings, since different languages may impose different
-   orderings on UTF-8 [UTF-8] characters.
-
-2.6.4.   Types of Arguments
-
-   Abstractly, arguments may be literal data, tests, or blocks of
-   commands.  In this way, an "if" control structure is merely a command
-   that happens to take a test and a block as arguments and may execute
-   the block of code.
-
-   However, this abstraction is ambiguous from a parsing standpoint.
-   The grammar in section 9.2 presents a parsable version of this:
-   Arguments are string-lists, numbers, and tags, which may be followed
-
-
-
-Showalter                   Standards Track                    [Page 10]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   by a test or a test-list, which may be followed by a block of
-   commands.  No more than one test or test list, nor more than one
-   block of commands, may be used, and commands that end with blocks of
-   commands do not end with semicolons.
-
-2.7.     String Comparison
-
-   When matching one string against another, there are a number of ways
-   of performing the match operation.  These are accomplished with three
-   types of matches: an exact match, a substring match, and a wildcard
-   glob-style match.  These are described below.
-
-   In order to provide for matches between character sets and case
-   insensitivity, Sieve borrows ACAP's comparator registry.
-
-   However, when a string represents the name of a header, the
-   comparator is never user-specified.  Header comparisons are always
-   done with the "i;ascii-casemap" operator, i.e., case-insensitive
-   comparisons, because this is the way things are defined in the
-   message specification [IMAIL].
-
-2.7.1.   Match Type
-
-   There are three match types describing the matching used in this
-   specification:  ":is", ":contains", and ":matches".  Match type
-   arguments are supplied to those commands which allow them to specify
-   what kind of match is to be performed.
-
-   These are used as tagged arguments to tests that perform string
-   comparison.
-
-   The ":contains" match type describes a substring match.  If the value
-   argument contains the key argument as a substring, the match is true.
-   For instance, the string "frobnitzm" contains "frob" and "nit", but
-   not "fbm".  The null key ("") is contained in all values.
-
-   The ":is" match type describes an absolute match; if the contents of
-   the first string are absolutely the same as the contents of the
-   second string, they match.  Only the string "frobnitzm" is the string
-   "frobnitzm".  The null key ":is" and only ":is" the null value.
-
-   The ":matches" version specifies a wildcard match using the
-   characters "*" and "?".  "*" matches zero or more characters, and "?"
-   matches a single character.  "?" and "*" may be escaped as "\\?" and
-   "\\*" in strings to match against themselves.  The first backslash
-   escapes the second backslash; together, they escape the "*".  This is
-   awkward, but it is commonplace in several programming languages that
-   use globs and regular expressions.
-
-
-
-Showalter                   Standards Track                    [Page 11]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   In order to specify what type of match is supposed to happen,
-   commands that support matching take optional tagged arguments
-   ":matches", ":is", and ":contains".  Commands default to using ":is"
-   matching if no match type argument is supplied.  Note that these
-   modifiers may interact with comparators; in particular, some
-   comparators are not suitable for matching with ":contains" or
-   ":matches".  It is an error to use a comparator with ":contains" or
-   ":matches" that is not compatible with it.
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-   For convenience, the "MATCH-TYPE" syntax element is defined  here  as
-   follows:
-
-   Syntax:   ":is" / ":contains" / ":matches"
-
-2.7.2.   Comparisons Across Character Sets
-
-   All Sieve scripts are represented in UTF-8, but messages may involve
-   a number of character sets.  In order for comparisons to work across
-   character sets, implementations SHOULD implement the following
-   behavior:
-
-      Implementations decode header charsets to UTF-8.  Two strings are
-      considered equal if their UTF-8 representations are identical.
-      Implementations should decode charsets represented in the forms
-      specified by [MIME] for both message headers and bodies.
-      Implementations must be capable of decoding US-ASCII, ISO-8859-1,
-      the ASCII subset of ISO-8859-* character sets, and UTF-8.
-
-   If implementations fail to support the above behavior, they MUST
-   conform to the following:
-
-      No two strings can be considered equal if one contains octets
-      greater than 127.
-
-2.7.3.   Comparators
-
-   In order to allow for language-independent, case-independent matches,
-   the match type may be coupled with a comparator name.  Comparators
-   are described for [ACAP]; a registry is defined for ACAP, and this
-   specification uses that registry.
-
-   ACAP defines multiple comparator types.  Only equality types are used
-   in this specification.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 12]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   All implementations MUST support the "i;octet" comparator (simply
-   compares octets) and the "i;ascii-casemap" comparator (which treats
-   uppercase and lowercase characters in the ASCII subset of UTF-8 as
-   the same).  If left unspecified, the default is "i;ascii-casemap".
-
-   Some comparators may not be usable with substring matches; that is,
-   they may only work with ":is".  It is an error to try and use a
-   comparator with ":matches" or ":contains" that is not compatible with
-   it.
-
-   A comparator is specified by the ":comparator" option with commands
-   that support matching.  This option is followed by a string providing
-   the name of the comparator to be used.  For convenience, the syntax
-   of a comparator is abbreviated to "COMPARATOR", and (repeated in
-   several tests) is as follows:
-
-   Syntax:   ":comparator" <comparator-name: string>
-
-   So in this example,
-
-   Example:  if header :contains :comparator "i;octet" "Subject"
-                "MAKE MONEY FAST" {
-                   discard;
-             }
-
-   would discard any message with subjects like "You can MAKE MONEY
-   FAST", but not "You can Make Money Fast", since the comparator used
-   is case-sensitive.
-
-   Comparators other than i;octet and i;ascii-casemap must be declared
-   with require, as they are extensions.  If a comparator declared with
-   require is not known, it is an error, and execution fails.  If the
-   comparator is not declared with require, it is also an error, even if
-   the comparator is supported.  (See 2.10.5.)
-
-   Both ":matches" and ":contains" match types are compatible with the
-   "i;octet" and "i;ascii-casemap" comparators and may be used with
-   them.
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-2.7.4.   Comparisons Against Addresses
-
-   Addresses are one of the most frequent things represented as strings.
-   These are structured, and being able to compare against the local-
-   part or the domain of an address is useful, so some tests that act
-
-
-
-
-Showalter                   Standards Track                    [Page 13]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   exclusively on addresses take an additional optional argument that
-   specifies what the test acts on.
-
-   These optional arguments are ":localpart", ":domain", and ":all",
-   which act on the local-part (left-side), the domain part (right-
-   side), and the whole address.
-
-   The kind of comparison done, such as whether or not the test done is
-   case-insensitive, is specified as a comparator argument to the test.
-
-   If an optional address-part is omitted, the default is ":all".
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-   For convenience, the "ADDRESS-PART" syntax element is defined here as
-   follows:
-
-   Syntax:   ":localpart" / ":domain" / ":all"
-
-2.8.     Blocks
-
-   Blocks are sets of commands enclosed within curly braces.  Blocks are
-   supplied to commands so that the commands can implement control
-   commands.
-
-   A control structure is a command that happens to take a test and a
-   block as one of its arguments; depending on the result of the test
-   supplied as another argument, it runs the code in the block some
-   number of times.
-
-   With the commands supplied in this memo, there are no loops.  The
-   control structures supplied--if, elsif, and else--run a block either
-   once or not at all.  So there are two arguments, the test and the
-   block.
-
-2.9.     Commands
-
-   Sieve scripts are sequences of commands.  Commands can take any of
-   the tokens above as arguments, and arguments may be either tagged or
-   positional arguments.  Not all commands take all arguments.
-
-   There are three kinds of commands: test commands, action commands,
-   and control commands.
-
-   The simplest is an action command.  An action command is an
-   identifier followed by zero or more arguments, terminated by a
-   semicolon.  Action commands do not take tests or blocks as arguments.
-
-
-
-Showalter                   Standards Track                    [Page 14]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   A control command is similar, but it takes a test as an argument, and
-   ends with a block instead of a semicolon.
-
-   A test command is used as part of a control command.  It is used to
-   specify whether or not the block of code given to the control command
-   is executed.
-
-2.10.    Evaluation
-
-2.10.1.  Action Interaction
-
-   Some actions cannot be used with other actions because the result
-   would be absurd.  These restrictions are noted throughout this memo.
-
-   Extension actions MUST state how they interact with actions defined
-   in this specification.
-
-2.10.2.  Implicit Keep
-
-   Previous experience with filtering systems suggests that cases tend
-   to be missed in scripts.  To prevent errors, Sieve has an "implicit
-   keep".
-
-   An implicit keep is a keep action (see 4.4) performed in absence of
-   any action that cancels the implicit keep.
-
-   An implicit keep is performed if a message is not written to a
-   mailbox, redirected to a new address, or explicitly thrown out.  That
-   is, if a fileinto, a keep, a redirect, or a discard is performed, an
-   implicit keep is not.
-
-   Some actions may be defined to not cancel the implicit keep.  These
-   actions may not directly affect the delivery of a message, and are
-   used for their side effects.  None of the actions specified in this
-   document meet that criteria, but extension actions will.
-
-   For instance, with any of the short messages offered above, the
-   following script produces no actions.
-
-   Example:  if size :over 500K { discard; }
-
-   As a result, the implicit keep is taken.
-
-2.10.3.  Message Uniqueness in a Mailbox
-
-   Implementations SHOULD NOT deliver a message to the same folder more
-   than once, even if a script explicitly asks for a message to be
-   written to a mailbox twice.
-
-
-
-Showalter                   Standards Track                    [Page 15]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   The test for equality of two messages is implementation-defined.
-
-   If a script asks for a message to be written to a mailbox twice, it
-   MUST NOT be treated as an error.
-
-2.10.4.  Limits on Numbers of Actions
-
-   Site policy MAY limit numbers of actions taken and MAY impose
-   restrictions on which actions can be used together.  In the event
-   that a script hits a policy limit on the number of actions taken for
-   a particular message, an error occurs.
-
-   Implementations MUST prohibit more than one reject.
-
-   Implementations MUST allow at least one keep or one fileinto.  If
-   fileinto is not implemented, implementations MUST allow at least one
-   keep.
-
-   Implementations SHOULD prohibit reject when used with other actions.
-
-2.10.5.  Extensions and Optional Features
-
-   Because of the differing capabilities of many mail systems, several
-   features of this specification are optional.  Before any of these
-   extensions can be executed, they must be declared with the "require"
-   action.
-
-   If an extension is not enabled with "require", implementations MUST
-   treat it as if they did not support it at all.
-
-   If a script does not understand an extension declared with require,
-   the script must not be used at all.  Implementations MUST NOT execute
-   scripts which require unknown capability names.
-
-   Note: The reason for this restriction is that prior experiences with
-         languages such as LISP and Tcl suggest that this is a workable
-         way of noting that a given script uses an extension.
-
-         Experience with PostScript suggests that mechanisms that allow
-         a script to work around missing extensions are not used in
-         practice.
-
-   Extensions which define actions MUST state how they interact with
-   actions discussed in the base specification.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 16]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.10.6.  Errors
-
-   In any programming language, there are compile-time and run-time
-   errors.
-
-   Compile-time errors are ones in syntax that are detectable if a
-   syntax check is done.
-
-   Run-time errors are not detectable until the script is run.  This
-   includes transient failures like disk full conditions, but also
-   includes issues like invalid combinations of actions.
-
-   When an error occurs in a Sieve script, all processing stops.
-
-   Implementations MAY choose to do a full parse, then evaluate the
-   script, then do all actions.  Implementations might even go so far as
-   to ensure that execution is atomic (either all actions are executed
-   or none are executed).
-
-   Other implementations may choose to parse and run at the same time.
-   Such implementations are simpler, but have issues with partial
-   failure (some actions happen, others don't).
-
-   Implementations might even go so far as to ensure that scripts can
-   never execute an invalid set of actions (e.g., reject + fileinto)
-   before execution, although this could involve solving the Halting
-   Problem.
-
-   This specification allows any of these approaches.  Solving the
-   Halting Problem is considered extra credit.
-
-   When an error happens, implementations MUST notify the user that an
-   error occurred, which actions (if any) were taken, and do an implicit
-   keep.
-
-2.10.7.  Limits on Execution
-
-   Implementations may limit certain constructs.  However, this
-   specification places a lower bound on some of these limits.
-
-   Implementations MUST support fifteen levels of nested blocks.
-
-   Implementations MUST support fifteen levels of nested test lists.
-
-3.      Control Commands
-
-   Control structures are needed to allow for multiple and conditional
-   actions.
-
-
-
-Showalter                   Standards Track                    [Page 17]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-3.1.     Control Structure If
-
-   There are three pieces to if: "if", "elsif", and "else".  Each is
-   actually a separate command in terms of the grammar.  However, an
-   elsif MUST only follow an if, and an else MUST follow only either an
-   if or an elsif.  An error occurs if these conditions are not met.
-
-   Syntax:   if <test1: test> <block1: block>
-
-   Syntax:   elsif <test2: test> <block2: block>
-
-   Syntax:   else <block>
-
-   The semantics are similar to those of any of the many other
-   programming languages these control commands appear in.  When the
-   interpreter sees an "if", it evaluates the test associated with it.
-   If the test is true, it executes the block associated with it.
-
-   If the test of the "if" is false, it evaluates the test of the first
-   "elsif" (if any).  If the test of "elsif" is true, it runs the
-   elsif's block.  An elsif may be followed by an elsif, in which case,
-   the interpreter repeats this process until it runs out of elsifs.
-
-   When the interpreter runs out of elsifs, there may be an "else" case.
-   If there is, and none of the if or elsif tests were true, the
-   interpreter runs the else case.
-
-   This provides a way of performing exactly one of the blocks in the
-   chain.
-
-   In the following example, both Message A and B are dropped.
-
-   Example:  require "fileinto";
-             if header :contains "from" "coyote" {
-                discard;
-             } elsif header :contains ["subject"] ["$$$"] {
-                discard;
-             } else {
-                fileinto "INBOX";
-             }
-
-
-   When the script below is run over message A, it redirects the message
-   to  acm@example.edu;  message B, to postmaster@example.edu; any other
-   message is redirected to field@example.edu.
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 18]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Example:  if header :contains ["From"] ["coyote"] {
-                redirect "acm@example.edu";
-             } elsif header :contains "Subject" "$$$" {
-                redirect "postmaster@example.edu";
-             } else {
-                redirect "field@example.edu";
-             }
-
-   Note that this definition prohibits the "... else if ..." sequence
-   used by C.  This is intentional, because this construct produces a
-   shift-reduce conflict.
-
-3.2.     Control Structure Require
-
-   Syntax:   require <capabilities: string-list>
-
-   The require action notes that a script makes use of a certain
-   extension.  Such a declaration is required to use the extension, as
-   discussed in section 2.10.5.  Multiple capabilities can be declared
-   with a single require.
-
-   The require command, if present, MUST be used before anything other
-   than a require can be used.  An error occurs if a require appears
-   after a command other than require.
-
-   Example:  require ["fileinto", "reject"];
-
-   Example:  require "fileinto";
-             require "vacation";
-
-3.3.     Control Structure Stop
-
-   Syntax:   stop
-
-   The "stop" action ends all processing.  If no actions have been
-   executed, then the keep action is taken.
-
-4.      Action Commands
-
-   This document supplies five actions that may be taken on a message:
-   keep, fileinto, redirect, reject, and discard.
-
-   Implementations MUST support the "keep", "discard", and "redirect"
-   actions.
-
-   Implementations SHOULD support "reject" and "fileinto".
-
-
-
-
-
-Showalter                   Standards Track                    [Page 19]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Implementations MAY limit the number of certain actions taken (see
-   section 2.10.4).
-
-4.1.     Action reject
-
-   Syntax:   reject <reason: string>
-
-   The optional "reject" action refuses delivery of a message by sending
-   back an [MDN] to the sender.  It resends the message to the sender,
-   wrapping it in a "reject" form, noting that it was rejected by the
-   recipient.  In the following script, message A is rejected and
-   returned to the sender.
-
-   Example:  if header :contains "from" "coyote@desert.example.org" {
-                reject "I am not taking mail from you, and I don't want
-                your birdseed, either!";
-             }
-
-   A reject message MUST take the form of a failure MDN as specified  by
-   [MDN].    The  human-readable  portion  of  the  message,  the  first
-   component of the MDN, contains the human readable message  describing
-   the  error,  and  it  SHOULD  contain  additional  text  alerting the
-   original sender that mail was refused by a filter.  This part of  the
-   MDN might appear as follows:
-
-   ------------------------------------------------------------
-   Message was refused by recipient's mail filtering program.  Reason
-   given was as follows:
-
-   I am not taking mail from you, and I don't want your birdseed,
-   either!
-   ------------------------------------------------------------
-
-   The MDN action-value field as defined in the MDN specification MUST
-   be "deleted" and MUST have the MDN-sent-automatically and automatic-
-   action modes set.
-
-   Because some implementations can not or will not implement the reject
-   command, it is optional.  The capability string to be used with the
-   require command is "reject".
-
-4.2.     Action fileinto
-
-   Syntax:   fileinto <folder: string>
-
-   The "fileinto" action delivers the message into the specified folder.
-   Implementations SHOULD support fileinto, but in some environments
-   this may be impossible.
-
-
-
-Showalter                   Standards Track                    [Page 20]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   The capability string for use with the require command is "fileinto".
-
-   In the following script, message A is filed into folder
-   "INBOX.harassment".
-
-   Example:  require "fileinto";
-             if header :contains ["from"] "coyote" {
-                fileinto "INBOX.harassment";
-             }
-
-4.3.     Action redirect
-
-   Syntax:   redirect <address: string>
-
-   The "redirect" action is used to send the message to another user at
-   a supplied address, as a mail forwarding feature does.  The
-   "redirect" action makes no changes to the message body or existing
-   headers, but it may add new headers.  The "redirect" modifies the
-   envelope recipient.
-
-   The redirect command performs an MTA-style "forward"--that is, what
-   you get from a .forward file using sendmail under UNIX.  The address
-   on the SMTP envelope is replaced with the one on the redirect command
-   and the message is sent back out.  (This is not an MUA-style forward,
-   which creates a new message with a different sender and message ID,
-   wrapping the old message in a new one.)
-
-   A simple script can be used for redirecting all mail:
-
-   Example:  redirect "bart@example.edu";
-
-   Implementations SHOULD take measures to implement loop control,
-   possibly including adding headers to the message or counting received
-   headers.  If an implementation detects a loop, it causes an error.
-
-4.4.     Action keep
-
-   Syntax:   keep
-
-   The "keep" action is whatever action is taken in lieu of all other
-   actions, if no filtering happens at all; generally, this simply means
-   to file the message into the user's main mailbox.  This command
-   provides a way to execute this action without needing to know the
-   name of the user's main mailbox, providing a way to call it without
-   needing to understand the user's setup, or the underlying mail
-   system.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 21]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   For instance, in an implementation where the IMAP server is running
-   scripts on behalf of the user at time of delivery, a keep command is
-   equivalent to a fileinto "INBOX".
-
-   Example:  if size :under 1M { keep; } else { discard; }
-
-   Note that the above script is identical to the one below.
-
-   Example:  if not size :under 1M { discard; }
-
-4.5.     Action discard
-
-   Syntax:   discard
-
-   Discard is used to silently throw away the message.  It does so by
-   simply canceling the implicit keep.  If discard is used with other
-   actions, the other actions still happen.  Discard is compatible with
-   all other actions.  (For instance fileinto+discard is equivalent to
-   fileinto.)
-
-   Discard MUST be silent; that is, it MUST NOT return a non-delivery
-   notification of any kind ([DSN], [MDN], or otherwise).
-
-   In the following script, any mail from "idiot@example.edu" is thrown
-   out.
-
-   Example:  if header :contains ["from"] ["idiot@example.edu"] {
-                discard;
-             }
-
-   While an important part of this language, "discard" has the potential
-   to create serious problems for users: Students who leave themselves
-   logged in to an unattended machine in a public computer lab may find
-   their script changed to just "discard".  In order to protect users in
-   this situation (along with similar situations), implementations MAY
-   keep messages destroyed by a script for an indefinite period, and MAY
-   disallow scripts that throw out all mail.
-
-5.      Test Commands
-
-   Tests are used in conditionals to decide which part(s) of the
-   conditional to execute.
-
-   Implementations MUST support these tests: "address", "allof",
-   "anyof", "exists", "false", "header", "not", "size", and "true".
-
-   Implementations SHOULD support the "envelope" test.
-
-
-
-
-Showalter                   Standards Track                    [Page 22]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-5.1.     Test address
-
-   Syntax:   address [ADDRESS-PART] [COMPARATOR] [MATCH-TYPE]
-             <header-list: string-list> <key-list: string-list>
-
-   The address test matches Internet addresses in structured headers
-   that contain addresses.  It returns true if any header contains any
-   key in the specified part of the address, as modified by the
-   comparator and the match keyword.
-
-   Like envelope and header, this test returns true if any combination
-   of the header-list and key-list arguments match.
-
-   Internet email addresses [IMAIL] have the somewhat awkward
-   characteristic that the local-part to the left of the at-sign is
-   considered case sensitive, and the domain-part to the right of the
-   at-sign is case insensitive.  The "address" command does not deal
-   with this itself, but provides the ADDRESS-PART argument for allowing
-   users to deal with it.
-
-   The address primitive never acts on the phrase part of an email
-   address, nor on comments within that address.  It also never acts on
-   group names, although it does act on the addresses within the group
-   construct.
-
-   Implementations MUST restrict the address test to headers that
-   contain addresses, but MUST include at least From, To, Cc, Bcc,
-   Sender, Resent-From, Resent-To, and SHOULD include any other header
-   that utilizes an "address-list" structured header body.
-
-   Example:  if address :is :all "from" "tim@example.com" {
-                discard;
-
-5.2.     Test allof
-
-   Syntax:   allof <tests: test-list>
-
-   The allof test performs a logical AND on the tests supplied to it.
-
-   Example:  allof (false, false)  =>   false
-             allof (false, true)   =>   false
-             allof (true,  true)   =>   true
-
-   The allof test takes as its argument a test-list.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 23]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-5.3.     Test anyof
-
-   Syntax:   anyof <tests: test-list>
-
-   The anyof test performs a logical OR on the tests supplied to it.
-
-   Example:  anyof (false, false)  =>   false
-             anyof (false, true)   =>   true
-             anyof (true,  true)   =>   true
-
-5.4.     Test envelope
-
-   Syntax:   envelope [COMPARATOR] [ADDRESS-PART] [MATCH-TYPE]
-             <envelope-part: string-list> <key-list: string-list>
-
-   The "envelope" test is true if the specified part of the SMTP (or
-   equivalent) envelope matches the specified key.
-
-   If one of the envelope-part strings is (case insensitive) "from",
-   then matching occurs against the FROM address used in the SMTP MAIL
-   command.
-
-   If one of the envelope-part strings is (case insensitive) "to", then
-   matching occurs against the TO address used in the SMTP RCPT command
-   that resulted in this message getting delivered to this user.  Note
-   that only the most recent TO is available, and only the one relevant
-   to this user.
-
-   The envelope-part is a string list and may contain more than one
-   parameter, in which case all of the strings specified in the key-list
-   are matched against all parts given in the envelope-part list.
-
-   Like address and header, this test returns true if any combination of
-   the envelope-part and key-list arguments is true.
-
-   All tests against envelopes MUST drop source routes.
-
-   If the SMTP transaction involved several RCPT commands, only the data
-   from the RCPT command that caused delivery to this user is available
-   in the "to" part of the envelope.
-
-   If a protocol other than SMTP is used for message transport,
-   implementations are expected to adapt this command appropriately.
-
-   The envelope command is optional.  Implementations SHOULD support it,
-   but the necessary information may not be available in all cases.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 24]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Example:  require "envelope";
-             if envelope :all :is "from" "tim@example.com" {
-                discard;
-             }
-
-5.5.     Test exists
-
-   Syntax:   exists <header-names: string-list>
-
-   The "exists" test is true if the headers listed in the header-names
-   argument exist within the message.  All of the headers must exist or
-   the test is false.
-
-   The following example throws out mail that doesn't have a From header
-   and a Date header.
-
-   Example:  if not exists ["From","Date"] {
-                discard;
-             }
-
-5.6.     Test false
-
-   Syntax:   false
-
-   The "false" test always evaluates to false.
-
-5.7.     Test header
-
-   Syntax:   header [COMPARATOR] [MATCH-TYPE]
-             <header-names: string-list> <key-list: string-list>
-
-   The "header" test evaluates to true if any header name matches any
-   key.  The type of match is specified by the optional match argument,
-   which defaults to ":is" if not specified, as specified in section
-   2.6.
-
-   Like address and envelope, this test returns true if any combination
-   of the string-list and key-list arguments match.
-
-   If a header listed in the header-names argument exists, it contains
-   the null key ("").  However, if the named header is not present, it
-   does not contain the null key.  So if a message contained the header
-
-           X-Caffeine: C8H10N4O2
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 25]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   these tests on that header evaluate as follows:
-
-           header :is ["X-Caffeine"] [""]         => false
-           header :contains ["X-Caffeine"] [""]   => true
-
-5.8.     Test not
-
-   Syntax:   not <test>
-
-   The "not" test takes some other test as an argument, and yields the
-   opposite result.  "not false" evaluates to "true" and "not true"
-   evaluates to "false".
-
-5.9.     Test size
-
-   Syntax:   size <":over" / ":under"> <limit: number>
-
-   The "size" test deals with the size of a message.  It takes either a
-   tagged argument of ":over" or ":under", followed by a number
-   representing the size of the message.
-
-   If the argument is ":over", and the size of the message is greater
-   than the number provided, the test is true; otherwise, it is false.
-
-   If the argument is ":under", and the size of the message is less than
-   the number provided, the test is true; otherwise, it is false.
-
-   Exactly one of ":over" or ":under" must be specified, and anything
-   else is an error.
-
-   The size of a message is defined to be the number of octets from the
-   initial header until the last character in the message body.
-
-   Note that for a message that is exactly 4,000 octets, the message is
-   neither ":over" 4000 octets or ":under" 4000 octets.
-
-5.10.    Test true
-
-   Syntax:   true
-
-   The "true" test always evaluates to true.
-
-6.      Extensibility
-
-   New control structures, actions, and tests can be added to the
-   language.  Sites must make these features known to their users; this
-   document does not define a way to discover the list of extensions
-   supported by the server.
-
-
-
-Showalter                   Standards Track                    [Page 26]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Any extensions to this language MUST define a capability string that
-   uniquely identifies that extension.  If a new version of an extension
-   changes the functionality of a previously defined extension, it MUST
-   use a different name.
-
-   In a situation where there is a submission protocol and an extension
-   advertisement mechanism aware of the details of this language,
-   scripts submitted can be checked against the mail server to prevent
-   use of an extension that the server does not support.
-
-   Extensions MUST state how they interact with constraints defined in
-   section 2.10, e.g., whether they cancel the implicit keep, and which
-   actions they are compatible and incompatible with.
-
-6.1.     Capability String
-
-   Capability strings are typically short strings describing what
-   capabilities are supported by the server.
-
-   Capability strings beginning with "vnd." represent vendor-defined
-   extensions.  Such extensions are not defined by Internet standards or
-   RFCs, but are still registered with IANA in order to prevent
-   conflicts.  Extensions starting with "vnd." SHOULD be followed by the
-   name of the vendor and product, such as "vnd.acme.rocket-sled".
-
-   The following capability strings are defined by this document:
-
-   envelope    The string "envelope" indicates that the implementation
-               supports the "envelope" command.
-
-   fileinto    The string "fileinto" indicates that the implementation
-               supports the "fileinto" command.
-
-   reject      The string "reject" indicates that the implementation
-               supports the "reject" command.
-
-   comparator- The string "comparator-elbonia" is provided if the
-               implementation supports the "elbonia" comparator.
-               Therefore, all implementations have at least the
-               "comparator-i;octet" and "comparator-i;ascii-casemap"
-               capabilities.  However, these comparators may be used
-               without being declared with require.
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 27]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-6.2.     IANA Considerations
-
-   In order to provide a standard set of extensions, a registry is
-   provided by IANA.  Capability names may be registered on a first-
-   come, first-served basis.  Extensions designed for interoperable use
-   SHOULD be defined as standards track or IESG approved experimental
-   RFCs.
-
-6.2.1.     Template for Capability Registrations
-
-   The following template is to be used for registering new Sieve
-   extensions with IANA.
-
-   To: iana@iana.org
-   Subject: Registration of new Sieve extension
-
-   Capability name:
-   Capability keyword:
-   Capability arguments:
-   Standards Track/IESG-approved experimental RFC number:
-   Person and email address to contact for further information:
-
-6.2.2.     Initial Capability Registrations
-
-   The following are to be added to the IANA registry for Sieve
-   extensions as the initial contents of the capability registry.
-
-   Capability name:        fileinto
-   Capability keyword:     fileinto
-   Capability arguments:   fileinto <folder: string>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-   Capability name:        reject
-   Capability keyword:     reject
-   Capability arguments:   reject <reason: string>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 28]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Capability name:        envelope
-   Capability keyword:     envelope
-   Capability arguments:
-           envelope [COMPARATOR] [ADDRESS-PART] [MATCH-TYPE]
-           <envelope-part: string-list> <key-list: string-list>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-   Capability name:        comparator-*
-   Capability keyword:
-           comparator-* (anything starting with "comparator-")
-   Capability arguments:   (none)
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028, Sieve, by reference of
-           RFC 2244, Application Configuration Access Protocol
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-6.3.     Capability Transport
-
-   As the range of mail systems that this document is intended to apply
-   to is quite varied, a method of advertising which capabilities an
-   implementation supports is difficult due to the wide range of
-   possible implementations.  Such a mechanism, however, should have
-   property that the implementation can advertise the complete set of
-   extensions that it supports.
-
-7.      Transmission
-
-   The MIME type for a Sieve script is "application/sieve".
-
-   The registration of this type for RFC 2048 requirements is as
-   follows:
-
-    Subject: Registration of MIME media type application/sieve
-
-    MIME media type name: application
-    MIME subtype name: sieve
-    Required parameters: none
-    Optional parameters: none
-    Encoding considerations: Most sieve scripts will be textual,
-       written in UTF-8.  When non-7bit characters are used,
-       quoted-printable is appropriate for transport systems
-       that require 7bit encoding.
-
-
-
-Showalter                   Standards Track                    [Page 29]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-    Security considerations: Discussed in section 10 of RFC 3028.
-    Interoperability considerations: Discussed in section 2.10.5
-       of RFC 3028.
-    Published specification: RFC 3028.
-    Applications which use this media type: sieve-enabled mail servers
-    Additional information:
-      Magic number(s):
-      File extension(s): .siv
-      Macintosh File Type Code(s):
-    Person & email address to contact for further information:
-       See the discussion list at ietf-mta-filters@imc.org.
-    Intended usage:
-       COMMON
-    Author/Change controller:
-       See Author information in RFC 3028.
-
-8.      Parsing
-
-   The Sieve grammar is separated into tokens and a separate grammar as
-   most programming languages are.
-
-8.1.     Lexical Tokens
-
-   Sieve scripts are encoded in UTF-8.  The following assumes a valid
-   UTF-8 encoding; special characters in Sieve scripts are all ASCII.
-
-   The following are tokens in Sieve:
-
-           - identifiers
-           - tags
-           - numbers
-           - quoted strings
-           - multi-line strings
-           - other separators
-
-   Blanks, horizontal tabs, CRLFs, and comments ("white space") are
-   ignored except as they separate tokens.  Some white space is required
-   to separate otherwise adjacent tokens and in specific places in the
-   multi-line strings.
-
-   The other separators are single individual characters, and are
-   mentioned explicitly in the grammar.
-
-   The lexical structure of sieve is defined in the following BNF (as
-   described in [ABNF]):
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 30]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   bracket-comment = "/*" *(CHAR-NOT-STAR / ("*" CHAR-NOT-SLASH)) "*/"
-           ;; No */ allowed inside a comment.
-           ;; (No * is allowed unless it is the last character,
-           ;; or unless it is followed by a character that isn't a
-           ;; slash.)
-
-   CHAR-NOT-DOT = (%x01-09 / %x0b-0c / %x0e-2d / %x2f-ff)
-           ;; no dots, no CRLFs
-
-   CHAR-NOT-CRLF = (%x01-09 / %x0b-0c / %x0e-ff)
-
-   CHAR-NOT-SLASH = (%x00-57 / %x58-ff)
-
-   CHAR-NOT-STAR = (%x00-51 / %x53-ff)
-
-   comment = bracket-comment / hash-comment
-
-   hash-comment = ( "#" *CHAR-NOT-CRLF CRLF )
-
-   identifier = (ALPHA / "_") *(ALPHA DIGIT "_")
-
-   tag = ":" identifier
-
-   number = 1*DIGIT [QUANTIFIER]
-
-   QUANTIFIER = "K" / "M" / "G"
-
-   quoted-string = DQUOTE *CHAR DQUOTE
-           ;; in general, \ CHAR inside a string maps to CHAR
-           ;; so \" maps to " and \\ maps to \
-           ;; note that newlines and other characters are all allowed
-           ;; strings
-
-   multi-line          = "text:" *(SP / HTAB) (hash-comment / CRLF)
-                         *(multi-line-literal / multi-line-dotstuff)
-                         "." CRLF
-   multi-line-literal  = [CHAR-NOT-DOT *CHAR-NOT-CRLF] CRLF
-   multi-line-dotstuff = "." 1*CHAR-NOT-CRLF CRLF
-           ;; A line containing only "." ends the multi-line.
-           ;; Remove a leading '.' if followed by another '.'.
-
-   white-space = 1*(SP / CRLF / HTAB) / comment
-
-8.2.     Grammar
-
-   The following is the grammar of Sieve after it has been lexically
-   interpreted.  No white space or comments appear below.  The start
-   symbol is "start".
-
-
-
-Showalter                   Standards Track                    [Page 31]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   argument = string-list / number / tag
-
-   arguments = *argument [test / test-list]
-
-   block = "{" commands "}"
-
-   command = identifier arguments ( ";" / block )
-
-   commands = *command
-
-   start = commands
-
-   string = quoted-string / multi-line
-
-   string-list = "[" string *("," string) "]" / string         ;; if
-   there is only a single string, the brackets are optional
-
-   test = identifier arguments
-
-   test-list = "(" test *("," test) ")"
-
-9.      Extended Example
-
-   The following is an extended example of a Sieve script.  Note that it
-   does not make use of the implicit keep.
-
-    #
-    # Example Sieve Filter
-    # Declare any optional features or extension used by the script
-    #
-    require ["fileinto", "reject"];
-
-    #
-    # Reject any large messages (note that the four leading dots get
-    # "stuffed" to three)
-    #
-    if size :over 1M
-            {
-            reject text:
-    Please do not send me large attachments.
-    Put your file on a server and send me the URL.
-    Thank you.
-    .... Fred
-    .
-    ;
-            stop;
-            }
-    #
-
-
-
-Showalter                   Standards Track                    [Page 32]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-    # Handle messages from known mailing lists
-    # Move messages from IETF filter discussion list to filter folder
-    #
-    if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-            {
-            fileinto "filter";  # move to "filter" folder
-            }
-    #
-    # Keep all messages to or from people in my company
-    #
-    elsif address :domain :is ["From", "To"] "example.com"
-            {
-            keep;               # keep in "In" folder
-            }
-
-    #
-    # Try and catch unsolicited email.  If a message is not to me,
-    # or it contains a subject known to be spam, file it away.
-    #
-    elsif anyof (not address :all :contains
-                   ["To", "Cc", "Bcc"] "me@example.com",
-                 header :matches "subject"
-                   ["*make*money*fast*", "*university*dipl*mas*"])
-            {
-            # If message header does not contain my address,
-            # it's from a list.
-            fileinto "spam";   # move to "spam" folder
-            }
-    else
-            {
-            # Move all other (non-company) mail to "personal"
-            # folder.
-            fileinto "personal";
-            }
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 33]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-10.     Security Considerations
-
-   Users must get their mail.  It is imperative that whatever method
-   implementations use to store the user-defined filtering scripts be
-   secure.
-
-   It is equally important that implementations sanity-check the user's
-   scripts, and not allow users to create on-demand mailbombs.  For
-   instance, an implementation that allows a user to reject or redirect
-   multiple times to a single message might also allow a user to create
-   a mailbomb triggered by mail from a specific user.  Site- or
-   implementation-defined limits on actions are useful for this.
-
-   Several commands, such as "discard", "redirect", and "fileinto" allow
-   for actions to be taken that are potentially very dangerous.
-
-   Implementations SHOULD take measures to prevent languages from
-   looping.
-
-11.     Acknowledgments
-
-   I am very thankful to Chris Newman for his support and his ABNF
-   syntax checker, to John Myers and Steve Hole for outlining the
-   requirements for the original drafts, to Larry Greenfield for nagging
-   me about the grammar and finally fixing it, to Greg Sereda for
-   repeatedly fixing and providing examples, to Ned Freed for fixing
-   everything else, to Rob Earhart for an early implementation and a
-   great deal of help, and to Randall Gellens for endless amounts of
-   proofreading.  I am grateful to Carnegie Mellon University where most
-   of the work on this document was done.  I am also indebted to all of
-   the readers of the ietf-mta-filters@imc.org mailing list.
-
-12.     Author's Address
-
-   Tim Showalter
-   Mirapoint, Inc.
-   909 Hermosa Court
-   Sunnyvale, CA 94085
-
-   EMail: tjs@mirapoint.com
-
-13.  References
-
-   [ABNF]      Crocker, D. and P. Overell, "Augmented BNF for Syntax
-               Specifications: ABNF", RFC 2234, November 1997.
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 34]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   [ACAP]      Newman, C. and J. G. Myers, "ACAP -- Application
-               Configuration Access Protocol", RFC 2244, November 1997.
-
-   [BINARY-SI] "Standard IEC 60027-2: Letter symbols to be used in
-               electrical technology - Part 2: Telecommunications and
-               electronics", January 1999.
-
-   [DSN]       Moore, K. and G. Vaudreuil, "An Extensible Message Format
-               for Delivery Status Notifications", RFC 1894, January
-               1996.
-
-   [FLAMES]    Borenstein, N, and C. Thyberg, "Power, Ease of Use, and
-               Cooperative Work in a Practical Multimedia Message
-               System", Int. J.  of Man-Machine Studies, April, 1991.
-               Reprinted in Computer-Supported Cooperative Work and
-               Groupware, Saul Greenberg, editor, Harcourt Brace
-               Jovanovich, 1991.  Reprinted in Readings in Groupware and
-               Computer-Supported Cooperative Work, Ronald Baecker,
-               editor, Morgan Kaufmann, 1993.
-
-   [KEYWORDS]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", BCP 14, RFC 2119, March 1997.
-
-   [IMAP]      Crispin, M., "Internet Message Access Protocol - version
-               4rev1", RFC 2060, December 1996.
-
-   [IMAIL]     Crocker, D., "Standard for the Format of ARPA Internet
-               Text Messages", STD 11, RFC 822, August 1982.
-
-   [MIME]      Freed, N. and N. Borenstein, "Multipurpose Internet Mail
-               Extensions (MIME) Part One: Format of Internet Message
-               Bodies", RFC 2045, November 1996.
-
-   [MDN]       Fajman, R., "An Extensible Message Format for Message
-               Disposition Notifications", RFC 2298, March 1998.
-
-   [RFC1123]   Braden, R., "Requirements for Internet Hosts --
-               Application and Support", STD 3, RFC 1123, November 1989.
-
-   [SMTP]      Postel, J., "Simple Mail Transfer Protocol", STD 10, RFC
-               821, August 1982.
-
-   [UTF-8]     Yergeau, F., "UTF-8, a transformation format of Unicode
-               and ISO 10646", RFC 2044, October 1996.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 35]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-14. Full Copyright Statement
-
-   Copyright (C) The Internet Society (2001).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 36]
-
+http://ktown.kde.org/~dirk/sieve/rfc3028.txt
Index: kioslaves/sieve/draft-degener-sieve-copy.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-copy.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-degener-sieve-copy.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,176 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: October 2003                                          April 2003
-
-
-                      Sieve -- "copy" extension
-		  <draft-degener-sieve-copy-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines a new keyword parameter, ":copy", to
-   be used with the sieve "fileinto" and "redirect" actions.
-   The new parameter prevents cancellation of the implicit keep.
-
-
-1. Introduction
-
-   Some users have the notion of forwarding a copy of a message
-   for safekeeping to another e-mail address, or of saving a copy
-   in a folder -- in addition to the regular message delivery,
-   which shouldn't be affected by the copy.
-
-   If saving an extra copy is all the user wanted to do, 
-   
-   	fileinto "unfiltered";
-	keep;
-
-   would do the job.  But the explicit "keep" is a poor substitute
-   for the implicit keep when more processing follows:
-
-   	fileinto "unfiltered";
-	keep;
-
-	if header "Subject" "MAKE MONEY FAST!!!"
-	{
-		discard;
-	}
-
-   In this example, the "discard" is ineffective against the
-   explicit "keep"; the discarded message still ends up in
-   the user's inbox.
-
-   It is possibly to generate sieve code that perfectly
-   expresses a user's wishes, but such code quickly grows
-   unwieldy because it needs to keep track of the state
-   the implicit keep would have had without the fileinto
-   or redirect command.
-
-   This extension tries to make life easier for user interface
-   designers and script writers by allowing them to express
-   the "copy" semantics directly.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "copy".
-
-
-3. ":copy" extension to the "fileinto" and "redirect" command.
-
-   Syntax:
-   	"fileinto" [:copy] <folder: string>
-   	"redirect" [:copy] <folder: string>
-
-   If the optional :copy keyword is specified with "fileinto"
-   or "redirect", the tagged command does not cancel the
-   implicit keep.  Instead, it merely files or redirects a
-   copy in addition to whatever else is happening to the
-   message.
-
-
-4. Security Considerations
-
-   The "copy" extension makes it easier to eavesdrop on a user's
-   message stream without the user noticing.
-
-
-5. Acknowledgments
-
-   Thanks to Eric Allman, Will Lee, and Rand Wacker for
-   corrections and comments.
-
-
-6. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-7. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-
-Appendices
-
-Appendix A.  References
-
-   [KEYWORDS] 	Bradner, S., "Key words for use in RFCs to Indicate
-   		Requirement Levels", RFC 2119, March 1997.
-
-   [SIEVE] 	Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-		January 2001.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-copy.txt
Index: kioslaves/sieve/draft-degener-sieve-body-00.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-body-00.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-degener-sieve-body-00.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,323 +1 @@
-
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: December 2002                                          June 2002
-
-
-                      Sieve -- "body" extension
-		  <draft-degener-sieve-body-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines a new primitive for the "sieve" language
-   that tests for the occurrence of one or more strings in the body
-   of an e-mail message.
-
-
-1. Introduction
-
-   The proposed "body" test checks for the occurrence of one
-   or more strings in the body of an e-mail message.
-   Such a test was initially discussed for the [SIEVE] base
-   document, but was subsequently removed because it was
-   thought to be too costly to implement.
-
-   Nevertheless, several server vendors have implemented
-   some form of the "body" test.
-
-   This document reintroduces the "body" test as an extension,
-   and specifies it syntax and semantics.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "body".
-
-
-3. Test body
-
-   Syntax:
-   	"body" [COMPARATOR] [MATCH-TYPE] [BODY-TRANSFORM]
-   		<key-list: string-list>
-
-   The body test matches text in the body of an e-mail message,
-   that is, anything following the first empty line after the header.
-   (The empty line itself, if present, is not considered to be part
-   of the body.)
-
-   The COMPARATOR and MATCH-TYPE keyword parameters are defined
-   in [SIEVE].  The BODY-TRANSFORM is a keyword parameter
-   discussed in section 4, below.
-
-   If a message consists of a header only, not followed by an empty
-   line, all "body" tests fail, including that for an empty string.
-
-   If a message consists of a header followed only by an empty
-   line with no body lines following it, the message is considered
-   to have an empty string as a body.
-
-
-4. Body Transform
-
-   Prior to matching text in a message body, "transformations"
-   can be applied that filter and decode certain parts of the body.
-   These transformations are selected by a "BODY-TRANSFORM"
-   keyword parameter.
-
-   Syntax:
-   	  ":raw"
-	/ ":content" <content-types: string-list>
-	/ ":text"
-
-
-4.1 Body Transform ":raw"
-
-   The ":raw" transform is intended to match against the undecoded
-   body of a message.
-
-   If the specified body-transform is ":raw", the MIME structure of
-   the body is irrelevant.  The implementation MUST NOT remove any
-   transfer encoding from the message, MUST NOT refuse to filter
-   messages with syntactic errors (unless the environment it is part
-   of rejects them outright), and MUST NOT interpret or skip MIME
-   headers of enclosed body parts.
-
-   Example:
-
-   	require "body";
-
-	# This will match a message containing the words "MAKE MONEY FAST"
-	# in body or MIME headers other than the outermost RFC 822 header,
-	# but will not match a message containing the words in a
-	# content-transfer-encoded body.
-
-	if body :raw :contains "MAKE MONEY FAST" {
-		reject;
-	}
-
-
-
-4.2 Body Transform ":content_type"
-
-   If the body transform is ":content_type", only MIME parts that have
-   the specified content-types are selected for matching.
-
-   If an individual content type contains a '/' (slash), it
-   specifies a full <type>/<subtype> pair, and matches only
-   that specific content type.  Otherwise, it specifies a
-   <type> only, and any subtype matches it.
-
-   The search for MIME parts is recursive and automatically
-   descends into multipart and message MIME parts.
-
-   MIME parts encoded in a content transfer encoding must be decoded,
-   and text MIME parts in charsets other than UTF-8 MUST be converted
-   to UTF-8 prior to the match.
-
-   Search expressions MUST NOT match across MIME part boundaries.
-   MIME headers of the containing text MUST NOT be included in the
-   data.
-
-   Example:
-   	require ["body", "fileinto"];
-
-	# Save any message with any text MIME part that contains the
-	# worlds "missile" or "coordinates" in the "secrets" folder. 
-	
-	if body :content_type "text" :contains ["missile", "coordinates"] {
-		fileinto "secrets";
-	}
-
-	# Save any message with an audio/mp3 MIME part in
-	# the "jukebox" folder.
-
-	if body :content_type "audio/mp3" :contains "" {
-		fileinto "jukebox";
-	}
-
-
-4.3 Body Transform ":text"
-
-   The ":text" body transform matches against the results of 
-   an implementation's best effort at extracting text from a message.
-
-   In simple implementations, :text MAY be a macro that stands
-   for :content_type "text".
-
-   Sophisticated implementations MAY strip mark-up from the text
-   prior to matching, and MAY convert media types other than text
-   to text prior to matching.
-   
-   (For example, they may be able to convert proprietary text
-   editor formats to text or apply optical character recognition
-   algorithms to image data.)
-
-
-5. Interaction with Other Sieve Extensions
-
-   Any extension that extends the grammar for the COMPARATOR or
-   MATCH-TYPE nonterminals will also affect the implementation of
-   "body".
-   
-   The [REGEX] extension can place a considerable load on a system
-   when applied to whole bodies of messages, especially when
-   implemented naively or used maliciously.
-
-
-6. Security Considerations
-
-   The system MUST be sized and restricted in such a manner that
-   even malicious use of body matching does not deny service to
-   other users of the host system.
-
-   Filters relying on string matches in the raw body of an e-mail
-   message may be more general than intended.  Text matches are no
-   replacement for a virus or spam filtering system.
-
-
-7. Acknowledgments
-
-   This document has been revised in part based on comments and
-   discussions that took place on and off the SIEVE mailing list.
-   Thanks to Cyrus Daboo, Simon Josefsson, Chris Markle, Greg Shapiro,
-   Tim Showalter, Nigel Swinson, and Dowson Tong for taking the time
-   to review this draft and make suggestions.
-
-
-8. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-9. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-9.1 Consensus
- 
-   A "body" operation is being used for mail filtering.
-   Some systems implement it in something similar to sieve,
-   some systems implement a body or x_body operations within sieve.
-
-   The implementations do not process the body contents.
-   They do not strip content-transfer encodings and do not convert
-   text to UTF-8 prior to comparison.
-
-   There is a strong feeling that this behavior is unworthy of
-   standardization, that body is a "valuable piece of real-estate"
-   that one should get right, and that users will expect a "body"
-   test to at least be capable of reaching inside encodings.
-
-
-9.2 Open Issues
-
-9.2.1 Body Transformations
-
-   This document names three possible transformations
-   (one of which, ":raw", does nothing) to apply to the
-   body before matching.  Are there important others that
-   are missing?  Are three too many?  Which ones should
-   be dropped?
-
-
-9.2.2 Default Transformation
-
-   If none of the transformations is specified, what should
-   be the default?  Should there be a default, or should it
-   be an error?
-
-   I'd like there to be a default, so that existing scripts
-   that use an undocumented "body" extensions just work.
-
-   The default should probably be :raw or :text.
-   It should be ":raw", because that's what current implementations do.
-   It should be ":text", because that's what we believe users expect.
-
-   I'd like this to be implementation-defined, allowing for a
-   gradual migration from the current behavior to something closer
-   to user expectations.
-
-
-Appendices
-
-Appendix A.  References
-
-   [SIEVE] Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-   January 2001.
-
-   [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-   Requirement Levels", RFC 2119, March 1997.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-body-00.txt
Index: kioslaves/sieve/draft-daboo-sieve-spamtest.txt
===================================================================
--- kioslaves/sieve/draft-daboo-sieve-spamtest.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-daboo-sieve-spamtest.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,514 +1 @@
-Network Working Group                                          C. Daboo
-Internet Draft: SIEVE Spamtest and Virustest Extensions
-Document: draft-daboo-sieve-spamtest-04.txt                October 2003
-
-                SIEVE Spamtest and Virustest Extensions
-    
-Status of this Memo
-    
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.
-    
-    Internet-Drafts are working documents of the Internet Engineering
-    Task Force (IETF), its areas, and its working groups.  Note that
-    other groups may also distribute working documents as
-    Internet-Drafts.
-    
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet-Drafts as
-    reference material or to cite them other than as "work in progress."
-    
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt.
-    
-    The list of Internet- Draft Shadow Directories can be accessed at
-    http://www.ietf.org/shadow.html.
-    
-    
-Copyright Notice
-    
-     Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 1]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-Abstract
-    
-    The SIEVE mail filtering language [SIEVE] "spamtest" and "virustest"
-    extensions permit users to use simple, portable commands for spam
-    and virus tests on email messages.  Each extension provides a new
-    test using matches against numeric 'scores'.  It is the
-    responsibility of the underlying SIEVE implementation to do the
-    actual checks that result in values returned by the tests.
-    
-Change History (to be removed prior to publication as an RFC)
-    
-    Changes from -03 to -04:
-    1   Added IPR boiler plate.
-    2   Re-ordered sections at start to conform to RFC style.
-    3   Eliminated the use of "NIL" for untested value.
-    4   Expanded virus test ranges to indicate additional state.
-    5   Added security consideration requiring admins to keep virus
-        tools up to date
-        
-    Changes from -02 to -03:
-    1   Changed test values to be arbitrary strings with numeric value
-        as first token.
-    2   Changed 'virii' to 'viruses'.
-        
-    Changes from -01 to -02:
-    1   Fixed syntax in examples.
-    2   Updated references section to normative/informative.
-        
-    Changes from -00 to -01:
-    1   Changed so that tests use standard SIEVE syntax.
-    2   Added requirement for relation extension for numeric
-        comparisons.
-    3   Changed spamtest numeric range to 0->10.
-        
-        
-Table of Contents
-        
-     1  Introduction and Overview . . . . . . . . . . . . . . . . . .  3
-     2  Conventions Used in This Document  . . . . . . . . . . . . . . 3
-     3  SIEVE Extensions  . . . . . . . . . . . . . . . . . . . . . .  4
-       3.1  General Considerations . . . . . . . . . . . . . . . . . . 4
-       3.2  Test spamtest . . . . . . . . . . . . . . . . . . . . . .  4
-       3.3  Test virustest . . . . . . . . . . . . . . . . . . . . . . 5
-     4  Security Considerations . . . . . . . . . . . . . . . . . . .  6
-     5  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 6
-       5.1  spamtest registration . . . . . . . . . . . . . . . . . .  7
-       5.2  virustest registration . . . . . . . . . . . . . . . . . . 7
-     6  References  . . . . . . . . . . . . . . . . . . . . . . . . .  7
-       6.1  Normative References . . . . . . . . . . . . . . . . . . . 7
-       6.2  Non-Normative References  . . . . . . . . . . . . . . . .  8
-     7  Acknowledgments  . . . . . . . . . . . . . . . . . . . . . . . 8
-     8  Author's Address  . . . . . . . . . . . . . . . . . . . . . .  8
-
-
-Daboo                    Expires April 2004                    [Page 2]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-     9  Intellectual Property Rights Statement . . . . . . . . . . . . 8
-    10  Full Copyright Statement  . . . . . . . . . . . . . . . . . .  8
-        
-        
-1 Introduction and Overview
-    
-    SIEVE scripts are frequently being used to do spam and virus
-    filtering based on either implicit script tests (e.g. tests for
-    'black-listed' senders directly encoded in the SIEVE script), or via
-    testing messages modified by some external spam or virus checker
-    that handled the message prior to SIEVE.  The use of third-party
-    spam and virus checker tools poses a problem since each tool has its
-    own way of indicating the result of its checks.  These usually take
-    the form of a header added to the message, the content of which
-    indicates the status using some syntax defined by the particular
-    tool.  Each user has to then create their own SIEVE scripts to match
-    the contents of these headers to do filtering.  This requires the
-    script to stay in synchronisation with the third party tool as it
-    gets updated or perhaps replaced with another.  Thus scripts become
-    tied to specific environments, and lose portability.
-    
-    The purpose of this document is to introduce two SIEVE tests that
-    can be used to implement 'generic' tests for spam and viruses in
-    messages processed via SIEVE scripts.  These tests return a string
-    containing a range of numeric values that indicate the severity of
-    spam or viruses in a message, or a string that indicates the message
-    has not passed through any spam or virus checking tools.  The spam
-    and virus checks themselves are handled by the underlying SIEVE
-    implementation in whatever manner is appropriate, and the
-    implementation maps the results of these checks into the numeric
-    ranges defined by the new tests.  Thus a SIEVE implementation can
-    have a spam test that implicitly checks for third-party spam tool
-    headers and determines how those map into the spamtest numeric
-    range.
-    
-    In order to do numeric comparisons against the returned strings,
-    server implementations MUST also support the SIEVE relational
-    [RELATIONAL] extension, in addition to the extensions described
-    here.  All examples below assume the relational extension is
-    present.
-    
-    
-2 Conventions Used in This Document
-    
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-    
-    The term 'spam' is used in this document to refer to unsolicited or
-    unwanted email messages.  This document does not attempt to define
-    what exactly constitutes spam, or how it should be identified, or
-    what actions should be taken when detected.
-    
-
-
-Daboo                    Expires April 2004                    [Page 3]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    The term 'virus' is used in this document to refer to any type of
-    message whose content can cause malicious damage.  This document
-    does not attempt to define what exactly constitutes a virus, or how
-    it should be identified, or what actions should be taken when
-    detected.
-    
-    
-3 SIEVE Extensions
-    
-3.1 General Considerations
-    
-    The "spamtest" and "virustest" tests described below both return a
-    string that starts with a numeric value, followed by an optional
-    space (%x20) character and optional arbitrary text.  The numeric
-    value can be compared to specific values using the SIEVE relational
-    [RELATIONAL] extension in conjunction with the "i;ascii-numeric"
-    comparator [ACAP], which will test for the presence of a numeric
-    value at the start of the string, ignoring any additional text in
-    the string.  The additional text can be used to carry implementation
-    specific details about the tests performed and descriptive comments
-    about the result.  Tests can be done using standard string
-    comparators against this text if it helps to refine behaviour,
-    however this will break portability of the script as the text will
-    likely be specific to a particular implementation.
-    
-3.2 Test spamtest
-    
-        Syntax: spamtest [COMPARATOR] [MATCH-TYPE] <value: string>
-    
-    SIEVE implementations that implement the "spamtest" test have an
-    identifier of "spamtest" for use with the capability mechanism.
-    
-    The "spamtest" test evaluates to true if the spamtest result matches
-    the value.  The type of match is specified by the optional match
-    argument, which defaults to ":is" if not specified.
-    
-    The spamtest result is a string starting with a numeric value in the
-    range "0" (zero) through "10", with meanings summarised below:
-    
-        spamtest    interpretation
-        value
-
-		 0          message was not tested for spam
-		 1          message was tested and is clear of spam
-		 2 - 9      message was tested and has a varying likelihood of
-		            containing spam in increasing order
-		 10         message was tested and definitely contains spam
-    
-    The underlying SIEVE implementation will map whatever spam check is
-    done into this numeric range, as appropriate.
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 4]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    Examples:
-    
-        require ["spamtest", "fileinto",
-                 "relational", "comparator-i;ascii-numeric"];
-
-        if spamtest :value "eq" :comparator "i;ascii-numeric" "0"
-        {
-            fileinto "INBOX.unclassified";
-        }
-        elsif spamtest :value "ge" :comparator "i;ascii-numeric" "3"
-        {
-            fileinto "INBOX.spam-trap";
-        }
-    
-    In this example, any message that has not passed through a spam
-    check tool will be filed into the mailbox "INBOX.unclassified".  Any
-    message with a spamtest value greater than or equal to "3" is filed
-    into a mailbox called "INBOX.spam-trap" in the user's mailstore.
-    
-3.3 Test virustest
-    
-        Syntax: virustest [COMPARATOR] [MATCH-TYPE] <value: string>
-    
-    SIEVE implementations that implement the "virustest" test have an
-    identifier of "virustest" for use with the capability mechanism.
-    
-    The "virustest" test evaluates to true if the virustest result
-    matches the value.  The type of match is specified by the optional
-    match argument, which defaults to ":is" if not specified.
-    
-    The virustest result is a string starting with a numeric value in
-    the range "0" (zero) through "5", with meanings summarised below:
-    
-        virustest   interpretation
-        value
-
-		 0          message was not tested for viruses
-		 1          message was tested and contains no known viruses
-		 2          message was tested and contained a known virus which
-		            was replaced with harmless content
-		 3          message was tested and contained a known virus which
-		            was "cured" such that it is now harmless
-		 4          message was tested and possibly contains a known virus
-		 5          message was tested and definately contains a known virus
-    
-    The underlying SIEVE implementation will map whatever virus checks
-    are done into this numeric range, as appropriate.  If the message
-    has not been categorised by any virus checking tools, then the
-    virustest result is "0".
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 5]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    Example:
-    
-	    require ["virustest", "fileinto",
-	             "relational", "comparator-i;ascii-numeric"];
-
-	    if virustest :value "eq" :comparator "i;ascii-numeric" "0"
-	    {
-	        fileinto "INBOX.unclassified";
-	    }
-	    if virustest :value "eq" :comparator "i;ascii-numeric" "4"
-	    {
-	        fileinto "INBOX.quarantine";
-    	}
-	    elsif virustest :value "eq" :comparator "i;ascii-numeric" "5"
-	    {
-	        discard;
-	    }
-    
-    In this example, any message that has not passed through a virus
-    check tool will be filed into the mailbox "INBOX.unclassified".  Any
-    message with a virustest value equal to "4" is filed into a mailbox
-    called "INBOX.quarantine" in the user's mailstore.  Any message with
-    a virustest value equal to "5" is discarded (removed) and not
-    delivered to the user's mailstore.
-    
-    
-4 Security Considerations
-    
-    SIEVE implementations SHOULD ensure that "spamtest" and "virustest"
-    tests can only occur for messages that have gone through a
-    legitimate spam or virus check process.  If such checks rely on the
-    addition of special headers to messages, it is the responsibility of
-    the implementation to ensure that such headers cannot be spoofed by
-    the sender, to prevent the implementation from being tricked into
-    returning the wrong result for the test.
-    
-    Server administrators MUST ensure that the virus checking tools are
-    kept up to date, to provide reasonable protection for users using
-    the "virustest" test.  Users should be made aware of the fact that
-    the "virustest" test does not provide a 100% reliable way to remove
-    all viruses, and they should continue to exercise caution when
-    dealing with messages of unknown content and origin.
-    
-    Beyond that, the "spamtest" and "virustest" extensions do not raise
-    any security considerations that are not present in the base [SIEVE]
-    protocol, and these issues are discussed in [SIEVE].
-    
-    
-5 IANA Considerations
-    
-    The following templates specify the IANA registration of the Sieve
-    extensions specified in this document:
-
-
-Daboo                    Expires April 2004                    [Page 6]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-5.1 spamtest registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: spamtest
-    Capability keyword: spamtest
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780, 
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-5.2 virustest registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: virustest
-    Capability keyword: virustest
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780, 
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-    
-6 References
-    
-6.1 Normative References
-    
-    [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-    Requirement Levels", RFC 2119, March 1997.
-    
-
-
-Daboo                    Expires April 2004                    [Page 7]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    [RELATIONAL] Segmuller, W. "Sieve Extension:  Relational Tests", RFC
-    3431, December 2002.
-    
-    [SIEVE] Showalter, "Sieve:  A Mail Filtering Language", RFC 3028,
-    January 2001.
-    
-6.2 Non-Normative References
-    
-    [ACAP] Newman, C. and J. G. Myers, "ACAP -- Application
-    Configuration Access Protocol", RFC 2244, November 1997.
-    
-    
-7 Acknowledgments
-    
-    Thanks to Tony Hansen, Jutta Degener, Ned Freed, Ashish Gawarikar
-    and Nigel Swinson for comments and corrections.
-    
-    
-8 Author's Address
-    
-    Cyrus Daboo
-    Cyrusoft International, Inc.
-    5001 Baum Blvd., Suite 780,
-    Pittsburgh, PA 15213
-    U.S.A.
-
-    <mailto:daboo@cyrusoft.com>
-    
-    
-9 Intellectual Property Rights Statement
-    
-    The IETF takes no position regarding the validity or scope of any
-    intellectual property or other rights that might be claimed to
-    pertain to the implementation or use of the technology described in
-    this document or the extent to which any license under such rights
-    might or might not be available; neither does it represent that it
-    has made any effort to identify any such rights.  Information on the
-    IETF's procedures with respect to rights in standards-track and
-    standards-related documentation can be found in BCP-11.  Copies of
-    claims of rights made available for publication and any assurances
-    of licenses to be made available, or the result of an attempt made
-    to obtain a general license or permission for the use of such
-    proprietary rights by implementors or users of this specification
-    can be obtained from the IETF Secretariat.
-    
-    
-10 Full Copyright Statement
-    
-    Copyright (C) The Internet Society 2003.  All Rights Reserved.
-    
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-
-
-Daboo                    Expires April 2004                    [Page 8]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-    
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-    
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 9]
\ brakuje znaku końca linii na końcu pliku 
+http://ktown.kde.org/~dirk/sieve/draft-daboo-sieve-spamtest.txt
Index: kioslaves/sieve/draft-martin-managesieve-04.txt
===================================================================
--- kioslaves/sieve/draft-martin-managesieve-04.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-martin-managesieve-04.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,1180 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                         Tim Martin
-Document: draft-ietf-managesieve-03.txt                   Mirapoint Inc.
-Expires January 21, 2003                                    16 July 2002
-
-
-               A Protocol for Remotely Managing Sieve Scripts
-
-                      <draft-martin-managesieve-04.txt>
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are
-    working documents of the Internet Engineering Task Force (IETF), its
-    areas, and its working groups.  Note that other groups may also
-    distribute working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet- Drafts as
-    reference material or to cite them other than as "work in progress."
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-
-Abstract
-
-    Sieve scripts allow users to filter incoming email. Message stores
-    are commonly sealed servers so users cannot log into them, yet users
-    must be able to update their scripts on them.  This document
-    describes a protocol "sieve" for securely managing Sieve scripts on
-    a remote server.  This protocol allows a user to have multiple
-    scripts, and also alerts a user to syntactically flawed scripts.
-
-    This an interim measure as it is hoped that eventually Sieve scripts
-    will be stored on ACAP. This document is intended to proceed on the
-    experimental track.
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 1]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.1.   Changes . . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.2.   Conventions Used in the Document  . . . . . . . . . . . . . .   4
-1.3.   Syntax  . . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-1.4.   Response Codes  . . . . . . . . . . . . . . . . . . . . . . .   5
-1.5.   Active Script . . . . . . . . . . . . . . . . . . . . . . . .   6
-1.6.   Quotas  . . . . . . . . . . . . . . . . . . . . . . . . . . .   7
-1.7.   Script Names  . . . . . . . . . . . . . . . . . . . . . . . .   7
-1.8.   Capabilities  . . . . . . . . . . . . . . . . . . . . . . . .   7
-
-2.     Commands  . . . . . . . . . . . . . . . . . . . . . . . . . .   8
-2.1.   AUTHENTICATE Command  . . . . . . . . . . . . . . . . . . . .   8
-2.2.   STARTTLS Command  . . . . . . . . . . . . . . . . . . . . . .  10
-2.3.   LOGOUT Command  . . . . . . . . . . . . . . . . . . . . . . .  10
-2.4.   CAPABILITY Command  . . . . . . . . . . . . . . . . . . . . .  11
-2.5.   HAVESPACE Command . . . . . . . . . . . . . . . . . . . . . .  11
-2.6.   PUTSCRIPT Command . . . . . . . . . . . . . . . . . . . . . .  11
-2.7.   LISTSCRIPTS Command . . . . . . . . . . . . . . . . . . . . .  13
-2.8.   SETACTIVE Command . . . . . . . . . . . . . . . . . . . . . .  13
-2.9.   GETSCRIPT Command . . . . . . . . . . . . . . . . . . . . . .  13
-2.10.   DELETESCRIPT Command . . . . . . . . . . . . . . . . . . . .  14
-
-3.     Sieve URL Scheme  . . . . . . . . . . . . . . . . . . . . . .  14
-
-4.     Formal Syntax . . . . . . . . . . . . . . . . . . . . . . . .  15
-
-5.     Security Considerations . . . . . . . . . . . . . . . . . . .  18
-
-6.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .  18
-
-7.     Copyright . . . . . . . . . . . . . . . . . . . . . . . . . .  18
-
-8.     References  . . . . . . . . . . . . . . . . . . . . . . . . .  19
-
-9.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .  19
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 2]
-
-Internet Draft             Managing Sieve Scripts            July 16, 2002
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 3]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-1.  Introduction
-
-
-
-1.1.  Changes
-
-    Changes since 03
-
-    -Add referals and Sieve URLs
-
-    -Lots of spelling/grammer fixes
-
-    -Don't give capabilities after successful STARTTLS. This is because
-    it isn't consistant with AUTHENTICATE. There is language specifying
-    that a client should re-issue a CAPABILITY command after
-    AUTHENTICATE/STARTTLS.
-
-    -Putting a script of length 0 doesn't remove the script. If this
-    functionality is desired, the DELETESCRIPT command should be used.
-
-    Changes since 02
-
-    -add BYE response
-
-    -typo on line 588
-
-    -allow ANONYMOUS access for sieve script verification
-
-    -updated SIEVE spec reference
-
-    Changes since 01
-
-    -changed contact info
-
-    Changes since 00
-
-    -added response codes (from ACAP)
-
-    -removed special-ok response from authenticate command (response
-    codes obsolete it)
-
-    -changed service name to "sieve"
-
-    -ABNF fixes
-
-    -Alexey's wording changes
-
-    -Eliminated lame PLAIN paragraph
-
-
-
-Expires January 21, 2003        Martin                          [Page 3]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    Changes since PRE
-
-    -dropped synchronized literals. added HAVESPACE command
-
-    -changed capability response syntax. added CAPABILITY command
-
-    -allowed pipelining
-
-    - "sieve" -> "Sieve". Other minor fixes
-
-    -made script names more flexible
-
-    -added starttls support
-
-
-
-
-1.2.  Conventions Used in the Document
-
-    The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-    "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
-    document are to be interpreted as described in [KEYWORDS].
-
-    In examples, "C:" and "S:" indicate lines sent by the client and
-    server respectively. Line breaks that do not start a new "C:" or
-    "S:" exist for editorial reasons.
-
-
-
-
-1.3.  Syntax
-
-    This a line oriented protocol much like [IMAP4rev1] or [ACAP]. There
-    are three types: ATOMS, numbers and strings. Strings may be quoted
-    or literal. See [ACAP] for detailed descriptions of these types.
-
-    Each command consists of an atom followed by zero or more strings
-    and numbers terminated by a newline.
-
-    All client queries are replied to with either an OK, NO, or BYE
-    response. Each response may be followed by a response code (see
-    response codes section) and by a string consisting of human readable
-    text in the local language. The contents of the string SHOULD be
-    shown to the user and implementations MUST NOT attempt to parse the
-    message for meaning.
-
-    The BYE command may be used if the server wishes to close the
-    connection. A server may wish to do this because the client was idle
-
-
-
-Expires January 21, 2003        Martin                          [Page 4]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    too long or there were too many failed authentication attempts. This
-    command can be issued at any time and should be immediately followed
-    by a server hang-up of the connection. If a server has a inactivity
-    timeout resulting in client autologout it MUST be no less than 30
-    minutes.
-
-    IANA registration is pending. Current implementations generally use
-    port number 2000.
-
-
-
-1.4.  Response Codes
-
-    An OK, NO, or BYE response from the server MAY contain a response
-    code to describe the event in a more detailed machine parsable
-    fashion. A response code consists of data inside parentheses in the
-    form of an atom, possibly followed by a space and arguments.
-    Response codes are defined when there is a specific action that a
-    client can take based upon the additional information. In order to
-    support future extension, the response code is represented as a
-    slash-separated hierarchy with each level of hierarchy representing
-    increasing detail about the error. Clients MUST tolerate additional
-    hierarchical response code detail which they don't understand.
-
-    The currently defined response codes are:
-
-    AUTH-TOO-WEAK
-
-    This response code is returned on a tagged NO result from an
-    AUTHENTICATE command. It indicates that site security policy forbids
-    the use of the requested mechanism for the specified authentication
-    identity.
-
-    ENCRYPT-NEEDED
-
-    This response code is returned on NO result from an AUTHENTICATE
-    command. It indicates that site security policy requires the use of
-    a strong encryption mechanism for the specified authentication
-    identity and mechanism.
-
-    QUOTA
-
-    The command would have placed the user above the site-defined quota
-    constraints.
-
-    REFERRAL
-
-    This response code may be returned with a BYE result from any
-
-
-
-Expires January 21, 2003        Martin                          [Page 5]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    command, and includes a mandatory parameter that indicates what
-    server to access to manage this user's sieve scripts.  The server
-    will be specified by a Sieve URL (see "Sieve URL Scheme" section).
-    The scriptname portion of the URL MUST NOT be specified. The client
-    should authenticate to the specified server and use it for all
-    further commands in the current session.
-
-    SASL
-
-    This response code can occur in the OK response to a successful
-    AUTHENTICATE command and includes the optional final server response
-    data from the server as specified by [SASL].
-
-    TRANSITION-NEEDED
-
-    This response code occurs on a NO response to an AUTHENTICATE
-    command. It indicates that the user name is valid, but the entry in
-    the authentication database needs to be updated in order to permit
-    authentication with the specified mechanism. This can happen if a
-    user has an entry in a system authentication database such as Unix
-    /etc/passwd, but does not have credentials suitable for use by the
-    specified mechanism.
-
-
-    TRYLATER
-
-    A command failed due to a temporary server failure. The client MAY
-    continue using local information and try the command later.
-
-    Client implementations MUST tolerate response codes that they do not
-    recognize.
-
-
-
-1.5.  Active Script
-
-    A user may have multiple Sieve scripts on the server, yet only one
-    script may be used for filtering of incoming messages. This is the
-    active script. Users may have zero or one active scripts and MUST
-    use the SETACTIVE command described below for changing the active
-    script or disabling Sieve processing. For example, a user may have
-    an everyday script they normally use and a special script they use
-    when they go on vacation. Users can change which script is being
-    used without having to download and upload a script stored somewhere
-    else.
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 6]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-1.6.  Quotas
-
-    Servers SHOULD impose quotas to prevent malicious users from
-    overflowing available storage. If a command would place a user over
-    a quota setting, servers MUST reply with a NO response. Client
-    implementations MUST be able to handle commands failing because of
-    quota restrictions.
-
-
-
-1.7.  Script Names
-
-    Sieve script names may contain any valid UTF8 characters, but names
-    must be at least one octet long. Script names zero octets in length
-    have special meaning. (see SETACTIVE command section) Servers MUST
-    allow names of up to 128 UTF8 octets in length, and may allow longer
-    names.
-
-
-
-1.8.  Capabilities
-
-    Server capabilities are sent by the server upon a client connection.
-    Clients may request the capabilities at a later time by issuing the
-    CAPABILITY command described later. The capabilities consist of a
-    series of lines each with one or two strings. The first string is
-    the name of the capability. The second optional string is the value
-    associated with that capability.
-
-    The following capabilities are defined here:
-
-    IMPLEMENTATION - Name of implementation and version
-
-    SASL - List of SASL mechanisms supported by the server, each
-    separated by a space
-
-    SIEVE - List of space separated Sieve extensions supported
-
-    STARTTLS - If TLS[TLS] is supported by this implementation
-
-    A client implementation MUST ignore any other capabilities given
-    that it does not understand.
-
-    Example:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-
-
-
-Expires January 21, 2003        Martin                          [Page 7]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    S: "STARTTLS"
-    S: OK
-
-
-
-2.  Commands
-
-    The following commands are valid. Prior to successful authentication
-    only the AUTHENTICATE, CAPABILITY, STARTTLS, and LOGOUT commands are
-    valid. Servers MUST reject all other commands with a NO response.
-    Clients may pipeline commands (send more than one command at a time
-    without waiting for completion of the first command ). However, a
-    group of commands sent together MUST NOT have a HAVESPACE command
-    anywhere but the last command in the list.
-
-
-
-2.1.  AUTHENTICATE Command
-
-    Arguments:
-         String - mechanism
-         String - initial data (optional)
-
-    The AUTHENTICATE command indicates a SASL [SASL] authentication
-    mechanism to the server.  If the server supports the requested
-    authentication mechanism, it performs an authentication protocol
-    exchange to authenticate and identify the user.  Optionally, it also
-    negotiates a security layer for subsequent protocol interactions.
-    If the requested authentication mechanism is not supported, the
-    server rejects the AUTHENTICATE command by sending a NO response.
-
-    The authentication protocol exchange consists of a series of server
-    challenges and client answers that are specific to the
-    authentication mechanism.  A server challenge consists of a string
-    followed by an endline. The contents of the string is a base-64
-    encoding of the SASL data. The client answer consists of a string
-    with the base-64 encoding of the SASL data followed by an endline.
-    If the mechanism dictates that the final response be sent by the
-    server this data MAY be placed within the data portion of the SASL
-    response code to save a round trip.
-
-    The optional initial-response argument to the AUTHENTICATE command
-    is used to save a round trip when using authentication mechanisms
-    that are defined to send no data in the initial challenge.  When the
-    initial-response argument is used with such a mechanism, the initial
-    empty challenge is not sent to the client and the server uses the
-    data in the initial-response argument as if it were sent in response
-    to the empty challenge.  If the initial-response argument to the
-
-
-
-Expires January 21, 2003        Martin                          [Page 8]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    AUTHENTICATE command is used with a mechanism that sends data in the
-    initial challenge, the server rejects the AUTHENTICATE command by
-    sending a tagged NO response.
-
-    The service name specified by this protocol's profile of SASL is
-    "sieve"
-
-    If a security layer is negotiated through the SASL authentication
-    exchange, it takes effect immediately following the CRLF that
-    concludes the authentication exchange for the client, and the CRLF
-    of the OK response for the server.
-
-    Implementations MAY advertise the ANONYMOUS SASL mechanism [SASL-
-    ANON]. This indicates that the server supports ANONYMOUS sieve
-    script syntax verification. Only the CAPABILITY, PUTSCRIPT and
-    LOGOUT commands are available to the anonymous user. All other
-    commands MUST give NO responses. Furthermore the PUTSCRIPT command
-    SHOULD NOT store any data. In this mode a positive response to the
-    PUTSCRIPT command indicates that the given script does not have any
-    syntax errors.
-
-    Server implementations SHOULD support authorization so that an
-    administrator can administer a user's scripts. Authorization is when
-    a user authenticates as himself but logs in as another user.
-
-    If an AUTHENTICATE command fails with a NO response, the client may
-    try another authentication mechanism by issuing another AUTHENTICATE
-    command.  In other words, the client may request authentication
-    types in decreasing order of preference.
-
-
-
-    Examples:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-    S: "STARTTLS"
-    S: OK
-    C: Authenticate "KERBEROS_V4"
-    S: "6UM4Ig=="
-    C: "BAYBQU5EUkVXLkNNVS5FRFUAOCjDCH77GOzSSOF1Df2Kb0zzPe
-    QJIrweAPyo6Q1T9xuYtCGylDqRYlbUFa77esDOtBJdDE5qRXcwHXQE5Dg
-    amqj0LqecZtKUCc8g2xpcqxn1fc/CH6QdZLOAGVpHTN1AX2Y="
-    S: "cmnEYo1x6wc="
-    C: "kjuaMkUeg2okQh+we2uiJw=="
-    S: OK
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 9]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    C: Authenticate "PLAIN" "QJIrweAPyo6Q1T9xu"
-    S: BYE "Too many failed authentication attempts"
-    Server closes connection
-
-
-
-2.2.  STARTTLS Command
-
-    The STARTTLS command requests to commencement of a TLS negotiation.
-    The negotiation begins immediately after the CRLF in the OK
-    response. After a client issues a STARTTLS command, it MUST NOT
-    issue further commands until a server response is seen and the TLS
-    negotiation is complete.
-
-     The STARTTLS command is only valid in non-authenticated state. The
-    server remains in non-authenticated state, even if client
-    credentials are supplied during the TLS negotiation. The SASL [SASL]
-    EXTERNAL mechanism MAY be used to authenticate once TLS clie nt
-    credentials are successfully exchanged, but servers supporting the
-    STARTTLS command are not required to support the EXTERNAL mechanism.
-
-    After the TLS layer is established, the server MUST re-issue the
-    capability results. This is necessary to protect against man-in-the-
-    middle attacks which alter the capabilities list prior to STARTTLS.
-    The client MUST discard cached capability information and replace it
-    with the new information. The server MAY advertise different
-    capabilities after STARTTLS.
-
-    Example:
-
-    C: STARTTLS
-    S: OK
-    <TLS negotiation, further commands are under TLS layer>
-
-
-
-2.3.  LOGOUT Command
-
-    The client sends the LOGOUT command when it is finished with a
-    connection and wishes to terminate it. The server MUST reply with an
-    OK response and terminate the connection. The server MUST ignore
-    commands issued by the client after the LOGOUT command.
-
-    Example:
-
-    C: Logout
-    S: OK
-    <connection terminated>
-
-
-
-Expires January 21, 2003        Martin                         [Page 10]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-2.4.  CAPABILITY Command
-
-    The CAPABILITY command requests the server capabilities as described
-    earlier in this document. While the capabilities are sent upon
-    connection, they may change during authentication. The client SHOULD
-    issue a CAPABILITY command after successful authentication or after
-    negotiating a security layer using STARTTLS.
-
-
-    Example:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "PLAIN KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-    S: "STARTTLS"
-    S: OK
-
-
-
-
-2.5.  HAVESPACE Command
-
-    Arguments:
-         String - name
-         Number - size
-
-    The HAVESPACE command is used to query the server for available
-    space. Clients specify the name they wish to save the script as and
-    it's size in octets. Servers respond with an NO if storing a script
-    with that name and size would fail or OK otherwise. Clients should
-    issue this command before attempting to place a script on the
-    server.
-
-    Example:
-
-    C: HAVESPACE "myscript" 999999
-    S: NO "Quota exceeded"
-
-    C: HAVESPACE "foobar" 435
-    S: OK
-
-
-
-
-2.6.  PUTSCRIPT Command
-
-    Arguments:
-         String - Script name
-
-
-
-Expires January 21, 2003        Martin                         [Page 11]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-         String - Script content
-
-    The PUTSCRIPT command is used by the client to submit a Sieve script
-    to the server.
-
-    If the script already exists upon success the old script will be
-    overwritten. The old script MUST NOT be overwritten if PUTSCRIPT
-    fails in any way. A script of zero length SHOULD be disallowed.
-
-    This command places the script on the server. It does not affect
-    whether the script is processed on incoming mail. The SETACTIVE
-    command is used to mark a script as active.
-
-    When submitting large scripts clients SHOULD use the HAVESPACE
-    command beforehand to query if the server is willing to accept a
-    script of that size.
-
-    The server MUST check the submitted script for syntactic validity.
-    If the script fails this test the server MUST reply with a NO
-    response. Any script that fails the validity test MUST NOT be stored
-    on the server. The message given with a NO response MUST be human
-    readable and SHOULD contain a specific error message giving line
-    number of the first error. Implementors should strive to produce
-    helpful error messages similar to those given by programming
-    language compilers. Client implementations should note that this may
-    be a multiline literal string with more than one error message
-    separated by newlines.
-
-    Example:
-
-    C: Putscript "foo" {31+}
-    C: #comment
-    C: InvalidSieveCommand
-    C:
-    S: NO "line 2: Syntax error"
-
-    C: Putscript "mysievescript" {110+}
-    C: require ["fileinto"];
-    C:
-    C: if envelope :contains "to" "tmartin+sent" {
-    C:   fileinto "INBOX.sent";
-    C: }
-    S: OK
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 12]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-2.7.  LISTSCRIPTS Command
-
-    This command lists the scripts the user has on the server. Upon
-    success a list of linebreak separated script names is returned
-    followed by an OK response. If there exists an active script the
-    atom ACTIVE is appended to the line of that script. The ACTIVE
-    string MUST NOT appear on more than one response line.
-
-    Example:
-
-    C: Listscripts
-    S: "summer_script"
-    S: "vacation_script"
-    S: "main_script" ACTIVE
-    S: OK
-
-
-
-2.8.  SETACTIVE Command
-
-    Arguments:
-         String - script name
-
-    This command sets a script active. If the script name is the empty
-    string (i.e. "") then any active script is disabled. If the script
-    does not exist on the server then the server MUST reply with a NO
-    response.
-
-    Examples:
-
-    C: Setactive "vacationscript"
-    S: Ok
-
-    C: Setactive ""
-    S: Ok
-
-    C: Setactive "baz"
-    S: No "There is no script by that name"
-
-
-
-2.9.  GETSCRIPT Command
-
-    Arguments:
-         String - Script name
-
-    This command gets the contents of the specified script. If the
-    script does not exist the server MUST reply with a NO response. Upon
-
-
-
-Expires January 21, 2003        Martin                         [Page 13]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    success a string with the contents of the script is returned
-    followed by a OK response.
-
-    Example:
-
-    C: Getscript "myscript"
-    S: {48+}
-    S: #this is my wonderful script
-    S: reject "I reject all";
-    S:
-    S: OK
-
-
-
-
-2.10.  DELETESCRIPT Command
-
-    Parameters:
-         sieve-name - Script name
-
-    This command is used to delete a user's Sieve script. Servers MUST
-    reply with a NO response if the script does not exist. The server
-    MUST NOT allow the client to delete an active script and reply with
-    a NO response if attempted. If a client wishes to delete an active
-    script it should use the SETACTIVE command to disable the script
-    first.
-
-    Example:
-
-    C: Deletescript "foo"
-    S: Ok
-
-    C: Deletescript "baz"
-    S: No "You may not delete an active script"
-
-
-
-3.  Sieve URL Scheme
-
-    URL scheme name: "sieve"
-
-    URL scheme syntax:
-
-      Described using ABNF [RFC 2234] and ABNF entities from RFC 2396.
-
-      sieveurl = "sieve://" [ hostport ] "/" scriptname
-
-      scriptname = *pchar
-
-
-
-Expires January 21, 2003        Martin                         [Page 14]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-      Character encoding considerations: The script name, if present,
-      is in UTF-8.  Non-ASCII characters must be escaped as described
-      in RFC 2396.
-
-    Intended usage: A sieve URL identifies a sieve server or a sieve
-      script on a sieve server.  The latter always have the
-      application/sieve MIME type.
-
-    Applications and/or protocols which use this URL scheme name:
-      The protocol is described in this document.
-
-    Interoperability considerations:  None.
-
-    Security considerations:  None.
-
-    Relevant publications:  This document and RFC 3028.
-
-    Person & email address to contact for further information:
-      Author of this document.
-
-    Author/Change controller:  Author of this document.
-
-
-
-4.  Formal Syntax
-
-    The following syntax specification uses the augmented Backus-Naur
-    Form (BNF) notation as specified in [ABNF]. This uses the ABNF core
-    rules as specified in Appendix A of the ABNF specification [ABNF].
-
-    Except as noted otherwise, all alphabetic characters are case-
-    insensitive. The use of upper or lower case characters to define
-    token strings is for editorial clarity only. Implementations MUST
-    accept these strings in a case-insensitive fashion.
-
-
-    SAFE-CHAR             = %x01-09 / %x0B-0C / %x0E-21 / %x23-5B / %x5D-7F
-                            ;; any TEXT-CHAR except QUOTED-SPECIALS
-
-    QUOTED-CHAR           = SAFE-UTF8-CHAR / "\" QUOTED-SPECIALS
-
-    QUOTED-SPECIALS       = <"> / "\"
-
-    SAFE-UTF8-CHAR        = SAFE-CHAR / UTF8-2 / UTF8-3 / UTF8-4 /
-                            UTF8-5 / UTF8-6
-
-    UTF8-1                = %x80-BF
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 15]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    UTF8-2                = %xC0-DF UTF8-1
-
-    UTF8-3                = %xE0-EF 2UTF8-1
-
-    UTF8-4                = %xF0-F7 3UTF8-1
-
-    UTF8-5                = %xF8-FB 4UTF8-1
-
-    UTF8-6                = %xFC-FD 5UTF8-1
-
-    auth-type             = <"> auth-type-name <">
-
-    auth-type-name        = iana-token
-                            ;; as defined in SASL [SASL]
-
-    command               = command-authenticate / command-logout / command-getscript /
-                            command-setactive / command-listscripts / command-deletescript /
-                            command-putscript / command-capability / command-havespace /
-                            command-starttls
-
-    command-authenticate  = "AUTHENTICATE" SP auth-type [SP string]  *(CRLF string)
-
-    command-capability    = "CAPABILITY" CRLF
-
-    command-deletescript  = "DELETESCRIPT" SP sieve-name CRLF
-
-    command-getscript     = "GETSCRIPT" SP sieve-name CRLF
-
-    command-havespace     = "HAVESPACE" SP sieve-name SP number CRLF
-
-    command-listscripts   = "LISTSCRIPTS" CRLF
-
-    command-logout        = "LOGOUT" CRLF
-
-    command-putscript     = "PUTSCRIPT" SP sieve-name SP string CRLF
-
-    command-setactive     = "SETACTIVE" SP sieve-name CRLF
-
-    command-starttls      = "STARTTLS" CRLF
-
-    literal               = "{" number  "+}" CRLF *OCTET
-                            ;; The number represents the number of octets
-                            ;; MUST be literal-utf8 except for values
-
-    number                = *DIGIT
-                            ;; A 32-bit unsigned number.
-                            ;; (0 <= n < 4,294,967,296)
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 16]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    quoted                = <"> *QUOTED-CHAR <">
-                            ;; limited to 1024 octets between the <">s
-
-    resp-code             = "AUTH-TOO-WEAK" / "ENCRYPT-NEEDED" /
-                            "QUOTA" / resp-code-sasl / resp-code-referral
-                            "TRANSITION-NEEDED" / "TRYLATER" /
-                            resp-code-ext
-
-    resp-code-referral   = "REFERRAL" SP sieveurl
-
-    resp-code-sasl        = "SASL" SP string
-
-    resp-code-ext         = iana-token [SP extension-data]
-                            ;; unknown codes MUST be tolerated by the client
-
-    response              = response-authenticate / response-logout / response-getscript /
-                            response-setactive / response-listscripts / response-deletescript /
-                            response-putscript / response-capability / response-havespace /
-                            response-starttls
-
-    response-authenticate = *(string CRLF) (response-oknobye)
-
-    response-capability   = *(string [SP string] CRLF) response-oknobye
-
-    response-deletescript = response-oknobye
-
-    response-getscript    = [string CRLF] response-oknobye
-
-    response-havespace    = response-oknobye
-
-    response-listscripts  = *(sieve-name [SP "ACTIVE"] CRLF) response-oknobye
-                   ;; ACTIVE may only occur with one sieve-name
-
-    response-logout       = response-oknobye
-
-    response-oknobye      = ("OK" / "NO" / "BYE") [SP "(" resp-code ")"] [SP string] CRLF
-
-    response-putscript    = response-oknobye
-
-    response-setactive    = response-oknobye
-
-    response-starttls     = response-oknobye
-
-    sieve-name            = string
-
-    string                = quoted / literal
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 17]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-5.  Security Considerations
-
-    The AUTHENTICATE command uses SASL [SASL] and TLS [TLS] to provide
-    basic authentication, authorization, integrity and privacy services.
-    When a SASL mechanism is used the security considerations for that
-    mechanism apply.
-
-    This protocol transactions are susceptible to passive observers or
-    man in the middle attacks which alter the data, unless the optional
-    encryption and integrity services of the AUTHENTICATE command are
-    enabled, or an external security mechanism is used for protection.
-    It may be useful to allow configuration of both clients and servers
-    to refuse to transfer sensitive information in the absence of strong
-    encryption.
-
-
-6.  Acknowledgments
-
-    Thanks to Simon Josefsson, Larry Greenfield, Allen Johnson, Chris
-    Newman, Lyndon Nerenberg, Alexey Melnikov, Tim Showalter, Sarah
-    Robeson, and Walter Wong for help with this document.
-
-
-
-7.  Copyright
-
-    Copyright (C) The Internet Society 1999. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-
-
-
-Expires January 21, 2003        Martin                         [Page 18]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-8.  References
-
-     [KEYWORDS] S. Bradner, "Key words for use in RFCs to Indicate
-         Requirement Levels", RFC 2119, March 1997
-
-         <ftp://ftp.isi.edu/in-notes/rfc2119.txt>
-
-
-[ABNF] Crocker, Overell, "Augmented BNF for Syntax Specifications:
-ABNF", RFC 2234, Internet Mail Consortium, Demon Internet Ltd, November
-1997.
-
-[ACAP] Newman, Myers, "ACAP -- Application Configuration Access Proto-
-col", RFC 2244, Innosoft, Netscape, November 1997.
-
-[IMAP4rev1] Crispin, M., "Internet Message Access Protocol - Version
-4rev1", RFC 2060, October 1996.
-
-[IMAP-URL] Newman, C.; "IMAP URL Scheme"; RFC 2192; Innosoft; September,
-1997
-
-[PLAIN] Newman, C. "Using TLS with IMAP, POP3 and ACAP", RFC 2595,
-Innosoft, June 1999.
-
-[SASL] Myers, J., "Simple Authentication and Security Layer (SASL)", RFC
-2222, Netscape Communications, October 1997.
-
-[SASL-ANON] Newman, C., "Anonymous SASL Mechanism", RFC 2245, November
-1997.
-
-[SIEVE] Showalter, T.; "Sieve: A Mail Filtering Language"; RFC 3028;
-Mirapoint, Inc.; January 2001
-
-[TLS] Dierks, T. and C. Allen, "The TLS Protocol Version 1.0", RFC 2246,
-January 1999.
-
-
-9.  Author's Address
-
-    Tim Martin
-    Mirapoint Inc.
-    909 Hermosa Court
-    Sunnyvale, CA 94085
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 19]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    Phone: (408) 720-3835
-    EMail: tmartin@mirapoint.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 20]
-
+http://ktown.kde.org/~dirk/sieve/draft-martin-managesieve-04.txt
Index: kioslaves/sieve/draft-melnikov-sieve-imapflags.txt
===================================================================
--- kioslaves/sieve/draft-melnikov-sieve-imapflags.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-melnikov-sieve-imapflags.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,504 +1 @@
-Network Working Group                                       
-Internet Draft: Sieve -- IMAP flag Extension                 A. Melnikov
-Document: draft-melnikov-sieve-imapflags-05.txt            Isode Limited
-Expires: December 2003                                         June 2003
-
-
-                      Sieve -- IMAP flag Extension
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is in full conformance with
-   all provisions of Section 10 of RFC2026.  Internet-Drafts are
-   working documents of the Internet Engineering Task Force (IETF), its
-   areas, and its working groups.  Note that other groups may also
-   distribute working documents as Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other documents
-   at any time.  It is inappropriate to use Internet- Drafts as
-   reference material or to cite them other than as "work in progress."
-
-   To learn the current status of any Internet-Draft, please check the
-   ``1id-abstracts.txt''  listing  contained  in  the  Internet-Drafts
-   Shadow   Directories   on   ftp.is.co.za   (Africa),  ftp.nordu.net
-   (Europe),  munnari.oz.au (Pacific Rim),  ds.internic.net  (US  East
-   Coast), or ftp.isi.edu (US West Coast).
-
-   The protocol discussed in this document is experimental and subject
-   to change.  Persons planning on either implementing or  using  this
-   protocol  are STRONGLY URGED to get in touch with the author before
-   embarking on such a project.
-
-Copyright
-
-   Copyright (C) The Internet Society 2000-2003.  All Rights Reserved.
-
-Abstract
-
-   Recent discussions have shown that it is desirable to set different
-   [IMAP] flags on message delivery.  This can be done, for example,
-   by a Sieve interpreter that works as a part of a Mail Delivery
-   Agent.
-
-   This document describes an extension to the Sieve mail filtering
-   language for setting [IMAP] flags. The extension allows to set both
-   [IMAP] system flags and [IMAP] keywords.
-
-
-0. Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-   Editorial comments are marked with << and >>.
-
-
-0.1. Discussion
-
-   This draft defines an extension to the Sieve mail filtering
-   language (RFC 3028) being  discussed  on the MTA Filters
-   mailing list at <ietf-mta-filters@imc.org>.  Subscription  requests
-   can  be  sent  to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body). More information on
-   the  mailing  list  along  with  a  WWW archive of back messages is
-   available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2. Open issues
-
-   1. There is no way to specify which flags to set on implicit keep.
-      Is this an issue?
-
-
-0.3. Changes from the version submitted to the Sieve mailing list
-
-   1. Added addflag and removeflag actions
-
-   2. Changed the semantics of setflag (setflag is not additive any
-      more)
-
-   3. Corrected section "Interaction with Other Sieve Actions".
-      Removed incorrect reference to the forward action as to an
-      action that prohibits setflag.
-
-   4. Added paragraph about the mutual order of "fileinto"/"keep" and
-      "setflag"/"addflag"/"removeflag" actions.
-
-
-0.4. Changes from the revision 00
-
-   1. Corrected Capability Identifier section (Section 2)
-
-   2. Corrected "Interaction with Other Sieve Actions" section
-      (Section 4)
-
-   3. Examples were updated to be compatible with Sieve-07 draft
-
-   4. Added "mark" and "unmark" actions
-
-
-0.5. Changes from the revision 01
-
-   1. Some language fixes based on Tony Hansen comments
-
-   2. Clarified that the extension allows to set both IMAP System
-      Flags and Keywords
-
-
-0.6. Changes from the revision 02
-
-   1. BugFix: all backslashes must be escaped
-
-   2. Added extended example and more detailed description of
-      "addflag"/"removeflag" additivity.
-
-   3. Minor example bugfixes
-
-
-0.7. Changes from the revision 03
-
-   1. Added second way to specify flags to be set (via optional tagged
-      arguments). [Tim Showalter]
-
-   2. Rules for using Reject with imapflags relaxed. [Randall Gellens]
- 
-   3. Removed ABNF section completely, added syntax description to
-      action definition. [Tim Showalter]
-
-   4. Cleaned up the example. [Ken Murchison]
-
-   5. Added FM (Flag Manupulation) acronym.
-
-   6. Clarified "mark"/"unmark" bahavior. [Randall Gellens]
-
-
-0.8. Changes from the revision 04
-
-   1. "Interaction with Other Sieve Actions" was simplified based on
-      comments from Tim Showalter.  Added sentence saying that
-      imapflags doesn't change an implicit keep.
-
-   2. Several editorial comments from Tim Showalter.
-
-0.9. Changes from the revision 05
-
-   1. Updated copyright, author address, section numbers and references.
-
-   2. Several editorial comments from Matthew Elvey.
-
-   3. Removed "mark" and "unmark" actions.
-
-   4. Removed "setflag" action.
-
-   5. Added "hasflag" test.
-
-
-1. Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE] for
-   setting [IMAP] flags. It adds a new tagged argument to "keep" and
-   "fileinto" that describes the list of flags that have to be set
-   when the message is delivered to the specified mailbox. It also
-   adds several actions to help manipulate list of flags and a test
-   to check if a flag belongs to a list.
-
-   This extension depends on the presence of "variables" extension
-   [Variables].
-
-   Sieve interpreters that don't support integration with IMAP SHOULD
-   ignore this extension.
-
-   The capability string associated with extension defined in this
-   document is "imapflags".
-
-<<Change extension name?>>
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-
-3. Actions
-
-   All actions described in this specification (addflag, removeflag)
-   operate on string variables that contain a set of [IMAP] flags.
-   On variable substitution a set of flags is represented as a string
-   containing space separated list of flag names.
-   The "addflag" action adds flags to an existing set. The "removeflag"
-   action removes flags from an existing set. The "set" action defined in
-   [Variables] can be used to replaces an existing set of flags with a
-   new set. The :flags tagged argument is used to associate a set of flags
-   referenced by a variable with the current message.
-
-<<Keep setflags as list to string converter operation?>>
-
-3.1. Addflag action
-
-   Syntax:   addflag <variablename: string> <list-of-flags: string-list>
-
-   Addflag is used to add flags to a list of [IMAP] flags. It doesn't
-   replace any previously set flags. This means that multiple occurrences
-   of addflag are treated additively. The order of the flags MAY NOT
-   be preserved and duplicates are allowed.
-
-   Addflag SHOULD check the list of flags for validity as described by
-   [IMAP] ABNF. In particular non-ASCII characters are not allowed in
-   flag names. However spaces MUST be always allowed and multiple spaces
-   between flag names MUST be treated as a single space character. The
-   last requirement is to simplify amalgamation of multiple flag lists.
-
-   For example, the following two actions
-
-      addflag "flagvar" "\\Deleted";
-      addflag "flagvar" "\\Answered";
-
-   produce the same result as the single action
-
-      addflag "flagvar" ["\\Deleted", "\\Answered"];
-
-   or
-
-      addflag "flagvar" "\\Deleted \\Answered";
-
-   or
-
-      addflag "flagvar" "\\Answered   \\Deleted";
-
-
-3.2. Removeflag Action
-
-   Syntax:   removeflag <variablename: string> <list-of-flags: string-list>
-
-   Removeflag is used to remove flags from a list of [IMAP] flags.
-   Removeflag clears flags previously set by "set"/"addflag". Calling
-   removeflag with a flag that wasn't set before is not an error and
-   is ignored. Multiple occurrences of removeflag are treated additively.
-
-   Removeflag SHOULD check the list of flags for validity as described by
-   [IMAP] ABNF. In particular non-ASCII characters are not allowed in
-   flag names. However spaces MUST be always allowed and multiple spaces
-   between flag names MUST be treated as a single space character.
-
-      Example:
-        if header :contains "Disposition-Notification-To" "mel@example.com" {
-            addflag "flagvar" "$MDNRequired";
-        }
-        if header :contains "from" "imap@cac.washington.edu" {
-            removeflag "flagvar" "$MDNRequired";
-            fileinto :globalflags "INBOX.imap-list";
-        }
-
-
-4.  Test hasflag
-
-   Syntax: hasflag [MATCH-TYPE]
-           <variable-list: string-list> <flag-list: string-list>
-
-   The "hasflag" test evaluates to true if any of the variables matches any
-   flag name.  The type of match defaults to ":is".
-
-   Flagname comparisons is always done with the "i;ascii-casemap" operator,
-   i.e., case-insensitive comparisons, as defined in [IMAP].
-
-   Note, that if an implementation automatically performs flags reordering
-   and/or duplicate elimination, it MUST perform it on both variable-list
-   values and flag-list values. This is required so that, when the variable
-   "flags" has the value "A B", the following test
-
-    hasflag :is "flags" "b A"
-
-   evaluates to true as expected.
-
-
-5. Tagged argument - :flags
-
-   This specification adds a new optional tagged argument ":flags" that
-   alter the behavior of actions "keep" and "fileinto".
-
-   The :flags tagged argument specifies that the flags provided in the
-   subsequent argument should be set when fileinto/keep deliver the message
-   to the target mailbox/user's main mailbox. If the :flags tagged argument
-   is not specified, "keep" or "fileinto" will not set any flag when they
-   deliver the message to the mailbox.
-
-   Syntax:   ":flags" <list-of-flags: string-list>
-
-   The copy of the message filed into mailbox will have only flags
-   listed after ":flags".
-
-   The Sieve interpreter MUST check that all flag names are valid [IMAP] flag
-   names and MUST signal a script execution error if they are not. The Sieve
-   interpreter MUST ignore all flags that it can't store
-   permanently. This means that the interpreter must not treat failure
-   to store any flag as a runtime failure to execute the Sieve
-   script. For example, if the mailbox "INBOX.From Boss" can't store any
-   flags, then
-
-     fileinto :flags "\\Deleted" "INBOX.From Boss";
-
-   and
-
-     fileinto "INBOX.From Boss";
-
-   are equivalent.
-
-   This document doesn't dictate how the Sieve interpreter will set
-   the [IMAP] flags. In particular, the Sieve interpreter may work as
-   an IMAP client, or may have direct access to the mailstore.
-
-<<If we propose using a string list, we have to tell that "" are ignored.
-Also, deprecate spaces in flag names? However, if we change the
-parameter to be a space separated string of flags, we don't have
-these issues.>>
-
-
-6. Implementation Notes
-
-   "Addflag <variable> <flaglist>" can be implemented as several actions
-   "set <variable> "${variable} <flag>", where <flag> is a flag in flaglist.
-
-   A script interpreter MAY reorder flags and remove duplicates from the list.
-   A SIEVE script write MUST NOT assume that the order or duplicates will be
-   preserved.
-
-<<Describe how removeflag and hasflag can be implemented using [Variables]>>
-
-
-7. Interaction with Other Sieve Actions
-
-   This extension work only on the message that is currently being
-   processed by Sieve, it doesn't affect another message generated
-   as a side affect of any action.
-
-   The extension decribed in this document doesn't change an implicit
-   keep (see section 2.10.2 of [SIEVE]).
-
-
-8. Other Considerations
-
-   This extension intentionally doesn't allow setting [IMAP] flags on
-   an arbitrary message in the [IMAP] message store.
-
-
-9. Security Considerations
-
-   Security considerations are discussed in the [IMAP] and [SIEVE].
-   It is belived that this extension doesn't introduce any additional
-   security concerns.
-
-
-10. Extended example
-
-   #
-   # Example Sieve Filter
-   # Declare any optional features or extension used by the script
-   #
-   require ["fileinto", "imapflags", "variables"];
-
-   #
-   # Move large messages to special mailbox
-   #
-   if size :over 1M
-           {
-           add "flags" "Big";
-           if header :is "From" "boss@company.com"
-                      {
-   # The message will be marked as "\Flagged Big" when filed into 
-   # mailbox "Big messages"
-                      add "flags" "\\Flagged";
-                      }
-           fileinto :flags "${flags}" "Big messages";
-           }
-
-   if header :is "From" "grandma@example.net"
-           {
-           add "flags" ["\\Answered", "$MDNSent"];
-   # If the message is bigger than 1Mb it will be marked as 
-   # "Big \Answered $MDNSent" when filed into mailbox "grandma". 
-   # If the message is shorter than 1Mb it will be marked as
-   # "\Answered $MDNSent"
-           fileinto :flags "${flags}" "GrandMa";  # move to "GrandMa" folder
-           }
-
-   #
-   # Handle messages from known mailing lists
-   # Move messages from IETF filter discussion list to filter folder
-   #
-   if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-           {
-           set "flags" "\\Flagged $Work";
-   # Message will have both "\Flagged" and $Work flags
-           keep :flags "${flags}";
-           }
-
-   #
-   # Keep all messages to or from people in my company
-   #
-   elsif anyof address :domain :is ["From", "To"] "company.com"
-           {
-           keep :flags "${flags}";               # keep in "Inbox" folder
-           }
-   #
-   # Try and catch unsolicited email.  If a message is not to me,
-   # or it contains a subject known to be spam, file it away.
-   #
-   elsif anyof (not address :all :contains
-                  ["To", "Cc"] "me@company.com",
-                header :matches "subject"
-                  ["*make*money*fast*", "*university*dipl*mas*"])
-           {
-           remove "flags" "\\Flagged";
-           # If message header does not contain my address,
-           # it's from a list.
-           fileinto :flags "${flags}" "spam";   # move to "spam" folder
-           }
-   else
-           {
-           # Move all other (non-company) mail to "personal"
-           # folder.
-           fileinto :flags "${flags}" "personal";
-           }
-
-
-11.  Acknowledgments
-
-    This document has been revised in part based on comments and
-    discussions which took place on and off the Sieve mailing list.
- 
-    The help of those who took the time to review the draft and make
-    suggestions is appreciated, especially that of Tim Showalter,
-    Barry Leiba, Randall Gellens, Ken Murchison, Cyrus Daboo,
-    Matthew Elvey, Jutta Degener, Ned Freed, Marc Mutz and
-    Kjetil Torgrim Homme.
-
-    Special thanks to Tony Hansen, David Lamb and
-    Roman Migal for helping me explain better the concept.
-
-
-12. Author's Address
-
-    Alexey Melnikov
-    Isode
-    28 Gloucester Road,
-    Teddington, Middlesex
-    United Kingdom, TW11 0NU
-
-    Email: mel@isode.com
-
-
-13.  Normative References
-
-    [SIEVE] Showalter, T.,  "Sieve: A Mail Filtering Language", Mirapoint,
-    RFC 3028, January 2001.
-
-    [ABNF] Crocker, D.,  "Augmented BNF for Syntax Specifications: ABNF",
-    Internet Mail Consortium, RFC 2234, November, 1997.
-
-    [KEYWORDS] Bradner, S., "Key  words  for  use  in  RFCs  to  Indicate
-    Requirement Levels", Harvard University, RFC 2119, March 1997.
-
-    [IMAP] Crispin, M., "INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1",
-    University of Washington, RFC 3501, March 2003.
-
-    [Variables] Homme, K. T., "Sieve -- Variables Extension", University of
-    Oslo, work in progress, draft-homme-sieve-variables-XX.txt
-
-
-14.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2000-2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
+http://ktown.kde.org/~dirk/sieve/draft-melnikov-sieve-imapflags.txt
Index: kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt
===================================================================
--- kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,396 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                        K. Murchison
-Document: draft-murchison-sieve-subaddress-05.txt      Oceana Matrix Ltd.
-Expires January 5, 2003                                      30 June 2002
-
-
-                        Sieve -- Subaddress Extension
-
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are working
-    documents of the Internet Engineering Task Force (IETF), its areas,
-    and its working groups.  Note that other groups may also distribute
-    working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six months
-    and may be updated, replaced, or obsoleted by other documents at any
-    time.  It is inappropriate to use Internet-Drafts as reference
-    material or to cite them other than as "work in progress."
-
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-Copyright Notice
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-
-Abstract
-
-    On email systems that allow for "subaddressing" or "detailed
-    addressing" (eg, "ken+sieve@example.org"), it is sometimes desirable
-    to make comparisons against these sub-parts of addresses.  This draft
-    defines an extension to the Sieve mail filtering language that allows
-    users to compare against the user and detail parts of an address.
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 1]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Copyright Notice . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-0.     Meta-information on this draft  . . . . . . . . . . . . . . .   3
-
-0.1.   Discussion  . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.   Noted Changes . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.1  since -04 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.2  since -03 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.3  since -02 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.4  since -01 . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-0.2.5  since -00 . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   4
-
-3.     Subaddress Comparisons  . . . . . . . . . . . . . . . . . . .   5
-
-4.     Security Considerations . . . . . . . . . . . . . . . . . . .   6
-
-5.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   6
-
-6.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .   6
-
-Appendix A.  References  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix B.  Full Copyright Statement  . . . . . . . . . . . . . . .   7
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 2]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-
-0.     Meta-information on this draft
-
-    This information is intended to facilitate discussion.  It will be
-    removed when this document leaves the Internet-Draft stage.
-
-
-0.1.   Discussion
-
-    This draft is intended to be an extension to the Sieve mail filtering
-    language, available from the RFC repository as
-    <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-    This draft and the Sieve language itself are being discussed on the
-    MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-    requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-    email message with the word "subscribe" in the body).  More
-    information on the mailing list along with a WWW archive of back
-    messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.   Noted Changes
-
-
-0.2.1  since -04
-
-    Non-existent ":detail" sub-part causes test to fail.
-
-    Editorial changes.
-
-
-0.2.2  since -03
-
-    Editorial changes.
-
-
-0.2.3  since -02
-
-    Decided on :user and :detail as sub-parts (removed Known Issues).
-
-    Noted that separator character MUST match the one used by the mail
-    system.
-
-    Editorial changes.
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 3]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-
-0.2.4  since -01
-
-    Added description of subaddressing inspired by Randy Gellens.
-
-    Added discussion of handling different separator characters.
-
-    Editorial changes.
-
-
-0.2.5  since -00
-
-    Added augmented ADDRESS-PART syntax element.
-
-    Editorial changes.
-
-
-1.  Introduction
-
-    Subaddressing is the practice of appending some "detail" information
-    to the local-part of an [IMAIL] address to indicate that the message
-    should be delivered to the set of messages specified by the "detail"
-    information.  The "detail" information is prefixed with a special
-    "separator character" (typically "+") which forms the boundary
-    between the "user" (original local-part) and the "detail" sub-parts
-    of the address, much like the "@" character forms the boundary
-    between the local-part and domain.
-
-    Typical uses of subaddressing might be:
-
-    - A message addressed to "ken+sieve@example.org" is delivered into a
-    mailbox called "sieve" belonging to the user "ken".
-
-    - A message addressed to "5551212#123@example.org" is delivered to
-    the voice mailbox number "123" at phone number "5551212".
-
-    This document describes an extension to the Sieve language defined by
-    [SIEVE] for comparing against the "user" and "detail" sub-parts of an
-    address.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "subaddress".
-
-
-
-Expires January 5, 2003       Murchison                         [Page 4]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-3.  Subaddress Comparisons
-
-    Commands that act exclusively on addresses may take the optional
-    tagged arguments ":user"  and ":detail" to specify what sub-part of
-    the local-part of the address will be acted upon.
-
-    NOTE: In most cases, the envelope "to" address is the prefered
-    address to examine for subaddress information when the desire is to
-    sort messages based on how they were addressed so as to get to a
-    specific recipient.  The envelope address is, after all, the reason a
-    given message is being processed by a given sieve script for a given
-    user.  This is particularly true when mailing lists, aliases, and
-    "virtual domains" are involved since the envelope may be the only
-    source of detail information for the specific recipient.
-
-    The ":user" argument specifies that sub-part of the local-part which
-    lies to the left of the separator character (eg, "ken" in
-    "ken+sieve@example.org").  If no separator character exists, then
-    ":user" specifies the entire left-side of the address (equivalent to
-    ":localpart").
-
-    The ":detail" argument specifies that sub-part of the local-part
-    which lies to the right of the separator character (eg, "sieve" in
-    "ken+sieve@example.org").  If no separator characater exists, the the
-    test evaluates to false.  If nothing lies to the right of the
-    separator character, then ":detail" ":is" the null key ("").
-    Otherwise, the ":detail" sub-part contains the null key.
-
-    Implementations MUST make sure that the separator character matches
-    that which is used and/or allowed by the encompassing mail system,
-    otherwise unexpected results might occur.  Implementations SHOULD
-    allow the separator character to be configurable so that they may be
-    used with a variety of mail systems.
-
-    The ":user" and ":detail" address parts are subject to the same rules
-    and restrictions as the standard address parts defined in [SIEVE].
-    For convenience, the "ADDRESS-PART" syntax element defined in [SIEVE]
-    is augmented here as follows:
-
-         ADDRESS-PART  =/  ":user" / ":detail"
-
-
-    A diagram showing the ADDRESS-PARTs of a email address utilizing a
-    separator character of '+' is shown below:
-
-           :user "+" :detail  "@" :domain
-          `-----------------'
-              :local-part
-
-
-
-Expires January 5, 2003       Murchison                         [Page 5]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-    Example:
-
-          require "subaddress";
-
-          # File mailing list messages (subscribed as "ken+mta-filters").
-          if envelope :detail "to" "mta-filters" {
-            fileinto "inbox.ietf-mta-filters";
-          }
-
-          # If a message is not to me (ignoring +detail), junk it.
-          if not allof (address :user ["to", "cc", "bcc"] "ken",
-               address :domain ["to", "cc", "bcc"] "example.org") {
-            discard;
-          }
-
-          # Redirect all mail sent to +foo.
-          if envelope :detail ["to", "cc", "bcc"] "foo" {
-            redirect "ken@example.edu";
-          }
-
-
-4.  Security Considerations
-
-    Security considerations are discussed in [SIEVE].  It is believed
-    that this extension doesn't introduce any additional security
-    concerns.
-
-
-5.  Acknowledgments
-
-    Thanks to Tim Showalter, Alexey Melnikov, Michael Salmon, Randall
-    Gellens, Philip Guenther and Jutta Degener for their help with this
-    document.
-
-
-6.  Author's Address
-
-    Kenneth Murchison
-    Oceana Matrix Ltd.
-    21 Princeton Place
-    Orchard Park, NY 14127
-
-    Phone: (716) 662-8973
-    EMail: ken@oceana.com
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 6]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-Appendix A.  References
-
-     [IMAIL] Resnick, P., Ed., "Internet Message Format", QUALCOMM
-         Incorporated, RFC 2822, April 2001.
-
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-         Requirement Levels", Harvard University, RFC 2119, March 1997.
-
-
-     [SIEVE] Showalter, T., "Sieve: A Mail Filtering Language", Mira
-         point, Inc., RFC 3028, January 2001.
-
-
-Appendix B.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of develop-
-    ing Internet standards in which case the procedures for copyrights
-    defined in the Internet Standards process must be followed, or as
-    required to translate it into languages other than English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 7]
-
+http://ktown.kde.org/~dirk/sieve/draft-murchison-sieve-subaddress-05.txt
Index: kioslaves/sieve/draft-degener-sieve-multiscript.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-multiscript.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/draft-degener-sieve-multiscript.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,244 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					              Rand Wacker
-Expires: October 2003                                          April 2003
-
-
-              Sieve -- Sequential Execution of Multiple Scripts
-		  <draft-degener-sieve-multiscript-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines sieve behavior relevant when multiple
-   scripts are executed sequentially on the same message.
-
-
-1. Introduction
-
-   E-mail messages frequently are processed by multiple agents
-   that implement nested layers of corporate policies.
-
-   For example, a provider may offer access to services that
-   perform spam- and virus filtering; a single corporation
-   may restrict e-mail to certain subdomains, or filter for
-   keywords; individual divisions within a corporation may
-   implement even more intrusive handling of e-mail messages,
-   for example by keeping a copy of all correspondence.
-   Amidst all of this, of course, users may still use sieve
-   filters to presort, redirect, or notify other accounts
-   as in the classic sieve use scenario.
-
-   In this context, it is desirable to specify an execution
-   model for sieve scripts when executed in series.  This
-   allows each layer of the mail filtering hierarchy to use
-   a separate sieve script to express its policies.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   This document defines no sieve extensions and no capability string.
-
-
-3. Sequential Script Execution Model
-
-   When multiple scripts are executed for a message, they
-   are executed in a specific order.
-
-   Within this order, this document defines that trailing
-   scripts will be executed as long as the message is being
-   "kept", that is, as long as either an implicit or explicit
-   "keep" is in effect.
-
-   In other words, for every script but the last, "keep"
-   doesn't mean "file this message into INBOX", it means
-   "process this message with the next sieve script."
-
-
-4. Locality of script actions
-
-   This document strongly limits the effects of scripts
-   on each other.
-
-   The "require" clauses at the beginning of a script
-   only apply to this particular script, not to following
-   ones.   Different stages in the script processing
-   may support different "require" areas.  For example,
-   it is conceivable that "fileinto" is not supported
-   for a stage other than a user's private script.
-
-   The "stop;" command ends the execution of its single
-   containing script, not of scripts in general.
-
-   After one script terminates, the next script is executed
-   if an implicit or explicit "keep" is in effect.
-   (To end all script execution, a script should execute
-   "discard; stop;".)
-
-   For sieve engines that implement the "variables" extension,
-   variable state is not carried over between scripts.
-
-   For sieve engines that implement the "notify" extension,
-   the "denotify" action in one script can only cancel
-   "notify" actions from that same script.
-
-   However, if a sequence of script executions results in
-   the same message sent to the same recipient, or filed to
-   the same destination folder, more than once, an implementation
-   MAY only produce a single message, even if the commands
-   executed stem from multiple scripts.
-
-   If a sieve implementation enforces the incompatibility
-   of "reject" with other actions (a SHOULD in [SIEVE]),
-   it MUST only enforce it within one script; an action
-   in a preceding script MUST be compatible with a "reject"
-   in a later script.
-
-
-5. Script Errors
-
-   When an error occurs during processing of any of the
-   scripts, all message processing stops, and the message
-   is treated as if the final script had executed a "keep;".
-
-
-6. Security Considerations
-
-   A script executed before another script can prevent the
-   trailing script from running (by executing "discard; stop;"
-   or by encountering an error.)  This is deliberate.
-
-   Corporate filtering of employee e-mail may violate the
-   privacy expectations of employees.  However, since these
-   instances are the ones running the software that handles
-   employee e-mail to begin with, they already have the
-   technical capability to do this.
-
-
-7. Acknowledgments
-
-   Thanks to Eric Allman, Will Lee, Dowson Tong, and Chris Markle for comments.
-
-
-8. Authors' Addresses
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-   Email: jutta@sendmail.com
-
-   Rand Wacker
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-   Email: rand@sendmail.com
-
-
-9. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-9.1 Comparison to draft-daboo-sieve-include-00
-
-   The "include" sieve extension describes a mechanism for
-   naming and combining multiple scripts.  This document doesn't
-   do that; how the sequence of scripts to be executed on a
-   message is determined is left up to the environment and likely
-   out of control of the script owner.
-
-   The "include" sieve extension creates a hierarchical
-   tree of nested scripts; this extension describes sequential,
-   not hierarchical execution.
-
-   The "include" sieve extension defines the semantics of
-   "stop" to stop all sieve execution, not just that of the
-   innermost containing script.  It adds a new "return" command
-   to explicitly end execution of a single script.
-   This document specifies that "stop" just stops a single script, 
-   and uses the redefined meaning of "keep" to regulate the
-   flow of messages through scripts.
-
-
-9.2 "require" keyword
-
-   This draft started out with a "require" keyword, "multiscript",
-   but since what it describes lies outside the domain of strict
-   sieve language behavior, I'm not sure it needs one.
-
-
-Appendices
-
-Appendix A.  References
-
-   [KEYWORDS] 	Bradner, S., "Key words for use in RFCs to Indicate
-   		Requirement Levels", RFC 2119, March 1997.
-
-   [SIEVE] 	Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-		January 2001.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002,2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-multiscript.txt
Index: kioslaves/sieve/sieve.protocol
===================================================================
--- kioslaves/sieve/sieve.protocol	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kioslaves/sieve/sieve.protocol	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -23,6 +23,7 @@
 Description[fa]=یک  ioslave برای قرارداد پالایش نامۀ Sieve
 Description[fi]=Siirräntätyöskentelijä Sieve-sähköpostiensuodatusyhteyskäytännölle
 Description[fr]=Un ioslave pour le protocole de filtrage de messagerie Sieve
+Description[gl]=Un esclavo io para o protocolo de filtraxe de correo Sieve
 Description[hu]=KDE-protokoll a Sieve levélszűrő protokollhoz
 Description[is]=Ioslave fyrir Sieve tölvupóstsíu samskiptaregluna
 Description[it]=Un ioslave per il protocollo di filtraggio posta Sieve
Index: doc/akregator/quick-filter.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/quick-filter.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/add-folder.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/add-folder.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/index.docbook
===================================================================
--- doc/akregator/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ doc/akregator/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,21 +13,35 @@
 <title>The &akregator; Handbook</title>
 
 <authorgroup>
+
 <author>
-<firstname></firstname>
-<othername></othername>
-<surname></surname>
-<affiliation>
-<address><email></email></address>
-</affiliation>
+<firstname>Frank</firstname>
+<surname>Osterfeld</surname>
+<affiliation><address><email>frank.osterfeld@kdemail.net</email>  
+</address></affiliation>
 </author>
+<author>
+<firstname>Anne-Marie</firstname>
+<surname>Mahfouf</surname>
+<affiliation><address>&Anne-Marie.Mahfouf.mail; 
+</address></affiliation>
+</author>
+
 <!-- TRANS:ROLES_OF_TRANSLATORS -->
 </authorgroup>
+<copyright>
+<year>2006</year>
+<holder>Frank Osterfeld</holder>
+</copyright>
+<copyright>
+<year>2006</year>
+<holder>&Anne-Marie.Mahfouf;</holder>
+</copyright>
 
 <legalnotice>&FDLNotice;</legalnotice>
 
-<date>2005-02-22</date>
-<releaseinfo>0.00.00</releaseinfo>
+<date>2006-12-08</date>
+<releaseinfo>1.2.5</releaseinfo>
 
 <!-- Abstract about this handbook -->
 
@@ -45,29 +59,1105 @@
 
 </bookinfo>
 
-<chapter id="introduction"> <title>Introduction</title> <para>
-The documentation for &kappname; was not finished when &kde; was installed on
-this computer.</para> <para>If you need help, please check <ulink
-url="http://www.kde.org">The &kde; Website</ulink> for updates, or by
-submitting your question to <ulink url="mailto:kde@kde.org">The
-&kde; User Mailing list</ulink>.</para> <para><emphasis>The &kde;
-Team</emphasis></para>
+<chapter id="introduction">
+<title>Introduction</title>
 
-&underFDL;
+<sect1 id="what-is-akregator">
+<title>What is &akregator;?</title>
 
+<para>&akregator; is a &kde; application for reading online news feeds. It has a
+powerful, user-friendly interface for reading feeds and the management of
+them.</para>
+
+<para>&akregator; is a lightweight and fast program for displaying news items
+provided by feeds, supporting all commonly-used versions of
+<acronym>RSS</acronym> and Atom feeds. Its interface is similar to those of
+e-mail programs, thus hopefully being very familiar to the user. Useful features include searching within article titles, management of feeds in folders and setting archiving
+preferences. Feeds can be displayed in a similar manner to e-mails. Websites related to a feed can be shown in &akregator;'s embedded browser or, at the users' choice, opened in an external browser.</para>
+</sect1>
+
+<sect1 id="rss-and-atom-feeds">
+<title><acronym>RSS</acronym> and Atom feeds</title>
+
+<para><acronym>RSS</acronym> (Really Simple Syndication) is an &XML;-based format used for publishing news or articles in a machine-readable form. An <acronym>RSS</acronym>
+or Atom file is also called a feed. A program that can be used to read such feeds is
+called a feed reader or aggregator, hence the title of the application, &akregator;.</para>
+
+<para>&akregator; automatically extracts new items from the feed and displays them in a human-friendly form to the user. The user can therefore save time with regularly-visited websites, as they need no longer manually check whether there are new pieces of information available.</para>
+<para><acronym>RSS</acronym> is available in different versions which
+are not compatible with each other (this situation caused by competing companies):
+<acronym>RSS</acronym> 0.9, <acronym>RSS</acronym> 1.0 and
+<acronym>RSS</acronym> 2.0. Atom is also an &XML;-based feed language which has
+been redesigned to fit the needs of webloggers and news sites. Atom attempts to
+replace <acronym>RSS</acronym> feeds and remove the uncertainty with
+incompatiblities in the different <acronym>RSS</acronym> versions.</para>
+
+</sect1>
+
 </chapter>
 
-&documentation.index; 
+<chapter id="quick-start">
+<title>Quick Start to &akregator;</title>
+
+<para>
+This section describes how to start using &akregator;. It explains the user
+interface and shows you how to add your own feed to the list. This section is
+particularily interesting if you are not yet familiar with the
+general <acronym>RSS</acronym>/Atom and feed aggregator concept.
+</para>
+
+<sect1 id="main-window">
+<title>The Main Window</title>
+<!--part of kontact
+say how to start it -->
+<para>When you first start &akregator;, you see its main window:
+<screenshot>
+<screeninfo>&akregator; main window</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="main-window.png" format="PNG" /></imageobject>
+<textobject><phrase>&akregator; main window</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para>
+
+<para>
+The main window consists of the feed list, the article list and the article
+viewer.
+</para>
+<para>
+The feed list is on the left. In the tree, you have news feeds you can
+select. A news feed is a collection of articles: for example, the recent news of
+a news site or the new entries of a blog. The default list contains feeds related to
+the &kde; project, but of course you can add your own feeds and remove the ones
+you are not interested in.
+<screenshot>
+<screeninfo>All articles are fetched</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="main-window2.png" format="PNG" /></imageobject>
+<textobject><phrase>All articles are fetched</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para>
+<para>
+In the upper right is the article list. It contains all the articles of the
+feed selected in the feed list (if it is empty, you must first fetch the feed). The list shows the headlines of the articles and the date when
+they were published. By default, the newest articles are at the top.
+<screenshot>
+<screeninfo>The article list</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="main-window3.png" format="PNG" /></imageobject>
+<textobject><phrase>The article list for one feed</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para>
+<para>
+If you select an article, it will be displayed in the article viewer in the
+lower right of the window. Depending on the feed, it contains either only a headline, a short
+summary, or the complete article content.
+<screenshot>
+<screeninfo>Reading an article from Planet &kde;</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="main-window4.png" format="PNG" /></imageobject>
+<textobject><phrase>Reading an article from Planet &kde;</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para>
+</sect1>
+
+<sect1 id="add-feed">
+<title>Adding a feed</title>
+<para>&akregator; provides you with some default feeds related to &kde; -  of course, you
+probably want to add your own feeds. Good candidates are the news sites you visit
+regularly.</para>
+
+<itemizedlist>
+<listitem><para>
+Go to the menu <guimenu>Feed</guimenu> and choose <guimenuitem>Add
+Feed...</guimenuitem> or use the default keyboard shortcut (<keycap>Insert</keycap>).
+The following dialog appears, with an input line labeled <guilabel>Feed
+URL:</guilabel>.
+<screenshot>
+<screeninfo>Add a new feed</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="add-feed.png" format="PNG" /></imageobject>
+<textobject><phrase>Add a new feed</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para></listitem>
+
+<listitem><para>
+Enter
+<userinput>www.slashdot.org</userinput>
+or <userinput>http://www.slashdot.org </userinput> in the line edit next
+to <guilabel>Feed URL</guilabel> and click <guibutton>OK</guibutton>.
+</para></listitem>
+<listitem><para>
+The feed settings dialog appears and you can modify the default options. When
+you are happy with the feed settings, click <guibutton>OK</guibutton> again.
+<screenshot>
+<screeninfo>The feed properties dialog</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="add-feed2.png" format="PNG" /></imageobject>
+<textobject><phrase>The feed properties dialog</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para></listitem>
+<listitem><para>
+Now Slashdot has been added to your feed list.
+</para> </listitem>
+</itemizedlist>
+<para>
+There are multiple other ways to find and add interesting feeds. Within KDE,
+websites browsed with &konqueror; will display the recognizable &quot;RSS
+lozenge&quot;<inlinemediaobject>
+  <imageobject>
+    <imagedata fileref="rss3.png" format="PNG"/>
+  </imageobject>
+    </inlinemediaobject>in the bottom-right if a compatible news feed is
+detected at the website. Just left-click on the icon and choose
+<guimenuitem>Add Feed to &akregator;</guimenuitem>:
+<screenshot>
+<screeninfo>Automatically finding feeds through &konqueror;</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="konq2.png" format="PNG" /></imageobject>
+<textobject><phrase>Automatically finding feeds through &konqueror;</phrase></textobject>
+</mediaobject>
+</screenshot>
+On pages with this RSS icon<inlinemediaobject>
+  <imageobject>
+    <imagedata fileref="rss.png" format="PNG"/>
+  </imageobject>
+    </inlinemediaobject>, right-click on the icon and choose in the context
+    menu <guimenuitem>Add Feed to &akregator;</guimenuitem>:
+    <screenshot>
+      <screeninfo>Automatically finding feeds through &konqueror;</screeninfo>
+      <mediaobject>
+        <imageobject><imagedata fileref="konq.png" format="PNG"
+/></imageobject>
+        <textobject><phrase>Automatically finding feeds through
+            &konqueror;</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para>
+</sect1>
+
+<sect1 id="creating-folder">
+<title>Creating a Folder</title>
+<para>After adding your own feeds, you may want to group them in some way,
+rather than just leave them unsorted. So let us create a folder for the
+Slashdot feed we just added:</para>
+<itemizedlist>
+<listitem><para>Select the parent folder of the new folder. In this example, we
+select <guilabel>All Feeds</guilabel>.
+</para></listitem>
+<listitem><para>Open <guimenu>Feed</guimenu>
+<guimenuitem>New Folder...</guimenuitem>.
+Enter <userinput>News</userinput> (or a more appropriate name for the feed category) in the line edit and choose <guibutton>OK</guibutton>.
+<screenshot>
+<screeninfo>The New Folder dialog</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="add-folder.png" format="PNG" /></imageobject>
+<textobject><phrase>The New Folder dialog</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para> </listitem>
+<listitem><para>Now you can drag the Slashdot feed to the new folder.
+<screenshot>
+<screeninfo>The News folder in the feed list</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="add-folder2.png" format="PNG" /></imageobject>
+<textobject><phrase>The News folder in the feed list</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para> </listitem>
+</itemizedlist>
+</sect1>
+
+<sect1 id="browsing-inside">
+<title>Browsing inside of &akregator;</title>
+<para>When reading feed articles, often you may want to read the web page that
+belongs to the article: some articles only contain the headline, and not the actual
+content. In this case, you need to visit the web page to read the complete article. Or perhaps
+an article links to some website, or you are reading a blog and want to comment
+on an entry. For these situations, &akregator; contains a simple web browser.
+Whenever you follow a link in the article viewer, &akregator; opens the link in
+new tab:</para>
+<note><para>Note that the browser in &akregator; is not intended to replace your
+favorite Web Browser. It is meant for reading articles, commenting on them, or
+following up a link quickly. It is not meant for browsing the web in general. It
+lacks many features fully-fledged web browsers offer.</para></note>
+</sect1>
+</chapter>
+
+<chapter id="configuration">
+<title>Configuring &akregator;</title>
+<para>Most of &akregator;'s options are listed in the &akregator; configuration
+dialog. The configuration dialog can be found in the menu under <menuchoice>
+<guimenu>Settings</guimenu><guimenuitem>Configure &akregator;...</guimenuitem>
+</menuchoice></para>
+<sect1 id="general-tab">
+<title>General</title>
+<para>The General tab contains the basic and otherwise-uncategorizable options of &akregator;.</para>
+<screenshot>
+<screeninfo>The General tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="general-tab.png" format="PNG" /></imageobject>
+<textobject><phrase>The General tab</phrase></textobject>
+</mediaobject>
+</screenshot>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Global</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Show tray icon</guilabel></term>
+<listitem><para>Display the &akregator; icon in the systray.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Use notifications for all feeds</guilabel></term>
+<listitem><para>Set global notifications for all feeds. This setting will
+override the individual notification value of each feed. When enabled, &akregator; will notify you of all new articles fetched in any feed. If you only want to enable notifications for some (but not all) feeds, leave this option disabled and enable notifications for the each specific feed using the individual feed properties dialog.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Use interval fetching</guilabel></term>
+<listitem><para>If this is unchecked, interval checking is disabled. However, if this is checked, you can set in <guilabel>Fetch feeds
+every:</guilabel> the interval that &akregator; will automatically check for new feed entries. Note that fetching articles generates traffic and therefore may be costly to the provider hosting the feed you're reading. Some sites may even block connections from your computer if you attempt to fetch the feed too often. In general, 30 minutes is a good choice. </para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Fetch feeds every:</guilabel></term>
+<listitem><para>This is enabled when <guilabel>Use interval
+fetching</guilabel> is checked. You can specify a time interval, after which
+feeds are checked for new articles. Default is 30 minutes.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Startup</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Mark all feeds as read on startup</guilabel></term>
+<listitem><para>When enabled, &akregator; marks all articles as read when
+started.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Fetch all feeds on startup</guilabel></term>
+<listitem><para>When enabled, &akregator; fetches all feeds right after
+start.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Network</guilabel></term>
+<listitem>
+<variablelist>
+<varlistentry>
+<term><guilabel>Use the browser cache (less network traffic)</guilabel></term>
+<listitem><para>When enabled, the &kde;-wide browser cache settings are used when
+updating feeds. You can configure the &kde;-wide browser cache either in
+&kcontrolcenter; or in &konqueror; configuration dialog.</para>
+<note><para>You should leave this option enabled whenever possible. Disabling
+this option leads to increased network traffic. The traffic caused by
+aggregators not using caching increases the costs for providers and may decrease the number of feeds are offered in future.</para></note>
+</listitem>
+</varlistentry>
+</variablelist>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect1>
+<sect1 id="archive-tab">
+<title>Archive</title>
+<para>Archiving articles means storing the links of articles. Here you can limit the
+number of articles stored and the method used for archiving. These settings are
+global settings, used by all feeds within &akregator;. If you want to use a custom
+setting for a feed, you can set it in each feed properties dialog in the archive
+tab.</para>
+<screenshot>
+<screeninfo>The Archive tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="archive-tab.png" format="PNG" /></imageobject>
+<textobject><phrase>The Archive tab</phrase></textobject>
+</mediaobject>
+</screenshot>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Default Archive Settings</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Keep all articles</guilabel></term>
+<listitem><para>All articles are kept forever.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Limit feed archive size to:</guilabel></term> 
+<listitem><para>If the number of articles exceeds the chosen limit, the oldest
+articles are deleted. Note that flagged articles are ignored when counting the
+number of articles: if your limit is 500, and you have 510 unflagged and 50
+flagged articles, &akregator; will ignore the 50 flagged ones and only delete
+the 10 oldest unflagged articles. So in this example, 550 articles would be kept.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Delete articles older than:</guilabel></term>
+<listitem><para>Articles older than the specified number of days are deleted from the archive, unless they have the keep flag set. &akregator; checks for expired articles at startup and then once per hour, so expiry may be delayed.</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Disable archiving</guilabel></term>
+<listitem><para>No articles are stored - all articles are discarded when
+quitting &akregator;.</para> </listitem>
+</varlistentry>
+</variablelist>
+
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Do not expire important articles</guilabel></term>
+<listitem><para>Right clicking on an article opens a context menu where
+you can mark this article as Important. Articles marked as Important will not
+expire, they will be kept.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect1>
+<sect1 id="appearance-tab">
+<title>Appearance</title>
+<para>On this page you can configure the appearance of the article viewer and
+the browser tabs. You can specify the font sizes and families to be used.
+</para>
+<screenshot>
+<screeninfo>The Appearance tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="appearance-tab.png" format="PNG"
+/></imageobject>
+<textobject><phrase>The Appearance tab</phrase></textobject>
+</mediaobject>
+</screenshot>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Font Size</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Minimum font size</guilabel></term>
+<listitem><para>Set the minimum size for the article viewer</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Medium font size</guilabel></term>
+<listitem><para>Set the default font size for the article viewer</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Fonts</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Standard font:</guilabel></term>
+<listitem><para>In the article viewer, the content is rendered using
+the Standard font in Medium font size. If you change the Standard font,
+the change will be applied in the article viewer.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Fixed font:</guilabel></term>
+<listitem><para>If the article uses a fixed-width font in the article viewer, the
+content will be rendered using this font family in Medium font size. </para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Serif font:</guilabel></term>
+<listitem><para>If the article uses Serif fonts, they will be
+rendered using the family you choose here in Medium font size.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Sans serif font:</guilabel></term>
+<listitem><para>If the article uses Sans-serif fonts, they will be
+rendered using the family you choose here in Medium font size.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Underline links</guilabel></term>
+<listitem><para>Check this if you want links to be underlined by default.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect1>
+<sect1 id="browser-tab">
+<title>Browser</title>
+<para>This tab allows you to customize the behavior of the internal browser
+tabs.</para>
+<screenshot>
+<screeninfo>The Browser tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="browser-tab.png" format="PNG" /></imageobject>
+<textobject><phrase>The Browser tab</phrase></textobject>
+</mediaobject>
+</screenshot>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Left mouse click</guilabel></term>
+<listitem><para>You can choose three actions for the Left mouse click
+action: <guilabel>Open in Tab</guilabel> (open the link in a tab and put this
+tab in focus), <guilabel>Open in Background Tab</guilabel> (open the link in a
+tab but keep the current tab in focus) and <guilabel>Open in External
+Browser (open in a new window with your default browser)</guilabel>.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Middle mouse click</guilabel></term>
+<listitem><para>As above, you can set one of the three actions for the
+middle mouse click.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>For External Browsing</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Use default &kde; web browser</guilabel></term>
+<listitem><para>If this is checked, &akregator; will use the web browser
+you set in &kcontrolcenter;. It may be the KDE default, &konqueror;, or another browser
+depending on what you set here.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Use this command:</guilabel></term>
+<listitem><para>You can use another web browser for &akregator; other than your
+&kde; default. If you wish to do so, check this option and enter the command for the
+browser, provided it is in your $<envar>PATH</envar>.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Show tab close button on hover</guilabel></term>
+<listitem><para>If this option is checked, the close button will appear when
+you move your mouse on the left side of the tab title so you can more easily
+close tabs.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect1>
+<sect1 id="advanced-tab">
+<title>Advanced</title>
+<para>The Advanced tab allows you to set more advanced options. If you
+are not sure about their effect, you can just leave the dafault ones.</para>
+<screenshot>
+<screeninfo>The Advanced tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="advanced-tab.png" format="PNG" /></imageobject>
+<textobject><phrase>The Advanced tab</phrase></textobject>
+</mediaobject>
+</screenshot>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Archive</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Archive backend:</guilabel></term>
+<listitem><para>&akregator; currently only uses the Metakit database but for &kde; 4, &akregator; will offer other database backends.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Article List</guilabel></term>
+<listitem>
+
+<variablelist>
+<varlistentry>
+<term><guilabel>Mark selected article read after</guilabel></term>
+<listitem><para>Default is 0 seconds, which means that as soon as
+you click on an article it is marked as read. You can choose to mark any
+article as read after a specified number of seconds.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><guilabel>Reset search bar when changing feeds</guilabel></term>
+<listitem><para>This will clear the search bar when you change feed.</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect1>
+</chapter>
+
+<chapter id="commands">
+<title>Command Reference</title>
+
+<sect1 id="akregator-mainwindow">
+<title>Menus and Shortcut Keys</title>
+
+<sect2>
+<title>The <guimenu>File</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<guimenu>File</guimenu>
+<guimenuitem>Import feeds...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the import feeds dialog</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>File</guimenu>
+<guimenuitem>Export feeds...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the save as dialog</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<shortcut>
+<keycombo action="simul">&Ctrl;<keycap>P</keycap></keycombo>
+</shortcut>
+<guimenu>File</guimenu>
+<guimenuitem>Print...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the print dialog</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut>
+<keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo>
+</shortcut>
+<guimenu>File</guimenu>
+<guimenuitem>Quit</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Quit</action> &akregator;</para></listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Edit</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<shortcut>
+<keycap>F2</keycap>
+</shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Edit Feed...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Edit</action> current feed to change its properties in
+the Properties dialog</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut>
+<keycombo action="simul">&Alt;<keycap>Delete</keycap></keycombo>
+</shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Delete feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Delete</action> current feed</para></listitem>
+</varlistentry>
+<varlistentry>
+<term>
+<menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>C</keycap></keycombo></shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Copy</guimenuitem>
+</menuchoice>
+</term>
+<listitem>
+<para>Copy selected text to the clipboard</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term>
+<menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>A</keycap></keycombo></shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Select All</guimenuitem>
+</menuchoice>
+</term>
+<listitem>
+<para>Select all text in the article viewer</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>F</keycap></keycombo></shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Find...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Launch</action> the Find Text dialog to allow you to
+search for text in the article viewer</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut>
+<keycap>F3</keycap>
+</shortcut>
+<guimenu>Edit</guimenu>
+<guimenuitem>Find Next</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the nearest match (down the list) of the
+search term (text or regular expression) searched for within the article viewer, starting
+from cursor position</para></listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>View</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<guimenu>View</guimenu>
+<guimenuitem>View Mode</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Choose</action> the View Mode for &akregator;</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>+</keycap></keycombo></shortcut>
+<guimenu>View</guimenu>
+<guimenuitem>Increase Font Sizes</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Increase</action> the font size in the article
+viewer</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>-</keycap></keycombo></shortcut>
+<guimenu>View</guimenu>
+<guimenuitem>Decrease Font Sizes</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Decrease</action> the font size in the article
+viewer</para>
+</listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Go</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>Left</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Previous Article</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the previous article in the article
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>-</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Previous Unread Article</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the previous unread
+article in the article list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>Right</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Next Article</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the next article in the article
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>+</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Next Unread Article</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the next unread article in the article
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>P</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Previous Feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the previous feed in the feed
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Alt;<keycap>-</keycap></keycombo></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Previous Unread Feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the previous unread feed in the feed
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>N</keycap></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Next Feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the next feed in the feed
+list</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Alt;<keycap>+</keycap></keycombo></shortcut>
+<guimenu>Go</guimenu>
+<guimenuitem>Next Unread Feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Go</action> to the next unread feed in the feed
+list</para></listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Feed</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>Insert</keycap></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Add Feed...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the Add Feed dialog</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Shift;<keycap>Insert</keycap></keycombo></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>New Folder...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the Add Folder dialog</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>R</keycap></keycombo></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Mark Feed as Read</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Mark</action> the current feed as read</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl; &Shift;<keycap>R</keycap></keycombo></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Mark All Feeds as Read</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Mark</action> all feeds as already
+read</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>F5</keycap></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Fetch Feed</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Fetch</action> the current feed</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>L</keycap></keycombo></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Fetch All Feeds</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Fetch</action> all feeds</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>Escape</keycap></shortcut>
+<guimenu>Feed</guimenu>
+<guimenuitem>Abort Fetches</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Stop</action> &akregator; fetching
+feeds</para></listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Article</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Shift;<keycap>Return</keycap></keycombo></shortcut>
+<guimenu>Article</guimenu>
+<guimenuitem>Open in Tab</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the current article in a
+tab within &akregator;</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl; &Shift;<keycap>Return</keycap></keycombo></shortcut>
+<guimenu>Article</guimenu>
+<guimenuitem>Open in External Browser.</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> the current article iin
+an external browser</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycombo
+action="simul">&Ctrl;<keycap>I</keycap></keycombo></shortcut>
+<guimenu>Article</guimenu>
+<guimenuitem>Mark as Important</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Mark</action> the current article as
+important</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<guimenu>Article</guimenu>
+<guimenuitem>Mark as</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Mark</action> the current article as
+Read, New or Unread</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<shortcut><keycap>Delete</keycap></shortcut>
+<guimenu>Article</guimenu>
+<guimenuitem>Delete</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Delete</action> the current article</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<guimenu>Article</guimenu>
+<guimenuitem>Send Link Address...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> your mail client and attach the link
+in the mail.</para></listitem>
+</varlistentry>
+<varlistentry>
+<term><menuchoice>
+<guimenu>Article</guimenu>
+<guimenuitem>Send File...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> your mail client and attach the file
+in the mail.
+</para></listitem>
+</varlistentry>
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Settings</guimenu> Menu</title>
+
+<variablelist>
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guisubmenu>Toolbars</guisubmenu>
+</menuchoice></term>
+<listitem><para><action>Toggle</action> the toolbars</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+
+<guimenu>Settings</guimenu>
+<guimenuitem>Show/Hide Statusbar</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Toggle</action> the statusbar</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guimenuitem>Show Quick Filter</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Toggle</action> the Quick Filter (Show/Hide it)
+<screenshot>
+<screeninfo>The Quick Filter</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="quick-filter.png" format="PNG" /></imageobject>
+<textobject><phrase>The Quick Filter</phrase></textobject>
+</mediaobject>
+</screenshot>
+</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guimenuitem>Configure Notifications...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Display</action> the Notifications Settings dialog
+</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guimenuitem>Configure &akregator;...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Display</action> the &akregator; settings dialog
+</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guimenuitem>Configure Shortcuts...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Open</action> standard &kde; setting dialog that allows
+you to choose different shortcut keys for different actions
+</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><menuchoice>
+<guimenu>Settings</guimenu>
+<guimenuitem>Configure Toolbars...</guimenuitem>
+</menuchoice></term>
+<listitem><para><action>Configure</action> the items you want to put in the
+toolbar
+</para></listitem>
+</varlistentry>
+
+</variablelist>
+
+</sect2>
+
+<sect2>
+<title>The <guimenu>Help</guimenu> Menu</title>
+&help.menu.documentation;
+</sect2>
+</sect1>
+</chapter>
+
+<chapter id="credits">
+
+<title>Credits and License</title>
+
+<para>
+&akregator;
+</para>
+<para>
+Program copyright 2004-2006 Frank Osterfeld
+<email>frank.osterfeld@kdemail.net</email> 
+</para>
+
+<para>
+Documentation copyright 2006 
+Frank Osterfeld <email>frank.osterfeld@kdemail.net</email>
+</para>
+
+<para>
+Documentation copyright 2006
+&Anne-Marie.Mahfouf; &Anne-Marie.Mahfouf.mail;
+</para>
+
+<!-- TRANS:CREDIT_FOR_TRANSLATORS -->
+&underFDL;               <!-- FDL: do not remove -->
+&underGPL;           <!-- GPL License -->
+
+</chapter>
+
+<appendix id="installation">
+<title>Installation</title>
+
+<sect1 id="getting-akregator">
+<title>How to obtain &akregator;</title>
+
+&install.intro.documentation;
+
+</sect1>
+
+<sect1 id="compilation">
+<title>Compilation and installation</title>
+
+&install.compile.documentation;
+
+</sect1>
+</appendix>
+
+&documentation.index;
 </book>
-
 <!--
 Local Variables:
 mode: sgml
-sgml-minimize-attributes:nil
-sgml-general-insert-case:lower
+sgml-minimize-attributes: nil
+sgml-general-insert-case: lower
 sgml-indent-step:0
 sgml-indent-data:nil
 End:
-
-// vim:ts=2:sw=2:tw=78:noet
--->
+-->
\ brakuje znaku końca linii na końcu pliku 
Index: doc/akregator/appearance-tab.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/appearance-tab.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/rss.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/rss.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/konq.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/konq.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/advanced-tab.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/advanced-tab.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/main-window2.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/main-window2.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/add-feed2.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/add-feed2.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/main-window3.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/main-window3.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/main-window4.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/main-window4.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/general-tab.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/general-tab.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/add-folder2.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/add-folder2.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/archive-tab.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/archive-tab.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/browser-tab.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/browser-tab.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/main-window.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/main-window.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/add-feed.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/add-feed.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/konq2.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/konq2.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/akregator/rss3.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png

Zmiany atrybutów dla: doc/akregator/rss3.png
___________________________________________________________________
Nazwa: svn:mime-type
   + image/png

Index: doc/kleopatra/index.docbook
===================================================================
--- doc/kleopatra/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ doc/kleopatra/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -7,46 +7,49 @@
   <!ENTITY gpgconf "<application>GpgConf</application>">
   <!ENTITY kappname "&kleopatra;">
   <!ENTITY package "kdepim">
+  <!ENTITY smime "<acronym>S/MIME</acronym>">
   <!ENTITY % addindex "IGNORE">
   <!ENTITY % English "INCLUDE">
 
   <!ENTITY dn "<acronym>DN</acronym>">
   <!ENTITY ca "<acronym>CA</acronym>">
 
-  <!-- FILE menu -->
+  <!-- Expanded all entities to make them translatable - lueck
+    FILE menu 
   <!ENTITY file-new-key-pair "<menuchoice><guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice>">
   <!ENTITY file-export-certificates "<menuchoice><guimenu>File</guimenu><guimenuitem>Export Certificates...</guimenuitem></menuchoice>">
   <!ENTITY file-export-secret-key "<menuchoice><guimenu>File</guimenu><guimenuitem>Export Secret key...</guimenuitem></menuchoice>">
   <!ENTITY file-import-certificates "<menuchoice><guimenu>File</guimenu><guimenuitem>Import Certificates...</guimenuitem></menuchoice>">
   <!ENTITY file-import-crls "<menuchoice><guimenu>File</guimenu><guimenuitem>Import CRLs...</guimenuitem></menuchoice>">
-  <!ENTITY file-quit "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>Q</keycap></keycombo></shortcut><guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice>">
+  <!ENTITY file-quit "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo></shortcut><guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice>">
 
-  <!-- VIEW menu -->
-  <!ENTITY view-redisplay "<menuchoice><shortcut><keycombo action='simul'><keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice>">
-  <!ENTITY view-stop-operation "<menuchoice><shortcut><keycombo action='simul'><keycap>Esc</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice>">
+   VIEW menu
+  <!ENTITY view-redisplay "<menuchoice><shortcut><keycombo action="simul"><keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice>">
+  <!ENTITY view-stop-operation "<menuchoice><shortcut><keycombo action="simul"><keycap>Esc</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice>">
   <!ENTITY view-certificate-details "<menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice>">
   <!ENTITY view-hierarchical-key-list "<menuchoice><guimenu>View</guimenu><guimenuitem>Hierarchical Key List</guimenuitem></menuchoice>">
-  <!ENTITY view-expand-all "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>.</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice>">
-  <!ENTITY view-collapse-all "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>,</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice>">
+  <!ENTITY view-expand-all "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>.</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice>">
+  <!ENTITY view-collapse-all "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>,</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice>">
 
-  <!-- CERTIFICATES menu -->
- <!ENTITY certificates-validate "<menuchoice><shortcut><keycombo action='simul'>&Shift;<keycap>F5</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice>">
+   CERTIFICATES menu 
+ <!ENTITY certificates-validate "<menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice>">
   <!ENTITY certificates-refresh-crls "<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice>">
-  <!ENTITY certificates-delete "<menuchoice><shortcut><keycombo action='simul'><keycap>Delete</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice>">
+  <!ENTITY certificates-delete "<menuchoice><shortcut><keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice>">
   <!ENTITY certificates-download "<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice>">
 
-  <!-- CRLS menu -->
+   CRLS menu
   <!ENTITY crls-clear-crl-cache "<menuchoice><guimenu>CRLs</guimenu><guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice>">
   <!ENTITY crls-dump-crl-cache "<menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice>">
 
-  <!-- TOOLS menu -->
+   TOOLS menu 
   <!ENTITY tools-gnupg-log-viewer "<menuchoice><guimenu>Tools</guimenu><guimenuitem>GnuPG Log Viewer...</guimenuitem></menuchoice>">
 
-  <!-- SETTINGS menu -->
+   SETTINGS menu 
   <!ENTITY settings-show-statusbar "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Show Statusbar</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-shortcuts "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure Shortcuts...</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-kleopatra "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-gpgme-backend "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice>">
+   -->
 
   <!-- Command line options -->
   <!ENTITY commandline-option-external "<option>--external</option>">
@@ -76,10 +79,9 @@
 
 <othercredit role="developer">
 <firstname>Steffen</firstname>
-<othername></othername>
 <surname>Hansen</surname>
 <affiliation>
-<address><email>steffen@klaralvdalens-datakonsult.se</email></address>
+<address>&Steffen.Hansen.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -94,7 +96,7 @@
 <firstname>Jesper</firstname>
 <surname>Pedersen</surname>
 <affiliation>
-<address><email>blackie@kde.org</email></address>
+<address>&Jesper.Pedersen.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -102,7 +104,7 @@
 <firstname>Daniel</firstname>
 <surname>Molkentin</surname>
 <affiliation>
-<address><email>molkentin@kde.org</email></address>
+<address>&Daniel.Molkentin.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -139,7 +141,7 @@
 the &gpgsm; keybox and for retrieving certificates from
 <acronym>LDAP</acronym> servers.</para>
 
-<para>&kleopatra; can be started from KMail's <guimenu>Tools</guimenu>
+<para>&kleopatra; can be started from &kmail;'s <guimenu>Tools</guimenu>
 menu, as well as from the command line. The &kleopatra; executable is
 named <userinput><command>kleopatra</command></userinput>.</para>
 
@@ -166,12 +168,12 @@
 
 <para>The main window is divided into the large key listing area, the
 menubar and the <link linkend="functions-search">search bar</link> on
-top, and a statusbar at the bottom.</para>
+top, and a status bar at the bottom.</para>
 
 <para>Each line in the key list corresponds to one certificate,
 identified by the so-called <guilabel>Subject &dn;</guilabel>. &dn; is
 an acronym for <quote>Distinguished Name</quote>, a hierarchical
-identifier, much like a filesystem path with an unusual syntax, that is
+identifier, much like a file system path with an unusual syntax, that is
 supposed to globally uniquely identify a given certificate.</para>
 
 <para>To be valid, and thus usable, (public) keys need to be signed by
@@ -180,7 +182,7 @@
 <quote>(public) key</quote> are used interchangeably, and we will not
 distinguish between them in this manual either, except when explicitly
 noted. The name of the &ca; which issued the certificate (its &dn;)
-is shown in the <guilabel>Issuer DN</guilabel> column.</para>
+is shown in the <guilabel>Issuer &dn;</guilabel> column.</para>
 
 <para>&ca;s must in turn be signed by other &ca;s to be valid. Of
 course, this must end somewhere, so the top-level &ca; (root-&ca;)
@@ -193,24 +195,33 @@
 
 <para>To see which of the certificates are root certificates, you can
 either compare <guilabel>Subject &dn;</guilabel> and <guilabel>Issuer
-&dn;</guilabel>, or you switch to hierarchical keylist mode with <xref
-linkend="view-hierarchical-key-list"/>.</para>
+&dn;</guilabel>, or you switch to hierarchical keylist mode with <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link>.</para>
 
 <para>You can see the details of any certificate by double-clicking it
-or using <xref linkend="view-certificate-details"/>. This opens a
+or using <link linkend="view-certificate-details"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Certificate Details...</guimenuitem></menuchoice></link>. This opens a
 dialog that shows the most common properties of the certificate, its
 certificate chain (&ie; the chain of issuers up to the root-&ca;), and
 a dump of all information the backend is able to extract from the
 certificate.</para>
 
 <para>If you change the keybox without using &kleopatra; (&eg; using
-&gpgsm;'s command line interface), you can refresh the view with <xref
-linkend="view-redisplay"/>.</para>
+&gpgsm;'s command line interface), you can refresh the view with <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>.</para>
 
 <para>Since validating a key may take some time (&eg; CRLs might need
 to be fetched), the normal keylisting does not attempt to check the
-validity of keys. For this, <xref linkend="certificates-validate"/>, a
-special variant of <xref linkend="view-redisplay"/>, is provided. It
+validity of keys. For this, <link linkend="certificates-validate">
+<menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo>
+</shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></link>, a
+special variant of <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>, is provided. It
 either checks the selected certificates, or all keys if none are
 selected.</para>
 
@@ -234,8 +245,10 @@
 you want the certificate for) into the line edit, and click on the
 <guilabel>Find</guilabel> icon. The results will be displayed in the
 key list below the search bar, where you can select certificates to
-either look at them with <xref linkend="view-certificate-details"/> or
-download them with <xref linkend="certificates-download"/> into the
+either look at them with <link linkend="view-certificate-details">
+<menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice></link> or
+download them with <link linkend="certificates-download">
+<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice></link> into the
 local keybox. Note that you can also download the certificate from the
 details dialog, using the <guilabel>Import to Local</guilabel>
 button.</para>
@@ -245,8 +258,9 @@
 Services</guilabel></link> page of &kleopatra;'s <link
 linkend="configuration">configure dialog</link>.</para>
 
-<para>If you received the certificate as a file, try <xref
-linkend="file-import-certificates"/>. &gpgsm; needs to understand the
+<para>If you received the certificate as a file, try <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>. &gpgsm; needs to understand the
 format of the certificate file; please refer to &gpgsm;'s manual for a
 list of supported file formats.</para>
 
@@ -257,19 +271,22 @@
 linkend="commandline-option-import-certificate"><userinput><command>kleopatra
 &commandline-option-import-certificate;
 <filename>filename</filename></command></userinput></link> or from
-within &kleopatra; with <xref linkend="file-import-certificates"/>,
+within &kleopatra; with <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>,
 just as you would to for <quote>normal</quote> certificates.</para>
 
 </sect1>
 
 <sect1 id="functions-newkey"><title>Creating New Key Pairs</title>
 
-<para>The menu item <xref linkend="file-new-key-pair"/> starts the
+<para>The menu item <link linkend="file-new-key-pair"><menuchoice>
+<guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice></link> starts the
 certificate-request-creating wizard which will guide you through a
 number of steps to create a certificate request; this request can, on the 
-last page of the wizard, either be sent to a certificate authority (CA)
+last page of the wizard, either be sent to a certificate authority (&ca;)
 to be signed or saved to a file (for example to a floppy, so it can be
-shipped to the CA).</para> <para>Whenever you are done with a step in
+shipped to the &ca;).</para> <para>Whenever you are done with a step in
 the wizard, press <guibutton>Next</guibutton> to go to the next step
 (or <guibutton>Back</guibutton> to review steps that are already
 completed). The certificate request creation can be canceled at any
@@ -304,7 +321,7 @@
 </itemizedlist>
 </para><para>
 The next step in the wizard is to select whether to store the
-certificate in a file or send it directly to a CA. You will have to
+certificate in a file or send it directly to a &ca;. You will have to
 specify the filename or email address to send the certificate request to.
 </para></sect1>
 
@@ -319,10 +336,15 @@
 keybox.</para>
 
 <para>These functions include deleting certificates from the local
-keybox with <xref linkend="certificates-delete"/>, as well as manual
-handling of CRLs (<xref linkend="certificates-refresh-crls"/>, <xref
-linkend="crls-clear-crl-cache"/>, <xref
-linkend="crls-dump-crl-cache"/>).</para>
+keybox with <link linkend="certificates-delete"><menuchoice><shortcut>
+<keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut>
+<guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice></link>, as well 
+as manual handling of CRLs (<link linkend="certificates-refresh-crls">
+<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem>
+</menuchoice></link>, <link linkend="crls-clear-crl-cache"><menuchoice><guimenu>CRLs</guimenu>
+<guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice></link>, <link
+linkend="crls-dump-crl-cache"><menuchoice><guimenu>CRLs</guimenu>
+<guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice></link>).</para>
 
 </sect1>
 
@@ -335,12 +357,12 @@
 <variablelist>
 
 <varlistentry id="file-new-key-pair">
-<term>&file-new-key-pair;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Creates a new key pair (public and private)</action> and
 allows to send the public part to a certification authority
-(<acronym>CA</acronym>) for signing. The resulting certificate is then
+(&ca;) for signing. The resulting certificate is then
 sent back to you, or stored in an LDAP server for you to download into
 your local keybox, where you can use it to sign and decrypt
 mails.</para>
@@ -349,20 +371,21 @@
 generation</quote>, since all keys are created locally. &kleopatra;
 (and &gpgsm;) do not support <quote>centralized key generation</quote>
 directly, but you can import the public/secret key bundle that you
-receive from the CA in PKCS#12 format via
-&file-import-certificates;.</para>
+receive from the &ca; in PKCS#12 format via <menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice>.</para>
 </listitem>
 </varlistentry>
 
 
 <varlistentry id="file-export-certificates">
-<term>&file-export-certificates;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Export Certificates...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Exports the selected certificates</action> into a file.</para>
 
 <note><para>This exports only the public keys, even if the
-secret key is available. Use &file-export-secret-key; to export both
+secret key is available. Use <menuchoice><guimenu>File</guimenu><guimenuitem>Export 
+Secret key...</guimenuitem></menuchoice> to export both
 public and secret keys into a file, but note that this is almost
 always a bad idea.</para></note>
 </listitem>
@@ -370,7 +393,7 @@
 
 
 <varlistentry id="file-export-secret-key">
-<term>&file-export-secret-key;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Export Secret key...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Exports both the public and the secret key to a
@@ -386,7 +409,7 @@
 
 
 <varlistentry id="file-import-certificates">
-<term>&file-import-certificates;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Import Certificates...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Imports certificates and/or secret keys from files into
@@ -400,7 +423,7 @@
 
 
 <varlistentry id="file-import-crls">
-<term>&file-import-crls;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Import CRLs...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Lets you manually import CRLs from
@@ -417,7 +440,8 @@
 <application>dirmngr</application>.</para></note>
 
 <para>You can view the contents of the local CRL cache from the menu
-item &crls-dump-crl-cache;. This will display a dialog with
+item <menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem>
+</menuchoice>. This will display a dialog with
 information about the CRLs in the cache and the fingerprints of the
 certificates in each CRL.
 </para>
@@ -426,7 +450,8 @@
 
 
 <varlistentry id="file-quit">
-<term>&file-quit;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo></shortcut>
+<guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Terminates &kleopatra;.</action></para>
@@ -444,7 +469,8 @@
 <variablelist>
 
 <varlistentry id="view-redisplay">
-<term>&view-redisplay;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>F5</keycap></keycombo>
+</shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Redisplays the selected certificates or refreshes the
@@ -468,7 +494,8 @@
 
 
 <varlistentry id="view-stop-operation">
-<term>&view-stop-operation;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>Esc</keycap></keycombo></shortcut>
+<guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Stops (cancels) all pending operations,</action> &eg; a
@@ -483,7 +510,7 @@
 
 
 <varlistentry id="view-certificate-details">
-<term>&view-certificate-details;</term>
+<term><menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Shows the details of the currently selected
@@ -498,7 +525,7 @@
 
 
 <varlistentry id="view-hierarchical-key-list">
-<term>&view-hierarchical-key-list;</term>
+<term><menuchoice><guimenu>View</guimenu><guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action> Toggles between hierarchical and flat keylist mode.
@@ -519,11 +546,13 @@
 
 
 <varlistentry id="view-expand-all">
-<term>&view-expand-all;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>.</keycap>
+</keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice></term>
 
 <listitem>
-<para>(This function is only available when <xref
-linkend="view-hierarchical-key-list"/> is on.)</para>
+<para>(This function is only available when <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> is on.)</para>
 
 <para><action>Expands all list items in the certificate list
 view,</action> &ie; makes all items visible.</para>
@@ -539,11 +568,13 @@
 
 
 <varlistentry id="view-collapse-all">
-<term>&view-collapse-all;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>,</keycap>
+</keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice></term>
 
 <listitem>
-<para>(This function is only available when <xref
-linkend="view-hierarchical-key-list"/> is on.)</para>
+<para>(This function is only available when <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> is on.)</para>
 
 <para><action>Collapses all list items in the certificate list
 view,</action> &ie; hides all but the top-level items.</para>
@@ -562,12 +593,16 @@
 <variablelist>
 
 <varlistentry id="certificates-validate">
-<term>&certificates-validate;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo>
+</shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Validates selected (or all) keys.</action></para>
 
-<para>This is similar to <xref linkend="view-redisplay"/>, but
+<para>This is similar to <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>, but
 performs a validation of the (selected) keys. Validation here means
 that all relevant CRLs are fetched, and the certificate chain is
 checked for correctness. As a result, invalid or expired keys will be
@@ -588,7 +623,7 @@
 
 
 <varlistentry id="certificates-refresh-crls">
-<term>&certificates-refresh-crls;</term>
+<term><menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Fetches the current CRLs for all selected keys,</action>
@@ -616,7 +651,8 @@
 
 
 <varlistentry id="certificates-delete">
-<term>&certificates-delete;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut>
+<guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Deletes selected certificate(s)</action> from the local keyring.</para>
@@ -626,8 +662,9 @@
 emails, verifying an email might result in the key just removed to pop
 back into the local keybox. So it is probably best to avoid using this
 function as much as possible. When you are lost, use the <link
-linkend="functions-search">search bar</link> or the <xref
-linkend="view-hierarchical-key-list"/> function to regain control over
+linkend="functions-search">search bar</link> or the <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> function to regain control over
 the lot of certificates.</para>
 </listitem>
 </varlistentry>
@@ -635,7 +672,7 @@
 
 
 <varlistentry id="certificates-download">
-<term>&certificates-download;</term>
+<term><menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Downloads the selected certificate(s) from the LDAP to the local keybox.</action></para>
@@ -653,19 +690,19 @@
 <variablelist>
 
 <varlistentry id="crls-clear-crl-cache">
-<term>&crls-clear-crl-cache;</term>
+<term><menuchoice><guimenu>CRLs</guimenu><guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Clears the &gpgsm; CRL cache.</action></para>
 
 <para>You probably never need this. You can force a refresh of the CRL
-cache by selecting all certificates and using <xref
-linkend="certificates-refresh-crls"/> instead.</para>
+cache by selecting all certificates and using <link linkend="certificates-refresh-crls"><menuchoice>
+<guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice></link> instead.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry id="crls-dump-crl-cache">
-<term>&crls-dump-crl-cache;</term>
+<term><menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Shows the detailed contents of the &gpgsm; CRL
@@ -682,7 +719,7 @@
 <variablelist>
 
 <varlistentry id="tools-gnupg-log-viewer">
-<term>&tools-gnupg-log-viewer;</term>
+<term><menuchoice><guimenu>Tools</guimenu><guimenuitem>GnuPG Log Viewer...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Starts <ulink url="help:/kwatchgnupg/index.html">&kwatchgnupg;</ulink></action></para>
@@ -698,7 +735,7 @@
 <variablelist>
 
 <varlistentry id="settings-show-statusbar">
-<term>&settings-show-statusbar;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Show Statusbar</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Toggles the visibility of the bottom status bar.</action></para>
@@ -706,7 +743,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-shortcuts">
-<term>&settings-configure-shortcuts;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure Shortcuts...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens the standard &kde; shortcut configuration dialog,
@@ -716,7 +753,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-kleopatra">
-<term>&settings-configure-kleopatra;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens &kleopatra;'s configure dialog.</action></para>
@@ -726,7 +763,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-gpgme-backend">
-<term>&settings-configure-gpgme-backend;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens a dialog that allows you to configure every aspect of
@@ -789,8 +826,9 @@
 <para><action>Specifies a file or URL from which to import
 certificates (or secret keys) from.</action></para>
 
-<para>This is the command line equivalent of <xref
-linkend="file-import-certificates"/>.</para>
+<para>This is the command line equivalent of <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>.</para>
 </listitem>
 </varlistentry>
 
@@ -800,8 +838,9 @@
 
 <chapter id="configuration"><title>Configuring &kleopatra;</title>
 
-<para>&kleopatra;'s configure dialog can be accessed via <xref
-linkend="settings-configure-kleopatra"/>.</para>
+<para>&kleopatra;'s configure dialog can be accessed via <link
+linkend="settings-configure-kleopatra"><menuchoice><guimenu>Settings</guimenu>
+<guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice></link>.</para>
 
 <para>Each of its pages is described in the sections below.</para>
 
@@ -810,13 +849,14 @@
 <para>On this page, you can configure which LDAP servers to use for
 certificate searches. You can also configure their order, as well as
 some selected LDAP-related settings from the dynamic backend
-configuration dialog, available via <xref
-linkend="settings-configure-gpgme-backend"/>.</para>
+configuration dialog, available via <link
+linkend="settings-configure-gpgme-backend"><menuchoice><guimenu>Settings</guimenu>
+<guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice></link>.</para>
 
 <para>To add a new server, click on the <guilabel>Add
 Service...</guilabel> button. In the dialog that appears, you can set
 the <guilabel>Server name</guilabel>, the <guilabel>Port</guilabel>
-(preset to the default LDAP port), the <guilabel>Base DN</guilabel>
+(preset to the default LDAP port), the <guilabel>Base &dn;</guilabel>
 (sometimes referred to as the search root or search base), and the
 usual <guilabel>User name</guilabel> and
 <guilabel>Password</guilabel>, both of which are only needed if the
@@ -898,7 +938,7 @@
 
 </sect1>
 
-<sect1 id="configuration-dn-order"><title>Configuring the Order DN Attributes are Shown</title>
+<sect1 id="configuration-dn-order"><title>Configuring the Order &dn; Attributes are Shown</title>
 
 <para>Although &dn;s are hierarchical, the order of the individual
 components (called relative &dn;s (RDNs), or &dn; attributes) is not
@@ -908,7 +948,7 @@
 
 <note><para>This setting does not only apply to &kleopatra;, but to all
 applications using &kleopatra; Technology. At the time of this
-writing, these include KMail, KAddressBook, as well as &kleopatra;
+writing, these include &kmail;, &kaddressbook;, as well as &kleopatra;
 itself, of course.</para></note>
 
 <para>This configuration page basically consists of two lists, one for
@@ -984,11 +1024,11 @@
 <chapter id="admin"><title>Administrator's Guide</title>
 
 <para>This Administrator's Guide describes ways to customize &kleopatra; that
-are not accessible via the GUI, but only via config files.</para>
+are not accessible via the &GUI;, but only via config files.</para>
 
 <para>It is assumed that the reader is familiar with the technology
 used for &kde; application configuration, including layout,
-filesystem location and cascading of &kde; config files, as well as
+file system location and cascading of &kde; config files, as well as
 the KIOSK framework.</para>
 
 <sect1 id="admin-certificate-request-wizard"><title>Customization of the Certificate-Creation Wizard</title>
@@ -1200,7 +1240,7 @@
 	      <entry>boolean</entry>
 	      <entry>
 		the key has been disabled (marked for not using) by
-		the user. Ignored for S/MIME keys.
+		the user. Ignored for &smime; keys.
 	      </entry>
 	    </row>
 	    <row>
@@ -1253,15 +1293,16 @@
 	      <entry>boolean</entry>
 	      <entry>
 		the key is an OpenPGP key (<literal>true</literal>),
-		or an S/MIME key (<literal>false</literal>).
+		or an &smime; key (<literal>false</literal>).
 	      </entry>
 	    </row>
 	    <row>
 	      <entry><varname>was-validated</varname></entry>
 	      <entry>boolean</entry>
 	      <entry>
-		the key has been validated (see <xref
-		linkend="certificates-validate"/>).
+		the key has been validated (see <link
+		linkend="certificates-validate"><menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo></shortcut>
+		<guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></link>).
 	      </entry>
 	    </row>
 	    <row>
@@ -1368,36 +1409,37 @@
 <chapter id="credits-and-license">
 <title>Credits and License</title>
 
-<para>&kleopatra; copyright 2002 Steffen Hansen, Matthias Kalle Dalheimer
-and Jesper Pedersen., copyright 2004 Daniel Molkentin, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
+<para>&kleopatra; copyright 2002 &Steffen.Hansen;, &Matthias.Kalle.Dalheimer;
+and &Jesper.Pedersen;., copyright 2004 &Daniel.Molkentin;, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
 
-<para>Documentation copyright 2002 Steffen Hansen, copyright 2004
-Daniel Molkentin, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
+<para>Documentation copyright 2002 &Steffen.Hansen;, copyright 2004
+&Daniel.Molkentin;, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
 
 <itemizedlist>
 <title>Contributors</title>
 <listitem>
-<para>Marc Mutz <email>mutz@kde.org</email></para>
+<para>&Marc.Mutz; &Marc.Mutz.mail;</para>
 </listitem>
 <listitem>
-<para>David Faure <email>faure@kde.org</email></para>
+<para>&David.Faure; &David.Faure.mail;</para>
 </listitem>
 <listitem>
-<para>Steffen Hansen <email>hansen@kde.org</email></para>
+<para>&Steffen.Hansen; <email>hansen@kde.org</email></para>
 </listitem>
 <listitem>
-<para>Matthias Kalle Dalheimer <email>kalle@kde.org</email></para>
+<para>&Matthias.Kalle.Dalheimer; &Matthias.Kalle.Dalheimer.mail;</para>
 </listitem>
 <listitem>
-<para>Jesper Pedersen <email>blackie@kde.org</email></para>
+<para>&Jesper.Pedersen; &Jesper.Pedersen.mail;</para>
 </listitem>
 <listitem>
-<para>Daniel Molkentin <email>molkentin@kde.org</email></para>
+<para>&Daniel.Molkentin; &Daniel.Molkentin.mail;</para>
 </listitem>
 </itemizedlist>
 
+<!-- TRANS:CREDIT_FOR_TRANSLATORS -->
+&underFDL;
 &underGPL;
-&underFDL;
 </chapter>
 
 &documentation.index; 
Index: doc/kalarm/mainwindow.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: doc/kalarm/editwindow.png
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = image/png
Index: doc/kalarm/index.docbook
===================================================================
--- doc/kalarm/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ doc/kalarm/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,5 @@
 <?xml version="1.0" ?>
-<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.1.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
+<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
   <!ENTITY kappname "&kalarm;">
   <!ENTITY package "kdepim">
   <!ENTITY % addindex "IGNORE">
@@ -16,7 +16,6 @@
 <authorgroup>
 <author>
 <firstname>David</firstname>
-<othername></othername>
 <surname>Jarvie</surname>
 <affiliation>
 <address><email>software@astrojar.org.uk</email></address>
@@ -42,8 +41,8 @@
 
 <!-- Don't change format of date and version of the documentation -->
 
-<date>2006-04-09</date>
-<releaseinfo>1.04.03</releaseinfo>
+<date>2006-12-06</date>
+<releaseinfo>1.04.07</releaseinfo>
 
 <abstract>
 <para>&kalarm; is a personal alarm message, command and email scheduler for &kde;.</para>
@@ -617,12 +616,12 @@
 <guimenuitem>Import Alarms...</guimenuitem></menuchoice>. The
 import function scans the selected calendar file for events containing
 alarms, and copies them (with new unique IDs) into &kalarm;'s calendar.
-Events without alarms, and other types of calendar entry, are
+Events without alarms, and calendar entries other than events, are
 ignored.</para>
 
 <warning><para>If you import alarms from calendar files which were
 created by applications other than &kalarm;, the alarms may be changed
-by the import process - even alarm times may change. This depends on
+by the import process &ndash; even alarm times may change. This depends on
 the data storage conventions used by the other application, and is
 unavoidable if those conventions differ from what &kalarm; expects.
 Always check imported alarms for unexpected changes, and adjust them
@@ -734,17 +733,15 @@
 
 <itemizedlist>
 <listitem>
-<para>The <guilabel>Confirm acknowledgment</guilabel> checkbox lets
-you specify whether you will be prompted for confirmation when you
-close the alarm message window. This may be used as a safeguard
-against accidental acknowledgment of alarms.</para>
-</listitem>
+<para>The <guilabel>Sound</guilabel> option allows you to select
+whether an audible alarm should sound when the alarm message is
+displayed. Choose:</para>
 
+<itemizedlist>
 <listitem>
-<para>Check <guilabel>Sound</guilabel> if you want an audible alarm
-to sound when the alarm message is displayed. Choose:</para>
+<para><guilabel>None</guilabel> to display the alarm silently.</para>
+</listitem>
 
-<itemizedlist>
 <listitem>
 <para><guilabel>Beep</guilabel> to sound a beep.</para>
 </listitem>
@@ -758,11 +755,11 @@
 </listitem>
 
 <listitem>
-<para><guilabel>File</guilabel> to play an audio file. Use the button
-on the right to display the Sound File dialog which lets you select a
-file to play and set volume and repetition options. If you hover the
-mouse over the button, a tooltip will display the audio file currently
-selected.</para>
+<para><guilabel>Sound file</guilabel> to play an audio file. Use the
+button on the right to display the Sound File dialog which lets you
+select a file to play and set volume and repetition options. If you
+hover the mouse over the button, a tooltip will display the audio file
+currently selected.</para>
 
 <note><para>&kalarm; uses the &arts; sound server for repetition and
 volume control. If &kalarm; has been built without &arts; support,
@@ -817,25 +814,6 @@
 </listitem>
 
 <listitem>
-<para>Check <guilabel>Reminder</guilabel> if you want to display a
-reminder in advance of the main alarm and of each of its recurrences
-(if any). Enter how long in advance using the edit controls beside
-the checkbox.</para>
-
-<note><para>You can only display a reminder before each repetition of
-an alarm if the repetitions are set up using the
-<guilabel>Recurrence</guilabel> tab. If the
-<guibutton>Simple Repetition</guibutton> button is used instead, a
-reminder will be displayed before the first occurrence
-only.</para></note>
-
-<para>If the alarm recurs, check <guilabel>Reminder for first
-recurrence only</guilabel> if you only want a reminder before the
-alarm's first recurrence. If this is not checked, the reminder period
-is limited to being less than the recurrence interval.</para>
-</listitem>
-
-<listitem>
 <para>Select the background color for the alarm message window.
 (The color selection list can be configured in the
 <link linkend="preferences-fontcolour">Preferences dialog</link>.)</para>
@@ -1029,6 +1007,28 @@
 </sect2>
 
 <sect2>
+<title>Reminder</title>
+
+<para>For a display alarm, check <guilabel>Reminder</guilabel> if you
+want to display a reminder in advance of the main alarm and of each of
+its recurrences (if any). Enter how long in advance using the edit
+controls beside the checkbox.</para>
+
+<note><para>You can only display a reminder before each repetition of
+an alarm if the repetitions are set up using the
+<guilabel>Recurrence</guilabel> tab. If the
+<guibutton>Simple Repetition</guibutton> button is used instead, a
+reminder will be displayed before the first occurrence
+only.</para></note>
+
+<para>If the alarm recurs, check <guilabel>Reminder for first
+recurrence only</guilabel> if you only want a reminder before the
+alarm's first recurrence. If this is not checked, the reminder period
+is limited to being less than the recurrence interval.</para>
+
+</sect2>
+
+<sect2>
 <title>Cancelation</title>
 
 <para>The late-cancelation options determine how an alarm is treated
@@ -1236,6 +1236,12 @@
 <sect2>
 <title>Other controls</title>
 
+<para>For display alarms, the
+<guilabel>Confirm acknowledgment</guilabel> checkbox lets you specify
+whether you will be prompted for confirmation when you close the alarm
+message window. This may be used as a safeguard against accidental
+acknowledgment of alarms.</para>
+
 <para>Select <guilabel>Show in &korganizer;</guilabel> to add the
 alarm to &korganizer;'s active calendar, where it will appear as an
 event without an alarm. This option allows you to track alarms in
@@ -1390,7 +1396,8 @@
 <variablelist>
 <varlistentry>
 <term><menuchoice><guimenuitem>Enable Alarms</guimenuitem></menuchoice></term>
-<listitem><para><action>Enables monitoring of alarms.</action></para>
+<listitem><para><action>Enables monitoring of alarms. This option
+only appears if alarms are currently disabled.</action></para>
 <para>See
 <link linkend="enable-disable">Enabling and disabling alarms</link>
 for details.</para>
@@ -1398,8 +1405,9 @@
 </varlistentry>
 
 <varlistentry>
-<term><menuchoice><guimenuitem>Alarms Enabled</guimenuitem></menuchoice></term>
-<listitem><para><action>Disables monitoring of alarms.</action></para>
+<term><menuchoice><guimenuitem>Disable Alarms</guimenuitem></menuchoice></term>
+<listitem><para><action>Disables monitoring of alarms. This option
+only appears if alarms are currently enabled.</action></para>
 <para>See
 <link linkend="enable-disable">Enabling and disabling alarms</link>
 for details.</para>
@@ -1574,9 +1582,9 @@
 
 <para>There are several ways to disable alarm monitoring, which
 prevents &kalarm; from displaying any further alarms either until you
-re-enable alarms, or - assuming that the <application>alarm
-daemon</application> is configured to start at login - until the next
-time you log in.</para>
+re-enable alarms, or &ndash; assuming that the <application>alarm
+daemon</application> is configured to start at login &ndash; until the
+next time you log in.</para>
 
 <para>To disable alarms without stopping the <application>alarm
 daemon</application>, do one of the following:</para>
@@ -1584,13 +1592,13 @@
 <itemizedlist>
 <listitem>
 <para>Select <menuchoice><guimenu>Actions</guimenu>
-<guimenuitem>Alarms Enabled</guimenuitem></menuchoice>.</para>
+<guimenuitem>Disable Alarms</guimenuitem></menuchoice>.</para>
 </listitem>
 
 <listitem>
 <para><mousebutton>Right</mousebutton> click on the system tray icon
 and choose
-<menuchoice><guimenuitem>Alarms Enabled</guimenuitem></menuchoice>
+<menuchoice><guimenuitem>Disable Alarms</guimenuitem></menuchoice>
 from the context menu.</para>
 </listitem>
 
@@ -1701,22 +1709,6 @@
 &kalarm;'s overall behavior:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
-This starts alarm monitoring at KDE session login, by starting the
-<application>alarm daemon</application>. Note that in order for alarms
-to be activated, you also need to select appropriate options in the
-<guilabel>Run Mode</guilabel> group box.</para>
-
-<warning><para>This option should always be checked unless you intend
-to discontinue use of &kalarm;.</para></warning>
-
-<note><para>This option is automatically reselected whenever &kalarm;
-is run. So if you have unchecked this option and want to continue to
-prevent the <application>alarm daemon</application> from running at
-login, you need to uncheck this option again each time you run
-&kalarm;.</para></note>
-</listitem>
-
 <listitem><para><guilabel>Run Mode</guilabel> group box: These options
 control &kalarm;'s system tray icon, and also allow some control over
 &kalarm;'s use of system resources by specifying whether or not to run
@@ -1730,6 +1722,13 @@
 monitors the alarm list and triggers alarms.</para>
 
 <itemizedlist>
+<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
+is run only when an alarm is triggered, if you run it manually, or
+while its system tray icon is displayed. In this mode the system tray
+icon can still be displayed, but closing the system tray icon has no
+effect on any &kalarm; windows.</para>
+</listitem>
+
 <listitem><para><guilabel>Run continuously in system tray</guilabel>:
 &kalarm; runs continuously and the system tray icon is always
 displayed while it is running. In this mode, closing the system tray
@@ -1738,10 +1737,6 @@
 are:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Autostart at login</guilabel>: This starts
-&kalarm; at &kde; session login, ensuring that &kalarm; runs at all
-times unless you manually quit.</para>
-</listitem>
 <listitem><para><guilabel>Disable alarms while not running</guilabel>:
 Selecting this option has the effect that alarms will be disabled
 whenever &kalarm;'s system tray icon is not visible.</para>
@@ -1759,22 +1754,37 @@
 </listitem>
 </itemizedlist>
 
+<!--
 <para>In this mode, if no system tray exists, &kalarm; runs
 continuously in the background and alarms are always enabled.</para>
+-->
 </listitem>
 
-<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
-is run only when an alarm is triggered, if you run it manually, or
-while its system tray icon is displayed. In this mode the system tray
-icon can still be displayed, but closing the system tray icon has no
-effect on any &kalarm; windows.</para>
+<listitem><para><guilabel>Autostart at login</guilabel>: In continuous
+mode, this starts &kalarm; at &kde; session login, ensuring that
+&kalarm; runs at all times unless you manually quit.</para>
+</listitem>
 
-<itemizedlist>
 <listitem><para><guilabel>Autostart system tray icon at
-login</guilabel>: This displays &kalarm;'s system tray icon at login.
-&kalarm; will run until the system tray icon is closed.</para>
+login</guilabel>: In on-demand mode, this displays &kalarm;'s system
+tray icon at login. &kalarm; will run until the system tray icon is
+closed.</para>
 </listitem>
-</itemizedlist>
+
+<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
+This starts alarm monitoring at KDE session login, by starting the
+<application>alarm daemon</application>. Note that in order for alarms
+to be activated, you also need to select appropriate options in the
+<guilabel>Run Mode</guilabel> group box.</para>
+
+<warning><para>This option should always be checked unless you intend
+to discontinue use of &kalarm;.</para></warning>
+
+<note><para>This option is automatically reselected whenever &kalarm;
+is run. So if you have unchecked this option and want to continue to
+prevent the <application>alarm daemon</application> from running at
+login, you need to uncheck this option again each time you run
+&kalarm;.</para></note>
 </listitem>
 </itemizedlist>
 </listitem>
@@ -1823,17 +1833,20 @@
 options control the storage of expired alarms.</para>
 <itemizedlist>
 <listitem><para><guilabel>Keep alarms after expiry</guilabel>:
-Select this option to store expired alarms. Deselect it to keep no
-record of alarms once they have expired.</para>
+Select this option to store expired and deleted alarms. Deselect it
+to keep no record of alarms once they cease to be active. Note that
+deleted alarms are only stored if they have previously been
+triggered. If you delete an alarm before it ever triggers, it is
+discarded.</para>
 </listitem>
 
 <listitem><para><guilabel>Discard expired alarms after</guilabel>:
-Set the number of days to store expired alarms after their last
-activation.</para>
+Set the number of days to store expired and deleted alarms, after which
+they are permanently deleted.</para>
 </listitem>
 
 <listitem><para><guibutton>Clear expired alarms</guibutton>: This
-button discards all currently stored  expired alarms. This has no
+button discards all currently stored expired alarms. This has no
 effect on alarms which subsequently expire; they will continue to be
 stored according to the selected options.</para>
 </listitem>
@@ -2149,9 +2162,8 @@
 </listitem>
 
 <listitem><para>Set the default sound options. Note that a default
-sound file may be specified even if <guilabel>Sound</guilabel> is
-unchecked, or if <guilabel>Beep</guilabel> or
-<guilabel>Speak</guilabel> is checked.</para>
+sound file may be specified even if the sound type is not set to
+<guilabel>Sound file</guilabel>.</para>
 </listitem>
 </itemizedlist>
 
@@ -3111,10 +3123,10 @@
 <para><function>scheduleMessage()</function> is a &DCOP; call to
 schedule the specified alarm message for display at the specified date
 and time. It has three forms. The most general form allows an
-arbitrary recurrence to be specified - use this also for non-repeating
-alarms. The other forms provide convenient access to a restricted set
-of alarm recurrence types, one specifying a repetition count and the
-other an end time.</para>
+arbitrary recurrence to be specified &ndash; use this also for
+non-repeating alarms. The other forms provide convenient access to a
+restricted set of alarm recurrence types, one specifying a repetition
+count and the other an end time.</para>
 
 <para>If the scheduled time (including any repetitions) has already
 passed, &kalarm; immediately displays the message (unless the
@@ -4030,16 +4042,16 @@
 
 <!-- TRANS:CREDIT_FOR_TRANSLATORS -->
 
+&underFDL;               <!-- FDL: do not remove -->
+
+&underGPL;        	 <!-- GPL License -->
+
 <para>Thanks go to the author of the &kde; 1 KAlarm application,
 Stefan Nikolaus <email>stefan.nikolaus@stuco.uni-oldenburg.de</email>,
 who kindly agreed to allow the name &kalarm; to be used by this
 &kde; 2 / &kde; 3 application.
 </para>
 
-&underFDL;               <!-- FDL: do not remove -->
-
-&underGPL;        	 <!-- GPL License -->
-
 </chapter>
 
 <appendix id="installation">
Index: kalarm/kamail.cpp
===================================================================
--- kalarm/kamail.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kamail.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  kamail.cpp  -  email functions
  *  Program:  kalarm
- *  Copyright (c) 2002 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002-2005 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -168,7 +168,7 @@
 				command += KShellProcess::quote(data.bcc);
 			}
 
-			command += " ";
+			command += ' ';
 			command += event.emailAddresses(" "); // locally provided, okay
 		}
 
@@ -954,7 +954,7 @@
   QString maybeLocalPart;
   QString tmp;
 
-  while ( scursor != send ) {
+  if ( scursor != send ) {
     // first, eat any whitespace
     eatCFWS( scursor, send, isCRLF );
 
Index: kalarm/alarmevent.cpp
===================================================================
--- kalarm/alarmevent.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/alarmevent.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -379,7 +379,7 @@
 			case KAAlarm::DEFERRED_REMINDER_DATE__ALARM:
 			case KAAlarm::DEFERRED_DATE__ALARM:
 				mDeferral = (data.type == KAAlarm::DEFERRED_REMINDER_DATE__ALARM) ? REMINDER_DEFERRAL : NORMAL_DEFERRAL;
-				mDeferralTime.set(data.dateTime, false);
+				mDeferralTime.set(data.dateTime, true);
 				break;
 			case KAAlarm::DEFERRED_REMINDER_TIME__ALARM:
 			case KAAlarm::DEFERRED_TIME__ALARM:
@@ -530,7 +530,7 @@
 			if (!alarm.programArguments().isEmpty())
 			{
 				if (!data.commandScript)
-					data.cleanText += " ";
+					data.cleanText += ' ';
 				data.cleanText += alarm.programArguments();
 			}
 			break;
@@ -834,16 +834,17 @@
 	DateTime dt = mNextMainDateTime;
 	if (mRepeatCount)
 	{
-		// N.B. This is coded to avoid 32-bit integer overflow which occurs
-		//      in QDateTime::secsTo() for large enough time differences.
 		QDateTime now = QDateTime::currentDateTime();
 		if (now > mNextMainDateTime)
 		{
+			// Find the next repetition > current date/time.
+			// N.B. This is coded to avoid 32-bit integer overflow which occurs
+			//      in QDateTime::secsTo() for large enough time differences.
 			dt = mainEndRepeatTime();    // get the last repetition time
 			if (dt > now)
 			{
 				int repeatSecs = mRepeatInterval * 60;
-				int repetition = (mNextMainDateTime.secsTo(now) + repeatSecs - 1) / repeatSecs;
+				int repetition = mNextMainDateTime.secsTo(now) / repeatSecs + 1;
 				dt = mNextMainDateTime.addSecs(repetition * repeatSecs);
 			}
 		}
@@ -3147,7 +3148,7 @@
 
 		result += (*it).email();
 		if (quote)
-			result += ">";
+			result += '>';
 	}
 	return result;
 }
Index: kalarm/messagewin.cpp
===================================================================
--- kalarm/messagewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/messagewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1437,18 +1437,18 @@
 		if (AlarmCalendar::activeCalendar()->event(mEventID))
 		{
 			// The old alarm hasn't expired yet, so replace it
-			status = KAlarm::modifyEvent(mEvent, event, 0);
+			status = KAlarm::modifyEvent(mEvent, event, 0, &editDlg);
 			Undo::saveEdit(mEvent, event);
 		}
 		else
 		{
 			// The old event has expired, so simply create a new one
-			status = KAlarm::addEvent(event, 0);
+			status = KAlarm::addEvent(event, 0, &editDlg);
 			Undo::saveAdd(event);
 		}
 
 		if (status == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_MODIFY, 1);
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
 
 		// Close the alarm window
@@ -1524,7 +1524,7 @@
 			KAEvent event(*kcalEvent);
 			bool repeat = event.defer(dateTime, (mAlarmType & KAAlarm::REMINDER_ALARM), true);
 			event.setDeferDefaultMinutes(delayMins);
-			KAlarm::updateEvent(event, 0, true, !repeat);
+			KAlarm::updateEvent(event, 0, mDeferDlg, true, !repeat);
 		}
 		else
 		{
@@ -1546,7 +1546,7 @@
 			event.setDeferDefaultMinutes(delayMins);
 			// Add the event back into the calendar file, retaining its ID
 			// and not updating KOrganizer
-			KAlarm::addEvent(event, 0, true, false);
+			KAlarm::addEvent(event, 0, mDeferDlg, true, false);
 			if (kcalEvent)
 			{
 				event.setUid(KAEvent::EXPIRED);
Index: kalarm/undo.cpp
===================================================================
--- kalarm/undo.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/undo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -57,7 +57,7 @@
 		virtual UndoItem* restore() = 0;
 		virtual bool      deleteID(const QString& /*id*/)  { return false; }
 
-		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_EXPIRED };
+		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_TEMPLATE, ERR_EXPIRED };
 		enum Warning { WARN_NONE, WARN_KORG_ADD, WARN_KORG_MODIFY, WARN_KORG_DELETE };
 		static int        mLastId;
 		static Error      mRestoreError;         // error code valid only if restore() returns 0
@@ -337,7 +337,7 @@
 	{
 		case UndoItem::ERR_NONE:
 		{
-			KAlarm::UpdateError errcode;
+			KAlarm::KOrgUpdateError errcode;
 			switch (UndoItem::mRestoreWarning)
 			{
 				case UndoItem::WARN_KORG_ADD:     errcode = KAlarm::KORG_ERR_ADD;  break;
@@ -352,6 +352,7 @@
 		}
 		case UndoItem::ERR_NOT_FOUND:  err = i18n("Alarm not found");  break;
 		case UndoItem::ERR_CREATE:     err = i18n("Error recreating alarm");  break;
+		case UndoItem::ERR_TEMPLATE:   err = i18n("Error recreating alarm template");  break;
 		case UndoItem::ERR_EXPIRED:    err = i18n("Cannot reactivate expired alarm");  break;
 		case UndoItem::ERR_PROG:       err = i18n("Program error");  break;
 		default:                       err = i18n("Unknown error");  break;
@@ -733,14 +734,24 @@
 			if (setArchive)
 				event.setArchive();
 			// Archive it if it has already triggered
-			if (KAlarm::deleteEvent(event, true) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::deleteEvent(event, true))
 			{
-				mRestoreWarning = WARN_KORG_DELETE;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_DELETE;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::deleteTemplate(event);
+			if (KAlarm::deleteTemplate(event) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // redoing the deletion of an expired alarm
 			KAlarm::deleteEvent(event);
@@ -814,14 +825,24 @@
 	switch (calendar())
 	{
 		case KAEvent::ACTIVE:
-			if (KAlarm::modifyEvent(newEvent, *mOldEvent, 0) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::modifyEvent(newEvent, *mOldEvent, 0))
 			{
-				mRestoreWarning = WARN_KORG_MODIFY;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_MODIFY;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::updateTemplate(*mOldEvent, 0);
+			if (KAlarm::updateTemplate(*mOldEvent, 0) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // editing of expired events is not allowed
 		default:
@@ -890,6 +911,8 @@
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_EXPIRED;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -898,13 +921,15 @@
 			}
 			else
 			{
-				switch (KAlarm::addEvent(*mEvent, 0, true))
+				switch (KAlarm::addEvent(*mEvent, 0, 0, true))
 				{
 					case KAlarm::UPDATE_KORG_ERR:
 						mRestoreWarning = WARN_KORG_ADD;
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_CREATE;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -913,7 +938,7 @@
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			if (!KAlarm::addTemplate(*mEvent, 0))
+			if (KAlarm::addTemplate(*mEvent, 0) != KAlarm::UPDATE_OK)
 			{
 				mRestoreError = ERR_CREATE;
 				return 0;
Index: kalarm/preferences.h
===================================================================
--- kalarm/preferences.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/preferences.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  preferences.h  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -60,7 +60,6 @@
 		static const QFont&      messageFont()                    { return mMessageFont; }
 		static const QTime&      startOfDay()                     { return mStartOfDay; }
 		static bool              hasStartOfDayChanged()           { return mStartOfDayChanged; }
-		static bool              autostartDaemon()                { return mAutostartDaemon; }
 		static bool              runInSystemTray()                { return mRunInSystemTray; }
 		static bool              disableAlarmsIfStopped()         { return mDisableAlarmsIfStopped; }
 		static bool              quitWarn()                       { return notifying(QUIT_WARN); }
@@ -90,7 +89,6 @@
 		static QColor            disabledColour()                 { return mDisabledColour; }
 		static QColor            expiredColour()                  { return mExpiredColour; }
 		static int               expiredKeepDays()                { return mExpiredKeepDays; }
-		static bool              defaultSound()                   { return mDefaultSound; }
 		static SoundPicker::Type defaultSoundType()               { return mDefaultSoundType; }
 		static const QString&    defaultSoundFile()               { return mDefaultSoundFile; }
 		static float             defaultSoundVolume()             { return mDefaultSoundVolume; }
@@ -123,7 +121,6 @@
 		static const QColor                     default_defaultFgColour;
 		static const QFont&                     default_messageFont()  { return mDefault_messageFont; };
 		static const QTime                      default_startOfDay;
-		static const bool                       default_autostartDaemon;
 		static const bool                       default_runInSystemTray;
 		static const bool                       default_disableAlarmsIfStopped;
 		static const bool                       default_quitWarn;
@@ -154,7 +151,6 @@
 		static const int                        default_defaultLateCancel;
 		static const bool                       default_defaultAutoClose;
 		static const bool                       default_defaultCopyToKOrganizer;
-		static const bool                       default_defaultSound;
 		static const SoundPicker::Type          default_defaultSoundType;
 		static const bool                       default_defaultSoundRepeat;
 		static const bool                       default_defaultConfirmAck;
@@ -201,7 +197,6 @@
 		static QColor              mDefaultBgColour;
 		static QFont               mMessageFont;
 		static QTime               mStartOfDay;
-		static bool                mAutostartDaemon;
 		static bool                mRunInSystemTray;
 		static bool                mDisableAlarmsIfStopped;
 		static bool                mAutostartTrayIcon;
@@ -229,7 +224,6 @@
 		static int                 mDefaultLateCancel;
 		static bool                mDefaultAutoClose;
 		static bool                mDefaultCopyToKOrganizer;
-		static bool                mDefaultSound;
 		static SoundPicker::Type   mDefaultSoundType;
 		static bool                mDefaultSoundRepeat;
 		static bool                mDefaultConfirmAck;
@@ -245,7 +239,6 @@
 		// Change tracking
 		static QTime               mOldStartOfDay;       // previous start-of-day time
 		static bool                mStartOfDayChanged;   // start-of-day check value doesn't tally with mStartOfDay
-		static bool                mOldAutostartDaemon;  // previous daemon autostart value
 };
 
 #endif // PREFERENCES_H
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -163,7 +163,7 @@
  */
 EditAlarmDlg::EditAlarmDlg(bool Template, const QString& caption, QWidget* parent, const char* name,
                            const KAEvent* event, bool readOnly)
-	: KDialogBase(parent, name, true, caption,
+	: KDialogBase(parent, (name ? name : Template ? "TemplEditDlg" : "EditDlg"), true, caption,
 	              (readOnly ? Cancel|Try : Template ? Ok|Cancel|Try : Ok|Cancel|Try|Default),
 	              (readOnly ? Cancel : Ok)),
 	  mMainPageShown(false),
@@ -225,8 +225,9 @@
 	mActionGroup = new ButtonGroup(i18n("Action"), mainPage, "actionGroup");
 	connect(mActionGroup, SIGNAL(buttonSet(int)), SLOT(slotAlarmTypeChanged(int)));
 	topLayout->addWidget(mActionGroup, 1);
-	QGridLayout* grid = new QGridLayout(mActionGroup, 3, 5, marginHint(), spacingHint());
-	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
+	QBoxLayout* layout = new QVBoxLayout(mActionGroup, marginHint(), spacingHint());
+	layout->addSpacing(fontMetrics().lineSpacing()/2);
+	QGridLayout* grid = new QGridLayout(layout, 1, 5);
 
 	// Message radio button
 	mMessageRadio = new RadioButton(i18n("Te&xt"), mActionGroup, "messageButton");
@@ -260,14 +261,11 @@
 	grid->addWidget(mEmailRadio, 1, 6);
 
 	initDisplayAlarms(mActionGroup);
+	layout->addWidget(mDisplayAlarmsFrame);
 	initCommand(mActionGroup);
+	layout->addWidget(mCommandFrame);
 	initEmail(mActionGroup);
-	mAlarmTypeStack = new QWidgetStack(mActionGroup);
-	grid->addMultiCellWidget(mAlarmTypeStack, 2, 2, 0, 6);
-	grid->setRowStretch(2, 1);
-	mAlarmTypeStack->addWidget(mDisplayAlarmsFrame, 0);
-	mAlarmTypeStack->addWidget(mCommandFrame, 1);
-	mAlarmTypeStack->addWidget(mEmailFrame, 2);
+	layout->addWidget(mEmailFrame);
 
 	// Deferred date/time: visible only for a deferred recurring event.
 	mDeferGroup = new QGroupBox(1, Qt::Vertical, i18n("Deferred Alarm"), mainPage, "deferGroup");
@@ -282,7 +280,7 @@
 	QWhatsThis::add(mDeferChangeButton, i18n("Change the alarm's deferred time, or cancel the deferral"));
 	mDeferGroup->addSpace(0);
 
-	QBoxLayout* layout = new QHBoxLayout(topLayout);
+	layout = new QHBoxLayout(topLayout);
 
 	// Date and time entry
 	if (mTemplate)
@@ -390,13 +388,21 @@
 	mLateCancel = new LateCancelSelector(true, mainPage);
 	topLayout->addWidget(mLateCancel, 0, Qt::AlignAuto);
 
+	// Acknowledgement confirmation required - default = no confirmation
+	layout = new QHBoxLayout(topLayout, 0);
+	mConfirmAck = createConfirmAckCheckbox(mainPage);
+	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
+	layout->addWidget(mConfirmAck);
+	layout->addSpacing(2*spacingHint());
+	layout->addStretch();
+
 	if (theApp()->korganizerEnabled())
 	{
 		// Show in KOrganizer checkbox
 		mShowInKorganizer = new CheckBox(i18n_ShowInKOrganizer(), mainPage);
 		mShowInKorganizer->setFixedSize(mShowInKorganizer->sizeHint());
 		QWhatsThis::add(mShowInKorganizer, i18n("Check to copy the alarm into KOrganizer's calendar"));
-		topLayout->addWidget(mShowInKorganizer);
+		layout->addWidget(mShowInKorganizer);
 	}
 
 	setButtonWhatsThis(Ok, i18n("Schedule the alarm at the specified time."));
@@ -458,7 +464,7 @@
 	mBgColourChoose->setFixedSize(mBgColourChoose->sizeHint());
 	connect(mBgColourChoose, SIGNAL(highlighted(const QColor&)), SLOT(slotBgColourSelected(const QColor&)));
 	layout->addWidget(box);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	// Font and colour choice drop-down list
@@ -468,16 +474,11 @@
 	layout->addWidget(mFontColourButton);
 
 	// Sound checkbox and file selector
+	layout = new QHBoxLayout(frameLayout);
 	mSoundPicker = new SoundPicker(mDisplayAlarmsFrame);
 	mSoundPicker->setFixedSize(mSoundPicker->sizeHint());
-	frameLayout->addWidget(mSoundPicker, 0, Qt::AlignAuto);
-
-	// Acknowledgement confirmation required - default = no confirmation
-	layout = new QHBoxLayout(frameLayout);
-	mConfirmAck = createConfirmAckCheckbox(mDisplayAlarmsFrame);
-	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
-	layout->addWidget(mConfirmAck);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addWidget(mSoundPicker);
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	if (ShellProcess::authorised())    // don't display if shell commands not allowed (e.g. kiosk mode)
@@ -789,11 +790,12 @@
 		mSimpleRepetition->set(event->repeatInterval(), event->repeatCount());
 		mRecurrenceText->setText(recurText(*event));
 		mRecurrenceEdit->set(*event);   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
-		SoundPicker::Type soundType = event->speak()                                ? SoundPicker::SPEAK
-		                            : event->beep() || event->audioFile().isEmpty() ? SoundPicker::BEEP
-		                            :                                                 SoundPicker::PLAY_FILE;
-		mSoundPicker->set((soundType != SoundPicker::BEEP || event->beep()), soundType, event->audioFile(),
-		                  event->soundVolume(), event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
+		SoundPicker::Type soundType = event->speak()                ? SoundPicker::SPEAK
+		                            : event->beep()                 ? SoundPicker::BEEP
+		                            : !event->audioFile().isEmpty() ? SoundPicker::PLAY_FILE
+		                            :                                 SoundPicker::NONE;
+		mSoundPicker->set(soundType, event->audioFile(), event->soundVolume(),
+		                  event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
 		CmdLogType logType = event->commandXterm()       ? EXEC_IN_TERMINAL
 		                   : !event->logFile().isEmpty() ? LOG_TO_FILE
 		                   :                               DISCARD_OUTPUT;
@@ -843,7 +845,7 @@
 		slotRecurFrequencyChange();      // update the Recurrence text
 		mReminder->setMinutes(0, false);
 		mReminder->enableOnceOnly(mRecurrenceEdit->isTimedRepeatType());   // must be called after mRecurrenceEdit is set up
-		mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+		mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 		                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 		mCmdTypeScript->setChecked(Preferences::defaultCmdScript());
 		mCmdLogFileEdit->setText(Preferences::defaultCmdLogFile());    // set file name before setting radio button
@@ -1020,6 +1022,7 @@
  */
 void EditAlarmDlg::saveState(const KAEvent* event)
 {
+	delete mSavedEvent;
 	mSavedEvent = 0;
 	if (event)
 		mSavedEvent = new KAEvent(*event);
@@ -1031,8 +1034,7 @@
 		mSavedTemplateAfterTime = mTemplateTimeAfter->value();
 	}
 	mSavedTypeRadio        = mActionGroup->selected();
-	mSavedSound            = mSoundPicker->sound();
-	mSavedSoundType        = mSoundPicker->type();
+	mSavedSoundType        = mSoundPicker->sound();
 	mSavedSoundFile        = mSoundPicker->file();
 	mSavedSoundVolume      = mSoundPicker->volume(mSavedSoundFadeVolume, mSavedSoundFadeSeconds);
 	mSavedRepeatSound      = mSoundPicker->repeat();
@@ -1106,7 +1108,7 @@
 		return true;
 	if (mMessageRadio->isOn()  ||  mFileRadio->isOn())
 	{
-		if (mSavedSound      != mSoundPicker->sound()
+		if (mSavedSoundType  != mSoundPicker->sound()
 		||  mSavedConfirmAck != mConfirmAck->isChecked()
 		||  mSavedFont       != mFontColourButton->font()
 		||  mSavedFgColour   != mFontColourButton->fgColour()
@@ -1121,24 +1123,19 @@
 			||  mSavedPostAction != mSpecialActionsButton->postAction())
 				return true;
 		}
-		if (mSavedSound)
+		if (mSavedSoundType == SoundPicker::PLAY_FILE)
 		{
-			if (mSavedSoundType != mSoundPicker->type())
+			if (mSavedSoundFile != mSoundPicker->file())
 				return true;
-			if (mSavedSoundType == SoundPicker::PLAY_FILE)
+			if (!mSavedSoundFile.isEmpty())
 			{
-				if (mSavedSoundFile != mSoundPicker->file())
+				float fadeVolume;
+				int   fadeSecs;
+				if (mSavedRepeatSound != mSoundPicker->repeat()
+				||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
+				||  mSavedSoundFadeVolume != fadeVolume
+				||  mSavedSoundFadeSeconds != fadeSecs)
 					return true;
-				if (!mSavedSoundFile.isEmpty())
-				{
-					float fadeVolume;
-					int   fadeSecs;
-					if (mSavedRepeatSound != mSoundPicker->repeat()
-					||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
-					||  mSavedSoundFadeVolume != fadeVolume
-					||  mSavedSoundFadeSeconds != fadeSecs)
-						return true;
-				}
 			}
 		}
 	}
@@ -1297,8 +1294,8 @@
 	bool displayAlarm = mMessageRadio->isOn() || mFileRadio->isOn();
 	bool cmdAlarm     = mCommandRadio->isOn();
 	bool emailAlarm   = mEmailRadio->isOn();
-	return (displayAlarm && mSoundPicker->beep()                                 ? KAEvent::BEEP : 0)
-	     | (displayAlarm && mSoundPicker->speak()                                ? KAEvent::SPEAK : 0)
+	return (displayAlarm && mSoundPicker->sound() == SoundPicker::BEEP           ? KAEvent::BEEP : 0)
+	     | (displayAlarm && mSoundPicker->sound() == SoundPicker::SPEAK          ? KAEvent::SPEAK : 0)
 	     | (displayAlarm && mSoundPicker->repeat()                               ? KAEvent::REPEAT_SOUND : 0)
 	     | (displayAlarm && mConfirmAck->isChecked()                             ? KAEvent::CONFIRM_ACK : 0)
 	     | (displayAlarm && mLateCancel->isAutoClose()                           ? KAEvent::AUTO_CLOSE : 0)
@@ -1599,7 +1596,7 @@
 
 	bool deferred = mDeferDateTime.isValid();
 	DeferAlarmDlg deferDlg(i18n("Defer Alarm"), (deferred ? mDeferDateTime : DateTime(now.addSecs(60))),
-	                       deferred, this, "deferDlg");
+	                       deferred, this, "EditDeferDlg");
 	if (limit)
 	{
 		// Don't allow deferral past the next recurrence
@@ -1832,10 +1829,13 @@
 		mFilePadding->hide();
 		mTextMessageEdit->show();
 		mFontColourButton->show();
+		mSoundPicker->showSpeak(true);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(true);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the alarm message now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		focus = mTextMessageEdit;
 		displayAlarm = true;
 	}
@@ -1845,27 +1845,36 @@
 		mFileBox->show();
 		mFilePadding->show();
 		mFontColourButton->hide();
+		mSoundPicker->showSpeak(false);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(false);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the file now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		mFileMessageEdit->setNoSelect();
 		focus = mFileMessageEdit;
 		displayAlarm = true;
 	}
 	else if (mCommandRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->show();
+		mEmailFrame->hide();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Execute the specified command now"));
-		mAlarmTypeStack->raiseWidget(mCommandFrame);
 		mCmdCommandEdit->setNoSelect();
 		focus = mCmdCommandEdit;
 	}
 	else if (mEmailRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->hide();
+		mEmailFrame->show();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Send the email to the specified addressees now"));
-		mAlarmTypeStack->raiseWidget(mEmailFrame);
 		mEmailToEdit->setNoSelect();
 		focus = mEmailToEdit;
 	}
Index: kalarm/functions.h
===================================================================
--- kalarm/functions.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/functions.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,14 +45,20 @@
 
 /** Return codes from fileType() */
 enum FileType { Unknown, TextPlain, TextFormatted, TextApplication, Image };
-/** Return codes from calendar update functions */
+/** Return codes from calendar update functions.
+ *  The codes are ordered by severity.
+ */
 enum UpdateStatus {
 	UPDATE_OK,          // update succeeded
-	UPDATE_ERROR,       // update failed completely
-	UPDATE_KORG_ERR     // update succeeded, but KOrganizer update failed
+	UPDATE_KORG_ERR,    // update succeeded, but KOrganizer update failed
+	UPDATE_ERROR,       // update failed partially
+	UPDATE_FAILED,      // update failed completely
+	SAVE_FAILED         // calendar was updated in memory, but save failed
 };
+/** Error codes supplied as parameter to displayUpdateError() */
+enum UpdateError { ERR_ADD, ERR_DELETE, ERR_REACTIVATE, ERR_TEMPLATE };
 /** Error codes supplied as parameter to displayKOrgUpdateError() */
-enum UpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
+enum KOrgUpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
 
 
 /** Display a main window with the specified event selected */
@@ -88,18 +94,19 @@
 QString             runKMail(bool minimise);
 bool                runProgram(const QCString& program, const QCString& windowName, QCString& dcopName, QString& errorMessage);
 
-UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false, bool allowKOrgUpdate = true);
+UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, QWidget* errmsgParent = 0, bool useEventID = false, bool allowKOrgUpdate = true);
 bool                addExpiredEvent(KAEvent&);
-bool                addTemplate(KAEvent&, TemplateListView* selectionView);
-UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView);
-void                updateEvent(KAEvent&, AlarmListView* selectionView, bool archiveOnDelete = true, bool incRevision = true);
-void                updateTemplate(const KAEvent&, TemplateListView* selectionView);
-UpdateStatus        deleteEvent(KAEvent&, bool archive = true);
-void                deleteTemplate(const KAEvent&);
+UpdateStatus        addTemplate(KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        updateEvent(KAEvent&, AlarmListView* selectionView, QWidget* errmsgParent = 0, bool archiveOnDelete = true, bool incRevision = true);
+UpdateStatus        updateTemplate(const KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        deleteEvent(KAEvent&, bool archive = true, QWidget* errmsgParent = 0);
+UpdateStatus        deleteTemplate(const KAEvent&);
 void                deleteDisplayEvent(const QString& eventID);
 UpdateStatus        reactivateEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false);
-void                enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
-void                displayKOrgUpdateError(QWidget* parent, UpdateError, int nAlarms);
+UpdateStatus        enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
+void                displayUpdateError(QWidget* parent, UpdateStatus, UpdateError, int nAlarms);
+void                displayKOrgUpdateError(QWidget* parent, KOrgUpdateError, int nAlarms);
 
 QString             stripAccel(const QString&);
 
Index: kalarm/alarmcalendar.h
===================================================================
--- kalarm/alarmcalendar.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/alarmcalendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,16 +43,16 @@
 		bool                  open();
 		int                   load();
 		bool                  reload();
-		void                  save();
+		bool                  save();
 		void                  close();
 		void                  startUpdate();
-		void                  endUpdate();
+		bool                  endUpdate();
 		KCal::Event*          event(const QString& uniqueID);
 		KCal::Event::List     events();
 		KCal::Event::List     eventsWithAlarms(const QDateTime& from, const QDateTime& to);
 		KCal::Event*          addEvent(KAEvent&, bool useEventID = false);
 		void                  updateEvent(const KAEvent&);
-		void                  deleteEvent(const QString& eventID, bool save = false);
+		bool                  deleteEvent(const QString& eventID, bool save = false);
 		void                  emitEmptyStatus();
 		void                  purgeAll()                          { purge(0); }
 		void                  setPurgeDays(int days);
Index: kalarm/soundpicker.h
===================================================================
--- kalarm/soundpicker.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/soundpicker.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.h  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,10 +25,9 @@
 #include <qstring.h>
 #include <kurl.h>
 
-class ButtonGroup;
-class CheckBox;
+class QHBox;
+class ComboBox;
 class PushButton;
-class RadioButton;
 
 
 class SoundPicker : public QFrame
@@ -36,19 +35,19 @@
 		Q_OBJECT
 	public:
 		/** Sound options which can be selected for when the alarm is displayed.
+		 *  @li NONE      - silence.
 		 *  @li BEEP      - a beep will be sounded.
-		 *  @li SPEAK     - the message will be spoken.
 		 *  @li PLAY_FILE - a sound file will be played.
+		 *  @li SPEAK     - the message text will be spoken.
 		 */
-		enum Type { BEEP = 1, SPEAK, PLAY_FILE };
+		enum Type { NONE = 0, BEEP, PLAY_FILE, SPEAK };
 		/** Constructor.
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
 		SoundPicker(QWidget* parent, const char* name = 0);
 		/** Initialises the widget's state.
-		 *  @param sound    True to enable sound.
-		 *  @param defaultType The default option to select when sound is enabled.
+		 *  @param type     The option to select.
 		 *  @param filename The full path or URL of the sound file to select. If the 'file' option is
 		 *                  not initially selected, @p filename provides the default should 'file'
 		 *                  later be selected by the user.
@@ -65,7 +64,7 @@
 		 *                  selected, @p repeat provides the default should 'file' later be selected by
 		 *                  the user.
 		 */
-		void           set(bool sound, Type defaultType, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
+		void           set(Type type, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
 		/** Returns true if the widget is read only for the user. */
 		bool           isReadOnly() const          { return mReadOnly; }
 		/** Sets whether the widget can be changed the user.
@@ -76,14 +75,8 @@
 		 *  If it is to be hidden and it is currently selected, sound is turned off.
 		 */
 		void           showSpeak(bool show);
-		/** Returns true if sound is selected. */
-		bool           sound() const;
 		/** Returns the selected option. */
-		Type           type() const;
-		/** Returns true if 'beep' is selected. */
-		bool           beep() const;
-		/** Returns true if 'speak' is selected. */
-		bool           speak() const;
+		Type           sound() const;
 		/** If the 'file' option is selected, returns the URL of the chosen file.
 		 *  Otherwise returns a null string.
 		 */
@@ -112,28 +105,21 @@
 		 */
 		static QString browseFile(QString& initialDir, const QString& initialFile = QString::null);
 
-		static QString i18n_Sound();       // plain text of Sound checkbox
-		static QString i18n_s_Sound();     // text of Sound checkbox, with 'S' shortcut
-		static QString i18n_Beep();        // plain text of Beep radio button
-		static QString i18n_b_Beep();      // text of Beep radio button, with 'B' shortcut
-		static QString i18n_Speak();       // plain text of Speak radio button
-		static QString i18n_p_Speak();     // text of Speak radio button, with 'P' shortcut
-		static QString i18n_File();        // plain text of File radio button
+		static QString i18n_Sound();       // plain text of Sound label
+		static QString i18n_None();        // plain text of None combo box item
+		static QString i18n_Beep();        // plain text of Beep combo box item
+		static QString i18n_Speak();       // plain text of Speak combo box item
+		static QString i18n_File();        // plain text of File combo box item
 
 
 	private slots:
-		void           slotSoundToggled(bool on);
-		void           slotTypeChanged(int id);
+		void           slotTypeSelected(int id);
 		void           slotPickFile();
-		void           setLastType();
 
 	private:
 
-		CheckBox*      mCheckbox;
-		ButtonGroup*   mTypeGroup;
-		RadioButton*   mBeepRadio;
-		RadioButton*   mSpeakRadio;
-		RadioButton*   mFileRadio;
+		ComboBox*      mTypeCombo;
+		QHBox*         mTypeBox;
 		PushButton*    mFilePicker;
 		QString        mDefaultDir;
 		QString        mFile;         // sound file to play when alarm is triggered
@@ -141,7 +127,7 @@
 		float          mFadeVolume;   // initial volume for file, or < 0 for no fading
 		int            mFadeSeconds;  // fade interval in seconds
 		Type           mLastType;     // last selected sound option
-		bool           mRevertType;   // reverting to last selected sound option
+		bool           mSpeakShowing; // Speak option is shown in combo box
 		bool           mRepeat;       // repeat the sound file
 		bool           mReadOnly;
 };
Index: kalarm/preferences.cpp
===================================================================
--- kalarm/preferences.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/preferences.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  preferences.cpp  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -37,6 +37,8 @@
 #include "preferences.moc"
 
 
+static QString translateXTermPath(KConfig*, const QString& cmdline, bool write);
+
 Preferences* Preferences::mInstance = 0;
 
 // Default config file settings
@@ -46,7 +48,6 @@
 const QColor                     Preferences::default_defaultFgColour(Qt::black);
 QFont                            Preferences::mDefault_messageFont;    // initialised in constructor
 const QTime                      Preferences::default_startOfDay(0, 0);
-const bool                       Preferences::default_autostartDaemon         = true;
 const bool                       Preferences::default_runInSystemTray         = true;
 const bool                       Preferences::default_disableAlarmsIfStopped  = true;
 const bool                       Preferences::default_quitWarn                = true;
@@ -72,7 +73,6 @@
 const int                        Preferences::default_defaultLateCancel       = 0;
 const bool                       Preferences::default_defaultAutoClose        = false;
 const bool                       Preferences::default_defaultCopyToKOrganizer = false;
-const bool                       Preferences::default_defaultSound            = false;
 const bool                       Preferences::default_defaultSoundRepeat      = false;
 const SoundPicker::Type          Preferences::default_defaultSoundType        = SoundPicker::BEEP;
 const bool                       Preferences::default_defaultConfirmAck       = false;
@@ -99,7 +99,6 @@
 QColor                     Preferences::mDefaultBgColour;
 QFont                      Preferences::mMessageFont;
 QTime                      Preferences::mStartOfDay;
-bool                       Preferences::mAutostartDaemon;
 bool                       Preferences::mRunInSystemTray;
 bool                       Preferences::mDisableAlarmsIfStopped;
 bool                       Preferences::mAutostartTrayIcon;
@@ -130,7 +129,6 @@
 int                        Preferences::mDefaultLateCancel;
 bool                       Preferences::mDefaultAutoClose;
 bool                       Preferences::mDefaultCopyToKOrganizer;
-bool                       Preferences::mDefaultSound;
 SoundPicker::Type          Preferences::mDefaultSoundType;
 bool                       Preferences::mDefaultSoundRepeat;
 bool                       Preferences::mDefaultConfirmAck;
@@ -145,7 +143,6 @@
 // Change tracking
 QTime                      Preferences::mOldStartOfDay;
 bool                       Preferences::mStartOfDayChanged;
-bool                       Preferences::mOldAutostartDaemon;
 
 
 static const QString defaultFeb29RecurType    = QString::fromLatin1("Mar1");
@@ -186,7 +183,6 @@
 static const QString DEF_AUTO_CLOSE           = QString::fromLatin1("DefAutoClose");
 static const QString DEF_CONFIRM_ACK          = QString::fromLatin1("DefConfirmAck");
 static const QString DEF_COPY_TO_KORG         = QString::fromLatin1("DefCopyKOrg");
-static const QString DEF_SOUND                = QString::fromLatin1("DefSound");
 static const QString DEF_SOUND_TYPE           = QString::fromLatin1("DefSoundType");
 static const QString DEF_SOUND_FILE           = QString::fromLatin1("DefSoundFile");
 static const QString DEF_SOUND_VOLUME         = QString::fromLatin1("DefSoundVolume");
@@ -199,11 +195,10 @@
 static const QString DEF_REMIND_UNITS         = QString::fromLatin1("DefRemindUnits");
 static const QString DEF_PRE_ACTION           = QString::fromLatin1("DefPreAction");
 static const QString DEF_POST_ACTION          = QString::fromLatin1("DefPostAction");
-// Obsolete - compatibility with pre-1.2.1
-static const QString EMAIL_ADDRESS            = QString::fromLatin1("EmailAddress");
-static const QString EMAIL_USE_CONTROL_CENTRE = QString::fromLatin1("EmailUseControlCenter");
-static const QString EMAIL_BCC_USE_CONTROL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
 
+// Config file entry name for temporary use
+static const QString TEMP                     = QString::fromLatin1("Temp");
+
 // Values for EmailFrom entry
 static const QString FROM_CONTROL_CENTRE      = QString::fromLatin1("@ControlCenter");
 static const QString FROM_KMAIL               = QString::fromLatin1("@KMail");
@@ -313,7 +308,7 @@
 		mEmailAddress     = from;
 	if (mEmailBccFrom == MAIL_FROM_ADDR)
 		mEmailBccAddress  = bccFrom;
-	mCmdXTermCommand          = config->readPathEntry(CMD_XTERM_COMMAND);
+	mCmdXTermCommand          = translateXTermPath(config, config->readEntry(CMD_XTERM_COMMAND), false);
 	QDateTime defStartOfDay(QDate(1900,1,1), default_startOfDay);
 	mStartOfDay               = config->readDateTimeEntry(START_OF_DAY, &defStartOfDay).time();
 	mOldStartOfDay.setHMS(0,0,0);
@@ -329,9 +324,8 @@
 	mDefaultAutoClose         = config->readBoolEntry(DEF_AUTO_CLOSE, default_defaultAutoClose);
 	mDefaultConfirmAck        = config->readBoolEntry(DEF_CONFIRM_ACK, default_defaultConfirmAck);
 	mDefaultCopyToKOrganizer  = config->readBoolEntry(DEF_COPY_TO_KORG, default_defaultCopyToKOrganizer);
-	mDefaultSound             = config->readBoolEntry(DEF_SOUND, default_defaultSound);
 	int soundType             = config->readNumEntry(DEF_SOUND_TYPE, default_defaultSoundType);
-	mDefaultSoundType         = (soundType < SoundPicker::BEEP || soundType > SoundPicker::PLAY_FILE)
+	mDefaultSoundType         = (soundType < 0 || soundType > SoundPicker::SPEAK)
 	                          ? default_defaultSoundType : (SoundPicker::Type)soundType;
 	mDefaultSoundVolume       = static_cast<float>(config->readDoubleNumEntry(DEF_SOUND_VOLUME, default_defaultSoundVolume));
 #ifdef WITHOUT_ARTS
@@ -356,8 +350,6 @@
 	                          ? default_defaultReminderUnits : (TimePeriod::Units)reminderUnits;
 	mDefaultPreAction         = config->readEntry(DEF_PRE_ACTION, default_defaultPreAction);
 	mDefaultPostAction        = config->readEntry(DEF_POST_ACTION, default_defaultPostAction);
-	mAutostartDaemon          = Daemon::autoStart(default_autostartDaemon);
-	mOldAutostartDaemon       = mAutostartDaemon;
 	mInstance->emitPreferencesChanged();
 	mStartOfDayChanged = (mStartOfDay != mOldStartOfDay);
 	if (mStartOfDayChanged)
@@ -398,18 +390,18 @@
 	config->writeEntry(EMAIL_COPY_TO_KMAIL, mEmailCopyToKMail);
 	config->writeEntry(EMAIL_FROM, emailFrom(mEmailFrom, true, false));
 	config->writeEntry(EMAIL_BCC_ADDRESS, emailFrom(mEmailBccFrom, true, true));
+	config->writeEntry(CMD_XTERM_COMMAND, translateXTermPath(config, mCmdXTermCommand, true));
 	config->writeEntry(START_OF_DAY, QDateTime(QDate(1900,1,1), mStartOfDay));
-	config->writePathEntry(CMD_XTERM_COMMAND, mCmdXTermCommand);
 	// Start-of-day check value is only written once the start-of-day time has been processed.
 	config->writeEntry(DISABLED_COLOUR, mDisabledColour);
 	config->writeEntry(EXPIRED_COLOUR, mExpiredColour);
 	config->writeEntry(EXPIRED_KEEP_DAYS, mExpiredKeepDays);
+
 	config->setGroup(DEFAULTS_SECTION);
 	config->writeEntry(DEF_LATE_CANCEL, mDefaultLateCancel);
 	config->writeEntry(DEF_AUTO_CLOSE, mDefaultAutoClose);
 	config->writeEntry(DEF_CONFIRM_ACK, mDefaultConfirmAck);
 	config->writeEntry(DEF_COPY_TO_KORG, mDefaultCopyToKOrganizer);
-	config->writeEntry(DEF_SOUND, mDefaultSound);
 	config->writeEntry(DEF_SOUND_TYPE, mDefaultSoundType);
 	config->writePathEntry(DEF_SOUND_FILE, mDefaultSoundFile);
 	config->writeEntry(DEF_SOUND_VOLUME, static_cast<double>(mDefaultSoundVolume));
@@ -423,14 +415,9 @@
 	config->writeEntry(DEF_REMIND_UNITS, mDefaultReminderUnits);
 	config->writeEntry(DEF_PRE_ACTION, mDefaultPreAction);
 	config->writeEntry(DEF_POST_ACTION, mDefaultPostAction);
+
 	if (syncToDisc)
 		config->sync();
-	if (mAutostartDaemon != mOldAutostartDaemon)
-	{
-		// The alarm daemon autostart setting has changed.
-		Daemon::enableAutoStart(mAutostartDaemon);
-		mOldAutostartDaemon = mAutostartDaemon;
-	}
 	mInstance->emitPreferencesChanged();
 	if (mStartOfDay != mOldStartOfDay)
 	{
@@ -565,42 +552,117 @@
 	KConfig* config = KGlobal::config();
 	config->setGroup(GENERAL_SECTION);
 	int version = KAlarm::getVersionNumber(config->readEntry(VERSION_NUM));
-	if (version >= KAlarm::Version(1,3,0))
+	if (version >= KAlarm::Version(1,4,6))
 		return;     // config format is up to date
 
-	bool sync = false;
-	QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
-	if (entries.find(EMAIL_FROM) == entries.end()
-	&&  entries.find(EMAIL_USE_CONTROL_CENTRE) != entries.end())
+	// Convert KAlarm 1.4.5 preferences
+	static const QString DEF_SOUND = QString::fromLatin1("DefSound");
+	config->setGroup(DEFAULTS_SECTION);
+	bool sound = config->readBoolEntry(DEF_SOUND, false);
+	if (!sound)
+		config->writeEntry(DEF_SOUND_TYPE, SoundPicker::NONE);
+	config->deleteEntry(DEF_SOUND);
+
+	if (version < KAlarm::Version(1,3,0))
 	{
-		// Preferences were written by KAlarm pre-1.2.1
-		config->setGroup(GENERAL_SECTION);
-		bool useCC = false;
-		bool bccUseCC = false;
-		const bool default_emailUseControlCentre    = true;
-		const bool default_emailBccUseControlCentre = true;
-		useCC = config->readBoolEntry(EMAIL_USE_CONTROL_CENTRE, default_emailUseControlCentre);
-		// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
-		bccUseCC = config->hasKey(EMAIL_BCC_USE_CONTROL_CENTRE)
-		         ? config->readBoolEntry(EMAIL_BCC_USE_CONTROL_CENTRE, default_emailBccUseControlCentre)
-			 : useCC;
-		config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
-		config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
-		config->deleteEntry(EMAIL_ADDRESS);
-		config->deleteEntry(EMAIL_BCC_USE_CONTROL_CENTRE);
-		config->deleteEntry(EMAIL_USE_CONTROL_CENTRE);
-		sync = true;
+		// Convert KAlarm pre-1.3 preferences
+		static const QString EMAIL_ADDRESS             = QString::fromLatin1("EmailAddress");
+		static const QString EMAIL_USE_CTRL_CENTRE     = QString::fromLatin1("EmailUseControlCenter");
+		static const QString EMAIL_BCC_USE_CTRL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
+		QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
+		if (entries.find(EMAIL_FROM) == entries.end()
+		&&  entries.find(EMAIL_USE_CTRL_CENTRE) != entries.end())
+		{
+			// Preferences were written by KAlarm pre-1.2.1
+			config->setGroup(GENERAL_SECTION);
+			bool useCC = false;
+			bool bccUseCC = false;
+			const bool default_emailUseControlCentre    = true;
+			const bool default_emailBccUseControlCentre = true;
+			useCC = config->readBoolEntry(EMAIL_USE_CTRL_CENTRE, default_emailUseControlCentre);
+			// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
+			bccUseCC = config->hasKey(EMAIL_BCC_USE_CTRL_CENTRE)
+			         ? config->readBoolEntry(EMAIL_BCC_USE_CTRL_CENTRE, default_emailBccUseControlCentre)
+				 : useCC;
+			config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
+			config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
+			config->deleteEntry(EMAIL_ADDRESS);
+			config->deleteEntry(EMAIL_BCC_USE_CTRL_CENTRE);
+			config->deleteEntry(EMAIL_USE_CTRL_CENTRE);
+		}
+		// Convert KAlarm 1.2 preferences
+		static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
+		config->setGroup(DEFAULTS_SECTION);
+		if (config->hasKey(DEF_CMD_XTERM))
+		{
+			config->writeEntry(DEF_CMD_LOG_TYPE,
+				(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
+			config->deleteEntry(DEF_CMD_XTERM);
+		}
 	}
-	// Convert KAlarm 1.2 preferences
-	static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
-	config->setGroup(DEFAULTS_SECTION);
-	if (config->hasKey(DEF_CMD_XTERM))
+	config->setGroup(GENERAL_SECTION);
+	config->writeEntry(VERSION_NUM, KALARM_VERSION);
+	config->sync();
+}
+
+/******************************************************************************
+* Translate an X terminal command path to/from config file format.
+* Note that only a home directory specification at the start of the path is
+* translated, so there's no need to worry about missing out some of the
+* executable's path due to quotes etc.
+* N.B. Calling KConfig::read/writePathEntry() on the entire command line
+*      causes a crash on some systems, so it's necessary to extract the
+*      executable path first before processing.
+*/
+QString translateXTermPath(KConfig* config, const QString& cmdline, bool write)
+{
+	QString params;
+	QString cmd = cmdline;
+	if (cmdline.isEmpty())
+		return cmdline;
+	// Strip any leading quote
+	QChar quote = cmdline[0];
+	char q = static_cast<char>(quote);
+	bool quoted = (q == '"' || q == '\'');
+	if (quoted)
+		cmd = cmdline.mid(1);
+	// Split the command at the first non-escaped space
+	for (int i = 0, count = cmd.length();  i < count;  ++i)
 	{
-		config->writeEntry(DEF_CMD_LOG_TYPE,
-			(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
-		config->deleteEntry(DEF_CMD_XTERM);
-		sync = true;
+		switch (cmd[i].latin1())
+		{
+			case '\\':
+				++i;
+				continue;
+			case '"':
+			case '\'':
+				if (cmd[i] != quote)
+					continue;
+				// fall through to ' '
+			case ' ':
+				params = cmd.mid(i);
+				cmd = cmd.left(i);
+				break;
+			default:
+				continue;
+		}
+		break;
 	}
-	if (sync)
-		config->sync();
+	// Translate any home directory specification at the start of the
+	// executable's path.
+	if (write)
+	{
+		config->writePathEntry(TEMP, cmd);
+		cmd = config->readEntry(TEMP);
+	}
+	else
+	{
+		config->writeEntry(TEMP, cmd);
+		cmd = config->readPathEntry(TEMP);
+	}
+	config->deleteEntry(TEMP);
+	if (quoted)
+		return quote + cmd + params;
+	else
+		return cmd + params;
 }
Index: kalarm/templatedlg.cpp
===================================================================
--- kalarm/templatedlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/templatedlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  templatedlg.cpp  -  dialogue to create, edit and delete alarm templates
  *  Program:  kalarm
- *  Copyright (c) 2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -144,14 +144,14 @@
 */
 void TemplateDlg::createTemplate(const KAEvent* event, QWidget* parent, TemplateListView* view)
 {
-	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, "editDlg", event);
+	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, 0, event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent event;
 		editDlg.getEvent(event);
 
 		// Add the template to the displayed lists and to the calendar file
-		KAlarm::addTemplate(event, view);
+		KAlarm::addTemplate(event, view, &editDlg);
 		Undo::saveAdd(event);
 	}
 }
@@ -166,7 +166,7 @@
 	if (item)
 	{
 		KAEvent event = item->event();
-		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, "editDlg", &event);
+		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, 0, &event);
 		if (editDlg.exec() == QDialog::Accepted)
 		{
 			KAEvent newEvent;
@@ -175,7 +175,7 @@
 			newEvent.setEventID(id);
 
 			// Update the event in the displays and in the calendar file
-			KAlarm::updateTemplate(newEvent, mTemplateList);
+			KAlarm::updateTemplate(newEvent, mTemplateList, &editDlg);
 			Undo::saveEdit(event, newEvent);
 		}
 	}
@@ -195,16 +195,29 @@
 		    != KMessageBox::Continue)
 		return;
 
+	int warnErr = 0;
+	KAlarm::UpdateStatus status = KAlarm::UPDATE_OK;
 	QValueList<KAEvent> events;
 	AlarmCalendar::templateCalendar()->startUpdate();    // prevent multiple saves of the calendar until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
 	{
 		TemplateListViewItem* item = (TemplateListViewItem*)(*it);
 		events.append(item->event());
-		KAlarm::deleteTemplate(item->event());
+		KAlarm::UpdateStatus st = KAlarm::deleteTemplate(item->event());
+		if (st != KAlarm::UPDATE_OK)
+		{
+			status = st;
+			++warnErr;
+		}
 	}
-	AlarmCalendar::templateCalendar()->endUpdate();    // save the calendar now
+	if (!AlarmCalendar::templateCalendar()->endUpdate())    // save the calendar now
+	{
+		status = KAlarm::SAVE_FAILED;
+		warnErr = items.count();
+	}
 	Undo::saveDeletes(events);
+	if (warnErr)
+		displayUpdateError(this, status, KAlarm::ERR_TEMPLATE, warnErr);
 }
 
 /******************************************************************************
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.5"
+#define KALARM_VERSION "1.4.9"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -114,7 +114,7 @@
 }
 
 MainWindow::MainWindow(bool restored)
-	: MainWindowBase(0, 0, WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
+	: MainWindowBase(0, "MainWin", WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
 	  mMinuteTimerActive(false),
 	  mHiddenTrayParent(false),
 	  mShowExpired(Preferences::showExpiredAlarms()),
@@ -567,7 +567,7 @@
 */
 void MainWindow::executeNew(MainWindow* win, const KAEvent* evnt, KAEvent::Action action, const AlarmText& text)
 {
-	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, "editDlg", evnt);
+	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, 0, evnt);
 	if (!text.isEmpty())
 		editDlg.setAction(action, text);
 	if (editDlg.exec() == QDialog::Accepted)
@@ -576,8 +576,8 @@
 		editDlg.getEvent(event);
 
 		// Add the alarm to the displayed lists and to the calendar file
-		if (KAlarm::addEvent(event, (win ? win->mListView : 0)) == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_ADD, 1);
+		if (KAlarm::addEvent(event, (win ? win->mListView : 0), &editDlg) == KAlarm::UPDATE_KORG_ERR)
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_ADD, 1);
 		Undo::saveAdd(event);
 
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
@@ -637,7 +637,7 @@
 */
 void MainWindow::executeEdit(KAEvent& event, MainWindow* win)
 {
-	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, "editDlg", &event);
+	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, 0, &event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent newEvent;
@@ -648,12 +648,13 @@
 		if (changeDeferral)
 		{
 			// The only change has been to an existing deferral
-			KAlarm::updateEvent(newEvent, view, true, false);   // keep the same event ID
+			if (KAlarm::updateEvent(newEvent, view, &editDlg, true, false) != KAlarm::UPDATE_OK)   // keep the same event ID
+				return;   // failed to save event
 		}
 		else
 		{
-			if (KAlarm::modifyEvent(event, newEvent, view) == KAlarm::UPDATE_KORG_ERR)
-				KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_MODIFY, 1);
+			if (KAlarm::modifyEvent(event, newEvent, view, &editDlg) == KAlarm::UPDATE_KORG_ERR)
+				KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		}
 		Undo::saveEdit(event, newEvent);
 
@@ -671,9 +672,9 @@
 	if (item)
 	{
 		KAEvent event = item->event();
-		EditAlarmDlg editDlg(false, (event.expired() ? i18n("Expired Alarm") + " [" + i18n("read-only") + "]"
+		EditAlarmDlg editDlg(false, (event.expired() ? i18n("Expired Alarm") + " [" + i18n("read-only") + ']'
 		                                             : i18n("View Alarm")),
-		                     this, "editDlg", &event, true);
+		                     this, 0, &event, true);
 		editDlg.exec();
 	}
 }
@@ -685,6 +686,14 @@
 void MainWindow::slotDelete()
 {
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
+	// Copy the events to be deleted, in case any are deleted by being
+	// triggered while the confirmation prompt is displayed.
+	QValueList<KAEvent> events;
+	for (QValueList<EventListViewItemBase*>::Iterator iit = items.begin();  iit != items.end();  ++iit)
+	{
+		AlarmListViewItem* item = (AlarmListViewItem*)(*iit);
+		events.append(item->event());
+	}
 	if (Preferences::confirmAlarmDeletion())
 	{
 		int n = items.count();
@@ -697,25 +706,35 @@
 			return;
 	}
 
+	int warnErr = 0;
 	int warnKOrg = 0;
-	QValueList<KAEvent> events;
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
 	AlarmCalendar::expiredCalendar()->startUpdate();
-	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
+	for (QValueList<KAEvent>::Iterator it = events.begin();  it != events.end();  ++it)
 	{
-		AlarmListViewItem* item = (AlarmListViewItem*)(*it);
-		KAEvent event = item->event();
-
 		// Delete the event from the calendar and displays
-		events.append(event);
-		if (KAlarm::deleteEvent(event) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::deleteEvent(*it))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = events.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveDeletes(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_DELETE, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_DELETE, warnKOrg);
 }
 
@@ -725,6 +744,7 @@
 */
 void MainWindow::slotReactivate()
 {
+	int warnErr = 0;
 	int warnKOrg = 0;
 	QValueList<KAEvent> events;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
@@ -737,14 +757,28 @@
 		AlarmListViewItem* item = (AlarmListViewItem*)(*it);
 		KAEvent event = item->event();
 		events.append(event);
-		if (KAlarm::reactivateEvent(event, mListView, true) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::reactivateEvent(event, mListView, true))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveReactivates(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_REACTIVATE, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 }
 
@@ -755,6 +789,7 @@
 void MainWindow::slotEnable()
 {
 	bool enable = mActionEnableEnable;    // save since changed in response to KAlarm::enableEvent()
+	int warnErr = 0;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
@@ -763,9 +798,13 @@
 		KAEvent event = item->event();
 
 		// Enable the alarm in the displayed lists and in the calendar file
-		KAlarm::enableEvent(event, mListView, enable);
+		if (KAlarm::enableEvent(event, mListView, enable) != KAlarm::UPDATE_OK)
+			++warnErr;
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
 }
 
 /******************************************************************************
@@ -830,14 +869,28 @@
 		if (events.count())
 		{
 			mListView->clearSelection();
+			int warnErr = 0;
 			int warnKOrg = 0;
 			for (QValueList<KAEvent>::Iterator ev = events.begin();  ev != events.end();  ++ev)
 			{
 				// Add alarm to the displayed lists and to the calendar file
-				if (KAlarm::addEvent(*ev, mListView) == KAlarm::UPDATE_KORG_ERR)
-					++warnKOrg;
+				switch (KAlarm::addEvent(*ev, mListView))
+				{
+					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
+						++warnErr;
+						break;
+					case KAlarm::UPDATE_KORG_ERR:
+						++warnKOrg;
+						break;
+					default:
+						break;
+				}
 			}
-			if (warnKOrg)
+			if (warnErr)
+				KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
+			else if (warnKOrg)
 				KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 			KAlarm::outputAlarmWarnings(&dlg);
 		}
Index: kalarm/editdlg.h
===================================================================
--- kalarm/editdlg.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/editdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.h  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -233,7 +233,6 @@
 		int                 mSavedTemplateAfterTime; // mTemplateAfterTime value
 		QButton*            mSavedTypeRadio;      // mMessageRadio, etc
 		SoundPicker::Type   mSavedSoundType;      // mSoundPicker sound type
-		bool                mSavedSound;          // mSoundPicker sound status
 		bool                mSavedRepeatSound;    // mSoundPicker repeat status
 		QString             mSavedSoundFile;      // mSoundPicker sound file
 		float               mSavedSoundVolume;    // mSoundPicker volume
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright (c) 2001-2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,6 +28,7 @@
 
 #include "preferences.h"
 #include "recurrenceedit.h"
+#include "soundpicker.h"
 
 class QButtonGroup;
 class QCheckBox;
@@ -126,8 +127,7 @@
 		QRadioButton*  mRunOnDemand;
 		QCheckBox*     mDisableAlarmsIfStopped;
 		QCheckBox*     mQuitWarn;
-		QCheckBox*     mAutostartTrayIcon1;
-		QCheckBox*     mAutostartTrayIcon2;
+		QCheckBox*     mAutostartTrayIcon;
 		QCheckBox*     mConfirmAlarmDeletion;
 		QCheckBox*     mKeepExpired;
 		QCheckBox*     mPurgeExpired;
@@ -192,8 +192,6 @@
 		void         slotBrowseSoundFile();
 
 	private:
-		void         setSoundType(SoundPicker::Type);
-
 		QCheckBox*      mAutoClose;
 		QCheckBox*      mConfirmAck;
 		QComboBox*      mReminderUnits;
@@ -201,10 +199,7 @@
 		QCheckBox*      mCmdScript;
 		QCheckBox*      mCmdXterm;
 		QCheckBox*      mEmailBcc;
-		QRadioButton*   mBeep;
-		QRadioButton*   mSpeak;
-		QRadioButton*   mFile;
-		QCheckBox*      mSound;
+		QComboBox*      mSound;
 		QLabel*         mSoundFileLabel;
 		QLineEdit*      mSoundFile;
 		QPushButton*    mSoundFileBrowse;
@@ -214,6 +209,7 @@
 		QComboBox*      mRecurPeriod;
 		QButtonGroup*   mFeb29;
 
+		static int soundIndex(SoundPicker::Type);
 		static int recurIndex(RecurrenceEdit::RepeatType);
 };
 
Index: kalarm/kalarmd/kalarmd.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kalarmd/kalarmd.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Name[fi]=Hälytyspalvelin
 Name[fr]=Démon d'alarme
 Name[ga]=Deamhan KAlarm
+Name[gl]=Daemon de KAlarm
 Name[he]=תהליך הרקע תזכורות
 Name[hu]=KAlarm szolgáltatás
 Name[is]=KAlarm þjónn
@@ -38,7 +39,7 @@
 Name[sv]=Alarmdemon
 Name[ta]=கேஅலாரம் டெமான்
 Name[tr]=KAlarm Servis Programı
-Name[uk]=Даемон KAlarm
+Name[uk]=Демон KAlarm
 Name[zh_CN]=KAlarm 进程
 Name[zh_TW]=KAlarm 守護程式
 Exec=kalarmd
Index: kalarm/kalarmd/kalarmd.autostart.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.autostart.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kalarmd/kalarmd.autostart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Name[fi]=Hälytyspalvelin
 Name[fr]=Démon d'alarme
 Name[ga]=Deamhan KAlarm
+Name[gl]=Daemon de KAlarm
 Name[he]=תהליך הרקע תזכורות
 Name[hu]=KAlarm szolgáltatás
 Name[is]=KAlarm þjónn
@@ -38,7 +39,7 @@
 Name[sv]=Alarmdemon
 Name[ta]=கேஅலாரம் டெமான்
 Name[tr]=KAlarm Servis Programı
-Name[uk]=Даемон KAlarm
+Name[uk]=Демон KAlarm
 Name[zh_CN]=KAlarm 进程
 Name[zh_TW]=KAlarm 守護程式
 Exec=kalarmd --autostart
@@ -57,6 +58,7 @@
 Comment[fa]=آغاز خودکار هشدار KAlarm در ورود
 Comment[fi]=KOrganizer/KAlarm-hälytyspalvelimen automaattikäynnistys sisäänkirjautuessa
 Comment[fr]=Le démon d'alarme de KOrganizer et de KAlarm démarre automatiquement lors de la connexion
+Comment[gl]=Autoinicio á entrada do daemon de KAlarm 
 Comment[he]=הפעלה אוטומטית של תהליך הרקע תזכורות של KAlarm בעת ההפעלה
 Comment[hu]=A KAlarm emlékeztető szolgáltatás automatikus elindítása
 Comment[is]=Ræsa KAlarm áminningaþjónn sjálfkrafa við byrjun setu
@@ -80,7 +82,7 @@
 Comment[sv]=Kalarm-alarmdemon, automatisk start vid inloggning
 Comment[ta]=உள்நுழையும்போது கேஅலாரம் அலாரம் டெமான் தானாகவே துவங்கும்
 Comment[tr]=KAlarm alarm servis programı (açılışta başlar)
-Comment[uk]=Автозавантаження даемона нагадувань KAlarm
+Comment[uk]=Автозавантаження демона нагадувань KAlarm
 Comment[zh_CN]=登录时自动启动 KAlarm 定时守护进程
 Comment[zh_TW]=登入時自動啟動 KAlarm 鬧鐘守護程式
 Terminal=false
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,22 @@
 KAlarm
 
+=== Version 1.4.9 --- 3 January 2007 ===
+
+=== Version 1.4.8 --- 28 December 2006 ===
+Fix Find always using first search text entered even after entering a new one.
+
+=== Version 1.4.7 --- 14 December 2006 ===
+Fix crash saving Preferences dialogue (due to command alarm terminal setting).
+
+=== Version 1.4.6 --- 30 November 2006 ===
+Fix crash if an alarm triggers while user is deleting it.
+Fix "Start alarm monitoring at login" value shown in preferences dialogue.
+Fix deselecting "Start alarm monitoring at login" when daemon not running.
+Fix editing of 29th February alarm options for non-leap years.
+Tidy up preferences dialogue Run mode options.
+Tidy up alarm edit/preferences dialogue sound type options into a combo box.
+Add context help for sound file fade options.
+
 === Version 1.4.5 (KDE 3.5.5) --- 29 September 2006 ===
 Improve edit dialogue layout (Reminder controls moved to below Time box).
 
Index: kalarm/daemon.h
===================================================================
--- kalarm/daemon.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/daemon.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -46,7 +46,7 @@
 		static bool      reregister()            { return registerWith(true); }
 		static bool      reset();
 		static bool      stop();
-		static bool      autoStart(bool defaultSetting);
+		static bool      autoStart();
 		static void      enableAutoStart(bool enable);
 		static void      setAlarmsEnabled()      { mInstance->setAlarmsEnabled(true); }
 		static void      checkStatus()           { checkIfRunning(); }
Index: kalarm/calendarcompat.cpp
===================================================================
--- kalarm/calendarcompat.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/calendarcompat.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -86,7 +86,7 @@
 	{
 		// Older versions used KAlarm's translated name in the product ID, which
 		// could have created problems using a calendar in different locales.
-		progname = QString(" ") + kapp->aboutData()->programName() + " ";
+		progname = QString(" ") + kapp->aboutData()->programName() + ' ';
 		i = prodid.find(progname, 0, false);
 		if (i < 0)
 			return 0;    // calendar wasn't created by KAlarm
@@ -119,7 +119,7 @@
 	if (!file.open(IO_ReadOnly))
 		return false;
 	QTextStream ts(&file);
-	ts.setEncoding(QTextStream::UnicodeUTF8);
+	ts.setEncoding(QTextStream::Latin1);
 	QString text = ts.read();
 	file.close();
 
Index: kalarm/karecurrence.h
===================================================================
--- kalarm/karecurrence.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/karecurrence.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  karecurrence.h  -  recurrence with special yearly February 29th handling
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -65,6 +65,8 @@
 		QDateTime   endDateTime() const;
 		QDate       endDate() const;
 		bool        recursOn(const QDate&) const;
+		QDateTime   getNextDateTime(const QDateTime& preDateTime) const;
+		QDateTime   getPreviousDateTime(const QDateTime& afterDateTime) const;
 		int         longestInterval() const;
 		Type        type() const;
 		static Type type(const KCal::RecurrenceRule*);
Index: kalarm/sounddlg.cpp
===================================================================
--- kalarm/sounddlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/sounddlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  sounddlg.cpp  -  sound file selection and configuration dialog
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -134,7 +134,7 @@
 	label->setBuddy(mFadeTime);
 	label = new QLabel(i18n("seconds"), mFadeBox);
 	label->setFixedSize(label->sizeHint());
-	QWhatsThis::add(box, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
+	QWhatsThis::add(mFadeBox, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
 
 	// Fade slider
 	mFadeVolumeBox = new QHBox(group);
@@ -147,7 +147,7 @@
 	mFadeSlider->setTickInterval(10);
 	mFadeSlider->setSizePolicy(QSizePolicy(QSizePolicy::Expanding, QSizePolicy::Fixed));
 	label->setBuddy(mFadeSlider);
-	QWhatsThis::add(box, i18n("Choose the initial volume for playing the sound file."));
+	QWhatsThis::add(mFadeVolumeBox, i18n("Choose the initial volume for playing the sound file."));
 
 	// Restore the dialogue size from last time
 	QSize s;
Index: kalarm/find.cpp
===================================================================
--- kalarm/find.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/find.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  find.cpp  -  search facility 
  *  Program:  kalarm
- *  Copyright (C) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -85,9 +85,9 @@
 	else
 	{
 #ifdef MODAL_FIND
-		mDialog = new KFindDialog(mListView, "findDlg", mOptions, mHistory, (mListView->selectedCount() > 1));
+		mDialog = new KFindDialog(mListView, "FindDlg", mOptions, mHistory, (mListView->selectedCount() > 1));
 #else
-		mDialog = new KFindDialog(false, mListView, "findDlg", mOptions, mHistory, (mListView->selectedCount() > 1));
+		mDialog = new KFindDialog(false, mListView, "FindDlg", mOptions, mHistory, (mListView->selectedCount() > 1));
 #endif
 		mDialog->setHasSelection(false);
 		QWidget* kalarmWidgets = mDialog->findExtension();
@@ -148,7 +148,6 @@
 #ifndef MODAL_FIND
 		connect(mDialog, SIGNAL(okClicked()), this, SLOT(slotFind()));
 #endif
-		connect(mDialog, SIGNAL(destroyed()), this, SLOT(slotDlgDestroyed()));
 	}
 
 	// Only display active/expired options if expired alarms are being kept
@@ -231,8 +230,9 @@
 	long options = mOptions & (KFindDialog::WholeWordsOnly | KFindDialog::CaseSensitive | KFindDialog::RegularExpression);
 	if (mFind)
 	{
+		mFind->setPattern(mDialog->pattern());
+		mFind->setOptions(options);
 		delete mDialog;    // automatically set to 0
-		mFind->setOptions(options);
 		findNext(true, true, false);
 	}
 	else
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.cpp  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -36,6 +36,7 @@
 #include <kglobal.h>
 #include <klocale.h>
 #include <kstandarddirs.h>
+#include <kshell.h>
 #include <kmessagebox.h>
 #include <kaboutdata.h>
 #include <kapplication.h>
@@ -48,6 +49,7 @@
 
 #include "alarmcalendar.h"
 #include "alarmtimewidget.h"
+#include "daemon.h"
 #include "editdlg.h"
 #include "fontcolour.h"
 #include "functions.h"
@@ -91,7 +93,7 @@
 =============================================================================*/
 
 KAlarmPrefDlg::KAlarmPrefDlg()
-	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, 0, true, true)
+	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", true, true)
 {
 	setIconListAllVisible(true);
 
@@ -225,26 +227,25 @@
 	// Get alignment to use in QGridLayout (AlignAuto doesn't work correctly there)
 	int alignment = QApplication::reverseLayout() ? Qt::AlignRight : Qt::AlignLeft;
 
-	// Autostart alarm daemon
-	QHBox* itemBox = new QHBox(mPage);   // this is to allow left adjustment
-	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), itemBox, "startDaemon");
-	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
-	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
-	QWhatsThis::add(mAutostartDaemon,
-	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
-	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
-	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
-	itemBox->setStretchFactor(new QWidget(itemBox), 1);    // left adjust the controls
-
 	QGroupBox* group = new QButtonGroup(i18n("Run Mode"), mPage, "modeGroup");
-	QGridLayout* grid = new QGridLayout(group, 6, 3, KDialog::marginHint(), KDialog::spacingHint());
+	QGridLayout* grid = new QGridLayout(group, 6, 2, KDialog::marginHint(), KDialog::spacingHint());
 	grid->setColStretch(2, 1);
 	grid->addColSpacing(0, indentWidth());
 	grid->addColSpacing(1, indentWidth());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	int row = 1;
 
-	// Run-in-system-tray radio button has an ID of 0
+	// Run-on-demand radio button
+	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
+	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
+	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
+	QWhatsThis::add(mRunOnDemand,
+	      i18n("Check to run KAlarm only when required.\n\n"
+	           "Notes:\n"
+	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
+	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
+	grid->addMultiCellWidget(mRunOnDemand, 1, 1, 0, 2, alignment);
+
+	// Run-in-system-tray radio button
 	mRunInSystemTray = new QRadioButton(i18n("Run continuously in system &tray"), group, "runTray");
 	mRunInSystemTray->setFixedSize(mRunInSystemTray->sizeHint());
 	connect(mRunInSystemTray, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
@@ -254,58 +255,42 @@
 	           "1. With this option selected, closing the system tray icon will quit KAlarm.\n"
 	           "2. You do not need to select this option in order for alarms to be displayed, since alarm monitoring is done by the alarm daemon."
 	           " Running in the system tray simply provides easy access and a status indication."));
-	grid->addMultiCellWidget(mRunInSystemTray, row, row, 0, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mRunInSystemTray, 2, 2, 0, 2, alignment);
 
-	mAutostartTrayIcon1 = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
-	mAutostartTrayIcon1->setFixedSize(mAutostartTrayIcon1->sizeHint());
-#ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon1, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
-#endif
-	QWhatsThis::add(mAutostartTrayIcon1,
-	      i18n("Check to run KAlarm whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon1, row, row, 1, 2, alignment);
-	++row;
-
+	// Run continuously options
 	mDisableAlarmsIfStopped = new QCheckBox(i18n("Disa&ble alarms while not running"), group, "disableAl");
 	mDisableAlarmsIfStopped->setFixedSize(mDisableAlarmsIfStopped->sizeHint());
 	connect(mDisableAlarmsIfStopped, SIGNAL(toggled(bool)), SLOT(slotDisableIfStoppedToggled(bool)));
 	QWhatsThis::add(mDisableAlarmsIfStopped,
 	      i18n("Check to disable alarms whenever KAlarm is not running. Alarms will only appear while the system tray icon is visible."));
-	grid->addMultiCellWidget(mDisableAlarmsIfStopped, row, row, 1, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mDisableAlarmsIfStopped, 3, 3, 1, 2, alignment);
 
 	mQuitWarn = new QCheckBox(i18n("Warn before &quitting"), group, "disableAl");
 	mQuitWarn->setFixedSize(mQuitWarn->sizeHint());
 	QWhatsThis::add(mQuitWarn,
 	      i18n("Check to display a warning prompt before quitting KAlarm."));
-	grid->addWidget(mQuitWarn, row, 2, alignment);
-	++row;
+	grid->addWidget(mQuitWarn, 4, 2, alignment);
 
-	// Run-on-demand radio button has an ID of 3
-	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
-	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
-	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
-	QWhatsThis::add(mRunOnDemand,
-	      i18n("Check to run KAlarm only when required.\n\n"
-	           "Notes:\n"
-	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
-	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
-	grid->addMultiCellWidget(mRunOnDemand, row, row, 0, 2, alignment);
-	++row;
-
-	mAutostartTrayIcon2 = new QCheckBox(i18n("Autostart system tray &icon at login"), group, "autoRun");
-	mAutostartTrayIcon2->setFixedSize(mAutostartTrayIcon2->sizeHint());
+	mAutostartTrayIcon = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
 #ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon2, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
+	connect(mAutostartTrayIcon, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
 #endif
-	QWhatsThis::add(mAutostartTrayIcon2,
-	      i18n("Check to display the system tray icon whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon2, row, row, 1, 2, alignment);
+	grid->addMultiCellWidget(mAutostartTrayIcon, 5, 5, 0, 2, alignment);
+
+	// Autostart alarm daemon
+	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), group, "startDaemon");
+	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
+	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
+	QWhatsThis::add(mAutostartDaemon,
+	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
+	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
+	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
+	grid->addMultiCellWidget(mAutostartDaemon, 6, 6, 0, 2, alignment);
+
 	group->setFixedHeight(group->sizeHint().height());
 
 	// Start-of-day time
-	itemBox = new QHBox(mPage);
+	QHBox* itemBox = new QHBox(mPage);
 	QHBox* box = new QHBox(itemBox);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	QLabel* label = new QLabel(i18n("&Start of day for date-only alarms:"), box);
@@ -370,7 +355,7 @@
 	      i18n("Choose which application to use when a command alarm is executed in a terminal window"));
 	grid = new QGridLayout(group, 1, 3, KDialog::marginHint(), KDialog::spacingHint());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	row = 0;
+	int row = 0;
 
 	mXtermType = new QButtonGroup(group);
 	mXtermType->hide();
@@ -379,11 +364,10 @@
 	for (mXtermCount = 0;  !xtermCommands[mXtermCount].isNull();  ++mXtermCount)
 	{
 		QString cmd = xtermCommands[mXtermCount];
-		int i = cmd.find(' ');    // find the end of the terminal window name
-		QString term = cmd.left(i > 0 ? i : 1000);
-		if (KStandardDirs::findExe(term).isEmpty())
+		QStringList args = KShell::splitArgs(cmd);
+		if (args.isEmpty()  ||  KStandardDirs::findExe(args[0]).isEmpty())
 			continue;
-		QRadioButton* radio = new QRadioButton(term, group);
+		QRadioButton* radio = new QRadioButton(args[0], group);
 		radio->setMinimumSize(radio->sizeHint());
 		mXtermType->insert(radio, mXtermCount);
 		cmd.replace("%t", kapp->aboutData()->programName());
@@ -413,14 +397,13 @@
 
 void MiscPrefTab::restore()
 {
-	mAutostartDaemon->setChecked(Preferences::mAutostartDaemon);
+	mAutostartDaemon->setChecked(Daemon::autoStart());
 	bool systray = Preferences::mRunInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::mDisableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::quitWarn());
-	mAutostartTrayIcon1->setChecked(Preferences::mAutostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::mAutostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::mAutostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::confirmAlarmDeletion());
 	mStartOfDay->setValue(Preferences::mStartOfDay);
 	setExpiredControls(Preferences::mExpiredKeepDays);
@@ -451,9 +434,8 @@
 			xtermID = 0;       // 'Other' is only acceptable if it's non-blank
 		else
 		{
-			int i = cmd.find(' ');    // find the end of the terminal window name
-			if (i > 0)
-				cmd = cmd.left(i);
+			QStringList args = KShell::splitArgs(cmd);
+			cmd = args.isEmpty() ? QString::null : args[0];
 			if (KStandardDirs::findExe(cmd).isEmpty())
 			{
 				mXtermCommand->setFocus();
@@ -468,12 +450,14 @@
 	Preferences::mDisableAlarmsIfStopped = mDisableAlarmsIfStopped->isChecked();
 	if (mQuitWarn->isEnabled())
 		Preferences::setQuitWarn(mQuitWarn->isChecked());
-	Preferences::mAutostartTrayIcon = systray ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
+	Preferences::mAutostartTrayIcon = mAutostartTrayIcon->isChecked();
 #ifdef AUTOSTART_BY_KALARMD
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
+	bool newAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
 #else
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked();
+	bool newAutostartDaemon = mAutostartDaemon->isChecked();
 #endif
+	if (newAutostartDaemon != Daemon::autoStart())
+		Daemon::enableAutoStart(newAutostartDaemon);
 	Preferences::setConfirmAlarmDeletion(mConfirmAlarmDeletion->isChecked());
 	int sod = mStartOfDay->value();
 	Preferences::mStartOfDay.setHMS(sod/60, sod%60, 0);
@@ -485,14 +469,13 @@
 
 void MiscPrefTab::setDefaults()
 {
-	mAutostartDaemon->setChecked(Preferences::default_autostartDaemon);
+	mAutostartDaemon->setChecked(true);
 	bool systray = Preferences::default_runInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::default_disableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::default_quitWarn);
-	mAutostartTrayIcon1->setChecked(Preferences::default_autostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::default_autostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::default_autostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::default_confirmAlarmDeletion);
 	mStartOfDay->setValue(Preferences::default_startOfDay);
 	setExpiredControls(Preferences::default_expiredKeepDays);
@@ -513,9 +496,10 @@
 
 void MiscPrefTab::slotRunModeToggled(bool)
 {
-	bool systray = (mRunInSystemTray->isOn());
-	mAutostartTrayIcon2->setEnabled(!systray);
-	mAutostartTrayIcon1->setEnabled(systray);
+	bool systray = mRunInSystemTray->isOn();
+	mAutostartTrayIcon->setText(systray ? i18n("Autostart at &login") : i18n("Autostart system tray &icon at login"));
+	QWhatsThis::add(mAutostartTrayIcon, (systray ? i18n("Check to run KAlarm whenever you start KDE.")
+	                                             : i18n("Check to display the system tray icon whenever you start KDE.")));
 	mDisableAlarmsIfStopped->setEnabled(systray);
 	slotDisableIfStoppedToggled(true);
 }
@@ -527,8 +511,7 @@
 void MiscPrefTab::slotAutostartToggled(bool)
 {
 #ifdef AUTOSTART_BY_KALARMD
-	bool autostart = mRunInSystemTray->isChecked() ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
-	mAutostartDaemon->setEnabled(!autostart);
+	mAutostartDaemon->setEnabled(!mAutostartTrayIcon->isChecked());
 #endif
 }
 
@@ -926,37 +909,25 @@
 	layout = new QVBoxLayout(bgroup, KDialog::marginHint(), KDialog::spacingHint());
 	layout->addSpacing(groupTopMargin);
 
-	mSound = new QCheckBox(SoundPicker::i18n_s_Sound(), bgroup, "defSound");
+	QBoxLayout* hlayout = new QHBoxLayout(layout, KDialog::spacingHint());
+	mSound = new QComboBox(false, bgroup, "defSound");
+	mSound->insertItem(SoundPicker::i18n_None());         // index 0
+	mSound->insertItem(SoundPicker::i18n_Beep());         // index 1
+	mSound->insertItem(SoundPicker::i18n_File());         // index 2
+	if (theApp()->speechEnabled())
+		mSound->insertItem(SoundPicker::i18n_Speak());  // index 3
 	mSound->setMinimumSize(mSound->sizeHint());
 	QWhatsThis::add(mSound, defsetting.arg(SoundPicker::i18n_Sound()));
-	layout->addWidget(mSound, 0, Qt::AlignAuto);
+	hlayout->addWidget(mSound);
+	hlayout->addStretch(1);
 
-	box = new QHBox(bgroup);
-	box->setSpacing(KDialog::spacingHint());
-	layout->addWidget(box, 0, Qt::AlignAuto);
+#ifndef WITHOUT_ARTS
+	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
+	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
+	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
+	hlayout->addWidget(mSoundRepeat);
+#endif
 
-	mBeep = new QRadioButton(SoundPicker::i18n_b_Beep(), box, "defBeep");
-	bgroup->insert(mBeep);
-	mBeep->setMinimumSize(mBeep->sizeHint());
-	QWhatsThis::add(mBeep,
-	      soundSetting.arg(SoundPicker::i18n_Beep()).arg(SoundPicker::i18n_Sound()));
-	mFile = new QRadioButton(SoundPicker::i18n_File(), box, "defFile");
-	bgroup->insert(mFile);
-	mFile->setMinimumSize(mFile->sizeHint());
-	QWhatsThis::add(mFile,
-	      soundSetting.arg(SoundPicker::i18n_File()).arg(SoundPicker::i18n_Sound()));
-	if (theApp()->speechEnabled())
-	{
-		mSpeak = new QRadioButton(SoundPicker::i18n_Speak(), box, "defSpeak");
-		mSpeak->setMinimumSize(mSpeak->sizeHint());
-		QWhatsThis::add(mSpeak,
-		      soundSetting.arg(SoundPicker::i18n_Speak()).arg(SoundPicker::i18n_Sound()));
-		bgroup->insert(mSpeak);
-	}
-	else
-		mSpeak = 0;
-	box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
-
 	box = new QHBox(bgroup);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	mSoundFileLabel = new QLabel(i18n("Sound &file:"), box);
@@ -972,13 +943,6 @@
 	      i18n("Enter the default sound file to use in the alarm edit dialog."));
 	box->setFixedHeight(box->sizeHint().height());
 	layout->addWidget(box);
-
-#ifndef WITHOUT_ARTS
-	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
-	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
-	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
-	layout->addWidget(mSoundRepeat, 0, Qt::AlignAuto);
-#endif
 	bgroup->setFixedHeight(bgroup->sizeHint().height());
 
 	// COMMAND ALARMS
@@ -1076,8 +1040,7 @@
 	mConfirmAck->setChecked(Preferences::mDefaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::mDefaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::mDefaultPreAction, Preferences::mDefaultPostAction);
-	mSound->setChecked(Preferences::mDefaultSound);
-	setSoundType(Preferences::mDefaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::mDefaultSoundType));
 	mSoundFile->setText(Preferences::mDefaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::mDefaultSoundRepeat);
@@ -1098,11 +1061,15 @@
 	Preferences::mDefaultReminderUnits    = static_cast<TimePeriod::Units>(mReminderUnits->currentItem());
 	Preferences::mDefaultPreAction        = mSpecialActionsButton->preAction();
 	Preferences::mDefaultPostAction       = mSpecialActionsButton->postAction();
-	Preferences::mDefaultSound            = mSound->isChecked();
+	switch (mSound->currentItem())
+	{
+		case 3:  Preferences::mDefaultSoundType = SoundPicker::SPEAK;      break;
+		case 2:  Preferences::mDefaultSoundType = SoundPicker::PLAY_FILE;  break;
+		case 1:  Preferences::mDefaultSoundType = SoundPicker::BEEP;       break;
+		case 0:
+		default: Preferences::mDefaultSoundType = SoundPicker::NONE;       break;
+	}
 	Preferences::mDefaultSoundFile        = mSoundFile->text();
-	Preferences::mDefaultSoundType        = mSpeak && mSpeak->isOn() ? SoundPicker::SPEAK
-	                                      : mFile->isOn()            ? SoundPicker::PLAY_FILE
-	                                      :                            SoundPicker::BEEP;
 #ifndef WITHOUT_ARTS
 	Preferences::mDefaultSoundRepeat      = mSoundRepeat->isChecked();
 #endif
@@ -1133,8 +1100,7 @@
 	mConfirmAck->setChecked(Preferences::default_defaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::default_defaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::default_defaultPreAction, Preferences::default_defaultPostAction);
-	mSound->setChecked(Preferences::default_defaultSound);
-	setSoundType(Preferences::default_defaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::default_defaultSoundType));
 	mSoundFile->setText(Preferences::default_defaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::default_defaultSoundRepeat);
@@ -1156,6 +1122,18 @@
 		mSoundFile->setText(url);
 }
 
+int EditPrefTab::soundIndex(SoundPicker::Type type)
+{
+	switch (type)
+	{
+		case SoundPicker::SPEAK:      return 3;
+		case SoundPicker::PLAY_FILE:  return 2;
+		case SoundPicker::BEEP:       return 1;
+		case SoundPicker::NONE:
+		default:                      return 0;
+	}
+}
+
 int EditPrefTab::recurIndex(RecurrenceEdit::RepeatType type)
 {
 	switch (type)
@@ -1171,30 +1149,9 @@
 	}
 }
 
-void EditPrefTab::setSoundType(SoundPicker::Type type)
-{
-	switch (type)
-	{
-		case SoundPicker::PLAY_FILE:
-			mFile->setChecked(true);
-			break;
-		case SoundPicker::SPEAK:
-			if (mSpeak)
-			{
-				mSpeak->setChecked(true);
-				break;
-			}
-			// fall through to BEEP
-		case SoundPicker::BEEP:
-		default:
-			mBeep->setChecked(true);
-			break;
-	}
-}
-
 QString EditPrefTab::validate()
 {
-	if (mFile->isOn()  &&  mSoundFile->text().isEmpty())
+	if (mSound->currentItem() == SoundPicker::PLAY_FILE  &&  mSoundFile->text().isEmpty())
 	{
 		mSoundFile->setFocus();
 		return i18n("You must enter a sound file when %1 is selected as the default sound type").arg(SoundPicker::i18n_File());;
Index: kalarm/main.cpp
===================================================================
--- kalarm/main.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -89,7 +89,7 @@
 	{ "speak", I18N_NOOP("Speak the message when it is displayed"), 0 },
 	{ "stop", I18N_NOOP("Stop the alarm scheduling daemon"), 0 },
 	{ "S", 0, 0 },
-	{ "subject ", I18N_NOOP("Email subject line"), 0 },
+	{ "subject", I18N_NOOP("Email subject line"), 0 },
 	{ "t", 0, 0 },
 	{ "time <time>", I18N_NOOP("Trigger alarm at time [[[yyyy-]mm-]dd-]hh:mm, or date yyyy-mm-dd"), 0 },
 	{ "tray", I18N_NOOP("Display system tray icon"), 0 },
Index: kalarm/kalarm.desktop
===================================================================
--- kalarm/kalarm.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kalarm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,9 +32,10 @@
 GenericName[es]=Planificador de alarmas personales
 GenericName[et]=Meeldetuletuste ajastaja
 GenericName[eu]=Alarma pertsonalen programatzailea
-GenericName[fa]=زمان‌بند هشدار شخصی 
+GenericName[fa]=زمان‌بند هشدار شخصی
 GenericName[fi]=Henkilökohtainen hälytysajastin
 GenericName[fr]=Planificateur d'alarme personnel
+GenericName[gl]=Progamador Persoal de Alarmas
 GenericName[he]=מנהל זמן אישי
 GenericName[hi]=निजी अलार्म शेड्यूलर
 GenericName[hu]=Emlékeztetőkezelő
Index: kalarm/daemon.cpp
===================================================================
--- kalarm/daemon.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/daemon.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -374,24 +374,23 @@
 	// Tell the alarm daemon in case it is running.
 	AlarmDaemonIface_stub s(DAEMON_APP_NAME, DAEMON_DCOP_OBJECT);
 	s.enableAutoStart(enable);
-	if (!s.ok())
-	{
-		// Failure - the daemon probably isn't running, so rewrite its config file for it
-		KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
-		adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-		adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
-		adconfig.sync();
-	}
+
+	// The return status doesn't report failure even if the daemon isn't running,
+	// so in case of failure, rewrite the config file in any case.
+	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
+	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
+	adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
+	adconfig.sync();
 }
 
 /******************************************************************************
 * Read the alarm daemon's autostart-at-login setting.
 */
-bool Daemon::autoStart(bool defaultAutoStart)
+bool Daemon::autoStart()
 {
 	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
 	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), defaultAutoStart);
+	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), true);
 }
 
 /******************************************************************************
@@ -677,9 +676,10 @@
 =============================================================================*/
 
 AlarmEnableAction::AlarmEnableAction(int accel, QObject* parent, const char* name)
-	: KToggleAction(QString::null, accel, parent, name),
+	: KToggleAction(i18n("Enable &Alarms"), accel, parent, name),
 	  mInitialised(false)
 {
+	setCheckedState(i18n("Disable &Alarms"));
 	setCheckedActual(false);    // set the correct text
 	mInitialised = true;
 }
@@ -692,7 +692,6 @@
 	kdDebug(5950) << "AlarmEnableAction::setCheckedActual(" << running << ")\n";
 	if (running != isChecked()  ||  !mInitialised)
 	{
-		setText(running ? i18n("&Alarms Enabled") : i18n("Enable &Alarms"));
 		KToggleAction::setChecked(running);
 		emit switched(running);
 	}
Index: kalarm/recurrenceedit.cpp
===================================================================
--- kalarm/recurrenceedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/recurrenceedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1476,6 +1476,7 @@
 		checked[(*it) - 1] = true;
 	for (int i = 0;  i < 12;  ++i)
 		mMonthBox[i]->setChecked(checked[i]);
+	enableFeb29();
 }
 
 /******************************************************************************
Index: kalarm/traywindow.cpp
===================================================================
--- kalarm/traywindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/traywindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -292,7 +292,7 @@
 	for (iit = items.begin();  iit != items.end();  ++iit)
 	{
 		kdDebug(5950) << "-- " << (count+1) << ") " << (*iit).text << endl;
-		text += "\n";
+		text += '\n';
 		text += (*iit).text;
 		if (++count == maxCount)
 			break;
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/functions.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -127,27 +127,37 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, bool useEventID, bool allowKOrgUpdate)
+UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, QWidget* errmsgParent, bool useEventID, bool allowKOrgUpdate)
 {
 	kdDebug(5950) << "KAlarm::addEvent(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 	if (!theApp()->checkCalendarDaemon())    // ensure calendar is open and daemon started
-		return UPDATE_ERROR;
-
-	// Save the event details in the calendar file, and get the new event ID
-	AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-	cal->addEvent(event, useEventID);
-	cal->save();
-
-	UpdateStatus ret = UPDATE_OK;
-	if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		return UPDATE_FAILED;
+	else
 	{
-		if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-			ret = UPDATE_KORG_ERR;
+		// Save the event details in the calendar file, and get the new event ID
+		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
+		if (!cal->addEvent(event, useEventID))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
 	}
+	if (status == UPDATE_OK)
+	{
+		if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		{
+			if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
+				status = UPDATE_KORG_ERR;
+		}
 
-	// Update the window lists
-	AlarmListView::addEvent(event, selectionView);
-	return ret;
+		// Update the window lists
+		AlarmListView::addEvent(event, selectionView);
+		return status;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -181,21 +191,29 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-bool addTemplate(KAEvent& event, TemplateListView* selectionView)
+UpdateStatus addTemplate(KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::addTemplate(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 
 	// Add the template to the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (!cal)
-		return false;
-	cal->addEvent(event);
-	cal->save();
-	cal->emitEmptyStatus();
+	if (!cal  ||  !cal->addEvent(event))
+		status = UPDATE_FAILED;
+	else if (!cal->save())
+		status = SAVE_FAILED;
+	else
+	{
+		cal->emitEmptyStatus();
 
-	// Update the window lists
-	TemplateListView::addEvent(event, selectionView);
-	return true;
+		// Update the window lists
+		TemplateListView::addEvent(event, selectionView);
+		return UPDATE_OK;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -205,15 +223,18 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * modified event in that listView instance.
 */
-UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView)
+UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::modifyEvent(): '" << oldEvent.id() << endl;
 
+	UpdateStatus status = UPDATE_OK;
 	if (!newEvent.valid())
-		return deleteEvent(oldEvent, true);
+	{
+		deleteEvent(oldEvent, true);
+		status = UPDATE_FAILED;
+	}
 	else
 	{
-		UpdateStatus ret = UPDATE_OK;
 		if (oldEvent.copyToKOrganizer())
 		{
 			// Tell KOrganizer to delete its old event.
@@ -224,20 +245,28 @@
 
 		// Update the event in the calendar file, and get the new event ID
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(oldEvent.id());
-		cal->addEvent(const_cast<KAEvent&>(newEvent), true);
-		cal->save();
+		if (!cal->deleteEvent(oldEvent.id())
+		||  !cal->addEvent(const_cast<KAEvent&>(newEvent), true))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
+		if (status == UPDATE_OK)
+		{
+			if (newEvent.copyToKOrganizer())
+			{
+				if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
+					status = UPDATE_KORG_ERR;
+			}
 
-		if (newEvent.copyToKOrganizer())
-		{
-			if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
-				ret = UPDATE_KORG_ERR;
+			// Update the window lists
+			AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
+			return status;
 		}
+	}
 
-		// Update the window lists
-		AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
-		return ret;
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -249,7 +278,7 @@
 * The event is not updated in KOrganizer, since this function is called when an
 * existing alarm is rescheduled (due to recurrence or deferral).
 */
-void updateEvent(KAEvent& event, AlarmListView* selectionView, bool archiveOnDelete, bool incRevision)
+UpdateStatus updateEvent(KAEvent& event, AlarmListView* selectionView, QWidget* errmsgParent, bool archiveOnDelete, bool incRevision)
 {
 	kdDebug(5950) << "KAlarm::updateEvent(): " << event.id() << endl;
 
@@ -262,11 +291,17 @@
 			event.incrementRevision();    // ensure alarm daemon sees the event has changed
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+		{
+			if (errmsgParent)
+				displayUpdateError(errmsgParent, SAVE_FAILED, ERR_ADD, 1);
+			return SAVE_FAILED;
+		}
 
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -274,23 +309,34 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void updateTemplate(const KAEvent& event, TemplateListView* selectionView)
+UpdateStatus updateTemplate(const KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
+	UpdateStatus status = UPDATE_OK;
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
+	if (!cal)
+		status = UPDATE_FAILED;
+	else
 	{
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			status = SAVE_FAILED;
+		else
+		{
+			TemplateListView::modifyEvent(event.id(), event, selectionView);
+			return UPDATE_OK;
+		}
+	}
 
-		TemplateListView::modifyEvent(event.id(), event, selectionView);
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete an alarm from the calendar file and from every main window instance.
 * If the event is archived, the event's ID is changed to an expired ID if necessary.
 */
-UpdateStatus deleteEvent(KAEvent& event, bool archive)
+UpdateStatus deleteEvent(KAEvent& event, bool archive, QWidget* errmsgParent)
 {
 	QString id = event.id();
 	kdDebug(5950) << "KAlarm::deleteEvent(): " << id << endl;
@@ -298,14 +344,15 @@
 	// Update the window lists
 	AlarmListView::deleteEvent(id);
 
-	UpdateStatus ret = UPDATE_OK;
+	UpdateStatus status = UPDATE_OK;
+	AlarmCalendar* cal;
 
 	// Delete the event from the calendar file
 	if (KAEvent::uidStatus(id) == KAEvent::EXPIRED)
 	{
-		AlarmCalendar* cal = AlarmCalendar::expiredCalendarOpen();
-		if (cal)
-			cal->deleteEvent(id, true);   // save calendar after deleting
+		cal = AlarmCalendar::expiredCalendarOpen();
+		if (!cal)
+			status = UPDATE_FAILED;
 	}
 	else
 	{
@@ -315,33 +362,40 @@
 			// delete it. Note that an error could occur if the user
 			// manually deleted it from KOrganizer since it was set up.
 			if (!deleteFromKOrganizer(event.id()))
-				ret = UPDATE_KORG_ERR;
+				status = UPDATE_KORG_ERR;
 		}
 		if (archive  &&  event.toBeArchived())
 			addExpiredEvent(event);     // this changes the event ID to an expired ID
-		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(id, true);    // save calendar after deleting
+		cal = AlarmCalendar::activeCalendar();
 	}
-	return ret;
+	if (status != UPDATE_FAILED)
+	{
+		if (!cal->deleteEvent(id, true))   // save calendar after deleting
+			status = SAVE_FAILED;
+	}
+	if (status > UPDATE_KORG_ERR  &&  errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_DELETE, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete a template from the calendar file and from every template list view.
 */
-void deleteTemplate(const KAEvent& event)
+UpdateStatus deleteTemplate(const KAEvent& event)
 {
 	QString id = event.id();
 
 	// Delete the template from the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
-	{
-		cal->deleteEvent(id, true);    // save calendar after deleting
-		cal->emitEmptyStatus();
-	}
+	if (!cal)
+		return UPDATE_FAILED;
+	if (!cal->deleteEvent(id, true))    // save calendar after deleting
+		return SAVE_FAILED;
+	cal->emitEmptyStatus();
 
 	// Update the window lists
 	TemplateListView::deleteEvent(id);
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -382,14 +436,16 @@
 
 			// Save the event details in the calendar file, and get the new event ID
 			AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-			cal->addEvent(event, useEventID);
-			cal->save();
+			if (!cal->addEvent(event, useEventID))
+				return UPDATE_FAILED;
+			if (!cal->save())
+				return SAVE_FAILED;
 
-			UpdateStatus ret = UPDATE_OK;
+			UpdateStatus status = UPDATE_OK;
 			if (event.copyToKOrganizer())
 			{
 				if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-					ret = UPDATE_KORG_ERR;
+					status = UPDATE_KORG_ERR;
 			}
 
 			// Update the window lists
@@ -398,10 +454,10 @@
 			cal = AlarmCalendar::expiredCalendarOpen();
 			if (cal)
 				cal->deleteEvent(id, true);   // save calendar after deleting
-			return ret;
+			return status;
 		}
 	}
-	return UPDATE_ERROR;
+	return UPDATE_FAILED;
 }
 
 /******************************************************************************
@@ -410,7 +466,7 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
+UpdateStatus enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
 {
 	kdDebug(5950) << "KAlarm::enableEvent(" << enable << "): " << event.id() << endl;
 
@@ -421,7 +477,8 @@
 		// Update the event in the calendar file
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			return SAVE_FAILED;
 
 		// If we're disabling a display alarm, close any message window
 		if (!enable  &&  event.displayAction())
@@ -433,12 +490,40 @@
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
+* Display an error message about an error saving an event.
+*/
+void displayUpdateError(QWidget* parent, UpdateStatus, UpdateError code, int nAlarms)
+{
+	QString errmsg;
+	switch (code)
+	{
+		case ERR_ADD:
+			errmsg = (nAlarms > 1) ? i18n("Error saving alarms")
+			                       : i18n("Error saving alarm");
+			break;
+		case ERR_DELETE:
+			errmsg = (nAlarms > 1) ? i18n("Error deleting alarms")
+			                       : i18n("Error deleting alarm");
+			break;
+		case ERR_REACTIVATE:
+			errmsg = (nAlarms > 1) ? i18n("Error saving reactivated alarms")
+			                       : i18n("Error saving reactivated alarm");
+			break;
+		case ERR_TEMPLATE:
+			errmsg = i18n("Error saving alarm template");
+			break;
+	}
+	KMessageBox::error(parent, errmsg);
+}
+
+/******************************************************************************
 * Display an error message corresponding to a specified alarm update error code.
 */
-void displayKOrgUpdateError(QWidget* parent, UpdateError code, int nAlarms)
+void displayKOrgUpdateError(QWidget* parent, KOrgUpdateError code, int nAlarms)
 {
 	QString errmsg;
 	switch (code)
Index: kalarm/karecurrence.cpp
===================================================================
--- kalarm/karecurrence.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/karecurrence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  karecurrence.cpp  -  recurrence with special yearly February 29th handling
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -31,7 +31,23 @@
 
 using namespace KCal;
 
+/*=============================================================================
+= Class KARecurrence
+= The purpose of this class is to represent the restricted range of recurrence
+= types which are handled by KAlarm, and to translate between these and the
+= libkcal Recurrence class. In particular, it handles yearly recurrences on
+= 29th February specially:
+=
+= KARecurrence allows annual 29th February recurrences to fall on 28th
+= February or 1st March, or not at all, in non-leap years. It allows such
+= 29th February recurrences to be combined with the 29th of other months in
+= a simple way, represented simply as the 29th of multiple months including
+= February. For storage in the libkcal calendar, the 29th day of the month
+= recurrence for other months is combined with a last-day-of-February or a
+= 60th-day-of-the-year recurrence rule, thereby conforming to RFC2445.
+=============================================================================*/
 
+
 KARecurrence::Feb29Type KARecurrence::mDefaultFeb29 = KARecurrence::FEB29_FEB29;
 
 
@@ -125,11 +141,13 @@
 		if (!QDate::leapYear(year)
 		&&  startdt.date().dayOfYear() == (feb29Type == FEB29_MAR1 ? 60 : 59))
 		{
-			// The event start date is February 28th or March 1st, but it
-			// is a recurrence on February 29th (recurring on February 28th
-			// or March 1st in non-leap years). Adjust the start date to
-			// be on February 29th in the last previous leap year.
-//#warning Is this necessary now?
+			/* The event start date is February 28th or March 1st, but it
+			 * is a recurrence on February 29th (recurring on February 28th
+			 * or March 1st in non-leap years). Adjust the start date to
+			 * be on February 29th in the last previous leap year.
+			 * This is necessary because KARecurrence represents all types
+			 * of 29th February recurrences by a simple 29th February.
+			 */
 			while (!QDate::leapYear(--year)) ;
 			startdt.setDate(QDate(year, 2, 29));
 		}
@@ -333,6 +351,44 @@
 }
 
 /******************************************************************************
+* Get the next time the recurrence occurs, strictly after a specified time.
+*/
+QDateTime KARecurrence::getNextDateTime(const QDateTime& preDateTime) const
+{
+	switch (type())
+	{
+		case ANNUAL_DATE:
+		case ANNUAL_POS:
+		{
+			Recurrence recur;
+			writeRecurrence(recur);
+			return recur.getNextDateTime(preDateTime);
+		}
+		default:
+			return Recurrence::getNextDateTime(preDateTime);
+	}
+}
+
+/******************************************************************************
+* Get the previous time the recurrence occurred, strictly before a specified time.
+*/
+QDateTime KARecurrence::getPreviousDateTime(const QDateTime& afterDateTime) const
+{
+	switch (type())
+	{
+		case ANNUAL_DATE:
+		case ANNUAL_POS:
+		{
+			Recurrence recur;
+			writeRecurrence(recur);
+			return recur.getPreviousDateTime(afterDateTime);
+		}
+		default:
+			return Recurrence::getPreviousDateTime(afterDateTime);
+	}
+}
+
+/******************************************************************************
 * Initialise a KCal::Recurrence to be the same as this instance.
 * Additional recurrence rules are created as necessary if it recurs on Feb 29th.
 */
@@ -613,7 +669,7 @@
 	// Get the date of the next occurrence after the end of the earlier ending rule
 	RecurrenceRule rr(*rr1);
 	rr.setDuration(-1);
-	QDateTime next1 = rr.getNextDate(end1).date();
+	QDateTime next1(rr.getNextDate(end1).date());
 	if (!next1.isValid())
 		end = end1.date();
 	else
Index: kalarm/kalarm.tray.desktop
===================================================================
--- kalarm/kalarm.tray.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/kalarm.tray.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,9 +32,10 @@
 Comment[es]=Programador de alarma personal: comenzar como icono de la bandeja del sistema
 Comment[et]=Häirete ja meeldetuletuste ajakava: käivitamine süsteemse doki ikoonina
 Comment[eu]=Alarma pertsonalen programatzailea: abiatu sistemaren bandejako ikono bezala
-Comment[fa]=زمان‌بند هشدار شخصی: آغاز به عنوان شمایل سینی سیستم‌
+Comment[fa]=زمان‌بند هشدار شخصی: آغاز به عنوان شمایل سینی سیستم
 Comment[fi]=Henkilökohtainen hälytysajastin: käynnistä paneelikuvake
 Comment[fr]=Planificateur d'alarme personnel : démarre dans la boîte à miniatures
+Comment[gl]=Programador persoal de alarmas: iniciar como icona na bandexa do sistema
 Comment[he]=מתזמן הודעות תזכורת: הפעלה בתור סמל במגש המערכת
 Comment[hi]=निजी अलार्म शेड्यूलरः तंत्र तश्तरी प्रतीक की तरह प्रारंभ हों
 Comment[hu]=Az emlékeztető üzenetek megjelenítőprogramja: indítás a paneltálcában
Index: kalarm/find.h
===================================================================
--- kalarm/find.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/find.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  find.h  -  search facility 
  *  Program:  kalarm
- *  Copyright (C) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -37,7 +37,7 @@
 {
 		Q_OBJECT
 	public:
-		Find(EventListViewBase* parent);
+		explicit Find(EventListViewBase* parent);
 		~Find();
 		void         display();
 		void         findNext(bool forward)     { findNext(forward, true); }
Index: kalarm/alarmcalendar.cpp
===================================================================
--- kalarm/alarmcalendar.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/alarmcalendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -578,26 +578,30 @@
 * Flag the end of a group of calendar update calls.
 * The calendar is saved if appropriate.
 */
-void AlarmCalendar::endUpdate()
+bool AlarmCalendar::endUpdate()
 {
 	if (mUpdateCount > 0)
 		--mUpdateCount;
 	if (!mUpdateCount)
 	{
 		if (mUpdateSave)
-			saveCal();
+			return saveCal();
 	}
+	return true;
 }
 
 /******************************************************************************
 * Save the calendar, or flag it for saving if in a group of calendar update calls.
 */
-void AlarmCalendar::save()
+bool AlarmCalendar::save()
 {
 	if (mUpdateCount)
+	{
 		mUpdateSave = true;
+		return true;
+	}
 	else
-		saveCal();
+		return saveCal();
 }
 
 #if 0
@@ -780,7 +784,7 @@
 * Delete the specified event from the calendar, if it exists.
 * The calendar is then optionally saved.
 */
-void AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
+bool AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
 {
 	if (mOpen)
 	{
@@ -791,12 +795,13 @@
 			if (mType == KAEvent::ACTIVE)
 				Daemon::savingEvent(eventID);
 			if (saveit)
-				save();
-			return;
+				return save();
+			return true;
 		}
 	}
 	if (mType == KAEvent::ACTIVE)
 		Daemon::eventHandled(eventID, false);
+	return false;
 }
 
 /******************************************************************************
Index: kalarm/soundpicker.cpp
===================================================================
--- kalarm/soundpicker.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/soundpicker.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.cpp  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -18,13 +18,13 @@
  *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-#include <config.h>
 #include "kalarm.h"
 
 #include <qlayout.h>
 #include <qregexp.h>
 #include <qtooltip.h>
 #include <qtimer.h>
+#include <qlabel.h>
 #include <qhbox.h>
 #include <qwhatsthis.h>
 
@@ -38,12 +38,10 @@
 #endif
 #include <kdebug.h>
 
-#include "buttongroup.h"
-#include "checkbox.h"
+#include "combobox.h"
 #include "functions.h"
 #include "kalarmapp.h"
 #include "pushbutton.h"
-#include "radiobutton.h"
 #include "sounddlg.h"
 #include "soundpicker.moc"
 
@@ -51,75 +49,46 @@
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
 QString SoundPicker::i18n_Sound()       { return i18n("An audio sound", "Sound"); }
-QString SoundPicker::i18n_s_Sound()     { return i18n("An audio sound", "&Sound"); }
+QString SoundPicker::i18n_None()        { return i18n("None"); }
 QString SoundPicker::i18n_Beep()        { return i18n("Beep"); }
-QString SoundPicker::i18n_b_Beep()      { return i18n("&Beep"); }
 QString SoundPicker::i18n_Speak()       { return i18n("Speak"); }
-QString SoundPicker::i18n_p_Speak()     { return i18n("S&peak"); }
-QString SoundPicker::i18n_File()        { return i18n("File"); }
+QString SoundPicker::i18n_File()        { return i18n("Sound file"); }
 
 
 SoundPicker::SoundPicker(QWidget* parent, const char* name)
-	: QFrame(parent, name),
-	  mRevertType(false)
+	: QFrame(parent, name)
 {
-	// Sound checkbox
 	setFrameStyle(QFrame::NoFrame);
-	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, 2*KDialog::spacingHint());
-	soundLayout->setAlignment(Qt::AlignVCenter);
-	mCheckbox = new CheckBox(i18n_s_Sound(), this);
-	mCheckbox->setFixedSize(mCheckbox->sizeHint());
-	connect(mCheckbox, SIGNAL(toggled(bool)), SLOT(slotSoundToggled(bool)));
-	QWhatsThis::add(mCheckbox,
-	      i18n("Check to enable sound when the message is displayed. Select the type of sound from the displayed options."));
-	soundLayout->addWidget(mCheckbox);
+	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, KDialog::spacingHint());
+	mTypeBox = new QHBox(this);    // this is to control the QWhatsThis text display area
+	mTypeBox->setSpacing(KDialog::spacingHint());
 
-	// Sound type
-	mTypeGroup = new ButtonGroup(this);
-	mTypeGroup->hide();
-	connect(mTypeGroup, SIGNAL(buttonSet(int)), SLOT(slotTypeChanged(int)));
+	QLabel* label = new QLabel(i18n("An audio sound", "&Sound:"), mTypeBox);
+	label->setFixedSize(label->sizeHint());
 
-	// Beep radio button
-	mBeepRadio = new RadioButton(i18n_Beep(), this, "beepButton");
-	mBeepRadio->setFixedSize(mBeepRadio->sizeHint());
-	QWhatsThis::add(mBeepRadio, i18n("If checked, a beep will sound when the alarm is displayed."));
-	mTypeGroup->insert(mBeepRadio, BEEP);
-	soundLayout->addWidget(mBeepRadio);
+	// Sound type combo box
+	// The order of combo box entries must correspond with the 'Type' enum.
+	mTypeCombo = new ComboBox(false, mTypeBox);
+	mTypeCombo->insertItem(i18n_None());     // index NONE
+	mTypeCombo->insertItem(i18n_Beep());     // index BEEP
+	mTypeCombo->insertItem(i18n_File());     // index PLAY_FILE
+	mSpeakShowing = !theApp()->speechEnabled();
+	showSpeak(!mSpeakShowing);               // index SPEAK (only displayed if appropriate)
+	connect(mTypeCombo, SIGNAL(activated(int)), SLOT(slotTypeSelected(int)));
+	label->setBuddy(mTypeCombo);
+	soundLayout->addWidget(mTypeBox);
 
-	// File radio button
-	QHBox* box = new QHBox(this);
-	mFileRadio = new RadioButton(i18n_File(), box, "audioFileButton");
-	mFileRadio->setFixedSize(mFileRadio->sizeHint());
-	QWhatsThis::add(mFileRadio, i18n("If checked, a sound file will be played when the alarm is displayed."));
-	mTypeGroup->insert(mFileRadio, PLAY_FILE);
-
 	// Sound file picker button
-	mFilePicker = new PushButton(box);
+	mFilePicker = new PushButton(this);
 	mFilePicker->setPixmap(SmallIcon("playsound"));
 	mFilePicker->setFixedSize(mFilePicker->sizeHint());
 	connect(mFilePicker, SIGNAL(clicked()), SLOT(slotPickFile()));
 	QWhatsThis::add(mFilePicker, i18n("Configure a sound file to play when the alarm is displayed."));
-	box->setFixedSize(box->sizeHint());
-	soundLayout->addWidget(box);
-	box->setFocusProxy(mFileRadio);
+	soundLayout->addWidget(mFilePicker);
 
-	// Speak radio button
-	mSpeakRadio = new RadioButton(i18n_p_Speak(), this, "speakButton");
-	mSpeakRadio->setFixedSize(mSpeakRadio->sizeHint());
-	QWhatsThis::add(mSpeakRadio, i18n("If checked, the message will be spoken when the alarm is displayed."));
-	mTypeGroup->insert(mSpeakRadio, SPEAK);
-	soundLayout->addWidget(mSpeakRadio);
-
-	if (!theApp()->speechEnabled())
-		mSpeakRadio->hide();     // speech capability is not installed
-
-	setTabOrder(mCheckbox, mBeepRadio);
-	setTabOrder(mBeepRadio, mFileRadio);
-	setTabOrder(mFileRadio, mFilePicker);
-	setTabOrder(mFilePicker, mSpeakRadio);
-
 	// Initialise the file picker button state and tooltip
-	slotSoundToggled(false);
+	mTypeCombo->setCurrentItem(NONE);
+	mFilePicker->setEnabled(false);
 }
 
 /******************************************************************************
@@ -127,13 +96,10 @@
 */
 void SoundPicker::setReadOnly(bool readOnly)
 {
-	mCheckbox->setReadOnly(readOnly);
-	mBeepRadio->setReadOnly(readOnly);
-	mFileRadio->setReadOnly(readOnly);
+	mTypeCombo->setReadOnly(readOnly);
 #ifdef WITHOUT_ARTS
 	mFilePicker->setReadOnly(readOnly);
 #endif
-	mSpeakRadio->setReadOnly(readOnly);
 	mReadOnly = readOnly;
 }
 
@@ -143,58 +109,41 @@
 void SoundPicker::showSpeak(bool show)
 {
 	if (!theApp()->speechEnabled())
-		return;     // speech capability is not installed
-
-	bool shown = !mSpeakRadio->isHidden();
-	if (show  &&  !shown)
-		mSpeakRadio->show();
-	else if (!show  &&  shown)
+		show = false;    // speech capability is not installed
+	if (show == mSpeakShowing)
+		return;    // no change
+	QString whatsThis = "<p>" + i18n("Choose a sound to play when the message is displayed.")
+	                  + "<br>" + i18n("%1: the message is displayed silently.").arg("<b>" + i18n_None() + "</b>")
+	                  + "<br>" + i18n("%1: a simple beep is sounded.").arg("<b>" + i18n_Beep() + "</b>")
+	                  + "<br>" + i18n("%1: an audio file is played. You will be prompted to choose the file and set play options.").arg("<b>" + i18n_File() + "</b>");
+	if (!show  &&  mTypeCombo->currentItem() == SPEAK)
+		mTypeCombo->setCurrentItem(NONE);
+	if (mTypeCombo->count() == SPEAK+1)
+		mTypeCombo->removeItem(SPEAK);    // precaution in case of mix-ups
+	if (show)
 	{
-		if (mSpeakRadio->isOn())
-			mCheckbox->setChecked(false);
-		mSpeakRadio->hide();
+		mTypeCombo->insertItem(i18n_Speak());
+		whatsThis += "<br>" + i18n("%1: the message text is spoken.").arg("<b>" + i18n_Speak() + "</b>") + "</p>";
 	}
+	QWhatsThis::add(mTypeBox, whatsThis + "</p>");
+	mSpeakShowing = show;
 }
 
 /******************************************************************************
-* Return whether sound is selected.
-*/
-bool SoundPicker::sound() const
-{
-	return mCheckbox->isChecked();
-}
-
-/******************************************************************************
 * Return the currently selected option.
 */
-SoundPicker::Type SoundPicker::type() const
+SoundPicker::Type SoundPicker::sound() const
 {
-	return static_cast<SoundPicker::Type>(mTypeGroup->selectedId());
+	return static_cast<SoundPicker::Type>(mTypeCombo->currentItem());
 }
 
 /******************************************************************************
-* Return whether beep is selected.
+* Return the selected sound file, if the File option is selected.
+* Returns null string if File is not currently selected.
 */
-bool SoundPicker::beep() const
-{
-	return mCheckbox->isChecked()  &&  mBeepRadio->isOn();
-}
-
-/******************************************************************************
-* Return whether speech is selected.
-*/
-bool SoundPicker::speak() const
-{
-	return mCheckbox->isChecked()  &&  !mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn();
-}
-
-/******************************************************************************
-* Return the selected sound file, if the main checkbox is checked.
-* Returns null string if beep is currently selected.
-*/
 QString SoundPicker::file() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() ? mFile : QString::null;
+	return (mTypeCombo->currentItem() == PLAY_FILE) ? mFile : QString::null;
 }
 
 /******************************************************************************
@@ -203,7 +152,7 @@
 */
 float SoundPicker::volume(float& fadeVolume, int& fadeSeconds) const
 {
-	if (mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty())
+	if (mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty())
 	{
 		fadeVolume  = mFadeVolume;
 		fadeSeconds = mFadeSeconds;
@@ -223,49 +172,34 @@
 */
 bool SoundPicker::repeat() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty() && mRepeat;
+	return mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty()  &&  mRepeat;
 }
 
 /******************************************************************************
 * Initialise the widget's state.
 */
-void SoundPicker::set(bool sound, SoundPicker::Type defaultType, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
+void SoundPicker::set(SoundPicker::Type type, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
 {
-	if (defaultType == PLAY_FILE  &&  f.isEmpty())
-		defaultType = BEEP;
-	mLastType    = static_cast<Type>(0);
+	if (type == PLAY_FILE  &&  f.isEmpty())
+		type = BEEP;
 	mFile        = f;
 	mVolume      = volume;
 	mFadeVolume  = fadeVolume;
 	mFadeSeconds = fadeSeconds;
 	mRepeat      = repeat;
 	QToolTip::add(mFilePicker, mFile);
-	mCheckbox->setChecked(sound);
-	mTypeGroup->setButton(defaultType);
+	mTypeCombo->setCurrentItem(type);  // this doesn't trigger slotTypeSelected()
+	mFilePicker->setEnabled(type == PLAY_FILE);
+	mLastType = type;
 }
 
 /******************************************************************************
-* Called when the sound checkbox is toggled.
-*/
-void SoundPicker::slotSoundToggled(bool on)
-{
-	mBeepRadio->setEnabled(on);
-	mSpeakRadio->setEnabled(on);
-	mFileRadio->setEnabled(on);
-	mFilePicker->setEnabled(on && mFileRadio->isOn());
-	if (on  &&  mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn())
-		mBeepRadio->setChecked(true);
-	if (on)
-		mBeepRadio->setFocus();
-}
-
-/******************************************************************************
 * Called when the sound option is changed.
 */
-void SoundPicker::slotTypeChanged(int id)
+void SoundPicker::slotTypeSelected(int id)
 {
 	Type newType = static_cast<Type>(id);
-	if (newType == mLastType  ||  mRevertType)
+	if (newType == mLastType)
 		return;
 	if (mLastType == PLAY_FILE)
 		mFilePicker->setEnabled(false);
@@ -277,7 +211,7 @@
 			if (mFile.isEmpty())
 				return;    // revert to previously selected type
 		}
-		mFilePicker->setEnabled(mCheckbox->isChecked());
+		mFilePicker->setEnabled(true);
 	}
 	mLastType = newType;
 }
@@ -317,23 +251,12 @@
 	QToolTip::add(mFilePicker, mFile);
 	if (mFile.isEmpty())
 	{
-		// No audio file is selected, so revert to 'beep'.
-		// But wait a moment until setting the radio button, or it won't work.
-		mRevertType = true;   // prevent sound dialogue popping up twice
-		QTimer::singleShot(0, this, SLOT(setLastType()));
+		// No audio file is selected, so revert to previously selected option
+		mTypeCombo->setCurrentItem(mLastType);
 	}
 }
 
 /******************************************************************************
-* Select the previously selected sound type.
-*/
-void SoundPicker::setLastType()
-{
-	mTypeGroup->setButton(mLastType);
-	mRevertType = false;
-}
-
-/******************************************************************************
 * Display a dialogue to choose a sound file, initially highlighting any
 * specified file. 'initialFile' must be a full path name or URL.
 * 'defaultDir' is updated to the directory containing the chosen file.
@@ -351,7 +274,8 @@
 #ifdef WITHOUT_ARTS
 	QString filter = QString::fromLatin1("*.wav *.mp3 *.ogg|%1\n*|%2").arg(i18n("Sound Files")).arg(i18n("All Files"));
 #else
-	QString filter = KDE::PlayObjectFactory::mimeTypes().join(" ");
+	QStringList filters = KDE::PlayObjectFactory::mimeTypes();
+	QString filter = filters.join(" ");
 #endif
 	return KAlarm::browseFile(i18n("Choose Sound File"), defaultDir, initialFile, filter, KFile::ExistingOnly, 0, "pickSoundFile");
 }
Index: kalarm/birthdaydlg.cpp
===================================================================
--- kalarm/birthdaydlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kalarm/birthdaydlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
  *  birthdaydlg.cpp  -  dialog to pick birthdays from address book
  *  Program:  kalarm
- *  Copyright (c) 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -71,7 +71,7 @@
 
 
 BirthdayDlg::BirthdayDlg(QWidget* parent)
-	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent),
+	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent, "BirthdayDlg"),
 	  mSpecialActionsButton(0)
 {
 	QWidget* topWidget = plainPage();
@@ -194,7 +194,7 @@
 	mBgColourChoose->setColour(Preferences::defaultBgColour());     // set colour before setting alarm type buttons
 	mLateCancel->setMinutes(Preferences::defaultLateCancel(), true, TimePeriod::DAYS);
 	mConfirmAck->setChecked(Preferences::defaultConfirmAck());
-	mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+	mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 	                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 	if (mSpecialActionsButton)
 		mSpecialActionsButton->setActions(Preferences::defaultPreAction(), Preferences::defaultPostAction());
@@ -352,11 +352,11 @@
 	config->writeEntry(QString::fromLatin1("BirthdaySuffix"), mSuffix->text());
 	config->sync();
 
-	mFlags = (mSoundPicker->beep()             ? KAEvent::BEEP : 0)
-	       | (mSoundPicker->repeat()           ? KAEvent::REPEAT_SOUND : 0)
-	       | (mConfirmAck->isChecked()         ? KAEvent::CONFIRM_ACK : 0)
-	       | (mFontColourButton->defaultFont() ? KAEvent::DEFAULT_FONT : 0)
-	       |                                     KAEvent::ANY_TIME;
+	mFlags = (mSoundPicker->sound() == SoundPicker::BEEP ? KAEvent::BEEP : 0)
+	       | (mSoundPicker->repeat()                     ? KAEvent::REPEAT_SOUND : 0)
+	       | (mConfirmAck->isChecked()                   ? KAEvent::CONFIRM_ACK : 0)
+	       | (mFontColourButton->defaultFont()           ? KAEvent::DEFAULT_FONT : 0)
+	       |                                               KAEvent::ANY_TIME;
 	KDialogBase::slotOk();
 }
 
Index: libemailfunctions/tests/testemail.cpp
===================================================================
--- libemailfunctions/tests/testemail.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libemailfunctions/tests/testemail.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -323,7 +323,7 @@
   // escape a quote to many to see if it makes it invalid
   checkIsValidEmailAddress( "\"testing, \\\"testing\\\" <matt@fruitsalad.org>", "UnbalancedQuote" );
 
-  // escape a parens and thus make a comma appear 
+  // escape a parens and thus make a comma appear
   checkIsValidEmailAddress( "Matt (jongel, fibbel\\\) <matt@fruitsalad.org>", "UnbalancedParens" );
 
   // several errors inside doublequotes
@@ -365,11 +365,12 @@
   checkIsValidEmailAddress( "|matt@fruitsalad.org", "AddressOk" );
   checkIsValidEmailAddress( "}matt@fruitsalad.org", "AddressOk" );
   checkIsValidEmailAddress( "~matt@fruitsalad.org", "AddressOk" );
+  checkIsValidEmailAddress( "matt%matt@fruitsalad.org", "AddressOk" );
 
   //bug 105405
   checkIsValidEmailAddress( "[foobar] <matt@fruitsalad.org>", "InvalidDisplayName" );
   checkIsValidEmailAddress( "matt \"[foobar]\" Douhan <matt@fruitsalad.org>", "AddressOk" );
- 
+
   checkIsValidEmailAddress( "Matt Douhan <matt\"@@\"fruitsalad.org>", "TooFewAts" );
 
 
Index: korn/KOrn.desktop
===================================================================
--- korn/KOrn.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korn/KOrn.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,7 +14,7 @@
 GenericName[es]=Aviso de correo
 GenericName[et]=E-kirjade teadustaja
 GenericName[eu]=Mail abisua
-GenericName[fa]=هشدار نامه
+GenericName[fa]=هشدارنامه
 GenericName[fi]=Saapuneen sähköpostin ilmoitus
 GenericName[fr]=Surveillance du courrier électronique
 GenericName[ga]=Fógairt Ríomhphoist
Index: libkpimidentities/identity.h
===================================================================
--- libkpimidentities/identity.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkpimidentities/identity.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -138,7 +138,7 @@
       KConfigGroup). Called from IdentityManager. */
   void readConfig( const KConfigBase * );
 
-  /** Write configuration to config. Group must be preset (or use 
+  /** Write configuration to config. Group must be preset (or use
       KConfigGroup). Called from IdentityManager. */
   void writeConfig( KConfigBase * ) const;
 
@@ -269,6 +269,11 @@
   QString drafts() const { return mDrafts; }
   void setDrafts(const QString&);
 
+  /** The folder where template messages from this identity will be
+      stored by default. */
+  QString templates() const { return mTemplates; }
+  void setTemplates( const QString& );
+
   /** dictionary which should be used for spell checking */
   QString dictionary() const { return mDictionary; }
   void setDictionary( const QString& );
@@ -292,7 +297,7 @@
   QString mBcc;
   QString mVCardFile;
   QCString mPGPEncryptionKey, mPGPSigningKey, mSMIMEEncryptionKey, mSMIMESigningKey;
-  QString mFcc, mDrafts, mTransport;
+  QString mFcc, mDrafts, mTemplates, mTransport;
   QString mDictionary;
   QString mXFace;
   bool mXFaceEnabled;
Index: libkpimidentities/identity.cpp
===================================================================
--- libkpimidentities/identity.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkpimidentities/identity.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -238,7 +238,7 @@
   return mIdentity.isEmpty() && mFullName.isEmpty() && mEmailAddr.isEmpty() &&
     mOrganization.isEmpty() && mReplyToAddr.isEmpty() && mBcc.isEmpty() &&
     mVCardFile.isEmpty() &&
-    mFcc.isEmpty() && mDrafts.isEmpty() &&
+    mFcc.isEmpty() && mDrafts.isEmpty() && mTemplates.isEmpty() &&
     mPGPEncryptionKey.isEmpty() && mPGPSigningKey.isEmpty() &&
     mSMIMEEncryptionKey.isEmpty() && mSMIMESigningKey.isEmpty() &&
     mTransport.isEmpty() && mDictionary.isEmpty() &&
@@ -259,7 +259,8 @@
       mSMIMEEncryptionKey == other.mSMIMEEncryptionKey &&
       mSMIMESigningKey == other.mSMIMESigningKey &&
       mPreferredCryptoMessageFormat == other.mPreferredCryptoMessageFormat &&
-      mDrafts == other.mDrafts && mTransport == other.mTransport &&
+      mDrafts == other.mDrafts && mTemplates == other.mTemplates &&
+      mTransport == other.mTransport &&
       mDictionary == other.mDictionary && mSignature == other.mSignature &&
       mXFace == other.mXFace && mXFaceEnabled == other.mXFaceEnabled;
 
@@ -281,6 +282,7 @@
   if ( mSMIMESigningKey != other.mSMIMESigningKey ) kdDebug() << "mSMIMESigningKey differs : " << mSMIMESigningKey << " != " << other.mSMIMESigningKey << endl;
   if ( mPreferredCryptoMessageFormat != other.mPreferredCryptoMessageFormat ) kdDebug() << "mPreferredCryptoMessageFormat differs : " << mPreferredCryptoMessageFormat << " != " << other.mPreferredCryptoMessageFormat << endl;
   if ( mDrafts != other.mDrafts ) kdDebug() << "mDrafts differs : " << mDrafts << " != " << other.mDrafts << endl;
+  if ( mTemplates != other.mTemplates ) kdDebug() << "mTemplates differs : " << mTemplates << " != " << other.mTemplates << endl;
   if ( mTransport != other.mTransport ) kdDebug() << "mTransport differs : " << mTransport << " != " << other.mTransport << endl;
   if ( mDictionary != other.mDictionary ) kdDebug() << "mDictionary differs : " << mDictionary << " != " << other.mDictionary << endl;
   if ( ! ( mSignature == other.mSignature ) ) kdDebug() << "mSignature differs" << endl;
@@ -297,7 +299,8 @@
     // Using "" instead of null to make operator==() not fail
     // (readConfig returns "")
     mBcc( "" ), mVCardFile( "" ), mPGPEncryptionKey( "" ), mPGPSigningKey( "" ),
-    mSMIMEEncryptionKey( "" ), mSMIMESigningKey( "" ), mFcc( "" ), mDrafts( "" ), mTransport( "" ),
+    mSMIMEEncryptionKey( "" ), mSMIMESigningKey( "" ), mFcc( "" ),
+    mDrafts( "" ), mTemplates( "" ), mTransport( "" ),
     mDictionary( "" ),
     mXFace( "" ), mXFaceEnabled( false ),
     mIsDefault( false ),
@@ -324,15 +327,18 @@
   mSMIMESigningKey = config->readEntry("SMIME Signing Key").latin1();
   mSMIMEEncryptionKey = config->readEntry("SMIME Encryption Key").latin1();
   mPreferredCryptoMessageFormat = Kleo::stringToCryptoMessageFormat( config->readEntry("Preferred Crypto Message Format", "none" ) );
-  mReplyToAddr = config->readEntry("Reply-To Address");
-  mBcc = config->readEntry("Bcc");
-  mFcc = config->readEntry("Fcc", "sent-mail");
+  mReplyToAddr = config->readEntry( "Reply-To Address" );
+  mBcc = config->readEntry( "Bcc" );
+  mFcc = config->readEntry( "Fcc", "sent-mail" );
   if( mFcc.isEmpty() )
     mFcc = "sent-mail";
-  mDrafts = config->readEntry("Drafts", "drafts");
+  mDrafts = config->readEntry( "Drafts", "drafts" );
   if( mDrafts.isEmpty() )
     mDrafts = "drafts";
-  mTransport = config->readEntry("Transport");
+  mTemplates = config->readEntry( "Templates", "templates" );
+  if( mTemplates.isEmpty() )
+    mTemplates = "templates";
+  mTransport = config->readEntry( "Transport" );
   mDictionary = config->readEntry( "Dictionary" );
   mXFace = config->readEntry( "X-Face" );
   mXFaceEnabled = config->readBoolEntry( "X-FaceEnabled", false );
@@ -362,6 +368,7 @@
   config->writeEntry("Transport", mTransport);
   config->writeEntry("Fcc", mFcc);
   config->writeEntry("Drafts", mDrafts);
+  config->writeEntry("Templates", mTemplates);
   config->writeEntry( "Dictionary", mDictionary );
   config->writeEntry( "X-Face", mXFace );
   config->writeEntry( "X-FaceEnabled", mXFaceEnabled );
@@ -385,6 +392,7 @@
 		<< i.transport()
 		<< i.fcc()
 		<< i.drafts()
+                << i.templates()
 		<< i.mSignature
                 << i.dictionary()
                 << i.xface()
@@ -409,6 +417,7 @@
 		>> i.mTransport
 		>> i.mFcc
 		>> i.mDrafts
+                >> i.mTemplates
 		>> i.mSignature
                 >> i.mDictionary
                 >> i.mXFace
@@ -541,7 +550,7 @@
 
 
 //-----------------------------------------------------------------------------
-void Identity::setTransport(const QString &str)
+void Identity::setTransport( const QString &str )
 {
   mTransport = str;
   if ( mTransport.isNull() )
@@ -549,7 +558,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void Identity::setFcc(const QString &str)
+void Identity::setFcc( const QString &str )
 {
   mFcc = str;
   if ( mFcc.isNull() )
@@ -557,13 +566,20 @@
 }
 
 //-----------------------------------------------------------------------------
-void Identity::setDrafts(const QString &str)
+void Identity::setDrafts( const QString &str )
 {
   mDrafts = str;
   if ( mDrafts.isNull() )
     mDrafts = "";
 }
 
+//-----------------------------------------------------------------------------
+void Identity::setTemplates( const QString &str )
+{
+  mTemplates = str;
+  if ( mTemplates.isNull() )
+    mTemplates = "";
+}
 
 //-----------------------------------------------------------------------------
 void Identity::setDictionary( const QString &str )
Index: kaddressbook/interfaces/kaddressbook_extension.desktop
===================================================================
--- kaddressbook/interfaces/kaddressbook_extension.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/interfaces/kaddressbook_extension.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Comment[fa]=وصلۀ پسوند KAddressBook
 Comment[fi]=KAddressbookin laajennusliitännäinen
 Comment[fr]=Module d'extension pour KAddressBook
+Comment[gl]=Engadido de Extensión para KAddressBook
 Comment[he]=תוסף הרחבה עבור פנקס הכתובות
 Comment[hi]=के-एड्रेस-बुक विस्तार प्लगइन
 Comment[hu]=KAddressBook kiegészítő modul
Index: kaddressbook/interfaces/kaddressbook_xxport.desktop
===================================================================
--- kaddressbook/interfaces/kaddressbook_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/interfaces/kaddressbook_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -19,6 +19,7 @@
 Comment[fa]=وصلۀ صادرات/واردات KAddressBook
 Comment[fi]=KAddressbookin tuonti/vienti-liitännäinen
 Comment[fr]=Module d'import / export pour KAddressBook
+Comment[gl]=Extensión de Importación/Exportación para KAddressBook
 Comment[he]=תוסף ייבוא/יצוא עבור פנקס הכתובות
 Comment[hi]=के-एड्रेस-बुक आयात/निर्यात प्लगइन
 Comment[hu]=KAddressBook importálási/exportálási bővítőmodul
Index: kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop
===================================================================
--- kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=وصلۀ عنصر ویرایشگر تماس KAddressBook
 Comment[fi]=Osoitekirjan yhteystietojen muokkainliitännäinen
 Comment[fr]=Module d'édition de contacts de KAddressBook
+Comment[gl]=Extensión Editor de Contactos para KAddressBook
 Comment[he]=תוסף תצוגה עבור עורך אנשי קשר של פנקס הכתובות
 Comment[hu]=KAddressBook névjegyszerkesztő bővítőmodul
 Comment[is]=KAddressbook tengiliðaritils íforrit
Index: kaddressbook/kaddressbook.desktop
===================================================================
--- kaddressbook/kaddressbook.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/kaddressbook.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,10 +28,11 @@
 GenericName[es]=Gestor de direcciones
 GenericName[et]=Aadressihaldur
 GenericName[eu]=Helbide kudeatzailea
-GenericName[fa]=مدیر نشانی‌
+GenericName[fa]=مدیر نشانی
 GenericName[fi]=Osoitteenhallinta
 GenericName[fr]=Gestionnaire d'adresses
 GenericName[ga]=Bainisteoir na Seoltaí
+GenericName[gl]=Xestor de Enderezos
 GenericName[he]=מנהל הכתובות
 GenericName[hu]=Címjegyzékkezelő
 GenericName[is]=Vistfangastjóri
Index: kaddressbook/views/cardview.desktop
===================================================================
--- kaddressbook/views/cardview.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/views/cardview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,7 +15,7 @@
 Name[es]=Vista de tarjeta
 Name[et]=Kaardivaade
 Name[eu]=Txartel ikuspegia
-Name[fa]=نمای کارت‌
+Name[fa]=نمای کارت
 Name[fi]=Korttinäkymä
 Name[fr]=Vue en cartes
 Name[gl]=Vista de tarxetas
Index: kaddressbook/xxport/kde2_xxport.desktop
===================================================================
--- kaddressbook/xxport/kde2_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/kde2_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Plugin KAB para {im,ex}portar KDE2
 Name[et]=KAB KDE2 importplugin
 Name[eu]=KAB-en KDE2 in/esportazio plugin-a
-Name[fa]=وصلۀ KAB KDE2 XXPort 
+Name[fa]=وصلۀ KAB KDE2 XXPort
 Name[fi]=KAB KDE2 -liitännäinen
 Name[fr]=Module d'import / export de KDE 2 pour KAB
+Name[gl]=Extensión XXPort de KDE2 para KAB
 Name[he]=תוסף ייבוא/ייצוא עבור KDE2 של KAB
 Name[hi]=केएबी केडीई2 XXपोर्ट प्लगइन
 Name[hu]=KAB KDE2 XXPort bővítőmodul
@@ -59,6 +60,7 @@
 Comment[fa]=وصله برای واردات کتاب نشانی قدیمی KDE ۲
 Comment[fi]=Liitännäinen vanhan KDE2-osoitekirjan tuontiin
 Comment[fr]=Module d'import du vieux carnet d'adresses de KDE 2
+Comment[gl]=Extensión para importar o vello caderno de enderezos de KDE 2
 Comment[hi]=पुराना केडीई 2 पता पुस्तिका को आयात के लिए प्लगइन
 Comment[hu]=Bővítőmodul KDE2-es címjegyzék importálásához
 Comment[is]=Íforrit til að færa inn gömlu KDE2 vistfangaskrána
Index: kaddressbook/xxport/csv_xxport.desktop
===================================================================
--- kaddressbook/xxport/csv_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/csv_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fa]=وصلۀ KAB CSV XXPort
 Name[fi]=KAB CSV -liitännäinen
 Name[fr]=Module d'import / export CSV pour KAB
+Name[gl]=Extensión XXPort de CSV para KAB
 Name[he]=תוסף ייבוא/ייצוא של קבצי CSV של KAB
 Name[hi]=केएबी सीएसवी XXपोर्ट प्लगइन
 Name[hu]=KAB XXPort bővítőmodul
@@ -58,6 +59,7 @@
 Comment[fa]=وصله برای واردات و صادرات تماسها در قالب CSV
 Comment[fi]=Liitännäinen kontaktien vientiin ja tuontiin CSV-muodossa
 Comment[fr]=Module d'import / export de contacts au format CSV
+Comment[gl]=Extensión para importar e exportar contactos e formato CSV
 Comment[hi]=सम्पर्कों को सीएसवी फार्मेट में निर्यात करने का प्लगइन
 Comment[hu]=Bővítőmodul névjegyek importálásához/exportálásához, CSV formátumban
 Comment[is]=Íforrit til að flytja tengiliði inn og út í CSV sniði
Index: kaddressbook/xxport/vcard_xxport.desktop
===================================================================
--- kaddressbook/xxport/vcard_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/vcard_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Plugin KAB para {im,ex}portar vCard
 Name[et]=KAB vCardi eksport/importplugin
 Name[eu]=KAB-en vCard in/esportazio plugin-a
-Name[fa]=وصلۀ KAB vCard XXPort 
+Name[fa]=وصلۀ KAB vCard XXPort
 Name[fi]=KAB vCard liitännäinen
 Name[fr]=Module d'import / export vCard pour KAB
+Name[gl]=Extensión XXPort de vCard para KAB
 Name[he]=תוסף ייבוא/ייצוא עבור vCard של KAB
 Name[hi]=केएबी वी-कार्डXXपोर्ट प्लगइन
 Name[hu]=KAB vCard XXPort bővítőmodul
Index: kaddressbook/xxport/pab_xxport.desktop
===================================================================
--- kaddressbook/xxport/pab_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/pab_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Name[fa]=وصلۀ XXPort  کتاب نشانی شخصی مبادلۀ KAB MS
 Name[fi]=KAB MS Exchangen henkilökohtaisen osoitekirjan liitännäinen
 Name[fr]=Module d'import / export de carnets d'adresses personnels de MS Exchange pour KAB
+Name[gl]=Extensión XXPort do Caderno de Enderezos de MS Exchange para KAB
 Name[hi]=केएबी एमएस एक्सचेंज निजी पता पुस्तिका XXपोर्ट प्लगइन
 Name[hu]=KAB XXPort bővítőmodul MS Exchange személyes címjegyzékekhez
 Name[is]=Íforrit fyrir KAB MS Exchange Personal Addressbook XXPort
@@ -58,6 +59,7 @@
 Comment[fa]=وصله برای واردات کتابهای نشانی شخصی مبادلۀ  MS
 Comment[fi]=Liitännäinen MS Exchangen henkilökohtaisten osoitekirjojen tuontiin
 Comment[fr]=Module d'import des carnets d'adresses personnels MS Exchange
+Comment[gl]=Extensión para importar Cadernos de Enderezos Persoais de MS Exchange
 Comment[hi]=एमएस एक्सचेंज निजी पता पुस्तिका को आयात करने का प्लगइन
 Comment[hu]=Bővítőmodul MS Exchange személyes címjegyzékek importálásához
 Comment[is]=Íforrit til að flytja tengiliði í eða úr MS Exchange Personal Address Book
Index: kaddressbook/xxport/opera_xxport.desktop
===================================================================
--- kaddressbook/xxport/opera_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/opera_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Plugin KAB para {im,ex}portar Opera
 Name[et]=KAB Opera importplugin
 Name[eu]=KAB-en Opera in/esportazio plugin-a
-Name[fa]=وصلۀ KAB Opera XXPort 
+Name[fa]=وصلۀ KAB Opera XXPort
 Name[fi]=KAB Opera -liitännäinen
 Name[fr]=Module d'import / export Opera pour KAB
+Name[gl]=Extensión XXPort para de Opera KAB
 Name[he]=תוסף ייבוא/ייצוא עבור Opera של KAB
 Name[hi]=केएबी ऑपेरा XXपोर्ट प्लगइन
 Name[hu]=KAB Opera XXPort bővítőmodul
@@ -56,9 +57,10 @@
 Comment[es]=Plugin para importar contactos de Opera
 Comment[et]=Plugin Opera kontaktide importimiseks
 Comment[eu]=Operaren kontaktuak inportatzeko plugin-a
-Comment[fa]=وصله برای واردات تماسهای Opera 
+Comment[fa]=وصله برای واردات تماسهای Opera
 Comment[fi]=Liitännäinen Operan kontaktien tuomiseen
 Comment[fr]=Module d'import de contacts Opera
+Comment[gl]=Extensión para importar contactos de Opera
 Comment[hi]=ऑपेरा सम्पर्कों को आयात करने का प्लगइन
 Comment[hu]=Bővítőmodul Opera névjegyek importálásához
 Comment[is]=Íforrit til flytja inn eða út Opera tengiliði
Index: kaddressbook/xxport/gnokii_xxport.desktop
===================================================================
--- kaddressbook/xxport/gnokii_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/gnokii_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fa]=وصلۀ XXPort تلفن همراه KAB
 Name[fi]=KAB-matkapuhelinliitännäinen
 Name[fr]=Module d'import / export de téléphone portable pour KAB
+Name[gl]=Extensión XXPort de Teléfono Móbil para KAB
 Name[he]=תוסף ייבוא/ייצוא עבור טלפונים ניידים של KAB
 Name[hi]=केएबी मोबाइल फोन XXपोर्ट प्लगइन
 Name[hu]=KAB mobiltelefon XXPort bővítőmodul
@@ -55,9 +56,10 @@
 Comment[es]=Plugin para importar y exportar números de móviles de las entradas de la libreta de direcciones
 Comment[et]=Mobiiltelefoni plugin aadressiraamatu kirjete importimiseks ja eksportimiseks
 Comment[eu]=Helbide-liburuko sarrerak in/esportatzeko mugikorren plugin-a
-Comment[fa]=وصلۀ تلفن همراه جهت واردات و صادرات مدخلهای کتاب نشانی‌
+Comment[fa]=وصلۀ تلفن همراه جهت واردات و صادرات مدخلهای کتاب نشانی
 Comment[fi]=Matkapuhelinliitännäinen osoitekirjan kontaktien tuontiin ja vientiin.
 Comment[fr]=Module de téléphone portable pour importer et exporter des entrées du carnet d'adresses
+Comment[gl]=Extensión de Teléfono Móbil para importar e exportar entradas do caderno de enderezos
 Comment[hi]=पता पुस्तिका प्रविष्टियों को आयात और निर्यात करने का मोबाइल फोन प्लगइन
 Comment[hu]=Mobiltelefonos bővítőmodul címbejegyzések importálásához/exportálásához
 Comment[is]=Íforrit til að færa tengilið milli póstfangaskrár og farsíma
Index: kaddressbook/xxport/bookmark_xxport.desktop
===================================================================
--- kaddressbook/xxport/bookmark_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/bookmark_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fa]=وصلۀ XXPort چوب الف KAB
 Name[fi]=KAB-kirjanmerkkiliitännäinen
 Name[fr]=Module d'import / export de signets pour KAB
+Name[gl]=Extensión XXPort de Marcadores para KAB
 Name[hi]=केएबी  पसंदीदा  XXपोर्ट प्लगइन
 Name[hu]=KAB könyvjelzőkezelő XXPort bővítőmodul
 Name[is]=Íforrit fyrir KAB XXPort bókarmerki
@@ -58,6 +59,7 @@
 Comment[fa]=وصله برای صادرات نشانیهای وب تماسها به عنوان چوب الفها
 Comment[fi]=Liitännäinen, joka muuntaa kontaktien sisältämät verkko-osoitteet kirjanmerkeiksi
 Comment[fr]=Module d'export des adresses internet des contacts en signets
+Comment[gl]=Extensión para exportar os enderezos web dos contactos como marcadores
 Comment[hi]=सम्पर्कों के वेब पते को  पसंदीदा  के रूप में निर्यात करने का प्लगइन
 Comment[hu]=Bővítőmodul webcímek exportáláshoz, könyvjelzőként
 Comment[is]=Íforrit til að skrá vefföng tengiliða sem bókarmerki
Index: kaddressbook/xxport/samples/rfc2849.ldif
===================================================================
--- kaddressbook/xxport/samples/rfc2849.ldif	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/samples/rfc2849.ldif	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,148 +0,0 @@
-i# Examples of LDAP Data Interchange Format
-
-# Example 1: An simple LDAP file with two entries
-
-version: 1
-dn: cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Barbara Jensen
-cn: Barbara J Jensen
-cn: Babs Jensen
-sn: Jensen
-uid: bjensen
-telephonenumber: +1 408 555 1212
-description: A big sailing fan.
-
-dn: cn=Bjorn Jensen, ou=Accounting, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Bjorn Jensen
-sn: Jensen
-telephonenumber: +1 408 555 1212
-
-Example 2: A file containing an entry with a folded attribute value
-
-version: 1
-dn:cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass:top
-objectclass:person
-objectclass:organizationalPerson
-cn:Barbara Jensen
-cn:Barbara J Jensen
-cn:Babs Jensen
-sn:Jensen
-uid:bjensen
-telephonenumber:+1 408 555 1212
-description:Babs is a big sailing fan, and travels extensively in sea
- rch of perfect sailing conditions.
-title:Product Manager, Rod and Reel Division
-
-Example 3: A file containing a base-64-encoded value
-
-version: 1
-dn: cn=Gern Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Gern Jensen
-cn: Gern O Jensen
-sn: Jensen
-uid: gernj
-telephonenumber: +1 408 555 1212
-description:: V2hhdCBhIGNhcmVmdWwgcmVhZGVyIHlvdSBhcmUhICBUaGlzIHZhbHVl
-IGlzIGJhc2UtNjQtZW5jb2RlZCBiZWNhdXNlIGl0IGhhcyBhIGNvbnRyb2wgY2hhcmFjdG
-VyIGluIGl0IChhIENSKS4NICBCeSB0aGUgd2F5LCB5b3Ugc2hvdWxkIHJlYWxseSBnZXQg
-b3V0IG1vcmUu
-
-Example 4: A file containing an entries with UTF-8-encoded attribute
-values, including language tags.  Comments indicate the contents
-of UTF-8-encoded attributes and distinguished names.
-
-version: 1
-dn:: b3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: ou=<JapaneseOU>,o=Airius
-objectclass: top
-objectclass: organizationalUnit
-ou:: 5Za25qWt6YOo
-# ou:: <JapaneseOU>
-ou;lang-ja:: 5Za25qWt6YOo
-# ou;lang-ja:: <JapaneseOU>
-ou;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2
-
-# ou;lang-ja:: <JapaneseOU_in_phonetic_representation>
-ou;lang-en: Sales
-description: Japanese office
-
-dn:: dWlkPXJvZ2FzYXdhcmEsb3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: uid=<uid>,ou=<JapaneseOU>,o=Airius
-userpassword: {SHA}O3HSv1MusyL4kTjP+HKI5uxuNoM=
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-objectclass: inetOrgPerson
-uid: rogasawara
-mail: rogasawara@airius.co.jp
-givenname;lang-ja:: 44Ot44OJ44OL44O8
-# givenname;lang-ja:: <JapaneseGivenname>
-sn;lang-ja:: 5bCP56yg5Y6f
-# sn;lang-ja:: <JapaneseSn>
-cn;lang-ja:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn;lang-ja:: <JapaneseCn>
-title;lang-ja:: 5Za25qWt6YOoIOmDqOmVtw==
-# title;lang-ja:: <JapaneseTitle>
-preferredlanguage: ja
-givenname:: 44Ot44OJ44OL44O8
-# givenname:: <JapaneseGivenname>
-sn:: 5bCP56yg5Y6f
-# sn:: <JapaneseSn>
-cn:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn:: <JapaneseCn>
-title:: 5Za25qWt6YOoIOmDqOmVtw==
-# title:: <JapaneseTitle>
-givenname;lang-ja;phonetic:: 44KN44Gp44Gr44O8
-# givenname;lang-ja;phonetic::
-<JapaneseGivenname_in_phonetic_representation_kana>
-sn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJ
-# sn;lang-ja;phonetic:: <JapaneseSn_in_phonetic_representation_kana>
-cn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJIOOCjeOBqeOBq+ODvA==
-# cn;lang-ja;phonetic:: <JapaneseCn_in_phonetic_representation_kana>
-title;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2IOOBtuOBoeOCh+OBhg==
-# title;lang-ja;phonetic::
-# <JapaneseTitle_in_phonetic_representation_kana>
-givenname;lang-en: Rodney
-sn;lang-en: Ogasawara
-cn;lang-en: Rodney Ogasawara
-title;lang-en: Sales, Director
-
-Example 5: A file containing a reference to an external file
-
-version: 1
-dn: cn=Horatio Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Horatio Jensen
-
-cn: Horatio N Jensen
-sn: Jensen
-uid: hjensen
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/hjensen.jpg
-
-Example 6: A file containing a series of change records and comments
-
-version: 1
-# Add a new entry
-dn: cn=Fiona Jensen, ou=Marketing, dc=airius, dc=com
-changetype: add
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Fiona Jensen
-sn: Jensen
-uid: fiona
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/fiona.jpg
Index: kaddressbook/xxport/samples/rfc2849.txt
===================================================================
--- kaddressbook/xxport/samples/rfc2849.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/samples/rfc2849.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,787 +1 @@
-
-
-
-
-
-
-Network Working Group                                             G. Good
-Request for Comments: 2849                   iPlanet e-commerce Solutions
-Category: Standards Track                                       June 2000
-
-
-   The LDAP Data Interchange Format (LDIF) - Technical Specification
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2000).  All Rights Reserved.
-
-Abstract
-
-   This document describes a file format suitable for describing
-   directory information or modifications made to directory information.
-   The file format, known as LDIF, for LDAP Data Interchange Format, is
-   typically used to import and export directory information between
-   LDAP-based directory servers, or to describe a set of changes which
-   are to be applied to a directory.
-
-Background and Intended Usage
-
-   There are a number of situations where a common interchange format is
-   desirable.  For example, one might wish to export a copy of the
-   contents of a directory server to a file, move that file to a
-   different machine, and import the contents into a second directory
-   server.
-
-   Additionally, by using a well-defined interchange format, development
-   of data import tools from legacy systems is facilitated.  A fairly
-   simple set of tools written in awk or perl can, for example, convert
-   a database of personnel information into an LDIF file. This file can
-   then be imported into a directory server, regardless of the internal
-   database representation the target directory server uses.
-
-   The LDIF format was originally developed and used in the University
-   of Michigan LDAP implementation.  The first use of LDIF was in
-   describing directory entries.  Later, the format was expanded to
-   allow representation of changes to directory entries.
-
-
-
-
-Good                        Standards Track                     [Page 1]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-   Relationship to the application/directory MIME content-type:
-
-   The application/directory MIME content-type [1] is a general
-   framework and format for conveying directory information, and is
-   independent of any particular directory service.  The LDIF format is
-   a simpler format which is perhaps easier to create, and may also be
-   used, as noted, to describe a set of changes to be applied to a
-   directory.
-
-   The key words "MUST", "MUST NOT", "MAY", "SHOULD", and "SHOULD NOT"
-   used in this document are to be interpreted as described in [7].
-
-Definition of the LDAP Data Interchange Format
-
-   The LDIF format is used to convey directory information, or a
-   description of a set of changes made to directory entries.  An LDIF
-   file consists of a series of records separated by line separators.  A
-   record consists of a sequence of lines describing a directory entry,
-   or a sequence of lines describing a set of changes to a directory
-   entry.  An LDIF file specifies a set of directory entries, or a set
-   of changes to be applied to directory entries, but not both.
-
-   There is a one-to-one correlation between LDAP operations that modify
-   the directory (add, delete, modify, and modrdn), and the types of
-   changerecords described below ("add", "delete", "modify", and
-   "modrdn" or "moddn").  This correspondence is intentional, and
-   permits a straightforward translation from LDIF changerecords to
-   protocol operations.
-
-Formal Syntax Definition of LDIF
-
-   The following definition uses the augmented Backus-Naur Form
-   specified in RFC 2234 [2].
-
-ldif-file                = ldif-content / ldif-changes
-
-ldif-content             = version-spec 1*(1*SEP ldif-attrval-record)
-
-ldif-changes             = version-spec 1*(1*SEP ldif-change-record)
-
-ldif-attrval-record      = dn-spec SEP 1*attrval-spec
-
-ldif-change-record       = dn-spec SEP *control changerecord
-
-version-spec             = "version:" FILL version-number
-
-
-
-
-
-
-Good                        Standards Track                     [Page 2]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-version-number           = 1*DIGIT
-                           ; version-number MUST be "1" for the
-                           ; LDIF format described in this document.
-
-dn-spec                  = "dn:" (FILL distinguishedName /
-                                  ":" FILL base64-distinguishedName)
-
-distinguishedName        = SAFE-STRING
-                           ; a distinguished name, as defined in [3]
-
-base64-distinguishedName = BASE64-UTF8-STRING
-                           ; a distinguishedName which has been base64
-                           ; encoded (see note 10, below)
-
-rdn                      = SAFE-STRING
-                           ; a relative distinguished name, defined as
-                           ; <name-component> in [3]
-
-base64-rdn               = BASE64-UTF8-STRING
-                           ; an rdn which has been base64 encoded (see
-                           ; note 10, below)
-
-control                  = "control:" FILL ldap-oid        ; controlType
-                           0*1(1*SPACE ("true" / "false")) ; criticality
-                           0*1(value-spec)                ; controlValue
-                           SEP
-                           ; (See note 9, below)
-
-ldap-oid                 = 1*DIGIT 0*1("." 1*DIGIT)
-                           ; An LDAPOID, as defined in [4]
-
-attrval-spec             = AttributeDescription value-spec SEP
-
-value-spec               = ":" (    FILL 0*1(SAFE-STRING) /
-                                ":" FILL (BASE64-STRING) /
-                                "<" FILL url)
-                           ; See notes 7 and 8, below
-
-url                      = <a Uniform Resource Locator,
-                            as defined in [6]>
-                                   ; (See Note 6, below)
-
-AttributeDescription     = AttributeType [";" options]
-                           ; Definition taken from [4]
-
-AttributeType            = ldap-oid / (ALPHA *(attr-type-chars))
-
-options                  = option / (option ";" options)
-
-
-
-Good                        Standards Track                     [Page 3]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-option                   = 1*opt-char
-
-attr-type-chars          = ALPHA / DIGIT / "-"
-
-opt-char                 = attr-type-chars
-
-changerecord             = "changetype:" FILL
-                           (change-add / change-delete /
-                            change-modify / change-moddn)
-
-change-add               = "add"                SEP 1*attrval-spec
-
-change-delete            = "delete"             SEP
-
-change-moddn             = ("modrdn" / "moddn") SEP
-                            "newrdn:" (    FILL rdn /
-                                       ":" FILL base64-rdn) SEP
-                            "deleteoldrdn:" FILL ("0" / "1")  SEP
-                            0*1("newsuperior:"
-                            (    FILL distinguishedName /
-                             ":" FILL base64-distinguishedName) SEP)
-
-change-modify            = "modify"             SEP *mod-spec
-
-mod-spec                 = ("add:" / "delete:" / "replace:")
-                           FILL AttributeDescription SEP
-                           *attrval-spec
-                           "-" SEP
-
-SPACE                    = %x20
-                           ; ASCII SP, space
-
-FILL                     = *SPACE
-
-SEP                      = (CR LF / LF)
-
-CR                       = %x0D
-                           ; ASCII CR, carriage return
-
-LF                       = %x0A
-                           ; ASCII LF, line feed
-
-ALPHA                    = %x41-5A / %x61-7A
-                           ; A-Z / a-z
-
-DIGIT                    = %x30-39
-                           ; 0-9
-
-
-
-
-Good                        Standards Track                     [Page 4]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-UTF8-1                   = %x80-BF
-
-UTF8-2                   = %xC0-DF UTF8-1
-
-UTF8-3                   = %xE0-EF 2UTF8-1
-
-UTF8-4                   = %xF0-F7 3UTF8-1
-
-UTF8-5                   = %xF8-FB 4UTF8-1
-
-UTF8-6                   = %xFC-FD 5UTF8-1
-
-SAFE-CHAR                = %x01-09 / %x0B-0C / %x0E-7F
-                           ; any value <= 127 decimal except NUL, LF,
-                           ; and CR
-
-SAFE-INIT-CHAR           = %x01-09 / %x0B-0C / %x0E-1F /
-                           %x21-39 / %x3B / %x3D-7F
-                           ; any value <= 127 except NUL, LF, CR,
-                           ; SPACE, colon (":", ASCII 58 decimal)
-                           ; and less-than ("<" , ASCII 60 decimal)
-
-SAFE-STRING              = [SAFE-INIT-CHAR *SAFE-CHAR]
-
-UTF8-CHAR                = SAFE-CHAR / UTF8-2 / UTF8-3 /
-                           UTF8-4 / UTF8-5 / UTF8-6
-
-UTF8-STRING              = *UTF8-CHAR
-
-BASE64-UTF8-STRING       = BASE64-STRING
-                           ; MUST be the base64 encoding of a
-                           ; UTF8-STRING
-
-BASE64-CHAR              = %x2B / %x2F / %x30-39 / %x3D / %x41-5A /
-                           %x61-7A
-                           ; +, /, 0-9, =, A-Z, and a-z
-                           ; as specified in [5]
-
-BASE64-STRING            = [*(BASE64-CHAR)]
-
-
-   Notes on LDIF Syntax
-
-      1)  For the LDIF format described in this document, the version
-          number MUST be "1". If the version number is absent,
-          implementations MAY choose to interpret the contents as an
-          older LDIF file format, supported by the University of
-          Michigan ldap-3.3 implementation [8].
-
-
-
-Good                        Standards Track                     [Page 5]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-      2)  Any non-empty line, including comment lines, in an LDIF file
-          MAY be folded by inserting a line separator (SEP) and a SPACE.
-          Folding MUST NOT occur before the first character of the line.
-          In other words, folding a line into two lines, the first of
-          which is empty, is not permitted. Any line that begins with a
-          single space MUST be treated as a continuation of the previous
-          (non-empty) line. When joining folded lines, exactly one space
-          character at the beginning of each continued line must be
-          discarded. Implementations SHOULD NOT fold lines in the middle
-          of a multi-byte UTF-8 character.
-
-      3)  Any line that begins with a pound-sign ("#", ASCII 35) is a
-          comment line, and MUST be ignored when parsing an LDIF file.
-
-      4)  Any dn or rdn that contains characters other than those
-          defined as "SAFE-UTF8-CHAR", or begins with a character other
-          than those defined as "SAFE-INIT-UTF8-CHAR", above, MUST be
-          base-64 encoded.  Other values MAY be base-64 encoded.  Any
-          value that contains characters other than those defined as
-          "SAFE-CHAR", or begins with a character other than those
-          defined as "SAFE-INIT-CHAR", above, MUST be base-64 encoded.
-          Other values MAY be base-64 encoded.
-
-      5)  When a zero-length attribute value is to be included directly
-          in an LDIF file, it MUST be represented as
-          AttributeDescription ":" FILL SEP.  For example, "seeAlso:"
-          followed by a newline represents a zero-length "seeAlso"
-          attribute value.  It is also permissible for the value
-          referred to by a URL to be of zero length.
-
-      6) When a URL is specified in an attrval-spec, the following
-          conventions apply:
-
-         a) Implementations SHOULD support the file:// URL format.  The
-            contents of the referenced file are to be included verbatim
-            in the interpreted output of the LDIF file.
-         b) Implementations MAY support other URL formats.  The
-            semantics associated with each supported URL will be
-            documented in an associated Applicability Statement.
-
-      7)  Distinguished names, relative distinguished names, and
-          attribute values of DirectoryString syntax MUST be valid UTF-8
-          strings.  Implementations that read LDIF MAY interpret files
-          in which these entities are stored in some other character set
-          encoding, but implementations MUST NOT generate LDIF content
-          which does not contain valid UTF-8 data.
-
-
-
-
-
-Good                        Standards Track                     [Page 6]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-      8)  Values or distinguished names that end with SPACE SHOULD be
-          base-64 encoded.
-
-      9)  When controls are included in an LDIF file, implementations
-          MAY choose to ignore some or all of them. This may be
-          necessary if the changes described in the LDIF file are being
-          sent on an LDAPv2 connection (LDAPv2 does not support
-          controls), or the particular controls are not supported by the
-          remote server. If the criticality of a control is "true", then
-          the implementation MUST either include the control, or MUST
-          NOT send the operation to a remote server.
-
-      10) When an attrval-spec, distinguishedName, or rdn is base64-
-          encoded, the encoding rules specified in [5] are used with the
-          following exceptions:  a) The requirement that base64 output
-          streams must be represented as lines of no more than 76
-          characters is removed. Lines in LDIF files may only be folded
-          according to the folding rules described in note 2, above.  b)
-          Base64 strings in [5] may contain characters other than those
-          defined in BASE64-CHAR, and are ignored. LDIF does not permit
-          any extraneous characters, other than those used for line
-          folding.
-
-Examples of LDAP Data Interchange Format
-
-Example 1: An simple LDAP file with two entries
-
-version: 1
-dn: cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Barbara Jensen
-cn: Barbara J Jensen
-cn: Babs Jensen
-sn: Jensen
-uid: bjensen
-telephonenumber: +1 408 555 1212
-description: A big sailing fan.
-
-dn: cn=Bjorn Jensen, ou=Accounting, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Bjorn Jensen
-sn: Jensen
-telephonenumber: +1 408 555 1212
-
-
-
-
-Good                        Standards Track                     [Page 7]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Example 2: A file containing an entry with a folded attribute value
-
-version: 1
-dn:cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass:top
-objectclass:person
-objectclass:organizationalPerson
-cn:Barbara Jensen
-cn:Barbara J Jensen
-cn:Babs Jensen
-sn:Jensen
-uid:bjensen
-telephonenumber:+1 408 555 1212
-description:Babs is a big sailing fan, and travels extensively in sea
- rch of perfect sailing conditions.
-title:Product Manager, Rod and Reel Division
-
-Example 3: A file containing a base-64-encoded value
-
-version: 1
-dn: cn=Gern Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Gern Jensen
-cn: Gern O Jensen
-sn: Jensen
-uid: gernj
-telephonenumber: +1 408 555 1212
-description:: V2hhdCBhIGNhcmVmdWwgcmVhZGVyIHlvdSBhcmUhICBUaGlzIHZhbHVl
-IGlzIGJhc2UtNjQtZW5jb2RlZCBiZWNhdXNlIGl0IGhhcyBhIGNvbnRyb2wgY2hhcmFjdG
-VyIGluIGl0IChhIENSKS4NICBCeSB0aGUgd2F5LCB5b3Ugc2hvdWxkIHJlYWxseSBnZXQg
-b3V0IG1vcmUu
-
-Example 4: A file containing an entries with UTF-8-encoded attribute
-values, including language tags.  Comments indicate the contents
-of UTF-8-encoded attributes and distinguished names.
-
-version: 1
-dn:: b3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: ou=<JapaneseOU>,o=Airius
-objectclass: top
-objectclass: organizationalUnit
-ou:: 5Za25qWt6YOo
-# ou:: <JapaneseOU>
-ou;lang-ja:: 5Za25qWt6YOo
-# ou;lang-ja:: <JapaneseOU>
-ou;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2
-
-
-
-Good                        Standards Track                     [Page 8]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-# ou;lang-ja:: <JapaneseOU_in_phonetic_representation>
-ou;lang-en: Sales
-description: Japanese office
-
-dn:: dWlkPXJvZ2FzYXdhcmEsb3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: uid=<uid>,ou=<JapaneseOU>,o=Airius
-userpassword: {SHA}O3HSv1MusyL4kTjP+HKI5uxuNoM=
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-objectclass: inetOrgPerson
-uid: rogasawara
-mail: rogasawara@airius.co.jp
-givenname;lang-ja:: 44Ot44OJ44OL44O8
-# givenname;lang-ja:: <JapaneseGivenname>
-sn;lang-ja:: 5bCP56yg5Y6f
-# sn;lang-ja:: <JapaneseSn>
-cn;lang-ja:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn;lang-ja:: <JapaneseCn>
-title;lang-ja:: 5Za25qWt6YOoIOmDqOmVtw==
-# title;lang-ja:: <JapaneseTitle>
-preferredlanguage: ja
-givenname:: 44Ot44OJ44OL44O8
-# givenname:: <JapaneseGivenname>
-sn:: 5bCP56yg5Y6f
-# sn:: <JapaneseSn>
-cn:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn:: <JapaneseCn>
-title:: 5Za25qWt6YOoIOmDqOmVtw==
-# title:: <JapaneseTitle>
-givenname;lang-ja;phonetic:: 44KN44Gp44Gr44O8
-# givenname;lang-ja;phonetic::
-<JapaneseGivenname_in_phonetic_representation_kana>
-sn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJ
-# sn;lang-ja;phonetic:: <JapaneseSn_in_phonetic_representation_kana>
-cn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJIOOCjeOBqeOBq+ODvA==
-# cn;lang-ja;phonetic:: <JapaneseCn_in_phonetic_representation_kana>
-title;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2IOOBtuOBoeOCh+OBhg==
-# title;lang-ja;phonetic::
-# <JapaneseTitle_in_phonetic_representation_kana>
-givenname;lang-en: Rodney
-sn;lang-en: Ogasawara
-cn;lang-en: Rodney Ogasawara
-title;lang-en: Sales, Director
-
-
-
-
-
-
-
-Good                        Standards Track                     [Page 9]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Example 5: A file containing a reference to an external file
-
-version: 1
-dn: cn=Horatio Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Horatio Jensen
-
-cn: Horatio N Jensen
-sn: Jensen
-uid: hjensen
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/hjensen.jpg
-
-Example 6: A file containing a series of change records and comments
-
-version: 1
-# Add a new entry
-dn: cn=Fiona Jensen, ou=Marketing, dc=airius, dc=com
-changetype: add
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Fiona Jensen
-sn: Jensen
-uid: fiona
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/fiona.jpg
-
-# Delete an existing entry
-dn: cn=Robert Jensen, ou=Marketing, dc=airius, dc=com
-changetype: delete
-
-# Modify an entry's relative distinguished name
-dn: cn=Paul Jensen, ou=Product Development, dc=airius, dc=com
-changetype: modrdn
-newrdn: cn=Paula Jensen
-deleteoldrdn: 1
-
-# Rename an entry and move all of its children to a new location in
-# the directory tree (only implemented by LDAPv3 servers).
-dn: ou=PD Accountants, ou=Product Development, dc=airius, dc=com
-changetype: modrdn
-newrdn: ou=Product Development Accountants
-deleteoldrdn: 0
-newsuperior: ou=Accounting, dc=airius, dc=com
-
-
-
-
-Good                        Standards Track                    [Page 10]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-# Modify an entry: add an additional value to the postaladdress
-# attribute, completely delete the description attribute, replace
-# the telephonenumber attribute with two values, and delete a specific
-# value from the facsimiletelephonenumber attribute
-dn: cn=Paula Jensen, ou=Product Development, dc=airius, dc=com
-changetype: modify
-add: postaladdress
-postaladdress: 123 Anystreet $ Sunnyvale, CA $ 94086
--
-
-delete: description
--
-replace: telephonenumber
-telephonenumber: +1 408 555 1234
-telephonenumber: +1 408 555 5678
--
-delete: facsimiletelephonenumber
-facsimiletelephonenumber: +1 408 555 9876
--
-
-# Modify an entry: replace the postaladdress attribute with an empty
-# set of values (which will cause the attribute to be removed), and
-# delete the entire description attribute. Note that the first will
-# always succeed, while the second will only succeed if at least
-# one value for the description attribute is present.
-dn: cn=Ingrid Jensen, ou=Product Support, dc=airius, dc=com
-changetype: modify
-replace: postaladdress
--
-delete: description
--
-
-Example 7: An LDIF file containing a change record with a control
-version: 1
-# Delete an entry. The operation will attach the LDAPv3
-# Tree Delete Control defined in [9]. The criticality
-# field is "true" and the controlValue field is
-# absent, as required by [9].
-dn: ou=Product Development, dc=airius, dc=com
-control: 1.2.840.113556.1.4.805 true
-changetype: delete
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 11]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Security Considerations
-
-   Given typical directory applications, an LDIF file is likely to
-   contain sensitive personal data.  Appropriate measures should be
-   taken to protect the privacy of those persons whose data is contained
-   in an LDIF file.
-
-   Since ":<" directives can cause external content to be included when
-   processing an LDIF file, one should be cautious of accepting LDIF
-   files from external sources.  A "trojan" LDIF file could name a file
-   with sensitive contents and cause it to be included in a directory
-   entry, which a hostile entity could read via LDAP.
-
-   LDIF does not provide any method for carrying authentication
-   information with an LDIF file.  Users of LDIF files must take care to
-   verify the integrity of an LDIF file received from an external
-   source.
-
-Acknowledgments
-
-   The LDAP Interchange Format was developed as part of the University
-   of Michigan LDAP reference implementation, and was developed by Tim
-   Howes, Mark Smith, and Gordon Good.  It is based in part upon work
-   supported by the National Science Foundation under Grant No.  NCR-
-   9416667.
-
-   Members of the IETF LDAP Extensions Working group provided many
-   helpful suggestions. In particular, Hallvard B. Furuseth of the
-   University of Oslo made many significant contributions to this
-   document, including a thorough review and rewrite of the BNF.
-
-References
-
-   [1]  Howes, T. and M. Smith, "A MIME Content-Type for Directory
-        Information", RFC 2425, September 1998.
-
-   [2]  Crocker, D., and P. Overell, "Augmented BNF for Syntax
-        Specifications: ABNF", RFC 2234, November 1997.
-
-   [3]  Wahl, M., Kille, S. and T. Howes, "A String Representation of
-        Distinguished Names", RFC 2253, December 1997.
-
-   [4]  Wahl, M., Howes, T. and S. Kille, "Lightweight Directory Access
-        Protocol (v3)", RFC 2251, July 1997.
-
-   [5]  Freed, N. and N. Borenstein, "Multipurpose Internet Mail
-        Extensions (MIME) Part One: Format of Internet Message Bodies",
-        RFC 2045, November 1996.
-
-
-
-Good                        Standards Track                    [Page 12]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-   [6]  Berners-Lee,  T., Masinter, L. and M. McCahill, "Uniform
-        Resource Locators (URL)", RFC 1738, December 1994.
-
-   [7]  Bradner, S., "Key Words for use in RFCs to Indicate Requirement
-        Levels", BCP 14, RFC 2119, March 1997.
-
-   [8]  The SLAPD and SLURPD Administrators Guide.  University of
-        Michigan, April 1996.  <URL:
-        http://www.umich.edu/~dirsvcs/ldap/doc/guides/slapd/toc.html>
-
-   [9]  M. P. Armijo, "Tree Delete Control", Work in Progress.
-
-Author's Address
-
-   Gordon Good
-   iPlanet e-commerce Solutions
-   150 Network Circle
-   Mailstop USCA17-201
-   Santa Clara, CA 95054, USA
-
-   Phone: +1 408 276 4351
-   EMail:  ggood@netscape.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 13]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Full Copyright Statement
-
-   Copyright (C) The Internet Society (2000).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 14]
-
+http://www.rfc-editor.org/rfc/rfc2849.txt
Index: kaddressbook/xxport/ldif_xxport.desktop
===================================================================
--- kaddressbook/xxport/ldif_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/ldif_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Plugin para {im,ex}portar LDIF
 Name[et]=KAB LDIF eksport/importplugin
 Name[eu]=KAB-en LDIF in/esportazio plugin-a
-Name[fa]=وصلۀ KAB LDIF XXPort 
+Name[fa]=وصلۀ KAB LDIF XXPort
 Name[fi]=KAB LDIF -liitännäinen
 Name[fr]=Module d'import / export LDIF pour KAB
+Name[gl]=Extensión XXPort de LDIF para KAB
 Name[he]=תוסף ייבוא/ייצוא עבור LDIF של KAB
 Name[hi]=केएबी एलडीआईएफ XXपोर्ट प्लगइन
 Name[hu]=KAB LDIF XXPort bővítőmodul
@@ -60,6 +61,7 @@
 Comment[fa]=وصله برای واردات و صادرات تماسها در قالب LDIF موزیلا و نت‌اسکیپ
 Comment[fi]=Liitännäinen Netscapen ja Mozillan LDIF-muodon kontaktien tuontiin ja vientiin
 Comment[fr]=Module d'import / export des contacts au format LDIF Mozilla et Netscape
+Comment[gl]=Extensión para importar e exportar contactos en formato LDIF de Netscape e Mozilla
 Comment[hi]=नेटस्केप तथा मोजिला एलडीआईएफ फार्मेट में सम्पर्कों को आयात और निर्यात करने का प्लगइन
 Comment[hu]=Bővítőmodul Netscape és Mozilla LDIF formátumú névjegyek importálásához/exportálásához
 Comment[is]=Íforrit sem flytur flytja inn eða út tengiliði í Netscape og Mozilla LDIF sniði
Index: kaddressbook/xxport/eudora_xxport.desktop
===================================================================
--- kaddressbook/xxport/eudora_xxport.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/xxport/eudora_xxport.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fa]=وصلۀ KAB Eudora XXPort
 Name[fi]=KAB Euroda -liitännäinen
 Name[fr]=Module d'import / export Eudora pour KAB
+Name[gl]=Extensión XXPort de Eudora para KA
 Name[he]=תוסף ייבוא/ייצוא עבור Eurdora של KAB
 Name[hi]=केएबी यूडोरा XXपोर्ट प्लगइन
 Name[hu]=KAB Eudora XXPort bővítőmodul
@@ -59,6 +60,7 @@
 Comment[fa]=وصله برای واردات و صادرات تماسهای Eudora
 Comment[fi]=Liitännäinen Eudora-kontaktien tuomiseen ja viemiseen
 Comment[fr]=Module d'import / export de contacts Eudora
+Comment[gl]=Extensión para importar e exportar contactos Eudora
 Comment[hi]=यूडोरा सम्पर्कों को आयात और निर्यात करने का प्लगइन
 Comment[hu]=Bővítőmodul Eudora névjegyek importálásához/exportálásához
 Comment[is]=Íforrit til að flytja inn og út Eudora tengiliði
Index: kaddressbook/editors/protocols/meanwhileprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/meanwhileprotocol.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/protocols/meanwhileprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,10 +15,11 @@
 Comment[es]=Protocolo Meanwhile
 Comment[et]=Meanwhile'i protokoll
 Comment[eu]=Meanwhile protokoloa
-Comment[fa]=قرارداد درضمن‌
+Comment[fa]=قرارداد در ضمن
 Comment[fi]=Meanwhile-protokolla
 Comment[fr]=Protocole Meanwhile
 Comment[ga]=Prótacal Meanwhile
+Comment[gl]=Protocolo Meanwhile
 Comment[he]=פרוטוקול Meanhwile
 Comment[hu]=Meanwhile protokoll
 Comment[is]=Meanwhile samskiptamátinn
@@ -46,5 +47,5 @@
 Comment[zh_CN]=Meanwhile 协议
 Comment[zh_TW]=Meanwhile 協定
 Name=Meanwhile
-Name[fa]=در ضمن‌
+Name[fa]=در ضمن
 
Index: kaddressbook/editors/protocols/skypeprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/skypeprotocol.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/protocols/skypeprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=ارتباط تلفنی اینترنت Skype
 Comment[fi]=Skype Internet-puhelin
 Comment[fr]=Téléphonie Internet Skype
+Comment[gl]=Telefonía por Internet con Skype
 Comment[he]=טלפוניית רשת של Skype
 Comment[hu]=Skype internetes telefon
 Comment[is]=Skype Internet sími
Index: kaddressbook/editors/protocols/ircprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/ircprotocol.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/protocols/ircprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -6,7 +6,7 @@
 X-KDE-InstantMessagingKABCField=messaging/irc
 Comment=Internet Relay Chat
 Comment[bg]=Протокол IRC
-Comment[fa]=گپ بازپخش اینترنت‌
+Comment[fa]=گپ بازپخش اینترنت
 Comment[hu]=IRC (Internet Relay Chat)
 Comment[is]=Internet spjall
 Comment[ja]=インターネット・リレー・チャット
Index: kaddressbook/editors/protocols/smsprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/smsprotocol.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/protocols/smsprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,7 +17,7 @@
 Comment[es]=Protocolo SMS
 Comment[et]=SMS protokoll
 Comment[eu]=SMS protokoloa
-Comment[fa]=قرارداد پیام کوتاه‌
+Comment[fa]=قرارداد پیام کوتاه
 Comment[fi]=SMS-protokolla
 Comment[fr]=Protocole SMS
 Comment[ga]=Prótacal SMS
@@ -51,7 +51,7 @@
 Comment[zh_CN]=短信息协议
 Comment[zh_TW]=SMS 協定
 Name=SMS
-Name[fa]=پیام کوتاه‌
+Name[fa]=پیام کوتاه
 Name[km]=សេវា​សារ​ខ្លីៗ
 Name[zh_CN]=短信息
 
Index: kaddressbook/editors/cryptosettings.desktop
===================================================================
--- kaddressbook/editors/cryptosettings.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/cryptosettings.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Name[es]=Preferencias de cifrado
 Name[et]=Krüptoseadistused
 Name[eu]=Kriptografia hobespenak
-Name[fa]=تنظیمات مخفی‌
+Name[fa]=تنظیمات مخفی
 Name[fi]=Salauksen asetukset
 Name[fr]=Préférences de chiffrement
 Name[gl]=Preferencias de Cifraxe
Index: kaddressbook/editors/imaddresseditor.desktop
===================================================================
--- kaddressbook/editors/imaddresseditor.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/editors/imaddresseditor.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,7 +11,7 @@
 Name[es]=Mensajería instantánea
 Name[et]=Kiirsuhtlus
 Name[eu]=Berehalako mezularitza
-Name[fa]=پیام‌دهی فوری‌
+Name[fa]=پیام‌دهی فوری
 Name[fi]=Pikaviestintä
 Name[fr]=Messagerie instantanée
 Name[gl]=Mensaxería Instantánea
@@ -54,7 +54,7 @@
 Comment[es]=Editor de direcciones de mensajería instantánea
 Comment[et]=Kiirsuhtluse aadresside redaktor
 Comment[eu]=Berehalako mezularitza helbide editorea
-Comment[fa]=ویرایشگر نشانی پیام‌دهی فوری‌
+Comment[fa]=ویرایشگر نشانی پیام‌دهی فوری
 Comment[fi]=Pikaviestinnän osoitteet
 Comment[fr]=Éditeur d'adresses de messagerie instantanée
 Comment[gl]=Editor de Enderezos de Mensaxería Instantánea
Index: kaddressbook/kaddressbook_view.desktop
===================================================================
--- kaddressbook/kaddressbook_view.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/kaddressbook_view.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,9 +16,10 @@
 Comment[es]=Plugin del visor de KAddressBook
 Comment[et]=KDE aadressiraamatu vaatamise plugin
 Comment[eu]=KAddressBook-en bistaratze plugin-a
-Comment[fa]=وصلۀ نمای KAddressBook 
+Comment[fa]=وصلۀ نمای KAddressBook
 Comment[fi]=KAddressbook näyttöliitännäinen
 Comment[fr]=Module d'affichage pour KAddressBook
+Comment[gl]=Extensión de Visualización para KAddressBook
 Comment[he]=תוסף תצוגה עבור פנקס הכתובות
 Comment[hi]=के-एड्रेस-बुक दृश्य प्लगइन
 Comment[hu]=KAddressBook nézeti bővítőmodul
Index: kaddressbook/kcmconfigs/kabcustomfields.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabcustomfields.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/kcmconfigs/kabcustomfields.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -24,7 +24,7 @@
 Name[es]=Páginas personalizadas
 Name[et]=Omaloodud leheküljed
 Name[eu]=Orri pertsonalizatuak
-Name[fa]=صفحات سفارشی‌
+Name[fa]=صفحات سفارشی
 Name[fi]=Omat sivut
 Name[fr]=Pages personnalisées
 Name[ga]=Leathanaigh Shaincheaptha
@@ -112,7 +112,7 @@
 Keywords[es]=kaddressbook, configurar, opciones, campos personalizados
 Keywords[et]=kde aadressiraamat, seadistamine, seadistused, omaloodud väljad
 Keywords[eu]=kaddressbook, konfiguratu, ezarpenak, eremu pertsonalizatuak
-Keywords[fa]=kaddressbook، پیکربندی، تنظیمات، حوزه‌های سفارشی‌
+Keywords[fa]=kaddresAPsbook، پیکربندی، تنظیمات، حوزه‌های سفارشی‌
 Keywords[fi]=osoitekirja, aseta, asetukset, omat kentät
 Keywords[fr]=carnet d'adresses,adresses,kab,kaddressbook,configurer,paramètres,paramètre,champ,personnalisé
 Keywords[ga]=kaddressbook, cumraith, cumraíocht, socruithe, réimsí saincheaptha
Index: kaddressbook/kcmconfigs/kabconfig.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabconfig.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/kcmconfigs/kabconfig.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,6 +27,7 @@
 Name[fi]=Yleinen
 Name[fr]=Général
 Name[ga]=Ginearálta
+Name[gl]=Xeral
 Name[he]=כללי
 Name[hu]=Általános
 Name[is]=Almennt
@@ -70,7 +71,7 @@
 Comment[es]=Configura la libreta de direcciones
 Comment[et]=Aadressiraamatu seadistamine
 Comment[eu]=Konfiguratu helbide-liburua
-Comment[fa]=پیکربندی کتاب نشانی‌
+Comment[fa]=پیکربندی کتاب نشانی
 Comment[fi]=Muokkaa osoitekirjan asetuksia
 Comment[fr]=Configurer le carnet d'adresses
 Comment[ga]=Cumraigh an Leabhar Seoltaí
Index: kaddressbook/kcmconfigs/kabldapconfig.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabldapconfig.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/kcmconfigs/kabldapconfig.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -73,6 +73,7 @@
 Comment[fa]=پیکربندی تنظیمات LDAP کتاب نشانی‌
 Comment[fi]=Aseta osoitekirjan LDAP-asetuksia
 Comment[fr]=Configurer les paramètres du carnet d'adresses LDAP
+Comment[gl]=Configurar as opcións do Caderno de Enderezos de LDAP
 Comment[he]=הגדר את פנקס הכתובות מבוסס LDAP
 Comment[hi]=पता पुस्तिका एलडीएपी विन्यास कॉन्फ़िगर करें
 Comment[hu]=A címjegyzék LDAP-beállításainak megváltoztatása
Index: kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop
===================================================================
--- kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Archivos de tarjetas de visita electrónicas
 Name[et]=Elektrooniline visiitkaart
 Name[eu]=Electronic Business Card fitxategiak
-Name[fa]=پرونده‌های کارت تجاری الکترونیکی‌
+Name[fa]=پرونده‌های کارت تجاری الکترونیکی
 Name[fi]=Sähköiset käyntikorttitiedostot
 Name[fr]=Fichiers de cartes de commerce électroniques
+Name[gl]=Ficheiros de Tarxetas de Visita Electrónicas
 Name[hi]=इलेक्ट्रानिक व्यापार कार्ड फ़ाइलें
 Name[hu]=Elektronikus névjegykártyák
 Name[is]=Skrár með rafrænum nafnspjöldum
Index: kaddressbook/features/distributionlistwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/features/distributionlistwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -327,6 +327,7 @@
 #else
   KABC::DistributionList *list = mManager->list( oldName );
   list->setName( newName );
+  mManager->save();
   updateNameCombo();
 #endif
 
Index: kaddressbook/features/distributionlist.desktop
===================================================================
--- kaddressbook/features/distributionlist.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/features/distributionlist.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -61,7 +61,7 @@
 Comment[es]=Plugin para gestionar listas de distribución
 Comment[et]=Plugin postiloendite haldamiseks
 Comment[eu]=Banaketa zerrendak kudeatzeko plugin-a
-Comment[fa]=وصله برای مدیریت فهرستهای توزیع‌
+Comment[fa]=وصله برای مدیریت فهرستهای توزیع
 Comment[fi]=Liitännäinen jakelulistojen hallintaan
 Comment[fr]=Module pour gérer des listes de diffusion
 Comment[gl]=Plugin para manexar listas de distribución
Index: kaddressbook/features/resourceselection.desktop
===================================================================
--- kaddressbook/features/resourceselection.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kaddressbook/features/resourceselection.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Name[es]=Extensión para gestionar la libreta de direcciones
 Name[et]=Aadressihalduri plugin
 Name[eu]=Helbide-liburu kudeaketa plugin-a
-Name[fa]=وصلۀ مدیریت کتاب نشانی‌
+Name[fa]=وصلۀ مدیریت کتاب نشانی
 Name[fi]=Osoitekirjan ylläpidon laajennus
 Name[fr]=Module de gestion de carnet d'adresses
 Name[ga]=Breiseán Bhainisteoireacht Leabhar na Seoltaí
@@ -58,7 +58,7 @@
 Comment[es]=Extenxión para gestionar libretas de direcciones
 Comment[et]=Plugin aadressiraamatute haldamiseks
 Comment[eu]=Helbide-liburuak kudeatzeko plugin-a
-Comment[fa]=وصله برای مدیریت کتابهای نشانی‌
+Comment[fa]=وصله برای مدیریت کتابهای نشانی
 Comment[fi]=Osoitekirjojen ylläpidon laajennus
 Comment[fr]=Module pour gérer les carnets d'adresses
 Comment[gl]=Extensión para xestionar cadernos de enderezos
Index: libkholidays/parseholiday.c
===================================================================
--- libkholidays/parseholiday.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/parseholiday.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1577,19 +1577,14 @@
 {
   int off = 0;
   int wday = 0;
-printf("ConditionalOffset: %i.%i.%i, condition=%i\n", day, month, year, cond );
   (void)date_to_time( day, month, year, &wday, 0, 0);
   if ( wday == 0 ) { wday = 7; } /* sunday is 7, not 0 */
-printf("Date is a %i\n", wday );
   if ( cond & (1<<wday) ) { 
     /* condition matches -> higher 8 bits contain the possible days to shift to */
     int to = (cond >> 8);
-printf("  Matches condition\n");
-printf("  To condition: %i\n", to);
     while ( !(to & (1<<((wday+off)%7))) && (off < 8) ) {
       ++off;
     }
-printf("  Resulting offset: %i\n", off);
   }
   if ( off >= 8 ) return 0;
   else return off;
Index: libkholidays/kholidays.cpp
===================================================================
--- libkholidays/kholidays.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/kholidays.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,7 +41,7 @@
 QStringList KHolidays::locations()
 {
   QStringList files =
-    KGlobal::dirs()->findAllResources( "data", "libkholidays/holiday_*",
+    KGlobal::dirs()->findAllResources( "data", "libkholidays/" + generateFileName( "*" ),
                                        false, true );
   QStringList locs;
 
@@ -52,10 +52,28 @@
   return locs;
 }
 
+QString KHolidays::fileForLocation( const QString &location )
+{
+  return locate( "data", "libkholidays/" + generateFileName( location ) );
+}
+
+QString KHolidays::userPath( bool create )
+{
+  return KGlobal::dirs()->saveLocation( "data", "libkholidays/", create );
+}
+
+QString KHolidays::generateFileName( const QString &location )
+{
+  return "holiday_" + location;
+}
+
+
+
+
 KHolidays::KHolidays( const QString& location )
   : mLocation( location )
 {
-  mHolidayFile = locate( "data", "libkholidays/holiday_" + location );
+  mHolidayFile = fileForLocation( location );
 
   mYearLast = 0;
 }
Index: libkholidays/parseholiday.y
===================================================================
--- libkholidays/parseholiday.y	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/parseholiday.y	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -374,19 +374,14 @@
 {
   int off = 0;
   int wday = 0;
-printf("ConditionalOffset: %i.%i.%i, condition=%i\n", day, month, year, cond );
   (void)date_to_time( day, month, year, &wday, 0, 0);
   if ( wday == 0 ) { wday = 7; } /* sunday is 7, not 0 */
-printf("Date is a %i\n", wday );
   if ( cond & (1<<wday) ) { 
     /* condition matches -> higher 8 bits contain the possible days to shift to */
     int to = (cond >> 8);
-printf("  Matches condition\n");
-printf("  To condition: %i\n", to);
     while ( !(to & (1<<((wday+off)%7))) && (off < 8) ) {
       ++off;
     }
-printf("  Resulting offset: %i\n", off);
   }
   if ( off >= 8 ) return 0;
   else return off;
Index: libkholidays/holidays/holiday_se
===================================================================
--- libkholidays/holidays/holiday_se	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/holidays/holiday_se	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,31 +1,37 @@
 :
-: Swedish holiday file. Copy to ~/.holiday for private changes or tip
-: wedberg@mednet.gu.se if things are missing.
+: Swedish holiday file.
 :
 weekend "Nyårsdagen" weekend on 1.1
 black "Trett.d.afton" black on 5.1
 weekend "Trett.d. Jul" weekend on 6.1
 black "Alla hjärtans dag" on 14.2
+black "Fettisdagen" on easter minus 47 days
+black "Askonsdagen" on easter minus 46 days
 blue "Sommartid" on last sunday in march
+black "Skärtorsdagen" black on easter minus 3
+weekend "Långfredagen" weekend on easter minus 2
 black "Påskafton" black on easter minus 1
 weekend "Påskdagen" weekend on easter
-weekend "Långfredagen" weekend on easter minus 2
 weekend "Annandag påsk" weekend on easter plus 1
-black "Pingstafton" black on easter plus 48 days 
-weekend "Pingstdagen" weekend on easter plus 49 days 
-weekend "Annandag Pingst" weekend on easter plus 50 days 
+black "Pingstafton" black on easter plus 48 days
+weekend "Pingstdagen" weekend on easter plus 49 days
+:Before 2005
+:weekend "Annandag Pingst" weekend on easter plus 50 days
+black "Annandag Pingst" black on easter plus 50 days
 weekend "Kristi Him.f." weekend on easter plus 39 days
 weekend "Första Maj" weekend on 1.5
-black "Nationaldagen" black on 6.6
+:Before 2005
+:black "Nationaldagen" black on 6.6
+weekend "Nationaldagen" weekend on 6.6
 black "Midsommarafton" black on friday before 26.6
 weekend "Midsommardagen" weekend on saturday before 27.6
 blue "Vintertid" on last sunday in october
 weekend "Alla helgons dag" weekend on first sunday in november minus 1
-black "1. Advent" on sunday before 23.12 minus 21 days
-black "2. Advent" on sunday before 23.12 minus 14 days
-black "3. Advent" on sunday before 23.12 minus 7 days
-black "4. Advent" on sunday before 23.12
+black "1. Advent" on sunday before 24.12 minus 21 days
+black "2. Advent" on sunday before 24.12 minus 14 days
+black "3. Advent" on sunday before 24.12 minus 7 days
 black "Julafton" black on 24.12
+black "4. Advent" on sunday before 24.12
 weekend "Juldagen" weekend on 25.12
 weekend "Annandag Jul" weekend on 26.12
 black "Nyårsafton" on 31.12
Index: libkholidays/holidays/holiday_gr
===================================================================
--- libkholidays/holidays/holiday_gr	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkholidays/holidays/holiday_gr	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,309 @@
+:
+: Greek holiday file.
+:
+: Author: capthookb (praktoreio2002@yahoo.gr)
+:
+: "weekend" or "red" indicate a "proper" holiday (i.e. you do not work)
+:  Other colours (black, green, yellow, blue, magenta, cyan, white)
+: can be used to distinguish between minor anniversaries or not-so-real
+: holidays, when you go working anyway.
+: "small" holidays are not as "invasive" in the month view in KOrganizer,
+: and do not take as much space.
+
+: Ονομαστικές εορτές
+
+small black "Βασίλης, Βασιλική, Βασιλεία, Βίβιαν" on 1.1
+small black "Συλβέστρος" on 2.1
+small black "Θεώνη" on 5.1
+small black "Άγια Θεοφάνεια (Αργία)" on 6.1
+small black "Φώτης, Φωτεινή, Θεοφάνης, Θεοφανία, Φανή, Ιορδάνης, Θεανώ, Ουρανία, Θεοπούλα" on 6.1
+small black "Ιωάννης, Ιωάννα, Πρόδρομος" on 7.1
+small black "Αγάθων, Δομινίκη, Παρθένα, Κύρος" on 8.1
+small black "Θεοδόσης, Θεοδοσία" on 11.1
+small black "Τατιάνα, Τατιανή" on 12.1
+small black "Αντώνης, Αντωνία" on 17.1
+small black "Αθανάσιος, Αθανασία, Κύριλλος" on 18.1
+small black "Μακάριος" on 19.1
+small black "Ευθύμης, Ευθυμία, Φαβιανός" on 20.1
+small black "Αγνή, Μάξιμος, Νεόφυτος, Πάτροκλος" on 21.1
+small black "Τιμόθεος, Αναστάσιος, Αναστασία" on 22.1
+small black "Αγαθάγγελος" on 23.1
+small black "Ξένη, Φίλωνας, Ζωσιμάς" on 24.1
+small black "Γρηγόρης, Γρηγορία, Μαργαρίτα" on 25.1
+small black "Ξενοφών" on 26.1
+small black "Χάρις, Παλλάδιος" on 28.1
+small black "Μαύρος, Χρυσή, Τριών Ιεραρχών (Σχολική Αργία)" on 30.1
+small black "Ευδοξία, Κύρος" on 31.1
+small black "Τρύφωνας" on 1.2
+small black "Υπαπαντή" on 2.2
+small black "Σταμάτ-ης/ία, Συμεώ-ν/νή, Σιμώνη, Ασημάκης, Ασημίνα, Μαλαματή" on 3.2
+small black "Ισίδωρος, Ιάσιμος, Ιασίμη" on 4.2
+small black "Αγαθή" on 5.2
+small black "Φώτης" on 6.2
+small black "Παρθένιος, Παρθενία" on 7.2
+small black "Ζαχαρίας, Ζαχαρούλα" on 8.2
+small black "Μάρκελος, Νικηφόρος, Νίκη" on 9.2
+small black "Χαράλαμπος, Χαραλαμπία, Χαρίκλεια, Χαρίλαος, Χαρούλα" on 10.2
+small black "Βλάσης, Βλασία, Θοδωρής, Θοδώρα, Αυγή " on 11.2
+small black "Μελέτης, Πλωτίνος" on 12.2
+small black "Πρίσκιλλα" on 13.2
+small black "Βαλεντίνος, Βαλεντίνη, Παγκόσμια Ημέρα Ερωτευμένων" on 14.2
+small black "Ευσέβιος, Ευσεβία" on 15.2
+small black "Πάμφιλος, Παμφίλη, Σέλευκος, Σελεύκη" on 16.2
+small black "Λέων, Αγαπητός" on 18.2
+small black "Φιλοθέη, Χλόη" on 19.2
+small black "Ανθούσα" on 22.2
+small black "Πολύκαρπος" on 23.2
+small black "Πορφύρης, Φωτεινή" on 26.2
+small black "Μαριάννα, Ασκληπιός" on 28.2
+small black "Ευδοκία, Χαρίσιος" on 1.3
+small black "Ευθαλία" on 2.3
+small black "Κλεόνικος, Κλεονίκη" on 3.3
+small black "Αρχέλαος, Eυλόγιος" on 5.3
+small black "Ησύχιος" on 6.3
+small black "Ευγένιος, Ευγενία" on 7.3
+small black "Ερμής, Θεοφύλακτος, Παγκόσμια Ημέρα της Γυναίκας" on 8.3
+small black "Σμάραγδος, Σμαράγδα, Ηλιάνα, Λεόντιος, Λεοντία, Λυσίμαχος Λυσιμαχη" on 9.3
+small black "Ξάνθος, Ξανθούλα, Σαράντης Σαραντούλα, Φιλοκτήμων" on 9.3
+small black "Θεόδωρος Θεοδώρα, Θώδος, Θώδη, Θαλλής, Θάλεια, Σωφρόνιος, Σωφρονία" on 11.3
+small black "Λωξάντρα, Ρωξάνη, Oρθοδόξης," on 12.3
+small black "Λέανδρος" on 13.3
+small black "Βενέδικτος, Βενεδίκτη" on 14.3
+small black "Αγάπιος" on 15.3
+small black "Χριστόδουλος, Ιουλιανός" on 16.3
+small black "Αλέξιος, Αλεξία" on 17.3
+small black "Χρύσανθος, Χρυσάνθη" on 19.3
+small black "Δρόσος, Δροσούλα" on 22.3
+small black "Ευαγγελισμός της Θεοτόκου " on 25.3
+small black "Ευάγγελος, Ευαγγελία" on 25.3
+small black "Πούλιος, Σύλας, Σύλια" on 26.3
+small black "Λυδία, Μακεδόνιος, Μακεδονούλα" on 27.3
+small black "Ευτύχιος, Ευτυχία" on 6.4
+small black "Ιωσήφ, Ιωσηφίνα" on 9.4
+small black "Δημοσθένης, Ηρακλής, Μιλτιάδης, Περικλής, Σοφοκλής, Επαμεινώνδας" on 10.4
+small black "Όμηρος, Πελοπίδας, Παρμενίων, Πολύβιος, Αναξιμένης, Φοιλοποίμην, Φίλης" on 10.4
+small black "Αρίσταρχος, Θωμαΐς" on 14.4
+small black "Λεωνίδας, Λάζαρος" on 15.4
+small black "Βάϊος, Βάϊα, Δάφνη, Γαλήνη, Χιονία" on 16.4
+small black "Ναθαναήλ, Νέαρχος, Νιάρχος" on 22.4
+small black "Αναστάσιος, Αναστασία, Λάμπρος, Λαμπρινή, Πασχάλης " on 23.4
+small black "Γεώργιος, Γεωργία, Ελισάβετ, Αχιλλέας" on 24.4
+small black "Μάρκος, Νίκη, Ραφαήλ" on 25.4
+small black "Ζωή, Πηγή" on 28.4
+small black "Ιάσωνας" on 29.4
+small black "Ιάκωβος, Θωμάς, Θωμαή, Ασημίνα" on 30.4
+weekend "Ιερεμίας" on 1.5
+small black "Έσπερος, Εσπέρια" on 2.5
+small black "Ροδόπη" on 3.5
+small black "Ειρήνη, Eιρηναίος, Ευφραίμ" on 5.5
+small black "Μυροφόρα" on 7.5
+small black "Θεολόγος" on 8.5
+small black "Χριστόφορος, Ησαΐας" on 9.5
+small black "Σίμων" on 10.5
+small black "Aρμόδιος,Μεθόδιος, Ολυμπία" on 11.5
+small black "Επιφάνειος" on 12.5
+small black "Γλυκερία" on 13.5
+small black "Γιορτή της Μητέρας, Αριστοτέλης" on 14.5
+small black "Καλή" on 15.5
+small black "Ανδρόνικος, Ανδρονίκη, Ιουνία" on 17.5
+small black "Ιουλία, Γαλάτεια" on 18.5
+small black "Θεόκτιστος, Μαγδαληνή, Πατρίκιος" on 19.5
+small black "Λυδία" on 20.5
+small black "Κωνσταντίνος, Κωνσταντίνα, Ελένη" on 21.5
+small black "Αιμίλιος, Αιμιλία, Έμυ" on 22.5
+small black "Μαρκιανή" on 24.5
+small black "Θεοδοσία" on 29.5
+small black "Πύρρος, Νεφέλη, Ιουστίνος, Ανάληψη" on 1.6
+small black "Νικηφόρος, Μαρίνος" on 2.6
+small black "Υπάτιος, Υπατία" on 3.6
+small black "Μάρθα" on 4.6
+small black "Aπόλλων, Δωρόθεος, Δωροθέα, Σελήνη, Νίκανδρος" on 5.6
+small black "Καλλιόπη" on 8.6
+small black "Ροδάνθη" on 9.6
+small black "Βαρθολομαίος, Βαρνάβας" on 11.6
+small black "Ονούφριος, Ζήνων,Κορίνα, Αγίου Πνεύματος" on 12.6
+small black "Ελισαίος" on 14.6
+small black "Αυγουστίνος, Αυγούστα, Ιερώνυμος, Μόνικα, Ορτανσία" on 15.6
+small black "Γιορτή του πατέρα" on 16.6
+small black "Έρασμος, Ερασμία, Aγίων Πάντων" on 18.6
+small black "Παΐσιος, Ζωσιμάς, Ζήσης" on 19.6
+small black "Ευσέβιος, Ευσεβία" on 22.6
+small black "Αριστοκλής" on 23.6
+small black "Φεβρωνία, Έρωτας" on 25.6
+small black "Γερμανός" on 28.6
+small black "Πέτρος, Πέτρα, Παύλος, Παυλίνα" on 29.6
+small black "Απόστολος, Αποστολία, Μελίτων" on 30.6
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.7
+small black "Υάκινθος, Ζουμπουλία" on 3.7
+small black "Λουκία" on 4.7
+small black "Λυκίας, Λύκιος, Λυκία, " on 6.7
+small black "Κυριακή" on 7.7
+small black "Θεόφιλος, Προκόπιος" on 8.7
+small black "Ευφημία, Όλγα" on 11.7
+small black "Βερονίκη, Βερενίκη " on 12.7
+small black "Σάρα" on 13.7
+small black "Ακύλας, Νικόδημος" on 14.7
+small black "Βλαδίμηρος, Ιουλίττα, Κήρυκος" on 15.7
+small black "Μαρίνα" on 17.7
+small black "Αιμίλιος, Αιμιλία" on 18.7
+small black "Ηλίας, Ηλιάνα" on 20.7
+small black "Μαγδαληνή, Μαρκέλλα, Μαριλένα" on 22.7
+small black "Φωκάς" on 23.7
+small black "Αθηναγόρας" on 24.7
+small black "Άννα, Ολυμπία" on 25.7
+small black "Παρασκευή, Παρασκευάς, Έρση" on 26.7
+small black "Παντελής" on 27.7
+small black "Ειρήνη, Χρυσοβαλάντης, Βαλάντης, Χρυσοβαλάντου, Ακάκιος" on 28.7
+small black "Καλλίνικος" on 29.7
+small black "Ανδρόνικος, Ανδρονίκη" on 30.7
+small black "Ιωσήφ, Ιωσηφίνα" on 31.7
+small black "Μάρκελος" on 1.8
+small black "Σωτήρης, Σωτηρία, Ευμορφία, Έμμυ, Μορφούλα" on 6.8
+small black "Αστέριος, Αστερία" on 7.8
+small black "Τριαντάφυλλος, Τριανταφυλλιά" on 8.8
+small black "Ρωμανός" on 9.8
+small black "Λαυρέντης, Λαυρεντία, Ευλαμπία, Ιππόλυτος, Ηρώ " on 10.8
+weekend "Κοίμηση της Θεοτόκου (Αργία)" on 15.8
+weekend "Μαρία, Μάριος, Παναγιώτης, Παναγιώτα, Δέσποινα, Θεοτόκης" on 15.8
+small black "Γεράσιμος, Αλκιβιάδης, Διομήδης, Σαράντης" on 16.8
+small black "Λευκοθέα, Μύρων, Μίρκα" on 17.8
+small black "Φλώρα" on 18.8
+small black "Σαμουήλ, Θεοχάρης" on 20.8
+small black "Aγαθόνικος" on 22.8
+small black "Κοσμάς" on 24.8
+small black "Βαρθολομαίος, Τίτος" on 25.8
+small black "Ναταλία, Ανδριανός, Ανδριανή" on 26.8
+small black "Φανούριος, Φανουρία, Αρκαδία" on 27.8
+small black "Θεοπίστη" on 29.8
+small black "Αλέξανδρος" on 30.8
+small black "Αδαμάντιος, Αδαμαντία, Αθηνά, Αντιγόνη, Ασπασία, Αφροδίτη, Δωδώνη" on 1.9
+small black "Ελπινίκη, Ερασμία, Ερατώ, Ευτέρπη, Θάλεια, Θεανώ, Καλλίστη, Κλειώ, Κλεονίκη" on 1.9
+small black "Κλεοπάτρα, Κοραλία, Μαργαρίτα, Μαριάνθη, Μελέτιος, Μελπομένη, Ουρανία" on 1.9
+small black "Πανδώρα, Πηνελόπη, Πολυμνία, Πολυνίκη, Σαπφώ, Συμεών, Τερψιχόρη, Χάιδω" on 1.9
+small black "Άνθιμος, Πολύδωρος, Φοίβη" on 3.9
+small black "Ερμιόνη, Μωυσής" on 4.9
+small black "Ζαχαρίας" on 5.9
+small black "Κασσιανή, Σώζων" on 7.9
+small black "Ιωακείμ" on 9.9
+small black "Εράστη, Εράστος, Μητροδώρα, Πουλχερία" on 10.9
+small black "Ευανθία" on 11.9
+small black "Αριστείδης, Κορνήλιος" on 13.9
+small black "Σταύρος, Σταυρούλα" on 14.9
+small black "Νικήτας, Βησσαρίων" on 15.9
+small black "Ευφημία" on 16.9
+small black "Σοφία, Ελπίδα, Αγάπη, Πίστη, Σόνια" on 17.9
+small black "Αριάδνη" on 18.9
+small black "Ευστάθιος, Ευσταθία" on 20.9
+small black "Ίωνας" on 21.9
+small black "Φωκάς, Ζωγραφιά" on 22.9
+small black "Πολυξένη, Ξανθίππη, Ξάνθιππος" on 23.9
+small black "Θέκλα, Μυρσίνη, Μυρτώ" on 24.9
+small black "Ευφροσύνη" on 25.9
+small black "Ζήνων" on 27.9
+small black "Κυριάκος, Κυριακή" on 29.9
+small black "Θηρεσία" on 1.10
+small black "Κυπριανός" on 2.10
+small black "Διονύσης, Διονυσία" on 3.10
+small black "Ιερόθεος, Φραγκίσκος" on 4.10
+small black "Χαριτινή" on 5.10
+small black "Σέργιος, Πολυχρόνης, Χρόνης" on 7.10
+small black "Πελαγία" on 8.10
+small black "Ευλάμπιος, Ευλαμπία" on 10.10
+small black "Ανδρομάχη, Ανδρόμαχος" on 12.10
+small black "Αγαθονίκη, Φλωρέντιος, Φλωρεντία" on 13.10
+small black "Λουκιανός" on 15.10
+small black "Λουκάς" on 18.10
+small black "Γεράσιμος, Αρτέμιος" on 20.10
+small black "Σωκράτης, Χριστόδουλος, Όυρσουλα" on 21.10
+small black "Αβέρκιος" on 22.10
+small black "Ιάκωβος" on 23.10
+small black "Χρυσάφης" on 25.10
+small black "Δημήτριος, Δήμητρα, Δανάη" on 26.10
+small black "Νέστορας" on 27.10
+small black "Ζηνοβία, Κλεόπας, Μαρκιανός" on 30.10
+small black "Αριστόβουλος" on 31.10
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.11
+small black "Αφθόνιος, Αφθονία" on 2.11
+small black "Ιωαννίκη" on 4.11
+small black "Λίνος" on 5.11
+small black "Λεονάρδος" on 6.11
+small black "Αθηνόδωρος" on 7.11
+small black "Σταμάτιος, Σταματία, Μιχάλης, Γαβριήλ, Γαβριέλα" on 8.11
+small black "Ταξιάρχης, Άγγελος, Αγγελική, Ματίνα, Σεραφείμ" on 8.11
+small black "Νεκτάριος, Νεκταρία" on 9.11
+small black "Ορέστης" on 10.11
+small black "Μηνάς, Mήνα, Βίκτωρ, Βικτωρία" on 11.11
+small black "Χρυσόστομος" on 13.11
+small black "Φίλιππος" on 14.11
+small black "Ματθαίος, Ιφιγένεια" on 16.11
+small black "Πλάτωνας" on 18.11
+small black "Μαρία, Μάριος" on 21.11
+small black "Φιλήμων" on 22.11
+small black "Μερώπη" on 23.11
+small black "Κατερίνα, Μερκούριος" on 25.11
+small black "Στέλιος, Στέλλα, Στέργιος" on 26.11
+small black "Φαίδρα" on 29.11
+small black "Ανδρέας, Ανδριάνα" on 30.11
+small black "Θεόκλητος, Ιακώβ" on 1.12
+small black "Βαρβάρα, Δαμασκηνός" on 4.12
+small black "Σάββας, Σαββούλα, Διογένης" on 5.12
+small black "Νίκος, Νικολέττα" on 6.12
+small black "Αμβρόσιος" on 7.12
+small black "Άννα" on 9.12
+small black "Ααρών, Αδάμ, Δαυίδ, Δανάη, Εύα, Ισαάκ, Ιώβ, Ραχήλ, Ρουμπίνη" on 11.12
+small black "Σπύρος, Σπυριδούλα" on 12.12
+small black "Ευστράτιος, Λουκάς, Λουκία, Άρης" on 13.12
+small black "Ελευθέριος, Ελευθερία, Ανθή, Σύλβια" on 15.12
+small black "Διονύσης, Διονυσία, Δανιήλ, Ρεβέκα, Σεβαστιανός, Σεβαστή" on 17.12
+small black "Ααρών, Αδάμ, Ισαάκ, Ραχήλ, Σάρα" on 17.12
+small black "Αγλαΐα" on 19.12
+small black "Ιγνάτιος" on 20.12
+small black "Θεμιστοκλής, Ιουλία" on 21.12
+small black "Αναστασία" on 22.12
+small black "Ευγένιος, Ευγενία" on 24.12
+small black "Χρήστος, Χριστίνα, Χρύσα" on 25.12
+weekend "Σύναξις Θεοτόκου (Αργία)" on 26.12
+weekend "Μανώλης, Εμμανουέλα, Δαβίδ" on 26.12
+small black "Στέφανος, Στεφανία" on 27.12
+small black "Δόμνα" on 28.12
+small black "Ιωσήφ" on 30.12
+weekend "Χριστούγεννα (Αργία)" on 25.12
+
+
+: Αργίες - Επέτειοι
+weekend "Πρωτοχρονιά (Αργία)" on 1.1
+weekend "Πρωτομαγιά (Αργία)" on 1.5
+weekend "Επέτειος του ΟΧΙ (Αργία)" 28.10
+weekend "Επέτειος της επανάστασης του 1821 (Αργία)" on 25.3
+small black "Εξέγερση του Πολυτεχνείου (Σχολική Αργία)" on 17.11
+
+: Κινητές εορτές
+
+small black "Τελώνου και Φαρισαίου - Αρχή Τριωδίου" on easter minus 70 days
+small black "Του Ασώτου" on easter minus 63 days
+small black "Τσικνοπέμπτη" on easter minus 59 days
+small black "Κυριακή των Απόκρεω" on easter minus 56 days
+small black "Τυροφάγου" on easter minus 49 days
+small black "Καθαρή Δευτέρα (Αργία)" on easter minus 48 days
+small black "Θεόδωρος, Θεοδώρα, Δώρα, Θώδης, Θώδος, Δώρης" on easter minus 43 days
+small black "Κυριακή της Ορθοδοξίας" on easter minus 42 days
+small black "Σάββατο του Λαζάρου" on easter minus 8 days
+small black "Κυριακή των Βαΐων" on easter minus 7 days
+small black "Μεγάλη Δευτέρα" on easter minus 6 days
+small black "Μεγάλη Τρίτη" on easter minus 5 days
+small black "Μεγάλη Τετάρτη" on easter minus 4 days
+small black "Μεγάλη Πέμπτη" on easter minus 3 days
+weekend "Μεγάλη Παρασκευή (Αργία)" on easter minus 2 days
+weekend "Μεγάλο Σάββατο" on easter minus 1 days
+weekend "Το Άγιον Πάσχα" on easter
+weekend "Δευτέρα του Πάσχα (Αργία)" on easter plus 1 days
+small black "Πηγή, Ζήσης, Ζησούλα, Ζήσιμος, Ζωή, Ζώης" on easter plus 5 days
+small black "Του Θωμά" on easter plus 7 days
+small black "Ανάληψη του Χριστού" on easter plus 39 days
+small black "Πεντηκοστή" on easter plus 49 days
+small black "Αγ. Πνεύματος" on easter plus 50 days
+small black "Αγ. Πάντων" on easter plus 56 days
+
+: Αλλαγή ώρας
+small black "Αλλαγή ώρας (1 ώρα πίσω)" on last sunday in october
+small black "Αλλαγή ώρας (1 ώρα μπροστά) " on last sunday in march
Index: libkholidays/holidays/Makefile.am
===================================================================
--- libkholidays/holidays/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/holidays/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,13 +5,13 @@
                 holiday_ca holiday_catalan holiday_co \
                 holiday_ch holiday_cz holiday_de holiday_dk holiday_ee \
                 holiday_es holiday_fi holiday_fr holiday_frswiss holiday_gb \
-                holiday_gt \
+                holiday_gr holiday_gt \
                 holiday_hu holiday_is holiday_il holiday_it holiday_ja \
                 holiday_lt holiday_mx \
                 holiday_nl \
                 holiday_no holiday_nz holiday_pl holiday_pt holiday_py \
                 holiday_quebec \
-                holiday_ro holiday_ru \ 
+                holiday_ro holiday_ru \
 		holiday_se holiday_si holiday_th holiday_us \
                 holiday_uy holiday_ie \
                 holiday_Suedtirol
Index: libkholidays/kholidays.h
===================================================================
--- libkholidays/kholidays.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkholidays/kholidays.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,6 +41,19 @@
        object.
     */
     static QStringList locations();
+    /**
+       Return the file name for the holiday file of the given location.
+    */
+    static QString fileForLocation( const QString &location );
+    /**
+       Return the directory for user-specific holiday files (i.e. somewhere below
+       $KDEDIR/share/apps/). Don't automatically create that path by default.
+    */
+    static QString userPath( bool create = false );
+    /** 
+       Generate the filename (without the path) for a given region.
+    */
+    static QString generateFileName( const QString &location );
 
     KHolidays( const QString& location );
     ~KHolidays();
Index: plugins/kmail/bodypartformatter/text_calendar.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ plugins/kmail/bodypartformatter/text_calendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -9,6 +9,7 @@
 Name[fa]=Octetstream کاربرد
 Name[fi]=Octetstream-sovellus
 Name[fr]=Application (flux d'octets)
+Name[gl]=Aplicación Octetstream
 Name[hu]=Alkalmazás-adatfolyam
 Name[ja]=アプリケーション オクテット ストリーム
 Name[km]=Octetstream កម្មវិធី
@@ -39,9 +40,10 @@
 Comment[es]=Un accesorio de formato para el cuerpo de text/calendar
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/calendar)
 Comment[eu]=Testu/egutegientzako gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/تقویم
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/تقویم
 Comment[fi]=Muokkausliitännäinen text/calendar-muodolle
 Comment[fr]=Module de formatage pour le text/calendar
+Comment[gl]=Unha extensión para formatear o corpo do texto/calendario
 Comment[hu]=Formázómodul text/calendar adatfolyamok kezeléséhez
 Comment[is]=Sniðmátstól fyrir text/calendar
 Comment[it]=Un plugin per formattare il corpo di text/calendar
Index: plugins/kmail/bodypartformatter/text_vcard.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_vcard.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ plugins/kmail/bodypartformatter/text_vcard.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -9,6 +9,7 @@
 Name[fa]=Octetstream کاربرد
 Name[fi]=Octetstream-sovellus
 Name[fr]=Application (flux d'octets)
+Name[gl]=Aplicación Octetstream
 Name[hu]=Alkalmazás-adatfolyam
 Name[ja]=アプリケーション オクテット ストリーム
 Name[km]=Octetstream កម្មវិធី
@@ -40,9 +41,10 @@
 Comment[es]=Un accesorio de formato para el cuerpo de text/vcard
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/vcard)
 Comment[eu]=Testu/vcard-en gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/vcard
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/vcard
 Comment[fi]=Muokkausliitännäinen text/vcard-muodolle
 Comment[fr]=Un formateur de partie de corps pour text/vcard
+Comment[gl]=Unha extensión para formatear o corpo do texto/vcard
 Comment[hu]=Formázómodul text/vcard adatfolyamok kezeléséhez
 Comment[is]=Sniðmátstól fyrir text/vcard
 Comment[it]=Un plugin per formattare il corpo di text/vcard
Index: plugins/kmail/bodypartformatter/text_xdiff.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -9,6 +9,7 @@
 Name[fa]=Octetstream کاربرد
 Name[fi]=Octetstream-sovellus
 Name[fr]=Application (flux d'octets)
+Name[gl]=Aplicación Octetstream
 Name[hu]=Alkalmazás-adatfolyam
 Name[ja]=アプリケーション オクテット ストリーム
 Name[km]=Octetstream កម្មវិធី
@@ -38,9 +39,10 @@
 Comment[es]=Una extensión de formato para el cuerpo de text/x-diff
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/x-diff)
 Comment[eu]=Testu/x-diff-en gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/x-diff
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/x-diff
 Comment[fi]=Muokkausliitännäinen text/x-diff-muodolle
 Comment[fr]=Un formateur de partie de corps pour text/x-diff
+Comment[gl]=Unha extensión para formatear o corpo do texto/x-diff
 Comment[hu]=Formázómodul text/x-diff adatok kezeléséhez
 Comment[is]=Sniðmátstól fyrir text/x-diff
 Comment[it]=Un plugin per formattare il corpo di text/x-diff
Index: kitchensync/multisynk/multisynk.desktop
===================================================================
--- kitchensync/multisynk/multisynk.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/multisynk/multisynk.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,10 +14,11 @@
 GenericName[es]=Sincronización
 GenericName[et]=Sünkroniseerimine
 GenericName[eu]=Sinkronizazioa
-GenericName[fa]=همگامی‌
+GenericName[fa]=همگامی
 GenericName[fi]=Synkronointi
 GenericName[fr]=Synchronisation
 GenericName[ga]=Sioncrónú
+GenericName[gl]=Sincronización
 GenericName[he]=סינכרון
 GenericName[hu]=Szinkronizáció
 GenericName[is]=Samstilling
Index: kitchensync/kitchensync/debugger/debugger.desktop
===================================================================
--- kitchensync/kitchensync/debugger/debugger.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/debugger/debugger.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fi]=Konnectorin vianjäljitysohjelma
 Name[fr]=Débogueur Konnector
 Name[ga]=Dífhabhtóir Konnector
+Name[gl]=Depuración de Konnector
 Name[hi]=कनेक्टर डिबगर
 Name[hu]=Konnector nyomkövető
 Name[is]=Konnector aflúsun
Index: kitchensync/kitchensync/syncerpart/syncerpart.desktop
===================================================================
--- kitchensync/kitchensync/syncerpart/syncerpart.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/syncerpart/syncerpart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[eu]=Sinkronizatzaile zatia
 Name[fa]=بخش همگام‌ساز
 Name[fr]=Composant de synchronisation
+Name[gl]=Parte Sincronizadora
 Name[he]=רכיב סנכרון
 Name[hi]=सिंक्रोनाइज़र पार्ट
 Name[hu]=Szinkronizáló objektum
Index: kitchensync/kitchensync/viewer/viewer.desktop
===================================================================
--- kitchensync/kitchensync/viewer/viewer.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/viewer/viewer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -12,9 +12,10 @@
 Name[es]=Visor de datos
 Name[et]=Andmete näitaja
 Name[eu]=Data ikustailea
-Name[fa]=مشاهده‌گر داده‌
+Name[fa]=مشاهده‌گر داده
 Name[fi]=Datanäkymä
 Name[fr]=Afficheur de données
+Name[gl]=Visor de Datos
 Name[he]=מציג מידע
 Name[hu]=Adatnézegető
 Name[is]=Gagnaskoðari
Index: kitchensync/kitchensync/plucker/kitchensync-pluck-rdf.desktop
===================================================================
--- kitchensync/kitchensync/plucker/kitchensync-pluck-rdf.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/plucker/kitchensync-pluck-rdf.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fa]=افزودن به وصلۀ KitchenSync Plucker
 Name[fi]=Lisää KitchenSync Plucker -liitännäiseen
 Name[fr]=Ajouter le module Plucker à KitchenSync
+Name[gl]=Engadir á Extensión de KitchenSync Plucker
 Name[hu]=Hozzáadás a KitchenSync Plucker bővítőmodulhoz
 Name[is]=Bæta við KitchenSync Plucker íforritið
 Name[it]=Aggiungi al plugin KitchenSync Plucker
Index: kitchensync/kitchensync/plucker/kitchensync-pluck.desktop
===================================================================
--- kitchensync/kitchensync/plucker/kitchensync-pluck.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/plucker/kitchensync-pluck.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fa]=افزودن به وصلۀ KitchenSync Plucker
 Name[fi]=Lisää KitchenSync Plucker -liitännäiseen
 Name[fr]=Ajouter le module Plucker à KitchenSync
+Name[gl]=Engadir á Extensión de KitchenSync Plucker
 Name[hu]=Hozzáadás a KitchenSync Plucker bővítőmodulhoz
 Name[is]=Bæta við KitchenSync Plucker íforritið
 Name[it]=Aggiungi al plugin KitchenSync Plucker
Index: kitchensync/kitchensync/plucker/plucker.desktop
===================================================================
--- kitchensync/kitchensync/plucker/plucker.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/plucker/plucker.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -7,8 +7,9 @@
 Name[es]=Parte Plucker
 Name[et]=Pluckeri komponent
 Name[eu]=Plucker zatia
-Name[fa]=بخش Plucker 
+Name[fa]=بخش Plucker
 Name[fr]=Composant Plucker
+Name[gl]=Parte Plucker 
 Name[he]=רכיב Plucker
 Name[hu]=Plucker objektum
 Name[is]=Plucker hluti
Index: kitchensync/kitchensync/backup/restore.desktop
===================================================================
--- kitchensync/kitchensync/backup/restore.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/backup/restore.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,9 +11,10 @@
 Name[es]=Konnector para restauración
 Name[et]=Konnectori taastaja
 Name[eu]=Konnector leheneratu
-Name[fa]=بازگردانی Konnector 
+Name[fa]=بازگردانی Konnector
 Name[fi]=Konnectorin palautus
 Name[fr]=Restauration de Konnector
+Name[gl]=Restauración de Konnector
 Name[he]=שחזור של Konnector
 Name[hu]=Konnector helyreállítás
 Name[is]=Konnector endurheimtun
Index: kitchensync/kitchensync/backup/backup.desktop
===================================================================
--- kitchensync/kitchensync/backup/backup.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/backup/backup.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Name[fi]=Konnector-varmuuskopio
 Name[fr]=Sauvegarde Konnector
 Name[ga]=Cúltaca Konnector
+Name[gl]=Salvagarda de Konnector
 Name[he]=גיבוי של Konnector
 Name[hi]=कनेक्टर बैकअप
 Name[hu]=Konnector biztonsági mentés
Index: kitchensync/kitchensync/overview/overview.desktop
===================================================================
--- kitchensync/kitchensync/overview/overview.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/overview/overview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,7 +11,7 @@
 Name[es]=Parte OverView
 Name[et]=Ülevaatekomponent
 Name[eu]=OverView zatia
-Name[fa]=بخش نمای کلی‌
+Name[fa]=بخش نمای کلی
 Name[fr]=Composant d'aperçu
 Name[he]=רכיב סקירה
 Name[hi]=ओवर-व्यू पार्ट
Index: kitchensync/kitchensync/lib/kitchensync.desktop
===================================================================
--- kitchensync/kitchensync/lib/kitchensync.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/lib/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -12,9 +12,10 @@
 Name[es]=Manipulador KitchenSync
 Name[et]=KitchenSync manipulaator
 Name[eu]=KitchenSync manipulatzailea
-Name[fa]=دست‌کاری کنندۀKitchenSync
+Name[fa]=دست‌کاری‌کنندۀKitchenSync
 Name[fi]=KitchenSync-muokkain
 Name[fr]=Utilitaire pour KitchenSync
+Name[gl]=Manipulador KitchenSync
 Name[he]=KitchenSync
 Name[hi]=किचन-सिंक मेनिपुलेटर
 Name[hu]=KitchenSync-kezelő
Index: kitchensync/kitchensync/Makefile.am
===================================================================
--- kitchensync/kitchensync/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/kitchensync/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,3 +15,7 @@
 kitchensync_LDADD = ../libkonnector2/libkonnector.la ./lib/libkitchensyncui.la \
   ../libksync/libksync2.la
 kitchensync_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+
+messages: rc.cpp
+	$(EXTRACTRC) plucker/kspluckerconfigwidget.ui >> rc.cpp
+	$(XGETTEXT) rc.cpp `find . -name \*.h -o -name \*.cpp -o -name \*.c` -o $(podir)/kitchensync.pot
Index: kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,6 +17,7 @@
 Name[fi]=Osoitekirjan Konnector
 Name[fr]=Konnector pour le carnet d'adresses
 Name[ga]=Konnector Leabhar Seoltaí
+Name[gl]=Konnector do Caderno de Enderezos
 Name[he]=רכיב Konnector עבור פנקס הכתובות
 Name[hu]=Címjegyzék-konnektor
 Name[is]=Vistfangaskráar Konnector
Index: kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Conector de demostración para una implementación con hilos
 Name[et]=Konnectori demo
 Name[eu]=Haridun inplementazioetzako eredu Konnector-a
-Name[fa]=Demo Konnector برای یک پیاده‌سازی رشته‌ای‌
+Name[fa]=Demo Konnector برای پیاده‌سازی رشته‌ای
 Name[fi]=Esimerkkiyhteys säikeistetylle toteutukselle
 Name[fr]=Konnector de démonstration pour une implantation avec plusieurs fils d'exécution
+Name[gl]=Konnector de demostración para unha implementación por pólas
 Name[hu]=Demókonnektor többszálú megvalósításra
 Name[is]=Prufu Konnector fyrir fjölþráða útfærslu
 Name[it]=Connettore demo per un'implementazione basata su thread
Index: kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Name[fi]=Kalenterin Konnector
 Name[fr]=Konnector pour l'agenda
 Name[ga]=Konnector Féilirí
+Name[gl]=Konnector do Calendario
 Name[he]=רכיב Konnector עבור לוח שנה
 Name[hu]=Naptár-konnektor
 Name[is]=Dagatals Konnector
Index: kitchensync/libkonnector2/plugins/local/localkonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/local/localkonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/local/localkonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -19,6 +19,7 @@
 Name[fi]= Paikallinen Konnector
 Name[fr]=Konnector local
 Name[ga]=Konnector Logánta
+Name[gl]=Konnector Local
 Name[he]=Konnector מקומי
 Name[hi]=स्थानीय कनेक्टर
 Name[hu]=Helyi konnektor
Index: kitchensync/libkonnector2/plugins/dummy/dummykonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/dummy/dummykonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/dummy/dummykonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Name[fi]=Tyhjä Konnector
 Name[fr]=Konnector factice
 Name[ga]=Konnector Caoch
+Name[gl]=Konnector Simulado
 Name[he]=Konnector טיפש
 Name[hi]=डमी कनेक्टर
 Name[hu]=Üres konnektor
@@ -26,7 +27,7 @@
 Name[km]=Konnector ល្ងីល្ងើ
 Name[ms]=Konnector Kosong
 Name[nb]=Test-Konnector
-Name[nds]=Dummy-Klamp
+Name[nds]=Platzholl-Klamp
 Name[nl]=Lege Konnector
 Name[nn]=Blind-Konnector
 Name[pl]=Nic nierobiący Konnector
Index: kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Name[fi]=Etä-Konnector
 Name[fr]=Konnector distant
 Name[ga]=Konnector Cianda
+Name[gl]=Konnector Remoto
 Name[he]=Konnector מרוחק
 Name[hu]=Távoli konnektor
 Name[is]=Utanaðkomandi Konnector
Index: kitchensync/libkonnector2/plugins/qtopia/qtopia.desktop
===================================================================
--- kitchensync/libkonnector2/plugins/qtopia/qtopia.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/plugins/qtopia/qtopia.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fi]=Qtopia-Konnector
 Name[fr]=Konnector pour Qtopia
 Name[ga]=Konnector Qtopia
+Name[gl]=Konnector Qtopia
 Name[hi]=क्यूटोपिया कनेक्टर
 Name[hu]=Qtopia-konnektor
 Name[nds]=Qtopia-Klamp
Index: kitchensync/libkonnector2/filter.desktop
===================================================================
--- kitchensync/libkonnector2/filter.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/filter.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Comment[fa]=پالایه برای KitchenSync Konnector
 Comment[fi]=Suodin KitchenSync-liitännäiselle
 Comment[fr]=Filtre pour KitchenSync Konnector
+Comment[gl]=Filtro para Konnector KitchenSync
 Comment[he]=תוסף עבור Konnector של KitchenSync
 Comment[hu]=Szűrő a KitchenSync-csatolóhoz
 Comment[is]=Sía fyrir KitchenSync Konnector
Index: kitchensync/libkonnector2/konnector_manager.desktop
===================================================================
--- kitchensync/libkonnector2/konnector_manager.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/konnector_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -8,6 +8,7 @@
 Name[et]=KitchenSynci Konnectorid
 Name[fi]=KitchenSync Konnenctorit
 Name[fr]=Konnectors pour KitchenSync
+Name[gl]=Konnectors KitchenSync
 Name[he]=מחברי KitchenSync
 Name[hu]=KitchenSync-csatolók
 Name[ms]= KitchenSync Konnectors
Index: kitchensync/libkonnector2/filters/calendarfilter.desktop
===================================================================
--- kitchensync/libkonnector2/filters/calendarfilter.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/filters/calendarfilter.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -17,9 +17,10 @@
 Name[es]=Filtro de calendario
 Name[et]=Kalendrifilter
 Name[eu]=Egutegiaren iragazkia
-Name[fa]=پالایۀ تقویم‌
+Name[fa]=پالایۀ تقویم
 Name[fi]=Kalenterisuodin
 Name[fr]=Filtre pour le calendrier
+Name[gl]=Filtro do Calendario
 Name[he]=מסנן לוח שנה
 Name[hu]=Naptárszűrő
 Name[is]=Dagatalssía
@@ -57,13 +58,14 @@
 Comment[es]=Filtra los eventos y las tareas pendientes de un calendario
 Comment[et]=Kalendri sündmuste ja ülesannete filtreerimine
 Comment[eu]=Egutegian gertaerak eta egitekoak iragazten ditu
-Comment[fa]=رویدادهای پالایه‌ها و کارهای انجامی در یک تقویم‌
+Comment[fa]=رویدادهای پالایه‌ها و کارهای انجامی در تقویم‌
 Comment[fi]=Suodattaa kalenterin tapahtumia ja tehtäviä
 Comment[fr]=Permet de filtrer les évènements et les tâches du calendrier
+Comment[gl]=Filtra eventos e tarefas nun calendario
 Comment[he]=מסנן אירועים ומטלות בלוח השנה
 Comment[hu]=Szűrő a naptár eseményeihez és feladataihoz
 Comment[is]=Síar atburði og verkþætti í dagatali
-Comment[it]=Fltra gli eventi e le cose da fare in un calendario
+Comment[it]=Filtra gli eventi e le cose da fare in un calendario
 Comment[ja]=カレンダーのイベントとTo-doをフィルタ
 Comment[km]=ត្រង​ព្រឹត្តិការណ៍ និង ការងារ​ត្រូវ​ធ្វើ នៅ​ក្នុង​ប្រតិទិន​មួយ
 Comment[lt]=Filtruoja įvykius ir užduotis kalendoriuje
Index: kitchensync/libkonnector2/filters/Makefile.am
===================================================================
--- kitchensync/libkonnector2/filters/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/filters/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,3 +15,6 @@
 ksfilterdata_DATA = addressbookfilter.desktop calendarfilter.desktop
 
 METASOURCES = AUTO
+
+messages: rc.cpp
+	$(XGETTEXT) *.cpp *.h -o $(podir)/libkitchensync.pot
Index: kitchensync/libkonnector2/filters/addressbookfilter.desktop
===================================================================
--- kitchensync/libkonnector2/filters/addressbookfilter.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/filters/addressbookfilter.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -20,6 +20,7 @@
 Name[fa]=پالایۀ کتاب نشانی
 Name[fi]=Osoitekirjasuodin
 Name[fr]=Filtre pour le carnet d'adresses
+Name[gl]=Filtro do Caderno de Enderezos
 Name[he]=מסנן פנקס כתובות
 Name[hu]=Címjegyzékszűrő
 Name[is]=Sía fyrir vistfangaskrá
@@ -57,9 +58,10 @@
 Comment[es]=Filtra los contactos de la libreta de direcciones
 Comment[et]=Kontaktide filtreerimine aadressiraamatus
 Comment[eu]=Helbide-liburuko kontaktuak iragazten ditu
-Comment[fa]=تماسهای پالایه‌ها در یک کتاب نشانی‌
+Comment[fa]=تماسهای پالایه‌ها در کتاب نشانی‌
 Comment[fi]=Suodattaa kontakteja osoitekirjassa
 Comment[fr]=Permet de filtrer les contacts du carnet d'adresses
+Comment[gl]=Filtra contactos nun caderno de enderezos
 Comment[he]=מסנן אנשי קשר בפנקס הכתובות
 Comment[hu]=Szűrési lehetőség a címjegyzékben
 Comment[is]=Síar tengiliði í vistfangaskrá
Index: kitchensync/libkonnector2/konnector.desktop
===================================================================
--- kitchensync/libkonnector2/konnector.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libkonnector2/konnector.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,9 +15,10 @@
 Comment[es]=Konnector para definiciones
 Comment[et]=Konnectori definitsioonid
 Comment[eu]=Konnector definizioak
-Comment[fa]=تعاریف Konnector 
+Comment[fa]=تعاریف Konnector
 Comment[fi]=Konnectorin määritykset
 Comment[fr]=Description de Konnector
+Comment[gl]=Definicións de Konnector
 Comment[he]=הגדרות Konnector
 Comment[hr]=Definicije Konnector-a
 Comment[hu]=Konnektordefiníciók
Index: kitchensync/libksync/Makefile.am
===================================================================
--- kitchensync/libksync/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kitchensync/libksync/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,3 +32,6 @@
 noinst_HEADERS    = debug.h
 
 METASOURCES = AUTO
+
+messages: rc.cpp
+	$(XGETTEXT) *.cpp *.h -o $(podir)/libksync.pot
Index: libkdepim/addresseelineedit.h
===================================================================
--- libkdepim/addresseelineedit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/addresseelineedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,7 +35,7 @@
 #include <kabc/addressee.h>
 
 #include "clicklineedit.h"
-#include "kcompletion.h"
+#include "kmailcompletion.h"
 #include <dcopobject.h>
 #include <kdepimmacros.h>
 
@@ -108,6 +108,7 @@
   private slots:
     void slotCompletion();
     void slotPopupCompletion( const QString& );
+    void slotReturnPressed( const QString& );
     void slotStartLDAPLookup();
     void slotLDAPSearchData( const KPIM::LdapResultList& );
     void slotEditCompletionOrder();
@@ -120,9 +121,10 @@
     void stopLDAPLookup();
 
     void setCompletedItems( const QStringList& items, bool autoSuggest );
-    void addCompletionItem( const QString& string, int weight, int source );
+    void addCompletionItem( const QString& string, int weight, int source, const QStringList * keyWords=0 );
     QString completionSearchText( QString& );
     const QStringList getAdjustedCompletionItems( bool fullSearch );
+    void updateSearchString();
 
     QString m_previousAddresses;
     QString m_searchString;
@@ -130,11 +132,13 @@
     bool m_completionInitialized;
     bool m_smartPaste;
     bool m_addressBookConnected;
+    bool m_lastSearchMode;
+    bool m_searchExtended; //has \" been added?
 
     //QMap<QString, KABC::Addressee> m_contactMap;
 
     static bool s_addressesDirty;
-    static KCompletion *s_completion;
+    static KMailCompletion *s_completion;
     static CompletionItemsMap* s_completionItemMap;
     static QTimer *s_LDAPTimer;
     static KPIM::LdapSearch *s_LDAPSearch;
@@ -144,6 +148,20 @@
 
     class AddresseeLineEditPrivate;
     AddresseeLineEditPrivate *d;
+
+    //until MenuID moves into protected in KLineEdit, we keep a copy here
+    //Constants that represent the ID's of the popup menu.
+      enum MenuID
+      {
+        Default = 42,
+        NoCompletion,
+        AutoCompletion,
+        ShellCompletion,
+        PopupCompletion,
+        ShortAutoCompletion,
+        PopupAutoCompletion
+      };
+
 };
 
 }
Index: libkdepim/categoryeditdialog.cpp
===================================================================
--- libkdepim/categoryeditdialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/categoryeditdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -76,6 +76,7 @@
   }
   mWidget->mButtonRemove->setEnabled( categoriesExist );
   mWidget->mCategories->setSelected( mWidget->mCategories->firstChild(), true );
+  mWidget->mEdit->setText( mWidget->mCategories->currentItem()->text( 0 ) );
 }
 
 void CategoryEditDialog::slotTextChanged(const QString &text)
Index: libkdepim/kmailcompletion.h
===================================================================
--- libkdepim/kmailcompletion.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkdepim/kmailcompletion.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,78 @@
+/*
+    This file is part of libkdepim.
+
+    Copyright (c) 2006 Christian Schaarschmidt <schaarsc@gmx.de>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KPIM_KMAILCOMPLETION_H
+#define KPIM_KMAILCOMPLETION_H
+
+#include <qmap.h>
+#include <qstringlist.h>
+#include "kcompletion.h"
+
+
+namespace KPIM {
+
+/**
+ * KMailCompletion allows lookup of email addresses by keyword.
+ * Typically a keywods would be firstname, lastname, nickname or domain. 
+ */
+class KMailCompletion : public KCompletion
+{
+  Q_OBJECT
+
+  public:
+    KMailCompletion();
+
+    /**
+     * Clears internal keyword map and calls KCompletion::clear.
+     */
+    virtual void clear();
+
+    /**
+     * Uses KCompletion::makeCompletion to find email addresses which starts with string.
+     * ignores keywords.
+     *
+     * @returns email address
+     */
+    QString makeCompletion( const QString &string );
+
+    /**
+     * Specify keywords for email.
+     *
+     * Items may be added with KCompletion::addItem, those will only be returned as match if they
+     * are in one of these formats:
+     * \li contains localpart@domain 
+     * \li contains <email>
+     * or if they have also been added with this function.
+     */
+    void addItemWithKeys( const QString& email, int weight, const QStringList * keyWords);
+
+    /**
+     * Uses an internal map to replace all keywords in pMatches whith corrsesponding email addresses.
+     */
+    virtual void postProcessMatches( QStringList * pMatches )const;
+
+  private:
+    QMap< QString, QStringList > m_keyMap;
+};
+
+}
+
+#endif
Index: libkdepim/kfoldertree.cpp
===================================================================
--- libkdepim/kfoldertree.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/kfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -65,14 +65,16 @@
     return 4;
   case Drafts:
     return 5;
+  case Templates:
+    return 6;
   case Calendar:
-    return 6;
+    return 7;
   case Contacts:
-    return 7;
+    return 8;
   case Notes:
-    return 8;
+    return 9;
   case Tasks:
-    return 9;
+    return 10;
   default:
     return 42;
   }
Index: libkdepim/kmailcompletion.cpp
===================================================================
--- libkdepim/kmailcompletion.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkdepim/kmailcompletion.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,103 @@
+/*
+    This file is part of libkdepim.
+
+    Copyright (c) 2006 Christian Schaarschmidt <schaarsc@gmx.de>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "kmailcompletion.h"
+#include <kdebug.h>
+
+#include <qregexp.h>
+
+using namespace KPIM;
+
+KMailCompletion::KMailCompletion()
+{
+	setIgnoreCase( true );
+}
+
+void KMailCompletion::clear()
+{
+  m_keyMap.clear();
+  KCompletion::clear();
+}
+
+QString KMailCompletion::makeCompletion( const QString &string )
+{
+  QString match = KCompletion::makeCompletion( string );
+
+  // this should be in postProcessMatch, but postProcessMatch is const and will not allow nextMatch
+  if ( !match.isEmpty() ){
+    const QString firstMatch( match );
+    while ( match.find( QRegExp( "(@)|(<.*>)" ) ) == -1 ) {
+      /* local email do not require @domain part, if match is an address we'll find
+       * last+first <match> in m_keyMap and we'll know that match is already a valid email.
+       *
+       * Distribution list do not have last+first <match> entry, they will be in mailAddr
+       */
+      const QStringList &mailAddr = m_keyMap[ match ]; //get all mailAddr for this keyword
+      bool isEmail = false;
+      for ( QStringList::ConstIterator sit ( mailAddr.begin() ), sEnd( mailAddr.end() ); sit != sEnd; ++sit )
+        if ( (*sit).find( "<" + match + ">" ) != -1 || (*sit) == match ) {
+          isEmail = true;
+          break;
+        }
+
+      if ( !isEmail ) {
+        // match is a keyword, skip it and try to find match <email@domain>
+        match = nextMatch();
+        if ( firstMatch == match ){
+          match = QString::null;
+          break;
+        }
+      } else
+        break;
+    }
+  }
+  return match;
+}
+
+void KMailCompletion::addItemWithKeys( const QString& email, int weight, const QStringList*  keyWords)
+{
+  Q_ASSERT( keyWords != 0 );
+  for ( QStringList::ConstIterator it( keyWords->begin() ); it != keyWords->end(); ++it ) {
+    QStringList &emailList = m_keyMap[ (*it) ];      //lookup email-list for given keyword
+    if ( emailList.find( email ) == emailList.end() ) //add email if not there
+      emailList.append( email );
+    addItem( (*it),weight );                         //inform KCompletion about keyword
+    }
+}
+
+void KMailCompletion::postProcessMatches( QStringList * pMatches )const
+{
+  Q_ASSERT( pMatches != 0 );
+  if ( pMatches->isEmpty() )
+    return;
+
+  //KCompletion has found the keywords for us, we can now map them to mail-addr
+  QMap< QString, bool > mailAddrDistinct; //TODO replace with QSet in KDE4
+  for ( QStringList::ConstIterator sit ( pMatches->begin() ), sEnd( pMatches->end() ); sit != sEnd; ++sit ) {
+    const QStringList &mailAddr = m_keyMap[ (*sit) ]; //get all mailAddr for this keyword
+    for ( QStringList::ConstIterator sit ( mailAddr.begin() ), sEnd( mailAddr.end() ); sit != sEnd; ++sit ) {
+      mailAddrDistinct[ (*sit) ] = true;  //store mailAddr, QMap will make them unique
+    }
+  }
+  pMatches->clear();                      //delete keywords
+  (*pMatches) += mailAddrDistinct.keys(); //add emailAddr
+}
+#include "kmailcompletion.moc"
Index: libkdepim/komposer/plugins/default/defaulteditor.desktop
===================================================================
--- libkdepim/komposer/plugins/default/defaulteditor.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/komposer/plugins/default/defaulteditor.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,6 +31,7 @@
 Name[fi]=Komposer-muokkain
 Name[fr]=Éditeur Komposer
 Name[ga]=Eagarthóir Komposer
+Name[gl]=Editor Komposer
 Name[hu]=Komposer szerkesztő
 Name[is]=Komposer ritill
 Name[it]=Editor Komposer
@@ -69,6 +70,7 @@
 Comment[fi]=Komposer oletusmuokkain
 Comment[fr]=Éditeur Komposer par défaut
 Comment[ga]=Eagarthóir réamhshocraithe Komposer
+Comment[gl]=Editor por defecto Komposer
 Comment[he]=עורך ברירת מחדל של Kompoer
 Comment[hu]=A Komposer alapértelmezett szerkesztője
 Comment[is]=Sjálfgefinn ritill Komposer
Index: libkdepim/Makefile.am
===================================================================
--- libkdepim/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,7 +35,7 @@
   embeddedurlpage.cpp kincidencechooser.cpp \
   groupwarejob.cpp pimemoticons.kcfgc \
   krsqueezedtextlabel.cpp csshelper.cpp distributionlist.cpp \
-  kpimurlrequesterdlg.cpp sendsmsdialog.cpp
+  kpimurlrequesterdlg.cpp sendsmsdialog.cpp kmailcompletion.cpp
 
 MailTransportServiceIface_DCOPIDLNG = true
 MailTransportServiceIface_DIR = $(srcdir)/interfaces
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -61,7 +61,7 @@
 
 using namespace KPIM;
 
-KCompletion * AddresseeLineEdit::s_completion = 0L;
+KMailCompletion * AddresseeLineEdit::s_completion = 0L;
 KPIM::CompletionItemsMap* AddresseeLineEdit::s_completionItemMap = 0L;
 QStringList* AddresseeLineEdit::s_completionSources = 0L;
 bool AddresseeLineEdit::s_addressesDirty = false;
@@ -70,7 +70,7 @@
 QString* AddresseeLineEdit::s_LDAPText = 0L;
 AddresseeLineEdit* AddresseeLineEdit::s_LDAPLineEdit = 0L;
 
-static KStaticDeleter<KCompletion> completionDeleter;
+static KStaticDeleter<KMailCompletion> completionDeleter;
 static KStaticDeleter<KPIM::CompletionItemsMap> completionItemsDeleter;
 static KStaticDeleter<QTimer> ldapTimerDeleter;
 static KStaticDeleter<KPIM::LdapSearch> ldapSearchDeleter;
@@ -110,7 +110,7 @@
 void AddresseeLineEdit::init()
 {
   if ( !s_completion ) {
-    completionDeleter.setObject( s_completion, new KCompletion() );
+    completionDeleter.setObject( s_completion, new KMailCompletion() );
     s_completion->setOrder( completionOrder() );
     s_completion->setIgnoreCase( true );
 
@@ -138,6 +138,8 @@
       setCompletionObject( s_completion, false );
       connect( this, SIGNAL( completion( const QString& ) ),
           this, SLOT( slotCompletion() ) );
+      connect( this, SIGNAL( returnPressed( const QString& ) ),
+          this, SLOT( slotReturnPressed( const QString& ) ) );
 
       KCompletionBox *box = completionBox();
       connect( box, SIGNAL( highlighted( const QString& ) ),
@@ -177,12 +179,15 @@
   bool accept = false;
 
   if ( KStdAccel::shortcut( KStdAccel::SubstringCompletion ).contains( KKey( e ) ) ) {
+    //TODO: add LDAP substring lookup, when it becomes available in KPIM::LDAPSearch
+    updateSearchString();
     doCompletion( true );
     accept = true;
   } else if ( KStdAccel::shortcut( KStdAccel::TextCompletion ).contains( KKey( e ) ) ) {
     int len = text().length();
 
     if ( len == cursorPosition() ) { // at End?
+      updateSearchString();
       doCompletion( true );
       accept = true;
     }
@@ -192,11 +197,17 @@
     KLineEdit::keyPressEvent( e );
 
   if ( e->isAccepted() ) {
+    updateSearchString();
+    QString searchString( m_searchString );
+    //LDAP does not know about our string manipulation, remove it
+    if ( m_searchExtended )
+        searchString = m_searchString.mid( 1 );
+
     if ( m_useCompletion && s_LDAPTimer != NULL ) {
-      if ( *s_LDAPText != text() || s_LDAPLineEdit != this )
+      if ( *s_LDAPText != searchString || s_LDAPLineEdit != this )
         stopLDAPLookup();
 
-      *s_LDAPText = text();
+      *s_LDAPText = searchString;
       s_LDAPLineEdit = this;
       s_LDAPTimer->start( 500, true );
     }
@@ -350,7 +361,11 @@
 
 void AddresseeLineEdit::doCompletion( bool ctrlT )
 {
-  if ( !m_useCompletion )
+  m_lastSearchMode = ctrlT;
+
+  KGlobalSettings::Completion  mode = completionMode();
+
+  if ( mode == KGlobalSettings::CompletionNone  )
     return;
 
   if ( s_addressesDirty ) {
@@ -370,10 +385,10 @@
     setCompletedItems( completions, true ); // this makes sure the completion popup is closed if no matching items were found
 
     cursorAtEnd();
+    setCompletionMode( mode ); //set back to previous mode
     return;
   }
 
-  KGlobalSettings::Completion  mode = completionMode();
 
   switch ( mode ) {
     case KGlobalSettings::CompletionPopupAuto:
@@ -385,15 +400,7 @@
     case KGlobalSettings::CompletionPopup:
     {
       const QStringList items = getAdjustedCompletionItems( true );
-      bool autoSuggest = !items.isEmpty() && (mode != KGlobalSettings::CompletionPopupAuto);
-      setCompletedItems( items, autoSuggest );
-
-      if ( !autoSuggest ) {
-        int index = items.first().find( m_searchString );
-        QString newText = m_previousAddresses + items.first().mid( index ).stripWhiteSpace();
-        setUserSelection( false );
-        setCompletedText( newText, true );
-      }
+      setCompletedItems( items, false );
       break;
     }
 
@@ -411,14 +418,51 @@
     case KGlobalSettings::CompletionMan: // Short-Auto in fact
     case KGlobalSettings::CompletionAuto:
     {
+      //force autoSuggest in KLineEdit::keyPressed or setCompletedText will have no effect
+      setCompletionMode( completionMode() );
+
       if ( !m_searchString.isEmpty() ) {
+        
+        //if only our \" is left, remove it since user has not typed it either
+        if ( m_searchExtended && m_searchString == "\"" ){
+          m_searchExtended = false;
+          m_searchString = QString::null;
+          setText( m_previousAddresses );
+          break;
+        }
+
         QString match = s_completion->makeCompletion( m_searchString );
-        if ( !match.isNull() && match != m_searchString ) {
-          QString adds = m_previousAddresses + match;
-          setCompletedText( adds );
+
+        if ( !match.isEmpty() ) {
+          if ( match != m_searchString ) {
+            QString adds = m_previousAddresses + match;
+            setCompletedText( adds );
+          } 
+        } else {
+          if ( !m_searchString.startsWith( "\"" ) ) {
+            //try with quoted text, if user has not type one already
+            match = s_completion->makeCompletion( "\"" + m_searchString );
+            if ( !match.isEmpty() && match != m_searchString ) {
+              m_searchString = "\"" + m_searchString;
+              m_searchExtended = true;
+              setText( m_previousAddresses + m_searchString );
+              setCompletedText( m_previousAddresses + match );
+            }
+          } else if ( m_searchExtended ) {
+            //our added \" does not work anymore, remove it
+            m_searchString = m_searchString.mid( 1 );
+            m_searchExtended = false;
+            setText( m_previousAddresses + m_searchString );
+            //now try again
+            match = s_completion->makeCompletion( m_searchString );
+            if ( !match.isEmpty() && match != m_searchString ) {
+              QString adds = m_previousAddresses + match;
+              setCompletedText( adds );
+            }
+          }
         }
-        break;
       }
+      break;
     }
 
     case KGlobalSettings::CompletionNone:
@@ -434,6 +478,14 @@
 //  slotMatched( m_previousAddresses + completion );
 }
 
+void AddresseeLineEdit::slotReturnPressed( const QString& item )
+{
+  Q_UNUSED( item );
+  QListBoxItem* i = completionBox()->selectedItem();
+  if ( i != 0 )
+    slotPopupCompletion( i->text() );
+}
+
 void AddresseeLineEdit::loadContacts()
 {
   s_completion->clear();
@@ -486,7 +538,14 @@
   QStringList::const_iterator listIt;
   int idx = addCompletionSource( i18n( "Distribution Lists" ) );
   for ( listIt = distLists.begin(); listIt != distLists.end(); ++listIt ) {
+
+    //for KGlobalSettings::CompletionAuto
     addCompletionItem( (*listIt).simplifyWhiteSpace(), weight, idx );
+
+    //for CompletionShell, CompletionPopup
+    QStringList sl( (*listIt).simplifyWhiteSpace() );
+    addCompletionItem( (*listIt).simplifyWhiteSpace(), weight, idx, &sl );
+
   }
 #endif
 
@@ -503,7 +562,14 @@
 #ifdef KDEPIM_NEW_DISTRLISTS
   if ( KPIM::DistributionList::isDistributionList( addr ) ) {
     //kdDebug(5300) << "AddresseeLineEdit::addContact() distribution list \"" << addr.formattedName() << "\" weight=" << weight << endl;
+ 
+    //for CompletionAuto
     addCompletionItem( addr.formattedName(), weight, source );
+
+    //for CompletionShell, CompletionPopup
+    QStringList sl( addr.formattedName() );
+    addCompletionItem( addr.formattedName(), weight, source, &sl );
+
     return;
   }
 #endif
@@ -511,18 +577,63 @@
   const QStringList emails = addr.emails();
   QStringList::ConstIterator it;
   for ( it = emails.begin(); it != emails.end(); ++it ) {
+    //TODO: highlight preferredEmail 
+    const QString email( (*it) );
+    const QString givenName = addr.givenName();
+    const QString familyName= addr.familyName();
+    const QString nickName  = addr.nickName();
+    const QString fullEmail = addr.fullEmail( email );
+    const QString domain    = email.mid( email.find( '@' ) + 1 );
+    //TODO: let user decide what fields to use in lookup, e.g. company, city, ...
 
-    if ( addr.givenName().isEmpty() && addr.familyName().isEmpty() ) {
-      addCompletionItem( addr.fullEmail( (*it) ), weight, source ); // use whatever is there
+    //for CompletionAuto
+    if ( givenName.isEmpty() && familyName.isEmpty() ) {
+      addCompletionItem( fullEmail, weight, source ); // use whatever is there
     } else {
-      const QString byFirstName= KPIM::quoteNameIfNecessary( addr.givenName() + " " + addr.familyName() ) + " <" + (*it) + ">";
-      const QString byLastName= "\"" + addr.familyName() + ", " + addr.givenName() + "\" "  + "<" + (*it) + ">";
-      const QString byEmail= (*it) + " (" + KPIM::quoteNameIfNecessary( addr.realName() ) + ")";
+      const QString byFirstName=  "\"" + givenName + " " + familyName + "\" <" + email + ">";
+      const QString byLastName =  "\"" + familyName + ", " + givenName + "\" <" + email + ">";
       addCompletionItem( byFirstName, weight, source );
       addCompletionItem( byLastName, weight, source );
-      addCompletionItem( byEmail, weight, source );
     }
 
+    addCompletionItem( email, weight, source );
+
+    if ( !nickName.isEmpty() ){
+      const QString byNick     =  "\"" + nickName + "\" <" + email + ">";
+      addCompletionItem( byNick, weight, source );
+    }
+
+    if ( !domain.isEmpty() ){
+      const QString byDomain   =  "\"" + domain + " " + familyName + " " + givenName + "\" <" + email + ">";
+      addCompletionItem( byDomain, weight, source );
+    }
+    
+    //for CompletionShell, CompletionPopup
+    QStringList keyWords;
+    const QString realName  = addr.realName();
+
+    if ( !givenName.isEmpty() && !familyName.isEmpty() ) {
+      keyWords.append( givenName  + " "  + familyName );
+      keyWords.append( familyName + " "  + givenName );
+      keyWords.append( familyName + ", " + givenName);
+    }else if ( !givenName.isEmpty() )
+      keyWords.append( givenName );
+    else if ( !familyName.isEmpty() )
+      keyWords.append( familyName );
+
+    if ( !nickName.isEmpty() )
+      keyWords.append( nickName );
+
+    if ( !realName.isEmpty() )
+      keyWords.append( realName );
+
+    if ( !domain.isEmpty() )
+      keyWords.append( domain );
+
+    keyWords.append( email );
+
+    addCompletionItem( fullEmail, weight, source, &keyWords );
+
 #if 0
     int len = (*it).length();
     if ( len == 0 ) continue;
@@ -574,7 +685,7 @@
   }
 }
 
-void AddresseeLineEdit::addCompletionItem( const QString& string, int weight, int completionItemSource )
+void AddresseeLineEdit::addCompletionItem( const QString& string, int weight, int completionItemSource, const QStringList * keyWords )
 {
   // Check if there is an exact match for item already, and use the max weight if so.
   // Since there's no way to get the information from KCompletion, we have to keep our own QMap
@@ -585,7 +696,10 @@
   } else {
     s_completionItemMap->insert( string, qMakePair( weight, completionItemSource ) );
   }
-  s_completion->addItem( string, weight );
+  if ( keyWords == 0 )
+    s_completion->addItem( string, weight );
+  else
+    s_completion->addItemWithKeys( string, weight, keyWords );
 }
 
 void AddresseeLineEdit::slotStartLDAPLookup()
@@ -636,9 +750,12 @@
     addContact( addr, (*it).completionWeight, (*it ).clientNumber  );
   }
 
-  if ( hasFocus() || completionBox()->hasFocus() )
-    if ( completionMode() != KGlobalSettings::CompletionNone )
-      doCompletion( false );
+  if ( (hasFocus() || completionBox()->hasFocus() )
+       && completionMode() != KGlobalSettings::CompletionNone 
+       && completionMode() != KGlobalSettings::CompletionShell) {
+    setText( m_previousAddresses + m_searchString );
+    doCompletion( m_lastSearchMode );
+  }
 }
 
 void AddresseeLineEdit::setCompletedItems( const QStringList& items, bool autoSuggest )
@@ -648,25 +765,11 @@
     if ( !items.isEmpty() &&
          !(items.count() == 1 && m_searchString == items.first()) )
     {
-        if ( completionBox->isVisible() )
-        {
-          bool wasSelected = completionBox->isSelected( completionBox->currentItem() );
-          const QString currentSelection = completionBox->currentText();
-          completionBox->setItems( items );
-          QListBoxItem* item = completionBox->findItem( currentSelection, Qt::ExactMatch );
-          if ( item )
-          {
-            completionBox->blockSignals( true );
-            completionBox->setCurrentItem( item );
-            completionBox->setSelected( item, wasSelected );
-            completionBox->blockSignals( false );
-          }
-        }
-        else // completion box not visible yet -> show it
-        {
+        completionBox->setItems( items );
+
+        if ( !completionBox->isVisible() ) {
           if ( !m_searchString.isEmpty() )
             completionBox->setCancelledText( m_searchString );
-          completionBox->setItems( items );
           completionBox->popup();
           // we have to install the event filter after popup(), since that 
           // calls show(), and that's where KCompletionBox installs its filter.
@@ -675,6 +778,14 @@
             qApp->installEventFilter( this );
         }
 
+        QListBoxItem* item = completionBox->item( 1 );
+        if ( item )
+        {
+          completionBox->blockSignals( true );
+          completionBox->setSelected( item, true );
+          completionBox->blockSignals( false );
+        }
+
         if ( autoSuggest )
         {
             int index = items.first().find( m_searchString );
@@ -687,6 +798,7 @@
     {
         if ( completionBox && completionBox->isVisible() ) {
             completionBox->hide();
+            completionBox->setItems( QStringList() );
         }
     }
 }
@@ -697,9 +809,12 @@
   if ( !menu )
     return 0;
 
-  if ( m_useCompletion )
+  if ( m_useCompletion ){
+    menu->setItemVisible( ShortAutoCompletion, false );
+    menu->setItemVisible( PopupAutoCompletion, false );
     menu->insertItem( i18n( "Configure Completion Order..." ),
                       this, SLOT( slotEditCompletionOrder() ) );
+  }
   return menu;
 }
 
@@ -720,12 +835,11 @@
 {
   if ( s_LDAPSearch && s_LDAPLineEdit == this )
     stopLDAPLookup();
-  userCancelled( cancelText ); // in KLineEdit
+  userCancelled( m_previousAddresses + cancelText ); // in KLineEdit
 }
 
-void KPIM::AddresseeLineEdit::slotCompletion()
+void AddresseeLineEdit::updateSearchString()
 {
-  // Called by KLineEdit's keyPressEvent -> new text, update search string
   m_searchString = text();
   int n = m_searchString.findRev(',');
   if ( n >= 0 ) {
@@ -744,6 +858,13 @@
   {
     m_previousAddresses = QString::null;
   }
+}
+
+void KPIM::AddresseeLineEdit::slotCompletion()
+{
+  // Called by KLineEdit's keyPressEvent for CompletionModes Auto,Popup -> new text, update search string
+  // not called for CompletionShell, this is been taken care of in AddresseeLineEdit::keyPressEvent
+  updateSearchString();
   if ( completionBox() )
     completionBox()->setCancelledText( m_searchString );
   doCompletion( false );
@@ -821,7 +942,7 @@
       // to ignore. If so, go one further
       QListBoxItem *itemAbove = completionBox()->item( currentIndex - 1 );
       if ( itemAbove && !itemAbove->text().startsWith( s_completionItemIndentString ) ) {
-        // there is a header above is, check if there is even further up
+        // there is a header above us, check if there is even further up
         // and if so go one up, so it'll be selected
         if ( currentIndex > 1 && completionBox()->item( currentIndex - 2 ) ) {
           //kdDebug() << "EVENTFILTER: Key_Up -> skipping " << currentIndex - 1 << endl;
@@ -831,6 +952,7 @@
             // nothing to skip to, let's stay where we are, but make sure the
             // first header becomes visible, if we are the first real entry
             completionBox()->ensureVisible( 0, 0 );
+            completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
@@ -845,9 +967,14 @@
           completionBox()->setSelected( currentIndex + 2, true );
         } else {
           // nothing to skip to, let's stay where we are
+          completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
+      // special case of the last and only item in the list needing selection
+      if ( !itemBelow && currentIndex == 1 ) {
+        completionBox()->setSelected( currentIndex, true );
+      }
       // special case of the initial selection, which is unfortunately a header.
       // Setting it to selected tricks KCompletionBox into not treating is special
       // and selecting making it current, instead of the one below.
@@ -865,15 +992,7 @@
   QStringList items = fullSearch ?
     s_completion->allMatches( m_searchString )
     : s_completion->substringCompletion( m_searchString );
-  if ( fullSearch )
-    items += s_completion->allMatches( "\"" + m_searchString );
-  unsigned int beforeDollarCompletionCount = items.count();
-
-  if ( fullSearch && m_searchString.find( ' ' ) == -1 ) // one word, possibly given name
-    items += s_completion->allMatches( "$$" + m_searchString );
-
-  // kdDebug(5300) << "     AddresseeLineEdit::doCompletion() found: " << items.join(" AND ") << endl;
-
+ 
   int lastSourceIndex = -1;
   unsigned int i = 0;
   QMap<int, QStringList> sections;
@@ -894,13 +1013,6 @@
     }
     sections[idx].append( *it );
 
-      if ( i > beforeDollarCompletionCount ) { 
-      // remove the '$$whatever$' part
-      int pos = (*it).find( '$', 2 );
-      if ( pos < 0 ) // ???
-        continue;
-      (*it) = (*it).mid( pos + 1 );
-    }
     if ( s_completion->order() == KCompletion::Sorted ) {
       sortedItems.append( *it );
     }
Index: libkdepim/linklocator.cpp
===================================================================
--- libkdepim/linklocator.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkdepim/linklocator.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -96,8 +96,8 @@
     {
       ++mPos;
     }
-    /* some URLs really end with:  # / &     */
-    const QString allowedSpecialChars = QString("#/&");
+    /* some URLs really end with:  # / & - _    */
+    const QString allowedSpecialChars = QString("#/&-_");
     while(mPos > start && mText[mPos-1].isPunct() &&
 		    allowedSpecialChars.find(mText[mPos-1]) == -1 )
     {
Index: libkcal/localdir.desktop
===================================================================
--- libkcal/localdir.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/localdir.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,10 +14,11 @@
 Name[es]=Calendario en el directorio local
 Name[et]=Kalender kohalikus kataloogis
 Name[eu]=Egutegia direktorio lokalean
-Name[fa]=تقویم در فهرست راهنمای محلی‌
+Name[fa]=تقویم در فهرست راهنمای محلی
 Name[fi]=Kalenteri paikallisessa kansiossa
 Name[fr]=Calendrier dans un dossier local
 Name[ga]=Féilire i gComhadlann Logánta
+Name[gl]=Calendario nun Cartafol Local
 Name[hi]=स्थानीय डिरेक्ट्री में कैलेन्डर
 Name[hu]=Helyi könyvtárban tárolt naptár
 Name[is]=Dagatal í staðbundinni möppu
@@ -34,7 +35,7 @@
 Name[pt]=Calendário numa Directoria Local
 Name[pt_BR]=Calendário em Diretório Local
 Name[ro]=Calendar în director local
-Name[ru]=Календарь в локальном каталоге
+Name[ru]=Календарь в локальной папке
 Name[sk]=Kalendár v lokálnom priečinku
 Name[sl]=Koledar v krajevnem imeniku
 Name[sr]=Календар у локалном директоријуму
Index: libkcal/incidencebase.h
===================================================================
--- libkcal/incidencebase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/incidencebase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -252,6 +252,12 @@
     void updated();
 
   protected:
+    /**
+      @copydoc
+      CustomProperties::customPropertyUpdated()
+    */
+    virtual void customPropertyUpdated();
+
     bool mReadOnly;
 
   private:
Index: libkcal/local.desktop
===================================================================
--- libkcal/local.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,10 +14,11 @@
 Name[es]=Calendario en archivo local
 Name[et]=Kalender kohalikus failis
 Name[eu]=Egutegia fitxategi lokalean
-Name[fa]=تقویم در پروندۀ محلی‌
+Name[fa]=تقویم در پروندۀ محلی
 Name[fi]=Kalenteri paikallisessa tiedostossa
 Name[fr]=Calendrier dans un fichier local
 Name[ga]=Féilire i gComhad Logánta
+Name[gl]=Calendario nun Ficheiro Local
 Name[hi]=स्थानीय फ़ाइल में कैलेन्डर
 Name[hu]=Helyi fájlban tárolt naptár
 Name[is]=Dagatal í staðbundinni skrá
Index: libkcal/customproperties.cpp
===================================================================
--- libkcal/customproperties.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/customproperties.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
     This file is part of libkcal.
 
-    Copyright (c) 2002 David Jarvie <software@astrojar.org.uk>
+    Copyright (c) 2002,2006 David Jarvie <software@astrojar.org.uk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -64,6 +64,7 @@
   if (!checkName(property))
     return;
   mProperties[property] = value;
+  customPropertyUpdated();
 }
 
 void CustomProperties::removeCustomProperty(const QCString &app, const QCString &key)
@@ -81,13 +82,16 @@
   if (value.isNull() || !checkName(name))
     return;
   mProperties[name] = value;
+  customPropertyUpdated();
 }
 
 void CustomProperties::removeNonKDECustomProperty(const QCString &name)
 {
   QMap<QCString, QString>::Iterator it = mProperties.find(name);
-  if (it != mProperties.end())
+  if (it != mProperties.end()) {
     mProperties.remove(it);
+    customPropertyUpdated();
+  }
 }
 
 QString CustomProperties::nonKDECustomProperty(const QCString &name) const
@@ -100,12 +104,16 @@
 
 void CustomProperties::setCustomProperties(const QMap<QCString, QString> &properties)
 {
+  bool changed = false;
   for (QMap<QCString, QString>::ConstIterator it = properties.begin();  it != properties.end();  ++it) {
     // Validate the property name and convert any null string to empty string
     if (checkName(it.key())) {
       mProperties[it.key()] = it.data().isNull() ? QString("") : it.data();
+      changed = true;
     }
   }
+  if (changed)
+    customPropertyUpdated();
 }
 
 QMap<QCString, QString> CustomProperties::customProperties() const
Index: libkcal/alarm.h
===================================================================
--- libkcal/alarm.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/alarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -334,6 +334,13 @@
     */
     Incidence *parent() const  { return mParent; }
 
+  protected:
+    /**
+      @copydoc
+      CustomProperties::customPropertyUpdated()
+    */
+    virtual void customPropertyUpdated();
+
   private:
     Incidence *mParent;          // the incidence which this alarm belongs to
     Type mType;                  // type of alarm
Index: libkcal/filestorage.cpp
===================================================================
--- libkcal/filestorage.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/filestorage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -108,7 +108,7 @@
           return false;
         }
       } else {
-        kdDebug(5800) << "Warning! There should be set an exception." << endl;
+        kdDebug(5800) << "Warning! There should be an exception set." << endl;
         return false;
       }
     } else {
@@ -136,7 +136,7 @@
     calendar()->setModified( false );
   } else {
     if ( !format->exception() ) {
-      kdDebug(5800) << "FileStorage::save(): Error. There should be set an expection."
+      kdDebug(5800) << "FileStorage::save(): Error. There should be an exception set."
                 << endl;
     } else {
       kdDebug(5800) << "FileStorage::save(): " << format->exception()->message()
Index: libkcal/calendarresources.cpp
===================================================================
--- libkcal/calendarresources.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/calendarresources.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -106,6 +106,8 @@
 {
   close();
   delete mManager;
+  delete mStandardPolicy;
+  delete mAskPolicy;
 }
 
 void CalendarResources::readConfig( KConfig *config )
Index: libkcal/icalformatimpl.h
===================================================================
--- libkcal/icalformatimpl.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/icalformatimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,7 +31,6 @@
 
 extern "C" {
   #include <ical.h>
-  #include <icalss.h>
 }
 
 namespace KCal {
Index: libkcal/libical/src/libical/icallangbind.c
===================================================================
--- libkcal/libical/src/libical/icallangbind.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libical/icallangbind.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,312 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icallangbind.c
-  CREATOR: eric 15 dec 2000
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-  (C) COPYRIGHT 1999 Eric Busboom 
-  http://www.softwarestudio.org
-  
-  This package is free software and is provided "as is" without
-  express or implied warranty.  It may be used, redistributed and/or
-  modified under the same terms as perl itself. ( Either the Artistic
-  License or the GPL. )
-
-  ======================================================================*/
-
-#include "icalcomponent.h"
-#include "icalproperty.h"
-#include "icalerror.h"
-#include "icalmemory.h"
-#include "icalvalue.h"
-#include <stdlib.h>
-#include <string.h>
-
-#ifdef WIN32
-#define snprintf      _snprintf
-#define strcasecmp    stricmp
-#endif
-
-int* icallangbind_new_array(int size){
-    int* p = (int*)malloc(size*sizeof(int));
-    return p; /* Caller handles failures */
-}
-
-void icallangbind_free_array(int* array){
-    free(array);
-}
-
-int icallangbind_access_array(int* array, int indx) {
-    return array[indx];
-}                    
-
-/** Iterators to fetch parameters given property */
-
-icalparameter* icallangbind_get_first_parameter(icalproperty *prop)
-
-{
-    icalparameter_kind kind = ICAL_ANY_PARAMETER;
-    
-    return icalproperty_get_first_parameter(prop,kind);
-}
-
-icalparameter* icallangbind_get_next_parameter(icalproperty *prop)
-{
-    icalparameter_kind kind = ICAL_ANY_PARAMETER;
-    
-    return icalproperty_get_next_parameter(prop,kind);
-}
-		                                              
-
-/** Like icalcomponent_get_first_component(), but takes a string for the
-   kind and can iterate over X properties as if each X name was a
-   seperate kind */
-
-icalproperty* icallangbind_get_first_property(icalcomponent *c,
-                                              const char* prop)
-{
-    icalproperty_kind kind = icalproperty_string_to_kind(prop);
-    icalproperty *p;
-
-    if (kind == ICAL_NO_PROPERTY){
-	return 0;
-    }
-
-    if(kind == ICAL_X_PROPERTY){
-        for(p = icalcomponent_get_first_property(c,kind);
-            p !=0;
-            p = icalcomponent_get_next_property(c,kind)){
-            
-            if(strcmp(icalproperty_get_x_name(p),prop) == 0){
-                return p;
-            }                
-        }
-    } else {
-        p=icalcomponent_get_first_property(c,kind);
-
-        return p;
-    }
-	
-    return 0;
-
-}
-
-icalproperty* icallangbind_get_next_property(icalcomponent *c,
-                                              const char* prop)
-{
-    icalproperty_kind kind = icalenum_string_to_property_kind(prop);
-    icalproperty *p;
-
-    if (kind == ICAL_NO_PROPERTY){
-	return 0;
-    }
-
-    if(kind == ICAL_X_PROPERTY){
-        for(p = icalcomponent_get_next_property(c,kind);
-            p !=0;
-            p = icalcomponent_get_next_property(c,kind)){
-            
-            if(strcmp(icalproperty_get_x_name(p),prop) == 0){
-                return p;
-            }                
-        }
-    } else {
-        p=icalcomponent_get_next_property(c,kind);
-
-        return p;
-    }
-	
-    return 0;
-
-}
-
-
-icalcomponent* icallangbind_get_first_component(icalcomponent *c,
-                                              const char* comp)
-{
-    icalcomponent_kind kind = icalenum_string_to_component_kind(comp);
-
-    if (kind == ICAL_NO_COMPONENT){
-	return 0;
-    }
-    return icalcomponent_get_first_component(c,kind);
-}
-
-icalcomponent* icallangbind_get_next_component(icalcomponent *c,
-                                              const char* comp)
-{
-    icalcomponent_kind kind = icalenum_string_to_component_kind(comp);
-
-    if (kind == ICAL_NO_COMPONENT){
-	return 0;
-    }
-    return icalcomponent_get_next_component(c,kind);
-}
-
-
-#define APPENDS(x) icalmemory_append_string(&buf, &buf_ptr, &buf_size, x);
-
-#define APPENDC(x) icalmemory_append_char(&buf, &buf_ptr, &buf_size, x);
-
-
-const char* icallangbind_property_eval_string(icalproperty* prop, char* sep)
-{
-    char tmp[25];
-    size_t buf_size = 1024;
-    char* buf = icalmemory_new_buffer(buf_size);
-    char* buf_ptr = buf;
-    icalparameter *param;
-    
-    icalvalue* value;
-
-    if( prop == 0){
-	return 0;
-    }
-
-    APPENDS("{ ");
-
-    value = icalproperty_get_value(prop);
-
-    APPENDS(" 'name' ");
-    APPENDS(sep);
-    APPENDC('\'');
-    APPENDS(icalproperty_kind_to_string(icalproperty_isa(prop)));
-    APPENDC('\'');
-
-    if(value){
-        APPENDS(", 'value_type' ");
-        APPENDS(sep);
-        APPENDC('\'');
-        APPENDS(icalvalue_kind_to_string(icalvalue_isa(value)));
-        APPENDC('\'');
-    }
-
-    APPENDS(", 'pid' ");
-    APPENDS(sep);
-    APPENDC('\'');
-    snprintf(tmp,25,"%p",prop);
-    APPENDS(tmp);
-    APPENDC('\'');
-
-
-    if(value){
-        switch (icalvalue_isa(value)){
-	
-        case ICAL_ATTACH_VALUE:
-        case ICAL_BINARY_VALUE: 
-        case ICAL_NO_VALUE: {
-            icalerror_set_errno(ICAL_INTERNAL_ERROR);
-            break;
-        }
-
-        default: 
-        {
-            const char* str = icalvalue_as_ical_string(value);
-            char* copy = (char*) malloc(strlen(str)+1);
-            
-            const char *i;
-            char *j;
-
-            if(copy ==0){
-                icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-                break; 
-            }
-            /* Remove any newlines */
-                
-            for(j=copy, i = str; *i != 0; j++,i++){
-                if(*i=='\n'){
-                    i++;
-                }   
-                *j = *i;
-            }
-                
-            *j = 0;
-                
-            APPENDS(", 'value'");
-            APPENDS(sep);
-            APPENDC('\'');
-            APPENDS(copy);
-            APPENDC('\'');
-            
-            free(copy);
-            break;
-
-        }
-        }
-    }
-
-    /* Add Parameters */
-
-    for(param = icalproperty_get_first_parameter(prop,ICAL_ANY_PARAMETER);
-        param != 0;
-        param = icalproperty_get_next_parameter(prop,ICAL_ANY_PARAMETER)){
-        
-        const char* str = icalparameter_as_ical_string(param);
-        char *copy = icalmemory_tmp_copy(str);
-        char *v;
-
-        if(copy == 0){
-            icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-            continue;
-        }
-
-        v = strchr(copy,'=');
-
-
-        if(v == 0){
-            continue;
-        }
-
-        *v = 0;
-
-        v++;
-
-        APPENDS(", ");
-        APPENDC('\'');
-        APPENDS(copy);
-        APPENDC('\'');
-        APPENDS(sep);
-        APPENDC('\'');
-        APPENDS(v);        
-        APPENDC('\'');
-        
-    }
-
-
-    APPENDC('}');
-
-    icalmemory_add_tmp_buffer(buf);
-    return buf;
-
-}
-
-#include "fcntl.h"
-int icallangbind_string_to_open_flag(const char* str)
-{
-    if (strcmp(str,"r") == 0) {return O_RDONLY;}
-    else if (strcmp(str,"r+") == 0) {return O_RDWR;}
-    else if (strcmp(str,"w") == 0) {return O_WRONLY;}
-    else if (strcmp(str,"w+") == 0) {return O_RDWR|O_CREAT;}
-    else if (strcmp(str,"a") == 0) {return O_WRONLY|O_APPEND;}
-    else return -1;
-}
-
-
-const char* icallangbind_quote_as_ical(const char* str)
-{
-    size_t buf_size = 2 * strlen(str);
-
-    /* assume every char could be quoted */
-    char* buf = icalmemory_new_buffer(buf_size);
-    int result;
-
-    result = icalvalue_encode_ical_string(str, buf, buf_size);
-
-    icalmemory_add_tmp_buffer(buf);
-
-    return buf;
-}
Index: libkcal/libical/src/libical/icallangbind.h
===================================================================
--- libkcal/libical/src/libical/icallangbind.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libical/icallangbind.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,54 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icallangbind.h
-  CREATOR: eric 25 jan 2001
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-  (C) COPYRIGHT 1999 Eric Busboom 
-  http://www.softwarestudio.org
-  
-  This package is free software and is provided "as is" without
-  express or implied warranty.  It may be used, redistributed and/or
-  modified under the same terms as perl itself. ( Either the Artistic
-  License or the GPL. )
-
-  ======================================================================*/
-
-#ifndef __ICALLANGBIND_H__
-#define __ICALLANGBIND_H__
-
-int* icallangbind_new_array(int size);
-void icallangbind_free_array(int* array);
-int icallangbind_access_array(int* array, int indx);
-icalproperty* icallangbind_get_property(icalcomponent *c, int n, const char* prop);
-const char* icallangbind_get_property_val(icalproperty* p);
-const char* icallangbind_get_parameter(icalproperty *p, const char* parameter);
-icalcomponent* icallangbind_get_component(icalcomponent *c, const char* comp);
-
-icalproperty* icallangbind_get_first_property(icalcomponent *c,
-                                              const char* prop);
-
-icalproperty* icallangbind_get_next_property(icalcomponent *c,
-                                              const char* prop);
-
-icalcomponent* icallangbind_get_first_component(icalcomponent *c,
-                                              const char* comp);
-
-icalcomponent* icallangbind_get_next_component(icalcomponent *c,
-                                              const char* comp);
-
-icalparameter* icallangbind_get_first_parameter(icalproperty *prop);
-
-icalparameter* icallangbind_get_next_parameter(icalproperty *prop);
-
-const char* icallangbind_property_eval_string(icalproperty* prop, char* sep);
-
-
-int icallangbind_string_to_open_flag(const char* str);
-
-const char* icallangbind_quote_as_ical(const char* str);
-#endif /*__ICALLANGBIND_H__*/
Index: libkcal/libical/src/libical/sspm.c
===================================================================
--- libkcal/libical/src/libical/sspm.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libical/sspm.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1171,7 +1171,7 @@
 			     char *src,
 			     size_t *size)
 {
-    int cc;
+    int cc = 0;
     char buf[4] = {0,0,0,0};  
     int p = 0;
     int valid_data = 0;
Index: libkcal/libical/src/libical/Makefile.am
===================================================================
--- libkcal/libical/src/libical/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libical/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -67,8 +67,7 @@
 	icalderivedvalue.c	\
 	pvl.c			\
 	sspm.c			\
-	vsnprintf.c		\
-	icallangbind.c
+	vsnprintf.c
 
 
 noinst_HEADERS = ical.h		\
@@ -97,8 +96,7 @@
 	icalvalueimpl.h		\
 	icalderivedvalue.h	\
 	pvl.h			\
-	sspm.h			\
-	icallangbind.h
+	sspm.h
 
 # ORDERING OF HEADERS IS SIGNIFICANT. Don't change this ordering. It
 # is required to make the combined header ical.h properly
@@ -126,8 +124,7 @@
 	$(srcdir)/icalerror.h		\
 	$(srcdir)/icalrestriction.h	\
 	$(srcdir)/sspm.h		\
-	$(srcdir)/icalmime.h		\
-	$(srcdir)/icallangbind.h
+	$(srcdir)/icalmime.h
 
 ical.h: $(COMBINEDHEADERS)
 	echo '#ifdef __cplusplus'	  >  ical.h
@@ -230,7 +227,6 @@
 icalderivedproperty.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
 icalderivedvalue.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
 icalduration.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
-icallangbind.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
 icalmime.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
 icalparameter.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
 icalparser.lo: icalderivedvalue.h icalderivedproperty.h icalderivedparameter.h
Index: libkcal/libical/src/libicalss/icalclusterimpl.h
===================================================================
--- libkcal/libical/src/libicalss/icalclusterimpl.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalclusterimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,45 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalfilesetimpl.h
-  CREATOR: eric 23 December 1999
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
- ======================================================================*/
-
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-/* This definition is in its own file so it can be kept out of the
-   main header file, but used by "friend classes" like icaldirset*/
-
-#define ICALCLUSTER_ID "clus"
-
-struct icalcluster_impl {
-
-	char		id[5];		/* clus */
-
-	char	       *key;
-	icalcomponent  *data;
-	int		changed;
-};
Index: libkcal/libical/src/libicalss/icalcalendar.c
===================================================================
--- libkcal/libical/src/libicalss/icalcalendar.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalcalendar.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,263 +0,0 @@
-/*======================================================================
-  FILE: icalcalendar.c
-  CREATOR: eric 23 December 1999
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- ======================================================================*/
-
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-
-#include "icalcalendar.h"
-#include "icalset.h"
-#include "icalfileset.h"
-#include "icaldirset.h"
-#include <limits.h> 
-#include <sys/stat.h> /* For mkdir, stat */
-#include <sys/types.h> /* For mkdir */
-#include <fcntl.h> /* For mkdir */
-
-#ifndef WIN32
-#include <unistd.h>  /* For mkdir, stat */    
-#endif
-
-#ifndef PATH_MAX
-#define PATH_MAX 512
-#endif
-
-
-#include <stdlib.h> /* for malloc */
-#include <string.h> /* for strcat */
-#include <errno.h>
-
-#define BOOKED_DIR "booked"
-#define INCOMING_FILE "incoming.ics"
-#define PROP_FILE "properties.ics"
-#define FBLIST_FILE "freebusy.ics"
-
-struct icalcalendar_impl 
-{
-	char* dir;
-	icalset* freebusy;
-	icalset* properties;
-	icalset* booked;
-	icalset* incoming;
-};
-
-struct icalcalendar_impl* icalcalendar_new_impl(void)
-{
-    struct icalcalendar_impl* impl;
-
-    if ( ( impl = (struct icalcalendar_impl*)
-	   malloc(sizeof(struct icalcalendar_impl))) == 0) {
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return 0;
-    }
-
-    return impl;
-}
-
-
-icalerrorenum icalcalendar_create(struct icalcalendar_impl* impl)
-{
-    char path[PATH_MAX];
-    struct stat sbuf;
-    int r;
-    
-    icalerror_check_arg_re((impl != 0),"impl",ICAL_BADARG_ERROR);
-
-    path[0] = '\0';
-    strcpy(path,impl->dir);
-    strcat(path,"/");
-    strcat(path,BOOKED_DIR);
-
-    r = stat(path,&sbuf);
-
-    if( r != 0 && errno == ENOENT){
-
-	if(mkdir(path,0777)!=0){
-	    icalerror_set_errno(ICAL_FILE_ERROR);
-	    return ICAL_FILE_ERROR;
-	}
-    }
-
-    return ICAL_NO_ERROR;
-}
-
-icalcalendar* icalcalendar_new(char* dir)
-{
-    struct icalcalendar_impl* impl;
-
-    icalerror_check_arg_rz((dir != 0),"dir");
-    
-    impl = icalcalendar_new_impl();
-
-    if (impl == 0){
-	return 0;
-    }
-
-    impl->dir = (char*)strdup(dir);
-    impl->freebusy = 0;
-    impl->properties = 0;
-    impl->booked = 0;
-    impl->incoming = 0;
-
-    if (icalcalendar_create(impl) != ICAL_NO_ERROR){
-	free(impl);
-	return 0;
-    }
-
-    return impl;
-}
-
-void icalcalendar_free(icalcalendar* impl)
-{
-    if (impl->dir !=0){
-	free(impl->dir);
-    }
-
-    if (impl->freebusy !=0){
-	icalset_free(impl->booked);
-    }
-
-    if (impl->properties !=0){
-	icalset_free(impl->properties);
-    }
-
-    if (impl->booked !=0){
-	icalset_free(impl->booked);
-    }
-
-    if (impl->incoming !=0){
-	icalset_free(impl->incoming);
-    }
-
-    impl->dir = 0;
-    impl->freebusy = 0;
-    impl->properties = 0;
-    impl->booked = 0;
-    impl->incoming = 0;
-
-
-    free(impl);
-}
-
-
-int icalcalendar_lock(icalcalendar* impl)
-{
-    icalerror_check_arg_rz((impl != 0),"impl");
-    return 0;
-}
-
-int icalcalendar_unlock(icalcalendar* impl)
-{
-    icalerror_check_arg_rz((impl != 0),"impl");
-    return 0;
-}
-
-int icalcalendar_islocked(icalcalendar* impl)
-{
-    icalerror_check_arg_rz((impl != 0),"impl");
-    return 0;
-}
-
-int icalcalendar_ownlock(icalcalendar* impl)
-{
-    icalerror_check_arg_rz((impl != 0),"impl");
-    return 0;
-}
-
-icalset* icalcalendar_get_booked(icalcalendar* impl)
-{
-    char dir[PATH_MAX];
-
-    icalerror_check_arg_rz((impl != 0),"impl");
-    
-    dir[0] = '\0';
-    strcpy(dir,impl->dir);
-    strcat(dir,"/");
-    strcat(dir,BOOKED_DIR);
-
-    if (impl->booked == 0){
-	icalerror_clear_errno();
-	impl->booked = icaldirset_new(dir);
-	assert(icalerrno == ICAL_NO_ERROR);
-    }
-
-    return impl->booked;
-
-}
-
-icalset* icalcalendar_get_incoming(icalcalendar* impl)
-{
-    char path[PATH_MAX];
-    icalerror_check_arg_rz((impl != 0),"impl");
-
-    path[0] = '\0';
-    strcpy(path,impl->dir);
-    strcat(path,"/");
-    strcat(path,INCOMING_FILE);
-
-    if (impl->properties == 0){
-	impl->properties = icalfileset_new(path);
-    }
-
-    return impl->properties;
-}
-
-icalset* icalcalendar_get_properties(icalcalendar* impl)
-{
-    char path[PATH_MAX];
-    icalerror_check_arg_rz((impl != 0),"impl");
-
-    path[0] = '\0';
-    strcpy(path,impl->dir);
-    strcat(path,"/");
-    strcat(path,PROP_FILE);
-
-    if (impl->properties == 0){
-	impl->properties = icalfileset_new(path);
-    }
-
-    return impl->properties;
-}
-
-icalset* icalcalendar_get_freebusy(icalcalendar* impl)
-{
-    char path[PATH_MAX];
-    icalerror_check_arg_rz((impl != 0),"impl");
-
-    path[0] = '\0';
-    strcpy(path,impl->dir);
-    strcat(path,"/");
-    strcat(path,FBLIST_FILE);
-
-
-    if (impl->freebusy == 0){
-	impl->freebusy = icalfileset_new(path);
-    }
-
-    return impl->freebusy;
-}
-
-
-
-
Index: libkcal/libical/src/libicalss/icalssyacc.y
===================================================================
--- libkcal/libical/src/libicalss/icalssyacc.y	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalssyacc.y	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,252 +0,0 @@
-%pure_parser
-
-%{
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalssyacc.y
-  CREATOR: eric 08 Aug 2000
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-(C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-  ======================================================================*/
-/*#define YYDEBUG 1*/
-#include <stdlib.h>
-#include <string.h> /* for strdup() */
-#include <limits.h> /* for SHRT_MAX*/
-#include "ical.h"
-#include "icalgauge.h"
-#include "icalgaugeimpl.h"
-
-
-#define YYPARSE_PARAM yy_globals
-#define YYLEX_PARAM yy_globals
-#define YY_EXTRA_TYPE  icalgauge_impl*
-  /* ick...*/
-#define yyextra ((struct icalgauge_impl*)ssget_extra(yy_globals))
-
-
-static void ssyacc_add_where(struct icalgauge_impl* impl, char* prop, 
-			icalgaugecompare compare , char* value);
-static void ssyacc_add_select(struct icalgauge_impl* impl, char* str1);
-static void ssyacc_add_from(struct icalgauge_impl* impl, char* str1);
-static void set_logic(struct icalgauge_impl* impl,icalgaugelogic l);
-void sserror(char *s); /* Don't know why I need this.... */
-
-%}
-
-%union {
-	char* v_string;
-}
-
-
-%token <v_string> STRING
-%token SELECT FROM WHERE COMMA QUOTE EQUALS NOTEQUALS  LESS GREATER LESSEQUALS
-%token GREATEREQUALS AND OR EOL END IS NOT SQLNULL
-
-%%
-
-query_min: SELECT select_list FROM from_list WHERE where_list
-	   | SELECT select_list FROM from_list
-	   | error { 
-                 yyclearin;
-		 YYABORT;
-           }	
-	   ;	
-
-select_list:
-	STRING {ssyacc_add_select(yyextra,$1);}
-	| select_list COMMA STRING {ssyacc_add_select(yyextra,$3);}
-	;
-
-
-from_list:
-	STRING {ssyacc_add_from(yyextra,$1);}
-	| from_list COMMA STRING {ssyacc_add_from(yyextra,$3);}
-	;
-
-where_clause:
-	/* Empty */
-	| STRING EQUALS STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_EQUAL,$3); }
-	| STRING IS SQLNULL {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_ISNULL,""); }
-	| STRING IS NOT SQLNULL {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_ISNOTNULL,""); }
-	| STRING NOTEQUALS STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_NOTEQUAL,$3); }
-	| STRING LESS STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_LESS,$3); }
-	| STRING GREATER STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_GREATER,$3); }
-	| STRING LESSEQUALS STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_LESSEQUAL,$3); }
-	| STRING GREATEREQUALS STRING {ssyacc_add_where(yyextra,$1,ICALGAUGECOMPARE_GREATEREQUAL,$3); }
-	;
-
-where_list:
-	where_clause {set_logic(yyextra,ICALGAUGELOGIC_NONE);}
-	| where_list AND where_clause {set_logic(yyextra,ICALGAUGELOGIC_AND);} 
-	| where_list OR where_clause {set_logic(yyextra,ICALGAUGELOGIC_OR);}
-	;
-
-
-%%
-
-static void ssyacc_add_where(struct icalgauge_impl* impl, char* str1, 
-	icalgaugecompare compare , char* value_str)
-{
-
-    struct icalgauge_where *where;
-    char *compstr, *propstr, *c, *s,*l;
-    
-    if ( (where = malloc(sizeof(struct icalgauge_where))) ==0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return;
-    }
-
-    memset(where,0,sizeof(struct icalgauge_where));
-    where->logic = ICALGAUGELOGIC_NONE;
-    where->compare = ICALGAUGECOMPARE_NONE;
-    where->comp = ICAL_NO_COMPONENT;
-    where->prop = ICAL_NO_PROPERTY;
-
-    /* remove enclosing quotes */
-    s = value_str;
-    if(*s == '\''){
-	s++;
-    }
-    l = s+strlen(s)-1;
-    if(*l == '\''){
-	*l=0;
-    }
-	
-    where->value = strdup(s);
-
-    /* Is there a period in str1 ? If so, the string specified both a
-       component and a property*/
-    if( (c = strrchr(str1,'.')) != 0){
-	compstr = str1;
-	propstr = c+1;
-	*c = '\0';
-    } else {
-	compstr = 0;
-	propstr = str1;
-    }
-
-
-    /* Handle the case where a component was specified */
-    if(compstr != 0){
-	where->comp = icalenum_string_to_component_kind(compstr);
-    } else {
-	where->comp = ICAL_NO_COMPONENT;
-    }
-
-    where->prop = icalenum_string_to_property_kind(propstr);    
-
-    where->compare = compare;
-
-    if(where->value == 0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	free(where->value);
-	return;
-    }
-
-    pvl_push(impl->where,where);
-}
-
-static void set_logic(struct icalgauge_impl* impl,icalgaugelogic l)
-{
-    pvl_elem e = pvl_tail(impl->where);
-    struct icalgauge_where *where = pvl_data(e);
-
-    where->logic = l;
-   
-}
-
-
-
-static void ssyacc_add_select(struct icalgauge_impl* impl, char* str1)
-{
-    char *c, *compstr, *propstr;
-    struct icalgauge_where *where;
-    
-    /* Uses only the prop and comp fields of the where structure */
-    if ( (where = malloc(sizeof(struct icalgauge_where))) ==0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return;
-    }
-
-    memset(where,0,sizeof(struct icalgauge_where));
-    where->logic = ICALGAUGELOGIC_NONE;
-    where->compare = ICALGAUGECOMPARE_NONE;
-    where->comp = ICAL_NO_COMPONENT;
-    where->prop = ICAL_NO_PROPERTY;
-
-    /* Is there a period in str1 ? If so, the string specified both a
-       component and a property*/
-    if( (c = strrchr(str1,'.')) != 0){
-	compstr = str1;
-	propstr = c+1;
-	*c = '\0';
-    } else {
-	compstr = 0;
-	propstr = str1;
-    }
-
-
-    /* Handle the case where a component was specified */
-    if(compstr != 0){
-	where->comp = icalenum_string_to_component_kind(compstr);
-    } else {
-	where->comp = ICAL_NO_COMPONENT;
-    }
-
-
-    /* If the property was '*', then accept all properties */
-    if(strcmp("*",propstr) == 0) {
-	where->prop = ICAL_ANY_PROPERTY; 	    
-    } else {
-	where->prop = icalenum_string_to_property_kind(propstr);    
-    }
-    
-
-    if(where->prop == ICAL_NO_PROPERTY){
-      free(where);
-      icalerror_set_errno(ICAL_BADARG_ERROR);
-      return;
-    }
-
-    pvl_push(impl->select,where);
-}
-
-static void ssyacc_add_from(struct icalgauge_impl* impl, char* str1)
-{
-    icalcomponent_kind ckind;
-
-    ckind = icalenum_string_to_component_kind(str1);
-
-    if(ckind == ICAL_NO_COMPONENT){
-	assert(0);
-    }
-
-    pvl_push(impl->from,(void*)ckind);
-
-}
-
-
-void sserror(char *s){
-  fprintf(stderr,"Parse error \'%s\'\n", s);
-  icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-}
Index: libkcal/libical/src/libicalss/icalcalendar.h
===================================================================
--- libkcal/libical/src/libicalss/icalcalendar.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalcalendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,67 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalcalendar.h
- CREATOR: eric 23 December 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALCALENDAR_H
-#define ICALCALENDAR_H
-
-#include "ical.h"
-#include "icalset.h"
-
-/* icalcalendar
- * Routines for storing calendar data in a file system. The calendar 
- * has two icaldirsets, one for incoming components and one for booked
- * components. It also has interfaces to access the free/busy list
- * and a list of calendar properties */
-
-typedef struct icalcalendar_impl icalcalendar;
-
-icalcalendar* icalcalendar_new(char* dir);
-
-void icalcalendar_free(icalcalendar* calendar);
-
-int icalcalendar_lock(icalcalendar* calendar);
-
-int icalcalendar_unlock(icalcalendar* calendar);
-
-int icalcalendar_islocked(icalcalendar* calendar);
-
-int icalcalendar_ownlock(icalcalendar* calendar);
-
-icalset* icalcalendar_get_booked(icalcalendar* calendar);
-
-icalset* icalcalendar_get_incoming(icalcalendar* calendar);
-
-icalset* icalcalendar_get_properties(icalcalendar* calendar);
-
-icalset* icalcalendar_get_freebusy(icalcalendar* calendar);
-
-
-#endif /* !ICALCALENDAR_H */
-
-
-
Index: libkcal/libical/src/libicalss/icalgaugeimpl.h
===================================================================
--- libkcal/libical/src/libicalss/icalgaugeimpl.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalgaugeimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,63 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalgaugeimpl.h
- CREATOR: eric 09 Aug 2000
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-======================================================================*/
-
-#include "ical.h"
-
-typedef enum icalgaugecompare {
-    ICALGAUGECOMPARE_EQUAL=ICAL_XLICCOMPARETYPE_EQUAL,
-    ICALGAUGECOMPARE_LESS=ICAL_XLICCOMPARETYPE_LESS,
-    ICALGAUGECOMPARE_LESSEQUAL=ICAL_XLICCOMPARETYPE_LESSEQUAL,
-    ICALGAUGECOMPARE_GREATER=ICAL_XLICCOMPARETYPE_GREATER,
-    ICALGAUGECOMPARE_GREATEREQUAL=ICAL_XLICCOMPARETYPE_GREATEREQUAL,
-    ICALGAUGECOMPARE_NOTEQUAL=ICAL_XLICCOMPARETYPE_NOTEQUAL,
-    ICALGAUGECOMPARE_REGEX=ICAL_XLICCOMPARETYPE_REGEX,
-    ICALGAUGECOMPARE_ISNULL=ICAL_XLICCOMPARETYPE_ISNULL,
-    ICALGAUGECOMPARE_ISNOTNULL=ICAL_XLICCOMPARETYPE_ISNOTNULL,
-    ICALGAUGECOMPARE_NONE=0
-} icalgaugecompare;
-
-typedef enum icalgaugelogic {
-    ICALGAUGELOGIC_NONE,
-    ICALGAUGELOGIC_AND,
-    ICALGAUGELOGIC_OR
-} icalgaugelogic;
-    
-
-struct icalgauge_where {
-	icalgaugelogic logic;
-	icalcomponent_kind comp;
-	icalproperty_kind prop;
-	icalgaugecompare compare;
-	char* value;
-};
-
-struct icalgauge_impl
-{
-	pvl_list select; /**< Of icalgaugecompare, using only prop and comp fields*/
-	pvl_list from;   /**< List of component_kinds, as integers */
-	pvl_list where;  /**< List of icalgaugecompare */
-        int      expand;
-};
-
-
Index: libkcal/libical/src/libicalss/icaldirsetimpl.h
===================================================================
--- libkcal/libical/src/libicalss/icaldirsetimpl.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icaldirsetimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,48 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icaldirsetimpl.h
-  CREATOR: eric 21 Aug 2000
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
- ======================================================================*/
-
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "icalcluster.h"
-
-/* This definition is in its own file so it can be kept out of the
-   main header file, but used by "friend classes" like icalset*/
-
-struct icaldirset_impl 
-{
-  icalset super;		/**< parent class */
-  char* dir;			/**< directory containing ics files  */
-  icaldirset_options options;	/**< copy of options passed to icalset_new() */
-  icalcluster* cluster;		/**< cluster containing data */
-  icalgauge* gauge;		/**< gauge for filtering out data  */
-  int first_component;		/**< ??? */
-  pvl_list directory;		/**< ??? */
-  pvl_elem directory_iterator;	/**< ??? */
-};
Index: libkcal/libical/src/libicalss/icalcluster.c
===================================================================
--- libkcal/libical/src/libicalss/icalcluster.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalcluster.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,245 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalcluster.c
-  CREATOR: acampi 13 March 2002
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2002, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
- ======================================================================*/
-
-
-/**
- *
- * icalcluster is an utility class design to manage clusters of
- * icalcomponents on behalf of an implementation of icalset. This is
- * done in order to split out common behavior different classes might
- * need.
- * The definition of what exactly a cluster will contain depends on the
- * icalset subclass. At the basic level, an icluster is just a tuple,
- * with anything as key and an icalcomponent as value.
- */
-
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include <stdlib.h>
-#include <string.h>
-
-#if 0
-#include <errno.h>
-#include <sys/stat.h> /* for stat */
-#ifndef WIN32
-#include <unistd.h> /* for stat, getpid */
-#else
-#include <io.h>
-#include <share.h>
-#endif
-#include <fcntl.h> /* for fcntl */
-#endif
-
-#include "icalcluster.h"
-#include "icalclusterimpl.h"
-#include "icalgauge.h"
-
-#ifdef WIN32
-#define snprintf	_snprintf
-#define strcasecmp	stricmp
-#endif
-
-
-icalcluster * icalcluster_new_impl(void) {
-
-	struct icalcluster_impl* impl;
-  
-	if ((impl = (struct icalcluster_impl*)malloc(
-				sizeof(struct icalcluster_impl))) == 0) {
-		icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-		return 0;
-	}
-  
-	memset(impl, 0, sizeof(struct icalcluster_impl));
-	strcpy(impl->id,ICALCLUSTER_ID);
-
-	return impl;
-}
-
-/**
- * Create a cluster with a key/value pair.
- *
- * @todo Always do a deep copy.
- */
-
-icalcluster * icalcluster_new(const char* key, icalcomponent *data) {
-	struct icalcluster_impl *impl = icalcluster_new_impl();
-	assert(impl->data == 0);
-
-	impl->key	= strdup(key);
-	impl->changed	= 0;
-	impl->data	= 0;
-
-	if (data != NULL) {
-		if (icalcomponent_isa(data) != ICAL_XROOT_COMPONENT) {
-			impl->data = icalcomponent_new(ICAL_XROOT_COMPONENT);
-			icalcomponent_add_component(impl->data, data);
-		} else {
-			impl->data = icalcomponent_new_clone(data);
-		}
-	} else {
-		impl->data = icalcomponent_new(ICAL_XROOT_COMPONENT);
-	}
-
-	return impl;
-}
-
-/**
- * Deep clone an icalcluster to a new one
- */
-
-icalcluster *icalcluster_new_clone(const icalcluster *data) {
-	struct icalcluster_impl *old = (struct icalcluster_impl *)data;
-	struct icalcluster_impl *impl = icalcluster_new_impl();
-
-	impl->key	= strdup(old->key);
-	impl->data	= icalcomponent_new_clone(old->data);
-	impl->changed	= 0;
-
-	return impl;
-}
-
-
-void icalcluster_free(icalcluster *impl) {
-	icalerror_check_arg_rv((impl!=0),"cluster");
-
-	if (impl->key != 0){
-		free(impl->key);
-		impl->key = 0;
-	}
-
-	if (impl->data != 0){
-		icalcomponent_free(impl->data);
-		impl->data = 0;
-	}
-
-	free(impl);
-}
-
-
-const char *icalcluster_key(icalcluster *impl) {
-	icalerror_check_arg_rz((impl!=0),"cluster");
-
-	return impl->key;
-}
-
-
-int icalcluster_is_changed(icalcluster *impl) {
-	icalerror_check_arg_rz((impl!=0),"cluster");
-
-	return impl->changed;
-}
-
-
-void icalcluster_mark(icalcluster *impl) {
-	icalerror_check_arg_rv((impl!=0),"cluster");
-
-	impl->changed = 1;
-}
-
-
-void icalcluster_commit(icalcluster *impl) {
-	icalerror_check_arg_rv((impl!=0),"cluster");
-
-	impl->changed = 0;
-}
-
-
-icalcomponent *icalcluster_get_component(icalcluster *impl) {
-
-	icalerror_check_arg_rz((impl!=0),"cluster");
-
-	if (icalcomponent_isa(impl->data) != ICAL_XROOT_COMPONENT) {
-		icalerror_warn("The top component is not an XROOT");
-		fprintf(stderr, "%s\n", icalcomponent_as_ical_string(impl->data));
-		abort();
-	}
-
-	return impl->data;
-}
-
-
-icalerrorenum icalcluster_add_component(icalcluster *impl, icalcomponent* child) {
-
-	icalerror_check_arg_re((impl!=0),"cluster", ICAL_BADARG_ERROR);
-	icalerror_check_arg_re((child!=0),"child",ICAL_BADARG_ERROR);
-
-	icalcomponent_add_component(impl->data, child);
-	icalcluster_mark(impl);
-
-	return ICAL_NO_ERROR;
-}
-
-
-icalerrorenum icalcluster_remove_component(icalcluster *impl, icalcomponent* child) {
-
-	icalerror_check_arg_re((impl!=0),"cluster",ICAL_BADARG_ERROR);
-	icalerror_check_arg_re((child!=0),"child",ICAL_BADARG_ERROR);
-
-	icalcomponent_remove_component(impl->data,child);
-	icalcluster_mark(impl);
-
-	return ICAL_NO_ERROR;
-}
-
-
-int icalcluster_count_components(icalcluster *impl, icalcomponent_kind kind) {
-
-	icalerror_check_arg_re((impl!=0),"cluster",ICAL_BADARG_ERROR);
-
-	return icalcomponent_count_components(impl->data, kind);
-}
-
-
-/** Iterate through components **/
-icalcomponent *icalcluster_get_current_component(icalcluster* impl) {
-
-	icalerror_check_arg_rz((impl!=0),"cluster");
-
-	return icalcomponent_get_current_component(impl->data);
-}
-
-
-icalcomponent *icalcluster_get_first_component(icalcluster* impl) {
-
-	icalerror_check_arg_rz((impl!=0),"cluster");
-
-	return icalcomponent_get_first_component(impl->data,
-						  ICAL_ANY_COMPONENT);
-}
-
-
-icalcomponent *icalcluster_get_next_component(icalcluster* impl) {
-
-	icalerror_check_arg_rz((impl!=0),"cluster");
-    
-	return icalcomponent_get_next_component(impl->data,
-					     ICAL_ANY_COMPONENT);
-}
Index: libkcal/libical/src/libicalss/icalfilesetimpl.h
===================================================================
--- libkcal/libical/src/libicalss/icalfilesetimpl.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalfilesetimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,53 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalfilesetimpl.h
-  CREATOR: eric 23 December 1999
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
- ======================================================================*/
-
-#ifndef ICALFILESETIMPL_H
-#define ICALFILESETIMPL_H
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "icalgauge.h"
-
-/* This definition is in its own file so it can be kept out of the
-   main header file, but used by "friend classes" like icaldirset*/
-
-#define ICALFILESET_ID "fset"
-
-struct icalfileset_impl {
-  icalset super;		/**< parent class */
-  char *path;			/**< pathname of file */
-  icalfileset_options options;  /**< copy of options passed to icalset_new() */
-
-  icalcomponent* cluster;	/**< cluster containing data */
-  icalgauge* gauge;		/**< gauge for filtering out data */
-  int changed;			/**< boolean flag, 1 if data has changed */
-  int fd;			/**< file descriptor */
-};
-
-#endif
Index: libkcal/libical/src/libicalss/icalmessage.c
===================================================================
--- libkcal/libical/src/libicalss/icalmessage.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalmessage.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,378 +0,0 @@
-/* -*- Mode: C -*-
-    ======================================================================
-    FILE: icalmessage.c
-    CREATOR: ebusboom 07 Nov 2000
-  
-    $Id$
-    $Locker$
-    
-    (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-    
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of either: 
-    
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-    
-    Or:
-    
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-
-    ======================================================================*/
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "icalmessage.h"
-#include "icalenums.h"
-#include <ctype.h>  /* for tolower()*/
-#include <string.h> /* for strstr */
-#include <stdlib.h> /* for free(), malloc() */
-icalcomponent* icalmessage_get_inner(icalcomponent* comp)
-{
-    if (icalcomponent_isa(comp) == ICAL_VCALENDAR_COMPONENT){
-	return icalcomponent_get_first_real_component(comp);
-    } else {
-	return comp;
-    }
-}
-
-static char* lowercase(const char* str)
-{
-    char* p = 0;
-    char* n = icalmemory_strdup(str);
-
-    if(str ==0){
-	return 0;
-    }
-
-    for(p = n; *p!=0; p++){
-	*p = tolower(*p);
-    }
-
-    return n;
-}
-
-icalproperty* icalmessage_find_attendee(icalcomponent* comp, const char* user)
-{
-    icalcomponent *inner = icalmessage_get_inner(comp);
-    icalproperty *p,*attendee = 0;
-    char* luser = lowercase(user);
-
-    for(p = icalcomponent_get_first_property(inner, ICAL_ATTENDEE_PROPERTY);
-	p != 0;
-	p = icalcomponent_get_next_property(inner, ICAL_ATTENDEE_PROPERTY)
-	){
-
-	char* lattendee;
-
-	lattendee = lowercase(icalproperty_get_attendee(p));
-
-	if (strstr(lattendee,user) != 0){
-	    attendee = p;
-	    break;
-	}
-
-	free(lattendee);
-
-    }
-    
-    free(luser);
-
-    return attendee;
-
-}
-
-void icalmessage_copy_properties(icalcomponent* to, icalcomponent* from, 
-		icalproperty_kind kind)
-{
-    icalcomponent *to_inner = icalmessage_get_inner(to);
-    icalcomponent *from_inner = icalmessage_get_inner(from);
-
-    if (to_inner == 0 && from_inner == 0){
-	icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-	return;
-    }
-
-    if(!icalcomponent_get_first_property(from_inner,kind)){
-	return;
-    }
-
-    icalcomponent_add_property(to_inner,
-	       icalproperty_new_clone(
-		   icalcomponent_get_first_property(
-		       from_inner,
-		       kind)
-		   )
-	);
-}
-
-icalcomponent *icalmessage_new_reply_base(icalcomponent* c,
-					    const char* user,
-					    const char* msg)
-{
-    icalproperty *attendee;
-    char tmp[45];
-
-    icalcomponent *reply = icalcomponent_vanew(
-	ICAL_VCALENDAR_COMPONENT,
-	icalproperty_new_method(ICAL_METHOD_REPLY),
-	icalcomponent_vanew(
-	    ICAL_VEVENT_COMPONENT,
-	    icalproperty_new_dtstamp(icaltime_from_timet(time(0),0)),
-	    0),
-	0);
-
-    icalcomponent *inner = icalmessage_get_inner(reply);
-
-    icalerror_check_arg_rz(c,"c");
-
-    icalmessage_copy_properties(reply,c,ICAL_UID_PROPERTY);
-    icalmessage_copy_properties(reply,c,ICAL_ORGANIZER_PROPERTY);
-    icalmessage_copy_properties(reply,c,ICAL_RECURRENCEID_PROPERTY);
-    icalmessage_copy_properties(reply,c,ICAL_SUMMARY_PROPERTY);
-    icalmessage_copy_properties(reply,c,ICAL_SEQUENCE_PROPERTY);
-
-    icalcomponent_set_dtstamp(reply,icaltime_from_timet(time(0),0));
-
-    if(msg != 0){
-	icalcomponent_add_property(inner,icalproperty_new_comment(msg));
-    }
-
-    /* Copy this user's attendee property */
-
-    attendee = icalmessage_find_attendee(c,user);
-
-    if (attendee == 0){
-	icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-	icalcomponent_free(reply);
-	return 0;
-    }
-
-    icalcomponent_add_property(inner,icalproperty_new_clone(attendee));
-
-    /* Add PRODID and VERSION */
-
-    icalcomponent_add_property(reply,icalproperty_new_version("2.0"));
-    
-#ifndef WIN32    
-    snprintf(tmp,sizeof(tmp),
-           "-//SoftwareStudio//NONSGML %s %s //EN",PACKAGE,VERSION);
-#else
-    snprintf(tmp,sizeof(tmp),
-           "-//SoftwareStudio//NONSGML %s %s //EN",ICAL_PACKAGE,ICAL_VERSION);
-#endif
-    icalcomponent_add_property(reply,icalproperty_new_prodid(tmp));
-
-    return reply;
-
-}
-
-icalcomponent* icalmessage_new_accept_reply(icalcomponent* c,
-					    const char* user,
-					    const char* msg)
-{
-
-    icalcomponent *reply;
-    icalproperty *attendee;
-    icalcomponent *inner;
-
-    icalerror_check_arg_rz(c,"c");
-    
-    reply = icalmessage_new_reply_base(c,user,msg);
-
-    if(reply == 0){
-	return 0;
-    }
-
-    inner  = icalmessage_get_inner(reply);
-
-    attendee = icalcomponent_get_first_property(inner,
-						ICAL_ATTENDEE_PROPERTY);
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_partstat(ICAL_PARTSTAT_ACCEPTED));
-
-    return reply;
-}
-
-icalcomponent* icalmessage_new_decline_reply(icalcomponent* c,
-					    const char* user,
-					    const char* msg)
-{
-    icalcomponent *reply;
-    icalproperty *attendee;
-    icalcomponent *inner;
-
-    icalerror_check_arg_rz(c,"c");
-    
-    reply = icalmessage_new_reply_base(c,user,msg);
-    inner = icalmessage_get_inner(reply);
-    if(reply == 0){
-	return 0;
-    }
-
-    attendee = icalcomponent_get_first_property(inner,
-						ICAL_ATTENDEE_PROPERTY);
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_partstat(ICAL_PARTSTAT_DECLINED));
-
-    return reply;
-}
-
-/* New is modified version of old */
-icalcomponent* icalmessage_new_counterpropose_reply(icalcomponent* oldc,
-						    icalcomponent* newc,
-						    const char* user,
-						    const char* msg)
-{
-    icalcomponent *reply;
-
-    icalerror_check_arg_rz(oldc,"oldc");
-    icalerror_check_arg_rz(newc,"newc");
-    
-    reply = icalmessage_new_reply_base(newc,user,msg);
-
-    icalcomponent_set_method(reply,ICAL_METHOD_COUNTER);
-
-    return reply;
-
-}
-
-
-icalcomponent* icalmessage_new_delegate_reply(icalcomponent* c,
-					      const char* user,
-					      const char* delegatee,
-					      const char* msg)
-{
-
-    icalcomponent *reply;
-    icalproperty *attendee;
-    icalcomponent *inner;
-
-    icalerror_check_arg_rz(c,"c");
-
-    reply =  icalmessage_new_reply_base(c,user,msg);
-    inner = icalmessage_get_inner(reply);
-    if(reply == 0){
-	return 0;
-    }
-
-    attendee = icalcomponent_get_first_property(inner,
-						ICAL_ATTENDEE_PROPERTY);
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_partstat(ICAL_PARTSTAT_DELEGATED));
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_delegatedto(delegatee));
-
-    return reply;
-
-}
-
-icalcomponent* icalmessage_new_delegate_request(icalcomponent* c,
-					      const char* user,
-					      const char* delegatee,
-					      const char* msg)
-{
-
-    icalcomponent *reply;
-    icalproperty *attendee;
-    icalcomponent *inner;
-
-    icalerror_check_arg_rz(c,"c");
-
-    reply =  icalmessage_new_reply_base(c,user,msg);
-    inner = icalmessage_get_inner(reply);
-
-    if(reply == 0){
-	return 0;
-    }
-
-    icalcomponent_set_method(reply,ICAL_METHOD_REQUEST);
-
-    attendee = icalcomponent_get_first_property(inner,
-						ICAL_ATTENDEE_PROPERTY);
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_partstat(ICAL_PARTSTAT_DELEGATED));
-
-    icalproperty_set_parameter(attendee,
-	       icalparameter_new_delegatedto(delegatee));
-
-    icalcomponent_add_property(
-	inner,
-	icalproperty_vanew_attendee(
-	    delegatee,
-	    icalparameter_new_delegatedfrom(
-		icalproperty_get_attendee(attendee)
-		),
-	    0
-	    )
-	);
-	     
-
-    return reply;
-
-}
-
-
-icalcomponent* icalmessage_new_cancel_event(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-icalcomponent* icalmessage_new_cancel_instance(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-icalcomponent* icalmessage_new_cancel_all(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-
-
-
-icalcomponent* icalmessage_new_error_reply(icalcomponent* c,
-					   const char* user,
-					   const char* msg,
-					   const char* debug,
-					   icalrequeststatus code)
-{
-    icalcomponent *reply;
-    icalcomponent *inner, *cinner;
-    struct icalreqstattype rs;
-
-    icalerror_check_arg_rz(c,"c");
-    
-    reply = icalmessage_new_reply_base(c,user,msg);
-    inner = icalmessage_get_inner(reply);
-    cinner = icalmessage_get_inner(c);
-    if(reply == 0){
-	return 0;
-    }
-
-    if( code != ICAL_UNKNOWN_STATUS){
-	rs.code = code;
-	rs.debug = debug;
-	
-	icalcomponent_add_property(inner, 
-				   icalproperty_new_requeststatus(rs));
-    } else { /*  code == ICAL_UNKNOWN_STATUS */ 
-
-	/* Copy all of the request status properties */
-	icalproperty *p;
-	for(p = icalcomponent_get_first_property(cinner,
-						 ICAL_REQUESTSTATUS_PROPERTY);
-	    p != 0;
-	    p = icalcomponent_get_next_property(cinner,
-						ICAL_REQUESTSTATUS_PROPERTY)){
-
-	    
-	    icalcomponent_add_property(inner,icalproperty_new_clone(p));
-	}
-    }
-
-    return reply;
-}
Index: libkcal/libical/src/libicalss/icalsslexer.c
===================================================================
--- libkcal/libical/src/libicalss/icalsslexer.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalsslexer.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,2485 +0,0 @@
-#define YY_REENTRANT 1
-#define YY_TEXT_IS_ARRAY
-#define YY_REENTRANT_BISON_PURE 1
-#ifndef YY_REENTRANT
-#define yytext sstext
-#define yyleng ssleng
-#define yyin ssin
-#define yyout ssout
-#endif
-#define yy_create_buffer ss_create_buffer
-#define yy_delete_buffer ss_delete_buffer
-#define yy_scan_buffer ss_scan_buffer
-#define yy_scan_string ss_scan_string
-#define yy_scan_bytes ss_scan_bytes
-#define yy_flex_debug ss_flex_debug
-#define yy_init_buffer ss_init_buffer
-#define yy_flush_buffer ss_flush_buffer
-#define yy_load_buffer_state ss_load_buffer_state
-#define yy_switch_to_buffer ss_switch_to_buffer
-#define yylex sslex
-#define yyrestart ssrestart
-#define yylex_init sslex_init
-#define yylex_destroy sslex_destroy
-#define yyget_extra ssget_extra
-#define yyset_extra ssset_extra
-#define yyget_in ssget_in
-#define yyset_in ssset_in
-#define yyget_out ssget_out
-#define yyset_out ssset_out
-#define yyget_leng ssget_leng
-#define yyget_text ssget_text
-#define yyget_lineno ssget_lineno
-#define yyset_lineno ssset_lineno
-#ifdef YY_REENTRANT_BISON_PURE
-#define yyget_lval ssget_lval
-#define yyset_lval ssset_lval
-#ifdef YYLTYPE
-#define yyget_lloc ssget_lloc
-#define yyset_lloc ssset_lloc
-#endif
-#endif
-#define yywrap sswrap
-
-/* -*-C-*- */
-/* A lexical scanner generated by flex */
-
-#define FLEX_SCANNER
-#define YY_FLEX_MAJOR_VERSION 2
-#define YY_FLEX_MINOR_VERSION 5
-
-/* %- */
-/* begin standard C headers. */
-#include <stdio.h>
-#include <errno.h>
-#include <stdlib.h>
-/* end standard C headers. */
-/* %+ */
-/* %* */
-
-#ifdef __cplusplus
-
-/* %+ */
-/* %* */
-
-/* Use prototypes in function declarations. */
-#define YY_USE_PROTOS
-
-/* The "const" storage-class-modifier is valid. */
-#define YY_USE_CONST
-
-#else	/* ! __cplusplus */
-
-#if __STDC__
-
-#define YY_USE_PROTOS
-#define YY_USE_CONST
-
-#endif	/* __STDC__ */
-#endif	/* ! __cplusplus */
-
-#ifdef YY_USE_CONST
-#define yyconst const
-#else
-#define yyconst
-#endif
-
-
-#ifdef YY_USE_PROTOS
-#define YY_PROTO(proto) proto
-#else
-#define YY_PROTO(proto) ()
-#endif
-
-/* Returned upon end-of-file. */
-#define YY_NULL 0
-
-/* Promotes a possibly negative, possibly signed char to an unsigned
- * integer for use as an array index.  If the signed char is negative,
- * we want to instead treat it as an 8-bit unsigned char, hence the
- * double cast.
- */
-#define YY_SC_TO_UI(c) ((unsigned int) (unsigned char) c)
-
-
-#ifdef YY_REENTRANT
-
-/* An opaque pointer. */
-#ifndef YY_TYPEDEF_YY_SCANNER_T
-#define YY_TYPEDEF_YY_SCANNER_T
-typedef void* yyscan_t;
-#endif
-
-/* For use wherever a Global is accessed or assigned. */
-#define YY_G(var) (((struct yy_globals_t*)yy_globals)->var)
-
-/* For use in function prototypes to append the additional argument. */
-#ifdef YY_USE_PROTOS
-#define YY_LAST_ARG , yyscan_t yy_globals
-#define YY_ONLY_ARG    yyscan_t yy_globals
-#else
-#define YY_LAST_ARG , yy_globals
-#define YY_ONLY_ARG    yy_globals
-#define YY_DECL_LAST_ARG yyscan_t yy_globals;
-#endif
-
-/* For use in function calls to pass the additional argument. */
-#define YY_CALL_LAST_ARG  , yy_globals
-#define YY_CALL_ONLY_ARG   yy_globals
-
-/* For convenience, these vars (plus the bison vars far below)
-   are macros in the reentrant scanner. */
-#define yyin YY_G(yyin_r)
-#define yyout YY_G(yyout_r)
-#define yyextra YY_G(yyextra_r)
-#define yyleng YY_G(yyleng_r)
-#define yytext YY_G(yytext_r)
-#define yylineno YY_G(yylineno_r)
-
-int yylex_init YY_PROTO((yyscan_t* scanner));
-int yylex_destroy YY_PROTO((yyscan_t scanner));
-
-#else /* not YY_REENTRANT */
-
-  /* Define these macros to be no-ops. */
-#define YY_G(var) (var)
-#define YY_LAST_ARG
-#define YY_ONLY_ARG  void
-#define YY_CALL_LAST_ARG
-#define YY_CALL_ONLY_ARG
-#define YY_DECL_LAST_ARG
-#endif
-
-/* Enter a start condition.  This macro really ought to take a parameter,
- * but we do it the disgusting crufty way forced on us by the ()-less
- * definition of BEGIN.
- */
-#define BEGIN YY_G(yy_start) = 1 + 2 *
-
-/* Translate the current start state into a value that can be later handed
- * to BEGIN to return to the state.  The YYSTATE alias is for lex
- * compatibility.
- */
-#define YY_START ((YY_G(yy_start) - 1) / 2)
-#define YYSTATE YY_START
-
-/* Action number for EOF rule of a given start state. */
-#define YY_STATE_EOF(state) (YY_END_OF_BUFFER + state + 1)
-
-/* Special action meaning "start processing a new file". */
-#define YY_NEW_FILE yyrestart( yyin YY_CALL_LAST_ARG )
-
-#define YY_END_OF_BUFFER_CHAR 0
-
-/* Size of default input buffer. */
-#define YY_BUF_SIZE 16384
-
-
-#ifndef YY_TYPEDEF_YY_BUFFER_STATE
-#define YY_TYPEDEF_YY_BUFFER_STATE
-typedef struct yy_buffer_state *YY_BUFFER_STATE;
-#endif
-
-#ifndef YY_REENTRANT
-extern size_t yyleng;
-#endif
-
-/* %- */
-#ifndef YY_REENTRANT
-extern FILE *yyin, *yyout;
-#endif
-/* %* */
-
-#define EOB_ACT_CONTINUE_SCAN 0
-#define EOB_ACT_END_OF_FILE 1
-#define EOB_ACT_LAST_MATCH 2
-
-/* The funky do-while in the following #define is used to turn the definition
- * int a single C statement (which needs a semi-colon terminator).  This
- * avoids problems with code like:
- *
- * 	if ( condition_holds )
- *		yyless( 5 );
- *	else
- *		do_something_else();
- *
- * Prior to using the do-while the compiler would get upset at the
- * "else" because it interpreted the "if" statement as being all
- * done when it reached the ';' after the yyless() call.
- */
-
-/* Return all but the first 'n' matched characters back to the input stream. */
-
-#define yyless(n) \
-	do \
-		{ \
-		/* Undo effects of setting up yytext. */ \
-		*yy_cp = YY_G(yy_hold_char); \
-		YY_RESTORE_YY_MORE_OFFSET \
-		YY_G(yy_c_buf_p) = yy_cp = yy_bp + n - YY_MORE_ADJ; \
-		YY_DO_BEFORE_ACTION; /* set up yytext again */ \
-		} \
-	while ( 0 )
-
-#define unput(c) yyunput( c, YY_G(yytext_ptr) YY_CALL_LAST_ARG )
-
-/* The following is because we cannot portably get our hands on size_t
- * (without autoconf's help, which isn't available because we want
- * flex-generated scanners to compile on their own).
- */
-
-#ifndef YY_TYPEDEF_YY_SIZE_T
-#define YY_TYPEDEF_YY_SIZE_T
-typedef unsigned int yy_size_t;
-#endif
-
-#ifndef YY_STRUCT_YY_BUFFER_STATE
-#define YY_STRUCT_YY_BUFFER_STATE
-struct yy_buffer_state
-	{
-/* %- */
-	FILE *yy_input_file;
-/* %+ */
-/* %* */
-
-	char *yy_ch_buf;		/* input buffer */
-	char *yy_buf_pos;		/* current position in input buffer */
-
-	/* Size of input buffer in bytes, not including room for EOB
-	 * characters.
-	 */
-	yy_size_t yy_buf_size;
-
-	/* Number of characters read into yy_ch_buf, not including EOB
-	 * characters.
-	 */
-	int yy_n_chars;
-
-	/* Whether we "own" the buffer - i.e., we know we created it,
-	 * and can realloc() it to grow it, and should free() it to
-	 * delete it.
-	 */
-	int yy_is_our_buffer;
-
-	/* Whether this is an "interactive" input source; if so, and
-	 * if we're using stdio for input, then we want to use getc()
-	 * instead of fread(), to make sure we stop fetching input after
-	 * each newline.
-	 */
-	int yy_is_interactive;
-
-	/* Whether we're considered to be at the beginning of a line.
-	 * If so, '^' rules will be active on the next match, otherwise
-	 * not.
-	 */
-	int yy_at_bol;
-
-	/* Whether to try to fill the input buffer when we reach the
-	 * end of it.
-	 */
-	int yy_fill_buffer;
-
-	int yy_buffer_status;
-#define YY_BUFFER_NEW 0
-#define YY_BUFFER_NORMAL 1
-	/* When an EOF's been seen but there's still some text to process
-	 * then we mark the buffer as YY_EOF_PENDING, to indicate that we
-	 * shouldn't try reading from the input source any more.  We might
-	 * still have a bunch of tokens to match, though, because of
-	 * possible backing-up.
-	 *
-	 * When we actually see the EOF, we change the status to "new"
-	 * (via yyrestart()), so that the user can continue scanning by
-	 * just pointing yyin at a new input file.
-	 */
-#define YY_BUFFER_EOF_PENDING 2
-	};
-#endif /* !YY_STRUCT_YY_BUFFER_STATE */
-
-/* %- Standard (non-C++) definition */
-/* %c */
-#ifndef ssIN_HEADER
-#ifndef YY_REENTRANT
-static YY_BUFFER_STATE yy_current_buffer = 0;
-#endif
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %* */
-
-/* We provide macros for accessing buffer states in case in the
- * future we want to put the buffer states in a more general
- * "scanner state".
- */
-#define YY_CURRENT_BUFFER yy_current_buffer
-
-
-/* %- Standard (non-C++) definition */
-
-#ifndef YY_REENTRANT
-/* %c */
-#ifndef ssIN_HEADER
-/* yy_hold_char holds the character lost when yytext is formed. */
-static char yy_hold_char;
-
-static int yy_n_chars;		/* number of characters read into yy_ch_buf */
-
-
-size_t yyleng;
-
-/* Points to current character in buffer. */
-static char *yy_c_buf_p = (char *) 0;
-static int yy_init = 1;		/* whether we need to initialize */
-static int yy_start = 0;	/* start state number */
-
-/* Flag which is used to allow yywrap()'s to do buffer switches
- * instead of setting up a fresh yyin.  A bit of a hack ...
- */
-static int yy_did_buffer_switch_on_eof;
-/* %e */
-#endif /* !ssIN_HEADER */
-#endif /* end !YY_REENTRANT */
-
-void yyrestart YY_PROTO(( FILE *input_file YY_LAST_ARG ));
-
-
-void yy_switch_to_buffer YY_PROTO(( YY_BUFFER_STATE new_buffer YY_LAST_ARG ));
-void yy_load_buffer_state YY_PROTO(( YY_ONLY_ARG ));
-YY_BUFFER_STATE yy_create_buffer YY_PROTO(( FILE *file, int size YY_LAST_ARG ));
-void yy_delete_buffer YY_PROTO(( YY_BUFFER_STATE b YY_LAST_ARG ));
-void yy_init_buffer YY_PROTO(( YY_BUFFER_STATE b, FILE *file YY_LAST_ARG ));
-void yy_flush_buffer YY_PROTO(( YY_BUFFER_STATE b YY_LAST_ARG ));
-
-#define YY_FLUSH_BUFFER yy_flush_buffer( YY_G(yy_current_buffer) YY_CALL_LAST_ARG)
-
-YY_BUFFER_STATE yy_scan_buffer YY_PROTO(( char *base, yy_size_t size YY_LAST_ARG ));
-YY_BUFFER_STATE yy_scan_string YY_PROTO(( yyconst char *yy_str YY_LAST_ARG ));
-YY_BUFFER_STATE yy_scan_bytes YY_PROTO(( yyconst char *bytes, int len YY_LAST_ARG ));
-
-/* %* */
-
-/* %c */
-#ifndef ssIN_HEADER
-static void *yy_flex_alloc YY_PROTO(( yy_size_t YY_LAST_ARG ));
-static void *yy_flex_realloc YY_PROTO(( void *, yy_size_t YY_LAST_ARG ));
-static void yy_flex_free YY_PROTO(( void * YY_LAST_ARG ));
-/* %e */
-#endif /* !ssIN_HEADER */
-
-#define yy_new_buffer yy_create_buffer
-
-#define yy_set_interactive(is_interactive) \
-	{ \
-	if ( ! YY_G(yy_current_buffer) ) \
-		YY_G(yy_current_buffer) =    \
-            yy_create_buffer( yyin, YY_BUF_SIZE YY_CALL_LAST_ARG); \
-	YY_G(yy_current_buffer)->yy_is_interactive = is_interactive; \
-	}
-
-#define yy_set_bol(at_bol) \
-	{ \
-	if ( ! YY_G(yy_current_buffer) ) \
-		YY_G(yy_current_buffer) =    \
-            yy_create_buffer( yyin, YY_BUF_SIZE YY_CALL_LAST_ARG); \
-	YY_G(yy_current_buffer)->yy_at_bol = at_bol; \
-	}
-
-#define YY_AT_BOL() (YY_G(yy_current_buffer)->yy_at_bol)
-
-/* %% [1.0] yytext/yyin/yyout/yy_state_type/yylineno etc. def's & init go here */
-/* Begin user sect3 */
-#ifndef ssIN_HEADER
-typedef unsigned char YY_CHAR;
-#endif /* !ssIN_HEADER */
-#ifndef ssIN_HEADER
-#ifndef YY_REENTRANT
-FILE *yyin = (FILE *) 0, *yyout = (FILE *) 0;
-#endif
-#endif /* !ssIN_HEADER */
-#ifndef ssIN_HEADER
-typedef int yy_state_type;
-#endif /* !ssIN_HEADER */
-
-/* %- Standard (non-C++) definition */
-/* %c */
-#ifndef ssIN_HEADER
-static yy_state_type yy_get_previous_state YY_PROTO(( YY_ONLY_ARG ));
-static yy_state_type yy_try_NUL_trans YY_PROTO(( yy_state_type current_state  YY_LAST_ARG));
-static int yy_get_next_buffer YY_PROTO(( YY_ONLY_ARG ));
-static void yy_fatal_error YY_PROTO(( yyconst char msg[] ));
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %* */
-
-/* Done after the current pattern has been matched and before the
- * corresponding action - sets up yytext.
- */
-#define YY_DO_BEFORE_ACTION \
-	YY_G(yytext_ptr) = yy_bp; \
-/* %% [2.0] code to fiddle yytext and yyleng for yymore() goes here \ */\
-	yyleng = (size_t) (yy_cp - yy_bp); \
-	YY_G(yy_hold_char) = *yy_cp; \
-	*yy_cp = '\0'; \
-/* %% [3.0] code to copy yytext_ptr to yytext[] goes here, if %array \ */\
-	if ( yyleng >= YYLMAX ) \
-		YY_FATAL_ERROR( "token too large, exceeds YYLMAX" ); \
-	yy_flex_strncpy( yytext, YY_G(yytext_ptr), yyleng + 1 YY_CALL_LAST_ARG); \
-	YY_G(yy_c_buf_p) = yy_cp;
-
-/* %* */
-
-/* %c */
-#ifndef ssIN_HEADER
-/* %% [4.0] data tables for the DFA and the user's section 1 definitions go here */
-#define YY_NUM_RULES 23
-#define YY_END_OF_BUFFER 24
-static yyconst short int yy_accept[56] =
-    {   0,
-        0,    0,    0,    0,    0,    0,   24,   22,   18,   18,
-       22,   17,   21,    4,   19,    8,    5,    9,   21,   21,
-       21,   21,   21,   21,   21,   18,    7,    0,   21,   10,
-        6,   11,   21,   21,   14,   21,   21,   13,   21,   21,
-       20,   12,   21,   15,   21,   21,   21,    2,   16,   21,
-       21,   21,    3,    1,    0
-    } ;
-
-static yyconst int yy_ec[256] =
-    {   0,
-        1,    1,    1,    1,    1,    1,    1,    1,    2,    3,
-        1,    1,    2,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    4,    5,    1,    1,    1,    1,    1,    6,    1,
-        1,    7,    1,    8,    7,    7,    1,    7,    7,    7,
-        7,    7,    7,    7,    7,    7,    7,    9,   10,   11,
-       12,   13,    1,    7,   14,    7,   15,   16,   17,   18,
-        7,   19,   20,    7,    7,   21,   22,   23,   24,    7,
-        7,   25,   26,   27,   28,    7,   29,    7,    7,    7,
-        1,    1,    1,    1,    1,    1,   14,    7,   15,   16,
-
-       17,   18,    7,   19,   20,    7,    7,   21,   22,   23,
-       24,    7,    7,   25,   26,   27,   28,    7,   29,    7,
-        7,    7,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1
-    } ;
-
-static yyconst int yy_meta[30] =
-    {   0,
-        1,    1,    1,    2,    1,    1,    3,    1,    2,    1,
-        1,    1,    1,    3,    3,    3,    3,    3,    3,    3,
-        3,    3,    3,    3,    3,    3,    3,    3,    3
-    } ;
-
-static yyconst short int yy_base[58] =
-    {   0,
-        0,    0,    0,    0,    0,    0,   68,   69,   28,   31,
-       55,    0,    0,   69,   69,   54,   53,   52,   40,   37,
-       35,   12,   35,   42,   39,   35,   69,   51,    0,   69,
-       69,   69,   40,   31,    0,   27,   32,    0,   31,   34,
-       69,    0,   28,    0,   28,   31,   22,    0,    0,   31,
-       28,   17,    0,    0,   69,   39,   40
-    } ;
-
-static yyconst short int yy_def[58] =
-    {   0,
-       55,    1,    1,    1,    1,    1,   55,   55,   55,   55,
-       55,   56,   57,   55,   55,   55,   55,   55,   57,   57,
-       57,   57,   57,   57,   57,   55,   55,   56,   57,   55,
-       55,   55,   57,   57,   57,   57,   57,   57,   57,   57,
-       55,   57,   57,   57,   57,   57,   57,   57,   57,   57,
-       57,   57,   57,   57,    0,   55,   55
-    } ;
-
-static yyconst short int yy_nxt[99] =
-    {   0,
-        8,    9,   10,    9,   11,   12,   13,   14,    8,   15,
-       16,   17,   18,   19,   13,   13,   13,   20,   13,   21,
-       13,   13,   22,   23,   13,   24,   13,   13,   25,   26,
-       26,   26,   26,   26,   26,   36,   26,   26,   26,   37,
-       28,   28,   29,   54,   53,   52,   51,   50,   49,   48,
-       47,   46,   45,   44,   43,   42,   41,   40,   39,   38,
-       35,   34,   33,   32,   31,   30,   27,   55,    7,   55,
-       55,   55,   55,   55,   55,   55,   55,   55,   55,   55,
-       55,   55,   55,   55,   55,   55,   55,   55,   55,   55,
-       55,   55,   55,   55,   55,   55,   55,   55
-
-    } ;
-
-static yyconst short int yy_chk[99] =
-    {   0,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    1,
-        1,    1,    1,    1,    1,    1,    1,    1,    1,    9,
-        9,    9,   10,   10,   10,   22,   26,   26,   26,   22,
-       56,   56,   57,   52,   51,   50,   47,   46,   45,   43,
-       40,   39,   37,   36,   34,   33,   28,   25,   24,   23,
-       21,   20,   19,   18,   17,   16,   11,    7,   55,   55,
-       55,   55,   55,   55,   55,   55,   55,   55,   55,   55,
-       55,   55,   55,   55,   55,   55,   55,   55,   55,   55,
-       55,   55,   55,   55,   55,   55,   55,   55
-
-    } ;
-
-/* The intent behind this definition is that it'll catch
- * any uses of REJECT which flex missed.
- */
-#define REJECT reject_used_but_not_detected
-#define yymore() yymore_used_but_not_detected
-#define YY_MORE_ADJ 0
-#define YY_RESTORE_YY_MORE_OFFSET
-#ifndef YYLMAX
-#define YYLMAX 8192
-#endif
-
-#ifndef YY_REENTRANT
-char yytext[YYLMAX];
-char *yytext_ptr;
-#endif
-#line 1 "icalsslexer.l"
-#define INITIAL 0
-#line 2 "icalsslexer.l"
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalsslexer.l
-  CREATOR: eric 8 Aug 2000
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-(C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-  ======================================================================*/
-
-#include "icalssyacc.h"
-#include "icalgaugeimpl.h"
-#include "assert.h"
-
-#include <string.h> /* For strdup() */
-
-#undef YYPURE
-#define YYPURE
-
-#undef SS_FATAL_ERROR
-#define SS_FATAL_ERROR(msg) sserror(msg)
-
-#define sql 1
-#define string_value 2
-
-#line 596 "lex.ss.c"
-/* %e */
-#endif /* !ssIN_HEADER */
-
-/* Special case for "unistd.h", since it is non-ANSI. We include it way
- * down here because we want the user's section 1 to have been scanned first.
- * The user has a chance to override it with an option.
- */
-#ifndef YY_NO_UNISTD_H
-/* %- */
-#include <unistd.h>
-/* %+ */
-/* %* */
-#endif /* !YY_NO_UNISTD_H */
-
-
-#ifndef YY_EXTRA_TYPE
-#define YY_EXTRA_TYPE void *
-#endif
-
-/* %- Reentrant structure and macros (non-C++). */
-#ifdef YY_REENTRANT
-
-/* %c */
-#ifndef ssIN_HEADER
-struct yy_globals_t
-    {
-
-    /* User-defined. Not touched by flex. */
-    YY_EXTRA_TYPE yyextra_r;
-
-    /* The rest are the same as the globals declared in the non-reentrant scanner. */
-    FILE *yyin_r, *yyout_r;
-    YY_BUFFER_STATE yy_current_buffer;
-    char yy_hold_char;
-    int yy_n_chars;
-    int yyleng_r;
-    char *yy_c_buf_p;
-    int yy_init;
-    int yy_start;
-    int yy_did_buffer_switch_on_eof;
-    int yy_start_stack_ptr;
-    int yy_start_stack_depth;
-    int *yy_start_stack;
-    yy_state_type yy_last_accepting_state;
-    char* yy_last_accepting_cpos;
-
-    int yylineno_r;
-
-#ifdef YY_TEXT_IS_ARRAY
-    char yytext_r[YYLMAX];
-    char *yytext_ptr;
-    int yy_more_offset;
-    int yy_prev_more_offset;
-#else
-    char *yytext_r;
-    int yy_more_flag;
-    int yy_more_len;
-#endif
-
-#ifdef YY_REENTRANT_BISON_PURE
-    YYSTYPE * yylval_r;
-#ifdef YYLTYPE
-    YYLTYPE * yylloc_r;
-#endif
-#endif
-
-    };
-/* %e */
-#endif /* !ssIN_HEADER */
-
-/* %c */
-#ifndef ssIN_HEADER
-static int yy_init_globals YY_PROTO(( yyscan_t ));
-/* %e */
-#endif /* !ssIN_HEADER */
-
-/* This must go here because YYSTYPE and YYLSTYPE are included
- * from bison output in section 1.*/
-#ifdef YY_REENTRANT_BISON_PURE
-#    define yylval YY_G(yylval_r)
-#  ifdef YYLTYPE
-#    define yylloc YY_G(yylloc_r)
-#  endif
-#endif /* YY_REENTRANT_BISON_PURE */
-
-#endif /* end if YY_REENTRANT */
-
-/* Accessor methods to globals.
-   These are made visible to non-reentrant scanners for convenience. */
-#ifndef YY_NO_GET_EXTRA
-YY_EXTRA_TYPE yyget_extra YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_SET_EXTRA
-void yyset_extra YY_PROTO(( YY_EXTRA_TYPE user_defined YY_LAST_ARG ));
-#endif
-
-#ifndef YY_NO_GET_IN
-FILE *yyget_in YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_SET_IN
-void yyset_in  YY_PROTO(( FILE * in_str YY_LAST_ARG ));
-#endif
-
-#ifndef YY_NO_GET_OUT
-FILE *yyget_out YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_SET_OUT
-void yyset_out  YY_PROTO(( FILE * out_str YY_LAST_ARG ));
-#endif
-
-#ifndef YY_NO_GET_LENG
-int yyget_leng YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_GET_TEXT
-char *yyget_text YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_GET_LINENO
-int yyget_lineno YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#ifndef YY_NO_SET_LINENO
-void yyset_lineno YY_PROTO(( int line_number YY_LAST_ARG ));
-#endif
-
-#ifdef YY_REENTRANT_BISON_PURE
-#ifndef YY_NO_GET_LVAL
-YYSTYPE * yyget_lval YY_PROTO(( YY_ONLY_ARG ));
-#endif
-void yyset_lval YY_PROTO(( YYSTYPE * yylvalp YY_LAST_ARG ));
-#ifdef YYLTYPE
-#ifndef YY_NO_GET_LLOC
-   YYLTYPE *yyget_lloc YY_PROTO(( YY_ONLY_ARG ));
-#endif
-#ifndef YY_NO_SET_LLOC
-    void yyset_lloc YY_PROTO(( YYLTYPE * yyllocp YY_LAST_ARG ));
-#endif
-#endif /* YYLTYPE */
-#endif /* YY_REENTRANT_BISON_PURE */
-
-/* Macros after this point can all be overridden by user definitions in
- * section 1.
- */
-
-#ifndef YY_SKIP_YYWRAP
-#ifdef __cplusplus
-extern "C" int yywrap YY_PROTO(( YY_ONLY_ARG ));
-#else
-extern int yywrap YY_PROTO(( YY_ONLY_ARG ));
-#endif
-#endif
-
-/* %- */
-/* %c */
-#ifndef ssIN_HEADER
-#ifndef YY_NO_UNPUT
-static void yyunput YY_PROTO(( int c, char *buf_ptr  YY_LAST_ARG));
-#endif
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %* */
-
-#ifndef yytext_ptr
-static void yy_flex_strncpy YY_PROTO(( char *, yyconst char *, int YY_LAST_ARG));
-#endif
-
-#ifdef YY_NEED_STRLEN
-static int yy_flex_strlen YY_PROTO(( yyconst char * YY_LAST_ARG));
-#endif
-
-#ifndef YY_NO_INPUT
-/* %- Standard (non-C++) definition */
-/* %c */
-#ifndef ssIN_HEADER
-#ifdef __cplusplus
-static int yyinput YY_PROTO(( YY_ONLY_ARG ));
-#else
-static int input YY_PROTO(( YY_ONLY_ARG ));
-#endif
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %* */
-#endif
-
-#if YY_STACK_USED
-#ifndef YY_REENTRANT
-/* %c */
-#ifndef ssIN_HEADER
-static int yy_start_stack_ptr = 0;
-static int yy_start_stack_depth = 0;
-static int *yy_start_stack = 0;
-/* %e */
-#endif /* !ssIN_HEADER */
-#endif
-#ifndef YY_NO_PUSH_STATE
-static void yy_push_state YY_PROTO(( int new_state YY_LAST_ARG));
-#endif
-#ifndef YY_NO_POP_STATE
-static void yy_pop_state YY_PROTO(( YY_ONLY_ARG ));
-#endif
-#ifndef YY_NO_TOP_STATE
-static int yy_top_state YY_PROTO(( YY_ONLY_ARG ));
-#endif
-
-#else
-#define YY_NO_PUSH_STATE 1
-#define YY_NO_POP_STATE 1
-#define YY_NO_TOP_STATE 1
-#endif
-
-/* Amount of stuff to slurp up with each read. */
-#ifndef YY_READ_BUF_SIZE
-#define YY_READ_BUF_SIZE 8192
-#endif
-
-/* Copy whatever the last rule matched to the standard output. */
-
-#ifndef ECHO
-/* %- Standard (non-C++) definition */
-/* This used to be an fputs(), but since the string might contain NUL's,
- * we now use fwrite().
- */
-#define ECHO (void) fwrite( yytext, yyleng, 1, yyout )
-/* %+ C++ definition */
-/* %* */
-#endif
-
-/* Gets input and stuffs it into "buf".  number of characters read, or YY_NULL,
- * is returned in "result".
- */
-#ifndef YY_INPUT
-#define YY_INPUT(buf,result,max_size) \
-/* %% [5.0] fread()/read() definition of YY_INPUT goes here unless we're doing C++ \ */\
-	if ( YY_G(yy_current_buffer)->yy_is_interactive ) \
-		{ \
-		int c = '*'; \
-		size_t n; \
-		for ( n = 0; n < max_size && \
-			     (c = getc( yyin )) != EOF && c != '\n'; ++n ) \
-			buf[n] = (char) c; \
-		if ( c == '\n' ) \
-			buf[n++] = (char) c; \
-		if ( c == EOF && ferror( yyin ) ) \
-			YY_FATAL_ERROR( "input in flex scanner failed" ); \
-		result = n; \
-		} \
-	else \
-		{ \
-		errno=0; \
-		while ( (result = fread(buf, 1, max_size, yyin))==0 && ferror(yyin)) \
-			{ \
-			if( errno != EINTR) \
-				{ \
-				YY_FATAL_ERROR( "input in flex scanner failed" ); \
-				break; \
-				} \
-			errno=0; \
-			clearerr(yyin); \
-			} \
-		}
-/* %+ C++ definition \ */\
-/* %* */
-#endif
-
-/* No semi-colon after return; correct usage is to write "yyterminate();" -
- * we don't want an extra ';' after the "return" because that will cause
- * some compilers to complain about unreachable statements.
- */
-#ifndef yyterminate
-#define yyterminate() return YY_NULL
-#endif
-
-/* Number of entries by which start-condition stack grows. */
-#ifndef YY_START_STACK_INCR
-#define YY_START_STACK_INCR 25
-#endif
-
-/* Report a fatal error. */
-#ifndef YY_FATAL_ERROR
-/* %- */
-#define YY_FATAL_ERROR(msg) yy_fatal_error( msg )
-/* %+ */
-/* %* */
-#endif
-
-/* Default declaration of generated scanner - a define so the user can
- * easily add parameters.
- */
-#ifndef YY_DECL
-/* %- Standard (non-C++) definition */
-
-/* If the bison pure parser is used, then bison will provide
-   one or two additional arguments. */
-
-#ifdef YY_REENTRANT_BISON_PURE
-#  ifdef YYLTYPE 
-#    ifdef YY_USE_PROTOS
-#        define YY_LEX_ARGS (YYSTYPE * yylvalp, YYLTYPE * yyllocp YY_LAST_ARG)
-#    else
-#        define YY_LEX_ARGS (yylvalp, yyllocp YY_LAST_ARG) \
-                             YYSTYPE * yylvalp; YYLTYPE * yyllocp; YY_DECL_LAST_ARG
-#    endif
-#  else
-#    ifdef YY_USE_PROTOS
-#        define YY_LEX_ARGS (YYSTYPE * yylvalp YY_LAST_ARG)
-#    else
-#        define YY_LEX_ARGS (yylvalp YY_LAST_ARG) \
-                             YYSTYPE * yylvalp; YY_DECL_LAST_ARG
-#    endif
-#  endif
-#else
-#  ifdef YY_USE_PROTOS
-#      define YY_LEX_ARGS (YY_ONLY_ARG)
-#  else
-#      define YY_LEX_ARGS (YY_ONLY_ARG) YY_DECL_LAST_ARG
-#  endif
-#endif
-
-
-extern int yylex YY_PROTO( YY_LEX_ARGS );
-
-#define YY_DECL int yylex YY_LEX_ARGS
-/* %+ C++ definition */
-/* %* */
-#endif
-
-/* Code executed at the beginning of each rule, after yytext and yyleng
- * have been set up.
- */
-#ifndef YY_USER_ACTION
-#define YY_USER_ACTION
-#endif
-
-/* Code executed at the end of each rule. */
-#ifndef YY_BREAK
-#define YY_BREAK break;
-#endif
-
-/* %% [6.0] YY_RULE_SETUP definition goes here */
-#define YY_RULE_SETUP \
-	YY_USER_ACTION
-
-/* %c */
-#ifndef ssIN_HEADER
-YY_DECL
-	{
-	register yy_state_type yy_current_state;
-	register char *yy_cp, *yy_bp;
-	register int yy_act;
-
-/* %% [7.0] user's declarations go here */
-#line 66 "icalsslexer.l"
-
-
-
-
-
-
-#line 959 "lex.ss.c"
-
-#ifdef YY_REENTRANT_BISON_PURE
-    yylval = yylvalp;
-#ifdef YYLTYPE
-    yylloc = yyllocp;
-#endif
-#endif
-
-	if ( YY_G(yy_init) )
-		{
-		YY_G(yy_init) = 0;
-
-#ifdef YY_USER_INIT
-		YY_USER_INIT;
-#endif
-
-		if ( ! YY_G(yy_start) )
-			YY_G(yy_start) = 1;	/* first start state */
-
-		if ( ! yyin )
-/* %- */
-			yyin = stdin;
-/* %+ */
-/* %* */
-
-		if ( ! yyout )
-/* %- */
-			yyout = stdout;
-/* %+ */
-/* %* */
-
-		if ( ! YY_G(yy_current_buffer) )
-			YY_G(yy_current_buffer) =
-				yy_create_buffer( yyin, YY_BUF_SIZE YY_CALL_LAST_ARG);
-
-		yy_load_buffer_state( YY_CALL_ONLY_ARG );
-		}
-
-	while ( 1 )		/* loops until end-of-file is reached */
-		{
-/* %% [8.0] yymore()-related code goes here */
-		yy_cp = YY_G(yy_c_buf_p);
-
-		/* Support of yytext. */
-		*yy_cp = YY_G(yy_hold_char);
-
-		/* yy_bp points to the position in yy_ch_buf of the start of
-		 * the current run.
-		 */
-		yy_bp = yy_cp;
-
-/* %% [9.0] code to set up and find next match goes here */
-		yy_current_state = YY_G(yy_start);
-yy_match:
-		do
-			{
-			register YY_CHAR yy_c = yy_ec[YY_SC_TO_UI(*yy_cp)];
-			if ( yy_accept[yy_current_state] )
-				{
-				YY_G(yy_last_accepting_state) = yy_current_state;
-				YY_G(yy_last_accepting_cpos) = yy_cp;
-				}
-			while ( yy_chk[yy_base[yy_current_state] + yy_c] != yy_current_state )
-				{
-				yy_current_state = (int) yy_def[yy_current_state];
-				if ( yy_current_state >= 56 )
-					yy_c = yy_meta[(unsigned int) yy_c];
-				}
-			yy_current_state = yy_nxt[yy_base[yy_current_state] + (unsigned int) yy_c];
-			++yy_cp;
-			}
-		while ( yy_base[yy_current_state] != 69 );
-
-yy_find_action:
-/* %% [10.0] code to find the action number goes here */
-		yy_act = yy_accept[yy_current_state];
-		if ( yy_act == 0 )
-			{ /* have to back up */
-			yy_cp = YY_G(yy_last_accepting_cpos);
-			yy_current_state = YY_G(yy_last_accepting_state);
-			yy_act = yy_accept[yy_current_state];
-			}
-
-		YY_DO_BEFORE_ACTION;
-
-/* %% [11.0] code for yylineno update goes here */
-
-do_action:	/* This label is used only to access EOF actions. */
-
-/* %% [12.0] debug code goes here */
-
-		switch ( yy_act )
-	{ /* beginning of action switch */
-/* %% [13.0] actions go here */
-			case 0: /* must back up */
-			/* undo the effects of YY_DO_BEFORE_ACTION */
-			*yy_cp = YY_G(yy_hold_char);
-			yy_cp = YY_G(yy_last_accepting_cpos);
-			yy_current_state = YY_G(yy_last_accepting_state);
-			goto yy_find_action;
-
-case 1:
-YY_RULE_SETUP
-#line 72 "icalsslexer.l"
-{ return SELECT; }
-	YY_BREAK
-case 2:
-YY_RULE_SETUP
-#line 73 "icalsslexer.l"
-{ return FROM; }
-	YY_BREAK
-case 3:
-YY_RULE_SETUP
-#line 74 "icalsslexer.l"
-{ return WHERE; }
-	YY_BREAK
-case 4:
-YY_RULE_SETUP
-#line 75 "icalsslexer.l"
-{ return COMMA; }
-	YY_BREAK
-case 5:
-YY_RULE_SETUP
-#line 76 "icalsslexer.l"
-{ return EQUALS; }
-	YY_BREAK
-case 6:
-YY_RULE_SETUP
-#line 77 "icalsslexer.l"
-{ return EQUALS; }
-	YY_BREAK
-case 7:
-YY_RULE_SETUP
-#line 78 "icalsslexer.l"
-{ return NOTEQUALS; }
-	YY_BREAK
-case 8:
-YY_RULE_SETUP
-#line 79 "icalsslexer.l"
-{ return LESS; }
-	YY_BREAK
-case 9:
-YY_RULE_SETUP
-#line 80 "icalsslexer.l"
-{ return GREATER; }
-	YY_BREAK
-case 10:
-YY_RULE_SETUP
-#line 81 "icalsslexer.l"
-{ return LESSEQUALS; }
-	YY_BREAK
-case 11:
-YY_RULE_SETUP
-#line 82 "icalsslexer.l"
-{ return GREATEREQUALS; }
-	YY_BREAK
-case 12:
-YY_RULE_SETUP
-#line 83 "icalsslexer.l"
-{ return AND; }
-	YY_BREAK
-case 13:
-YY_RULE_SETUP
-#line 84 "icalsslexer.l"
-{ return OR; }
-	YY_BREAK
-case 14:
-YY_RULE_SETUP
-#line 85 "icalsslexer.l"
-{ return IS; }
-	YY_BREAK
-case 15:
-YY_RULE_SETUP
-#line 86 "icalsslexer.l"
-{ return NOT; }
-	YY_BREAK
-case 16:
-YY_RULE_SETUP
-#line 87 "icalsslexer.l"
-{ return SQLNULL; }
-	YY_BREAK
-case 17:
-YY_RULE_SETUP
-#line 88 "icalsslexer.l"
-{ return QUOTE; }
-	YY_BREAK
-case 18:
-YY_RULE_SETUP
-#line 89 "icalsslexer.l"
-;			
-	YY_BREAK
-case 19:
-YY_RULE_SETUP
-#line 90 "icalsslexer.l"
-{ return EOL; }
-	YY_BREAK
-case 20:
-YY_RULE_SETUP
-#line 92 "icalsslexer.l"
-{
-	int c = input(yy_globals);
-	unput(c);
-	if(c!='\''){
-		yylvalp->v_string= icalmemory_tmp_copy(yytext);
-		return STRING;
-	} else {
-		/*ssmore();*/
-	}
-}
-	YY_BREAK
-case 21:
-YY_RULE_SETUP
-#line 103 "icalsslexer.l"
-{
-        yylval->v_string= icalmemory_tmp_copy(yytext);
-	return STRING; 
-}
-	YY_BREAK
-case 22:
-YY_RULE_SETUP
-#line 109 "icalsslexer.l"
-{ return yytext[0]; }
-	YY_BREAK
-case 23:
-YY_RULE_SETUP
-#line 111 "icalsslexer.l"
-ECHO;
-	YY_BREAK
-#line 1188 "lex.ss.c"
-case YY_STATE_EOF(INITIAL):
-case YY_STATE_EOF(sql):
-case YY_STATE_EOF(string_value):
-	yyterminate();
-
-	case YY_END_OF_BUFFER:
-		{
-		/* Amount of text matched not including the EOB char. */
-		int yy_amount_of_matched_text = (int) (yy_cp - YY_G(yytext_ptr)) - 1;
-
-		/* Undo the effects of YY_DO_BEFORE_ACTION. */
-		*yy_cp = YY_G(yy_hold_char);
-		YY_RESTORE_YY_MORE_OFFSET
-
-		if ( YY_G(yy_current_buffer)->yy_buffer_status == YY_BUFFER_NEW )
-			{
-			/* We're scanning a new file or input source.  It's
-			 * possible that this happened because the user
-			 * just pointed yyin at a new source and called
-			 * yylex().  If so, then we have to assure
-			 * consistency between yy_current_buffer and our
-			 * globals.  Here is the right place to do so, because
-			 * this is the first action (other than possibly a
-			 * back-up) that will match for the new input source.
-			 */
-			YY_G(yy_n_chars) = YY_G(yy_current_buffer)->yy_n_chars;
-			YY_G(yy_current_buffer)->yy_input_file = yyin;
-			YY_G(yy_current_buffer)->yy_buffer_status = YY_BUFFER_NORMAL;
-			}
-
-		/* Note that here we test for yy_c_buf_p "<=" to the position
-		 * of the first EOB in the buffer, since yy_c_buf_p will
-		 * already have been incremented past the NUL character
-		 * (since all states make transitions on EOB to the
-		 * end-of-buffer state).  Contrast this with the test
-		 * in input().
-		 */
-		if ( YY_G(yy_c_buf_p) <= &YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars)] )
-			{ /* This was really a NUL. */
-			yy_state_type yy_next_state;
-
-			YY_G(yy_c_buf_p) = YY_G(yytext_ptr) + yy_amount_of_matched_text;
-
-			yy_current_state = yy_get_previous_state( YY_CALL_ONLY_ARG );
-
-			/* Okay, we're now positioned to make the NUL
-			 * transition.  We couldn't have
-			 * yy_get_previous_state() go ahead and do it
-			 * for us because it doesn't know how to deal
-			 * with the possibility of jamming (and we don't
-			 * want to build jamming into it because then it
-			 * will run more slowly).
-			 */
-
-			yy_next_state = yy_try_NUL_trans( yy_current_state YY_CALL_LAST_ARG);
-
-			yy_bp = YY_G(yytext_ptr) + YY_MORE_ADJ;
-
-			if ( yy_next_state )
-				{
-				/* Consume the NUL. */
-				yy_cp = ++YY_G(yy_c_buf_p);
-				yy_current_state = yy_next_state;
-				goto yy_match;
-				}
-
-			else
-				{
-/* %% [14.0] code to do back-up for compressed tables and set up yy_cp goes here */
-				yy_cp = YY_G(yy_c_buf_p);
-				goto yy_find_action;
-				}
-			}
-
-		else switch ( yy_get_next_buffer( YY_CALL_ONLY_ARG ) )
-			{
-			case EOB_ACT_END_OF_FILE:
-				{
-				YY_G(yy_did_buffer_switch_on_eof) = 0;
-
-				if ( yywrap( YY_CALL_ONLY_ARG ) )
-					{
-					/* Note: because we've taken care in
-					 * yy_get_next_buffer() to have set up
-					 * yytext, we can now set up
-					 * yy_c_buf_p so that if some total
-					 * hoser (like flex itself) wants to
-					 * call the scanner after we return the
-					 * YY_NULL, it'll still work - another
-					 * YY_NULL will get returned.
-					 */
-					YY_G(yy_c_buf_p) = YY_G(yytext_ptr) + YY_MORE_ADJ;
-
-					yy_act = YY_STATE_EOF(YY_START);
-					goto do_action;
-					}
-
-				else
-					{
-					if ( ! YY_G(yy_did_buffer_switch_on_eof) )
-						YY_NEW_FILE;
-					}
-				break;
-				}
-
-			case EOB_ACT_CONTINUE_SCAN:
-				YY_G(yy_c_buf_p) =
-					YY_G(yytext_ptr) + yy_amount_of_matched_text;
-
-				yy_current_state = yy_get_previous_state( YY_CALL_ONLY_ARG );
-
-				yy_cp = YY_G(yy_c_buf_p);
-				yy_bp = YY_G(yytext_ptr) + YY_MORE_ADJ;
-				goto yy_match;
-
-			case EOB_ACT_LAST_MATCH:
-				YY_G(yy_c_buf_p) =
-				&YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars)];
-
-				yy_current_state = yy_get_previous_state( YY_CALL_ONLY_ARG );
-
-				yy_cp = YY_G(yy_c_buf_p);
-				yy_bp = YY_G(yytext_ptr) + YY_MORE_ADJ;
-				goto yy_find_action;
-			}
-		break;
-		}
-
-	default:
-		YY_FATAL_ERROR(
-			"fatal flex scanner internal error--no action found" );
-	} /* end of action switch */
-		} /* end of scanning one token */
-	} /* end of yylex */
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %+ */
-/* %c */
-#ifndef ssIN_HEADER
-/* %e */
-#endif /* !ssIN_HEADER */
-/* %* */
-
-/* yy_get_next_buffer - try to read in a new buffer
- *
- * Returns a code representing an action:
- *	EOB_ACT_LAST_MATCH -
- *	EOB_ACT_CONTINUE_SCAN - continue scanning from current position
- *	EOB_ACT_END_OF_FILE - end of file
- */
-
-/* %- */
-/* %c */
-#ifndef ssIN_HEADER
-#ifdef YY_USE_PROTOS
-static int yy_get_next_buffer(YY_ONLY_ARG)
-#else
-static int yy_get_next_buffer(YY_ONLY_ARG)
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	register char *dest = YY_G(yy_current_buffer)->yy_ch_buf;
-	register char *source = YY_G(yytext_ptr);
-	register int number_to_move, i;
-	int ret_val;
-
-	if ( YY_G(yy_c_buf_p) > &YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars) + 1] )
-		YY_FATAL_ERROR(
-		"fatal flex scanner internal error--end of buffer missed" );
-
-	if ( YY_G(yy_current_buffer)->yy_fill_buffer == 0 )
-		{ /* Don't try to fill the buffer, so this is an EOF. */
-		if ( YY_G(yy_c_buf_p) - YY_G(yytext_ptr) - YY_MORE_ADJ == 1 )
-			{
-			/* We matched a single character, the EOB, so
-			 * treat this as a final EOF.
-			 */
-			return EOB_ACT_END_OF_FILE;
-			}
-
-		else
-			{
-			/* We matched some text prior to the EOB, first
-			 * process it.
-			 */
-			return EOB_ACT_LAST_MATCH;
-			}
-		}
-
-	/* Try to read more data. */
-
-	/* First move last chars to start of buffer. */
-	number_to_move = (int) (YY_G(yy_c_buf_p) - YY_G(yytext_ptr)) - 1;
-
-	for ( i = 0; i < number_to_move; ++i )
-		*(dest++) = *(source++);
-
-	if ( YY_G(yy_current_buffer)->yy_buffer_status == YY_BUFFER_EOF_PENDING )
-		/* don't do the read, it's not guaranteed to return an EOF,
-		 * just force an EOF
-		 */
-		YY_G(yy_current_buffer)->yy_n_chars = YY_G(yy_n_chars) = 0;
-
-	else
-		{
-			size_t num_to_read =
-			YY_G(yy_current_buffer)->yy_buf_size - number_to_move - 1;
-
-		while ( num_to_read <= 0 )
-			{ /* Not enough room in the buffer - grow it. */
-#ifdef YY_USES_REJECT
-			YY_FATAL_ERROR(
-"input buffer overflow, can't enlarge buffer because scanner uses REJECT" );
-#else
-
-			/* just a shorter name for the current buffer */
-			YY_BUFFER_STATE b = YY_G(yy_current_buffer);
-
-			int yy_c_buf_p_offset =
-				(int) (YY_G(yy_c_buf_p) - b->yy_ch_buf);
-
-			if ( b->yy_is_our_buffer )
-				{
-				int new_size = b->yy_buf_size * 2;
-
-				if ( new_size <= 0 )
-					b->yy_buf_size += b->yy_buf_size / 8;
-				else
-					b->yy_buf_size *= 2;
-
-				b->yy_ch_buf = (char *)
-					/* Include room in for 2 EOB chars. */
-					yy_flex_realloc( (void *) b->yy_ch_buf,
-							 b->yy_buf_size + 2 YY_CALL_LAST_ARG );
-				}
-			else
-				/* Can't grow it, we don't own it. */
-				b->yy_ch_buf = 0;
-
-			if ( ! b->yy_ch_buf )
-				YY_FATAL_ERROR(
-				"fatal error - scanner input buffer overflow" );
-
-			YY_G(yy_c_buf_p) = &b->yy_ch_buf[yy_c_buf_p_offset];
-
-			num_to_read = YY_G(yy_current_buffer)->yy_buf_size -
-						number_to_move - 1;
-#endif
-			}
-
-		if ( num_to_read > YY_READ_BUF_SIZE )
-			num_to_read = YY_READ_BUF_SIZE;
-
-		/* Read in more data. */
-		YY_INPUT( (&YY_G(yy_current_buffer)->yy_ch_buf[number_to_move]),
-			YY_G(yy_n_chars), num_to_read );
-
-		YY_G(yy_current_buffer)->yy_n_chars = YY_G(yy_n_chars);
-		}
-
-	if ( YY_G(yy_n_chars) == 0 )
-		{
-		if ( number_to_move == YY_MORE_ADJ )
-			{
-			ret_val = EOB_ACT_END_OF_FILE;
-			yyrestart( yyin  YY_CALL_LAST_ARG);
-			}
-
-		else
-			{
-			ret_val = EOB_ACT_LAST_MATCH;
-			YY_G(yy_current_buffer)->yy_buffer_status =
-				YY_BUFFER_EOF_PENDING;
-			}
-		}
-
-	else
-		ret_val = EOB_ACT_CONTINUE_SCAN;
-
-	YY_G(yy_n_chars) += number_to_move;
-	YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars)] = YY_END_OF_BUFFER_CHAR;
-	YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars) + 1] = YY_END_OF_BUFFER_CHAR;
-
-	YY_G(yytext_ptr) = &YY_G(yy_current_buffer)->yy_ch_buf[0];
-
-	return ret_val;
-	}
-/* %e */
-#endif /* !ssIN_HEADER */
-
-/* yy_get_previous_state - get the state just before the EOB char was reached */
-
-/* %- */
-/* %c */
-#ifndef ssIN_HEADER
-#ifdef YY_USE_PROTOS
-static yy_state_type yy_get_previous_state(YY_ONLY_ARG)
-#else
-static yy_state_type yy_get_previous_state(YY_ONLY_ARG)
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	register yy_state_type yy_current_state;
-	register char *yy_cp;
-
-/* %% [15.0] code to get the start state into yy_current_state goes here */
-	yy_current_state = YY_G(yy_start);
-
-	for ( yy_cp = YY_G(yytext_ptr) + YY_MORE_ADJ; yy_cp < YY_G(yy_c_buf_p); ++yy_cp )
-		{
-/* %% [16.0] code to find the next state goes here */
-		register YY_CHAR yy_c = (*yy_cp ? yy_ec[YY_SC_TO_UI(*yy_cp)] : 1);
-		if ( yy_accept[yy_current_state] )
-			{
-			YY_G(yy_last_accepting_state) = yy_current_state;
-			YY_G(yy_last_accepting_cpos) = yy_cp;
-			}
-		while ( yy_chk[yy_base[yy_current_state] + yy_c] != yy_current_state )
-			{
-			yy_current_state = (int) yy_def[yy_current_state];
-			if ( yy_current_state >= 56 )
-				yy_c = yy_meta[(unsigned int) yy_c];
-			}
-		yy_current_state = yy_nxt[yy_base[yy_current_state] + (unsigned int) yy_c];
-		}
-
-	return yy_current_state;
-	}
-
-
-/* yy_try_NUL_trans - try to make a transition on the NUL character
- *
- * synopsis
- *	next_state = yy_try_NUL_trans( current_state );
- */
-
-/* %- */
-#ifdef YY_USE_PROTOS
-static yy_state_type yy_try_NUL_trans( yy_state_type yy_current_state YY_LAST_ARG )
-#else
-static yy_state_type yy_try_NUL_trans( yy_current_state YY_LAST_ARG )
-yy_state_type yy_current_state;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	register int yy_is_jam;
-/* %% [17.0] code to find the next state, and perhaps do backing up, goes here */
-	register char *yy_cp = YY_G(yy_c_buf_p);
-
-	register YY_CHAR yy_c = 1;
-	if ( yy_accept[yy_current_state] )
-		{
-		YY_G(yy_last_accepting_state) = yy_current_state;
-		YY_G(yy_last_accepting_cpos) = yy_cp;
-		}
-	while ( yy_chk[yy_base[yy_current_state] + yy_c] != yy_current_state )
-		{
-		yy_current_state = (int) yy_def[yy_current_state];
-		if ( yy_current_state >= 56 )
-			yy_c = yy_meta[(unsigned int) yy_c];
-		}
-	yy_current_state = yy_nxt[yy_base[yy_current_state] + (unsigned int) yy_c];
-	yy_is_jam = (yy_current_state == 55);
-
-	return yy_is_jam ? 0 : yy_current_state;
-	}
-
-
-/* %- */
-#ifndef YY_NO_UNPUT
-#ifdef YY_USE_PROTOS
-static void yyunput( int c, register char *yy_bp YY_LAST_ARG )
-#else
-static void yyunput( c, yy_bp YY_LAST_ARG)
-int c;
-register char *yy_bp;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	register char *yy_cp = YY_G(yy_c_buf_p);
-
-	/* undo effects of setting up yytext */
-	*yy_cp = YY_G(yy_hold_char);
-
-	if ( yy_cp < YY_G(yy_current_buffer)->yy_ch_buf + 2 )
-		{ /* need to shift things up to make room */
-		/* +2 for EOB chars. */
-		register int number_to_move = YY_G(yy_n_chars) + 2;
-		register char *dest = &YY_G(yy_current_buffer)->yy_ch_buf[
-					YY_G(yy_current_buffer)->yy_buf_size + 2];
-		register char *source =
-				&YY_G(yy_current_buffer)->yy_ch_buf[number_to_move];
-
-		while ( source > YY_G(yy_current_buffer)->yy_ch_buf )
-			*--dest = *--source;
-
-		yy_cp += (int) (dest - source);
-		yy_bp += (int) (dest - source);
-		YY_G(yy_current_buffer)->yy_n_chars =
-			YY_G(yy_n_chars) = YY_G(yy_current_buffer)->yy_buf_size;
-
-		if ( yy_cp < YY_G(yy_current_buffer)->yy_ch_buf + 2 )
-			YY_FATAL_ERROR( "flex scanner push-back overflow" );
-		}
-
-	*--yy_cp = (char) c;
-
-/* %% [18.0] update yylineno here */
-
-	YY_G(yytext_ptr) = yy_bp;
-	YY_G(yy_hold_char) = *yy_cp;
-	YY_G(yy_c_buf_p) = yy_cp;
-	}
-/* %- */
-#endif	/* ifndef YY_NO_UNPUT */
-/* %* */
-
-
-/* %- */
-#ifndef YY_NO_INPUT
-#ifdef __cplusplus
-static int yyinput(YY_ONLY_ARG)
-#else
-#ifdef YY_USE_PROTOS
-static int input(YY_ONLY_ARG)
-#else
-static int input(YY_ONLY_ARG)
-    YY_DECL_LAST_ARG
-#endif
-#endif
-/* %+ */
-/* %* */
-	{
-	int c;
-
-	*YY_G(yy_c_buf_p) = YY_G(yy_hold_char);
-
-	if ( *YY_G(yy_c_buf_p) == YY_END_OF_BUFFER_CHAR )
-		{
-		/* yy_c_buf_p now points to the character we want to return.
-		 * If this occurs *before* the EOB characters, then it's a
-		 * valid NUL; if not, then we've hit the end of the buffer.
-		 */
-		if ( YY_G(yy_c_buf_p) < &YY_G(yy_current_buffer)->yy_ch_buf[YY_G(yy_n_chars)] )
-			/* This was really a NUL. */
-			*YY_G(yy_c_buf_p) = '\0';
-
-		else
-			{ /* need more input */
-			int offset = YY_G(yy_c_buf_p) - YY_G(yytext_ptr);
-			++YY_G(yy_c_buf_p);
-
-			switch ( yy_get_next_buffer( YY_CALL_ONLY_ARG ) )
-				{
-				case EOB_ACT_LAST_MATCH:
-					/* This happens because yy_g_n_b()
-					 * sees that we've accumulated a
-					 * token and flags that we need to
-					 * try matching the token before
-					 * proceeding.  But for input(),
-					 * there's no matching to consider.
-					 * So convert the EOB_ACT_LAST_MATCH
-					 * to EOB_ACT_END_OF_FILE.
-					 */
-
-					/* Reset buffer status. */
-					yyrestart( yyin YY_CALL_LAST_ARG);
-
-					/* fall through */
-
-				case EOB_ACT_END_OF_FILE:
-					{
-					if ( yywrap( YY_CALL_ONLY_ARG ) )
-						return EOF;
-
-					if ( ! YY_G(yy_did_buffer_switch_on_eof) )
-						YY_NEW_FILE;
-#ifdef __cplusplus
-					return yyinput(YY_CALL_ONLY_ARG);
-#else
-					return input(YY_CALL_ONLY_ARG);
-#endif
-					}
-
-				case EOB_ACT_CONTINUE_SCAN:
-					YY_G(yy_c_buf_p) = YY_G(yytext_ptr) + offset;
-					break;
-				}
-			}
-		}
-
-	c = *(unsigned char *) YY_G(yy_c_buf_p);	/* cast for 8-bit char's */
-	*YY_G(yy_c_buf_p) = '\0';	/* preserve yytext */
-	YY_G(yy_hold_char) = *++YY_G(yy_c_buf_p);
-
-/* %% [19.0] update BOL and yylineno */
-
-	return c;
-	}
-/* %- */
-#endif	/* ifndef YY_NO_INPUT */
-/* %* */
-
-/* %- */
-#ifdef YY_USE_PROTOS
-void yyrestart( FILE *input_file YY_LAST_ARG)
-#else
-void yyrestart( input_file YY_LAST_ARG)
-FILE *input_file;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	if ( ! YY_G(yy_current_buffer) )
-		YY_G(yy_current_buffer) =
-            yy_create_buffer( yyin, YY_BUF_SIZE YY_CALL_LAST_ARG);
-
-	yy_init_buffer( YY_G(yy_current_buffer), input_file YY_CALL_LAST_ARG);
-	yy_load_buffer_state( YY_CALL_ONLY_ARG );
-	}
-
-
-/* %- */
-#ifdef YY_USE_PROTOS
-void yy_switch_to_buffer( YY_BUFFER_STATE new_buffer YY_LAST_ARG )
-#else
-void yy_switch_to_buffer( new_buffer YY_LAST_ARG )
-YY_BUFFER_STATE new_buffer;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	if ( YY_G(yy_current_buffer) == new_buffer )
-		return;
-
-	if ( YY_G(yy_current_buffer) )
-		{
-		/* Flush out information for old buffer. */
-		*YY_G(yy_c_buf_p) = YY_G(yy_hold_char);
-		YY_G(yy_current_buffer)->yy_buf_pos = YY_G(yy_c_buf_p);
-		YY_G(yy_current_buffer)->yy_n_chars = YY_G(yy_n_chars);
-		}
-
-	YY_G(yy_current_buffer) = new_buffer;
-	yy_load_buffer_state( YY_CALL_ONLY_ARG );
-
-	/* We don't actually know whether we did this switch during
-	 * EOF (yywrap()) processing, but the only time this flag
-	 * is looked at is after yywrap() is called, so it's safe
-	 * to go ahead and always set it.
-	 */
-	YY_G(yy_did_buffer_switch_on_eof) = 1;
-	}
-
-
-/* %- */
-#ifdef YY_USE_PROTOS
-void yy_load_buffer_state( YY_ONLY_ARG )
-#else
-void yy_load_buffer_state(YY_ONLY_ARG )
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	YY_G(yy_n_chars) = YY_G(yy_current_buffer)->yy_n_chars;
-	YY_G(yytext_ptr) = YY_G(yy_c_buf_p) = YY_G(yy_current_buffer)->yy_buf_pos;
-	yyin = YY_G(yy_current_buffer)->yy_input_file;
-	YY_G(yy_hold_char) = *YY_G(yy_c_buf_p);
-	}
-
-
-/* %- */
-#ifdef YY_USE_PROTOS
-YY_BUFFER_STATE yy_create_buffer( FILE *file, int size YY_LAST_ARG)
-#else
-YY_BUFFER_STATE yy_create_buffer( file, size YY_LAST_ARG)
-FILE *file;
-int size;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	YY_BUFFER_STATE b;
-
-	b = (YY_BUFFER_STATE) yy_flex_alloc( sizeof( struct yy_buffer_state ) YY_CALL_LAST_ARG );
-	if ( ! b )
-		YY_FATAL_ERROR( "out of dynamic memory in yy_create_buffer()" );
-
-	b->yy_buf_size = size;
-
-	/* yy_ch_buf has to be 2 characters longer than the size given because
-	 * we need to put in 2 end-of-buffer characters.
-	 */
-	b->yy_ch_buf = (char *) yy_flex_alloc( b->yy_buf_size + 2 YY_CALL_LAST_ARG );
-	if ( ! b->yy_ch_buf )
-		YY_FATAL_ERROR( "out of dynamic memory in yy_create_buffer()" );
-
-	b->yy_is_our_buffer = 1;
-
-	yy_init_buffer( b, file YY_CALL_LAST_ARG);
-
-	return b;
-	}
-
-
-/* %- */
-#ifdef YY_USE_PROTOS
-void yy_delete_buffer( YY_BUFFER_STATE b YY_LAST_ARG)
-#else
-void yy_delete_buffer( b YY_LAST_ARG)
-YY_BUFFER_STATE b;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	if ( ! b )
-		return;
-
-	if ( b == YY_G(yy_current_buffer) )
-		YY_G(yy_current_buffer) = (YY_BUFFER_STATE) 0;
-
-	if ( b->yy_is_our_buffer )
-		yy_flex_free( (void *) b->yy_ch_buf YY_CALL_LAST_ARG );
-
-	yy_flex_free( (void *) b YY_CALL_LAST_ARG );
-	}
-
-
-/* %- */
-#ifndef YY_ALWAYS_INTERACTIVE
-#ifndef YY_NEVER_INTERACTIVE
-#ifdef __cplusplus
-extern "C" int isatty YY_PROTO(( int ));
-#else
-extern int isatty YY_PROTO(( int ));
-#endif /* __cplusplus */
-#endif /* !YY_NEVER_INTERACTIVE */
-#endif /* !YY_ALWAYS_INTERACTIVE */
-
-#ifdef YY_USE_PROTOS
-void yy_init_buffer( YY_BUFFER_STATE b, FILE *file YY_LAST_ARG)
-#else
-void yy_init_buffer( b, file YY_LAST_ARG)
-YY_BUFFER_STATE b;
-FILE *file;
-YY_DECL_LAST_ARG
-#endif
-
-/* %+ */
-/* %* */
-
-	{
-	int oerrno = errno;
-
-	yy_flush_buffer( b YY_CALL_LAST_ARG);
-
-	b->yy_input_file = file;
-	b->yy_fill_buffer = 1;
-
-/* %- */
-#if YY_ALWAYS_INTERACTIVE
-	b->yy_is_interactive = 1;
-#else
-#if YY_NEVER_INTERACTIVE
-	b->yy_is_interactive = 0;
-#else
-	b->yy_is_interactive = file ? (isatty( fileno(file) ) > 0) : 0;
-#endif
-#endif
-/* %+ */
-/* %* */
-	errno = oerrno;
-	}
-
-
-/* %- */
-#ifdef YY_USE_PROTOS
-void yy_flush_buffer( YY_BUFFER_STATE b YY_LAST_ARG )
-#else
-void yy_flush_buffer( b YY_LAST_ARG )
-YY_BUFFER_STATE b;
-YY_DECL_LAST_ARG
-#endif
-
-/* %+ */
-/* %* */
-	{
-	if ( ! b )
-		return;
-
-	b->yy_n_chars = 0;
-
-	/* We always need two end-of-buffer characters.  The first causes
-	 * a transition to the end-of-buffer state.  The second causes
-	 * a jam in that state.
-	 */
-	b->yy_ch_buf[0] = YY_END_OF_BUFFER_CHAR;
-	b->yy_ch_buf[1] = YY_END_OF_BUFFER_CHAR;
-
-	b->yy_buf_pos = &b->yy_ch_buf[0];
-
-	b->yy_at_bol = 1;
-	b->yy_buffer_status = YY_BUFFER_NEW;
-
-	if ( b == YY_G(yy_current_buffer) )
-		yy_load_buffer_state( YY_CALL_ONLY_ARG );
-	}
-/* %* */
-
-
-#ifndef YY_NO_SCAN_BUFFER
-/* %- */
-#ifdef YY_USE_PROTOS
-YY_BUFFER_STATE yy_scan_buffer( char *base, yy_size_t size YY_LAST_ARG )
-#else
-YY_BUFFER_STATE yy_scan_buffer( base, size YY_LAST_ARG )
-char *base;
-yy_size_t size;
-YY_DECL_LAST_ARG
-#endif
-	{
-	YY_BUFFER_STATE b;
-
-	if ( size < 2 ||
-	     base[size-2] != YY_END_OF_BUFFER_CHAR ||
-	     base[size-1] != YY_END_OF_BUFFER_CHAR )
-		/* They forgot to leave room for the EOB's. */
-		return 0;
-
-	b = (YY_BUFFER_STATE) yy_flex_alloc( sizeof( struct yy_buffer_state ) YY_CALL_LAST_ARG );
-	if ( ! b )
-		YY_FATAL_ERROR( "out of dynamic memory in yy_scan_buffer()" );
-
-	b->yy_buf_size = size - 2;	/* "- 2" to take care of EOB's */
-	b->yy_buf_pos = b->yy_ch_buf = base;
-	b->yy_is_our_buffer = 0;
-	b->yy_input_file = 0;
-	b->yy_n_chars = b->yy_buf_size;
-	b->yy_is_interactive = 0;
-	b->yy_at_bol = 1;
-	b->yy_fill_buffer = 0;
-	b->yy_buffer_status = YY_BUFFER_NEW;
-
-	yy_switch_to_buffer( b YY_CALL_LAST_ARG );
-
-	return b;
-	}
-/* %* */
-#endif
-
-
-#ifndef YY_NO_SCAN_STRING
-/* %- */
-#ifdef YY_USE_PROTOS
-YY_BUFFER_STATE yy_scan_string( yyconst char *yy_str YY_LAST_ARG )
-#else
-YY_BUFFER_STATE yy_scan_string( yy_str YY_LAST_ARG)
-yyconst char *yy_str;
-YY_DECL_LAST_ARG
-#endif
-	{
-	int len;
-	for ( len = 0; yy_str[len]; ++len )
-		;
-
-	return yy_scan_bytes( yy_str, len YY_CALL_LAST_ARG);
-	}
-/* %* */
-#endif
-
-
-#ifndef YY_NO_SCAN_BYTES
-/* %- */
-#ifdef YY_USE_PROTOS
-YY_BUFFER_STATE yy_scan_bytes( yyconst char *bytes, int len YY_LAST_ARG)
-#else
-YY_BUFFER_STATE yy_scan_bytes( bytes, len YY_LAST_ARG)
-yyconst char *bytes;
-YY_DECL_LAST_ARG
-int len;
-#endif
-	{
-	YY_BUFFER_STATE b;
-	char *buf;
-	yy_size_t n;
-	int i;
-
-	/* Get memory for full buffer, including space for trailing EOB's. */
-	n = len + 2;
-	buf = (char *) yy_flex_alloc( n YY_CALL_LAST_ARG );
-	if ( ! buf )
-		YY_FATAL_ERROR( "out of dynamic memory in yy_scan_bytes()" );
-
-	for ( i = 0; i < len; ++i )
-		buf[i] = bytes[i];
-
-	buf[len] = buf[len+1] = YY_END_OF_BUFFER_CHAR;
-
-	b = yy_scan_buffer( buf, n YY_CALL_LAST_ARG);
-	if ( ! b )
-		YY_FATAL_ERROR( "bad buffer in yy_scan_bytes()" );
-
-	/* It's okay to grow etc. this buffer, and we should throw it
-	 * away when we're done.
-	 */
-	b->yy_is_our_buffer = 1;
-
-	return b;
-	}
-/* %* */
-#endif
-
-
-#ifndef YY_NO_PUSH_STATE
-/* %- */
-#ifdef YY_USE_PROTOS
-static void yy_push_state( int new_state YY_LAST_ARG)
-#else
-static void yy_push_state( new_state YY_LAST_ARG)
-int new_state;
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	if ( YY_G(yy_start_stack_ptr) >= YY_G(yy_start_stack_depth) )
-		{
-		yy_size_t new_size;
-
-		YY_G(yy_start_stack_depth) += YY_START_STACK_INCR;
-		new_size = YY_G(yy_start_stack_depth) * sizeof( int );
-
-		if ( ! YY_G(yy_start_stack) )
-			YY_G(yy_start_stack) = (int *) yy_flex_alloc( new_size YY_CALL_LAST_ARG );
-
-		else
-			YY_G(yy_start_stack) = (int *) yy_flex_realloc(
-					(void *) YY_G(yy_start_stack), new_size YY_CALL_LAST_ARG );
-
-		if ( ! YY_G(yy_start_stack) )
-			YY_FATAL_ERROR(
-			"out of memory expanding start-condition stack" );
-		}
-
-	YY_G(yy_start_stack)[YY_G(yy_start_stack_ptr)++] = YY_START;
-
-	BEGIN(new_state);
-	}
-#endif
-
-
-#ifndef YY_NO_POP_STATE
-/* %- */
-#ifdef YY_USE_PROTOS
-static void yy_pop_state( YY_ONLY_ARG )
-#else
-static void yy_pop_state( YY_ONLY_ARG )
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	if ( --YY_G(yy_start_stack_ptr) < 0 )
-		YY_FATAL_ERROR( "start-condition stack underflow" );
-
-	BEGIN(YY_G(yy_start_stack)[YY_G(yy_start_stack_ptr)]);
-	}
-#endif
-
-
-#ifndef YY_NO_TOP_STATE
-/* %- */
-#ifdef YY_USE_PROTOS
-static int yy_top_state( YY_ONLY_ARG )
-#else
-static int yy_top_state( YY_ONLY_ARG )
-YY_DECL_LAST_ARG
-#endif
-/* %+ */
-/* %* */
-	{
-	return YY_G(yy_start_stack)[YY_G(yy_start_stack_ptr) - 1];
-	}
-#endif
-
-#ifndef YY_EXIT_FAILURE
-#define YY_EXIT_FAILURE 2
-#endif
-
-/* %- */
-static void yy_fatal_error( yyconst char msg[] )
-	{
-	(void) fprintf( stderr, "%s\n", msg );
-	exit( YY_EXIT_FAILURE );
-	}
-
-/* %+ */
-/* %* */
-
-
-/* Redefine yyless() so it works in section 3 code. */
-
-#undef yyless
-#define yyless(n) \
-	do \
-		{ \
-		/* Undo effects of setting up yytext. */ \
-		yytext[yyleng] = YY_G(yy_hold_char); \
-		YY_G(yy_c_buf_p) = yytext + n; \
-		YY_G(yy_hold_char) = *YY_G(yy_c_buf_p); \
-		*YY_G(yy_c_buf_p) = '\0'; \
-		yyleng = n; \
-		} \
-	while ( 0 )
-
-
-
-#ifdef YY_REENTRANT
-
-/* Accessor  methods (get/set functions) to struct members. */
-
-#ifndef YY_NO_GET_EXTRA
-#ifdef YY_USE_PROTOS
-YY_EXTRA_TYPE yyget_extra( YY_ONLY_ARG )
-#else
-YY_EXTRA_TYPE yyget_extra( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yyextra;
-}
-#endif /* !YY_NO_GET_EXTRA */
-
-#ifndef YY_NO_GET_LINENO
-#  ifdef YY_USE_PROTOS
-int yyget_lineno( YY_ONLY_ARG )
-#  else
-int yyget_lineno( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#  endif
-{
-    return yylineno;
-}
-#endif /* !YY_NO_GET_LINENO */
-
-#ifndef YY_NO_GET_IN
-#ifdef YY_USE_PROTOS
-FILE *yyget_in( YY_ONLY_ARG )
-#else
-FILE *yyget_in( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yyin;
-}
-#endif /* !YY_NO_GET_IN */
-
-#ifndef YY_NO_GET_OUT
-#ifdef YY_USE_PROTOS
-FILE *yyget_out( YY_ONLY_ARG )
-#else
-FILE *yyget_out( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yyout;
-}
-#endif /* !YY_NO_GET_OUT */
-
-#ifndef YY_NO_GET_LENG
-#ifdef YY_USE_PROTOS
-int yyget_leng( YY_ONLY_ARG )
-#else
-int yyget_leng( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yyleng;
-}
-#endif /* !YY_NO_GET_LENG */
-
-#ifndef YY_NO_GET_TEXT
-#ifdef YY_USE_PROTOS
-char *yyget_text( YY_ONLY_ARG )
-#else
-char *yyget_text( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yytext;
-}
-#endif /* !YY_NO_GET_TEXT */
-
-#ifndef YY_NO_SET_EXTRA
-#ifdef YY_USE_PROTOS
-void yyset_extra( YY_EXTRA_TYPE user_defined YY_LAST_ARG )
-#else
-void yyset_extra( user_defined YY_LAST_ARG )
-    YY_EXTRA_TYPE user_defined;
-    YY_DECL_LAST_ARG
-#endif
-{
-    yyextra = user_defined ;
-}
-#endif /* !YY_NO_SET_EXTRA */
-
-#ifndef YY_NO_SET_LINENO
-#  ifdef YY_USE_PROTOS
-void yyset_lineno( int line_number YY_LAST_ARG )
-#  else
-void yyset_lineno( line_number YY_LAST_ARG )
-    int line_number;
-    YY_DECL_LAST_ARG
-#  endif
-{
-    yylineno = line_number;
-}
-#endif /* !YY_NO_SET_LINENO */
-
-
-#ifndef YY_NO_SET_IN
-#ifdef YY_USE_PROTOS
-void yyset_in( FILE * in_str YY_LAST_ARG )
-#else
-void yyset_in( in_str YY_LAST_ARG )
-    FILE * in_str;
-    YY_DECL_LAST_ARG
-#endif
-{
-    yyin = in_str ;
-}
-#endif /* !YY_NO_SET_IN */
-
-#ifndef YY_NO_SET_OUT
-#ifdef YY_USE_PROTOS
-void yyset_out( FILE * out_str YY_LAST_ARG )
-#else
-void yyset_out( out_str YY_LAST_ARG )
-    FILE * out_str;
-    YY_DECL_LAST_ARG
-#endif
-{
-    yyout = out_str ;
-}
-#endif /* !YY_NO_SET_OUT */
-
-/* Accessor methods for yylval and yylloc */
-
-#ifdef YY_REENTRANT_BISON_PURE
-#ifndef YY_NO_GET_LVAL
-#ifdef YY_USE_PROTOS
-YYSTYPE * yyget_lval( YY_ONLY_ARG )
-#else
-YYSTYPE * yyget_lval( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yylval;
-}
-#endif /* !YY_NO_GET_LVAL */
-
-#ifndef YY_NO_SET_LVAL
-#ifdef YY_USE_PROTOS
-void yyset_lval( YYSTYPE * yylvalp YY_LAST_ARG )
-#else
-void yyset_lval( yylvalp YY_LAST_ARG )
-    YYSTYPE * yylvalp;
-    YY_DECL_LAST_ARG
-#endif
-{
-    yylval = yylvalp;
-}
-#endif /* !YY_NO_SET_LVAL */
-
-#ifdef YYLTYPE
-#ifndef YY_NO_GET_LLOC
-#ifdef YY_USE_PROTOS
-YYLTYPE *yyget_lloc( YY_ONLY_ARG )
-#else
-YYLTYPE *yyget_lloc( YY_ONLY_ARG )
-    YY_DECL_LAST_ARG
-#endif
-{
-    return yylloc;
-}
-#endif /* !YY_NO_GET_LLOC */
-
-#ifndef YY_NO_SET_LLOC
-#ifdef YY_USE_PROTOS
-void yyset_lloc( YYLTYPE * yyllocp YY_LAST_ARG )
-#else
-void yyset_lloc( yyllocp YY_LAST_ARG )
-    YYLTYPE * yyllocp;
-    YY_DECL_LAST_ARG
-#endif
-{
-    yylloc = yyllocp;
-}
-#endif /* !YY_NO_SET_LLOC */
-
-#endif /* YYLTYPE */
-#endif /* YY_REENTRANT_BISON_PURE */
-
-
-#ifdef YY_USE_PROTOS
-static int yy_init_globals( yyscan_t yy_globals)
-#else
-static int yy_init_globals( yy_globals )
-    yyscan_t yy_globals;
-#endif
-    {
-    /* Initialization is the same as for the non-reentrant scanner.
-       This function is called once per scanner lifetime. */
-
-  /* We do not touch yylineno unless the option is enabled. */
-#ifdef YY_USE_LINENO
-    yylineno =  1;
-#endif
-    YY_G(yy_current_buffer) = 0;
-    YY_G(yy_c_buf_p) = (char *) 0;
-    YY_G(yy_init) = 1;
-    YY_G(yy_start) = 0;
-    YY_G(yy_start_stack_ptr) = 0;
-    YY_G(yy_start_stack_depth) = 0;
-    YY_G(yy_start_stack) = (int *) 0;
-
-/* Defined in main.c */
-#ifdef YY_STDINIT
-    yyin = stdin;
-    yyout = stdout;
-#else
-    yyin = (FILE *) 0;
-    yyout = (FILE *) 0;
-#endif
-    return 0;
-    }
-
-/* User-visible API */
-#ifdef YY_USE_PROTOS
-int yylex_init( yyscan_t* ptr_yy_globals)
-#else
-int yylex_init( ptr_yy_globals )
-    yyscan_t* ptr_yy_globals;
-#endif
-    {
-    *ptr_yy_globals = (yyscan_t) yy_flex_alloc ( sizeof( struct yy_globals_t ), NULL );
-    yy_init_globals ( *ptr_yy_globals );
-    return 0;
-    }
-
-#ifdef YY_USE_PROTOS
-int yylex_destroy( yyscan_t yy_globals )
-#else
-int yylex_destroy( yy_globals )
-    yyscan_t yy_globals;
-#endif
-    {
-    if( yy_globals )
-        {
-
-            /* Destroy the current (main) buffer. */
-            yy_delete_buffer( YY_G(yy_current_buffer) YY_CALL_LAST_ARG );
-            YY_G(yy_current_buffer) = NULL;
-
-            /* Destroy the start condition stack. */
-            if( YY_G(yy_start_stack) ) {
-                yy_flex_free( YY_G(yy_start_stack) YY_CALL_LAST_ARG );
-                YY_G(yy_start_stack) = NULL;
-            }
-
-            /* Destroy the main struct. */
-            yy_flex_free ( yy_globals YY_CALL_LAST_ARG );
-        }
-    return 0;
-    }
-
-#endif /* End YY_REENTRANT */
-
-/* Internal utility routines. */
-
-#ifndef yytext_ptr
-#ifdef YY_USE_PROTOS
-static void yy_flex_strncpy( char *s1, yyconst char *s2, int n YY_LAST_ARG)
-#else
-static void yy_flex_strncpy( s1, s2, n YY_LAST_ARG)
-char *s1;
-yyconst char *s2;
-int n;
-YY_DECL_LAST_ARG
-#endif
-	{
-	register int i;
-	for ( i = 0; i < n; ++i )
-		s1[i] = s2[i];
-	}
-#endif
-
-#ifdef YY_NEED_STRLEN
-#ifdef YY_USE_PROTOS
-static int yy_flex_strlen( yyconst char *s YY_LAST_ARG)
-#else
-static int yy_flex_strlen( s YY_LAST_ARG)
-yyconst char *s;
-YY_DECL_LAST_ARG
-#endif
-	{
-	register int n;
-	for ( n = 0; s[n]; ++n )
-		;
-
-	return n;
-	}
-#endif
-
-
-#ifdef YY_USE_PROTOS
-static void *yy_flex_alloc( yy_size_t size YY_LAST_ARG )
-#else
-static void *yy_flex_alloc( size YY_LAST_ARG )
-yy_size_t size;
-YY_DECL_LAST_ARG
-#endif
-	{
-	return (void *) malloc( size );
-	}
-
-#ifdef YY_USE_PROTOS
-static void *yy_flex_realloc( void *ptr, yy_size_t size YY_LAST_ARG )
-#else
-static void *yy_flex_realloc( ptr, size YY_LAST_ARG )
-void *ptr;
-yy_size_t size;
-YY_DECL_LAST_ARG
-#endif
-	{
-	/* The cast to (char *) in the following accommodates both
-	 * implementations that use char* generic pointers, and those
-	 * that use void* generic pointers.  It works with the latter
-	 * because both ANSI C and C++ allow castless assignment from
-	 * any pointer type to void*, and deal with argument conversions
-	 * as though doing an assignment.
-	 */
-	return (void *) realloc( (char *) ptr, size );
-	}
-
-#ifdef YY_USE_PROTOS
-static void yy_flex_free( void *ptr YY_LAST_ARG )
-#else
-static void yy_flex_free( ptr YY_LAST_ARG )
-void *ptr;
-YY_DECL_LAST_ARG
-#endif
-	{
-	free( (char *) ptr );	/* see yy_flex_realloc() for (char *) cast */
-	}
-
-#if YY_MAIN
-int main()
-	{
-
-#ifdef YY_REENTRANT
-    yyscan_t lexer;
-    yylex_init(&lexer);
-    yylex( lexer );
-    yylex_destroy( lexer);
-
-#else
-	yylex();
-#endif
-
-	return 0;
-	}
-#endif
-/* %e */
-#endif /* !ssIN_HEADER */
-#line 111 "icalsslexer.l"
-#ifndef ssIN_HEADER
-
-
-int yywrap(yyscan_t yy_globals)
-{
-     return 1;
-}
-
-#endif /* !ssIN_HEADER */
Index: libkcal/libical/src/libicalss/icalssyacc.c
===================================================================
--- libkcal/libical/src/libicalss/icalssyacc.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalssyacc.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,1399 +0,0 @@
-/* A Bison parser, made from icalssyacc.y
-   by GNU bison 1.34.  */
-
-#define YYBISON 1  /* Identify Bison output.  */
-
-#define yyparse ssparse
-#define yylex sslex
-#define yyerror sserror
-#define yylval sslval
-#define yychar sschar
-#define yydebug ssdebug
-#define yynerrs ssnerrs
-# define	STRING	257
-# define	SELECT	258
-# define	FROM	259
-# define	WHERE	260
-# define	COMMA	261
-# define	QUOTE	262
-# define	EQUALS	263
-# define	NOTEQUALS	264
-# define	LESS	265
-# define	GREATER	266
-# define	LESSEQUALS	267
-# define	GREATEREQUALS	268
-# define	AND	269
-# define	OR	270
-# define	EOL	271
-# define	END	272
-# define	IS	273
-# define	NOT	274
-# define	SQLNULL	275
-
-#line 3 "icalssyacc.y"
-
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalssyacc.y
-  CREATOR: eric 08 Aug 2000
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-(C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-  ======================================================================*/
-/*#define YYDEBUG 1*/
-#include <stdlib.h>
-#include <string.h> /* for strdup() */
-#include <limits.h> /* for SHRT_MAX*/
-#include "ical.h"
-#include "icalgauge.h"
-#include "icalgaugeimpl.h"
-
-
-#define YYPARSE_PARAM yy_globals
-#define YYLEX_PARAM yy_globals
-#define YY_EXTRA_TYPE  icalgauge_impl*
-  /* ick...*/
-#define yyextra ((struct icalgauge_impl*)ssget_extra(yy_globals))
-
-
-static void ssyacc_add_where(struct icalgauge_impl* impl, char* prop, 
-			icalgaugecompare compare , char* value);
-static void ssyacc_add_select(struct icalgauge_impl* impl, char* str1);
-static void ssyacc_add_from(struct icalgauge_impl* impl, char* str1);
-static void set_logic(struct icalgauge_impl* impl,icalgaugelogic l);
-void sserror(char *s); /* Don't know why I need this.... */
-
-
-#line 56 "icalssyacc.y"
-#ifndef YYSTYPE
-typedef union {
-	char* v_string;
-} yystype;
-# define YYSTYPE yystype
-#endif
-#ifndef YYDEBUG
-# define YYDEBUG 0
-#endif
-
-
-
-#define	YYFINAL		38
-#define	YYFLAG		-32768
-#define	YYNTBASE	22
-
-/* YYTRANSLATE(YYLEX) -- Bison token number corresponding to YYLEX. */
-#define YYTRANSLATE(x) ((unsigned)(x) <= 275 ? yytranslate[x] : 27)
-
-/* YYTRANSLATE[YYLEX] -- Bison token number corresponding to YYLEX. */
-static const char yytranslate[] =
-{
-       0,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     2,     1,     3,     4,     5,
-       6,     7,     8,     9,    10,    11,    12,    13,    14,    15,
-      16,    17,    18,    19,    20,    21
-};
-
-#if YYDEBUG
-static const short yyprhs[] =
-{
-       0,     0,     7,    12,    14,    16,    20,    22,    26,    27,
-      31,    35,    40,    44,    48,    52,    56,    60,    62,    66
-};
-static const short yyrhs[] =
-{
-       4,    23,     5,    24,     6,    26,     0,     4,    23,     5,
-      24,     0,     1,     0,     3,     0,    23,     7,     3,     0,
-       3,     0,    24,     7,     3,     0,     0,     3,     9,     3,
-       0,     3,    19,    21,     0,     3,    19,    20,    21,     0,
-       3,    10,     3,     0,     3,    11,     3,     0,     3,    12,
-       3,     0,     3,    13,     3,     0,     3,    14,     3,     0,
-      25,     0,    26,    15,    25,     0,    26,    16,    25,     0
-};
-
-#endif
-
-#if YYDEBUG
-/* YYRLINE[YYN] -- source line where rule number YYN was defined. */
-static const short yyrline[] =
-{
-       0,    67,    68,    69,    75,    77,    81,    83,    86,    88,
-      89,    90,    91,    92,    93,    94,    95,    98,   100,   101
-};
-#endif
-
-
-#if (YYDEBUG) || defined YYERROR_VERBOSE
-
-/* YYTNAME[TOKEN_NUM] -- String name of the token TOKEN_NUM. */
-static const char *const yytname[] =
-{
-  "$", "error", "$undefined.", "STRING", "SELECT", "FROM", "WHERE", "COMMA", 
-  "QUOTE", "EQUALS", "NOTEQUALS", "LESS", "GREATER", "LESSEQUALS", 
-  "GREATEREQUALS", "AND", "OR", "EOL", "END", "IS", "NOT", "SQLNULL", 
-  "query_min", "select_list", "from_list", "where_clause", "where_list", 0
-};
-#endif
-
-/* YYR1[YYN] -- Symbol number of symbol that rule YYN derives. */
-static const short yyr1[] =
-{
-       0,    22,    22,    22,    23,    23,    24,    24,    25,    25,
-      25,    25,    25,    25,    25,    25,    25,    26,    26,    26
-};
-
-/* YYR2[YYN] -- Number of symbols composing right hand side of rule YYN. */
-static const short yyr2[] =
-{
-       0,     6,     4,     1,     1,     3,     1,     3,     0,     3,
-       3,     4,     3,     3,     3,     3,     3,     1,     3,     3
-};
-
-/* YYDEFACT[S] -- default rule to reduce with in state S when YYTABLE
-   doesn't specify something else to do.  Zero means the default is an
-   error. */
-static const short yydefact[] =
-{
-       0,     3,     0,     4,     0,     0,     0,     6,     2,     5,
-       8,     0,     0,    17,     1,     7,     0,     0,     0,     0,
-       0,     0,     0,     8,     8,     9,    12,    13,    14,    15,
-      16,     0,    10,    18,    19,    11,     0,     0,     0
-};
-
-static const short yydefgoto[] =
-{
-      36,     4,     8,    13,    14
-};
-
-static const short yypact[] =
-{
-       5,-32768,     9,-32768,     6,    17,    18,-32768,     1,-32768,
-      19,    20,    -9,-32768,    -1,-32768,    21,    22,    23,    24,
-      25,    26,    -4,    19,    19,-32768,-32768,-32768,-32768,-32768,
-  -32768,    10,-32768,-32768,-32768,-32768,    30,    32,-32768
-};
-
-static const short yypgoto[] =
-{
-  -32768,-32768,-32768,    -5,-32768
-};
-
-
-#define	YYLAST		32
-
-
-static const short yytable[] =
-{
-      16,    17,    18,    19,    20,    21,     1,    10,    11,     2,
-      22,     5,     3,     6,    23,    24,    31,    32,    33,    34,
-       7,     9,    12,    15,    25,    26,    27,    28,    29,    30,
-      37,    35,    38
-};
-
-static const short yycheck[] =
-{
-       9,    10,    11,    12,    13,    14,     1,     6,     7,     4,
-      19,     5,     3,     7,    15,    16,    20,    21,    23,    24,
-       3,     3,     3,     3,     3,     3,     3,     3,     3,     3,
-       0,    21,     0
-};
-#define YYPURE 1
-
-/* -*-C-*-  Note some compilers choke on comments on `#line' lines.  */
-#line 3 "/usr/local/share/bison/bison.simple"
-
-/* Skeleton output parser for bison,
-
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002 Free Software
-   Foundation, Inc.
-
-   This program is free software; you can redistribute it and/or modify
-   it under the terms of the GNU General Public License as published by
-   the Free Software Foundation; either version 2, or (at your option)
-   any later version.
-
-   This program is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-   GNU General Public License for more details.
-
-   You should have received a copy of the GNU General Public License
-   along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
-
-/* As a special exception, when this file is copied by Bison into a
-   Bison output file, you may use that output file without restriction.
-   This special exception was added by the Free Software Foundation
-   in version 1.24 of Bison.  */
-
-/* This is the parser code that is written into each bison parser when
-   the %semantic_parser declaration is not specified in the grammar.
-   It was written by Richard Stallman by simplifying the hairy parser
-   used when %semantic_parser is specified.  */
-
-/* All symbols defined below should begin with yy or YY, to avoid
-   infringing on user name space.  This should be done even for local
-   variables, as they might otherwise be expanded by user macros.
-   There are some unavoidable exceptions within include files to
-   define necessary library symbols; they are noted "INFRINGES ON
-   USER NAME SPACE" below.  */
-
-#if ! defined (yyoverflow) || defined (YYERROR_VERBOSE)
-
-/* The parser invokes alloca or malloc; define the necessary symbols.  */
-
-# if YYSTACK_USE_ALLOCA
-#  define YYSTACK_ALLOC alloca
-# else
-#  ifndef YYSTACK_USE_ALLOCA
-#   if defined (alloca) || defined (_ALLOCA_H)
-#    define YYSTACK_ALLOC alloca
-#   else
-#    ifdef __GNUC__
-#     define YYSTACK_ALLOC __builtin_alloca
-#    endif
-#   endif
-#  endif
-# endif
-
-# ifdef YYSTACK_ALLOC
-   /* Pacify GCC's `empty if-body' warning. */
-#  define YYSTACK_FREE(Ptr) do { /* empty */; } while (0)
-# else
-#  if defined (__STDC__) || defined (__cplusplus)
-#   include <stdlib.h> /* INFRINGES ON USER NAME SPACE */
-#   define YYSIZE_T size_t
-#  endif
-#  define YYSTACK_ALLOC malloc
-#  define YYSTACK_FREE free
-# endif
-
-/* A type that is properly aligned for any stack member.  */
-union yyalloc
-{
-  short yyss;
-  YYSTYPE yyvs;
-# if YYLSP_NEEDED
-  YYLTYPE yyls;
-# endif
-};
-
-/* The size of the maximum gap between one aligned stack and the next.  */
-# define YYSTACK_GAP_MAX (sizeof (union yyalloc) - 1)
-
-/* The size of an array large to enough to hold all stacks, each with
-   N elements.  */
-# if YYLSP_NEEDED
-#  define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short) + sizeof (YYSTYPE) + sizeof (YYLTYPE))	\
-      + 2 * YYSTACK_GAP_MAX)
-# else
-#  define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short) + sizeof (YYSTYPE))				\
-      + YYSTACK_GAP_MAX)
-# endif
-
-/* Relocate the TYPE STACK from its old location to the new one.  The
-   local variables YYSIZE and YYSTACKSIZE give the old and new number of
-   elements in the stack, and YYPTR gives the new location of the
-   stack.  Advance YYPTR to a properly aligned location for the next
-   stack.  */
-# define YYSTACK_RELOCATE(Type, Stack)					\
-    do									\
-      {									\
-	YYSIZE_T yynewbytes;						\
-	yymemcpy ((char *) yyptr, (char *) (Stack),			\
-		  yysize * (YYSIZE_T) sizeof (Type));			\
-	Stack = &yyptr->Stack;						\
-	yynewbytes = yystacksize * sizeof (Type) + YYSTACK_GAP_MAX;	\
-	yyptr += yynewbytes / sizeof (*yyptr);				\
-      }									\
-    while (0)
-
-#endif /* ! defined (yyoverflow) || defined (YYERROR_VERBOSE) */
-
-
-#if ! defined (YYSIZE_T) && defined (__SIZE_TYPE__)
-# define YYSIZE_T __SIZE_TYPE__
-#endif
-#if ! defined (YYSIZE_T) && defined (size_t)
-# define YYSIZE_T size_t
-#endif
-#if ! defined (YYSIZE_T)
-# if defined (__STDC__) || defined (__cplusplus)
-#  include <stddef.h> /* INFRINGES ON USER NAME SPACE */
-#  define YYSIZE_T size_t
-# endif
-#endif
-#if ! defined (YYSIZE_T)
-# define YYSIZE_T unsigned int
-#endif
-
-#define yyerrok		(yyerrstatus = 0)
-#define yyclearin	(yychar = YYEMPTY)
-#define YYEMPTY		-2
-#define YYEOF		0
-#define YYACCEPT	goto yyacceptlab
-#define YYABORT 	goto yyabortlab
-#define YYERROR		goto yyerrlab1
-/* Like YYERROR except do call yyerror.  This remains here temporarily
-   to ease the transition to the new meaning of YYERROR, for GCC.
-   Once GCC version 2 has supplanted version 1, this can go.  */
-#define YYFAIL		goto yyerrlab
-#define YYRECOVERING()  (!!yyerrstatus)
-#define YYBACKUP(Token, Value)					\
-do								\
-  if (yychar == YYEMPTY && yylen == 1)				\
-    {								\
-      yychar = (Token);						\
-      yylval = (Value);						\
-      yychar1 = YYTRANSLATE (yychar);				\
-      YYPOPSTACK;						\
-      goto yybackup;						\
-    }								\
-  else								\
-    { 								\
-      yyerror ("syntax error: cannot back up");			\
-      YYERROR;							\
-    }								\
-while (0)
-
-#define YYTERROR	1
-#define YYERRCODE	256
-
-
-/* YYLLOC_DEFAULT -- Compute the default location (before the actions
-   are run).
-
-   When YYLLOC_DEFAULT is run, CURRENT is set the location of the
-   first token.  By default, to implement support for ranges, extend
-   its range to the last symbol.  */
-
-#ifndef YYLLOC_DEFAULT
-# define YYLLOC_DEFAULT(Current, Rhs, N)       	\
-   Current.last_line   = Rhs[N].last_line;	\
-   Current.last_column = Rhs[N].last_column;
-#endif
-
-
-/* YYLEX -- calling `yylex' with the right arguments.  */
-
-#if YYPURE
-# if YYLSP_NEEDED
-#  ifdef YYLEX_PARAM
-#   define YYLEX		yylex (&yylval, &yylloc, YYLEX_PARAM)
-#  else
-#   define YYLEX		yylex (&yylval, &yylloc)
-#  endif
-# else /* !YYLSP_NEEDED */
-#  ifdef YYLEX_PARAM
-#   define YYLEX		yylex (&yylval, YYLEX_PARAM)
-#  else
-#   define YYLEX		yylex (&yylval)
-#  endif
-# endif /* !YYLSP_NEEDED */
-#else /* !YYPURE */
-# define YYLEX			yylex ()
-#endif /* !YYPURE */
-
-
-/* Enable debugging if requested.  */
-#if YYDEBUG
-
-# ifndef YYFPRINTF
-#  include <stdio.h> /* INFRINGES ON USER NAME SPACE */
-#  define YYFPRINTF fprintf
-# endif
-
-# define YYDPRINTF(Args)			\
-do {						\
-  if (yydebug)					\
-    YYFPRINTF Args;				\
-} while (0)
-/* Nonzero means print parse trace.  It is left uninitialized so that
-   multiple parsers can coexist.  */
-int yydebug;
-#else /* !YYDEBUG */
-# define YYDPRINTF(Args)
-#endif /* !YYDEBUG */
-
-/* YYINITDEPTH -- initial size of the parser's stacks.  */
-#ifndef	YYINITDEPTH
-# define YYINITDEPTH 200
-#endif
-
-/* YYMAXDEPTH -- maximum size the stacks can grow to (effective only
-   if the built-in stack extension method is used).
-
-   Do not make this value too large; the results are undefined if
-   SIZE_MAX < YYSTACK_BYTES (YYMAXDEPTH)
-   evaluated with infinite-precision integer arithmetic.  */
-
-#if YYMAXDEPTH == 0
-# undef YYMAXDEPTH
-#endif
-
-#ifndef YYMAXDEPTH
-# define YYMAXDEPTH 10000
-#endif
-
-#if ! defined (yyoverflow) && ! defined (yymemcpy)
-# if __GNUC__ > 1		/* GNU C and GNU C++ define this.  */
-#  define yymemcpy __builtin_memcpy
-# else				/* not GNU C or C++ */
-
-/* This is the most reliable way to avoid incompatibilities
-   in available built-in functions on various systems.  */
-static void
-#  if defined (__STDC__) || defined (__cplusplus)
-yymemcpy (char *yyto, const char *yyfrom, YYSIZE_T yycount)
-#  else
-yymemcpy (yyto, yyfrom, yycount)
-     char *yyto;
-     const char *yyfrom;
-     YYSIZE_T yycount;
-#  endif
-{
-  register const char *yyf = yyfrom;
-  register char *yyt = yyto;
-  register YYSIZE_T yyi = yycount;
-
-  while (yyi-- != 0)
-    *yyt++ = *yyf++;
-}
-# endif
-#endif
-
-#ifdef YYERROR_VERBOSE
-
-# ifndef yystrlen
-#  if defined (__GLIBC__) && defined (_STRING_H)
-#   define yystrlen strlen
-#  else
-/* Return the length of YYSTR.  */
-static YYSIZE_T
-#   if defined (__STDC__) || defined (__cplusplus)
-yystrlen (const char *yystr)
-#   else
-yystrlen (yystr)
-     const char *yystr;
-#   endif
-{
-  register const char *yys = yystr;
-
-  while (*yys++ != '\0')
-    continue;
-
-  return yys - yystr - 1;
-}
-#  endif
-# endif
-
-# ifndef yystpcpy
-#  if defined (__GLIBC__) && defined (_STRING_H) && defined (_GNU_SOURCE)
-#   define yystpcpy stpcpy
-#  else
-/* Copy YYSRC to YYDEST, returning the address of the terminating '\0' in
-   YYDEST.  */
-static char *
-#   if defined (__STDC__) || defined (__cplusplus)
-yystpcpy (char *yydest, const char *yysrc)
-#   else
-yystpcpy (yydest, yysrc)
-     char *yydest;
-     const char *yysrc;
-#   endif
-{
-  register char *yyd = yydest;
-  register const char *yys = yysrc;
-
-  while ((*yyd++ = *yys++) != '\0')
-    continue;
-
-  return yyd - 1;
-}
-#  endif
-# endif
-#endif
-
-#line 319 "/usr/local/share/bison/bison.simple"
-
-
-/* The user can define YYPARSE_PARAM as the name of an argument to be passed
-   into yyparse.  The argument should have type void *.
-   It should actually point to an object.
-   Grammar actions can access the variable by casting it
-   to the proper pointer type.  */
-
-#ifdef YYPARSE_PARAM
-# if defined (__STDC__) || defined (__cplusplus)
-#  define YYPARSE_PARAM_ARG void *YYPARSE_PARAM
-#  define YYPARSE_PARAM_DECL
-# else
-#  define YYPARSE_PARAM_ARG YYPARSE_PARAM
-#  define YYPARSE_PARAM_DECL void *YYPARSE_PARAM;
-# endif
-#else /* !YYPARSE_PARAM */
-# define YYPARSE_PARAM_ARG
-# define YYPARSE_PARAM_DECL
-#endif /* !YYPARSE_PARAM */
-
-/* Prevent warning if -Wstrict-prototypes.  */
-#ifdef __GNUC__
-# ifdef YYPARSE_PARAM
-int yyparse (void *);
-# else
-int yyparse (void);
-# endif
-#endif
-
-/* YY_DECL_VARIABLES -- depending whether we use a pure parser,
-   variables are global, or local to YYPARSE.  */
-
-#define YY_DECL_NON_LSP_VARIABLES			\
-/* The lookahead symbol.  */				\
-int yychar;						\
-							\
-/* The semantic value of the lookahead symbol. */	\
-YYSTYPE yylval;						\
-							\
-/* Number of parse errors so far.  */			\
-int yynerrs;
-
-#if YYLSP_NEEDED
-# define YY_DECL_VARIABLES			\
-YY_DECL_NON_LSP_VARIABLES			\
-						\
-/* Location data for the lookahead symbol.  */	\
-YYLTYPE yylloc;
-#else
-# define YY_DECL_VARIABLES			\
-YY_DECL_NON_LSP_VARIABLES
-#endif
-
-
-/* If nonreentrant, generate the variables here. */
-
-#if !YYPURE
-YY_DECL_VARIABLES
-#endif  /* !YYPURE */
-
-int
-yyparse (YYPARSE_PARAM_ARG)
-     YYPARSE_PARAM_DECL
-{
-  /* If reentrant, generate the variables here. */
-#if YYPURE
-  YY_DECL_VARIABLES
-#endif  /* !YYPURE */
-
-  register int yystate;
-  register int yyn;
-  int yyresult;
-  /* Number of tokens to shift before error messages enabled.  */
-  int yyerrstatus;
-  /* Lookahead token as an internal (translated) token number.  */
-  int yychar1 = 0;
-
-  /* Three stacks and their tools:
-     `yyss': related to states,
-     `yyvs': related to semantic values,
-     `yyls': related to locations.
-
-     Refer to the stacks thru separate pointers, to allow yyoverflow
-     to reallocate them elsewhere.  */
-
-  /* The state stack. */
-  short	yyssa[YYINITDEPTH];
-  short *yyss = yyssa;
-  register short *yyssp;
-
-  /* The semantic value stack.  */
-  YYSTYPE yyvsa[YYINITDEPTH];
-  YYSTYPE *yyvs = yyvsa;
-  register YYSTYPE *yyvsp;
-
-#if YYLSP_NEEDED
-  /* The location stack.  */
-  YYLTYPE yylsa[YYINITDEPTH];
-  YYLTYPE *yyls = yylsa;
-  YYLTYPE *yylsp;
-#endif
-
-#if YYLSP_NEEDED
-# define YYPOPSTACK   (yyvsp--, yyssp--, yylsp--)
-#else
-# define YYPOPSTACK   (yyvsp--, yyssp--)
-#endif
-
-  YYSIZE_T yystacksize = YYINITDEPTH;
-
-
-  /* The variables used to return semantic value and location from the
-     action routines.  */
-  YYSTYPE yyval;
-#if YYLSP_NEEDED
-  YYLTYPE yyloc;
-#endif
-
-  /* When reducing, the number of symbols on the RHS of the reduced
-     rule. */
-  int yylen;
-
-  YYDPRINTF ((stderr, "Starting parse\n"));
-
-  yystate = 0;
-  yyerrstatus = 0;
-  yynerrs = 0;
-  yychar = YYEMPTY;		/* Cause a token to be read.  */
-
-  /* Initialize stack pointers.
-     Waste one element of value and location stack
-     so that they stay on the same level as the state stack.
-     The wasted elements are never initialized.  */
-
-  yyssp = yyss;
-  yyvsp = yyvs;
-#if YYLSP_NEEDED
-  yylsp = yyls;
-#endif
-  goto yysetstate;
-
-/*------------------------------------------------------------.
-| yynewstate -- Push a new state, which is found in yystate.  |
-`------------------------------------------------------------*/
- yynewstate:
-  /* In all cases, when you get here, the value and location stacks
-     have just been pushed. so pushing a state here evens the stacks.
-     */
-  yyssp++;
-
- yysetstate:
-  *yyssp = yystate;
-
-  if (yyssp >= yyss + yystacksize - 1)
-    {
-      /* Get the current used size of the three stacks, in elements.  */
-      YYSIZE_T yysize = yyssp - yyss + 1;
-
-#ifdef yyoverflow
-      {
-	/* Give user a chance to reallocate the stack. Use copies of
-	   these so that the &'s don't force the real ones into
-	   memory.  */
-	YYSTYPE *yyvs1 = yyvs;
-	short *yyss1 = yyss;
-
-	/* Each stack pointer address is followed by the size of the
-	   data in use in that stack, in bytes.  */
-# if YYLSP_NEEDED
-	YYLTYPE *yyls1 = yyls;
-	/* This used to be a conditional around just the two extra args,
-	   but that might be undefined if yyoverflow is a macro.  */
-	yyoverflow ("parser stack overflow",
-		    &yyss1, yysize * sizeof (*yyssp),
-		    &yyvs1, yysize * sizeof (*yyvsp),
-		    &yyls1, yysize * sizeof (*yylsp),
-		    &yystacksize);
-	yyls = yyls1;
-# else
-	yyoverflow ("parser stack overflow",
-		    &yyss1, yysize * sizeof (*yyssp),
-		    &yyvs1, yysize * sizeof (*yyvsp),
-		    &yystacksize);
-# endif
-	yyss = yyss1;
-	yyvs = yyvs1;
-      }
-#else /* no yyoverflow */
-      /* Extend the stack our own way.  */
-      if (yystacksize >= YYMAXDEPTH)
-	goto yyoverflowlab;
-      yystacksize *= 2;
-      if (yystacksize > YYMAXDEPTH)
-	yystacksize = YYMAXDEPTH;
-
-      {
-	short *yyss1 = yyss;
-	union yyalloc *yyptr =
-	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
-	if (! yyptr)
-	  goto yyoverflowlab;
-	YYSTACK_RELOCATE (short, yyss);
-	YYSTACK_RELOCATE (YYSTYPE, yyvs);
-# if YYLSP_NEEDED
-	YYSTACK_RELOCATE (YYLTYPE, yyls);
-# endif
-# undef YYSTACK_RELOCATE
-	if (yyss1 != yyssa)
-	  YYSTACK_FREE (yyss1);
-      }
-#endif /* no yyoverflow */
-
-      yyssp = yyss + yysize - 1;
-      yyvsp = yyvs + yysize - 1;
-#if YYLSP_NEEDED
-      yylsp = yyls + yysize - 1;
-#endif
-
-      YYDPRINTF ((stderr, "Stack size increased to %lu\n",
-		  (unsigned long int) yystacksize));
-
-      if (yyssp >= yyss + yystacksize - 1)
-	YYABORT;
-    }
-
-  YYDPRINTF ((stderr, "Entering state %d\n", yystate));
-
-  goto yybackup;
-
-
-/*-----------.
-| yybackup.  |
-`-----------*/
-yybackup:
-
-/* Do appropriate processing given the current state.  */
-/* Read a lookahead token if we need one and don't already have one.  */
-/* yyresume: */
-
-  /* First try to decide what to do without reference to lookahead token.  */
-
-  yyn = yypact[yystate];
-  if (yyn == YYFLAG)
-    goto yydefault;
-
-  /* Not known => get a lookahead token if don't already have one.  */
-
-  /* yychar is either YYEMPTY or YYEOF
-     or a valid token in external form.  */
-
-  if (yychar == YYEMPTY)
-    {
-      YYDPRINTF ((stderr, "Reading a token: "));
-      yychar = YYLEX;
-    }
-
-  /* Convert token to internal form (in yychar1) for indexing tables with */
-
-  if (yychar <= 0)		/* This means end of input. */
-    {
-      yychar1 = 0;
-      yychar = YYEOF;		/* Don't call YYLEX any more */
-
-      YYDPRINTF ((stderr, "Now at end of input.\n"));
-    }
-  else
-    {
-      yychar1 = YYTRANSLATE (yychar);
-
-#if YYDEBUG
-     /* We have to keep this `#if YYDEBUG', since we use variables
-	which are defined only if `YYDEBUG' is set.  */
-      if (yydebug)
-	{
-	  YYFPRINTF (stderr, "Next token is %d (%s",
-		     yychar, yytname[yychar1]);
-	  /* Give the individual parser a way to print the precise
-	     meaning of a token, for further debugging info.  */
-# ifdef YYPRINT
-	  YYPRINT (stderr, yychar, yylval);
-# endif
-	  YYFPRINTF (stderr, ")\n");
-	}
-#endif
-    }
-
-  yyn += yychar1;
-  if (yyn < 0 || yyn > YYLAST || yycheck[yyn] != yychar1)
-    goto yydefault;
-
-  yyn = yytable[yyn];
-
-  /* yyn is what to do for this token type in this state.
-     Negative => reduce, -yyn is rule number.
-     Positive => shift, yyn is new state.
-       New state is final state => don't bother to shift,
-       just return success.
-     0, or most negative number => error.  */
-
-  if (yyn < 0)
-    {
-      if (yyn == YYFLAG)
-	goto yyerrlab;
-      yyn = -yyn;
-      goto yyreduce;
-    }
-  else if (yyn == 0)
-    goto yyerrlab;
-
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
-  /* Shift the lookahead token.  */
-  YYDPRINTF ((stderr, "Shifting token %d (%s), ",
-	      yychar, yytname[yychar1]));
-
-  /* Discard the token being shifted unless it is eof.  */
-  if (yychar != YYEOF)
-    yychar = YYEMPTY;
-
-  *++yyvsp = yylval;
-#if YYLSP_NEEDED
-  *++yylsp = yylloc;
-#endif
-
-  /* Count tokens shifted since error; after three, turn off error
-     status.  */
-  if (yyerrstatus)
-    yyerrstatus--;
-
-  yystate = yyn;
-  goto yynewstate;
-
-
-/*-----------------------------------------------------------.
-| yydefault -- do the default action for the current state.  |
-`-----------------------------------------------------------*/
-yydefault:
-  yyn = yydefact[yystate];
-  if (yyn == 0)
-    goto yyerrlab;
-  goto yyreduce;
-
-
-/*-----------------------------.
-| yyreduce -- Do a reduction.  |
-`-----------------------------*/
-yyreduce:
-  /* yyn is the number of a rule to reduce with.  */
-  yylen = yyr2[yyn];
-
-  /* If YYLEN is nonzero, implement the default value of the action:
-     `$$ = $1'.
-
-     Otherwise, the following line sets YYVAL to the semantic value of
-     the lookahead token.  This behavior is undocumented and Bison
-     users should not rely upon it.  Assigning to YYVAL
-     unconditionally makes the parser a bit smaller, and it avoids a
-     GCC warning that YYVAL may be used uninitialized.  */
-  yyval = yyvsp[1-yylen];
-
-#if YYLSP_NEEDED
-  /* Similarly for the default location.  Let the user run additional
-     commands if for instance locations are ranges.  */
-  yyloc = yylsp[1-yylen];
-  YYLLOC_DEFAULT (yyloc, (yylsp - yylen), yylen);
-#endif
-
-#if YYDEBUG
-  /* We have to keep this `#if YYDEBUG', since we use variables which
-     are defined only if `YYDEBUG' is set.  */
-  if (yydebug)
-    {
-      int yyi;
-
-      YYFPRINTF (stderr, "Reducing via rule %d (line %d), ",
-		 yyn, yyrline[yyn]);
-
-      /* Print the symbols being reduced, and their result.  */
-      for (yyi = yyprhs[yyn]; yyrhs[yyi] > 0; yyi++)
-	YYFPRINTF (stderr, "%s ", yytname[yyrhs[yyi]]);
-      YYFPRINTF (stderr, " -> %s\n", yytname[yyr1[yyn]]);
-    }
-#endif
-
-  switch (yyn) {
-
-case 3:
-#line 69 "icalssyacc.y"
-{ 
-                 yyclearin;
-		 YYABORT;
-           }
-    break;
-case 4:
-#line 76 "icalssyacc.y"
-{ssyacc_add_select(yyextra,yyvsp[0].v_string);}
-    break;
-case 5:
-#line 77 "icalssyacc.y"
-{ssyacc_add_select(yyextra,yyvsp[0].v_string);}
-    break;
-case 6:
-#line 82 "icalssyacc.y"
-{ssyacc_add_from(yyextra,yyvsp[0].v_string);}
-    break;
-case 7:
-#line 83 "icalssyacc.y"
-{ssyacc_add_from(yyextra,yyvsp[0].v_string);}
-    break;
-case 9:
-#line 88 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_EQUAL,yyvsp[0].v_string); }
-    break;
-case 10:
-#line 89 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_ISNULL,""); }
-    break;
-case 11:
-#line 90 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-3].v_string,ICALGAUGECOMPARE_ISNOTNULL,""); }
-    break;
-case 12:
-#line 91 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_NOTEQUAL,yyvsp[0].v_string); }
-    break;
-case 13:
-#line 92 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_LESS,yyvsp[0].v_string); }
-    break;
-case 14:
-#line 93 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_GREATER,yyvsp[0].v_string); }
-    break;
-case 15:
-#line 94 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_LESSEQUAL,yyvsp[0].v_string); }
-    break;
-case 16:
-#line 95 "icalssyacc.y"
-{ssyacc_add_where(yyextra,yyvsp[-2].v_string,ICALGAUGECOMPARE_GREATEREQUAL,yyvsp[0].v_string); }
-    break;
-case 17:
-#line 99 "icalssyacc.y"
-{set_logic(yyextra,ICALGAUGELOGIC_NONE);}
-    break;
-case 18:
-#line 100 "icalssyacc.y"
-{set_logic(yyextra,ICALGAUGELOGIC_AND);}
-    break;
-case 19:
-#line 101 "icalssyacc.y"
-{set_logic(yyextra,ICALGAUGELOGIC_OR);}
-    break;
-}
-
-#line 705 "/usr/local/share/bison/bison.simple"
-
-
-  yyvsp -= yylen;
-  yyssp -= yylen;
-#if YYLSP_NEEDED
-  yylsp -= yylen;
-#endif
-
-#if YYDEBUG
-  if (yydebug)
-    {
-      short *yyssp1 = yyss - 1;
-      YYFPRINTF (stderr, "state stack now");
-      while (yyssp1 != yyssp)
-	YYFPRINTF (stderr, " %d", *++yyssp1);
-      YYFPRINTF (stderr, "\n");
-    }
-#endif
-
-  *++yyvsp = yyval;
-#if YYLSP_NEEDED
-  *++yylsp = yyloc;
-#endif
-
-  /* Now `shift' the result of the reduction.  Determine what state
-     that goes to, based on the state we popped back to and the rule
-     number reduced by.  */
-
-  yyn = yyr1[yyn];
-
-  yystate = yypgoto[yyn - YYNTBASE] + *yyssp;
-  if (yystate >= 0 && yystate <= YYLAST && yycheck[yystate] == *yyssp)
-    yystate = yytable[yystate];
-  else
-    yystate = yydefgoto[yyn - YYNTBASE];
-
-  goto yynewstate;
-
-
-/*------------------------------------.
-| yyerrlab -- here on detecting error |
-`------------------------------------*/
-yyerrlab:
-  /* If not already recovering from an error, report this error.  */
-  if (!yyerrstatus)
-    {
-      ++yynerrs;
-
-#ifdef YYERROR_VERBOSE
-      yyn = yypact[yystate];
-
-      if (yyn > YYFLAG && yyn < YYLAST)
-	{
-	  YYSIZE_T yysize = 0;
-	  char *yymsg;
-	  int yyx, yycount;
-
-	  yycount = 0;
-	  /* Start YYX at -YYN if negative to avoid negative indexes in
-	     YYCHECK.  */
-	  for (yyx = yyn < 0 ? -yyn : 0;
-	       yyx < (int) (sizeof (yytname) / sizeof (char *)); yyx++)
-	    if (yycheck[yyx + yyn] == yyx)
-	      yysize += yystrlen (yytname[yyx]) + 15, yycount++;
-	  yysize += yystrlen ("parse error, unexpected ") + 1;
-	  yysize += yystrlen (yytname[YYTRANSLATE (yychar)]);
-	  yymsg = (char *) YYSTACK_ALLOC (yysize);
-	  if (yymsg != 0)
-	    {
-	      char *yyp = yystpcpy (yymsg, "parse error, unexpected ");
-	      yyp = yystpcpy (yyp, yytname[YYTRANSLATE (yychar)]);
-
-	      if (yycount < 5)
-		{
-		  yycount = 0;
-		  for (yyx = yyn < 0 ? -yyn : 0;
-		       yyx < (int) (sizeof (yytname) / sizeof (char *));
-		       yyx++)
-		    if (yycheck[yyx + yyn] == yyx)
-		      {
-			const char *yyq = ! yycount ? ", expecting " : " or ";
-			yyp = yystpcpy (yyp, yyq);
-			yyp = yystpcpy (yyp, yytname[yyx]);
-			yycount++;
-		      }
-		}
-	      yyerror (yymsg);
-	      YYSTACK_FREE (yymsg);
-	    }
-	  else
-	    yyerror ("parse error; also virtual memory exhausted");
-	}
-      else
-#endif /* defined (YYERROR_VERBOSE) */
-	yyerror ("parse error");
-    }
-  goto yyerrlab1;
-
-
-/*--------------------------------------------------.
-| yyerrlab1 -- error raised explicitly by an action |
-`--------------------------------------------------*/
-yyerrlab1:
-  if (yyerrstatus == 3)
-    {
-      /* If just tried and failed to reuse lookahead token after an
-	 error, discard it.  */
-
-      /* return failure if at end of input */
-      if (yychar == YYEOF)
-	YYABORT;
-      YYDPRINTF ((stderr, "Discarding token %d (%s).\n",
-		  yychar, yytname[yychar1]));
-      yychar = YYEMPTY;
-    }
-
-  /* Else will try to reuse lookahead token after shifting the error
-     token.  */
-
-  yyerrstatus = 3;		/* Each real token shifted decrements this */
-
-  goto yyerrhandle;
-
-
-/*-------------------------------------------------------------------.
-| yyerrdefault -- current state does not do anything special for the |
-| error token.                                                       |
-`-------------------------------------------------------------------*/
-yyerrdefault:
-#if 0
-  /* This is wrong; only states that explicitly want error tokens
-     should shift them.  */
-
-  /* If its default is to accept any token, ok.  Otherwise pop it.  */
-  yyn = yydefact[yystate];
-  if (yyn)
-    goto yydefault;
-#endif
-
-
-/*---------------------------------------------------------------.
-| yyerrpop -- pop the current state because it cannot handle the |
-| error token                                                    |
-`---------------------------------------------------------------*/
-yyerrpop:
-  if (yyssp == yyss)
-    YYABORT;
-  yyvsp--;
-  yystate = *--yyssp;
-#if YYLSP_NEEDED
-  yylsp--;
-#endif
-
-#if YYDEBUG
-  if (yydebug)
-    {
-      short *yyssp1 = yyss - 1;
-      YYFPRINTF (stderr, "Error: state stack now");
-      while (yyssp1 != yyssp)
-	YYFPRINTF (stderr, " %d", *++yyssp1);
-      YYFPRINTF (stderr, "\n");
-    }
-#endif
-
-/*--------------.
-| yyerrhandle.  |
-`--------------*/
-yyerrhandle:
-  yyn = yypact[yystate];
-  if (yyn == YYFLAG)
-    goto yyerrdefault;
-
-  yyn += YYTERROR;
-  if (yyn < 0 || yyn > YYLAST || yycheck[yyn] != YYTERROR)
-    goto yyerrdefault;
-
-  yyn = yytable[yyn];
-  if (yyn < 0)
-    {
-      if (yyn == YYFLAG)
-	goto yyerrpop;
-      yyn = -yyn;
-      goto yyreduce;
-    }
-  else if (yyn == 0)
-    goto yyerrpop;
-
-  if (yyn == YYFINAL)
-    YYACCEPT;
-
-  YYDPRINTF ((stderr, "Shifting error token, "));
-
-  *++yyvsp = yylval;
-#if YYLSP_NEEDED
-  *++yylsp = yylloc;
-#endif
-
-  yystate = yyn;
-  goto yynewstate;
-
-
-/*-------------------------------------.
-| yyacceptlab -- YYACCEPT comes here.  |
-`-------------------------------------*/
-yyacceptlab:
-  yyresult = 0;
-  goto yyreturn;
-
-/*-----------------------------------.
-| yyabortlab -- YYABORT comes here.  |
-`-----------------------------------*/
-yyabortlab:
-  yyresult = 1;
-  goto yyreturn;
-
-/*---------------------------------------------.
-| yyoverflowab -- parser overflow comes here.  |
-`---------------------------------------------*/
-yyoverflowlab:
-  yyerror ("parser stack overflow");
-  yyresult = 2;
-  /* Fall through.  */
-
-yyreturn:
-#ifndef yyoverflow
-  if (yyss != yyssa)
-    YYSTACK_FREE (yyss);
-#endif
-  return yyresult;
-}
-#line 105 "icalssyacc.y"
-
-
-static void ssyacc_add_where(struct icalgauge_impl* impl, char* str1, 
-	icalgaugecompare compare , char* value_str)
-{
-
-    struct icalgauge_where *where;
-    char *compstr, *propstr, *c, *s,*l;
-    
-    if ( (where = malloc(sizeof(struct icalgauge_where))) ==0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return;
-    }
-
-    memset(where,0,sizeof(struct icalgauge_where));
-    where->logic = ICALGAUGELOGIC_NONE;
-    where->compare = ICALGAUGECOMPARE_NONE;
-    where->comp = ICAL_NO_COMPONENT;
-    where->prop = ICAL_NO_PROPERTY;
-
-    /* remove enclosing quotes */
-    s = value_str;
-    if(*s == '\''){
-	s++;
-    }
-    l = s+strlen(s)-1;
-    if(*l == '\''){
-	*l=0;
-    }
-	
-    where->value = strdup(s);
-
-    /* Is there a period in str1 ? If so, the string specified both a
-       component and a property*/
-    if( (c = strrchr(str1,'.')) != 0){
-	compstr = str1;
-	propstr = c+1;
-	*c = '\0';
-    } else {
-	compstr = 0;
-	propstr = str1;
-    }
-
-
-    /* Handle the case where a component was specified */
-    if(compstr != 0){
-	where->comp = icalenum_string_to_component_kind(compstr);
-    } else {
-	where->comp = ICAL_NO_COMPONENT;
-    }
-
-    where->prop = icalenum_string_to_property_kind(propstr);    
-
-    where->compare = compare;
-
-    if(where->value == 0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	free(where->value);
-	return;
-    }
-
-    pvl_push(impl->where,where);
-}
-
-static void set_logic(struct icalgauge_impl* impl,icalgaugelogic l)
-{
-    pvl_elem e = pvl_tail(impl->where);
-    struct icalgauge_where *where = pvl_data(e);
-
-    where->logic = l;
-   
-}
-
-
-
-static void ssyacc_add_select(struct icalgauge_impl* impl, char* str1)
-{
-    char *c, *compstr, *propstr;
-    struct icalgauge_where *where;
-    
-    /* Uses only the prop and comp fields of the where structure */
-    if ( (where = malloc(sizeof(struct icalgauge_where))) ==0){
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return;
-    }
-
-    memset(where,0,sizeof(struct icalgauge_where));
-    where->logic = ICALGAUGELOGIC_NONE;
-    where->compare = ICALGAUGECOMPARE_NONE;
-    where->comp = ICAL_NO_COMPONENT;
-    where->prop = ICAL_NO_PROPERTY;
-
-    /* Is there a period in str1 ? If so, the string specified both a
-       component and a property*/
-    if( (c = strrchr(str1,'.')) != 0){
-	compstr = str1;
-	propstr = c+1;
-	*c = '\0';
-    } else {
-	compstr = 0;
-	propstr = str1;
-    }
-
-
-    /* Handle the case where a component was specified */
-    if(compstr != 0){
-	where->comp = icalenum_string_to_component_kind(compstr);
-    } else {
-	where->comp = ICAL_NO_COMPONENT;
-    }
-
-
-    /* If the property was '*', then accept all properties */
-    if(strcmp("*",propstr) == 0) {
-	where->prop = ICAL_ANY_PROPERTY; 	    
-    } else {
-	where->prop = icalenum_string_to_property_kind(propstr);    
-    }
-    
-
-    if(where->prop == ICAL_NO_PROPERTY){
-      free(where);
-      icalerror_set_errno(ICAL_BADARG_ERROR);
-      return;
-    }
-
-    pvl_push(impl->select,where);
-}
-
-static void ssyacc_add_from(struct icalgauge_impl* impl, char* str1)
-{
-    icalcomponent_kind ckind;
-
-    ckind = icalenum_string_to_component_kind(str1);
-
-    if(ckind == ICAL_NO_COMPONENT){
-	assert(0);
-    }
-
-    pvl_push(impl->from,(void*)ckind);
-
-}
-
-
-void sserror(char *s){
-  fprintf(stderr,"Parse error \'%s\'\n", s);
-  icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-}
Index: libkcal/libical/src/libicalss/icalcluster.h
===================================================================
--- libkcal/libical/src/libicalss/icalcluster.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalcluster.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,61 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalcluster.h
- CREATOR: eric 23 December 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALCLUSTER_H
-#define ICALCLUSTER_H
-
-#include "ical.h"
-#include "icalset.h"
-
-typedef struct icalcluster_impl icalcluster;
-
-icalcluster* icalcluster_new(const char *key, icalcomponent *data);
-icalcluster* icalcluster_new_clone(const icalcluster *cluster);
-
-void icalcluster_free(icalcluster *cluster);
-
-const char* icalcluster_key(icalcluster *cluster);
-int icalcluster_is_changed(icalcluster *cluster);
-void icalcluster_mark(icalcluster *cluster);
-void icalcluster_commit(icalcluster *cluster);
-
-icalcomponent* icalcluster_get_component(icalcluster* cluster);
-int icalcluster_count_components(icalcluster *cluster, icalcomponent_kind kind);
-icalerrorenum icalcluster_add_component(icalcluster* cluster,
-					icalcomponent* child);
-icalerrorenum icalcluster_remove_component(icalcluster* cluster,
-					   icalcomponent* child);
-
-icalcomponent* icalcluster_get_current_component(icalcluster* cluster);
-icalcomponent* icalcluster_get_first_component(icalcluster* cluster);
-icalcomponent* icalcluster_get_next_component(icalcluster* cluster);
-
-#endif /* !ICALCLUSTER_H */
-
-
-
Index: libkcal/libical/src/libicalss/icalgauge.c
===================================================================
--- libkcal/libical/src/libicalss/icalgauge.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalgauge.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,529 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalgauge.c
- CREATOR: eric 23 December 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#include "ical.h"
-#include "icalgauge.h"
-#include "icalgaugeimpl.h"
-#include <stdlib.h>
-
-#include "icalssyacc.h"
-
-typedef void* yyscan_t;
-
-int ssparse(yyscan_t );
-
-
-icalgauge* icalgauge_new_from_sql(char* sql, int expand)
-{
-    struct icalgauge_impl *impl;
-    yyscan_t yy_globals = NULL;
-
-    int r;
-    
-    if ( ( impl = (struct icalgauge_impl*)
-	   malloc(sizeof(struct icalgauge_impl))) == 0) {
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return 0;
-    }
-
-    impl->select = pvl_newlist();
-    impl->from = pvl_newlist();
-    impl->where = pvl_newlist();
-    impl->expand = expand;
-
-    sslex_init(&yy_globals);
-
-    ssset_extra(impl, yy_globals);
-
-    ss_scan_string(sql, yy_globals);
-
-    r = ssparse(yy_globals);
-    sslex_destroy(yy_globals);
-
-	if (r == 0) {
-	    return impl;
-	}
-	else {
-		 icalgauge_free(impl);
-	 	 return NULL;
-	}
-}
-
-int icalgauge_get_expand(icalgauge* gauge)
-{
-return (gauge->expand);
-
-}
-
-void icalgauge_free(icalgauge* gauge)
-{
-      struct icalgauge_where *w;
-
-      assert(gauge->select != 0);
-      assert(gauge->where != 0);
-      assert(gauge->from != 0);
-
-      if(gauge->select){
-	  while( (w=pvl_pop(gauge->select)) != 0){
-	      if(w->value != 0){
-		  free(w->value);
-	      }
-	      free(w);
-	  }
-	  pvl_free(gauge->select);
-	  gauge->select = 0;
-      }
-
-      if(gauge->where){
-	  while( (w=pvl_pop(gauge->where)) != 0){
-	      
-	      if(w->value != 0){
-		  free(w->value);
-	      }
-	      free(w);
-	  }
-	  pvl_free(gauge->where);
-	  gauge->where = 0;
-      }
-
-      if(gauge->from){
-	  pvl_free(gauge->from);
-	  gauge->from = 0;
-      }
-
-	  free(gauge);
-      
-}
-
-
-/** Convert a VQUERY component into a gauge */
-icalcomponent* icalgauge_make_gauge(icalcomponent* query);
-
-/**
-   icaldirset_test compares a component against a gauge, and returns
-   true if the component passes the test 
-
-   The gauge is a VCALENDAR component that specifies how to test the
-   target components. The gauge holds a collection of VEVENT, VTODO or
-   VJOURNAL sub-components. Each of the sub-components has a
-   collection of properties that are compared to corresponding
-   properties in the target component, according to the
-   X-LIC-COMPARETYPE parameters to the gauge's properties.
-
-   When a gauge has several sub-components, the results of testing the
-   target against each of them is ORed together - the target
-   component will pass if it matches any of the sub-components in the
-   gauge. However, the results of matching the properties in a
-   sub-component are ANDed -- the target must match every property in
-   a gauge sub-component to match the sub-component.
-
-   Here is an example:
-
-   BEGIN:XROOT
-   DTSTART;X-LIC-COMPARETYPE=LESS:19981025T020000
-   ORGANIZER;X-LIC-COMPARETYPE=EQUAL:mrbig@host.com 
-   END:XROOT
-   BEGIN:XROOT
-   LOCATION;X-LIC-COMPARETYPE=EQUAL:McNary's Pub
-   END:XROOT
-
-   This gauge has two sub-components; one which will match a VEVENT
-   based on start time, and organizer, and another that matches based
-   on LOCATION. A target component will pass the test if it matched
-   either of the sub-components.
-   
-  */
-
-
-int icalgauge_compare_recurse(icalcomponent* comp, icalcomponent* gauge)
-{
-    int pass = 1,localpass = 0;
-    icalproperty *p;
-    icalcomponent *child,*subgauge; 
-    icalcomponent_kind gaugekind, compkind;
-
-    icalerror_check_arg_rz( (comp!=0), "comp");
-    icalerror_check_arg_rz( (gauge!=0), "gauge");
-
-    gaugekind = icalcomponent_isa(gauge);
-    compkind = icalcomponent_isa(comp);
-
-    if( ! (gaugekind == compkind || gaugekind == ICAL_ANY_COMPONENT) ){
-	return 0;
-    }   
-
-    /* Test properties. For each property in the gauge, search through
-       the component for a similar property. If one is found, compare
-       the two properties value with the comparison specified in the
-       gauge with the X-LIC-COMPARETYPE parameter */
-    
-    for(p = icalcomponent_get_first_property(gauge,ICAL_ANY_PROPERTY);
-	p != 0;
-	p = icalcomponent_get_next_property(gauge,ICAL_ANY_PROPERTY)){
-	
-	icalproperty* targetprop; 
-	icalparameter* compareparam;
-	icalparameter_xliccomparetype compare;
-	int rel; /* The relationship between the gauge and target values.*/
-	
-	/* Extract the comparison type from the gauge. If there is no
-	   comparison type, assume that it is "EQUAL" */
-	
-	compareparam = icalproperty_get_first_parameter(
-	    p,
-	    ICAL_XLICCOMPARETYPE_PARAMETER);
-	
-	if (compareparam!=0){
-	    compare = icalparameter_get_xliccomparetype(compareparam);
-	} else {
-	    compare = ICAL_XLICCOMPARETYPE_EQUAL;
-	}
-	
-	/* Find a property in the component that has the same type
-	   as the gauge property. HACK -- multiples of a single
-	   property type in the gauge will match only the first
-	   instance in the component */
-	
-	targetprop = icalcomponent_get_first_property(comp,
-						      icalproperty_isa(p));
-	
-	if(targetprop != 0){
-	
-	    /* Compare the values of the gauge property and the target
-	       property */
-	    
-	    rel = icalvalue_compare(icalproperty_get_value(p),
-				    icalproperty_get_value(targetprop));
-	    
-	    /* Now see if the comparison is equavalent to the comparison
-	       specified in the gauge */
-	    
-	    if (rel == compare){ 
-		localpass++; 
-	    } else if (compare == ICAL_XLICCOMPARETYPE_LESSEQUAL && 
-		       ( rel == ICAL_XLICCOMPARETYPE_LESS ||
-			 rel == ICAL_XLICCOMPARETYPE_EQUAL)) {
-		localpass++;
-	    } else if (compare == ICAL_XLICCOMPARETYPE_GREATEREQUAL && 
-		       ( rel == ICAL_XLICCOMPARETYPE_GREATER ||
-			 rel == ICAL_XLICCOMPARETYPE_EQUAL)) {
-		localpass++;
-	    } else if (compare == ICAL_XLICCOMPARETYPE_NOTEQUAL && 
-		       ( rel == ICAL_XLICCOMPARETYPE_GREATER ||
-			 rel == ICAL_XLICCOMPARETYPE_LESS)) {
-		localpass++;
-	    } else {
-		localpass = 0;
-	    }
-	    
-	    pass = pass && (localpass>0);
-	}
-    }
-    
-    /* Test subcomponents. Look for a child component that has a
-       counterpart in the gauge. If one is found, recursively call
-       icaldirset_test */
-    
-    for(subgauge = icalcomponent_get_first_component(gauge,ICAL_ANY_COMPONENT);
-	subgauge != 0;
-	subgauge = icalcomponent_get_next_component(gauge,ICAL_ANY_COMPONENT)){
-	
-	gaugekind = icalcomponent_isa(subgauge);
-
-	if (gaugekind == ICAL_ANY_COMPONENT){
-	    child = icalcomponent_get_first_component(comp,ICAL_ANY_COMPONENT);
-	} else {
-	    child = icalcomponent_get_first_component(comp,gaugekind);
-	}
-	
-	if(child !=0){
-	    localpass = icalgauge_compare_recurse(child,subgauge);
-	    pass = pass && localpass;
-	} else {
-	    pass = 0;
-	}
-    }
-    
-    return pass;   
-}
-
-
-int icalgauge_compare(icalgauge* gauge,icalcomponent* comp)
-{
-
-    icalcomponent *inner; 
-    int local_pass = 0;
-    int last_clause = 1, this_clause = 1;
-    pvl_elem e;
-    icalcomponent_kind kind;
-    icalproperty *rrule;
-    int compare_recur = 0;
-
-
-    icalerror_check_arg_rz( (comp!=0), "comp");
-    icalerror_check_arg_rz( (gauge!=0), "gauge");
-    
-    if (gauge == 0 || comp == 0) return 0;
- 
-    inner = icalcomponent_get_first_real_component(comp);
-
-    if(inner == 0){
-	/* Wally Yau: our component is not always wrapped with
-	 * a <VCALENDAR>. It's not an error. 
-	 * icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-	 * return 0; */
-	kind = icalcomponent_isa(comp);
-	if(kind == ICAL_VEVENT_COMPONENT ||
-	    kind == ICAL_VTODO_COMPONENT ||
-	    kind == ICAL_VJOURNAL_COMPONENT ||
-	    kind == ICAL_VQUERY_COMPONENT ||
-	    kind == ICAL_VAGENDA_COMPONENT){
-		inner = comp;
-	    }
-	else {
-	    icalerror_set_errno(ICAL_MALFORMEDDATA_ERROR);
-	    return 0;
-	}
-        inner = comp;
-    }
-
-    /* Check that this component is one of the FROM types */
-    local_pass = 0;
-    for(e = pvl_head(gauge->from);e!=0;e=pvl_next(e)){
-	icalcomponent_kind k = (icalcomponent_kind)pvl_data(e);
-
-	if(k == icalcomponent_isa(inner)){
-	    local_pass=1;
-	}
-    }
-    
-    if(local_pass == 0){
-	return 0;
-    }
-
-    
-    /**** Check each where clause against the component ****/
-    for(e = pvl_head(gauge->where);e!=0;e=pvl_next(e)){
-	struct icalgauge_where *w = pvl_data(e);
-	icalcomponent *sub_comp;
-	icalvalue *v;
-	icalproperty *prop;
-	icalvalue_kind vk;
-
-	if(w->prop == ICAL_NO_PROPERTY || w->value == 0){
-	    icalerror_set_errno(ICAL_INTERNAL_ERROR);
-	    return 0;
-	}
-
-	/* First, create a value from the gauge */
-	vk = icalenum_property_kind_to_value_kind(w->prop);
-
-	if(vk == ICAL_NO_VALUE){
-            icalerror_set_errno(ICAL_INTERNAL_ERROR);
-	    return 0;
-	}
-
-        if (w->compare == ICALGAUGECOMPARE_ISNULL || w->compare == ICALGAUGECOMPARE_ISNOTNULL)
-	    v = icalvalue_new(vk);
-        else
-	  v = icalvalue_new_from_string(vk,w->value);
-
-	if (v == 0){
-	    /* Keep error set by icalvalue_from-string*/
-	    return 0;
-	}
-	    
-	/* Now find the corresponding property in the component,
-	   descending into a sub-component if necessary */
-
-	if(w->comp == ICAL_NO_COMPONENT){
-	    sub_comp = inner;
-	} else {
-	    sub_comp = icalcomponent_get_first_component(inner,w->comp);
-	    if(sub_comp == 0){
-		return 0;
-	    }
-	}	   
-
-        /* check if it is a recurring */
-        rrule = icalcomponent_get_first_property(sub_comp,ICAL_RRULE_PROPERTY);
-
-        if (gauge->expand
-            && rrule) {
-
-            if (w->prop == ICAL_DTSTART_PROPERTY || 
-                w->prop == ICAL_DTEND_PROPERTY || 
-                w->prop == ICAL_DUE_PROPERTY){
-	        /** needs to use recurrence-id to do comparison */
-                compare_recur = 1;
-            } 
-
-       }
-
-
-	this_clause = 0;
-	local_pass = (w->compare == ICALGAUGECOMPARE_ISNULL) ? 1 : 0;
-
-	for(prop = icalcomponent_get_first_property(sub_comp,w->prop);
-	    prop != 0;
-	    prop = icalcomponent_get_next_property(sub_comp,w->prop)){
-	    icalvalue* prop_value;
-	    icalgaugecompare relation;
-
-            if (w->compare == ICALGAUGECOMPARE_ISNULL) {
-                local_pass = 0;
-                break;
-            }
-
-            if (w->compare == ICALGAUGECOMPARE_ISNOTNULL) {
-                local_pass = 1;
-                break;
-            }
-
-            if (compare_recur) {
-                icalproperty *p = icalcomponent_get_first_property(sub_comp, ICAL_RECURRENCEID_PROPERTY);   
-                prop_value = icalproperty_get_value(p);
-            }
-            else /* prop value from this component */
-	    prop_value = icalproperty_get_value(prop);
-
-	    relation = (icalgaugecompare)icalvalue_compare(prop_value,v);
-	    
-	    if (relation  == w->compare){ 
-		local_pass++; 
-	    } else if (w->compare == ICALGAUGECOMPARE_LESSEQUAL && 
-		       ( relation  == ICALGAUGECOMPARE_LESS ||
-			 relation  == ICALGAUGECOMPARE_EQUAL)) {
-		local_pass++;
-	    } else if (w->compare == ICALGAUGECOMPARE_GREATEREQUAL && 
-		       ( relation  == ICALGAUGECOMPARE_GREATER ||
-			 relation  == ICALGAUGECOMPARE_EQUAL)) {
-		local_pass++;
-	    } else if (w->compare == ICALGAUGECOMPARE_NOTEQUAL && 
-		       ( relation  == ICALGAUGECOMPARE_GREATER ||
-			 relation  == ICALGAUGECOMPARE_LESS)) {
-		local_pass++;
-	    } else {
-		local_pass = 0;
-	    }
-	}
-    
-    
-	this_clause = local_pass > 0 ? 1 : 0;
-
-
-	/* Now look at the logic operator for this clause to see how
-           the value should be merge with the previous clause */
-
-	if(w->logic == ICALGAUGELOGIC_AND){
-	    last_clause = this_clause && last_clause;
-	} else if(w->logic == ICALGAUGELOGIC_OR) {
-	    last_clause = this_clause || last_clause;
-	} else {
-	    last_clause = this_clause;
-	}
-
-	icalvalue_free(v);
-
-    }/**** check next one in where clause ****/
-
-    return last_clause;
-
-}
-    
-/** @brief Debug
- * Print gauge information to stdout.
- */
-
-void icalgauge_dump(icalgauge* gauge)
-{
-
-    pvl_elem p;
-  
-    printf("--- Select ---\n");
-    for(p = pvl_head(gauge->select);p!=0;p=pvl_next(p)){
-	struct icalgauge_where *w = pvl_data(p);
-
-	if(w->comp != ICAL_NO_COMPONENT){
-	    printf("%s ",icalenum_component_kind_to_string(w->comp));
-	}
-
-	if(w->prop != ICAL_NO_PROPERTY){
-	    printf("%s ",icalenum_property_kind_to_string(w->prop));
-	}
-	
-	if (w->compare != ICALGAUGECOMPARE_NONE){
-	    printf("%d ",w->compare);
-	}
-
-
-	if (w->value!=0){
-	    printf("%s",w->value);
-	}
-
-
-	printf("\n");
-    }
-
-    printf("--- From ---\n");
-    for(p = pvl_head(gauge->from);p!=0;p=pvl_next(p)){
-	icalcomponent_kind k = (icalcomponent_kind)pvl_data(p);
-
-	printf("%s\n",icalenum_component_kind_to_string(k));
-    }
-
-    printf("--- Where ---\n");
-    for(p = pvl_head(gauge->where);p!=0;p=pvl_next(p)){
-	struct icalgauge_where *w = pvl_data(p);
-
-	if(w->logic != ICALGAUGELOGIC_NONE){
-	    printf("%d ",w->logic);
-	}
-	
-	if(w->comp != ICAL_NO_COMPONENT){
-	    printf("%s ",icalenum_component_kind_to_string(w->comp));
-	}
-
-	if(w->prop != ICAL_NO_PROPERTY){
-	    printf("%s ",icalenum_property_kind_to_string(w->prop));
-	}
-	
-	if (w->compare != ICALGAUGECOMPARE_NONE){
-	    printf("%d ",w->compare);
-	}
-
-
-	if (w->value!=0){
-	    printf("%s",w->value);
-	}
-
-
-	printf("\n");
-    }
-}
-
Index: libkcal/libical/src/libicalss/icalmessage.h
===================================================================
--- libkcal/libical/src/libicalss/icalmessage.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalmessage.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,71 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalmessage.h
- CREATOR: eric 07 Nov 2000
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-
- =========================================================================*/
-
-#include "ical.h"
-
-#ifndef ICALMESSAGE_H
-#define ICALMESSAGE_H
-
-
-icalcomponent* icalmessage_new_accept_reply(icalcomponent* c, 
-					    const char* user,
-					    const char* msg);
-
-icalcomponent* icalmessage_new_decline_reply(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-
-/* New is modified version of old */
-icalcomponent* icalmessage_new_counterpropose_reply(icalcomponent* oldc,
-						    icalcomponent* newc,
-						    const char* user,
-						    const char* msg);
-
-
-icalcomponent* icalmessage_new_delegate_reply(icalcomponent* c,
-					      const char* user,
-					      const char* delegatee,
-					      const char* msg);
-
-
-icalcomponent* icalmessage_new_cancel_event(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-icalcomponent* icalmessage_new_cancel_instance(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-icalcomponent* icalmessage_new_cancel_all(icalcomponent* c,
-					    const char* user,
-					    const char* msg);
-
-
-icalcomponent* icalmessage_new_error_reply(icalcomponent* c,
-					   const char* user,
-					   const char* msg,
-					   const char* debug,
-					   icalrequeststatus rs);
-
-
-#endif /* ICALMESSAGE_H*/
Index: libkcal/libical/src/libicalss/icaldirset.c
===================================================================
--- libkcal/libical/src/libicalss/icaldirset.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icaldirset.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,805 +0,0 @@
-/* -*- Mode: C -*-
-    ======================================================================
-    FILE: icaldirset.c
-    CREATOR: eric 28 November 1999
-  
-    $Id$
-    $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-    The Original Code is eric. The Initial Developer of the Original
-    Code is Eric Busboom
-
-
-    ======================================================================*/
-
-
-/**
-   @file   icaldirset.c
- 
-   @brief  icaldirset manages a database of ical components and offers
-  interfaces for reading, writing and searching for components.
-
-  icaldirset groups components in to clusters based on their DTSTAMP
-  time -- all components that start in the same month are grouped
-  together in a single file. All files in a sotre are kept in a single
-  directory. 
-
-  The primary interfaces are icaldirset__get_first_component and
-  icaldirset_get_next_component. These routine iterate through all of
-  the components in the store, subject to the current gauge. A gauge
-  is an icalcomponent that is tested against other componets for a
-  match. If a gauge has been set with icaldirset_select,
-  icaldirset_first and icaldirset_next will only return componentes
-  that match the gauge.
-
-  The Store generated UIDs for all objects that are stored if they do
-  not already have a UID. The UID is the name of the cluster (month &
-  year as MMYYYY) plus a unique serial number. The serial number is
-  stored as a property of the cluster.
-
-*/
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-
-#include "ical.h"
-#include "icaldirset.h"
-#include "icaldirset.h"
-#include "icalfileset.h"
-#include "icalfilesetimpl.h"
-#include "icalcluster.h"
-#include "icalgauge.h"
-
-#include <limits.h> /* For PATH_MAX */
-#ifndef WIN32
-#include <dirent.h> /* for opendir() */
-#include <unistd.h> /* for stat, getpid */
-#include <sys/utsname.h> /* for uname */
-#else
-#include <io.h>
-#include <process.h>
-#endif
-#include <errno.h>
-#include <sys/types.h> /* for opendir() */
-#include <sys/stat.h> /* for stat */
-#include <time.h> /* for clock() */
-#include <stdlib.h> /* for rand(), srand() */
-#include <string.h> /* for strdup */
-#include "icaldirsetimpl.h"
-
-
-#ifdef WIN32
-#define snprintf	_snprintf
-#define strcasecmp	stricmp
-
-#define _S_ISTYPE(mode, mask)  (((mode) & _S_IFMT) == (mask))
-
-#define S_ISDIR(mode)    _S_ISTYPE((mode), _S_IFDIR)
-#define S_ISREG(mode)    _S_ISTYPE((mode), _S_IFREG)
-#endif
-
-/** Default options used when NULL is passed to icalset_new() **/
-icaldirset_options icaldirset_options_default = {O_RDWR|O_CREAT};
-
-
-const char* icaldirset_path(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-
-  return dset->dir;
-}
-
-
-void icaldirset_mark(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-
-  icalcluster_mark(dset->cluster);
-}
-
-
-icalerrorenum icaldirset_commit(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-  icalset *fileset;
-  icalfileset_options options = icalfileset_options_default;
-
-  options.cluster = dset->cluster;
-
-  fileset = icalset_new(ICAL_FILE_SET, icalcluster_key(dset->cluster), &options);
-
-  fileset->commit(fileset);
-  fileset->free(fileset);
-
-  return ICAL_NO_ERROR;
-}
-
-void icaldirset_lock(const char* dir)
-{
-}
-
-
-void icaldirset_unlock(const char* dir)
-{
-}
-
-/* Load the contents of the store directory into the store's internal directory list*/
-icalerrorenum icaldirset_read_directory(icaldirset *dset)
-{
-    char *str;
-#ifndef WIN32
-    struct dirent *de;
-    DIR* dp;
- 
-    dp = opendir(dset->dir);
-   
-    if (dp == 0) {
-	icalerror_set_errno(ICAL_FILE_ERROR);
-	return ICAL_FILE_ERROR;
-    }
-
-    /* clear contents of directory list */
-    while((str = pvl_pop(dset->directory))){
-	free(str);
-    }
-    
-    /* load all of the cluster names in the directory list */
-    for(de = readdir(dp);
-	de != 0;
-	de = readdir(dp)){
-
-	/* Remove known directory names  '.' and '..'*/
-	if (strcmp(de->d_name,".") == 0 ||
-	    strcmp(de->d_name,"..") == 0 ){
-	    continue;
-	}
-
-	pvl_push(dset->directory, (void*)strdup(de->d_name));	
-    }
-
-    closedir(dp);
-#else
-	struct _finddata_t c_file;
-	long hFile;
-	
-	/* Find first .c file in current directory */
-    if( (hFile = _findfirst( "*", &c_file )) == -1L ) {
-		icalerror_set_errno(ICAL_FILE_ERROR);
-		return ICAL_FILE_ERROR;
-    } else {
-      while((str = pvl_pop(dset->directory))){
-			free(str);
-		}
-		
-		/* load all of the cluster names in the directory list */
-      do {
-			/* Remove known directory names  '.' and '..'*/
-			if (strcmp(c_file.name,".") == 0 ||
-				strcmp(c_file.name,"..") == 0 ){
-				continue;
-			}
-			
-	pvl_push(dset->directory, (void*)strdup(c_file.name));
-		}
-		while ( _findnext( hFile, &c_file ) == 0 );
-			
-		_findclose( hFile );
-	}
-
-#endif
-
-    return ICAL_NO_ERROR;
-}
-
-
-icalset* icaldirset_init(icalset* set, const char* dir, void* options_in)
-{
-  icaldirset *dset = (icaldirset*)set;
-  icaldirset_options *options = options_in;
-    struct stat sbuf;
-
-    icalerror_check_arg_rz( (dir!=0), "dir");
-  icalerror_check_arg_rz( (set!=0), "set");
-
-    if (stat(dir,&sbuf) != 0){
-	icalerror_set_errno(ICAL_FILE_ERROR);
-	return 0;
-    }
-    
-    /* dir is not the name of a direectory*/
-    if (!S_ISDIR(sbuf.st_mode)){ 
-	icalerror_set_errno(ICAL_USAGE_ERROR);
-	return 0;
-    }	    
-
-    icaldirset_lock(dir);
-
-  dset->dir = (char*)strdup(dir);
-  dset->options = *options;
-  dset->directory = pvl_newlist();
-  dset->directory_iterator = 0;
-  dset->gauge = 0;
-  dset->first_component = 0;
-  dset->cluster = 0;
-
-  return set;
-}
-
-icalset* icaldirset_new(const char* dir)
-{
-  return icalset_new(ICAL_DIR_SET, dir, &icaldirset_options_default);
-}
-
-    
-icalset* icaldirset_new_reader(const char* dir)
-{
-  icaldirset_options reader_options = icaldirset_options_default;
-
-  reader_options.flags = O_RDONLY;
-
-  return icalset_new(ICAL_DIR_SET, dir, &reader_options);
-}
-
-    
-icalset* icaldirset_new_writer(const char* dir)
-{
-  icaldirset_options writer_options = icaldirset_options_default;
-
-  writer_options.flags = O_RDWR|O_CREAT;
-
-  return icalset_new(ICAL_DIR_SET, dir, &writer_options);
-}
-
-
-void icaldirset_free(icalset* s)
-{
-  icaldirset *dset = (icaldirset*)s;
-    char* str;
-
-  icaldirset_unlock(dset->dir);
-
-  if(dset->dir !=0){
-    free(dset->dir);
-    dset->dir = 0;
-    }
-
-  if(dset->gauge !=0){
-    icalgauge_free(dset->gauge);
-    dset->gauge = 0;
-    }
-
-  if(dset->cluster !=0){
-    icalcluster_free(dset->cluster);
-    }
-
-  while(dset->directory !=0 &&  (str=pvl_pop(dset->directory)) != 0){
-	free(str);
-    }
-
-  if(dset->directory != 0){
-    pvl_free(dset->directory);
-    dset->directory = 0;
-    }
-
-  dset->directory_iterator = 0;
-  dset->first_component = 0;
-}
-
-
-/* icaldirset_next_uid_number updates a serial number in the Store
-   directory in a file called SEQUENCE */
-
-int icaldirset_next_uid_number(icaldirset* dset)
-{
-    char sequence = 0;
-    char temp[128];
-    char filename[ICAL_PATH_MAX];
-    char *r;
-    FILE *f;
-    struct stat sbuf;
-
-    icalerror_check_arg_rz( (dset!=0), "dset");
-
-    snprintf(filename,sizeof(filename),"%s/%s",dset->dir,"SEQUENCE");
-
-    /* Create the file if it does not exist.*/
-    if (stat(filename,&sbuf) == -1 || !S_ISREG(sbuf.st_mode)){
-
-	f = fopen(filename,"w");
-	if (f != 0){
-	    fprintf(f,"0");
-	    fclose(f);
-	} else {
-	    icalerror_warn("Can't create SEQUENCE file in icaldirset_next_uid_number");
-	    return 0;
-	}
-    }
-    
-    if ( (f = fopen(filename,"r+")) != 0){
-
-	rewind(f);
-	r = fgets(temp,128,f);
-
-	if (r == 0){
-	    sequence = 1;
-	} else {
-	    sequence = atoi(temp)+1;
-	}
-
-	rewind(f);
-
-	fprintf(f,"%d",sequence);
-
-	fclose(f);
-
-	return sequence;
-	
-    } else {
-	icalerror_warn("Can't create SEQUENCE file in icaldirset_next_uid_number");
-	return 0;
-    }
-}
-
-icalerrorenum icaldirset_next_cluster(icaldirset* dset)
-{
-    char path[ICAL_PATH_MAX];
-
-    if (dset->directory_iterator == 0){
-	icalerror_set_errno(ICAL_INTERNAL_ERROR);
-	return ICAL_INTERNAL_ERROR;
-    }	    
-    dset->directory_iterator = pvl_next(dset->directory_iterator);
-
-    if (dset->directory_iterator == 0){
-	/* There are no more clusters */
-	if(dset->cluster != 0){
-	    icalcluster_free(dset->cluster);
-	    dset->cluster = 0;
-	}
-	return ICAL_NO_ERROR;
-    }
-	    
-    snprintf(path,sizeof(path),"%s/%s", dset->dir,(char*)pvl_data(dset->directory_iterator));
-
-    icalcluster_free(dset->cluster);
-    dset->cluster = icalfileset_produce_icalcluster(path);
-
-    return icalerrno;
-}
-
-static void icaldirset_add_uid(icalcomponent* comp)
-{
-    char uidstring[ICAL_PATH_MAX];
-    icalproperty *uid;
-#ifndef WIN32
-    struct utsname unamebuf;
-#endif
-
-    icalerror_check_arg_rv( (comp!=0), "comp");
-
-    uid = icalcomponent_get_first_property(comp,ICAL_UID_PROPERTY);
-    
-    if (uid == 0) {
-	
-#ifndef WIN32
-	uname(&unamebuf);
-	
-	snprintf(uidstring,sizeof(uidstring),"%d-%s",(int)getpid(),unamebuf.nodename);
-#else
-	snprintf(uidstring,sizeof(uidstring),"%d-%s",(int)getpid(),"WINDOWS");  /* FIX: There must be an easy get the system name */
-#endif
-	
-	uid = icalproperty_new_uid(uidstring);
-	icalcomponent_add_property(comp,uid);
-    } else {
-	strcpy(uidstring,icalproperty_get_uid(uid));
-    }
-}
-
-
-/**
-  This assumes that the top level component is a VCALENDAR, and there
-   is an inner component of type VEVENT, VTODO or VJOURNAL. The inner
-  component must have a DSTAMP property 
-*/
-
-icalerrorenum icaldirset_add_component(icalset* set, icalcomponent* comp)
-{
-    char clustername[ICAL_PATH_MAX];
-    icalproperty *dt = 0;
-    icalvalue *v;
-    struct icaltimetype tm;
-    icalerrorenum error = ICAL_NO_ERROR;
-    icalcomponent *inner;
-    icaldirset *dset = (icaldirset*) set;
-
-    icalerror_check_arg_rz( (dset!=0), "dset");
-    icalerror_check_arg_rz( (comp!=0), "comp");
-
-    icaldirset_add_uid(comp);
-
-    /* Determine which cluster this object belongs in. This is a HACK */
-
-    for(inner = icalcomponent_get_first_component(comp,ICAL_ANY_COMPONENT);
-	inner != 0;
-	inner = icalcomponent_get_next_component(comp,ICAL_ANY_COMPONENT)){
-  
-	dt = icalcomponent_get_first_property(inner,ICAL_DTSTAMP_PROPERTY);
- 	
-      if (dt != 0)
-	    break; 
-	}	
-
-    if (dt == 0) {
-	for(inner = icalcomponent_get_first_component(comp,ICAL_ANY_COMPONENT);
-	    inner != 0;
-	    inner = icalcomponent_get_next_component(comp,ICAL_ANY_COMPONENT)){
-	    
-	    dt = icalcomponent_get_first_property(inner,ICAL_DTSTART_PROPERTY);
-	    
-	  if (dt != 0)
-		break; 
-	    }	
-	}
-
-    if (dt == 0){
-	icalerror_warn("The component does not have a DTSTAMP or DTSTART property, so it cannot be added to the store");
-	icalerror_set_errno(ICAL_BADARG_ERROR);
-	return ICAL_BADARG_ERROR;
-    }
-
-    v = icalproperty_get_value(dt);
-    tm = icalvalue_get_datetime(v);
-
-    snprintf(clustername,ICAL_PATH_MAX,"%s/%04d%02d",dset->dir, tm.year, tm.month);
-
-    /* Load the cluster and insert the object */
-    if(dset->cluster != 0 && 
-       strcmp(clustername,icalcluster_key(dset->cluster)) != 0 ){
-      icalcluster_free(dset->cluster);
-      dset->cluster = 0;
-    }
-
-    if (dset->cluster == 0){
-      dset->cluster = icalfileset_produce_icalcluster(clustername);
-
-      if (dset->cluster == 0){
-	    error = icalerrno;
-	}
-    }
-    
-    if (error != ICAL_NO_ERROR){
-	icalerror_set_errno(error);
-	return error;
-    }
-
-    /* Add the component to the cluster */
-    icalcluster_add_component(dset->cluster,comp);
-    
-    /* icalcluster_mark(impl->cluster); */
-
-    return ICAL_NO_ERROR;    
-}
-
-/**
-   Remove a component in the current cluster. HACK. This routine is a
-   "friend" of icalfileset, and breaks its encapsulation. It was
-   either do it this way, or add several layers of interfaces that had
-   no other use.  
- */
-
-icalerrorenum icaldirset_remove_component(icalset* set, icalcomponent* comp)
-{
-    icaldirset *dset = (icaldirset*)set;
-    icalcomponent *filecomp = icalcluster_get_component(dset->cluster);
-
-    icalcompiter i;
-    int found = 0;
-
-    icalerror_check_arg_re((set!=0),"set",ICAL_BADARG_ERROR);
-    icalerror_check_arg_re((comp!=0),"comp",ICAL_BADARG_ERROR);
-    icalerror_check_arg_re((dset->cluster!=0),"Cluster pointer",ICAL_USAGE_ERROR);
-
-    for(i = icalcomponent_begin_component(filecomp,ICAL_ANY_COMPONENT);
-	icalcompiter_deref(&i)!= 0; icalcompiter_next(&i)){
-	
-	icalcomponent *this = icalcompiter_deref(&i);
-
-	if (this == comp){
-	    found = 1;
-	    break;
-	}
-    }
-
-    if (found != 1){
-	icalerror_warn("icaldirset_remove_component: component is not part of current cluster");
-	icalerror_set_errno(ICAL_USAGE_ERROR);
-	return ICAL_USAGE_ERROR;
-    }
-
-    icalcluster_remove_component(dset->cluster,comp);
-
-    /* icalcluster_mark(impl->cluster); */
-
-    /* If the removal emptied the fileset, get the next fileset */
-    if( icalcluster_count_components(dset->cluster,ICAL_ANY_COMPONENT)==0){
-      icalerrorenum error = icaldirset_next_cluster(dset);
-
-      if(dset->cluster != 0 && error == ICAL_NO_ERROR){
-	icalcluster_get_first_component(dset->cluster);
-	} else {
-	    /* HACK. Not strictly correct for impl->cluster==0 */
-	    return error;
-	}
-    } else {
-	/* Do nothing */
-    }
-
-    return ICAL_NO_ERROR;
-}
-
-
-
-int icaldirset_count_components(icalset* store,
-			       icalcomponent_kind kind)
-{
-    /* HACK, not implemented */
-    assert(0);
-
-    return 0;
-}
-
-
-icalcomponent* icaldirset_fetch_match(icalset* set, icalcomponent *c)
-{
-    fprintf(stderr," icaldirset_fetch_match is not implemented\n");
-    assert(0);
-    return 0;
-}
-
-
-icalcomponent* icaldirset_fetch(icalset* set, const char* uid)
-{
-    icaldirset *dset = (icaldirset*)set;
-    icalgauge *gauge;
-    icalgauge *old_gauge;
-    icalcomponent *c;
-    char sql[256];
-
-    icalerror_check_arg_rz( (set!=0), "set");
-    icalerror_check_arg_rz( (uid!=0), "uid");
-
-    snprintf(sql, 256, "SELECT * FROM VEVENT WHERE UID = \"%s\"", uid);
-    
-    gauge = icalgauge_new_from_sql(sql, 0);
-
-    old_gauge = dset->gauge;
-    dset->gauge = gauge;
-
-    c= icaldirset_get_first_component(set);
-
-    dset->gauge = old_gauge;
-
-    icalgauge_free(gauge);
-
-    return c;
-}
-
-
-int icaldirset_has_uid(icalset* set, const char* uid)
-{
-    icalcomponent *c;
-
-    icalerror_check_arg_rz( (set!=0), "set");
-    icalerror_check_arg_rz( (uid!=0), "uid");
-    
-    /* HACK. This is a temporary implementation. _has_uid should use a
-       database, and _fetch should use _has_uid, not the other way
-       around */
-    c = icaldirset_fetch(set,uid);
-
-    return c!=0;
-
-}
-
-
-icalerrorenum icaldirset_select(icalset* set, icalgauge* gauge)
-{
-  icaldirset *dset = (icaldirset*)set;
-
-  icalerror_check_arg_re( (set!=0), "set",ICAL_BADARG_ERROR);
-    icalerror_check_arg_re( (gauge!=0), "gauge",ICAL_BADARG_ERROR);
-
-  dset->gauge = gauge;
-
-    return ICAL_NO_ERROR;
-}
-
-
-icalerrorenum icaldirset_modify(icalset* set, 
-				icalcomponent *old,
-			       icalcomponent *new)
-{
-    assert(0);
-    return ICAL_NO_ERROR; /* HACK, not implemented */
-
-}
-
-
-void icaldirset_clear(icalset* set)
-{
-
-    assert(0);
-    return;
-    /* HACK, not implemented */
-}
-
-icalcomponent* icaldirset_get_current_component(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-
-  if (dset->cluster == 0){
-    icaldirset_get_first_component(set);
-    }
-  if(dset->cluster == 0){
-	return 0;
-    }
-
-  return icalcluster_get_current_component(dset->cluster);
-}
-
-
-icalcomponent* icaldirset_get_first_component(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-
-    icalerrorenum error;
-    char path[ICAL_PATH_MAX];
-
-  error = icaldirset_read_directory(dset);
-
-    if (error != ICAL_NO_ERROR){
-	icalerror_set_errno(error);
-	return 0;
-    }
-
-  dset->directory_iterator = pvl_head(dset->directory);
-    
-  if (dset->directory_iterator == 0){
-	icalerror_set_errno(error);
-	return 0;
-    }
-    
-  snprintf(path,ICAL_PATH_MAX,"%s/%s",
-	   dset->dir,
-	   (char*)pvl_data(dset->directory_iterator));
-
-    /* If the next cluster we need is different than the current cluster, 
-       delete the current one and get a new one */
-
-  if(dset->cluster != 0 && strcmp(path,icalcluster_key(dset->cluster)) != 0 ){
-    icalcluster_free(dset->cluster);
-    dset->cluster = 0;
-    }
-    
-  if (dset->cluster == 0){
-    dset->cluster = icalfileset_produce_icalcluster(path);
-
-    if (dset->cluster == 0){
-	    error = icalerrno;
-	}
-    } 
-
-    if (error != ICAL_NO_ERROR){
-	icalerror_set_errno(error);
-	return 0;
-    }
-
-  dset->first_component = 1;
-
-  return icaldirset_get_next_component(set);
-}
-
-
-icalcomponent* icaldirset_get_next_component(icalset* set)
-{
-  icaldirset *dset = (icaldirset*)set;
-    icalcomponent *c;
-    icalerrorenum error;
-
-  icalerror_check_arg_rz( (set!=0), "set");
-
-
-  if(dset->cluster == 0){
-	icalerror_warn("icaldirset_get_next_component called with a NULL cluster (Caller must call icaldirset_get_first_component first");
-	icalerror_set_errno(ICAL_USAGE_ERROR);
-	return 0;
-
-    }
-
-    /* Set the component iterator for the following for loop */
-  if (dset->first_component == 1){
-    icalcluster_get_first_component(dset->cluster);
-    dset->first_component = 0;
-    } else {
-    icalcluster_get_next_component(dset->cluster);
-    }
-
-    while(1){
-	/* Iterate through all of the objects in the cluster*/
-    for( c = icalcluster_get_current_component(dset->cluster);
-	     c != 0;
-	 c = icalcluster_get_next_component(dset->cluster)){
-	    
-	    /* If there is a gauge defined and the component does not
-	       pass the gauge, skip the rest of the loop */
-
-      if (dset->gauge != 0 && icalgauge_compare(dset->gauge,c) == 0){
-		continue;
-	    }
-
-	    /* Either there is no gauge, or the component passed the
-	       gauge, so return it*/
-
-	    return c;
-	}
-
-	/* Fell through the loop, so the component we want is not
-	   in this cluster. Load a new cluster and try again.*/
-
-    error = icaldirset_next_cluster(dset);
-
-    if(dset->cluster == 0 || error != ICAL_NO_ERROR){
-	    /* No more clusters */
-	    return 0;
-	} else {
-      c = icalcluster_get_first_component(dset->cluster);
-
-	    return c;
-	}
-	
-    }
-
-    return 0; /* Should never get here */
-}
-
-icalsetiter icaldirset_begin_component(icalset* set, icalcomponent_kind kind, icalgauge* gauge)
-{
-    icalsetiter itr = icalsetiter_null;
-    icaldirset *fset = (icaldirset*) set;
-
-    icalerror_check_arg_re((fset!=0), "set", icalsetiter_null);
-
-    itr.iter.kind = kind;
-    itr.gauge = gauge;
-
-    /* TO BE IMPLEMENTED */
-    return icalsetiter_null;
-}
-
-icalcomponent* icaldirsetiter_to_next(icalset* set, icalsetiter* i)
-{
-    /* TO BE IMPLEMENTED */
-    return NULL;
-}
-
-icalcomponent* icaldirsetiter_to_prior(icalset* set, icalsetiter* i)
-{
-    /* TO BE IMPLEMENTED */
-    return NULL;
-}
Index: libkcal/libical/src/libicalss/icalssyacc.h
===================================================================
--- libkcal/libical/src/libicalss/icalssyacc.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalssyacc.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,31 +0,0 @@
-#ifndef BISON_Y_TAB_H
-# define BISON_Y_TAB_H
-
-#ifndef YYSTYPE
-typedef union {
-	char* v_string;
-} yystype;
-# define YYSTYPE yystype
-#endif
-# define	STRING	257
-# define	SELECT	258
-# define	FROM	259
-# define	WHERE	260
-# define	COMMA	261
-# define	QUOTE	262
-# define	EQUALS	263
-# define	NOTEQUALS	264
-# define	LESS	265
-# define	GREATER	266
-# define	LESSEQUALS	267
-# define	GREATEREQUALS	268
-# define	AND	269
-# define	OR	270
-# define	EOL	271
-# define	END	272
-# define	IS	273
-# define	NOT	274
-# define	SQLNULL	275
-
-
-#endif /* not BISON_Y_TAB_H */
Index: libkcal/libical/src/libicalss/icalfileset.c
===================================================================
--- libkcal/libical/src/libicalss/icalfileset.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalfileset.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,960 +0,0 @@
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalfileset.c
-  CREATOR: eric 23 December 1999
-  
-  $Id$
-  $Locker$
-    
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
- ======================================================================*/
-
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "icalfileset.h"
-#include "icalgauge.h"
-#include <errno.h>
-#include <sys/stat.h> /* for stat */
-#ifndef WIN32
-#include <unistd.h> /* for stat, getpid */
-#else
-#include <io.h>
-#include <share.h>
-#endif
-#include <stdlib.h>
-#include <string.h>
-#include <fcntl.h> /* for fcntl */
-#include "icalfilesetimpl.h"
-#include "icalclusterimpl.h"
-
-#ifdef WIN32
-#define snprintf	_snprintf
-#define strcasecmp	stricmp
-
-#define _S_ISTYPE(mode, mask)  (((mode) & _S_IFMT) == (mask))
-
-#define S_ISDIR(mode)    _S_ISTYPE((mode), _S_IFDIR)
-#define S_ISREG(mode)    _S_ISTYPE((mode), _S_IFREG)
-#endif
-
-extern int errno;
-
-/** Default options used when NULL is passed to icalset_new() **/
-icalfileset_options icalfileset_options_default = {O_RDWR|O_CREAT, 0644, 0, 0};
-
-int icalfileset_lock(icalfileset *set);
-int icalfileset_unlock(icalfileset *set);
-icalerrorenum icalfileset_read_file(icalfileset* set, mode_t mode);
-int icalfileset_filesize(icalfileset* set);
-
-icalerrorenum icalfileset_create_cluster(const char *path);
-
-icalset* icalfileset_new(const char* path)
-{
-  return icalset_new(ICAL_FILE_SET, path, &icalfileset_options_default);
-}
-
-icalset* icalfileset_new_reader(const char* path)
-{
-  icalfileset_options reader_options = icalfileset_options_default;
-  reader_options.flags = O_RDONLY;
-
-  return icalset_new(ICAL_FILE_SET, path, &reader_options);
-}
-
-icalset* icalfileset_new_writer(const char* path)
-{
-  icalfileset_options writer_options = icalfileset_options_default;
-  writer_options.flags = O_RDONLY;
-
-  return icalset_new(ICAL_FILE_SET, path, &writer_options);
-}
-
-icalset* icalfileset_init(icalset *set, const char* path, void* options_in)
-{
-  icalfileset_options *options = (options_in) ? options_in : &icalfileset_options_default;
-  icalfileset *fset = (icalfileset*) set;
-  int flags;
-  mode_t mode;
-  off_t cluster_file_size;
-
-  icalerror_clear_errno();
-  icalerror_check_arg_rz( (path!=0), "path");
-  icalerror_check_arg_rz( (fset!=0), "fset");
-
-  fset->path = strdup(path);
-  fset->options = *options;
-
-  flags = options->flags;
-  mode  = options->mode;
-
-  cluster_file_size = icalfileset_filesize(fset);
-  
-  if(cluster_file_size < 0){
-    icalfileset_free(set);
-    return 0;
-  }
-
-#ifndef WIN32
-  fset->fd = open(fset->path, flags, mode);
-#else
-  fset->fd = open(fset->path, flags, mode);
-  /* fset->fd = sopen(fset->path,flags, _SH_DENYWR, _S_IREAD | _S_IWRITE); */
-#endif
-    
-  if (fset->fd < 0){
-    icalerror_set_errno(ICAL_FILE_ERROR);
-    icalfileset_free(set);
-    return 0;
-  }
-
-#ifndef WIN32
-    icalfileset_lock(fset);
-#endif
-    
-    if(cluster_file_size > 0 ){
-	icalerrorenum error;
-	if((error = icalfileset_read_file(fset,mode))!= ICAL_NO_ERROR){
-	  icalfileset_free(set);
-	  return 0;
-	}
-    }
- 
-    if (options->cluster) {
-	fset->cluster = icalcomponent_new_clone(icalcluster_get_component(options->cluster));
-	fset->changed = 1;
-    }
-
-    if (fset->cluster == 0) {
-      fset->cluster = icalcomponent_new(ICAL_XROOT_COMPONENT);
-    }
-
-    return set;
-}
-
-
-icalcluster* icalfileset_produce_icalcluster(const char *path) {
-  icalset *fileset;
-  icalcluster *ret;
-
-  int errstate = icalerror_errors_are_fatal;
-  icalerror_errors_are_fatal = 0;
-    
-  fileset = icalfileset_new_reader(path);
-  
-
-  if (fileset == 0 || icalerrno == ICAL_FILE_ERROR) {
-    /* file does not exist */
-    ret = icalcluster_new(path, NULL);
-  } else {
-    ret = icalcluster_new(path, ((icalfileset*)fileset)->cluster);
-    icalfileset_free(fileset);
-  }
-  
-  icalerror_errors_are_fatal = errstate;
-  icalerror_set_errno(ICAL_NO_ERROR);
-  return ret;
-}
-
-
-
-char* icalfileset_read_from_file(char *s, size_t size, void *d)
-{
-    char* p = s;
-    int fd = (int)d;
-
-    /* Simulate fgets -- read single characters and stop at '\n' */
-
-    for(p=s; p<s+size-1;p++){
-	
-	if(read(fd,p,1) != 1 || *p=='\n'){
-	    p++;
-	    break;
-	} 
-    }
-
-    *p = '\0';
-    
-    if(*s == 0){
-	return 0;
-    } else {
-	return s;
-    }
-
-}
-
-
-icalerrorenum icalfileset_read_file(icalfileset* set,mode_t mode)
-{
-    icalparser *parser;
-  
-    parser = icalparser_new();
-
-    icalparser_set_gen_data(parser,(void*)set->fd);
-    set->cluster = icalparser_parse(parser,icalfileset_read_from_file);
-    icalparser_free(parser);
-
-    if (set->cluster == 0 || icalerrno != ICAL_NO_ERROR){
-	icalerror_set_errno(ICAL_PARSE_ERROR);
-	/*return ICAL_PARSE_ERROR;*/
-    }
-  
-    if (icalcomponent_isa(set->cluster) != ICAL_XROOT_COMPONENT){
-	/* The parser got a single component, so it did not put it in
-	   an XROOT. */
-	icalcomponent *cl = set->cluster;
-	set->cluster = icalcomponent_new(ICAL_XROOT_COMPONENT);
-	icalcomponent_add_component(set->cluster,cl);
-    }
-
-    return ICAL_NO_ERROR;
-}
-
-int icalfileset_filesize(icalfileset* fset)
-{
-    int cluster_file_size;
-    struct stat sbuf;
-    
-    if (stat(fset->path,&sbuf) != 0){
-	
-	/* A file by the given name does not exist, or there was
-	   another error */
-	cluster_file_size = 0;
-	if (errno == ENOENT) {
-	    /* It was because the file does not exist */
-	    return 0;
-	} else {
-	    /* It was because of another error */
-	    icalerror_set_errno(ICAL_FILE_ERROR);
-	    return -1;
-	}
-    } else {
-	/* A file by the given name exists, but is it a regular file? */
-	
-	if (!S_ISREG(sbuf.st_mode)){ 
-	    /* Nope, not a regular file */
-	    icalerror_set_errno(ICAL_FILE_ERROR);
-	    return -1;
-	} else {
-	    /* Lets assume that it is a file of the right type */
-	    return sbuf.st_size;
-	}	
-    }
-
-    /*return -1; not reached*/
-}
-
-void icalfileset_free(icalset* set)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_rv((set!=0),"set");
-
-    if (fset->cluster != 0){
-	icalfileset_commit(set);
-	icalcomponent_free(fset->cluster);
-	fset->cluster=0;
-    }
-
-    if (fset->gauge != 0){
-	icalgauge_free(fset->gauge);
-	fset->gauge=0;
-    }
-
-    if(fset->fd > 0){
-	icalfileset_unlock(fset);
-	close(fset->fd);
-	fset->fd = -1;
-    }
-
-    if(fset->path != 0){
-	free(fset->path);
-	fset->path = 0;
-    }
-}
-
-const char* icalfileset_path(icalset* set) {
-    icalerror_check_arg_rz((set!=0),"set");
-
-    return ((icalfileset*)set)->path;
-}
-
-
-int icalfileset_lock(icalfileset *set)
-{
-#ifndef WIN32
-    struct flock lock;
-    int rtrn;
-
-    icalerror_check_arg_rz((set->fd>0),"set->fd");
-    errno = 0;
-    lock.l_type = F_WRLCK;     /* F_RDLCK, F_WRLCK, F_UNLCK */
-    lock.l_start = 0;  /* byte offset relative to l_whence */
-    lock.l_whence = SEEK_SET; /* SEEK_SET, SEEK_CUR, SEEK_END */
-    lock.l_len = 0;       /* #bytes (0 means to EOF) */
-
-    rtrn = fcntl(set->fd, F_SETLKW, &lock);
-
-    return rtrn;
-#else
-	return 0;
-#endif
-}
-
-int icalfileset_unlock(icalfileset *set)
-{
-#ifndef WIN32
-    struct flock lock;
-    icalerror_check_arg_rz((set->fd>0),"set->fd");
-
-    lock.l_type = F_WRLCK;     /* F_RDLCK, F_WRLCK, F_UNLCK */
-    lock.l_start = 0;  /* byte offset relative to l_whence */
-    lock.l_whence = SEEK_SET; /* SEEK_SET, SEEK_CUR, SEEK_END */
-    lock.l_len = 0;       /* #bytes (0 means to EOF) */
-
-    return (fcntl(set->fd, F_UNLCK, &lock)); 
-#else
-    return 0;
-#endif
-}
-
-static char * shell_quote(const char *s)
-{
-    char *result;
-    char *p;
-    p = result = malloc(strlen(s)*5+1);
-    while(*s)
-    {
-	if (*s == '\'')
-	{
-	    *p++ = '\'';
-	    *p++ = '"';
-	    *p++ = *s++;
-	    *p++ = '"';
-	    *p++ = '\'';
-	}
-	else
-	{
-	    *p++ = *s++;
-	}
-    }
-    *p = '\0';
-    return result;
-}
-
-icalerrorenum icalfileset_commit(icalset* set)
-{
-    char tmp[ICAL_PATH_MAX]; 
-    char *str;
-    icalcomponent *c;
-    off_t write_size=0;
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_re((fset!=0),"set",ICAL_BADARG_ERROR);  
-    
-    icalerror_check_arg_re((fset->fd>0),"set->fd is invalid",
-			   ICAL_INTERNAL_ERROR) ;
-
-    if (fset->changed == 0 ){
-	return ICAL_NO_ERROR;
-    }
-    
-    if (fset->options.safe_saves == 1) {
-#ifndef WIN32
-	char *quoted_file = shell_quote(fset->path);
-	snprintf(tmp,ICAL_PATH_MAX,"cp '%s' '%s.bak'",fset->path, fset->path);
-	free(quoted_file);
-#else
-	snprintf(tmp,ICAL_PATH_MAX,"copy %s %s.bak", fset->path, fset->path);
-#endif
-
-	if(system(tmp) < 0){
-	    icalerror_set_errno(ICAL_FILE_ERROR);
-	    return ICAL_FILE_ERROR;
-	}
-    }
-
-    if(lseek(fset->fd, 0, SEEK_SET) < 0){
-	icalerror_set_errno(ICAL_FILE_ERROR);
-	return ICAL_FILE_ERROR;
-    }
-    
-    for(c = icalcomponent_get_first_component(fset->cluster,ICAL_ANY_COMPONENT);
-	c != 0;
-	c = icalcomponent_get_next_component(fset->cluster,ICAL_ANY_COMPONENT)){
-	int sz;
-
-	str = icalcomponent_as_ical_string(c);
-    
-	sz=write(fset->fd,str,strlen(str));
-
-	if ( sz != strlen(str)){
-	    perror("write");
-	    icalerror_set_errno(ICAL_FILE_ERROR);
-	    return ICAL_FILE_ERROR;
-	}
-
-	write_size += sz;
-    }
-    
-    fset->changed = 0;    
-
-#ifndef WIN32
-    if(ftruncate(fset->fd,write_size) < 0){
-	return ICAL_FILE_ERROR;
-    }
-#else
-	chsize( fset->fd, tell( fset->fd ) );
-#endif
-    
-    return ICAL_NO_ERROR;
-} 
-
-void icalfileset_mark(icalset* set) {
-    icalerror_check_arg_rv((set!=0),"set");
-
-    ((icalfileset*)set)->changed = 1;
-}
-
-icalcomponent* icalfileset_get_component(icalset* set){
-    icalfileset *fset = (icalfileset*) set;
-    icalerror_check_arg_rz((set!=0),"set");
-
-    return fset->cluster;
-}
-
-
-/* manipulate the components in the set */
-
-icalerrorenum icalfileset_add_component(icalset *set,
-					icalcomponent* child)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_re((set!=0),"set", ICAL_BADARG_ERROR);
-    icalerror_check_arg_re((child!=0),"child",ICAL_BADARG_ERROR);
-
-    icalcomponent_add_component(fset->cluster,child);
-
-    icalfileset_mark(set);
-
-    return ICAL_NO_ERROR;
-}
-
-icalerrorenum icalfileset_remove_component(icalset *set,
-					   icalcomponent* child)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_re((set!=0),"set",ICAL_BADARG_ERROR);
-    icalerror_check_arg_re((child!=0),"child",ICAL_BADARG_ERROR);
-
-    icalcomponent_remove_component(fset->cluster,child);
-
-    icalfileset_mark(set);
-
-    return ICAL_NO_ERROR;
-}
-
-int icalfileset_count_components(icalset *set,
-				 icalcomponent_kind kind)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    if (set == 0){
-	icalerror_set_errno(ICAL_BADARG_ERROR);
-	return -1;
-    }
-
-    return icalcomponent_count_components(fset->cluster,kind);
-}
-
-icalerrorenum icalfileset_select(icalset* set, icalgauge* gauge)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_re(gauge!=0,"gauge",ICAL_BADARG_ERROR);
-
-    fset->gauge = gauge;
-
-    return ICAL_NO_ERROR;
-}
-
-void icalfileset_clear(icalset* set)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_rv(set!=0,"set");
-
-    fset->gauge = 0;
-}
-
-icalcomponent* icalfileset_fetch(icalset* set,const char* uid)
-{
-    icalfileset *fset = (icalfileset*) set;
-    icalcompiter i;    
-
-    icalerror_check_arg_rz(set!=0,"set");
-    
-    for(i = icalcomponent_begin_component(fset->cluster,ICAL_ANY_COMPONENT);
-	icalcompiter_deref(&i)!= 0; icalcompiter_next(&i)){
-	
-		icalcomponent *this = icalcompiter_deref(&i);
-		icalcomponent *inner;
-		icalproperty *p;
-		const char *this_uid;
-
-		for(inner = icalcomponent_get_first_component(this,ICAL_ANY_COMPONENT);
-			inner != 0;
-			inner = icalcomponent_get_next_component(this,ICAL_ANY_COMPONENT)){
-
-			p = icalcomponent_get_first_property(inner,ICAL_UID_PROPERTY);
-			if ( p )
-			{
-				this_uid = icalproperty_get_uid(p);
-
-				if(this_uid==0){
-				icalerror_warn("icalfileset_fetch found a component with no UID");
-				continue;
-				}
-
-				if (strcmp(uid,this_uid)==0){
-					return this;
-				}
-			}
-		}
-	}
-
-    return 0;
-}
-
-int icalfileset_has_uid(icalset* set,const char* uid)
-{
-    assert(0); /* HACK, not implemented */
-    return 0;
-}
-
-/******* support routines for icalfileset_fetch_match *********/
-
-struct icalfileset_id{
-    char* uid;
-    char* recurrence_id;
-    int sequence;
-};
-
-void icalfileset_id_free(struct icalfileset_id *id)
-{
-    if(id->recurrence_id != 0){
-	free(id->recurrence_id);
-    }
-
-    if(id->uid != 0){
-	free(id->uid);
-    }
-}
-
-
-struct icalfileset_id icalfileset_get_id(icalcomponent* comp)
-{
-    icalcomponent *inner;
-    struct icalfileset_id id;
-    icalproperty *p;
-
-    inner = icalcomponent_get_first_real_component(comp);
-    
-    p = icalcomponent_get_first_property(inner, ICAL_UID_PROPERTY);
-
-    assert(p!= 0);
-
-    id.uid = strdup(icalproperty_get_uid(p));
-
-    p = icalcomponent_get_first_property(inner, ICAL_SEQUENCE_PROPERTY);
-
-    if(p == 0) {
-	id.sequence = 0;
-    } else { 
-	id.sequence = icalproperty_get_sequence(p);
-    }
-
-    p = icalcomponent_get_first_property(inner, ICAL_RECURRENCEID_PROPERTY);
-
-    if (p == 0){
-	id.recurrence_id = 0;
-    } else {
-	icalvalue *v;
-	v = icalproperty_get_value(p);
-	id.recurrence_id = strdup(icalvalue_as_ical_string(v));
-
-	assert(id.recurrence_id != 0);
-    }
-
-    return id;
-}
-
-
-/* Find the component that is related to the given
-   component. Currently, it just matches based on UID and
-   RECURRENCE-ID */
-icalcomponent* icalfileset_fetch_match(icalset* set, icalcomponent *comp)
-{
-    icalfileset *fset = (icalfileset*) set;
-    icalcompiter i;    
-
-    struct icalfileset_id comp_id, match_id;
-    
-    comp_id = icalfileset_get_id(comp);
-
-    for(i = icalcomponent_begin_component(fset->cluster,ICAL_ANY_COMPONENT);
-	icalcompiter_deref(&i)!= 0; icalcompiter_next(&i)){
-	
-	icalcomponent *match = icalcompiter_deref(&i);
-
-	match_id = icalfileset_get_id(match);
-
-	if(strcmp(comp_id.uid, match_id.uid) == 0 &&
-	   ( comp_id.recurrence_id ==0 || 
-	     strcmp(comp_id.recurrence_id, match_id.recurrence_id) ==0 )){
-
-	    /* HACK. What to do with SEQUENCE? */
-
-	    icalfileset_id_free(&match_id);
-	    icalfileset_id_free(&comp_id);
-	    return match;
-	    
-	}
-	
-	icalfileset_id_free(&match_id);
-    }
-
-    icalfileset_id_free(&comp_id);
-    return 0;
-
-}
-
-
-icalerrorenum icalfileset_modify(icalset* set, icalcomponent *old,
-				 icalcomponent *new)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    assert(0); /* HACK, not implemented */
-    return ICAL_NO_ERROR;
-}
-
-
-/* Iterate through components */
-icalcomponent* icalfileset_get_current_component (icalset* set)
-{
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_rz((set!=0),"set");
-
-    return icalcomponent_get_current_component(fset->cluster);
-}
-
-
-icalcomponent* icalfileset_get_first_component(icalset* set)
-{
-    icalcomponent *c=0;
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_rz((set!=0),"set");
-
-    do {
-	if (c == 0){
-	    c = icalcomponent_get_first_component(fset->cluster,
-						  ICAL_ANY_COMPONENT);
-	} else {
-	    c = icalcomponent_get_next_component(fset->cluster,
-						 ICAL_ANY_COMPONENT);
-	}
-
-	if(c != 0 && (fset->gauge == 0 ||
-		      icalgauge_compare(fset->gauge, c) == 1)){
-	    return c;
-	}
-
-    } while(c != 0);
-
-
-    return 0;
-}
-
-icalcomponent* icalfileset_get_next_component(icalset* set)
-{
-    icalfileset *fset = (icalfileset*) set;
-    icalcomponent *c;
-
-    icalerror_check_arg_rz((set!=0),"set");
-    
-    do {
-	c = icalcomponent_get_next_component(fset->cluster,
-					     ICAL_ANY_COMPONENT);
-
-	if(c != 0 && (fset->gauge == 0 ||
-		      icalgauge_compare(fset->gauge,c) == 1)){
-	    return c;
-	}
-	
-    } while(c != 0);
-    
-    
-    return 0;
-}
-/*
-icalsetiter icalfileset_begin_component(icalset* set, icalcomponent_kind kind, icalgauge* gauge)
-{
-    icalsetiter itr = icalsetiter_null;
-    icalcomponent* comp = NULL;
-    icalcompiter citr;
-    icalfileset *fset = (icalfileset*) set;
-
-    icalerror_check_arg_re((set!=0), "set", icalsetiter_null);
-
-    itr.gauge = gauge;
-
-    citr = icalcomponent_begin_component(fset->cluster, kind);
-    comp = icalcompiter_deref(&citr);
-
-    while (comp != 0) {
-	comp = icalcompiter_deref(&citr);
-	if (gauge == 0 || icalgauge_compare(itr.gauge, comp) == 1) {
-	    itr.iter = citr;
-	    return itr;
-	}
-	comp =  icalcompiter_next(&citr);
-    }
-
-    return icalsetiter_null;
-}
-*/
-
-icalsetiter icalfileset_begin_component(icalset* set, icalcomponent_kind kind, icalgauge* gauge)
-{
-    icalsetiter itr = icalsetiter_null;
-    icalcomponent* comp = NULL;
-    icalcompiter citr;
-    icalfileset *fset = (icalfileset*) set;
-    struct icaltimetype start, next;
-    icalproperty *dtstart, *rrule, *prop, *due;
-    struct icalrecurrencetype recur;
-    int g = 0;
-
-    icalerror_check_arg_re((set!=0), "set", icalsetiter_null);
-
-    itr.gauge = gauge;
-
-    citr = icalcomponent_begin_component(fset->cluster, kind);
-    comp = icalcompiter_deref(&citr);
-
-    if (gauge == 0) {
-        itr.iter = citr;
-        return itr;
-    }
-
-    while (comp != 0) {
-
-        /* check if it is a recurring component and with guage expand, if so
-           we need to add recurrence-id property to the given component */
-        rrule = icalcomponent_get_first_property(comp, ICAL_RRULE_PROPERTY);
-        g = icalgauge_get_expand(gauge);
-
-        if (rrule != 0
-            && g == 1) {
-
-            recur = icalproperty_get_rrule(rrule);
-            if (icalcomponent_isa(comp) == ICAL_VEVENT_COMPONENT) {
-                dtstart = icalcomponent_get_first_property(comp, ICAL_DTSTART_PROPERTY);
-                if (dtstart)
-                    start = icalproperty_get_dtstart(dtstart);
-            } else if (icalcomponent_isa(comp) == ICAL_VTODO_COMPONENT) {
-                    due = icalcomponent_get_first_property(comp, ICAL_DUE_PROPERTY);
-                    if (due)
-                        start = icalproperty_get_due(due);
-            }
-
-            if (itr.last_component == NULL) {
-                itr.ritr = icalrecur_iterator_new(recur, start);
-                next = icalrecur_iterator_next(itr.ritr);
-                itr.last_component = comp;
-            }
-            else {
-                next = icalrecur_iterator_next(itr.ritr);
-                if (icaltime_is_null_time(next)){
-                    itr.last_component = NULL;
-                    icalrecur_iterator_free(itr.ritr);
-                    itr.ritr = NULL;
-                    return icalsetiter_null;
-                } else {
-                    itr.last_component = comp;
-                }
-            }
-
-            /* add recurrence-id to the component
-               if there is a recurrence-id already, remove it, then add the new one */
-            if (prop = icalcomponent_get_first_property(comp, ICAL_RECURRENCEID_PROPERTY))
-                icalcomponent_remove_property(comp, prop);
-            icalcomponent_add_property(comp, icalproperty_new_recurrenceid(next));
-
-        }
-
-        if (gauge == 0 || icalgauge_compare(itr.gauge, comp) == 1) {
-            /* matches and returns */
-            itr.iter = citr;
-            return itr;
-        }
-
-        /* if there is no previous component pending, then get the next component */
-        if (itr.last_component == NULL)
-            comp =  icalcompiter_next(&citr);
-    }
-
-    return icalsetiter_null;
-}
-icalcomponent* icalfileset_form_a_matched_recurrence_component(icalsetiter* itr)
-{
-    icalcomponent* comp = NULL;
-    struct icaltimetype start, next;
-    icalproperty *dtstart, *rrule, *prop, *due;
-    struct icalrecurrencetype recur;
-
-    comp = itr->last_component;
-
-    if (comp == NULL || itr->gauge == NULL) {
-        return NULL;
-    }
-
-    rrule = icalcomponent_get_first_property(comp, ICAL_RRULE_PROPERTY);
-
-    recur = icalproperty_get_rrule(rrule);
-
-    if (icalcomponent_isa(comp) == ICAL_VEVENT_COMPONENT) {
-        dtstart = icalcomponent_get_first_property(comp, ICAL_DTSTART_PROPERTY);
-        if (dtstart)
-            start = icalproperty_get_dtstart(dtstart);
-    } else if (icalcomponent_isa(comp) == ICAL_VTODO_COMPONENT) {
-        due = icalcomponent_get_first_property(comp, ICAL_DUE_PROPERTY);
-        if (due)
-            start = icalproperty_get_due(due);
-    }
-
-    if (itr->ritr == NULL) {
-        itr->ritr = icalrecur_iterator_new(recur, start);
-        next = icalrecur_iterator_next(itr->ritr);
-        itr->last_component = comp;
-    } else {
-        next = icalrecur_iterator_next(itr->ritr);
-        if (icaltime_is_null_time(next)){
-            /* no more recurrence, returns */
-            itr->last_component = NULL;
-            icalrecur_iterator_free(itr->ritr);
-            itr->ritr = NULL;
-            return NULL;
-        } else {
-            itr->last_component = comp;
-        }
-    }
-
-    /* add recurrence-id to the component
-     * if there is a recurrence-id already, remove it, then add the new one */
-    if (prop = icalcomponent_get_first_property(comp, ICAL_RECURRENCEID_PROPERTY))
-        icalcomponent_remove_property(comp, prop);
-        icalcomponent_add_property(comp, icalproperty_new_recurrenceid(next));
-
-     if (itr->gauge == 0 || icalgauge_compare(itr->gauge, comp) == 1) {
-         /* matches and returns */
-         return comp;
-     }
-     /* not matched */
-     return NULL;
-
-}
-icalcomponent* icalfilesetiter_to_next(icalset* set, icalsetiter* i)
-{
-
-    icalcomponent* c = NULL;
-    icalfileset *fset = (icalfileset*) set;
-    struct icaltimetype start, next;
-    icalproperty *dtstart, *rrule, *prop, *due;
-    struct icalrecurrencetype recur;
-    int g = 0;
-
-
-    do {
-        c = icalcompiter_next(&(i->iter));
-
-        if (c == 0) continue;
-        if (i->gauge == 0) return c;
-
-
-        rrule = icalcomponent_get_first_property(c, ICAL_RRULE_PROPERTY);
-        g = icalgauge_get_expand(i->gauge);
-
-        /* a recurring component with expand query */
-        if (rrule != 0
-            && g == 1) {
-
-            recur = icalproperty_get_rrule(rrule);
-
-            if (icalcomponent_isa(c) == ICAL_VEVENT_COMPONENT) {
-                dtstart = icalcomponent_get_first_property(c, ICAL_DTSTART_PROPERTY);
-                if (dtstart)
-                    start = icalproperty_get_dtstart(dtstart);
-            } else if (icalcomponent_isa(c) == ICAL_VTODO_COMPONENT) {
-                due = icalcomponent_get_first_property(c, ICAL_DUE_PROPERTY);
-                if (due)
-                    start = icalproperty_get_due(due);
-            }
-
-            if (i->ritr == NULL) {
-                i->ritr = icalrecur_iterator_new(recur, start);
-                next = icalrecur_iterator_next(i->ritr);
-                i->last_component = c;
-            } else {
-                next = icalrecur_iterator_next(i->ritr);
-                if (icaltime_is_null_time(next)) {
-                    /* no more recurrence, returns */
-                    i->last_component = NULL;
-                    icalrecur_iterator_free(i->ritr);
-                    i->ritr = NULL;
-                    return NULL;
-                } else {
-                    i->last_component = c;
-                }
-            }
-        }
-
-        /* add recurrence-id to the component
-         * if there is a recurrence-id already, remove it, then add the new one */
-        if (prop = icalcomponent_get_first_property(c, ICAL_RECURRENCEID_PROPERTY))
-            icalcomponent_remove_property(c, prop);
-        icalcomponent_add_property(c, icalproperty_new_recurrenceid(next));
-
-        if(c != 0 && (i->gauge == 0 ||
-                        icalgauge_compare(i->gauge, c) == 1)){
-            return c;
-        }
-    } while (c != 0);
-
-    return 0;
-
-}
Index: libkcal/libical/src/libicalss/icalset.c
===================================================================
--- libkcal/libical/src/libicalss/icalset.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalset.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,493 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalset.c
- CREATOR: eric 17 Jul 2000
-
-
- Icalset is the "base class" for representations of a collection of
- iCal components. Derived classes (actually delegates) include:
- 
-    icalfileset   Store components in a single file
-    icaldirset    Store components in multiple files in a directory
-    icalheapset   Store components on the heap
-    icalmysqlset  Store components in a mysql database. 
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#include "ical.h"
-#include "icalset.h"
-#include "icalfileset.h"
-#include "icalfilesetimpl.h"
-#include "icaldirset.h"
-#include "icaldirsetimpl.h"
-#include <stdlib.h>
-#include <string.h>
-#include <errno.h>
-
-#ifdef WITH_BDB4
-#include "icalbdbset.h"
-#include "icalbdbsetimpl.h"
-#endif
-
-/* #define _DLOPEN_TEST */
-#ifdef _DLOPEN_TEST
-#include <sys/types.h>
-#include <dlfcn.h>
-#include <dirent.h>
-#endif
-
-static icalset icalset_dirset_init = {
-    ICAL_DIR_SET,
-    sizeof(icaldirset),
-    NULL,
-    icaldirset_init,
-    icaldirset_free,
-    icaldirset_path,
-    icaldirset_mark,
-    icaldirset_commit,
-    icaldirset_add_component,
-    icaldirset_remove_component,
-    icaldirset_count_components,
-    icaldirset_select,
-    icaldirset_clear,
-    icaldirset_fetch,
-    icaldirset_fetch_match,
-    icaldirset_has_uid,
-    icaldirset_modify,
-    icaldirset_get_current_component,
-    icaldirset_get_first_component,
-    icaldirset_get_next_component,
-    icaldirset_begin_component,
-    icaldirsetiter_to_next,
-    icaldirsetiter_to_prior
-};
-
-
-static icalset icalset_fileset_init = {
-    ICAL_FILE_SET,
-    sizeof(icalfileset),
-    NULL,
-    icalfileset_init,
-    icalfileset_free,
-    icalfileset_path,
-    icalfileset_mark,
-    icalfileset_commit,
-    icalfileset_add_component,
-    icalfileset_remove_component,
-    icalfileset_count_components,
-    icalfileset_select,
-    icalfileset_clear,
-    icalfileset_fetch,
-    icalfileset_fetch_match,
-    icalfileset_has_uid,
-    icalfileset_modify,
-    icalfileset_get_current_component,
-    icalfileset_get_first_component,
-    icalfileset_get_next_component,
-    icalfileset_begin_component,
-    icalfilesetiter_to_next,
-    NULL
-};
-
-#ifdef WITH_BDB4
-static icalset icalset_bdbset_init = {
-    ICAL_BDB_SET,
-    sizeof(icalbdbset),
-    NULL,
-    icalbdbset_init,
-    icalbdbset_free,
-    icalbdbset_path,
-    icalbdbset_mark,
-    icalbdbset_commit,
-    icalbdbset_add_component,
-    icalbdbset_remove_component,
-    icalbdbset_count_components,
-    icalbdbset_select,
-    icalbdbset_clear,
-    icalbdbset_fetch,
-    icalbdbset_fetch_match,
-    icalbdbset_has_uid,
-    icalbdbset_modify,
-    icalbdbset_get_current_component,
-    icalbdbset_get_first_component,
-    icalbdbset_get_next_component,
-    icalbdbset_begin_component,
-    icalbdbsetiter_to_next,
-    NULL 
-};
-#endif
-
-#ifdef _DLOPEN_TEST
-static int	icalset_init_done = 0;
-static pvl_list icalset_kinds = 0;
-
-typedef icalset *(*fptr)(void);
-
-/**
- * Try to load the file and register any icalset found within.
- */
-static int load(const char *file) {
-
-        void           *modh;
-        fptr            inith;
-	icalset	       *icalset_init_ptr;
-
-        if ((modh = dlopen(file, RTLD_NOW)) == 0) {
-                perror("dlopen");
-                return 0;
-        }
-
-        if ((inith = (fptr)dlsym(modh, "InitModule")) == 0) {
-                perror("dlsym");
-                return 0;
-        }
-
-        while ((icalset_init_ptr = ((inith)())) != 0) {
-		pvl_push(icalset_kinds, &icalset_init_ptr);
-        }
-
-        return 1;
-}
-
-/**
- * Look in the given directory for files called mod_*.o and try to
- * load them.
- */
-int icalset_loaddir(const char *path) {
-        DIR             *d;
-        struct dirent   *dp;
-        char            buf[PATH_MAX],
-                       *bufptr;
-        int             tot = 0;
-
-        strcpy(buf, path);
-        bufptr = buf + strlen(buf);
-
-        if (*(bufptr-1) != '/')
-                *bufptr++ = '/';
-
-        if ((d = opendir(path)) == 0) {
-                perror("opendir");
-                return 0;
-        }
-
-        while ((dp = readdir(d)) != 0) {
-                if (strncmp(dp->d_name, "mod_", 4)) continue;
-
-                strcpy(bufptr, dp->d_name);
-
-                load(buf);
-                tot++;
-        }
-        (void)closedir(d);
-
-        return 1;
-}
-
-int icalset_register_class(icalset *set);
-
-static void icalset_init(void) {
-    assert(icalset_kinds == 0);
-    icalset_kinds = pvl_newlist();
-
-    pvl_push(icalset_kinds, &icalset_fileset_init);
-    pvl_push(icalset_kinds, &icalset_dirset_init);
-#ifdef WITH_BDB4
-    pvl_push(icalset_kinds, &icalset_bdb4set_init);
-#endif
-
-#ifdef EXT_PATH
-    icalset_loaddir(EXT_PATH);
-#endif
-
-    icalset_init_done++;
-}
-
-int icalset_register_class(icalset *set) {
-
-    if (!icalset_init_done)
-	icalset_init();
-
-    pvl_push(icalset_kinds, set);
-    return 1;
-}
-
-#endif
-
-icalset* icalset_new(icalset_kind kind, const char* dsn, void* options) {
-  icalset *data = NULL;
-  icalset *ret = NULL;
-
-#ifdef _DLOPEN_TEST
-    pvl_elem	e;
-    icalset    *impl;
-
-    if (!icalset_init_done)
-	icalset_init();
-
-    for(e = pvl_head(icalset_kinds); e!=0; e = pvl_next(e)) {
-	impl = (icalset*)pvl_data(e);
-	if (impl->kind == kind)
-	    break;
-    }
-    if (e == 0) {
-	icalerror_set_errno(ICAL_UNIMPLEMENTED_ERROR);
-	return(NULL);
-    }
-
-    data = (icalset*)malloc(impl->size);
-    if (data == 0) {
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	errno = ENOMEM;
-	return 0;
-    }
-
-    /* The first member of the derived class must be an icalset. */
-    memset(data,0,impl->size);
-    /* *data = *impl; */
-    memcpy(data, impl, sizeof(icalset));
-
-    data->dsn     = strdup(dsn);
-#else
-  switch(kind) {
-  case ICAL_FILE_SET:
-    data = (icalset*) malloc(sizeof(icalfileset));
-    if (data == 0) {
-      	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	errno = ENOMEM;
-	return 0;
-    }
-    memset(data,0,sizeof(icalfileset));
-    *data = icalset_fileset_init;
-    break;
-  case ICAL_DIR_SET:
-    data = (icalset*) malloc(sizeof(icaldirset));
-    if (data == 0) {
-      	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	errno = ENOMEM;
-	return 0;
-    }
-    memset(data,0,sizeof(icaldirset));
-    *data = icalset_dirset_init;
-    break;
-#ifdef WITH_BDB4
-  case ICAL_BDB_SET:
-    data = (icalset*) malloc(sizeof(icalbdbset));
-    if (data == 0) {
-      	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	errno = ENOMEM;
-	return 0;
-    }
-    memset(data,0,sizeof(icalbdbset));
-    *data = icalset_bdbset_init;
-    break;
-#endif
-    
-  default:
-    icalerror_set_errno(ICAL_UNIMPLEMENTED_ERROR);
-    /** unimplemented **/
-    return(NULL);
-  }
-
-  if ( data == 0) {
-    icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-    return 0;
-  }
-  data->kind    = kind;
-  data->dsn     = strdup(dsn);
-#endif
-
-  /** call the implementation specific initializer **/
-  if ((ret = data->init(data, dsn, options)) == NULL)
-    icalset_free(data);
-
-  return ret;
-}
-
-icalset* icalset_new_file(const char* path)
-{
-  return icalset_new(ICAL_FILE_SET, path, NULL);
-}
-
-icalset* icalset_new_file_writer(const char* path)
-{
-  return icalfileset_new_writer(path);
-}
-
-icalset* icalset_new_file_reader(const char* path)
-{
-  return icalfileset_new_reader(path);
-}
-
-
-icalset* icalset_new_dir(const char* path)
-{
-  return icalset_new(ICAL_DIR_SET, path, NULL);
-}
-
-icalset* icalset_new_dir_writer(const char* path)
-{
-  return icaldirset_new_writer(path);
-}
-
-icalset* icalset_new_dir_reader(const char* path)
-{
-  return icaldirset_new_reader(path);
-}
-
-
-
-/* Functions for built-in methods */
-
-/**
- *  free memory associated with this icalset
- *  automatically calls the implementation specific free routine
- */
-
-void icalset_free(icalset* set)
-{
-  if (set->free)
-    set->free(set);
-
-  if (set->dsn)
-    free(set->dsn);
-
-  free(set);
-}
-
-
-const char* icalset_path(icalset* set) {
-    return set->path(set);
-}
-
-void icalset_mark(icalset* set) {
-    set->mark(set);
-}
-
-icalerrorenum icalset_commit(icalset* set) {
-    return set->commit(set);
-}
-
-icalerrorenum icalset_add_component(icalset* set, icalcomponent* comp) {
-    return set->add_component(set,comp);
-}
-
-icalerrorenum icalset_remove_component(icalset* set, icalcomponent* comp) {
-    return set->remove_component(set,comp);
-}
-
-int icalset_count_components(icalset* set,icalcomponent_kind kind) {
-    return set->count_components(set,kind);
-}
-
-icalerrorenum icalset_select(icalset* set, icalgauge* gauge) {
-    return set->select(set, gauge);
-}
-
-void icalset_clear(icalset* set) {
-    set->clear(set);
-}
-
-icalcomponent* icalset_fetch(icalset* set, const char* uid) {
-    return set->fetch(set, uid);
-}
-
-icalcomponent* icalset_fetch_match(icalset* set, icalcomponent *comp) {
-    return set->fetch_match(set, comp);
-}
-
-int icalset_has_uid(icalset* set, const char* uid) {
-    return set->has_uid(set, uid);
-}
-
-icalerrorenum icalset_modify(icalset* set, icalcomponent *old,
-			       icalcomponent *new) {
-    return set->modify(set, old, new);
-}
-
-icalcomponent* icalset_get_current_component(icalset* set) {
-    return set->get_current_component(set);
-}
-
-icalcomponent* icalset_get_first_component(icalset* set) {
-    return set->get_first_component(set);
-}
-
-icalcomponent* icalset_get_next_component(icalset* set) {
-    return set->get_next_component(set);
-}
-
-icalsetiter icalsetiter_null = {{ICAL_NO_COMPONENT, 0}, 0};
-
-icalsetiter icalset_begin_component(icalset* set,
-                                 icalcomponent_kind kind, icalgauge* gauge) {
-    return set->icalset_begin_component(set, kind, gauge);
-}
-
-icalcomponent* icalsetiter_next(icalsetiter* itr) {
-
-    icalcomponent* c = 0;
-    icalerror_check_arg_rz( (itr != NULL), "i");
-
-    do  {
-	c = icalcompiter_next(&(itr->iter));
-	if(c != 0 && (itr->gauge == 0 ||
-			icalgauge_compare(itr->gauge, c) == 1)){
-	    return c;
-	}
-    } while (c != 0);
-
-    return 0;
-}
-
-icalcomponent* icalsetiter_prior(icalsetiter* i) {
-
-    icalcomponent* c = 0;
-    icalerror_check_arg_rz( (i != NULL), "i" );
-
-    do  {
-	c = icalcompiter_prior(&(i->iter));
-	if(c != 0 && (i->gauge == 0 ||
-			icalgauge_compare(i->gauge, c) == 1)){
-	    return c;
-	}
-    } while (c != 0);
-
-    return 0;
-}
-
-icalcomponent* icalsetiter_deref(icalsetiter* i) {
-    icalerror_check_arg_rz( (i != NULL), "i" );
-    return (icalcompiter_deref(&(i->iter)));
-}
-
-/* for subclasses that use multiple clusters that require specialized cluster traversal */
-icalcomponent* icalsetiter_to_next(icalset* set, icalsetiter* i)
-{
-    return set->icalsetiter_to_next(set, i);
-}
-
-icalcomponent* icalsetiter_to_prior(icalset* set, icalsetiter* i)
-{
-    return set->icalsetiter_to_prior(set, i);
-}
Index: libkcal/libical/src/libicalss/icalgauge.h
===================================================================
--- libkcal/libical/src/libicalss/icalgauge.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalgauge.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,61 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalgauge.h
- CREATOR: eric 23 December 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALGAUGE_H
-#define ICALGAUGE_H
-
-/** @file icalgauge.h
- *  @brief Routines implementing a filter for ical components
- */
-
-typedef struct icalgauge_impl icalgauge;
-
-icalgauge* icalgauge_new_from_sql(char* sql, int expand);
-
-int icalgauge_get_expand(icalgauge* gauge);
-
-void icalgauge_free(icalgauge* gauge);
-
-char* icalgauge_as_sql(icalcomponent* gauge);
-
-void icalgauge_dump(icalgauge* gauge);
-
-
-/** @brief Return true if comp matches the gauge.
- *
- * The component must be in
- * cannonical form -- a VCALENDAR with one VEVENT, VTODO or VJOURNAL
- * sub component 
- */
-int icalgauge_compare(icalgauge* g, icalcomponent* comp);
-
-/** Clone the component, but only return the properties 
- *  specified in the gauge */
-icalcomponent* icalgauge_new_clone(icalgauge* g, icalcomponent* comp);
-
-#endif /* ICALGAUGE_H*/
Index: libkcal/libical/src/libicalss/icalspanlist.c
===================================================================
--- libkcal/libical/src/libicalss/icalspanlist.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalspanlist.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,567 +0,0 @@
-/* -*- Mode: C -*-
-    ======================================================================
-    FILE: icalspanlist.c
-    CREATOR: ebusboom 23 aug 2000
-  
-    $Id$
-    $Locker$
-    
-    (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-    
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of either: 
-    
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-    
-    Or:
-    
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-
-    ======================================================================*/
-
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "ical.h"
-#include "icalspanlist.h"
-
-#include <stdlib.h> /* for free and malloc */
-#include <string.h>
-
-struct icalspanlist_impl {
-  pvl_list spans;		/**< list of icaltime_span data **/
-  struct icaltimetype start;    /**< start time of span **/
-  struct icaltimetype end;	/**< end time of span **/
-};
-
-/** @brief Internal comparison function for two spans
- *
- *  @param  a   a spanlist.
- *  @param  b   another spanlist.
- *
- *  @return     -1, 0, 1 depending on the comparison of the start times.
- *
- * Used to insert spans into the tree in sorted order.
- */
-
-static int compare_span(void* a, void* b)
-{
-    struct icaltime_span *span_a = (struct icaltime_span *)a ;
-    struct icaltime_span *span_b = (struct icaltime_span *)b ;
-    
-    if(span_a->start == span_b->start){
-	return 0;
-    } else if(span_a->start < span_b->start){
-	return -1;
-    }  else { /*if(span_a->start > span->b.start)*/
-	return 1;
-    }
-}
-
-
-/** @brief callback function for collecting spanlists of a
- *         series of events.
- *
- *  @param   comp  A valid icalcomponent.
- *  @param   span  The span to insert into data.
- *  @param   data  The actual spanlist to insert into
- *
- *  This callback is used by icalcomponent_foreach_recurrence()
- *  to build up a spanlist.
- */
-
-static void icalspanlist_new_callback(icalcomponent *comp,
-					    struct icaltime_span *span,
-					    void *data)
-{
-  icaltime_span *s;
-  icalspanlist *sl = (icalspanlist*) data;
-
-  if (span->is_busy == 0)
-    return;
-
-  if ((s=(icaltime_span *) malloc(sizeof(icaltime_span))) == 0) {
-    icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-    return;
-  }
-
-  /** copy span data into allocated memory.. **/
-  *s = *span;
-  pvl_insert_ordered(sl->spans, compare_span, (void*)s);
-}
-					    
-
-
-/** @brief Make a free list from a set of VEVENT components.
- *
- *  @param set    A valid icalset containing VEVENTS
- *  @param start  The free list starts at this date/time
- *  @param end    The free list ends at this date/time
- *
- *  @return        A spanlist corresponding to the VEVENTS
- *
- * Given a set of components,  a start time and an end time
- * return a spanlist that contains the free/busy times.
- */
-
-icalspanlist* icalspanlist_new(icalset *set, 
-			       struct icaltimetype start,
-			       struct icaltimetype end)
-{
-    struct icaltime_span range;
-    pvl_elem itr;
-    icalcomponent *c,*inner;
-    icalcomponent_kind kind, inner_kind;
-    icalspanlist *sl; 
-    struct icaltime_span *freetime;
-
-    if ( ( sl = (struct icalspanlist_impl*)
-	   malloc(sizeof(struct icalspanlist_impl))) == 0) {
-	icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	return 0;
-    }
-
-    sl->spans =  pvl_newlist();
-    sl->start =  start;
-    sl->end   =  end;
-
-    range.start = icaltime_as_timet(start);
-    range.end = icaltime_as_timet(end);
-
-    /* Get a list of spans of busy time from the events in the set
-       and order the spans based on the start time */
-
-   for(c = icalset_get_first_component(set);
-	c != 0;
-	c = icalset_get_next_component(set)){
-
-       kind  = icalcomponent_isa(c);
-       inner = icalcomponent_get_inner(c);
-
-       if(!inner){
-	   continue;
-       }
-
-       inner_kind = icalcomponent_isa(inner);
-
-       if( kind != ICAL_VEVENT_COMPONENT &&
-	   inner_kind != ICAL_VEVENT_COMPONENT){
-	   continue;
-       }
-       
-       icalerror_clear_errno();
-       
-       icalcomponent_foreach_recurrence(c, start, end, 
-					icalspanlist_new_callback, 
-					(void*)sl);
-       
-   }
-    
-    /* Now Fill in the free time spans. loop through the spans. if the
-       start of the range is not within the span, create a free entry
-       that runs from the start of the range to the start of the
-       span. */
-
-     for( itr = pvl_head(sl->spans);
-	 itr != 0;
-	 itr = pvl_next(itr))
-    {
-	struct icaltime_span *s = (struct icaltime_span*)pvl_data(itr);
-
-	if ((freetime=(struct icaltime_span *)
-	     malloc(sizeof(struct icaltime_span))) == 0){
-	    icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-	    return 0;
-	    }
-
-	if(range.start < s->start){
-	    freetime->start = range.start; 
-	    freetime->end = s->start;
-	    
-	    freetime->is_busy = 0;
-
-
-	    pvl_insert_ordered(sl->spans,compare_span,(void*)freetime);
-	} else {
-	    free(freetime);
-	}
-	
-	range.start = s->end;
-    }
-     
-     /* If the end of the range is null, then assume that everything
-        after the last item in the calendar is open and add a span
-        that indicates this */
-
-     if( icaltime_is_null_time(end)){
-	 struct icaltime_span* last_span;
-
-	 last_span = (struct icaltime_span*)pvl_data(pvl_tail(sl->spans));
-
-	 if (last_span != 0){
-
-	     if ((freetime=(struct icaltime_span *)
-		  malloc(sizeof(struct icaltime_span))) == 0){
-		 icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-		 return 0;
-	     }	
-	
-	     freetime->is_busy = 0;
-	     freetime->start = last_span->end;
-	     freetime->end = freetime->start;
-	     pvl_insert_ordered(sl->spans,compare_span,(void*)freetime);
-	 }
-     }
-
-
-     return sl;
-}
-
-/** @brief Destructor.
- *  @param s A valid icalspanlist
- *
- *  Free memory associated with the spanlist
- */
-
-void icalspanlist_free(icalspanlist* s)
-{
-    struct icaltime_span *span;
-
-    if (s == NULL)
-      return;
-
-    while( (span=pvl_pop(s->spans)) != 0){
-	free(span);
-    }
-    
-    pvl_free(s->spans);
-    
-    s->spans = 0;
-
-    free(s);
-}
-
-
-/** @brief (Debug) print out spanlist to stdout.
- *  @param sl A valid icalspanlist.
- */
-
-void icalspanlist_dump(icalspanlist* sl){
-     int i = 0;
-     pvl_elem itr;
-
-     for( itr = pvl_head(sl->spans);
-	 itr != 0;
-	 itr = pvl_next(itr))
-    {
-	struct icaltime_span *s = (struct icaltime_span*)pvl_data(itr);
-	
-	printf("#%02d %d start: %s",++i,s->is_busy,ctime(&s->start));
-	printf("      end  : %s",ctime(&s->end));
-
-    }
-}
-
-icalcomponent* icalspanlist_make_free_list(icalspanlist* sl);
-icalcomponent* icalspanlist_make_busy_list(icalspanlist* sl);
-
-
-/** @brief Find next free time span in a spanlist.
- *
- *  @param  sl     The spanlist to search.
- *  @param  t      The time to start looking.
- *
- *  Given a spanlist and a time, find the next period of time
- *  that is free
- */
-
-struct icalperiodtype icalspanlist_next_free_time(icalspanlist* sl,
-						struct icaltimetype t)
-{
-     pvl_elem itr;
-     struct icalperiodtype period;
-     struct icaltime_span *s;
-
-     time_t rangett= icaltime_as_timet(t);
-
-     period.start = icaltime_null_time();
-     period.end = icaltime_null_time();
-
-     itr = pvl_head(sl->spans);
-     s = (struct icaltime_span *)pvl_data(itr);
-
-     if (s == 0){
-	 /* No elements in span */
-	 return period;
-     }
-
-     /* Is the reference time before the first span? If so, assume
-        that the reference time is free */
-     if(rangett <s->start ){
-	 /* End of period is start of first span if span is busy, end
-            of the span if it is free */
-	 period.start =  t;
-
-	 if (s->is_busy == 1){
-	     period.end =  icaltime_from_timet(s->start,0);
-	 } else {
-	     period.end =  icaltime_from_timet(s->end,0);
-	 }
-
-	 return period;
-     }
-
-     /* Otherwise, find the first free span that contains the
-        reference time. */
-     for( itr = pvl_head(sl->spans);
-	 itr != 0;
-	 itr = pvl_next(itr))
-    {
-	s = (struct icaltime_span *)pvl_data(itr);
-
-	if(s->is_busy == 0 && s->start >= rangett && 
-	    ( rangett < s->end || s->end == s->start)){
-
-	    if (rangett < s->start){
-		period.start = icaltime_from_timet(s->start,0);
-	    } else {
-		period.start = icaltime_from_timet(rangett,0);
-	    }
-	    
-	    period.end = icaltime_from_timet(s->end,0);
-
-	    return period;
-	}
-			
-    }
-
-     period.start = icaltime_null_time();
-     period.end = icaltime_null_time();
-
-     return period;
-}
-
-struct icalperiodtype icalspanlist_next_busy_time(icalspanlist* sl,
-						struct icaltimetype t);
-
-
-/** @brief Returns an hour-by-hour array of free/busy times over a
- *         given period.
- *
- *  @param sl        A valid icalspanlist
- *  @param delta_t   The time slice to divide by, in seconds.  Default 3600.
- *  
- *  @return A pointer to an array of integers containing the number of
- *       busy events in each delta_t time period.  The final entry 
- *       contains the value -1.
- *
- *  This calculation is somewhat tricky.  This is due to the fact that
- *  the time range contains the start time, but does not contain the
- *  end time.  To perform a proper calculation we subtract one second
- *  off the end times to get a true containing time.
- * 
- *  Also note that if you supplying a spanlist that does not start or
- *  end on a time boundary divisible by delta_t you may get results
- *  that are not quite what you expect.
- */
-
-int* icalspanlist_as_freebusy_matrix(icalspanlist* sl, int delta_t) {
-  pvl_elem itr;
-  int spanduration_secs;
-  int *matrix;
-  int matrix_slots;
-  time_t sl_start, sl_end;
-
-  icalerror_check_arg_rz( (sl!=0), "spanlist");
-
-  if (!delta_t)
-    delta_t = 3600;
-
-  /** calculate the start and end time as time_t **/
-  sl_start = icaltime_as_timet_with_zone(sl->start, icaltimezone_get_utc_timezone());
-  sl_end   = icaltime_as_timet_with_zone(sl->end, icaltimezone_get_utc_timezone());
-
-
-  /** insure that the time period falls on a time boundary divisable
-      by delta_t */
-
-  sl_start /= delta_t;
-  sl_start *= delta_t;
-
-  sl_end /= delta_t;
-  sl_end *= delta_t;
-
-
-  /** find the duration of this spanlist **/
-  spanduration_secs = sl_end - sl_start;
-
-
-  /** malloc our matrix, add one extra slot for a final -1 **/
-  matrix_slots = spanduration_secs/delta_t + 1;
-
-  matrix = (int*) malloc(sizeof(int) * matrix_slots);
-  if (matrix == NULL) {
-    icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-    return NULL;
-  }
-  memset(matrix, 0, sizeof(int) * matrix_slots);
-  matrix[matrix_slots-1] = -1;
-
-  /* loop through each span and mark the slots in the array */
-
-  for( itr = pvl_head(sl->spans);  itr != 0;  itr = pvl_next(itr)) {
-    struct icaltime_span *s = (struct icaltime_span*)pvl_data(itr);
-    
-    if (s->is_busy == 1) {
-      int offset_start = s->start/delta_t - sl_start/delta_t;
-      int offset_end   = (s->end - 1) /delta_t  - sl_start/delta_t + 1;
-      int i;
-      
-      if (offset_end >= matrix_slots)
-	offset_end = matrix_slots - 1;
-
-      i = offset_start;
-      for (i=offset_start; i < offset_end; i++) {
-	matrix[i]++;
-      }
-    }
-  }
-  return matrix;
-}
-    
-
-/** @brief Return a VFREEBUSY component for the corresponding spanlist
- *
- *   @param sl         A valid icalspanlist, from icalspanlist_new()
- *   @param organizer  The organizer specified as MAILTO:user@domain
- *   @param attendee   The attendee specified as MAILTO:user@domain
- *
- *   @return            A valid icalcomponent or NULL.
- *
- * This function returns a VFREEBUSY component for the given spanlist.
- * The start time is mapped to DTSTART, the end time to DTEND.
- * Each busy span is represented as a separate FREEBUSY entry.
- * An attendee parameter is required, and organizer parameter is
- * optional.
- */
-
-icalcomponent *icalspanlist_as_vfreebusy(icalspanlist* sl,
-					 const char* organizer,
-					 const char* attendee) {
-  icalcomponent *comp;
-  icalproperty *p;
-  struct icaltimetype atime = icaltime_from_timet( time(0),0);
-  pvl_elem itr;
-  icaltimezone *utc_zone;
-  icalparameter *param;
-
-  if (!attendee) {
-    icalerror_set_errno(ICAL_USAGE_ERROR);
-    return 0;
-  }
-
-  utc_zone = icaltimezone_get_utc_timezone ();
-
-  comp = icalcomponent_new_vfreebusy();
-  
-  icalcomponent_add_property(comp, icalproperty_new_dtstart(sl->start));
-  icalcomponent_add_property(comp, icalproperty_new_dtend(sl->end));
-  icalcomponent_add_property(comp, icalproperty_new_dtstamp(atime));
-
-  if (organizer) {
-    icalcomponent_add_property(comp, icalproperty_new_organizer(organizer));
-  }
-  icalcomponent_add_property(comp, icalproperty_new_attendee(attendee));
-
-  /* now add the freebusy sections.. */
-
-  for( itr = pvl_head(sl->spans);  itr != 0;  itr = pvl_next(itr)) {
-    struct icalperiodtype period;
-    struct icaltime_span *s = (struct icaltime_span*)pvl_data(itr);
-
-    if (s->is_busy == 1) {
-
-      period.start = icaltime_from_timet_with_zone (s->start, 0, utc_zone);
-      period.end   = icaltime_from_timet_with_zone (s->end, 0, utc_zone);
-      period.duration = icaldurationtype_null_duration();
-
-
-      p = icalproperty_new_freebusy(period);
-      param = icalparameter_new_fbtype(ICAL_FBTYPE_BUSY);
-      icalproperty_add_parameter(p, param);
-
-      icalcomponent_add_property(comp, p);
-    }
-    
-  }
-
-  return comp;
-}
-
-
-/** @brief Return a spanlist corresponding to the VFREEBUSY portion of
- *         an icalcomponent.
- *
- *   @param   c        A valid icalcomponent.
- *
- *   @return           A valid icalspanlist or NULL if no VFREEBUSY section.
- *
- */
-
-
-icalspanlist *icalspanlist_from_vfreebusy(icalcomponent* comp)
-{
-  icalcomponent *inner;
-  icalproperty  *prop;
-  icalspanlist  *sl;
-
-  icalerror_check_arg_rz((comp != NULL), "comp");
-  
-  inner = icalcomponent_get_inner(comp);
-  if (!inner) return NULL;
-
-  if ( ( sl = (icalspanlist*) malloc(sizeof(icalspanlist))) == 0) {
-    icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-    return 0;
-  }
-  sl->spans =  pvl_newlist();
-
-  /* cycle through each FREEBUSY property, adding to the spanlist */
-  for (prop = icalcomponent_get_first_property(inner, ICAL_FREEBUSY_PROPERTY);
-       prop != NULL;
-       prop = icalcomponent_get_next_property(inner, ICAL_FREEBUSY_PROPERTY)) {
-    icaltime_span *s = (icaltime_span *) malloc(sizeof(icaltime_span));
-    icalparameter *param;
-    struct icalperiodtype period;
-    icalparameter_fbtype fbtype;
-
-    if (s == 0) {
-      icalerror_set_errno(ICAL_NEWFAILED_ERROR);
-      return 0;
-    }
-    
-    param = icalproperty_get_first_parameter(prop, ICAL_FBTYPE_PARAMETER);
-    fbtype = (param) ? icalparameter_get_fbtype(param) : ICAL_FBTYPE_BUSY;
-
-    switch (fbtype) {
-    case ICAL_FBTYPE_FREE:
-    case ICAL_FBTYPE_NONE:
-    case ICAL_FBTYPE_X:
-      s->is_busy = 1;
-    default:
-      s->is_busy = 0;
-    }
-    
-    period = icalproperty_get_freebusy(prop);
-    s->start = icaltime_as_timet_with_zone(period.start, icaltimezone_get_utc_timezone());
-    s->end = icaltime_as_timet_with_zone(period.end, icaltimezone_get_utc_timezone());
-;
-    pvl_insert_ordered(sl->spans, compare_span, (void*)s);
-  }
-  /** @todo calculate start/end limits.. fill in holes? **/
-  return sl;
-}
Index: libkcal/libical/src/libicalss/icalsslexer.l
===================================================================
--- libkcal/libical/src/libicalss/icalsslexer.l	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalsslexer.l	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,119 +0,0 @@
-%{
-/* -*- Mode: C -*-
-  ======================================================================
-  FILE: icalsslexer.l
-  CREATOR: eric 8 Aug 2000
-  
-  DESCRIPTION:
-  
-  $Id$
-  $Locker$
-
-(C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-  ======================================================================*/
-
-#include "icalssyacc.h"
-#include "icalgaugeimpl.h"
-#include "assert.h"
-
-#include <string.h> /* For strdup() */
-
-#undef YYPURE
-#define YYPURE
-
-#undef SS_FATAL_ERROR
-#define SS_FATAL_ERROR(msg) sserror(msg)
-
-%}
-
-crlf		\x0D?\x0A
-space		[ ]
-qsafechar	[^\x00-\x1F\"]
-safechar	[^\x00-\x1F\"\:\;\,]
-tsafechar	[\x20-\x21\x23-\x2B\x2D-\x39\x3C-\x5B\x5D-\x7E]
-valuechar	[^\x00-\x08\x10-\x1F]
-xname		X-[a-zA-Z0-9\-]+
-xname2          [a-zA-Z0-9\-\ ]
-paramtext	{safechar}+
-value		{valuechar}+
-quotedstring	\"{qsafechar}+\"
-digit		[0-9]
-
-%array /* Make yytext an array. Slow, but handy. HACK */
-
-%option caseless
-/* See http://lists.ximian.com/archives/public/evolution-hackers/2003-September/001304.html
-   if you run into problems with this option. */
-%option reentrant-bison
-
-%s sql string_value
-
-
-
-%%
-
-%{
-%}
-
-
-SELECT			{ return SELECT; }
-FROM			{ return FROM; }
-WHERE			{ return WHERE; }
-,			{ return COMMA; }
-"="  			{ return EQUALS; }
-"=="  			{ return EQUALS; }
-"!=" 			{ return NOTEQUALS; }
-"<"  			{ return LESS; }
-">"  			{ return GREATER; }
-"<=" 			{ return LESSEQUALS; }
-">=" 			{ return GREATEREQUALS; }
-AND 			{ return AND; }
-OR			{ return OR; }
-IS			{ return IS; }
-NOT			{ return NOT; }
-NULL			{ return SQLNULL; }
-\'                      { return QUOTE; }
-[ \t\n\r]+ ;			
-;			{ return EOL; }
-
-\'[\@\*A-Za-z0-9\-\.\:\ ]+\' {
-	int c = input(yy_globals);
-	unput(c);
-	if(c!='\''){
-		yylvalp->v_string= icalmemory_tmp_copy(yytext);
-		return STRING;
-	} else {
-		/*ssmore();*/
-	}
-}
-
-[\@\*A-Za-z0-9\-\.]+ {
-        yylval->v_string= icalmemory_tmp_copy(yytext);
-	return STRING; 
-}
-
-
-.			{ return yytext[0]; }
-
-%% 
-
-int yywrap(yyscan_t yy_globals)
-{
-     return 1;
-}
-
Index: libkcal/libical/src/libicalss/icaldirset.h
===================================================================
--- libkcal/libical/src/libicalss/icaldirset.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icaldirset.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,98 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icaldirset.h
- CREATOR: eric 28 November 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALDIRSET_H
-#define ICALDIRSET_H
-
-#include "ical.h"
-#include "icalset.h"
-#include "icalcluster.h"
-#include "icalgauge.h"
-
-/* icaldirset Routines for storing, fetching, and searching for ical
- * objects in a database */
-
-typedef struct icaldirset_impl icaldirset;
-
-icalset* icaldirset_new(const char* path);
-
-icalset* icaldirset_new_reader(const char* path);
-icalset* icaldirset_new_writer(const char* path);
-
-
-icalset* icaldirset_init(icalset* set, const char *dsn, void *options);
-void icaldirset_free(icalset* set);
-
-const char* icaldirset_path(icalset* set);
-
-/* Mark the cluster as changed, so it will be written to disk when it
-   is freed. Commit writes to disk immediately*/
-void icaldirset_mark(icalset* set);
-icalerrorenum icaldirset_commit(icalset* set);
-
-icalerrorenum icaldirset_add_component(icalset* store, icalcomponent* comp);
-icalerrorenum icaldirset_remove_component(icalset* store, icalcomponent* comp);
-
-int icaldirset_count_components(icalset* store,
-			       icalcomponent_kind kind);
-
-/* Restrict the component returned by icaldirset_first, _next to those
-   that pass the gauge. _clear removes the gauge. */
-icalerrorenum icaldirset_select(icalset* store, icalgauge* gauge);
-void icaldirset_clear(icalset* store);
-
-/* Get a component by uid */
-icalcomponent* icaldirset_fetch(icalset* store, const char* uid);
-int icaldirset_has_uid(icalset* store, const char* uid);
-icalcomponent* icaldirset_fetch_match(icalset* set, icalcomponent *c);
-
-/* Modify components according to the MODIFY method of CAP. Works on
-   the currently selected components. */
-icalerrorenum icaldirset_modify(icalset* store, icalcomponent *oldc,
-			       icalcomponent *newc);
-
-/* Iterate through the components. If a gauge has been defined, these
-   will skip over components that do not pass the gauge */
-
-icalcomponent* icaldirset_get_current_component(icalset* store);
-icalcomponent* icaldirset_get_first_component(icalset* store);
-icalcomponent* icaldirset_get_next_component(icalset* store);
-
-/* External iterator for thread safety */
-icalsetiter icaldirset_begin_component(icalset* set, icalcomponent_kind kind, icalgauge* gauge);
-icalcomponent* icaldirsetiter_to_next(icalset* set, icalsetiter* i);
-icalcomponent* icaldirsetiter_to_prior(icalset* set, icalsetiter* i);
-
-typedef struct icaldirset_options {
-  int flags;			/**< flags corresponding to the open() system call O_RDWR, etc. */
-} icaldirset_options;
-
-#endif /* !ICALDIRSET_H */
-
-
-
Index: libkcal/libical/src/libicalss/icalfileset.h
===================================================================
--- libkcal/libical/src/libicalss/icalfileset.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalfileset.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,134 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalfileset.h
- CREATOR: eric 23 December 1999
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALFILESET_H
-#define ICALFILESET_H
-
-#include "ical.h"
-#include "icalset.h"
-#include "icalcluster.h"
-#include "icalgauge.h"
-#include <sys/types.h> /* For open() flags and mode */
-#include <sys/stat.h> /* For open() flags and mode */
-#include <fcntl.h> /* For open() flags and mode */
-
-#ifdef WIN32
-#define mode_t int
-#endif
-
-extern int icalfileset_safe_saves;
-
-typedef struct icalfileset_impl icalfileset;
-
-icalset* icalfileset_new(const char* path);
-icalset* icalfileset_new_reader(const char* path);
-icalset* icalfileset_new_writer(const char* path);
-
-icalset* icalfileset_init(icalset *set, const char *dsn, void* options);
-
-icalfileset* icalfileset_new_from_cluster(const char* path, icalcluster *cluster);
-
-icalcluster* icalfileset_produce_icalcluster(const char *path);
-
-void icalfileset_free(icalset* cluster);
-
-const char* icalfileset_path(icalset* cluster);
-
-/* Mark the cluster as changed, so it will be written to disk when it
-   is freed. Commit writes to disk immediately. */
-void icalfileset_mark(icalset* set);
-icalerrorenum icalfileset_commit(icalset* set); 
-
-icalerrorenum icalfileset_add_component(icalset* set,
-					icalcomponent* child);
-
-icalerrorenum icalfileset_remove_component(icalset* set,
-					   icalcomponent* child);
-
-int icalfileset_count_components(icalset* set,
-				 icalcomponent_kind kind);
-
-/**
- * Restrict the component returned by icalfileset_first, _next to those
- * that pass the gauge. _clear removes the gauge 
- */
-icalerrorenum icalfileset_select(icalset* set, icalgauge* gauge);
-
-/** clear the gauge **/
-void icalfileset_clear(icalset* set);
-
-/** Get and search for a component by uid **/
-icalcomponent* icalfileset_fetch(icalset* set, const char* uid);
-int icalfileset_has_uid(icalset* set, const char* uid);
-icalcomponent* icalfileset_fetch_match(icalset* set, icalcomponent *c);
-
-
-/**
- *  Modify components according to the MODIFY method of CAP. Works on the
- *  currently selected components. 
- */
-icalerrorenum icalfileset_modify(icalset* set, 
-				 icalcomponent *oldcomp,
-			       icalcomponent *newcomp);
-
-/* Iterate through components. If a gauge has been defined, these
-   will skip over components that do not pass the gauge */
-
-icalcomponent* icalfileset_get_current_component (icalset* cluster);
-icalcomponent* icalfileset_get_first_component(icalset* cluster);
-icalcomponent* icalfileset_get_next_component(icalset* cluster);
-
-/* External iterator for thread safety */
-icalsetiter icalfileset_begin_component(icalset* set, icalcomponent_kind kind, icalgauge* gauge);
-icalcomponent * icalfilesetiter_to_next(icalset* set, icalsetiter *iter);
-icalcomponent* icalfileset_form_a_matched_recurrence_component(icalsetiter* itr);
-
-/** Return a reference to the internal component. You probably should
-   not be using this. */
-
-icalcomponent* icalfileset_get_component(icalset* cluster);
-
-/** 
- * @brief options for opening an icalfileset.
- *
- * These options should be passed to the icalset_new() function
- */
-
-typedef struct icalfileset_options {
-  int          flags;		/**< flags for open() O_RDONLY, etc  */
-  mode_t       mode;		/**< file mode */
-  int          safe_saves;	/**< to lock or not */
-  icalcluster  *cluster;	/**< use this cluster to initialize data */
-} icalfileset_options;
-
-extern icalfileset_options icalfileset_options_default;
-
-#endif /* !ICALFILESET_H */
-
-
-
Index: libkcal/libical/src/libicalss/icalset.h
===================================================================
--- libkcal/libical/src/libicalss/icalset.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalset.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,184 +0,0 @@
-/* -*- Mode: C -*- */
-/**
- @file icalset.h
- @author eric 28 November 1999
-
- Icalset is the "base class" for representations of a collection of
- iCal components. Derived classes (actually delegatees) include:
- 
-    icalfileset   Store components in a single file
-    icaldirset    Store components in multiple files in a directory
-    icalbdbset    Store components in a Berkeley DB File
-    icalheapset   Store components on the heap
-    icalmysqlset  Store components in a mysql database. 
-**/
-
-/*
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
- The Original Code is eric. The Initial Developer of the Original
- Code is Eric Busboom
-
-
-======================================================================*/
-
-#ifndef ICALSET_H
-#define ICALSET_H
-
-#include <limits.h> /* For PATH_MAX */
-#include "ical.h"
-#include "icalgauge.h"
-
-#ifdef PATH_MAX
-#define ICAL_PATH_MAX PATH_MAX
-#else
-#define ICAL_PATH_MAX 1024
-#endif
-
-
-typedef struct icalset_impl icalset;
-
-typedef enum icalset_kind {
-    ICAL_FILE_SET,
-    ICAL_DIR_SET,
-    ICAL_BDB_SET
-} icalset_kind;
-
-typedef struct icalsetiter
-{
-	icalcompiter iter;    /* icalcomponent_kind, pvl_elem iter */
-	icalgauge* gauge;
-        icalrecur_iterator* ritr; /*the last iterator*/
-        icalcomponent* last_component; /*the pending recurring component to be processed  */
-	const char* tzid; /* the calendar's timezone id */
-} icalsetiter;
-
-struct icalset_impl {
-        icalset_kind kind;
-	int size;
-        char *dsn;
-        icalset* (*init)(icalset* set, const char *dsn, void *options);
-	void (*free)(icalset* set);
-	const char* (*path)(icalset* set);
-	void (*mark)(icalset* set);
-	icalerrorenum (*commit)(icalset* set); 
-	icalerrorenum (*add_component)(icalset* set, icalcomponent* comp);
-	icalerrorenum (*remove_component)(icalset* set, icalcomponent* comp);
-	int (*count_components)(icalset* set,
-			     icalcomponent_kind kind);
-	icalerrorenum (*select)(icalset* set, icalgauge* gauge);
-	void (*clear)(icalset* set);
-	icalcomponent* (*fetch)(icalset* set, const char* uid);
-	icalcomponent* (*fetch_match)(icalset* set, icalcomponent *comp);
-	int (*has_uid)(icalset* set, const char* uid);
-	icalerrorenum (*modify)(icalset* set, icalcomponent *old,
-				     icalcomponent *newc);
-	icalcomponent* (*get_current_component)(icalset* set);	
-	icalcomponent* (*get_first_component)(icalset* set);
-	icalcomponent* (*get_next_component)(icalset* set);
-	icalsetiter (*icalset_begin_component)(icalset* set,
-					 icalcomponent_kind kind, icalgauge* gauge);
-	icalcomponent* (*icalsetiter_to_next)(icalset* set, icalsetiter* i);
-	icalcomponent* (*icalsetiter_to_prior)(icalset* set, icalsetiter* i);
-};
-
-/** @brief Register a new derived class */
-int icalset_register_class(icalset *set);
-
-
-/** @brief Generic icalset constructor
- *  
- *  @param kind     The type of icalset to create
- *  @param dsn      Data Source Name - usually a pathname or DB handle
- *  @param options  Any implementation specific options
- *
- *  @return         A valid icalset reference or NULL if error.
- * 
- *  This creates any of the icalset types available.
- */
-
-icalset* icalset_new(icalset_kind kind, const char* dsn, void* options);
-
-icalset* icalset_new_file(const char* path);
-icalset* icalset_new_file_reader(const char* path);
-icalset* icalset_new_file_writer(const char* path);
-
-icalset* icalset_new_dir(const char* path);
-icalset* icalset_new_file_reader(const char* path);
-icalset* icalset_new_file_writer(const char* path);
-
-void icalset_free(icalset* set);
-
-const char* icalset_path(icalset* set);
-
-/** Mark the cluster as changed, so it will be written to disk when it
-    is freed. **/
-void icalset_mark(icalset* set);
-
-/** Write changes to disk immediately */
-icalerrorenum icalset_commit(icalset* set); 
-
-icalerrorenum icalset_add_component(icalset* set, icalcomponent* comp);
-icalerrorenum icalset_remove_component(icalset* set, icalcomponent* comp);
-
-int icalset_count_components(icalset* set,
-			     icalcomponent_kind kind);
-
-/** Restrict the component returned by icalset_first, _next to those
-    that pass the gauge. */
-icalerrorenum icalset_select(icalset* set, icalgauge* gauge);
-
-/** Clears the gauge defined by icalset_select() */
-void icalset_clear_select(icalset* set);
-
-/** Get a component by uid */
-icalcomponent* icalset_fetch(icalset* set, const char* uid);
-
-int icalset_has_uid(icalset* set, const char* uid);
-icalcomponent* icalset_fetch_match(icalset* set, icalcomponent *c);
-
-/** Modify components according to the MODIFY method of CAP. Works on
-   the currently selected components. */
-icalerrorenum icalset_modify(icalset* set, icalcomponent *oldc,
-			       icalcomponent *newc);
-
-/** Iterate through the components. If a guage has been defined, these
-   will skip over components that do not pass the gauge */
-
-icalcomponent* icalset_get_current_component(icalset* set);
-icalcomponent* icalset_get_first_component(icalset* set);
-icalcomponent* icalset_get_next_component(icalset* set);
-
-/** External Iterator with gauge - for thread safety */
-extern icalsetiter icalsetiter_null;
-
-icalsetiter icalset_begin_component(icalset* set,
-				 icalcomponent_kind kind, icalgauge* gauge);
-
-/** Default _next, _prior, _deref for subclasses that use single cluster */
-icalcomponent* icalsetiter_next(icalsetiter* i);
-icalcomponent* icalsetiter_prior(icalsetiter* i);
-icalcomponent* icalsetiter_deref(icalsetiter* i);
-
-/** for subclasses that use multiple clusters that require specialized cluster traversal */
-icalcomponent* icalsetiter_to_next(icalset* set, icalsetiter* i);
-icalcomponent* icalsetiter_to_prior(icalset* set, icalsetiter* i);
-
-#endif /* !ICALSET_H */
-
-
-
Index: libkcal/libical/src/libicalss/icalspanlist.h
===================================================================
--- libkcal/libical/src/libicalss/icalspanlist.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalspanlist.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,77 +0,0 @@
-/* -*- Mode: C -*- */
-/*======================================================================
- FILE: icalspanlist.h
- CREATOR: eric 21 Aug 2000
-
-
- $Id$
- $Locker$
-
- (C) COPYRIGHT 2000, Eric Busboom, http://www.softwarestudio.org
-
- This program is free software; you can redistribute it and/or modify
- it under the terms of either: 
-
-    The LGPL as published by the Free Software Foundation, version
-    2.1, available at: http://www.fsf.org/copyleft/lesser.html
-
-  Or:
-
-    The Mozilla Public License Version 1.0. You may obtain a copy of
-    the License at http://www.mozilla.org/MPL/
-
-
- =========================================================================*/
-#ifndef ICALSPANLIST_H
-#define ICALSPANLIST_H
-
-#include "ical.h"
-#include "icalset.h"
-
-/** @file icalspanlist.h
- *  @brief Code that supports collections of free/busy spans of time
- */
-
-typedef struct icalspanlist_impl icalspanlist;
-
-
-/** @brief Constructor
- * Make a free list from a set of component. Start and end should be in UTC 
- */
-
-icalspanlist* icalspanlist_new(icalset *set, 
-				struct icaltimetype start,
-				struct icaltimetype end);
-
-/** @brief Destructor
- */
-void icalspanlist_free(icalspanlist* spl);
-
-/* Unimplemented functions */
-icalcomponent* icalspanlist_make_free_list(icalspanlist* sl);
-icalcomponent* icalspanlist_make_busy_list(icalspanlist* sl);
-
-/** Get first next free time after time t. all times are in UTC. */
-struct icalperiodtype icalspanlist_next_free_time(icalspanlist* sl,
-						struct icaltimetype t);
-/** Get first next busy time after time t. all times are in UTC. */
-struct icalperiodtype icalspanlist_next_busy_time(icalspanlist* sl,
-						struct icaltimetype t);
-
-void icalspanlist_dump(icalspanlist* s);
-
-/** @brief Return a valid VFREEBUSY component for this span */
-icalcomponent *icalspanlist_as_vfreebusy(icalspanlist* s_in,
-					 const char* organizer,
-					 const char* attendee);
-
-/** @brief Return an integer matrix of total events per delta_t timespan */
-int *icalspanlist_as_freebusy_matrix(icalspanlist* span, int delta_t);
-
-/** @brief Construct an icalspanlist from a VFREEBUSY component */
-icalspanlist *icalspanlist_from_vfreebusy(icalcomponent* c);
-
-#endif
-				    
-
-
Index: libkcal/libical/src/libicalss/icalclassify.c
===================================================================
--- libkcal/libical/src/libicalss/icalclassify.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalclassify.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -67,59 +67,8 @@
     return xnew;
 }
 
-/* Return a set of components that intersect in time with comp. For
-component X and Y to intersect:
-    X.DTSTART < Y.DTEND && X.DTEND > Y.DTSTART
-*/
 
 
-icalcomponent* icalclassify_find_overlaps(icalset* set, icalcomponent* comp)
-{
-    icalcomponent *return_set;
-    icalcomponent *c;
-    struct icaltime_span span,compspan;
-    
-    icalerror_clear_errno();
-    compspan = icalcomponent_get_span(comp);
-
-    if(icalerrno != ICAL_NO_ERROR){
-	return 0;
-    }
-
-
-    return_set = icalcomponent_new(ICAL_XROOT_COMPONENT);
-
-    for(c = icalset_get_first_component(set);
-	c != 0;
-	c = icalset_get_next_component(set)){
-
-	icalerror_clear_errno();
-
-	span = icalcomponent_get_span(c);
-
-	if(icalerrno != ICAL_NO_ERROR){
-	    continue;
-	}
-
-	if (compspan.start < span.end && 
-	    compspan.end > span.start){
-
-	    icalcomponent *clone = icalcomponent_new_clone(c);
-
-	    icalcomponent_add_component(return_set,clone);
-	}	
-    }
-
-    if(icalcomponent_count_components(return_set,ICAL_ANY_COMPONENT) !=0){
-	return return_set;
-    } else {
-	icalcomponent_free(return_set);
-	return 0;
-    }
-}
-
-
-
 icalproperty* icalclassify_find_attendee(icalcomponent *c, 
 						  const char* attendee)
 {
Index: libkcal/libical/src/libicalss/Makefile.am
===================================================================
--- libkcal/libical/src/libicalss/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -8,45 +8,14 @@
 INCLUDES = -I../libical -I$(srcdir)/../libical
 
 libicalss_la_SOURCES =		\
-	icalcalendar.c		\
-	icalcalendar.h		\
 	icalclassify.c		\
-	icalclassify.h		\
-	icalcluster.c		\
-	icalcluster.h		\
-	icalclusterimpl.h	\
-	icalgauge.c		\
-	icalgauge.h		\
-	icalgaugeimpl.h		\
-	icaldirset.c		\
-	icaldirset.h		\
-	icaldirsetimpl.h	\
-	icalfileset.c		\
-	icalfileset.h		\
-	icalfilesetimpl.h	\
-	icalset.c		\
-	icalset.h		\
-	icalssyacc.h		\
-	icalspanlist.c		\
-	icalspanlist.h		\
-	icalmessage.c		\
-	icalmessage.h		\
-	icalsslexer.c           \
-        icalssyacc.c
+	icalclassify.h
 
 # We don't need icalss.h, but it needs to be built...
 libicalss_la_COMPILE_FIRST = ../libical/ical.h icalss.h
 
 COMBINEDHEADERS = \
-	$(srcdir)/icalgauge.h \
-	$(srcdir)/icalset.h \
-	$(srcdir)/icalcluster.h \
-	$(srcdir)/icalfileset.h \
-	$(srcdir)/icaldirset.h \
-	$(srcdir)/icalcalendar.h  \
-	$(srcdir)/icalclassify.h \
-	$(srcdir)/icalspanlist.h	\
-	$(srcdir)/icalmessage.h
+	$(srcdir)/icalclassify.h 
 
 icalss.h: $(COMBINEDHEADERS)
 	echo '#ifdef __cplusplus'	  >  icalss.h
@@ -63,10 +32,7 @@
 	echo '}'			  >> icalss.h
 	echo '#endif'			  >> icalss.h
 
-noinst_HEADERS = icalss.h icalcalendar.h icalclassify.h icalcluster.h \
-                 icaldirset.h icaldirsetimpl.h icalfileset.h icalfilesetimpl.h \
-                 icalgauge.h icalgaugeimpl.h icalmessage.h icalset.h \
-                 icalspanlist.h icalssyacc.h
+noinst_HEADERS = icalss.h icalclassify.h 
 
-CLEANFILES = y.output icalss.h
+CLEANFILES = icalss.h
 
Index: libkcal/libical/src/libicalss/icalclassify.h
===================================================================
--- libkcal/libical/src/libicalss/icalclassify.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/libical/src/libicalss/icalclassify.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,16 +27,10 @@
 #define ICALCLASSIFY_H
 
 #include "ical.h"
-#include "icalset.h"
 
 icalproperty_xlicclass icalclassify(icalcomponent* c,icalcomponent* match, 
 			      const char* user);
 
-icalcomponent* icalclassify_find_overlaps(icalset* set, icalcomponent* comp);
-
-char* icalclassify_class_to_string(icalproperty_xlicclass c);
-
-
 #endif /* ICALCLASSIFY_H*/
 
 
Index: libkcal/calendarlocal.cpp
===================================================================
--- libkcal/calendarlocal.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/calendarlocal.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -452,7 +452,7 @@
           eventList.append( event );
         }
       } else {
-        if ( ( s >= start && s <= end ) || ( e >= start && e <= end ) ) {
+        if ( s <= end && e >= start ) {
           eventList.append( event );
         }
       }
@@ -478,10 +478,10 @@
 
 bool CalendarLocal::addJournal(Journal *journal)
 {
-  if (journal->dtStart().isValid())
-    kdDebug(5800) << "Adding Journal on " << journal->dtStart().toString() << endl;
-  else
-    kdDebug(5800) << "Adding Journal without a DTSTART" << endl;
+//   if (journal->dtStart().isValid())
+//     kdDebug(5800) << "Adding Journal on " << journal->dtStart().toString() << endl;
+//   else
+//     kdDebug(5800) << "Adding Journal without a DTSTART" << endl;
 
   mJournalList.append(journal);
 
Index: libkcal/icalformatimpl.cpp
===================================================================
--- libkcal/icalformatimpl.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/icalformatimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,7 +31,6 @@
 
 extern "C" {
   #include <ical.h>
-  #include <icalss.h>
   #include <icalparser.h>
   #include <icalrestriction.h>
 }
@@ -192,17 +191,16 @@
     icaltimetype end;
     if (event->doesFloat()) {
 //      kdDebug(5800) << " Event " << event->summary() << " floats." << endl;
-//      if (event->dtEnd().date() != event->dtStart().date()) {
-        // +1 day because end date is non-inclusive.
-        end = writeICalDate( event->dtEnd().date().addDays( 1 ) );
-//      }
+      // +1 day because end date is non-inclusive.
+      end = writeICalDate( event->dtEnd().date().addDays( 1 ) );
+      icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
     } else {
 //      kdDebug(5800) << " Event " << event->summary() << " has time." << endl;
       if (event->dtEnd() != event->dtStart()) {
         end = writeICalDateTime(event->dtEnd());
+        icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
       }
     }
-    icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
   }
 
 // TODO: resources
@@ -406,8 +404,8 @@
         incidence->relatedToUid().utf8()));
   }
 
-  kdDebug(5800) << "Write recurrence for '" << incidence->summary() << "' (" << incidence->uid()
-            << ")" << endl;
+//   kdDebug(5800) << "Write recurrence for '" << incidence->summary() << "' (" << incidence->uid()
+//             << ")" << endl;
 
   RecurrenceRule::List rrules( incidence->recurrence()->rRules() );
   RecurrenceRule::List::ConstIterator rit;
@@ -766,7 +764,7 @@
 
 icalcomponent *ICalFormatImpl::writeAlarm(Alarm *alarm)
 {
-kdDebug(5800) << " ICalFormatImpl::writeAlarm" << endl;
+// kdDebug(5800) << " ICalFormatImpl::writeAlarm" << endl;
   icalcomponent *a = icalcomponent_new(ICAL_VALARM_COMPONENT);
 
   icalproperty_action action;
@@ -783,7 +781,7 @@
       break;
     case Alarm::Audio:
       action = ICAL_ACTION_AUDIO;
-kdDebug(5800) << " It's an audio action, file: " << alarm->audioFile() << endl;
+// kdDebug(5800) << " It's an audio action, file: " << alarm->audioFile() << endl;
       if (!alarm->audioFile().isEmpty()) {
         attach = icalattach_new_from_url(QFile::encodeName( alarm->audioFile() ).data());
         icalcomponent_add_property(a,icalproperty_new_attach(attach));
@@ -950,6 +948,8 @@
   QStringList categories;
   icalproperty_transp transparency;
 
+  bool dtEndProcessed = false;
+
   while (p) {
     icalproperty_kind kind = icalproperty_isa(p);
     switch (kind) {
@@ -968,6 +968,7 @@
           event->setDtEnd(readICalDateTime(icaltime, tz));
           event->setFloats( false );
         }
+        dtEndProcessed = true;
         break;
 
       case ICAL_RELATEDTO_PROPERTY:  // related event (parent)
@@ -993,6 +994,12 @@
     p = icalcomponent_get_next_property(vevent,ICAL_ANY_PROPERTY);
   }
 
+  // according to rfc2445 the dtend shouldn't be written when it equals
+  // start date. so assign one equal to start date.
+  if ( !dtEndProcessed && !event->hasDuration() ) {
+    event->setDtEnd( event->dtStart() );
+  }
+
   QString msade = event->nonKDECustomProperty("X-MICROSOFT-CDO-ALLDAYEVENT");
   if (!msade.isNull()) {
     bool floats = (msade == QString::fromLatin1("TRUE"));
@@ -1173,19 +1180,26 @@
 
 Attachment *ICalFormatImpl::readAttachment(icalproperty *attach)
 {
-  icalattach *a = icalproperty_get_attach(attach);
-
   Attachment *attachment = 0;
 
-  int isurl = icalattach_get_is_url (a);
-  if (isurl == 0)
-    attachment = new Attachment((const char*)icalattach_get_data(a));
-  else {
-    attachment = new Attachment(QString(icalattach_get_url(a)));
+  icalvalue_kind value_kind = icalvalue_isa(icalproperty_get_value(attach));
+
+  if ( value_kind == ICAL_ATTACH_VALUE ) {
+    icalattach *a = icalproperty_get_attach(attach);
+
+    int isurl = icalattach_get_is_url (a);
+    if (isurl == 0)
+      attachment = new Attachment((const char*)icalattach_get_data(a));
+    else {
+      attachment = new Attachment(QString(icalattach_get_url(a)));
+    }
   }
+  else if ( value_kind == ICAL_URI_VALUE ) {
+    attachment = new Attachment(QString(icalvalue_get_uri(icalproperty_get_value(attach))));
+  }
 
   icalparameter *p = icalproperty_get_first_parameter(attach, ICAL_FMTTYPE_PARAMETER);
-  if (p)
+  if (p && attachment)
     attachment->setMimeType(QString(icalparameter_get_fmttype(p)));
 
   return attachment;
@@ -1429,7 +1443,7 @@
     QString value = QString::fromUtf8(icalproperty_get_x(p));
     const char *name = icalproperty_get_x_name(p);
     customProperties[name] = value;
-    kdDebug(5800) << "Set custom property [" << name << '=' << value << ']' << endl;
+    // kdDebug(5800) << "Set custom property [" << name << '=' << value << ']' << endl;
     p = icalcomponent_get_next_property(parent,ICAL_X_PROPERTY);
   }
 
@@ -1445,7 +1459,7 @@
   Recurrence *recur = incidence->recurrence();
 
   struct icalrecurrencetype r = icalproperty_get_rrule(rrule);
-  dumpIcalRecurrence(r);
+//   dumpIcalRecurrence(r);
 
   RecurrenceRule *recurrule = new RecurrenceRule( /*incidence*/ );
   recurrule->setStartDt( incidence->dtStart() );
@@ -1458,7 +1472,7 @@
 //  kdDebug(5800) << "Read recurrence for " << incidence->summary() << endl;
 
   struct icalrecurrencetype r = icalproperty_get_exrule(rrule);
-  dumpIcalRecurrence(r);
+//   dumpIcalRecurrence(r);
 
   RecurrenceRule *recurrule = new RecurrenceRule( /*incidence*/ );
   recurrule->setStartDt( incidence->dtStart() );
@@ -1552,7 +1566,7 @@
 
 void ICalFormatImpl::readAlarm(icalcomponent *alarm,Incidence *incidence)
 {
-  kdDebug(5800) << "Read alarm for " << incidence->summary() << endl;
+//   kdDebug(5800) << "Read alarm for " << incidence->summary() << endl;
 
   Alarm* ialarm = incidence->newAlarm();
   ialarm->setRepeatCount(0);
@@ -1579,7 +1593,7 @@
     }
   }
   ialarm->setType(type);
-kdDebug(5800) << " alarm type =" << type << endl;
+// kdDebug(5800) << " alarm type =" << type << endl;
 
   p = icalcomponent_get_first_property(alarm,ICAL_ANY_PROPERTY);
   while (p) {
Index: libkcal/calendar.h
===================================================================
--- libkcal/calendar.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/calendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -902,6 +902,12 @@
     void notifyIncidenceDeleted( Incidence *incidence );
 
     /**
+      @copydoc
+      CustomProperties::customPropertyUpdated()
+    */
+    virtual void customPropertyUpdated();
+
+    /**
        Let Calendar subclasses notify that they enabled an Observer.
 
        @param enabled if true tells the Calendar that a subclass has
Index: libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.recurson.ref
===================================================================
--- libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.recurson.ref	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.recurson.ref	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,2 @@
+1997-09-02
+
Index: libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.prev.ref
===================================================================
--- libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.prev.ref	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.prev.ref	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,8 @@
+1997-09-02T10:30:00
+1997-09-02T10:15:00
+1997-09-02T10:00:00
+1997-09-02T09:45:00
+1997-09-02T09:30:00
+1997-09-02T09:15:00
+1997-09-02T09:00:00
+
Index: libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.comp34.ref
===================================================================
--- libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.comp34.ref	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.comp34.ref	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,8 @@
+1997-09-02T09:00:00
+1997-09-02T09:15:00
+1997-09-02T09:30:00
+1997-09-02T09:45:00
+1997-09-02T10:00:00
+1997-09-02T10:15:00
+1997-09-02T10:30:00
+
Index: libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.next.ref
===================================================================
--- libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.next.ref	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics.next.ref	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,8 @@
+1997-09-02T09:00:00
+1997-09-02T09:15:00
+1997-09-02T09:30:00
+1997-09-02T09:45:00
+1997-09-02T10:00:00
+1997-09-02T10:15:00
+1997-09-02T10:30:00
+
Index: libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics
===================================================================
--- libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ libkcal/tests/data/RecurrenceRule/RFC2445/RFC2445_RRULETestCase36U.ics	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,34 @@
+BEGIN:VCALENDAR
+CALSCALE:GREGORIAN
+METHOD:PUBLISH
+PRODID:-//Cyrusoft International\, Inc.//Mulberry v4.0//EN
+VERSION:2.0
+X-LibKCal-Testsuite-OutTZ:America/New_York
+BEGIN:VTIMEZONE
+LAST-MODIFIED:20040110T032845Z
+TZID:US-Eastern
+BEGIN:DAYLIGHT
+DTSTART:19900404T010000
+RRULE:FREQ=YEARLY;BYDAY=1SU;BYMONTH=4
+TZNAME:EDT
+TZOFFSETFROM:-0500
+TZOFFSETTO:-0400
+END:DAYLIGHT
+BEGIN:STANDARD
+DTSTART:19901026T060000
+RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10
+TZNAME:EST
+TZOFFSETFROM:-0400
+TZOFFSETTO:-0500
+END:STANDARD
+END:VTIMEZONE
+BEGIN:VEVENT
+DESCRIPTION:Every 15 minutes until 10:30
+DTSTAMP:20040102T053656Z
+DTSTART;TZID=US-Eastern:19970902T090000
+RRULE:FREQ=MINUTELY;UNTIL=19970902T143000Z;INTERVAL=15
+SUMMARY:RExample36U
+UID:RExample36U
+END:VEVENT
+END:VCALENDAR
+
Index: libkcal/tests/Makefile.am
===================================================================
--- libkcal/tests/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/tests/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-INCLUDES = -I$(top_srcdir)/libkcal $(all_includes)
+INCLUDES = -I$(top_srcdir)/libkcal -I$(top_srcdir) $(all_includes)
 
 
 check_PROGRAMS = testtostring \
Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -119,6 +119,7 @@
   return KGlobal::locale()->formatDate(dtDue( !doesRecur() ).date(),shortfmt);
 }
 
+// TODO: Add shortfmt param!!!
 QString Todo::dtDueStr() const
 {
   return KGlobal::locale()->formatDateTime( dtDue( !doesRecur() ) );
@@ -275,11 +276,17 @@
 
     if ( ( r->duration() == -1 || ( nextDate.isValid() && endDateTime.isValid()
            && nextDate <= endDateTime ) ) ) {
-      setDtDue( nextDate );
-      while ( !recursAt( dtDue() ) || dtDue() <= QDateTime::currentDateTime() ) {
-        setDtDue( r->getNextDateTime( dtDue() ) );
+
+      while ( !recursAt( nextDate ) || nextDate <= QDateTime::currentDateTime() ) {
+
+        if ( !nextDate.isValid() || nextDate > endDateTime ) {
+          return false;
+        }
+
+        nextDate = r->getNextDateTime( nextDate );
       }
 
+      setDtDue( nextDate );
       setCompleted( false );
       setRevision( revision() + 1 );
 
Index: libkcal/calendar.cpp
===================================================================
--- libkcal/calendar.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/calendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -793,6 +793,11 @@
   }
 }
 
+void Calendar::customPropertyUpdated()
+{
+  setModified( true );
+}
+
 void Calendar::setProductId( const QString &productId )
 {
   mProductId = productId;
Index: libkcal/htmlexport.h
===================================================================
--- libkcal/htmlexport.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/htmlexport.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -37,7 +37,7 @@
 namespace KCal {
 
 /**
-  This class provides the functions to export a calendar as a HTML page.
+  This class provides the functions to export a calendar as an HTML page.
 */
 class KDE_EXPORT HtmlExport
 {
Index: libkcal/incidencebase.cpp
===================================================================
--- libkcal/incidencebase.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/incidencebase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -379,3 +379,8 @@
     o->incidenceUpdated( this );
   }
 }
+
+void IncidenceBase::customPropertyUpdated()
+{
+  updated();
+}
Index: libkcal/incidence.cpp
===================================================================
--- libkcal/incidence.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -92,7 +92,7 @@
     Incidence::List Relations = mRelations;
     List::ConstIterator it;
     for ( it = Relations.begin(); it != Relations.end(); ++it ) {
-        if ( (*it)->relatedTo() == this ) (*it)->setRelatedTo( 0 );
+        if ( (*it)->relatedTo() == this ) (*it)->mRelatedTo = 0;
     }
     if ( relatedTo() ) relatedTo()->removeRelation( this );
 
@@ -102,9 +102,7 @@
 // A string comparison that considers that null and empty are the same
 static bool stringCompare( const QString& s1, const QString& s2 )
 {
-    if ( s1.isEmpty() && s2.isEmpty() )
-        return true;
-    return s1 == s2;
+  return ( s1.isEmpty() && s2.isEmpty() ) || (s1 == s2);
 }
 
 bool Incidence::operator==( const Incidence& i2 ) const
Index: libkcal/icalformat.cpp
===================================================================
--- libkcal/icalformat.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/icalformat.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -126,6 +126,7 @@
   file.file()->writeBlock( textUtf8.data(), textUtf8.size() - 1 );
 
   if ( !file.close() ) {
+    kdDebug(5800) << "KSaveFile: close: status was " << file.status() << ". See errno.h." << endl;
     setException(new ErrorFormat(ErrorFormat::SaveError,
                  i18n("Could not save '%1'").arg(fileName)));
     return false;
Index: libkcal/recurrencerule.cpp
===================================================================
--- libkcal/recurrencerule.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/recurrencerule.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1069,7 +1069,7 @@
 
 // kdDebug(5800) << "    getNext date after " << preDate << endl;
   prev = afterDate;
-  if ( mDuration >= 0 && endDt().isValid() && afterDate >= endDt() )
+  if ( mDuration >= 0 && endDt().isValid() && afterDate > endDt() )
     prev = endDt().addSecs( 1 );
 
   Constraint interval( getPreviousValidDateInterval( prev, recurrenceType() ) );
@@ -1081,7 +1081,10 @@
     do {
       --dtit;
     } while ( dtit != dts.begin() && (*dtit) >= prev );
-    if ( (*dtit) < prev ) return (*dtit);
+    if ( (*dtit) < prev ) {
+      if ( (*dtit) >= startDt() ) return (*dtit);
+      else return QDateTime();
+    }
   }
 
   // Previous interval. As soon as we find an occurrence, we're done.
Index: libkcal/customproperties.h
===================================================================
--- libkcal/customproperties.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/customproperties.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,7 @@
 /*
     This file is part of libkcal.
 
-    Copyright (c) 2002 David Jarvie <software@astrojar.org.uk>
+    Copyright (c) 2002,2006 David Jarvie <software@astrojar.org.uk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -111,6 +111,14 @@
     */
     QMap<QCString, QString> customProperties() const;
 
+  protected:
+    /**
+      Called when a custom property has been changed.
+      The default implementation does nothing: override in derived classes
+      to perform change processing.
+    */
+    virtual void customPropertyUpdated()  {}
+
   private:
     static bool checkName(const QCString& name);
 
Index: libkcal/alarm.cpp
===================================================================
--- libkcal/alarm.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ libkcal/alarm.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -452,3 +452,8 @@
 {
   mParent = parent;
 }
+
+void Alarm::customPropertyUpdated()
+{
+  if ( mParent ) mParent->updated();
+}
Index: kpilot/cmake/modules/FindPilotlink.cmake
===================================================================
--- kpilot/cmake/modules/FindPilotlink.cmake	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/cmake/modules/FindPilotlink.cmake	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,37 @@
+set(CMAKE_INCLUDE_PATH "${PILOTLINK_BASE}/include")
+FIND_PATH(PILOTLINK_INCLUDE_DIR pi-dlp.h 
+	/usr/include
+	/usr/include/libpisock
+	/usr/local/include
+	)
+set(CMAKE_LIBRARY_PATH "${PILOTLINK_BASE}/lib")
+FIND_LIBRARY(PILOTLINK_LIBRARY pisock 
+	/usr/lib
+	/usr/local/lib
+	)
+
+IF (NOT PILOTLINK_INCLUDE_DIR)
+	MESSAGE(STATUS "Could not find pi-dlp.h")
+ELSE (NOT PILOTLINK_INCLUDE_DIR)
+	MESSAGE(STATUS "Found pi-dlp.h in ${PILOTLINK_INCLUDE_DIR}")
+ENDIF (NOT PILOTLINK_INCLUDE_DIR)
+
+IF (NOT PILOTLINK_LIBRARY)
+	MESSAGE(STATUS "Could not find libpisock")
+ELSE (NOT PILOTLINK_LIBRARY)
+	MESSAGE(STATUS "Found libpisock in ${PILOTLINK_LIBRARY}")
+ENDIF (NOT PILOTLINK_LIBRARY)
+
+IF (PILOTLINK_INCLUDE_DIR AND PILOTLINK_LIBRARY)
+	SET(PILOTLINK_FOUND TRUE)
+ENDIF (PILOTLINK_INCLUDE_DIR AND PILOTLINK_LIBRARY)
+
+IF (PILOTLINK_FOUND)
+	MESSAGE(STATUS "Found pilot-link: ${PILOTLINK_LIBRARY}")
+ELSE (PILOTLINK_FOUND)
+	IF (Pilotlink_FIND_REQUIRED)
+		MESSAGE(STATUS "KPilot requires pilot-link 0.12.0 or later. Pilot-link is available from pilot-link.org and is packaged by most distributions. Remember to install the development package with the compilation headers as well.")
+		MESSAGE(FATAL_ERROR "Could not find pilot-link.")
+	ENDIF (Pilotlink_FIND_REQUIRED)
+ENDIF (PILOTLINK_FOUND)
+
Index: kpilot/cmake/modules/FindMal.cmake
===================================================================
--- kpilot/cmake/modules/FindMal.cmake	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/cmake/modules/FindMal.cmake	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,37 @@
+set(CMAKE_INCLUDE_PATH "${MAL_BASE}/include")
+FIND_PATH(MAL_INCLUDE_DIR libmal.h 
+	/usr/include
+	/usr/include/libmal
+	/usr/local/include
+	/usr/local/include/libmal
+)
+set(CMAKE_LIBRARY_PATH "${MAL_BASE}/lib")
+FIND_LIBRARY(MAL_LIBRARY mal 
+	/usr/lib
+	/usr/lib/libmal
+	/usr/local/lib
+	/usr/local/lib/libmal
+)
+
+IF (NOT MAL_INCLUDE_DIR)
+	MESSAGE(STATUS "Could not find libmal.h")
+ELSE (NOT MAL_INCLUDE_DIR)
+	MESSAGE(STATUS "Found libmal.h in ${MAL_INCLUDE_DIR}")
+ENDIF (NOT MAL_INCLUDE_DIR)
+
+IF (NOT MAL_LIBRARY)
+	MESSAGE(STATUS "Could not find libmal")
+ELSE (NOT MAL_LIBRARY)
+	MESSAGE(STATUS "Found libmal in ${MAL_LIBRARY}")
+ENDIF (NOT MAL_LIBRARY)
+
+IF (MAL_INCLUDE_DIR AND MAL_LIBRARY)
+	SET(MAL_FOUND TRUE)
+ENDIF (MAL_INCLUDE_DIR AND MAL_LIBRARY)
+
+IF (MAL_FOUND)
+	MESSAGE(STATUS "Found mal: ${MAL_LIBRARY}")
+ELSE (MAL_FOUND)
+	MESSAGE(STATUS "Couldn't find mal. Won't be able to build malconduit")
+ENDIF (MAL_FOUND)
+
Index: kpilot/cmake/modules/KPilotCustom.cmake
===================================================================
--- kpilot/cmake/modules/KPilotCustom.cmake	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/cmake/modules/KPilotCustom.cmake	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,53 @@
+MACRO(KDE3_INSTALL_ICONS_CUSTOM _theme)
+   ADD_CUSTOM_TARGET(install_icons )
+   SET_TARGET_PROPERTIES(install_icons PROPERTIES POST_INSTALL_SCRIPT ${CMAKE_CURRENT_BINARY_DIR}/install_icons.cmake )
+   FILE(WRITE ${CMAKE_CURRENT_BINARY_DIR}/install_icons.cmake "# icon installations rules\n")
+   FILE(APPEND ${CMAKE_CURRENT_BINARY_DIR}/install_icons.cmake "SET(CMAKE_BACKWARDS_COMPATIBILITY \"2.2\") \n")
+
+   FILE(GLOB _icons *.png)
+   FOREACH(_current_ICON ${_icons} )
+      STRING(REGEX REPLACE "^.*/[a-zA-Z]+([0-9]+)\\-([a-z]+)\\-(.+\\.png)$" "\\1" _size "${_current_ICON}")
+      STRING(REGEX REPLACE "^.*/[a-zA-Z]+([0-9]+)\\-([a-z]+)\\-(.+\\.png)$" "\\2" _group "${_current_ICON}")
+      STRING(REGEX REPLACE "^.*/[a-zA-Z]+([0-9]+)\\-([a-z]+)\\-(.+\\.png)$" "\\3" _name "${_current_ICON}")
+
+      SET(_icon_GROUP "unknown")
+
+      IF(${_group} STREQUAL "mime")
+         SET(_icon_GROUP  "mimetypes")
+      ENDIF(${_group} STREQUAL "mime")
+
+      IF(${_group} STREQUAL "filesys")
+         SET(_icon_GROUP  "filesystems")
+      ENDIF(${_group} STREQUAL "filesys")
+
+      IF(${_group} STREQUAL "device")
+         SET(_icon_GROUP  "devices")
+      ENDIF(${_group} STREQUAL "device")
+
+      IF(${_group} STREQUAL "app")
+         SET(_icon_GROUP  "apps")
+      ENDIF(${_group} STREQUAL "app")
+
+      IF(${_group} STREQUAL "action")
+         SET(_icon_GROUP  "actions")
+      ENDIF(${_group} STREQUAL "action")
+
+      IF( NOT ${_icon_GROUP} STREQUAL "unknown")
+#        message(STATUS "icon: ${_current_ICON} size: ${_size} group: ${_group} name: ${_name}" )
+         SET(_ICON_INSTALL_NAME ${CMAKE_INSTALL_PREFIX}/share/icons/${_theme}/${_size}x${_size}/${_icon_GROUP}/${_name})
+         FILE(APPEND ${CMAKE_CURRENT_BINARY_DIR}/install_icons.cmake "message(STATUS \"Installing ${_ICON_INSTALL_NAME}\") \n")
+         FILE(APPEND ${CMAKE_CURRENT_BINARY_DIR}/install_icons.cmake "CONFIGURE_FILE( ${_current_ICON} ${_ICON_INSTALL_NAME} COPYONLY) \n")
+      ELSE( NOT ${_icon_GROUP} STREQUAL "unknown")
+         message(STATUS "icon: ${_current_ICON} doesn't fit naming conventions. ignoring." )
+      ENDIF( NOT ${_icon_GROUP} STREQUAL "unknown")
+
+   ENDFOREACH (_current_ICON)
+ENDMACRO(KDE3_INSTALL_ICONS_CUSTOM)
+
+
+MACRO(KPILOT_RPATH _thing)
+	set_target_properties(${_thing} PROPERTIES 
+		INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib;${KDE3_DIR}/lib;${PILOTLINK_LIBRARY}
+		INSTALL_RPATH_USE_LINK_PATH true
+	)
+ENDMACRO(KPILOT_RPATH _thing)
Index: kpilot/configure
===================================================================
--- kpilot/configure	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/configure	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,178 @@
+#!/bin/sh
+
+# simple configure script for user-friendliness
+
+# file to put output into for cmake to read in...
+OUTFILE=$(dirname $0)/CMakeOptions.txt
+
+# --- FUNCTIONS ---
+
+usage()
+{
+echo "
+
+Hi there.  You can use this script to configure parameters used by cmake.
+Currently, understood parameters are as follows:
+
+  --prefix=PREFIX         install architecture-independent files in PREFIX
+  --enable-debug=ARG      enables debug symbols (yes|no) default=no
+  --enable-tests=ARG      enable test suite (yes|no) default=no
+  --with-pilot-link=PATH  set prefix for pilot-link files [default=check]
+  --with-mal=PATH         set path for libmal files [default=check]
+
+  --show                  show existing configuration values
+
+More obscure options:
+
+  --with-simple-builddir=ARG      use 'build' instead of longer name (yes|no) default=no
+  --with-pilot-link-includes=PATH set include directory for pilot-link
+  --with-pilot-link-lib=PATH      set full path to libpisock.so
+
+"
+}
+
+getvalue()
+{
+	KEY="$1"
+	# use dynamic variable...
+	eval VAL='$'$KEY
+
+	ECHO="$2"
+	
+	if test -n "$VAL"
+	then
+		CMAKE_FLAGS="${CMAKE_FLAGS}-D${KEY}=${VAL} "
+		if [ "$ECHO" = "y" ]
+		then
+			echo "$KEY=\"$VAL\""
+		fi
+	fi
+
+}
+
+outputvalues()
+{
+
+# only include what we're passed
+CMAKE_FLAGS=""
+
+getvalue CMAKE_INSTALL_PREFIX y
+getvalue CMAKE_BUILD_TYPE y
+getvalue ENABLE_TESTS y
+getvalue BUILD_DIR y
+getvalue PILOTLINK_BASE y
+getvalue MAL_BASE y
+getvalue PILOTLINK_INCLUDE_DIR y
+getvalue PILOTLINK_LIBRARY y
+
+echo "CMAKE_FLAGS=$CMAKE_FLAGS"
+}
+
+# --- MAIN ---
+
+# first, if there's no args, don't lose what we had stored (badness).
+# simply show what available arguments are and exit...
+if test -z "$1"; then
+	usage
+	exit
+fi
+
+CMAKE_BUILD_TYPE="normal"
+ENABLE_TESTS="NO"
+
+while test -n "$1"
+do
+	case "$1" in
+		--prefix=*)
+			CMAKE_INSTALL_PREFIX=$(echo $1 | cut -d "=" -f2)
+			;;
+		--enable-debug*)
+			T=$(echo $1 | cut -d "=" -f2 | tr '[A-Z]' '[a-z]')
+			if test "$T" = "$1" || test "yes" = "$T" || test "full" = "$T" ; then
+				CMAKE_BUILD_TYPE=debug
+			else
+				CMAKE_BUILD_TYPE=normal
+			fi
+			;;
+		--enable-test*)
+			T=$(echo "$1" | cut -d = -f2 | tr '[A-Z]' '[a-z]')
+			if test "$T" = "$1" || test "yes" = "$T" ; then
+				ENABLE_TESTS=YES
+			else
+				ENABLE_TESTS=NO
+			fi
+			;;
+		--with-simple-builddir*)
+			T=$(echo "$1" | cut -d = -f2 | tr '[A-Z]' '[a-z]')
+			if test "$T" = "$1" || test "yes" = "$T" ; then
+				BUILD_DIR=build
+			fi
+			;;
+		--with-pilot-link-includes=*)
+			PILOTLINK_INCLUDE_DIR=$(echo $1 | cut -d = -f2)
+			;;
+		--with-pilot-link-lib=*)
+			PILOTLINK_LIBRARY=$(echo $1 | cut -d = -f2)
+			;;
+		--with-pilot-link=*)
+			PILOTLINK_BASE=$(echo $1 | cut -d "=" -f2)
+			;;
+		--with-mal=*)
+			MAL_BASE=$(echo $1 | cut -d "=" -f2)
+			;;
+		--show)
+			echo "Existing configuration values:"
+			cat "$OUTFILE" 2>/dev/null
+			echo "-----------"
+			exit
+			;;
+		*)
+			usage
+			exit
+			;;
+	esac
+
+	shift
+
+done
+
+echo "
+Thanks.  Here are the values I will be using...
+
+$(outputvalues)
+
+To compile KPilot, now run GNU make, like so:
+"
+
+###
+#
+# BSD uses gmake for the GNU make which we need ...
+#
+if uname -s | grep BSD > /dev/null 2>&1 ; then
+	echo "    gmake -f Makefile.cmake"
+else
+	echo "    make -f Makefile.cmake"
+fi
+echo ""
+
+outputvalues > "$OUTFILE.new"
+
+
+###
+#
+# If the configure values have changed, then we should update the 
+# CMakeLists.txt in order to prompt a re-run of cmake.
+#
+update=no
+if test -f "$OUTFILE" ; then
+	diff -q "$OUTFILE" "$OUTFILE.new" > /dev/null 2>&1 || update=yes
+else
+	update=yes
+fi
+if test yes = "$update" ; then
+	cp "$OUTFILE.new" "$OUTFILE"
+	touch CMakeLists.txt
+fi
+rm -f "$OUTFILE.new"
+
+

Zmiany atrybutów dla: kpilot/configure
___________________________________________________________________
Nazwa: svn:executable
   + *

Index: kpilot/AUTHORS
===================================================================
--- kpilot/AUTHORS	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/AUTHORS	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -3,6 +3,7 @@
 Adriaan de Groot and Reinhold Kainhofe are currently the maintainers.
 
 
+o Jason 'vanRijn' Kasper is prime motivator in 2006.
 o The vcal and todo conduit were originally written by Preston Brown.
 o The popclient conduit was written by Michael Kropfberger.
 o The null conduit and KNotes conduit were written by Adriaan de Groot.
@@ -25,4 +26,4 @@
 -- Adriaan de Groot January 20th 2002
 -- Reinhold Kainhofer, April 5th 2003
 -- Adriaan de Groot, March 4th 2004
-
+-- Adriaan de Groot, November 18th 2006
Index: kpilot/ChangeLog
===================================================================
--- kpilot/ChangeLog	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/ChangeLog	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -8,12 +8,39 @@
 	               record->isDeleted() is false, on sync, but it is modified and
 	               updated on the pc, although that does not change anything.
 
+TODO: store map of pilot-id <-> uid elsewhere (not in the .vcf file)
+TODO: don't make ActionQueue auto-delete the actions in it.
 TODO: provide template-based, interpreted databases much like the
-  AppInfo classes now have.
+      AppInfo classes now have.
 TODO: give the knotes conduit a decent test mode.
 TODO: only re-write a local database if it is changed.
-TODO: move set-category code from subclasses into PilotRecordBase.
 
+2006-10-24  Jason 'vanRijn' Kasper
+* Getting rid of FastSync.  The only difference between it and HotSync was
+  that HotSync did a Backup and FastSync did not.  Having a third
+  permutation because of not having a way to set it in the Backup settings
+  seems wrong.  Also, if one of them is to go, I think that HotSync is much
+  more recognizable and widely used than FastSync.  
+* Allowing finer-grained control around when database backups are done.
+  This is so that users can choose when they want a backup to be done.
+  The problem I need to solve for myself is that since I'm now syncing
+  between 2 PCs, I need a full sync to be done whenever I switch.  But I
+  do not EVER want an automatic backup to be done.  Currently, this is not
+  possible.  Fixing it.  =:)  This will also allow for schedule backups to
+  be done, which is also of interest to me.
+
+2006-01-30  Adriaan de Groot
+* Updated pilot-link to today's CVS, with one change - use of pl_socklen_t
+  in inet.c changed back to socklen_t.
+* Added --loop to kpilotTest to repeatedly run the same action. Only
+  works for --list right now.
+
+2006-01-23  Adriaan de Groot
+* Gosh, where to begin. KPilot moved SVN repositories, changed build
+  systems, had the guts of the device link class refactored, bumped the
+  plugin API version again, and tons more. The commit logs are probably
+  the most useful source of information about what's changed.
+
 2005-08-18  Adriaan de Groot
 * Found out that the PilotAppCategory constructor that takes
   a PilotRecord * was passing subsequent parameters in the wrong
Index: kpilot/conduits/sysinfoconduit/sysinfo-conduit.cc
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -148,23 +148,18 @@
 extern "C"
 {
 
-long version_conduit_sysinfo = KPILOT_PLUGIN_API;
-const char *id_conduit_sysinfo =
-	"$Id$";
+unsigned long version_conduit_sysinfo = Pilot::PLUGIN_API;
 
 }
 
 
 
-SysInfoConduit::SysInfoConduit(KPilotDeviceLink * o,
+SysInfoConduit::SysInfoConduit(KPilotLink * o,
 	const char *n,
 	const QStringList & a) :
 	ConduitAction(o, n, a)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<id_conduit_sysinfo<<endl;
-#endif
 	fConduitName=i18n("System Information");
 }
 
@@ -198,9 +193,6 @@
 /* virtual */ bool SysInfoConduit::exec()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << id_conduit_sysinfo<<endl;
-#endif
 
 	readConfig();
 
@@ -213,7 +205,7 @@
 	FUNCTIONSETUP;
 	if (fHardwareInfo) {
 		QString unknown = i18n("unknown");
-		
+
 		/* Retrieve values for
 		* - #deviceid#
 		* - #devicename#
@@ -221,17 +213,10 @@
 		* - #manufactorer#
 		* - #devicetype#
 		*/
-		KPilotSysInfo *sysinfo = fHandle->getSysInfo();
-		if (sysinfo)
-		{
-			fValues[CSL1("deviceid")] = QString::fromLatin1(sysinfo->getProductID());
-		}
-		else
-		{
-			fValues[CSL1("deviceid")] = unknown;
-		}
-		
-		KPilotCard *device = fHandle->getCardInfo();
+		KPilotSysInfo sysinfo = fHandle->getSysInfo();
+		fValues[CSL1("deviceid")] = QString::fromLatin1(sysinfo.getProductID());
+
+		const KPilotCard *device = fHandle->getCardInfo();
 		if (device)
 		{
 			fValues[CSL1("devicename")] = QString::fromLatin1(device->getCardName());
@@ -244,9 +229,9 @@
 			fValues[CSL1("devicemodel")] = unknown;
 			fValues[CSL1("manufacturer")] = unknown;
 		}
-		
+
 		fValues[CSL1("devicetype")] = unknown;
-		
+
 		KPILOT_DELETE(device);
 		keepParts.append(CSL1("hardware"));
 	} else removeParts.append(CSL1("hardware"));
@@ -261,14 +246,14 @@
 		 * - #username#
 		 * - #uid#
 		 */
-		KPilotUser*user=fHandle->getPilotUser();
-		fValues[CSL1("username")] = user->getUserName();
-		if (user->getPasswordLength()>0)
+		KPilotUser user=fHandle->getPilotUser();
+		fValues[CSL1("username")] = user.getUserName();
+		if (user.getPasswordLength()>0)
 			fValues[CSL1("pw")] = i18n("Password set");
 		else
 			fValues[CSL1("pw")] = i18n("No password set");
-		fValues[CSL1("uid")] = QString::number(user->getUserID());
-		fValues[CSL1("viewerid")] = QString::number(user->getViewerID());
+		fValues[CSL1("uid")] = QString::number(user.getUserID());
+		fValues[CSL1("viewerid")] = QString::number(user.getViewerID());
 		keepParts.append(CSL1("user"));
 	} else removeParts.append(CSL1("user"));
 	QTimer::singleShot(0, this, SLOT(memoryInfo()));
@@ -283,10 +268,13 @@
 		 * - #totalmem#
 		 * - #freemem#
 		 */
-		KPilotCard*device = fHandle->getCardInfo();
-		fValues[CSL1("rom")] =  QString::number(device->getRomSize()/1024);
-		fValues[CSL1("totalmem")] =  QString::number(device->getRamSize()/1024);
-		fValues[CSL1("freemem")] =  QString::number(device->getRamFree()/1024);
+		const KPilotCard *device = fHandle->getCardInfo();
+		if (device)
+		{
+			fValues[CSL1("rom")] =  QString::number(device->getRomSize()/1024);
+			fValues[CSL1("totalmem")] =  QString::number(device->getRamSize()/1024);
+			fValues[CSL1("freemem")] =  QString::number(device->getRamFree()/1024);
+		}
 		keepParts.append(CSL1("memory"));
 	} else removeParts.append(CSL1("memory"));
 	QTimer::singleShot(0, this, SLOT(storageInfo()));
@@ -299,7 +287,7 @@
 		/* Retrieve values for
 		 * - $cards$
 		 */
-		KPilotCard*device = fHandle->getCardInfo(1);
+		const KPilotCard *device = fHandle->getCardInfo(1);
 		if (device) {
 			fValues[CSL1("cards")] = CSL1("%1 (%2, %3 kB of %3 kB free)")
 				.arg(QString::fromLatin1(device->getCardName()))
@@ -322,7 +310,7 @@
 		/* Retrieve values for
 		 * - #dblist(structure)#
 		 */
-		dblist=fHandle->getDBList();
+		dblist=deviceLink()->getDBList();
 		keepParts.append(CSL1("dblist"));
 	} else removeParts.append(CSL1("dblist"));
 	QTimer::singleShot(0, this, SLOT(recNumberInfo()));
@@ -338,28 +326,28 @@
 		 * - #todos#
 		 * - #memos#
 		 */
-		PilotDatabase*fDatabase;
+		PilotDatabase *fDatabase = 0L;
 		QString ERROR = CSL1("ERROR");
 		fValues[CSL1("addresses")] = ERROR;
 		fValues[CSL1("events")] = ERROR;
 		fValues[CSL1("todos")] = ERROR;
 		fValues[CSL1("memos")] = ERROR;
-		fDatabase = new PilotSerialDatabase(pilotSocket(), CSL1("AddressDB"));
+		fDatabase = deviceLink()->database(CSL1("AddressDB"));
 		if (fDatabase) {
 			fValues[CSL1("addresses")] = QString::number(fDatabase->recordCount());
 			KPILOT_DELETE(fDatabase);
 		}
-		fDatabase = new PilotSerialDatabase(pilotSocket(), CSL1("DatebookDB"));
+		fDatabase = deviceLink()->database(CSL1("DatebookDB"));
 		if (fDatabase) {
 			fValues[CSL1("events")] = QString::number(fDatabase->recordCount());
 			KPILOT_DELETE(fDatabase);
 		}
-		fDatabase = new PilotSerialDatabase(pilotSocket(), CSL1("ToDoDB"));
+		fDatabase = deviceLink()->database(CSL1("ToDoDB"));
 		if (fDatabase) {
 			fValues[CSL1("todos")] = QString::number(fDatabase->recordCount());
 			KPILOT_DELETE(fDatabase);
 		}
-		fDatabase = new PilotSerialDatabase(pilotSocket(), CSL1("MemoDB"));
+		fDatabase = deviceLink()->database(CSL1("MemoDB"));
 		if (fDatabase) {
 			fValues[CSL1("memos")] = QString::number(fDatabase->recordCount());
 			KPILOT_DELETE(fDatabase);
@@ -378,15 +366,15 @@
 		 * - #lastsuccsync#
 		 * - #lastsyncpc#
 		 */
-		KPilotUser*user=fHandle->getPilotUser();
-		time_t lastsync = user->getLastSyncDate();
+		KPilotUser user = deviceLink()->getPilotUser();
+		time_t lastsync = user.getLastSyncDate();
 		QDateTime qlastsync;
 		qlastsync.setTime_t(lastsync);
 		fValues[CSL1("lastsync")] = qlastsync.toString(Qt::LocalDate);
-		lastsync = user->getLastSuccessfulSyncDate();
+		lastsync = user.getLastSuccessfulSyncDate();
 		qlastsync.setTime_t(lastsync);
 		fValues[CSL1("lastsuccsync")] = qlastsync.toString(Qt::LocalDate);
-		fValues[CSL1("lastsyncpc")] = QString::number(user->getLastSyncPC());
+		fValues[CSL1("lastsyncpc")] = QString::number(user.getLastSyncPC());
 		keepParts.append(CSL1("sync"));
 	} else removeParts.append(CSL1("sync"));
 	QTimer::singleShot(0, this, SLOT(pcVersionInfo()));
@@ -448,7 +436,8 @@
 			.arg(fHandle->getSysInfo()->getMinorVersion())
 			.arg(fHandle->getSysInfo()->getCompatMajorVersion())
 			.arg(fHandle->getSysInfo()->getCompatMinorVersion());*/
-		fValues[CSL1("palmos")] = CSL1("PalmOS %1.%2").arg(fHandle->majorVersion()).arg(fHandle->minorVersion());
+		KPilotSysInfo i = deviceLink()->getSysInfo();
+		fValues[CSL1("palmos")] = CSL1("PalmOS %1.%2").arg(i.getMajorVersion()).arg(i.getMinorVersion());
 
 		keepParts.append(CSL1("palmversion"));
 	} else removeParts.append(CSL1("palmversion"));
@@ -535,8 +524,8 @@
 	while (re.search(output)>=0){
 		QString dbstring;
 		QString subpatt=re.cap(1);
-		DBInfo*dbi;
-		for (dbi=dblist.first(); dbi; dbi=dblist.next() ) {
+		for (DBInfoList::ConstIterator i = dblist.begin(); i != dblist.end(); ++i ) {
+			DBInfo dbi = *i;
 			QString newpatt(subpatt);
 			char tmpchr[5];
 			::memset(&tmpchr[0], 0, 5);
@@ -552,21 +541,21 @@
 			 * %8 .. modifyDate
 			 * %9 .. backupDate
 			 */
-			newpatt.replace(CSL1("%0"), QString::fromLatin1(dbi->name));
-			set_long(&tmpchr[0],dbi->type);
+			newpatt.replace(CSL1("%0"), QString::fromLatin1(dbi.name));
+			set_long(&tmpchr[0],dbi.type);
 			newpatt.replace(CSL1("%1"), QString::fromLatin1(tmpchr));
-			set_long(&tmpchr[0],dbi->creator);
+			set_long(&tmpchr[0],dbi.creator);
 			newpatt.replace(CSL1("%2"), QString::fromLatin1(tmpchr));
-			newpatt.replace(CSL1("%3"), QString::number(dbi->index));
-			newpatt.replace(CSL1("%4"), QString::number(dbi->flags));
-			newpatt.replace(CSL1("%5"), QString::number(dbi->miscFlags));
-			newpatt.replace(CSL1("%6"), QString::number(dbi->version));
+			newpatt.replace(CSL1("%3"), QString::number(dbi.index));
+			newpatt.replace(CSL1("%4"), QString::number(dbi.flags));
+			newpatt.replace(CSL1("%5"), QString::number(dbi.miscFlags));
+			newpatt.replace(CSL1("%6"), QString::number(dbi.version));
 			QDateTime tm;
-			tm.setTime_t(dbi->createDate);
+			tm.setTime_t(dbi.createDate);
 			newpatt.replace(CSL1("%7"), tm.toString(Qt::LocalDate));
-			tm.setTime_t(dbi->modifyDate);
+			tm.setTime_t(dbi.modifyDate);
 			newpatt.replace(CSL1("%8"), tm.toString(Qt::LocalDate));
-			tm.setTime_t(dbi->backupDate);
+			tm.setTime_t(dbi.backupDate);
 			newpatt.replace(CSL1("%9"), tm.toString(Qt::LocalDate));
 
 			dbstring.append(newpatt);
Index: kpilot/conduits/sysinfoconduit/sysinfo-conduit.h
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,7 +35,7 @@
 	Q_OBJECT
 public:
 	SysInfoConduit(
-		KPilotDeviceLink *o,
+		KPilotLink *o,
 		const char *n = 0L,
 		const QStringList &a = QStringList() );
 	virtual ~SysInfoConduit();
@@ -70,7 +70,7 @@
 		eOutputTemplate
 	} fOutputType;
 
-	QPtrList<DBInfo> dblist;
+	DBInfoList dblist;
 	QStringList removeParts;
 	QStringList keepParts;
 	static const QString defaultpage;
Index: kpilot/conduits/sysinfoconduit/sysinfo-factory.cc
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,100 +27,17 @@
 */
 
 #include "options.h"
+#include "pluginfactory.h"
 
-#include <kapplication.h>
-#include <kinstance.h>
-#include <kaboutdata.h>
-
 #include "sysinfo-conduit.h"
 #include "sysinfo-setup.h"
 
-#include "sysinfo-factory.moc"
-
-
 extern "C"
 {
 
 void *init_conduit_sysinfo()
 {
-	return new SysInfoConduitFactory;
+	return new ConduitFactory<SysInfoWidgetConfig,SysInfoConduit>;
 }
 
 }
-
-
-// A number of static variables
-KAboutData *SysInfoConduitFactory::fAbout = 0L;
-
-
-SysInfoConduitFactory::SysInfoConduitFactory(QObject *p, const char *n) :
-	KLibFactory(p,n)
-{
-	FUNCTIONSETUP;
-
-	fInstance = new KInstance("SysInfoConduit");
-	fAbout = new KAboutData("SysInfoConduit",
-		I18N_NOOP("KPilot System Information conduit"),
-		KPILOT_VERSION,
-		I18N_NOOP("Retrieves System, Hardware, and User Info from the Handheld and stores them to a file."),
-		KAboutData::License_GPL,
-		"(C) 2003, Reinhold Kainhofer");
-	fAbout->addAuthor("Reinhold Kainhofer",
-		I18N_NOOP("Primary Author"), "reinhold@kainhofer.com", "http://reinhold.kainhofer.com/");
-}
-
-SysInfoConduitFactory::~SysInfoConduitFactory()
-{
-	FUNCTIONSETUP;
-
-	KPILOT_DELETE(fInstance);
-	KPILOT_DELETE(fAbout);
-}
-
-/* virtual */ QObject *SysInfoConduitFactory::createObject( QObject *p,
-	const char *n,
-	const char *c,
-	const QStringList &a)
-{
-	FUNCTIONSETUP;
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< c
-		<< endl;
-#endif
-
-	if (qstrcmp(c,"ConduitConfigBase")==0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(p);
-		if (w)
-		{
-			return new SysInfoWidgetConfig(w,"ConduitConfigBase");
-		}
-		else
-		{
-			return 0L;
-		}
-	}
-	else
-	if (qstrcmp(c,"SyncAction")==0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
-
-		if (d)
-		{
-			return new SysInfoConduit(d,n,a);
-		}
-		else
-		{
-			kdError() << k_funcinfo
-				<< ": Couldn't cast parent to KPilotDeviceLink"
-				<< endl;
-			return 0L;
-		}
-	}
-
-	return 0L;
-}
-
Index: kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -206,12 +206,9 @@
     <tabstop>tabWidget</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/sysinfoconduit/sysinfo-factory.h
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,31 +28,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include <klibloader.h>
-
-class KInstance;
-class KAboutData;
-
-class SysInfoConduitFactory : public KLibFactory
-{
-	Q_OBJECT
-
-public:
-	SysInfoConduitFactory(QObject * = 0L,const char * = 0L);
-	virtual ~SysInfoConduitFactory();
-
-	static KAboutData *about() { return fAbout; } ;
-
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() );
-private:
-	KInstance *fInstance;
-	static KAboutData *fAbout;
-} ;
-
 extern "C"
 {
 	void *init_libsysinfoconduit();
Index: kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=این لوله، اطلاعات دربارۀ دستی شما و ترکیب‌دهی به پرونده را می‌نویسد.
 Comment[fi]=Tämä yhdyskäytävä kirjoittaa tietoja taskutietokoneelta ja synkronoi ne tiedostoon.
 Comment[fr]=Ce canal écrit des informations sur votre périphérique et la synchronisation dans un fichier.
+Comment[gl]=Este conducto escribe a información sobre o seu aparello portátil e a sincronización a un ficheiro.
 Comment[hi]=यह कन्ड्यूइट आपके हैंण्डहेल्ड के बारे में जानकारी लिखता है तथा एक फ़ाइल में सिंक करता है.
 Comment[hu]=Ezzel a csatolóval fájlba lehet kiíratni a kéziszámítógép és a szinkronizálás jellemzőit
 Comment[is]=Þessi rás skrifar upplýsingar um lófatölvuna þína og samstillinguna í skrá.
@@ -43,6 +44,7 @@
 Comment[zh_CN]=此管道写入您手持设备的信息，并同步至一文件。
 Comment[zh_TW]=此軟體將您的 handheld 資訊寫入檔案。
 Name=System Information
+Name[ar]=معلومات عن النظام
 Name[be]=Сыстэмная інфармацыя
 Name[br]=Titouroù diwar-benn ar reizhiad
 Name[bs]=Sistemske informacije
@@ -55,7 +57,7 @@
 Name[es]=Información del sistema
 Name[et]=Süsteemi info
 Name[eu]=Sistemaren informazioa
-Name[fa]=اطلاعات سیستم‌
+Name[fa]=اطلاعات سیستم
 Name[fi]=Järjestelmätiedot
 Name[fr]=Informations sur le système
 Name[ga]=Faisnéis Córais
Index: kpilot/conduits/sysinfoconduit/sysinfo-setup.cc
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-setup.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/sysinfoconduit/sysinfo-setup.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -33,6 +33,8 @@
 #include <qcheckbox.h>
 #include <qbuttongroup.h>
 #include <qlistview.h>
+
+#include <kaboutdata.h>
 #include <kapplication.h>
 #include <kurlrequester.h>
 
@@ -89,7 +91,17 @@
 	fConfigWidget(new SysInfoWidget(w))
 {
 	FUNCTIONSETUP;
-	UIDialog::addAboutPage(fConfigWidget->tabWidget,SysInfoConduitFactory::about());
+
+	KAboutData *fAbout = new KAboutData("SysInfoConduit",
+		I18N_NOOP("KPilot System Information conduit"),
+		KPILOT_VERSION,
+		I18N_NOOP("Retrieves System, Hardware, and User Info from the Handheld and stores them to a file."),
+		KAboutData::License_GPL,
+		"(C) 2003, Reinhold Kainhofer");
+	fAbout->addAuthor("Reinhold Kainhofer",
+		I18N_NOOP("Primary Author"), "reinhold@kainhofer.com", "http://reinhold.kainhofer.com/");
+
+	UIDialog::addAboutPage(fConfigWidget->tabWidget,fAbout);
 	fWidget=fConfigWidget;
 
 	QObject::connect(fConfigWidget->fOutputFile,SIGNAL(textChanged(const QString&)),
@@ -121,7 +133,7 @@
 			<< (ci->isOn() ? " on" : " off") << endl;
 #endif
 		int index=ci->text(PART_KEY).toInt();
-		if (0<=index && index<=10) 
+		if (0<=index && index<=10)
 		{
 			const sysinfoEntry_t *p = sysinfoEntries+index;
 			p->mutator(ci->isOn());
Index: kpilot/conduits/sysinfoconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/sysinfoconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/sysinfoconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,53 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_sysinfo_SRCS
+	sysinfo-setup.cc
+	sysinfo-factory.cc
+	sysinfo-conduit.cc
+)
+
+set(conduit_sysinfo_UIS
+	sysinfo-setup_dialog.ui
+)
+
+set(conduit_sysinfo_KCFGS
+	sysinfoSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_sysinfo_SRCS ${conduit_sysinfo_KCFGS})
+kde3_add_ui_files(conduit_sysinfo_SRCS ${conduit_sysinfo_UIS})
+kde3_automoc(${conduit_sysinfo_SRCS})
+add_library(conduit_sysinfo SHARED ${conduit_sysinfo_SRCS})
+
+set_target_properties(
+	conduit_sysinfo PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_sysinfo)
+
+install(
+	TARGETS conduit_sysinfo
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES sysinfo_conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)
+
+install(
+	FILES sysinfoSettings.kcfgc DESTINATION ${KDE3_KCFG_DIR}
+)
+
+install(
+	FILES Template.html DESTINATION ${CMAKE_INSTALL_PREFIX}/share
+)
+
+install(
+	FILES Template.txt 
+	DESTINATION ${CMAKE_INSTALL_PREFIX}/share/apps/kpilot/sysinfoconduit
+)
+

Zmiany atrybutów dla: kpilot/conduits/sysinfoconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
sysinfo-setup_dialog.h
sysinfo-setup_dialog.cc
temp
   + .deps
.libs
Makefile
Makefile.in
sysinfo-setup_dialog.h
sysinfo-setup_dialog.cc
*.moc
sysinfoSettings.cc
sysinfoSettings.h



Index: kpilot/conduits/notepadconduit/notepad-conduit.cc
===================================================================
--- kpilot/conduits/notepadconduit/notepad-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,7 +2,7 @@
 **
 ** Copyright (C) 2004 by Adriaan de Groot, Joern Ahrens
 **
-** The code for NotepadActionThread::unpackNotePad was taken from 
+** The code for NotepadActionThread::unpackNotePad was taken from
 ** Angus Ainslies read-notepad.c, which is part of pilot-link.
 ** NotepadActionThread::saveImage is also based on read-notepad.c.
 **
@@ -49,22 +49,16 @@
 
 extern "C"
 {
-long version_conduit_notepad = KPILOT_PLUGIN_API;
-const char *id_conduit_notepad =
-	"$Id$";
+unsigned long version_conduit_notepad = Pilot::PLUGIN_API;
 }
 
-NotepadConduit::NotepadConduit(KPilotDeviceLink *d,	const char *n,
-	const QStringList &args) :	ConduitAction(d, n, args)
+NotepadConduit::NotepadConduit(KPilotLink *d, const char *n,
+	const QStringList &args) : ConduitAction(d, n, args)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_conduit_notepad << endl;
-#endif
 	fConduitName=i18n("Notepad");
 	thread = 0L;
 
-	(void) id_conduit_notepad;
 }
 
 NotepadConduit::~NotepadConduit()
@@ -75,7 +69,7 @@
 /* virtual */ bool NotepadConduit::exec()
 {
 	FUNCTIONSETUP;
-	
+
 #ifdef DEBUG
 	DEBUGCONDUIT << fname << ": In exec() @" << (unsigned long) this << endl;
 #endif
@@ -87,13 +81,13 @@
 		return false;
 	}
 	else {
-		thread = new NotepadActionThread(this, pilotSocket());
+		thread = new NotepadActionThread(this, deviceLink());
 		thread->start();
 		// tickle is disabled due to crashs during sync
 		// -> PADP TX "unexpected package"
 //		startTickle();
 	}
-	
+
 	return true;
 }
 
@@ -113,7 +107,7 @@
 		delete thread;
 		return true;
 	}
-	else 
+	else
 		return ConduitAction::event(e);
 }
 
@@ -121,8 +115,8 @@
 // NotepadActionThread
 //-----------------------------------------------------------------------------
 
-NotepadActionThread::NotepadActionThread(QObject *parent, int pilotSocket) :
-	fParent(parent), fPilotSocket(pilotSocket), notSaved(0), saved(0)
+NotepadActionThread::NotepadActionThread(QObject *parent, KPilotLink *link) :
+	fParent(parent), fLink(link), notSaved(0), saved(0)
 {
 	FUNCTIONSETUP;
 }
@@ -131,7 +125,7 @@
 {
 	FUNCTIONSETUP;
 
-	PilotSerialDatabase *db = new PilotSerialDatabase(fPilotSocket, "npadDB");
+	PilotDatabase *db = fLink->database( CSL1("npadDB") );
 
 	int n = db->recordCount();
 
@@ -140,11 +134,14 @@
 		QValueList<recordid_t> vl = db->idList();
 		QValueList<recordid_t>::iterator it;
 		struct NotePad a;
-		for ( it = vl.begin(); it != vl.end(); ++it ) {
+		for ( it = vl.begin(); it != vl.end(); ++it )
+		{
 			PilotRecord *pr = db->readRecordById(*it);
-			if(pr) {
-				unpack_NotePad(&a, (unsigned char*)pr->getData(), pr->size());
+			if(pr)
+			{
+				unpack_NotePad(&a, (unsigned char*)pr->data(), pr->size());
 				saveImage(&a);
+				free_NotePad(&a);
 			}
 		}
 	}
@@ -152,70 +149,113 @@
 	QApplication::postEvent(fParent, new QEvent(QEvent::User));
 }
 
+static void saveImageFromBITS(QImage &image, struct NotePad *n, unsigned int width)
+{
+	FUNCTIONSETUP;
+	image.setColor(0, qRgb(0xaa, 0xc1 ,0x91));
+	image.setColor(1, qRgb(0x30, 0x36, 0x29));
+
+	int x = 0;
+	int y = 0;
+	int pos = 0;
+	for(unsigned int i=0; i<n->body.dataLen/2; ++i)
+	{
+		for(int j=0; j<n->data[i].repeat; ++j)
+		{
+			for(int k=0; k<8; ++k)
+			{
+				y = pos / width;
+				x = pos % width ;
+
+				image.setPixel( x, y,
+					(n->data[i].data & 1<<(7-k)) ? 1 : 0 );
+				++pos;
+			}
+		}
+	}
+}
+
+static void saveImageFromUNCOMPRESSED(QImage &image, struct NotePad *n, unsigned int width)
+{
+	FUNCTIONSETUP;
+
+	image.setColor(0, qRgb(0xaa, 0xc1 ,0x91));
+	image.setColor(1, qRgb(0x30, 0x36, 0x29));
+
+	unsigned int pos = 0;
+	unsigned int x,y;
+
+	for (unsigned int i=0; i<n->body.dataLen / 2; ++i)
+	{
+		for (unsigned int k=0; k<8; ++k)
+		{
+			y = pos / width;
+			x = pos % width ;
+
+			image.setPixel( x, y,
+				(n->data[i].repeat & 1<<(7-k)) ? 1 : 0 );
+			++pos;
+		}
+
+		for (unsigned int k=0; k<8; ++k)
+		{
+			y = pos / width;
+			x = pos % width ;
+
+			image.setPixel( x, y,
+				(n->data[i].data & 1<<(7-k)) ? 1 : 0 );
+			++pos;
+		}
+	}
+}
+
 void NotepadActionThread::saveImage(struct NotePad *n)
 {
 	FUNCTIONSETUP;
-	
-    int width = n->body.width + 8;    
-    int height = n->body.height;
-	
-    QImage image(width, height, 8, 2);
-    
-    if(n->body.dataType == NOTEPAD_DATA_BITS)
-    {
-        image.setColor(0, qRgb(0xaa, 0xc1 ,0x91));
-        image.setColor(1, qRgb(0x30, 0x36, 0x29));
 
-        int x = 0;  
-        int y = 0;
-        int pos = 0;
-        for(int i=0; i<n->body.dataLen/2; ++i)
-        {
-            for(int j=0; j<n->data[i].repeat; ++j)
-            {
-                for(int k=0; k<8; ++k)
-                {
-				    y = pos / width;
-				    x = pos % width ;
-        
-				    if(n->data[i].data & 1<<(7-k))
-				        image.setPixel(x,y,1);
-				    else
-                        image.setPixel(x,y,0);
-                    ++pos;
-                }
-	       }
-        }      
-    }
-    else if(n->body.dataType == NOTEPAD_DATA_PNG)
-    {
-        image.loadFromData((uchar*)(n->data), n->body.dataLen);
-    }
-    else
-    {
-        // Unknown data type
+	// Width needs adjusting, based on whether it's low res (+8)
+	// or a hi-res notepad image.
+	int width = n->body.width + ( n->body.width > 160 ? 16 : 8 );
+	int height = n->body.height;
+
+
+	QImage image(width, height, 8, 2);
+
+	switch (n->body.dataType)
+	{
+	case NOTEPAD_DATA_BITS :
+		saveImageFromBITS( image,n,width );
+		break;
+	case NOTEPAD_DATA_UNCOMPRESSED :
+		saveImageFromUNCOMPRESSED( image,n,width );
+		break;
+	case NOTEPAD_DATA_PNG :
+		image.loadFromData((uchar*)(n->data), n->body.dataLen);
+		break;
+	default :
+		// Unknown data type
+		kdWarning() << k_funcinfo << ": Unknown data type: "
+			<< n->body.dataType << endl;
+		return;
+
+		// TODO: Post a warning to the UI
+	}
+
+	QString filename(n->name);
+	if(filename.isEmpty())
+	{
+		filename.sprintf("%4d-%02d-%02d_%02d-%02d-%02d",
+			n->changeDate.year,
+			n->changeDate.month,
+			n->changeDate.day,
+			n->changeDate.hour,
+			n->changeDate.min,
+			n->changeDate.sec);
+	}
+	QString imgname = QString("%1/%2.png").arg(NotepadConduitSettings::outputDirectory()).arg(filename);
+
+
 #ifdef DEBUG
-    DEBUGCONDUIT << fname << ": Unknown data type: " << n->body.dataType << endl;
-#endif        
-        return;
-    }
-	
-    QString filename(n->name);
-    if(filename.isEmpty())
-    {
-        filename.sprintf("%4d-%02d-%02d_%02d-%02d-%02d",
-                        n->changeDate.year,
-                        n->changeDate.month,
-                        n->changeDate.day,
-                        n->changeDate.hour,
-                        n->changeDate.min,
-                        n->changeDate.sec);
-                
-    }
-    QString imgname = QString("%1/%2.png").arg(NotepadConduitSettings::outputDirectory()).arg(filename);
-    
-    
-#ifdef DEBUG
 	DEBUGCONDUIT << fname << ": Notepad " << imgname << endl;
 #endif
 	if(!image.save(imgname, "PNG", -1))
Index: kpilot/conduits/notepadconduit/notepad-conduit.h
===================================================================
--- kpilot/conduits/notepadconduit/notepad-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,7 +4,7 @@
 **
 ** Copyright (C) 2004 by Adriaan de Groot, Joern Ahrens, Angus Ainslie
 **
-** The code for NotepadActionThread::unpackNotePad was taken from 
+** The code for NotepadActionThread::unpackNotePad was taken from
 ** Angus Ainslies read-notepad.c, which is part of pilot-link.
 ** NotepadActionThread::saveImage is also based on read-notepad.c.
 **
@@ -42,15 +42,15 @@
 class NotepadConduit : public ConduitAction
 {
 public:
-	NotepadConduit(KPilotDeviceLink *,
+	NotepadConduit(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~NotepadConduit();
 	virtual bool event(QEvent *e);
-	
+
 protected:
 	virtual bool exec();           // From ConduitAction
-	
+
 private:
 	NotepadActionThread *thread;
 };
@@ -62,15 +62,16 @@
 class NotepadActionThread : public QThread
 {
 public:
-	NotepadActionThread(QObject *parent, int pilotSocket);
+	NotepadActionThread(QObject *parent, KPilotLink *link);
 
 	virtual void run();
 	int	getFailed() { return notSaved; }
 	int getSaved() { return saved; }
-		
+
 private:
 	QObject *fParent;
-	int fPilotSocket;
+	KPilotLink *fLink;
+
 	/**
 	 * counts how many notepads couldn't be saved during the sync
 	 */
@@ -79,8 +80,14 @@
 	 * counts how many files a saved during the sync
 	 */
 	int saved;
-	
+
 	int unpackNotePad(struct NotePad *a, unsigned char *buffer, int len);
+
+	/**
+	* Saves a single NotePad structure to disk, using the name in
+	* the Note @p n, or if no name is specified, using the
+	* timestamp in the note.
+	*/
 	void saveImage(struct NotePad *n);
 };
 
Index: kpilot/conduits/notepadconduit/notepad-factory.cc
===================================================================
--- kpilot/conduits/notepadconduit/notepad-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -36,24 +36,14 @@
 #include <qlineedit.h>
 
 #include "uiDialog.h"
+#include "pluginfactory.h"
 
 #include "notepad-conduit.h"     // Conduit action
 #include "notepad-setup.h"
-#include "notepad-factory.moc"
 #include "notepadconduit.h"     // Settings class
 
-extern "C"
-{
-
-void *init_conduit_notepad()
-{
-	return new NotepadConduitFactory;
-}
-
-}
-
 //----------------------------------------------------------------------------
-// Conduit Confuguration
+// Conduit Configuration
 //----------------------------------------------------------------------------
 class NotepadConduitConfig : public ConduitConfigBase
 {
@@ -62,26 +52,47 @@
 	virtual void commit();
 	virtual void load();
 	static ConduitConfigBase *create(QWidget *p, const char *n)
-	{ 
-		return new NotepadConduitConfig(p, n); 
+	{
+		return new NotepadConduitConfig(p, n);
 	};
-	
+
 protected:
 	NotepadWidget *fConfigWidget;
 } ;
 
+static KAboutData *createAbout()
+{
+	FUNCTIONSETUP;
+
+	KAboutData *fAbout = new KAboutData("NotepadConduit",
+		I18N_NOOP("Saves notepads to png files"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the Notepad Conduit for KPilot"),
+		KAboutData::License_LGPL,
+		"(C) 2004, Joern Ahrens");
+	fAbout->addAuthor("Joern Ahrens",
+		I18N_NOOP("Primary Author"),
+		"kde@jokele.de",
+		"http://www.jokele.de/");
+	fAbout->addCredit("Adriaan de Groot");
+	fAbout->addCredit("Angus Ainslies",
+		I18N_NOOP("Notepad conduit is based on Angus' read-notepad, part of pilot-link" ));
+	return fAbout;
+}
+
+
 NotepadConduitConfig::NotepadConduitConfig(QWidget *p, const char *n) :
 	ConduitConfigBase(p, n),
 	fConfigWidget(new NotepadWidget(p))
 {
 	FUNCTIONSETUP;
-	
+
 	fConduitName = i18n("Notepad");
-	UIDialog::addAboutPage(fConfigWidget->tabWidget, NotepadConduitFactory::about());
+	UIDialog::addAboutPage(fConfigWidget->tabWidget, createAbout());
 	fWidget=fConfigWidget;
 	QObject::connect(fConfigWidget->fOutputDirectory, SIGNAL(textChanged(const QString&)),
 		this, SLOT(modified()));
-	fConfigWidget->fOutputDirectory->setMode(KFile::Directory | 
+	fConfigWidget->fOutputDirectory->setMode(KFile::Directory |
 											KFile::LocalOnly);
 }
 
@@ -96,85 +107,19 @@
 /* virtual */ void NotepadConduitConfig::load()
 {
 	FUNCTIONSETUP;
-	
+
 	NotepadConduitSettings::self()->readConfig();
 	fConfigWidget->fOutputDirectory->setURL(NotepadConduitSettings::outputDirectory());
 	fModified=false;
 }
 
-//----------------------------------------------------------------------------
-// Conduit Factory
-//----------------------------------------------------------------------------
-KAboutData *NotepadConduitFactory::fAbout = 0L;
-
-NotepadConduitFactory::NotepadConduitFactory(QObject *p, const char *n) :
-	KLibFactory(p,n)
+extern "C"
 {
-	FUNCTIONSETUP;
 
-	fInstance = new KInstance("notepadconduit");
-	fAbout = new KAboutData("NotepadConduit",
-		I18N_NOOP("Saves notepads to png files"),
-		KPILOT_VERSION,
-		I18N_NOOP("Configures the Notepad Conduit for KPilot"),
-		KAboutData::License_LGPL,
-		"(C) 2004, Joern Ahrens");
-	fAbout->addAuthor("Joern Ahrens",
-		I18N_NOOP("Primary Author"),
-		"kde@jokele.de",
-		"http://www.jokele.de/");
-	fAbout->addCredit("Adriaan de Groot");
-	fAbout->addCredit("Angus Ainslies", 
-		I18N_NOOP("Notepad conduit is based on Angus' read-notepad, part of pilot-link" ));
-}
-
-NotepadConduitFactory::~NotepadConduitFactory()
+void *init_conduit_notepad()
 {
-	FUNCTIONSETUP;
-
-	KPILOT_DELETE(fInstance);
-	KPILOT_DELETE(fAbout);
+	return new ConduitFactory<NotepadConduitConfig,NotepadConduit>(0,"abbrowserconduit");
 }
 
-/* virtual */ QObject *NotepadConduitFactory::createObject( QObject *parent,
-	const char *name, const char *className, const QStringList &args)
-{
-	FUNCTIONSETUP;
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< className
-		<< endl;
-#endif
-
-	if(qstrcmp(className, "ConduitConfigBase") == 0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(parent);
-		if (w) {
-			return new NotepadConduitConfig(w);
-		}
-		else {
-			return 0L;
-		}
-	}
-
-	if(qstrcmp(className, "SyncAction") == 0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(parent);
-
-		if (d) {
-			return new NotepadConduit(d, name, args);
-		}
-		else {
-			kdError() << k_funcinfo
-				<< ": Couldn't cast to KPilotDeviceLink"
-				<< endl;
-			return 0L;
-		}
-	}
-
-	return 0L;
 }
 
-
Index: kpilot/conduits/notepadconduit/notepad-setup.ui
===================================================================
--- kpilot/conduits/notepadconduit/notepad-setup.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-setup.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -71,9 +71,9 @@
     </grid>
 </widget>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/notepadconduit/notepad-conduit.desktop
===================================================================
--- kpilot/conduits/notepadconduit/notepad-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,12 +27,13 @@
 Comment[es]=Este conducto copia los dibujos del bloc de notas en una carpeta local.
 Comment[et]=See kanal teeb NotePadi joonistustest varukoopia kohalikku kataloogi.
 Comment[eu]=Kanal honek Ohar-blokaren marrazkiak karpeta lokal batera gordetzen ditu.
-Comment[fa]=این لوله، ترسیمهای NotePad را در یک پوشۀ محلی پشتیبانی می‌کند.
+Comment[fa]=این لوله، ترسیمهای NotePad را در پوشه‌ای محلی پشتیبانی می‌کند.
 Comment[fi]=Tämä yhdyskäytävä tekee varmuuskopion NotePad -piirroksista paikalliseen kansioon.
 Comment[fr]=Ce conduit sauvegarde les dessins (Notes) dans un dossier local
+Comment[gl]=Este conducto pon de volta os debuxos do NotePad a un cartafol local.
 Comment[hu]=Bővítőmodul NotePad-rajzok helyi könyvtárba való lementéséhez.
 Comment[is]=Þessi rás afritar NotePad teikningar í staðbundna möppu.
-Comment[it]=Questo conduit archivia i disegni NotePad drawings in una cartella locale.
+Comment[it]=Questo conduit archivia i disegni NotePad in una cartella locale.
 Comment[ja]=このコンジットは NotePad の絵をローカルのフォルダにバックアップします。
 Comment[km]=បំពង់​នេះ​អាច​បម្រុង​ទុក​គំនូរ NotePad ទៅ​ថត​មូលដ្ឋាន ។
 Comment[lt]=Šis kanalas padaro NotePad piešinių atsargines kopijas į vietinį aplanką.
Index: kpilot/conduits/notepadconduit/notepad-factory.h
===================================================================
--- kpilot/conduits/notepadconduit/notepad-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/notepadconduit/notepad-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,31 +28,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include <klibloader.h>
-
-class KInstance;
-class KAboutData;
-
-class NotepadConduitFactory : public KLibFactory
-{
-Q_OBJECT
-
-public:
-	NotepadConduitFactory(QObject * = 0L, const char * = 0L);
-	virtual ~NotepadConduitFactory();
-
-	static KAboutData *about() { return fAbout; } ;
-
-protected:
-	virtual QObject* createObject(QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList());
-private:
-	KInstance *fInstance;
-	static KAboutData *fAbout;
-} ;
-
 extern "C"
 {
 
Index: kpilot/conduits/notepadconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/notepadconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/notepadconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,38 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_notepad_SRCS
+	notepad-factory.cc
+	notepad-conduit.cc
+)
+
+set(conduit_notepad_UIS
+	notepad-setup.ui
+)
+
+set(conduit_notepad_KCFGS
+	notepadconduit.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_notepad_SRCS ${conduit_notepad_KCFGS})
+kde3_add_ui_files(conduit_notepad_SRCS ${conduit_notepad_UIS})
+kde3_automoc(${conduit_notepad_SRCS})
+add_library(conduit_notepad SHARED ${conduit_notepad_SRCS})
+
+set_target_properties(
+	conduit_notepad PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_notepad)
+
+install(
+	TARGETS conduit_notepad
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES notepad-conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/notepadconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile.in
   + .deps
.libs
Makefile.in
Makefile
*.moc
notepadconduit.cc
notepadconduit.h
notepad-setup.cc
notepad-setup.h



Index: kpilot/conduits/memofileconduit/memofile.cc
===================================================================
--- kpilot/conduits/memofileconduit/memofile.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,13 +28,10 @@
 #include "memofile.h"
 
 Memofile::Memofile(PilotMemo * memo, QString categoryName, QString fileName, QString baseDirectory) :
-		PilotMemo(memo->text()), _categoryName(categoryName), _filename(fileName),  _baseDirectory(baseDirectory)
+		PilotMemo(memo,memo->text()), _categoryName(categoryName), _filename(fileName),  _baseDirectory(baseDirectory)
 {
 	_lastModified = 0;
 	_size = 0;
-	setAttributes(memo->attributes());
-	PilotAppCategory::setCategory(memo->category());
-	setID(memo->id());
 	_modified = _modifiedByPalm = false;
 }
 
@@ -44,7 +41,7 @@
 		_filename(fileName),_baseDirectory(baseDirectory)
 {
 	setID(id);
-	PilotAppCategory::setCategory(category);
+	PilotRecordBase::setCategory(category);
 	_lastModified = lastModifiedTime;
 	_size = size;
 	_modified = _modifiedByPalm = false;
@@ -56,7 +53,7 @@
 {
 	setID(0);
 	_new = true;
-	PilotAppCategory::setCategory(category);
+	PilotRecordBase::setCategory(category);
 	_modified = true;
 	_modifiedByPalm = false;
 	_lastModified = 0;
Index: kpilot/conduits/memofileconduit/memofile-conduit.cc
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,13 +29,6 @@
 
 #include "options.h"
 
-// Something to allow us to check what revision
-// the modules are that make up a binary distribution.
-//
-//
-static const char *memofile_conduit_id=
-    "$Id$";
-
 // Only include what we really need:
 // First UNIX system stuff, then std C++,
 // then Qt, then KDE, then local includes.
@@ -55,7 +48,7 @@
 #include <kconfig.h>
 #include <kdebug.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "pilotSerialDatabase.h"
 #include "memofile-factory.h"
 #include "memofile-conduit.h"
@@ -65,7 +58,7 @@
 /**
  * Our workhorse.  This is the main driver for the conduit.
  */
-MemofileConduit::MemofileConduit(KPilotDeviceLink *d,
+MemofileConduit::MemofileConduit(KPilotLink *d,
                                  const char *n,
                                  const QStringList &l) :
 		ConduitAction(d,n,l),
@@ -74,9 +67,6 @@
 		_memofiles(0L)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<memofile_conduit_id<<endl;
-#endif
 	fConduitName=i18n("Memofile");
 	fMemoList.setAutoDelete(true);
 }
@@ -195,7 +185,7 @@
 
 	fCategories = map;
 
-	for (int i = 0; i < PILOT_CATEGORY_MAX; i++)
+	for (unsigned int i = 0; i < Pilot::CATEGORY_COUNT; i++)
 	{
 		if (fCategories.contains(i)) {
 			QString name = fCategories[i].left(16);
@@ -272,9 +262,9 @@
 	int _category_id=0;
 	int _category_num=0;
 
-	for (int i = 0; i < PILOT_CATEGORY_MAX; i++)
+	for (unsigned int i = 0; i < Pilot::CATEGORY_COUNT; i++)
 	{
-		_category_name = fMemoAppInfo->category(i);
+		_category_name = fMemoAppInfo->categoryName(i);
 		if (!_category_name.isEmpty())
 		{
 			_category_name = Memofiles::sanitizeName( _category_name );
@@ -360,7 +350,7 @@
 }
 
 /**
- *  Read all memos in from Pilot.
+ *  Read all modified memos in from Pilot.
  */
 void MemofileConduit::getModifiedFromPilot()
 {
@@ -504,8 +494,8 @@
 	FUNCTIONSETUP;
 	if ( syncMode()==SyncMode::eCopyPCToHH )
 	{
-		RecordIDList ids=fDatabase->idList();
-		RecordIDList::iterator it;
+		Pilot::RecordIDList ids=fDatabase->idList();
+		Pilot::RecordIDList::iterator it;
 		for ( it = ids.begin(); it != ids.end(); ++it )
 		{
 			if (!_memofiles->find(*it))
Index: kpilot/conduits/memofileconduit/memofile-conduit.h
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -38,7 +38,7 @@
 {
 Q_OBJECT
 public:
-	MemofileConduit(KPilotDeviceLink *,
+	MemofileConduit(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~MemofileConduit();
Index: kpilot/conduits/memofileconduit/memofile-factory.cc
===================================================================
--- kpilot/conduits/memofileconduit/memofile-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,21 +39,11 @@
 
 #include "setup_base.h"
 #include "memofile-conduit.h"
-#include "memofile-factory.moc"
 #include "memofileSettings.h"
 #include "uiDialog.h"
 
+#include "pluginfactory.h"
 
-extern "C"
-{
-
-void *init_conduit_memofile()
-{
-	return new MemofileConduitFactory;
-}
-
-}
-
 class MemofileConduitConfig : public ConduitConfigBase
 {
 public:
@@ -70,7 +60,18 @@
 {
 	FUNCTIONSETUP;
 	fConduitName = i18n("Memofile");
-	UIDialog::addAboutPage(fConfigWidget->tabWidget,MemofileConduitFactory::about());
+	KAboutData *about = new KAboutData("MemofileConduit",
+		I18N_NOOP("Memofile Conduit for KPilot"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the Memofile Conduit for KPilot"),
+		KAboutData::License_GPL,
+		"(C) 2004, Jason 'vanRijn' Kasper");
+	about->addAuthor("Jason 'vanRijn' Kasper",
+		I18N_NOOP("Primary Author"),
+		"vR@movingparts.net",
+		"http://www.cs.kun.nl/~adridg/kpilot");
+
+	UIDialog::addAboutPage(fConfigWidget->tabWidget,about);
 	fWidget=fConfigWidget;
 	QObject::connect(fConfigWidget->fDirectory,SIGNAL(textChanged(const QString&)),
 		this,SLOT(modified()));
@@ -116,77 +117,17 @@
 	unmodified();
 }
 
-KAboutData *MemofileConduitFactory::fAbout = 0L;
-MemofileConduitFactory::MemofileConduitFactory(QObject *p, const char *n) :
-	KLibFactory(p,n)
-{
-	FUNCTIONSETUP;
 
-	fInstance = new KInstance("Memofileconduit");
-	fAbout = new KAboutData("MemofileConduit",
-		I18N_NOOP("Memofile Conduit for KPilot"),
-		KPILOT_VERSION,
-		I18N_NOOP("Configures the Memofile Conduit for KPilot"),
-		KAboutData::License_GPL,
-		"(C) 2004, Jason 'vanRijn' Kasper");
-	fAbout->addAuthor("Jason 'vanRijn' Kasper",
-		I18N_NOOP("Primary Author"),
-		"vR@movingparts.net",
-		"http://www.cs.kun.nl/~adridg/kpilot");
-}
 
-MemofileConduitFactory::~MemofileConduitFactory()
+extern "C"
 {
-	FUNCTIONSETUP;
 
-	KPILOT_DELETE(fInstance);
-	KPILOT_DELETE(fAbout);
+void *init_conduit_memofile()
+{
+	return new ConduitFactory<MemofileConduitConfig,MemofileConduit>(0,"memofileconduit");
 }
 
-/* virtual */ QObject *MemofileConduitFactory::createObject( QObject *p,
-	const char *n,
-	const char *c,
-	const QStringList &a)
-{
-	FUNCTIONSETUP;
+unsigned long version_conduit_memofile = Pilot::PLUGIN_API;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< c
-		<< endl;
-#endif
-
-	if (qstrcmp(c,"ConduitConfigBase")==0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(p);
-		if (w)
-		{
-			return new MemofileConduitConfig(w);
-		}
-		else
-		{
-			return 0L;
-		}
-	}
-	else if (qstrcmp(c,"SyncAction")==0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
-
-		if (d)
-		{
-			return new MemofileConduit(d,n,a);
-		}
-		else
-		{
-			kdError() << k_funcinfo
-				<< ": Couldn't cast to KPilotDeviceLink"
-				<< endl;
-			return 0L;
-		}
-	}
-
-	return 0L;
 }
 
-
Index: kpilot/conduits/memofileconduit/setup_base.ui
===================================================================
--- kpilot/conduits/memofileconduit/setup_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/setup_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -135,9 +135,9 @@
     <tabstop>tabWidget</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/memofileconduit/memofile-conduit.desktop
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Name[fi]=Muistiotiedosto
 Name[fr]=Fichier mémo
 Name[ga]=Comhad Meamraim
+Name[gl]=Ficheiro Memo
 Name[hu]=Memófájl
 Name[is]=Minnismiðaskrá
 Name[it]=File appunti
@@ -47,9 +48,10 @@
 Comment[es]=Este conducto sincroniza las notas de su agenda electrónica con el directorio local.
 Comment[et]=See kanal sünkroniseerib pihuarvutis ja arvutis olevad memod.
 Comment[eu]=Kanal honek zure agendako oharrak direktorio lokal batekin sinkronizatzen ditu.
-Comment[fa]=این لوله، memo‌های دستی خود را با یک فهرست راهنمای محلی همگام‌سازی کنید.
+Comment[fa]=این لوله، memo‌های دستی خود را با فهرست راهنمای محلی همگام‌سازی می‌کند.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen muistiot paikalliseen kansioon.
 Comment[fr]=Ce canal synchronise les mémos du Palm avec ceux de KDE.
+Comment[gl]=Este conducto sincroniza os memos do seu aparello portátil cun cartafol local.
 Comment[hu]=Ezzel a csatolóval egy kézi számítógép memóit lehet szinkronizálni a helyi címjegyzékkel.
 Comment[is]=Þessi rás samstillir minnismiða lófatölvunnar þinnar við staðbundna möppu.
 Comment[it]=Questo condotto sincronizza gli appunti del tuo palmare con una cartella locale.
Index: kpilot/conduits/memofileconduit/memofile-factory.h
===================================================================
--- kpilot/conduits/memofileconduit/memofile-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/memofileconduit/memofile-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,34 +29,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include <klibloader.h>
 
-#include "plugin.h"
-
-class MemofileWidget;
-class KInstance;
-class KAboutData;
-
-class MemofileConduitFactory : public KLibFactory
-{
-Q_OBJECT
-
-public:
-	MemofileConduitFactory(QObject * = 0L,const char * = 0L);
-	virtual ~MemofileConduitFactory();
-
-	static KAboutData *about() { return fAbout; } ;
-
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() );
-private:
-	KInstance *fInstance;
-	static KAboutData *fAbout;
-} ;
-
 extern "C"
 {
 
Index: kpilot/conduits/memofileconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/memofileconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/memofileconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,40 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_memofile_SRCS
+	memofile-factory.cc
+	memofile.cc
+	memofiles.cc
+	memofile-conduit.cc
+)
+
+set(conduit_memofile_UIS
+	setup_base.ui
+)
+
+set(conduit_memofile_KCFGS
+	memofileSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_memofile_SRCS ${conduit_memofile_KCFGS})
+kde3_add_ui_files(conduit_memofile_SRCS ${conduit_memofile_UIS})
+kde3_automoc(${conduit_memofile_SRCS})
+add_library(conduit_memofile SHARED ${conduit_memofile_SRCS})
+
+set_target_properties(
+	conduit_memofile PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_memofile)
+
+install(
+	TARGETS conduit_memofile
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES memofile-conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/memofileconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
Doxyfile
   + .deps
.libs
Makefile
Makefile.in
Doxyfile
*.moc
setup_base.h
setup_base.cc
memofileSettings.h
memofileSettings.cc



Index: kpilot/conduits/timeconduit/time-conduit.cc
===================================================================
--- kpilot/conduits/timeconduit/time-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/timeconduit/time-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,6 +29,8 @@
 
 #include <time.h>
 
+#include <pilotSysInfo.h>
+
 #include <kconfig.h>
 #include <kdebug.h>
 
@@ -41,22 +43,17 @@
 // the modules are that make up a binary distribution.
 extern "C"
 {
-long version_conduit_time = KPILOT_PLUGIN_API ;
-const char *id_conduit_time =
-	"$Id$";
+unsigned long version_conduit_time = Pilot::PLUGIN_API ;
 }
 
 
 
-TimeConduit::TimeConduit(KPilotDeviceLink * o,
+TimeConduit::TimeConduit(KPilotLink * o,
 	const char *n,
 	const QStringList & a) :
 	ConduitAction(o, n, a)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<id_conduit_time<<endl;
-#endif
 	fConduitName=i18n("Time");
 }
 
@@ -79,7 +76,6 @@
 /* virtual */ bool TimeConduit::exec()
 {
 	FUNCTIONSETUP;
-	DEBUGCONDUIT<<id_conduit_time<<endl;
 
 	readConfig();
 
@@ -103,9 +99,9 @@
 	FUNCTIONSETUP;
 	time_t ltime;
 	time(&ltime);
-	QDateTime time=QDateTime::currentDateTime();
 
-	long int major=fHandle->majorVersion(), minor=fHandle->minorVersion();
+	long int major=fHandle->getSysInfo().getMajorVersion(), 
+		 minor=fHandle->getSysInfo().getMinorVersion();
 
 	if (major==3 && (minor==25 || minor==30))
 	{
@@ -113,9 +109,13 @@
 		return;
 	}
 
-	fHandle->setTime(ltime);
-#ifdef DEBUG
-	time.setTime_t(ltime);
-	DEBUGCONDUIT<<fname<<": synced time "<<time.toString()<<" to the handheld"<<endl;
-#endif
+	int sd = pilotSocket();
+	if ( sd > 0 )
+	{
+		dlp_SetSysDateTime( sd, ltime );
+	}
+	else
+	{
+		kdWarning() << k_funcinfo << ": Link is not a real device." << endl;
+	}
 }
Index: kpilot/conduits/timeconduit/time-conduit.h
===================================================================
--- kpilot/conduits/timeconduit/time-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/timeconduit/time-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -34,7 +34,7 @@
 {
 public:
 	TimeConduit(
-		KPilotDeviceLink *o,
+		KPilotLink *o,
 		const char *n = 0L,
 		const QStringList &a = QStringList() );
 	virtual ~TimeConduit();
Index: kpilot/conduits/timeconduit/time_conduit.desktop
===================================================================
--- kpilot/conduits/timeconduit/time_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/timeconduit/time_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=این لوله، از طریق ساعت PC زمان دستی شما را تنظیم می‌کند.
 Comment[fi]=Tämä yhdyskäytävä asettaa taskutietokoneen kellonajan PC:n kellosta.
 Comment[fr]=Ce canal règle l'heure de votre périphérique depuis celle du PC.
+Comment[gl]=Este conducto pon a hora do seu aparello portátil dende o reloxo do seu PC.
 Comment[hi]=यह कन्ड्यूइट आपके हैंण्डहेल्ड में पीसी घड़ी द्वारा समय नियत करता है.
 Comment[hu]=Ez a csatoló beállítja a kéziszámítógép óráját a számítógépé alapján
 Comment[is]=Þessi rás stillir klukku lófatölvunnar eftir klukku PC tölvunnar.
@@ -55,7 +56,7 @@
 Name[es]=Sincronización de hora
 Name[et]=Aja sünkroniseerimine
 Name[eu]=Ordu sinkronizazioa
-Name[fa]=همگام‌سازی زمان 
+Name[fa]=همگام‌سازی زمان
 Name[fi]=Ajan synkronointi
 Name[fr]=Synchronisation de l'heure
 Name[gl]=Sincronización Horaria
Index: kpilot/conduits/timeconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/timeconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/timeconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,40 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_time_SRCS
+	time-conduit.cc
+	time-factory.cc
+	time-setup.cc
+)
+
+set(conduit_time_UIS
+	time-setup_dialog.ui
+)
+
+set(conduit_time_KCFGS
+	timeConduitSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_time_SRCS ${conduit_time_KCFGS})
+kde3_add_ui_files(conduit_time_SRCS ${conduit_time_UIS})
+kde3_automoc(${conduit_time_SRCS})
+add_library(conduit_time SHARED ${conduit_time_SRCS})
+
+kpilot_rpath(conduit_time)
+
+set_target_properties(
+	conduit_time PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_time)
+
+install(
+	TARGETS conduit_time
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES time_conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/timeconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
time-setup_dialog.h
time-setup_dialog.cc
   + .deps
.libs
Makefile
Makefile.in
*.moc
time-setup_dialog.h
time-setup_dialog.cc
timeConduitSettings.cc
timeConduitSettings.h



Index: kpilot/conduits/docconduit/pilotDOCEntry.cc
===================================================================
--- kpilot/conduits/docconduit/pilotDOCEntry.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCEntry.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,12 +31,10 @@
 
 
 
-static const char *pilotDOCEntry_id =
-	"$Id$";
 const int PilotDOCEntry::TEXT_SIZE = 4096;
 
 
-PilotDOCEntry::PilotDOCEntry():PilotAppCategory()
+PilotDOCEntry::PilotDOCEntry():PilotRecordBase()
 {
 	FUNCTIONSETUP;
 	compress = false;
@@ -46,16 +44,15 @@
 
 /* initialize the entry from another one. If rec==NULL, this constructor does the same as PilotDOCEntry()
 */
-PilotDOCEntry::PilotDOCEntry(PilotRecord * rec, bool compressed):PilotAppCategory(rec)
+PilotDOCEntry::PilotDOCEntry(PilotRecord * rec, bool compressed):PilotRecordBase(rec)
 {
 	if (rec) fText.setText((unsigned char *) rec->data(), rec->size(), compressed);
 	compress = compressed;
-	(void) pilotDOCEntry_id;
 }
 
 
 
-PilotDOCEntry::PilotDOCEntry(const PilotDOCEntry & e):PilotAppCategory(e)
+PilotDOCEntry::PilotDOCEntry(const PilotDOCEntry & e):PilotRecordBase(e)
 {
 	FUNCTIONSETUP;
 	// See PilotDateEntry::operator = for details
@@ -77,24 +74,19 @@
 
 
 
-void *PilotDOCEntry::pack_(void *buf, int *len)
+
+PilotRecord *PilotDOCEntry::pack()
 {
-//      int len;
-	if (compress)
+	int len = compress ? fText.Compress() : fText.Decompress();
+
+	if (len<0)
 	{
-		*len = fText.Compress();
+		return 0L;
 	}
-	else
-	{
-		*len = fText.Decompress();
-	}
-	if (len > 0)
-	{
-//              char*out=new char[len];
-		memcpy(buf, (const char *) fText.text(), *len);
-		return buf;
-	}
-	return 0L;
-}
 
-
+	pi_buffer_t *b = pi_buffer_new( len + 4 ); // +4 for safety
+	memcpy( b->data, (const char *) fText.text(), len );
+	b->used = len;
+	PilotRecord* rec =  new PilotRecord(b, this);
+	return rec;
+}
Index: kpilot/conduits/docconduit/pilotDOCHead.cc
===================================================================
--- kpilot/conduits/docconduit/pilotDOCHead.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCHead.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,31 +32,34 @@
 
 
 
-static const char *pilotDOCHead_id =
-	"$Id$";
 const int PilotDOCHead::textRecordSize = 4096;
 
-
-
-PilotDOCHead::PilotDOCHead():PilotAppCategory(),
+PilotDOCHead::PilotDOCHead():PilotRecordBase(),
 version(0),
 spare(0), storyLen(0), numRecords(0), recordSize(textRecordSize), position(0)
 {
 	FUNCTIONSETUP;
-	(void) pilotDOCHead_id;
 }
 
 
 
 /* initialize the entry from another one. If rec==NULL, this constructor does the same as PilotDOCHead()
 */
-PilotDOCHead::PilotDOCHead(PilotRecord * rec):PilotAppCategory(rec)
+PilotDOCHead::PilotDOCHead(PilotRecord * rec):PilotRecordBase(rec)
 {
-	unpack((const void *) rec->data());
+	const unsigned char *b = (const unsigned char *) rec->data();
+	unsigned int offset = 0;
+
+	version = dlp<short>::read(b,offset);
+	spare = dlp<short>::read(b,offset);
+	storyLen = dlp<long>::read(b,offset);
+	numRecords = dlp<short>::read(b,offset);
+	recordSize = dlp<short>::read(b,offset);
+	position = dlp<long>::read(b,offset);
 }
 
 
-PilotDOCHead::PilotDOCHead(const PilotDOCHead & e):PilotAppCategory(e)
+PilotDOCHead::PilotDOCHead(const PilotDOCHead & e):PilotRecordBase(e)
 {
 	FUNCTIONSETUP;
 	*this = e;
@@ -80,40 +83,19 @@
 
 
 
-void *PilotDOCHead::pack_(void *buf, int *len)
-{
-	char *tmp = (char *) buf;
 
-	*len = 16;
-	set_short(tmp, version);
-	tmp+=2;
-	set_short(tmp, spare);
-	tmp+=2;
-	set_long(tmp, storyLen);
-	tmp+=4;
-	set_short(tmp, numRecords);
-	tmp+=2;
-	set_short(tmp, recordSize);
-	tmp+=2;
-	set_short(tmp, position);
-	return buf;
-}
-
-
-void PilotDOCHead::unpack(const void *buf, int)
+PilotRecord *PilotDOCHead::pack() const
 {
-	char *tmp = (char *) buf;
+	pi_buffer_t *b = pi_buffer_new(16);
 
-	version = get_short(tmp);
-	tmp+=2;
-	spare = get_short(tmp);
-	tmp+=2;
-	storyLen = get_long(tmp);
-	tmp+=4;
-	numRecords = get_short(tmp);
-	tmp+=2;
-	recordSize = get_short(tmp);
-	tmp+=2;
-	position = get_long(tmp);
+	dlp<short>::append(b,version);
+	dlp<short>::append(b,spare);
+	dlp<long>::append(b,storyLen);
+	dlp<short>::append(b,numRecords);
+	dlp<short>::append(b,recordSize);
+	dlp<long>::append(b,position);
+
+	PilotRecord *rec =  new PilotRecord(b, this);
+	return rec;
 }
 
Index: kpilot/conduits/docconduit/pilotDOCEntry.h
===================================================================
--- kpilot/conduits/docconduit/pilotDOCEntry.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCEntry.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,7 +18,7 @@
 **
 ** You should have received a copy of the GNU General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -28,14 +28,14 @@
 #ifndef _KPILOT_PILOTDOCENTRY_H
 #define _KPILOT_PILOTDOCENTRY_H
 
-#include <pilotAppCategory.h>
+#include <pilotRecord.h>
 #include "makedoc9.h"
 
 
 class PilotRecord;
 
 
-class PilotDOCEntry:public PilotAppCategory {
+class PilotDOCEntry:public PilotRecordBase {
 private:
 	bool compress;
 	tBuf fText;
@@ -64,10 +64,7 @@
 		compress = compressed;
 	};
 
-protected:
-	void *pack_(void *, int *);
-	void unpack(const void *, int = 0) {
-	}
+	PilotRecord *pack(); // Not const because it can change the compression
 };
 
 
Index: kpilot/conduits/docconduit/pilotDOCHead.h
===================================================================
--- kpilot/conduits/docconduit/pilotDOCHead.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCHead.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,7 +18,7 @@
 **
 ** You should have received a copy of the GNU General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -28,12 +28,12 @@
 #ifndef _KPILOT_PILOTDOCHEAD_H
 #define _KPILOT_PILOTDOCHEAD_H
 
-#include <pilotAppCategory.h>
+#include <pilotRecord.h>
 
 class PilotRecord;
 
 
-class PilotDOCHead:public PilotAppCategory {
+class PilotDOCHead:public PilotRecordBase {
  private:
 	static const int textRecordSize;
 
@@ -45,17 +45,15 @@
 	int recordSize;
 	long int position;
 
+	PilotRecord *pack() const;
+
  public:
 	 PilotDOCHead();
 	 PilotDOCHead(PilotRecord * rec);
 	 PilotDOCHead(const PilotDOCHead & e);
-	~PilotDOCHead() {
-	} PilotDOCHead & operator=(const PilotDOCHead & e);
+	~PilotDOCHead() { }
 
-
- protected:
-	void *pack_(void *, int *);
-	void unpack(const void *, int = 0);
+	PilotDOCHead & operator=(const PilotDOCHead & e);
 };
 
 
Index: kpilot/conduits/docconduit/doc-conduit.cc
===================================================================
--- kpilot/conduits/docconduit/doc-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,8 +56,7 @@
 // the modules are that make up a binary distribution.
 extern "C"
 {
-long version_conduit_doc = KPILOT_PLUGIN_API;
-const char *id_conduit_doc = "$Id$";
+unsigned long version_conduit_doc = Pilot::PLUGIN_API;
 }
 
 QString dirToString(eSyncDirectionEnum dir) {
@@ -78,13 +77,10 @@
  *********************************************************************/
 
 
-DOCConduit::DOCConduit(KPilotDeviceLink * o,
+DOCConduit::DOCConduit(KPilotLink * o,
 	const char *n, const QStringList & a):ConduitAction(o, n, a)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<id_conduit_doc<<endl;
-#endif
 	fConduitName=i18n("DOC");
 }
 
@@ -269,9 +265,6 @@
 /* virtual */ bool DOCConduit::exec()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<"Conduit version: "<<id_conduit_doc<<endl;
-#endif
 
 	readConfig();
 	dbnr=0;
@@ -316,8 +309,7 @@
 			}
 		}
 		if (!DOCConduitSettings::localSync()) {
-			PilotDatabase *database=new PilotSerialDatabase(pilotSocket(),
-				QString::fromLatin1(sinfo.dbinfo.name));
+			PilotDatabase *database=deviceLink()->database( sinfo.dbinfo.name );
 			if ( database->deleteDatabase() !=0 ) {
 					kdWarning()<<"Unable to delete database "<<sinfo.dbinfo.name<<" from the handheld"<<endl;
 			}
@@ -330,7 +322,7 @@
 	// instance which points either to a local database or a database on the handheld.
 	PilotDatabase *database = preSyncAction(sinfo);
 
-	if (database && ( !database->isDBOpen() ) ) {
+	if (database && ( !database->isOpen() ) ) {
 #ifdef DEBUG
 		DEBUGCONDUIT<<"Database "<<sinfo.dbinfo.name<<" does not yet exist. Creating it:"<<endl;
 #endif
@@ -342,7 +334,7 @@
 		}
 	}
 
-	if (database && database->isDBOpen()) {
+	if (database && database->isOpen()) {
 		DOCConverter docconverter;
 		connect(&docconverter, SIGNAL(logError(const QString &)), SIGNAL(logError(const QString &)));
 		connect(&docconverter, SIGNAL(logMessage(const QString &)), SIGNAL(logMessage(const QString &)));
@@ -692,9 +684,15 @@
 }
 
 
-PilotDatabase*DOCConduit::openDOCDatabase(QString dbname) {
-	if (DOCConduitSettings::localSync()) return new PilotLocalDatabase(DOCConduitSettings::pDBDirectory(), dbname, false);
-	else return new PilotSerialDatabase(pilotSocket(), dbname);
+PilotDatabase*DOCConduit::openDOCDatabase(const QString &dbname) {
+	if (DOCConduitSettings::localSync())
+	{
+		return new PilotLocalDatabase(DOCConduitSettings::pDBDirectory(), dbname, false);
+	}
+	else
+	{
+		return deviceLink()->database( dbname );
+	}
 }
 
 
@@ -720,7 +718,7 @@
 
 		if (QFile::exists(sinfo.txtfilename)) sinfo.fPCStatus=eStatNew;
 		else sinfo.fPCStatus=eStatDoesntExist;
-		if (docdb && docdb->isDBOpen()) sinfo.fPalmStatus=eStatNew;
+		if (docdb && docdb->isOpen()) sinfo.fPalmStatus=eStatNew;
 		else sinfo.fPalmStatus=eStatDoesntExist;
 		KPILOT_DELETE(docdb);
 
@@ -771,7 +769,7 @@
 #endif
 	}
 
-	if (!docdb || !docdb->isDBOpen()) sinfo.fPalmStatus=eStatDeleted;
+	if (!docdb || !docdb->isOpen()) sinfo.fPalmStatus=eStatDeleted;
 	else if (hhTextChanged(docdb)) {
 #ifdef DEBUG
 		DEBUGCONDUIT<<"Handheld side has changed!"<<endl;
@@ -928,8 +926,7 @@
 	}
 	else
 	{
-		return new PilotSerialDatabase(pilotSocket(),
-			QString::fromLatin1(dbinfo.name));
+		return deviceLink()->database(QString::fromLatin1(dbinfo.name));
 	}
 }
 
@@ -952,7 +949,7 @@
 #endif
 		if (DOCConduitSettings::keepPDBsLocally() && !DOCConduitSettings::localSync())
 		{
-			PilotSerialDatabase*db=new PilotSerialDatabase(pilotSocket(),
+			PilotDatabase*db=deviceLink()->database(
 				QString::fromLatin1(sinfo.dbinfo.name));
 #ifdef DEBUG
 			DEBUGCONDUIT<<"Middle 1 Resetting sync flags for database "
Index: kpilot/conduits/docconduit/DOC-converter.cc
===================================================================
--- kpilot/conduits/docconduit/DOC-converter.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/DOC-converter.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,10 +45,6 @@
 
 
 
-// Something to allow us to check what revision
-// the modules are that make up a binary distribution.
-const char *doc_converter_id = "$Id$";
-
 #define min(a,b) (a<b)?(a):(b)
 
 
@@ -154,7 +150,6 @@
 	docdb=0L;
 	eSortBookmarks=eSortNone;
 	fBookmarks.setAutoDelete( TRUE );
-	(void) doc_converter_id;
 }
 
 
@@ -441,7 +436,7 @@
 	}
 #endif
 
-	if (!docdb->isDBOpen()) {
+	if (!docdb->isOpen()) {
 		emit logError(i18n("Unable to open palm doc database %1").arg(docdb->dbPathName()) );
 		return false;
 	}
Index: kpilot/conduits/docconduit/doc_conduit.desktop
===================================================================
--- kpilot/conduits/docconduit/doc_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,10 +14,11 @@
 Comment[fa]=پرونده‌های متن را به دستی شما اضافه می‌کند، که برای خوانندگان DOC مفید است.
 Comment[fi]=Lisää tekstitiedostoja taskutietokoneeseen. Tämä on käyttökelpoinen DOC-lukijoille.
 Comment[fr]=Ajoute des fichiers texte à votre Palm, approprié pour les lecteurs de DOC.
+Comment[gl]=Engade ficheiros de texto ao seu aparello de man, axeitado para os lectores DOC.
 Comment[hu]=Szöveges fájlok hozzáadása a kézi számítógéphez, DOC-olvasók számára.
 Comment[is]=Bætir textaskrám, sem hægt er að lesa í DOC lesara, við lófatölvuna þína.
 Comment[it]=Aggiunge file di testo al tuo Pilot, adatti per lettori DOC.
-Comment[ja]=テキストファイルを DOC リーダに適した形式でハンドヘルドに追加します。
+Comment[ja]=テキストファイルを DOC リーダーに適した形式でハンドヘルドに追加します。
 Comment[km]=បន្ថែម​ឯកសារ​អត្ថបទ​ទៅ​ឧបករណ៍​យួរ​ដៃ​របស់​អ្នក (សមស្រប​សម្រាប់​កម្មវិធី​អាន DOC) ។
 Comment[lt]=Prideda teksto bylas prie Jūsų nešiojamos knygelės, tinka DOC skaityklėms.
 Comment[ms]=Menambah fail teks ke komputer telapak, sesuai dengan pembaca DOC.
Index: kpilot/conduits/docconduit/doc-conflictdialog.h
===================================================================
--- kpilot/conduits/docconduit/doc-conflictdialog.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-conflictdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,7 +39,7 @@
 class QLabel;
 class QPushButton;
 class QTimer;
-class KPilotDeviceLink;
+class KPilotLink;
 
 
 typedef struct conflictEntry {
@@ -56,7 +56,7 @@
 	Q_OBJECT
 
 public:
-	ResolutionDialog( QWidget* parent=0, const QString& caption=i18n("Resolution Dialog"), syncInfoList*sinfo=0L, KPilotDeviceLink*lnk=0L);
+	ResolutionDialog( QWidget* parent=0, const QString& caption=i18n("Resolution Dialog"), syncInfoList*sinfo=0L, KPilotLink*lnk=0L);
 	~ResolutionDialog();
 
 	bool hasConflicts;
@@ -64,7 +64,7 @@
 	void _tickle();
 protected:
 	QTimer* tickleTimer;
-	KPilotDeviceLink* fHandle;
+	KPilotLink* fHandle;
 
 protected:
 	QGroupBox* resolutionGroupBox;
Index: kpilot/conduits/docconduit/Icons/CMakeLists.txt
===================================================================
--- kpilot/conduits/docconduit/Icons/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/docconduit/Icons/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,3 @@
+
+kde3_install_icons_custom( hicolor )
+
Index: kpilot/conduits/docconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/docconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/docconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,83 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(doc_shared_SRCS
+	makedoc9.cc
+	pilotDOCHead.cc
+	pilotDOCEntry.cc
+	pilotDOCBookmark.cc
+	DOC-converter.cc
+)
+
+set(conduit_doc_SRCS
+	${doc_shared_SRCS}
+	kpalmdoc_dlg.cc
+	kpalmdoc.cpp
+	doc-factory.cc
+	doc-setup.cc
+	doc-conduit.cc
+	doc-conflictdialog.cc
+)
+
+set(conduit_doc_UIS
+	kpalmdoc_dlgbase.ui
+	doc-setupdialog.ui
+)
+
+set(conduit_doc_KCFGS
+	docconduitSettings.kcfgc
+	kpalmdocSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_doc_SRCS ${conduit_doc_KCFGS})
+kde3_add_ui_files(conduit_doc_SRCS ${conduit_doc_UIS})
+kde3_automoc(${conduit_doc_SRCS})
+add_library(conduit_doc SHARED ${conduit_doc_SRCS})
+
+kpilot_rpath(conduit_doc)
+
+set_target_properties(
+	conduit_doc PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_doc)
+
+install(
+	TARGETS conduit_doc
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+set(kpalmdoc_SRCS
+	${doc_shared_SRCS}
+	kpalmdoc_dlg.cc
+	kpalmdoc.cpp
+)
+kde3_add_kcfg_files(kpalmdoc_SRCS kpalmdocSettings.kcfgc)
+kde3_add_ui_files(kpalmdoc_SRCS kpalmdoc_dlgbase.ui)
+kde3_automoc(${kpalmdoc_SRCS})
+add_executable(kpalmdoc ${kpalmdoc_SRCS})
+target_link_libraries(kpalmdoc ${QT_LIBRARIES} kpilot)
+kpilot_rpath(kpalmdoc)
+
+install(
+	TARGETS kpalmdoc conduit_doc
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+	RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
+)
+
+install(
+	FILES doc_conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)
+
+install(
+	FILES docconduit.kcfg kpalmdoc.kcfg DESTINATION ${KDE3_KCFG_DIR}
+)
+
+install(
+	FILES kpalmdoc.upd
+	DESTINATION ${CMAKE_INSTALL_PREFIX}/share/apps/kconf_update
+)
+
+add_subdirectory(Icons)
Index: kpilot/conduits/docconduit/pilotDOCBookmark.cc
===================================================================
--- kpilot/conduits/docconduit/pilotDOCBookmark.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCBookmark.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,12 +31,7 @@
 
 
 
-static const char *pilotDOCBookmark_id =
-	"$Id$";
-
-
-
-PilotDOCBookmark::PilotDOCBookmark():PilotAppCategory(), pos(0)
+PilotDOCBookmark::PilotDOCBookmark():PilotRecordBase(), pos(0)
 {
 	FUNCTIONSETUP;
 	memset(&bookmarkName[0], 0, 16);
@@ -46,21 +41,21 @@
 
 /* initialize the entry from another one. If rec==NULL, this constructor does the same as PilotDOCBookmark()
 */
-PilotDOCBookmark::PilotDOCBookmark(PilotRecord * rec):PilotAppCategory(rec)
+PilotDOCBookmark::PilotDOCBookmark(PilotRecord * rec):PilotRecordBase(rec)
 {
 	if (rec)
 	{
-		strncpy(&bookmarkName[0], (char *) rec->data(), 16);
+		const pi_buffer_t *b = rec->buffer();
+		unsigned int offset = 0;
+		dlp<char *>::read(b,offset,bookmarkName,16);
 		bookmarkName[16]='\0';
-		pos = get_long(&rec->data()[16]);// << 8 + (rec->getData())[17];
+		pos = dlp<long>::read(b,offset);
 	}
-	(void) pilotDOCBookmark_id;
 }
 
 
 
-PilotDOCBookmark::
-PilotDOCBookmark(const PilotDOCBookmark & e):PilotAppCategory(e)
+PilotDOCBookmark::PilotDOCBookmark(const PilotDOCBookmark & e):PilotRecordBase(e)
 {
 	FUNCTIONSETUP;
 	*this = e;
@@ -81,15 +76,12 @@
 
 
 
-void *PilotDOCBookmark::pack_(void *buf, int *len)
+PilotRecord *PilotDOCBookmark::pack() const
 {
-	char *tmp = (char *) buf;
-
-//  buf=malloc(16*sizeof(char)+sizeof(long int));
-	strncpy(tmp, &bookmarkName[0], 16);
-	//*(long int *) (tmp + 16) = pos;
-	set_long(tmp + 16, pos);
-	*len = 20;
-	return buf;
+	pi_buffer_t *b = pi_buffer_new( 16 + dlp<long>::size );
+	pi_buffer_append(b, bookmarkName, 16);
+	b->data[16] = 0;
+	dlp<long>::append(b,pos);
+	PilotRecord* rec =  new PilotRecord(b, this);
+	return rec;
 }
-
Index: kpilot/conduits/docconduit/kpalmdoc_dlgbase.ui
===================================================================
--- kpilot/conduits/docconduit/kpalmdoc_dlgbase.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/kpalmdoc_dlgbase.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -427,14 +427,9 @@
     </connection>
 </connections>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/docconduit/pilotDOCBookmark.h
===================================================================
--- kpilot/conduits/docconduit/pilotDOCBookmark.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/pilotDOCBookmark.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,7 +18,7 @@
 **
 ** You should have received a copy of the GNU General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -28,11 +28,11 @@
 #ifndef _KPILOT_PILOTDOCBOOKMARK_H
 #define _KPILOT_PILOTDOCBOOKMARK_H
 
-#include <pilotAppCategory.h>
+#include <pilotRecord.h>
 class PilotRecord;
 
 
-class PilotDOCBookmark:public PilotAppCategory {
+class PilotDOCBookmark:public PilotRecordBase {
 public:
 	PilotDOCBookmark();
 	PilotDOCBookmark(PilotRecord * rec);
@@ -40,9 +40,7 @@
 	~PilotDOCBookmark() {};
 	PilotDOCBookmark & operator=(const PilotDOCBookmark & e);
 
-protected:
-	void *pack_(void *, int *);
-	void unpack(const void *, int = 0) {}
+	PilotRecord *pack() const;
 
 public:
 	char bookmarkName[17];
Index: kpilot/conduits/docconduit/doc-conduit.h
===================================================================
--- kpilot/conduits/docconduit/doc-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -59,7 +59,7 @@
 	eSyncDirectionEnum eSyncDirection;
 
 public:
-	DOCConduit(KPilotDeviceLink * o,
+	DOCConduit(KPilotLink * o,
 		const char *n = 0L, const QStringList & a = QStringList());
 	 virtual ~ DOCConduit();
 
@@ -89,30 +89,30 @@
     */
 	void readConfig();
 
-	/** 
+	/**
 	* Check if the database needs to be synced at all.
 	*/
 	bool needsSync(docSyncInfo &sinfo);
 	 /**
-    * If necessary, copy the database from the palm to a local dir. 
+    * If necessary, copy the database from the palm to a local dir.
     * Also initialize the docDBInfo that will be passed to the docconverter
     */
 	PilotDatabase *preSyncAction(docSyncInfo &sinfo) const;
 
 	bool doSync(docSyncInfo &sinfo);
 	 /**
-    * Clean up after the sync. The bool parameter res tells 
+    * Clean up after the sync. The bool parameter res tells
     * the function if the  conversion was successful or not
     */
 	bool postSyncAction(PilotDatabase * dbinfo, docSyncInfo &sinfo, bool res = true);
 
 	bool pcTextChanged(QString txtfn);
 	bool hhTextChanged(PilotDatabase*docdb);
-	
-	/** Opens the database with name dbname. For a local sync, this will be a 
-	 *  PilotLocalDatabase, otherwise it will be a database on the serial device 
+
+	/** Opens the database with name dbname. For a local sync, this will be a
+	 *  PilotLocalDatabase, otherwise it will be a database on the serial device
 	 *  (i.e. an object of class PilotSerialDatabase) */
-	PilotDatabase*openDOCDatabase(QString dbname);
+	PilotDatabase *openDOCDatabase(const QString &dbname);
 
 	QString constructPDBFileName(QString name);
 	QString constructTXTFileName(QString name);
Index: kpilot/conduits/docconduit/doc-factory.cc
===================================================================
--- kpilot/conduits/docconduit/doc-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -101,7 +101,7 @@
 	}
 	if (qstrcmp(c, "SyncAction") == 0)
 	{
-		KPilotDeviceLink * d = dynamic_cast < KPilotDeviceLink * >(p);
+		KPilotLink * d = dynamic_cast < KPilotLink * >(p);
 		if (d)
 		{
 			return new DOCConduit(d, n, a);
@@ -109,7 +109,7 @@
 		else
 		{
 			kdError() << k_funcinfo
-				<<": Couldn't cast parent to KPilotDeviceLink" <<endl;
+				<<": Couldn't cast parent to KPilotLink" <<endl;
 			return 0L;
 		}
 	}
Index: kpilot/conduits/docconduit/doc-setupdialog.ui
===================================================================
--- kpilot/conduits/docconduit/doc-setupdialog.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-setupdialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -549,12 +549,9 @@
     <tabstop>RadioButton1</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/docconduit/kpalmdoc_dlg.cc
===================================================================
--- kpilot/conduits/docconduit/kpalmdoc_dlg.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/kpalmdoc_dlg.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -459,7 +459,7 @@
 		PilotLocalDatabase*pdbdb=new PilotLocalDatabase(pdbdir, QFileInfo(pdbfile).baseName(), false);
 		if (pdbdb)
 		{
-			if (!pdbdb->isDBOpen())
+			if (!pdbdb->isOpen())
 			{
 #ifdef DEBUG
 				DEBUGCONDUIT<<pdbfile<<" does not yet exist. Creating it"<<endl;
@@ -468,7 +468,7 @@
 				}
 			}
 
-			if (pdbdb->isDBOpen())
+			if (pdbdb->isOpen())
 			{
 				conv->setPDB(pdbdb);
 				conv->setTXTpath(txtdir, txtfile);
@@ -504,7 +504,7 @@
 		PilotLocalDatabase*pdbdb=new PilotLocalDatabase(pdbdir, QFileInfo(pdbfile).baseName(), false);
 		if (pdbdb)
 		{
-			if (pdbdb->isDBOpen())
+			if (pdbdb->isOpen())
 			{
 				conv->setPDB(pdbdb);
 				conv->setTXTpath(txtdir, txtfile);
Index: kpilot/conduits/docconduit/doc-conflictdialog.cc
===================================================================
--- kpilot/conduits/docconduit/doc-conflictdialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/docconduit/doc-conflictdialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,7 +39,7 @@
 #include <qscrollview.h>
 
 
-ResolutionDialog::ResolutionDialog( QWidget* parent, const QString& caption, syncInfoList*sinfo, KPilotDeviceLink*lnk )
+ResolutionDialog::ResolutionDialog( QWidget* parent, const QString& caption, syncInfoList*sinfo, KPilotLink*lnk )
     : KDialogBase( parent, "resolutionDialog", true, caption, KDialogBase::Ok|KDialogBase::Cancel, KDialogBase::Ok, true), tickleTimer(0L), fHandle(lnk) {
 	FUNCTIONSETUP;
 	syncInfo=sinfo;

Zmiany atrybutów dla: kpilot/conduits/docconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile.in
Makefile
DOCSpecification
*.kdevelop
temp
ztxt
*.x
   + .deps
Makefile.in
Makefile
DOCSpecification


Index: kpilot/conduits/malconduit/mal-conduit.cc
===================================================================
--- kpilot/conduits/malconduit/mal-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/malconduit/mal-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -44,12 +44,6 @@
 #include "malconduitSettings.h"
 
 
-// Something to allow us to check what revision
-// the modules are that make up a binary distribution.
-const char *MAL_conduit_id =
-	"$Id$";
-
-
 static MALConduit *conduitInstance=0L;
 
 int malconduit_logf(const char *, ...) __attribute__ ((format (printf, 1, 2)));
@@ -113,7 +107,7 @@
 #endif
 
  
-MALConduit::MALConduit(KPilotDeviceLink * o,
+MALConduit::MALConduit(KPilotLink * o,
 	const char *n, 
 	const QStringList & a) :
 	ConduitAction(o, n, a)
@@ -124,9 +118,6 @@
 	register_printErrorHook(malconduit_logf);
 #endif
 	conduitInstance=this;
-#ifdef DEBUG
-	DEBUGCONDUIT<<MAL_conduit_id<<endl;
-#endif
 	fConduitName=i18n("MAL");
 }
 
@@ -192,7 +183,6 @@
 /* virtual */ bool MALConduit::exec()
 {
 	FUNCTIONSETUP;
-	DEBUGCONDUIT<<MAL_conduit_id<<endl;
 
 	readConfig();
 	
@@ -213,10 +203,6 @@
 		return false;
 	}
 
-#ifndef LIBMAL20
-	pInfo->lowres = 1;
-#endif
-
 	QString proxyServer( MALConduitSettings::proxyServer() );
 	int proxyPort( MALConduitSettings::proxyPort() );
 	QString syncMessage;
Index: kpilot/conduits/malconduit/mal-conduit.h
===================================================================
--- kpilot/conduits/malconduit/mal-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/malconduit/mal-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,7 +40,7 @@
 Q_OBJECT
 public:
 	MALConduit(
-		KPilotDeviceLink *o,
+		KPilotLink *o,
 		const char *n = 0L,
 		const QStringList &a = QStringList() );
 	virtual ~MALConduit();
Index: kpilot/conduits/malconduit/mal-factory.cc
===================================================================
--- kpilot/conduits/malconduit/mal-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/malconduit/mal-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -121,7 +121,7 @@
 
 	if (qstrcmp(c,"SyncAction")==0)
 	{ 
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
+		KPilotLink *d = dynamic_cast<KPilotLink *>(p);
 
 		if (d)
 		{
@@ -130,7 +130,7 @@
 		else
 		{
 			kdError() << k_funcinfo
-				<< ": Couldn't cast parent to KPilotDeviceLink"
+				<< ": Couldn't cast parent to KPilotLink"
 				<< endl;
 			return 0L;
 		}
Index: kpilot/conduits/malconduit/mal-setup_dialog.ui
===================================================================
--- kpilot/conduits/malconduit/mal-setup_dialog.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/malconduit/mal-setup_dialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -627,8 +627,8 @@
     <tabstop>tabWidget</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>klineedit.h</includehint>
-    <includehint>knuminput.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">knuminput.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/malconduit/mal_conduit.desktop
===================================================================
--- kpilot/conduits/malconduit/mal_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/malconduit/mal_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fi]=MAL (AvantGo)- yhdyskäytävä
 Name[fr]=MAL (AvantGo) Canal
 Name[ga]=Seoladán MAL (AvantGo)
+Name[gl]=Conducto MAL (AvantGo)
 Name[he]=ממשק AvantGo) MAL)
 Name[hi]=एमएएल (AvantGo) कन्ड्यूइट
 Name[hu]=MAL- (AvantGo) csatoló
@@ -55,9 +56,10 @@
 Comment[es]=Sincroniza AvantGo (o más genéricamente, el contenido de un servidor MAL) con la agenda electrónica. Le permite ver páginas web en la agenda electrónica sin estar conectado, como la programación de televisión o la cartelera de cine, o cualquier otra página web.
 Comment[et]=See kanal sünkroniseerib AvantGo (või üldisemalt MAL serveri sisu) pihuarvutiga. See võimaldab vaadata veebilehekülgi pihuseadmelt ilma võrguühendusega, näiteks uurida kino- või telekava või mis tahes muud huvipakkuvat veebilehekülge.
 Comment[eu]=Sinkronizatu AvantGo (edo orokorrean MAL zerbitzariaren edukina) agenda elektronikora. Honek web-orriak agendan konexio gabe ikusteko aukera ematen dizu, zure zine edo TB antolatzailean bezala, edo beste web orri bat bezala.
-Comment[fa]=همگام‌سازی AvantGo (یا عموماً یک محتوای کارساز MAL) با دستی. به شما اجازه می‌دهد که صفحات وب برون خطی روی دستی، مانند برنامۀ سینما یا تلویزیون شما، یا هر صفحه وب دیگری را مشاهده کنید. 
+Comment[fa]=همگام‌سازی AvantGo (یا عموماً محتوای کارساز MAL) با دستی. به شما اجازه می‌دهد که صفحات وب برون‌خطی روی دستی، مانند برنامۀ سینما یا تلویزیون شما، یا هر صفحه وب دیگری را مشاهده کنید.
 Comment[fi]=Synkronoi AvantGo (tai yleisesti MAL-palvelimen sisältö) taskutietokoneeseen. Tämä mahdollistaa web-sivujen lukemisen offline-tilassa (esim. elokuva- tai tv-ohjelmasivujen).
 Comment[fr]=Synchronise AvantGo (ou plus généralement tout serveur MAL) avec votre Palm. Ceci vous permet de consulter des pages Web hors ligne sur votre Palm, comme des programmes TV, Cinéma ou n'importe quelle page Web.
+Comment[gl]=Sincronizar AvantGo (ou xeralmente o contido dun servidor MAL) co aparello portátil. Isto permite ver as páxinas web fóra de liña no aparello portátil, como a programación do cine ou da TV, ou calquera outra páxina web.
 Comment[hu]=AvantGo (vagy MAL-kiszolgáló) adatainak szinkronizálása a kézi számítógéppel. Lehetővé teszi weboldalak offline módban való megtekintését, például a mozi- vagy tévéműsort, vagy bármi mást.
 Comment[is]=Samstillir AvantGo (eða venjulega innihald MAL þjóns) við lófatölvuna. Þetta gerir þér kleyft að skoða vefsíður þegar þú ert ótengd(ur) vefnum, t.d. kvikmynda eða sjónvarpsdagskrá.
 Comment[it]=Sincronizza AvantGo (o il contenuto di un generico server MAL) con il palmare. In questo modo potrai visualizzare le pagine web offline sul palmare come per esempio la programmazione di un cinema o una TV o qualsiasi altra pagina web.
Index: kpilot/conduits/malconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/malconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/malconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,46 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+	${MAL_INCLUDE_DIR}
+)
+
+set(conduit_mal_SRCS
+	mal-factory.cc 
+	mal-setup.cc 
+	mal-conduit.cc 
+)
+
+set(conduit_mal_UIS
+	mal-setup_dialog.ui
+)
+
+set(conduit_mal_KCFGS
+	malconduitSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_mal_SRCS ${conduit_mal_KCFGS})
+kde3_add_ui_files(conduit_mal_SRCS ${conduit_mal_UIS})
+kde3_automoc(${conduit_mal_SRCS})
+add_library(conduit_mal SHARED ${conduit_mal_SRCS})
+
+kpilot_rpath(conduit_mal)
+
+set_target_properties(
+	conduit_mal PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_mal)
+
+install(
+	TARGETS conduit_mal
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES mal_conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)
+
+install(
+	FILES malconduit.kcfg DESTINATION ${KDE3_KCFG_DIR}
+)
+

Zmiany atrybutów dla: kpilot/conduits/malconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
mal-setup_dialog.cc
mal-setup_dialog.h
*.lo
*.moc
libmalconduit.la
   + .deps
Makefile
Makefile.in
mal-setup_dialog.cc
mal-setup_dialog.h
*.lo
*.moc
libmalconduit.la


Index: kpilot/conduits/popmail/setupDialog.cc
===================================================================
--- kpilot/conduits/popmail/setupDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/setupDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,12 +29,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-// This is an old trick so you can determine what revisions
-// make up a binary distribution.
-//
-//
-static const char *setupDialog_id=
-	"$Id$";
 
 #include "options.h"
 
@@ -46,6 +40,7 @@
 #include <kconfig.h>
 #include <kstandarddirs.h>
 #include <klineedit.h>
+#include <kaboutdata.h>
 
 #include <qcheckbox.h>
 #include <qdir.h>
@@ -70,7 +65,26 @@
 {
 	FUNCTIONSETUP;
 	fConduitName = i18n("KMail");
-	UIDialog::addAboutPage(fConfigWidget->fTabWidget,PopMailConduitFactory::about());
+	KAboutData *fAbout = new KAboutData("popmailConduit",
+		I18N_NOOP("Mail Conduit for KPilot"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the Mail Conduit for KPilot"),
+		KAboutData::License_GPL,
+		"(C) 2001, Dan Pilone, Michael Kropfberger, Adriaan de Groot");
+	fAbout->addAuthor("Adriaan de Groot",
+		I18N_NOOP("Maintainer"),
+		"groot@kde.org",
+		"http://www.kpilot.org/");
+	fAbout->addAuthor("Dan Pilone",
+		I18N_NOOP("Original Author"));
+	fAbout->addCredit("Michael Kropfberger",
+		I18N_NOOP("POP3 code"));
+	fAbout->addCredit("Marko Gr&ouml;nroos",
+		I18N_NOOP("SMTP support and redesign"),
+		"magi@iki.fi",
+		"http://www.iki.fi/magi/");
+
+	UIDialog::addAboutPage(fConfigWidget->fTabWidget,fAbout);
 	fWidget=fConfigWidget;
 
 #define CM(a,b) connect(fConfigWidget->a,b,this,SLOT(modified()));
@@ -82,7 +96,6 @@
 	connect(fConfigWidget->fSendMode,SIGNAL(activated(int)),
 		this,SLOT(toggleSendMode(int)));
 
-	(void) setupDialog_id;
 }
 
 void PopMailWidgetConfig::commit()
Index: kpilot/conduits/popmail/popmail-conduit.cc
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/popmail-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -37,9 +37,7 @@
 extern "C"
 {
 
-long version_conduit_popmail = KPILOT_PLUGIN_API;
-const char *id_conduit_popmail =
-	"$Id$";
+unsigned long version_conduit_popmail = Pilot::PLUGIN_API;
 
 }
 
@@ -74,36 +72,19 @@
 #include <dcopclient.h>
 #include <ktempfile.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "pilotSerialDatabase.h"
 
 #include "popmailSettings.h"
 #include "setupDialog.h"
 
-#if 0
-static void reset_Mail(struct Mail *t)
-{
-      t->to = 0;
-      t->from = 0;
-      t->cc = 0;
-      t->bcc = 0;
-      t->subject = 0;
-      t->replyTo = 0;
-      t->sentTo = 0;
-      t->body = 0;
-      t->dated = 0;
-}
-#endif
 
-PopMailConduit::PopMailConduit(KPilotDeviceLink *d,
+PopMailConduit::PopMailConduit(KPilotLink *d,
 	const char *n,
 	const QStringList &l) :
 	ConduitAction(d,n,l)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_conduit_popmail << endl;
-#endif
 	fConduitName=i18n("KMail");
 }
 
@@ -119,11 +100,9 @@
 	int sent_count=0;
 	int mode=MailConduitSettings::syncOutgoing();
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname
 		<< ": Outgoing mail disposition "
 		<< mode << endl;
-#endif
 
 	if(mode)
 	{
@@ -168,13 +147,11 @@
 	}
 	else
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname
 			<< ": Sent "
 			<< count
 			<< " messages"
 			<< endl;
-#endif
 	}
 
 	return count;
@@ -230,21 +207,17 @@
 
 	while (PilotRecord *pilotRec = fDatabase->readNextRecInCategory(1))
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname
 			<< ": Reading "
 			<< count + 1
 			<< "th message"
 			<< endl;
-#endif
 
 		if (pilotRec->isDeleted() || pilotRec->isArchived())
 		{
-#ifdef DEBUG
 			DEBUGCONDUIT << fname
 				<< ": Skipping record."
 				<< endl;
-#endif
 			continue;
 		}
 
@@ -279,7 +252,7 @@
 		}
 
 		unpack_Mail(&theMail,
-			(unsigned char*)pilotRec->getData(),
+			(unsigned char*)pilotRec->data(),
 			pilotRec->size());
 		writeMessageToFile(sendf, theMail);
 
@@ -288,11 +261,11 @@
 		QCString returnType;
 		QDataStream arg(data,IO_WriteOnly);
 
-		arg << kmailOutboxName << t.name();
+		arg << kmailOutboxName << t.name() << CSL1("N") ;
 
 		if (!dcopptr->call("kmail",
 			"KMailIface",
-			"dcopAddMessage(QString,QString)",
+			"dcopAddMessage(QString,QString,QString)",
 			data,
 			returnType,
 			returnValue,
@@ -308,14 +281,12 @@
 			continue;
 		}
 
-#ifdef DEBUG
 		DEBUGCONDUIT << fname
 			<< ": DCOP call returned "
 			<< returnType
 			<< " of "
 			<< (const char *)returnValue
 			<< endl;
-#endif
 
 		// Mark it as filed...
 		pilotRec->setCategory(3);
@@ -328,19 +299,6 @@
 		count++;
 	}
 
-#if 0
-	if ((count > 0)  && sendImmediate)
-	{
-		QByteArray data;
-		if (dcopptr->send("kmail","KMailIface","sendQueued",data))
-		{
-			kdWarning() << k_funcinfo
-				<< ": Could not flush queue."
-				<< endl;
-		}
-	}
-#endif
-
 	return count;
 }
 
@@ -368,16 +326,12 @@
 	mailPipe << "\r\n";
 
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname << ": To: " << theMail.to << endl;
-#endif
 
 
 	if(theMail.body)
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname << ": Sent body." << endl;
-#endif
 		mailPipe << theMail.body << "\r\n";
 	}
 
@@ -385,9 +339,7 @@
 	QString signature = MailConduitSettings::signature();
 	if(!signature.isEmpty())
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname << ": Reading signature" << endl;
-#endif
 
 		QFile f(signature);
 		if ( f.open(IO_ReadOnly) )
@@ -403,9 +355,7 @@
 	}
 	mailPipe << "\r\n";
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname << ": Done" << endl;
-#endif
 }
 
 
@@ -415,20 +365,16 @@
 
 	QString outbox = getKMailOutbox();
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname
 		<< ": KMail's outbox is "
 		<< outbox
 		<< endl;
-#endif
 }
 
 /* virtual */ bool PopMailConduit::exec()
 {
 	FUNCTIONSETUP;
-	DEBUGCONDUIT << id_conduit_popmail << endl;
 
-
 	if (syncMode().isTest())
 	{
 		doTest();
@@ -439,10 +385,9 @@
 	}
 	else
 	{
-		fDatabase=new PilotSerialDatabase(pilotSocket(),
-			CSL1("MailDB"));
+		fDatabase = deviceLink()->database( CSL1("MailDB") );
 
-		if (!fDatabase || !fDatabase->isDBOpen())
+		if (!fDatabase || !fDatabase->isOpen())
 		{
 			emit logError(i18n("Unable to open mail database on handheld"));
 			KPILOT_DELETE(fDatabase);
Index: kpilot/conduits/popmail/setup-dialog.ui
===================================================================
--- kpilot/conduits/popmail/setup-dialog.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/setup-dialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -133,9 +133,9 @@
     </grid>
 </widget>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>klineedit.h</includehint>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/popmail/popmail-conduit.h
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/popmail-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -44,7 +44,7 @@
 class PopMailConduit : public ConduitAction
 {
 public:
-	PopMailConduit(KPilotDeviceLink *d,
+	PopMailConduit(KPilotLink *d,
 		const char *n=0L,
 		const QStringList &l=QStringList());
 	virtual ~PopMailConduit();
Index: kpilot/conduits/popmail/popmail-factory.cc
===================================================================
--- kpilot/conduits/popmail/popmail-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/popmail-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,7 @@
 /* KPilot
 **
 ** Copyright (C) 2001 by Dan Pilone
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org>
 **
 ** This file defines the factory for the popmail-conduit plugin.
 */
@@ -28,16 +29,10 @@
 
 #include "options.h"
 
-#include <qtabwidget.h>
-#include <qlineedit.h>
 
-#include <kconfig.h>
-#include <kinstance.h>
-#include <kaboutdata.h>
-
 #include "setupDialog.h"
 #include "popmail-conduit.h"
-#include "popmail-factory.moc"
+#include "pluginfactory.h"
 
 
 extern "C"
@@ -45,96 +40,8 @@
 
 void *init_conduit_popmail()
 {
-	return new PopMailConduitFactory;
+	return new ConduitFactory<PopMailWidgetConfig,PopMailConduit>;
 }
 
 }
 
-
-KAboutData *PopMailConduitFactory::fAbout = 0L;
-PopMailConduitFactory::PopMailConduitFactory(QObject *p, const char *n) :
-	KLibFactory(p,n)
-{
-	FUNCTIONSETUP;
-
-	fInstance = new KInstance("popmailconduit");
-	fAbout = new KAboutData("popmailConduit",
-		I18N_NOOP("Mail Conduit for KPilot"),
-		KPILOT_VERSION,
-		I18N_NOOP("Configures the Mail Conduit for KPilot"),
-		KAboutData::License_GPL,
-		"(C) 2001, Dan Pilone, Michael Kropfberger, Adriaan de Groot");
-	fAbout->addAuthor("Adriaan de Groot",
-		I18N_NOOP("Maintainer"),
-		"groot@kde.org",
-		"http://www.cs.kun.nl/~adridg/kpilot");
-	fAbout->addAuthor("Dan Pilone",
-		I18N_NOOP("Original Author"));
-	fAbout->addCredit("Michael Kropfberger",
-		I18N_NOOP("POP3 code"));
-	fAbout->addCredit("Marko Gr&ouml;nroos",
-		I18N_NOOP("SMTP support and redesign"),
-		"magi@iki.fi",
-		"http://www/iki.fi/magi/");
-}
-
-PopMailConduitFactory::~PopMailConduitFactory()
-{
-	FUNCTIONSETUP;
-
-	KPILOT_DELETE(fInstance);
-	KPILOT_DELETE(fAbout);
-}
-
-/* virtual */ QObject *PopMailConduitFactory::createObject( QObject *p,
-	const char *n,
-	const char *c,
-	const QStringList &a)
-{
-	FUNCTIONSETUP;
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< c
-		<< endl;
-#endif
-
-	if (qstrcmp(c,"ConduitConfigBase")==0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(p);
-
-		if (w)
-		{
-			return new PopMailWidgetConfig(w,n);
-		}
-		else
-		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< ": Couldn't cast parent to widget."
-				<< endl;
-#endif
-			return 0L;
-		}
-	}
-
-	if (qstrcmp(c,"SyncAction")==0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
-
-		if (d)
-		{
-			return new PopMailConduit(d,n,a);
-		}
-		else
-		{
-			kdError() << k_funcinfo
-				<< ": Couldn't cast to KPilotDeviceLink"
-				<< endl;
-			return 0L;
-		}
-	}
-	return 0L;
-}
-
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,6 +14,7 @@
 Comment[fa]=ارسال نامه از طریق KMail، از دستی شما.
 Comment[fi]=Lähetä sähköpostia taskutietokoneelta KMailin kautta.
 Comment[fr]=Permet d'envoyer des messages du Palm vers KMail
+Comment[gl]=Enviar correo dende o seu aparello de man a través de KMail.
 Comment[hu]=Ezzel a csatolóval kézi számítógépről lehet levelet küldeni a KMailen keresztül.
 Comment[is]=Sendu tölvupóst frá lófatölvunni þinni gegnum KMail.
 Comment[it]=Invia la posta dal tuo palmare tramite KMail.
Index: kpilot/conduits/popmail/popmail-factory.h
===================================================================
--- kpilot/conduits/popmail/popmail-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/popmail/popmail-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,31 +28,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include <klibloader.h>
 
-class KInstance;
-class KAboutData;
-
-class PopMailConduitFactory : public KLibFactory
-{
-Q_OBJECT
-
-public:
-	PopMailConduitFactory(QObject * = 0L,const char * = 0L);
-	virtual ~PopMailConduitFactory();
-
-	static KAboutData *about() { return fAbout; } ;
-
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() );
-private:
-	KInstance *fInstance;
-	static KAboutData *fAbout;
-}  ;
-
 extern "C"
 {
 void *init_conduit_popmail();
Index: kpilot/conduits/popmail/CMakeLists.txt
===================================================================
--- kpilot/conduits/popmail/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/popmail/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,39 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_popmail_SRCS
+	popmail-factory.cc
+	popmail-conduit.cc
+	setupDialog.cc
+)
+
+set(conduit_popmail_UIS
+	setup-dialog.ui
+)
+
+set(conduit_popmail_KCFGS
+	popmailSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_popmail_SRCS ${conduit_popmail_KCFGS})
+kde3_add_ui_files(conduit_popmail_SRCS ${conduit_popmail_UIS})
+kde3_automoc(${conduit_popmail_SRCS})
+add_library(conduit_popmail SHARED ${conduit_popmail_SRCS})
+
+set_target_properties(
+	conduit_popmail PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_popmail)
+
+install(
+	TARGETS conduit_popmail
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES popmail-conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/popmail
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
   + .deps
.libs
Makefile
Makefile.in
*.moc
setup-dialog.cc
setup-dialog.h
popmailSettings.cc
popmailSettings.h



Index: kpilot/conduits/knotes/knotes-action.cc
===================================================================
--- kpilot/conduits/knotes/knotes-action.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/knotes/knotes-action.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -57,8 +57,7 @@
 extern "C"
 {
 
-long version_conduit_knotes = KPILOT_PLUGIN_API;
-const char *id_conduit_knotes = "$Id$" ;
+unsigned long version_conduit_knotes = Pilot::PLUGIN_API;
 
 }
 
@@ -183,7 +182,7 @@
 
 
 
-KNotesAction::KNotesAction(KPilotDeviceLink *o,
+KNotesAction::KNotesAction(KPilotLink *o,
 	const char *n, const QStringList &a) :
 	ConduitAction(o,n ? n : "knotes-conduit",a),
 	fP(new KNotesActionPrivate)
@@ -361,7 +360,6 @@
 			listNotes(); // Debugging
 			fActionStatus = MemosToKNotes;
 			break;
-		case SyncAction::SyncMode::eFastSync:
 		case SyncAction::SyncMode::eHotSync:
 		case SyncAction::SyncMode::eFullSync:
 		case SyncAction::SyncMode::eCopyPCToHH:
@@ -396,7 +394,6 @@
 				// Impossible!
 				fActionStatus = Done;
 				break;
-			case SyncAction::SyncMode::eFastSync:
 			case SyncAction::SyncMode::eHotSync:
 			case SyncAction::SyncMode::eFullSync:
 				fActionStatus = MemosToKNotes;
Index: kpilot/conduits/knotes/knotes-action.h
===================================================================
--- kpilot/conduits/knotes/knotes-action.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/knotes/knotes-action.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,7 +28,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include "plugin.h"
+#include <plugin.h>
 
 
 class NoteAndMemo;
@@ -39,7 +39,7 @@
 Q_OBJECT
 public:
 	KNotesAction(
-		KPilotDeviceLink *o,
+		KPilotLink *o,
 		const char *n = 0L,
 		const QStringList &a = QStringList() );
 	virtual ~KNotesAction();
Index: kpilot/conduits/knotes/knotes-factory.cc
===================================================================
--- kpilot/conduits/knotes/knotes-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/knotes/knotes-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -114,7 +114,7 @@
 	else
 	if (qstrcmp(c,"SyncAction")==0)
 	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
+		KPilotLink *d = dynamic_cast<KPilotLink *>(p);
 
 		if (d)
 		{
Index: kpilot/conduits/knotes/knotes-conduit.desktop
===================================================================
--- kpilot/conduits/knotes/knotes-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/knotes/knotes-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=این لوله، کاربرد Memo Pad را با KNotes همگام می‌سازد.
 Comment[fi]=Tämä yhdyskäytävä synkronoi Memo Pad -ohelman KNotesin kanssa.
 Comment[fr]=Ce canal synchronise l'application « Memo Pad » avec KNotes.
+Comment[gl]=Este conducto sincroniza a aplicación Memo Pad con KNotes.
 Comment[hi]=यह कन्ड्यूइट मेमो पेड अनुप्रयोगों को के-नोट्स के साथ सिंक करता है
 Comment[hu]=Ezzel a csatolóval a Memo Pad program és a KNotes között lehet szinkronizálást végezni.
 Comment[is]=Þessi rás samstillir lófatölvuna þína við KNotes.

Zmiany atrybutów dla: kpilot/conduits/knotes
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
conduitKNotes
   + .deps
.libs
Makefile
Makefile.in
*.moc
conduitKNotes
setup_base.h
setup_base.cc
knotesconduitSettings.cc
knotesconduitSettings.h
KNotesIface.kidl
KNotesIface_stub.h
KNotesIface_stub.cc



Index: kpilot/conduits/recordconduit/setup_base.ui
===================================================================
--- kpilot/conduits/recordconduit/setup_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/setup_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,158 @@
+<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
+<class>RecordWidget</class>
+<comment>A tabWidget for configuring
+the Record-conduit settings.</comment>
+<author>Adriaan de Groot</author>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>Form1</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>342</width>
+            <height>163</height>
+        </rect>
+    </property>
+    <property name="sizePolicy">
+        <sizepolicy>
+            <hsizetype>5</hsizetype>
+            <vsizetype>5</vsizetype>
+            <horstretch>0</horstretch>
+            <verstretch>0</verstretch>
+        </sizepolicy>
+    </property>
+    <property name="baseSize">
+        <size>
+            <width>570</width>
+            <height>270</height>
+        </size>
+    </property>
+    <property name="caption">
+        <string>Null-Conduit Options</string>
+    </property>
+    <property name="layoutMargin" stdset="0">
+    </property>
+    <property name="layoutSpacing" stdset="0">
+    </property>
+    <grid>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <property name="margin">
+            <number>0</number>
+        </property>
+        <property name="spacing">
+            <number>6</number>
+        </property>
+        <widget class="QTabWidget" row="0" column="0">
+            <property name="name">
+                <cstring>tabWidget</cstring>
+            </property>
+            <property name="sizePolicy">
+                <sizepolicy>
+                    <hsizetype>7</hsizetype>
+                    <vsizetype>7</vsizetype>
+                    <horstretch>0</horstretch>
+                    <verstretch>0</verstretch>
+                </sizepolicy>
+            </property>
+            <property name="layoutMargin" stdset="0">
+            </property>
+            <widget class="QWidget">
+                <property name="name">
+                    <cstring>Widget2</cstring>
+                </property>
+                <attribute name="title">
+                    <string>General</string>
+                </attribute>
+                <grid>
+                    <property name="name">
+                        <cstring>unnamed</cstring>
+                    </property>
+                    <property name="margin">
+                        <number>11</number>
+                    </property>
+                    <property name="spacing">
+                        <number>6</number>
+                    </property>
+                    <widget class="QLineEdit" row="0" column="1">
+                        <property name="name">
+                            <cstring>fLogMessage</cstring>
+                        </property>
+                        <property name="text">
+                            <string>KPilot was here.</string>
+                        </property>
+                        <property name="whatsThis" stdset="0">
+                            <string>&lt;qt&gt;Enter the message to add to the Sync Log on your Pilot here.&lt;/qt&gt;</string>
+                        </property>
+                    </widget>
+                    <widget class="QLabel" row="0" column="0">
+                        <property name="name">
+                            <cstring>TextLabel1_2</cstring>
+                        </property>
+                        <property name="text">
+                            <string>&amp;Log message:</string>
+                        </property>
+                        <property name="buddy" stdset="0">
+                            <cstring>fLogMessage</cstring>
+                        </property>
+                    </widget>
+                    <widget class="QLabel" row="1" column="0">
+                        <property name="name">
+                            <cstring>TextLabel2_2</cstring>
+                        </property>
+                        <property name="text">
+                            <string>&amp;Databases:</string>
+                        </property>
+                        <property name="buddy" stdset="0">
+                            <cstring>fDatabases</cstring>
+                        </property>
+                    </widget>
+                    <widget class="QLineEdit" row="1" column="1">
+                        <property name="name">
+                            <cstring>fDatabases</cstring>
+                        </property>
+                        <property name="whatsThis" stdset="0">
+                            <string>&lt;qt&gt;The Null-conduit can be attached to several databases, effectively preventing them from Syncing. Enter the database names here.&lt;/qt&gt;</string>
+                        </property>
+                    </widget>
+                    <spacer row="3" column="1">
+                        <property name="name">
+                            <cstring>Spacer4</cstring>
+                        </property>
+                        <property name="orientation">
+                            <enum>Vertical</enum>
+                        </property>
+                        <property name="sizeType">
+                            <enum>Expanding</enum>
+                        </property>
+                        <property name="sizeHint">
+                            <size>
+                                <width>20</width>
+                                <height>20</height>
+                            </size>
+                        </property>
+                    </spacer>
+                    <widget class="QCheckBox" row="2" column="1">
+                        <property name="name">
+                            <cstring>fFailImmediately</cstring>
+                        </property>
+                        <property name="text">
+                            <string>Simulate failure</string>
+                        </property>
+                        <property name="whatsThis" stdset="0">
+                            <string>Force the conduit to simulate a failure to perform the HotSync.</string>
+                        </property>
+                    </widget>
+                </grid>
+            </widget>
+        </widget>
+    </grid>
+</widget>
+<tabstops>
+    <tabstop>tabWidget</tabstop>
+</tabstops>
+<layoutdefaults spacing="6" margin="11"/>
+</UI>
Index: kpilot/conduits/recordconduit/Makefile.am
===================================================================
--- kpilot/conduits/recordconduit/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,15 @@
+INCLUDES= $(PISOCK_INCLUDE) -I$(top_srcdir)/kpilot/lib $(all_includes)
+
+METASOURCES = AUTO
+
+servicedir = $(kde_servicesdir)
+service_DATA = record-conduit.desktop
+
+kde_module_LTLIBRARIES = conduit_record.la
+
+
+conduit_record_la_SOURCES = settings.kcfgc setup_base.ui factory.cc
+conduit_record_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
+conduit_record_la_LIBADD = ../../lib/libkpilot.la $(LIB_KDEUI)
+
+kde_kcfg_DATA = settings.kcfg
Index: kpilot/conduits/recordconduit/record-conduit.desktop
===================================================================
--- kpilot/conduits/recordconduit/record-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/record-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,72 @@
+[Desktop Entry]
+Encoding=UTF-8
+Type=Service
+Name=Records (Experimental)
+Name[ca]=Registres (Experimental)
+Name[cs]=Záznamy (experimentální)
+Name[da]=Indspilninger (eksperimentel)
+Name[de]=Einträge (Experimentell)
+Name[el]=Εγγραφές (Πειραματικό)
+Name[es]=Registros (Experimental)
+Name[et]=Kirjed (eksperimentaalne)
+Name[fr]=Enregistrements (expérimental)
+Name[gl]=Grava (Experimental)
+Name[hu]=Rekordok (kísérleti)
+Name[it]=Record (sperimentale)
+Name[ja]=レコード (実験中)
+Name[km]=កំណត់​ត្រា (ពិសោធន៍)
+Name[nds]=Logbook (warrt utprobeert)
+Name[nl]=Opnames (experimenteel)
+Name[pt]=Registos (Experimental)
+Name[pt_BR]=Registos (Experimental)
+Name[ru]=Записи (экспериментально)
+Name[sv]=Inspelningar (experimentell)
+Name[uk]=Записи (експериментальний)
+Name[zh_TW]=紀錄（實驗性）
+Comment=This conduit does nothing.
+Comment[bg]=Това нещо прави нищо
+Comment[bs]=Ovaj conduit ne radi ništa.
+Comment[ca]=Aquest conducte no fa res.
+Comment[cs]=Toto propojení nedělá nic.
+Comment[cy]=Nid yw'r cwndid yma yn gwneud unrhyw beth.
+Comment[da]=Denne kanal gør ingenting.
+Comment[de]=Diese Erweiterung (Conduit) ist ohne Funktion
+Comment[el]=Αυτός ο σύνδεσμος δεν κάνει τίποτα.
+Comment[et]=See kanal ei tee mitte kui midagi.
+Comment[eu]=Kanal honek ez du ezer egiten.
+Comment[fa]=این لوله هیچ چیز ندارد.
+Comment[fi]=Tämä yhdyskäytävä ei tee mitään.
+Comment[fr]=Ce canal ne fait rien.
+Comment[ga]=Ní dhéanann an seoladán seo faic.
+Comment[gl]=Este conducto non fai nada.
+Comment[hi]=यह कन्ड्यूइट कुछ नहीं करता है.
+Comment[hu]=Ez a csatoló üres, csak tesztelési célokat szolgál
+Comment[is]=Þessi rás gerir ekki neitt.
+Comment[it]=Questo conduit non fa nulla.
+Comment[ja]=このコンジットは未知です。
+Comment[km]=បំពង់​នេះ​មិន​ធ្វើ​អ្វី​ទាំងអស់ ។
+Comment[lt]=Šis kanalas nieko neatlieka.
+Comment[ms]=Saluran ini tidak berbuat apa-apa.
+Comment[nb]=Denne kanalen gjør ingenting.
+Comment[nds]=Disse Kanaal deit gor nix.
+Comment[nl]=Dit conduit doet niets.
+Comment[nn]=Denne koplinga gjer ingenting.
+Comment[pl]=Ten łącznik nic nie robi.
+Comment[pt]=Esta conduta não faz nada.
+Comment[pt_BR]=Este conduíte não faz coisa alguma.
+Comment[ro]=Această conductă nu face nimic.
+Comment[ru]=Канал, который ничего не делает.
+Comment[sk]=Táto spojka nič nerobí.
+Comment[sl]=Ta veznik ne počne ničesar.
+Comment[sr]=Овај провод не ради ништа.
+Comment[sr@Latn]=Ovaj provod ne radi ništa.
+Comment[sv]=Den här kanalen gör ingenting.
+Comment[ta]=இந்த காப்புக் குழாய் ஒன்றும் செய்யாது
+Comment[tg]=Канале, ки дар ҳолати шурӯъ нест.
+Comment[tr]=Bu kanal herhangi bir işlem yapmaz.
+Comment[uk]=Цей акведук нічого не робить.
+Comment[zh_CN]=此管道不做任何事。
+Comment[zh_TW]=不做任何事。
+Implemented=file
+ServiceTypes=KPilotConduit
+X-KDE-Library=conduit_record
Index: kpilot/conduits/recordconduit/settings.kcfg
===================================================================
--- kpilot/conduits/recordconduit/settings.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/settings.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<kcfg xmlns="http://www.kde.org/standards/kcfg/1.0"
+      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+      xsi:schemaLocation="http://www.kde.org/standards/kcfg/1.0
+      http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
+  <kcfgfile name="kpilotrc"/>
+  <group name="RecordConduit">
+		<entry name="FailImmediately" key="FailNow" type="Bool">
+        <label>Whether the conduit should immediately bail out with an error</label>
+        <default>false</default>
+    </entry>
+    <entry name="LogMessage" type="String">
+        <label>The error message if the null conduit is supposed to fail</label>
+        <default>KPilot was here.</default>
+    </entry>
+		<entry name="Databases" type="StringList">
+				<label>Databases that are skipped on sync</label>
+				<default></default>
+		</entry>
+  </group>
+
+</kcfg>
Index: kpilot/conduits/recordconduit/factory.cc
===================================================================
--- kpilot/conduits/recordconduit/factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,145 @@
+/* KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot
+**
+** This file defines the factory for the recordconduit plugin.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <qtabwidget.h>
+#include <qlineedit.h>
+#include <qcheckbox.h>
+
+#include <kconfig.h>
+#include <kinstance.h>
+#include <kaboutdata.h>
+
+#include "uiDialog.h"
+#include "pluginfactory.h"
+#include "pilotDatabase.h"
+#include "recordConduit.h"
+
+#include "setup_base.h"
+#include "factory.h"
+#include "settings.h"
+
+
+class ConduitConfig : public ConduitConfigBase
+{
+public:
+	ConduitConfig(QWidget *parent=0L, const char *n=0L);
+	virtual void commit();
+	virtual void load();
+protected:
+	RecordWidget *fConfigWidget;
+	KAboutData *fAbout;
+} ;
+
+ConduitConfig::ConduitConfig(QWidget *p, const char *n) :
+	ConduitConfigBase(p,n),
+	fConfigWidget(new RecordWidget(p))
+{
+	FUNCTIONSETUP;
+	fConduitName = TODO_I18N("Record Conduit");
+		fAbout = new KAboutData("recordConduit",
+		I18N_NOOP("Record Conduit for KPilot"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the Record Conduit for KPilot"),
+		KAboutData::License_GPL,
+		"(C) 2005, Adriaan de Groot");
+	fAbout->addAuthor("Adriaan de Groot",
+		I18N_NOOP("Primary Author"),
+		"groot@kde.org",
+		"http://people.fruitsalad.org/adridg/");
+
+	UIDialog::addAboutPage(fConfigWidget->tabWidget,fAbout);
+	fWidget=fConfigWidget;
+	QObject::connect(fConfigWidget->fLogMessage,SIGNAL(textChanged(const QString&)),
+		this,SLOT(modified()));
+	QObject::connect(fConfigWidget->fDatabases,SIGNAL(textChanged(const QString&)),
+		this,SLOT(modified()));
+	QObject::connect(fConfigWidget->fFailImmediately,SIGNAL(toggled(bool)),
+		this,SLOT(modified()));
+}
+
+/* virtual */ void ConduitConfig::commit()
+{
+	FUNCTIONSETUP;
+
+#ifdef DEBUG
+	DEBUGCONDUIT << fname
+		<< ": Message="
+		<< fConfigWidget->fLogMessage->text()
+		<< endl;
+	DEBUGCONDUIT << fname
+		<< ": Databases="
+		<< fConfigWidget->fDatabases->text()
+		<< endl;
+#endif
+
+	ConduitSettings::setLogMessage( fConfigWidget->fLogMessage->text() );
+	ConduitSettings::setDatabases( fConfigWidget->fDatabases->text() );
+	ConduitSettings::setFailImmediately( fConfigWidget->fFailImmediately->isChecked());
+	ConduitSettings::self()->writeConfig();
+	unmodified();
+}
+
+/* virtual */ void ConduitConfig::load()
+{
+	FUNCTIONSETUP;
+	ConduitSettings::self()->readConfig();
+
+	fConfigWidget->fLogMessage->setText( ConduitSettings::logMessage() );
+	fConfigWidget->fDatabases->setText( ConduitSettings::databases().join(",") );
+	fConfigWidget->fFailImmediately->setChecked( ConduitSettings::failImmediately() );
+
+#ifdef DEBUG
+	DEBUGCONDUIT << fname
+		<< ": Read Message="
+		<< fConfigWidget->fLogMessage->text()
+		<< endl;
+	DEBUGCONDUIT << fname
+		<< ": Read Database="
+		<< fConfigWidget->fDatabases->text()
+		<< endl;
+#endif
+
+	unmodified();
+}
+
+typedef PilotDatabase PilotDatabaseContainer;
+
+typedef RecordConduit<PilotRecord, PilotDatabaseContainer, PilotRecord, PilotAppInfoBase, NullMapper<PilotRecord> > RecordAction;
+
+extern "C"
+{
+
+void *init_conduit_record()
+{
+	return new ConduitFactory<ConduitConfig,RecordAction>(0,"recordconduit");
+}
+
+}
+
Index: kpilot/conduits/recordconduit/settings.kcfgc
===================================================================
--- kpilot/conduits/recordconduit/settings.kcfgc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/settings.kcfgc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,7 @@
+File=settings.kcfg
+ClassName= ConduitSettings
+Singleton=true
+ItemAccessors=true
+Mutators=true
+GlobalEnums=true
+SetUserTexts=true
Index: kpilot/conduits/recordconduit/factory.h
===================================================================
--- kpilot/conduits/recordconduit/factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/recordconduit/factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,40 @@
+#ifndef KPILOT_RECORD_FACTORY_H
+#define KPILOT_RECORD_FACTORY_H
+/* factory.h                       KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot
+**
+** This is the factory for the recordconduit, which uses the
+** template class RecordConduit for demonstration purposes.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+
+extern "C"
+{
+
+void *init_conduit_record();
+
+}
+
+#endif

Zmiany atrybutów dla: kpilot/conduits/recordconduit
___________________________________________________________________
Nazwa: svn:ignore
   + .deps
Makefile.in
Makefile


Index: kpilot/conduits/Makefile.am
===================================================================
--- kpilot/conduits/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,7 +1,4 @@
 ###
-### The todo conduit is deprecated -- well, it has moved to
-### vcalconduit where it shares most of the code with the vcalconduit.
-###
 ### The NULL conduit is a neat programming example, but shouldn't be
 ### installed on user systems.
 ###
@@ -10,30 +7,16 @@
 MAL_SUBDIR = malconduit
 endif
 
-if include_abc
-ABC_SUBDIR = abbrowserconduit vcalconduit
-endif
-
-if include_perl
-PERL_SUBDIR = perlconduit
-endif
-
-if include_python
-PYTHON_SUBDIR = pythonconduit
-endif
-
-if include_notepad
-NOTEPAD_SUBDIR = notepadconduit
-endif
-
 SUBDIRS = \
-          docconduit \
-          knotes \
-          popmail \
-          timeconduit \
-          sysinfoconduit \
+	  abbrowserconduit \
+	  docconduit \
+	  knotes \
 	  memofileconduit \
-          $(MAL_SUBDIR) $(ABC_SUBDIR) $(NOTEPAD_SUBDIR)
+	  notepadconduit \
+	  popmail \
+	  sysinfoconduit \
+	  timeconduit \
+	  vcalconduit
 
 ###
 ### Subdirs you might have for experimental purposes:
@@ -41,7 +24,4 @@
 ###	null             - a conduit that just logs a single message.
 ###	$(PERL_SUBDIR)   - fires off a perl interpreter in a thread.
 ###	$(PYTHON_SUBDIR) - starts a python interpreter in a thread.
-###	notepadconduit   - a conduit to save notepad drawings as pngs.
 ###
-
-
Index: kpilot/conduits/null/null-conduit.cc
===================================================================
--- kpilot/conduits/null/null-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/null-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -33,13 +33,6 @@
 
 #include "options.h"
 
-// Something to allow us to check what revision
-// the modules are that make up a binary distribution.
-//
-//
-static const char *null_conduit_id=
-	"$Id$";
-
 // Only include what we really need:
 // First UNIX system stuff, then std C++,
 // then Qt, then KDE, then local includes.
@@ -59,16 +52,14 @@
 // simple constructor and destructor.
 //
 //
-NullConduit::NullConduit(KPilotDeviceLink *d,
+NullConduit::NullConduit(KPilotLink *d,
 	const char *n,
 	const QStringList &l) :
 	ConduitAction(d,n,l),
-	fDatabase(0L)
+	fDatabase(0L),
+	fFailImmediately( l.contains( CSL1("--fail") ))
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<null_conduit_id<<endl;
-#endif
 	fConduitName=i18n("Null");
 }
 
@@ -81,13 +72,12 @@
 /* virtual */ bool NullConduit::exec()
 {
 	FUNCTIONSETUP;
-	DEBUGCONDUIT<<null_conduit_id<<endl;
 
-	if ( NullConduitSettings::failImmediately() )
+	DEBUGCONDUIT << fname << ": Mode " << syncMode().name() << endl;
+
+	if ( fFailImmediately )
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname << ": Config says to fail now." << endl;
-#endif
 		emit logError(i18n("NULL conduit is programmed to fail."));
 		return false;
 	}
@@ -98,12 +88,10 @@
 		addSyncLogEntry(m);
 	}
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname
 		<< ": Message from null-conduit: "
 		<< m
 		<< endl;
-#endif
 
 	emit syncDone(this);
 	return true;
Index: kpilot/conduits/null/null-conduit.h
===================================================================
--- kpilot/conduits/null/null-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/null-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,10 +35,21 @@
 class PilotRecord;
 class PilotDatabase;
 
+/**
+ * The conduit Null does nothing. Almost nothing, anyway.
+ * It writes a single log message to the sync log and then
+ * completes successfully. For debugging purposes it can
+ * also simulate failure, but that is a very specialized
+ * case available only programmatically.
+ */
 class NullConduit : public ConduitAction
 {
 public:
-	NullConduit(KPilotDeviceLink *,
+	/** Constructor. Special case is if @p contains
+	 *  @c --fail as an argument to the conduit, then
+	 *  the conduit will fail instead of trivially succeeding.
+	 */
+	NullConduit(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~NullConduit();
@@ -48,6 +59,7 @@
 
 protected:
 	PilotDatabase *fDatabase;
+	bool fFailImmediately;
 };
 
 #endif
Index: kpilot/conduits/null/null-factory.cc
===================================================================
--- kpilot/conduits/null/null-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/null-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -62,7 +62,7 @@
 {
 	FUNCTIONSETUP;
 	fConduitName = i18n("Null");
-		fAbout = new KAboutData("nullConduit",
+	fAbout = new KAboutData("nullConduit",
 		I18N_NOOP("Null Conduit for KPilot"),
 		KPILOT_VERSION,
 		I18N_NOOP("Configures the Null Conduit for KPilot"),
@@ -77,10 +77,6 @@
 	fWidget=fConfigWidget;
 	QObject::connect(fConfigWidget->fLogMessage,SIGNAL(textChanged(const QString&)),
 		this,SLOT(modified()));
-	QObject::connect(fConfigWidget->fDatabases,SIGNAL(textChanged(const QString&)),
-		this,SLOT(modified()));
-	QObject::connect(fConfigWidget->fFailImmediately,SIGNAL(toggled(bool)),
-		this,SLOT(modified()));
 }
 
 /* virtual */ void NullConduitConfig::commit()
@@ -92,15 +88,9 @@
 		<< ": Message="
 		<< fConfigWidget->fLogMessage->text()
 		<< endl;
-	DEBUGCONDUIT << fname
-		<< ": Databases="
-		<< fConfigWidget->fDatabases->text()
-		<< endl;
 #endif
 
 	NullConduitSettings::setLogMessage( fConfigWidget->fLogMessage->text() );
-	NullConduitSettings::setDatabases( fConfigWidget->fDatabases->text() );
-	NullConduitSettings::setFailImmediately( fConfigWidget->fFailImmediately->isChecked());
 	NullConduitSettings::self()->writeConfig();
 	unmodified();
 }
@@ -111,18 +101,11 @@
 	NullConduitSettings::self()->readConfig();
 
 	fConfigWidget->fLogMessage->setText( NullConduitSettings::logMessage() );
-	fConfigWidget->fDatabases->setText( NullConduitSettings::databases().join(",") );
-	fConfigWidget->fFailImmediately->setChecked( NullConduitSettings::failImmediately() );
-
 #ifdef DEBUG
 	DEBUGCONDUIT << fname
 		<< ": Read Message="
 		<< fConfigWidget->fLogMessage->text()
 		<< endl;
-	DEBUGCONDUIT << fname
-		<< ": Read Database="
-		<< fConfigWidget->fDatabases->text()
-		<< endl;
 #endif
 
 	unmodified();
@@ -133,6 +116,7 @@
 extern "C"
 {
 
+unsigned long version_conduit_null = Pilot::PLUGIN_API;
 void *init_conduit_null()
 {
 	return new ConduitFactory<NullConduitConfig,NullConduit>(0,"nullconduit");
Index: kpilot/conduits/null/null-conduit.desktop
===================================================================
--- kpilot/conduits/null/null-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/null-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -23,6 +23,7 @@
 Comment[fi]=Tämä yhdyskäytävä ei tee mitään.
 Comment[fr]=Ce canal ne fait rien.
 Comment[ga]=Ní dhéanann an seoladán seo faic.
+Comment[gl]=Este conducto non fai nada.
 Comment[hi]=यह कन्ड्यूइट कुछ नहीं करता है.
 Comment[hu]=Ez a csatoló üres, csak tesztelési célokat szolgál
 Comment[is]=Þessi rás gerir ekki neitt.
Index: kpilot/conduits/null/setup_base.ui
===================================================================
--- kpilot/conduits/null/setup_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/setup_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
 <class>NullWidget</class>
 <comment>A tabWidget for configuring
 the Null-conduit settings.</comment>
@@ -99,25 +99,6 @@
                             <cstring>fLogMessage</cstring>
                         </property>
                     </widget>
-                    <widget class="QLabel" row="1" column="0">
-                        <property name="name">
-                            <cstring>TextLabel2_2</cstring>
-                        </property>
-                        <property name="text">
-                            <string>&amp;Databases:</string>
-                        </property>
-                        <property name="buddy" stdset="0">
-                            <cstring>fDatabases</cstring>
-                        </property>
-                    </widget>
-                    <widget class="QLineEdit" row="1" column="1">
-                        <property name="name">
-                            <cstring>fDatabases</cstring>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>&lt;qt&gt;The Null-conduit can be attached to several databases, effectively preventing them from Syncing. Enter the database names here.&lt;/qt&gt;</string>
-                        </property>
-                    </widget>
                     <spacer row="3" column="1">
                         <property name="name">
                             <cstring>Spacer4</cstring>
@@ -135,17 +116,6 @@
                             </size>
                         </property>
                     </spacer>
-                    <widget class="QCheckBox" row="2" column="1">
-                        <property name="name">
-                            <cstring>fFailImmediately</cstring>
-                        </property>
-                        <property name="text">
-                            <string>Simulate failure</string>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>Force the conduit to simulate a failure to perform the HotSync.</string>
-                        </property>
-                    </widget>
                 </grid>
             </widget>
         </widget>
Index: kpilot/conduits/null/nullconduit.kcfg
===================================================================
--- kpilot/conduits/null/nullconduit.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/null/nullconduit.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,18 +5,9 @@
       http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
   <kcfgfile name="kpilotrc"/> 
   <group name="Null-conduit">
-		<entry name="FailImmediately" key="FailNow" type="Bool">
-        <label>Whether the conduit should immediately bail out with an error</label>
-        <default>false</default>
-    </entry>
     <entry name="LogMessage" type="String">
-        <label>The error message if the null conduit is supposed to fail</label>
-        <default>KPilot was here.</default>
+      <label>The error message if the null conduit is supposed to fail</label>
+      <default>KPilot was here.</default>
     </entry>
-		<entry name="Databases" type="StringList">
-				<label>Databases that are skipped on sync</label>
-				<default></default>
-		</entry>
   </group>
-	
 </kcfg>
Index: kpilot/conduits/null/CMakeLists.txt
===================================================================
--- kpilot/conduits/null/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/null/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,38 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_null_SRCS
+	null-conduit.cc
+	null-factory.cc
+)
+
+set(conduit_null_UIS
+	setup_base.ui
+)
+
+set(conduit_null_KCFGS
+	nullSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_null_SRCS ${conduit_null_KCFGS})
+kde3_add_ui_files(conduit_null_SRCS ${conduit_null_UIS})
+kde3_automoc(${conduit_null_SRCS})
+add_library(conduit_null SHARED ${conduit_null_SRCS})
+
+set_target_properties(
+	conduit_null PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_null)
+
+install(
+	TARGETS conduit_null
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES null-conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/null
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
   + .deps
Makefile
Makefile.in


Index: kpilot/conduits/vcalconduit/vcal-factorybase.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-factorybase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-factorybase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,41 +0,0 @@
-/* vcal-factory.cc                      KPilot
-**
-** Copyright (C) 2002-2003 Reinhold Kainhofer
-** Copyright (C) 2001 by Dan Pilone
-**
-** This file defines the factory for the vcal-conduit plugin.
-*/
-
-/*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU General Public License as published by
-** the Free Software Foundation; either version 2 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU General Public License for more details.
-**
-** You should have received a copy of the GNU General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
-
-/*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
-#include <kaboutdata.h>
-
-#include "vcal-factorybase.moc"
-#include "options.h"
-
-KAboutData *VCalConduitFactoryBase::fAbout = 0L;
-
-
-VCalConduitFactoryBase::~VCalConduitFactoryBase()
-{
-	KPILOT_DELETE(fAbout);
-}
-
Index: kpilot/conduits/vcalconduit/todo-conduit.desktop
===================================================================
--- kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=این لوله، فهرست کارهایی که باید انجام شود را از دستی شما با KOrganizer همگام‌سازی می‌کند.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen tehtävälistan KOrganizeriin.
 Comment[fr]=Ce canal synchronise la liste des tâches de votre Palm sur KOrganizer.
+Comment[gl]=Este conducto sincroniza a lista de tarefas pendentes dende o seu aparello portátil a KOrganizer.
 Comment[hi]=यह कन्ड्यूइट आपके हैंण्डहेल्ड से टू-डू सूची को के-आर्गेनाइज़र में सिंक करता है
 Comment[hu]=Ezzel a csatolóval a Pilot tennivalólistája és a KOrganizer tennivalói között lehet szinkronizálást végezni.
 Comment[is]=Þessi rás samstillir verkþáttalista lófatölvunnar þinnar og KOrganizer.
@@ -54,7 +55,7 @@
 Name[es]=Tareas pendientes (KOrganizer)
 Name[et]=Ülesanded (KOrganizer)
 Name[eu]=Egitekoak (KOrganizer)
-Name[fa]=کارهایی که باید انجام شوند (KOrganizer)
+Name[fa]=کارهای انجامی (KOrganizer)
 Name[fi]=Tehtävät (KOrganizer)
 Name[fr]=Tâches (KOrganizer)
 Name[ga]=Tascanna (KOrganizer)
Index: kpilot/conduits/vcalconduit/vcal-factory.h
===================================================================
--- kpilot/conduits/vcalconduit/vcal-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,31 +30,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include "vcal-factorybase.h"
 
-class KInstance;
-class KAboutData;
-class VCalConduitSettings;
-
-class VCalConduitFactory : public VCalConduitFactoryBase
-{
-    Q_OBJECT
-
-public:
-	VCalConduitFactory(QObject * = 0L,const char * = 0L);
-	virtual ~VCalConduitFactory();
-	static VCalConduitSettings*config();
-	
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() );
-private:
-	KInstance *fInstance;
-	static VCalConduitSettings*fConfig;
-};
-
 extern "C"
 {
 
Index: kpilot/conduits/vcalconduit/deleteunsyncedhhstate.h
===================================================================
--- kpilot/conduits/vcalconduit/deleteunsyncedhhstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/deleteunsyncedhhstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,53 @@
+#ifndef _KPILOT_DUSHHSTATE_H
+#define _KPILOT_DUSHHSTATE_H
+/* deleteunsyncedhhstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the deleteunsyncedpcstate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State to handle delete unsynced pc records. @see vcal-conduitstate.h
+ */
+class DeleteUnsyncedHHState : public ConduitState
+{
+private:
+	ConduitState *fNextState;
+	int fPilotIndex;
+
+public:
+	DeleteUnsyncedHHState();
+	virtual ~DeleteUnsyncedHHState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/todo-setup.cc
===================================================================
--- kpilot/conduits/vcalconduit/todo-setup.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-setup.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,9 +30,10 @@
 #include "options.h"
 
 #include <qbuttongroup.h>
+#include <kaboutdata.h>
 
 #include "korganizerConduit.h"
-#include "todo-factory.h"
+#include "todo-conduit.h"
 #include "todo-setup.h"
 
 #include "uiDialog.h"
@@ -43,8 +44,29 @@
 {
 	FUNCTIONSETUP;
 	fConduitName = i18n("To-do");
-	UIDialog::addAboutPage(fConfigWidget->tabWidget,VCalConduitFactoryBase::about());
+	KAboutData *fAbout = new KAboutData("todoConduit",
+		I18N_NOOP("To-do Conduit for KPilot"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the To-do Conduit for KPilot"),
+		KAboutData::License_GPL,
+		"(C) 2001, Adriaan de Groot\n(C) 2002-2003, Reinhold Kainhofer");
+	fAbout->addAuthor("Dan Pilone",
+		I18N_NOOP("Original Author"));
+	fAbout->addAuthor("Preston Brown",
+		I18N_NOOP("Original Author"));
+	fAbout->addAuthor("Herwin-Jan Steehouwer",
+		I18N_NOOP("Original Author"));
+	fAbout->addAuthor("Adriaan de Groot",
+		I18N_NOOP("Maintainer"),
+		"groot@kde.org",
+		"http://www.cs.kun.nl/~adridg/kpilot");
+	fAbout->addAuthor("Reinhold Kainhofer",
+		I18N_NOOP("Maintainer"),
+		"reinhold@kainhofer.com",
+		"http://reinhold.kainhofer.com/Linux/");
 
+	UIDialog::addAboutPage(fConfigWidget->tabWidget,fAbout);
+
 	fConfigWidget->fSyncDestination->setTitle(i18n("To-do Destination"));
 }
 
@@ -58,8 +80,8 @@
 	return new ToDoWidgetSetup(w,n);
 }
 
-VCalConduitSettings*ToDoWidgetSetup::config() 
+VCalConduitSettings*ToDoWidgetSetup::config()
 {
-  return ToDoConduitFactory::config(); 
+  return TodoConduit::theConfig();
 }
 
Index: kpilot/conduits/vcalconduit/initstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/initstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/initstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,109 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the InitState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+#include <plugin.h>
+
+#include "vcal-conduitbase.h"
+#include "initstate.h"
+#include "teststate.h"
+#include "pctohhstate.h"
+#include "hhtopcstate.h"
+
+InitState::InitState()
+{
+	fState = eInit;
+}
+
+InitState::~InitState()
+{
+}
+
+void InitState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Starting InitState." << endl;
+
+	vccb->addLogMessage( i18n( "Initializing conduit ..." ) );
+	vccb->preSync();
+
+	if ( vccb->syncMode().isTest() )
+	{
+		fNextState = new TestState();
+	}
+	else
+	{
+		switch( vccb->syncMode().mode() )
+		{
+		case ConduitAction::SyncMode::eCopyPCToHH:
+			// TODO: Clear the palm and backup database??? Or just add the
+			// new items ignore the Palm->PC side and leave the existing items
+			// on the palm?
+			fNextState = new PCToHHState();
+			break;
+		case ConduitAction::SyncMode::eCopyHHToPC:
+			// TODO: Clear the backup database and the calendar, update fP
+			//       or just add the palm items and leave the PC ones there????
+			fNextState = new HHToPCState();
+			break;
+		default:
+			fNextState = new HHToPCState();
+			break;
+		}
+	}
+
+	fStarted = true;
+	vccb->setHasNextRecord( false );
+}
+
+void InitState::handleRecord( ConduitAction *vccb )
+{
+	FUNCTIONSETUP;
+	Q_UNUSED(vccb);
+}
+
+void InitState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finished InitState." << endl;
+	vccb->setState( fNextState );
+}
Index: kpilot/conduits/vcalconduit/todo-factory.cc
===================================================================
--- kpilot/conduits/vcalconduit/todo-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,118 +29,18 @@
 
 #include "options.h"
 
-#include <kaboutdata.h>
+#include "pluginfactory.h"
 
 #include "todo-setup.h"
 #include "todo-conduit.h"
-#include "todo-factory.moc"
-#include "vcalconduitSettings.h"
 
 extern "C"
 {
 
 void *init_conduit_todo()
 {
-	return new ToDoConduitFactory;
+	return new ConduitFactory<ToDoWidgetSetup,TodoConduit>;
 }
 
 }
 
-VCalConduitSettings* ToDoConduitFactory::fConfig=0L;
-
-ToDoConduitFactory::ToDoConduitFactory(QObject *p, const char *n) :
-	VCalConduitFactoryBase(p,n)
-{
-	FUNCTIONSETUP;
-
-	fInstance = new KInstance("todoconduit");
-	fAbout = new KAboutData("todoConduit",
-		I18N_NOOP("To-do Conduit for KPilot"),
-		KPILOT_VERSION,
-		I18N_NOOP("Configures the To-do Conduit for KPilot"),
-		KAboutData::License_GPL,
-		"(C) 2001, Adriaan de Groot\n(C) 2002-2003, Reinhold Kainhofer");
-	fAbout->addAuthor("Dan Pilone",
-		I18N_NOOP("Original Author"));
-	fAbout->addAuthor("Preston Brown",
-		I18N_NOOP("Original Author"));
-	fAbout->addAuthor("Herwin-Jan Steehouwer",
-		I18N_NOOP("Original Author"));
-	fAbout->addAuthor("Adriaan de Groot",
-		I18N_NOOP("Maintainer"),
-		"groot@kde.org",
-		"http://www.cs.kun.nl/~adridg/kpilot");
-	fAbout->addAuthor("Reinhold Kainhofer",
-		I18N_NOOP("Maintainer"),
-		"reinhold@kainhofer.com",
-		"http://reinhold.kainhofer.com/Linux/");
-}
-
-ToDoConduitFactory::~ToDoConduitFactory()
-{
-	FUNCTIONSETUP;
-
-	KPILOT_DELETE(fInstance);
-	KPILOT_DELETE(fAbout);
-}
-
-VCalConduitSettings* ToDoConduitFactory::config()
-{
-	if (!fConfig) {
- 		fConfig = new VCalConduitSettings( CSL1("ToDo") );
- 		if (fConfig) fConfig->readConfig();
-	}
-	return fConfig;
-}
-
-/* virtual */ QObject *ToDoConduitFactory::createObject( QObject *p,
-	const char *n,
-	const char *c,
-	const QStringList &a)
-{
-	FUNCTIONSETUP;
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< c
-		<< endl;
-#endif
-
-	if (qstrcmp(c,"ConduitConfigBase")==0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(p);
-
-		if (w)
-		{
-			return new ToDoWidgetSetup(w,n);
-		}
-		else
-		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< ": Couldn't cast parent to widget."
-				<< endl;
-#endif
-			return 0L;
-		}
-	}
-	else
-	if (qstrcmp(c,"SyncAction")==0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
-
-		if (d)
-		{
-			return new TodoConduit(d,n,a);
-		}
-		else
-		{
-			kdError() << k_funcinfo
-				<< ": Couldn't cast to KPilotDeviceLink."
-				<< endl;
-		}
-	}
-
-	return 0L;
-}
Index: kpilot/conduits/vcalconduit/todo-conduit.h
===================================================================
--- kpilot/conduits/vcalconduit/todo-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -37,10 +37,8 @@
 #include <pilotTodoEntry.h>
 #include "vcal-conduitbase.h"
 
-class PilotRecord;
 class PilotSerialDatabase;
 class PilotLocalDatabase;
-class PilotTodoEntry;
 
 class TodoConduitPrivate : public VCalConduitPrivateBase
 {
@@ -55,7 +53,7 @@
 	virtual void addIncidence(KCal::Incidence*);
 	virtual void removeIncidence(KCal::Incidence *);
 	virtual KCal::Incidence *findIncidence(recordid_t);
-	virtual KCal::Incidence *findIncidence(PilotAppCategory*tosearch);
+	virtual KCal::Incidence *findIncidence(PilotRecordBase *tosearch);
 	virtual KCal::Incidence *getNextIncidence();
 	virtual KCal::Incidence *getNextModifiedIncidence();
 	virtual int count() {return fAllTodos.count();};
@@ -67,16 +65,16 @@
 {
 Q_OBJECT
 public:
-	TodoConduit(KPilotDeviceLink *,
+	TodoConduit(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~TodoConduit();
 
 protected:
-	virtual const QString getTitle(PilotAppCategory*de);
+	virtual const QString getTitle(PilotRecordBase *de);
 
 	virtual const QString dbname() { return CSL1("ToDoDB"); };
-	virtual void preSync() {_getAppInfo(); };
+	virtual void preSync();
 	virtual VCalConduitPrivateBase* newVCalPrivate(KCal::Calendar *fCalendar) {
 		return new TodoConduitPrivate(fCalendar);
 	};
@@ -87,7 +85,7 @@
 	virtual void postSync();
 	QString _getCat(const QStringList cats, const QString curr) const;
 
-	virtual PilotAppCategory*newPilotEntry(PilotRecord*r) {
+	virtual PilotTodoEntry *newPilotEntry(PilotRecord*r) {
 		FUNCTIONSETUP;
 		if (r) return new PilotTodoEntry(*(fTodoAppInfo->info()), r);
 		else return new PilotTodoEntry(*(fTodoAppInfo->info()));
@@ -96,12 +94,14 @@
 
 	virtual void preRecord(PilotRecord*r);
 	virtual VCalConduitSettings *config();
+public:
+	static VCalConduitSettings *theConfig();
 
 protected:
 
-	PilotRecord *recordFromIncidence(PilotAppCategory*de, const KCal::Incidence*e);
+	PilotRecord *recordFromIncidence(PilotRecordBase *de, const KCal::Incidence*e);
 	PilotRecord *recordFromTodo(PilotTodoEntry*de, const KCal::Todo*e);
-	KCal::Incidence *incidenceFromRecord(KCal::Incidence *, const PilotAppCategory *);
+	KCal::Incidence *incidenceFromRecord(KCal::Incidence *, const PilotRecordBase *);
 	KCal::Todo *incidenceFromRecord(KCal::Todo *, const PilotTodoEntry *);
 
 	void setCategory(PilotTodoEntry*de, const KCal::Todo*todo);
Index: kpilot/conduits/vcalconduit/vcal-conduit.desktop
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -60,6 +60,7 @@
 Comment[fa]=این لوله، دستی شما را با کتاب دادۀ KOrganizer  همگام می‌سازد.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen KOrganizerin päiväkirjaan.
 Comment[fr]=Ce canal synchronise votre Palm avec l'agenda KOrganizer.
+Comment[gl]=Este conducto sincroniza o seu aparello portátil co libro de datos de KOrganizer.
 Comment[hu]=Ezzel a csatolóval szinkronizálhatók a kézi számítógép és a KOrganizer dátumai.
 Comment[is]=Þessi rás samstillir lófatölvuna þína við dagbók KOrganizer.
 Comment[it]=Questo conduit sincronizza il tuo palmare con il calendario di KOrganizer.
Index: kpilot/conduits/vcalconduit/teststate.h
===================================================================
--- kpilot/conduits/vcalconduit/teststate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/teststate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,55 @@
+#ifndef _KPILOT_TESTSTATE_H
+#define _KPILOT_TESTSTATE_H
+/* teststate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the teststate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <libkcal/calendarlocal.h>
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State to test the vcal-conduit. @see vcal-conduitstate.h
+ */
+class TestState : public ConduitState
+{
+private:
+	KCal::CalendarLocal fCalendar;
+	int fPilotindex;
+
+public:
+	TestState();
+	virtual ~TestState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/vcal-conduitbase.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,6 +5,7 @@
 **
 ** Contributions:
 **    Copyright (c) 2001 David Jarvie <software@astrojar.org.uk>
+**    Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
 **
 ** This file defines the vcal-conduit plugin.
 */
@@ -30,8 +31,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *vcalconduitbase_id = "$Id$";
-
 #include <options.h>
 
 #include <qtimer.h>
@@ -52,20 +51,20 @@
 #include "vcal-conduitbase.moc"
 #include "vcalconduitSettings.h"
 
-
 #ifndef LIBKCAL_IS_VERSION
 #warning "Using an old version of libkcal with timezone bug."
 #define LIBKCAL_IS_VERSION(a,b,c) (0)
 #endif
 
+#include "conduitstate.h"
+#include "initstate.h"
 
 
 /****************************************************************************
- *                          VCalConduitBase class                               *
+ *                          VCalConduitBase class                           *
  ****************************************************************************/
 
-
-VCalConduitBase::VCalConduitBase(KPilotDeviceLink *d,
+VCalConduitBase::VCalConduitBase(KPilotLink *d,
 	const char *n,
 	const QStringList &a) :
 	ConduitAction(d,n,a),
@@ -73,78 +72,93 @@
 	fP(0L)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<vcalconduitbase_id<<endl;
-#endif
+
+	fState = new InitState();
 }
 
-
-
 VCalConduitBase::~VCalConduitBase()
 {
 	FUNCTIONSETUP;
 
 	KPILOT_DELETE(fP);
+	KPILOT_DELETE(fState);
 	KPILOT_DELETE(fCalendar);
+	KPILOT_DELETE(fDatabase);
+	KPILOT_DELETE(fLocalDatabase);
 }
 
 
-/* There are several different scenarios for a record on the Palm and its PC counterpart
-	N means a new record, M flags a modified record, D a deleted and - an unmodified record
-	first is the Palm record, second the corresponding PC record
-	(-,-)...unchanged, just sync if first time or full sync
-	(N,-)...no rec matching the Palm ID in the backupDB/calendar yet => add KCal::Event
-	(M,-)...record is in backupDB, unchanged in calendar => modify in calendar and in backupDB
-	(D,-)...deleted on Palm, exists in backupDB and calendar => just delete from calendar and backupDB
-	(-,N)...no or invalid pilotID set for the KCal::Event => just add to palm and backupDB
-	(-,M)...valid PilotID set => just modify on Palm
-	(-,D)...Record in backupDB, but not in calendar => delete from Palm and backupDB
-	(N,N)...Can't find out (the two records are not correlated in any way, they just have the same data!!
-	(M,M),(M,L),(L,M)...(Record exists on Palm and the Event has the ID) CONFLICT, ask the user what to do
-		or use a config setting
-	(L,L)...already deleted on both, no need to do anything.
+/*
+	There are several different scenarios for a record on the Palm and its PC
+	counterpart. N means a new record, M flags a modified record, D a deleted
+	and - an unmodified record. First is the Palm record, second the
+	corresponding PC record:
+	(-,-) unchanged, just sync if first time or full sync
+	(N,-) no rec matching the Palm ID in the backupDB/calendar yet => add
+	      KCal::Event
+	(M,-) record is in backupDB, unchanged in calendar => modify in calendar and
+	      in backupDB
+	(D,-) deleted on Palm, exists in backupDB and calendar => just delete from
+	      calendar and backupDB
+	(-,N) no or invalid pilotID set for the KCal::Event => just add to palm and
+	      backupDB
+	(-,M) valid PilotID set => just modify on Palm
+	(-,D) Record in backupDB, but not in calendar => delete from Palm and
+	      backupDB
+	(N,N) Can't find out (the two records are not correlated in any way, they
+	      just have the same data!!
+	(M,M),(M,L),(L,M) (Record exists on Palm and the Event has the ID) CONFLICT,
+	      ask the user what to do or use a config setting
+	(L,L) already deleted on both, no need to do anything.
 
-
 	The sync process is as follows (for a fast sync):
-	1) slotPalmRecToPC goes through all records on Palm (just the modified one are necessary), find it
-		in the backupDB. The following handles ([NMD],*)
-		a) if it doesn't exist and was not deleted, add it to the calendar and the backupDB
-		b) if it exists and was not deleted,
-			A) if it is unchanged in the calendar, just modify in the calendar
-		c) if it exists and was deleted, delete it from the calendar if necessary
-	2) slotEvent goes through all KCale::Events in the calendar (just modified, this is the modification
-		time is later than the last sync time). This handles (-,N),(-,M)
-		a) if it does not have a pilotID, add it to the palm and backupDB, store the PalmID
+	1) HHToPCState goes through all records on Palm (just the modified one
+	   are necessary), find it in the backupDB. The following handles ([NMD],*)
+		a) if it doesn't exist and was not deleted, add it to the calendar and
+		   the backupDB
+		b) if it exists, is unchanged in the calendar and was not deleted,
+		   just modify in the calendar
+		c) if it exists and was deleted, delete it from the calendar if
+		   necessary
+	2) PCToHHState goes through all KCale::Events in the calendar (just
+	   modified, this is the modification time is later than the last sync time
+		). This handles (-,N),(-,M)
+		a) if it does not have a pilotID, add it to the palm and backupDB,
+		   store the PalmID
 		b) if it has a valid pilotID, update the Palm record and the backup
-	3) finally, deleteRecord goes through all records (which don't have the deleted flag) of the backup db
-		and if one does not exist in the Calendar, it was deleted there, so delete it from the Palm, too.
-		This handles the last remaining case of (-,D)
+	3) DeletedUnsyncedHHState goes through all palm records (which don't
+	   have the deleted flag) of the palm db and if one does not exist in the
+	   Calendar, it was deleted there, so delete it from the Palm and backup,
+	   too. This handles the case of (-,D)
+	4) DeletedUnsyncedPCState goes through all KCal::Events in the calendar and
+	   looks for a corresponding event in the palm database. If it does not
+	   exist, that means that it was deleted on the palm, so we need to also
+	   delete it from the local calendar.  This handles the case of (D,-).
 
+	In addition to the fast sync, where the last sync was done with this very
+	PC and calendar file, there are two special cases: a full and a first sync.
+	-) a full sync goes through all records, not just the modified ones. The
+	   pilotID setting of the calendar records is used to determine if the
+	   record already exists. if yes, the record is just modified.
+	-) a first sync completely ignores the pilotID setting of the calendar
+	   events. All records are added, so there might be duplicates. The add
+	   function for the calendar should check if a similar record already
+	   exists, but this is not done yet.
 
-In addition to the fast sync, where the last sync was done with this very PC and calendar file,
-there are two special cases: a full and a first sync.
--) a full sync goes through all records, not just the modified ones. The pilotID setting of the calendar
-	records is used to determine if the record already exists. if yes, the record is just modified
--) a first sync completely ignores the pilotID setting of the calendar events. All records are added,
-	so there might be duplicates. The add function for the calendar should check if a similar record already
-	exists, but this is not done yet.
-
-
--) a full sync is done if
-	a) there is a backupdb and a calendar, but the PC id number changed
-	b) it was explicitly requested by pressing the full sync button in KPilot
-	c) the setting "always full sync" was selected in the configuration dlg
--) a first sync is done if
-	a) either the calendar or the backup DB does not exist.
-	b) the calendar and the backup DB exists, but the sync is done for a different User name
-	c) it was explicitly requested in KPilot
-
+	-) a full sync is done if
+	   a) there is a backupdb and a calendar, but the PC id number changed
+	   b) it was explicitly requested by pressing the full sync button in KPilot
+	   c) the setting "always full sync" was selected in the configuration dlg
+	-) a first sync is done if
+	   a) either the calendar or the backup DB does not exist.
+	   b) the calendar and the backup DB exists, but the sync is done for a
+	      different User name
+	   c) it was explicitly requested in KPilot
 */
 
 /* virtual */ bool VCalConduitBase::exec()
 {
 	FUNCTIONSETUP;
-	DEBUGCONDUIT<<vcalconduitbase_id<<endl;
 
 	readConfig();
 
@@ -154,56 +168,64 @@
 
 	// TODO: Check Full sync and First sync
 	bool retrieved = false;
-	if (!openCalendar() ) goto error;
-	if (!openDatabases(dbname(), &retrieved) ) goto error;
+	if ( !openDatabases( dbname(), &retrieved ) ) goto error;
 	setFirstSync( retrieved );
-	preSync();
 
+	// If we are in testmode we don't need the local calendar. Else a
+	// calendar *must* be opened, we want to sync something don't we?
+	if (!syncMode().isTest() && !openCalendar() ) goto error;
 
-#ifdef DEBUG
-	DEBUGCONDUIT<<fname<<": fullsync="<<isFullSync()<<", firstSync="<<isFirstSync()<<endl;
-	DEBUGCONDUIT<<fname<<": syncAction=" << syncMode().name() <<
-		", conflictResolution = "<<getConflictResolution()<<", archive = "<<config()->syncArchived()<<endl;
-#endif
-
-	pilotindex=0;
-	switch (syncMode().mode())
-	{
-	case SyncMode::eCopyPCToHH:
-		// TODO: Clear the palm and backup database??? Or just add the new items ignore
-		// the Palm->PC side and leave the existing items on the palm?
-		emit logMessage(i18n("Copying records to Pilot ..."));
-		QTimer::singleShot(0, this, SLOT(slotPCRecToPalm()));
-		break;
-	case SyncMode::eCopyHHToPC:
-		// TODO: Clear the backup database and the calendar, update fP
-		//       or just add the palm items and leave the PC ones there????
-	default:
-		emit logMessage(i18n("Copying records to PC ..."));
-		QTimer::singleShot(0, this, SLOT(slotPalmRecToPC()));
-	}
+	// Start processing the sync
+	QTimer::singleShot(0, this, SLOT(slotProcess()));
 	return true;
 
 error:
+	emit logError( i18n( "Could not open the calendar databases." ) );
 
-	emit logError(i18n("Could not open the calendar databases."));
-
 	KPILOT_DELETE(fCalendar);
 	KPILOT_DELETE(fP);
+	KPILOT_DELETE(fState);
 	return false;
 }
 
+void VCalConduitBase::slotProcess() {
+	FUNCTIONSETUP;
 
+	// start the current state if necessary
+	if( fState && !fState->started() ) {
+		fState->startSync( this );
+	}
 
+	// Process next record if applicable
+	if( hasNextRecord )
+	{
+		fState->handleRecord( this );
+		QTimer::singleShot( 0, this, SLOT( slotProcess() ) );
+	}
+	// Else finish the current state if there is one
+	else if( fState )
+	{
+		fState->finishSync( this );
+		QTimer::singleShot( 0, this, SLOT( slotProcess() ) );
+	}
+	// No state so sync is finished
+	else
+	{
+		DEBUGCONDUIT << fname << ": Sync finished." << endl;
+		delayDone();
+	}
+}
+
 /* virtual */ void VCalConduitBase::readConfig()
 {
 	config()->readConfig();
-	SyncAction::ConflictResolution res=(SyncAction::ConflictResolution)(config()->conflictResolution());
-	setConflictResolution(res);
+	SyncAction::ConflictResolution res = (SyncAction::ConflictResolution)
+		(config()->conflictResolution());
+	setConflictResolution( res );
 }
 
 #ifdef DEBUG
-static void listResources(KCal::CalendarResources *p)
+static void listResources( KCal::CalendarResources *p )
 {
 	FUNCTIONSETUP;
 	KCal::CalendarResourceManager *manager = p->resourceManager();
@@ -222,71 +244,64 @@
 	FUNCTIONSETUP;
 
 	KConfig korgcfg( locate( "config", CSL1("korganizerrc") ) );
+
 	// this part taken from adcalendarbase.cpp:
 	korgcfg.setGroup( "Time & Date" );
 	QString tz(korgcfg.readEntry( "TimeZoneId" ) );
-#ifdef DEBUG
+
 	DEBUGCONDUIT << fname << ": KOrganizer's time zone = " << tz << endl;
-#endif
 
 	// Need a subclass ptr. for the ResourceCalendar methods
 	KCal::CalendarResources *rescal = 0L;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Got calendar type " << config()->calendarType() << endl;
-#endif
+	DEBUGCONDUIT << fname << ": Got calendar type " << config()->calendarType()
+		<< endl;
 
 	switch(config()->calendarType())
 	{
 		case VCalConduitSettings::eCalendarLocal:
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< "Using CalendarLocal, file="
+			DEBUGCONDUIT << fname << "Using CalendarLocal, file = "
 				<< config()->calendarFile() << endl;
-#endif
-			if (config()->calendarFile().isEmpty() )
+
+			if ( config()->calendarFile().isEmpty() )
 			{
-#ifdef DEBUG
-				DEBUGCONDUIT << fname
-					<< "Empty calendar file name."
-					<< endl;
-#endif
-				emit logError(i18n("You selected to sync with the a iCalendar file, "
-						"but did not give a filename. Please select a valid file name in "
-						"the conduit's configuration dialog"));
+				DEBUGCONDUIT << fname << "Empty calendar file name." << endl;
+
+				emit logError( i18n( "You selected to sync with an iCalendar"
+						" file, but did not give a filename. Please select a"
+						" valid file name in the conduit's configuration"
+						" dialog" ) );
 				return false;
 			}
 
-			fCalendar = new KCal::CalendarLocal(tz);
-			if ( !fCalendar)
+			fCalendar = new KCal::CalendarLocal( tz );
+			if ( !fCalendar )
 			{
 				kdWarning() << k_funcinfo
 					<< "Cannot initialize calendar object for file "
 					<< config()->calendarFile() << endl;
 				return false;
 			}
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< "Calendar's timezone: "
+
+			DEBUGCONDUIT << fname << "Calendar's timezone: "
 				<< fCalendar->timeZoneId() << endl;
-			DEBUGCONDUIT << fname
-				<< "Calendar is local time: "
+			DEBUGCONDUIT << fname << "Calendar is local time: "
 				<< fCalendar->isLocalTime() << endl;
-#endif
+
 			emit logMessage( fCalendar->isLocalTime() ?
-				i18n("Using local time zone: %1").arg(tz) :
-				i18n("Using non-local time zone: %1").arg(tz) );
+				i18n( "Using local time zone: %1" ).arg( tz ) :
+				i18n( "Using non-local time zone: %1" ).arg( tz ) );
 
-			KURL kurl(config()->calendarFile());
-			if(!KIO::NetAccess::download(config()->calendarFile(), fCalendarFile, 0L) &&
-				!kurl.isLocalFile())
+			KURL kurl( config()->calendarFile() );
+			if( !KIO::NetAccess::download( config()->calendarFile(),
+				fCalendarFile, 0L ) && !kurl.isLocalFile() )
 			{
-				emit logError(i18n("You chose to sync with the file \"%1\", which "
-							"cannot be opened. Please make sure to supply a "
-							"valid file name in the conduit's configuration dialog. "
-							"Aborting the conduit.").arg(config()->calendarFile()));
-				KIO::NetAccess::removeTempFile(fCalendarFile);
+				emit logError(i18n( "You chose to sync with the file \"%1\", which "
+					"cannot be opened. Please make sure to supply a "
+					"valid file name in the conduit's configuration dialog. "
+					"Aborting the conduit." ).arg( config()->calendarFile() ) );
+				KIO::NetAccess::removeTempFile( fCalendarFile );
 				return false;
 			}
 
@@ -294,41 +309,34 @@
 			// the calendar is initialized, so nothing more to do...
 			if (!dynamic_cast<KCal::CalendarLocal*>(fCalendar)->load(fCalendarFile) )
 			{
-#ifdef DEBUG
-				DEBUGCONDUIT << fname
-					<< "Calendar file "
-					<< fCalendarFile
-					<< " could not be opened. "
-					   "Will create a new one"
-					<< endl;
-#endif
+				DEBUGCONDUIT << fname << "Calendar file " << fCalendarFile
+					<< " could not be opened. Will create a new one" << endl;
+
 				// Try to create empty file. if it fails,
 				// no valid file name was given.
 				QFile fl(fCalendarFile);
 				if (!fl.open(IO_WriteOnly | IO_Append))
 				{
-#ifdef DEBUG
-					DEBUGCONDUIT << fname
-						<< "Invalid calendar file name "
+					DEBUGCONDUIT << fname << "Invalid calendar file name "
 						<< fCalendarFile << endl;
-#endif
-					emit logError(i18n("You chose to sync with the file \"%1\", which "
-							"cannot be opened or created. Please make sure to supply a "
-							"valid file name in the conduit's configuration dialog. "
-							"Aborting the conduit.").arg(config()->calendarFile()));
+
+					emit logError( i18n( "You chose to sync with the file \"%1\", which "
+						"cannot be opened or created. Please make sure to supply a "
+						"valid file name in the conduit's configuration dialog. "
+						"Aborting the conduit." ).arg( config()->calendarFile() ) );
 					return false;
 				}
 				fl.close();
 				setFirstSync( true );
 			}
-			addSyncLogEntry(i18n("Syncing with file \"%1\"").arg(config()->calendarFile()));
+			addSyncLogEntry( i18n( "Syncing with file \"%1\"" )
+				.arg( config()->calendarFile() ) );
 			break;
 		}
 
 		case VCalConduitSettings::eCalendarResource:
-#ifdef DEBUG
 			DEBUGCONDUIT << "Using CalendarResource!" << endl;
-#endif
+
 			rescal = new KCal::CalendarResources( tz );
 #ifdef DEBUG
 			listResources(rescal);
@@ -336,39 +344,42 @@
 			fCalendar = rescal;
 			if ( !fCalendar)
 			{
-				kdWarning() << k_funcinfo << "Cannot initialize calendar "<<
-					"object for ResourceCalendar"<<endl;
+				kdWarning() << k_funcinfo << "Cannot initialize calendar " <<
+					"object for ResourceCalendar" << endl;
 				return false;
 			}
+
 #if LIBKCAL_IS_VERSION(1,1,0)
 			rescal->readConfig();
 			rescal->load();
 #else
 #warning "Timezone bug is present."
 #endif
-			addSyncLogEntry(i18n("Syncing with standard calendar resource."));
+			addSyncLogEntry( i18n( "Syncing with standard calendar resource." ) );
 			emit logMessage( fCalendar->isLocalTime() ?
-				i18n("Using local time zone: %1").arg(tz) :
-				i18n("Using non-local time zone: %1").arg(tz) );
+				i18n( "Using local time zone: %1" ).arg( tz ) :
+				i18n( "Using non-local time zone: %1" ).arg( tz ) );
 			break;
 		default:
 			break;
-
 	}
 
-	if (!fCalendar)
+	if ( !fCalendar )
 	{
-		kdWarning() <<k_funcinfo << "Unable to initialize calendar object. Please check the conduit's setup."<<endl;
-		emit logError(i18n("Unable to initialize the calendar object. Please check the conduit's setup"));
+		kdWarning() <<k_funcinfo << "Unable to initialize calendar object."
+			<< " Please check the conduit's setup." << endl;
+		emit logError( i18n( "Unable to initialize the calendar object. Please"
+			" check the conduit's setup") );
 		return false;
 	}
-	fP = newVCalPrivate(fCalendar);
-	if (!fP)
+	fP = newVCalPrivate( fCalendar );
+	if ( !fP )
 	{
 		return false;
 	}
 	fP->updateIncidences();
-	if (fP->count()<1)
+
+	if ( fP->count() < 1 )
 	{
 		setFirstSync( true );
 	}
@@ -376,303 +387,59 @@
 	return true;
 }
 
-
-
-void VCalConduitBase::slotPalmRecToPC()
+KCal::Incidence* VCalConduitBase::addRecord( PilotRecord *r )
 {
 	FUNCTIONSETUP;
 
-	PilotRecord *r;
-	if (isFullSync())
-	{
-		r = fDatabase->readRecordByIndex(pilotindex++);
-	}
-	else
-	{
-		r = fDatabase->readNextModifiedRec();
-	}
-	PilotRecord *s = 0L;
-
-	if (!r)
-	{
-		fP->updateIncidences();
-		if ( syncMode()==SyncMode::eCopyHHToPC )
-		{
-			emit logMessage(i18n("Cleaning up ..."));
-			QTimer::singleShot(0, this, SLOT(cleanup()));
-			return;
-		}
-		else
-		{
-			emit logMessage(i18n("Copying records to Pilot ..."));
-			QTimer::singleShot(0 ,this,SLOT(slotPCRecToPalm()));
-			return;
-		}
-	}
-
-	// let subclasses do something with the record before we try to sync
-	preRecord(r);
-
-//	DEBUGCONDUIT<<fname<<": Event: "<<e->dtStart()<<" until "<<e->dtEnd()<<endl;
-//	DEBUGCONDUIT<<fname<<": Time: "<<e->dtStart()<<" until "<<e->dtEnd()<<endl;
-	bool archiveRecord=(r->isArchived());
-
-	s = fLocalDatabase->readRecordById(r->id());
-	if (!s || isFirstSync())
-	{
+	recordid_t id = fLocalDatabase->writeRecord( r );
 #ifdef DEBUG
-		if (r->id()>0 && !s)
-		{
-			DEBUGCONDUIT<<"---------------------------------------------------------------------------"<<endl;
-			DEBUGCONDUIT<< fname<<": Could not read palm record with ID "<<r->id()<<endl;
-		}
-#endif
-		if (!r->isDeleted() || (config()->syncArchived() && archiveRecord))
-		{
-			KCal::Incidence*e=addRecord(r);
-			if (config()->syncArchived() && archiveRecord)  {
-				e->setSyncStatus(KCal::Incidence::SYNCDEL);
-			}
-		}
-	}
-	else
-	{
-		if (r->isDeleted())
-		{
-			if (config()->syncArchived() && archiveRecord)
-			{
-				changeRecord(r,s);
-			}
-			else
-			{
-				deleteRecord(r,s);
-			}
-		}
-		else
-		{
-			changeRecord(r,s);
-		}
-	}
-
-	KPILOT_DELETE(r);
-	KPILOT_DELETE(s);
-
-	QTimer::singleShot(0,this,SLOT(slotPalmRecToPC()));
-}
-
-
-void VCalConduitBase::slotPCRecToPalm()
-{
-	FUNCTIONSETUP;
-	KCal::Incidence*e=0L;
-	if (isFullSync()) e=fP->getNextIncidence();
-	else e=fP->getNextModifiedIncidence();
-
-	if (!e)
-	{
-		pilotindex=0;
-		// if we are asked to copy HH to PC, we shouldn't look for deleted records
-		// on the Palm, since we've just copied them all.  =:)  Otherwise, look for
-		// data on the palm that shouldn't be there and delete it if we find it....
-		if ( syncMode()==SyncMode::eCopyHHToPC )
-		{
-			QTimer::singleShot(0, this, SLOT(cleanup()));
-		}
-		else
-		{
-			QTimer::singleShot(0,this,SLOT(slotDeletedIncidence()));
-		}
-		return;
-	}
-
-	// let subclasses do something with the event
-	preIncidence(e);
-
-	// find the corresponding index on the palm and sync. If there is none, create it.
-	recordid_t ix=e->pilotId();
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": found PC entry with pilotID "<<ix<<endl;
-		DEBUGCONDUIT<<fname<<": Description: "<<e->summary()<<endl;
-		DEBUGCONDUIT<<fname<<": Time: "<<e->dtStart().toString()<<" until "<<e->dtEnd().toString()<<endl;
-#endif
-	PilotRecord *s=0L;
-	if (ix>0 && (s=fDatabase->readRecordById(ix)))
-	{
-		if (e->syncStatus()==KCal::Incidence::SYNCDEL)
-		{
-			deletePalmRecord(e, s);
-		}
-		else
-		{
-			changePalmRecord(e, s);
-		}
-		KPILOT_DELETE(s);
-	} else {
-#ifdef DEBUG
-		if (ix>0)
-		{
-			DEBUGCONDUIT<<"---------------------------------------------------------------------------"<<endl;
-			DEBUGCONDUIT<< fname<<": Could not read palm record with ID "<<ix<<endl;
-		}
-#endif
-		addPalmRecord(e);
-	}
-	QTimer::singleShot(0, this, SLOT(slotPCRecToPalm()));
-}
-
-
-void VCalConduitBase::slotDeletedIncidence()
-{
-	FUNCTIONSETUP;
-
-	PilotRecord *r = fLocalDatabase->readRecordByIndex(pilotindex++);
-	if (!r || (syncMode()==SyncMode::eCopyHHToPC) )
-	{
-		QTimer::singleShot(0 ,this,SLOT(cleanup()));
-		return;
-	}
-
-	KCal::Incidence *e = fP->findIncidence(r->id());
-	if (!e)
-	{
-#ifdef DEBUG
-		DEBUGCONDUIT<<"didn't find incidence with id="<<r->id()<<", deleting it"<<endl;
-#endif
-		// entry was deleted from Calendar, so delete it from the palm
-//		PilotRecord*s=fLocalDatabase->readRecordById(r->id());
-//		if (s)
-//		{
-//			// delete the record from the palm
-//			s->setDeleted();
-////			s->setAttrib(s->getAttrib() & ~dlpRecAttrDeleted & ~dlpRecAttrDirty);
-//			fDatabase->writeRecord(s);
-//			KPILOT_DELETE(s);
-//		}
-		deletePalmRecord(NULL, r);
-//		r->setDeleted();
-////		r->setAttrib(r->getAttrib() & ~dlpRecAttrDeleted & ~dlpRecAttrDirty);
-//		fLocalDatabase->writeRecord(r);
-//		fDatabase->writeRecord(r);
-	}
-
-	KPILOT_DELETE(r);
-	QTimer::singleShot(0,this,SLOT(slotDeletedIncidence()));
-}
-
-
-void VCalConduitBase::cleanup()
-{
-	FUNCTIONSETUP;
-	postSync();
-
-	if (fDatabase)
-	{
-		fDatabase->resetSyncFlags();
-		fDatabase->cleanup();
-	}
-	if (fLocalDatabase)
-	{
-		fLocalDatabase->resetSyncFlags();
-		fLocalDatabase->cleanup();
-	}
-	KPILOT_DELETE(fDatabase);
-	KPILOT_DELETE(fLocalDatabase);
-	if (fCalendar)
-	{
-		KURL kurl(config()->calendarFile());
-		switch(config()->calendarType())
-		{
-			case VCalConduitSettings::eCalendarLocal:
-				dynamic_cast<KCal::CalendarLocal*>(fCalendar)->save(fCalendarFile);
-				if(!kurl.isLocalFile())
-				{
-					if(!KIO::NetAccess::upload(fCalendarFile, config()->calendarFile(), 0L)) {
-						emit logError(i18n("An error occurred while uploading \"%1\". You can try to upload "
-							"the temporary local file \"%2\" manually.")
-							.arg(config()->calendarFile()).arg(fCalendarFile));
-					}
-					else {
-						KIO::NetAccess::removeTempFile(fCalendarFile);
-					}
-					QFile backup(fCalendarFile + CSL1("~"));
-					backup.remove();
-				}
-				break;
-			case VCalConduitSettings::eCalendarResource:
-				fCalendar->save();
-				break;
-			default:
-				break;
-		}
-		fCalendar->close();
-	}
-	KPILOT_DELETE(fCalendar);
-	KPILOT_DELETE(fP);
-
-	emit syncDone(this);
-}
-
-
-
-void VCalConduitBase::postSync()
-{
-	FUNCTIONSETUP;
-}
-
-
-KCal::Incidence* VCalConduitBase::addRecord(PilotRecord *r)
-{
-	FUNCTIONSETUP;
-
-	recordid_t id=fLocalDatabase->writeRecord(r);
-#ifdef DEBUG
-	DEBUGCONDUIT<<fname<<": Pilot Record ID="<<r->id()<<", backup ID="<<id<<endl;
+	DEBUGCONDUIT<<fname<<": Pilot Record ID = " << r->id() << ", backup ID = "
+		<< id << endl;
 #else
 	Q_UNUSED(id);
 #endif
 
-	PilotAppCategory *de=newPilotEntry(r);
-	KCal::Incidence*e =0L;
+	PilotRecordBase *de = newPilotEntry( r );
+	KCal::Incidence*e = 0L;
 
-	if (de)
+	if ( de )
 	{
-		e=fP->findIncidence(r->id());
-		if (!e)
+		e = fP->findIncidence( r->id() );
+		if ( !e )
 		{
 			// no corresponding entry found, so create, copy and insert it.
-			e=newIncidence();
-			incidenceFromRecord(e,de);
-			fP->addIncidence(e);
+			e = newIncidence();
+			incidenceFromRecord( e, de );
+			fP->addIncidence( e );
 		}
 		else
 		{
 			// similar entry found, so just copy, no need to insert again
-			incidenceFromRecord(e,de);
+			incidenceFromRecord( e, de );
 		}
 	}
-	KPILOT_DELETE(de);
+	KPILOT_DELETE( de );
 	return e;
 }
 
-// return how to resolve conflicts. for now PalmOverrides=0=false, PCOverrides=1=true, Ask=2-> ask the user using a messagebox
-int VCalConduitBase::resolveConflict(KCal::Incidence*e, PilotAppCategory*de) {
-	if (getConflictResolution()==SyncAction::eAskUser)
+int VCalConduitBase::resolveConflict( KCal::Incidence *e, PilotRecordBase *de ) {
+	if ( getConflictResolution() == SyncAction::eAskUser )
 	{
 		// TODO: This is messed up!!!
-		QString query = i18n("The following item was modified "
-			"both on the Handheld and on your PC:\nPC entry:\n\t");
+		QString query = i18n( "The following item was modified "
+			"both on the Handheld and on your PC:\nPC entry:\n\t" );
 		query += e->summary();
-		query += i18n("\nHandheld entry:\n\t");
-		query += getTitle(de);
-		query += i18n("\n\nWhich entry do you want to keep? It will "
-			"overwrite the other entry.");
+		query += i18n( "\nHandheld entry:\n\t" );
+		query += getTitle( de );
+		query += i18n( "\n\nWhich entry do you want to keep? It will "
+			"overwrite the other entry." );
 
 		return KMessageBox::No == questionYesNo(
 			query,
-			i18n("Conflicting Entries"),
+			i18n( "Conflicting Entries" ),
 			QString::null,
 			0 /* Never timeout */,
-			i18n("Handheld"), i18n("PC"));
+			i18n( "Handheld" ), i18n( "PC" ));
 	}
 	return getConflictResolution();
 }
@@ -681,41 +448,43 @@
 {
 	FUNCTIONSETUP;
 
-	PilotAppCategory*de=newPilotEntry(r);
-	KCal::Incidence *e = fP->findIncidence(r->id());
-#ifdef DEBUG
-	DEBUGCONDUIT<<fname<<": Pilot Record ID: ["<<r->id() << "]" <<endl;
-#endif
+	PilotRecordBase *de = newPilotEntry( r );
+	KCal::Incidence *e = fP->findIncidence( r->id() );
 
-	if (e && de)
+	DEBUGCONDUIT << fname << ": Pilot Record ID: [" << r->id() << "]" << endl;
+
+	if ( e && de )
 	{
 		// TODO: check for conflict, and if there is one, ask for resolution
-		if ( (e->syncStatus()!=KCal::Incidence::SYNCNONE) && (r->isDirty() ) )
+		if ( ( e->syncStatus() != KCal::Incidence::SYNCNONE )
+			&& r->isModified() )
 		{
 			// TODO: I have not yet found a way to complete ignore an item
-			if (resolveConflict(e, de))
+			if (resolveConflict( e, de ) )
 			{
 				// PC record takes precedence:
-				KPILOT_DELETE(de);
+				KPILOT_DELETE( de );
 				return e;
 			}
 		}
 		// no conflict or conflict resolution says, Palm overwrites, so do it:
-		incidenceFromRecord(e,de);
-		e->setSyncStatus(KCal::Incidence::SYNCNONE);
-		fLocalDatabase->writeRecord(r);
+		incidenceFromRecord( e, de );
+		e->setSyncStatus( KCal::Incidence::SYNCNONE );
+		fLocalDatabase->writeRecord( r );
 	}
 	else
 	{
-		kdWarning() << k_funcinfo << ": While changing record -- not found in iCalendar" << endl;
-		addRecord(r);
+		kdWarning() << k_funcinfo
+			<< ": While changing record -- not found in iCalendar" << endl;
+		addRecord( r );
 	}
-	KPILOT_DELETE(de);
+
+	KPILOT_DELETE( de );
 	return e;
 }
 
 
-KCal::Incidence*VCalConduitBase::deleteRecord(PilotRecord *r, PilotRecord *)
+KCal::Incidence*VCalConduitBase::deleteRecord( PilotRecord *r, PilotRecord * )
 {
 	FUNCTIONSETUP;
 
@@ -725,84 +494,80 @@
 		// RemoveEvent also takes it out of the calendar.
 		fP->removeIncidence(e);
 	}
-	fLocalDatabase->writeRecord(r);
+	fLocalDatabase->writeRecord( r );
 	return NULL;
 }
 
 
-void VCalConduitBase::addPalmRecord(KCal::Incidence*e)
+void VCalConduitBase::addPalmRecord( KCal::Incidence *e )
 {
 	FUNCTIONSETUP;
 
-	PilotAppCategory*de=newPilotEntry(NULL);
-	updateIncidenceOnPalm(e, de);
-	KPILOT_DELETE(de);
+	PilotRecordBase *de = newPilotEntry( 0L );
+	updateIncidenceOnPalm( e, de );
+	KPILOT_DELETE( de );
 }
 
 
 void VCalConduitBase::changePalmRecord(KCal::Incidence*e, PilotRecord*s)
 {
-	PilotAppCategory*de=newPilotEntry(s);
-	updateIncidenceOnPalm(e, de);
-	KPILOT_DELETE(de);
+	PilotRecordBase *de = newPilotEntry( s );
+	updateIncidenceOnPalm( e, de );
+	KPILOT_DELETE( de );
 }
 
 
-void VCalConduitBase::deletePalmRecord(KCal::Incidence*e, PilotRecord*s)
+void VCalConduitBase::deletePalmRecord( KCal::Incidence *e, PilotRecord *s )
 {
 	FUNCTIONSETUP;
-	if (s)
+	if ( s )
 	{
-#ifdef DEBUG
 		DEBUGCONDUIT << fname << ": deleting record " << s->id() << endl;
-#endif
 		s->setDeleted();
-		fDatabase->writeRecord(s);
-		fLocalDatabase->writeRecord(s);
+		fDatabase->writeRecord( s );
+		fLocalDatabase->writeRecord( s );
 	}
 	else
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": could not find record to delete (" << e->pilotId() << ")" << endl;
-#endif
+		DEBUGCONDUIT << fname << ": could not find record to delete (";
+		DEBUGCONDUIT << e->pilotId() << ")" << endl;
 	}
 
 	Q_UNUSED(e);
 }
 
-
 /* I have to use a pointer to an existing PilotDateEntry so that I can handle
    new records as well (and to prevent some crashes concerning the validity
    domain of the PilotRecord*r). In syncEvent this PilotDateEntry is created. */
-void VCalConduitBase::updateIncidenceOnPalm(KCal::Incidence*e, PilotAppCategory*de)
+void VCalConduitBase::updateIncidenceOnPalm( KCal::Incidence *e,
+	PilotRecordBase *de )
 {
 	FUNCTIONSETUP;
-	if (!de || !e ) {
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": NULL event given... Skipping it"<<endl;
-#endif
+	if ( !de || !e ) {
+		DEBUGCONDUIT << fname << ": NULL event given... Skipping it" << endl;
 		return;
 	}
-	if (e->syncStatus()==KCal::Incidence::SYNCDEL)
+
+	if ( e->syncStatus() == KCal::Incidence::SYNCDEL )
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": don't write deleted incidence "<<e->summary()<<" to the palm"<<endl;
-#endif
+		DEBUGCONDUIT << fname << ": don't write deleted incidence "
+			<< e->summary() << " to the palm" << endl;
 		return;
 	}
-	PilotRecord*r=recordFromIncidence(de, e);
 
+	PilotRecord *r = recordFromIncidence( de, e );
+
 	// TODO: Check for conflict!
-	if (r)
+	if ( r )
 	{
 		recordid_t id=fDatabase->writeRecord(r);
 		r->setID(id);
 //		r->setAttrib(r->getAttrib() & ~dlpRecAttrDeleted);
-		fLocalDatabase->writeRecord(r);
+		fLocalDatabase->writeRecord( r );
 //		fDatabase->writeRecord(r);
-		e->setPilotId(id);
-		e->setSyncStatus(KCal::Incidence::SYNCNONE);
-		KPILOT_DELETE(r);
+		e->setPilotId( id );
+		e->setSyncStatus( KCal::Incidence::SYNCNONE );
+		KPILOT_DELETE( r );
 	}
 }
 
@@ -811,4 +576,25 @@
     return QString::null;
 }
 
+PilotRecord *VCalConduitBase::readRecordByIndex( int index )
+{
+	FUNCTIONSETUP;
+	return fDatabase->readRecordByIndex( index );
+}
 
+KCal::Incidence *VCalConduitBase::incidenceFromRecord( PilotRecord *r )
+{
+	FUNCTIONSETUP;
+	PilotRecordBase *pac = newPilotEntry( r );
+	KCal::Incidence *i = newIncidence();
+	incidenceFromRecord( i, pac );
+
+	KPILOT_DELETE( pac );
+	return i;
+}
+
+void VCalConduitBase::setState( ConduitState *s )
+{
+	KPILOT_DELETE( fState );
+	fState = s;
+};
Index: kpilot/conduits/vcalconduit/vcal-setup.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-setup.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-setup.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,10 +30,10 @@
 #include "options.h"
 
 #include <qbuttongroup.h>
-#include <klocale.h>
+#include <kaboutdata.h>
 
 #include "korganizerConduit.h"
-#include "vcal-factory.h"
+#include "vcal-conduit.h"
 #include "vcal-setup.h"
 
 #include "uiDialog.h"
@@ -41,7 +41,32 @@
 VCalWidgetSetup::VCalWidgetSetup(QWidget *w, const char *n) :
 	VCalWidgetSetupBase(w,n)
 {
-	UIDialog::addAboutPage(fConfigWidget->tabWidget, VCalConduitFactoryBase::about());
+	KAboutData *fAbout = new KAboutData("vcalConduit",
+		I18N_NOOP("VCal Conduit for KPilot"),
+		KPILOT_VERSION,
+		I18N_NOOP("Configures the VCal Conduit for KPilot"),
+		KAboutData::License_GPL,
+		"(C) 2001, Adriaan de Groot\n(C) 2002-2003, Reinhold Kainhofer");
+	fAbout->addAuthor("Adriaan de Groot",
+		I18N_NOOP("Maintainer"),
+		"groot@kde.org",
+		"http://www.kpilot.org/");
+	fAbout->addAuthor("Reinhold Kainhofer",
+		I18N_NOOP("Maintainer"),
+		"reinhold@kainhofer.com",
+		"http://reinhold.kainhofer.com/Linux/");
+	fAbout->addAuthor("Dan Pilone",
+		I18N_NOOP("Original Author"));
+	fAbout->addAuthor("Preston Brown",
+		I18N_NOOP("Original Author"));
+	fAbout->addAuthor("Herwin-Jan Steehouwer",
+		I18N_NOOP("Original Author"));
+	fAbout->addCredit("Cornelius Schumacher",
+		I18N_NOOP("iCalendar port"));
+	fAbout->addCredit("Philipp Hullmann",
+		I18N_NOOP("Bugfixer"));
+
+	UIDialog::addAboutPage(fConfigWidget->tabWidget, fAbout);
 	fConfigWidget->fSyncDestination->setTitle(i18n("Calendar Destination"));
 	fConduitName=i18n("Calendar");
 
@@ -51,4 +76,4 @@
 {
 	return new VCalWidgetSetup(w,n);
 }
-VCalConduitSettings*VCalWidgetSetup::config() { return VCalConduitFactory::config(); }
+VCalConduitSettings*VCalWidgetSetup::config() { return VCalConduit::theConfig(); }
Index: kpilot/conduits/vcalconduit/vcal-conduitbase.h
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduitbase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-conduitbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,21 +29,25 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
+
+#include <qstring.h>
+
+#include <libkcal/calendarlocal.h>
+
 #include <plugin.h>
+#include <pilotRecord.h>
 
-
 namespace KCal
 {
 class Calendar;
 class Incidence;
 }
 
-class PilotRecord;
 class PilotSerialDatabase;
 class PilotLocalDatabase;
-class PilotAppCategory;
 class VCalConduitSettings;
 
+class ConduitState;
 
 class VCalConduitPrivateBase
 {
@@ -51,95 +55,148 @@
 	bool reading;
 	KCal::Calendar *fCalendar;
 public:
-	VCalConduitPrivateBase(KCal::Calendar *buddy):fCalendar(buddy) { reading=false;};
+	VCalConduitPrivateBase(KCal::Calendar *buddy) : fCalendar(buddy)
+	{
+		reading = false;
+	};
 
-	virtual int updateIncidences()=0;
-	virtual void addIncidence(KCal::Incidence*)=0;
-	virtual void removeIncidence(KCal::Incidence *)=0;
-	virtual KCal::Incidence *findIncidence(recordid_t)=0;
-	virtual KCal::Incidence *findIncidence(PilotAppCategory*tosearch)=0;
-	virtual KCal::Incidence *getNextIncidence()=0;
-	virtual KCal::Incidence *getNextModifiedIncidence()=0;
+	virtual ~VCalConduitPrivateBase() { } ;
+
+	virtual int updateIncidences() = 0;
+	virtual void addIncidence(KCal::Incidence*) = 0;
+	virtual void removeIncidence(KCal::Incidence*) = 0;
+	virtual KCal::Incidence *findIncidence(recordid_t) = 0;
+	virtual KCal::Incidence *findIncidence(PilotRecordBase *tosearch) = 0;
+	virtual KCal::Incidence *getNextIncidence() = 0;
+	virtual KCal::Incidence *getNextModifiedIncidence() = 0;
 	virtual int count()=0;
 } ;
 
-
-
 class VCalConduitBase : public ConduitAction
 {
         Q_OBJECT
 public:
-	VCalConduitBase(KPilotDeviceLink *,
-		const char *name=0L,
+	VCalConduitBase(KPilotLink *,
+		const char *name = 0L,
 		const QStringList &args = QStringList());
 	virtual ~VCalConduitBase();
 
+/*********************************************************************
+                D A T A   M E M B E R S ,   S E T T I N G S
+ *********************************************************************/
 protected:
+	KCal::Calendar *fCalendar;
+	QString fCalendarFile;
+	VCalConduitPrivateBase *fP;
+	ConduitState *fState;
+	bool hasNextRecord;
+
+	virtual const QString dbname() = 0;
+	virtual const QString getTitle(PilotRecordBase *de) = 0;
+	virtual void readConfig();
+
 	virtual bool exec();
 
 protected slots:
 	/**
-	* This function is called to sync modified records from the Pilot to KOrganizer.
-	*/
-	void slotPalmRecToPC();
-	/**
-	* This function goes the other way around: KOrganizer -> Pilot.
-	*/
-	void slotPCRecToPalm();
-	void slotDeletedIncidence();
-	void cleanup();
+	 * This slot is used to execute the actions applicable to this conduit. What
+	 * happens in this method is defined by the state the conduit has at the
+	 * moment that this method is called. For more information about the actions
+	 * that are executed, look at the classes that are implementing ConduitState.
+	 */
+	void slotProcess();
 
+public:
+	// Maybe it's better to make this methods public in ConduitAction. They need
+	// to be public so that the state classes can access them.
+	const SyncMode &syncMode() const { return ConduitAction::syncMode(); };
+	bool isFullSync() const { return ConduitAction::isFullSync(); };
+	bool isFirstSync() const { return ConduitAction::isFirstSync(); };
 
-protected:
+	/**
+	 * Method used by state classes to indicatie if there are more records to
+	 * deal with.
+	 */
+	void setHasNextRecord( bool b) { hasNextRecord = b; };
 
-	virtual int resolveConflict(KCal::Incidence*e, PilotAppCategory*de);
+	/**
+	 * Change the current state of the conduit. The state that the conduit has
+	 * at the moment of the call will be deleted. The last state *must* set the
+	 * state to 0L when finished.
+	 */
+	void setState( ConduitState *s );
 
-	// add, change or delete events from the calendar
-	virtual KCal::Incidence* addRecord(PilotRecord *);
-	virtual KCal::Incidence* changeRecord(PilotRecord *,PilotRecord *);
-	virtual KCal::Incidence* deleteRecord(PilotRecord *,PilotRecord *);
+	/**
+	 * Returns the privatebase, that is used to for accessing the local calendar.
+	 */
+	VCalConduitPrivateBase *privateBase() const { return fP; };
 
-	// add, change or delete records from the palm
-	virtual void addPalmRecord(KCal::Incidence*e);
-	virtual void changePalmRecord(KCal::Incidence*e, PilotRecord*s);
-	virtual void deletePalmRecord(KCal::Incidence*e, PilotRecord*s);
+	/**
+	 * Returns the record at index from the palm or 0L if there is no record at
+	 * index.
+	 */
+	PilotRecord *readRecordByIndex( int index );
 
-	virtual void updateIncidenceOnPalm(KCal::Incidence*e, PilotAppCategory*de);
+	/**
+	 * Returns a KCal::Incidence constructed from PilotRecord r. If r is 0L the
+	 * it will return a KCal::Incidence that is empty.
+	 */
+	KCal::Incidence *incidenceFromRecord( PilotRecord *r );
 
-	virtual void readConfig();
-	virtual bool openCalendar();
+	virtual void preIncidence( KCal::Incidence* ) {};
 
-	// THESE NEED TO BE IMPLEMENTED BY CHILD CLASSES!!!!
+	// Getters
+	KCal::Calendar *calendar() const { return fCalendar; };
+	QString calendarFile() const { return fCalendarFile; };
 
-	// create events from Palm records or vice versa
-	virtual PilotRecord*recordFromIncidence(PilotAppCategory*de, const KCal::Incidence*e)=0;
-	virtual KCal::Incidence *incidenceFromRecord(KCal::Incidence *e, const PilotAppCategory *de)=0;
+	virtual VCalConduitSettings *config() = 0;
+	virtual PilotDatabase *database() const { return fDatabase; };
+	virtual PilotDatabase *localDatabase() const { return fLocalDatabase; };
 
-	virtual PilotAppCategory*newPilotEntry(PilotRecord*r)=0;
-	virtual KCal::Incidence*newIncidence()=0;
+	// add, change or delete records from the palm
+	virtual void addPalmRecord( KCal::Incidence *e );
+	virtual void changePalmRecord( KCal::Incidence *e, PilotRecord *s );
+	virtual void deletePalmRecord( KCal::Incidence *e, PilotRecord *s );
 
+	// add, change or delete events from the calendar
+	virtual KCal::Incidence* changeRecord( PilotRecord*, PilotRecord* );
+	virtual KCal::Incidence* deleteRecord( PilotRecord*, PilotRecord* );
+	virtual KCal::Incidence* addRecord( PilotRecord * );
 
-	// general settings, implemented by child classes for the conduits
-	virtual const QString dbname() = 0;
+/*********************************************************************
+          P R E -   A N D   P O S T S Y N C   F U N C T I O N S
+ *********************************************************************/
+	virtual void preSync() {};
+	virtual void postSync() {};
+	virtual void preRecord(PilotRecord*) {};
 
-	virtual const QString getTitle(PilotAppCategory*de)=0;
+protected:
+	virtual void updateIncidenceOnPalm(KCal::Incidence *e, PilotRecordBase *de);
 
-	// THESE *CAN* BE IMPLEMTED BY CHILD CLASSES
-	// execute something at the beginning or end of the sync.
-	virtual void preSync(){};
-	virtual void postSync();
-	virtual void preRecord(PilotRecord*){};
-	virtual void preIncidence(KCal::Incidence *){};
+/*********************************************************************
+                 	S Y N C   F U N C T I O N S
+               for creating events from Palm records or vice versa
+ *********************************************************************/
+	virtual PilotRecord *recordFromIncidence(PilotRecordBase *de,
+		const KCal::Incidence *e) = 0;
+	virtual PilotRecordBase *newPilotEntry(PilotRecord *r) = 0;
 
-protected:
-	KCal::Calendar *fCalendar;
-	int pilotindex;
-	QString fCalendarFile;
+	virtual KCal::Incidence *newIncidence() = 0;
+	virtual KCal::Incidence *incidenceFromRecord(KCal::Incidence *e,
+		const PilotRecordBase *de) = 0;
 
-protected:
-	virtual VCalConduitSettings *config()=0;
-	VCalConduitPrivateBase*fP;
-	virtual VCalConduitPrivateBase* newVCalPrivate(KCal::Calendar *fCalendar)=0;
+/*********************************************************************
+                M I S C   F U N C T I O N S
+ *********************************************************************/
+	/**
+     * Return how to resolve conflicts. For now
+	 * PalmOverrides=0=false,
+	 * PCOverrides=1=true,
+	 * Ask=2-> ask the user using a messagebox
+	 */
+	virtual int resolveConflict(KCal::Incidence *e, PilotRecordBase *de);
+	virtual bool openCalendar();
+	virtual VCalConduitPrivateBase *newVCalPrivate(KCal::Calendar *fCalendar) = 0;
 } ;
 
 #endif
Index: kpilot/conduits/vcalconduit/hhtopcstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/hhtopcstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/hhtopcstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,249 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the HHtoPCState
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+
+#include "pilotDatabase.h"
+#include "pilotRecord.h"
+
+#include "vcalconduitSettings.h"
+#include "vcal-conduitbase.h"
+#include "hhtopcstate.h"
+#include "pctohhstate.h"
+#include "cleanupstate.h"
+
+HHToPCState::HHToPCState()
+{
+	fState = eHHToPC;
+	fPilotindex = 0;
+}
+
+HHToPCState::~HHToPCState()
+{
+}
+
+void HHToPCState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Starting HHToPCState." << endl;
+
+	if ( vccb->syncMode() == ConduitAction::SyncMode::eCopyHHToPC )
+	{
+		fNextState = new CleanUpState();
+	}
+	else
+	{
+		fNextState = new PCToHHState();
+	}
+
+	fStarted = true;
+	vccb->setHasNextRecord( true );
+}
+
+void HHToPCState::handleRecord( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	PilotRecord *r = 0L;
+	PilotRecord *s = 0L;
+
+	if ( vccb->isFullSync() )
+	{
+		r = vccb->database()->readRecordByIndex( fPilotindex++ );
+	}
+	else
+	{
+		r = vccb->database()->readNextModifiedRec();
+	}
+
+	if (!r)
+	{
+		vccb->privateBase()->updateIncidences();
+		vccb->setHasNextRecord( false );
+		return;
+	}
+
+	// let subclasses do something with the record before we try to sync
+	vccb->preRecord( r );
+
+	bool archiveRecord = ( r->isArchived() );
+	s = vccb->localDatabase()->readRecordById( r->id() );
+	
+	if ( !s || vccb->isFirstSync() )
+	{
+#ifdef DEBUG
+		if ( r->id() > 0 && !s )
+		{
+			DEBUGCONDUIT << "-------------------------------------------------";
+			DEBUGCONDUIT << "--------------------------" << endl;
+			DEBUGCONDUIT << fname << ": Could not read palm record with ID ";
+			DEBUGCONDUIT << r->id() << endl;
+		}
+#endif
+		if ( !r->isDeleted() 
+			|| ( vccb->config()->syncArchived() && archiveRecord ) )
+		{
+			KCal::Incidence *e = vccb->addRecord( r );
+			if ( vccb->config()->syncArchived() && archiveRecord )  {
+				e->setSyncStatus( KCal::Incidence::SYNCDEL );
+			}
+		}
+	}
+	else
+	{
+		if ( r->isDeleted() )
+		{
+			if ( vccb->config()->syncArchived() && archiveRecord )
+			{
+				vccb->changeRecord( r, s );
+			}
+			else
+			{
+				vccb->deleteRecord( r, s );
+			}
+		}
+		else
+		{
+			vccb->changeRecord( r, s );
+		}
+	}
+
+	KPILOT_DELETE(r);
+	KPILOT_DELETE(s);
+}
+
+void HHToPCState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finished HHToPCState." << endl;
+	vccb->setState( fNextState );
+}
+
+/*
+void VCalConduitBase::slotPalmRecToPC()
+{
+	FUNCTIONSETUP;
+
+	PilotRecord *r;
+	if (isFullSync())
+	{
+		r = fDatabase->readRecordByIndex(pilotindex++);
+	}
+	else
+	{
+		r = fDatabase->readNextModifiedRec();
+	}
+	PilotRecord *s = 0L;
+
+	if (!r)
+	{
+		fP->updateIncidences();
+		if ( syncMode()==SyncMode::eCopyHHToPC )
+		{
+			emit logMessage(i18n("Cleaning up ..."));
+			QTimer::singleShot(0, this, SLOT(cleanup()));
+			return;
+		}
+		else
+		{
+			emit logMessage(i18n("Copying records to Pilot ..."));
+			QTimer::singleShot(0 ,this,SLOT(slotPCRecToPalm()));
+			return;
+		}
+	}
+
+	// let subclasses do something with the record before we try to sync
+	preRecord(r);
+
+//	DEBUGCONDUIT<<fname<<": Event: "<<e->dtStart()<<" until "<<e->dtEnd()<<endl;
+//	DEBUGCONDUIT<<fname<<": Time: "<<e->dtStart()<<" until "<<e->dtEnd()<<endl;
+	bool archiveRecord=(r->isArchived());
+
+	s = fLocalDatabase->readRecordById(r->id());
+	if (!s || isFirstSync())
+	{
+#ifdef DEBUG
+		if (r->id()>0 && !s)
+		{
+			DEBUGCONDUIT<<"---------------------------------------------------------------------------"<<endl;
+			DEBUGCONDUIT<< fname<<": Could not read palm record with ID "<<r->id()<<endl;
+		}
+#endif
+		if (!r->isDeleted() || (config()->syncArchived() && archiveRecord))
+		{
+			KCal::Incidence*e=addRecord(r);
+			if (config()->syncArchived() && archiveRecord)  {
+				e->setSyncStatus(KCal::Incidence::SYNCDEL);
+			}
+		}
+	}
+	else
+	{
+		if (r->isDeleted())
+		{
+			if (config()->syncArchived() && archiveRecord)
+			{
+				changeRecord(r,s);
+			}
+			else
+			{
+				deleteRecord(r,s);
+			}
+		}
+		else
+		{
+			changeRecord(r,s);
+		}
+	}
+
+	KPILOT_DELETE(r);
+	KPILOT_DELETE(s);
+
+	QTimer::singleShot(0,this,SLOT(slotPalmRecToPC()));
+}
+*/
Index: kpilot/conduits/vcalconduit/pctohhstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/pctohhstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/pctohhstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,156 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the PCToHHState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+
+#include "pilotDatabase.h"
+#include "pilotRecord.h"
+
+#include "vcal-conduitbase.h"
+#include "pctohhstate.h"
+#include "cleanupstate.h"
+#include "deleteunsyncedhhstate.h"
+
+PCToHHState::PCToHHState()
+{
+	fState = ePCToHH;
+}
+
+PCToHHState::~PCToHHState()
+{
+}
+
+void PCToHHState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+	
+	DEBUGCONDUIT << fname << ": Starting PCToHHState." << endl;
+
+	// if we are asked to copy HH to PC, we shouldn't look for deleted records
+	// on the Palm, since we've just copied them all.  =:)  Otherwise, look for
+	// data on the palm that shouldn't be there and delete it if we find it....
+	if ( vccb->syncMode() == ConduitAction::SyncMode::eCopyHHToPC )
+	{
+		fNextState = new CleanUpState();
+	}
+	else
+	{
+		fNextState = new DeleteUnsyncedHHState();
+	}
+
+	vccb->addLogMessage( i18n( "Copying records to Pilot ..." ) );
+
+	fStarted = true;
+	vccb->setHasNextRecord( true );
+}
+
+void PCToHHState::handleRecord( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	KCal::Incidence *e = 0L;
+
+	if( vccb->isFullSync() )
+	{
+		e = vccb->privateBase()->getNextIncidence();
+	}
+	else
+	{
+		e = vccb->privateBase()->getNextModifiedIncidence();
+	}
+
+	// No more incidences to sync
+	if( !e )
+	{
+		vccb->setHasNextRecord( false );
+		return;
+	}
+	
+	// let subclasses do something with the event
+	vccb->preIncidence( e );
+
+	// find the corresponding index on the palm and sync. If there is none, 
+	// create it.
+	recordid_t id = e->pilotId();
+	
+	DEBUGCONDUIT << fname << ": found PC entry with pilotID " << id <<endl;
+	DEBUGCONDUIT << fname << ": Description: " << e->summary() << endl;
+	DEBUGCONDUIT << fname << ": Time: "<< e->dtStart().toString() << " until "
+		<< e->dtEnd().toString() << endl;
+
+	PilotRecord *s = 0L;
+
+	if( id > 0 && ( s = vccb->database()->readRecordById( id ) ) )
+	{
+		if( e->syncStatus() == KCal::Incidence::SYNCDEL )
+		{
+			vccb->deletePalmRecord( e, s );
+		}
+		else
+		{
+			vccb->changePalmRecord( e, s );
+		}
+
+		KPILOT_DELETE( s );
+	} else {
+#ifdef DEBUG
+		if (id > 0 )
+		{
+			DEBUGCONDUIT << "-------------------------------------------------"
+				<< "--------------------------" << endl;
+			DEBUGCONDUIT << fname << ": Could not read palm record with ID "
+				<< id << endl;
+		}
+#endif
+		vccb->addPalmRecord( e );
+	}
+}
+
+void PCToHHState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+	
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finished PCToHHState." << endl;
+	vccb->setState( fNextState );
+}
Index: kpilot/conduits/vcalconduit/vcalRecord.h
===================================================================
--- kpilot/conduits/vcalconduit/vcalRecord.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/vcalRecord.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,62 @@
+#ifndef _KPILOT_VCALRECORD_H
+#define _KPILOT_VCALRECORD_H
+/* vcal-conduit.h                       KPilot
+**
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org>
+** Copyright (C) 2002-2003 by Reinhold Kainhofer
+** Copyright (C) 2001 by Dan Pilone
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+namespace KCal
+{
+	class Event;
+}
+
+class PilotDateEntry;
+
+class VCalRecord
+{
+public:
+	static bool setEvent( KCal::Event *e, const PilotDateEntry *de);
+	static bool setDateEntry(PilotDateEntry *de, const KCal::Event *e);
+
+protected:
+	static void setStartEndTimes(KCal::Event *,const PilotDateEntry *);
+	static void setAlarms(KCal::Event *,const PilotDateEntry *);
+	static void setRecurrence(KCal::Event *,const PilotDateEntry *);
+	static void setExceptions(KCal::Event *,const PilotDateEntry *);
+	static void setCategory(KCal::Event *, const PilotDateEntry *);
+
+	static void setStartEndTimes(PilotDateEntry *, const KCal::Event * );
+	static void setAlarms(PilotDateEntry *, const KCal::Event * );
+	static void setRecurrence(PilotDateEntry *, const KCal::Event * );
+	static void setExceptions(PilotDateEntry *, const KCal::Event * );
+	static void setCategory(PilotDateEntry *, const KCal::Event *);
+
+} ;
+
+#endif
+
+
Index: kpilot/conduits/vcalconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/vcalconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,69 @@
+set(conduit_LIBS kcal)
+
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_SHARED
+	vcal-setupbase.cc
+	vcal-conduitbase.cc
+	teststate.cc
+	initstate.cc
+	pctohhstate.cc
+	hhtopcstate.cc
+	cleanupstate.cc
+	deleteunsyncedpcstate.cc
+	deleteunsyncedhhstate.cc
+	vcalRecord.cc
+)
+
+kde3_add_kcfg_files(conduit_SHARED vcalconduitSettings.kcfgc)
+kde3_add_ui_files(conduit_SHARED korganizerConduit.ui)
+
+set(conduit_vcal_SRCS
+	${conduit_SHARED}
+	vcal-conduit.cc
+	vcal-factory.cc
+	vcal-setup.cc
+)
+
+kde3_automoc(${conduit_vcal_SRCS})
+add_library(conduit_vcal SHARED ${conduit_vcal_SRCS})
+target_link_libraries(conduit_vcal kcal)
+
+set(conduit_todo_SRCS
+	${conduit_SHARED}
+	todo-factory.cc
+	todo-setup.cc
+	todo-conduit.cc
+)
+
+kde3_automoc(${conduit_todo_SRCS})
+add_library(conduit_todo SHARED ${conduit_todo_SRCS})
+target_link_libraries(conduit_todo kcal)
+
+set_target_properties(
+	conduit_vcal PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+set_target_properties(
+	conduit_todo PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_vcal)
+
+install(
+	TARGETS conduit_vcal conduit_todo
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+kde3_install_libtool_file(conduit_todo)
+
+install(
+	FILES vcal-conduit.desktop todo-conduit.desktop
+	DESTINATION ${KDE3_SERVICES_DIR}
+)
Index: kpilot/conduits/vcalconduit/vcal-factory.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-factory.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-factory.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,120 +31,20 @@
 
 #include <kaboutdata.h>
 
+#include "pluginfactory.h"
+
 #include "vcal-setup.h"
 #include "vcal-conduit.h"
-#include "vcal-factory.moc"
-#include "vcalconduitSettings.h"
 
 extern "C"
 {
 
 void *init_conduit_vcal()
 {
-	return new VCalConduitFactory;
+	return new ConduitFactory<VCalWidgetSetup,VCalConduit>;
 }
 
 }
 
 
-VCalConduitSettings* VCalConduitFactory::fConfig=0L;
 
-VCalConduitFactory::VCalConduitFactory(QObject *p, const char *n) :
-	VCalConduitFactoryBase(p,n)
-{
-	FUNCTIONSETUP;
-
-	fInstance = new KInstance("vcalconduit");
-	fAbout = new KAboutData("vcalConduit",
-		I18N_NOOP("VCal Conduit for KPilot"),
-		KPILOT_VERSION,
-		I18N_NOOP("Configures the VCal Conduit for KPilot"),
-		KAboutData::License_GPL,
-		"(C) 2001, Adriaan de Groot\n(C) 2002-2003, Reinhold Kainhofer");
-	fAbout->addAuthor("Adriaan de Groot",
-		I18N_NOOP("Maintainer"),
-		"groot@kde.org",
-		"http://www.cs.kun.nl/~adridg/kpilot");
-	fAbout->addAuthor("Reinhold Kainhofer",
-		I18N_NOOP("Maintainer"),
-		"reinhold@kainhofer.com",
-		"http://reinhold.kainhofer.com/Linux/");
-	fAbout->addAuthor("Dan Pilone",
-		I18N_NOOP("Original Author"));
-	fAbout->addAuthor("Preston Brown",
-		I18N_NOOP("Original Author"));
-	fAbout->addAuthor("Herwin-Jan Steehouwer",
-		I18N_NOOP("Original Author"));
-	fAbout->addCredit("Cornelius Schumacher",
-		I18N_NOOP("iCalendar port"));
-	fAbout->addCredit("Philipp Hullmann",
-		I18N_NOOP("Bugfixer"));
-}
-
-VCalConduitFactory::~VCalConduitFactory()
-{
-	FUNCTIONSETUP;
-
-	KPILOT_DELETE(fInstance);
-}
-
-VCalConduitSettings* VCalConduitFactory::config()
-{
-	if (!fConfig) {
-		fConfig = new VCalConduitSettings(CSL1("Calendar"));
-		if (fConfig) fConfig->readConfig();
-	}
-	return fConfig;
-}
-
-/* virtual */ QObject *VCalConduitFactory::createObject( QObject *p,
-	const char *n,
-	const char *c,
-	const QStringList &a)
-{
-	FUNCTIONSETUP;
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating object of class "
-		<< c
-		<< endl;
-#endif
-
-	if (qstrcmp(c,"ConduitConfigBase")==0)
-	{
-		QWidget *w = dynamic_cast<QWidget *>(p);
-
-		if (w)
-		{
-			return new VCalWidgetSetup(w,n);
-		}
-		else
-		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< ": Couldn't cast parent to widget."
-				<< endl;
-#endif
-			return 0L;
-		}
-	}
-	else
-	if (qstrcmp(c,"SyncAction")==0)
-	{
-		KPilotDeviceLink *d = dynamic_cast<KPilotDeviceLink *>(p);
-
-		if (d)
-		{
-			return new VCalConduit(d,n,a);
-		}
-		else
-		{
-			kdError() << k_funcinfo
-				<< ": Couldn't cast to KPilotDeviceLink."
-				<< endl;
-		}
-	}
-
-	return 0L;
-}
Index: kpilot/conduits/vcalconduit/vcal-conduit.h
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,9 +52,11 @@
 	virtual void addIncidence(KCal::Incidence*);
 	virtual void removeIncidence(KCal::Incidence *);
 	virtual KCal::Incidence *findIncidence(recordid_t);
-	/** Find the incidence based on tosearch's description and date information. Returns 0L if no incidence could be found.
+	/**
+	 * Find the incidence based on tosearch's description and date information.
+	 * Returns 0L if no incidence could be found.
 	 */
-	virtual KCal::Incidence *findIncidence(PilotAppCategory*tosearch);
+	virtual KCal::Incidence *findIncidence(PilotRecordBase *tosearch);
 	virtual KCal::Incidence *getNextIncidence();
 	virtual KCal::Incidence *getNextModifiedIncidence();
 	virtual int count() {return fAllEvents.count();};
@@ -66,7 +68,7 @@
 {
 Q_OBJECT
 public:
-	VCalConduit(KPilotDeviceLink *,
+	VCalConduit(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~VCalConduit();
@@ -79,34 +81,21 @@
 
 	void _getAppInfo();
 	void _setAppInfo();
-	QString _getCat(const QStringList cats, const QString curr) const;
 
-	virtual PilotAppCategory*newPilotEntry(PilotRecord*r);
+	virtual PilotRecordBase *newPilotEntry(PilotRecord*r);
 	virtual KCal::Incidence*newIncidence();
-	virtual const QString getTitle(PilotAppCategory*de);
+	virtual const QString getTitle(PilotRecordBase *de);
 	virtual VCalConduitSettings *config();
+public:
+	static VCalConduitSettings *theConfig();
 
 protected:
-	virtual PilotRecord *recordFromIncidence(PilotAppCategory*de, const KCal::Incidence*e);
-	virtual PilotRecord *recordFromIncidence(PilotDateEntry*de, const KCal::Event*e);
-	virtual KCal::Incidence *incidenceFromRecord(KCal::Incidence *, const PilotAppCategory *);
-	virtual KCal::Event *incidenceFromRecord(KCal::Event *, const PilotDateEntry *);
+	virtual PilotRecord *recordFromIncidence(PilotRecordBase *de,
+		const KCal::Incidence *e);
+	virtual KCal::Incidence *incidenceFromRecord(KCal::Incidence *e,
+		const PilotRecordBase *de);
 
-
-	void setStartEndTimes(KCal::Event *,const PilotDateEntry *);
-	void setAlarms(KCal::Event *,const PilotDateEntry *);
-	void setRecurrence(KCal::Event *,const PilotDateEntry *);
-	void setExceptions(KCal::Event *,const PilotDateEntry *);
-
-	void setStartEndTimes(PilotDateEntry *, const KCal::Event * );
-	void setAlarms(PilotDateEntry *, const KCal::Event * );
-	void setRecurrence(PilotDateEntry *, const KCal::Event * );
-	void setExceptions(PilotDateEntry *, const KCal::Event * );
-
-	void setCategory(PilotDateEntry *, const KCal::Event *);
-	void setCategory(KCal::Event *, const PilotDateEntry *);
 	struct AppointmentAppInfo fAppointmentAppInfo;
+};
 
-} ;
-
 #endif
Index: kpilot/conduits/vcalconduit/cleanupstate.h
===================================================================
--- kpilot/conduits/vcalconduit/cleanupstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/cleanupstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,49 @@
+#ifndef _KPILOT_CLEANUPSTATE_H
+#define _KPILOT_CLEANUPSTATE_H
+/* cleanupstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the cleanupstate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "conduitstate.h"
+
+class ConduitAction;
+
+/**
+ * State to Cleanup after all sync actions are finished. @see vcal-conduitstate.h
+ */
+class CleanUpState : public ConduitState
+{
+public:
+	CleanUpState();
+	virtual ~CleanUpState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/deleteunsyncedhhstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/deleteunsyncedhhstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/deleteunsyncedhhstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,115 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the DeleteUnsyncedHHState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+#include <plugin.h>
+
+#include "pilotDatabase.h"
+#include "pilotRecord.h"
+
+#include "vcal-conduitbase.h"
+#include "deleteunsyncedhhstate.h"
+#include "deleteunsyncedpcstate.h"
+#include "cleanupstate.h"
+
+DeleteUnsyncedHHState::DeleteUnsyncedHHState()
+{
+	fState = eDeleteUnsyncedHH;
+}
+
+DeleteUnsyncedHHState::~DeleteUnsyncedHHState()
+{
+}
+
+void DeleteUnsyncedHHState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Starting DeleteUnsyncedHHState." << endl;
+	
+	fPilotIndex = 0;
+	fNextState = new DeleteUnsyncedPCState();
+	
+	vccb->setHasNextRecord( true );
+	fStarted = true;
+}
+
+void DeleteUnsyncedHHState::handleRecord( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	PilotRecord *r = vccb->localDatabase()->readRecordByIndex( fPilotIndex++ );
+	// if either we don't have a record, or if we're copying everything
+	// from the handheld to the pc, then we don't have anything to do
+	// here.  the latter is because if we're copying HH->PC, then by
+	// definition, we will have everything from the HH on the PC and
+	// therefore can't possibly have anything that needs to be deleted
+	// from it.
+	if ( !r
+		|| ( vccb->syncMode().mode() == ConduitAction::SyncMode::eCopyHHToPC ) )
+	{
+		vccb->setHasNextRecord( false );
+		return;
+	}
+
+	KCal::Incidence *e = vccb->privateBase()->findIncidence( r->id() );
+	if ( !e )
+	{
+		DEBUGCONDUIT << "Didn't find incidence with id = " << r->id()
+			<< ", deleting it" << endl;
+		vccb->deletePalmRecord( NULL, r );
+	}
+
+	KPILOT_DELETE( r );
+}
+
+void DeleteUnsyncedHHState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finishing DeleteUnsyncedHHState." << endl;
+	vccb->setState( fNextState );
+}
Index: kpilot/conduits/vcalconduit/deleteunsyncedpcstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/deleteunsyncedpcstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/deleteunsyncedpcstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,135 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the DeleteUnsyncedPCState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+#include <plugin.h>
+
+#include "pilotDatabase.h"
+#include "pilotRecord.h"
+
+#include "vcal-conduitbase.h"
+#include "deleteunsyncedpcstate.h"
+#include "cleanupstate.h"
+
+DeleteUnsyncedPCState::DeleteUnsyncedPCState()
+{
+	fState = eDeleteUnsyncedPC;
+}
+
+DeleteUnsyncedPCState::~DeleteUnsyncedPCState()
+{
+}
+
+void DeleteUnsyncedPCState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Starting DeleteUnsyncedPCState." << endl;
+	
+	fPilotIndex = 0;
+	fNextState = new CleanUpState();
+	
+	vccb->setHasNextRecord( true );
+	fStarted = true;
+}
+
+void DeleteUnsyncedPCState::handleRecord( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	KCal::Incidence *e = 0L;
+	e = vccb->privateBase()->getNextIncidence();
+
+	// if we don't have a record, then we can't do anything.  also, if
+	// we're copying everything from the PC to our handheld, then we're
+	// guaranteed not to have anything extra on our PC that's not on
+	// our handheld that needs to get deleted, so we can return in that
+	// case too...
+
+	if( !e || ( vccb->syncMode().mode() == ConduitAction::SyncMode::eCopyPCToHH ) )
+	{
+		vccb->setHasNextRecord( false );
+		return;
+	}
+
+
+	// try to find the corresponding index on the palm.  if we can't
+	// find it, then we have a pc record that needs to be deleted.
+	recordid_t id = e->pilotId();
+	
+	PilotRecord *s = 0L;
+
+	if( id > 0 )
+	{
+		s = vccb->database()->readRecordById( id );
+	}
+
+	// if we either have a pc record with no palm id or if we can't
+	// find a palm record that matches, then we need to delete this PC
+	// record.
+	if ( id <=0 || !s )
+	{
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << ": found PC entry with pilotID: [" << id 
+			<< "], Description: [" << e->summary() 
+			<< "], Time: ["<< e->dtStart().toString() << "] until: ["
+			<< e->dtEnd().toString() << "]. Can't find it on Palm, "
+			<< "so I'm deleting it from the local calendar." << endl;
+#endif
+		vccb->privateBase()->removeIncidence(e);
+	}
+
+	KPILOT_DELETE( s );
+
+}
+
+void DeleteUnsyncedPCState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finishing DeleteUnsyncedPCState." << endl;
+	vccb->setState( fNextState );
+}
Index: kpilot/conduits/vcalconduit/deleteunsyncedpcstate.h
===================================================================
--- kpilot/conduits/vcalconduit/deleteunsyncedpcstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/deleteunsyncedpcstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,53 @@
+#ifndef _KPILOT_DUSPCSTATE_H
+#define _KPILOT_DUSPCSTATE_H
+/* deleteunsyncedpcstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the deleteunsyncedpcstate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State to handle delete unsynced pc records. @see vcal-conduitstate.h
+ */
+class DeleteUnsyncedPCState : public ConduitState
+{
+private:
+	ConduitState *fNextState;
+	int fPilotIndex;
+
+public:
+	DeleteUnsyncedPCState();
+	virtual ~DeleteUnsyncedPCState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/initstate.h
===================================================================
--- kpilot/conduits/vcalconduit/initstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/initstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,52 @@
+#ifndef _KPILOT_INITSTATE_H
+#define _KPILOT_INITSTATE_H
+/* initstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the teststate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State to test the vcal-conduit. @see vcal-conduitstate.h
+ */
+class InitState : public ConduitState
+{
+private:
+	ConduitState *fNextState;
+
+public:
+	InitState();
+	virtual ~InitState();
+
+	virtual void startSync( ConduitAction *vccb );
+	virtual void handleRecord( ConduitAction *vccb );
+	virtual void finishSync( ConduitAction *vccb );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/todo-conduit.cc
===================================================================
--- kpilot/conduits/vcalconduit/todo-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,10 +52,7 @@
 
 extern "C"
 {
-long version_conduit_todo = KPILOT_PLUGIN_API;
-
-const char *id_conduit_todo = "$Id$";
-
+unsigned long version_conduit_todo = Pilot::PLUGIN_API;
 }
 
 
@@ -82,7 +79,12 @@
 void TodoConduitPrivate::removeIncidence(KCal::Incidence *e)
 {
 	fAllTodos.remove(static_cast<KCal::Todo*>(e));
+	if (!fCalendar) return;
 	fCalendar->deleteTodo(static_cast<KCal::Todo*>(e));
+	// now just in case we're in the middle of reading through our list
+	// and we delete something, set reading to false so we start at the
+	// top again next time and don't have problems with our iterator
+	reading = false;
 }
 
 
@@ -100,7 +102,7 @@
 
 
 
-KCal::Incidence *TodoConduitPrivate::findIncidence(PilotAppCategory*tosearch)
+KCal::Incidence *TodoConduitPrivate::findIncidence(PilotRecordBase *tosearch)
 {
 	PilotTodoEntry*entry=dynamic_cast<PilotTodoEntry*>(tosearch);
 	if (!entry) return 0L;
@@ -169,17 +171,13 @@
  *                          TodoConduit class                               *
  ****************************************************************************/
 
-TodoConduit::TodoConduit(KPilotDeviceLink *d,
+TodoConduit::TodoConduit(KPilotLink *d,
 	const char *n,
-	const QStringList &a) : VCalConduitBase(d,n,a)
+	const QStringList &a) : VCalConduitBase(d,n,a),
+	fTodoAppInfo( 0L )
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_conduit_todo << endl;
-#endif
 	fConduitName=i18n("To-do");
-
-        (void) id_conduit_todo;
 }
 
 
@@ -195,7 +193,19 @@
 {
 	FUNCTIONSETUP;
 	// get the address application header information
-	fTodoAppInfo->write(fDatabase);
+
+	if( !fTodoAppInfo )
+	{
+		DEBUGCONDUIT << fname << ": fTodoAppInfo is NULL" << endl;
+		return;
+	}
+	if( !fDatabase )
+	{
+		DEBUGCONDUIT << fname << ": fDatabase is NULL" << endl;
+		return;
+	}
+
+	fTodoAppInfo->writeTo(fDatabase);
 }
 
 void TodoConduit::_getAppInfo()
@@ -203,19 +213,20 @@
 	FUNCTIONSETUP;
 	// get the address application header information
 
+	KPILOT_DELETE( fTodoAppInfo );
 	fTodoAppInfo = new PilotToDoInfo(fDatabase);
-
-#ifdef DEBUG
 	fTodoAppInfo->dump();
-#endif
 }
 
 
 
-const QString TodoConduit::getTitle(PilotAppCategory*de)
+const QString TodoConduit::getTitle(PilotRecordBase *de)
 {
 	PilotTodoEntry*d=dynamic_cast<PilotTodoEntry*>(de);
-	if (d) return QString(d->getDescription());
+	if (d)
+	{
+		return QString(d->getDescription());
+	}
 	return QString::null;
 }
 
@@ -231,14 +242,19 @@
 	//
 	categoriesSynced = config()->conduitVersion()>=CONDUIT_VERSION_CATEGORYSYNC;
 	if (!categoriesSynced && !isFullSync() )
+	{
 		changeSync(SyncMode::eFullSync);
-#ifdef DEBUG
-	DEBUGCONDUIT<<"categoriesSynced="<<categoriesSynced<<endl;
-#endif
+	}
+	DEBUGCONDUIT<<"categoriesSynced=" << categoriesSynced << endl;
 }
 
+void TodoConduit::preSync()
+{
+	FUNCTIONSETUP;
+	VCalConduitBase::preSync();
+	_getAppInfo();
+}
 
-
 void TodoConduit::postSync()
 {
 	FUNCTIONSETUP;
@@ -251,7 +267,7 @@
 
 
 
-PilotRecord*TodoConduit::recordFromIncidence(PilotAppCategory*de, const KCal::Incidence*e)
+PilotRecord*TodoConduit::recordFromIncidence(PilotRecordBase *de, const KCal::Incidence*e)
 {
 	// don't need to check for null pointers here, the recordFromIncidence(PTE*, KCal::Todo*) will do that.
 	PilotTodoEntry *tde = dynamic_cast<PilotTodoEntry*>(de);
@@ -266,14 +282,15 @@
 {
 	FUNCTIONSETUP;
 	if (!de || !todo) {
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": NULL todo given... Skipping it"<<endl;
-#endif
+		DEBUGCONDUIT << fname << ": NULL todo given... Skipping it" << endl;
 		return NULL;
 	}
 
 	// set secrecy, start/end times, alarms, recurrence, exceptions, summary and description:
-	if (todo->secrecy()!=KCal::Todo::SecrecyPublic) de->setSecret( true );
+	if (todo->secrecy()!=KCal::Todo::SecrecyPublic)
+	{
+		de->setSecret( true );
+	}
 
 	// update it from the iCalendar Todo.
 
@@ -300,9 +317,7 @@
 	// what we call description pilot puts as a separate note
 	de->setNote(todo->description());
 
-#ifdef DEBUG
-DEBUGCONDUIT<<"-------- "<<todo->summary()<<endl;
-#endif
+	DEBUGCONDUIT << "-------- " << todo->summary() << endl;
 	return de->pack();
 }
 
@@ -313,7 +328,7 @@
 	FUNCTIONSETUP;
 	if (!categoriesSynced && r)
 	{
-		const PilotAppCategory*de=newPilotEntry(r);
+		const PilotRecordBase *de=newPilotEntry(r);
 		KCal::Incidence *e = fP->findIncidence(r->id());
 		setCategory(dynamic_cast<KCal::Todo*>(e), dynamic_cast<const PilotTodoEntry*>(de));
 	}
@@ -323,7 +338,10 @@
 
 void TodoConduit::setCategory(PilotTodoEntry*de, const KCal::Todo*todo)
 {
-	if (!de || !todo) return;
+	if (!de || !todo)
+	{
+		return;
+	}
 	de->setCategory(_getCat(todo->categories(), de->getCategoryLabel()));
 }
 
@@ -335,14 +353,13 @@
  */
 QString TodoConduit::_getCat(const QStringList cats, const QString curr) const
 {
-	int j;
 	if (cats.size()<1) return QString::null;
 	if (cats.contains(curr)) return curr;
 	for ( QStringList::ConstIterator it = cats.begin(); it != cats.end(); ++it )
 	{
-		for (j=1; j<PILOT_CATEGORY_MAX; j++)
+		for (unsigned int j=1; j<Pilot::CATEGORY_COUNT; j++)
 		{
-			QString catName = fTodoAppInfo->category(j);
+			QString catName = fTodoAppInfo->categoryName(j);
 			if (!(*it).isEmpty() && !(*it).compare( catName ) )
 			{
 				return catName;
@@ -352,14 +369,14 @@
 	// If we have a free label, return the first possible cat
 	//
 	// FIXME: Clearly buggy, but I don't know how or why
-	QString lastName = fTodoAppInfo->category(PILOT_CATEGORY_MAX-1);
+	QString lastName = fTodoAppInfo->categoryName(Pilot::CATEGORY_COUNT-1);
 	if (lastName.isEmpty()) return cats.first();
 	return QString::null;
 }
 
 
 
-KCal::Incidence *TodoConduit::incidenceFromRecord(KCal::Incidence *e, const PilotAppCategory *de)
+KCal::Incidence *TodoConduit::incidenceFromRecord(KCal::Incidence *e, const PilotRecordBase *de)
 {
 	return dynamic_cast<KCal::Incidence*>(incidenceFromRecord(dynamic_cast<KCal::Todo*>(e), dynamic_cast<const PilotTodoEntry*>(de)));
 }
@@ -430,25 +447,35 @@
 	if (!e || !de) return;
 	QStringList cats=e->categories();
 	int cat=de->category();
-	if (0<cat && cat<PILOT_CATEGORY_MAX)
+	if ( (0<cat) && (cat<(int)Pilot::CATEGORY_COUNT) )
 	{
-		QString newcat=fTodoAppInfo->category(cat);
+		QString newcat=fTodoAppInfo->categoryName(cat);
 		if (!cats.contains(newcat))
 		{
 			// if this event only has one category associated with it, then we can
 			// safely assume that what we should be doing here is changing it to match
 			// the palm.  if there's already more than one category in the event, however, we
-			// won't cause data loss--we'll just append what the palm has to the 
+			// won't cause data loss--we'll just append what the palm has to the
 			// event's categories
 			if (cats.count() <=1) cats.clear();
-			
+
 			cats.append( newcat );
 			e->setCategories(cats);
 		}
 	}
 }
 
-VCalConduitSettings *TodoConduit::config()
-{
-  return ToDoConduitFactory::config();
+static VCalConduitSettings *config_vcal = 0L;
+
+VCalConduitSettings *TodoConduit::theConfig() {
+	if (!config_vcal)
+	{
+		config_vcal = new VCalConduitSettings(CSL1("Calendar"));
+	}
+
+	return config_vcal;
 }
+
+VCalConduitSettings *TodoConduit::config() {
+	return theConfig();
+}
Index: kpilot/conduits/vcalconduit/conduitstate.h
===================================================================
--- kpilot/conduits/vcalconduit/conduitstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/conduitstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,86 @@
+#ifndef _KPILOT_CONDUITSTATE_H
+#define _KPILOT_CONDUITSTATE_H
+/* vcal-conduitstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the vcal-conduitstate.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "plugin.h"
+
+/**
+ * This class defines the current state of the vcal-conduitbase. Subclasses of
+ * this class can do the things that are needed, in methods defined here, for 
+ * the state that they define.
+ */
+class ConduitState
+{
+public:
+	enum state_t {
+		eTest,
+		eInit,
+		ePCToHH,
+		eHHToPC,
+		eDeleteUnsyncedHH,
+		eDeleteUnsyncedPC,
+		eCleanUp
+	};
+
+protected:
+	state_t fState;
+	bool fStarted;
+
+public:
+	ConduitState(){ fState = eInit; fStarted = false; };
+	virtual ~ConduitState() {};
+
+	/**
+	 * Prepare for a sync in the current state. Don't forget to set fState to 
+	 * true in this method. Otherwise the state won't handle records.
+	 */
+	virtual void startSync( ConduitAction * ) = 0;
+	
+	/**
+	 * Sync the next record in row.
+	 */
+	virtual void handleRecord( ConduitAction * ) = 0;
+
+	/**
+	 * Clean up after all records are synced and enter next state.
+	 */
+	virtual void finishSync( ConduitAction * ) = 0;
+
+	/**
+	 * Returns the state type.
+	 */
+	state_t state() { return fState; };
+
+	/**
+	 * Returns wether or not this state has started.
+	 */
+	bool started() { return fStarted; };
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/todo-factory.h
===================================================================
--- kpilot/conduits/vcalconduit/todo-factory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/todo-factory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,29 +30,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include "vcal-factorybase.h"
-
-class KInstance;
-
-class ToDoConduitFactory : public VCalConduitFactoryBase
-{
-    Q_OBJECT
-
-public:
-	ToDoConduitFactory(QObject * = 0L,const char * = 0L);
-	virtual ~ToDoConduitFactory();
-	static VCalConduitSettings*config();
-
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() );
-private:
-	KInstance *fInstance;
-	static VCalConduitSettings*fConfig;
-};
-
 extern "C"
 {
 
Index: kpilot/conduits/vcalconduit/teststate.cc
===================================================================
--- kpilot/conduits/vcalconduit/teststate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/teststate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,127 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the TestState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+
+#include <qdatetime.h>
+#include <qfile.h>
+
+#include "pilotSerialDatabase.h"
+#include "pilotLocalDatabase.h"
+#include "pilotDateEntry.h"
+
+#include "teststate.h"
+#include "vcal-conduitbase.h"
+
+TestState::TestState() : fCalendar( QString::null )
+{
+	fState = eTest;
+}
+
+TestState::~TestState()
+{
+	FUNCTIONSETUP;
+}
+
+void TestState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+	
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+	
+	DEBUGCONDUIT << fname << ": Starting teststate." << endl;
+
+	vccb->setHasNextRecord( true );
+	fPilotindex = 0;
+	fStarted = true;
+}
+
+void TestState::handleRecord( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Handling record " << fPilotindex << endl;
+
+	PilotRecord *record = vccb->readRecordByIndex( fPilotindex );
+	
+	if( record )
+	{
+		KCal::Incidence *i = vccb->incidenceFromRecord( record );
+		fCalendar.addIncidence( i );
+	
+		KPILOT_DELETE(record);
+	
+		// Schedule more work.
+		++fPilotindex;
+	}
+	else
+	{
+		vccb->setHasNextRecord( false );
+	}
+}
+
+void TestState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+	
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": finishing teststate." << endl;
+
+	// No more records present on the device so lets dump the
+	// readed records in a file.
+	QFile f( CSL1("dump.ics") );
+	if( !f.exists() )
+	{
+		f.open( IO_WriteOnly );
+		f.close();
+	}
+
+	if( !fCalendar.save( CSL1("dump.ics") ) )
+	{
+		DEBUGCONDUIT << fname << ": Can't save calendar file." << endl;
+	}
+
+	fCalendar.close();
+
+	vccb->setState( 0L );
+}
Index: kpilot/conduits/vcalconduit/vcalRecord.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcalRecord.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/vcalRecord.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,628 @@
+/* vcalRecord.cc                       KPilot
+**
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org>
+** Copyright (C) 2002-2003 by Reinhold Kainhofer
+** Copyright (C) 2001 by Dan Pilone
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <libkcal/calendar.h>
+#include <libkcal/calendarlocal.h>
+#include <libkcal/recurrence.h>
+#include <libkcal/vcalformat.h>
+
+#include "pilot.h"
+#include "pilotDateEntry.h"
+
+#include "vcalRecord.h"
+
+bool VCalRecord::setEvent(KCal::Event *e, const PilotDateEntry *de)
+{
+	FUNCTIONSETUP;
+	if (!e) {
+		DEBUGCONDUIT << fname
+			<< "! NULL event given... Skipping it" << endl;
+		return false;
+	}
+
+	e->setSyncStatus(KCal::Incidence::SYNCNONE);
+	e->setSecrecy(de->isSecret() ?
+		KCal::Event::SecrecyPrivate :
+		KCal::Event::SecrecyPublic);
+
+	e->setPilotId(de->id());
+	e->setSyncStatus(KCal::Incidence::SYNCNONE);
+
+	setStartEndTimes(e,de);
+	setAlarms(e,de);
+	setRecurrence(e,de);
+	setExceptions(e,de);
+
+	e->setSummary(de->getDescription());
+	e->setDescription(de->getNote());
+	e->setLocation(de->getLocation());
+
+	// used by e.g. Agendus and Datebk
+	setCategory(e, de);
+
+	return true;
+}
+
+void VCalRecord::setStartEndTimes(KCal::Event *e, const PilotDateEntry *de)
+{
+	FUNCTIONSETUP;
+	DEBUGCONDUIT << fname
+		<< "# Start time on Palm: "
+		<< readTm(de->getEventStart()).toString() << endl;
+
+	e->setDtStart(readTm(de->getEventStart()));
+	e->setFloats(de->isEvent());
+
+	if (de->isMultiDay())
+	{
+		e->setDtEnd(readTm(de->getRepeatEnd()));
+	}
+	else
+	{
+		e->setDtEnd(readTm(de->getEventEnd()));
+	}
+}
+
+void VCalRecord::setAlarms(KCal::Event *e, const PilotDateEntry *de)
+{
+	FUNCTIONSETUP;
+
+	if (!e) return;
+	// Delete all the alarms now and add them one by one later on.
+	e->clearAlarms();
+	if (!de->isAlarmEnabled()) return;
+
+//	QDateTime alarmDT = readTm(de->getEventStart());
+	int advanceUnits = de->getAdvanceUnits();
+
+	switch (advanceUnits)
+	{
+	case advMinutes:
+		advanceUnits = 1;
+		break;
+	case advHours:
+		advanceUnits = 60;
+		break;
+	case advDays:
+		advanceUnits = 60*24;
+		break;
+	default:
+#ifdef DEBUG
+		DEBUGCONDUIT << fname
+			<< ": Unknown advance units "
+			<< advanceUnits
+			<< endl;
+#endif
+		advanceUnits=1;
+	}
+
+	KCal::Duration adv(-60*advanceUnits*de->getAdvance());
+	KCal::Alarm*alm=e->newAlarm();
+	if (!alm) return;
+
+	alm->setStartOffset(adv);
+	alm->setEnabled(true);
+}
+
+void VCalRecord::setRecurrence(KCal::Event *event,const PilotDateEntry *dateEntry)
+{
+	FUNCTIONSETUP;
+
+	if ((dateEntry->getRepeatType() == repeatNone) || dateEntry->isMultiDay())
+	{
+#ifdef DEBUG
+		DEBUGCONDUIT<<fname<<": no recurrence to set"<<endl;
+#endif
+		return;
+	}
+
+	KCal::Recurrence *recur = event->recurrence();
+	int freq = dateEntry->getRepeatFrequency();
+	bool repeatsForever = dateEntry->getRepeatForever();
+	QDate endDate, evt;
+
+	if (!repeatsForever)
+	{
+		endDate = readTm(dateEntry->getRepeatEnd()).date();
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << "-- end " << endDate.toString() << endl;
+	}
+	else
+	{
+		DEBUGCONDUIT << fname << "-- noend" << endl;
+#endif
+	}
+
+	QBitArray dayArray(7);
+
+	switch(dateEntry->getRepeatType())
+	{
+	case repeatDaily:
+		recur->setDaily(freq);
+		break;
+	case repeatWeekly:
+		{
+		const int *days = dateEntry->getRepeatDays();
+
+#ifdef DEBUG
+		DEBUGCONDUIT << fname
+			<< ": Got repeat-weekly entry, by-days="
+			<< days[0] << " "<< days[1] << " "<< days[2] << " "
+			<< days[3] << " "
+			<< days[4] << " "<< days[5] << " "<< days[6] << " "
+			<< endl;
+#endif
+
+		// Rotate the days of the week, since day numbers on the Pilot and
+		// in vCal / Events are different.
+		//
+		if (days[0]) dayArray.setBit(6);
+		for (int i = 1; i < 7; i++)
+		{
+			if (days[i]) dayArray.setBit(i-1);
+		}
+		recur->setWeekly( freq, dayArray );
+		}
+		break;
+	case repeatMonthlyByDay: {
+		// Palm: Day=0(sun)-6(sat); week=0-4, 4=last week; pos=week*7+day
+		// libkcal: day=bit0(mon)-bit6(sun); week=-5to-1(from end) and 1-5 (from beginning)
+		// Palm->PC: w=pos/7
+		// week: if w=4 -> week=-1, else week=w+1;
+		// day: day=(pos-1)%7 (rotate by one day!)
+		recur->setMonthly( freq );
+
+		int day=dateEntry->getRepeatDay();
+		int week=day/7;
+		// week=4 means last, otherwise convert to 0-based
+		if (week==4) week=-1; else week++;
+		dayArray.setBit((day+6) % 7);
+		recur->addMonthlyPos(week, dayArray);
+		break;}
+	case repeatMonthlyByDate:
+		recur->setMonthly( freq );
+		recur->addMonthlyDate( dateEntry->getEventStart().tm_mday );
+		break;
+	case repeatYearly:
+		recur->setYearly( freq );
+		evt=readTm(dateEntry->getEventStart()).date();
+		recur->addYearlyMonth( evt.month() );
+//		dayArray.setBit((evt.day()-1) % 7);
+//		recur->addYearlyMonthPos( ( (evt.day()-1) / 7) + 1, dayArray );
+		break;
+	case repeatNone:
+	default :
+#ifdef DEBUG
+		DEBUGCONDUIT << fname
+			<< ": Can't handle repeat type "
+			<< dateEntry->getRepeatType()
+			<< endl;
+#endif
+		break;
+	}
+	if (!repeatsForever)
+	{
+		recur->setEndDate(endDate);
+	}
+}
+
+void VCalRecord::setExceptions(KCal::Event *vevent,const PilotDateEntry *dateEntry)
+{
+	FUNCTIONSETUP;
+
+	// Start from an empty exception list, and if necessary, add exceptions.
+	// At the end of the function, apply the (possibly empty) exception list.
+	KCal::DateList dl;
+
+	if ( !(dateEntry->isMultiDay() ) && dateEntry->getExceptionCount()>0 )
+	{
+		for (int i = 0; i < dateEntry->getExceptionCount(); i++)
+		{
+//			vevent->addExDate(readTm(dateEntry->getExceptions()[i]).date());
+			dl.append(readTm(dateEntry->getExceptions()[i]).date());
+		}
+	}
+	else
+	{
+#ifdef DEBUG
+	if (dateEntry->getExceptionCount()>0)
+	DEBUGCONDUIT << fname
+		<< ": WARNING Exceptions ignored for multi-day event "
+		<< dateEntry->getDescription()
+		<< endl ;
+#endif
+		return;
+	}
+	vevent->recurrence()->setExDates(dl);
+}
+
+void VCalRecord::setCategory(KCal::Event *e, const PilotDateEntry *de)
+{
+	FUNCTIONSETUP;
+
+	if (!e || !de)
+	{
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << ": error.  unable to set kcal category. e: [" <<
+			e << "], de: [" << de << "]" << endl;
+#endif
+		return;
+	}
+
+	QStringList cats=e->categories();
+	int cat = de->category();
+	QString newcat = de->getCategoryLabel();
+#ifdef DEBUG
+	DEBUGCONDUIT << fname << ": palm category id: [" << cat <<
+		"], label: [" << de->getCategoryLabel() << "]" << endl;
+#endif
+	if ( (0<cat) && (cat< (int)Pilot::CATEGORY_COUNT) )
+	{
+		if (!cats.contains(newcat))
+		{
+			// if this event only has one category associated with it, then we can
+			// safely assume that what we should be doing here is changing it to match
+			// the palm.  if there's already more than one category in the event, however, we
+			// won't cause data loss--we'll just append what the palm has to the
+			// event's categories
+			if (cats.count() <=1) cats.clear();
+
+			cats.append( newcat );
+			e->setCategories(cats);
+		}
+	}
+#ifdef DEBUG
+	DEBUGCONDUIT << fname << ": kcal categories now: [" << cats.join(",") << "]" << endl;
+#endif
+}
+
+
+bool VCalRecord::setDateEntry(PilotDateEntry*de, const KCal::Event*e)
+{
+	FUNCTIONSETUP;
+	if (!de || !e) {
+		DEBUGCONDUIT << fname
+			<< ": NULL event given... Skipping it" << endl;
+		return false;
+	}
+
+	// set secrecy, start/end times, alarms, recurrence, exceptions, summary and description:
+	if (e->secrecy()!=KCal::Event::SecrecyPublic)
+	{
+		de->setSecret( true );
+	}
+
+	setStartEndTimes(de, e);
+	setAlarms(de, e);
+	setRecurrence(de, e);
+	setExceptions(de, e);
+	de->setDescription(e->summary());
+	de->setNote(e->description());
+	de->setLocation(e->location());
+	setCategory(de, e);
+	return true;
+}
+
+void VCalRecord::setStartEndTimes(PilotDateEntry*de, const KCal::Event *e)
+{
+	FUNCTIONSETUP;
+	struct tm ttm=writeTm(e->dtStart());
+	de->setEventStart(ttm);
+	de->setFloats( e->doesFloat() );
+
+	if (e->hasEndDate() && e->dtEnd().isValid())
+	{
+		ttm=writeTm(e->dtEnd());
+	}
+	else
+	{
+		ttm=writeTm(e->dtStart());
+	}
+	de->setEventEnd(ttm);
+}
+
+
+
+
+void VCalRecord::setAlarms(PilotDateEntry*de, const KCal::Event *e)
+{
+	FUNCTIONSETUP;
+
+	if (!de || !e )
+	{
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << ": NULL entry given to setAlarms. "<<endl;
+#endif
+		return;
+	}
+
+	if ( !e->isAlarmEnabled() )
+	{
+		de->setAlarmEnabled( false );
+		return;
+	}
+
+	// find the first enabled alarm
+	KCal::Alarm::List alms=e->alarms();
+	KCal::Alarm* alm=0;
+	KCal::Alarm::List::ConstIterator it;
+	for ( it = alms.begin(); it != alms.end(); ++it ) {
+		if ((*it)->enabled()) alm=*it;
+	}
+
+	if (!alm )
+	{
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << ": no enabled alarm found (should exist!!!)"<<endl;
+#endif
+		de->setAlarmEnabled( false );
+		return;
+	}
+
+	// palm and PC offsets have a different sign!!
+	int aoffs=-alm->startOffset().asSeconds()/60;
+	int offs=(aoffs>0)?aoffs:-aoffs;
+
+	// find the best Advance Unit
+	if (offs>=100 || offs==60)
+	{
+		offs/=60;
+		if (offs>=48 || offs==24)
+		{
+			offs/=24;
+			de->setAdvanceUnits(advDays);
+		}
+		else
+		{
+			de->setAdvanceUnits(advHours);
+		}
+	}
+	else
+	{
+		de->setAdvanceUnits(advMinutes);
+	}
+	de->setAdvance((aoffs>0)?offs:-offs);
+	de->setAlarmEnabled( true );
+}
+
+
+
+void VCalRecord::setRecurrence(PilotDateEntry*dateEntry, const KCal::Event *event)
+{
+	FUNCTIONSETUP;
+	bool isMultiDay=false;
+
+	// first we have 'fake type of recurrence' when a multi-day event is passed to the pilot, it is converted to an event
+	// which recurs daily a number of times. if the event itself recurs, this will be overridden, and
+	// only the first day will be included in the event!!!!
+	QDateTime startDt(readTm(dateEntry->getEventStart())), endDt(readTm(dateEntry->getEventEnd()));
+	if (startDt.daysTo(endDt))
+	{
+		isMultiDay=true;
+		dateEntry->setRepeatType(repeatDaily);
+		dateEntry->setRepeatFrequency(1);
+		dateEntry->setRepeatEnd(dateEntry->getEventEnd());
+#ifdef DEBUG
+		DEBUGCONDUIT << fname <<": Setting single-day recurrence (" << startDt.toString() << " - " << endDt.toString() << ")" <<endl;
+#endif
+	}
+
+
+	KCal::Recurrence*r=event->recurrence();
+	if (!r) return;
+	ushort recType=r->recurrenceType();
+	if ( recType==KCal::Recurrence::rNone )
+	{
+		if (!isMultiDay) dateEntry->setRepeatType(repeatNone);
+		return;
+	}
+
+
+	int freq=r->frequency();
+	QDate endDate=r->endDate();
+
+	if ( r->duration() < 0 || !endDate.isValid() )
+	{
+		dateEntry->setRepeatForever();
+	}
+	else
+	{
+		dateEntry->setRepeatEnd(writeTm(endDate));
+	}
+	dateEntry->setRepeatFrequency(freq);
+#ifdef DEBUG
+	DEBUGCONDUIT<<" Event: "<<event->summary()<<" ("<<event->description()<<")"<<endl;
+	DEBUGCONDUIT<< "duration: "<<r->duration() << ", endDate: "<<endDate.toString()<< ", ValidEndDate: "<<endDate.isValid()<<", NullEndDate: "<<endDate.isNull()<<endl;
+#endif
+
+	QBitArray dayArray(7), dayArrayPalm(7);
+	switch(recType)
+	{
+	case KCal::Recurrence::rDaily:
+		dateEntry->setRepeatType(repeatDaily);
+		break;
+	case KCal::Recurrence::rWeekly:
+		dateEntry->setRepeatType(repeatWeekly);
+		dayArray=r->days();
+		// rotate the bits by one
+		for (int i=0; i<7; i++)
+		{
+			dayArrayPalm.setBit( (i+1)%7, dayArray[i]);
+		}
+		dateEntry->setRepeatDays(dayArrayPalm);
+		break;
+	case KCal::Recurrence::rMonthlyPos:
+		// Palm: Day=0(sun)-6(sat); week=0-4, 4=last week; pos=week*7+day
+		// libkcal: day=bit0(mon)-bit6(sun); week=-5to-1(from end) and 1-5 (from beginning)
+		// PC->Palm: pos=week*7+day
+		//  week: if w=-1 -> week=4, else week=w-1
+		//  day: day=(daybit+1)%7  (rotate because of the different offset)
+		dateEntry->setRepeatType(repeatMonthlyByDay);
+		if (r->monthPositions().count()>0)
+		{
+			// Only take the first monthly position, as the palm allows only one
+			QValueList<KCal::RecurrenceRule::WDayPos> mps=r->monthPositions();
+			KCal::RecurrenceRule::WDayPos mp=mps.first();
+			int week = mp.pos();
+			int day = (mp.day()+1) % 7; // rotate because of different offset
+			// turn to 0-based and include starting from end of month
+			// TODO: We don't handle counting from the end of the month yet!
+			if (week==-1) week=4; else week--;
+			dateEntry->setRepeatDay(static_cast<DayOfMonthType>(7*week + day));
+		}
+		break;
+	case KCal::Recurrence::rMonthlyDay:
+		dateEntry->setRepeatType(repeatMonthlyByDate);
+//TODO: is this needed?		dateEntry->setRepeatDay(static_cast<DayOfMonthType>(startDt.day()));
+		break;
+	case KCal::Recurrence::rYearlyDay:
+	case KCal::Recurrence::rYearlyPos:
+		DEBUGCONDUIT << fname
+			<< "! Unsupported yearly recurrence type." << endl;
+	case KCal::Recurrence::rYearlyMonth:
+		dateEntry->setRepeatType(repeatYearly);
+		break;
+	case KCal::Recurrence::rNone:
+		if (!isMultiDay) dateEntry->setRepeatType(repeatNone);
+		break;
+	default:
+#ifdef DEBUG
+		DEBUGCONDUIT << fname << ": Unknown recurrence type "<< recType << " with frequency "
+			<< freq << " and duration " << r->duration() << endl;
+#endif
+		break;
+	}
+}
+
+
+void VCalRecord::setExceptions(PilotDateEntry *dateEntry, const KCal::Event *vevent )
+{
+	FUNCTIONSETUP;
+	struct tm *ex_List;
+
+	if (!dateEntry || !vevent)
+	{
+		kdWarning() << k_funcinfo << ": NULL dateEntry or NULL vevent given for exceptions. Skipping exceptions" << endl;
+		return;
+	}
+	// first, we need to delete the old exceptions list, if it existed...
+	// This is no longer needed, as I fixed PilotDateEntry::setExceptions to do this automatically
+/*	ex_List=const_cast<structdateEntry->getExceptions();
+	if (ex_List)
+		KPILOT_DELETE(ex_List);*/
+
+	KCal::DateList exDates = vevent->recurrence()->exDates();
+	size_t excount = exDates.size();
+	if (excount<1)
+	{
+		dateEntry->setExceptionCount(0);
+		dateEntry->setExceptions(0);
+		return;
+	}
+
+	// we have exceptions, so allocate mem and copy them there...
+	ex_List=new struct tm[excount];
+	if (!ex_List)
+	{
+		kdWarning() << k_funcinfo << ": Couldn't allocate memory for the exceptions" << endl;
+		dateEntry->setExceptionCount(0);
+		dateEntry->setExceptions(0);
+		return;
+	}
+
+	size_t n=0;
+
+	KCal::DateList::ConstIterator dit;
+	for (dit = exDates.begin(); dit != exDates.end(); ++dit ) {
+		struct tm ttm=writeTm(*dit);
+		ex_List[n++]=ttm;
+	}
+	dateEntry->setExceptionCount(excount);
+	dateEntry->setExceptions(ex_List);
+}
+
+
+void VCalRecord::setCategory(PilotDateEntry *de, const KCal::Event *e)
+{
+	FUNCTIONSETUP;
+
+	if (!de || !e)
+	{
+		return;
+	}
+
+	QString deCategory;
+	QStringList eventCategories = e->categories();
+	if (eventCategories.size() < 1)
+	{
+		// This event has no categories.
+		de->setCategory(Pilot::Unfiled);
+		return;
+	}
+
+	// Quick check: does the record (not unfiled) have an entry
+	// in the categories list? If so, use that.
+	if (de->category() != Pilot::Unfiled)
+	{
+		deCategory = de->getCategoryLabel();
+		if (eventCategories.contains(deCategory))
+		{
+			// Found, so leave the category unchanged.
+			return;
+		}
+	}
+
+	QStringList availableHandheldCategories = Pilot::categoryNames(&(de->appInfo().category));
+
+	// Either the record is unfiled, and should be filed, or
+	// it has a category set which is not in the list of
+	// categories that the event has. So go looking for
+	// a category that is available both for the event
+	// and on the handheld.
+	for ( QStringList::ConstIterator it = eventCategories.begin();
+		it != eventCategories.end(); ++it )
+	{
+		// Odd, an empty category string.
+		if ( (*it).isEmpty() )
+		{
+			continue;
+		}
+
+		if (availableHandheldCategories.contains(*it))
+		{
+			de->setCategory(*it);
+			return;
+		}
+	}
+
+	de->setCategory(Pilot::Unfiled);
+}
+
Index: kpilot/conduits/vcalconduit/Makefile.am
===================================================================
--- kpilot/conduits/vcalconduit/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,11 +16,12 @@
 
 libvcalconduit_shared_la_SOURCES = vcalconduitSettings.kcfgc \
 	korganizerConduit.ui \
-	vcal-factorybase.cc \
 	vcal-setupbase.cc \
-	vcal-conduitbase.cc
+	vcal-conduitbase.cc \
+	cleanupstate.cc deleteunsyncedhhstate.cc deleteunsyncedpcstate.cc \
+	hhtopcstate.cc initstate.cc pctohhstate.cc teststate.cc
 
-conduit_vcal_la_SOURCES = vcal-conduit.cc vcal-factory.cc vcal-setup.cc
+conduit_vcal_la_SOURCES = vcal-conduit.cc vcalRecord.cc vcal-factory.cc vcal-setup.cc
 conduit_vcal_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
 conduit_vcal_la_LIBADD = ../../lib/libkpilot.la \
 	../../../libkcal/libkcal.la \
Index: kpilot/conduits/vcalconduit/vcal-factorybase.h
===================================================================
--- kpilot/conduits/vcalconduit/vcal-factorybase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-factorybase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,7 +30,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-#include <klibloader.h>
 
 #define RES_PALMOVERRIDES 0
 #define RES_PCOVERRIDES 1
@@ -41,24 +40,5 @@
 #define SYNC_FULL 2
 #define SYNC_MAX SYNC_FULL
 
-class KAboutData;
-class VCalConduitSettings;
 
-class VCalConduitFactoryBase : public KLibFactory
-{
-  Q_OBJECT
-
-public:
-	VCalConduitFactoryBase(QObject * p= 0L,const char * n= 0L):KLibFactory(p,n){};
-	virtual ~VCalConduitFactoryBase();
-	static KAboutData *about() { return fAbout; };
-
-protected:
-	virtual QObject* createObject( QObject* parent = 0,
-		const char* name = 0,
-		const char* classname = "QObject",
-		const QStringList &args = QStringList() )=0;
-	static KAboutData *fAbout;
-};
-
 #endif
Index: kpilot/conduits/vcalconduit/vcal-conduit.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/vcal-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,20 +28,23 @@
 */
 
 #include "options.h"
-#include <qtextcodec.h>
+
 #include <libkcal/calendar.h>
+#include <libkcal/calendarlocal.h>
 #include <libkcal/recurrence.h>
-#define Recurrence_t KCal::Recurrence
-#include <pilotDateEntry.h>
-#include <pilotDatabase.h>
+#include <libkcal/vcalformat.h>
+
+#include "pilotDateEntry.h"
+#include "pilotDatabase.h"
+
 #include "vcal-conduit.moc"
-#include "vcal-factory.h"
+#include "vcalconduitSettings.h"
+#include "vcalRecord.h"
 
 extern "C"
 {
 
-long version_conduit_vcal = KPILOT_PLUGIN_API;
-const char *id_conduit_vcal = "$Id$";
+unsigned long version_conduit_vcal = Pilot::PLUGIN_API;
 
 }
 
@@ -76,6 +79,10 @@
 	fAllEvents.remove(dynamic_cast<KCal::Event*>(e));
 	if (!fCalendar) return;
 	fCalendar->deleteEvent(dynamic_cast<KCal::Event*>(e));
+	// now just in case we're in the middle of reading through our list
+	// and we delete something, set reading to false so we start at the
+	// top again next time and don't have problems with our iterator
+	reading = false;
 }
 
 
@@ -89,7 +96,7 @@
 	return 0L;
 }
 
-KCal::Incidence *VCalConduitPrivate::findIncidence(PilotAppCategory*tosearch)
+KCal::Incidence *VCalConduitPrivate::findIncidence(PilotRecordBase *tosearch)
 {
 	PilotDateEntry*entry=dynamic_cast<PilotDateEntry*>(tosearch);
 	if (!entry) return 0L;
@@ -158,16 +165,12 @@
  *                          VCalConduit class                               *
  ****************************************************************************/
 
-VCalConduit::VCalConduit(KPilotDeviceLink *d,
+VCalConduit::VCalConduit(KPilotLink *d,
 	const char *n,
 	const QStringList &a) : VCalConduitBase(d,n,a)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_conduit_vcal << endl;
-#endif
 	fConduitName=i18n("Calendar");
-	(void) id_conduit_vcal;
 }
 
 
@@ -185,8 +188,8 @@
 	FUNCTIONSETUP;
 	// get the address application header information
 	unsigned char *buffer =
-		new unsigned char[PilotRecord::APP_BUFFER_SIZE];
-	int appLen = fDatabase->readAppBlock(buffer,PilotRecord::APP_BUFFER_SIZE);
+		new unsigned char[Pilot::MAX_APPINFO_SIZE];
+	int appLen = fDatabase->readAppBlock(buffer,Pilot::MAX_APPINFO_SIZE);
 
 	unpack_AppointmentAppInfo(&fAppointmentAppInfo, buffer, appLen);
 	delete[]buffer;
@@ -206,7 +209,7 @@
 
 }
 
-const QString VCalConduit::getTitle(PilotAppCategory*de)
+const QString VCalConduit::getTitle(PilotRecordBase *de)
 {
 	PilotDateEntry*d=dynamic_cast<PilotDateEntry*>(de);
 	if (d) return QString(d->getDescription());
@@ -215,590 +218,105 @@
 
 
 
-PilotRecord*VCalConduit::recordFromIncidence(PilotAppCategory*de, const KCal::Incidence*e)
+PilotRecord *VCalConduit::recordFromIncidence(PilotRecordBase *de, const KCal::Incidence*e)
 {
 	FUNCTIONSETUP;
 	if (!de || !e)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": got null entry or null incidence."<<endl;
-#endif
-		return NULL;
-	}
-	return recordFromIncidence(dynamic_cast<PilotDateEntry*>(de), dynamic_cast<const KCal::Event*>(e));
-}
-
-PilotRecord*VCalConduit::recordFromIncidence(PilotDateEntry*de, const KCal::Event*e)
-{
-	FUNCTIONSETUP;
-	if (!de || !e) {
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": NULL event given... Skipping it"<<endl;
-#endif
-		return NULL;
-	}
-
-	// set secrecy, start/end times, alarms, recurrence, exceptions, summary and description:
-	if (e->secrecy()!=KCal::Event::SecrecyPublic) de->setSecret( true );
-
-	setStartEndTimes(de, e);
-	setAlarms(de, e);
-	setRecurrence(de, e);
-	setExceptions(de, e);
-	de->setDescription(e->summary());
-	de->setNote(e->description());
-	setCategory(de, e);
-DEBUGCONDUIT<<"-------- "<<e->summary()<<endl;
-	return de->pack();
-}
-
-
-KCal::Incidence *VCalConduit::incidenceFromRecord(KCal::Incidence *e, const PilotAppCategory *de)
-{
-	return dynamic_cast<KCal::Incidence*>(incidenceFromRecord(dynamic_cast<KCal::Event*>(e), dynamic_cast<const PilotDateEntry*>(de)));
-}
-
-
-KCal::Event *VCalConduit::incidenceFromRecord(KCal::Event *e, const PilotDateEntry *de)
-{
-	FUNCTIONSETUP;
-	if (!e) {
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": NULL event given... Skipping it"<<endl;
-#endif
-		return NULL;
-	}
-
-   // We don't want this, do we?
-//	e->setOrganizer(fCalendar->getEmail());
-	e->setSyncStatus(KCal::Incidence::SYNCNONE);
-	e->setSecrecy(de->isSecret() ?
-		KCal::Event::SecrecyPrivate :
-		KCal::Event::SecrecyPublic);
-
-	e->setPilotId(de->id());
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": set KCal item to pilotId: [" << e->pilotId() << "]..."<<endl;
-#endif
-	e->setSyncStatus(KCal::Incidence::SYNCNONE);
-
-	setStartEndTimes(e,de);
-	setAlarms(e,de);
-	setRecurrence(e,de);
-	setExceptions(e,de);
-
-	e->setSummary(de->getDescription());
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": DESCRIPTION: "<<de->getDescription()<<"  ---------------------------------------------------"<<endl;
-#endif
-	e->setDescription(de->getNote());
-
-	// used by e.g. Agendus and Datebk
-	setCategory(e, de);
-
-	return e;
-}
-
-
-void VCalConduit::setStartEndTimes(KCal::Event *e,const PilotDateEntry *de)
-{
-	FUNCTIONSETUP;
-	e->setDtStart(readTm(de->getEventStart()));
-#ifdef DEBUG
-	DEBUGCONDUIT<<"Start time on Palm: "<<readTm(de->getEventStart()).toString()<<", on PC: "<<e->dtStart().toString()<<endl;
-#endif
-	e->setFloats(de->isEvent());
-
-	if (de->isMultiDay())
-	{
-		e->setDtEnd(readTm(de->getRepeatEnd()));
-	}
-	else
-	{
-		e->setDtEnd(readTm(de->getEventEnd()));
-	}
-}
-
-
-void VCalConduit::setStartEndTimes(PilotDateEntry*de, const KCal::Event *e)
-{
-	FUNCTIONSETUP;
-	struct tm ttm=writeTm(e->dtStart());
-	de->setEventStart(ttm);
-	de->setFloats( e->doesFloat() );
-
-	if (e->hasEndDate() && e->dtEnd().isValid())
-	{
-		ttm=writeTm(e->dtEnd());
-	}
-	else
-	{
-		ttm=writeTm(e->dtStart());
-	}
-	de->setEventEnd(ttm);
-}
-
-
-void VCalConduit::setAlarms(KCal::Event *e, const PilotDateEntry *de)
-{
-	FUNCTIONSETUP;
-
-	if (!e) return;
-	// Delete all the alarms now and add them one by one later on.
-	e->clearAlarms();
-	if (!de->isAlarmEnabled()) return;
-
-//	QDateTime alarmDT = readTm(de->getEventStart());
-	int advanceUnits = de->getAdvanceUnits();
-
-	switch (advanceUnits)
-	{
-	case advMinutes:
-		advanceUnits = 1;
-		break;
-	case advHours:
-		advanceUnits = 60;
-		break;
-	case advDays:
-		advanceUnits = 60*24;
-		break;
-	default:
-#ifdef DEBUG
 		DEBUGCONDUIT << fname
-			<< ": Unknown advance units "
-			<< advanceUnits
-			<< endl;
-#endif
-		advanceUnits=1;
+			<< ": got NULL entry or NULL incidence." << endl;
+		return 0L;
 	}
 
-	KCal::Duration adv(-60*advanceUnits*de->getAdvance());
-	KCal::Alarm*alm=e->newAlarm();
-	if (!alm) return;
-
-	alm->setStartOffset(adv);
-	alm->setEnabled(true);
-}
-
-
-
-void VCalConduit::setAlarms(PilotDateEntry*de, const KCal::Event *e)
-{
-	FUNCTIONSETUP;
-
-	if (!de || !e )
+	if ( (e->recurrenceType() == KCal::Recurrence::rYearlyDay) ||
+		(e->recurrenceType() ==  KCal::Recurrence::rYearlyPos) )
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": NULL entry given to setAlarms. "<<endl;
-#endif
-		return;
+		// Warn ahead of time
+		emit logMessage(i18n("Event \"%1\" has a yearly recurrence other than by month, will change this to recurrence by month on handheld.").arg(e->summary()));
 	}
 
-	if ( !e->isAlarmEnabled() )
+	PilotDateEntry *dateEntry = dynamic_cast<PilotDateEntry*>(de);
+	if (!dateEntry)
 	{
-		de->setAlarmEnabled( false );
-		return;
+		// Secretly wasn't a date entry after all
+		return 0L;
 	}
 
-	// find the first enabled alarm
-	KCal::Alarm::List alms=e->alarms();
-	KCal::Alarm* alm=0;
-	KCal::Alarm::List::ConstIterator it;
-	for ( it = alms.begin(); it != alms.end(); ++it ) {
-		if ((*it)->enabled()) alm=*it;
-	}
-
-	if (!alm )
+	const KCal::Event *event = dynamic_cast<const KCal::Event *>(e);
+	if (!event)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": no enabled alarm found (should exist!!!)"<<endl;
-#endif
-		de->setAlarmEnabled( false );
-		return;
+		DEBUGCONDUIT << fname << ": Incidence is not an event." << endl;
+		return 0L;
 	}
 
-	// palm and PC offsets have a different sign!!
-	int aoffs=-alm->startOffset().asSeconds()/60;
-	int offs=(aoffs>0)?aoffs:-aoffs;
-
-	// find the best Advance Unit
-	if (offs>=100 || offs==60)
+	if (VCalRecord::setDateEntry(dateEntry, event))
 	{
-		offs/=60;
-		if (offs>=48 || offs==24)
-		{
-			offs/=24;
-			de->setAdvanceUnits(advDays);
-		}
-		else
-		{
-			de->setAdvanceUnits(advHours);
-		}
+		return dateEntry->pack();
 	}
 	else
 	{
-		de->setAdvanceUnits(advMinutes);
+		return 0L;
 	}
-	de->setAdvance((aoffs>0)?offs:-offs);
-	de->setAlarmEnabled( true );
 }
 
-
-void VCalConduit::setRecurrence(KCal::Event *event,const PilotDateEntry *dateEntry)
+KCal::Incidence *VCalConduit::incidenceFromRecord(KCal::Incidence *e, const PilotRecordBase  *de)
 {
 	FUNCTIONSETUP;
 
-	if ((dateEntry->getRepeatType() == repeatNone) || dateEntry->isMultiDay())
+	if (!de || !e)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT<<fname<<": no recurrence to set"<<endl;
-#endif
-		return;
-	}
-
-	Recurrence_t *recur = event->recurrence();
-	int freq = dateEntry->getRepeatFrequency();
-	bool repeatsForever = dateEntry->getRepeatForever();
-	QDate endDate, evt;
-
-	if (!repeatsForever)
-	{
-		endDate = readTm(dateEntry->getRepeatEnd()).date();
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << "-- end " << endDate.toString() << endl;
-	}
-	else
-	{
-		DEBUGCONDUIT << fname << "-- noend" << endl;
-#endif
-	}
-
-	QBitArray dayArray(7);
-
-	switch(dateEntry->getRepeatType())
-	{
-	case repeatDaily:
-		recur->setDaily(freq);
-		break;
-	case repeatWeekly:
-		{
-		const int *days = dateEntry->getRepeatDays();
-
-#ifdef DEBUG
 		DEBUGCONDUIT << fname
-			<< ": Got repeat-weekly entry, by-days="
-			<< days[0] << " "<< days[1] << " "<< days[2] << " "
-			<< days[3] << " "
-			<< days[4] << " "<< days[5] << " "<< days[6] << " "
-			<< endl;
-#endif
-
-		// Rotate the days of the week, since day numbers on the Pilot and
-		// in vCal / Events are different.
-		//
-		if (days[0]) dayArray.setBit(6);
-		for (int i = 1; i < 7; i++)
-		{
-			if (days[i]) dayArray.setBit(i-1);
-		}
-		recur->setWeekly( freq, dayArray );
-		}
-		break;
-	case repeatMonthlyByDay: {
-		// Palm: Day=0(sun)-6(sat); week=0-4, 4=last week; pos=week*7+day
-		// libkcal: day=bit0(mon)-bit6(sun); week=-5to-1(from end) and 1-5 (from beginning)
-		// Palm->PC: w=pos/7
-		// week: if w=4 -> week=-1, else week=w+1;
-		// day: day=(pos-1)%7 (rotate by one day!)
-		recur->setMonthly( freq );
-
-		int day=dateEntry->getRepeatDay();
-		int week=day/7;
-		// week=4 means last, otherwise convert to 0-based
-		if (week==4) week=-1; else week++;
-		dayArray.setBit((day+6) % 7);
-		recur->addMonthlyPos(week, dayArray);
-		break;}
-	case repeatMonthlyByDate:
-		recur->setMonthly( freq );
-		recur->addMonthlyDate( dateEntry->getEventStart().tm_mday );
-		break;
-	case repeatYearly:
-		recur->setYearly( freq );
-		evt=readTm(dateEntry->getEventStart()).date();
-		recur->addYearlyMonth( evt.month() );
-//		dayArray.setBit((evt.day()-1) % 7);
-//		recur->addYearlyMonthPos( ( (evt.day()-1) / 7) + 1, dayArray );
-		break;
-	case repeatNone:
-	default :
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-			<< ": Can't handle repeat type "
-			<< dateEntry->getRepeatType()
-			<< endl;
-#endif
-		break;
+			<< ": Got NULL entry or NULL incidence." << endl;
+		return 0L;
 	}
-	if (!repeatsForever)
-	{
-		recur->setEndDate(endDate);
-	}
-}
 
-
-void VCalConduit::setRecurrence(PilotDateEntry*dateEntry, const KCal::Event *event)
-{
-	FUNCTIONSETUP;
-	bool isMultiDay=false;
-
-	// first we have 'fake type of recurrence' when a multi-day event is passed to the pilot, it is converted to an event
-	// which recurs daily a number of times. if the event itself recurs, this will be overridden, and
-	// only the first day will be included in the event!!!!
-	QDateTime startDt(readTm(dateEntry->getEventStart())), endDt(readTm(dateEntry->getEventEnd()));
-	if (startDt.daysTo(endDt))
+	const PilotDateEntry *dateEntry = dynamic_cast<const PilotDateEntry *>(de);
+	if (!dateEntry)
 	{
-		isMultiDay=true;
-		dateEntry->setRepeatType(repeatDaily);
-		dateEntry->setRepeatFrequency(1);
-		dateEntry->setRepeatEnd(dateEntry->getEventEnd());
-#ifdef DEBUG
-		DEBUGCONDUIT << fname <<": Setting single-day recurrence (" << startDt.toString() << " - " << endDt.toString() << ")" <<endl;
-#endif
+		DEBUGCONDUIT << fname << ": HH record not a date entry." << endl;
+		return 0L;
 	}
 
-
-	KCal::Recurrence*r=event->recurrence();
-	if (!r) return;
-	ushort recType=r->recurrenceType();
-	if ( recType==KCal::Recurrence::rNone )
+	KCal::Event *event = dynamic_cast<KCal::Event *>(e);
+	if (!event)
 	{
-		if (!isMultiDay) dateEntry->setRepeatType(repeatNone);
-		return;
+		DEBUGCONDUIT << fname << ": Incidence is not an event." << endl;
+		return 0L;
 	}
 
+	VCalRecord::setEvent(event, dateEntry);
+	return e;
+}
 
-	int freq=r->frequency();
-	QDate endDate=r->endDate();
 
-	if ( r->duration() < 0 || !endDate.isValid() )
-	{
-		dateEntry->setRepeatForever();
-	}
-	else
-	{
-		dateEntry->setRepeatEnd(writeTm(endDate));
-	}
-	dateEntry->setRepeatFrequency(freq);
-#ifdef DEBUG
-	DEBUGCONDUIT<<" Event: "<<event->summary()<<" ("<<event->description()<<")"<<endl;
-	DEBUGCONDUIT<< "duration: "<<r->duration() << ", endDate: "<<endDate.toString()<< ", ValidEndDate: "<<endDate.isValid()<<", NullEndDate: "<<endDate.isNull()<<endl;
-#endif
 
-	QBitArray dayArray(7), dayArrayPalm(7);
-	switch(recType)
-	{
-	case KCal::Recurrence::rDaily:
-		dateEntry->setRepeatType(repeatDaily);
-		break;
-	case KCal::Recurrence::rWeekly:
-		dateEntry->setRepeatType(repeatWeekly);
-		dayArray=r->days();
-		// rotate the bits by one
-		for (int i=0; i<7; i++)
-		{
-			dayArrayPalm.setBit( (i+1)%7, dayArray[i]);
-		}
-		dateEntry->setRepeatDays(dayArrayPalm);
-		break;
-	case KCal::Recurrence::rMonthlyPos:
-		// Palm: Day=0(sun)-6(sat); week=0-4, 4=last week; pos=week*7+day
-		// libkcal: day=bit0(mon)-bit6(sun); week=-5to-1(from end) and 1-5 (from beginning)
-		// PC->Palm: pos=week*7+day
-		//  week: if w=-1 -> week=4, else week=w-1
-		//  day: day=(daybit+1)%7  (rotate because of the different offset)
-		dateEntry->setRepeatType(repeatMonthlyByDay);
-		if (r->monthPositions().count()>0)
-		{
-			// Only take the first monthly position, as the palm allows only one
-			QValueList<KCal::RecurrenceRule::WDayPos> mps=r->monthPositions();
-			KCal::RecurrenceRule::WDayPos mp=mps.first();
-			int week = mp.pos();
-			int day = (mp.day()+1) % 7; // rotate because of different offset
-			// turn to 0-based and include starting from end of month
-			// TODO: We don't handle counting from the end of the month yet!
-			if (week==-1) week=4; else week--;
-			dateEntry->setRepeatDay(static_cast<DayOfMonthType>(7*week + day));
-		}
-		break;
-	case KCal::Recurrence::rMonthlyDay:
-		dateEntry->setRepeatType(repeatMonthlyByDate);
-//TODO: is this needed?		dateEntry->setRepeatDay(static_cast<DayOfMonthType>(startDt.day()));
-		break;
-	case KCal::Recurrence::rYearlyDay:
-	case KCal::Recurrence::rYearlyPos:
-		emit logMessage(i18n("Event \"%1\" has a yearly recurrence other than by month, will change this to recurrence by month on handheld.").arg(event->summary()));
-	case KCal::Recurrence::rYearlyMonth:
-		dateEntry->setRepeatType(repeatYearly);
-		break;
-	case KCal::Recurrence::rNone:
-		if (!isMultiDay) dateEntry->setRepeatType(repeatNone);
-		break;
-	default:
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Unknown recurrence type "<< recType << " with frequency "
-			<< freq << " and duration " << r->duration() << endl;
-#endif
-		break;
-	}
+PilotRecordBase * VCalConduit::newPilotEntry(PilotRecord*r)
+{
+	if (r) return new PilotDateEntry(fAppointmentAppInfo,r);
+	else return new PilotDateEntry(fAppointmentAppInfo);
 }
 
-
-void VCalConduit::setExceptions(KCal::Event *vevent,const PilotDateEntry *dateEntry)
+KCal::Incidence* VCalConduit::newIncidence()
 {
-	FUNCTIONSETUP;
-
-	// Start from an empty exception list, and if necessary, add exceptions.
-	// At the end of the function, apply the (possibly empty) exception list.
-	KCal::DateList dl;
-
-	if ( !(dateEntry->isMultiDay() ) && dateEntry->getExceptionCount()>0 )
-	{
-		for (int i = 0; i < dateEntry->getExceptionCount(); i++)
-		{
-//			vevent->addExDate(readTm(dateEntry->getExceptions()[i]).date());
-			dl.append(readTm(dateEntry->getExceptions()[i]).date());
-		}
-	}
-	else
-	{
-#ifdef DEBUG
-	if (dateEntry->getExceptionCount()>0)
-	DEBUGCONDUIT << fname
-		<< ": WARNING Exceptions ignored for multi-day event "
-		<< dateEntry->getDescription()
-		<< endl ;
-#endif
-		return;
-	}
-	vevent->recurrence()->setExDates(dl);
+  return new KCal::Event;
 }
 
-void VCalConduit::setExceptions(PilotDateEntry *dateEntry, const KCal::Event *vevent )
-{
-	FUNCTIONSETUP;
-	struct tm *ex_List;
+static VCalConduitSettings *config_vcal = 0L;
 
-	if (!dateEntry || !vevent)
+VCalConduitSettings *VCalConduit::theConfig() {
+	if (!config_vcal)
 	{
-		kdWarning() << k_funcinfo << ": NULL dateEntry or NULL vevent given for exceptions. Skipping exceptions" << endl;
-		return;
+		config_vcal = new VCalConduitSettings(CSL1("Calendar"));
 	}
-	// first, we need to delete the old exceptions list, if it existed...
-	// This is no longer needed, as I fixed PilotDateEntry::setExceptions to do this automatically
-/*	ex_List=const_cast<structdateEntry->getExceptions();
-	if (ex_List)
-		KPILOT_DELETE(ex_List);*/
 
-	KCal::DateList exDates = vevent->recurrence()->exDates();
-	size_t excount = exDates.size();
-	if (excount<1)
-	{
-		dateEntry->setExceptionCount(0);
-		dateEntry->setExceptions(0);
-		return;
-	}
-
-	// we have exceptions, so allocate mem and copy them there...
-	ex_List=new struct tm[excount];
-	if (!ex_List)
-	{
-		kdWarning() << k_funcinfo << ": Couldn't allocate memory for the exceptions" << endl;
-		dateEntry->setExceptionCount(0);
-		dateEntry->setExceptions(0);
-		return;
-	}
-
-	size_t n=0;
-
-	KCal::DateList::ConstIterator dit;
-	for (dit = exDates.begin(); dit != exDates.end(); ++dit ) {
-		struct tm ttm=writeTm(*dit);
-		ex_List[n++]=ttm;
-	}
-	dateEntry->setExceptionCount(excount);
-	dateEntry->setExceptions(ex_List);
+	return config_vcal;
 }
 
-
-void VCalConduit::setCategory(PilotDateEntry *de, const KCal::Event *e)
-{
-	if (!de || !e) return;
-	de->setCategory(_getCat(e->categories(), de->getCategoryLabel()));
+VCalConduitSettings *VCalConduit::config() {
+	return theConfig();
 }
 
-/**
- * _getCat returns the id of the category from the given categories list. If none of the categories exist
- * on the palm, the "Nicht abgelegt" (don't know the english name) is used.
- */
 
-QString VCalConduit::_getCat(const QStringList cats, const QString curr) const
-{
-	int j;
-	if (cats.size()<1) return QString::null;
-	if (cats.contains(curr)) return curr;
-	for ( QStringList::ConstIterator it = cats.begin(); it != cats.end(); ++it ) {
-		for (j=1; j<PILOT_CATEGORY_MAX; j++)
-		{
-			QString catName = PilotAppCategory::codec()->
-        toUnicode(fAppointmentAppInfo.category.name[j]);
-			if (!(*it).isEmpty() && !(*it).compare( catName ) )
-			{
-				return catName;
-			}
-		}
-	}
-	// If we have a free label, return the first possible cat
-	QString lastName(QString::fromLatin1(fAppointmentAppInfo.category.name[PILOT_CATEGORY_MAX-1]));
-	if (lastName.isEmpty()) return cats.first();
-	return QString::null;
-}
 
-void VCalConduit::setCategory(KCal::Event *e, const PilotDateEntry *de)
-{
-	if (!e || !de) return;
-	QStringList cats=e->categories();
-	int cat=de->category();
-	if (0<cat && cat<PILOT_CATEGORY_MAX)
-	{
-		QString newcat=PilotAppCategory::codec()->toUnicode(fAppointmentAppInfo.category.name[cat]);
-		if (!cats.contains(newcat))
-		{
-			// if this event only has one category associated with it, then we can
-			// safely assume that what we should be doing here is changing it to match
-			// the palm.  if there's already more than one category in the event, however, we
-			// won't cause data loss--we'll just append what the palm has to the 
-			// event's categories
-			if (cats.count() <=1) cats.clear();
-			
-			cats.append( newcat );
-			e->setCategories(cats);
-		}
-	}
-}
+// vim: ts=4:sw=4:noexpandtab:
 
-
-PilotAppCategory*VCalConduit::newPilotEntry(PilotRecord*r)
-{
-	if (r) return new PilotDateEntry(fAppointmentAppInfo,r);
-	else return new PilotDateEntry(fAppointmentAppInfo);
-}
-
-KCal::Incidence*VCalConduit::newIncidence()
-{
-  return new KCal::Event;
-}
-
-VCalConduitSettings *VCalConduit::config() {
-  return VCalConduitFactory::config();
-}
Index: kpilot/conduits/vcalconduit/pctohhstate.h
===================================================================
--- kpilot/conduits/vcalconduit/pctohhstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/pctohhstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,54 @@
+#ifndef _KPILOT_PCTOHHSTATE_H
+#define _KPILOT_PCTOHHSTATE_H
+/* pctohhstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the pctohhstate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State that handles copying of records from pc to handheld. 
+ * @see vcal-conduitstate.h
+ */
+class PCToHHState : public ConduitState
+{
+private:
+	ConduitState *fNextState;
+	int fPilotindex;
+
+public:
+	PCToHHState();
+	virtual ~PCToHHState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/cleanupstate.cc
===================================================================
--- kpilot/conduits/vcalconduit/cleanupstate.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/cleanupstate.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,132 @@
+/* KPilot
+**
+** Copyright (C) 2006 by Bertjan Broeksema <b.broeksema@gmail.com>
+**
+** This file is the implementation of the CleanUpState.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <options.h>
+
+#include <kio/netaccess.h>
+#include <qfile.h>
+
+#include "pilotDatabase.h"
+
+#include "vcal-conduitbase.h"
+#include "vcalconduitSettings.h"
+#include "cleanupstate.h"
+
+
+CleanUpState::CleanUpState()
+{
+	fState = eCleanUp;
+}
+
+CleanUpState::~CleanUpState()
+{
+}
+
+void CleanUpState::startSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Starting CleanUpState." << endl;
+
+	vccb->addLogMessage( i18n( "Cleaning up ..." ) );
+	vccb->postSync();
+
+	if ( vccb->database() )
+	{
+		vccb->database()->resetSyncFlags();
+		vccb->database()->cleanup();
+	}
+	if ( vccb->localDatabase() )
+	{
+		vccb->localDatabase()->resetSyncFlags();
+		vccb->localDatabase()->cleanup();
+	}
+
+	KCal::Calendar *fCalendar = vccb->calendar();
+	QString fCalendarFile = vccb->calendarFile();
+
+	if ( fCalendar )
+	{
+		KURL kurl( vccb->config()->calendarFile() );
+		switch( vccb->config()->calendarType() )
+		{
+		case VCalConduitSettings::eCalendarLocal:
+			dynamic_cast<KCal::CalendarLocal*>(fCalendar)->save( fCalendarFile );
+			if(!kurl.isLocalFile())
+			{
+				if( !KIO::NetAccess::upload( fCalendarFile
+					, vccb->config()->calendarFile(), 0L) )
+				{
+					vccb->addLogError( i18n( "An error occurred while uploading"
+						" \"%1\". You can try to upload "
+						"the temporary local file \"%2\" manually.")
+						.arg(vccb->config()->calendarFile()).arg(fCalendarFile));
+				}
+				else {
+					KIO::NetAccess::removeTempFile( fCalendarFile );
+				}
+				QFile backup( fCalendarFile + CSL1( "~" ) );
+				backup.remove();
+			}
+			break;
+		case VCalConduitSettings::eCalendarResource:
+			fCalendar->save();
+			break;
+		default:
+			break;
+		}
+		fCalendar->close();
+	}
+
+	vccb->setHasNextRecord( false );
+}
+
+void CleanUpState::handleRecord( ConduitAction * )
+{
+	FUNCTIONSETUP;
+}
+
+void CleanUpState::finishSync( ConduitAction *ca )
+{
+	FUNCTIONSETUP;
+
+	VCalConduitBase *vccb = dynamic_cast<VCalConduitBase*>(ca);
+	if( !vccb )
+	{
+		return;
+	}
+
+	DEBUGCONDUIT << fname << ": Finished CleanUpState." << endl;
+	vccb->setState( 0L );
+}
Index: kpilot/conduits/vcalconduit/hhtopcstate.h
===================================================================
--- kpilot/conduits/vcalconduit/hhtopcstate.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/vcalconduit/hhtopcstate.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,55 @@
+#ifndef _KPILOT_HHTOPCSTATE_H
+#define _KPILOT_HHTOPCSTATE_H
+/* hhtopcstate.h                       KPilot
+**
+** Copyright (C) 2006 Bertjan Broeksema
+**
+** This file defines the teststate for vcal-conduitbase.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU General Public License as published by
+** the Free Software Foundation; either version 2 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU General Public License for more details.
+**
+** You should have received a copy of the GNU General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <libkcal/calendarlocal.h>
+
+#include "conduitstate.h"
+
+class VCalConduitBase;
+
+/**
+ * State to test the vcal-conduit. @see vcal-conduitstate.h
+ */
+class HHToPCState : public ConduitState
+{
+private:
+	ConduitState *fNextState;
+	int fPilotindex;
+
+public:
+	HHToPCState();
+	virtual ~HHToPCState();
+
+	virtual void startSync( ConduitAction* );
+	virtual void handleRecord( ConduitAction* );
+	virtual void finishSync( ConduitAction* );
+};
+
+#endif
Index: kpilot/conduits/vcalconduit/korganizerConduit.ui
===================================================================
--- kpilot/conduits/vcalconduit/korganizerConduit.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/vcalconduit/korganizerConduit.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -267,9 +267,9 @@
     <tabstop>tabWidget</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>

Zmiany atrybutów dla: kpilot/conduits/vcalconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
   + .deps
.libs
Makefile
Makefile.in
*.moc
vcalconduitSettings.h
vcalconduitSettings.cc
korganizerConduit.cc
korganizerConduit.h



Index: kpilot/conduits/abbrowserconduit/abbrowser-conduit.h
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser-conduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/abbrowser-conduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,7 +56,7 @@
 {
 Q_OBJECT
 public:
-	AbbrowserConduit(KPilotDeviceLink *o,const char *n = 0L,
+	AbbrowserConduit(KPilotLink *o,const char *n = 0L,
 		const QStringList &a = QStringList() );
 	virtual ~AbbrowserConduit();
 
@@ -72,6 +72,8 @@
 	void slotDeleteUnsyncedHHRecords();
 	void slotCleanup();
 
+	void slotTestRecord();
+
 private:
 
 	/********************************************************/
@@ -133,7 +135,6 @@
 /*********************************************************************
                      D E B U G   O U T P U T
  *********************************************************************/
-#ifdef DEBUG
 	/**
 	* Output to console, for debugging only
 	*/
@@ -142,7 +143,7 @@
 	* Output to console, for debugging only
 	*/
 	static void showPilotAddress(PilotAddress *pilotAddress);
-#endif
+
 	void showAdresses(Addressee &pcAddr, PilotAddress *backupAddr,
 		PilotAddress *palmAddr);
 
Index: kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Comment[fa]=این لوله، کتاب نشانی دستی را با کتاب نشانی KDE همگام می‌سازد.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen KDE:n osoitekirjan kanssa
 Comment[fr]=Ce canal synchronise le carnet d'adresses du périphérique avec celui de KDE.
+Comment[gl]=Este conducto sincroniza o caderno de enderezos do seu aparello portátil co caderno de enderezos de KDE.
 Comment[hi]=यह कन्ड्यूइट हैंडहेल्ड पता-पुस्तिका को केडीई के पता-पुस्तिका से सिंक करती है.
 Comment[hu]=Ezzel a csatolóval egy kéziszámítógép és a KDE címjegyzéke között lehet szinkronizálást végezni.
 Comment[is]=Þessi rás samstillir póstfangaskrár KDE og lófatölvunnar
Index: kpilot/conduits/abbrowserconduit/resolutionDialog.cc
===================================================================
--- kpilot/conduits/abbrowserconduit/resolutionDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/resolutionDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -171,8 +171,8 @@
  *
  *****************************************************************/
 
-ResolutionDlg::ResolutionDlg( QWidget* parent, KPilotDeviceLink*fH,
-	QString caption, QString helpText, ResolutionTable*tab) :
+ResolutionDlg::ResolutionDlg( QWidget* parent, KPilotLink*fH,
+	const QString &caption, const QString &helpText, ResolutionTable*tab) :
 	KDialogBase( parent, "ResolutionDlg", false, caption, Apply|Cancel, Apply),
 	tickleTimer(0L),
 	fHandle(fH),
Index: kpilot/conduits/abbrowserconduit/resolutionDialog.h
===================================================================
--- kpilot/conduits/abbrowserconduit/resolutionDialog.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/resolutionDialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,7 +29,7 @@
 */
 
 #include <kdialogbase.h>
-class KPilotDeviceLink;
+class KPilotLink;
 class QTimer;
 class QListView;
 class ResolutionDialogBase;
@@ -42,7 +42,11 @@
     Q_OBJECT
 
 public:
-	ResolutionDlg( QWidget* parent=0, KPilotDeviceLink*fH=0L, QString caption=QString::null, QString helpText=QString::null, ResolutionTable*tab=0L );
+	ResolutionDlg( QWidget* parent=0, 
+		KPilotLink*fH=0L, 
+		const QString &caption=QString(), 
+		const QString &helpText=QString(), 
+		ResolutionTable *tab=0L );
 	~ResolutionDlg();
 
 public slots:
@@ -57,10 +61,10 @@
 	void adjustButtons(ResolutionTable*tab);
 
 	QTimer* tickleTimer;
-	KPilotDeviceLink* fHandle;
+	KPilotLink* fHandle;
 	ResolutionTable*fTable;
 
 	ResolutionDialogBase*fWidget;
 };
 
-#endif // MYDIALOG_H
+#endif // RESOLUTIONDIALOG_H
Index: kpilot/conduits/abbrowserconduit/kaddressbookConduit.ui
===================================================================
--- kpilot/conduits/abbrowserconduit/kaddressbookConduit.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/kaddressbookConduit.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -738,9 +738,9 @@
     <tabstop>fFax</tabstop>
 </tabstops>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kurlrequester.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+    <include location="global" impldecl="in implementation">kurlrequester.h</include>
+    <include location="global" impldecl="in implementation">klineedit.h</include>
+    <include location="global" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,6 +40,7 @@
 #include <kabc/stdaddressbook.h>
 #include <kabc/resourcefile.h>
 #include <kio/netaccess.h>
+#include <ksavefile.h>
 
 #include <pilotSerialDatabase.h>
 #include <pilotLocalDatabase.h>
@@ -56,8 +57,7 @@
 //
 extern "C"
 {
-long version_conduit_address = KPILOT_PLUGIN_API;
-const char *id_conduit_address="$Id$";
+unsigned long version_conduit_address = Pilot::PLUGIN_API;
 }
 
 
@@ -86,7 +86,7 @@
 
 
 
-AbbrowserConduit::AbbrowserConduit(KPilotDeviceLink * o, const char *n, const QStringList & a):
+AbbrowserConduit::AbbrowserConduit(KPilotLink * o, const char *n, const QStringList & a):
 		ConduitAction(o, n, a),
 		fAddressAppInfo(0L),
 		addresseeMap(),
@@ -95,9 +95,6 @@
 		ticket(0L)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT<<id_conduit_address<<endl;
-#endif
 	fConduitName=i18n("Addressbook");
 }
 
@@ -167,6 +164,7 @@
 
 	readConfig();
 	syncedIds.clear();
+	pilotindex = 0;
 
 	return true;
 }
@@ -182,20 +180,26 @@
 	SyncAction::ConflictResolution res = (SyncAction::ConflictResolution)AbbrowserSettings::conflictResolution();
 	setConflictResolution(res);
 
-#ifdef DEBUG
 	DEBUGCONDUIT << fname
-		<< ": Settings "
+		<< ": Reading addressbook "
+		<< ( AbbrowserSettings::addressbookType() == AbbrowserSettings::eAbookFile ?
+			AbbrowserSettings::fileName() : CSL1("Standard") )
+		<< endl;
+	DEBUGCONDUIT << fname
+		<< ": "
 		<< " fConflictResolution=" << getConflictResolution()
+		<< " fArchive=" << AbbrowserSettings::archiveDeleted()
+		<< " fFirstTime=" << isFirstSync()
+		<< endl;
+	DEBUGCONDUIT << fname
+		<< ": "
 		<< " fPilotStreetHome=" << AbbrowserSettings::pilotStreet()
 		<< " fPilotFaxHome=" << AbbrowserSettings::pilotFax()
-		<< " fArchive=" << AbbrowserSettings::archiveDeleted()
 		<< " eCustom[0]=" << AbbrowserSettings::custom0()
 		<< " eCustom[1]=" << AbbrowserSettings::custom1()
 		<< " eCustom[2]=" << AbbrowserSettings::custom2()
 		<< " eCustom[3]=" << AbbrowserSettings::custom3()
-		<< " fFirstTime=" << isFirstSync()
 		<< endl;
-#endif
 }
 
 
@@ -382,8 +386,8 @@
 void AbbrowserConduit::_setAppInfo()
 {
 	FUNCTIONSETUP;
-	if (fDatabase) fAddressAppInfo->write(fDatabase);
-	if (fLocalDatabase) fAddressAppInfo->write(fLocalDatabase);
+	if (fDatabase) fAddressAppInfo->writeTo(fDatabase);
+	if (fLocalDatabase) fAddressAppInfo->writeTo(fLocalDatabase);
 }
 
 int AbbrowserConduit::getCustom(const int index)
@@ -629,10 +633,10 @@
 
 
 
-#ifdef DEBUG
 void AbbrowserConduit::showAddressee(const Addressee & abAddress)
 {
 	FUNCTIONSETUP;
+#ifdef DEBUG
 	DEBUGCONDUIT << "\tAbbrowser Contact Entry" << endl;
 	if (abAddress.isEmpty()) {
 		DEBUGCONDUIT<< "\t\tEMPTY"<<endl;
@@ -650,6 +654,9 @@
 	DEBUGCONDUIT << "\t\tFax = " << getFax(abAddress).number() << endl;
 	DEBUGCONDUIT << "\t\tPager = " << abAddress.phoneNumber(PhoneNumber::Pager).number() << endl;
 	DEBUGCONDUIT << "\t\tCategory = " << abAddress.categories().first() << endl;
+#else
+	Q_UNUSED( abAddress );
+#endif
 }
 
 
@@ -657,6 +664,7 @@
 void AbbrowserConduit::showPilotAddress(PilotAddress *pilotAddress)
 {
 	FUNCTIONSETUPL(3);
+#ifdef DEBUG
 	if (debug_level >= 3)
 	{
 	if (!pilotAddress) {
@@ -666,8 +674,10 @@
 	DEBUGCONDUIT << fname << "\n"
 			<< pilotAddress->getTextRepresentation(false) << endl;
 	}
+#else
+	Q_UNUSED( pilotAddress );
+#endif
 }
-#endif
 
 
 void AbbrowserConduit::showAdresses(Addressee &pcAddr, PilotAddress *backupAddr,
@@ -703,9 +713,6 @@
 /* virtual */ bool AbbrowserConduit::exec()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << id_conduit_address << endl;
-#endif
 
 	_prepare();
 
@@ -717,11 +724,20 @@
 	}
 	setFirstSync( retrieved );
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": First sync now " << isFirstSync() << endl;
-#endif
+	_getAppInfo();
 
-	_getAppInfo();
+	// Local block
+	{
+		QString dbpath = fLocalDatabase->dbPathName();
+		DEBUGCONDUIT << fname << ": Local database path " << dbpath << endl;
+	}
+
+	if ( syncMode().isTest() )
+	{
+		QTimer::singleShot(0, this, SLOT(slotTestRecord()));
+		return true;
+	}
+
 	if(!_loadAddressBook())
 	{
 		emit logError(i18n("Unable to open the addressbook."));
@@ -738,7 +754,6 @@
 
 	// perform syncing from palm to abbrowser
 	// iterate through all records in palm pilot
-	pilotindex = 0;
 
 #ifdef DEBUG
 	DEBUGCONDUIT << fname << ": fullsync=" << isFullSync() << ", firstSync=" <<    isFirstSync() << endl;
@@ -1059,10 +1074,27 @@
 		fLocalDatabase->resetSyncFlags();
 		fLocalDatabase->cleanup();
 	}
+
+	// Write out the sync maps
+	QString syncFile = fLocalDatabase->dbPathName() + CSL1(".sync");
+	DEBUGCONDUIT << fname << ": Writing sync map to " << syncFile << endl;
+	KSaveFile map( syncFile );
+	if ( map.status() == 0 )
+	{
+		DEBUGCONDUIT << fname << ": Writing sync map ..." << endl;
+		(*map.dataStream()) << addresseeMap ;
+		map.close();
+	}
+	// This also picks up errors from map.close()
+	if ( map.status() != 0 )
+	{
+		kdWarning() << k_funcinfo << ": Could not make backup of sync map." << endl;
+	}
+
 	KPILOT_DELETE(fDatabase);
 	KPILOT_DELETE(fLocalDatabase);
 	_saveAddressBook();
-	emit syncDone(this);
+	delayDone();
 }
 
 
@@ -1304,9 +1336,9 @@
 	{
 		return false;
 	}
-#ifdef DEBUG
+
 	showPilotAddress(palmAddr);
-#endif
+
 	_copy(pcAddr, palmAddr);
 	_savePCAddr(pcAddr, backupAddr, palmAddr);
 	_writeBackup(palmAddr);
@@ -1320,10 +1352,8 @@
 	FUNCTIONSETUP;
 	if (!backup) return false;
 
+	showPilotAddress(backup);
 
-#ifdef DEBUG
-	showPilotAddress(backup);
-#endif
 	PilotRecord *pilotRec = backup->pack();
 	fLocalDatabase->writeRecord(pilotRec);
 	KPILOT_DELETE(pilotRec);
@@ -1874,7 +1904,7 @@
 
 
 	int cat = fromPiAddr->category();
-	QString category = fAddressAppInfo->category(cat);
+	QString category = fAddressAppInfo->categoryName(cat);
 	_setCategory(toAbEntry, category);
 #ifdef DEBUG
 	showAddressee(toAbEntry);
@@ -2266,3 +2296,24 @@
 	return Addressee();
 }
 
+void AbbrowserConduit::slotTestRecord()
+{
+	FUNCTIONSETUP;
+
+	// Get a record and interpret it as an address.
+	PilotRecord *r = fDatabase->readRecordByIndex( pilotindex );
+	if (!r)
+	{
+		delayDone();
+		return;
+	}
+	PilotAddress a(fAddressAppInfo,r);
+	KPILOT_DELETE(r);
+
+	// Process this record.
+	showPilotAddress(&a);
+
+	// Schedule more work.
+	++pilotindex;
+	QTimer::singleShot(0, this, SLOT(slotTestRecord()));
+}
Index: kpilot/conduits/abbrowserconduit/CMakeLists.txt
===================================================================
--- kpilot/conduits/abbrowserconduit/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/abbrowserconduit/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,40 @@
+include_directories(
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+set(conduit_abbrowser_SRCS
+	resolutionDialog.cc
+	abbrowser-factory.cc
+	abbrowser-setup.cc 
+	abbrowser-conduit.cc
+)
+
+set(conduit_abbrowser_UIS
+	resolutionDialog_base.ui
+	kaddressbookConduit.ui
+)
+
+set(conduit_abbrowser_KCFGS
+	abbrowserSettings.kcfgc
+)
+
+kde3_add_kcfg_files(conduit_abbrowser_SRCS ${conduit_abbrowser_KCFGS})
+kde3_add_ui_files(conduit_abbrowser_SRCS ${conduit_abbrowser_UIS})
+kde3_automoc(${conduit_abbrowser_SRCS})
+add_library(conduit_address SHARED ${conduit_abbrowser_SRCS})
+target_link_libraries(conduit_address kabc_file)
+set_target_properties(conduit_address PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	INSTALL_RPATH ${CMAKE_INSTALL_PREFIX}/lib
+	PREFIX ""
+)
+
+kde3_install_libtool_file(conduit_address)
+
+install(
+	TARGETS conduit_address
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+)
+
+install(
+	FILES abbrowser_conduit.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)

Zmiany atrybutów dla: kpilot/conduits/abbrowserconduit
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
abbrowser_conduit
   + .deps
.libs
Makefile
Makefile.in
abbrowser_conduit
kaddressbookConduit.cc
kaddressbookConduit.h
*.moc
abbrowserSettings.cc
abbrowserSettings.h
resolutionDialog_base.cc
resolutionDialog_base.h



Index: kpilot/conduits/CMakeLists.txt
===================================================================
--- kpilot/conduits/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/conduits/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,26 @@
+include_directories(
+	${CMAKE_BINARY_DIR}/lib
+	${CMAKE_SOURCE_DIR}/lib
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+add_subdirectory(abbrowserconduit)
+add_subdirectory(docconduit)
+add_subdirectory(knotes)
+add_subdirectory(memofileconduit)
+add_subdirectory(notepadconduit)
+add_subdirectory(null)
+add_subdirectory(popmail)
+add_subdirectory(sysinfoconduit)
+add_subdirectory(timeconduit)
+add_subdirectory(vcalconduit)
+
+# MAL seems to be broken, or the MAL API has changed somewhat
+# since the last time that the conduit was compiled by the development
+# team. Since we don't use the conduit it is disabled. 
+IF (MAL_FOUND)
+	# add_subdirectory(malconduit)
+	MESSAGE(STATUS "Although mal was found, the malconduit will not be compiled since it is unmaintained")
+ELSE (MAL_FOUND)
+	MESSAGE(STATUS "Couldn't find mal. Won't be able to build malconduit")
+ENDIF (MAL_FOUND)
Index: kpilot/configure.in.in
===================================================================
--- kpilot/configure.in.in	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/configure.in.in	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -129,15 +129,13 @@
 	#include <pi-version.h>
 	int main()
 	{ if (PILOT_LINK_VERSION==0) {
-	    if ((PILOT_LINK_MAJOR==9) && (PILOT_LINK_MINOR>=5)) return (0);
-	    if ((PILOT_LINK_MAJOR==10) || (PILOT_LINK_MAJOR==11)) return (0);
-	    if ((PILOT_LINK_MAJOR==12)) return(0);
+            if ((PILOT_LINK_MAJOR==12) && (PILOT_LINK_MINOR>=0)) return (0);
 	  }
 	  return (1);
 	}
 	]
 	,
-	[AC_MSG_RESULT([pilot-link version >= 0.9.5 found])],
+	[AC_MSG_RESULT([pilot-link version >= 0.12.0 found])],
 	[AC_MSG_RESULT([Your version of pilot-link won't work with KPilot])]
 	HAVE_PISOCK="0"
 	,
@@ -145,25 +143,6 @@
 	HAVE_PISOCK="0"
 	])
 fi
-if test "$HAVE_PISOCK" = "1" ; then
-	AC_MSG_CHECKING([deprecated pilot-link version])
-	AC_TRY_RUN([
-	#include <pi-version.h>
-	int main()
-	{ if (PILOT_LINK_VERSION==0) {
-	    if ((PILOT_LINK_MAJOR<11)) return (0);
-	    if ((PILOT_LINK_MAJOR==11) && (PILOT_LINK_MINOR<8)) return (0);
-	  }
-	  return (1);
-	}
-	]
-	,
-	[AC_MSG_RESULT([yes])
-	HAVE_BAD_PISOCK=YES
-	],
-	[AC_MSG_RESULT([no])]
-	)
-fi
 
 if test "x$with_pilot_link" = "xCHECK" ; then
 
Index: kpilot/Makefile.cmake
===================================================================
--- kpilot/Makefile.cmake	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/Makefile.cmake	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,62 @@
+# This is a GNU makefile. You need GNU make to process it.
+# FreeBSD users should use gmake.
+#
+#
+
+# Unusual configuration things:
+#   CMAKE = path to cmake
+#   BUILD_DIR = directory to build things in
+#   CMAKE_FLAGS = extra flags to CMake.  These will get set by
+#      ./configure, saved to CMakeOptions.txt, and read in below...
+#
+
+-include CMakeOptions.txt
+
+BUILD_DIR ?= build-$(shell uname -sr | tr -d [:space:] | tr -Cs a-zA-Z0-9 _ )
+# these come from CMakeOptions.txt (from ./configure)
+CMAKE_FLAGS ?=
+CMAKE ?= cmake
+
+all: build-check
+	@cd "$(BUILD_DIR)" && $(MAKE)
+
+check: lib tests
+	$(BUILD_DIR)/tests/testconstants
+	$(BUILD_DIR)/tests/testcategories --data-dir=tests/data
+	$(BUILD_DIR)/tests/testaddresses --data-dir=tests/data
+	$(BUILD_DIR)/tests/testdatebook --data-dir=tests/data
+
+install: all
+	@cd "$(BUILD_DIR)" && $(MAKE) install
+
+uninstall: 
+	@cd "$(BUILD_DIR)" && $(MAKE) uninstall
+
+lib: $(BUILD_DIR)/lib/libkpilot.so
+
+$(BUILD_DIR)/lib/libkpilot.so: build-check
+	@cd "$(BUILD_DIR)/lib" && $(MAKE)
+
+tests: build-check
+	@cd "$(BUILD_DIR)/tests" && $(MAKE)
+
+	
+build-check:
+	test -d "$(BUILD_DIR)" || mkdir -p "$(BUILD_DIR)"
+	test -d "$(BUILD_DIR)"
+	SRC_DIR=`pwd` ; cd "$(BUILD_DIR)" && $(CMAKE) $$SRC_DIR $(CMAKE_FLAGS)
+
+messages:
+	extractrc `find . -name *.rc` > rc.cc
+	extractrc `find . -name *.ui` >> rc.cc
+	xgettext -o kpilot.po --keyword=i18n rc.cc `find . -name *.h` `find . -name *.cc` 
+
+clean:
+	@rm -rf $(BUILD_DIR)
+
+help:
+	@echo "Usage: make ( all | install | uninstall | clean )"
+	@echo ""
+
+.PHONY : all check install uninstall lib build-check clean help 
+
Index: kpilot/cmake_uninstall.cmake.in
===================================================================
--- kpilot/cmake_uninstall.cmake.in	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/cmake_uninstall.cmake.in	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,23 @@
+IF(NOT EXISTS "@CMAKE_CURRENT_BINARY_DIR@/install_manifest.txt")
+  MESSAGE(FATAL_ERROR "Cannot find install manifest: 
+\"@CMAKE_CURRENT_BINARY_DIR@/install_manifest.txt\"")
+ENDIF(NOT EXISTS "@CMAKE_CURRENT_BINARY_DIR@/install_manifest.txt")
+
+FILE(READ "@CMAKE_CURRENT_BINARY_DIR@/install_manifest.txt" files)
+STRING(REGEX REPLACE "\n" ";" files "${files}")
+FOREACH(file ${files})
+  MESSAGE(STATUS "Uninstalling \"${file}\"")
+  IF(EXISTS "${file}")
+    EXEC_PROGRAM(
+      "@CMAKE_COMMAND@" ARGS "-E remove \"${file}\""
+      OUTPUT_VARIABLE rm_out
+      RETURN_VALUE rm_retval
+      )
+    IF("${rm_retval}" STREQUAL 0)
+    ELSE("${rm_retval}" STREQUAL 0)
+      MESSAGE(FATAL_ERROR "Problem when removing \"${file}\"")
+    ENDIF("${rm_retval}" STREQUAL 0)
+  ELSE(EXISTS "${file}")
+    MESSAGE(STATUS "File \"${file}\" does not exist.")
+  ENDIF(EXISTS "${file}")
+ENDFOREACH(file)
Index: kpilot/README
===================================================================
--- kpilot/README	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/README	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,36 +1,20 @@
-KPILOT 4.5.0 by Dan Pilone / Adriaan de Groot
+KPILOT 4.6.0 by Adriaan de Groot
 =============================================
 	Additional work by Robert Ambrose,
 	Preston Brown, Adriaan de Groot,
 	Heiko Purnhagen, Joerg Habenicht,
 	David Bishop, Aaron Seigo,
-	Reinhold Kainhofer, Joern Ahrens
+	Reinhold Kainhofer, Joern Ahrens,
+	Jason Kasper,
 	and probably many more.
 
-	KPilot is software for syncing PalmOne handhelds, the 3Com Palm Pilot 
-and IBM Workpad (UNTESTED!) with a machine running some flavor of unix.  By 
-default KPilot attempts to connnect using /dev/pilot which should be a link 
-to the actual serial port, however this is configurable in the settings dialog.
-Modern USB-based devices should be accessed by configuring the USB HotPlug 
-manager for your OS to link /dev/pilot to the correct USB device node.
+	KPilot is software for syncing PalmOS based handhelds
+such as the 3Com Palm Pilot with a machine running some flavor of UNIX.  
 
-	Release notes can be found in Documentation/README-4.*. These are
-official announcements of KPilot 4.x releases. There is also a README for
-3.2.1 which is probably not interesting any more.
-
 	Developer's notes are listed in the file ChangeLog. This is
 probably only of interest if you want to see how certain features developed
 or if certain bugs have been reported before.
 
-	Generic installation instructions can be found in the file
-INSTALL, but note that KPilot is part of the kdepim package and you
-have to configure that package, not KPilot. KPilot does compile and
-install on its own though, once kdepim is configured. Tarballs are
-available from www.kpilot.org for standalone compilation.
-
-	You NEED pilot-link to compile or install KPilot; KPilot is
-currently tested using version 0.11.8 of pilot-link.
-
 	http://www.kpilot.org/
 
 
@@ -55,4 +39,5 @@
 
 	Adriaan de Groot
 	groot@kde.org
-	April 23, 2005
+	November 18, 2006
+
Index: kpilot/kpilot/addressEditor.cc
===================================================================
--- kpilot/kpilot/addressEditor.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/addressEditor.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -19,7 +19,7 @@
 **
 ** You should have received a copy of the GNU General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -51,19 +51,17 @@
 
 #include "addressEditor.moc"
 
-static const char *addressEditor_id =
-	"$Id$";
 
 AddressEditor::AddressEditor(PilotAddress * p,
-	struct AddressAppInfo *appInfo,
+	PilotAddressInfo *appInfo,
 	QWidget * parent,
 	const char *name) :
 	KDialogBase(KDialogBase::Plain,
 		i18n("Address Editor"),
 		Ok | Cancel, Cancel,
 		parent, name, false /* non-modal */ ),
-	fDeleteOnCancel(p == 0L), 
-	fAddress(p), 
+	fDeleteOnCancel(p == 0L),
+	fAddress(p),
 	fAppInfo(appInfo)
 {
 	FUNCTIONSETUP;
@@ -74,7 +72,6 @@
 	connect(parent, SIGNAL(recordChanged(PilotAddress *)),
 		this, SLOT(updateRecord(PilotAddress *)));
 
-	(void) addressEditor_id;
 }
 
 AddressEditor::~AddressEditor()
@@ -116,7 +113,7 @@
 
 	if (idx >= 0 && idx < 8)	// hard-coded, no constant in pi-address.h
 	{
-		if ((s = fAppInfo->phoneLabels[idx]))
+		if ((s = fAppInfo->info()->phoneLabels[idx]))
 		{
 			ret = s;
 			ret += CSL1(":");
@@ -134,7 +131,7 @@
 
 	if (fAddress == 0L)
 	{
-		fAddress = new PilotAddress(*fAppInfo);
+		fAddress = new PilotAddress(fAppInfo);
 		fDeleteOnCancel = true;
 	}
 
@@ -256,7 +253,6 @@
 	fAddress->setField(entryCustom4, fCustom4Field->text());
 
 	emit(recordChangeComplete(fAddress));
-        fDeleteOnCancel = false;
 	KDialogBase::slotOk();
 }
 
Index: kpilot/kpilot/fileInstaller.cc
===================================================================
--- kpilot/kpilot/fileInstaller.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/fileInstaller.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,10 +29,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *fileinstaller_id =
-	"$Id$";
 
-
 #include "options.h"
 
 #include <unistd.h>
@@ -58,7 +55,6 @@
 		CSL1("kpilot/pending_install/"));
 	fPendingCopies = 0;
 
-	(void) fileinstaller_id;
 }
 
 /* virtual */ FileInstaller::~FileInstaller()
@@ -116,7 +112,7 @@
 	}
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname << ": Copying " << s << endl;
+	DEBUGKPILOT << fname << ": Copying " << s << endl;
 #endif
 
 	KURL srcName;
Index: kpilot/kpilot/todoEditor_base.ui
===================================================================
--- kpilot/kpilot/todoEditor_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/todoEditor_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -174,7 +174,7 @@
     </connection>
 </connections>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kdatewidget.h</includehint>
-</includehints>
+<includes>
+    <include location="system" impldecl="in implementation">kdatewidget.h</include>
+</includes>
 </UI>
Index: kpilot/kpilot/syncStack.cc
===================================================================
--- kpilot/kpilot/syncStack.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/syncStack.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,14 +29,11 @@
 */
 #include "options.h"
 
-static const char *syncStack_id = "$Id$";
-
 #include <unistd.h>
 
 #include <qtimer.h>
 #include <qfile.h>
 #include <qdir.h>
-#include <qtextcodec.h>
 
 #include <kservice.h>
 #include <kservicetype.h>
@@ -49,18 +46,16 @@
 #include "interactiveSync.h"
 #include "fileInstaller.h"
 #include "kpilotSettings.h"
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 
 #include "syncStack.moc"
 
 
 
-WelcomeAction::WelcomeAction(KPilotDeviceLink *p) :
+WelcomeAction::WelcomeAction(KPilotLink *p) :
 	SyncAction(p,"welcomeAction")
 {
 	FUNCTIONSETUP;
-
-	(void) syncStack_id;
 }
 
 /* virtual */ bool WelcomeAction::exec()
@@ -69,12 +64,12 @@
 
 	addSyncLogEntry(i18n("KPilot %1 HotSync starting...\n")
 		.arg(QString::fromLatin1(KPILOT_VERSION)));
-	emit logMessage( i18n("Using encoding %1 on the handheld.").arg(PilotAppCategory::codecName()) );
+	emit logMessage( i18n("Using encoding %1 on the handheld.").arg(Pilot::codecName()) );
 	emit syncDone(this);
 	return true;
 }
 
-SorryAction::SorryAction(KPilotDeviceLink *p, const QString &s) :
+SorryAction::SorryAction(KPilotLink *p, const QString &s) :
 	SyncAction(p,"sorryAction"),
 	fMessage(s)
 {
@@ -93,7 +88,7 @@
 	return delayDone();
 }
 
-LocalBackupAction::LocalBackupAction(KPilotDeviceLink *p, const QString &d) :
+LocalBackupAction::LocalBackupAction(KPilotLink *p, const QString &d) :
 	SyncAction(p,"LocalBackupAction"),
 	fDir(d)
 {
@@ -106,7 +101,7 @@
 	startTickle();
 
 	QString dirname = fDir +
-		PilotAppCategory::codec()->toUnicode(fHandle->getPilotUser()->getUserName()) +
+		Pilot::fromPilot(fHandle->getPilotUser().getUserName()) +
 		CSL1("/");
 	QDir dir(dirname,QString::null,QDir::Unsorted,QDir::Files);
 
@@ -135,7 +130,7 @@
 }
 
 
-ConduitProxy::ConduitProxy(KPilotDeviceLink *p,
+ConduitProxy::ConduitProxy(KPilotLink *p,
 	const QString &name,
 	const SyncAction::SyncMode &m) :
 	ConduitAction(p,name.latin1(),m.list()),
@@ -173,23 +168,51 @@
 		<< endl;
 #endif
 
-	KLibFactory *factory = KLibLoader::self()->factory(
+	KLibrary *library = KLibLoader::self()->library(
 		QFile::encodeName(fLibraryName));
-	if (!factory)
+	if (!library)
 	{
 		kdWarning() << k_funcinfo
 			<< ": Can't load library "
 			<< fLibraryName
+			<< " - "
+			<< KLibLoader::self()->lastErrorMessage()
 			<< endl;
 		addSyncLogEntry(i18n("Could not load conduit %1.").arg(fDesktopName));
 		emit syncDone(this);
 		return true;
 	}
 
+	unsigned long version = PluginUtility::pluginVersion(library);
+	if ( Pilot::PLUGIN_API != version )
+	{
+		kdWarning() << k_funcinfo
+			<< ": Library "
+			<< fLibraryName
+			<< " has version "
+			<< version
+			<< endl;
+		addSyncLogEntry(i18n("Conduit %1 has wrong version (%2).").arg(fDesktopName).arg(version));
+		emit syncDone(this);
+		return true;
+	}
+
+	KLibFactory *factory = library->factory();
+	if (!factory)
+	{
+		kdWarning() << k_funcinfo
+			<< ": Can't find factory in library "
+			<< fLibraryName
+			<< endl;
+		addSyncLogEntry(i18n("Could not initialize conduit %1.").arg(fDesktopName));
+		emit syncDone(this);
+		return true;
+	}
+
 	QStringList l = syncMode().list();
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname << ": Flags: " << syncMode().name() << endl;
+	DEBUGKPILOT << fname << ": Flags: " << syncMode().name() << endl;
 #endif
 
 	QObject *object = factory->create(fHandle,name(),"SyncAction",l);
@@ -254,7 +277,7 @@
 }
 
 
-ActionQueue::ActionQueue(KPilotDeviceLink *d) :
+ActionQueue::ActionQueue(KPilotLink *d) :
 	SyncAction(d,"ActionQueue"),
 	fReady(false)
 	// The string lists have default constructors
@@ -268,13 +291,13 @@
 }
 
 
-void ActionQueue::queueInit(bool checkUser)
+void ActionQueue::queueInit( ActionQueue::InitFlags checkUser)
 {
 	FUNCTIONSETUP;
 
 	addAction(new WelcomeAction(fHandle));
 
-	if (checkUser)
+	if ( ActionQueue::queueCheckUser == checkUser)
 	{
 		addAction(new CheckUser(fHandle));
 	}
@@ -294,14 +317,14 @@
 		if ((*it).startsWith(CSL1("internal_")))
 		{
 #ifdef DEBUG
-			DEBUGDAEMON << fname <<
+			DEBUGKPILOT << fname <<
 				": Ignoring conduit " << *it << endl;
 #endif
 			continue;
 		}
 
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Creating proxy with mode=" << m.name() << endl;
 #endif
 		ConduitProxy *cp = new ConduitProxy(fHandle,*it,m);
@@ -332,7 +355,7 @@
 	if (b)
 	{
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Completed action "
 			<< b->name()
 			<< endl;
@@ -369,7 +392,7 @@
 	}
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": Will run action "
 		<< a->name()
 		<< endl;
Index: kpilot/kpilot/kpilotConfigDialog.cc
===================================================================
--- kpilot/kpilot/kpilotConfigDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotConfigDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,9 +30,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *kpilotconfigdialog_id =
-	"$Id$";
-
 #include "options.h"
 
 #include <pi-version.h>
@@ -103,8 +100,6 @@
 #undef CM
 
 	fConduitName = i18n("Device");
-
-	(void) kpilotconfigdialog_id;
 }
 
 void DeviceConfigPage::load()
@@ -242,7 +237,7 @@
 
 #define CM(a,b) connect(fConfigWidget->a,b,this,SLOT(modified()));
 	CM(fSpecialSync, SIGNAL(activated(int)));
-	CM(fFullBackupCheck, SIGNAL(toggled(bool)));
+	CM(fFullSyncCheck, SIGNAL(toggled(bool)));
 	CM(fScreenlockSecure, SIGNAL(toggled(bool)));
 	CM(fConflictResolution, SIGNAL(activated(int)));
 #undef CM
@@ -250,10 +245,9 @@
 	fConduitName = i18n("HotSync");
 }
 
-#define MENU_ITEM_COUNT (5)
+#define MENU_ITEM_COUNT (4)
 static SyncAction::SyncMode::Mode syncTypeMap[MENU_ITEM_COUNT] = {
 	SyncAction::SyncMode::eHotSync,
-	SyncAction::SyncMode::eFastSync,
 	SyncAction::SyncMode::eFullSync,
 	SyncAction::SyncMode::eCopyPCToHH,
 	SyncAction::SyncMode::eCopyHHToPC
@@ -281,7 +275,7 @@
 		fConfigWidget->fSpecialSync->setCurrentItem(0); /* HotSync */
 	}
 
-	fConfigWidget->fFullBackupCheck->setChecked(KPilotSettings::fullSyncOnPCChange());
+	fConfigWidget->fFullSyncCheck->setChecked(KPilotSettings::fullSyncOnPCChange());
 	fConfigWidget->fConflictResolution->setCurrentItem(KPilotSettings::conflictResolution());
 	fConfigWidget->fScreenlockSecure->setChecked(KPilotSettings::screenlockSecure());
 
@@ -305,7 +299,7 @@
 	}
 
 	KPilotSettings::setSyncType(synctype);
-	KPilotSettings::setFullSyncOnPCChange(fConfigWidget->fFullBackupCheck->isChecked());
+	KPilotSettings::setFullSyncOnPCChange(fConfigWidget->fFullSyncCheck->isChecked());
 	KPilotSettings::setConflictResolution(fConfigWidget->fConflictResolution->currentItem());
 	KPilotSettings::setScreenlockSecure(fConfigWidget->fScreenlockSecure->isChecked());
 
@@ -315,7 +309,6 @@
 }
 
 
-
 BackupConfigPage::BackupConfigPage(QWidget * w, const char *n ) : ConfigPage( w, n )
 {
 	FUNCTIONSETUP;
@@ -332,6 +325,7 @@
 #define CM(a,b) connect(fConfigWidget->a,b,this,SLOT(modified()));
 	CM(fBackupOnly, SIGNAL(textChanged(const QString &)));
 	CM(fSkipDB, SIGNAL(textChanged(const QString &)));
+	CM(fBackupFrequency, SIGNAL(activated(int)));
 #undef CM
 
 	fConduitName = i18n("Backup");
@@ -346,6 +340,11 @@
 	fConfigWidget->fBackupOnly->setText(KPilotSettings::skipBackupDB().join(CSL1(",")));
 	fConfigWidget->fSkipDB->setText(KPilotSettings::skipRestoreDB().join(CSL1(",")));
 	fConfigWidget->fRunConduitsWithBackup->setChecked(KPilotSettings::runConduitsWithBackup());
+
+	int backupfreq=KPilotSettings::backupFrequency();
+
+	fConfigWidget->fBackupFrequency->setCurrentItem(backupfreq);
+
 	unmodified();
 }
 
@@ -359,6 +358,7 @@
 	KPilotSettings::setSkipRestoreDB(
 		QStringList::split(CSL1(","),fConfigWidget->fSkipDB->text()));
 	KPilotSettings::setRunConduitsWithBackup(fConfigWidget->fRunConduitsWithBackup->isChecked());
+	KPilotSettings::setBackupFrequency(fConfigWidget->fBackupFrequency->currentItem());
 
 	KPilotConfig::updateConfigVersion();
 	KPilotSettings::self()->writeConfig();
@@ -500,9 +500,9 @@
 	}
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname << ": Autostart=" << autostart << endl;
-	DEBUGDAEMON << fname << ": desktop=" << desktopfile << endl;
-	DEBUGDAEMON << fname << ": location=" << location << endl;
+	DEBUGKPILOT << fname << ": Autostart=" << autostart << endl;
+	DEBUGKPILOT << fname << ": desktop=" << desktopfile << endl;
+	DEBUGKPILOT << fname << ": location=" << location << endl;
 #endif
 
 	KPilotSettings::setStartDaemonAtLogin(fConfigWidget->fStartDaemonAtLogin->isChecked());
Index: kpilot/kpilot/kpilotProbeDialog.cc
===================================================================
--- kpilot/kpilot/kpilotProbeDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotProbeDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -48,12 +48,10 @@
 #include "pilotUser.h"
 #include "pilotSysInfo.h"
 #include "options.h"
-#include "kpilotlink.h"
+#include "kpilotdevicelink.h"
 
 #include "kpilotProbeDialog.moc"
-#ifndef __PILOTDAEMONDCOP_STUB__
 #include "pilotDaemonDCOP_stub.h"
-#endif
 
 /*
 We can't connect to /dev/ttyUSB0 and /dev/ttyUSB1 at the same time, because that
@@ -277,10 +275,10 @@
 
 	mActiveLink = lnk;
 	if ( !mActiveLink ) return;
-	KPilotUser*usr( mActiveLink->getPilotUser() );
+	const KPilotUser &usr( mActiveLink->getPilotUser() );
 
-	mUserName = usr->getUserName();
-	mUID = usr->getUserID();
+	mUserName = usr.getUserName();
+	mUID = usr.getUserID();
 	mDevice = mActiveLink->pilotPath();
 
 	fStatus->setText( i18n("Found a connected device on %1").arg(mDevice) );
@@ -296,23 +294,20 @@
 
 void ProbeDialog::retrieveDBList()
 {
-	QPtrList<DBInfo> dbs = mActiveLink->getDBList();
+	DBInfoList dbs = mActiveLink->getDBList();
 	mDBs.clear();
-	dbs.setAutoDelete( true );
 	char buff[7];
 	buff[0] = '[';
 
-	DBInfo *dbi;
-	for ( dbi = dbs.first(); dbi; dbi = dbs.next() ) {
-		if ( dbi ) {
-			set_long( &buff[1], dbi->creator );
-			buff[5] = ']';
-			buff[6] = '\0';
-			QString cr( buff );
-			mDBs << cr;
-			dbi->name[33]='\0';
-			mDBs << QString( dbi->name );
-		}
+	for ( DBInfoList::ConstIterator i = dbs.begin();
+		i != dbs.end(); ++i )
+	{
+		set_long( &buff[1], (*i).creator );
+		buff[5] = ']';
+		buff[6] = '\0';
+		QString cr( buff );
+		mDBs << cr;
+		mDBs << QString( (*i).name );
 	}
 	mDBs.sort();
 	
Index: kpilot/kpilot/fileInstallWidget.cc
===================================================================
--- kpilot/kpilot/fileInstallWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/fileInstallWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,8 +28,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *fileinstallwidget_id =
-	"$Id$";
 
 #ifndef _KPILOT_OPTIONS_H
 #include "options.h"
@@ -109,7 +107,6 @@
 	connect(fInstaller, SIGNAL(filesChanged()),
 		this, SLOT(refreshFileInstallList()));
 
-	(void) fileinstallwidget_id;
 }
 
 FileInstallWidget::~FileInstallWidget()
Index: kpilot/kpilot/pilotDaemon.cc
===================================================================
--- kpilot/kpilot/pilotDaemon.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/pilotDaemon.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,8 +28,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *pilotdaemon_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -54,11 +52,13 @@
 #include <kapplication.h>
 #include <khelpmenu.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 
 #include "fileInstaller.h"
 #include "pilotUser.h"
 #include "pilotDatabase.h"
+#include "kpilotlink.h"
+#include "kpilotdevicelink.h"
 
 #include "hotSync.h"
 #include "interactiveSync.h"
@@ -87,10 +87,6 @@
 	FUNCTIONSETUP;
 	setupWidget();
 	setAcceptDrops(true);
-
-
-	/* NOTREACHED */
-	(void) pilotdaemon_id;
 }
 
 /* virtual */ void PilotDaemonTray::dragEnterEvent(QDragEnterEvent * e)
@@ -149,7 +145,7 @@
 	FUNCTIONSETUP;
 
 	KGlobal::iconLoader()->addAppDir( CSL1("kpilot") );
-	icons[Normal] = loadIcon( CSL1("kpilot") );
+	icons[Normal] = loadIcon( CSL1("kpilotDaemon") );
 	icons[Busy] = loadIcon( CSL1("busysync") );
 	icons[NotListening] = loadIcon( CSL1("nosync") );
 
@@ -176,7 +172,6 @@
 
         // Keep this synchronized with kpilotui.rc and kpilot.cc if at all possible.
 	MI(eHotSync);
-	MI(eFastSync);
 	MI(eFullSync);
 	MI(eBackup);
 	MI(eRestore);
@@ -197,7 +192,7 @@
 
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname << ": Finished getting icons" << endl;
+	DEBUGKPILOT << fname << ": Finished getting icons" << endl;
 #endif
 }
 
@@ -318,7 +313,7 @@
 	fNextSyncType.setMode( KPilotSettings::syncType() );
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": The daemon is ready with status "
 		<< statusString() << " (" << (int) fDaemonStatus << ")" << endl;
 #endif
@@ -332,7 +327,7 @@
 	KPILOT_DELETE(fSyncStack);
 	KPILOT_DELETE(fInstaller);
 
-	(void) PilotDatabase::count();
+	(void) PilotDatabase::instanceCount();
 }
 
 void PilotDaemon::addInstallFiles(const QStringList &l)
@@ -377,7 +372,7 @@
 	}
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": Speed set to "
 		<< speedname << " (" << speed << ")" << endl;
 #endif
@@ -395,7 +390,7 @@
 	if (!fTray)
 	{
 #ifdef DEBUG
-		DEBUGDAEMON << fname << ": No tray icon to display!" << endl;
+		DEBUGKPILOT << fname << ": No tray icon to display!" << endl;
 #endif
 
 		return;
@@ -407,7 +402,7 @@
 	fTray->show();
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname << ": Tray icon displayed." << endl;
+	DEBUGKPILOT << fname << ": Tray icon displayed." << endl;
 #endif
 
 	updateTrayStatus();
@@ -450,14 +445,14 @@
 	KPilotSettings::self()->readConfig();
 	getPilotSpeed();
 
-	(void) PilotAppCategory::setupPilotCodec(KPilotSettings::encoding());
+	(void) Pilot::setupPilotCodec(KPilotSettings::encoding());
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": Got configuration "
 		<< KPilotSettings::pilotDevice()
 		<< endl;
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": Got conduit list "
 		<< (KPilotSettings::installedConduits().join(CSL1(",")))
 		<< endl;
@@ -469,7 +464,7 @@
 	if (fPilotLink)
 	{
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Resetting with device "
 			<< KPilotSettings::pilotDevice()
 			<< endl;
@@ -477,7 +472,7 @@
 
 		fPilotLink->reset( KPilotSettings::pilotDevice() );
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Using workarounds "
 			<< KPilotSettings::workarounds()
 			<< endl;
@@ -485,7 +480,7 @@
 		if ( KPilotSettings::workarounds() == KPilotSettings::eWorkaroundUSB )
 		{
 #ifdef DEBUG
-			DEBUGDAEMON << fname
+			DEBUGKPILOT << fname
 				<< ": Using Zire31 USB workaround." << endl;
 #endif
 			fPilotLink->setWorkarounds(true);
@@ -604,8 +599,8 @@
 		return false;
 	}
 
-	QObject::connect(fPilotLink, SIGNAL(deviceReady(KPilotDeviceLink*)),
-		this, SLOT(startHotSync(KPilotDeviceLink*)));
+	QObject::connect(fPilotLink, SIGNAL(deviceReady(KPilotLink*)),
+		this, SLOT(startHotSync(KPilotLink*)));
 	// connect the signals emitted by the pilotDeviceLink
 	QObject::connect(fPilotLink, SIGNAL(logError(const QString &)),
 		this, SLOT(logError(const QString &)));
@@ -649,12 +644,7 @@
 	requestSync(SyncAction::SyncMode::eHotSync);
 }
 
-/* DCOP ASYNC */ void PilotDaemon::requestFastSyncNext()
-{
-	requestSync(SyncAction::SyncMode::eFastSync);
-}
 
-
 /* DCOP ASYNC */ void PilotDaemon::requestSync(int mode)
 {
 	FUNCTIONSETUP;
@@ -674,7 +664,7 @@
 
 	if (fTray && (fTray->fSyncTypeMenu))
 	{
-		for (int i=((int)SyncAction::SyncMode::eFastSync);
+		for (int i=((int)SyncAction::SyncMode::eHotSync);
 			i<=((int)SyncAction::SyncMode::eRestore) /* Restore */ ;
 			++i)
 		{
@@ -692,7 +682,6 @@
 
 	// This checks unique prefixes of the names of the various sync types.
 	if (s.startsWith(CSL1("H"))) requestSync(SyncAction::SyncMode::eHotSync);
-	else if (s.startsWith(CSL1("Fa"))) requestSync(SyncAction::SyncMode::eFastSync);
 	else if (s.startsWith(CSL1("Fu"))) requestSync(SyncAction::SyncMode::eFullSync);
 	else if (s.startsWith(CSL1("B"))) requestSync(SyncAction::SyncMode::eBackup);
 	else if (s.startsWith(CSL1("R"))) requestSync(SyncAction::SyncMode::eRestore);
@@ -869,7 +858,7 @@
 }
 
 static bool isSyncPossible(ActionQueue *fSyncStack,
-	KPilotDeviceLink *pilotLink,
+	KPilotLink *pilotLink,
 	KPilotDCOP_stub &kpilot)
 {
 	FUNCTIONSETUP;
@@ -886,12 +875,12 @@
 #ifdef DEBUG
 	if (callstatus != DCOPStub::CallSucceeded)
 	{
-		DEBUGDAEMON << fname <<
+		DEBUGKPILOT << fname <<
 			": Could not call KPilot for status." << endl;
 	}
 	else
 	{
-		DEBUGDAEMON << fname << ": KPilot status " << kpilotstatus << endl;
+		DEBUGKPILOT << fname << ": KPilot status " << kpilotstatus << endl;
 	}
 #endif
 	/**
@@ -942,7 +931,7 @@
 	}
 }
 
-static void queueEditors(ActionQueue *fSyncStack, KPilotDeviceLink *pilotLink)
+static void queueEditors(ActionQueue *fSyncStack, KPilotLink *pilotLink)
 {
 	if (KPilotSettings::internalEditors())
 	{
@@ -963,21 +952,60 @@
 	}
 }
 
-/* slot */ void PilotDaemon::startHotSync(KPilotDeviceLink *pilotLink)
+bool PilotDaemon::shouldBackup()
 {
+
 	FUNCTIONSETUP;
 
+	bool ret = false;
+	int backupfreq = KPilotSettings::backupFrequency();
+
+#ifdef DEBUG
+	DEBUGKPILOT << fname << ": Backup Frequency is: [" << backupfreq <<
+	"]. " << endl;
+#endif
+
+	if ( (fNextSyncType == SyncAction::SyncMode::eHotSync) ||
+		(fNextSyncType == SyncAction::SyncMode::eFullSync) )
+	{
+		/** If we're doing a Hot or Full sync, see if our user has
+		 * configured us to or to not always do a backup.
+		 */
+		if ( backupfreq == SyncAction::eOnRequestOnly )
+		{
+#ifdef DEBUG
+	DEBUGKPILOT << fname << ": Should not do backup..." << endl;
+#endif
+			ret = false;
+		}
+		else if ( backupfreq == SyncAction::eEveryHotSync )
+		{
+#ifdef DEBUG
+	DEBUGKPILOT << fname << ": Should do backup..." << endl;
+#endif
+			ret = true;
+		}
+	}
+
+	return ret;
+
+}
+
+
+/* slot */ void PilotDaemon::startHotSync(KPilotLink *pilotLink)
+{
+	FUNCTIONSETUP;
+
 	bool pcchanged=false; // If last PC to sync was a different one (implies full sync, normally)
 	QStringList conduits ; // list of conduits to run
 	QString s; // a generic string for stuff
-	KPilotUser *usr = 0L; // Pointer to user data on Pilot
 
 #ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGKPILOT << fname
 		<< ": Starting Sync with type "
 		<< fNextSyncType.name() << endl;
-	DEBUGDAEMON << fname << ": Status is " << shortStatusString() << endl;
-	(void) PilotDatabase::count();
+	DEBUGKPILOT << fname << ": Status is " << shortStatusString() << endl;
+	(void) PilotDatabase::instanceCount();
 #endif
 
 	fDaemonStatus = HOTSYNC_START ;
@@ -1003,19 +1031,35 @@
 	// want to sync with a blank palm and then back up the result over her stored backup files,
 	// do a Full Sync when changing the PC or using a different Palm Desktop app.
 	if (fNextSyncType.mode() != SyncAction::SyncMode::eRestore)
-	{
-		// Use gethostid to determine , since JPilot uses 1+(2000000000.0*random()/(RAND_MAX+1.0))
+	{ // Use gethostid to determine , since JPilot uses 1+(2000000000.0*random()/(RAND_MAX+1.0))
 		// as PC_ID, so using JPilot and KPilot is the same as using two different PCs
-		usr = pilotLink->getPilotUser();
-		pcchanged = usr->getLastSyncPC() !=(unsigned long) gethostid();
-		if (pcchanged && KPilotSettings::fullSyncOnPCChange() )
+		KPilotUser &usr = pilotLink->getPilotUser();
+		pcchanged = usr.getLastSyncPC() !=(unsigned long) gethostid();
+
+		if (pcchanged)
 		{
-			fNextSyncType = SyncAction::SyncMode::eFullSync;
+#ifdef DEBUG
+			DEBUGKPILOT << fname << ": PC changed. Last sync PC: [" << usr.getLastSyncPC()
+				<< "], me: [" << (unsigned long) gethostid() << "]" << endl;
+#endif
+ 			if ( KPilotSettings::fullSyncOnPCChange() )
+			{
+#ifdef DEBUG
+				DEBUGKPILOT << fname << ": Setting sync mode to full sync. " << endl;
+#endif
+				fNextSyncType = SyncAction::SyncMode::eFullSync;
+			}
+			else
+			{
+#ifdef DEBUG
+				DEBUGKPILOT << fname << ": Not changing sync mode because of settings. " << endl;
+#endif
+			}
 		}
 	}
 
 	// Normal case: regular sync.
-	fSyncStack->queueInit(true);
+	fSyncStack->queueInit( ActionQueue::queueCheckUser );
 
 	conduits = KPilotSettings::installedConduits() ;
 
@@ -1039,7 +1083,6 @@
 			queueInstaller(fSyncStack,fInstaller,conduits);
 			break;
 		case SyncAction::SyncMode::eFullSync:
-		case SyncAction::SyncMode::eFastSync:
 		case SyncAction::SyncMode::eHotSync:
 			// first install the files, and only then do the conduits
 			// (conduits might want to sync a database that will be installed
@@ -1049,8 +1092,7 @@
 			// After running the conduits, install new databases
 			queueInstaller(fSyncStack,fInstaller,conduits);
 			// And sync the remaining databases if needed.
-			if ( (fNextSyncType == SyncAction::SyncMode::eHotSync) ||
-				(fNextSyncType == SyncAction::SyncMode::eFullSync))
+			if (shouldBackup())
 			{
 				fSyncStack->addAction(new BackupAction(pilotLink, (fNextSyncType == SyncAction::SyncMode::eFullSync)));
 			}
@@ -1145,13 +1187,13 @@
 	}
 	else
 	{
-		QTimer::singleShot(5000,fPilotLink,SLOT(reset()));
+		QTimer::singleShot(10000,fPilotLink,SLOT(reset()));
 	}
 
 	fPostSyncAction = None;
 	requestSync(0);
 
-	(void) PilotDatabase::count();
+	(void) PilotDatabase::instanceCount();
 
 	updateTrayStatus();
 }
@@ -1184,7 +1226,7 @@
 	else
 	{
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Started KPilot with DCOP name "
 			<< kpilotDCOP << " (pid " << kpilotPID << ")" << endl;
 #endif
@@ -1285,7 +1327,7 @@
 		"pilone@slac.com");
 	about.addAuthor("Adriaan de Groot",
 		I18N_NOOP("Maintainer"),
-		"groot@kde.org", "http://www.cs.kun.nl/~adridg/");
+		"groot@kde.org", "http://www.kpilot.org/");
 	about.addAuthor("Reinhold Kainhofer",
 		I18N_NOOP("Developer"),
 		"reinhold@kainhofer.com", "http://reinhold.kainhofer.com/Linux/");
@@ -1338,7 +1380,7 @@
 		}
 
 #ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Configuration version "
 			<< KPilotSettings::configVersion() << endl;
 #endif
@@ -1365,9 +1407,6 @@
 	gPilotDaemon->showTray();
 
 	return a.exec();
-
-	/* NOTREACHED */
-	(void) pilotdaemon_id;
 }
 
 
Index: kpilot/kpilot/dbSelection_base.ui
===================================================================
--- kpilot/kpilot/dbSelection_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/dbSelection_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -71,10 +71,10 @@
     </connection>
 </connections>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>klistview.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-    <includehint>klineedit.h</includehint>
-    <includehint>kpushbutton.h</includehint>
-</includehints>
+<includes>
+	<include location="system" impldecl="in implementation">klistview.h</include>
+	<include location="system" impldecl="in implementation">kpushbutton.h</include>
+	<include location="system" impldecl="in implementation">klineedit.h</include>
+	<include location="system" impldecl="in implementation">kpushbutton.h</include>
+</includes>
 </UI>
Index: kpilot/kpilot/pilotDaemon.h
===================================================================
--- kpilot/kpilot/pilotDaemon.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/pilotDaemon.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -48,6 +48,9 @@
 class KPilotDCOP_stub;
 class LogFile;
 
+class KPilotLink;
+class KPilotDeviceLink;
+
 class PilotDaemonTray : public KSystemTray
 {
 	Q_OBJECT
@@ -163,7 +166,6 @@
 	virtual ASYNC requestSync(int);
 public:
 	virtual ASYNC requestSyncType(QString);
-	virtual ASYNC requestFastSyncNext();
 	virtual ASYNC requestRegularSyncNext();
 	virtual int nextSyncType() const;
 	virtual ASYNC requestSyncOptions(bool,bool);
@@ -196,7 +198,7 @@
 	int fPostSyncAction;
 
 protected slots:
-	void startHotSync( KPilotDeviceLink* lnk );
+	void startHotSync( KPilotLink* lnk );
 	void endHotSync();
 
 	void logMessage(const QString &);
@@ -206,6 +208,14 @@
 private:
 	int getPilotSpeed();
 
+	/**
+	* Check whether we should do a backup.  This is based on the
+	* KPilotSettings::backupFrequency and uses
+	* SyncAction::BackupFrequency.  This will be expanded, hopefully,
+	* to provide backup scheduling at some point.
+	*/
+	bool shouldBackup();
+
 	bool setupPilotLink();
 
 	KPilotDeviceLink &getPilotLink() { return *fPilotLink; }
Index: kpilot/kpilot/kpilotui.rc
===================================================================
--- kpilot/kpilot/kpilotui.rc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,6 @@
   <Menu name="file" noMerge="1"><text>&amp;File</text>
     <!-- Keep this list synchronized with pilotDaemon.cc and kpilot.cc -->
     <Action name="file_hotsync" />
-    <Action name="file_fastsync" />
     <Action name="file_fullsync" />
     <Action name="file_backup" />
     <Action name="file_restore" />
@@ -28,7 +27,6 @@
 
 <Menu name="rb_popup">
   <Action name="file_hotsync" />
-  <Action name="file_fastsync" />
   <Action name="file_backup" />
   <Action name="file_restore" />
   <Separator />
Index: kpilot/kpilot/internalEditorAction.h
===================================================================
--- kpilot/kpilot/internalEditorAction.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/internalEditorAction.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -38,7 +38,7 @@
 Q_OBJECT
 
 public:
-	InternalEditorAction(KPilotDeviceLink *);
+	InternalEditorAction(KPilotLink *);
 	~InternalEditorAction() {}
 
 protected:
Index: kpilot/kpilot/Icons/CMakeLists.txt
===================================================================
--- kpilot/kpilot/Icons/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/kpilot/Icons/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,4 @@
+
+kde3_install_icons_custom( hicolor )
+
+install( FILES kpilot-splash.png DESTINATION ${CMAKE_INSTALL_PREFIX}/share/apps/kpilot/pics/)
Index: kpilot/kpilot/main-test.cc
===================================================================
--- kpilot/kpilot/main-test.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/main-test.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,8 +29,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org.
 */
-static const char *test_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -52,29 +50,43 @@
 
 #include <pi-version.h>
 
-#include "logWidget.h"
 #include "kpilotConfig.h"
 #include "syncStack.h"
 #include "hotSync.h"
 #include "interactiveSync.h"
 
-static KCmdLineOptions kpilotoptions[] = {
+#include "kpilotdevicelink.h"
+#include "kpilotlocallink.h"
+
+static KCmdLineOptions generalOptions[] = {
 	{"p",0,0},
 	{"port <device>",
 		I18N_NOOP("Path to Pilot device node"),
 		"/dev/pilot"},
 	{"l",0,0},
-	{"list", I18N_NOOP("List DBs (default)"), 0},
+	{"list", I18N_NOOP("List DBs"), 0},
 	{"b",0,0},
-	{"backup", I18N_NOOP("Backup instead of list DBs"), 0},
+	{"backup <dest dir>", I18N_NOOP("Backup Pilot to <dest dir>"), 0},
 	{"r",0,0},
-	{"restore", I18N_NOOP("Restore Pilot from backup"), 0},
-	{"L",0,0},
-	{ "conduit-list", I18N_NOOP("List available conduits"), 0},
-	{"E",0,0},
-	{ "conduit-exec <filename>",
+	{"restore <src dir>", I18N_NOOP("Restore Pilot from backup"), 0},
+	{"e",0,0},
+	{ "exec <filename>",
 		I18N_NOOP("Run conduit from desktop file <filename>"),
 		0 },
+	{"c",0,0},
+	{ "check <what>",
+		I18N_NOOP("Run a specific check (with the device)"), "help"},
+	{"s",0,0},
+	{ "show <what>",
+		I18N_NOOP("Show KPilot configuration information"), "help"},
+#ifdef DEBUG
+	{ "debug <level>",
+		I18N_NOOP("Set the debug level"), "1" },
+#endif
+	KCmdLineLastOption
+} ;
+
+static KCmdLineOptions conduitOptions[] = {
 	{ "T",0,0},
 	{ "notest",
 		I18N_NOOP("*Really* run the conduit, not in test mode."),
@@ -89,217 +101,156 @@
 	{ "PCtoHH",
 		I18N_NOOP("Copy Desktop to Pilot."),
 		0 } ,
-	{ "test-timeout",
-		I18N_NOOP("Run conduit specially designed to timeout."),
+	{ "loop",
+		I18N_NOOP("Repeated perform action - only useful for --list"),
 		0 } ,
-	{ "test-usercheck",
-		I18N_NOOP("Run conduit just for user check."),
-		0 } ,
-	{ "dump-calendar",
-		I18N_NOOP("Dump calendar to stdout."),
-		0 } ,
-#ifdef DEBUG
-	{"debug <level>", I18N_NOOP("Set debugging level"), "0"},
-#endif
 	KCmdLineLastOption
-};
+} ;
 
-
-static LogWidget *logWidget = 0L;
-static QPushButton *resetButton = 0L;
-
-
-
 /**
 *** Conduits - sync actions - for testing specific scenarios.
 **/
 
-class TimeoutAction : public SyncAction
-{
-public:
-	TimeoutAction(KPilotDeviceLink *p) ;
-protected:
-	virtual bool exec();
-} ;
 
-TimeoutAction::TimeoutAction(KPilotDeviceLink *p) :
-	SyncAction(p)
+
+KPilotLink *createLink( bool local )
 {
 	FUNCTIONSETUP;
+	if (!local)
+	{
+		return new KPilotDeviceLink(0, "deviceLink");
+	}
+	else
+	{
+		return new KPilotLocalLink(0, "localLink");
+	}
 }
 
-bool TimeoutAction::exec()
+/** If @p loop is true, then instead of quitting at end of
+*   sync, wait for a new sync just like the real daemon does.
+*/
+void connectStack( KPilotLink *l, ActionQueue *a, bool loop = false )
 {
 	FUNCTIONSETUP;
 
-	for (int i = 0; i<3; i++)
+	if (l && a)
 	{
-		logMessage( CSL1("Hup two %1").arg(i) );
-		fHandle->tickle();
-		qApp->processEvents();
-		sleep(1);
+		QObject::connect(a, SIGNAL(syncDone(SyncAction *)),
+			l, SLOT(close()));
+		if (!loop)
+		{
+			QObject::connect(a, SIGNAL(syncDone(SyncAction *)),
+				kapp, SLOT(quit()));
+		}
+		else
+		{
+			QObject::connect(a, SIGNAL(syncDone(SyncAction *)),
+				l, SLOT(reset()));
+		}
+		QObject::connect(l, SIGNAL(deviceReady(KPilotLink*)),
+			a, SLOT(execConduit()));
 	}
-
-	logMessage( CSL1("Now sleeping 65") );
-	qApp->processEvents();
-	sleep(65);
-	return delayDone();
 }
 
 
 
-
-
-
-
-void createLogWidget()
+int exec(const QString &device, const QString &what, KCmdLineArgs *p)
 {
-	LogWidget *w = new LogWidget(0L);
-
-	w->resize(300, 300);
-	w->show();
-	w->setShowTime(true);
-	kapp->setMainWidget(w);
-	logWidget = w;
-
-	resetButton = new QPushButton(i18n("Reset"),w->buttonBox());
-}
-
-static KPilotDeviceLink *deviceLink = 0L;
-
-void createLink()
-{
 	FUNCTIONSETUP;
 
-	deviceLink = new KPilotDeviceLink(0, "deviceLink");
+	// get --exec-conduit value
+	if (what.isEmpty()) return 1;
+	QStringList l;
+	l.append(what);
 
-	QObject::connect(deviceLink, SIGNAL(logError(const QString &)),
-		logWidget, SLOT(addError(const QString &)));
-	QObject::connect(deviceLink, SIGNAL(logMessage(const QString &)),
-		logWidget, SLOT(addMessage(const QString &)));
-	QObject::connect(deviceLink,SIGNAL(logProgress(const QString &,int)),
-		logWidget, SLOT(addProgress(const QString &,int)));
+	SyncAction::SyncMode::Mode syncMode = SyncAction::SyncMode::eHotSync;
+	if (p->isSet("HHtoPC")) syncMode = SyncAction::SyncMode::eCopyHHToPC;
+	if (p->isSet("PCtoHH")) syncMode = SyncAction::SyncMode::eCopyPCToHH;
+	SyncAction::SyncMode mode(syncMode,p->isSet("test"),p->isSet("local"));
 
+	KPilotLink *link = createLink( p->isSet("local") );
+	ActionQueue *syncStack = new ActionQueue( link );
+	syncStack->queueInit( ActionQueue::queueCheckUser );
+	syncStack->queueConduits(l,mode,false);
+	syncStack->queueCleanup();
+	connectStack(link,syncStack);
+	link->reset(device);
+	return kapp->exec();
 }
 
-static ActionQueue *syncStack = 0L;
-
-void connectStack()
+int backup(const QString &device, const QString &what, KCmdLineArgs *p)
 {
 	FUNCTIONSETUP;
-
-	QObject::connect(syncStack, SIGNAL(logError(const QString &)),
-		logWidget, SLOT(addError(const QString &)));
-	QObject::connect(syncStack, SIGNAL(logMessage(const QString &)),
-		logWidget, SLOT(addMessage(const QString &)));
-	QObject::connect(syncStack,SIGNAL(logProgress(const QString &,int)),
-		logWidget, SLOT(addProgress(const QString &,int)));
-	QObject::connect(syncStack, SIGNAL(syncDone(SyncAction *)),
-		logWidget, SLOT(syncDone()));
-
-	if (deviceLink)
-	{
-		QObject::connect(syncStack, SIGNAL(syncDone(SyncAction *)),
-			deviceLink, SLOT(close()));
-		QObject::connect(deviceLink, SIGNAL(deviceReady(KPilotDeviceLink*)), syncStack, SLOT(execConduit()));
-		QObject::connect(resetButton,SIGNAL(clicked()),deviceLink,SLOT(reset()));
-	}
+	KPilotLink *link = createLink( p->isSet("local") );
+	ActionQueue *syncStack = new ActionQueue( link );
+	syncStack->queueInit();
+	BackupAction *ba = new BackupAction( link, true /* full backup */ );
+	ba->setDirectory( what );
+	syncStack->addAction( ba );
+	syncStack->queueCleanup();
+	connectStack(link,syncStack);
+	link->reset(device);
+	return kapp->exec();
 }
 
-void createConnection(KCmdLineArgs *p)
+int restore(const QString &device, const QString &what, KCmdLineArgs *p)
 {
 	FUNCTIONSETUP;
-
-	QString devicePath = p->getOption("port");
-
-	if (devicePath.isEmpty())
-	{
-		devicePath = "/dev/pilot";
-	}
-
-	deviceLink->reset(devicePath);
+	KPilotLink *link = createLink( p->isSet("local") );
+	ActionQueue *syncStack = new ActionQueue( link );
+	syncStack->queueInit();
+	RestoreAction *ra = new RestoreAction( link );
+	ra->setDirectory( what );
+	syncStack->addAction( ra );
+	syncStack->queueCleanup();
+	connectStack(link,syncStack);
+	link->reset(device);
+	return kapp->exec();
 }
 
-int syncTest(KCmdLineArgs *p)
+int listDB(const QString &device, KCmdLineArgs *p)
 {
 	FUNCTIONSETUP;
-
-	createLogWidget();
-	createLink();
-
-	syncStack = new ActionQueue(deviceLink);
-
-	if (p->isSet("backup"))
-	{
-		syncStack->queueInit();
-		syncStack->addAction(new BackupAction(deviceLink,true));
-	}
-	else if (p->isSet("restore"))
-	{
-		syncStack->queueInit(0);
-		syncStack->addAction(new RestoreAction(deviceLink));
-	}
-	else if (p->isSet("test-timeout"))
-	{
-		syncStack->queueInit();
-		syncStack->addAction( new TimeoutAction(deviceLink) );
-		syncStack->addAction( new TimeoutAction(deviceLink) );
-	}
-	else
-	{
-		syncStack->queueInit(p->isSet("test-usercheck") /* whether to run usercheck */);
-		syncStack->addAction(new TestLink(deviceLink));
-	}
+	KPilotLink *link = createLink( p->isSet("local") );
+	ActionQueue *syncStack = new ActionQueue( link );
+	syncStack->queueInit();
+	syncStack->addAction( new TestLink( link ) );
 	syncStack->queueCleanup();
-
-	connectStack();
-	createConnection(p);
+	connectStack(link,syncStack, p->isSet("loop") );
+	link->reset(device);
 	return kapp->exec();
 }
 
-int execConduit(KCmdLineArgs *p)
+int check( const QString &device, const QString &what, KCmdLineArgs *p )
 {
 	FUNCTIONSETUP;
 
-	// get --exec-conduit value
-	QString s = p->getOption("conduit-exec");
-	if (s.isEmpty()) return 1;
-	QStringList l;
-	l.append(s);
-
-	createLogWidget();
-
-	SyncAction::SyncMode::Mode syncMode = SyncAction::SyncMode::eHotSync;
-	if (p->isSet("HHtoPC")) syncMode = SyncAction::SyncMode::eCopyHHToPC;
-	if (p->isSet("PCtoHH")) syncMode = SyncAction::SyncMode::eCopyPCToHH;
-	SyncAction::SyncMode mode(syncMode,p->isSet("test"),p->isSet("local"));
-
-	if (!p->isSet("local"))
+	if ( "help" == what )
 	{
-		createLink();
+		std::cout <<
+"You can use the --check option to kpilotTest to run various\n"
+"small checks that require the use of the device. These are:\n"
+"\thelp - show this help\n"
+"\tuser - check the user name on the handheld\n"
+		<< std::endl;
+		return 0;
+	}
 
-		syncStack = new ActionQueue(deviceLink);
-		syncStack->queueInit();
-		syncStack->queueConduits(l,mode,false);
-		syncStack->queueCleanup();
-		connectStack();
-		createConnection(p);
-	}
-	else
+	if ( "user" == what )
 	{
-		syncStack = new ActionQueue( 0L );
-		syncStack->queueInit();
-		syncStack->queueConduits(l,mode,false);
+		KPilotLink *link = createLink( p->isSet("local") );
+		ActionQueue *syncStack = new ActionQueue( link );
+		syncStack->queueInit( ActionQueue::queueCheckUser ); // Creates usercheck
 		syncStack->queueCleanup();
-		connectStack();
-		QTimer::singleShot(100,syncStack,SLOT(execConduit()));
+		connectStack(link,syncStack);
+		link->reset(device);
+		return kapp->exec();
 	}
 
-
-	return kapp->exec();
+	return 0;
 }
 
-int listConduits(KCmdLineArgs *)
+void listConduits()
 {
 	FUNCTIONSETUP;
 
@@ -315,23 +266,78 @@
 	{
 		KSharedPtr < KService > o = (*availList).service();
 
-		std::cout << o->desktopEntryName().latin1() << std::endl;
-		std::cout << "\t" << o->name().latin1()  << std::endl;
+		std::cout << "File:   " << o->desktopEntryName().latin1() << std::endl;
+		std::cout << "  Desc: " << o->name().latin1()  << std::endl;
 		if (!o->library().isEmpty())
 		{
-			std::cout << "\tIn "
+			std::cout << "  Lib : "
 				<< o->library().latin1()
 				<< std::endl;
 		}
 
 		++availList;
 	}
+}
 
-	return 0;
+int show( const QString &what )
+{
+	FUNCTIONSETUP;
+
+	if ( "help" == what )
+	{
+		std::cout <<
+"Displays various bits of KPilot's internal settings. This\n"
+"does not require a device connection or a running KDE desktop.\n"
+"No change to data takes place. The following options are available\n"
+"for display:\n"
+"\thelp     - displays this help\n"
+"\tconduits - displays the list of available conduits\n"
+"\tuser     - displays the user name KPilot expects\n"
+"\tdevice   - displays the device settings in KPilot\n"
+"\tdebug    - displays internal numbers\n"
+		<< std::endl;
+		return 0;
+	}
+
+	if ( "conduits" == what )
+	{
+		listConduits();
+		return 0;
+	}
+
+	if ( "user" == what )
+	{
+		std::cout << "User: " << KPilotSettings::userName().latin1() << std::endl;
+		return 0;
+	}
+
+	if ( "device" == what )
+	{
+		std::cout << "Device:   " << KPilotSettings::pilotDevice().latin1()
+			<< "\nSpeed:    " << KPilotSettings::pilotSpeed()
+			<< "\nEncoding: " << KPilotSettings::encoding().latin1()
+			<< "\nQuirks:   " << KPilotSettings::workarounds()
+			<< std::endl;
+		return 0;
+	}
+
+	if ( "debug" == what )
+	{
+		std::cout << "Debug:  " << KPilotSettings::debug()
+			<< "\nConfig: " << KPilotSettings::configVersion()
+			<< std::endl;
+		return 0;
+	}
+
+	std::cerr << "Unknown --show argument, use --show help for help.\n";
+	return 1;
 }
 
 int main(int argc, char **argv)
 {
+#ifdef DEBUG
+	debug_level = 1;
+#endif
 	FUNCTIONSETUP;
 	KAboutData about("kpilotTest",
 		I18N_NOOP("KPilotTest"),
@@ -340,43 +346,87 @@
 		KAboutData::License_GPL, "(C) 2001-2004, Adriaan de Groot");
 	about.addAuthor("Adriaan de Groot",
 		I18N_NOOP("KPilot Maintainer"),
-		"groot@kde.org", "http://www.cs.kun.nl/~adridg/kpilot/");
+		"groot@kde.org", "http://www.kpilot.org/");
 
 	KCmdLineArgs::init(argc, argv, &about);
-	KCmdLineArgs::addCmdLineOptions(kpilotoptions, "kpilottest");
+	KCmdLineArgs::addCmdLineOptions(generalOptions,
+		I18N_NOOP("General"));
+	KCmdLineArgs::addCmdLineOptions(conduitOptions,
+		I18N_NOOP("Conduit Actions"),"conduit");
+
 	KApplication::addCmdLineOptions();
 
 	KCmdLineArgs *p = KCmdLineArgs::parsedArgs();
 
+	bool needGUI = false;
 
-	KApplication a;
+	// Some versions need a GUI
+	needGUI |= (p->isSet("check"));
+	needGUI |= (p->isSet("exec")); // assume worst wrt. conduits
+	needGUI |= (p->isSet("restore"));
+
+	KApplication a(needGUI,needGUI);
 #ifdef DEBUG
 	KPilotConfig::getDebugLevel(p);
+	DEBUGKPILOT  << fname << "Created KApplication." << endl;
 #endif
 
-	if ( p->isSet("backup") ||
-		p->isSet("restore") ||
-		p->isSet("list") ||
-		p->isSet("test-timeout") ||
-		p->isSet("test-usercheck") )
+
+	QString device( "/dev/pilot" );
+
+	if ( p->isSet("port") )
 	{
-		return syncTest(p);
+		device = p->getOption("port");
 	}
 
-	if (p->isSet("conduit-list"))
+	if ( p->isSet("check") )
 	{
-		return listConduits(p);
+		return check( device, p->getOption("check"),
+			KCmdLineArgs::parsedArgs("conduit") );
 	}
 
-	if (p->isSet("conduit-exec"))
+	if ( p->isSet("show") )
 	{
-		return execConduit(p);
+		return show( p->getOption("show") );
 	}
 
-	// The default is supposed to be "list"
-	return syncTest(p);
-	/* NOTREACHED */
-	(void) test_id;
+	if ( p->isSet("exec") )
+	{
+		return exec( device, p->getOption("exec"),
+			KCmdLineArgs::parsedArgs("conduit") );
+	}
+
+	if ( p->isSet("list") )
+	{
+		return listDB( device,
+			KCmdLineArgs::parsedArgs("conduit") );
+	}
+
+	if ( p->isSet("backup") )
+	{
+		return backup( device, p->getOption("backup"),
+			KCmdLineArgs::parsedArgs("conduit") );
+	}
+
+	if ( p->isSet("restore") )
+	{
+		return restore( device, p->getOption("restore"),
+			KCmdLineArgs::parsedArgs("conduit") );
+	}
+
+
+
+	std::cout <<
+"Usage: kpilotTest [--port devicename] action\n\n"
+"Where action can be one of:\n"
+"\t--list - list the databases on the handheld\n"
+"\t--show (help | conduits | ...) - show configuration\n"
+"\t--check (help | user | ...) - check device\n"
+"\t--exec conduit - run a single conduit\n"
+"\t--backup - backup the device\n"
+"\t--restore - restore the device from backup\n"
+	<< std::endl;
+	return 1;
 }
 
 
Index: kpilot/kpilot/memoWidget.cc
===================================================================
--- kpilot/kpilot/memoWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/memoWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,8 +27,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *memowidget_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -47,7 +45,6 @@
 #include <qtextstream.h>
 #include <qwhatsthis.h>
 #include <qlabel.h>
-#include <qtextcodec.h>
 #include <qdatetime.h>
 #include <qptrlist.h>
 
@@ -91,9 +88,6 @@
 	setupWidget();
 	d->fMemoList.setAutoDelete(true);
 	slotUpdateButtons();
-
-	/* NOTREACHED */
-	(void) memowidget_id;
 }
 
 MemoWidget::~MemoWidget()
@@ -178,7 +172,7 @@
 	//
 	PilotLocalDatabase *memoDB =
 		new PilotLocalDatabase(dbPath(), CSL1("MemoDB"));
-	if (memoDB == NULL || !memoDB->isDBOpen())
+	if (memoDB == NULL || !memoDB->isOpen())
 	{
 		kdWarning() << k_funcinfo <<
 			": Can't open local database MemoDB\n";
@@ -366,7 +360,7 @@
 		DEBUGKPILOT << fname << ": Searching for record to delete (it's fresh)" << endl;
 #endif
 		PilotLocalDatabase *memoDB = new PilotLocalDatabase(dbPath(), CSL1("MemoDB"));
-		if (!memoDB || (!memoDB->isDBOpen()))
+		if (!memoDB || (!memoDB->isOpen()))
 		{
 			// Err.. peculiar.
 			kdWarning() << k_funcinfo << ": Can't open MemoDB" << endl;
@@ -554,8 +548,8 @@
 		(PilotListItem *) fListBox->item(lastSelectedMemo);
 	PilotMemo *currentMemo = (PilotMemo *) p->rec();
 
-	currentMemo->setText(PilotAppCategory::codec()->
-		fromUnicode(fTextWidget->text()));
+// TODO: overload setText in PilotMemo
+	currentMemo->setText(Pilot::toPilot(fTextWidget->text()));
 	writeMemo(currentMemo);
 }
 
@@ -574,21 +568,17 @@
 	{
 		return false;
 	}
-	if ((category<0) || (category>=PILOT_CATEGORY_MAX)) category=0;
-
-	char *text = new char[s.length() + 2];
-	if (s.isEmpty())
+	if ((category<0) || (category>=(int)Pilot::CATEGORY_COUNT))
 	{
-		text[0]=0;
+		category=Pilot::Unfiled;
 	}
-	else
-	{
-		strlcpy(text,PilotAppCategory::codec()->fromUnicode(s),s.length()+2);
-	}
-	PilotMemo *aMemo = new PilotMemo(text, 0, 0, category);
+
+	PilotMemo *aMemo = new PilotMemo();
+	aMemo->setCategory(category);
+	aMemo->setText(s);
+
 	d->fMemoList.append(aMemo);
 	writeMemo(aMemo);
-	delete[]text;
 	updateWidget();
 #ifdef DEBUG
 	DEBUGKPILOT << fname << ": New memo @" << (void *)aMemo << endl;
Index: kpilot/kpilot/kpilot.cc
===================================================================
--- kpilot/kpilot/kpilot.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilot.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,10 +29,6 @@
 */
 
 
-static const char *kpilot_id =
-	"$Id$";
-
-
 #include "options.h"
 
 #include <qfile.h>
@@ -127,8 +123,6 @@
 #endif
 	fConfigureKPilotDialogInUse = false;
 
-	/* NOTREACHED */
-	(void) kpilot_id;
 }
 
 KPilotInstaller::~KPilotInstaller()
@@ -138,7 +132,7 @@
 	delete fDaemonStub;
 #ifdef DEBUG
 	PilotRecord::allocationInfo();
-	(void) PilotDatabase::count();
+	(void) PilotDatabase::instanceCount();
 #endif
 }
 
@@ -233,12 +227,14 @@
 
 	KPilotSettings::self()->readConfig();
 
-	(void) PilotAppCategory::setupPilotCodec(KPilotSettings::encoding());
+	(void) Pilot::setupPilotCodec(KPilotSettings::encoding());
+	(void) Pilot::setupPilotCodec(KPilotSettings::encoding());
+
 	if (fLogWidget)
 	{
 		fLogWidget->addMessage(i18n("Using character set %1 on "
 			"the handheld.")
-			.arg(PilotAppCategory::codecName()));
+			.arg(Pilot::codecName()));
 	}
 }
 
@@ -421,14 +417,6 @@
 		i18n("Please press the HotSync button."));
 }
 
-void KPilotInstaller::slotFastSyncRequested()
-{
-	FUNCTIONSETUP;
-	setupSync(SyncAction::SyncMode::eFastSync,
-		i18n("Next sync will be a Fast Sync. ") +
-		i18n("Please press the HotSync button."));
-}
-
 void KPilotInstaller::slotFullSyncRequested()
 {
 	FUNCTIONSETUP;
@@ -594,14 +582,6 @@
 		"should be a normal HotSync."));
 	syncPopup->insert(a);
 
-	a = new KAction(i18n("&FastSync"), CSL1("fastsync"), 0,
-		this, SLOT(slotFastSyncRequested()),
-		actionCollection(), "file_fastsync");
-	a->setToolTip(i18n("Next HotSync will be a FastSync."));
-	a->setWhatsThis(i18n("Tell the daemon that the next HotSync "
-		"should be a FastSync (run conduits only)."));
-	syncPopup->insert(a);
-
 	a = new KAction(i18n("Full&Sync"), CSL1("fullsync"), 0,
 		this, SLOT(slotFullSyncRequested()),
 		actionCollection(), "file_fullsync");
@@ -1064,7 +1044,7 @@
 	//
 	if (kind)
 	{
-		return ::kpilot_id;
+		return "kpilot.cc";
 	}
 	else
 	{
@@ -1110,7 +1090,7 @@
 		KPILOT_VERSION,
 		"KPilot - HotSync software for KDE\n\n",
 		KAboutData::License_GPL,
-		"(c) 1998-2000,2001, Dan Pilone (c) 2000-2004, Adriaan de Groot",
+		"(c) 1998-2000,2001, Dan Pilone (c) 2000-2006, Adriaan de Groot",
 		0L,
 		"http://www.kpilot.org/"
 		);
@@ -1119,9 +1099,12 @@
 		"pilone@slac.com" );
 	about.addAuthor("Adriaan de Groot",
 		I18N_NOOP("Maintainer"),
-		"groot@kde.org", "http://www.cs.kun.nl/~adridg/");
+		"groot@kde.org", "http://www.kpilot.org/");
 	about.addAuthor("Reinhold Kainhofer",
 		I18N_NOOP("Core and conduits developer"), "reinhold@kainhofer.com", "http://reinhold.kainhofer.com/Linux/");
+	about.addAuthor("Jason 'vanRijn' Kasper",
+		I18N_NOOP("Core and conduits developer"),
+		"vR@movingparts.net", "http://movingparts.net/");
 	about.addCredit("Preston Brown", I18N_NOOP("VCal conduit"));
 	about.addCredit("Greg Stern", I18N_NOOP("Abbrowser conduit"));
 	about.addCredit("Chris Molnar", I18N_NOOP("Expenses conduit"));
@@ -1135,6 +1118,8 @@
 		I18N_NOOP(".ui files"));
 	about.addCredit("Aaron J. Seigo",
 		I18N_NOOP("Bugfixer, coolness"));
+	about.addCredit("Bertjan Broeksema", 
+		I18N_NOOP("VCalconduit state machine, CMake"));
 
 	KCmdLineArgs::init(argc, argv, &about);
 	KCmdLineArgs::addCmdLineOptions(kpilotoptions, "kpilot");
@@ -1222,6 +1207,7 @@
 		CSL1("share/apps/kpilot/DBBackup"));
 	tp->show();
 	a.setMainWidget(tp);
+	DEBUGKPILOT << fname << ": MINIICON = " << a.miniIconName() << endl;
 	return a.exec();
 }
 
Index: kpilot/kpilot/listCat.cc
===================================================================
--- kpilot/kpilot/listCat.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/listCat.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,9 +28,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *listCat_id =
-	"$Id$";
-
 #include "options.h"
 
 #include <qpainter.h>
@@ -46,7 +43,6 @@
 {
 	FUNCTIONSETUP;
 	setupWidget();
-	(void) listCat_id;
 }
 
 ListCategorizer::ListCategorizer(const QStringList & i,
@@ -240,7 +236,7 @@
 	for (int i=0; i<fColumns; i++)
 	{
 		computeHeight(i);
-		h = QMAX(h,fRect[i].height()+2*RVPAD);
+		h = kMax(h,fRect[i].height()+2*RVPAD);
 	}
 
 	setHeight(h);
Index: kpilot/kpilot/syncStack.h
===================================================================
--- kpilot/kpilot/syncStack.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/syncStack.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,7 +52,7 @@
 * ActionQueue.
 *
 * An ActionQueue is constructed with a @p device. As usual, you should connect
-* the device's deviceReady(KPilotDeviceLink*) signal with the exec() slot --
+* the device's deviceReady(KPilotLink*) signal with the exec() slot --
 * or something to that effect.
 * The ActionQueue will then run all the actions in the queue in sequence.
 *
@@ -65,7 +65,7 @@
 	/** Constructor. Pass in a KPilot device link for it to act on.
 	* It is legal to pass in 0 (NULL) as a device.
 	*/
-	ActionQueue(KPilotDeviceLink *device);
+	ActionQueue(KPilotLink *device);
 
 	virtual ~ActionQueue();
 
@@ -91,6 +91,14 @@
 	QStringList fConduits;
 
 public:
+	/** Enum values for queueInit(), specifying what
+	*   standard actions to queue automatically.
+	*/
+	enum InitFlags {
+		queueNone=0,
+		queueCheckUser
+	} ;
+
 	/**
 	* Call these queue*() functions to append standard functional
 	* blocks. You should at least call queueInit() and
@@ -106,7 +114,7 @@
 	*   of files to install (checked at exec() time).
 	*/
 
-	void queueInit(bool checkUser = false);
+	void queueInit( InitFlags checkUser = queueNone );
 	void queueConduits(const QStringList &conduits,const SyncAction::SyncMode &e, bool local=false);
 	void queueInstaller(const QString &dir);
 	void queueCleanup();
@@ -129,7 +137,7 @@
 class WelcomeAction : public SyncAction
 {
 public:
-	WelcomeAction(KPilotDeviceLink *);
+	WelcomeAction(KPilotLink *);
 
 protected:
 	virtual bool exec();
@@ -143,7 +151,7 @@
 class SorryAction : public SyncAction
 {
 public:
-	SorryAction(KPilotDeviceLink *, const QString &s=QString::null);
+	SorryAction(KPilotLink *, const QString &s=QString::null);
 
 protected:
 	virtual bool exec();
@@ -160,7 +168,7 @@
 class LocalBackupAction : public SyncAction
 {
 public:
-	LocalBackupAction(KPilotDeviceLink *, const QString &);
+	LocalBackupAction(KPilotLink *, const QString &);
 protected:
 	virtual bool exec();
 	QString fDir;
@@ -177,7 +185,7 @@
 Q_OBJECT
 
 public:
-	ConduitProxy(KPilotDeviceLink *,
+	ConduitProxy(KPilotLink *,
 		const QString &desktopName,
 		const SyncAction::SyncMode &m);
 
Index: kpilot/kpilot/dbFlagsEditor.cc
===================================================================
--- kpilot/kpilot/dbFlagsEditor.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/dbFlagsEditor.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,19 +31,18 @@
 
 #include <qlineedit.h>
 #include <qcheckbox.h>
-#include <qtextcodec.h>
 #include <kdatewidget.h>
 #include <ktimewidget.h>
 #include <kmessagebox.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "dbFlagsEditor.h"
 #include "dbFlagsEditor_base.h"
 
 
 DBFlagsEditor::DBFlagsEditor(DBInfo*dbinfo, QWidget *parent) :
 	KDialogBase(parent, "FlagsEditor",false,
-		i18n("Edit Database Flags"), Ok|Cancel), 
+		i18n("Edit Database Flags"), Ok|Cancel),
 	dbi(dbinfo)
 {
 	widget=new DBFlagsEditorWidget(this);
@@ -60,7 +59,7 @@
 {
 	if (KMessageBox::questionYesNo(this, i18n("Changing the database flags might corrupt the whole database, or make the data unusable. Do not change the values unless you are absolutely sure you know what you are doing.\n\nReally assign these new flags?"), i18n("Changing Database Flags"),i18n("Assign"),KStdGuiItem::cancel())==KMessageBox::Yes)
 	{
-		strlcpy(dbi->name, PilotAppCategory::codec()->fromUnicode(widget->fDBName->text()), 33);
+		Pilot::toPilot(widget->fDBName->text(),dbi->name,33);
 
 		char buff[5];
 		strlcpy(buff, widget->fType->text().latin1(), 5);
Index: kpilot/kpilot/todoWidget.cc
===================================================================
--- kpilot/kpilot/todoWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/todoWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,10 +26,7 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *todowidget_id =
-	"$Id$";
 
-
 #include "options.h"
 
 #include <qptrlist.h>
@@ -79,8 +76,6 @@
 	setupWidget();
 	fTodoList.setAutoDelete(true);
 
-	/* NOTREACHED */
-	(void) todowidget_id;
 }
 
 TodoWidget::~TodoWidget()
@@ -144,7 +139,7 @@
 
 	fTodoList.clear();
 
-	if (fTodoDB->isDBOpen())
+	if (fTodoDB->isOpen())
 	{
 		KPILOT_DELETE(fTodoAppInfo);
 		fTodoAppInfo = new PilotToDoInfo(fTodoDB);
@@ -397,7 +392,7 @@
 	//
 	PilotDatabase *myDB = new PilotLocalDatabase(dbPath(), CSL1("ToDoDB"));
 
-	if (!myDB || !myDB->isDBOpen())
+	if (!myDB || !myDB->isOpen())
 	{
 #ifdef DEBUG
 		DEBUGKPILOT << fname
@@ -407,7 +402,7 @@
 			<< " and got pointer @"
 			<< (void *) myDB
 			<< " with status "
-			<< ( myDB ? myDB->isDBOpen() : false )
+			<< ( myDB ? myDB->isOpen() : false )
 			<< endl;
 #endif
 
@@ -444,7 +439,7 @@
 		fTodoAppInfo->categoryInfo(), true);
 
 
-	todo->PilotAppCategory::setCategory(currentCatID);
+	todo->PilotRecordBase::setCategory(currentCatID);
 	fTodoList.append(todo);
 	writeTodo(todo);
 	// TODO: Just add the new record to the lists
@@ -555,7 +550,7 @@
 	PilotDatabase *myDB = todoDB;
 	bool usemyDB = false;
 
-	if (myDB == 0L || !myDB->isDBOpen())
+	if (myDB == 0L || !myDB->isOpen())
 	{
 		myDB = new PilotLocalDatabase(dbPath(), CSL1("ToDoDB"));
 		usemyDB = true;
@@ -564,7 +559,7 @@
 	// Still no valid todo database...
 	//
 	//
-	if (!myDB->isDBOpen())
+	if (!myDB->isOpen())
 	{
 #ifdef DEBUG
 		DEBUGKPILOT << fname << ": Todo database is not open" <<
Index: kpilot/kpilot/pilotComponent.cc
===================================================================
--- kpilot/kpilot/pilotComponent.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/pilotComponent.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -37,19 +37,15 @@
 
 #include <qwidget.h>
 #include <qcombobox.h>
-#include <qtextcodec.h>
 
 #include <kdebug.h>
 
 #include "kpilotConfig.h"
-#include "pilotAppCategory.h"
-#include "pilotDatabase.h"
+#include "pilotRecord.h"
+#include "pilot.h"
 
 #include "pilotComponent.moc"
 
-static const char *pilotComponent_id =
-	"$Id$";
-
 PilotComponent::PilotComponent(QWidget * parent,
 	const char *id,
 	const QString & path) :
@@ -65,7 +61,6 @@
 			parent->geometry().height());
 	}
 
-	(void) pilotComponent_id;
 }
 
 
@@ -108,7 +103,7 @@
 	{
 		QString selectedCategory =
 			fCatList->text(fCatList->currentItem());
-		currentCatID = PilotAppInfoBase::findCategory(selectedCategory, AllIsUnfiled, info);
+		currentCatID = Pilot::findCategory(info, selectedCategory, AllIsUnfiled);
 	}
 
 	if ((currentCatID == -1) && AllIsUnfiled)
@@ -139,7 +134,7 @@
 	// the user uses, so no translation is necessary.
 	//
 	//
-	for (int i = 0; i < PILOT_CATEGORY_MAX; i++)
+	for (unsigned int i = 0; i < Pilot::CATEGORY_COUNT; i++)
 	{
 		if (info->name[i][0])
 		{
@@ -150,7 +145,7 @@
 				<< " with ID: " << (int) info->ID[i] << endl;
 #endif
 
-			c->insertItem(PilotAppCategory::codec()->toUnicode(info->name[i]));
+			c->insertItem(Pilot::fromPilot(info->name[i]));
 		}
 	}
 
Index: kpilot/kpilot/kpilot_config.desktop
===================================================================
--- kpilot/kpilot/kpilot_config.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilot_config.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -108,7 +108,7 @@
 Keywords[es]=kpilot,principal
 Keywords[et]=kpilot,peamine
 Keywords[eu]=kpilot,nagusia
-Keywords[fa]=kpilot،اصلی
+Keywords[fa]=kpilot ،اصلی
 Keywords[fi]=kpilot
 Keywords[fr]=kpilot,principal
 Keywords[ga]=kpilot,príomh
Index: kpilot/kpilot/logFile.cc
===================================================================
--- kpilot/kpilot/logFile.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/logFile.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,8 +27,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org.
 */
-static const char *logf_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -50,7 +48,6 @@
 LogFile::LogFile() : DCOPObject("LogIface"), QObject(), fOutfile(0L), fSyncing(false)
 {
 	FUNCTIONSETUP;
-	(void) logf_id;
 }
 
 
Index: kpilot/kpilot/kpilot.desktop
===================================================================
--- kpilot/kpilot/kpilot.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilot.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,7 +14,6 @@
 Name[zu]=KUmshayeli webhanoyi
 GenericName=PalmPilot Tool
 GenericName[af]=Palmpilot Program
-GenericName[ar]=أداة بالم بايلوت
 GenericName[be]=Інструмэнт Palm Pilot
 GenericName[bg]=Връзка с PalmPilot
 GenericName[br]=Ostilh PalmPilot
Index: kpilot/kpilot/hotSync.cc
===================================================================
--- kpilot/kpilot/hotSync.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/hotSync.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,6 +2,7 @@
 **
 ** Copyright (C) 2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 ** This file defines SyncActions, which are used to perform some specific
 ** task during a HotSync. Conduits are not included here, nor are
@@ -30,8 +31,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org.
 */
 
-static const char *hotsync_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -40,6 +39,7 @@
 #include <stdio.h>
 
 #include <pi-file.h>
+#include <pi-util.h>
 
 #include <qtimer.h>
 #include <qfile.h>
@@ -47,7 +47,6 @@
 #include <qdir.h>
 #include <qvaluelist.h>
 #include <qregexp.h>
-#include <qtextcodec.h>
 #include <qstringlist.h>
 
 #include <kglobal.h>
@@ -55,7 +54,7 @@
 #include <kapplication.h>
 
 #include "pilotUser.h"
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "syncStack.h"
 #include "pilotSerialDatabase.h"
 #include "pilotLocalDatabase.h"
@@ -64,12 +63,11 @@
 
 #include "hotSync.moc"
 
-TestLink::TestLink(KPilotDeviceLink * p) :
+TestLink::TestLink(KPilotLink * p) :
 	SyncAction(p, "testLink")
 {
 	FUNCTIONSETUP;
 
-	(void) hotsync_id;
 }
 
 /* virtual */ bool TestLink::exec()
@@ -83,33 +81,22 @@
 
 	addSyncLogEntry(i18n("Testing.\n"));
 
-#ifdef BRUTE_FORCE
-	for (i=0; i<32; i++)
-#else
-	while ((i = fHandle->getNextDatabase(dbindex,&db)) > 0)
-#endif
+	while ((i = deviceLink()->getNextDatabase(dbindex,&db)) > 0)
 	{
-#ifdef BRUTE_FORCE
-		if (fHandle->getNextDatabase(i,&db) < 1)
-		{
-			DEBUGCONDUIT << fname << ": No database index " << i << endl;
-			continue;
-		}
-#endif
-
 		count++;
 		dbindex = db.index + 1;
 
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Read database " << db.name << endl;
-#endif
+		DEBUGKPILOT << fname
+			<< ": Read database " << db.name
+			<< " with index " << db.index
+			<< endl;
 
 		// Let the Pilot User know what's happening
 		openConduit();
 		// Let the KDE User know what's happening
 		// Pretty sure all database names are in latin1.
 		emit logMessage(i18n("Syncing database %1...")
-			.arg(PilotAppCategory::codec()->toUnicode(db.name)));
+			.arg(Pilot::fromPilot(db.name)));
 
 		kapp->processEvents();
 	}
@@ -119,19 +106,32 @@
 	return true;
 }
 
-BackupAction::BackupAction(KPilotDeviceLink * p, bool full) :
+class BackupAction::Private
+{
+public:
+	Private() : fTimer(0L) { }
+
+	QTimer *fTimer;
+	bool fFullBackup;
+	QStringList fNoBackupDBs;
+	QValueList<unsigned long> fNoBackupCreators;
+	QStringList fDeviceDBs;
+
+	QString fPreferBackupDir; /**< Directory towrite backup in, overrides default */
+
+	// Remainder is used to hand around info during sync
+
+	int fDBIndex;       /**< Database number we're now doing */
+	QString fBackupDir; /**< Directory to write backup in.*/
+} ;
+
+BackupAction::BackupAction(KPilotLink * p, bool full) :
 	SyncAction(p, "backupAction"),
-	fFullBackup(full)
+	fP( new Private )
 {
 	FUNCTIONSETUP;
 
-	fDatabaseDir = KGlobal::dirs()->saveLocation("data",
-		CSL1("kpilot/DBBackup/"));
-
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Will write to " << fDatabaseDir << endl;
-	DEBUGCONDUIT << fname << ": Full sync? " << full << endl;
-#endif
+	fP->fFullBackup = full;
 }
 
 /* virtual */ QString BackupAction::statusString() const
@@ -171,6 +171,15 @@
 	return s;
 }
 
+void BackupAction::setDirectory( const QString &p )
+{
+	fP->fPreferBackupDir = p;
+	if (!p.endsWith(CSL1("/")))
+	{
+		fP->fPreferBackupDir.append(CSL1("/"));
+	}
+}
+
 static inline bool dontBackup(struct DBInfo *info,
 	const QStringList &dbnames,
 	const QValueList<unsigned long> &dbcreators)
@@ -182,7 +191,7 @@
 	if (dbcreators.findIndex(info->creator) != -1) return true;
 
 	// Now take wildcards into account
-	QString db = PilotAppCategory::codec()->toUnicode(info->name);
+	QString db = Pilot::fromPilot(info->name);
 	for (QStringList::const_iterator i = dbnames.begin(); i != dbnames.end(); ++i)
 	{
 		QRegExp re(*i,true,true); // Wildcard match
@@ -223,8 +232,7 @@
 		}
 	}
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Will skip databases "
+	DEBUGKPILOT << fname << ": Will skip databases "
 		<< dbnames.join(CSL1(",")) << endl;
 	QString creatorids;
 	for (QValueList<unsigned long>::const_iterator i = dbcreators.begin();
@@ -232,35 +240,39 @@
 	{
 		creatorids.append(CSL1("[%1]").arg(*i,0,16));
 	}
-	DEBUGCONDUIT << fname << ": Will skip creators " << creatorids << endl;
-#endif
+	DEBUGKPILOT << fname << ": Will skip creators " << creatorids << endl;
 }
 
 /* virtual */ bool BackupAction::exec()
 {
 	FUNCTIONSETUP;
 
-	mDeviceDBs = KPilotSettings::deviceDBs();
+	fP->fDeviceDBs = KPilotSettings::deviceDBs();
 
-	fBackupDir =
-		fDatabaseDir +
-		PilotAppCategory::codec()->toUnicode(fHandle->getPilotUser()->getUserName()) +
-		CSL1("/");
+	if (fP->fPreferBackupDir.isEmpty())
+	{
+		fP->fBackupDir =
+			KGlobal::dirs()->saveLocation("data",CSL1("kpilot/DBBackup/")) +
+			Pilot::fromPilot(deviceLink()->getPilotUser().getUserName()) +
+			CSL1("/");
+	}
+	else
+	{
+		fP->fBackupDir = fP->fPreferBackupDir;
+	}
 
-	logMessage(i18n("Backup directory: %1.").arg(fBackupDir));
+	logMessage(i18n("Backup directory: %1.").arg(fP->fBackupDir));
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGKPILOT << fname
 		<< ": This Pilot user's name is \""
-		<< fHandle->getPilotUser()->getUserName() << "\"" << endl;
-	DEBUGCONDUIT << fname
-		<< ": Using backup dir: " << fBackupDir << endl;
-	DEBUGCONDUIT << fname
-		<< ": Full Backup? " << fFullBackup << endl;
-#endif
+		<< deviceLink()->getPilotUser().getUserName() << "\"" << endl;
+	DEBUGKPILOT << fname
+		<< ": Using backup dir: " << fP->fBackupDir << endl;
+	DEBUGKPILOT << fname
+		<< ": Full Backup? " << fP->fFullBackup << endl;
 
 
-	if (fFullBackup)
+	if (fP->fFullBackup)
 	{
 		fActionStatus = FullBackup;
 		addSyncLogEntry(i18n("Full backup started."));
@@ -271,7 +283,7 @@
 		addSyncLogEntry(i18n("Fast backup started"));
 	}
 
-	if (!checkBackupDirectory(fBackupDir))
+	if (!checkBackupDirectory(fP->fBackupDir))
 	{
 		fActionStatus=BackupIncomplete;
 		// Don't issue an error message, checkBackupDirectory
@@ -279,51 +291,56 @@
 		return false;
 	}
 
-	initNoBackup( fNoBackupDBs, fNoBackupCreators );
+	initNoBackup( fP->fNoBackupDBs, fP->fNoBackupCreators );
 
-	fTimer = new QTimer( this );
-	QObject::connect( fTimer, SIGNAL( timeout() ),
+	fP->fTimer = new QTimer( this );
+	QObject::connect( fP->fTimer, SIGNAL( timeout() ),
 		this, SLOT( backupOneDB() ) );
 
-	fDBIndex = 0;
+	fP->fDBIndex = 0;
 
-	fTimer->start( 0, false );
+	fP->fTimer->start( 0, false );
 	return true;
 }
 
-bool BackupAction::checkBackupDirectory(QString backupDir)
+bool BackupAction::checkBackupDirectory( const QString &backupDir )
 {
 	FUNCTIONSETUP;
 	QFileInfo fi(backupDir);
 
-	if (!(fi.exists() && fi.isDir()))
+	if (fi.exists() && fi.isDir())
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-			<< ": Need to create backup directory for user "
-			<< fHandle->getPilotUser()->getUserName() << endl;
-#endif
+		return true;
+	}
 
-		fi = QFileInfo(fDatabaseDir);
-		if (!(fi.exists() && fi.isDir()))
-		{
-			kdError() << k_funcinfo
-				<< ": Database backup directory "
-				<< "doesn't exist."
-				<< endl;
-			return false;
-		}
+	if (fi.exists() && !fi.isDir())
+	{
+		kdWarning() << k_funcinfo
+			<< ": Requested backup directory "
+			<< backupDir
+			<< " exists but is not a directory."
+			<< endl;
+		return false;
+	}
 
-		QDir databaseDir(backupDir);
+	if ( !backupDir.endsWith("/") )
+	{
+		kdWarning() << k_funcinfo
+			<< ": Backup dir does not end with a / "
+			<< endl;
+		return false;
+	}
 
-		if (!databaseDir.mkdir(backupDir, true))
-		{
-			kdError() << k_funcinfo
-				<< ": Can't create backup directory." << endl;
-			return false;
-		}
-	}
-	return true;
+	Q_ASSERT(!fi.exists());
+
+	DEBUGKPILOT << fname
+		<< ": Creating directory " << backupDir << endl;
+
+	KStandardDirs::makeDir( backupDir );
+
+	fi = QFileInfo(backupDir);
+
+	return fi.exists() && fi.isDir();
 }
 
 /* slot */ void BackupAction::backupOneDB()
@@ -332,15 +349,10 @@
 
 	struct DBInfo info;
 
-	emit logProgress(QString::null, fDBIndex);
+	emit logProgress(QString::null, fP->fDBIndex);
 
 	if (openConduit() < 0)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-			<< ": openConduit failed. User cancel?" << endl;
-#endif
-
 		addSyncLogEntry(i18n("Exiting on cancel."));
 		endBackup();
 		fActionStatus = BackupIncomplete;
@@ -348,14 +360,10 @@
 	}
 
 	// TODO: Is there a way to skip unchanged databases?
-	int res = fHandle->getNextDatabase( fDBIndex, &info );
+	int res = deviceLink()->getNextDatabase( fP->fDBIndex, &info );
 	if (res < 0)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Backup complete." << endl;
-#endif
-
-		if ( fFullBackup )
+		if ( fP->fFullBackup )
 			addSyncLogEntry( i18n("Full backup complete.") );
 		else
 			addSyncLogEntry( i18n("Fast backup complete.") );
@@ -364,7 +372,7 @@
 		return;
 	}
 
-	fDBIndex = info.index + 1;
+	fP->fDBIndex = info.index + 1;
 
 	char buff[8];
 	memset(buff, 0, 8);
@@ -375,43 +383,37 @@
 	QString creator = QString::fromLatin1( buff );
 	info.name[33]='\0';
 	QString dbname = QString::fromLatin1( info.name );
-	if ( !mDeviceDBs.contains( creator ) )
-		mDeviceDBs << creator;
-	if ( !mDeviceDBs.contains( dbname ) )
-		mDeviceDBs << dbname;
+	if ( !fP->fDeviceDBs.contains( creator ) )
+		fP->fDeviceDBs << creator;
+	if ( !fP->fDeviceDBs.contains( dbname ) )
+		fP->fDeviceDBs << dbname;
 
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Checking to see if we should backup database " << info.name
+	DEBUGKPILOT << fname << ": Checking to see if we should backup database " << info.name
 		<< " [" << QString::number(info.creator,16) << "]" << endl;
-#endif
 
 	// see if user told us not to back this creator or database up...
-	if (dontBackup(&info,fNoBackupDBs,fNoBackupCreators))
+	if (dontBackup(&info,fP->fNoBackupDBs,fP->fNoBackupCreators))
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Skipping database " << info.name
+		DEBUGKPILOT << fname << ": Skipping database " << info.name
 			<< " (database in no-backup list)" << endl;
-#endif
 		QString s = i18n("Skipping %1")
-			.arg(PilotAppCategory::codec()->toUnicode(info.name));
+			.arg(Pilot::fromPilot(info.name));
 		addSyncLogEntry(s);
 		return;
 	}
 
 	// don't backup resource databases...
-	if ( (!fFullBackup) && PilotDatabase::isResource(&info))
+	if ( (!fP->fFullBackup) && PilotDatabase::isResource(&info))
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Skipping database " << info.name
+		DEBUGKPILOT << fname << ": Skipping database " << info.name
 			<< " (resource database)" << endl;
-#endif
 		// Just skip resource DBs during an update hotsync.
 		return;
 	}
 
 	QString s = i18n("Backing up: %1")
-		.arg(PilotAppCategory::codec()->toUnicode(info.name));
+		.arg(Pilot::fromPilot(info.name));
 	addSyncLogEntry(s);
 
 	if (!createLocalDatabase(&info))
@@ -420,7 +422,7 @@
 			<< ": Couldn't create local database for "
 			<< info.name << endl;
 		addSyncLogEntry(i18n("Backup of %1 failed.\n")
-			.arg(PilotAppCategory::codec()->toUnicode(info.name)));
+			.arg(Pilot::fromPilot(info.name)));
 	}
 	else
 	{
@@ -441,28 +443,29 @@
 {
 	FUNCTIONSETUP;
 
-	QString databaseName(PilotAppCategory::codec()->toUnicode(info->name));
+	QString databaseName(Pilot::fromPilot(info->name));
 	// default this to true.  we will set it to false if there are no modified
 	// records and we are not doing a full sync.
 	bool doBackup = true;
 
 	// make sure that our directory is available...
-	if (!checkBackupDirectory(fBackupDir)) return false;
+	if (!checkBackupDirectory( fP->fBackupDir )) return false;
 
 	// we always need to open the database on the pilot because if we're going to sync
 	// it, we need to reset the "dirty" flags, etc.
-	PilotSerialDatabase*serial=new PilotSerialDatabase(pilotSocket(), databaseName);
-	if (!serial->isDBOpen())
+	PilotDatabase *serial=deviceLink()->database(databaseName);
+	if (!serial->isOpen())
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT<<"Unable to open database "<<info->name<<" to check for modified records and reset sync flags."<<endl;
-#endif
+		DEBUGKPILOT << fname << ": Unable to open database "<<info->name
+			<< " to check for modified records and reset sync flags." << endl;
+		KPILOT_DELETE(serial);
+		return false;
 	}
 
 	// now we look to see if the database on the pilot has at least one changed record
 	// in it.  we do this so that we don't waste time backing up a database that has
 	// not changed.  note: don't bother with this check if we're doing a full backup.
-	if (!fFullBackup && serial->isDBOpen())
+	if (!fP->fFullBackup && serial->isOpen())
 	{
 		int index=0;
 		PilotRecord*rec=serial->readNextModifiedRec(&index);
@@ -492,7 +495,7 @@
 	// checks and proceed....
 	databaseName.replace('/', CSL1("_"));
 
-	QString fullBackupName = fBackupDir + databaseName;
+	QString fullBackupName = fP->fBackupDir + databaseName;
 
 	if (PilotDatabase::isResource(info))
 	{
@@ -515,8 +518,8 @@
 
 	// if we've backed this one up, clean it up so we won't do it again next
 	// sync unless it's truly changed
-	serial=new PilotSerialDatabase(pilotSocket(), databaseName);
-	if (backedUp && serial->isDBOpen())
+	serial=deviceLink()->database(databaseName);
+	if (backedUp && serial->isOpen())
 	{
 		serial->cleanup();
 		serial->resetSyncFlags();
@@ -530,26 +533,26 @@
 {
 	FUNCTIONSETUP;
 
-	KPILOT_DELETE(fTimer);
-	fDBIndex = (-1);
+	KPILOT_DELETE(fP->fTimer);
+	fP->fDBIndex = (-1);
 	fActionStatus = BackupEnded;
-	mDeviceDBs.sort();
+	fP->fDeviceDBs.sort();
 	QString old( QString::null );
-	QStringList::Iterator itr = mDeviceDBs.begin();
-	while ( itr != mDeviceDBs.end() ) {
+	QStringList::Iterator itr = fP->fDeviceDBs.begin();
+	while ( itr != fP->fDeviceDBs.end() ) {
 		if ( old == *itr ) {
-			itr = mDeviceDBs.remove( itr );
+			itr = fP->fDeviceDBs.remove( itr );
 		} else {
 			old = *itr;
 			++itr;
 		}
 	}
-	KPilotSettings::setDeviceDBs( mDeviceDBs );
+	KPilotSettings::setDeviceDBs( fP->fDeviceDBs );
 
 	emit syncDone(this);
 }
 
-FileInstallAction::FileInstallAction(KPilotDeviceLink * p,
+FileInstallAction::FileInstallAction(KPilotLink * p,
 	const QString & d) :
 	SyncAction(p, "fileInstall"),
 	fDBIndex(-1),
@@ -574,7 +577,7 @@
 	fList = installDir.entryList(QDir::Files |
 		QDir::NoSymLinks | QDir::Readable);
 #ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGKPILOT << fname
 		<< ": Installing " << fList.count() << " files" << endl;
 #endif
 
@@ -608,7 +611,7 @@
 	Q_ASSERT((unsigned) fDBIndex <= fList.count());
 
 #ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGKPILOT << fname
 		<< ": Installing file index "
 		<< fDBIndex << " (of " << fList.count() << ")" << endl;
 #endif
@@ -616,7 +619,7 @@
 	if ((!fList.count()) || ((unsigned) fDBIndex >= fList.count()))
 	{
 #ifdef DEBUG
-		DEBUGCONDUIT << fname
+		DEBUGKPILOT << fname
 			<< ": Peculiar file index, bailing out." << endl;
 #endif
 		KPILOT_DELETE(fTimer);
@@ -632,7 +635,7 @@
 	fDBIndex++;
 
 #ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Installing file " << filePath << endl;
+	DEBUGKPILOT << fname << ": Installing file " << filePath << endl;
 #endif
 
 	QString m = i18n("Installing %1").arg(fileName);
@@ -749,7 +752,7 @@
 	}
 }
 
-CleanupAction::CleanupAction(KPilotDeviceLink *p)  : SyncAction(p,"cleanupAction")
+CleanupAction::CleanupAction(KPilotLink *p)  : SyncAction(p,"cleanupAction")
 {
 	FUNCTIONSETUP;
 }
@@ -758,7 +761,7 @@
 {
 #ifdef DEBUG
 	FUNCTIONSETUP;
-	DEBUGCONDUIT << fname
+	DEBUGKPILOT << fname
 		<< ": Deleting @" << (long)this << endl;
 #endif
 }
Index: kpilot/kpilot/kpilotConfig.cc
===================================================================
--- kpilot/kpilot/kpilotConfig.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotConfig.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,8 +45,6 @@
 #include "kpilotSettings.h"
 #include "kpilotConfig.h"
 
-static const char kpilotconfig_id[] =
-	"$Id$";
 
 // This is a number indicating what configuration version
 // we're dealing with. Whenever new configuration options are
Index: kpilot/kpilot/addressWidget.cc
===================================================================
--- kpilot/kpilot/addressWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/addressWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,11 +28,8 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *addresswidget_id =
-	"$Id$";
 
 
-
 #ifndef _KPILOT_OPTIONS_H
 #include "options.h"
 #endif
@@ -79,9 +76,6 @@
 
 	setupWidget();
 	fAddressList.setAutoDelete(true);
-
-	/* NOTREACHED */
-	(void) addresswidget_id;
 }
 
 AddressWidget::~AddressWidget()
@@ -146,7 +140,7 @@
 
 	fAddressList.clear();
 
-	if (addressDB->isDBOpen())
+	if (addressDB->isOpen())
 	{
 		KPILOT_DELETE(fAddressAppInfo);
 		fAddressAppInfo = new PilotAddressInfo(addressDB);
@@ -447,7 +441,7 @@
 	}
 
 	AddressEditor *editor = new AddressEditor(selectedRecord,
-		fAddressAppInfo->info(), this);
+		fAddressAppInfo, this);
 
 	connect(editor, SIGNAL(recordChangeComplete(PilotAddress *)),
 		this, SLOT(slotUpdateRecord(PilotAddress *)));
@@ -470,7 +464,7 @@
 	//
 	PilotDatabase *myDB = new PilotLocalDatabase(dbPath(), CSL1("AddressDB"));
 
-	if (!myDB || !myDB->isDBOpen())
+	if (!myDB || !myDB->isOpen())
 	{
 #ifdef DEBUG
 		DEBUGKPILOT << fname
@@ -480,7 +474,7 @@
 			<< " and got pointer @"
 			<< (long) myDB
 			<< " with status "
-			<< ( myDB ? myDB->isDBOpen() : false )
+			<< ( myDB ? myDB->isOpen() : false )
 			<< endl;
 #endif
 
@@ -497,7 +491,7 @@
 	}
 
 	AddressEditor *editor = new AddressEditor(0L,
-		fAddressAppInfo->info(), this);
+		fAddressAppInfo, this);
 
 	connect(editor, SIGNAL(recordChangeComplete(PilotAddress *)),
 		this, SLOT(slotAddRecord(PilotAddress *)));
@@ -517,7 +511,7 @@
 		fAddressAppInfo->categoryInfo(), true);
 
 
-	address->PilotAppCategory::setCategory(currentCatID);
+	address->PilotRecordBase::setCategory(currentCatID);
 	fAddressList.append(address);
 	writeAddress(address);
 	// TODO: Just add the new record to the lists
@@ -636,7 +630,7 @@
 	PilotDatabase *myDB = addressDB;
 	bool usemyDB = false;
 
-	if (myDB == 0L || !myDB->isDBOpen())
+	if (myDB == 0L || !myDB->isOpen())
 	{
 		myDB = new PilotLocalDatabase(dbPath(), CSL1("AddressDB"));
 		usemyDB = true;
@@ -645,7 +639,7 @@
 	// Still no valid address database...
 	//
 	//
-	if (!myDB->isDBOpen())
+	if (!myDB->isOpen())
 	{
 #ifdef DEBUG
 		DEBUGKPILOT << fname << ": Address database is not open" <<
@@ -683,7 +677,7 @@
 
 	QString prompt = (currentCatID==-1) ?
 		i18n("Export All Addresses") :
-		i18n("Export Address Category %1").arg(fAddressAppInfo->category(currentCatID)) ;
+		i18n("Export Address Category %1").arg(fAddressAppInfo->categoryName(currentCatID)) ;
 
 
 	QString saveFile = KFileDialog::getSaveFileName(
Index: kpilot/kpilot/hotSync.h
===================================================================
--- kpilot/kpilot/hotSync.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/hotSync.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,6 +4,7 @@
 **
 ** Copyright (C) 2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 ** This file defines SyncActions, which are used to perform some specific
 ** task during a HotSync. Conduits are not included here, nor are
@@ -36,14 +37,13 @@
 class QTimer;
 
 #include "syncAction.h"
-#include "syncStack.h"
 
 class TestLink : public SyncAction
 {
 Q_OBJECT
 
 public:
-	TestLink(KPilotDeviceLink *);
+	TestLink(KPilotLink *);
 
 protected:
 	virtual bool exec();
@@ -54,7 +54,15 @@
 Q_OBJECT
 
 public:
-	BackupAction(KPilotDeviceLink *, bool full);
+	/** Constructor. Back up all the databases on
+	*   the link to a directory on the local disk.
+	*   If @p full is @c true, then a full backup,
+	*   including applications, is done. Otherwise,
+	*   only user data is backed-up.
+	*
+	* @see setDirectory()
+	*/
+	BackupAction(KPilotLink *, bool full);
 
 	enum Status { Init,
 		Error,
@@ -66,35 +74,53 @@
 		} ;
 	virtual QString statusString() const;
 
+	/** By default, a path based on the user name (either
+	*   on the handheld or set in KPilot) is used to
+	*   determine the backup directory name ( generally
+	*   $KDEHOME/share/apps/kpilot/DBBackup/_user_name_ ).
+	*   Use setDirectory() to change that and use a given
+	*   @p path as target for the backup. Use an empty
+	*   @p path to restore the default behavior of using
+	*   the username.
+	*/
+	void setDirectory( const QString &path );
+
 protected:
 	virtual bool exec();
 
 private:
-	/**
-	* All manner of support functions for full backup.
-	*/
+	/** Finish the backup and clean up resources. */
 	void endBackup();
-	bool createLocalDatabase(DBInfo *);
-	bool checkBackupDirectory(QString backupDir);
 
+	/** Copy the database indicated by @p info to the local
+	*   disk; returns @c false on failure.
+	*/
+	bool createLocalDatabase(DBInfo *info);
+
+	/** Make sure that the backup directory @p backupDir
+	*   exists and is a directory; returns @c false
+	*   if this is not the case. This method will try
+	*   to create the directory if it doesn't exist yet.
+	*/
+	static bool checkBackupDirectory( const QString &backupDir );
+
 private slots:
+	/** Implementation detail: databases get backed-up
+	*   one at a time because the backup function in
+	*   pilot-link isn't threaded.
+	*/
 	void backupOneDB();
 
 private:
-	QTimer *fTimer;
-	int fDBIndex;
-	QString fBackupDir, fDatabaseDir;
-	bool fFullBackup;
-	QStringList fNoBackupDBs;
-	QValueList<unsigned long> fNoBackupCreators;
-	QStringList mDeviceDBs;
+	class Private;
+	Private *fP;
 } ;
 
 class FileInstallAction : public SyncAction
 {
 Q_OBJECT
 public:
-	FileInstallAction(KPilotDeviceLink *,
+	FileInstallAction(KPilotLink *,
 		const QString &fileDir);
 	virtual ~FileInstallAction();
 
@@ -120,7 +146,7 @@
 class CleanupAction : public SyncAction
 {
 public:
-	CleanupAction(KPilotDeviceLink * p);
+	CleanupAction(KPilotLink * p);
 	virtual ~CleanupAction();
 
 protected:
Index: kpilot/kpilot/kpilotConfigDialog_sync.ui
===================================================================
--- kpilot/kpilot/kpilotConfigDialog_sync.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotConfigDialog_sync.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-<!DOCTYPE UI><UI version="3.2" stdsetdef="1">
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
 <class>SyncConfigWidget</class>
 <comment>A widget for editing HotSync-specific settings.</comment>
 <author>David Bishop</author>
@@ -26,33 +26,31 @@
         </property>
         <widget class="QCheckBox" row="1" column="1">
             <property name="name">
-                <cstring>fFullBackupCheck</cstring>
+                <cstring>fFullSyncCheck</cstring>
             </property>
             <property name="text">
-                <string>&amp;Do full backup when changing PCs</string>
+                <string>Do full sync when chan&amp;ging PCs</string>
             </property>
+            <property name="checked">
+                <bool>true</bool>
+            </property>
             <property name="whatsThis" stdset="0">
-                <string>&lt;qt&gt;Check this box to perform a full backup when your last sync was performed with another PC or system, to guarantee the completeness of your backup data.&lt;/qt&gt;</string>
+                <string>&lt;qt&gt;Check this box to perform a full sync when your last sync was performed with another PC or system, to guarantee the completeness of your data.&lt;/qt&gt;</string>
             </property>
         </widget>
         <widget class="QComboBox" row="0" column="1">
             <item>
                 <property name="text">
-                    <string>HotSync (sync all changes, update backup)</string>
+                    <string>HotSync (sync all changes)</string>
                 </property>
             </item>
             <item>
                 <property name="text">
-                    <string>FastSync (sync changes, no backup)</string>
+                    <string>FullSync (sync also unchanged records)</string>
                 </property>
             </item>
             <item>
                 <property name="text">
-                    <string>FullSync (sync also unchanged records, full backup)</string>
-                </property>
-            </item>
-            <item>
-                <property name="text">
                     <string>Copy PC to Handheld</string>
                 </property>
             </item>
@@ -65,7 +63,7 @@
                 <cstring>fSpecialSync</cstring>
             </property>
             <property name="whatsThis" stdset="0">
-                <string>&lt;qt&gt;Select in this list the synchronization type that KPilot will use as default. Possibly values are:&lt;br&gt;"HotSync", to run all selected conduits, and sync the databases with a modified flag set, updating the modified records only;&lt;br&gt;"FastSync", to only synchronize those databases that have conduits;&lt;br&gt;"FullSync" to run all selected conduits, and sync all databases, reading all records, and performing a full backup;&lt;br&gt;"Copy PC to handheld" to run all conduits and sync all databases, but instead of merging the information from both sources, copy the PC data to the handheld;&lt;br&gt;"Copy handheld to PC" to run all conduits and sync all databases, but instead of merging the information from both sources, copy the handheld data to the PC.&lt;/qt&gt;</string>
+                <string>&lt;qt&gt;Select in this list the synchronization type that KPilot will use as default. Possible values are:&lt;br&gt;"HotSync", to run all selected conduits, and sync the databases with a modified flag set, updating the modified records only;&lt;br&gt;"FullSync" to run all selected conduits, and sync all databases, reading all records, and performing a full backup;&lt;br&gt;"Copy PC to handheld" to run all conduits and sync all databases, but instead of merging the information from both sources, copy the PC data to the handheld;&lt;br&gt;"Copy handheld to PC" to run all conduits and sync all databases, but instead of merging the information from both sources, copy the handheld data to the PC.&lt;/qt&gt;</string>
             </property>
         </widget>
         <widget class="QLabel" row="0" column="0">
Index: kpilot/kpilot/kpilot.h
===================================================================
--- kpilot/kpilot/kpilot.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilot.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -102,7 +102,6 @@
 	void slotRestoreRequested();
 	void slotBackupRequested();
 	void slotHotSyncRequested();
-	void slotFastSyncRequested();
 	void slotFullSyncRequested();
 	void slotHHtoPCRequested();
 	void slotPCtoHHRequested();
Index: kpilot/kpilot/interactiveSync.cc
===================================================================
--- kpilot/kpilot/interactiveSync.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/interactiveSync.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,6 +2,7 @@
 **
 ** Copyright (C) 2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 ** This file specializes SyncAction to a kind that can have interaction
 ** with the user without the Sync timing out.
@@ -28,9 +29,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org.
 */
 
-static const char *interactivesync_id =
-	"$Id$";
-
 #include "options.h"
 
 #include <time.h>
@@ -50,7 +48,6 @@
 #include <qfileinfo.h>
 #include <qtl.h>
 #include <qstyle.h>
-#include <qtextcodec.h>
 
 #include <kdialogbase.h>
 #include <kglobal.h>
@@ -60,7 +57,7 @@
 #include <kapplication.h>
 
 #include "pilotUser.h"
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "pilotLocalDatabase.h"
 #include "kpilotConfig.h"
 #include "kpilotlink.h"
@@ -68,12 +65,11 @@
 #include "interactiveSync.moc"
 
 
-CheckUser::CheckUser(KPilotDeviceLink * p, QWidget * vp):
+CheckUser::CheckUser(KPilotLink * p, QWidget * vp):
 	SyncAction(p, vp, "userCheck")
 {
 	FUNCTIONSETUP;
 
-	(void) interactivesync_id;
 }
 
 CheckUser::~CheckUser()
@@ -86,8 +82,8 @@
 	FUNCTIONSETUP;
 
 	QString guiUserName = KPilotSettings::userName();
-	QString pilotUserName = PilotAppCategory::codec()->
-		toUnicode(fHandle->getPilotUser()->getUserName());
+// TODO: add userName() to pilotUser class
+	QString pilotUserName = Pilot::fromPilot(fHandle->getPilotUser().getUserName());
 	bool pilotUserEmpty = pilotUserName.isEmpty();
 	// 4 cases to handle:
 	//    guiUserName empty / not empty
@@ -111,8 +107,7 @@
 				KMessageBox::Yes)
 			{
 				KPilotSettings::setUserName(defaultUserName);
-				fHandle->getPilotUser()->
-					setUserName(PilotAppCategory::codec()->fromUnicode(defaultUserName));
+				fHandle->getPilotUser().setUserName(defaultUserName);
 				guiUserName=defaultUserName;
 				pilotUserName=defaultUserName;
 			}
@@ -146,14 +141,12 @@
 				KMessageBox::Yes)
 			{
 #ifdef DEBUG
-				DEBUGDAEMON << fname
+				DEBUGKPILOT << fname
 					<< ": Setting user name in pilot to "
 					<< guiUserName << endl;
 #endif
 
-				QCString l1 = PilotAppCategory::codec()->fromUnicode(guiUserName);
-
-				fHandle->getPilotUser()->setUserName(l1.data());
+				fHandle->getPilotUser().setUserName(guiUserName);
 				pilotUserName=guiUserName;
 			}
 		}
@@ -179,8 +172,7 @@
 				switch (r)
 				{
 				case KMessageBox::Yes:
-					fHandle->getPilotUser()->setUserName(
-						PilotAppCategory::codec()->fromUnicode(guiUserName));
+					fHandle->getPilotUser().setUserName(guiUserName);
 					pilotUserName=guiUserName;
 					break;
 				case KMessageBox::No:
@@ -198,11 +190,11 @@
 
 
 #ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGKPILOT << fname
 		<< ": User name set to gui<"
 		<< guiUserName
 		<< "> hh<"
-		<< fHandle->getPilotUser()->getUserName() << ">" << endl;
+		<< fHandle->getPilotUser().getUserName() << ">" << endl;
 #endif
 
 	KPilotSettings::writeConfig();
@@ -227,47 +219,68 @@
 class RestoreInfo
 {
 public:
-	struct db DBInfo;
+	struct DBInfo DBInfo;
 	QString path;
 } ;
 
-class RestoreAction::RestoreActionPrivate
+class RestoreAction::Private
 {
 public:
-	QString fDatabaseDir;
-	QValueList<RestoreInfo *> fDBList;
+	QString fPreferRestoreDir; /**< Preference setting where to get data from. */
+
+	QValueList<RestoreInfo> fDBList;
 	QTimer fTimer;
-	QValueList<RestoreInfo *>::ConstIterator fDBIterator;
+	QValueList<RestoreInfo>::ConstIterator fDBIterator;
 	int fDBIndex;
 };
 
 
-RestoreAction::RestoreAction(KPilotDeviceLink * p, QWidget * visible ) :
+RestoreAction::RestoreAction(KPilotLink * p, QWidget * visible ) :
 	SyncAction(p, visible, "restoreAction")
 {
 	FUNCTIONSETUP;
 
-	fP = new RestoreActionPrivate;
-	fP->fDatabaseDir = KGlobal::dirs()->saveLocation("data",
-		CSL1("kpilot/DBBackup/"));
+	fP = new Private;
 }
 
+void RestoreAction::setDirectory( const QString &path )
+{
+	fP->fPreferRestoreDir = path;
+}
+
 /* virtual */ bool RestoreAction::exec()
 {
 	FUNCTIONSETUP;
 
+	QString dirname;
+	if (fP->fPreferRestoreDir.isEmpty())
+	{
+		dirname = PilotLocalDatabase::getDBPath();
+	}
+	else
+	{
+		dirname = fP->fPreferRestoreDir;
+	}
+
 #ifdef DEBUG
-	DEBUGDAEMON << fname
-		<< ": Restoring from base directory "
-		<< *(PilotLocalDatabase::getDBPath()) << endl;
+	DEBUGKPILOT << fname << ": Restoring user " << dirname << endl;
 #endif
 
-	QString dirname = *(PilotLocalDatabase::getDBPath());
+	QDir dir(dirname, QString::null, QDir::Name,
+		QDir::Files | QDir::Readable | QDir::NoSymLinks);
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Restoring user " << dirname << endl;
-#endif
+	if (!dir.exists())
+	{
+		kdWarning() << k_funcinfo
+			<< ": Restore directory "
+			<< dirname << " does not exist." << endl;
+		fActionStatus = Error;
+		addSyncLogEntry(i18n("Restore directory does not exist.") +
+			CSL1(" ") + i18n("Restore not performed."));
+		return false;
+	}
 
+	dirname = dir.absPath();
 	if (questionYesNo(i18n("<qt>Are you sure you want to completely "
 				"restore your Pilot from the backup directory "
 				"(<i>%1</i>)? This will erase any information "
@@ -279,119 +292,61 @@
 
 		addSyncLogEntry(i18n("Canceled by user.") + CSL1(" ") +
 			i18n("Restore not performed."));
-		emit syncDone(this);
 
+		// You might call this an error, but that causes
+		// a frightening message in the log .. and the
+		// user already _knows_ the restore didn't happen.
+		// So instead, act as if everything was ok.
+		delayDone();
 		return true;
 	}
 
-	QDir dir(dirname, QString::null, QDir::Name,
-		QDir::Files | QDir::Readable | QDir::NoSymLinks);
 
-	if (!dir.exists())
-	{
-		kdWarning() << k_funcinfo
-			<< ": Restore directory "
-			<< dirname << " does not exist." << endl;
-		fActionStatus = Error;
-		addSyncLogEntry(i18n("Restore directory does not exist.") +
-			CSL1(" ") + i18n("Restore not performed."));
-		return false;
-	}
-
 	emit logProgress(i18n("Restoring %1...").arg(QString::null),1);
 
 	for (unsigned int i = 0; i < dir.count(); i++)
 	{
 		QString s;
-		RestoreInfo *dbi;
-		struct DBInfo info;
-		struct pi_file *f;
+		RestoreInfo info;
 
-		s = dir[i];
+		s = dirname + QDir::separator() + dir[i];
 
-#ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGKPILOT << fname
 			<< ": Adding " << s << " to restore list." << endl;
-#endif
 
-    char * fileName = qstrdup( QFile::encodeName(dirname + s) );
-    f = pi_file_open( fileName );
-    delete fileName;
-		if (!f)
+		if ( PilotLocalDatabase::infoFromFile( s, &info.DBInfo ) )
 		{
-			kdWarning() << k_funcinfo
-				<< ": Can't open " << s << endl;
-			logMessage(i18n("File '%1' cannot be read.").arg(s));
-			continue;
+			info.path = s;
+			fP->fDBList.append(info);
 		}
-
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-		if (!pi_file_get_info(f, &info))
-#else
-		pi_file_get_info(f,&info);
-		if (true)
-#endif
-		{
-			dbi = new RestoreInfo;
-			memcpy(&dbi->DBInfo,&info,sizeof(struct DBInfo));
-			dbi->path = dirname + s;
-			fP->fDBList.append(dbi);
-		}
 		else
 		{
 			kdWarning() << k_funcinfo
 				<< ": Can't open " << s << endl;
 			logMessage(i18n("File '%1' cannot be read.").arg(s));
 		}
-
-		pi_file_close(f);
-		f = 0L;
 	}
 
 	fP->fDBIndex = 0;
 	fP->fDBIterator = fP->fDBList.begin();
-	fActionStatus = GettingFileInfo;
+	fActionStatus = InstallingFiles;
 
 	QObject::connect(&(fP->fTimer), SIGNAL(timeout()),
-		this, SLOT(getNextFileInfo()));
+		this, SLOT(installNextFile()));
 
 	fP->fTimer.start(0, false);
 	return true;
 }
 
-/* slot */ void RestoreAction::getNextFileInfo()
-{
-	FUNCTIONSETUP;
-
-	Q_ASSERT(fActionStatus == GettingFileInfo);
-
-	QObject::disconnect(&(fP->fTimer), SIGNAL(timeout()),
-		this, SLOT(getNextFileInfo()));
-	fP->fTimer.stop();
-
-	qBubbleSort(fP->fDBList);
-
-	fP->fDBIndex = 0;
-	fP->fDBIterator = fP->fDBList.begin();
-	fActionStatus = InstallingFiles;
-
-	QObject::connect(&(fP->fTimer), SIGNAL(timeout()),
-		this, SLOT(installNextFile()));
-	fP->fTimer.start(0, false);
-}
-
 /* slot */ void RestoreAction::installNextFile()
 {
 	FUNCTIONSETUP;
 
 	Q_ASSERT(fActionStatus == InstallingFiles);
 
-	const RestoreInfo *dbi = 0L;
 
 	if (fP->fDBIterator == fP->fDBList.end())
 	{
-		QObject::disconnect(&(fP->fTimer), SIGNAL(timeout()),
-			this, SLOT(getNextFileInfo()));
 		fP->fTimer.stop();
 
 		fActionStatus = Done;
@@ -400,13 +355,12 @@
 		return;
 	}
 
-	dbi = *fP->fDBIterator;
+	const RestoreInfo dbi = *(fP->fDBIterator);
 	++(fP->fDBIterator);
 	++(fP->fDBIndex);
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Trying to install " << dbi->path << endl;
-#endif
 
+	DEBUGKPILOT << fname << ": Trying to install " << dbi.path << endl;
+
 	if (openConduit() < 0)
 	{
 		kdWarning() << k_funcinfo
@@ -418,38 +372,18 @@
 		return;
 	}
 
-	QFileInfo databaseInfo(dbi->path);
+	QFileInfo databaseInfo(dbi.path);
 	addSyncLogEntry(databaseInfo.fileName());
 	emit logProgress(i18n("Restoring %1...").arg(databaseInfo.fileName()),
 		(100*fP->fDBIndex) / (fP->fDBList.count()+1)) ;
 
-	char * fileName = qstrdup( dbi->path.utf8() );
-	pi_file *f  = pi_file_open( fileName );
-	delete fileName;
-
-	if (!f)
+	if ( !deviceLink()->installFiles( dbi.path, false /* don't delete */ ) )
 	{
 		kdWarning() << k_funcinfo
-			<< ": Can't open "
-			<< dbi->path << " for restore." << endl;
-		logError(i18n("Cannot open file `%1' for restore.")
-			.arg(databaseInfo.fileName()));
-		return;
-	}
-
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	if (pi_file_install(f, pilotSocket(), 0) < 0)
-#else
-	if (pi_file_install(f, pilotSocket(), 0, NULL) < 0)
-#endif
-	{
-		kdWarning() << k_funcinfo
-			<< ": Couldn't  restore " << dbi->path << endl;
+			<< ": Couldn't  restore " << dbi.path << endl;
 		logError(i18n("Cannot restore file `%1'.")
 			.arg(databaseInfo.fileName()));
 	}
-
-	pi_file_close(f);
 }
 
 /* virtual */ QString RestoreAction::statusString() const
Index: kpilot/kpilot/dbviewerWidget.cc
===================================================================
--- kpilot/kpilot/dbviewerWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/dbviewerWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -184,7 +184,7 @@
 		currentDB.remove( QRegExp(CSL1(".(pdb|PDB)$")) );
 
 		fDB=new PilotLocalDatabase(dbPath(), currentDB, false);
-		if (!fDB || !fDB->isDBOpen())
+		if (!fDB || !fDB->isOpen())
 		{
 			fDBInfo->setText(i18n("<B>Warning:</B> Cannot read "
 				"database file %1.").arg(currentDB));
@@ -310,7 +310,8 @@
 void GenericDBWidget::slotAddRecord()
 {
 	FUNCTIONSETUP;
-	PilotRecord*rec=new PilotRecord(0L, 0, 0, 0, 0);
+	pi_buffer_t *b = pi_buffer_new(0);
+	PilotRecord *rec=new PilotRecord(b, 0, 0, 0);
 	PilotListViewItem*item=new PilotListViewItem(fRecordList,
 		QString::number(-1), QString::number(rec->size()),
 		QString::number(rec->id()), QString::null,
Index: kpilot/kpilot/listItems.cc
===================================================================
--- kpilot/kpilot/listItems.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/listItems.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,9 +27,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *listitems_id =
-	"$Id$";
-
 #include "options.h"
 
 
@@ -68,7 +65,6 @@
 	if (!(count & 0xff))
 		counts();
 #endif
-	(void) listitems_id;
 }
 
 PilotListItem::~PilotListItem()
@@ -110,7 +106,6 @@
 	if (!(count & 0xff))
 		counts();
 #endif
-	(void) listitems_id;
 }
 
 PilotCheckListItem::~PilotCheckListItem()
@@ -164,7 +159,6 @@
 	if (!(count & 0xff))
 		counts();
 #endif
-	(void) listitems_id;
 }
 
 PilotListViewItem::~PilotListViewItem()
Index: kpilot/kpilot/internalEditorAction.cc
===================================================================
--- kpilot/kpilot/internalEditorAction.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/internalEditorAction.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,7 +52,7 @@
 using namespace KHE;
 #endif
 
-InternalEditorAction::InternalEditorAction(KPilotDeviceLink * p) :
+InternalEditorAction::InternalEditorAction(KPilotLink * p) :
 	SyncAction(p, "internalSync")
 {
 	FUNCTIONSETUP;
@@ -97,8 +97,8 @@
 
 	PilotRecord*rec=0L;
 	PilotLocalDatabase*localDB=new PilotLocalDatabase(*dbIter, false);
-	PilotSerialDatabase*serialDB=new PilotSerialDatabase(pilotSocket(), *dbIter);
-	if (!localDB->isDBOpen() || !serialDB->isDBOpen())
+	PilotDatabase *serialDB= deviceLink()->database(*dbIter);
+	if (!localDB->isOpen() || !serialDB->isOpen())
 	{
 		emit logError(i18n("Unable to open the serial or local database for %1. "
 			"Skipping it.").arg(*dbIter));
@@ -337,7 +337,7 @@
 return;
 
 	PilotLocalDatabase*localDB=new PilotLocalDatabase(*dbIter, false);
-	PilotSerialDatabase*serialDB=new PilotSerialDatabase(pilotSocket(), *dbIter);
+	PilotDatabase *serialDB=deviceLink()->database(*dbIter);
 
 	// open the local and the serial database and copy the flags over
 	// TODO: Implement the copying
@@ -374,7 +374,7 @@
 #endif
 
 	PilotLocalDatabase*localDB=new PilotLocalDatabase(*dbIter, false);
-	PilotSerialDatabase*serialDB=new PilotSerialDatabase(pilotSocket(), *dbIter);
+	PilotDatabase *serialDB=deviceLink()->database(*dbIter);
 
 	unsigned char*appBlock=new unsigned char[0xFFFF];
 	int len=localDB->readAppBlock(appBlock, 0xFFFF);
Index: kpilot/kpilot/pilotDaemonDCOP.h
===================================================================
--- kpilot/kpilot/pilotDaemonDCOP.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/pilotDaemonDCOP.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -55,8 +55,6 @@
 	*/
 	virtual ASYNC requestSyncType(QString) = 0;
 	/** Shortcut for using requestSync(1) */
-	virtual ASYNC requestFastSyncNext() = 0;
-	/** Shortcut for using requestSync(2) */
 	virtual ASYNC requestRegularSyncNext() = 0;
 	/** Query what type is set most recently. */
 	virtual int nextSyncType() const = 0;
Index: kpilot/kpilot/logWidget.cc
===================================================================
--- kpilot/kpilot/logWidget.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/logWidget.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,8 +26,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org.
 */
-static const char *logw_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -211,7 +209,6 @@
 		grid->addColSpacing(3,10);
 	}
 
-	(void) logw_id;
 }
 
 void LogWidget::addMessage(const QString & s)
Index: kpilot/kpilot/CMakeLists.txt
===================================================================
--- kpilot/kpilot/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/kpilot/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,167 @@
+link_directories(${CMAKE_BINARY_DIR}/lib ${CMAKE_CURRENT_BINARY_DIR})
+
+set(settings_SRC
+	kpilotConfig.cc
+)
+
+kde3_add_kcfg_files(settings_SRC kpilotSettings.kcfgc)
+
+set(shared_SRCS
+	${settings_SRC}
+	syncStack.cc
+	hotSync.cc
+	interactiveSync.cc
+	logWidget.cc
+	pilotComponent.cc
+)
+
+set(shared_STUBS
+	loggerDCOP.h
+)
+
+kde3_add_dcop_skels(shared_SRCS ${shared_STUBS})
+kde3_add_dcop_stubs(shared_SRCS ${shared_STUBS})
+
+set(kcmpilot_SRCS
+	${settings_SRC}
+	kpilotConfigWizard.cc
+	dbSelectionDialog.cc
+	kpilotConfigDialog.cc
+	conduitConfigDialog.cc
+	kpilotProbeDialog.cc
+)
+
+set(kcmpilot_KCFGS
+	kpilotConfigWizard_address.kcfgc
+	kpilotConfigWizard_notes.kcfgc
+	kpilotConfigWizard_vcal.kcfgc
+)
+
+set(kcmpilot_UIS
+	kpilotConfigDialog_device.ui
+	kpilotConfigDialog_sync.ui
+	kpilotConfigDialog_startup.ui
+	kpilotConfigDialog_viewers.ui
+	kpilotConfigDialog_backup.ui
+	kpilotConfigWizard_user.ui
+	kpilotConfigWizard_app.ui
+	dbSelection_base.ui
+)
+
+set(kcmpilot_STUBS
+	pilotDaemonDCOP.h
+)
+
+# Don't forget to include output directory, otherwise
+# the UI file won't be wrapped!
+include_directories(
+	${CMAKE_BINARY_DIR}/lib
+	${CMAKE_SOURCE_DIR}/lib
+	${CMAKE_CURRENT_BINARY_DIR}
+)
+
+kde3_add_ui_files(kcmpilot_SRCS ${kcmpilot_UIS})
+kde3_add_kcfg_files(kcmpilot_SRCS ${kcmpilot_KCFGS})
+kde3_add_dcop_skels(kcmpilot_SRCS ${kcmpilot_STUBS})
+kde3_add_dcop_stubs(kcmpilot_SRCS ${kcmpilot_STUBS})
+kde3_automoc(${kcmpilot_SRCS})
+
+# Now add these generated files to the ADD_LIBRARY step
+# If this is NOT done, then the ui_*.h files will not be generated
+add_library(kcm_kpilot SHARED ${kcmpilot_SRCS})
+set_target_properties(kcm_kpilot PROPERTIES LOCATION ${KDE3_PLUGIN_INSTALL_DIR}
+	PREFIX ""
+)
+
+set(kpilotTest_SRCS
+	${shared_SRCS}	
+	main-test.cc
+)
+
+kde3_automoc(${kpilotTest_SRCS})
+add_executable(kpilotTest ${kpilotTest_SRCS})
+target_link_libraries(kpilotTest ${QT_LIBRARIES} kpilot)
+kpilot_rpath(kpilotTest)
+
+set(kpilotDaemon_SRCS
+	${shared_SRCS}
+	fileInstaller.cc
+	internalEditorAction.cc
+	logFile.cc
+	pilotDaemon.cc
+)
+
+set(kpilot_STUBS
+	kpilotDCOP.h
+	pilotDaemonDCOP.h
+)
+
+kde3_add_dcop_skels(kpilotDaemon_SRCS ${kpilot_STUBS})
+kde3_add_dcop_stubs(kpilotDaemon_SRCS ${kpilot_STUBS})
+kde3_automoc(${kpilotDaemon_SRCS})
+add_executable(kpilotDaemon ${kpilotDaemon_SRCS})
+target_link_libraries(kpilotDaemon ${QT_LIBRARIES} kpilot)
+kpilot_rpath(kpilotDaemon)
+
+set(kpilot_SRCS
+	${shared_SRCS}
+	kpilot.cc
+	dbviewerWidget.cc
+	dbFlagsEditor.cc
+	dbRecordEditor.cc
+	dbAppInfoEditor.cc
+	memoWidget.cc
+	addressWidget.cc
+	addressEditor.cc
+	datebookWidget.cc
+	todoWidget.cc
+	todoEditor.cc
+	fileInstaller.cc
+	fileInstallWidget.cc
+	listItems.cc
+)
+
+set(kpilot_UIS
+	dbFlagsEditor_base.ui
+	todoEditor_base.ui
+)
+
+kde3_add_ui_files(kpilot_SRCS ${kpilot_UIS})
+kde3_add_dcop_skels(kpilot_SRCS ${kpilot_STUBS})
+kde3_add_dcop_stubs(kpilot_SRCS ${kpilot_STUBS})
+kde3_automoc(${kpilot_SRCS})
+add_executable(kpilot_bin ${kpilot_SRCS})
+target_link_libraries(kpilot_bin ${QT_LIBRARIES} kpilot kutils)
+kpilot_rpath(kpilot_bin)
+set_target_properties(kpilot_bin PROPERTIES 
+	OUTPUT_NAME kpilot
+)
+
+######################### INSTALL STUFF #######################################
+
+kde3_install_libtool_file(kcm_kpilot)
+
+install(
+	TARGETS kcm_kpilot kpilot_bin kpilotDaemon
+	LIBRARY DESTINATION ${KDE3_PLUGIN_INSTALL_DIR}
+	RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
+	RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
+)
+
+install(
+	FILES kpilot.desktop DESTINATION ${CMAKE_INSTALL_PREFIX}/share
+)
+
+install(
+	FILES kpilotdaemon.desktop DESTINATION ${KDE3_XDG_APPS_DIR}
+)
+
+install(
+	FILES kpilotconduit.desktop DESTINATION ${KDE3_SERVICETYPES_DIR}
+)
+
+install(
+	FILES kpilot_config.desktop DESTINATION ${KDE3_SERVICES_DIR}
+)
+
+add_subdirectory(Icons)
Index: kpilot/kpilot/dbFlagsEditor_base.ui
===================================================================
--- kpilot/kpilot/dbFlagsEditor_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/dbFlagsEditor_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -370,9 +370,7 @@
 </tabstops>
 <includes>
     <include location="local" impldecl="in implementation">dbFlagsEditor_base.ui.h</include>
+    <include location="system" impldecl="in implementation">kdatewidget.h</include>
 </includes>
 <layoutdefaults spacing="6" margin="11"/>
-<includehints>
-    <includehint>kdatewidget.h</includehint>
-</includehints>
 </UI>
Index: kpilot/kpilot/addressEditor.h
===================================================================
--- kpilot/kpilot/addressEditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/addressEditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -19,7 +19,7 @@
 **
 ** You should have received a copy of the GNU General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -32,22 +32,23 @@
 
 #include <kdialogbase.h>
 
+#include <pilotAddress.h>
+
 class QLineEdit;
 class PilotAddress;
-struct AddressAppInfo;
 
-class AddressEditor : public KDialogBase 
+class AddressEditor : public KDialogBase
 {
 	Q_OBJECT
 
 
 public:
 	AddressEditor(PilotAddress *address,
-		struct AddressAppInfo *appInfo,
+		PilotAddressInfo *appInfo,
 		QWidget *parent, const char *name=0L);
 	~AddressEditor();
 
- 
+
 signals:
 	void recordChangeComplete ( PilotAddress* );
 
@@ -60,7 +61,7 @@
 	bool fDeleteOnCancel;
 
 	PilotAddress* fAddress;
-	struct AddressAppInfo *fAppInfo;
+	PilotAddressInfo *fAppInfo;
 	// entry fields
 	QLineEdit *fCustom4Field;
 	QLineEdit *fCustom3Field;
@@ -78,7 +79,7 @@
 	QLineEdit *fLastNameField;
 	// phone labels (changing!)
 	QLabel    *m_phoneLabel[5];
-	
+
 	void initLayout();
 	void fillFields();
 	QString phoneLabelText(PilotAddress *, int i);
Index: kpilot/kpilot/kpilotConfigWizard.cc
===================================================================
--- kpilot/kpilot/kpilotConfigWizard.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotConfigWizard.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,9 +26,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *conduitconfigwizard_id =
-	"$Id$";
-
 //#include "options.h"
 
 #include <qpushbutton.h>
@@ -78,7 +75,6 @@
 	page2->fDeviceName->setText( KPilotSettings::pilotDevice() );
 	page2->fPilotRunningPermanently->setChecked( KPilotSettings::startDaemonAtLogin() );
 
-	(void) conduitconfigwizard_id;
 }
 
 ConfigWizard::~ConfigWizard()
@@ -100,7 +96,7 @@
 	app=(eSyncApp)( page3->fAppType->selectedId() );
 	bool keepPermanently( page2->fPilotRunningPermanently->isChecked() );
 #ifdef DEBUG
-	DEBUGCONDUIT<<fname<<"Keep permanently: "<<keepPermanently<<endl;
+	DEBUGKPILOT<<fname<<"Keep permanently: "<<keepPermanently<<endl;
 #endif
 
 	KPilotSettings::setPilotDevice( devicename );
Index: kpilot/kpilot/conduitConfigDialog.cc
===================================================================
--- kpilot/kpilot/conduitConfigDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/conduitConfigDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,9 +28,6 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
-static const char *conduitconfigdialog_id =
-	"$Id$";
-
 #include "options.h"
 
 #include <qlistview.h>
@@ -78,11 +75,13 @@
 {
 	KDE_EXPORT KCModule *create_kpilotconfig( QWidget *parent, const char * )
 	{
+		FUNCTIONSETUP;
 		return new ConduitConfigWidget( parent, "kcmkpilotconfig" );
 	}
 
 	KDE_EXPORT ConfigWizard *create_wizard(QWidget *parent, int m)
 	{
+		FUNCTIONSETUP;
 		return new ConfigWizard(parent,"Wizard", m);
 	}
 }
@@ -217,6 +216,8 @@
 	fConfigureKontact(0L),
 	fActionDescription(0L)
 {
+	FUNCTIONSETUP;
+
 	QWidget *w = 0L; // For spacing purposes only.
 	QHBox *btns = 0L;
 
@@ -346,7 +347,6 @@
 	(void) new ConduitTip(fConduitList);
 	setButtons(Apply);
 
-	(void) conduitconfigdialog_id;
 }
 
 ConduitConfigWidget::~ConduitConfigWidget()
@@ -519,21 +519,25 @@
 		return;
 	}
 
+	QString libraryName = p->text(CONDUIT_LIBRARY);
+
 #ifdef DEBUG
 	DEBUGKPILOT << fname
 		<< ": Executing conduit "
 		<< p->text(CONDUIT_NAME)
+		<< " (library " << libraryName << ")"
 		<< endl;
 #endif
 
-	if (p->text(CONDUIT_LIBRARY).isEmpty())
+
+	if (libraryName.isEmpty())
 	{
 		fStack->raiseWidget(BROKEN_CONDUIT);
 		warnNoExec(p);
 		return;
 	}
 
-	if (p->text(CONDUIT_LIBRARY).startsWith(CSL1("internal_")))
+	if (libraryName.startsWith(CSL1("internal_")))
 	{
 		fStack->raiseWidget(INTERNAL_CONDUIT);
 		fActionDescription->setText(
@@ -544,18 +548,18 @@
 		return;
 	}
 
-	if (p->text(CONDUIT_LIBRARY) == CSL1("expln_conduits"))
+	if (libraryName == CSL1("expln_conduits"))
 	{
 		fStack->raiseWidget(CONDUIT_EXPLN);
 		return;
 	}
-	if (p->text(CONDUIT_LIBRARY) == CSL1("expln_general"))
+	if (libraryName == CSL1("expln_general"))
 	{
 		fStack->raiseWidget(GENERAL_EXPLN);
 		return;
 	}
 
-	if (p->text(CONDUIT_LIBRARY) == CSL1("general_about"))
+	if (libraryName == CSL1("general_about"))
 	{
 		fStack->raiseWidget(GENERAL_ABOUT);
 		return;
@@ -564,13 +568,13 @@
 	QObject *o = 0L;
 
 	// Page 4: General setup
-	if (p->text(CONDUIT_LIBRARY).startsWith(CSL1("general_")))
+	if (libraryName.startsWith(CSL1("general_")))
 	{
 		o = handleGeneralPages(fStack,p);
 	}
 	else
 	{
-		QCString library = QFile::encodeName(p->text(CONDUIT_LIBRARY));
+		QCString library = QFile::encodeName(libraryName);
 
 		KLibFactory *f = KLibLoader::self()->factory(library);
 		if (!f)
@@ -578,7 +582,9 @@
 #ifdef DEBUG
 			DEBUGKPILOT << fname
 				<< ": No conduit library "
-				<< library
+				<< library.data()
+				<< " [" << library.size() << "]"
+				<< " (" << libraryName << ")"
 				<< " found."
 				<< endl;
 #endif
Index: kpilot/kpilot/interactiveSync.h
===================================================================
--- kpilot/kpilot/interactiveSync.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/interactiveSync.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,6 +4,7 @@
 **
 ** Copyright (C) 2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 ** This file specializes SyncAction to a kind that can have interaction
 ** with the user without the Sync timing out.
@@ -38,7 +39,7 @@
 class CheckUser : public SyncAction
 {
 public:
-	CheckUser(KPilotDeviceLink *p,QWidget *w=0L);
+	CheckUser(KPilotLink *p,QWidget *w=0L);
 	virtual ~CheckUser();
 
 protected:
@@ -49,26 +50,31 @@
 {
 Q_OBJECT
 public:
-	RestoreAction(KPilotDeviceLink *,QWidget *w=0L);
+	RestoreAction(KPilotLink *,QWidget *w=0L);
 
 	typedef enum { InstallingFiles, GettingFileInfo,Done } Status;
 	virtual QString statusString() const;
 
+	/** By default, a path based on the user name (either
+	*   on the handheld or set in KPilot) is used to
+	*   determine the restory directory name ( generally
+	*   $KDEHOME/share/apps/kpilot/DBBackup/_user_name_ ).
+	*   Use setDirectory() to change that and use a given
+	*   @p path as target for the source. Use an empty
+	*   @p path to restore the default behavior of using
+	*   the username.
+	*/
+	void setDirectory( const QString &path );
+
 protected:
 	virtual bool exec();
 
 protected slots:
-	void getNextFileInfo();
 	void installNextFile();
 
 private:
-	// Use a private-d pointer for once (well, in KPilot
-	// parlance it'd be fd, which is confusing, so it's
-	// become a private fP) since we need QList or QPtrList.
-	//
-	//
-	class RestoreActionPrivate;
-	RestoreActionPrivate *fP;
+	class Private;
+	Private *fP;
 } ;
 
 #endif
Index: kpilot/kpilot/todoEditor.cc
===================================================================
--- kpilot/kpilot/todoEditor.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/todoEditor.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,8 +43,6 @@
 #include "todoEditor_base.h"
 #include "todoEditor.moc"
 
-static const char *todoEditor_id =
-	"$Id$";
 
 TodoEditor::TodoEditor(PilotTodoEntry * p, struct ToDoAppInfo *appInfo,
 	QWidget * parent, const char *name) :
@@ -62,7 +60,6 @@
 	connect(parent, SIGNAL(recordChanged(PilotTodoEntry *)),
 		this, SLOT(updateRecord(PilotTodoEntry *)));
 
-	(void) todoEditor_id;
 }
 
 TodoEditor::~TodoEditor()
@@ -149,7 +146,6 @@
 	fTodo->setNote(fWidget->fNote->text());
 
 	emit(recordChangeComplete(fTodo));
-	fDeleteOnCancel = false;
 	KDialogBase::slotOk();
 }
 
Index: kpilot/kpilot/kroupware.cc
===================================================================
--- kpilot/kpilot/kroupware.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kroupware.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,15 +40,12 @@
 #include "kroupware.h"
 #include "kpilotConfig.h"
 
-static const char *kroupware_id =
-	"$Id$";
-
 KroupwareSync::KroupwareSync(bool pre,int parts,KPilotDeviceLink *p) :
 	SyncAction(p,pre ? "KroupwarePreSync" : "KroupwarePostSync"),
 	fPre(pre),
 	fParts(parts)
 {
-	(void) kroupware_id;
+
 }
 
 /* virtual */ bool KroupwareSync::exec()
Index: kpilot/kpilot/kpilotConfigDialog_backup.ui
===================================================================
--- kpilot/kpilot/kpilotConfigDialog_backup.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilotConfigDialog_backup.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,4 @@
-<!DOCTYPE UI><UI version="3.2" stdsetdef="1">
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
 <class>BackupConfigWidget</class>
 <comment>A widget for editing HotSync-specific settings.</comment>
 <author>David Bishop</author>
@@ -10,22 +10,80 @@
         <rect>
             <x>0</x>
             <y>0</y>
-            <width>593</width>
-            <height>328</height>
+            <width>549</width>
+            <height>424</height>
         </rect>
     </property>
     <property name="caption">
         <string>KPilot Options</string>
     </property>
-    <grid>
+    <vbox>
         <property name="name">
             <cstring>unnamed</cstring>
         </property>
-        <property name="margin">
-            <number>0</number>
-        </property>
-        <widget class="QGroupBox" row="0" column="0">
+        <widget class="QGroupBox">
             <property name="name">
+                <cstring>GroupBox23_2</cstring>
+            </property>
+            <property name="title">
+                <string>Backup Frequency</string>
+            </property>
+            <hbox>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QLabel">
+                    <property name="name">
+                        <cstring>TextLabel5_2</cstring>
+                    </property>
+                    <property name="sizePolicy">
+                        <sizepolicy>
+                            <hsizetype>5</hsizetype>
+                            <vsizetype>5</vsizetype>
+                            <horstretch>0</horstretch>
+                            <verstretch>0</verstretch>
+                        </sizepolicy>
+                    </property>
+                    <property name="minimumSize">
+                        <size>
+                            <width>100</width>
+                            <height>0</height>
+                        </size>
+                    </property>
+                    <property name="text">
+                        <string>Do &amp;backup:</string>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>fBackupFrequency</cstring>
+                    </property>
+                </widget>
+                <widget class="QComboBox">
+                    <item>
+                        <property name="text">
+                            <string>On every HotSync</string>
+                        </property>
+                    </item>
+                    <item>
+                        <property name="text">
+                            <string>On request only</string>
+                        </property>
+                    </item>
+                    <property name="name">
+                        <cstring>fBackupFrequency</cstring>
+                    </property>
+                    <property name="sizePolicy">
+                        <sizepolicy>
+                            <hsizetype>7</hsizetype>
+                            <vsizetype>0</vsizetype>
+                            <horstretch>0</horstretch>
+                            <verstretch>0</verstretch>
+                        </sizepolicy>
+                    </property>
+                </widget>
+            </hbox>
+        </widget>
+        <widget class="QGroupBox">
+            <property name="name">
                 <cstring>GroupBox23</cstring>
             </property>
             <property name="title">
@@ -39,6 +97,12 @@
                     <property name="name">
                         <cstring>TextLabel5</cstring>
                     </property>
+                    <property name="minimumSize">
+                        <size>
+                            <width>100</width>
+                            <height>0</height>
+                        </size>
+                    </property>
                     <property name="text">
                         <string>&amp;No backup:</string>
                     </property>
@@ -53,6 +117,12 @@
                     <property name="name">
                         <cstring>TextLabel6</cstring>
                     </property>
+                    <property name="minimumSize">
+                        <size>
+                            <width>100</width>
+                            <height>0</height>
+                        </size>
+                    </property>
                     <property name="text">
                         <string>Not &amp;restored:</string>
                     </property>
@@ -103,20 +173,20 @@
                 </widget>
             </grid>
         </widget>
-        <widget class="QCheckBox" row="1" column="0">
+        <widget class="QCheckBox">
             <property name="name">
                 <cstring>fRunConduitsWithBackup</cstring>
             </property>
             <property name="text">
-                <string>Run &amp;conduits during a backup sync</string>
+                <string>Run conduits durin&amp;g a backup sync</string>
             </property>
             <property name="whatsThis" stdset="0">
                 <string>&lt;qt&gt;Check this box to run the selected conduits before every backup. This makes sure the backup is up to date with the last changes from your PC.&lt;/qt&gt;</string>
             </property>
         </widget>
-        <spacer row="2" column="0">
+        <spacer>
             <property name="name">
-                <cstring>spacer3</cstring>
+                <cstring>spacer8</cstring>
             </property>
             <property name="orientation">
                 <enum>Vertical</enum>
@@ -127,11 +197,11 @@
             <property name="sizeHint">
                 <size>
                     <width>20</width>
-                    <height>131</height>
+                    <height>41</height>
                 </size>
             </property>
         </spacer>
-    </grid>
+    </vbox>
 </widget>
 <layoutdefaults spacing="6" margin="11"/>
 </UI>
Index: kpilot/kpilot/kpilot.kcfg
===================================================================
--- kpilot/kpilot/kpilot.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/kpilot/kpilot.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -108,13 +108,17 @@
     </entry>
     <entry name="SkipBackupDB" type="StringList">
         <label>Which databases not to backup.</label>
-        <default>[Arng],[PmDB],[lnch],[a86k],FATFS,ImgFile-Foto,Jpeg-Foto</default>
+        <default>[Arng],[PmDB],[lnch],[a86k],FATFS,ImgFile-Foto,Jpeg-Foto,WifiCoreLib</default>
     </entry>
     <entry name="SkipRestoreDB" type="StringList">
         <label>
         </label>
         <default>[AvGo]</default>
     </entry>
+    <entry name="BackupFrequency" type="UInt">
+        <label></label>
+        <default>0</default>
+    </entry>
     <entry name="RunConduitsWithBackup" type="Bool">
         <label></label>
         <default>false</default>

Zmiany atrybutów dla: kpilot/kpilot
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
   + .deps
.libs
Makefile
Makefile.in
*.moc
kpilotConfigDialog_*
kpilotConfigWizard_*
dbFlagsEditor_base.h
dbFlagsEditor_base.cc
todoEditor_base.h
todoEditor_base.cc
dbSelection_base.h
dbSelection_base.cc
kpilotDaemon
kpilot
kpilotTest
kpilotSettings.cc
kpilotSettings.h
*_skel.h
*_stub.h
*_skel.cc
*_stub.cc
*.kidl


Index: kpilot/tests/testconstants.cc
===================================================================
--- kpilot/tests/testconstants.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testconstants.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,68 @@
+/* testconstants KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
+**
+** Checks that various data structures are sized properly.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include "pilot.h"
+#include "pilotAppInfo.h"
+
+#include <pi-appinfo.h>
+
+int main(int, char **)
+{
+#ifdef DEBUG
+	debug_level = 1;
+#endif
+	PilotAppInfoBase info( 0L );
+
+
+	kdDebug() << "### testconstants\n#" << endl;
+	kdDebug() << "# Sizes of structures\n#" << endl;
+	kdDebug() << "#     AppInfoBase: " << sizeof(PilotAppInfoBase) << endl;
+	kdDebug() << "#    CategoryInfo: " << sizeof(info.categoryInfo()) << endl;
+	kdDebug() << "#    CategoryInfo: " << sizeof(*info.categoryInfo()) << endl;
+	kdDebug() << "#  Category names: " << sizeof(info.categoryInfo()->name) << endl;
+	kdDebug() << "# Single category: " << sizeof(info.categoryInfo()->name[0]) << endl;
+
+	kdDebug() << "#\n# Sanity checking structure sizes\n#" << endl;
+	if ( sizeof(info.categoryInfo()->name[0]) != Pilot::CATEGORY_SIZE )
+	{
+		kdDebug() << "! Category names are not 16 bytes." << endl;
+		return 1;
+	}
+	if ( sizeof(info.categoryInfo()->name) / sizeof(info.categoryInfo()->name[0]) != Pilot::CATEGORY_COUNT )
+	{
+		kdDebug() << "! There are not " << Pilot::CATEGORY_COUNT << " categories available." << endl;
+		return 1;
+	}
+
+	kdDebug() << "# OK.\n" << endl;
+	return 0;
+}
+
+
Index: kpilot/tests/testactions.cc
===================================================================
--- kpilot/tests/testactions.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testactions.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,92 @@
+/* testactions			KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to sync actions.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+#include "syncAction.h"
+
+bool run_modes(bool test, bool local)
+{
+	bool ok = true;
+
+	kdDebug() << "***\n*** Sync Modes ("
+		<< ( test ? "" : "no")
+		<< "test, "
+		<< ( local ? "" : "no")
+		<< "local)\n***\n";
+
+
+	for (int m = (int)SyncAction::SyncMode::eHotSync;
+		m <= (int) SyncAction::SyncMode::eRestore ;
+		m++)
+	{
+		SyncAction::SyncMode mode((SyncAction::SyncMode::Mode)m,test,local);
+		kdDebug() << "* " << mode.name() << endl;
+		SyncAction::SyncMode mode2(mode.list());
+		if (!(mode==mode2)) {
+			kdDebug() << "E " << "Modes mismatch [" << mode.name() << "] ["
+				<< mode2.name() << "]" << endl;
+			ok = false;
+		}
+	}
+
+	return ok;
+}
+
+bool single_mode(int m, bool test, bool local)
+{
+	SyncAction::SyncMode mode((SyncAction::SyncMode::Mode)m,test,local);
+
+	kdDebug() << "* " << m << " " << test << " " << local << endl;
+
+	if ((mode.mode() == m) && (mode.isTest() == test) && (mode.isLocal() == local))
+	{
+		return true;
+	}
+	else
+	{
+		kdDebug() << "E " << "Modes mismatch " << m << " " << test << " " << local
+			<< "[" << mode.name() << "]" << endl;
+		return false;
+	}
+}
+
+int main(int argc, char **argv)
+{
+	if (!run_modes(false,false)) return 1;
+	if (!run_modes(false,true)) return 1;
+	if (!run_modes(true,false)) return 1;
+	if (!run_modes(true,true)) return 1;
+
+	kdDebug() << "***\n*** Sync Modes - misc\n***\n";
+	if (!single_mode(3,false,false)) return 1;
+	if (!single_mode(1,true,true)) return 1;
+
+	return 0;
+}
+
+
Index: kpilot/tests/importdatebook.cc
===================================================================
--- kpilot/tests/importdatebook.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/importdatebook.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,118 @@
+/* testaddresses			KPilot
+**
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to address database handling.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <kcmdlineargs.h>
+
+#include <libkcal/calendar.h>
+#include <libkcal/calendarlocal.h>
+
+#include "pilot.h"
+#include "pilotDateEntry.h"
+#include "pilotLocalDatabase.h"
+#include "../conduits/vcalconduit/vcalRecord.cc"
+
+static const KCmdLineOptions options[] =
+{
+	{"verbose", "Verbose output", 0},
+	{"data-dir <path>","Set data directory", "."},
+	{"vcal-file <path>","Set vcal file", 0},
+	KCmdLineLastOption
+};
+
+
+
+int main(int argc, char **argv)
+{
+	KAboutData aboutData("importdatebook","Import Date Book","0.1");
+	KCmdLineArgs::init(argc,argv,&aboutData);
+	KCmdLineArgs::addCmdLineOptions( options );
+
+	//  KApplication app( false, false );
+	KApplication app;
+
+	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+#ifdef DEBUG
+	debug_level= (args->isSet("verbose")) ? 4 : 0;
+#endif
+	QString datadir = args->getOption("data-dir");
+	QString vcalfile = args->getOption("vcal-file");
+
+	if (datadir.isEmpty())
+	{
+		kdWarning() << "! Must provide a data-directory." << endl;
+	}
+	if (vcalfile.isEmpty())
+	{
+		kdWarning() << "! Must provide a vcal-file to read." << endl;
+	}
+	if (datadir.isEmpty() || vcalfile.isEmpty())
+	{
+		return 1;
+	}
+
+	KCal::CalendarLocal *calendar = new KCal::CalendarLocal( QString() );
+	if (!calendar->load( vcalfile ))
+	{
+		return 1;
+	}
+
+	Pilot::setupPilotCodec( CSL1("Latin1") );
+
+	PilotLocalDatabase db( datadir, "DatebookDB" );
+	db.createDatabase( 0xdead, 0xbeef );
+	PilotDateInfo appInfo;
+	appInfo.writeTo(&db);
+
+	KCal::Event::List events = calendar->rawEvents();
+
+	for (KCal::Event::List::ConstIterator i = events.begin();
+		i != events.end(); ++i)
+	{
+		PilotDateEntry d(*appInfo.info());
+		memset(&d,0,sizeof(d));
+		if (VCalRecord::setDateEntry(&d,*i))
+		{
+			PilotRecord *r = d.pack();
+			if (r)
+			{
+				db.writeRecord(r);
+				delete r;
+			}
+		}
+	}
+
+	return 0;
+}
+
Index: kpilot/tests/conduits/vcalconduit/exampletest.cc
===================================================================
--- kpilot/tests/conduits/vcalconduit/exampletest.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/conduits/vcalconduit/exampletest.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,26 @@
+#include "options.h"
+#include "config.h"
+
+#include "exampletest.h"
+
+CPPUNIT_TEST_SUITE_REGISTRATION( VCalConduitTest );
+
+
+void VCalConduitTest::setUp()
+{
+	device = QString("testdevice");
+	link = new KPilotLocalLink(0, "localLink");
+	syncMode = SyncAction::SyncMode::eHotSync;
+}
+
+
+void VCalConduitTest::tearDown()
+{
+	delete link;
+}
+
+
+void VCalConduitTest::testConstructor()
+{
+	CPPUNIT_ASSERT( true == true );
+}
Index: kpilot/tests/conduits/vcalconduit/exampletest.h
===================================================================
--- kpilot/tests/conduits/vcalconduit/exampletest.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/conduits/vcalconduit/exampletest.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,28 @@
+#ifndef EXAMPLETEST_H
+#define EXAMPLETEST_H
+
+#include <cppunit/extensions/HelperMacros.h>
+#include <qstring.h>
+
+#include "kpilotlocallink.h"
+#include "syncAction.h"
+
+class VCalConduitTest : public CppUnit::TestFixture
+{
+  CPPUNIT_TEST_SUITE( VCalConduitTest );
+  CPPUNIT_TEST( testConstructor );
+  CPPUNIT_TEST_SUITE_END();
+
+private:
+	QString device;
+	KPilotLocalLink *link;
+	SyncAction::SyncMode::Mode syncMode;
+
+public:
+  void setUp();
+  void tearDown();
+
+  void testConstructor();
+};
+
+#endif
Index: kpilot/tests/main.cc
===================================================================
--- kpilot/tests/main.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/main.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,17 @@
+#include <cppunit/extensions/TestFactoryRegistry.h>
+#include <cppunit/ui/text/TestRunner.h>
+
+int main( int argc, char **argv)
+{
+	CppUnit::TestFactoryRegistry &registry =
+		CppUnit::TestFactoryRegistry::getRegistry();
+
+	CppUnit::TextUi::TestRunner runner;
+	runner.addTest( registry.makeTest() );
+
+	// Run the tests.
+	bool wasSucessful = runner.run();
+
+	// Return error code 1 if the one of test failed.
+	return wasSucessful ? 0 : 1;
+}
Index: kpilot/tests/testdatabase.cc
===================================================================
--- kpilot/tests/testdatabase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testdatabase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,315 @@
+/* testdatabase			KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to local databases.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <kcmdlineargs.h>
+
+#include "pilotLocalDatabase.h"
+#include "pilotRecord.h"
+#include "pilotMemo.h"
+
+
+/* Return values for the various check* functions. They
+   return OK if all is OK; ERR is for generic errors.
+   ERR_NO_EXIST is returned if something (usually a database
+   or other file) doesn't exist that should. The latter
+   error might be ignored.
+*/
+#define OK           (0)
+#define ERR          (1)
+#define ERR_NO_EXIST (2)
+
+
+/* Data about the records in a database. The id field is
+   interpreted specially for the first and last entries.
+*/
+typedef struct { int id,size; } recordInfo;
+
+/* Use END in the last recordInfo struct describing a database
+   to indicate you expect the database to end there. Use NO_EXIST
+   as the ID in the first struct to indicate that the database
+   is expected _not_ to exist.
+*/
+#define NO_EXIST   (-2)
+#define END        (-1)
+
+/* These tables of data are taken from various databases I have
+   (but which I cannot commit to SVN due to license issues).
+   The aesop listing is from an eBook of Aesop's fables.
+   The way to create these tables is to use a third-party
+   tool such as par to read the database:
+
+   ./par l /tmp/Aesop.pdb | awk '{print "{",$3,",",$4,"},";}'
+
+*/
+recordInfo nonexistent[] = {
+	{ NO_EXIST, 0 }
+} ;
+
+recordInfo aesop[] = {
+{ 7307264 , 214 },
+{ 7307265 , 1564 },
+{ 7307266 , 1575 },
+{ 7307267 , 2214 },
+{ 7307268 , 2276 },
+{ 7307269 , 2148 },
+{ 7307270 , 2194 },
+{ 7307271 , 2178 },
+{ 7307272 , 2220 },
+{ 7307273 , 2216 },
+{ 7307274 , 2181 },
+{ 7307275 , 2183 },
+{ 7307276 , 2197 },
+{ 7307277 , 2010 },
+{ 7307278 , 2198 },
+{ 7307279 , 2196 },
+{ 7307280 , 2243 },
+{ 7307281 , 2211 },
+{ 7307282 , 2274 },
+{ 7307283 , 364 },
+{ 7307284 , 49124 },
+	{ END, 0 }
+} ;
+
+int checkDatabase(const char *path, recordInfo *info)
+{
+	FUNCTIONSETUP;
+
+	PilotLocalDatabase db(QString::fromLatin1(path));
+	if (!db.isOpen())
+	{
+		kdDebug() << "No database " << path << endl;
+		if ( info[0].id == NO_EXIST )
+		{
+			kdDebug() << "This was expected" << endl;
+			return OK;
+		}
+		else
+		{
+			return ERR_NO_EXIST;
+		}
+	}
+
+	if ( info[0].id == NO_EXIST )
+	{
+		kdDebug() << "Database not expected" << endl;
+		return ERR;
+	}
+
+	int fail = 0;
+	int index = 0;
+	PilotRecord *r;
+	while( (r = db.readRecordByIndex(index) ) )
+	{
+		kdDebug() << "[" << index << "] id=" << r->id() << " size=" << r->size() << endl;
+		if ( ((recordid_t)info[index].id) != r->id() )
+		{
+			kdDebug() << "* Bad ID (expected" << r->id() << ")" << endl;
+			fail++;
+		}
+		else if ( info[index].size != r->size() )
+		{
+			kdDebug() << "* Bad size (expected " << info[index].size << ")" << endl;
+			fail++;
+		}
+		index++;
+	}
+	if ( info[index].id != END )
+	{
+		kdDebug() << "* End wasn't expected yet." << endl;
+		r++;
+	}
+
+	if (fail)
+	{
+		kdDebug() << "* " << fail << " failures." << endl;
+		return ERR;
+	}
+	return OK;
+}
+
+const char *categoryNames[4] =
+{
+	"aardvarks",
+	"toolongToBeaCategoryName",
+	"personal",
+	"impersonal"
+} ;
+
+QStringList listCategories()
+{
+	QStringList cats;
+	PilotLocalDatabase *l = new PilotLocalDatabase("./data/MemoDB");
+	PilotMemoInfo *m = new PilotMemoInfo(l);
+
+	if (!l->isOpen()) return cats;
+
+	cats.append(CSL1("Unfiled"));
+	m->dump();
+
+	for (int i=0; i<20; i++)
+	{
+		PilotRecord *r = l->readRecordByIndex(i);
+		kdDebug() << "Read record " << (void *)r << " with id=" << r->id() << endl;
+		if (!r) break;
+	}
+
+	for (int i=0; i<4; i++)
+	{
+		QString s = m->category(i);
+		kdDebug() << "Category " << i << ": " << (s.isEmpty() ? CSL1("<empty>") : s) << endl;
+		cats.append(s);
+/*
+		if (i<((sizeof(categoryNames) / sizeof(categoryNames[0]))))
+			m->setCategoryName(i,QString::fromLatin1(categoryNames[i]));
+*/
+	}
+
+	m->write(l);
+
+	delete m;
+	delete l;
+
+	return cats;
+}
+
+int checkCategories()
+{
+	QStringList l = listCategories();
+	QStringList m = listCategories();
+
+	if (l.isEmpty() || m.isEmpty()) return ERR;
+	if (l!=m) return ERR;
+	return OK;
+}
+
+int checkMemo()
+{
+	PilotLocalDatabase *l = new PilotLocalDatabase("./data/MemoDB");
+	if (!l->isOpen()) return ERR_NO_EXIST;
+
+	PilotMemoInfo *m = new PilotMemoInfo(l);
+	m->dump();
+
+	QString c = m->category(1);
+	if (c != CSL1("Business"))
+	{
+		kdDebug() << "* Category 1 is not 'Business' but " << c << endl;
+		return ERR;
+	}
+
+	m->setCategoryName(2,CSL1("Aardvark"));
+	m->dump();
+
+	c = m->category(2);
+	if (c != CSL1("Aardvark"))
+	{
+		kdDebug() << "* Category 2 is not 'Aardvark' but " << c << endl;
+		return ERR;
+	}
+
+
+	delete m;
+	delete l;
+	return OK;
+}
+
+static const KCmdLineOptions options[] =
+{
+  {"verbose", "Verbose output", 0},
+  KCmdLineLastOption
+};
+
+
+int main(int argc, char **argv)
+{
+	KAboutData aboutData("testdatabase","Test Databases","0.1");
+	KCmdLineArgs::init(argc,argv,&aboutData);
+	KCmdLineArgs::addCmdLineOptions( options );
+
+	//  KApplication app( false, false );
+	KApplication app;
+
+	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+	Q_UNUSED(args)
+
+	int r = 0;
+	int i = 0;
+#ifdef DEBUG
+	debug_level=4;
+#endif
+
+	Q_UNUSED(argc);
+	Q_UNUSED(argv);
+
+#define ALLOW_NO_EXIST (1)
+	static struct { const char *path; recordInfo *info; int flags; } 
+		tests[] =
+	{
+		{ "/tmp/nonexistant/nonexistent", nonexistent,0 },
+		{ "/tmp/Aesop", aesop, ALLOW_NO_EXIST },
+		{ 0L, 0L, 0 }
+	} ;
+
+	while ( tests[i].path )
+	{
+		kdDebug() << "*** Test " << i << endl;
+		int ret = checkDatabase( tests[i].path, tests[i].info );
+		if ( ret )
+		{
+			if ( (ret==ERR_NO_EXIST) && 
+				(tests[i].flags & ALLOW_NO_EXIST) )
+			{
+				kdDebug() << "* Test database doesn't exist, ignored." << endl;
+			}
+			else
+			{
+				r++;
+			}
+		}
+		i++;
+	}
+
+	kdDebug() << "*** Test " << i << endl;
+	if (checkMemo()) r++;
+	i++;
+
+	if (r)
+	{
+		kdDebug() << "***\n*** Failed " << r << " tests." << endl;
+		return 1;
+	}
+	return 0;
+}
+
Index: kpilot/tests/data/AddressDB.pdb
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kpilot/tests/data/AddressDB.pdb
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kpilot/tests/data/ToDoDB.pdb
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kpilot/tests/data/ToDoDB.pdb
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kpilot/tests/data/bogus.pdb
===================================================================
--- kpilot/tests/data/bogus.pdb	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/data/bogus.pdb	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,367 @@
+/* This file is part of the KDE libraries
+   Copyright (c) 2000 The KDE Project
+
+   unsetenv() taken from the GNU C Library.
+   Copyright (C) 1992,1995-1999,2000-2002 Free Software Foundation, Inc.
+
+   This library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Library General Public
+   License version 2 as published by the Free Software Foundation.
+
+   This library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   Library General Public License for more details.
+
+   You should have received a copy of the GNU Library General Public License
+   along with this library; see the file COPYING.LIB.  If not, write to
+   the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+   Boston, MA 02110-1301, USA.
+*/
+
+
+#include <config.h>
+
+#define KDE_open open
+#define KDE_mkdir mkdir 
+
+#ifndef HAVE_SETENV
+
+#ifdef HAVE_ALLOCA_H
+#include <alloca.h>
+#endif
+
+#include <string.h>
+#include <stdlib.h>
+#include <unistd.h>
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+ int setenv(const char *name, const char *value, int overwrite) {
+    int i;
+    char * a;
+
+    if (!overwrite && getenv(name)) return 0;
+
+    i = strlen(name) + strlen(value) + 2;
+    a = (char*)malloc(i);
+    if (!a) return 1;
+
+    strcpy(a, name);
+    strcat(a, "=");
+    strcat(a, value);
+
+    return putenv(a);
+}
+#endif /* !HAVE_SETENV */
+
+#ifndef HAVE_UNSETENV
+
+#ifdef HAVE_ALLOCA_H
+#include <alloca.h>
+#endif
+
+#include <string.h>
+#include <stdlib.h>
+#include <errno.h>
+#include <unistd.h>
+
+#ifndef environ
+extern char ** environ;
+#endif
+
+ void unsetenv (name)
+     const char *name;
+{
+  size_t len;
+  char **ep;
+
+  if (name == NULL || *name == '\0' || strchr (name, '=') != NULL)
+    {
+      errno = EINVAL;
+      return;
+    }
+
+  len = strlen (name);
+
+  ep = environ;
+  while (*ep != NULL)
+    if (!strncmp (*ep, name, len) && (*ep)[len] == '=')
+      {
+	/* Found it.  Remove this pointer by moving later ones back.  */
+	char **dp = ep;
+
+	do
+	  dp[0] = dp[1];
+	while (*dp++);
+	/* Continue the loop in case NAME appears again.  */
+      }
+    else
+      ++ep;
+
+}
+
+#endif /* !HAVE_UNSETENV */
+
+#ifndef HAVE_USLEEP
+
+#if TIME_WITH_SYS_TIME
+# include <sys/time.h>
+# include <time.h>
+#else
+# if defined(HAVE_SYS_TIME_H)
+#  include <sys/time.h>
+# else
+#  include <time.h>
+# endif
+#endif
+
+#ifdef HAVE_SYS_SELECT_H
+#include <sys/select.h>
+#endif
+
+#ifdef __cplusplus  /* this is supposed to be a C source file but still.. */
+extern "C" {
+#endif
+
+void usleep(unsigned int usec) {
+        struct timeval _usleep_tv;
+        _usleep_tv.tv_sec = usec/1000000;
+        _usleep_tv.tv_usec = usec%1000000;
+        select(0,0,0,0,&_usleep_tv);
+}
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* !HAVE_USLEEP */
+
+#ifndef HAVE_RANDOM
+long int random()
+{
+    return lrand48();
+}
+
+void srandom(unsigned int seed)
+{
+    srand48(seed);
+}
+#endif
+
+#ifndef HAVE_SETEUID
+int seteuid(uid_t euid)
+{
+    setreuid(-1, euid); /* Well, if you have neither you are in trouble :) */
+}
+#endif
+
+#ifndef HAVE_MKSTEMPS
+#include <sys/types.h>
+#ifdef HAVE_SYS_STAT_H
+#include <sys/stat.h>
+#endif
+#include <fcntl.h>
+#include <string.h>
+#include <strings.h>
+#include <stdlib.h>
+
+/* this is based on code taken from the GNU libc, distributed under the LGPL license */
+
+/* Generate a unique temporary file name from TEMPLATE.
+
+   TEMPLATE has the form:
+
+   <path>/ccXXXXXX<suffix>
+
+   SUFFIX_LEN tells us how long <suffix> is (it can be zero length).
+
+   The last six characters of TEMPLATE before <suffix> must be "XXXXXX";
+   they are replaced with a string that makes the filename unique.
+
+   Returns a file descriptor open on the file for reading and writing.  */
+
+ int mkstemps (char* _template, int suffix_len)
+{
+  static const char letters[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
+  char *XXXXXX;
+  int len;
+  int count;
+  int value;
+
+  len = strlen (_template);
+
+  if ((int) len < 6 + suffix_len || strncmp (&_template[len - 6 - suffix_len], "XXXXXX", 6))
+      return -1;
+
+  XXXXXX = &_template[len - 6 - suffix_len];
+
+  value = rand();
+  for (count = 0; count < 256; ++count)
+  {
+      int v = value;
+      int fd;
+
+      /* Fill in the random bits.  */
+      XXXXXX[0] = letters[v % 62];
+      v /= 62;
+      XXXXXX[1] = letters[v % 62];
+      v /= 62;
+      XXXXXX[2] = letters[v % 62];
+      v /= 62;
+      XXXXXX[3] = letters[v % 62];
+      v /= 62;
+      XXXXXX[4] = letters[v % 62];
+      v /= 62;
+      XXXXXX[5] = letters[v % 62];
+
+      fd = KDE_open (_template, O_RDWR|O_CREAT|O_EXCL, 0600);
+      if (fd >= 0)
+	/* The file does not exist.  */
+	return fd;
+
+      /* This is a random value.  It is only necessary that the next
+	 TMP_MAX values generated by adding 7777 to VALUE are different
+	 with (module 2^32).  */
+      value += 7777;
+    }
+  /* We return the null string if we can't find a unique file name.  */
+  _template[0] = '\0';
+  return -1;
+}
+
+#endif /* !HAVE_MKSTEMPS */
+
+#ifndef HAVE_MKSTEMP
+ int mkstemp (char* _template)
+{
+  return mkstemps( _template, 0 );
+}
+#endif
+
+#ifndef HAVE_MKDTEMP
+
+#ifndef HAVE_MKSTEMPS
+#include <sys/types.h>
+#ifdef HAVE_SYS_STAT_H
+#include <sys/stat.h>
+#endif
+#endif
+
+/* Generate a unique temporary directory name from TEMPLATE.
+
+   TEMPLATE has the form:
+
+   <path>/ccXXXXXX
+
+
+   The last six characters of TEMPLATE must be "XXXXXX";
+   they are replaced with a string that makes the filename unique.
+
+   Returns a file descriptor open on the file for reading and writing.  */
+
+ char* mkdtemp (char* _template)
+{
+  static const char letters[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
+  char *XXXXXX;
+  int len;
+  int count;
+  int value;
+
+  len = strlen (_template);
+
+  if ((int) len < 6 || strncmp (&_template[len - 6], "XXXXXX", 6))
+      return 0;
+
+  XXXXXX = &_template[len - 6];
+
+  value = rand();
+  for (count = 0; count < 256; ++count)
+  {
+      int v = value;
+
+      /* Fill in the random bits.  */
+      XXXXXX[0] = letters[v % 62];
+      v /= 62;
+      XXXXXX[1] = letters[v % 62];
+      v /= 62;
+      XXXXXX[2] = letters[v % 62];
+      v /= 62;
+      XXXXXX[3] = letters[v % 62];
+      v /= 62;
+      XXXXXX[4] = letters[v % 62];
+      v /= 62;
+      XXXXXX[5] = letters[v % 62];
+
+      /* This is a random value.  It is only necessary that the next
+	 TMP_MAX values generated by adding 7777 to VALUE are different
+	 with (module 2^32).  */
+      value += 7777;
+
+      if (!KDE_mkdir(_template,0700))
+	return _template;	
+    }
+    return 0;
+}
+#endif /* !HAVE_MKDTEMP */
+
+#ifndef HAVE_REVOKE
+#include <errno.h>
+#ifndef ENOTSUP
+#define ENOTSUP 134 /* Not supported */
+#endif
+ int revoke(const char *tty)
+{
+        errno = ENOTSUP;
+        return -1;
+}
+#endif
+
+#ifndef HAVE_STRLCPY
+ unsigned long strlcpy(char* d, const char* s, unsigned long bufsize)
+{
+    unsigned long len, ret = strlen(s);
+
+    if (ret >= bufsize) {
+        if (bufsize) {
+            len = bufsize - 1;
+            memcpy(d, s, len);
+            d[len] = '\0';
+        }
+    } else
+	memcpy(d, s, ret + 1);
+	
+    return ret;
+}
+#endif
+
+#ifndef HAVE_STRLCAT
+ unsigned long strlcat(char* d, const char* s, unsigned long bufsize)
+{
+    char *cp;
+    unsigned long ret, len1, len2 = strlen(s);
+
+    cp = (char *)memchr (d, '\0', bufsize);
+    if (!cp)
+	return bufsize + len2;
+    len1 = cp - d;
+    ret = len1 + len2;
+    if (ret >= bufsize) {
+        len2 = bufsize - len1 - 1;
+        memcpy(cp, s, len2);
+        cp[len2] = '\0';
+    } else
+        memcpy(cp, s, len2 + 1);
+
+    return ret;
+}
+#endif
+
+
+#ifdef __cplusplus
+}
+#endif
+
+
Index: kpilot/tests/data/MemoDB.pdb
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kpilot/tests/data/MemoDB.pdb
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kpilot/tests/data/MailDB.pdb
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kpilot/tests/data/MailDB.pdb
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kpilot/tests/testaddress.cc
===================================================================
--- kpilot/tests/testaddress.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testaddress.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,105 @@
+/* testaddresses			KPilot
+**
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to address database handling.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <kcmdlineargs.h>
+
+#include "pilot.h"
+#include "pilotAddress.h"
+#include "pilotLocalDatabase.h"
+
+static const KCmdLineOptions options[] =
+{
+	{"verbose", "Verbose output", 0},
+	{"data-dir <path>","Set data directory", "."},
+	KCmdLineLastOption
+};
+
+
+
+int main(int argc, char **argv)
+{
+	KAboutData aboutData("testaddress","Test Addresses","0.1");
+	KCmdLineArgs::init(argc,argv,&aboutData);
+	KCmdLineArgs::addCmdLineOptions( options );
+
+	//  KApplication app( false, false );
+	KApplication app;
+
+	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+#ifdef DEBUG
+	debug_level= (args->isSet("verbose")) ? 4 : 0;
+#endif
+	QString datadir = args->getOption("data-dir");
+
+	DEBUGKPILOT << "### testaddresses\n#\n#" << endl;
+
+	Pilot::setupPilotCodec( CSL1("Latin1") );
+
+	PilotLocalDatabase db( datadir, "AddressDB" );
+	PilotAddressInfo appinfo( &db );
+
+	appinfo.dump();
+
+	for (unsigned int i=0; i<db.recordCount(); ++i)
+	{
+		PilotRecord *r = db.readRecordByIndex( i );
+
+		if (r)
+		{
+			DEBUGKPILOT << "# Record @" << (void *)r << " ID=" << r->id() << endl;
+			PilotAddress a( &appinfo, r );
+			DEBUGKPILOT << "# Text Representation:" << endl << a.getTextRepresentation() << endl;
+			DEBUGKPILOT << "# Category#" << a.category() << endl;
+			DEBUGKPILOT << "# Category Label " << a.getCategoryLabel() << endl;
+			DEBUGKPILOT << "# ID " << a.id() << endl;
+
+			// With the given address database, where all the
+			// categories are already filled, this should fail
+			// (and give a useful error message).
+			//
+			a.setCategory( CSL1("Fake Cat") );
+			DEBUGKPILOT << "# Category#" << a.category() << endl;
+			DEBUGKPILOT << "# Category Label " << a.getCategoryLabel() << endl;
+			// This category exists, so it should succeed
+			//
+			a.setCategory( CSL1("Business") );
+			DEBUGKPILOT << "# Category#" << a.category() << endl;
+			DEBUGKPILOT << "# Category Label " << a.getCategoryLabel() << endl;
+		}
+	}
+
+	return 0;
+}
+
Index: kpilot/tests/testcategories.cc
===================================================================
--- kpilot/tests/testcategories.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testcategories.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,201 @@
+/* testcategories			KPilot
+**
+** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to category handling.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <kcmdlineargs.h>
+
+#include "pilotLocalDatabase.h"
+#include "pilotRecord.h"
+#include "pilotAppInfo.h"
+
+// Name of a bogus broken DB
+#define BOGUS_NAME "bogus"
+
+// Name of an actual DB
+#define MEMO_NAME "MemoDB"
+
+QStringList listCategories( const QString &dir, const char *dbname )
+{
+	QStringList cats;
+	PilotLocalDatabase *database = new PilotLocalDatabase( dir, dbname );
+	if (!database->isOpen()) return cats;
+
+	PilotAppInfoBase *appinfo = new PilotAppInfoBase( database );
+	appinfo->dump();
+
+	for (unsigned int i=0; i<Pilot::CATEGORY_COUNT; i++)
+	{
+		QString s = appinfo->categoryName(i);
+		cats.append(s);
+	}
+
+	delete appinfo;
+	delete database;
+
+	return cats;
+}
+
+void badAppInfoCreation()
+{
+	FUNCTIONSETUP;
+	PilotAppInfoBase *appinfo = new PilotAppInfoBase( 0L );
+	appinfo->dump();
+	KPILOT_DELETE( appinfo ) ;
+
+	PilotLocalDatabase *database = new PilotLocalDatabase( BOGUS_NAME );
+	appinfo = new PilotAppInfoBase( database );
+	appinfo->dump();
+	KPILOT_DELETE( appinfo );
+}
+
+void categoryNames()
+{
+	FUNCTIONSETUP;
+
+	PilotLocalDatabase *database = new PilotLocalDatabase( MEMO_NAME );
+	if (!database->isOpen())
+	{
+		return;
+	}
+
+	PilotAppInfoBase *appinfo = new PilotAppInfoBase( database );
+	appinfo->dump();
+
+	DEBUGKPILOT << "# Done dumping" << endl;
+
+	if (!appinfo->categoryInfo())
+	{
+		DEBUGKPILOT << "! Could not read required database" << endl;
+		return;
+	}
+
+	const char *funnyname = "AardvarkWhaleMooseExplosion";
+	const int funnyname_length = strlen(funnyname);
+
+	if (funnyname_length < 20)
+	{
+		DEBUGKPILOT << "! String of example category names is too short." << endl;
+		return;
+	}
+
+	for (unsigned int i=0; i<Pilot::CATEGORY_COUNT+2; i++)
+	{
+		QString name = QString::fromLatin1(funnyname+funnyname_length-i-3);
+		if (!appinfo->setCategoryName(i,name))
+		{
+			DEBUGKPILOT << "! Failed to set category " << i << " name to <" << name << ">" << endl;
+		}
+		else
+		{
+			QString categoryname = appinfo->categoryName(i);
+			if (categoryname != name)
+			{
+				DEBUGKPILOT << "! Category name " << i
+					<< " set to <" << name
+					<< "> and returns <"
+					<< categoryname << ">" << endl;
+			}
+		}
+	}
+
+	appinfo->dump();
+}
+
+static const KCmdLineOptions options[] =
+{
+	{"verbose", "Verbose output", 0},
+	{"data-dir <path>","Set data directory", "."},
+	KCmdLineLastOption
+};
+
+
+int main(int argc, char **argv)
+{
+	KAboutData aboutData("testcategories","Test Categories","0.1");
+	KCmdLineArgs::init(argc,argv,&aboutData);
+	KCmdLineArgs::addCmdLineOptions( options );
+
+	//  KApplication app( false, false );
+	KApplication app;
+
+	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+#ifdef DEBUG
+	debug_level= (args->isSet("verbose")) ? 4 : 0;
+#endif
+
+	Q_UNUSED(argc);
+	Q_UNUSED(argv);
+
+	static const char *files[] = {
+		MEMO_NAME,
+		"AddressDB",
+		"MailDB",
+		"ToDoDB",
+		0L
+	};
+
+	QString datadir = args->getOption("data-dir");
+
+	DEBUGKPILOT << "### testcategories\n#\n#" << endl;
+	DEBUGKPILOT << "# Listing categories from database files.\n#" << endl;
+
+	Pilot::setupPilotCodec( CSL1("Latin1") );
+
+	// Include arbitrary break-off point, in case
+	for (unsigned int i = 0; i<sizeof(files)/sizeof(const char *) ; i++)
+	{
+		if (!files[i])
+		{
+			break;
+		}
+		DEBUGKPILOT << "# Categories (" << files[i] << "): " << endl;
+		(void) listCategories( datadir, files[i] );
+	}
+	// Should bail, not crash
+	DEBUGKPILOT << "# Categories (nonexistent): " << endl;
+	(void) listCategories( datadir, "nonexistent" );
+
+	DEBUGKPILOT << "# Categories (bogus): " << endl;
+	(void) listCategories( datadir, BOGUS_NAME );
+
+	DEBUGKPILOT << "\n# Trying to pass broken pointers to category functions.\n#" << endl;
+	badAppInfoCreation();
+
+	DEBUGKPILOT << "\n# Checking category names.\n#" << endl;
+	categoryNames();
+
+	DEBUGKPILOT << "# OK.\n" << endl;
+	return 0;
+}
+
Index: kpilot/tests/testdatebook.cc
===================================================================
--- kpilot/tests/testdatebook.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/testdatebook.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,93 @@
+/* testaddresses			KPilot
+**
+** Copyright (C) 2006 by Adriaan de Groot <groot@kde.org)
+**
+** Test the functions related to address database handling.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <kcmdlineargs.h>
+
+#include "pilot.h"
+#include "pilotDateEntry.h"
+#include "pilotLocalDatabase.h"
+
+static const KCmdLineOptions options[] =
+{
+	{"verbose", "Verbose output", 0},
+	{"data-dir <path>","Set data directory", "."},
+	KCmdLineLastOption
+};
+
+
+
+int main(int argc, char **argv)
+{
+	KAboutData aboutData("testdatebook","Test Date Book","0.1");
+	KCmdLineArgs::init(argc,argv,&aboutData);
+	KCmdLineArgs::addCmdLineOptions( options );
+
+	//  KApplication app( false, false );
+	KApplication app;
+
+	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+#ifdef DEBUG
+	debug_level= (args->isSet("verbose")) ? 4 : 0;
+#endif
+	QString datadir = args->getOption("data-dir");
+
+	DEBUGKPILOT << "### testdatebook\n#\n#" << endl;
+
+	Pilot::setupPilotCodec( CSL1("Latin1") );
+
+	PilotLocalDatabase db( datadir, "DatebookDB" );
+	PilotDateInfo appinfo( &db );
+
+	for (unsigned int i=0; i<db.recordCount(); ++i)
+	{
+		PilotRecord *r = db.readRecordByIndex( i );
+
+		if (r)
+		{
+			DEBUGKPILOT << "# Record @" << (void *)r << " ID=" << r->id() << endl;
+			PilotDateEntry a( *appinfo.info(), r );
+			DEBUGKPILOT << "# Text Representation:" << endl << a.getTextRepresentation() << endl;
+			DEBUGKPILOT << "# Category#" << a.category() << endl;
+			DEBUGKPILOT << "# Category Label " << a.getCategoryLabel() << endl;
+			DEBUGKPILOT << "# ID " << a.id() << endl;
+			a.setCategory( CSL1("Fake Cat") );
+			DEBUGKPILOT << "# Category#" << a.category() << endl;
+			DEBUGKPILOT << "# Category Label " << a.getCategoryLabel() << endl;
+		}
+	}
+
+	return 0;
+}
+
Index: kpilot/tests/CMakeLists.txt
===================================================================
--- kpilot/tests/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/tests/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,37 @@
+link_directories(${CMAKE_BINARY_DIR}/lib ${CMAKE_CURRENT_BINARY_DIR})
+include_directories(${CMAKE_SOURCE_DIR}/lib ${CMAKE_BINARY_DIR}/lib)
+
+# Tests don't need to go into toplevel/bin, they are fine in the current dir.
+set(EXECUTABLE_OUTPUT_PATH ${CMAKE_CURRENT_BINARY_DIR} )
+
+# This can be used for finding data files in the source dir
+add_definitions( -DKDESRCDIR=\\"${CMAKE_CURRENT_SOURCE_DIR}\\" )
+
+
+set(testconstants_SRCS testconstants.cc)
+kde3_add_executable(testconstants ${testconstants_SRCS})
+target_link_libraries(testconstants kpilot ${QT_LIBRARIES})
+add_test(testconstants ${EXECUTABLE_OUTPUT_PATH}/testconstants)
+
+set(testcategories_SRCS testcategories.cc)
+kde3_add_executable(testcategories ${testcategories_SRCS})
+target_link_libraries(testcategories kpilot ${QT_LIBRARIES})
+add_test(testcategories ${EXECUTABLE_OUTPUT_PATH}/testcategories)
+
+set(testaddresses_SRCS testaddress.cc)
+kde3_add_executable(testaddresses ${testaddresses_SRCS})
+target_link_libraries(testaddresses kpilot ${QT_LIBRARIES})
+add_test(testaddresses ${EXECUTABLE_OUTPUT_PATH}/testaddresses)
+
+set(testdatebook_SRCS testdatebook.cc)
+kde3_add_executable(testdatebook ${testdatebook_SRCS})
+target_link_libraries(testdatebook kpilot ${QT_LIBRARIES})
+add_test(testdatebook ${EXECUTABLE_OUTPUT_PATH}/testdatebook)
+
+set(importdatebook_SRCS importdatebook.cc)
+kde3_add_executable(importdatebook ${importdatebook_SRCS})
+target_link_libraries(importdatebook kpilot ${QT_LIBRARIES} kcal)
+add_test(importdatebook ${EXECUTABLE_OUTPUT_PATH}/importdatebook)
+
+
+
Index: kpilot/TODO
===================================================================
--- kpilot/TODO	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/TODO	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,6 +5,12 @@
  periodically purged from this list.
 
 
+* Import pilot-link 0.12 CVS again
+* Implement correct full syncing in memofile conduit.  honestly, we should
+  really have a generic sync engine that knows how to do all of the
+  different sync types and only calls conduits for comparisons, list
+  fetching, pilotid->whateverId persistence and retrieval, etc.  *sigh*  is
+  that what opensync gives us?
 
 Essential
 =========
Index: kpilot/INSTALL
===================================================================
--- kpilot/INSTALL	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/INSTALL	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,172 +1,46 @@
 Basic Installation
 ==================
 
-   These are generic installation instructions.
 
-   KPILOT IS NOT A SEPARATE PACKAGE. APPLY THESE INSTALL INSTRUCTIONS
-   TO THE PACKAGE kdepim, WHICH SHOULD BE THE DIRECTORY ABOVE THE ONE
-   CONTAINING KPILOT. YOU MAY make KPILOT BY ITSELF THOUGH, ONCE YOU
-   HAVE CONFIGURED kdepim ACCORDING TO THE INSTRUCTIONS BELOW.
+KPilot uses the CMake build system which is the native build system
+for KDE4; for KDE3 applications like KPilot, CMake is also useable.
+You need CMake installed on your system to compile KPilot, but CMake
+is becoming more widespread now. You can get it from www.cmake.org .
 
-   The `configure' shell script attempts to guess correct values for
-various system-dependent variables used during compilation.  It uses
-those values to create a `Makefile' in each directory of the package.
-It may also create one or more `.h' files containing system-dependent
-definitions.  Finally, it creates a shell script `config.status' that
-you can run in the future to recreate the current configuration, a file
-`config.cache' that saves the results of its tests to speed up
-reconfiguring, and a file `config.log' containing compiler output
-(useful mainly for debugging `configure').
 
-   If you need to do unusual things to compile the package, please try
-to figure out how `configure' could check whether to do them, and mail
-diffs or instructions to the address given in the `README' so they can
-be considered for the next release.  If at some point `config.cache'
-contains results you don't want to keep, you may remove or edit it.
+To compile KPilot, just run
 
-   The file `configure.in' is used to create `configure' by a program
-called `autoconf'.  You only need `configure.in' if you want to change
-it or regenerate `configure' using a newer version of `autoconf'.
+	make -f Makefile.cmake
 
-The simplest way to compile this package is:
+in the KPilot source directory (that is the one containing this
+INSTALL file). This will run CMake to generate the real Makefiles,
+then run make again to build the project in a build-* subdirectory.
+Once it is done, you can run
 
-  1. `cd' to the directory containing the package's source code and type
-     `./configure' to configure the package for your system.  If you're
-     using `csh' on an old version of System V, you might need to type
-     `sh ./configure' instead to prevent `csh' from trying to execute
-     `configure' itself.
+	make -f Makefile.cmake install
 
-     Running `configure' takes a while.  While running, it prints some
-     messages telling which features it is checking for.
+to install KPilot in the KDE directory.
 
-  2. Type `make' to compile the package.
 
-  3. Type `make install' to install the programs and any data files and
-     documentation.
 
-  4. You can remove the program binaries and object files from the
-     source code directory by typing `make clean'.  
 
-Compilers and Options
+Advanced Installation
 =====================
 
-   Some systems require unusual options for compilation or linking that
-the `configure' script does not know about.  You can give `configure'
-initial values for variables by setting them in the environment.  Using
-a Bourne-compatible shell, you can do that on the command line like
-this:
-     CC=c89 CFLAGS=-O2 LIBS=-lposix ./configure
+In order to build KPilot somewhere else, or if the sources are on
+read-only media, use CMake directly instead of using the basic
+Makefile included with KPilot. To do this,
+	1) Create a build directory somewhere
+	2) cd into that build directory
+	3) Run cmake /path/to/kpilot/sources
+	4) Run make
 
-Or on systems that have the `env' program, you can do it like this:
-     env CPPFLAGS=-I/usr/local/include LDFLAGS=-s ./configure
+In order to install KPilot somewhere else, set PREFIX in the
+default Makefile, for instance like so:
 
-Compiling For Multiple Architectures
-====================================
+	make -f Makefile.cmake PREFIX=/usr/local/kpilot
+	make -f Makefile.cmake install PREFIX=/usr/local/kpilot
 
-   You can compile the package for more than one kind of computer at the
-same time, by placing the object files for each architecture in their
-own directory.  To do this, you must use a version of `make' that
-supports the `VPATH' variable, such as GNU `make'.  `cd' to the
-directory where you want the object files and executables to go and run
-the `configure' script.  `configure' automatically checks for the
-source code in the directory that `configure' is in and in `..'.
+If using CMake directly, use -DCMAKE_INSTALL_PREFIX .
 
-   If you have to use a `make' that does not supports the `VPATH'
-variable, you have to compile the package for one architecture at a time
-in the source code directory.  After you have installed the package for
-one architecture, use `make distclean' before reconfiguring for another
-architecture.
 
-Installation Names
-==================
-
-   By default, `make install' will install the package's files in
-`/usr/local/bin', `/usr/local/man', etc.  You can specify an
-installation prefix other than `/usr/local' by giving `configure' the
-option `--prefix=PATH'.
-
-   You can specify separate installation prefixes for
-architecture-specific files and architecture-independent files.  If you
-give `configure' the option `--exec-prefix=PATH', the package will use
-PATH as the prefix for installing programs and libraries.
-Documentation and other data files will still use the regular prefix.
-
-   If the package supports it, you can cause programs to be installed
-with an extra prefix or suffix on their names by giving `configure' the
-option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
-
-Optional Features
-=================
-
-   Some packages pay attention to `--enable-FEATURE' options to
-`configure', where FEATURE indicates an optional part of the package.
-They may also pay attention to `--with-PACKAGE' options, where PACKAGE
-is something like `gnu-as' or `x' (for the X Window System).  The
-`README' should mention any `--enable-' and `--with-' options that the
-package recognizes.
-
-   For packages that use the X Window System, `configure' can usually
-find the X include and library files automatically, but if it doesn't,
-you can use the `configure' options `--x-includes=DIR' and
-`--x-libraries=DIR' to specify their locations.
-
-Specifying the System Type
-==========================
-
-   There may be some features `configure' can not figure out
-automatically, but needs to determine by the type of host the package
-will run on.  Usually `configure' can figure that out, but if it prints
-a message saying it can not guess the host type, give it the
-`--host=TYPE' option.  TYPE can either be a short name for the system
-type, such as `sun4', or a canonical name with three fields:
-     CPU-COMPANY-SYSTEM
-
-See the file `config.sub' for the possible values of each field.  If
-`config.sub' isn't included in this package, then this package doesn't
-need to know the host type.
-
-   If you are building compiler tools for cross-compiling, you can also
-use the `--target=TYPE' option to select the type of system they will
-produce code for and the `--build=TYPE' option to select the type of
-system on which you are compiling the package.
-
-Sharing Defaults
-================
-
-   If you want to set default values for `configure' scripts to share,
-you can create a site shell script called `config.site' that gives
-default values for variables like `CC', `cache_file', and `prefix'.
-`configure' looks for `PREFIX/share/config.site' if it exists, then
-`PREFIX/etc/config.site' if it exists.  Or, you can set the
-`CONFIG_SITE' environment variable to the location of the site script.
-A warning: not all `configure' scripts look for a site script.
-
-Operation Controls
-==================
-
-   `configure' recognizes the following options to control how it
-operates.
-
-`--cache-file=FILE'
-     Use and save the results of the tests in FILE instead of
-     `./config.cache'.  Set FILE to `/dev/null' to disable caching, for
-     debugging `configure'.
-
-`--help'
-     Print a summary of the options to `configure', and exit.
-
-`--quiet'
-`--silent'
-`-q'
-     Do not print messages saying which checks are being made.
-
-`--srcdir=DIR'
-     Look for the package's source code in directory DIR.  Usually
-     `configure' can determine that directory automatically.
-
-`--version'
-     Print the version of Autoconf used to generate the `configure'
-     script, and exit.
-
-`configure' also accepts some other, not widely useful, options.
-
Index: kpilot/lib/testactions.cc
===================================================================
--- kpilot/lib/testactions.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/testactions.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,92 +0,0 @@
-/* testactions			KPilot
-**
-** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
-**
-** Test the functions related to sync actions.
-*/
-
-/*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU Lesser General Public License as published by
-** the Free Software Foundation; either version 2.1 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU Lesser General Public License for more details.
-**
-** You should have received a copy of the GNU Lesser General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
-
-/*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
-
-#include "options.h"
-#include "syncAction.h"
-
-bool run_modes(bool test, bool local)
-{
-	bool ok = true;
-
-	kdDebug() << "***\n*** Sync Modes ("
-		<< ( test ? "" : "no")
-		<< "test, "
-		<< ( local ? "" : "no")
-		<< "local)\n***\n";
-
-
-	for (int m = (int)SyncAction::SyncMode::eFastSync;
-		m <= (int) SyncAction::SyncMode::eRestore ;
-		m++)
-	{
-		SyncAction::SyncMode mode((SyncAction::SyncMode::Mode)m,test,local);
-		kdDebug() << "* " << mode.name() << endl;
-		SyncAction::SyncMode mode2(mode.list());
-		if (!(mode==mode2)) {
-			kdDebug() << "E " << "Modes mismatch [" << mode.name() << "] ["
-				<< mode2.name() << "]" << endl;
-			ok = false;
-		}
-	}
-
-	return ok;
-}
-
-bool single_mode(int m, bool test, bool local)
-{
-	SyncAction::SyncMode mode((SyncAction::SyncMode::Mode)m,test,local);
-
-	kdDebug() << "* " << m << " " << test << " " << local << endl;
-
-	if ((mode.mode() == m) && (mode.isTest() == test) && (mode.isLocal() == local))
-	{
-		return true;
-	}
-	else
-	{
-		kdDebug() << "E " << "Modes mismatch " << m << " " << test << " " << local
-			<< "[" << mode.name() << "]" << endl;
-		return false;
-	}
-}
-
-int main(int argc, char **argv)
-{
-	if (!run_modes(false,false)) return 1;
-	if (!run_modes(false,true)) return 1;
-	if (!run_modes(true,false)) return 1;
-	if (!run_modes(true,true)) return 1;
-
-	kdDebug() << "***\n*** Sync Modes - misc\n***\n";
-	if (!single_mode(3,false,false)) return 1;
-	if (!single_mode(1,true,true)) return 1;
-
-	return 0;
-}
-
-
Index: kpilot/lib/testconstants.cc
===================================================================
--- kpilot/lib/testconstants.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/testconstants.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,54 +0,0 @@
-/* testconstants KPilot
-**
-** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
-**
-** Checks that various data structures are sized properly.
-*/
-
-/*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU Lesser General Public License as published by
-** the Free Software Foundation; either version 2.1 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU Lesser General Public License for more details.
-**
-** You should have received a copy of the GNU Lesser General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
-
-/*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
-
-#include "options.h"
-
-#define private public
-#define protected public
-
-#include "pilotDatabase.h"
-
-#include <pi-appinfo.h>
-
-int main(int argc, char **argv)
-{
-	PilotAppInfoBase info;
-
-	kdDebug() << "*** Sizes of structures" << endl;
-	kdDebug() << "AppInfoBase: " << sizeof(PilotAppInfoBase) << endl;
-	kdDebug() << "CategoryInfo: " << sizeof(info.categoryInfo()) << endl;
-	kdDebug() << "CategoryInfo: " << sizeof(*info.categoryInfo()) << endl;
-	kdDebug() << "Category names: " << sizeof(info.categoryInfo()->name) << endl;
-	kdDebug() << "Single category: " << sizeof(info.categoryInfo()->name[0]) << endl;
-
-	if ( sizeof(info.categoryInfo()->name[0]) != 16 ) return 1;
-	if ( sizeof(info.categoryInfo()->name) / sizeof(info.categoryInfo()->name[0]) != 16 ) return 1;
-	return 0;
-}
-
-
Index: kpilot/lib/pilotAppCategory.h
===================================================================
--- kpilot/lib/pilotAppCategory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotAppCategory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,198 +0,0 @@
-#ifndef _KPILOT_PILOTAPPCATEGORY_H
-#define _KPILOT_PILOTAPPCATEGORY_H
-/* pilotAppCategory.h			KPilot
-**
-** Copyright (C) 1998-2001 by Dan Pilone
-** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
-**
-*/
-
-/*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU Lesser General Public License as published by
-** the Free Software Foundation; either version 2.1 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU Lesser General Public License for more details.
-**
-** You should have received a copy of the GNU Lesser General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
-
-/*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
-
-/**
-* @file The class PilotAppCategory is the base class for "interpretations"
-* of a PilotRecord. This is where the records change from a collection
-* of bits to something with meaning. Subclasses of PilotAppCategory
-* give specific meaning to records from specific databases.
-*
-* Almost everything is inline; as a crufty hack, the non-inline
-* part of this class lives in pilotRecord.cc.
-*/
-
-#include <qstring.h>
-#include <klocale.h>
-
-#include <pi-appinfo.h>
-
-#include "pilotRecord.h"
-
-class QTextCodec;
-
-/**
-* Base class for interpretations of the binary blobs. Also
-* exposes the common characteristics of all entries (in general,
-* these characteristics are copied from the binary blob that
-* this interpretation represents).
-*
-* Since this is the base of interpretation of the binary blobs,
-* we include codec() here, which is used to translate from and to
-* the handheld native (8 bit) encoding.
-*/
-class KDE_EXPORT PilotAppCategory : public PilotRecordBase
-{
-protected:			// Use protected since we will be subclassed
-	/**
-	* Pack whatever data the interpreted record holds into the given
-	* buffer, of length @p size; return NULL to indicate failure,
-	* otherwise @p buf. Set @p size to the actual size of data returned.
-	* (all of this is dictated by the pilot-link interfaces).
-	*
-	* Subclasses must reimplement this to give a @em specific
-	* meaning to the binary blob.
-	*
-	* @param buf Data buffer containing the blob.
-	* @param size Size of the buffer (in bytes). As input, the maximum
-	*        size of the buffer. As output, the number of bytes used.
-	*/
-	virtual void *pack_(void *buf, int *size) = 0;
-
-	/** Unpack the binary blob @p buf of size @p size into
-	* some structure with meaning.
-	*/
-	virtual void unpack(const void *buf, int size) = 0;
-
-
-public:
-	/** Constructor with no data. Use the indicated values
-	* of the characteristics. @em Note that the order of the
-	* parameters is subtly different from that in PilotRecordBase .
-	*/
-	PilotAppCategory(int a=0, recordid_t i=0, int c=0) :
-		PilotRecordBase(a,c,i)
-	{} ;
-
-	/** Constructor. Use the common characteristics values from the
-	* given record @p rec.
-	*/
-	PilotAppCategory(const PilotRecord* rec) :
-		PilotRecordBase( ((rec)?rec->attributes():0),
-			((rec)?rec->category():0),
-			((rec)?rec->id():0)
-			)
-	{} ;
-
-	/** Copy constructor. */
-	PilotAppCategory(const PilotAppCategory &copyFrom) :
-		PilotRecordBase(copyFrom.attributes(),
-			copyFrom.id(),
-			copyFrom.category() )
-	{} ;
-
-	/** Assignment operator. I rather doubt that this is useful. */
-	PilotAppCategory& operator=( const PilotAppCategory &r )
-	{
-		setAttributes( r.attributes() );
-		setID( r.id() );
-		setCategory( r.category() );
-		return *this;
-	} ;
-
-	/** Comparison operator. Not really useful, since it also
-	* wants the same record ID.
-	*/
-	bool operator==(const PilotAppCategory &compareTo)
-	{
-		return (attributes() ==compareTo.attributes() &&
-			id() ==compareTo.id() &&
-			category() ==compareTo.category() );
-	} ;
-
-	/** Destructor. VIrtual, since we will be subclassed. */
-	virtual ~PilotAppCategory(void) {};
-
-	/** @return a PilotRecord that contains all of the info of the
-	*  subclass.  Remember to delete the PilotRecord when finished.
-	* Calls pack_() to get the work done.
-	*/
-	virtual PilotRecord* pack();
-
-	/** Returns a text representation of this (interpreted) data.
-	* The text may use Qt rich text tags if @p rt is true. The
-	* default implementation just returns a junk message.
-	*
-	* @param rt Use right text (if needed) if and only if @p rt is true.
-	*/
-	virtual QString getTextRepresentation(bool rt=false)
-		{ Q_UNUSED(rt); return i18n("Unknown record type"); }
-
-	/** Sets the category number to @p c in the range 
-	* 0 <= c < PILOT_CATEGORY_MAX). Using an invalid
-	* category number results in category 0.
-	*/
-	void setCategory( int c ) { return PilotRecordBase::setCategory(c); }
-	/** Sets the category number by looking up the string @p label
-	* in the category table @p info . Sets the category to 0 (unfiled)
-	* if no match is found.
-	*
-	* @param info AppInfo structure containing the labels (in handheld
-	*        native encoding).
-	* @param label The label to look for.
-	*/
-	bool setCategory(struct CategoryAppInfo &info,const QString &label);
-	bool KDE_DEPRECATED setCat(struct CategoryAppInfo &info,const QString &label)
-		{ return setCategory(info,label); }
-
-protected:
-	static QTextCodec *pilotCodec;
-public:
-	/** Static translaion function that maps handheld native (8 bit,
-	* usually latin1 but sometimes someting else) encoded data to
-	* a Unicode string. Converts the @p len characters in @p c
-	* to a Unicode string.
-	*/
-	static QString fromPilot( const char *c, int len );
-
-	/** Static translation function that maps a QString onto the
-	* native 8 bit encoding of the handheld. Writes the result into
-	* the buffer @p buf which has size @p len. Returns the length
-	* of the result. Zero-fills the buffer as needed.
-	*/
-	static int toPilot( const QString &s, char *buf, int len);
-
-	/** Get the codec for use in translating strings from handheld
-	* native encoding to QString and vice-versa.
-	*/
-	static QTextCodec *codec()
-		{ if (pilotCodec) return pilotCodec; else return setupPilotCodec(QString::null); } ;
-	/** Create a codec for translating handheld native 8 bit to Unicode,
-	* using the given codec @p name -- this will often be latin1, but
-	* might be something else for, say, Russian-language Pilots.
-	* If @p name is empty, use latin1.
-	*/
-	static QTextCodec *setupPilotCodec(const QString &name);
-	/** Returns the name of the codec being used. */
-	static QString codecName();
-};
-
-
-
-#endif
Index: kpilot/lib/testdatabase.cc
===================================================================
--- kpilot/lib/testdatabase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/testdatabase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,315 +0,0 @@
-/* testdatabase			KPilot
-**
-** Copyright (C) 2005 by Adriaan de Groot <groot@kde.org)
-**
-** Test the functions related to local databases.
-*/
-
-/*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU Lesser General Public License as published by
-** the Free Software Foundation; either version 2.1 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU Lesser General Public License for more details.
-**
-** You should have received a copy of the GNU Lesser General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
-
-/*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
-
-#include "options.h"
-
-#include <kaboutdata.h>
-#include <kapplication.h>
-#include <kdebug.h>
-#include <klocale.h>
-#include <kcmdlineargs.h>
-
-#include "pilotLocalDatabase.h"
-#include "pilotRecord.h"
-#include "pilotMemo.h"
-
-
-/* Return values for the various check* functions. They
-   return OK if all is OK; ERR is for generic errors.
-   ERR_NO_EXIST is returned if something (usually a database
-   or other file) doesn't exist that should. The latter
-   error might be ignored.
-*/
-#define OK           (0)
-#define ERR          (1)
-#define ERR_NO_EXIST (2)
-
-
-/* Data about the records in a database. The id field is
-   interpreted specially for the first and last entries.
-*/
-typedef struct { int id,size; } recordInfo;
-
-/* Use END in the last recordInfo struct describing a database
-   to indicate you expect the database to end there. Use NO_EXIST
-   as the ID in the first struct to indicate that the database
-   is expected _not_ to exist.
-*/
-#define NO_EXIST   (-2)
-#define END        (-1)
-
-/* These tables of data are taken from various databases I have
-   (but which I cannot commit to SVN due to license issues).
-   The aesop listing is from an eBook of Aesop's fables.
-   The way to create these tables is to use a third-party
-   tool such as par to read the database:
-
-   ./par l /tmp/Aesop.pdb | awk '{print "{",$3,",",$4,"},";}'
-
-*/
-recordInfo nonexistent[] = {
-	{ NO_EXIST, 0 }
-} ;
-
-recordInfo aesop[] = {
-{ 7307264 , 214 },
-{ 7307265 , 1564 },
-{ 7307266 , 1575 },
-{ 7307267 , 2214 },
-{ 7307268 , 2276 },
-{ 7307269 , 2148 },
-{ 7307270 , 2194 },
-{ 7307271 , 2178 },
-{ 7307272 , 2220 },
-{ 7307273 , 2216 },
-{ 7307274 , 2181 },
-{ 7307275 , 2183 },
-{ 7307276 , 2197 },
-{ 7307277 , 2010 },
-{ 7307278 , 2198 },
-{ 7307279 , 2196 },
-{ 7307280 , 2243 },
-{ 7307281 , 2211 },
-{ 7307282 , 2274 },
-{ 7307283 , 364 },
-{ 7307284 , 49124 },
-	{ END, 0 }
-} ;
-
-int checkDatabase(const char *path, recordInfo *info)
-{
-	FUNCTIONSETUP;
-
-	PilotLocalDatabase db(QString::fromLatin1(path));
-	if (!db.isDBOpen())
-	{
-		kdDebug() << "No database " << path << endl;
-		if ( info[0].id == NO_EXIST )
-		{
-			kdDebug() << "This was expected" << endl;
-			return OK;
-		}
-		else
-		{
-			return ERR_NO_EXIST;
-		}
-	}
-
-	if ( info[0].id == NO_EXIST )
-	{
-		kdDebug() << "Database not expected" << endl;
-		return ERR;
-	}
-
-	int fail = 0;
-	int index = 0;
-	PilotRecord *r;
-	while( (r = db.readRecordByIndex(index) ) )
-	{
-		kdDebug() << "[" << index << "] id=" << r->id() << " size=" << r->size() << endl;
-		if ( ((recordid_t)info[index].id) != r->id() )
-		{
-			kdDebug() << "* Bad ID (expected" << r->id() << ")" << endl;
-			fail++;
-		}
-		else if ( info[index].size != r->size() )
-		{
-			kdDebug() << "* Bad size (expected " << info[index].size << ")" << endl;
-			fail++;
-		}
-		index++;
-	}
-	if ( info[index].id != END )
-	{
-		kdDebug() << "* End wasn't expected yet." << endl;
-		r++;
-	}
-
-	if (fail)
-	{
-		kdDebug() << "* " << fail << " failures." << endl;
-		return ERR;
-	}
-	return OK;
-}
-
-const char *categoryNames[4] =
-{
-	"aardvarks",
-	"toolongToBeaCategoryName",
-	"personal",
-	"impersonal"
-} ;
-
-QStringList listCategories()
-{
-	QStringList cats;
-	PilotLocalDatabase *l = new PilotLocalDatabase(SOURCE "/data/MemoDB");
-	PilotMemoInfo *m = new PilotMemoInfo(l);
-
-	if (!l->isDBOpen()) return cats;
-
-	cats.append(CSL1("Unfiled"));
-	m->dump();
-
-	for (int i=0; i<20; i++)
-	{
-		PilotRecord *r = l->readRecordByIndex(i);
-		kdDebug() << "Read record " << (void *)r << " with id=" << r->id() << endl;
-		if (!r) break;
-	}
-
-	for (int i=0; i<4; i++)
-	{
-		QString s = m->category(i);
-		kdDebug() << "Category " << i << ": " << (s.isEmpty() ? CSL1("<empty>") : s) << endl;
-		cats.append(s);
-/*
-		if (i<((sizeof(categoryNames) / sizeof(categoryNames[0]))))
-			m->setCategoryName(i,QString::fromLatin1(categoryNames[i]));
-*/
-	}
-
-	m->write(l);
-
-	delete m;
-	delete l;
-
-	return cats;
-}
-
-int checkCategories()
-{
-	QStringList l = listCategories();
-	QStringList m = listCategories();
-
-	if (l.isEmpty() || m.isEmpty()) return ERR;
-	if (l!=m) return ERR;
-	return OK;
-}
-
-int checkMemo()
-{
-	PilotLocalDatabase *l = new PilotLocalDatabase(SOURCE "/data/MemoDB");
-	if (!l->isDBOpen()) return ERR_NO_EXIST;
-
-	PilotMemoInfo *m = new PilotMemoInfo(l);
-	m->dump();
-
-	QString c = m->category(1);
-	if (c != CSL1("Business"))
-	{
-		kdDebug() << "* Category 1 is not 'Business' but " << c << endl;
-		return ERR;
-	}
-
-	m->setCategoryName(2,CSL1("Aardvark"));
-	m->write(l);
-
-	c = m->category(2);
-	if (c != CSL1("Aardvark"))
-	{
-		kdDebug() << "* Category 2 is not 'Aardvark' but " << c << endl;
-		return ERR;
-	}
-
-
-	delete m;
-	delete l;
-	return OK;
-}
-
-static const KCmdLineOptions options[] =
-{
-  {"verbose", "Verbose output", 0},
-  KCmdLineLastOption
-};
-
-
-int main(int argc, char **argv)
-{
-	KAboutData aboutData("testdatabase","Test Databases","0.1");
-	KCmdLineArgs::init(argc,argv,&aboutData);
-	KCmdLineArgs::addCmdLineOptions( options );
-
-	//  KApplication app( false, false );
-	KApplication app;
-
-	KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
-
-	Q_UNUSED(args)
-
-	int r = 0;
-	int i = 0;
-#ifdef DEBUG
-	debug_level=4;
-#endif
-
-	Q_UNUSED(argc);
-	Q_UNUSED(argv);
-
-#define ALLOW_NO_EXIST (1)
-	static struct { const char *path; recordInfo *info; int flags; } 
-		tests[] =
-	{
-		{ "/tmp/nonexistant/nonexistent", nonexistent,0 },
-		{ "/tmp/Aesop", aesop, ALLOW_NO_EXIST },
-		{ 0L, 0L, 0 }
-	} ;
-
-	while ( tests[i].path )
-	{
-		kdDebug() << "*** Test " << i << endl;
-		int ret = checkDatabase( tests[i].path, tests[i].info );
-		if ( ret )
-		{
-			if ( (ret==ERR_NO_EXIST) && 
-				(tests[i].flags & ALLOW_NO_EXIST) )
-			{
-				kdDebug() << "* Test database doesn't exist, ignored." << endl;
-			}
-			else
-			{
-				r++;
-			}
-		}
-		i++;
-	}
-
-	kdDebug() << "*** Test " << i << endl;
-	if (checkMemo()) r++;
-	i++;
-
-	if (r)
-	{
-		kdDebug() << "***\n*** Failed " << r << " tests." << endl;
-		return 1;
-	}
-	return 0;
-}
-
Index: kpilot/lib/options.cc
===================================================================
--- kpilot/lib/options.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/options.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,38 +28,31 @@
 */
 
 
-static const char *options_id =
-	"$Id$";
-
 #include "options.h"
 
 
 #include <iostream>
 
-#if TIME_WITH_SYS_TIME
-# include <sys/time.h>
-# include <time.h>
-#else
-# if HAVE_SYS_TIME_H
-#  include <sys/time.h>
-# else
-#  include <time.h>
-# endif
-#endif
-
 #include <qsize.h>
 
 #include <kconfig.h>
 #include <kdebug.h>
 #include <kcmdlineargs.h>
 
+#ifdef DEBUG
+int debug_level = 1;
+#else
+int debug_level = 0;
+#endif
+
 // The daemon also has a debug level; debug_spaces is 60 spaces,
 // to align FUNCTIONSETUP output.
 //
 //
-int debug_level = 0;
 const char *debug_spaces =
 	"                                                    ";
+
+
 QString rtExpand(const QString &s, bool richText)
 {
 	if (richText)
@@ -70,59 +63,47 @@
 	else
 		return s;
 
-	Q_UNUSED(options_id);
 }
 
 QDateTime readTm(const struct tm &t)
 {
-  QDateTime dt;
-  dt.setDate(QDate(1900 + t.tm_year, t.tm_mon + 1, t.tm_mday));
-  dt.setTime(QTime(t.tm_hour, t.tm_min, t.tm_sec));
-  return dt;
+	QDateTime dt;
+	dt.setDate(QDate(1900 + t.tm_year, t.tm_mon + 1, t.tm_mday));
+	dt.setTime(QTime(t.tm_hour, t.tm_min, t.tm_sec));
+	return dt;
 }
 
 
 
 struct tm writeTm(const QDateTime &dt)
 {
-  struct tm t;
+	struct tm t;
 
-  t.tm_wday = 0; // unimplemented
-  t.tm_yday = 0; // unimplemented
-  t.tm_isdst = 0; // unimplemented
-  t.tm_zone = 0; // unimplemented
+	t.tm_wday = 0; // unimplemented
+	t.tm_yday = 0; // unimplemented
+	t.tm_isdst = 0; // unimplemented
+#ifdef HAVE_STRUCT_TM_TM_ZONE
+	t.tm_zone = 0; // unimplemented
+#endif
 
-  t.tm_year = dt.date().year() - 1900;
-  t.tm_mon = dt.date().month() - 1;
-  t.tm_mday = dt.date().day();
-  t.tm_hour = dt.time().hour();
-  t.tm_min = dt.time().minute();
-  t.tm_sec = dt.time().second();
+	t.tm_year = dt.date().year() - 1900;
+	t.tm_mon = dt.date().month() - 1;
+	t.tm_mday = dt.date().day();
+	t.tm_hour = dt.time().hour();
+	t.tm_min = dt.time().minute();
+	t.tm_sec = dt.time().second();
 
-  return t;
+	return t;
 }
 
 
 
-struct tm writeTm(const QDate &dt)
+struct tm writeTm(const QDate &d)
 {
-  struct tm t;
-
-  t.tm_wday = 0; // unimplemented
-  t.tm_yday = 0; // unimplemented
-  t.tm_isdst = 0; // unimplemented
-
-  t.tm_year = dt.year() - 1900;
-  t.tm_mon = dt.month() - 1;
-  t.tm_mday = dt.day();
-  t.tm_hour = 0;
-  t.tm_min = 0;
-  t.tm_sec = 0;
-
-  return t;
+	QDateTime dt(d);
+	return writeTm(dt);
 }
 
-#ifdef DEBUG
 KPilotDepthCount::KPilotDepthCount(int area, int level, const char *s) :
 	fDepth(depth),
 	fLevel(level),
@@ -131,7 +112,8 @@
 	if (debug_level>=fLevel)
 	{
 #ifdef DEBUG_CERR
-		DEBUGKPILOT
+		Q_UNUSED(area);
+		DEBUGLIBRARY
 #else
 		debug(area)
 #endif
@@ -153,5 +135,4 @@
 }
 
 int KPilotDepthCount::depth = 0;
-#endif
 
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/options.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -50,43 +50,27 @@
 #endif
 
 
-// Switch _on_ debugging if it's not off.
-//
-#ifndef NDEBUG
-#ifndef DEBUG
-#define DEBUG				(1)
-#endif
-#endif
-
-// Switch on debugging explicitly. Perhaps send debug to stderr instead
-// of to the KDE debugging facility (it does lose some niftiness then).
-//
-#ifndef DEBUG
-// #define DEBUG			(1)
-#endif
-// #define DEBUG_CERR			(1)
-
-#ifdef HAVE_CONFIG_H
 #include "config.h"
-#endif
 
 #include <unistd.h>     /* For size_t for pilot-link */
 #include <qglobal.h>
-// For KDE_EXPORT with kdelibs 3.3.x
-#include <kdepimmacros.h>
 
-#if (QT_VERSION < 0x030200)
-#error "This is KPilot for KDE3.3 and won't compile with Qt < 3.2.0"
+#if (QT_VERSION < 0x030300)
+#error "This is KPilot for KDE3.5 and won't compile with Qt < 3.3.0"
 #endif
 
 #ifndef KDE_VERSION
 #include <kdeversion.h>
 #endif
 
-#if !(KDE_IS_VERSION(3,3,0))
-#error "This is KPilot for KDE 3.3 and won't compile with KDE < 3.3.0"
+#if !(KDE_IS_VERSION(3,4,0))
+#error "This is KPilot for (really) KDE 3.5 and won't compile with KDE < 3.4.0"
 #endif
 
+#if !(KDE_IS_VERSION(3,5,0))
+#warning "This is KPilot for KDE 3.5 and might not compile with KDE < 3.5.0"
+#endif
+
 #include "pilotLinkVersion.h"
 
 // For QString, and everything else needs it anyway.
@@ -97,33 +81,14 @@
 #ifdef DEBUG
 #undef NDEBUG
 #undef NO_DEBUG
+#ifndef DEBUG_CERR
+#define DEBUG_CERR
 #endif
+#endif
 #include <kdebug.h>
 
-
-
 extern KDE_EXPORT int debug_level;
 
-#ifdef DEBUG
-#ifdef __GNUC__
-#define KPILOT_FNAMEDEF(l)	KPilotDepthCount fname(DEBUGAREA,l,__FUNCTION__)
-#else
-#define	KPILOT_FNAMEDEF(l)	KPilotDepthCount fname(DEBUGAREA,l,__FILE__ ":" "__LINE__")
-#endif
-
-#define FUNCTIONSETUP		KPILOT_FNAMEDEF(1)
-#define FUNCTIONSETUPL(l)	KPILOT_FNAMEDEF(l)
-#define DEBUGAREA 		0
-
-#define DEBUGAREA_KPILOT	5510
-#define DEBUGAREA_DAEMON	5511
-#define DEBUGAREA_CONDUIT	5512
-#define DEBUGAREA_DB		5513
-
-#ifdef DEBUG_CERR
-#include <iostream>
-#endif
-
 class KDE_EXPORT KPilotDepthCount
 {
 public:
@@ -134,7 +99,11 @@
 	// if DEBUG_CERR is defined, we can't return std::cerr (by value),
 	// since the copy constructor is private!
 #ifndef DEBUG_CERR
+#ifdef NDEBUG
+	inline kndbgstream debug(int area=0)
+#else
 	inline kdbgstream debug(int area=0)
+#endif
 	{ return kdDebug(debug_level >= fLevel, area); }
 #endif
 
@@ -145,16 +114,36 @@
 	const char *fName;
 } ;
 
+
+#ifdef DEBUG
+#ifdef __GNUC__
+#define KPILOT_FNAMEDEF(l)	KPilotDepthCount fname(DEBUGAREA,l,__FUNCTION__)
+#else
+#define	KPILOT_FNAMEDEF(l)	KPilotDepthCount fname(DEBUGAREA,l,__FILE__ ":" "__LINE__")
+#endif
+
+#define FUNCTIONSETUP		KPILOT_FNAMEDEF(1)
+#define FUNCTIONSETUPL(l)	KPILOT_FNAMEDEF(l)
+#define DEBUGAREA 		0
+
+#define DEBUGAREA_KPILOT	5510
+#define DEBUGAREA_LIBRARY	5511
+#define DEBUGAREA_CONDUIT	5512
+#define DEBUGAREA_DB		5513
+
+#ifdef DEBUG_CERR
+#include <iostream>
+#endif
+
 // stderr / iostream-based debugging.
 //
 //
 #ifdef DEBUG_CERR
 #include <iostream>
 #define DEBUGKPILOT	std::cerr
-#define DEBUGDAEMON	std::cerr
+#define DEBUGLIBRARY	std::cerr
 #define DEBUGCONDUIT	std::cerr
 #define DEBUGDB		std::cerr
-
 using namespace std;
 
 inline std::ostream& operator <<(std::ostream &o, const QString &s)
@@ -169,11 +158,13 @@
 
 #else
 
+#warning "kdDebug()-based debugging is deprecated"
+
 // kddebug based debugging
 //
 //
 #define DEBUGKPILOT	fname.debug(DEBUGAREA_KPILOT)
-#define DEBUGDAEMON	fname.debug(DEBUGAREA_DAEMON)
+#define DEBUGLIBRARY	fname.debug(DEBUGAREA_LIBRARY)
 #define DEBUGCONDUIT	fname.debug(DEBUGAREA_CONDUIT)
 #define DEBUGDB         fname.debug(DEBUGAREA_DB)
 
@@ -188,7 +179,7 @@
 #else
 #define DEBUGSTREAM	kndbgstream
 #define DEBUGKPILOT	kndDebug()
-#define DEBUGDAEMON	kndDebug()
+#define DEBUGLIBRARY	kndDebug()
 #define DEBUGCONDUIT	kndDebug()
 #define DEBUGDB         kndDebug()
 
@@ -199,7 +190,7 @@
 #define FUNCTIONSETUPL(a) const int fname = a; Q_UNUSED(fname);
 #endif
 
-#define KPILOT_VERSION	"4.6.0 (blivit)"
+#define KPILOT_VERSION	"4.9.0 (deepsix)"
 
 
 // Function to expand newlines in rich text to <br>\n
Index: kpilot/lib/plugin.cc
===================================================================
--- kpilot/lib/plugin.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/plugin.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,7 +39,6 @@
 #include <qfileinfo.h>
 #include <qdir.h>
 #include <qregexp.h>
-#include <qtextcodec.h>
 
 #include <dcopclient.h>
 #include <kapplication.h>
@@ -49,7 +48,6 @@
 
 #include "pilotSerialDatabase.h"
 #include "pilotLocalDatabase.h"
-#include "pilotAppCategory.h"
 
 #include "plugin.moc"
 
@@ -96,7 +94,7 @@
 	return true;
 }
 
-ConduitAction::ConduitAction(KPilotDeviceLink *p,
+ConduitAction::ConduitAction(KPilotLink *p,
 	const char *name,
 	const QStringList &args) :
 	SyncAction(p,name),
@@ -115,16 +113,14 @@
 			cResolution.replace(QRegExp(CSL1("--conflictResolution (\\d*)")), CSL1("\\1")).toInt();
 	}
 
-#ifdef DEBUG
 	for (QStringList::ConstIterator it = args.begin();
 		it != args.end();
 		++it)
 	{
-		DEBUGCONDUIT << fname << ": " << *it << endl;
+		DEBUGLIBRARY << fname << ": " << *it << endl;
 	}
 
-	DEBUGCONDUIT << fname << ": Direction=" << fSyncDirection.name() << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Direction=" << fSyncDirection.name() << endl;
 }
 
 /* virtual */ ConduitAction::~ConduitAction()
@@ -134,19 +130,24 @@
 	KPILOT_DELETE(fLocalDatabase);
 }
 
-bool ConduitAction::openDatabases_(const QString &name, bool *retrieved)
+bool ConduitAction::openDatabases(const QString &name, bool *retrieved)
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGLIBRARY << fname
 		<< ": Trying to open database "
 		<< name << endl;
-#endif
+	DEBUGLIBRARY << fname
+		<< ": Mode="
+		<< (syncMode().isTest() ? "test " : "")
+		<< (syncMode().isLocal() ? "local " : "")
+		<< endl ;
 
 	KPILOT_DELETE(fLocalDatabase);
-	PilotLocalDatabase *localDB = new PilotLocalDatabase(name, true);
 
+	QString localPathName = PilotLocalDatabase::getDBPath() + name;
+	PilotLocalDatabase *localDB = new PilotLocalDatabase( localPathName );
+
 	if (!localDB)
 	{
 		kdWarning() << k_funcinfo
@@ -158,69 +159,59 @@
 	}
 
 	// if there is no backup db yet, fetch it from the palm, open it and set the full sync flag.
-	if (!localDB->isDBOpen() )
+	if (!localDB->isOpen() )
 	{
 		QString dbpath(localDB->dbPathName());
 		KPILOT_DELETE(localDB);
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-			<< ": Backup database "<< dbpath <<" could not be opened. Will fetch a copy from the palm and do a full sync"<<endl;
-#endif
+		DEBUGLIBRARY << fname
+			<< ": Backup database " << dbpath
+			<< " not found." << endl;
 		struct DBInfo dbinfo;
-		if (fHandle->findDatabase(PilotAppCategory::codec()->fromUnicode( name ), &dbinfo)<0 )
+
+// TODO Extend findDatabase() with extra overload?
+		if (deviceLink()->findDatabase(Pilot::toPilot( name ), &dbinfo)<0 )
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< ": Could not get DBInfo for "<<name<<"! "<<endl;
-#endif
+			kdWarning() << k_funcinfo
+				<< ": Could not get DBInfo for " << name << endl;
 			if (retrieved) *retrieved = false;
 			return false;
 		}
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-				<< ": Found Palm database: "<<dbinfo.name<<endl
-				<<"type = "<< dbinfo.type<<endl
-				<<"creator = "<< dbinfo.creator<<endl
-				<<"version = "<< dbinfo.version<<endl
-				<<"index = "<< dbinfo.index<<endl;
-#endif
+
+		DEBUGLIBRARY << fname
+				<< ": Found Palm database: " << dbinfo.name <<endl
+				<< fname << ": type = " << dbinfo.type
+				<< " creator = " << dbinfo.creator
+				<< " version = " << dbinfo.version
+				<< " index = " << dbinfo.index << endl;
 		dbinfo.flags &= ~dlpDBFlagOpen;
 
 		// make sure the dir for the backup db really exists!
 		QFileInfo fi(dbpath);
-		QString path(QFileInfo(dbpath).dir(TRUE).absPath());
+		QString path(QFileInfo(dbpath).dir(true).absPath());
 		if (!path.endsWith(CSL1("/"))) path.append(CSL1("/"));
 		if (!KStandardDirs::exists(path))
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname << ": Trying to create path for database: <"
+			DEBUGLIBRARY << fname << ": Trying to create path for database: <"
 				<< path << ">" << endl;
-#endif
 			KStandardDirs::makeDir(path);
 		}
 		if (!KStandardDirs::exists(path))
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname << ": Database directory does not exist." << endl;
-#endif
+			DEBUGLIBRARY << fname << ": Database directory does not exist." << endl;
 			if (retrieved) *retrieved = false;
 			return false;
 		}
 
-		if (!fHandle->retrieveDatabase(dbpath, &dbinfo) )
+		if (!deviceLink()->retrieveDatabase(dbpath, &dbinfo) )
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname << ": Could not retrieve database "<<name<<" from the handheld."<<endl;
-#endif
+			kdWarning() << k_funcinfo << ": Could not retrieve database "<<name<<" from the handheld."<<endl;
 			if (retrieved) *retrieved = false;
 			return false;
 		}
-		localDB = new PilotLocalDatabase(name, true);
-		if (!localDB || !localDB->isDBOpen())
+		localDB = new PilotLocalDatabase( localPathName );
+		if (!localDB || !localDB->isOpen())
 		{
-#ifdef DEBUG
-			DEBUGCONDUIT << fname << ": local backup of database "<<name<<" could not be initialized."<<endl;
-#endif
+			kdWarning() << k_funcinfo << ": local backup of database "<<name<<" could not be initialized."<<endl;
 			if (retrieved) *retrieved = false;
 			return false;
 		}
@@ -228,7 +219,7 @@
 	}
 	fLocalDatabase = localDB;
 
-	fDatabase = new PilotSerialDatabase(pilotSocket(), name /* On pilot */);
+	fDatabase = deviceLink()->database( name );
 
 	if (!fDatabase)
 	{
@@ -239,170 +230,78 @@
 			<< endl;
 	}
 
-	return (fDatabase && fDatabase->isDBOpen() &&
-	        fLocalDatabase && fLocalDatabase->isDBOpen() );
+	return (fDatabase && fDatabase->isOpen() &&
+	        fLocalDatabase && fLocalDatabase->isOpen() );
 }
 
-// This whole function is for debugging purposes only.
-bool ConduitAction::openDatabases_(const QString &dbName,const QString &localPath)
+
+bool ConduitAction::changeSync(SyncMode::Mode m)
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Doing local test mode for " << dbName << endl;
-#endif
-	if (localPath.isNull())
-	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname
-			<< ": local mode test for one database only."
-			<< endl;
-#endif
-		fDatabase = new PilotLocalDatabase(dbName,false);
-		fLocalDatabase = 0L;
-		return false;
-	}
 
-	fDatabase = new PilotLocalDatabase(localPath,dbName);
-	fLocalDatabase= new PilotLocalDatabase(dbName, true); // From default
-	if (!fLocalDatabase || !fDatabase)
+	if ( fSyncDirection.isSync() && SyncMode::eFullSync == m)
 	{
-#ifdef DEBUG
-		const QString *where2 = PilotLocalDatabase::getDBPath();
-
-		QString none = CSL1("<null>");
-		DEBUGCONDUIT << fname
-			<< ": Could not open both local copies of \""
-			<< dbName
-			<< "\"" << endl
-			<< "Using \""
-			<< (where2 ? *where2 : none)
-			<< "\" and \""
-			<< (localPath.isEmpty() ? localPath : none)
-			<< "\""
-			<< endl;
-#endif
+		fSyncDirection.setMode(m);
+		return true;
 	}
-#ifdef DEBUG
-	if (fLocalDatabase)
-	{
-		DEBUGCONDUIT << fname
-			<< ": Opened local database "
-			<< fLocalDatabase->dbPathName()
-			<< (fLocalDatabase->isDBOpen() ? " OK" : "")
-			<< endl;
-	}
-	if (fDatabase)
-	{
-		DEBUGCONDUIT << fname
-			<< ": Opened database "
-			<< fDatabase->dbPathName()
-			<< (fDatabase->isDBOpen() ? " OK" : "")
-			<< endl;
-	}
-#endif
-
-	return (fDatabase && fLocalDatabase);
+	return false;
 }
 
-bool ConduitAction::openDatabases(const QString &dbName, bool *retrieved)
+
+namespace PluginUtility
 {
+
+QString findArgument(const QStringList &a, const QString &arg)
+{
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Mode="
-		<< (syncMode().isTest() ? "test " : "")
-		<< (syncMode().isLocal() ? "local " : "")
-		<< endl ;
-#endif
+	QString search;
 
-	if (syncMode().isLocal())
+	if (arg.startsWith( CSL1("--") ))
 	{
-		return openDatabases_(dbName,CSL1("/tmp/"));
+		search = arg;
 	}
 	else
 	{
-		return openDatabases_(dbName, retrieved);
+		search = CSL1("--") + arg;
 	}
-}
+	search.append( CSL1("=") );
 
-bool ConduitAction::changeSync(SyncMode::Mode m)
-{
-	FUNCTIONSETUP;
 
-	if ( fSyncDirection.isSync() && SyncMode::eFullSync == m)
+	QStringList::ConstIterator end = a.end();
+	for (QStringList::ConstIterator i = a.begin(); i != end; ++i)
 	{
-		fSyncDirection.setMode(m);
-		return true;
-	}
-	return false;
-}
-
-int PluginUtility::findHandle(const QStringList &a)
-{
-	FUNCTIONSETUP;
-
-	int handle = -1;
-	for (QStringList::ConstIterator i = a.begin();
-		i != a.end(); ++i)
-	{
-		if ((*i).left(7) == CSL1("handle="))
+		if ((*i).startsWith( search ))
 		{
-			QString s = (*i).mid(7);
-			if (s.isEmpty()) continue;
-
-			handle = s.toInt();
-#ifdef DEBUG
-			DEBUGCONDUIT << fname
-				<< ": Got handle "
-				<< handle
-				<< endl;
-#endif
-			if (handle<1)
-			{
-				kdWarning() << k_funcinfo
-					<< ": Improbable handle value found."
-					<< endl;
-			}
-			return handle;
+			QString s = (*i).mid(search.length());
+			return s;
 		}
 	}
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": No handle= parameter found."
-		<< endl;
-#endif
-
-	return -1;
+	return QString::null;
 }
 
-bool PluginUtility::isModal(const QStringList &a)
+/* static */ bool isRunning(const QCString &n)
 {
-	return a.contains(CSL1("modal"));
-}
-
-/* static */ bool PluginUtility::isRunning(const QCString &n)
-{
 	DCOPClient *dcop = KApplication::kApplication()->dcopClient();
 	QCStringList apps = dcop->registeredApplications();
 	return apps.contains(n);
 }
 
 
-/* static */ long PluginUtility::pluginVersion(const KLibrary *lib)
+/* static */ unsigned long pluginVersion(const KLibrary *lib)
 {
 	QString symbol = CSL1("version_");
 	symbol.append(lib->name());
 
 	if (!lib->hasSymbol(symbol.latin1())) return 0;
 
-	long *p = (long *)(lib->symbol(symbol.latin1()));
+	unsigned long *p = (unsigned long *)(lib->symbol(symbol.latin1()));
 	return *p;
 }
 
 
-/* static */ QString PluginUtility::pluginVersionString(const KLibrary *lib)
+/* static */ QString pluginVersionString(const KLibrary *lib)
 {
 	QString symbol= CSL1("id_");
 	symbol.append(lib->name());
@@ -413,3 +312,5 @@
 }
 
 
+}
+
Index: kpilot/lib/kpilotdevicelink.h
===================================================================
--- kpilot/lib/kpilotdevicelink.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/kpilotdevicelink.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,234 @@
+#ifndef _KPILOT_KPILOTDEVICELINK_H
+#define _KPILOT_KPILOTDEVICELINK_H
+/* kpilotdevicelink.h			KPilot
+**
+** Copyright (C) 1998-2001 by Dan Pilone
+** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "kpilotlink.h"
+
+/** @file Definition of the device link class; implemented in kpilotlink.cc */
+
+/** Implementation of the device link class for physical
+*   handheld devices, which communicate with the PC
+*   using DLP / SLP via the pilot-link library.
+*/
+class KDE_EXPORT KPilotDeviceLink : public KPilotLink
+{
+friend class PilotSerialDatabase;
+Q_OBJECT
+
+/*
+** Constructors and destructors.
+*/
+public:
+	/**
+	* Creates a pilot link that can sync to the pilot.
+	*
+	* Call reset() on it to start looking for a device.
+	*/
+	KPilotDeviceLink( QObject *parent = 0, 
+		const char *name = 0, 
+		const QString &tempDevice = QString::null );
+	/** Destructor. This rudely ends the communication with the handheld. */
+	virtual ~KPilotDeviceLink();
+
+
+	/**
+	* The link behaves like a state machine most of the time:
+	* it waits for the actual device to become available, and
+	* then becomes ready to handle syncing.
+	*/
+	typedef enum {
+		Init,
+		WaitingForDevice,
+		FoundDevice,
+		CreatedSocket,
+		DeviceOpen,
+		AcceptedDevice,
+		SyncDone,
+		PilotLinkError,
+		WorkaroundUSB
+		} LinkStatus;
+
+	/** Get the status (state enum) of this link.
+	* @return The LinkStatus enum for the link's current state.
+	*/
+	LinkStatus status() const { return fLinkStatus; } ;
+	/** Get a human-readable string for the given status @p l. */
+	static QString statusString(LinkStatus l);
+
+	// The followin API is the actual implementation of
+	// the KPilotLink API, for documentation see that file.
+	//
+	virtual QString statusString() const;
+	virtual bool isConnected() const;
+	virtual void reset( const QString & );
+	virtual void close();
+	virtual void reset();
+	virtual bool tickle();
+	virtual const KPilotCard *getCardInfo(int card);
+	virtual void endOfSync();
+	virtual void finishSync();
+	virtual int openConduit();
+	virtual int getNextDatabase(int index,struct DBInfo *);
+	virtual int findDatabase(const char *name, struct DBInfo*,
+		int index=0, unsigned long type=0, unsigned long creator=0);
+	virtual bool retrieveDatabase(const QString &path, struct DBInfo *db);
+	virtual DBInfoList getDBList(int cardno=0, int flags=dlpDBListRAM);
+	virtual PilotDatabase *database( const QString &name );
+
+protected:
+	virtual bool installFile(const QString &, const bool deleteFile);
+	virtual void addSyncLogEntryImpl( const QString &s );
+	virtual int pilotSocket() const { return fCurrentPilotSocket; } ;
+
+
+private:
+	LinkStatus fLinkStatus;
+
+
+
+
+
+public:
+
+	/**
+	* Special-cases. Call this after a reset to set device-
+	* specific workarounds; the only one currently known
+	* is the Zire 31/72 T5 quirk of doing a non-HotSync
+	* connect when it's switched on.
+	*/
+	void setWorkarounds(bool usb)
+	{
+		fWorkaroundUSB = usb;
+	} ;
+
+	/**
+	* Sets an additional device, which should be tried as fallback.
+	* Useful for hotplug enviroments, this device is used @em once
+	* for accepting a connection.
+	*/
+	void setTempDevice( const QString &device );
+
+private:
+	/** Should we work around the Zire31/72 quirk? @see setWorkarounds() */
+	bool fWorkaroundUSB;
+	/** Timer used to check for a badly-connected Z31/72 */
+	QTimer *fWorkaroundUSBTimer;
+
+private slots:
+	/** This slot is called when we detect a bogus connection from
+	 *  a Z31 or Z72 and the workaround is enabled. It disconnects,
+	 *  then re-enables connections.
+	 */
+	void workaroundUSB();
+
+protected slots:
+	/**
+	* Attempt to open the device. Called regularly to check
+	* if the device exists (to handle USB-style devices).
+	*/
+	void openDevice();
+
+	/**
+	* Called when the device is opened *and* activity occurs on the
+	* device. This indicates the beginning of a hotsync.
+	*/
+	void acceptDevice();
+
+protected:
+	/**
+	* Does the low-level opening of the device and handles the
+	* pilot-link library initialisation.
+	*/
+	bool open( const QString &device = QString::null );
+
+	/**
+	* Check for device permissions and existence, emitting
+	* warnings for weird situations. This is primarily intended
+	* to inform the user.
+	*/
+	void checkDevice();
+
+	/**
+	* Some messages are only printed once and are suppressed
+	* after that. These are indicated by flag bits in
+	* messages.
+	*/
+	enum { OpenMessage=1, OpenFailMessage=2 } ;
+	int messages;
+	int messagesMask;
+	static const int messagesType;
+
+	/** Print a message @p s which has an id of @p msgid (one of
+	 *  the enum values mentioned above) -- but only if that
+	 *  message has not been suppressed through messagesMask.
+	 *  Printing a message adds it to the messagesMask.
+	 */
+	void shouldPrint(int msgid,const QString &s);
+
+
+
+private:
+	/**
+	* Path with resolved symlinks, to prevent double binding
+	* to the same device.
+	*/
+	QString fRealPilotPath;
+
+	/**
+	* For transient devices: how often have we tried pi_bind()?
+	*/
+	int fRetries;
+
+	/**
+	* Timers and Notifiers for detecting activity on the device.
+	*/
+	QTimer *fOpenTimer;
+	QSocketNotifier *fSocketNotifier;
+	bool fSocketNotifierActive;
+
+	/**
+	* Pilot-link library handles for the device once it's opened.
+	*/
+	int fPilotMasterSocket;
+	int fCurrentPilotSocket;
+	QString fTempDevice;
+
+	/**
+	* Handle cases where we can't accept or open the device,
+	* and data remains available on the pilot socket.
+	*/
+	int fAcceptedCount;
+
+private:
+	class KPilotDeviceLinkPrivate;
+} ;
+
+#endif
+
Index: kpilot/lib/pilotSysInfo.h
===================================================================
--- kpilot/lib/pilotSysInfo.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotSysInfo.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,68 +40,103 @@
 class KPilotSysInfo
 {
 public:
-	KPilotSysInfo() { ::memset(&fSysInfo,0,sizeof(struct SysInfo)); }
-	KPilotSysInfo(const SysInfo* sys_info) { fSysInfo = *sys_info; }
+	/** Constructor. Create an empty SysInfo structure. */
+	KPilotSysInfo() 
+	{
+		::memset(&fSysInfo,0,sizeof(struct SysInfo)); 
+	}
 
-	SysInfo *sysInfo() { return &fSysInfo; }
+	/** Constructor. Copy an existing pilot-link SysInfo structure. 
+	 *  Ownership is not changed. @p sys_info may be NULL.
+	 */ 
+	KPilotSysInfo(const SysInfo *sys_info) 
+	{
+		::memset(&fSysInfo,0,sizeof(struct SysInfo)); 
+		if (sys_info)
+		{
+			fSysInfo = *sys_info;
+		}
+	}
 
-	/**
-	* Ensures the names are properly terminated.  Needed incase we
-	* are syncing a new and bogus pilot.
-	*/
-	void boundsCheck()
+	/** Access to the raw SysInfo structure. */
+	SysInfo *sysInfo()
 	{
+		return &fSysInfo;
 	}
 
-	const unsigned long getRomVersion() const {return fSysInfo.romVersion;}
-	void setRomVersion(unsigned long newval)  {fSysInfo.romVersion=newval;}
+	/** Get the ROM version of the handheld. This is a pilot-link
+	 *  long value (4 bytes) with major, minor, bugfix version
+	 *  numbers encoded in the value.
+	 */
+	const unsigned long getRomVersion() const 
+	{
+		return fSysInfo.romVersion;
+	}
 
-	const unsigned long getLocale() const {return fSysInfo.locale;}
-	void setLocale(unsigned long newval)  {fSysInfo.locale=newval;}
-
-#if ( PILOT_LINK_VERSION < 1 ) && ( PILOT_LINK_MAJOR < 11 )
-// Older pilot-link versions < 0.11.x don't have prodID, but name instead,
-// and they also do not have the *Version members.
-	const int getProductIDLength() const { return fSysInfo.nameLength; }
-	const char* getProductID()
+	/** Get the locale number of the handheld. 
+	 *  @note I do not know what this means.
+	 */
+	const unsigned long getLocale() const 
 	{
-		fSysInfo.name[fSysInfo.nameLength]='\0';
-		return fSysInfo.name;
+		return fSysInfo.locale;
 	}
-	void setProductID(char* prodid)
+	/** Set the locale number of the handheld.
+	 *  @note I do not know what this means.
+	 */
+	void setLocale(unsigned long newval)
 	{
-		strlcpy(fSysInfo.name, prodid, sizeof(fSysInfo.name));
-		boundsCheck();
-		fSysInfo.nameLength = strlen(fSysInfo.name);
+		fSysInfo.locale=newval;
 	}
 
-	const unsigned short getMajorVersion() const {return 0;}
-	const unsigned short getMinorVersion() const {return 0;}
-	const unsigned short getCompatMajorVersion() const {return 0;}
-	const unsigned short getCompatMinorVersion() const {return 0;}
-	const unsigned short getMaxRecSize() const {return 0;}
-#else
-// Newer pilot-link versions have these fields, so use them:
-	const int getProductIDLength() const { return fSysInfo.prodIDLength; }
-	const char* getProductID()
+	/** Get the length (in bytes) of the ProductID string. */
+	const int getProductIDLength() const
 	{
-		fSysInfo.prodID[fSysInfo.prodIDLength]='\0';
+		return fSysInfo.prodIDLength;
+	}
+	/** Get the ProductID string from the handheld. This is
+	 *  guaranteed to be NUL terminated.
+	 */
+	const char* getProductID() const
+	{
 		return fSysInfo.prodID;
 	}
-	void setProductID(char* prodid)
+
+	/** Accessor for the major version of the DLP protocol in use. */
+	const unsigned short getMajorVersion() const 
 	{
-		strlcpy(fSysInfo.prodID, prodid, sizeof(fSysInfo.prodID));
-		boundsCheck();
-		fSysInfo.prodIDLength = strlen(fSysInfo.prodID);
+		return fSysInfo.dlpMajorVersion;
 	}
+	/** Accessor for the minor version of the DLP protocol in use. */
+	const unsigned short getMinorVersion() const 
+	{
+		return fSysInfo.dlpMinorVersion;
+	}
 
-	const unsigned short getMajorVersion() const {return fSysInfo.dlpMajorVersion;}
-	const unsigned short getMinorVersion() const {return fSysInfo.dlpMinorVersion;}
-	const unsigned short getCompatMajorVersion() const {return fSysInfo.compatMajorVersion;}
-	const unsigned short getCompatMinorVersion() const {return fSysInfo.compatMinorVersion;}
-	const unsigned short getMaxRecSize() const {return fSysInfo.maxRecSize;}
-#endif
+	/** Accessor for the major compatibility version of the handheld.
+	 *  @note I do not know what this means.
+	 */
+	const unsigned short getCompatMajorVersion() const 
+	{
+		return fSysInfo.compatMajorVersion;
+	}
+	/** Accessor for the minor compatibility version of the handheld.
+	 *  @note I do not know what this means.
+	 */
+	const unsigned short getCompatMinorVersion() const 
+	{
+		return fSysInfo.compatMinorVersion;
+	}
 
+
+	/** Returns the maximum record size that the handheld supports.
+	 *  Normally this is 65524 or so (which means that larger values
+	 *  don't necessarily @em fit in a short).
+	 */
+	const unsigned short getMaxRecSize() const 
+	{
+		return fSysInfo.maxRecSize;
+	}
+
 private:
 	struct SysInfo fSysInfo;
 };
Index: kpilot/lib/recordConduit.cc
===================================================================
--- kpilot/lib/recordConduit.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/recordConduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -38,7 +38,6 @@
 #include "options.h"
 
 #include <qtimer.h>
-#include <qtextcodec.h>
 #include <qfile.h>
 
 #include "pilotAppCategory.h"
@@ -53,8 +52,7 @@
 //
 extern "C"
 {
-long version_record_conduit = KPILOT_PLUGIN_API;
-const char *id_record_conduit="$Id$";
+long version_record_conduit = Pilot::PLUGIN_API;
 }
 
 
@@ -79,7 +77,7 @@
 
 	fTimer = new QTimer(this);
 	connect(fTimer,SIGNAL(timeout()),this,SLOT(process()));
-	fTimer->start(0,true); // Fire as often as possible to prompt processing
+	fTimer->start(0,false); // Fire as often as possible to prompt processing
 	return true;
 }
 
@@ -88,6 +86,10 @@
 	FUNCTIONSETUP;
 	SyncProgress p = Error;
 
+#ifdef DEBUG
+	DEBUGLIBRARY << fname << ": From state " << name(fState) << endl;
+#endif
+
 	switch(fState)
 	{
 	case Initialize :
@@ -96,11 +98,18 @@
 	case PalmToPC :
 		p = palmRecToPC();
 		break;
+	case PCToPalm :
+		p = pcRecToPalm();
+		break;
 	case Cleanup :
 		p = cleanup();
 		break;
 	}
 
+#ifdef DEBUG
+	DEBUGLIBRARY << fname << ": Step returned " << name(p) << endl;
+#endif
+
 	switch(p)
 	{
 	case Error :
@@ -115,21 +124,36 @@
 		break;
 	}
 
+#ifdef DEBUG
+	DEBUGLIBRARY << fname << ": Step is done, moving to next state." << endl;
+#endif
+
 	// Here the previous call was done.
 	switch(fState)
 	{
 	case Initialize :
-		if ( ( syncMode().mode() == SyncMode::eCopyPCToHH ) ||
-			( syncMode().mode() == SyncMode::eRestore ) )
+		switch (syncMode().mode())
 		{
-			fState = Cleanup;
+		case SyncMode::eRestore :
+		case SyncMode::eCopyPCToHH : /* These two don't copy Palm records to the PC */
+			fState = PCToPalm;
+			break;
+		default :
+			fState = PalmToPC;
 		}
-		else
+		break;
+	case PalmToPC :
+		switch (syncMode().mode())
 		{
-			fState = PalmToPC;
+		case SyncMode::eBackup :
+		case SyncMode::eCopyHHToPC : /* These modes don't copy PC records back */
+			fState = Cleanup;
+			break;
+		default :
+			fState = PCToPalm;
 		}
 		break;
-	case PalmToPC :
+	case PCToPalm :
 		fState = Cleanup;
 		break;
 	case Cleanup :
@@ -138,9 +162,44 @@
 		// No change in state, timer stopped and we're done.
 		break;
 	}
+
+#ifdef DEBUG
+	DEBUGLIBRARY << fname << ": Next state is " << name(fState) << endl;
+#endif
+
 }
 
 
+QString RecordConduitBase::name(RecordConduitBase::SyncProgress s)
+{
+	switch(s)
+	{
+	case RecordConduitBase::NotDone:
+		return CSL1("NotDone");
+	case RecordConduitBase::Done:
+		return CSL1("Done");
+	case RecordConduitBase::Error:
+		return CSL1("Error");
+	}
+}
+
+
+QString RecordConduitBase::name(RecordConduitBase::States s)
+{
+	switch(s)
+	{
+	case RecordConduitBase::Initialize:
+		return CSL1("Initialize");
+	case RecordConduitBase::PalmToPC:
+		return CSL1("Handheld-to-PC");
+	case RecordConduitBase::PCToPalm:
+		return CSL1("PC-to-Handheld");
+	case RecordConduitBase::Cleanup:
+		return CSL1("Cleanup");
+	}
+}
+
+
 #if 0
 /** make that entry on the pc archived (i.e. deleted on the handheld,
  *  while present on the pc, but not synced to the handheld */
@@ -174,7 +233,7 @@
 		++it;
 	}
 #ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Loaded " << idContactMap.size() <<
+	DEBUGLIBRARY << fname << ": Loaded " << idContactMap.size() <<
 	    " Entries on the pc and mapped them to records on the handheld. " << endl;
 #endif
 	return true;
@@ -196,9 +255,6 @@
 		mEntryMap(), mSyncedIds(), mAllIds()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_record_conduit << endl;
-#endif
 	fConduitName = name;
 }
 
@@ -223,9 +279,6 @@
 /* virtual */ bool RecordConduit::exec()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGCONDUIT << id_record_conduit << endl;
-#endif
 
 	if ( !_prepare() ) return false;
 
@@ -255,13 +308,13 @@
 	mPalmIndex = 0;
 
 #ifdef DEBUG
-	DEBUGCONDUIT << fname << ": fullsync=" << isFullSync() << ", firstSync=" << isFirstSync() << endl;
-	DEBUGCONDUIT << fname << ": "
+	DEBUGLIBRARY << fname << ": fullsync=" << isFullSync() << ", firstSync=" << isFirstSync() << endl;
+	DEBUGLIBRARY << fname << ": "
 		<< "syncDirection=" << getSyncDirection() << ", "
 //		<< "archive = " << AbbrowserSettings::archiveDeleted()
 		<< endl;
-	DEBUGCONDUIT << fname << ": conflictRes="<< getConflictResolution() << endl;
-//	DEBUGCONDUIT << fname << ": PilotStreetHome=" << AbbrowserSettings::pilotStreet() << ", PilotFaxHOme" << AbbrowserSettings::pilotFax() << endl;
+	DEBUGLIBRARY << fname << ": conflictRes="<< getConflictResolution() << endl;
+//	DEBUGLIBRARY << fname << ": PilotStreetHome=" << AbbrowserSettings::pilotStreet() << ", PilotFaxHOme" << AbbrowserSettings::pilotFax() << endl;
 #endif
 
 	if ( !isFirstSync() )
@@ -361,7 +414,7 @@
 	if ( isArchived( pcEntry ) )
 	{
 #ifdef DEBUG
-		DEBUGCONDUIT << fname << ": address with id " << pcEntry->uid() <<
+		DEBUGLIBRARY << fname << ": address with id " << pcEntry->uid() <<
 			" marked archived, so don't sync." << endl;
 #endif
 		KPILOT_DELETE( pcEntry );
@@ -383,7 +436,7 @@
 	if ( mSyncedIds.contains( recID ) )
 	{
 #ifdef DEBUG
-		DEBUGCONDUIT << ": address with id " << recID << " already synced." << endl;
+		DEBUGLIBRARY << ": address with id " << recID << " already synced." << endl;
 #endif
 		KPILOT_DELETE( pcEntry );
 		QTimer::singleShot( 0, this, SLOT( slotPCRecToPalm() ) );
@@ -487,7 +540,7 @@
 			if ( !uids.contains( *uidit ) )
 			{
 #ifdef DEBUG
-				DEBUGCONDUIT << "Deleting PCEntry with uid " << (*uidit) << " from PC (is not on HH, and syncing with HH->PC direction)" << endl;
+				DEBUGLIBRARY << "Deleting PCEntry with uid " << (*uidit) << " from PC (is not on HH, and syncing with HH->PC direction)" << endl;
 #endif
 				mPCData->removeEntry( *uidit );
 			}
@@ -510,7 +563,7 @@
 			if ( !mSyncedIds.contains(*it) )
 			{
 #ifdef DEBUG
-				DEBUGCONDUIT << "Deleting record with ID " << *it << " from handheld (is not on PC, and syncing with PC->HH direction)" << endl;
+				DEBUGLIBRARY << "Deleting record with ID " << *it << " from handheld (is not on PC, and syncing with PC->HH direction)" << endl;
 #endif
 				fDatabase->deleteRecord(*it);
 				fLocalDatabase->deleteRecord(*it);
@@ -552,7 +605,7 @@
 const QStringList RecordConduit::categories() const
 {
 	QStringList cats;
-	for ( int j = 0; j < PILOT_CATEGORY_MAX; j++ ) {
+	for ( unsigned int j = 0; j < Pilot::CATEGORY_COUNT; j++ ) {
 		QString catName( category( j ) );
 		if ( !catName.isEmpty() ) cats << catName;
 	}
@@ -607,8 +660,8 @@
 {
 	FUNCTIONSETUP;
 	// get the address application header information
-	unsigned char *buffer = new unsigned char[PilotRecord::APP_BUFFER_SIZE];
-	int appLen=fDatabase->readAppBlock(buffer, PilotRecord::APP_BUFFER_SIZE);
+	unsigned char *buffer = new unsigned char[Pilot::MAX_APPINFO_SIZE];
+	int appLen=fDatabase->readAppBlock(buffer, Pilot::MAX_APPINFO_SIZE);
 
 	doUnpackAppInfo( buffer, appLen );
 	delete[] buffer;
@@ -651,14 +704,13 @@
 QString RecordConduit::getCatForHH( const QStringList cats, const QString curr ) const
 {
 	FUNCTIONSETUP;
-	int j;
 	if ( cats.size() < 1 )
 		return QString::null;
 	if ( cats.contains( curr ) )
 		return curr;
 	for ( QStringList::ConstIterator it = cats.begin(); it != cats.end(); ++it)
 	{
-		for ( j = 0; j < PILOT_CATEGORY_MAX; j++ )
+		for ( unsigned int j = 0; j < Pilot::CATEGORY_COUNT; j++ )
 		{
 			QString catnm( category( j ) );
 			if ( !(*it).isEmpty() && ( (*it)==catnm ) )
@@ -668,7 +720,7 @@
 		}
 	}
 	// If we have a free label, return the first possible cat
-	QString lastCat( category( PILOT_CATEGORY_MAX-1 ) );
+	QString lastCat( category( Pilot::CATEGORY_COUNT-1 ) );
 	return ( lastCat.isEmpty() ) ? ( cats.first() ) : ( QString::null );
 }
 
@@ -811,7 +863,7 @@
 		else if ( _equal( backupEntry, pcEntry ) )
 		{
 #ifdef DEBUG
-			DEBUGCONDUIT << "Flags: " << palmEntry->getAttrib() << ", isDeleted=" <<
+			DEBUGLIBRARY << "Flags: " << palmEntry->getAttrib() << ", isDeleted=" <<
 				isDeleted( palmEntry ) << ", isArchived=" << isArchived( palmEntry )
 				<< endl;
 #endif
@@ -852,14 +904,14 @@
 	}
 	_copy( hhEntry, pcEntry );
 #ifdef DEBUG
-	DEBUGCONDUIT << "palmEntry->id=" << hhEntry->id() << ", pcEntry.ID=" <<
+	DEBUGLIBRARY << "palmEntry->id=" << hhEntry->id() << ", pcEntry.ID=" <<
 		pcEntry->uid() << endl;
 #endif
 
 	if( palmSaveEntry( hhEntry, pcEntry ) )
 	{
 #ifdef DEBUG
-		DEBUGCONDUIT << "Entry palmEntry->id=" <<
+		DEBUGLIBRARY << "Entry palmEntry->id=" <<
 		hhEntry->id() << "saved to palm, now updating pcEntry->uid()=" << pcEntry->uid() << endl;
 #endif
 		pcSaveEntry( pcEntry, backupEntry, hhEntry );
@@ -899,13 +951,13 @@
 	FUNCTIONSETUP;
 
 #ifdef DEBUG
-	DEBUGCONDUIT << "Saving to pilot " << palmEntry->id() << endl;
+	DEBUGLIBRARY << "Saving to pilot " << palmEntry->id() << endl;
 #endif
 
 	PilotRecord *pilotRec = palmEntry->pack();
 	recordid_t pilotId = fDatabase->writeRecord(pilotRec);
 #ifdef DEBUG
-	DEBUGCONDUIT << "PilotRec nach writeRecord (" << pilotId <<
+	DEBUGLIBRARY << "PilotRec nach writeRecord (" << pilotId <<
 		": ID=" << pilotRec->id() << endl;
 #endif
 	fLocalDatabase->writeRecord( pilotRec );
@@ -956,7 +1008,7 @@
 	FUNCTIONSETUP;
 
 #ifdef DEBUG
-	DEBUGCONDUIT << "Before _savepcEntry, pcEntry->uid()=" <<
+	DEBUGLIBRARY << "Before _savepcEntry, pcEntry->uid()=" <<
 		pcEntry->uid() << endl;
 #endif
 	if ( pcEntry->recid() != 0 )
@@ -1007,7 +1059,7 @@
 	if ( !pcEntry->isEmpty() )
 	{
 #ifdef DEBUG
-		DEBUGCONDUIT << fname << " removing " << pcEntry->uid() << endl;
+		DEBUGLIBRARY << fname << " removing " << pcEntry->uid() << endl;
 #endif
 		mPCData->removeEntry( pcEntry );
 	}
@@ -1046,7 +1098,7 @@
 	{
 		QString id( mEntryMap[palmEntry->id()] );
 #ifdef DEBUG
-		DEBUGCONDUIT << fname << ": PilotRecord has id " << palmEntry->id() << ", mapped to " << id << endl;
+		DEBUGLIBRARY << fname << ": PilotRecord has id " << palmEntry->id() << ", mapped to " << id << endl;
 #endif
 		if( !id.isEmpty() )
 		{
@@ -1054,7 +1106,7 @@
 			if ( !res && !res->isEmpty() ) return res;
 			KPILOT_DELETE( res );
 #ifdef DEBUG
-			DEBUGCONDUIT << fname << ": PilotRecord has id " << palmEntry->id() <<
+			DEBUGLIBRARY << fname << ": PilotRecord has id " << palmEntry->id() <<
 				", but could not be found on the PC side" << endl;
 #endif
 		}
@@ -1079,7 +1131,7 @@
 		KPILOT_DELETE( abEntry );
 	}
 #ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Could not find any entry matching Palm record with id " << QString::number( palmEntry->id() ) << endl;
+	DEBUGLIBRARY << fname << ": Could not find any entry matching Palm record with id " << QString::number( palmEntry->id() ) << endl;
 #endif
 	return 0;
 }
Index: kpilot/lib/pilotMemo.cc
===================================================================
--- kpilot/lib/pilotMemo.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotMemo.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -25,71 +25,30 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *pilotMemo_id =
-	"$Id$";
 
 #include "options.h"
 
-#include <qtextcodec.h>
 
 #include "pilotMemo.h"
 #include "pilotDatabase.h"
 
 
 
-PilotMemo::PilotMemo(const PilotRecord * rec) : PilotAppCategory(rec)
+PilotMemo::PilotMemo(const PilotRecord * rec) : PilotRecordBase(rec)
 {
 	FUNCTIONSETUP;
-	fText = codec()->toUnicode((const char *)(rec->data()),rec->size());
-	(void) pilotMemo_id;
+	fText = Pilot::fromPilot((const char *)(rec->data()),rec->size());
 }
 
-void PilotMemo::unpack(const void *text, int /* firstTime */)
-{
-	FUNCTIONSETUP;
-	kdWarning() << k_funcinfo << ": deprecated and broken function." << endl;
-	fText = codec()->toUnicode((const char *)text);
-}
-
 PilotRecord *PilotMemo::pack()
 {
-	char *buf = new char[fText.length() + 8];
-	int len = fText.length() + 8;
-	pack_(buf,&len);
-	PilotRecord *r = new PilotRecord(buf, len, attributes(), category(), id());
-	delete[] buf;
+	pi_buffer_t *b = pi_buffer_new(fText.length()+8);
+	b->used = Pilot::toPilot(fText, b->data, b->allocated);
+	PilotRecord *r = new PilotRecord(b, this);
 	return r;
 }
 
-void *PilotMemo::pack_(void *buf, int *len)
-{
-	FUNCTIONSETUP;
-	if (!*len) return NULL;
-	if (*len < 0) return NULL; // buffer size being silly
-	if (fText.length() > (unsigned) *len) return NULL; // won't fit either
 
-	QCString s = codec()->fromUnicode(fText);
-
-	int use_length = *len;
-	if (MAX_MEMO_LEN < use_length) use_length = MAX_MEMO_LEN;
-
-	// Zero out the buffer, up to the max memo size.
-	memset(buf,0,use_length);
-
-	// Copy the encoded string and make extra sure it's NUL terminated.
-	// Yay, _every_ parameter needs a cast.
-	// *NOTE* This will truncate the memo text if it was passed in as being
-	//        too long, but this is better than allowing garbage in
-	strlcpy(( char *)buf,(const char *)s,use_length);
-
-	// Finally, we set the length of the memo to the used length
-	// of the data buffer, which might be the length of the string.
-	if ((int)s.length() < use_length) use_length = s.length()+1;
-	*len = use_length;
-	return buf;
-}
-
-
 QString PilotMemo::getTextRepresentation(bool richText)
 {
 	if (richText)
Index: kpilot/lib/pilotAppInfo.h
===================================================================
--- kpilot/lib/pilotAppInfo.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/pilotAppInfo.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,207 @@
+#ifndef _KPILOT_PILOTAPPINFO_H
+#define _KPILOT_PILOTAPPINFO_H
+/* pilotAppInfo.h			KPilot
+**
+** Copyright (C) 2005-2006 Adriaan de Groot <groot@kde.org>
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "pilotLinkVersion.h"
+
+#include "pilot.h"
+#include "pilotDatabase.h"
+
+/**
+* A database on the handheld has an "AppInfo" block at the beginning
+* with some database-specific information and a common part.
+* This base class deals with the common part, the categories.
+*
+* Most data in the handheld is stored in @em categories ; every
+* record in every database, for instance, has a category assigned
+* to it (perhaps "Unfiled", but that's just another category).
+*
+* Every database has a category table assigning labels to the
+* categories that exist. There are CATEGORY_COUNT (16) categories
+* available for each database; labels may vary per database.
+*
+* This class encapsulates the basic category table manipulations.
+*/
+class KDE_EXPORT PilotAppInfoBase
+{
+protected:
+	/** Constructor. This is for use by derived classes (using the template below
+	* only, and says that the category info in the base class aliases data in
+	* the derived class. Remember to call init()!
+	*/
+	PilotAppInfoBase() : fC(0L), fLen(0), fOwn(false) { } ;
+
+	/** Initialize class members after reading header, to alias data elsewhere.
+	* Only for use by the (derived) template classes below.
+	*/
+	void init(struct CategoryAppInfo *c, int len)
+	{
+		fC = c;
+		fLen = len ;
+	} ;
+
+public:
+	/** Constructor, intended for untyped access to the AppInfo only. This throws
+	* away everything but the category information. In this variety, the
+	* CategoryAppInfo structure is owned by the PilotAppInfoBase object.
+	*/
+	PilotAppInfoBase(PilotDatabase *d);
+
+	/** Destructor. */
+	virtual ~PilotAppInfoBase();
+
+	/** Retrieve the most basic part of the AppInfo block -- the category
+	* information which is guaranteed to be the first 240-odd bytes of
+	* a database.
+	*/
+	struct CategoryAppInfo *categoryInfo()
+	{
+		return fC;
+	} ;
+
+	/** Const version of the above function. */
+	inline const struct CategoryAppInfo *categoryInfo() const
+	{
+		return fC;
+	} ;
+
+	/** Returns the length of the (whole) AppInfo block. */
+	inline PI_SIZE_T length() const
+	{
+		return fLen;
+	} ;
+
+	/** @see findCategory(const QString &name, bool unknownIsUnfiled, struct CategoryAppInfo *info). */
+	inline int findCategory(const QString &name, bool unknownIsUnfiled = false)
+	{
+		return Pilot::findCategory(fC,name,unknownIsUnfiled);
+	} ;
+
+	/** Gets a single category name. Returns QString::null if there is no
+	* such category number @p i . */
+	inline QString categoryName(unsigned int i) const
+	{
+		return Pilot::categoryName(fC,i);
+	}
+
+	/** Sets a category name. @return true if this succeeded. @return false
+	* on failure, e.g. the index @p i was out of range or the category name
+	* was invalid. Category names that are too long are truncated to 15 characters.
+	*/
+	bool setCategoryName(unsigned int i, const QString &s);
+
+	/** For debugging, display all the category names */
+	inline void dump() const
+	{
+		Pilot::dumpCategories(fC);
+	};
+
+protected:
+	struct CategoryAppInfo *fC;
+	PI_SIZE_T fLen;
+
+	bool fOwn;
+} ;
+
+/** A template class for reading and interpreting AppInfo blocks;
+* the idea is that it handles all the boilerplate code for reading
+* the app block, converting it to the right kind, and then unpacking
+* it. Template parameters are the type (struct, from pilot-link probably)
+* of the interpreted appinfo, and the pack and unpack functions for it
+* (again, from pilot-link).
+*/
+template <typename appinfo,
+	int(*unpack)(appinfo *, unsigned char *, PI_SIZE_T),
+	int(*pack)(appinfo *, unsigned char *, PI_SIZE_T)>
+class PilotAppInfo : public PilotAppInfoBase
+{
+public:
+	/** Constructor. Read the appinfo from database @p d and
+	* interpret it.
+	*/
+	PilotAppInfo(PilotDatabase *d) : PilotAppInfoBase()
+	{
+		int appLen = Pilot::MAX_APPINFO_SIZE;
+		unsigned char buffer[Pilot::MAX_APPINFO_SIZE];
+
+		memset(&fInfo,0,sizeof(fInfo));
+		if (d && d->isOpen())
+		{
+			appLen = d->readAppBlock(buffer,appLen);
+			(*unpack)(&fInfo, buffer, appLen);
+			// fInfo is just a struct, so we can point to it anyway.
+			init(&fInfo.category,appLen);
+		}
+		else
+		{
+			delete fC;
+			fC = 0L;
+			fLen = 0;
+		}
+	} ;
+
+	PilotAppInfo()
+	{
+		memset(&fInfo,0,sizeof(fInfo));
+	}
+
+
+	/** Write this appinfo block to the database @p d; returns
+	* the number of bytes written or -1 on failure. This
+	* function is robust when called with a NULL database @p d.
+	*/
+	int writeTo(PilotDatabase *d)
+	{
+		unsigned char buffer[Pilot::MAX_APPINFO_SIZE];
+		if (!d || !d->isOpen())
+		{
+			return -1;
+		}
+		int appLen = (*pack)(&fInfo, buffer, length());
+		if (appLen > 0)
+		{
+			d->writeAppBlock(buffer,appLen);
+		}
+		return appLen;
+	} ;
+
+	/** Returns a (correctly typed) pointer to the interpreted
+	* appinfo block.
+	*/
+	appinfo *info() { return &fInfo; } ;
+	/** Returns a const (correctly typed) pointer to the interpreted
+	* appinfo block.
+	*/
+	const appinfo *info() const { return &fInfo; } ;
+
+protected:
+	appinfo fInfo;
+} ;
+
+
+#endif
Index: kpilot/lib/pilotMemo.h
===================================================================
--- kpilot/lib/pilotMemo.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotMemo.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,19 +32,44 @@
 
 #include <pi-memo.h>
 
-#include "pilotAppCategory.h"
-#include "pilotDatabase.h"
+#include "pilotRecord.h"
+#include "pilotAppInfo.h"
 
-
-class KDE_EXPORT PilotMemo : public PilotAppCategory
+class KDE_EXPORT PilotMemo : public PilotRecordBase
 {
 public:
-	PilotMemo(void) : PilotAppCategory() { } ;
-	PilotMemo(const QString &s) : PilotAppCategory() { setText(s); } ;
+	/**
+	* Constructor. Create an empty memo.
+	*/
+	PilotMemo(void) : PilotRecordBase() { } ;
+
+	/**
+	* Constructor. Create a memo in the Unfiled category with
+	* text @p s .
+	*/
+	PilotMemo(const QString &s) : PilotRecordBase()
+	{
+		setText(s);
+	} ;
+
+	/**
+	* Constructor. Create a memo with the category and
+	* attributes of the given record @p rec, and extract
+	* the text from that record as if it comes from the MemoDB.
+	*/
 	PilotMemo(const PilotRecord* rec);
-	PilotMemo(void *buf) : PilotAppCategory() { unpack(buf, 1); } ;
-	PilotMemo(void *buf, int attr, recordid_t id, int category)
-		: PilotAppCategory(attr, id, category) { unpack(buf, 1); } ;
+
+	/**
+	* Constructor. Create a memo with category and
+	* attributes from the argument @p r, and set the
+	* text of the memo from string @p s.
+	*/
+	PilotMemo(const PilotRecordBase *r, const QString &s) :
+		PilotRecordBase(r)
+	{
+		setText(s);
+	}
+
 	~PilotMemo() { } ;
 
 	virtual QString getTextRepresentation(bool richText=false);
@@ -69,10 +94,6 @@
 	*/
 	QString sensibleTitle() const;
 
-protected:
-	void *pack_(void *, int *);
-	void unpack(const void *, int = 0);
-
 private:
 	QString fText;
 };
Index: kpilot/lib/pilotDateEntry.cc
===================================================================
--- kpilot/lib/pilotDateEntry.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotDateEntry.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,20 +31,15 @@
 
 #include <stdlib.h>
 
-#include <qtextcodec.h>
 #include <qdatetime.h>
+#include <qregexp.h>
 
 #include <kglobal.h>
 #include <kdebug.h>
-#include "libkcal/event.h"
 
 #include "pilotDateEntry.h"
 
-static const char *pilotDateEntry_id = "$Id$";
-const int PilotDateEntry::APP_BUFFER_SIZE = 0xffff;
-
-
-PilotDateEntry::PilotDateEntry(struct AppointmentAppInfo &appInfo):PilotAppCategory(), fAppInfo(appInfo)
+PilotDateEntry::PilotDateEntry(struct AppointmentAppInfo &appInfo):PilotRecordBase(), fAppInfo(appInfo)
 {
 	::memset(&fAppointmentInfo, 0, sizeof(struct Appointment));
 }
@@ -52,27 +47,19 @@
 /* initialize the entry from another one. If rec==NULL, this constructor does the same as PilotDateEntry()
 */
 PilotDateEntry::PilotDateEntry(struct AppointmentAppInfo &appInfo, PilotRecord * rec) :
-	PilotAppCategory(rec),
+	PilotRecordBase(rec),
 	fAppInfo(appInfo)
 {
 	::memset(&fAppointmentInfo, 0, sizeof(fAppointmentInfo));
 	if (rec)
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-		pi_buffer_t b;
-		b.data = (unsigned char *) rec->getData();
-		b.allocated = b.used = rec->size();
+		// Construct a fake pi_buffer for unpack_Appointment.
+		// No ownership changes occur here.
+		pi_buffer_t b = { (unsigned char *) rec->data(), rec->size(), rec->size() } ;
 		unpack_Appointment(&fAppointmentInfo, &b, datebook_v1);
-#else
-		unpack_Appointment(&fAppointmentInfo,
-			(unsigned char *) rec->data(), rec->size());
-#endif
 	}
 	return;
 
-	/* NOTREACHED */
-	/* Included to avoid warning that id isn't used. */
-	(void) pilotDateEntry_id;
 }
 
 void PilotDateEntry::_copyExceptions(const PilotDateEntry & e)
@@ -108,7 +95,7 @@
 
 
 PilotDateEntry::PilotDateEntry(const PilotDateEntry & e) :
-	PilotAppCategory(e),
+	PilotRecordBase(e),
 	fAppInfo(e.fAppInfo)
 {
 	::memcpy(&fAppointmentInfo, &e.fAppointmentInfo,
@@ -300,7 +287,10 @@
 	if (!isAlarmEnabled()) return 0;
 
 	int adv = getAdvance();
-	if ( adv < 0 ) return 0; // Not possible to enter on the pilot
+	if ( adv < 0 )
+	{
+		return 0; // Not possible to enter on the pilot
+	}
 	unsigned int t = adv;
 	int u = getAdvanceUnits();
 
@@ -316,25 +306,20 @@
 	return t;
 }
 
-QString PilotDateEntry::getCategoryLabel() const
+PilotRecord *PilotDateEntry::pack() const
 {
-	return codec()->toUnicode(fAppInfo.category.name[category()]);
-}
-
-void *PilotDateEntry::pack_(void *buf, int *len)
-{
 	int i;
 
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	pi_buffer_t b = { 0,0,0 } ;
-	i = pack_Appointment(&fAppointmentInfo, &b, datebook_v1);
-	memcpy(buf,b.data,kMin(i,*len));
-	*len = kMin(i,*len);
-#else
-	i = pack_Appointment(&fAppointmentInfo, (unsigned char *) buf, *len);
-	*len = i;
-#endif
-	return buf;
+	pi_buffer_t *b = pi_buffer_new( sizeof(fAppointmentInfo) );
+	i = pack_Appointment(const_cast<Appointment_t *>(&fAppointmentInfo), b, datebook_v1);
+	if (i<0)
+	{
+		// Generic error from the pack_*() functions.
+		return 0;
+	}
+
+	// pack_Appointment sets b->used
+	return new PilotRecord( b, this );
 }
 
 /* setExceptions sets a new set of exceptions. Note that
@@ -403,23 +388,74 @@
 
 void PilotDateEntry::setNote(const QString &s)
 {
-	QCString t = codec()->fromUnicode(s);
+	QCString t = Pilot::toPilot(s);
 	setNoteP( t.data(),t.length() );
 }
 
+void PilotDateEntry::setLocation(const QString &s)
+{
+	QString note = Pilot::fromPilot(getNoteP());
+	QRegExp rxp = QRegExp("^[Ll]ocation:[^\n]+\n");
+
+	if( s.isNull() )
+	{
+		note.replace(rxp,"");
+	}
+	else
+	{
+		QString location = "Location: " + s + "\n";
+		int pos = note.find(rxp);
+
+		if(pos >= 0)
+		{
+			note.replace( rxp, location );
+		}
+		else
+		{
+			note = location + note;
+			setNote( note );
+		}
+	}
+}
+
+QString PilotDateEntry::getLocation() const
+{
+	// Read the complete note here and not the filtered
+	// one from PilotDateEntry::getNote();
+	QString note = Pilot::fromPilot(getNoteP());
+	QRegExp rxp = QRegExp("^[Ll]ocation:[^\n]+\n");
+	int pos = note.find(rxp, 0);
+
+	if(pos >= 0)
+	{
+		QString location = rxp.capturedTexts().first();
+		rxp = QRegExp("^[Ll]ocation:[\\s|\t]*");
+		location.replace(rxp,"");
+		location.replace("\n", "");
+		return location;
+	}
+	else
+	{
+		return "";
+	}
+}
+
 void PilotDateEntry::setDescription(const QString &s)
 {
-	QCString t = codec()->fromUnicode(s);
+	QCString t = Pilot::toPilot(s);
 	setDescriptionP( t.data(),t.length() );
 }
 
 QString PilotDateEntry::getNote() const
 {
-	return codec()->toUnicode(getNoteP());
+	QString note = Pilot::fromPilot(getNoteP());
+	QRegExp rxp = QRegExp("^[Ll]ocation:[^\n]+\n");
+	note.replace(rxp, "" );
+	return note;
 }
 
 QString PilotDateEntry::getDescription() const
 {
-	return codec()->toUnicode(getDescriptionP());
+	return Pilot::fromPilot(getDescriptionP());
 }
 
Index: kpilot/lib/pilotDateEntry.h
===================================================================
--- kpilot/lib/pilotDateEntry.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotDateEntry.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,12 +32,13 @@
 */
 
 #include <qbitarray.h>
+#include <qdatetime.h>
 
 #include <pi-macros.h>
 #include <pi-datebook.h>
 
-#include "pilotAppCategory.h"
-#include "pilotDatabase.h"
+#include "pilotRecord.h"
+#include "pilotAppInfo.h"
 
 namespace KCal
 {
@@ -45,20 +46,23 @@
 }
 
 /** This class is a wrapper for pilot-link's datebook entries (struct Appointment). */
-class KDE_EXPORT PilotDateEntry : public PilotAppCategory
+class KDE_EXPORT PilotDateEntry : public PilotRecordBase
 {
 public:
 	/** Constructor. Sets the appinfo structure and zeroes out the appointment. */
 	PilotDateEntry(struct AppointmentAppInfo &appInfo);
 
 	/** Constructor. Interprets the given record as an appointment. */
-	PilotDateEntry(struct AppointmentAppInfo &appInfo, PilotRecord* rec);
+	PilotDateEntry(struct AppointmentAppInfo &appInfo, PilotRecord *rec);
 
 	/** Copy constructor. */
 	PilotDateEntry(const PilotDateEntry &e);
 
 	/** Destructor. */
-	~PilotDateEntry() { free_Appointment(&fAppointmentInfo); }
+	~PilotDateEntry()
+	{
+		free_Appointment(&fAppointmentInfo);
+	}
 
 	/** Assignment operator. */
 	PilotDateEntry& operator=(const PilotDateEntry &e);
@@ -67,7 +71,7 @@
 	* If @p richText is true, then the text representation uses qt style
 	* tags as well.
 	*/
-	virtual QString getTextRepresentation(bool richText=false);
+	QString getTextRepresentation(bool richText=false);
 
 	/** Is this appointment a "floating" appointment?
 	*
@@ -77,13 +81,18 @@
 	*  as opposed to a regular "appointment", which does normally have a time
 	*  associated with it.
 	*/
-	bool doesFloat() const { return fAppointmentInfo.event; }
+	inline bool doesFloat() const
+	{
+		return fAppointmentInfo.event;
+	}
+
 	/** Is this a non-time-related event as opposed to an appointment that has a
 	* time associated with it?.
 	*/
-	inline bool isEvent() const { return doesFloat(); }
-	/** A synonym for isEvent, deprecated. */
-	int KDE_DEPRECATED getEvent() const { return doesFloat(); }
+	inline bool isEvent() const
+	{
+		return doesFloat();
+	}
 
 	/** Sets this appointment's floating status.
 	*
@@ -93,16 +102,26 @@
 	*  as opposed to a regular "appointment", which does normally have a time
 	*  associated with it.
 	*/
-	void setFloats(bool f) { fAppointmentInfo.event = (f ? 1 : 0) /* Force 1 or 0 */ ; }
-	/** Synonym for setFloats() */
-	void KDE_DEPRECATED setEvent(int event) { setFloats( event ); }
+	inline void setFloats(bool f)
+	{
+		fAppointmentInfo.event = (f ? 1 : 0) /* Force 1 or 0 */ ;
+	}
 
 	/** Get the start time of this appointment.  See dtStart() for caveats. */
-	struct tm getEventStart() const { return fAppointmentInfo.begin; }
+	inline struct tm getEventStart() const { return fAppointmentInfo.begin; }
+
 	/** Get a pointer to the start time of this appointment.  See dtStart() for caveats. */
-	const struct tm *getEventStart_p() const { return &fAppointmentInfo.begin; }
+	inline const struct tm *getEventStart_p() const
+	{
+		return &fAppointmentInfo.begin;
+	}
+
 	/** Sets the start time of this appointment. */
-	void setEventStart(struct tm& start) { fAppointmentInfo.begin = start; }
+	inline void setEventStart(struct tm& start)
+	{
+		fAppointmentInfo.begin = start;
+	}
+
 	/** Get the start time of this appointment. For floating appointments, the
 	* time is undefined (perhaps 1 minute past midnight).
 	*
@@ -112,11 +131,23 @@
 	QDateTime dtStart() const;
 
 	/** Get the end time of this appointment.  See dtEnd() for caveats. */
-	struct tm getEventEnd() const { return fAppointmentInfo.end; }
+	inline struct tm getEventEnd() const
+	{
+		return fAppointmentInfo.end;
+	}
+
 	/** Get a pointer to the end time of this appointment.  See dtEnd() for caveats. */
-	const struct tm *getEventEnd_p() const { return &fAppointmentInfo.end; }
+	inline const struct tm *getEventEnd_p() const
+	{
+		return &fAppointmentInfo.end;
+	}
+
 	/** Set the end time of this appointment. */
-	void setEventEnd(struct tm& end) { fAppointmentInfo.end = end; }
+	inline void setEventEnd(struct tm& end)
+	{
+		fAppointmentInfo.end = end;
+	}
+
 	/** Get the end time of this appointment. For floating appointments, the
 	* time is undefined (perhaps 1 minute past midnight).
 	*
@@ -129,13 +160,16 @@
 	* may have an alarm (or not). If it has one, it is also enabled and
 	* causes the Pilot to beep (or whatever is set in the system preferences).
 	*/
-	bool isAlarmEnabled() const { return fAppointmentInfo.alarm; }
-	/** Does this appointment have an alarm set?  See isAlarmEnabled() */
-	int KDE_DEPRECATED getAlarm() const { return fAppointmentInfo.alarm; }
+	inline bool isAlarmEnabled() const
+	{
+		return fAppointmentInfo.alarm;
+	}
+
 	/** Set whether this appointment has an alarm. */
-	void KDE_DEPRECATED setAlarm(int alarm) { fAppointmentInfo.alarm = alarm; }
-	/** Set whether this appointment has an alarm. */
-	void setAlarmEnabled(bool b) { fAppointmentInfo.alarm = (b?1:0) /* Force to known int values */ ; }
+	inline void setAlarmEnabled(bool b)
+	{
+		fAppointmentInfo.alarm = (b?1:0) /* Force to known int values */ ;
+	}
 
 	/** Get the numeric part of "alarm: __ (v) minutes" on the pilot -- you
 	* set the alarm time in two parts, a number and a unit type to use; unit
@@ -146,14 +180,28 @@
 	* @see alarmLeadTime()
 	* @see dtAlarm()
 	*/
-	int getAdvance() const { return fAppointmentInfo.advance; }
+	inline int getAdvance() const
+	{
+		return fAppointmentInfo.advance;
+	}
+
 	/** Set the numeric part of the alarm setting.  See getAdvance for details. */
-	void setAdvance(int advance) { fAppointmentInfo.advance = advance; }
+	inline void setAdvance(int advance)
+	{
+		fAppointmentInfo.advance = advance;
+	}
 
 	/** Returns the units part of the alarm time.  See getAdvance . */
-	int getAdvanceUnits() const { return fAppointmentInfo.advanceUnits; }
+	inline int getAdvanceUnits() const
+	{
+		return fAppointmentInfo.advanceUnits;
+	}
+
 	/** Sets the unites part of the alarm time.  See getAdvance . */
-	void setAdvanceUnits(int units) { fAppointmentInfo.advanceUnits = units; }
+	inline void setAdvanceUnits(int units)
+	{
+		fAppointmentInfo.advanceUnits = units;
+	}
 
 	/** Returns the number of @em seconds "lead time" the alarm should sound
 	* before the actual appointment. This interprets the advance number and units.
@@ -164,43 +212,95 @@
 	/** Returns the absolute date and time that the alarm should sound for
 	* this appointment.
 	*/
-	QDateTime dtAlarm() const { return dtStart().addSecs(-alarmLeadTime()); }
+	inline QDateTime dtAlarm() const
+	{
+		return dtStart().addSecs(-alarmLeadTime());
+	}
 
-  // The following need set routines written
-  repeatTypes getRepeatType() const { return fAppointmentInfo.repeatType; }
-  void setRepeatType(repeatTypes r) { fAppointmentInfo.repeatType = r; }
+	// The following need set routines written
+	inline repeatTypes getRepeatType() const
+	{
+		return fAppointmentInfo.repeatType;
+	}
+	inline void setRepeatType(repeatTypes r)
+	{
+		fAppointmentInfo.repeatType = r;
+	}
 
-  int getRepeatForever() const { return fAppointmentInfo.repeatForever; }
-  void setRepeatForever(int f = 1) { fAppointmentInfo.repeatForever = f; }
+	inline int getRepeatForever() const
+	{
+		return fAppointmentInfo.repeatForever;
+	}
+	inline void setRepeatForever(int f = 1)
+	{
+		fAppointmentInfo.repeatForever = f;
+	}
 
-  struct tm getRepeatEnd() const { return fAppointmentInfo.repeatEnd; }
-  void setRepeatEnd(struct tm tm) { fAppointmentInfo.repeatEnd = tm; }
+	inline struct tm getRepeatEnd() const
+	{
+		return fAppointmentInfo.repeatEnd;
+	}
+	inline void setRepeatEnd(struct tm tm)
+	{
+		fAppointmentInfo.repeatEnd = tm;
+	}
+
 	/** Returns the date and time that the repeat ends. If there is no repeat,
 	* returns an invalid date and time.
 	*/
 	QDateTime dtRepeatEnd() const;
 
-  int getRepeatFrequency() const { return fAppointmentInfo.repeatFrequency; }
-  void setRepeatFrequency(int f) { fAppointmentInfo.repeatFrequency = f; }
+	inline int getRepeatFrequency() const
+	{
+		return fAppointmentInfo.repeatFrequency;
+	}
+	inline void setRepeatFrequency(int f)
+	{
+		fAppointmentInfo.repeatFrequency = f;
+	}
 
-  DayOfMonthType getRepeatDay() const { return fAppointmentInfo.repeatDay; }
-  void setRepeatDay(DayOfMonthType rd) { fAppointmentInfo.repeatDay = rd; };
+	inline DayOfMonthType getRepeatDay() const
+	{
+		return fAppointmentInfo.repeatDay;
+	}
+	inline void setRepeatDay(DayOfMonthType rd)
+	{
+		fAppointmentInfo.repeatDay = rd;
+	};
 
-  const int *getRepeatDays() const { return fAppointmentInfo.repeatDays; }
-  void setRepeatDays(int *rd) {
-    for (int i = 0; i < 7; i++)
-      fAppointmentInfo.repeatDays[i] = rd[i];
-  }
-  void setRepeatDays(QBitArray rba) {
-    for (int i = 0; i < 7; i++)
-      fAppointmentInfo.repeatDays[i] = (rba[i] ? 1 : 0);
-  }
+	inline const int *getRepeatDays() const
+	{
+		return fAppointmentInfo.repeatDays;
+	}
+	inline void setRepeatDays(int *rd)
+	{
+		for (int i = 0; i < 7; i++)
+		{
+			fAppointmentInfo.repeatDays[i] = rd[i];
+		}
+	}
+	inline void setRepeatDays(QBitArray rba)
+	{
+		for (int i = 0; i < 7; i++)
+		{
+			fAppointmentInfo.repeatDays[i] = (rba[i] ? 1 : 0);
+		}
+	}
 
-  int getExceptionCount() const { return fAppointmentInfo.exceptions; }
-  void setExceptionCount(int e) { fAppointmentInfo.exceptions = e; }
+	inline int getExceptionCount() const
+	{
+		return fAppointmentInfo.exceptions;
+	}
+	inline void setExceptionCount(int e)
+	{
+		fAppointmentInfo.exceptions = e;
+	}
 
-  const struct tm *getExceptions() const { return fAppointmentInfo.exception; }
-  void setExceptions(struct tm *e);
+	inline const struct tm *getExceptions() const
+	{
+		return fAppointmentInfo.exception;
+	}
+	void setExceptions(struct tm *e);
 
 	/** Sets the description of the appointment. This is the short string
 	* entered in the day view on the handheld, and it is called the summary
@@ -218,32 +318,64 @@
 	/** Gets the note for this appointment.  See setNote for meaning. */
 	QString getNote() const;
 
+	/**
+	 * Sets the location for the appointment. For now it will be placed within
+	 * the notes on the handheld. It will be placed on one line and starts with:
+	 * Location: {location}. Everything on that line will be counted as location.
+	 * TODO: Make distinguish between handhelds that support the location field
+	 * and the ones that don't. (Shouldn't this be done in the pilot-link lib?)
+	 */
+	void setLocation(const QString &);
+
+	/** Gets the location for this appointment.  See setNote for meaning. */
+	QString getLocation() const;
+
 protected:
 	void  setDescriptionP(const char* desc, int l=-1);
-	const char* getDescriptionP() const { return fAppointmentInfo.description; }
+	const char* getDescriptionP() const
+	{
+		return fAppointmentInfo.description;
+	}
 
 	void  setNoteP(const char* note, int l=-1);
-	const char* getNoteP() const { return fAppointmentInfo.note; }
+	const char* getNoteP() const
+	{
+		return fAppointmentInfo.note;
+	}
 
 public:
-  bool isMultiDay() const {
-    return ((fAppointmentInfo.repeatType == repeatDaily) &&
-            (fAppointmentInfo.repeatFrequency == 1) &&
-            ( !getRepeatForever() ) &&
-            !doesFloat() );
-  }
+	bool isMultiDay() const
+	{
+	return ((fAppointmentInfo.repeatType == repeatDaily) &&
+		(fAppointmentInfo.repeatFrequency == 1) &&
+		( !getRepeatForever() ) &&
+		!doesFloat() );
+	}
 
-  QString getCategoryLabel() const;
-  inline bool setCategory(const QString &label) { return PilotAppCategory::setCategory(fAppInfo.category,label); } ;
-  static const int KDE_DEPRECATED APP_BUFFER_SIZE;
+	inline QString getCategoryLabel() const
+	{
+		return Pilot::categoryName(&(fAppInfo.category),category());
+	}
+	inline bool setCategory(const QString &label)
+	{
+		int c = Pilot::insertCategory(&fAppInfo.category,label,false);
+		PilotRecordBase::setCategory(c);
+		return c>=0;
+	} ;
 
-protected:
-  void *pack_(void *buf, int *size);
-  void unpack(const void *buf, int size = 0) { }
+	PilotRecord *pack() const;
 
+	/** @return A reference to the appinfo block of the database
+	*          holding this entry.
+	*/
+	const AppointmentAppInfo &appInfo()
+	{
+		return fAppInfo;
+	}
+
 private:
-  struct Appointment fAppointmentInfo;
-        struct AppointmentAppInfo &fAppInfo;
+	struct Appointment fAppointmentInfo;
+	struct AppointmentAppInfo &fAppInfo;
 	void _copyExceptions(const PilotDateEntry &e);
 };
 
Index: kpilot/lib/pilotDatabase.cc
===================================================================
--- kpilot/lib/pilotDatabase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotDatabase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,8 @@
 /* KPilot
 **
 ** Copyright (C) 1998-2001 by Dan Pilone
+** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2005-2006 Adriaan de Groot <groot@kde.org>
 **
 ** This is the abstract base class for databases, which is used both
 ** by local databases and by the serial databases held in the Pilot.
@@ -33,12 +35,11 @@
 #include <pi-appinfo.h>
 
 #include <qstringlist.h>
-#include <qtextcodec.h>
 
 #include <kglobal.h>
 
 #include "pilotDatabase.h"
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 
 static int creationCount = 0;
 static QStringList *createdNames = 0L;
@@ -66,23 +67,21 @@
 	}
 }
 
-/* static */ int PilotDatabase::count()
+/* static */ int PilotDatabase::instanceCount()
 {
 	FUNCTIONSETUP;
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": " << creationCount << " databases." << endl;
+	DEBUGLIBRARY << fname << ": " << creationCount << " databases." << endl;
 	if (createdNames)
 	{
-		DEBUGDAEMON << fname << ": "
+		DEBUGLIBRARY << fname << ": "
 			<< createdNames->join(CSL1(",")) << endl;
 	}
-#endif
 	return creationCount;
 }
 
-/* virtual */ RecordIDList PilotDatabase::idList()
+/* virtual */ Pilot::RecordIDList PilotDatabase::idList()
 {
-	RecordIDList l;
+	Pilot::RecordIDList l;
 
 	for (unsigned int i = 0 ; ; i++)
 	{
@@ -95,9 +94,9 @@
 	return l;
 }
 
-/* virtual */ RecordIDList PilotDatabase::modifiedIDList()
+/* virtual */ Pilot::RecordIDList PilotDatabase::modifiedIDList()
 {
-	RecordIDList l;
+	Pilot::RecordIDList l;
 
 	resetDBIndex();
 	while(1)
@@ -111,94 +110,3 @@
 	return l;
 }
 
-PilotAppInfoBase::PilotAppInfoBase(PilotDatabase *d) : fC(new struct CategoryAppInfo), fLen(0), fOwn(true)
-{
-	FUNCTIONSETUP;
-	int appLen = MAX_APPINFO_SIZE;
-	unsigned char buffer[MAX_APPINFO_SIZE];
-
-	fLen = appLen = d->readAppBlock(buffer,appLen);
-	unpack_CategoryAppInfo(fC, buffer, appLen);
-}
-
-PilotAppInfoBase::~PilotAppInfoBase()
-{
-	if (fOwn) delete fC;
-}
-
-
-int PilotAppInfoBase::findCategory(const QString &selectedCategory,
-	bool unknownIsUnfiled, struct CategoryAppInfo *info)
-{
-	FUNCTIONSETUP;
-
-	int currentCatID = -1;
-	for (int i=0; i<PILOT_CATEGORY_MAX; i++)
-	{
-		if (!info->name[i][0]) continue;
-		if (selectedCategory ==
-			PilotAppCategory::codec()->toUnicode(info->name[i]))
-		{
-			currentCatID = i;
-			break;
-		}
-	}
-
-#ifdef DEBUG
-	if (-1 == currentCatID)
-	{
-		DEBUGKPILOT << fname << ": Category name "
-			<< selectedCategory << " not found." << endl;
-	}
-	else
-	{
-		DEBUGKPILOT << fname << ": Matched category " << currentCatID << endl;
-	}
-#endif
-
-	if ((currentCatID == -1) && unknownIsUnfiled)
-		currentCatID = 0;
-	return currentCatID;
-}
-
-void PilotAppInfoBase::dumpCategories(const struct CategoryAppInfo &info)
-{
-#ifdef DEBUG
-	FUNCTIONSETUP;
-	DEBUGCONDUIT << fname << " lastUniqueId"
-		<< info.lastUniqueID << endl;
-	for (int i = 0; i < PILOT_CATEGORY_MAX; i++)
-	{
-		if (!info.name[i][0]) continue;
-		DEBUGCONDUIT << fname << ": " << i << " = "
-			<< info.ID[i] << " <"
-			<< info.name[i] << ">" << endl;
-	}
-#else
-	Q_UNUSED(info);
-#endif
-}
-
-void PilotAppInfoBase::dump() const
-{
-	dumpCategories(*categoryInfo());
-}
-
-
-QString PilotAppInfoBase::category(unsigned int i)
-{
-	if (i>=PILOT_CATEGORY_MAX) return QString::null;
-	return PilotAppCategory::codec()->toUnicode(categoryInfo()->name[i],PILOT_CATEGORY_SIZE-1);
-}
-
-bool PilotAppInfoBase::setCategoryName(unsigned int i, const QString &s)
-{
-	if (i>=PILOT_CATEGORY_MAX) return false;
-	int len = PILOT_CATEGORY_SIZE - 1;
-	QCString t = PilotAppCategory::codec()->fromUnicode(s,len);
-	memset(categoryInfo()->name[i],0,PILOT_CATEGORY_SIZE);
-	qstrncpy(categoryInfo()->name[i],t,PILOT_CATEGORY_SIZE);
-	return true;
-}
-
-
Index: kpilot/lib/syncAction.h
===================================================================
--- kpilot/lib/syncAction.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/syncAction.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -49,16 +49,24 @@
 Q_OBJECT
 
 public:
-	SyncAction(KPilotDeviceLink *p,
+	SyncAction(KPilotLink *p,
 		const char *name=0L);
-	SyncAction(KPilotDeviceLink *p,
+	SyncAction(KPilotLink *p,
 		QWidget *visibleparent,
 		const char *name=0L);
 	~SyncAction();
 
 	typedef enum { Error=-1 } Status;
 
-	int status() const { return fActionStatus; } ;
+	/** A syncaction has a status, which can be expressed as an
+	*   integer. Subclasses are expected to define their own status
+	*   values as needed.
+	*/
+	int status() const
+	{
+		return fActionStatus;
+	}
+	/** Return a human-readable representation of the status. */
 	virtual QString statusString() const;
 
 protected:
@@ -90,6 +98,14 @@
 	void logError(const QString &);
 	void logProgress(const QString &,int);
 
+protected slots:
+	/** This slot emits syncDone(), and does nothing else. This
+	*   is safe, since the method returns immediately after the
+	*   emit -- even if syncDone() causes the SyncAction to be deleted.
+	*/
+	void delayedDoneSlot();
+
+protected:
 	/**
 	* It might not be safe to emit syncDone() from exec().
 	* So instead, call delayDone() to wait for the main event
@@ -99,37 +115,68 @@
 	* delayDone() returns true, so that return delayDone();
 	* is a sensible final statement in exec().
 	*/
-protected slots:
-	void delayedDoneSlot();
-
-protected:
 	bool delayDone();
 
 public:
+	/** Public API for adding a sync log entry, see the implementation
+	*   in KPilotLink::addSyncLogEntry().
+	* @param e   Message to add to the sync log
+	* @param log If @c true, also add the entry to the log in KPilot
+	* @note Having messages appear on the handheld but not in KPilot
+	*       should be a @em very rare occurrence.
+	*/
 	void addSyncLogEntry(const QString &e,bool log=true)
-		{ if (deviceLink()) { deviceLink()->addSyncLogEntry(e,log); } } ;
-	void addLogMessage( const QString &msg ) { emit logMessage( msg ); }
-	void addLogError( const QString &msg ) { emit logError( msg ); }
-	void addLogProgress( const QString &msg, int prog ) { emit logProgress( msg, prog ); }
+	{
+		if (deviceLink())
+		{
+			deviceLink()->addSyncLogEntry(e,log);
+		}
+	}
+	/** Public API for adding a message to the log in KPilot.
+	*   Adds @p msg to the synclog maintained on the PC.
+	*/
+	void addLogMessage( const QString &msg )
+	{
+		emit logMessage( msg );
+	}
+	/** Log an error message in KPilot (the PC side of things). */
+	void addLogError( const QString &msg )
+	{
+		emit logError( msg );
+	}
+	/** Log progress in KPilot (the PC side of things). */
+	void addLogProgress( const QString &msg, int prog )
+	{
+		emit logProgress( msg, prog );
+	}
 protected:
 	/** Connection to the device. @todo make private. */
-	KPilotDeviceLink *fHandle;
+	KPilotLink *fHandle;
 	int fActionStatus;
 
 	/** Returns a pointer to the connection to the device. */
-	inline KPilotDeviceLink *deviceLink() const { return fHandle; } ;
+	inline KPilotLink *deviceLink() const
+	{
+		return fHandle;
+	}
 
 	/** Returns the file descriptor for the device link -- that is,
 	* the raw handle to the OS's connection to the device. Use with care.
 	* May return -1 if there is no device.
 	*/
-	int pilotSocket() const { return deviceLink() ? deviceLink()->pilotSocket() : -1 ; } ;
+	int pilotSocket() const
+	{
+		return deviceLink() ? deviceLink()->pilotSocket() : -1 ;
+	}
 
 	/** Tells the handheld device that someone is talking to it now.
 	* Useful (repeatedly) to inform the user of what is going on.
 	* May return < 0 on error (or if there is no device attached).
 	*/
-	int openConduit() { return deviceLink() ? deviceLink()->openConduit() : -1; } ;
+	int openConduit()
+	{
+		return deviceLink() ? deviceLink()->openConduit() : -1;
+	}
 public:
 	/**
 	* This class encapsulates the different sync modes that
@@ -146,13 +193,12 @@
 	public:
 		/** Available modes for the sync. */
 		enum Mode {
-		eFastSync=1,
-		eHotSync=2,
-		eFullSync=3,
-		eCopyPCToHH=4,
-		eCopyHHToPC=5,
-		eBackup=6,
-		eRestore=7
+			eHotSync=1,
+			eFullSync=2,
+			eCopyPCToHH=3,
+			eCopyHHToPC=4,
+			eBackup=5,
+			eRestore=6
 		} ;
 
 		/** Create a mode with the given Mode @p m and
@@ -173,14 +219,18 @@
 		/** Returns the kind of sync; this is just incomplete
 		* information, since a test hot sync is very different from
 		* a non-test one. */
-		Mode mode() const { return fMode; };
+		Mode mode() const
+		{
+			return fMode;
+		}
 
 		/** Sets a mode from an integer @p mode, if possible.
 		* If the @p mode is illegal, return false and set the
-		* mode to Fast Sync. As a side effect, options test and local
+		* mode to Hot Sync. As a side effect, options test and local
 		* are reset to false.
 		*/
 		bool setMode(int);
+
 		/** Sets a mode from a @p mode, if possible. This leaves
 		* the options unchanged, so as to reward properly-typed programming.
 		*/
@@ -188,12 +238,23 @@
 
 		/** Sets options. Returns false if the combination of mode
 		* and the options is impossible. */
-		bool setOptions(bool test, bool local) { fTest=test; fLocal=local; return true; } ;
+		bool setOptions(bool test, bool local)
+		{
+			fTest=test;
+			fLocal=local;
+			return true;
+		}
 
 		/** Shorthand to test for a specific mode enum. This disregards
-		* the mixings local and test.
+		*   the mixings local and test.
 		*/
-		bool operator ==(const Mode &m) const { return mode() == m; } ;
+		bool operator ==(const Mode &m) const
+		{
+			return mode() == m;
+		}
+		/** Longhand comparison. Compares two modes for the same
+		*   mode enum and mixins local and test.
+		*/
 		bool operator ==(const SyncMode &m) const
 		{
 			return ( mode() == m.mode() ) &&
@@ -202,16 +263,21 @@
 		} ;
 
 		/** Accessor for the test part of the mode. Test syncs should
-		* never actually modify data anywhere.
+		*   never actually modify data anywhere.
 		*/
-		bool isTest() const { return fTest; };
+		bool isTest() const
+		{
+			return fTest;
+		}
 
 		/** Accessor for the local part of the mode. Local syncs use a
-		* local database instead of one on the device link.
+		*   local database instead of one on the device link.
 		*/
-		bool isLocal() const { return fLocal; };
+		bool isLocal() const
+		{
+			return fLocal;
+		}
 
-
 		bool isFullSync() const
 		{
 			return	( fMode==eFullSync  ) ||
@@ -227,8 +293,7 @@
 		bool isSync() const
 		{
 			return ( fMode==eFullSync ) ||
-				( fMode == eHotSync ) ||
-				( fMode == eFastSync );
+				( fMode == eHotSync );
 		} ;
 
 		/** Classify every mode as either a sync (two-way) or copy (one-way) mode. */
@@ -244,6 +309,7 @@
 		* Returns a standard name for each of the sync modes.
 		*/
 		static QString name(Mode);
+
 		/**
 		* Returns a (human readable) name for this particular mode,
 		* including extra information about test and local mode.
@@ -277,6 +343,17 @@
 		eCROffset=-1
 	};
 
+	/**
+	 * This MUST stay in sync with the combobox in
+	 * kpilotConfigDialog_backup.ui.  If it does not, you need to
+	 * either change this enum or the combobox.
+	 */
+	enum BackupFrequency
+	{
+		eEveryHotSync=0,
+		eOnRequestOnly
+	};
+
 protected:
 	/**
 	* Call startTickle() some time before showing a dialog to the
Index: kpilot/lib/pilotLinkVersion.h
===================================================================
--- kpilot/lib/pilotLinkVersion.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotLinkVersion.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,5 @@
-#ifndef PILOTLINKVERSION_H
-#define PILOTLINKVERSION_H
+#ifndef _KPILOT_PILOTLINKVERSION_H
+#define _KPILOT_PILOTLINKVERSION_H
 
 /* pilotLinkVersion.h                           KPilot
 **
@@ -34,7 +34,7 @@
 #include <pi-version.h>
 
 #ifndef PILOT_LINK_VERSION
-#error "You need at least pilot-link version 0.9.5"
+#error "You need at least pilot-link version 0.12.0"
 #endif
 
 
@@ -44,16 +44,13 @@
 #define PILOT_LINK_0_11_0	(1100)
 #define PILOT_LINK_0_11_8	(1108)
 #define PILOT_LINK_0_12_0	(1200)
+#define PILOT_LINK_0_12_1	(1201)
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_11_8
-#warning "You need at least pilot-link version 0.11.8 for modern devices"
+#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
+#error "You need at least pilot-link version 0.12.0 for KPilot"
 #endif
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-#define PI_SIZE_T int
-#else
 #define PI_SIZE_T size_t
-#endif
 
 
 #endif
Index: kpilot/lib/pilotSerialDatabase.h
===================================================================
--- kpilot/lib/pilotSerialDatabase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotSerialDatabase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,19 +35,23 @@
 #include "pilotDatabase.h"
 #include "pilotRecord.h"
 
+class KPilotDeviceLink;
 
 class KDE_EXPORT PilotSerialDatabase : public PilotDatabase
 {
+friend class KPilotDeviceLink;
+protected:
+	PilotSerialDatabase( KPilotDeviceLink *l, const QString &dbName);
+
 public:
-	PilotSerialDatabase(int linksocket, const QString &dbName);
 	virtual ~PilotSerialDatabase();
 
 	/** Reads the application block info, returns size */
 	virtual int readAppBlock(unsigned char* buffer, int maxLen);
 	/** Writes the application block info. */
 	virtual int writeAppBlock(unsigned char* buffer, int len);
-	/**  returns the number of records in the database */
-	virtual int recordCount();
+	/**  returns the number of records in the database, 0 if not open */
+	virtual unsigned int recordCount() const;
 	/** Returns a QValueList of all record ids in the database. */
 	 virtual QValueList<recordid_t> idList();
 	/** Reads a record from database by id, returns record length */
@@ -105,7 +109,13 @@
 protected:
 	virtual void openDatabase();
 	virtual void closeDatabase();
-	int getDBHandle() { return fDBHandle; }
+	/** Returns the file handle used to communicate with the handheld.
+	*   This is an internal value to be passed to DLP functions.
+	*/
+	int getDBHandle() const
+	{
+		return fDBHandle;
+	}
 
 
 private:
@@ -114,14 +124,12 @@
 	QString     fDBName;
 	int         fDBHandle;
 	int         fDBSocket;
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 	// Pilot-link 0.12 allocates buffers as needed and resizes them.
 	// Start with a buffer that is _probably_ big enough for most 
 	// PIM records, but much smaller than the 64k that we use otherwise.
 	// Might want to add algorithm for trying to optimize the initial 
 	// allocation for a given database.
 	static const int InitialBufferSize = 2048;
-#endif
 };
 
 #endif
Index: kpilot/lib/kpilotlink.cc
===================================================================
--- kpilot/lib/kpilotlink.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/kpilotlink.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,6 +2,7 @@
 **
 ** Copyright (C) 1998-2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 */
 
@@ -25,7 +26,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *kpilotlink_id = "$Id$";
 
 #include "options.h"
 
@@ -44,29 +44,231 @@
 #include <pi-socket.h>
 #include <pi-dlp.h>
 #include <pi-file.h>
-#if !(PILOT_LINK_NUMBER < PILOT_LINK_0_12_0)
 #include <pi-buffer.h>
-#endif
 
 #include <qdir.h>
 #include <qtimer.h>
 #include <qdatetime.h>
 #include <qsocketnotifier.h>
 #include <qthread.h>
-#include <qtextcodec.h>
 
 #include <kconfig.h>
 #include <kmessagebox.h>
 #include <kstandarddirs.h>
+#include <kurl.h>
+#include <kio/netaccess.h>
 
 #include "pilotUser.h"
 #include "pilotSysInfo.h"
 #include "pilotCard.h"
-#include "pilotAppCategory.h"
+#include "pilotSerialDatabase.h"
+#include "pilotLocalDatabase.h"
 
 #include "kpilotlink.moc"
+#include "kpilotdevicelink.moc"
+#include "kpilotlocallink.moc"
 
+/** Class that handles periodically tickling the handheld through
+*   the virtual tickle() method; deals with cancels through the
+*   shared fDone variable.
+*/
+class TickleThread : public QThread
+{
+public:
+	TickleThread(KPilotLink *d, bool *done, int timeout) :
+		QThread(),
+		fHandle(d),
+		fDone(done),
+		fTimeout(timeout)
+	{ };
+	virtual ~TickleThread();
 
+	virtual void run();
+
+	static const int ChecksPerSecond = 5;
+	static const int SecondsPerTickle = 5;
+	static const unsigned int TickleTimeoutEvent = 1066;
+
+private:
+	KPilotLink *fHandle;
+	bool *fDone;
+	int fTimeout;
+} ;
+
+TickleThread::~TickleThread()
+{
+}
+
+void TickleThread::run()
+{
+	FUNCTIONSETUP;
+	int subseconds = ChecksPerSecond;
+	int ticktock = SecondsPerTickle;
+	int timeout = fTimeout;
+	DEBUGLIBRARY << fname << ": Running for " 
+		<< timeout << " seconds." << endl;
+	DEBUGLIBRARY << fname << ": Done @" << (void *) fDone << endl;
+
+	while (!(*fDone))
+	{
+		QThread::msleep(1000/ChecksPerSecond);
+		if (!(--subseconds))
+		{
+			if (timeout)
+			{
+				if (!(--timeout))
+				{
+					QApplication::postEvent(fHandle, new QEvent(static_cast<QEvent::Type>(TickleTimeoutEvent)));
+					break;
+				}
+			}
+			subseconds=ChecksPerSecond;
+			if (!(--ticktock))
+			{
+				ticktock=SecondsPerTickle;
+				fHandle->tickle();
+			}
+		}
+	}
+}
+
+
+
+
+
+
+
+
+KPilotLink::KPilotLink( QObject *parent, const char *name ) :
+	QObject( parent, name ),
+	fPilotPath(QString::null),
+	fPilotUser(0L),
+	fPilotSysInfo(0L),
+	fTickleDone(true),
+	fTickleThread(0L)
+
+{
+	FUNCTIONSETUP;
+
+	fPilotUser = new KPilotUser();
+	strncpy( fPilotUser->pilotUser()->username, "Henk Westbroek",
+		sizeof(fPilotUser->pilotUser()->username)-1);
+	fPilotUser->setLastSuccessfulSyncDate( 1139171019 );
+
+	fPilotSysInfo = new KPilotSysInfo();
+	memset(fPilotSysInfo->sysInfo()->prodID, 0,
+		sizeof(fPilotSysInfo->sysInfo()->prodID));
+	strncpy(fPilotSysInfo->sysInfo()->prodID, "LocalLink",
+		sizeof(fPilotSysInfo->sysInfo()->prodID)-1);
+	fPilotSysInfo->sysInfo()->prodIDLength =
+		strlen(fPilotSysInfo->sysInfo()->prodID);
+}
+
+KPilotLink::~KPilotLink()
+{
+	FUNCTIONSETUP;
+	KPILOT_DELETE(fPilotUser);
+	KPILOT_DELETE(fPilotSysInfo);
+}
+
+/* virtual */ bool KPilotLink::event(QEvent *e)
+{
+	if (e->type() == TickleThread::TickleTimeoutEvent)
+	{
+		stopTickle();
+		emit timeout();
+		return true;
+	}
+	else	return QObject::event(e);
+}
+
+/*
+Start a tickle thread with the indicated timeout.
+*/
+void KPilotLink::startTickle(unsigned int timeout)
+{
+	FUNCTIONSETUP;
+
+	Q_ASSERT(fTickleDone);
+
+	/*
+	** We've told the thread to finish up, but it hasn't
+	** done so yet - so wait for it to do so, should be
+	** only 200ms at most.
+	*/
+	if (fTickleDone && fTickleThread)
+	{
+		fTickleThread->wait();
+		KPILOT_DELETE(fTickleThread);
+	}
+
+	DEBUGLIBRARY << fname << ": Done @" << (void *) (&fTickleDone) << endl;
+
+	fTickleDone = false;
+	fTickleThread = new TickleThread(this,&fTickleDone,timeout);
+	fTickleThread->start();
+}
+
+void KPilotLink::stopTickle()
+{
+	FUNCTIONSETUP;
+	fTickleDone = true;
+	if (fTickleThread)
+	{
+		fTickleThread->wait();
+		KPILOT_DELETE(fTickleThread);
+	}
+}
+
+unsigned int KPilotLink::installFiles(const QStringList & l, const bool deleteFiles)
+{
+	FUNCTIONSETUP;
+
+	QStringList::ConstIterator i,e;
+	unsigned int k = 0;
+	unsigned int n = 0;
+	unsigned int total = l.count();
+
+	for (i = l.begin(), e = l.end(); i != e; ++i)
+	{
+		emit logProgress(QString::null,
+			(int) ((100.0 / total) * (float) n));
+
+		if (installFile(*i, deleteFiles))
+			k++;
+		n++;
+	}
+	emit logProgress(QString::null, 100);
+
+	return k;
+}
+
+void KPilotLink::addSyncLogEntry(const QString & entry, bool log)
+{
+	FUNCTIONSETUP;
+	if (entry.isEmpty()) return;
+
+	addSyncLogEntryImpl(entry);
+	if (log)
+	{
+		emit logMessage(entry);
+	}
+}
+
+
+/* virtual */ int KPilotLink::openConduit()
+{
+	return 0;
+}
+
+/* virtual */ int KPilotLink::pilotSocket() const
+{
+	return -1;
+}
+
+
+
+
 // singleton helper class
 class KPilotDeviceLink::KPilotDeviceLinkPrivate
 {
@@ -77,19 +279,19 @@
 		return mThis;
 	}
 
-	bool canBind( QString device )
+	bool canBind( const QString &device )
 	{
 		showList();
 		return !mBoundDevices.contains( device );
 	}
 
-	void bindDevice( QString device )
+	void bindDevice( const QString &device )
 	{
 		mBoundDevices.append( device );
 		showList();
 	}
 
-	void unbindDevice( QString device )
+	void unbindDevice( const QString &device )
 	{
 		mBoundDevices.remove( device );
 		showList();
@@ -105,11 +307,10 @@
 private:
 	inline void showList() const
 	{
-#ifdef DEBUG
+		if ( !(mBoundDevices.count() > 0) ) return;
 		FUNCTIONSETUPL(3);
-		DEBUGDAEMON << fname << "Bound devices: "
+		DEBUGLIBRARY << fname << ": Bound devices: "
 			<< ((mBoundDevices.count() > 0) ? mBoundDevices.join(CSL1(", ")) : CSL1("<none>")) << endl;
-#endif
 	}
 } ;
 
@@ -117,34 +318,26 @@
 
 
 KPilotDeviceLink::KPilotDeviceLink(QObject * parent, const char *name, const QString &tempDevice) :
-	QObject(parent, name),
+	KPilotLink(parent, name),
 	fLinkStatus(Init),
-	fTickleDone(true),
-	fTickleThread(0L),
 	fWorkaroundUSB(false),
 	fWorkaroundUSBTimer(0L),
-	fPilotPath(QString::null),
 	fRetries(0),
 	fOpenTimer(0L),
 	fSocketNotifier(0L),
 	fSocketNotifierActive(false),
 	fPilotMasterSocket(-1),
 	fCurrentPilotSocket(-1),
-	fTempDevice(tempDevice),
-	fPilotUser(0L),
-	fPilotSysInfo(0L)
+	fTempDevice(tempDevice)
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGLIBRARY << fname
 		<< ": Pilot-link version " << PILOT_LINK_NUMBER
 		<< endl;
-#endif
 
 	messagesMask=0xffffffff;
 
-	(void) kpilotlink_id;
 }
 
 KPilotDeviceLink::~KPilotDeviceLink()
@@ -156,6 +349,12 @@
 	KPILOT_DELETE(fPilotUser);
 }
 
+/* virtual */ bool KPilotDeviceLink::isConnected() const
+{
+	 return fLinkStatus == AcceptedDevice;
+}
+
+
 void KPilotDeviceLink::close()
 {
 	FUNCTIONSETUP;
@@ -164,14 +363,14 @@
 	KPILOT_DELETE(fOpenTimer);
 	KPILOT_DELETE(fSocketNotifier);
 	fSocketNotifierActive=false;
-#ifdef DEBUG
-	DEBUGDAEMON << fname
+
+	DEBUGLIBRARY << fname
 		<< ": Closing sockets "
 		<< fCurrentPilotSocket
 		<< " and "
 		<< fPilotMasterSocket
 		<< endl;
-#endif
+
 	if (fCurrentPilotSocket != -1)
 	{
 		pi_close(fCurrentPilotSocket);
@@ -305,7 +504,7 @@
 	}
 }
 
-bool KPilotDeviceLink::open(QString device)
+bool KPilotDeviceLink::open(const QString &device)
 {
 	FUNCTIONSETUPL(2);
 
@@ -321,12 +520,8 @@
 	}
 	fCurrentPilotSocket = (-1);
 
-	if ( device.isEmpty() )
+	if (device.isEmpty() && pilotPath().isEmpty())
 	{
-		device = pilotPath();
-	}
-	if (device.isEmpty())
-	{
 		kdWarning() << k_funcinfo
 			<< ": No point in trying empty device."
 			<< endl;
@@ -335,31 +530,26 @@
 		e = 0;
 		goto errInit;
 	}
-	fRealPilotPath = KStandardDirs::realPath ( device );
+	fRealPilotPath = KStandardDirs::realFilePath( device.isEmpty() ? fPilotPath : device );
 
 	if ( !KPilotDeviceLinkPrivate::self()->canBind( fRealPilotPath ) ) {
 		msg = i18n("Already listening on that device");
 		e=0;
-		kdWarning() << k_funcinfo <<": Pilot Path " << pilotPath().latin1() << " already connected." << endl;
+		kdWarning() << k_funcinfo << ": Pilot Path "
+			<< fRealPilotPath << " already connected." << endl;
 		goto errInit;
 	}
 
 
 	if (fPilotMasterSocket == -1)
 	{
-#ifdef DEBUG
-		DEBUGDAEMON << fname << ": Typing to open " << fRealPilotPath << endl;
-#endif
+		DEBUGLIBRARY << fname << ": Typing to open "
+			<< fRealPilotPath << endl;
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_10_0
-		fPilotMasterSocket = pi_socket(PI_AF_SLP,
-			PI_SOCK_STREAM, PI_PF_PADP);
-#else
 		fPilotMasterSocket = pi_socket(PI_AF_PILOT,
 			PI_SOCK_STREAM, PI_PF_DLP);
-#endif
 
-		if (fPilotMasterSocket<1)
+		if (fPilotMasterSocket < 0)
 		{
 			e = errno;
 			msg = i18n("Cannot create socket for communicating "
@@ -367,35 +557,19 @@
 			goto errInit;
 		}
 
-#ifdef DEBUG
-		DEBUGDAEMON << fname
+		DEBUGLIBRARY << fname
 			<< ": Got master " << fPilotMasterSocket << endl;
-#endif
 
 		fLinkStatus = CreatedSocket;
 	}
 
 	Q_ASSERT(fLinkStatus == CreatedSocket);
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Binding to path " << fPilotPath << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Binding to path "
+		<< fRealPilotPath << endl;
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	struct pi_sockaddr addr;
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_10_0
-	addr.pi_family = PI_AF_SLP;
-#else
-	addr.pi_family = PI_AF_PILOT;
-#endif
-	strlcpy(addr.pi_device, QFile::encodeName(device),sizeof(addr.pi_device));
+	ret = pi_bind(fPilotMasterSocket, QFile::encodeName(fRealPilotPath));
 
-	ret = pi_bind(fPilotMasterSocket,
-		(struct sockaddr *) &addr, sizeof(addr));
-#else
-	ret = pi_bind(fPilotMasterSocket, QFile::encodeName(device));
-#endif
-
 	if (ret >= 0)
 	{
 		fLinkStatus = DeviceOpen;
@@ -408,12 +582,10 @@
 		QObject::connect(fSocketNotifier, SIGNAL(activated(int)),
 			this, SLOT(acceptDevice()));
 		fSocketNotifierActive=true;
-		
+
 		if (fWorkaroundUSB)
 		{
-#ifdef DEBUG
-			DEBUGDAEMON << fname << ": Adding Z31 workaround." << endl;
-#endif
+			DEBUGLIBRARY << fname << ": Adding Z31 workaround." << endl;
 			// Special case for Zire 31, 72, Tungsten T5,
 			// all of which may make a non-HotSync connection
 			// to the PC. Must detect this and bail quickly.
@@ -423,24 +595,14 @@
 				this,SLOT(workaroundUSB()));
 			fWorkaroundUSBTimer->start(5000,true);
 		}
-		
+
 		return true;
 	}
 	else
 	{
-#ifdef DEBUG
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-		DEBUGDAEMON << fname
-			<< ": Tried "
-			<< addr.pi_device
-			<< " and got "
-			<< strerror(errno)
-			<< endl;
-#else
-		DEBUGDAEMON << fname
-			<< ": Tried " << device << " and got " << strerror(errno) << endl;
-#endif
-#endif
+		DEBUGLIBRARY << fname
+			<< ": Tried " << fRealPilotPath << " and got "
+			<< strerror(errno) << endl;
 
 		if (fRetries < 5)
 		{
@@ -465,13 +627,20 @@
 
 	if (msg.find('%'))
 	{
-		if (fPilotPath.isEmpty())
+		if (fRealPilotPath.isEmpty())
 		{
-			msg = msg.arg(i18n("(empty)"));
+			if (fPilotPath.isEmpty())
+			{
+				msg = msg.arg(i18n("(empty)"));
+			}
+			else
+			{
+				msg = msg.arg(fPilotPath);
+			}
 		}
 		else
 		{
-			msg = msg.arg(fPilotPath);
+			msg = msg.arg(fRealPilotPath);
 		}
 	}
 	switch (e)
@@ -535,17 +704,15 @@
 		fSocketNotifierActive=false;
 	}
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGLIBRARY << fname
 		<< ": Found connection on device "<<pilotPath().latin1()<<endl;
-	DEBUGDAEMON << fname
+	DEBUGLIBRARY << fname
 		<< ": Current status "
 		<< statusString()
 		<< " and master " << fPilotMasterSocket << endl;
-#endif
 
 	ret = pi_listen(fPilotMasterSocket, 1);
-	if (ret == -1)
+	if (ret < 0)
 	{
 		char *s = strerror(errno);
 
@@ -565,7 +732,7 @@
 	emit logProgress(QString::null,10);
 
 	fCurrentPilotSocket = pi_accept(fPilotMasterSocket, 0, 0);
-	if (fCurrentPilotSocket == -1)
+	if (fCurrentPilotSocket < 0)
 	{
 		char *s = strerror(errno);
 
@@ -594,64 +761,50 @@
 	emit logProgress(QString::null, 30);
 
         KPILOT_DELETE(fPilotSysInfo);
-	fPilotSysInfo = new KPilotSysInfo;
+	fPilotSysInfo = new KPilotSysInfo();
 	if (dlp_ReadSysInfo(fCurrentPilotSocket, fPilotSysInfo->sysInfo()) < 0)
 	{
 		emit logError(i18n("Unable to read system information from Pilot"));
 		fLinkStatus=PilotLinkError;
 		return;
 	}
-#ifdef DEBUG
 	else
 	{
-		DEBUGDAEMON << fname
+		DEBUGLIBRARY << fname
 			<< ": RomVersion=" << fPilotSysInfo->getRomVersion()
 			<< " Locale=" << fPilotSysInfo->getLocale()
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_10_0
-			/* No prodID member */
-#else
 			<< " Product=" << fPilotSysInfo->getProductID()
-#endif
 			<< endl;
 	}
-#endif
-	fPilotSysInfo->boundsCheck();
 
 	emit logProgress(QString::null, 60);
         KPILOT_DELETE(fPilotUser);
 	fPilotUser = new KPilotUser;
 
 	/* Ask the pilot who it is.  And see if it's who we think it is. */
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Reading user info @"
-		<< (long) fPilotUser << endl;
-	DEBUGDAEMON << fname << ": Buffer @"
-		<< (long) fPilotUser->pilotUser() << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Reading user info @"
+		<< (void *) fPilotUser << endl;
+	DEBUGLIBRARY << fname << ": Buffer @"
+		<< (void *) fPilotUser->pilotUser() << endl;
 
 	dlp_ReadUserInfo(fCurrentPilotSocket, fPilotUser->pilotUser());
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname
-		<< ": Read user name " << fPilotUser->getUserName() << endl;
-#endif
+	const char *n = fPilotUser->getUserName();
+	DEBUGLIBRARY << fname
+		<< ": Read user name "
+		<< ( (!n || !*n) ?
+			"<empty>" :
+			fPilotUser->getUserName() )
+		<< endl;
 
 	emit logProgress(i18n("Checking last PC..."), 90);
 
 	/* Tell user (via Pilot) that we are starting things up */
 	if ((ret=dlp_OpenConduit(fCurrentPilotSocket)) < 0)
 	{
-#ifdef DEBUG
-		DEBUGDAEMON << k_funcinfo
+		DEBUGLIBRARY << fname
 			<< ": dlp_OpenConduit returned " << ret << endl;
-#endif
 
-#if 0
-		fLinkStatus = SyncDone;
-		emit logMessage(i18n
-			("Exiting on cancel. All data not restored."));
-		return;
-#endif
 		emit logError(i18n("Could not read user information from the Pilot. "
 			"Perhaps you have a password set on the device?"));
 	}
@@ -665,14 +818,14 @@
 void KPilotDeviceLink::workaroundUSB()
 {
 	FUNCTIONSETUP;
-	
+
 	Q_ASSERT((fLinkStatus == DeviceOpen) || (fLinkStatus == WorkaroundUSB));
 	if (fLinkStatus == DeviceOpen)
 	{
 		reset();
 	}
 	fLinkStatus = WorkaroundUSB;
-	
+
 	if (!QFile::exists(fRealPilotPath))
 	{
 		// Fake connection has vanished again.
@@ -688,167 +841,24 @@
 	QTimer::singleShot(1000,this,SLOT(workaroundUSB()));
 }
 
-bool KPilotDeviceLink::tickle() const
+/* virtual */ bool KPilotDeviceLink::tickle()
 {
 	// No FUNCTIONSETUP here because it may be called from
 	// a separate thread.
 	return pi_tickle(pilotSocket()) >= 0;
 }
 
-class TickleThread : public QThread
+/* virtual */ void KPilotDeviceLink::addSyncLogEntryImpl( const QString &entry )
 {
-public:
-	TickleThread(KPilotDeviceLink *d, bool *done, int timeout) :
-		QThread(),
-		fHandle(d),
-		fDone(done),
-		fTimeout(timeout)
-	{ };
-	virtual ~TickleThread();
-
-	virtual void run();
-
-	static const int ChecksPerSecond = 5;
-	static const int SecondsPerTickle = 5;
-
-private:
-	KPilotDeviceLink *fHandle;
-	bool *fDone;
-	int fTimeout;
-} ;
-
-TickleThread::~TickleThread()
-{
+	dlp_AddSyncLogEntry(fCurrentPilotSocket,
+		const_cast<char *>((const char *)Pilot::toPilot(entry)));
 }
 
-void TickleThread::run()
-{
-	FUNCTIONSETUP;
-	int subseconds = ChecksPerSecond;
-	int ticktock = SecondsPerTickle;
-	int timeout = fTimeout;
-#ifdef DEBUG_CERR
-	DEBUGDAEMON << fname << ": Running for " << timeout << " seconds." << endl;
-	DEBUGDAEMON << fname << ": Done @" << (void *) fDone << endl;
-#endif
-	while (!(*fDone))
-	{
-		QThread::msleep(1000/ChecksPerSecond);
-		if (!(--subseconds))
-		{
-#ifdef DEBUG_CERR
-// Don't dare use kdDebug() here, we're in a separate thread
-			DEBUGDAEMON << fname << ": One second." << endl;
-#endif
-			if (timeout)
-			{
-				if (!(--timeout))
-				{
-					QApplication::postEvent(fHandle, new QEvent((QEvent::Type)(KPilotDeviceLink::TickleTimeoutEvent)));
-					break;
-				}
-			}
-			subseconds=ChecksPerSecond;
-			if (!(--ticktock))
-			{
-#ifdef DEBUG_CERR
-				DEBUGDAEMON << fname << ": Kietel kietel!." << endl;
-#endif
-				ticktock=SecondsPerTickle;
-				fHandle->tickle();
-			}
-		}
-	}
-#ifdef DEBUG_CERR
-	DEBUGDAEMON << fname << ": Finished." << endl;
-#endif
-}
-
-/*
-** Deal with events, especially the ones used to signal a timeout
-** in a tickle thread.
-*/
-
-/* virtual */ bool KPilotDeviceLink::event(QEvent *e)
-{
-	if (e->type() == TickleTimeoutEvent)
-	{
-		stopTickle();
-		emit timeout();
-		return true;
-	}
-	else	return QObject::event(e);
-}
-
-/*
-Start a tickle thread with the indicated timeout.
-*/
-void KPilotDeviceLink::startTickle(unsigned int timeout)
-{
-	FUNCTIONSETUP;
-
-	Q_ASSERT(fTickleDone);
-
-	/*
-	** We've told the thread to finish up, but it hasn't
-	** done so yet - so wait for it to do so, should be
-	** only 200ms at most.
-	*/
-	if (fTickleDone && fTickleThread)
-	{
-		fTickleThread->wait();
-		KPILOT_DELETE(fTickleThread);
-	}
-
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Done @" << (void *) (&fTickleDone) << endl;
-#endif
-	fTickleDone = false;
-	fTickleThread = new TickleThread(this,&fTickleDone,timeout);
-	fTickleThread->start();
-}
-
-void KPilotDeviceLink::stopTickle()
-{
-	FUNCTIONSETUP;
-	fTickleDone = true;
-	if (fTickleThread)
-	{
-		fTickleThread->wait();
-		KPILOT_DELETE(fTickleThread);
-	}
-}
-
-
-int KPilotDeviceLink::installFiles(const QStringList & l, const bool deleteFiles)
-{
-	FUNCTIONSETUP;
-
-	QStringList::ConstIterator i;
-	int k = 0;
-	int n = 0;
-
-	for (i = l.begin(); i != l.end(); ++i)
-	{
-		emit logProgress(QString::null,
-			(int) ((100.0 / l.count()) * (float) n));
-
-		if (installFile(*i, deleteFiles))
-			k++;
-		n++;
-	}
-	emit logProgress(QString::null, 100);
-
-	return k;
-}
-
 bool KPilotDeviceLink::installFile(const QString & f, const bool deleteFile)
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Installing file " << f << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Installing file " << f << endl;
 
 	if (!QFile::exists(f))
 		return false;
@@ -869,11 +879,7 @@
 		return false;
 	}
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	if (pi_file_install(pf, fCurrentPilotSocket, 0) < 0)
-#else
 	if (pi_file_install(pf, fCurrentPilotSocket, 0, 0L) < 0)
-#endif
 	{
 		kdWarning() << k_funcinfo
 			<< ": Cannot pi_file_install " << f << endl;
@@ -890,25 +896,6 @@
 }
 
 
-void KPilotDeviceLink::addSyncLogEntry(const QString & entry, bool log)
-{
-	FUNCTIONSETUP;
-	if (entry.isEmpty()) return;
-
-	QString t(entry);
-
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_11_0
-	t.append("X");
-#endif
-
-	dlp_AddSyncLogEntry(fCurrentPilotSocket,
-		const_cast<char *>((const char *)PilotAppCategory::codec()->fromUnicode(entry)));
-	if (log)
-	{
-		emit logMessage(entry);
-	}
-}
-
 int KPilotDeviceLink::openConduit()
 {
 	return dlp_OpenConduit(fCurrentPilotSocket);
@@ -969,14 +956,13 @@
 {
 	FUNCTIONSETUP ;
 
-	getPilotUser()->setLastSyncPC((unsigned long) gethostid());
-	getPilotUser()->setLastSyncDate(time(0));
+	getPilotUser().setLastSyncPC((unsigned long) gethostid());
+	getPilotUser().setLastSyncDate(time(0));
 
-	
-#ifdef DEBUG	
-	DEBUGDAEMON << fname << ": Writing username " << getPilotUser()->getUserName() << endl;
-#endif
-	dlp_WriteUserInfo(pilotSocket(),getPilotUser()->pilotUser());
+
+	DEBUGLIBRARY << fname << ": Writing username " << getPilotUser().getUserName() << endl;
+
+	dlp_WriteUserInfo(pilotSocket(),getPilotUser().pilotUser());
 	addSyncLogEntry(i18n("End of HotSync\n"));
 	endOfSync();
 }
@@ -985,9 +971,6 @@
 {
 	FUNCTIONSETUP;
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	return dlp_ReadDBList(pilotSocket(),0,dlpDBListRAM,index,dbinfo);
-#else
 	pi_buffer_t buf = { 0,0,0 };
 	int r = dlp_ReadDBList(pilotSocket(),0,dlpDBListRAM,index,&buf);
 	if (r >= 0)
@@ -995,12 +978,11 @@
 		memcpy(dbinfo,buf.data,sizeof(struct DBInfo));
 	}
 	return r;
-#endif
 }
 
 // Find a database with the given name. Info about the DB is stored into dbinfo (e.g. to be used later on with retrieveDatabase).
 int KPilotDeviceLink::findDatabase(const char *name, struct DBInfo *dbinfo,
-	int index, long type, long creator)
+	int index, unsigned long type, unsigned long creator)
 {
 	FUNCTIONSETUP;
 	return dlp_FindDBInfo(pilotSocket(), 0, index,
@@ -1012,10 +994,8 @@
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Writing DB <" << info->name << "> "
+	DEBUGLIBRARY << fname << ": Writing DB <" << info->name << "> "
 		<< " to " << fullBackupName << endl;
-#endif
 
 	struct pi_file *f;
 	if (fullBackupName.isEmpty())
@@ -1036,11 +1016,7 @@
 		return false;
 	}
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	if (pi_file_retrieve(f, pilotSocket(), 0) < 0)
-#else
 	if (pi_file_retrieve(f, pilotSocket(), 0, 0L) < 0)
-#endif
 	{
 		kdWarning() << k_funcinfo
 			<< ": Failed, unable to back up database" << endl;
@@ -1054,26 +1030,13 @@
 }
 
 
-QPtrList<DBInfo> KPilotDeviceLink::getDBList(int cardno, int flags)
+DBInfoList KPilotDeviceLink::getDBList(int cardno, int flags)
 {
 	bool cont=true;
-	QPtrList<DBInfo>dbs;
+	DBInfoList dbs;
 	int index=0;
 	while (cont)
 	{
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-		DBInfo*dbi=new DBInfo();
-		if (dlp_ReadDBList(pilotSocket(), cardno, flags, index, dbi)<0)
-		{
-			KPILOT_DELETE(dbi);
-			cont=false;
-		}
-		else
-		{
-			index=dbi->index+1;
-			dbs.append(dbi);
-		}
-#else
 		pi_buffer_t buf = { 0,0,0 };
 		pi_buffer_clear(&buf);
 		// DBInfo*dbi=new DBInfo();
@@ -1083,29 +1046,24 @@
 		}
 		else
 		{
-			DBInfo *db_n = 0L;
+			DBInfo db_n;
 			DBInfo *db_it = (DBInfo *)buf.data;
 			int info_count = buf.used / sizeof(struct DBInfo);
 
 			while(info_count>0)
 			{
-				db_n = new DBInfo();
-				memcpy(db_n,db_it,sizeof(struct DBInfo));
+				memcpy(&db_n,db_it,sizeof(struct DBInfo));
 				++db_it;
 				info_count--;
 				dbs.append(db_n);
 			}
-			if (db_n)
-			{
-				index=db_n->index+1;
-			}
+			index=db_n.index+1;
 		}
-#endif
 	}
 	return dbs;
 }
 
-KPilotCard *KPilotDeviceLink::getCardInfo(int card)
+const KPilotCard *KPilotDeviceLink::getCardInfo(int card)
 {
 	KPilotCard *cardinfo=new KPilotCard();
 	if (dlp_ReadStorageInfo(pilotSocket(), card, cardinfo->cardInfo())<0)
@@ -1119,68 +1077,325 @@
 	return cardinfo;
 }
 
-QDateTime KPilotDeviceLink::getTime()
+/* static */ const int KPilotDeviceLink::messagesType=
+	(int)OpenFailMessage ;
+
+void KPilotDeviceLink::shouldPrint(int m,const QString &s)
 {
-	QDateTime time;
-	time_t palmtime;
-	if (dlp_GetSysDateTime(pilotSocket(), &palmtime))
+	if (!(messages & m))
 	{
-		time.setTime_t(palmtime);
+		if (messagesType & m) { emit logError(s); }
+		else { emit logMessage(s); }
+		messages |= (m & messagesMask);
 	}
-	return time;
 }
 
-bool KPilotDeviceLink::setTime(const time_t &pctime)
+PilotDatabase *KPilotDeviceLink::database( const QString &name )
 {
-//	struct tm time_tm=writeTm(time);
-//	time_t pctime=mktime(&time_tm);
-	return dlp_SetSysDateTime(pilotSocket(), pctime);
+	return new PilotSerialDatabase( this, name );
 }
 
 
+typedef QPair<QString, struct DBInfo> DatabaseDescriptor;
+typedef QValueList<DatabaseDescriptor> DatabaseDescriptorList;
 
-unsigned long KPilotDeviceLink::ROMversion() const
+class KPilotLocalLink::Private
 {
-	unsigned long rom;
-	dlp_ReadFeature(pilotSocket(),
-		makelong(const_cast<char *>("psys")), 1, &rom);
-	return rom;
+public:
+	DatabaseDescriptorList fDBs;
+} ;
+
+unsigned int KPilotLocalLink::findAvailableDatabases( KPilotLocalLink::Private &info, const QString &path )
+{
+	FUNCTIONSETUP;
+
+	info.fDBs.clear();
+
+	QDir d(path);
+	if (!d.exists())
+	{
+		// Perhaps return an error?
+		return 0;
+	}
+
+	// Use this to fake indexes in the list of DBInfo structs
+	unsigned int counter = 0;
+
+	QStringList dbs = d.entryList( CSL1("*.pdb"), QDir::Files | QDir::NoSymLinks | QDir::Readable );
+	for ( QStringList::ConstIterator i = dbs.begin(); i != dbs.end() ; ++i)
+	{
+		struct DBInfo dbi;
+
+		// Remove the trailing 4 characters
+		QString dbname = (*i);
+		dbname.remove(dbname.length()-4,4);
+
+		QString dbnamecheck = (*i).left((*i).findRev(CSL1(".pdb")));
+		Q_ASSERT(dbname == dbnamecheck);
+
+		if (PilotLocalDatabase::infoFromFile( path + CSL1("/") + (*i), &dbi))
+		{
+			DEBUGLIBRARY << fname << ": Loaded "
+				<< dbname << endl;
+			dbi.index = counter;
+			info.fDBs.append( DatabaseDescriptor(dbname,dbi) );
+			++counter;
+		}
+	}
+
+	DEBUGLIBRARY << fname << ": Total " << info.fDBs.count()
+		<< " databases." << endl;
+	return info.fDBs.count();
 }
-unsigned long KPilotDeviceLink::majorVersion() const
+
+
+KPilotLocalLink::KPilotLocalLink( QObject *parent, const char *name ) :
+	KPilotLink(parent,name),
+	fReady(false),
+	d( new Private )
 {
-	unsigned long rom=ROMversion();
-	return (((rom >> 28) & 0xf) * 10)+ ((rom >> 24) & 0xf);
+	FUNCTIONSETUP;
 }
-unsigned long KPilotDeviceLink::minorVersion() const
+
+KPilotLocalLink::~KPilotLocalLink()
 {
-	unsigned long int rom=ROMversion();
-	return (((rom >> 20) & 0xf) * 10)+ ((rom >> 16) & 0xf);
+	FUNCTIONSETUP;
+	KPILOT_DELETE(d);
 }
 
-/* static */ const int KPilotDeviceLink::messagesType=
-	(int)OpenFailMessage ;
+/* virtual */ QString KPilotLocalLink::statusString() const
+{
+	return fReady ? CSL1("Ready") : CSL1("Waiting") ;
+}
 
-void KPilotDeviceLink::shouldPrint(int m,const QString &s)
+/* virtual */ bool KPilotLocalLink::isConnected() const
 {
-	if (!(messages & m))
+	return fReady;
+}
+
+/* virtual */ void KPilotLocalLink::reset( const QString &p )
+{
+	FUNCTIONSETUP;
+	fPath = p;
+	reset();
+}
+
+/* virtual */ void KPilotLocalLink::reset()
+{
+	FUNCTIONSETUP;
+	QFileInfo info( fPath );
+	fReady = !fPath.isEmpty() && info.exists() && info.isDir() ;
+	if (fReady)
 	{
-		if (messagesType & m) { emit logError(s); }
-		else { emit logMessage(s); }
-		messages |= (m & messagesMask);
+		findAvailableDatabases(*d, fPath);
+		QTimer::singleShot(500,this,SLOT(ready()));
 	}
+	else
+	{
+		kdWarning() << k_funcinfo << ": The local link path "
+			<< fPath
+			<< " does not exist or is not a direcotory. No sync will be done."
+			<< endl;
+	}
 }
 
-bool operator < (const db & a, const db & b) {
-	if (a.creator == b.creator)
+/* virtual */ void KPilotLocalLink::close()
+{
+	fReady = false;
+}
+
+/* virtual */ bool KPilotLocalLink::tickle()
+{
+	return true;
+}
+
+/* virtual */ const KPilotCard *KPilotLocalLink::getCardInfo(int)
+{
+	return 0;
+}
+
+/* virtual */ void KPilotLocalLink::endOfSync()
+{
+}
+
+/* virtual */ void KPilotLocalLink::finishSync()
+{
+}
+
+/* virtual */ int KPilotLocalLink::openConduit()
+{
+	FUNCTIONSETUP;
+	return 0;
+}
+
+
+/* virtual */ int KPilotLocalLink::getNextDatabase( int index, struct DBInfo *info )
+{
+	FUNCTIONSETUP;
+
+	if ( (index<0) || (index>=(int)d->fDBs.count()) )
 	{
-		if (a.type != b.type)
+		kdWarning() << k_funcinfo << ": Index out of range." << endl;
+		return -1;
+	}
+
+	DatabaseDescriptor dd = d->fDBs[index];
+
+	DEBUGLIBRARY << fname << ": Getting database " << dd.first << endl;
+
+	if (info)
+	{
+		*info = dd.second;
+	}
+
+	return index+1;
+}
+
+/* virtual */ int KPilotLocalLink::findDatabase(const char *name, struct DBInfo*info,
+		int index, unsigned long type, unsigned long creator)
+{
+	FUNCTIONSETUP;
+
+	if ( (index<0) || (index>=(int)d->fDBs.count()) )
+	{
+		kdWarning() << k_funcinfo << ": Index out of range." << endl;
+		return -1;
+	}
+
+	if (!name)
+	{
+		kdWarning() << k_funcinfo << ": NULL name." << endl;
+		return -1;
+	}
+
+	QString desiredName = Pilot::fromPilot(name);
+	DEBUGLIBRARY << fname << ": Looking for DB " << desiredName << endl;
+	for ( DatabaseDescriptorList::ConstIterator i = d->fDBs.at(index);
+		i != d->fDBs.end(); ++i)
+	{
+		const DatabaseDescriptor &dd = *i;
+		if (dd.first == desiredName)
 		{
-			if (a.type == pi_mktag('a', 'p', 'p', 'l'))
-				return false;
-			else
-				return true;
+			if ( (!type || (type == dd.second.type)) &&
+				(!creator || (creator == dd.second.creator)) )
+			{
+				if (info)
+				{
+					*info = dd.second;
+				}
+				return index;
+			}
 		}
+
+		++index;
 	}
 
-	return a.maxblock < b.maxblock;
+	return -1;
 }
+
+/* virtual */ void KPilotLocalLink::addSyncLogEntryImpl(QString const &s)
+{
+	FUNCTIONSETUP;
+	DEBUGLIBRARY << fname << ": " << s << endl ;
+}
+
+/* virtual */ bool KPilotLocalLink::installFile(QString const &path, bool deletefile)
+{
+	FUNCTIONSETUP;
+
+	QFileInfo srcInfo(path);
+	QString canonicalSrcPath = srcInfo.dir().canonicalPath() + CSL1("/") + srcInfo.fileName() ;
+	QString canonicalDstPath = fPath + CSL1("/") + srcInfo.fileName();
+
+	if (canonicalSrcPath == canonicalDstPath)
+	{
+		// That's a cheap copy operation
+		return true;
+	}
+
+	KURL src = KURL::fromPathOrURL( canonicalSrcPath );
+	KURL dst = KURL::fromPathOrURL( canonicalDstPath );
+
+	KIO::NetAccess::file_copy(src,dst,-1,true);
+
+	if (deletefile)
+	{
+		KIO::NetAccess::del(src, 0L);
+	}
+
+	return true;
+}
+
+/* virtual */ bool KPilotLocalLink::retrieveDatabase( const QString &path, struct DBInfo *db )
+{
+	FUNCTIONSETUP;
+
+	QString dbname = Pilot::fromPilot(db->name) + CSL1(".pdb") ;
+	QString sourcefile = fPath + CSL1("/") + dbname ;
+	QString destfile = path ;
+
+	DEBUGLIBRARY << fname << ": src=" << sourcefile << endl;
+	DEBUGLIBRARY << fname << ": dst=" << destfile << endl;
+
+	QFile in( sourcefile );
+	if ( !in.exists() )
+	{
+		kdWarning() << k_funcinfo<< ": Source file " << sourcefile << " doesn't exist." << endl;
+		return false;
+	}
+	if ( !in.open( IO_ReadOnly | IO_Raw ) )
+	{
+		kdWarning() << k_funcinfo << ": Can't read source file " << sourcefile << endl;
+		return false;
+	}
+
+	QFile out( destfile );
+	if ( !out.open( IO_WriteOnly | IO_Truncate | IO_Raw ) )
+	{
+		kdWarning() << k_funcinfo << ": Can't write destination file " << destfile << endl;
+		return false;
+	}
+
+	const Q_ULONG BUF_SIZ = 8192 ;
+	char buf[BUF_SIZ];
+	Q_LONG r;
+
+	while ( (r=in.readBlock(buf,BUF_SIZ))>0 )
+	{
+		out.writeBlock(buf,r);
+	}
+	out.flush();
+	in.close();
+
+	return out.exists();
+}
+
+/* virtual */ DBInfoList KPilotLocalLink::getDBList( int, int )
+{
+	FUNCTIONSETUP;
+	DBInfoList l;
+	for ( DatabaseDescriptorList::ConstIterator i=d->fDBs.begin();
+		i != d->fDBs.end(); ++i)
+	{
+		l.append( (*i).second );
+	}
+	return l;
+}
+
+
+/* virtual */ PilotDatabase *KPilotLocalLink::database( const QString &name )
+{
+	FUNCTIONSETUP;
+	return new PilotLocalDatabase( fPath, name );
+}
+
+
+
+/* slot */ void KPilotLocalLink::ready()
+{
+	if (fReady)
+	{
+		emit deviceReady(this);
+	}
+}
+
Index: kpilot/lib/data/MemoDB.pdb
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream
Index: kpilot/lib/pilotRecord.cc
===================================================================
--- kpilot/lib/pilotRecord.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotRecord.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -36,43 +36,46 @@
 
 #include <string.h>
 
-#include <qtextcodec.h>
 #include <qregexp.h>
 
 #include <kglobal.h>
 #include <kcharsets.h>
 
-// PilotAppCategory includes pilotRecord and we
-// provide its implementation here as well.
-//
-#include "pilotAppCategory.h"
+#include "pilot.h"
+#include "pilotRecord.h"
 
 
 
-static const char *pilotRecord_id =
-	"$Id$";
+/* virtual */ QString PilotRecordBase::textRepresentation() const
+{
+	return CSL1("[ %1,%2,%3 ]") . arg(attributes(),category(),id());
+}
 
+/* virtual */ QString PilotRecord::textRepresentation() const
+{
+	return CSL1("[ %1,%2 ]")
+		.arg(PilotRecordBase::textRepresentation())
+		.arg(size());
+}
+
+
+
 /* static */ int PilotRecord::fAllocated = 0;
 /* static */ int PilotRecord::fDeleted = 0;
 
 /* static */ void PilotRecord::allocationInfo()
 {
-#ifdef DEBUG
 	FUNCTIONSETUP;
-	DEBUGKPILOT << fname
+	DEBUGLIBRARY << fname
 		<< ": Allocated " << fAllocated
 		<< "  Deleted " << fDeleted << endl;
-#endif
 }
 
 PilotRecord::PilotRecord(void *data, int len, int attrib, int cat, recordid_t uid) :
 	PilotRecordBase(attrib,cat,uid),
 	fData(0L),
-	fLen(len)
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	,
+	fLen(len),
 	fBuffer(0L)
-#endif
 {
 	FUNCTIONSETUPL(4);
 	fData = new char[len];
@@ -80,15 +83,11 @@
 	memcpy(fData, data, len);
 
 	fAllocated++;
-	(void) pilotRecord_id;
 }
 
 PilotRecord::PilotRecord(PilotRecord * orig) :
-	PilotRecordBase( orig->attributes(), orig->category(), orig->id() )
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	,
+	PilotRecordBase( orig->attributes(), orig->category(), orig->id() ) ,
 	fBuffer(0L)
-#endif
 {
 	FUNCTIONSETUPL(4);
 	fData = new char[orig->size()];
@@ -101,14 +100,12 @@
 PilotRecord & PilotRecord::operator = (PilotRecord & orig)
 {
 	FUNCTIONSETUP;
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 	if (fBuffer)
 	{
 		pi_buffer_free(fBuffer);
 		fBuffer=0L;
 		fData=0L;
 	}
-#endif
 
 	if (fData)
 		delete[]fData;
@@ -133,75 +130,3 @@
 	fLen = len;
 }
 
-
-/* static */ QTextCodec *PilotAppCategory::pilotCodec = 0L;
-
-/* static */ QTextCodec *PilotAppCategory::setupPilotCodec(const QString &s)
-{
-	FUNCTIONSETUP;
-	QString encoding(KGlobal::charsets()->encodingForName(s));
-
-#ifdef DEBUG
-	DEBUGKPILOT << fname << ": Creating codec " << encoding << endl;
-#endif
-
-	// if the desired codec can't be found, latin1 will be returned anyway, no need to do this manually
-	pilotCodec = KGlobal::charsets()->codecForName(encoding);
-
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Got codec " << codecName() << " for setting "
-		<< s << endl;
-#endif
-	return codec();
-}
-
-/* static */ QString PilotAppCategory::codecName()
-{
-	return QString::fromLatin1(codec()->name());
-}
-
-bool PilotAppCategory::setCategory(struct CategoryAppInfo &info,const QString &label)
-{
-	int emptyAvailable = -1;
-	if (label.isEmpty()) { setCategory(0); return true; }
-	for (int catId = 1; catId < PILOT_CATEGORY_MAX; catId++)
-	{
-		QString aCat;
-		if (!info.name[catId][0])
-		{
-			emptyAvailable=catId; continue;
-		}
-		aCat = codec()->toUnicode(info.name[catId]);
-		if (label == aCat) { setCategory(catId); return true; }
-	}
-	if (emptyAvailable<0) return false;
-	strlcpy(info.name[emptyAvailable], codec()->fromUnicode(label), sizeof(info.name[emptyAvailable]) );
-	setCategory(emptyAvailable);
-	return true;
-}
-
-PilotRecord *PilotAppCategory::pack()
-{
-	int len = PilotRecord::APP_BUFFER_SIZE;
-	void* buff = new unsigned char[len];
-	pack_(buff, &len);
-	PilotRecord* rec =  new PilotRecord(buff, len, attributes(), category(), id());
-	delete [] (unsigned char*)buff;
-	return rec;
-}
-
-QString PilotAppCategory::fromPilot( const char *c, int len )
-{
-	return codec()->toUnicode(c,len);
-}
-
-int PilotAppCategory::toPilot( const QString &s, char *buf, int len)
-{
-	int used = len;
-	QCString cbuf = codec()->fromUnicode(s,used);
-	memset( buf, 0, len );
-	if (used > len) used=len;
-	memcpy( buf, cbuf.data(), used );
-	return used;
-}
Index: kpilot/lib/fakes.c
===================================================================
--- kpilot/lib/fakes.c	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/fakes.c	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,367 @@
+/* This file is part of the KDE libraries
+   Copyright (c) 2000 The KDE Project
+
+   unsetenv() taken from the GNU C Library.
+   Copyright (C) 1992,1995-1999,2000-2002 Free Software Foundation, Inc.
+
+   This library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Library General Public
+   License version 2 as published by the Free Software Foundation.
+
+   This library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   Library General Public License for more details.
+
+   You should have received a copy of the GNU Library General Public License
+   along with this library; see the file COPYING.LIB.  If not, write to
+   the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+   Boston, MA 02110-1301, USA.
+*/
+
+
+#include <config.h>
+
+#define KDE_open open
+#define KDE_mkdir mkdir 
+
+#ifndef HAVE_SETENV
+
+#ifdef HAVE_ALLOCA_H
+#include <alloca.h>
+#endif
+
+#include <string.h>
+#include <stdlib.h>
+#include <unistd.h>
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+ int setenv(const char *name, const char *value, int overwrite) {
+    int i;
+    char * a;
+
+    if (!overwrite && getenv(name)) return 0;
+
+    i = strlen(name) + strlen(value) + 2;
+    a = (char*)malloc(i);
+    if (!a) return 1;
+
+    strcpy(a, name);
+    strcat(a, "=");
+    strcat(a, value);
+
+    return putenv(a);
+}
+#endif /* !HAVE_SETENV */
+
+#ifndef HAVE_UNSETENV
+
+#ifdef HAVE_ALLOCA_H
+#include <alloca.h>
+#endif
+
+#include <string.h>
+#include <stdlib.h>
+#include <errno.h>
+#include <unistd.h>
+
+#ifndef environ
+extern char ** environ;
+#endif
+
+ void unsetenv (name)
+     const char *name;
+{
+  size_t len;
+  char **ep;
+
+  if (name == NULL || *name == '\0' || strchr (name, '=') != NULL)
+    {
+      errno = EINVAL;
+      return;
+    }
+
+  len = strlen (name);
+
+  ep = environ;
+  while (*ep != NULL)
+    if (!strncmp (*ep, name, len) && (*ep)[len] == '=')
+      {
+	/* Found it.  Remove this pointer by moving later ones back.  */
+	char **dp = ep;
+
+	do
+	  dp[0] = dp[1];
+	while (*dp++);
+	/* Continue the loop in case NAME appears again.  */
+      }
+    else
+      ++ep;
+
+}
+
+#endif /* !HAVE_UNSETENV */
+
+#ifndef HAVE_USLEEP
+
+#if TIME_WITH_SYS_TIME
+# include <sys/time.h>
+# include <time.h>
+#else
+# if defined(HAVE_SYS_TIME_H)
+#  include <sys/time.h>
+# else
+#  include <time.h>
+# endif
+#endif
+
+#ifdef HAVE_SYS_SELECT_H
+#include <sys/select.h>
+#endif
+
+#ifdef __cplusplus  /* this is supposed to be a C source file but still.. */
+extern "C" {
+#endif
+
+void usleep(unsigned int usec) {
+        struct timeval _usleep_tv;
+        _usleep_tv.tv_sec = usec/1000000;
+        _usleep_tv.tv_usec = usec%1000000;
+        select(0,0,0,0,&_usleep_tv);
+}
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* !HAVE_USLEEP */
+
+#ifndef HAVE_RANDOM
+long int random()
+{
+    return lrand48();
+}
+
+void srandom(unsigned int seed)
+{
+    srand48(seed);
+}
+#endif
+
+#ifndef HAVE_SETEUID
+int seteuid(uid_t euid)
+{
+    setreuid(-1, euid); /* Well, if you have neither you are in trouble :) */
+}
+#endif
+
+#ifndef HAVE_MKSTEMPS
+#include <sys/types.h>
+#ifdef HAVE_SYS_STAT_H
+#include <sys/stat.h>
+#endif
+#include <fcntl.h>
+#include <string.h>
+#include <strings.h>
+#include <stdlib.h>
+
+/* this is based on code taken from the GNU libc, distributed under the LGPL license */
+
+/* Generate a unique temporary file name from TEMPLATE.
+
+   TEMPLATE has the form:
+
+   <path>/ccXXXXXX<suffix>
+
+   SUFFIX_LEN tells us how long <suffix> is (it can be zero length).
+
+   The last six characters of TEMPLATE before <suffix> must be "XXXXXX";
+   they are replaced with a string that makes the filename unique.
+
+   Returns a file descriptor open on the file for reading and writing.  */
+
+ int mkstemps (char* _template, int suffix_len)
+{
+  static const char letters[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
+  char *XXXXXX;
+  int len;
+  int count;
+  int value;
+
+  len = strlen (_template);
+
+  if ((int) len < 6 + suffix_len || strncmp (&_template[len - 6 - suffix_len], "XXXXXX", 6))
+      return -1;
+
+  XXXXXX = &_template[len - 6 - suffix_len];
+
+  value = rand();
+  for (count = 0; count < 256; ++count)
+  {
+      int v = value;
+      int fd;
+
+      /* Fill in the random bits.  */
+      XXXXXX[0] = letters[v % 62];
+      v /= 62;
+      XXXXXX[1] = letters[v % 62];
+      v /= 62;
+      XXXXXX[2] = letters[v % 62];
+      v /= 62;
+      XXXXXX[3] = letters[v % 62];
+      v /= 62;
+      XXXXXX[4] = letters[v % 62];
+      v /= 62;
+      XXXXXX[5] = letters[v % 62];
+
+      fd = KDE_open (_template, O_RDWR|O_CREAT|O_EXCL, 0600);
+      if (fd >= 0)
+	/* The file does not exist.  */
+	return fd;
+
+      /* This is a random value.  It is only necessary that the next
+	 TMP_MAX values generated by adding 7777 to VALUE are different
+	 with (module 2^32).  */
+      value += 7777;
+    }
+  /* We return the null string if we can't find a unique file name.  */
+  _template[0] = '\0';
+  return -1;
+}
+
+#endif /* !HAVE_MKSTEMPS */
+
+#ifndef HAVE_MKSTEMP
+ int mkstemp (char* _template)
+{
+  return mkstemps( _template, 0 );
+}
+#endif
+
+#ifndef HAVE_MKDTEMP
+
+#ifndef HAVE_MKSTEMPS
+#include <sys/types.h>
+#ifdef HAVE_SYS_STAT_H
+#include <sys/stat.h>
+#endif
+#endif
+
+/* Generate a unique temporary directory name from TEMPLATE.
+
+   TEMPLATE has the form:
+
+   <path>/ccXXXXXX
+
+
+   The last six characters of TEMPLATE must be "XXXXXX";
+   they are replaced with a string that makes the filename unique.
+
+   Returns a file descriptor open on the file for reading and writing.  */
+
+ char* mkdtemp (char* _template)
+{
+  static const char letters[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
+  char *XXXXXX;
+  int len;
+  int count;
+  int value;
+
+  len = strlen (_template);
+
+  if ((int) len < 6 || strncmp (&_template[len - 6], "XXXXXX", 6))
+      return 0;
+
+  XXXXXX = &_template[len - 6];
+
+  value = rand();
+  for (count = 0; count < 256; ++count)
+  {
+      int v = value;
+
+      /* Fill in the random bits.  */
+      XXXXXX[0] = letters[v % 62];
+      v /= 62;
+      XXXXXX[1] = letters[v % 62];
+      v /= 62;
+      XXXXXX[2] = letters[v % 62];
+      v /= 62;
+      XXXXXX[3] = letters[v % 62];
+      v /= 62;
+      XXXXXX[4] = letters[v % 62];
+      v /= 62;
+      XXXXXX[5] = letters[v % 62];
+
+      /* This is a random value.  It is only necessary that the next
+	 TMP_MAX values generated by adding 7777 to VALUE are different
+	 with (module 2^32).  */
+      value += 7777;
+
+      if (!KDE_mkdir(_template,0700))
+	return _template;	
+    }
+    return 0;
+}
+#endif /* !HAVE_MKDTEMP */
+
+#ifndef HAVE_REVOKE
+#include <errno.h>
+#ifndef ENOTSUP
+#define ENOTSUP 134 /* Not supported */
+#endif
+ int revoke(const char *tty)
+{
+        errno = ENOTSUP;
+        return -1;
+}
+#endif
+
+#ifndef HAVE_STRLCPY
+ unsigned long strlcpy(char* d, const char* s, unsigned long bufsize)
+{
+    unsigned long len, ret = strlen(s);
+
+    if (ret >= bufsize) {
+        if (bufsize) {
+            len = bufsize - 1;
+            memcpy(d, s, len);
+            d[len] = '\0';
+        }
+    } else
+	memcpy(d, s, ret + 1);
+	
+    return ret;
+}
+#endif
+
+#ifndef HAVE_STRLCAT
+ unsigned long strlcat(char* d, const char* s, unsigned long bufsize)
+{
+    char *cp;
+    unsigned long ret, len1, len2 = strlen(s);
+
+    cp = (char *)memchr (d, '\0', bufsize);
+    if (!cp)
+	return bufsize + len2;
+    len1 = cp - d;
+    ret = len1 + len2;
+    if (ret >= bufsize) {
+        len2 = bufsize - len1 - 1;
+        memcpy(cp, s, len2);
+        cp[len2] = '\0';
+    } else
+        memcpy(cp, s, len2 + 1);
+
+    return ret;
+}
+#endif
+
+
+#ifdef __cplusplus
+}
+#endif
+
+
Index: kpilot/lib/pilotLocalDatabase.cc
===================================================================
--- kpilot/lib/pilotLocalDatabase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotLocalDatabase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,9 +28,6 @@
 */
 
 
-static const char *pilotlocaldatabase_id =
-	"$Id$";
-
 #include "options.h"
 
 #include <stdio.h>
@@ -43,14 +40,14 @@
 #include <qfile.h>
 #include <qregexp.h>
 #include <qdatetime.h>
-#include <qtextcodec.h>
 #include <qvaluevector.h>
 
 #include <kdebug.h>
 #include <kglobal.h>
 #include <kstandarddirs.h>
+#include <ksavefile.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "pilotLocalDatabase.h"
 
 typedef QValueVector<PilotRecord *> Records;
@@ -72,7 +69,11 @@
 		resetIndex();
 	}
 
-	void resetIndex() { current = 0; pending = -1; }
+	void resetIndex()
+	{
+		current = 0;
+		pending = -1;
+	}
 
 	unsigned int current;
 	int pending;
@@ -91,7 +92,7 @@
 	fixupDBName();
 	openDatabase();
 
-	if (!isDBOpen() && useDefaultPath)
+	if (!isOpen() && useDefaultPath)
 	{
 		if (fPathBase && !fPathBase->isEmpty())
 		{
@@ -104,40 +105,14 @@
 		}
 		fixupDBName();
 		openDatabase();
-		if (!isDBOpen())
+		if (!isOpen())
+		{
 			fPathName=path;
+		}
 	}
 
-	/* NOTREACHED */
-	(void) pilotlocaldatabase_id;
 }
 
-PilotLocalDatabase::PilotLocalDatabase(const QString & dbName,
-	bool useConduitDBs) :
-	PilotDatabase(dbName),
-	fPathName(QString::null),
-	fDBName(dbName),
-	fAppInfo(0L),
-	fAppLen(0),
-	d(0L)
-{
-	FUNCTIONSETUP;
-	if (fPathBase && !fPathBase->isEmpty() )
-	{
-		fPathName = *fPathBase;
-		if (useConduitDBs)
-			fPathName.replace(CSL1("DBBackup/"), CSL1("conduits/"));
-	}
-	else
-	{
-		fPathName = KGlobal::dirs()->saveLocation("data",
-			CSL1("kpilot/")+(useConduitDBs?CSL1("conduits/"):CSL1("DBBackup/")));
-	}
-
-	fixupDBName();
-	openDatabase();
-}
-
 PilotLocalDatabase::PilotLocalDatabase(const QString &dbName) :
 	PilotDatabase( QString() ),
 	fPathName( QString() ),
@@ -183,20 +158,20 @@
 {
 	FUNCTIONSETUP;
 
-	// if the database is already open, we cannot create it again. How about completely resetting it? (i.e. deleting it and the createing it again)
-	if (isDBOpen()) {
-#ifdef DEBUG
-		DEBUGCONDUIT<<"Database "<<fDBName<<" already open. Cannot recreate it."<<endl;
-#endif
+	// if the database is already open, we cannot create it again.
+	// How about completely resetting it? (i.e. deleting it and then
+	// creating it again)
+	if (isOpen()) 
+	{
+		DEBUGLIBRARY << fname << ": Database " << fDBName
+			<< " already open. Cannot recreate it." << endl;
 		return true;
 	}
 
-#ifdef DEBUG
-	DEBUGCONDUIT<<"Creating database "<<fDBName<<endl;
-#endif
+	DEBUGLIBRARY << fname << ": Creating database " << fDBName << endl;
 
 	// Database names seem to be latin1.
-	memcpy(&fDBInfo.name[0], PilotAppCategory::codec()->fromUnicode(fDBName), 34*sizeof(char));
+	Pilot::toPilot(fDBName, fDBInfo.name, sizeof(fDBInfo.name));
 	fDBInfo.creator=creator;
 	fDBInfo.type=type;
 	fDBInfo.more=0;
@@ -223,14 +198,21 @@
 int PilotLocalDatabase::deleteDatabase()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen()) closeDatabase();
+	if (isOpen())
+	{
+		closeDatabase();
+	}
 
 	QString dbpath=dbPathName();
 	QFile fl(dbpath);
 	if (QFile::remove(dbPathName()))
+	{
 		return 0;
+	}
 	else
+	{
 		return -1;
+	}
 }
 
 
@@ -242,7 +224,7 @@
 
 	size_t m = kMin((size_t)size,(size_t)fAppLen);
 
-	if (!isDBOpen())
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open!" << endl;
 		memset(buffer,0,m);
@@ -257,7 +239,7 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open!" << endl;
 		return -1;
@@ -271,10 +253,17 @@
 }
 
 
-	// returns the number of records in the database
-int PilotLocalDatabase::recordCount()
+// returns the number of records in the database
+unsigned int PilotLocalDatabase::recordCount() const
 {
-	return d->size();
+	if (d && isOpen())
+	{
+		return d->size();
+	}
+	else
+	{
+		return 0;
+	}
 }
 
 
@@ -283,7 +272,10 @@
 {
 	int idlen=recordCount();
 	QValueList<recordid_t> idlist;
-	if (idlen<=0) return idlist;
+	if (idlen<=0)
+	{
+		return idlist;
+	}
 
 	// now create the QValue list from the idarr:
 	for (int i=0; i<idlen; i++)
@@ -299,13 +291,13 @@
 {
 	FUNCTIONSETUP;
 
-	d->pending = -1;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << fDBName << ": DB not open!" << endl;
 		return 0L;
 	}
 
+	d->pending = -1;
 
 	for (unsigned int i = 0; i < d->size(); i++)
 	{
@@ -323,17 +315,26 @@
 PilotRecord *PilotLocalDatabase::readRecordByIndex(int index)
 {
 	FUNCTIONSETUP;
+
+	if (index < 0)
+	{
+		DEBUGLIBRARY << fname << ": Index " << index << " is bogus." << endl;
+		return 0L;
+	}
+
 	d->pending = -1;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return 0L;
 	}
-#ifdef DEBUG
-	DEBUGKPILOT << "Index=" << index << " Count=" << recordCount() << endl;
-#endif
-	if (index >= recordCount())
+
+	DEBUGLIBRARY << fname << ": Index=" << index << " Count=" << recordCount() << endl;
+
+	if ( (unsigned int)index >= recordCount() )
+	{
 		return 0L;
+	}
 	PilotRecord *newRecord = new PilotRecord((*d)[index]);
 	d->current = index;
 
@@ -345,7 +346,7 @@
 {
 	FUNCTIONSETUP;
 	d->pending  = -1;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return 0L;
@@ -369,14 +370,12 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return 0L;
 	}
-#ifdef DEBUG
-	DEBUGKPILOT << fname << ": looking for new record from " << d->current << endl;
-#endif
+	DEBUGLIBRARY << fname << ": looking for new record from " << d->current << endl;
 	// Should this also check for deleted?
 	while ((d->current < d->size())
 		&& ((*d)[d->current]->id() != 0 ))
@@ -396,7 +395,7 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return 0L;
@@ -411,9 +410,14 @@
 	}
 
 	if (d->current >= d->size())
+	{
 		return 0L;
+	}
 	PilotRecord *newRecord = new PilotRecord((*d)[d->current]);
-	if (ind) *ind=d->current;
+	if (ind)
+	{
+		*ind=d->current;
+	}
 
 	d->pending = d->current;	// Record which one needs the new id
 	d->current++;	// so we skip it next time
@@ -425,7 +429,7 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open!" << endl;
 		return 0;
@@ -446,7 +450,7 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open!" << endl;
 		return 0;
@@ -486,7 +490,7 @@
 int PilotLocalDatabase::deleteRecord(recordid_t id, bool all)
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo <<": DB not open"<<endl;
 		return -1;
@@ -524,7 +528,7 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open!" << endl;
 		return -1;
@@ -541,7 +545,7 @@
 int PilotLocalDatabase::resetDBIndex()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return -1;
@@ -554,7 +558,7 @@
 int PilotLocalDatabase::cleanup()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdWarning() << k_funcinfo << ": DB not open!" << endl;
 		return -1;
@@ -602,16 +606,12 @@
 	pi_file *dbFile;
 
 	setDBOpen(false);
-	char buffer[PATH_MAX];
-	memset(buffer,0,PATH_MAX);
-	strlcpy(buffer,QFile::encodeName(dbPathName()),PATH_MAX);
 
-	dbFile = pi_file_open(buffer);
+	dbFile = pi_file_open( QFile::encodeName(dbPathName()) );
 	if (dbFile == 0L)
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Failed to open " << dbPathName() << endl;
-#endif
+		QString path = dbPathName();
+		DEBUGLIBRARY << fname << ": Failed to open " << path << endl;
 		return;
 	}
 
@@ -638,10 +638,16 @@
 	while (pi_file_read_record(dbFile, i,
 			&tmpBuffer, &size, &attr, &cat, &id) == 0)
 	{
-		(*d)[i] = new PilotRecord(tmpBuffer, size, attr, cat, id);
+		pi_buffer_t *b = pi_buffer_new(size);
+		memcpy(b->data,tmpBuffer,size);
+		b->used = size;
+		(*d)[i] = new PilotRecord(b, attr, cat, id);
 		i++;
 	}
 	pi_file_close(dbFile);	// We done with it once we've read it in.
+
+	KSaveFile::backupFile( dbPathName() );
+
 	setDBOpen(true);
 }
 
@@ -650,29 +656,31 @@
 	FUNCTIONSETUP;
 	pi_file *dbFile;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
-#ifdef DEBUG
-		DEBUGCONDUIT << fname << ": Database "<<fDBName<<" is not open. Cannot close and write it"<<endl;
-#endif
+		DEBUGLIBRARY << fname << ": Database " << fDBName
+			<< " is not open. Cannot close and write it"
+			<< endl;
 		return;
 	}
 
 	QString newName = dbPathName() + CSL1(".new");
-	char buf[PATH_MAX];
-	memset(buf,0,PATH_MAX);
-	strlcpy(buf,QFile::encodeName(newName),PATH_MAX);
+	QString path = dbPathName();
+	DEBUGLIBRARY << fname
+		<< ": Creating temp file " << newName
+		<< " for the database file " << path << endl;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
-		<< ": Creating temp file " << buf
-		<< " for the database file " << dbPathName() << endl;
-#endif
+	dbFile = pi_file_create(QFile::encodeName(newName),&fDBInfo);
+	pi_file_set_app_info(dbFile, fAppInfo, fAppLen);
 
-	dbFile = pi_file_create(buf,&fDBInfo);
-	pi_file_set_app_info(dbFile, fAppInfo, fAppLen);
 	for (unsigned int i = 0; i < d->size(); i++)
 	{
+		// How did a NULL pointer sneak in here?
+		if (!(*d)[i])
+		{
+			continue;
+		}
+
 		if (((*d)[i]->id() == 0) && ((*d)[i]->isDeleted()))
 		{
 			// Just ignore it
@@ -701,12 +709,10 @@
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname
+	DEBUGLIBRARY << fname
 		<< ": Setting default DB path to "
 		<< s
 		<< endl;
-#endif
 
 	if (!fPathBase)
 	{
@@ -723,3 +729,34 @@
 	return eLocalDB;
 }
 
+
+/* static */ bool PilotLocalDatabase::infoFromFile( const QString &path, DBInfo *d )
+{
+	FUNCTIONSETUP;
+
+	pi_file *f = 0L;
+
+	if (!d)
+	{
+		return false;
+	}
+	if (!QFile::exists(path))
+	{
+		return false;
+	}
+
+	const char * fileName = QFile::encodeName( path );
+	f = pi_file_open( fileName );
+	if (!f)
+	{
+		kdWarning() << k_funcinfo
+			<< ": Can't open " << path << endl;
+		return false;
+	}
+
+	pi_file_get_info(f,d);
+	pi_file_close(f);
+
+	return true;
+}
+
Index: kpilot/lib/pilotUser.h
===================================================================
--- kpilot/lib/pilotUser.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotUser.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -21,7 +21,7 @@
 **
 ** You should have received a copy of the GNU Lesser General Public License
 ** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, 
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 ** MA 02110-1301, USA.
 */
 
@@ -35,42 +35,120 @@
 
 #include <pi-dlp.h>
 
+#include "pilot.h"
+
 class KPilotUser
 {
 public:
-	KPilotUser() { ::memset(&fUser,0,sizeof(struct PilotUser)); }
-	KPilotUser(const PilotUser* user) { fUser = *user; }
+	/** Constructor. Create an empty PilotUser structure. */
+	KPilotUser()
+	{
+		::memset(&fUser,0,sizeof(struct PilotUser));
+	}
+	/** Constructor. Use the given PilotUser structure.
+	*  This creates a copy; no ownership is transferred.
+	*/
+	KPilotUser(const PilotUser *user)
+	{
+		fUser = *user;
+	}
 
-	PilotUser *pilotUser() { return &fUser; }
+	/** Accessor for the whole PilotUser structure. */
+	PilotUser *pilotUser()
+	{
+		return &fUser;
+	}
 
-	const char* getUserName() const     { return fUser.username; }
-	void setUserName(const char* name)
+	/** @return The username set on the handheld. */
+	const char* getUserName() const
 	{
-		memset(&fUser.username, 0, sizeof(fUser.username));
-		strlcpy(fUser.username, name,sizeof(fUser.username));
+		return fUser.username;
 	}
+	/** Set the user name to the given @p name , truncated
+	*  if necessary to the size of the field on the handheld.
+	*/
+	void setUserName( const QString &name)
+	{
+		Pilot::toPilot( name, fUser.username, sizeof(fUser.username) );
+	}
 
-	const int getPasswordLength() const { return fUser.passwordLength; }
-	const char* getPassword() const     { return fUser.password; }
-	void setPassword(char* password)
+	/** @return The length of the password on the handheld,
+	*           in bytes.
+	*/
+	const int getPasswordLength() const
 	{
-		memset(&fUser.password, 0, sizeof(fUser.password));
-		strlcpy(fUser.password, password,sizeof(fUser.password));
-		fUser.passwordLength = strlen(fUser.password);
+		return fUser.passwordLength;
 	}
+	/** @return The password on the handheld, NUL terminated. */
+	const char* getPassword() const
+	{
+		return fUser.password;
+	}
+	/** Set the password for the user to @p password , truncated
+	*  to the size of the field on the handheld if needed.
+	*/
+	void setPassword( const QString &password )
+	{
+		Pilot::toPilot( password, fUser.password, sizeof(fUser.password) );
+	}
 
-	unsigned long getUserID() const     { return fUser.userID; }
-	unsigned long getViewerID() const   { return fUser.viewerID; }
+	/** Accessor for the user ID value; returned as a handheld
+	*  long value (4 bytes).
+	*  @note I have no idea what this is for.
+	*/
+	unsigned long getUserID() const
+	{
+		return fUser.userID;
+	}
+	/** Accessor for the viewer ID value; returned as a handheld
+	*  long value (4 bytes).
+	*  @note I have no idea what this is for.
+	*/
+	unsigned long getViewerID() const
+	{
+		return fUser.viewerID;
+	}
 
-	unsigned long getLastSyncPC() const { return fUser.lastSyncPC; }
-	void setLastSyncPC(unsigned long pc) { fUser.lastSyncPC = pc; }
+	/** @return the ID (4 bytes) of the last PC to sync this handheld.
+	 *          This is intended to help identify when the use has
+	 *          changed PCs and needs a new full sync.
+	 */
+	unsigned long getLastSyncPC() const
+	{
+		return fUser.lastSyncPC;
+	}
+	/** Set the ID of the PC syncing the handheld to @p pc . This
+	 *  should be unique in some way (perhaps IP addresses can be
+	 *  used this way, or hostnames).
+	 */
+	void setLastSyncPC(unsigned long pc)
+	{
+		fUser.lastSyncPC = pc;
+	}
 
-	time_t getLastSuccessfulSyncDate() { return fUser.successfulSyncDate; }
+	/** @return the timestamp that the handheld was last synced
+	 *  successfully.
+	 */
+	time_t getLastSuccessfulSyncDate()
+	{
+		return fUser.successfulSyncDate;
+	}
+	/** Set the timestamp for a successful sync. */
 	void setLastSuccessfulSyncDate(time_t when)
-		{ fUser.successfulSyncDate = when; }
+	{
+		fUser.successfulSyncDate = when;
+	}
 
-	time_t getLastSyncDate()           { return fUser.lastSyncDate; }
-	void setLastSyncDate(time_t when) { fUser.lastSyncDate = when; }
+	/** @return the timestamp of the last sync attempt. */
+	time_t getLastSyncDate()
+	{
+		return fUser.lastSyncDate;
+	}
+	/** Set the timestamp of the sync attempt. */
+	void setLastSyncDate(time_t when)
+	{
+		fUser.lastSyncDate = when;
+	}
 
 private:
 	struct PilotUser fUser;
Index: kpilot/lib/pluginfactory.h
===================================================================
--- kpilot/lib/pluginfactory.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pluginfactory.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,6 +1,6 @@
-#ifndef _KPILOT_PLUGIN_FACTORY_H
-#define _KPILOT_PLUGIN_FACTORY_H
-/* plugin_factory.h                        KPilot
+#ifndef _KPILOT_PLUGINFACTORY_H
+#define _KPILOT_PLUGINFACTORY_H
+/* pluginfactory.h                        KPilot
 **
 ** Copyright (C) 2005 by Adriaan de Groot
 **
@@ -33,7 +33,7 @@
 #include <klibloader.h>
 #include <kdebug.h>
 
-class KPilotDeviceLink;
+class KPilotLink;
 
 /** Template class that defines a conduit's factory. */
 
@@ -68,8 +68,8 @@
 
 		if (qstrcmp(classname,"SyncAction")==0)
 		{
-			KPilotDeviceLink *d = 0L;
-			if (parent) d = dynamic_cast<KPilotDeviceLink *>(parent);
+			KPilotLink *d = 0L;
+			if (parent) d = dynamic_cast<KPilotLink *>(parent);
 
 			if (d || !parent)
 			{
@@ -82,7 +82,7 @@
 			else
 			{
 				kdError() << k_funcinfo
-					<< ": Couldn't cast parent to KPilotDeviceLink"
+					<< ": Couldn't cast parent to KPilotLink"
 					<< endl;
 				return 0L;
 			}
Index: kpilot/lib/pilotLocalDatabase.h
===================================================================
--- kpilot/lib/pilotLocalDatabase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotLocalDatabase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -47,21 +47,7 @@
 	*/
 	PilotLocalDatabase( const QString& path,
 		const QString& name, bool useDefaultPath=true);
-	/**
-	* Opens the local database. A default path is used
-	* ($KDEHOME/share/apps/kpilot/DBBackup)
-	* and if the file is found there, it is opened.
-	* Since a backup messes up the state of the conduits (i.e.
-	* changes on the handheld might no longer be detected after
-	* a backup run, since the conduit assumes the database to have
-	* the state of the previous conduit run,  useConduitDBs=true
-	* opens the database in $KDEHOME/share/apps/kpilot/conduits
-	*
-	* TODO: Deprecate this one.
-	*/
-	PilotLocalDatabase(const QString &name, bool useConduitDBs /* =false */);
 
-
 	/**
 	* Opens the local database. This is primarily for testing
 	* purposes; only tries the given path.
@@ -88,8 +74,8 @@
 	virtual int readAppBlock(unsigned char* buffer, int maxLen);
 	// Writes the application block info.
 	virtual int writeAppBlock(unsigned char* buffer, int len);
-	// returns the number of records in the database
-	virtual int recordCount();
+	// returns the number of records in the database, 0 if not open
+	virtual unsigned int recordCount() const;
 	// Returns a QValueList of all record ids in the database.
 	virtual QValueList<recordid_t> idList();
 	// Reads a record from database by id, returns record
@@ -152,7 +138,7 @@
 	* Accessor functions for the application info block.
 	*/
 	int appInfoSize() const
-		{ if (isDBOpen()) return fAppLen; else return -1; } ;
+		{ if (isOpen()) return fAppLen; else return -1; } ;
 	char *appInfo() { return fAppInfo; } ;
 
 	const struct DBInfo &getDBInfo() const { return fDBInfo; }
@@ -160,6 +146,18 @@
 
 	virtual DBType dbType() const;
 
+	/** Reads local file @p path and fills in the DBInfo
+	*   structure @p d with the DBInfo from the file.
+	*
+	*   @return @c false if d is NULL
+	*   @return @c false if the file @p path does not exist
+	*   @return @c true if reading the DBInfo succeeds
+	*
+	*   @note Relatively expensive operation, since the pilot-link
+	*         library doesn't provide a cheap way of getting this
+	*         information.
+	*/
+	static bool infoFromFile( const QString &path, DBInfo *d );
 
 protected:
 	// Changes any forward slashes to underscores
@@ -183,7 +181,7 @@
 	*/
 public:
 	static void setDBPath(const QString &);
-	static const QString *getDBPath() { return fPathBase; } ;
+	static const QString &getDBPath() { return *fPathBase; } ;
 private:
 	static QString *fPathBase;
 };
Index: kpilot/lib/CMakeLists.txt
===================================================================
--- kpilot/lib/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,78 @@
+include(CheckIncludeFiles)
+include(CheckFunctionExists)
+
+check_include_files( stdint.h HAVE_STDINT_H )
+check_include_files( alloca.h HAVE_ALLOCA_H )
+check_include_files( "sys/time.h" HAVE_SYS_TIME_H )
+check_include_files( "sys/stat.h" HAVE_SYS_STAT_H )
+check_function_exists( cfsetspeed HAVE_CFSETSPEED )
+check_function_exists( strdup HAVE_STRDUP )
+check_function_exists( setenv HAVE_SETENV )
+check_function_exists( unsetenv HAVE_UNSETENV )
+check_function_exists( usleep HAVE_USLEEP )
+check_function_exists( random HAVE_RANDOM )
+check_function_exists( putenv HAVE_PUTENV )
+check_function_exists( seteuid HAVE_SETEUID )
+check_function_exists( mkstemps HAVE_MKSTEMPS )
+check_function_exists( mkstemp HAVE_MKSTEMP )
+check_function_exists( mkdtemp HAVE_MKDTEMP )
+check_function_exists( revoke HAVE_REVOKE )
+check_function_exists( strlcpy HAVE_STRLCPY )
+check_function_exists( strlcat HAVE_STRLCAT )
+check_function_exists( inet_aton HAVE_INET_ATON )
+
+configure_file(
+	${CMAKE_SOURCE_DIR}/config.h.cmake
+	${CMAKE_CURRENT_BINARY_DIR}/config.h
+)
+
+include_directories(${CMAKE_CURRENT_BINARY_DIR})
+
+set(lib_SRCS
+	options.cc
+	uiDialog.cc
+	plugin.cc
+	syncAction.cc
+	kpilotlink.cc
+	pilot.cc
+	pilotAppInfo.cc
+	pilotRecord.cc
+	pilotDatabase.cc
+	pilotLocalDatabase.cc
+	pilotSerialDatabase.cc
+	pilotMemo.cc
+	pilotAddress.cc
+	pilotDateEntry.cc
+	pilotTodoEntry.cc
+)
+
+kde3_automoc(${lib_SRCS})
+kde3_add_kcfg_files(lib_SRCS kpilotlibSettings.kcfgc)
+add_library(kpilot SHARED ${lib_SRCS})
+target_link_libraries(kpilot ${PILOTLINK_LIBRARY} ${QT_LIBRARIES} kabc kdeui)
+kpilot_rpath(kpilot)
+
+#---------- INSTALL -----------------------*
+set(kpilotinclude_HEADERS
+	kpilotlink.h
+	pilot.h
+	pilotDatabase.h
+	pilotLinkVersion.h
+	pilotLocalDatabase.h
+	pilotRecord.h
+	pilotSerialDatabase.h
+	plugin.h
+	pluginfactory.h
+	syncAction.h
+	uiDialog.h
+)
+
+install(
+	TARGETS kpilot
+	LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
+)
+
+install(
+	FILES ${kpilotinclude_HEADERS}
+	DESTINATION ${CMAKE_INSTALL_PREFIX}/include/kpilot
+)
Index: kpilot/lib/fakes.h
===================================================================
--- kpilot/lib/fakes.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/fakes.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,79 @@
+#ifndef _KPILOT_FAKES_H
+#define _KPILOT_FAKES_H
+
+/* This file is part of the KDE libraries
+   Copyright (c) 2000 The KDE Project
+
+   unsetenv() taken from the GNU C Library.
+   Copyright (C) 1992,1995-1999,2000-2002 Free Software Foundation, Inc.
+
+   This library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Library General Public
+   License version 2 as published by the Free Software Foundation.
+
+   This library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   Library General Public License for more details.
+
+   You should have received a copy of the GNU Library General Public License
+   along with this library; see the file COPYING.LIB.  If not, write to
+   the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+   Boston, MA 02110-1301, USA.
+*/
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#ifndef HAVE_SETENV
+int setenv(const char *name, const char *value, int overwrite);
+#endif /* !HAVE_SETENV */
+
+#ifndef HAVE_UNSETENV
+void unsetenv (const char *name);
+#endif /* !HAVE_UNSETENV */
+
+#ifndef HAVE_USLEEP
+void usleep(unsigned int usec);
+#endif /* !HAVE_USLEEP */
+
+#ifndef HAVE_RANDOM
+long int random();
+void srandom(unsigned int seed);
+#endif
+
+#ifndef HAVE_SETEUID
+int seteuid(uid_t euid);
+#endif
+
+#ifndef HAVE_MKSTEMPS
+int mkstemps (char* _template, int suffix_len);
+#endif /* !HAVE_MKSTEMPS */
+
+#ifndef HAVE_MKSTEMP
+int mkstemp (char* _template);
+#endif
+
+#ifndef HAVE_MKDTEMP
+char* mkdtemp (char* _template);
+#endif /* !HAVE_MKDTEMP */
+
+#ifndef HAVE_REVOKE
+int revoke(const char *tty);
+#endif
+
+#ifndef HAVE_STRLCPY
+unsigned long strlcpy(char* d, const char* s, unsigned long bufsize);
+#endif
+
+#ifndef HAVE_STRLCAT
+unsigned long strlcat(char* d, const char* s, unsigned long bufsize);
+#endif
+
+#ifdef __cplusplus
+}
+#endif
+
+
+#endif
Index: kpilot/lib/pilotAddress.cc
===================================================================
--- kpilot/lib/pilotAddress.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotAddress.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,17 +28,12 @@
 */
 
 
-static const char *pilotadress_id =
-	"$Id$";
-
-#ifndef _KPILOT_OPTIONS_H
 #include "options.h"
-#endif
 
+
 #include <stdlib.h>
 #include <assert.h>
 
-#include <qtextcodec.h>
 #include <qstringlist.h>
 
 #include "pilotAddress.h"
@@ -46,45 +41,8 @@
 
 #define MAXFIELDS 19
 
-PilotAddress::PilotAddress(struct AddressAppInfo &appInfo,
-	PilotRecord * rec) :
-	PilotAppCategory(rec),
-	fAppInfo(appInfo),
-	fAddressInfo()
-{
-	FUNCTIONSETUPL(4);
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	pi_buffer_t b;
-	b.data = (unsigned char *) rec->getData();
-	b.allocated = b.used = rec->size();
-	if (rec) unpack_Address(&fAddressInfo, &b, address_v1);
-#else
-	if (rec) unpack_Address(&fAddressInfo, (unsigned char *) rec->data(), rec->size());
-#endif
-	(void) pilotadress_id;
-	_loadMaps();
-}
-
-PilotAddress::PilotAddress(struct AddressAppInfo &appInfo) :
-	PilotAppCategory(),
-	fAppInfo(appInfo)
-{
-	FUNCTIONSETUPL(4);
-	reset();
-
-	// assign the phoneLabel so it doesn't appear in the pilot as
-	// work for all fields, but at least shows other fields
-	fAddressInfo.phoneLabel[0] = (int) eWork;
-	fAddressInfo.phoneLabel[1] = (int) eHome;
-	fAddressInfo.phoneLabel[2] = (int) eOther;
-	fAddressInfo.phoneLabel[3] = (int) eMobile;
-	fAddressInfo.phoneLabel[4] = (int) eEmail;
-
-	_loadMaps();
-}
-
 PilotAddress::PilotAddress(PilotAddressInfo *info, PilotRecord *rec) :
-	PilotAppCategory(rec),
+	PilotRecordBase(rec),
 	fAppInfo(*(info->info())),
 	fAddressInfo()
 {
@@ -93,14 +51,10 @@
 
 	if (rec)
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 		pi_buffer_t b;
-		b.data = (unsigned char *) rec->getData();
+		b.data = (unsigned char *) rec->data();
 		b.allocated = b.used = rec->size();
 		unpack_Address(&fAddressInfo, &b, address_v1);
-#else
-		unpack_Address(&fAddressInfo, (unsigned char *) rec->data(), rec->size());
-#endif
 	}
 	else
 	{
@@ -115,7 +69,7 @@
 }
 
 PilotAddress::PilotAddress(const PilotAddress & copyFrom) :
-	PilotAppCategory(copyFrom),
+	PilotRecordBase(copyFrom),
 	fAppInfo(copyFrom.fAppInfo),
 	fAddressInfo()
 {
@@ -128,7 +82,7 @@
 PilotAddress & PilotAddress::operator = (const PilotAddress & copyFrom)
 {
 	FUNCTIONSETUPL(4);
-	PilotAppCategory::operator = (copyFrom);
+	PilotRecordBase::operator = (copyFrom);
 	_copyAddressInfo(copyFrom.fAddressInfo);
 	return *this;
 }
@@ -179,7 +133,7 @@
 	free_Address(&fAddressInfo);
 }
 
-QString PilotAddress::getTextRepresentation(bool richText)
+QString PilotAddress::getTextRepresentation(bool richText) const
 {
 	QString text, tmp;
 
@@ -226,7 +180,7 @@
 			}
 			else
 				tmp=CSL1("%1: %2");
-			tmp=tmp.arg(PilotAppCategory::codec()->toUnicode(
+			tmp=tmp.arg(Pilot::fromPilot(
 				fAppInfo.phoneLabels[getPhoneLabelIndex(i-entryPhone1)]));
 			tmp=tmp.arg(rtExpand(getField(i), richText));
 			text += tmp;
@@ -296,7 +250,7 @@
 QString PilotAddress::getCategoryLabel() const
 {
 	int cat(category());
-	if (cat>0) return codec()->toUnicode(fAppInfo.category.name[cat]);
+	if (cat>0) return Pilot::fromPilot(fAppInfo.category.name[cat]);
 	else return QString::null;
 }
 
@@ -319,10 +273,8 @@
 		}
 	}
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": returning: ["
-				<< list.size() << "] e-mail addresses." << endl;
-#endif
+	DEBUGLIBRARY << fname << ": returning: ["
+		<< list.size() << "] e-mail addresses." << endl;
 	return list;
 }
 
@@ -334,12 +286,11 @@
 	QString test;
 
 	int shownPhone = getShownPhone() + entryPhone1;
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": preferred pilot index is: ["
-				<< shownPhone << "], preferred phone number is: ["
-				<< getField(shownPhone) << "]" << endl;
-#endif
 
+	DEBUGLIBRARY << fname << ": preferred pilot index is: ["
+		<< shownPhone << "], preferred phone number is: ["
+		<< getField(shownPhone) << "]" << endl;
+
 	for (int i = entryPhone1; i <= entryPhone5; i++)
 	{
 		test = getField(i);
@@ -358,27 +309,24 @@
 					// if this is the preferred phone number, set it as such
 					if (shownPhone == i) {
 						phoneType |= KABC::PhoneNumber::Pref;
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": found preferred pilot index: ["
-				<< i << "], text: [" << test << "]" << endl;
-#endif
+						DEBUGLIBRARY << fname << ": found preferred pilot index: ["
+							<< i << "], text: [" << test << "]" << endl;
 					}
 					KABC::PhoneNumber ph(test, phoneType);
 					list.append(ph);
-				} else {
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": whoopsie.  pilot phone number: ["
-				<< test << "], index: [" << i << "], type: ["
-				<< ind << "], has no corresponding PhoneNumber type." << endl;
-#endif
 				}
+				else
+				{
+					DEBUGLIBRARY << fname << ": whoopsie.  pilot phone number: ["
+						<< test << "], index: [" << i << "], type: ["
+						<< ind << "], has no corresponding PhoneNumber type." << endl;
+				}
 			}
 		}
 	}
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": returning: ["
-				<< list.size() << "] phone numbers" << endl;
-#endif
+
+	DEBUGLIBRARY << fname << ": returning: ["
+		<< list.size() << "] phone numbers" << endl;
 	return list;
 }
 
@@ -419,13 +367,12 @@
 			int phoneKey = it.data();
 			if ( phone.type() & phoneKey)
 			{
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": found pilot type: ["
-				<< pilotKey << "] ("
-				<< fAppInfo.phoneLabels[pilotKey]
-				<< ") for PhoneNumber: ["
-				<< phone.number() << "]" << endl;
-#endif
+				DEBUGLIBRARY << fname << ": found pilot type: ["
+					<< pilotKey << "] ("
+					<< fAppInfo.phoneLabels[pilotKey]
+					<< ") for PhoneNumber: ["
+					<< phone.number() << "]" << endl;
+
 				category = pilotKey;
 				break;
 			}
@@ -434,32 +381,28 @@
 					  phone.number(), true, false);
 
 		// if this is the preferred phone number, then set it as such
-		if (phone.type() & KABC::PhoneNumber::Pref) {
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": found preferred PhoneNumber. "
+		if (phone.type() & KABC::PhoneNumber::Pref) 
+		{
+			DEBUGLIBRARY << fname << ": found preferred PhoneNumber. "
 				<< "setting showPhone to index: ["
 				<< fieldSlot << "], PhoneNumber: ["
 				<< phone.number() << "]" << endl;
-#endif
 			fAddressInfo.showPhone = fieldSlot - entryPhone1;
 		}
 	}
 
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Pilot's showPhone now: ["
-				<< fAddressInfo.showPhone << "]." << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Pilot's showPhone now: ["
+		<< fAddressInfo.showPhone << "]." << endl;
 
 	// after setting the numbers, make sure that something sensible is set as the
 	// shownPhone on the Pilot if nothing is yet...
 	QString pref = getField(fAddressInfo.showPhone + entryPhone1);
 	if (fAddressInfo.showPhone < 0 || fAddressInfo.showPhone > 4 || pref.isEmpty()) {
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Pilot's showPhone: ["
-				<< fAddressInfo.showPhone
-				<< "] not properly set to a default. trying to set a sensible one."
-				<< endl;
-#endif
+		DEBUGLIBRARY << fname << ": Pilot's showPhone: ["
+			<< fAddressInfo.showPhone
+			<< "] not properly set to a default. trying to set a sensible one."
+			<< endl;
+
 		for (int i = entryPhone1; i <= entryPhone5; i++)
 		{
 			pref = getField(i);
@@ -470,10 +413,8 @@
 			}
 		}
 	}
-#ifdef DEBUG
-	DEBUGDAEMON << fname << ": Pilot's showPhone now: ["
-				<< fAddressInfo.showPhone << "], and that's final." << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Pilot's showPhone now: ["
+		<< fAddressInfo.showPhone << "], and that's final." << endl;
 }
 
 void PilotAddress::setEmails(QStringList list)
@@ -544,7 +485,7 @@
 
 QString PilotAddress::getField(int field) const
 {
-	return codec()->toUnicode(fAddressInfo.entry[field]);
+	return Pilot::fromPilot(fAddressInfo.entry[field]);
 }
 
 int PilotAddress::_getNextEmptyPhoneSlot() const
@@ -582,7 +523,7 @@
 		{
 			QString custom4Field = getField(entryCustom4);
 			QString typeStr(
-				codec()->toUnicode(fAppInfo.phoneLabels[appPhoneLabelNum]));
+				Pilot::fromPilot(fAppInfo.phoneLabels[appPhoneLabelNum]));
 
 			custom4Field += typeStr + CSL1(" ") + fieldStr;
 			setField(entryCustom4, custom4Field);
@@ -628,7 +569,7 @@
 		return QString::null;
 
 	// look for the phone type str
-	QString typeToStr(codec()->toUnicode(fAppInfo.phoneLabels[appTypeNum]));
+	QString typeToStr(Pilot::fromPilot(fAppInfo.phoneLabels[appTypeNum]));
 	QString customField(getField(entryCustom4));
 	int foundField = customField.find(typeToStr);
 
@@ -655,7 +596,7 @@
 	FUNCTIONSETUPL(4);
 	for (int index = 0; index < 8; index++)
 	{
-		if (phoneType == codec()->toUnicode(fAppInfo.phoneLabels[index]))
+		if (phoneType == Pilot::fromPilot(fAppInfo.phoneLabels[index]))
 			return index;
 	}
 
@@ -693,7 +634,7 @@
 	if (!text.isEmpty())
 	{
 		fAddressInfo.entry[field] = (char *) malloc(text.length() + 1);
-		strlcpy(fAddressInfo.entry[field], codec()->fromUnicode(text), text.length() + 1);
+		Pilot::toPilot(text, fAddressInfo.entry[field], text.length()+1);
 	}
 	else
 	{
@@ -701,20 +642,17 @@
 	}
 }
 
-void *PilotAddress::pack_(void *buf, int *len)
+PilotRecord *PilotAddress::pack() const
 {
 	FUNCTIONSETUPL(4);
 	int i;
 
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	pi_buffer_t b = { 0,0,0 } ;
-	i = pack_Address(&fAddressInfo, &b, address_v1);
-	memcpy(buf,b.data,kMin(i,*len));
-	*len = kMin(i,*len);
-#else
-	i = pack_Address(&fAddressInfo, (unsigned char *) buf, *len);
-	*len = i;
-#endif
-	return buf;
+	pi_buffer_t *b = pi_buffer_new( sizeof(fAddressInfo) );
+	i = pack_Address(const_cast<Address_t *>(&fAddressInfo), b, address_v1);
+	if (i<0)
+	{
+		return 0L;
+	}
+	// pack_Address sets b->used
+	return new PilotRecord( b, this );
 }
-
Index: kpilot/lib/kpilotlocallink.h
===================================================================
--- kpilot/lib/kpilotlocallink.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/kpilotlocallink.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,84 @@
+#ifndef _KPILOT_KPILOTLOCALLINK_H
+#define _KPILOT_KPILOTLOCALLINK_H
+/* kpilotlocallink.h			KPilot
+**
+** Copyright (C) 1998-2001 by Dan Pilone
+** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "kpilotlink.h"
+
+/** @file Definition of the local link class; implemented in kpilotlink.cc */
+
+
+/** Implementation of the device link for file-system backed (ie. local, fake)
+*   devices. Uses a directory specified in the reset() call to serve databases.
+*/
+class KDE_EXPORT KPilotLocalLink : public KPilotLink
+{
+Q_OBJECT
+public:
+	KPilotLocalLink( QObject *parent=0L, const char *name=0L );
+	virtual ~KPilotLocalLink();
+
+	virtual QString statusString() const;
+	virtual bool isConnected() const;
+	virtual void reset( const QString & );
+	virtual void close();
+	virtual void reset();
+	virtual bool tickle();
+	virtual const KPilotCard *getCardInfo(int card);
+	virtual void endOfSync();
+	virtual void finishSync();
+	virtual int openConduit();
+	virtual int getNextDatabase(int index,struct DBInfo *);
+	virtual int findDatabase(const char *name, struct DBInfo*,
+		int index=0, unsigned long type=0, unsigned long creator=0);
+	virtual bool retrieveDatabase(const QString &path, struct DBInfo *db);
+	virtual DBInfoList getDBList(int cardno=0, int flags=dlpDBListRAM);
+	virtual PilotDatabase *database( const QString &name );
+
+public slots:
+	void ready();
+
+protected:
+	virtual bool installFile(const QString &, const bool deleteFile);
+	virtual void addSyncLogEntryImpl( const QString &s );
+	virtual int pilotSocket() const { return -1; } ;
+
+protected:
+	bool fReady;
+	QString fPath;
+
+	class Private;
+	Private *d;
+
+	unsigned int findAvailableDatabases( Private &, const QString &path );
+} ;
+
+
+#endif
+
Index: kpilot/lib/uiDialog.cc
===================================================================
--- kpilot/lib/uiDialog.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/uiDialog.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -63,13 +63,6 @@
 	grid->addColSpacing(4, SPACING);
 
 
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Looking for icon for "
-		<< p->appName()
-		<< endl;
-#endif
-
 	QPixmap applicationIcon =
 		l->loadIcon(QString::fromLatin1(p->appName()),
 		KIcon::Desktop,
@@ -78,12 +71,6 @@
 
 	if (applicationIcon.isNull())
 	{
-#ifdef DEBUG
-		DEBUGKPILOT << fname
-			<< ": Looking for icon for "
-			<< "kpilot"
-			<< endl;
-#endif
 		applicationIcon = l->loadIcon(QString::fromLatin1("kpilot"),
 			KIcon::Desktop);
 	}
@@ -94,14 +81,7 @@
 	//
 	text->setText(i18n("Send questions and comments to kdepim-users@kde.org"));
 	text->adjustSize();
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Text size "
-		<< text->size().width()
-		<< ","
-		<< text->size().height()
-		<< endl;
-#endif
+
 	int linewidth = text->size().width();
 	int lineheight = text->size().height();
 
@@ -113,16 +93,16 @@
 
 
 	KActiveLabel *linktext = new KActiveLabel(w);
-	grid->addRowSpacing(1,QMAX(100,6*lineheight));
-	grid->addRowSpacing(2,QMAX(100,6*lineheight));
+	grid->addRowSpacing(1,kMax(100,6*lineheight));
+	grid->addRowSpacing(2,kMax(100,6*lineheight));
 	grid->addColSpacing(2,SPACING+linewidth/2);
 	grid->addColSpacing(3,SPACING+linewidth/2);
 	grid->setRowStretch(1,50);
 	grid->setRowStretch(2,50);
 	grid->setColStretch(2,50);
 	grid->setColStretch(3,50);
-	linktext->setMinimumSize(linewidth,QMAX(260,60+12*lineheight));
-	linktext->setFixedHeight(QMAX(260,60+12*lineheight));
+	linktext->setMinimumSize(linewidth,kMax(260,60+12*lineheight));
+	linktext->setFixedHeight(kMax(260,60+12*lineheight));
 	linktext->setVScrollBarMode(QScrollView::Auto/*AlwaysOn*/);
 	text = new QLabel(w);
 	grid->addMultiCellWidget(text,0,0,2,3);
@@ -203,24 +183,7 @@
 	linktext->append(s);
 	linktext->ensureVisible(0,0);
 
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Size "
-		<< w->size().width()
-		<< ","
-		<< w->size().height()
-		<< endl;
-#endif
-
 	w->adjustSize();
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Adjusted size "
-		<< w->size().width()
-		<< ","
-		<< w->size().height()
-		<< endl;
-#endif
 
 	return w;
 }
@@ -245,15 +208,6 @@
 		sz.setHeight(tw->size().height());
 	}
 
-#ifdef DEBUG
-	DEBUGKPILOT << fname
-		<< ": Final size "
-		<< sz.width()
-		<< ","
-		<< sz.height()
-		<< endl;
-#endif
-
 	tw->resize(sz);
 	tw->addTab(w, i18n("About"));
 	tw->adjustSize();
Index: kpilot/lib/pilotAddress.h
===================================================================
--- kpilot/lib/pilotAddress.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotAddress.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -34,9 +34,15 @@
 
 #include <kabc/addressbook.h>
 
-#include "pilotAppCategory.h"
-#include "pilotDatabase.h"
+#include "pilotRecord.h"
+#include "pilotAppInfo.h"
 
+/** Interpreted form of the AppInfo block in the address database. */
+typedef PilotAppInfo<
+	AddressAppInfo,
+	unpack_AddressAppInfo, 
+	pack_AddressAppInfo> PilotAddressInfo;
+
 /** @brief A wrapper class around the Address struct provided by pi-address.h
  *
  * This class allows the user to set and get address field values.
@@ -71,34 +77,25 @@
  * this order is kept. In other languages, main can replaced with
  * Corporation.
  */
-namespace KABC
+class KDE_EXPORT PilotAddress : public PilotRecordBase
 {
-	class PhoneNumber;
-}
-
-typedef PilotAppInfo<AddressAppInfo,unpack_AddressAppInfo, pack_AddressAppInfo> PilotAddressInfo;
-
-class KDE_EXPORT PilotAddress : public PilotAppCategory
-{
 public:
 	enum EPhoneType {
 		eWork=0, eHome, eFax, eOther, eEmail, eMain,
 		ePager, eMobile
 		};
 
-	PilotAddress(struct AddressAppInfo &appInfo) KDE_DEPRECATED ;
-	PilotAddress(struct AddressAppInfo &appInfo, PilotRecord* rec) KDE_DEPRECATED ;
 	PilotAddress(PilotAddressInfo *appinfo, PilotRecord *rec = 0L);
 	PilotAddress(const PilotAddress &copyFrom);
 	PilotAddress& operator=( const PilotAddress &r );
 	bool operator==(const PilotAddress &r);
 
-	~PilotAddress();
+	virtual ~PilotAddress();
 
 	/** Returns a text representation of the address. If richText is true, the
 	 *  text is allowed to contain Qt-HTML tags.
 	 */
-	virtual QString getTextRepresentation(bool richText=false);
+	QString getTextRepresentation(bool richText=false) const;
 
 	/** Zeros the internal address info structure, in effect clearing
 	*  out all prior set values
@@ -119,17 +116,17 @@
 	void setField(int field, const QString &text);
 	QString getField(int field) const;
 
-    /**
-      Return list of all email addresses.  This will search through our "phone"
-	  fields and will return only those which are e-mail addresses.
-     */
-    QStringList getEmails() const;
+	/**
+	*   Return list of all email addresses.  This will search through our "phone"
+	*   fields and will return only those which are e-mail addresses.
+	*/
+	QStringList getEmails() const;
 	void setEmails(QStringList emails);
 
-    /**
-	Return list of all phone numbers.  This will search through our "phone"
-	fields and will return only those which are not e-mail addresses.
-	 */
+	/**
+	*   Return list of all phone numbers.  This will search through our "phone"
+	*   fields and will return only those which are not e-mail addresses.
+	*/
 	KABC::PhoneNumber::List getPhoneNumbers() const;
 	void setPhoneNumbers(KABC::PhoneNumber::List list);
 
@@ -139,7 +136,12 @@
 	*  to the category list
 	*  @return false if category labels are full
 	*/
-	inline bool setCategory(const QString &label) { return PilotAppCategory::setCategory(fAppInfo.category,label); } ;
+	inline bool setCategory(const QString &label)
+	{
+		int c = Pilot::insertCategory(&fAppInfo.category,label,false);
+		PilotRecordBase::setCategory(c);
+		return c>=0;
+	} ;
 
 
 	/**
@@ -175,11 +177,8 @@
 	int  getPhoneLabelIndex(int index) const { return fAddressInfo.phoneLabel[index]; }
 
 
-	virtual void *pack_(void *, int *);
-	void unpack(const void *, int = 0) { }
+	PilotRecord *pack() const;
 
-	static const int APP_BUFFER_SIZE;
-
 	const struct Address *address() const { return &fAddressInfo; } ;
 
 protected:
Index: kpilot/lib/pilotTodoEntry.cc
===================================================================
--- kpilot/lib/pilotTodoEntry.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotTodoEntry.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,9 +28,9 @@
 */
 #include "options.h"
 
+
 #include <stdlib.h>
 
-#include <qtextcodec.h>
 #include <qdatetime.h>
 
 #include <kglobal.h>
@@ -39,10 +39,11 @@
 
 #include "pilotTodoEntry.h"
 
-static const char *pilotTodoEntry_id = "$Id$";
 
-
-PilotTodoEntry::PilotTodoEntry(struct ToDoAppInfo &appInfo):PilotAppCategory(), fAppInfo(appInfo)
+PilotTodoEntry::PilotTodoEntry(struct ToDoAppInfo &appInfo) :
+	fAppInfo(appInfo),
+	fDescriptionSize(0),
+	fNoteSize(0)
 {
 	FUNCTIONSETUP;
 	::memset(&fTodoInfo, 0, sizeof(struct ToDo));
@@ -50,27 +51,40 @@
 
 /* initialize the entry from another one. If rec==NULL, this constructor does the same as PilotTodoEntry()
 */
-PilotTodoEntry::PilotTodoEntry(struct ToDoAppInfo &appInfo, PilotRecord * rec):PilotAppCategory(rec), fAppInfo(appInfo)
+PilotTodoEntry::PilotTodoEntry(struct ToDoAppInfo &appInfo, PilotRecord * rec) :
+	PilotRecordBase(rec),
+	fAppInfo(appInfo),
+	fDescriptionSize(0),
+	fNoteSize(0)
 {
 	::memset(&fTodoInfo, 0, sizeof(struct ToDo));
 	if (rec)
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 		pi_buffer_t b;
-		b.data = (unsigned char *) rec->getData();
+		b.data = (unsigned char *) rec->data();
 		b.allocated = b.used = rec->size();
 		unpack_ToDo(&fTodoInfo, &b, todo_v1);
-#else
-		unpack_ToDo(&fTodoInfo, (unsigned char *) rec->data(),
-			rec->size());
-#endif
+		if (fTodoInfo.description)
+		{
+			// Assume size of buffer allocated is just large enough;
+			// count trailing NUL as well.
+			fDescriptionSize = strlen(fTodoInfo.description)+1;
+		}
+		if (fTodoInfo.note)
+		{
+			// Same
+			fNoteSize = strlen(fTodoInfo.note)+1;
+		}
 	}
 
-	(void) pilotTodoEntry_id;
 }
 
 
-PilotTodoEntry::PilotTodoEntry(const PilotTodoEntry & e):PilotAppCategory(e), fAppInfo(e.fAppInfo)
+PilotTodoEntry::PilotTodoEntry(const PilotTodoEntry & e) :
+	PilotRecordBase( &e ),
+	fAppInfo(e.fAppInfo),
+	fDescriptionSize(0),
+	fNoteSize(0)
 {
 	FUNCTIONSETUP;
 	::memcpy(&fTodoInfo, &e.fTodoInfo, sizeof(fTodoInfo));
@@ -80,10 +94,9 @@
 
 	setDescriptionP(e.getDescriptionP());
 	setNoteP(e.getNoteP());
+}
 
-}				// end of copy constructor
 
-
 PilotTodoEntry & PilotTodoEntry::operator = (const PilotTodoEntry & e)
 {
 	if (this != &e)
@@ -95,6 +108,8 @@
 		// See PilotDateEntry::operator = for details
 		fTodoInfo.description = 0L;
 		fTodoInfo.note = 0L;
+		fDescriptionSize = 0;
+		fNoteSize = 0;
 
 		setDescriptionP(e.getDescriptionP());
 		setNoteP(e.getNoteP());
@@ -102,7 +117,7 @@
 	}
 
 	return *this;
-}				// end of assignment operator
+}
 
 QString PilotTodoEntry::getTextRepresentation(bool richText)
 {
@@ -154,28 +169,33 @@
 
 QString PilotTodoEntry::getCategoryLabel() const
 {
-	return codec()->toUnicode(fAppInfo.category.name[category()]);
+	return Pilot::fromPilot(fAppInfo.category.name[category()]);
 }
 
-void *PilotTodoEntry::pack_(void *buf, int *len)
+PilotRecord *PilotTodoEntry::pack() const
 {
 	int i;
 
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-	pi_buffer_t b = { 0,0,0 } ;
-	i = pack_ToDo(&fTodoInfo, &b, todo_v1);
-	memcpy(buf,b.data,kMin(i,*len));
-	*len = kMin(i,*len);
-#else
-	i = pack_ToDo(&fTodoInfo, (unsigned char *) buf, *len);
-	*len = i;
-#endif
-	return buf;
+	pi_buffer_t *b = pi_buffer_new( sizeof(fTodoInfo) );
+	i = pack_ToDo(const_cast<ToDo_t *>(&fTodoInfo), b, todo_v1);
+	if (i<0)
+	{
+		return 0;
+	}
+	// pack_ToDo sets b->used
+	return new PilotRecord( b, this );
 }
 
 void PilotTodoEntry::setDescription(const QString &desc)
 {
-	setDescriptionP(codec()->fromUnicode(desc),desc.length());
+	if (desc.length() < fDescriptionSize)
+	{
+		Pilot::toPilot(desc, fTodoInfo.description, fDescriptionSize);
+	}
+	else
+	{
+		setDescriptionP(Pilot::toPilot(desc),desc.length());
+	}
 }
 
 void PilotTodoEntry::setDescriptionP(const char *desc, int len)
@@ -183,12 +203,17 @@
 	KPILOT_FREE(fTodoInfo.description);
 	if (desc && *desc)
 	{
-		if (-1 == len) len=::strlen(desc);
+		if (-1 == len)
+		{
+			len=::strlen(desc);
+		}
 
+		fDescriptionSize = len+1;
 		fTodoInfo.description = (char *)::malloc(len + 1);
 		if (fTodoInfo.description)
 		{
-			strlcpy(fTodoInfo.description, desc, len+1);
+			strncpy(fTodoInfo.description, desc, len);
+			fTodoInfo.description[len] = 0;
 		}
 		else
 		{
@@ -205,24 +230,37 @@
 
 QString PilotTodoEntry::getDescription() const
 {
-	return codec()->toUnicode(getDescriptionP());
+	return Pilot::fromPilot(getDescriptionP());
 }
 
 void PilotTodoEntry::setNote(const QString &note)
 {
-	setNoteP(codec()->fromUnicode(note),note.length());
+	if (note.length() < fNoteSize)
+	{
+		Pilot::toPilot(note, fTodoInfo.note, fNoteSize);
+	}
+	else
+	{
+		setNoteP(Pilot::toPilot(note),note.length());
+	}
 }
 
 void PilotTodoEntry::setNoteP(const char *note, int len)
 {
 	KPILOT_FREE(fTodoInfo.note);
 	if (note && *note)
-	  {
-	    if (-1 == len) len=::strlen(note);
+	{
+		if (-1 == len)
+		{
+			len=::strlen(note);
+		}
+
+		fNoteSize = len+1;
 		fTodoInfo.note = (char *)::malloc(len + 1);
 		if (fTodoInfo.note)
 		{
-		    strlcpy(fTodoInfo.note, note, len+1);
+			strncpy(fTodoInfo.note, note, len);
+			fTodoInfo.note[len] = 0;
 		}
 		else
 		{
@@ -238,6 +276,6 @@
 
 QString PilotTodoEntry::getNote() const
 {
-	return codec()->toUnicode(getNoteP());
+	return Pilot::fromPilot(getNoteP());
 }
 
Index: kpilot/lib/plugin.h
===================================================================
--- kpilot/lib/plugin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,7 +41,10 @@
 class PilotDatabase;
 class KLibrary;
 
-#define KPILOT_PLUGIN_API	(20050401)
+namespace Pilot
+{
+	static const unsigned int PLUGIN_API = 20061118;
+}
 
 /**
 * The first classe here: ConduitConfigBase is for configuration purposes.
@@ -135,7 +138,7 @@
 {
 Q_OBJECT
 public:
-	ConduitAction(KPilotDeviceLink *,
+	ConduitAction(KPilotLink *,
 		const char *name=0L,
 		const QStringList &args = QStringList());
 	virtual ~ConduitAction();
@@ -188,12 +191,16 @@
 	} ;
 	void setFirstSync(bool first) { fFirstSync=first; } ;
 
-	PilotDatabase *fDatabase,*fLocalDatabase;
+	PilotDatabase *fDatabase;
+	PilotDatabase *fLocalDatabase; // Guaranteed to be a PilotLocalDatabase
 
 	/**
-	* See openDatabases_ for info on the @p retrieved
-	* parameter. In local mode, @p retrieved is left
-	* unchanged.
+	* Open both the local copy of database @p dbName
+	* and the version on the Pilot. Return true only
+	* if both opens succeed. If the local copy of the database
+	* does not exist, it is retrieved from the handheld. In this
+	* case, retrieved is set to true, otherwise it is left alone
+	* (i.e. retains its value and is not explicitly set to false).
 	*
 	* @param dbName database name to open.
 	* @param retrieved indicator whether the database had to be loaded
@@ -210,38 +217,14 @@
 	QString fConduitName;
 private:
 	bool fFirstSync;
-
-private:
-	/**
-	* Open both the local copy of database @p dbName
-	* and the version on the Pilot. Return true only
-	* if both opens succeed. If the local copy of the database
-	* does not exist, it is retrieved from the handheld. In this
-	* case, retrieved is set to true, otherwise it is left alone
-	* (i.e. retains its value and is not explicitly set to false).
-	*/
-	bool openDatabases_(const QString &dbName, bool*retrieved=0L);
-
-	/**
-	* Open both databases, but get the fDatabase not from
-	* the Pilot, but from a local database in an alternate
-	* directory. For testing only.
-	*
-	* If @p localPath is QString::null, don't even try to open
-	* fDatabase (the one that is supposed to be on the HH).
-	* Just open the one inteded to be on the PC (fLocalDatabase).
-	*/
-	bool openDatabases_(const QString &dbName,const QString &localPath);
 } ;
 
-/** A class containing only static helper methods. */
-class KDE_EXPORT PluginUtility
+/** A namespace containing only static helper methods. */
+namespace PluginUtility
 {
-public:
-	/** Searches the string list for --handle=NN and returns the number. */
-	static int findHandle(const QStringList &);
-	/** Searches the string list for --modal and returns true if found. */
-	static bool isModal(const QStringList &a);
+	/** Searches the argument list for --foo=bar and returns bar, QString::null if not found.
+	* Don't include the -- in the argname. */
+	QString findArgument(const QStringList &a, const QString argname);
 
 	/**
 	* This function attempts to detect whether or not the given
@@ -251,14 +234,14 @@
 	* The current approach is to ask the DCOP server if the application
 	* has registered.
 	*/
-	static bool isRunning(const QCString &appName);
+	bool isRunning(const QCString &appName);
 
 	/**
 	* Check a given library for its version, returning 0 if no
 	* version symbol is found.
 	*/
-	static long pluginVersion(const KLibrary *);
-	static QString pluginVersionString(const KLibrary *);
+	unsigned long pluginVersion(const KLibrary *);
+	QString pluginVersionString(const KLibrary *);
 } ;
 
 /**
Index: kpilot/lib/pilotTodoEntry.h
===================================================================
--- kpilot/lib/pilotTodoEntry.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotTodoEntry.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -37,59 +37,90 @@
 
 #include <qstring.h>
 
-#include "pilotAppCategory.h"
-#include "pilotDatabase.h"
+#include "pilotRecord.h"
+#include "pilotAppInfo.h"
 
 /** @file This file defines structures wrapped around the ToDo database
 * on the Pilot, based on pilot-link's ToDo stuff.
 */
 
 /** A decoded ToDo item. */
-class KDE_EXPORT PilotTodoEntry : public PilotAppCategory
+class KDE_EXPORT PilotTodoEntry : public PilotRecordBase
 {
 public:
 	/** Create an empty ToDo item */
 	PilotTodoEntry(struct ToDoAppInfo &appInfo);
+
 	/** Create a ToDo item and fill it with data from the uninterpreted record @p rec. */
 	PilotTodoEntry(struct ToDoAppInfo &appInfo, PilotRecord * rec);
+
 	/** Copy an existing ToDo item. */
 	PilotTodoEntry(const PilotTodoEntry &e);
+
 	/** Delete a ToDo item. */
-	~PilotTodoEntry() { free_ToDo(&fTodoInfo); }
+	~PilotTodoEntry()
+	{
+		free_ToDo(&fTodoInfo);
+	}
 
 	/** Return a string for the ToDo item. If @param richText is true, then
 	* use qt style markup to make the string clearer when displayed.
 	*/
-	virtual QString getTextRepresentation(bool richText=false);
+	QString getTextRepresentation(bool richText=false);
 
 	/** Assign an existing ToDo item to this one. */
 	PilotTodoEntry& operator=(const PilotTodoEntry &e);
 
 	/** Accessor for the Due Date of the ToDo item. */
 	struct tm getDueDate() const { return fTodoInfo.due; }
+
 	/** Set the Due Date for the ToDo item. */
-	void setDueDate(struct tm& d) { fTodoInfo.due = d; }
+	void setDueDate(struct tm& d)
+	{
+		fTodoInfo.due = d;
+	}
 
 	/** Return the indefinite status of the ToDo (? that is, whether it
 	* had a Due Date that is relevant or not). Return values are 0
 	* (not indefinite) or non-0.
 	*/
-	int getIndefinite() const { return fTodoInfo.indefinite; }
+	int getIndefinite() const
+	{
+		return fTodoInfo.indefinite;
+	}
+
 	/** Set whether the ToDo is indefinite or not. */
-	void setIndefinite(int i) { fTodoInfo.indefinite = i; }
+	void setIndefinite(int i)
+	{
+		fTodoInfo.indefinite = i;
+	}
 
 	/** Return the priority of the ToDo item. The priority ranges
 	* from 1-5 on the handheld, so this needs to be mapped (perhaps)
 	* onto KOrganizer's priority levels.
 	*/
-	int getPriority() const { return fTodoInfo.priority; }
+	int getPriority() const
+	{
+		return fTodoInfo.priority;
+	}
+
 	/** Set the priority of the ToDo. */
-	void setPriority(int p) { fTodoInfo.priority = p; }
+	void setPriority(int p)
+	{
+		fTodoInfo.priority = p;
+	}
 
 	/** Return whether the ToDo is complete (done, finished) or not. */
-	int getComplete() const { return fTodoInfo.complete; }
+	int getComplete() const
+	{
+		return fTodoInfo.complete;
+	}
+
 	/** Set whether the ToDo is done. */
-	void setComplete(int c) { fTodoInfo.complete = c; }
+	void setComplete(int c)
+	{
+		fTodoInfo.complete = c;
+	}
 
 	/** Get the ToDo item's description (which is the title shown on
 	* the handheld, and the item's Title in KDE). This uses the default codec.
@@ -102,6 +133,7 @@
 	* on the handheld). This uses the default codec.
 	*/
 	QString getNote() const;
+
 	/** Set the ToDo item's note. */
 	void  setNote(const QString &note);
 
@@ -112,14 +144,16 @@
 	/** If the label already exists, uses the id; if not, adds the label
 	*  to the category list. @return false if category labels are full.
 	*/
-	inline bool setCategory(const QString &label) { return PilotAppCategory::setCategory(fAppInfo.category,label);  };
+	inline bool setCategory(const QString &label)
+	{
+		int c = Pilot::insertCategory(&fAppInfo.category,label,false);
+		PilotRecordBase::setCategory(c);
+		return c>=0;
+	}
 
-	// static const int APP_BUFFER_SIZE;
+	PilotRecord *pack() const;
 
 protected:
-	void *pack_(void *buf, int *size);
-	void unpack(const void *buf, int size = 0) { } ;
-
 	const char *getDescriptionP() const { return fTodoInfo.description; } ;
 	void setDescriptionP(const char *, int len=-1) ;
 	const char *getNoteP() const { return fTodoInfo.note; } ;
@@ -128,6 +162,7 @@
 private:
 	struct ToDo fTodoInfo;
 	struct ToDoAppInfo &fAppInfo;
+	unsigned int fDescriptionSize, fNoteSize;
 };
 
 typedef PilotAppInfo<ToDoAppInfo,unpack_ToDoAppInfo, pack_ToDoAppInfo> PilotToDoInfo;
Index: kpilot/lib/pilotAppInfo.cc
===================================================================
--- kpilot/lib/pilotAppInfo.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/pilotAppInfo.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,69 @@
+/* pilotAppInfo.cc		KPilot
+**
+** Copyright (C) 2005-2006 Adriaan de Groot <groot@kde.org>
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+
+#include "options.h"
+
+#include <stdio.h>
+
+#include "pilotAppInfo.h"
+
+PilotAppInfoBase::PilotAppInfoBase(PilotDatabase *d) : fC(new struct CategoryAppInfo), fLen(0), fOwn(true)
+{
+	FUNCTIONSETUP;
+	int appLen = Pilot::MAX_APPINFO_SIZE;
+	unsigned char buffer[Pilot::MAX_APPINFO_SIZE];
+
+	if (!d || !d->isOpen())
+	{
+		kdError() << "Bad database pointer." << endl;
+		fLen = 0;
+		KPILOT_DELETE( fC );
+		return;
+	}
+	fLen = appLen = d->readAppBlock(buffer,appLen);
+	unpack_CategoryAppInfo(fC, buffer, appLen);
+}
+
+PilotAppInfoBase::~PilotAppInfoBase()
+{
+	if (fOwn) delete fC;
+}
+
+bool PilotAppInfoBase::setCategoryName(unsigned int i, const QString &s)
+{
+	if ( (i>=Pilot::CATEGORY_COUNT) || // bad category number
+		(!categoryInfo())) // Nowhere to write to
+	{
+		return false;
+	}
+
+	(void) Pilot::toPilot(s, categoryInfo()->name[i], Pilot::CATEGORY_SIZE - 1);
+	return true;
+}
+
+
Index: kpilot/lib/recordConduit.h
===================================================================
--- kpilot/lib/recordConduit.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/recordConduit.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,5 +1,5 @@
-#ifndef _RECORD_CONDUIT_H
-#define _RECORD_CONDUIT_H
+#ifndef _KPILOT_RECORDCONDUIT_H
+#define _KPILOT_RECORDCONDUIT_H
 /* record-conduit.h                           KPilot
 **
 ** Copyright (C) 2005 by Adriaan de Groot
@@ -70,20 +70,21 @@
 		// delete fTimer; // Timer is a child object
 	} ;
 
-	/** The different directions that a pair of records (one on the PC, one
-	* on the Pilot) can be synced. These correspond to special sync directions
-	* and the most general "sync both ways". Values of this type are passed
-	* to the single-record syncer functions.
-	*/
-	typedef enum { HHtoPC=0, PCtoHH=1, Both=2 } SyncDirection;
-
 	/** Return values for the processing functions. Each should return
 	* NotDone if it needs to be called again (e.g. to process another record),
 	* Done if it is finished and something else should be done, and
 	* Error if the sync cannot be completed.
 	*/
-	typedef enum { NotDone=0, Done=1, Error=2 } SyncProgress;
+	enum SyncProgress { NotDone=0, Done=1, Error=2 } ;
 
+	/** Returns a human-readable name for the progress indicator @p s */
+	static QString name(SyncProgress s);
+
+	/** State of the conduit's sync. This is changed by process(). */
+	enum States { Initialize, PalmToPC, PCToPalm, Cleanup } ;
+
+	static QString name(States s);
+
 protected:
 	/** Function called at the beginning of a sync to load data from the PC.
 	* @return Done when the load has finished.
@@ -94,16 +95,24 @@
 	/** Function called repeatedly to fetch the next modified entry from the Palm and
 	* sync it with the PC by looking up the record, and calling the syncer for it.
 	*
-	* @return true when there are no more modified records on the Palm
-	* @see process
+	* @return Dome when there are no more modified records on the Palm
+	* @see process()
 	*/
 	virtual SyncProgress palmRecToPC() = 0;
 
+	/** Function called repeatedly to fetch the next modified entry from the PC and
+	* sync it with the Palm by looking up the record and calling the syncer for it.
+	*
+	* @return Done when there are no more modified records on the PC
+	* @see process()
+	*/
+	virtual SyncProgress pcRecToPalm() = 0;
+
 	/** Function called at the end of this conduit's sync, which should reset DB flags
 	* and write changed config data out to disk.
 	*
-	* @return true if the cleanup succeeds.
-	* @see process
+	* @return Done when the cleanup is complete.
+	* @see process()
 	*/
 	virtual SyncProgress cleanup() = 0;
 
@@ -120,10 +129,8 @@
 	/** Timer to signal the process() slot. Used to keep the UI responsive. */
 	QTimer *fTimer;
 
-	/** State of the conduit's sync. This is changed by process. */
-	enum { Initialize, PalmToPC, Cleanup } fState;
+	States fState;
 
-	QMap<recordid_t,QString> fUIDMap;
 	RecordIDList fIDList;
 	RecordIDList::Iterator fIDListIterator;
 
@@ -135,13 +142,12 @@
 {
 public:
 	/** Construct a record conduit on a given device link. */
-	RecordConduit(const QString &name /**< Name presented to user */,
+	RecordConduit(
 		KPilotDeviceLink *o /**< Connection to HH */,
 		const char *n /**< Name for QObject */,
 		const QStringList a = QStringList() /**< Flags */) :
 		RecordConduitBase(o,n,a)
 	{
-		fConduitName=name;
 	} ;
 	virtual ~RecordConduit()
 	{
@@ -149,78 +155,23 @@
 
 	virtual SyncProgress loadPC()
 	{
-		fAppInfo = new HHAppInfo(fDatabase) ;
-		fContainer = new PCContainer();
-		if (!fContainer->load())
-		{
-			emit logError(i18n("Unable to load the %1 database on the PC.").arg(fConduitName));
-			return Error;
-		}
-		if (fContainer->isEmpty()) setFirstSync(true); /* And leave UID map empty */
-		else fContainer->mapToRecords(fUIDMap);
-
 		return Done;
 	} ;
 
 	virtual SyncProgress palmRecToPC()
 	{
-		if ( fIDListIterator == fIDList.end() )
-		{
-			return Done;
-		}
+		return Done;
+	}
 
-		recordid_t currentID = *fIDListIterator++;
-		PilotRecord *rec = fDatabase->readRecordById(currentID);
-		HHEntry *currentHH = 0;
-		PCEntry *currentPC = 0;
-		Q_ASSERT(rec);
-		if (fUIDMap.contains(currentID))
-		{
-			QString currentUID = fUIDMap[currentID];
-			// This is a modified entry or it is deleted on the HH
-			if (rec->isDeleted())
-			{
-				fContainer->remove(currentUID);
-			}
-			else
-			{
-				currentHH = new HHEntry(rec);
-				currentPC = fContainer->get(currentUID);
-				Syncer::sync(currentPC,currentHH,fAppInfo,HHtoPC);
-			}
-		}
-		else
-		{
-			// Deleted on HH, unknown on PC -> Ignore it.
-			// Not deleted, unknown -> New record.
-			if (!rec->isDeleted())
-			{
-				currentHH = new HHEntry(rec);
-				currentPC = new PCEntry();
-				Syncer::sync(currentPC,currentHH,fAppInfo,HHtoPC);
-				fContainer->insert(currentPC);
-			}
-		}
-		delete rec;
-		delete currentHH;
-		// delete currentPC; Ownership passed to the container
-
-		return NotDone;
+	virtual SyncProgress pcRecToPalm()
+	{
+		return Done;
 	}
 
 	virtual SyncProgress cleanup()
 	{
-		delete fAppInfo;
-		fContainer->save();
-		delete fContainer;
 		return Done;
 	}
-
-	virtual bool getAppInfo( unsigned char *buffer, int appLen ) { return true; } ;
-
-protected:
-	HHAppInfo *fAppInfo;
-	PCContainer *fContainer;
 } ;
 
 
Index: kpilot/lib/syncAction.cc
===================================================================
--- kpilot/lib/syncAction.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/syncAction.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,8 +26,6 @@
 /*
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
-static const char *syncAction_id =
-	"$Id$";
 
 #include "options.h"
 
@@ -57,17 +55,16 @@
 #include "syncAction.moc"
 #include "kpilotlibSettings.h"
 
-SyncAction::SyncAction(KPilotDeviceLink  *p,
+SyncAction::SyncAction(KPilotLink  *p,
 	const char *name) :
 	QObject(p, name),
 	fHandle(p),
 	fParent(0L)
 {
 	FUNCTIONSETUP;
-	(void) syncAction_id;
 }
 
-SyncAction::SyncAction(KPilotDeviceLink *p,
+SyncAction::SyncAction(KPilotLink *p,
 	QWidget * visibleparent,
 	const char *name) :
 	QObject(p, name),
@@ -94,16 +91,12 @@
 {
 	FUNCTIONSETUP;
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname
+	DEBUGLIBRARY << fname
 		<< ": Running conduit " << name() << endl;
-#endif
 
 	bool r = this->exec();
 
-#ifdef DEBUG
-	DEBUGCONDUIT << fname << ": Exec returned " << r << endl;
-#endif
+	DEBUGLIBRARY << fname << ": Exec returned " << r << endl;
 
 	if (!r)
 	{
@@ -131,20 +124,18 @@
 } maps[] =
 {
 	{ SyncAction::SyncMode::eHotSync, "--hotsync" },
-	{ SyncAction::SyncMode::eFastSync, "--fast" },
 	{ SyncAction::SyncMode::eFullSync, "--full" },
 	{ SyncAction::SyncMode::eCopyPCToHH, "--copyPCToHH" },
 	{ SyncAction::SyncMode::eCopyHHToPC, "--copyHHToPC" },
 	{ SyncAction::SyncMode::eBackup, "--backup" },
 	{ SyncAction::SyncMode::eRestore, "--restore" },
-	{ SyncAction::SyncMode::eFastSync, "--fastsync" },
 	{ SyncAction::SyncMode::eFullSync, "--fullsync" },
 	{ SyncAction::SyncMode::eHotSync, (const char *)0 }
 }
 ;
 
 SyncAction::SyncMode::SyncMode(const QStringList &args) :
-	fMode(eFastSync),
+	fMode(eHotSync),
 	fTest(args.contains("--test")),
 	fLocal(args.contains("--local"))
 {
@@ -162,7 +153,7 @@
 	if (!maps[i].name)
 	{
 		kdError() << k_funcinfo << "No mode set by arguments "
-			<< args << ", defaulting to FastSync." << endl;
+			<< args << ", defaulting to HotSync." << endl;
 	}
 }
 
@@ -171,11 +162,11 @@
 	fTest(test),
 	fLocal(local)
 {
-	if ( ((int)m<(int)eFastSync) || ((int)m>(int)eRestore) )
+	if ( ((int)m<(int)eHotSync) || ((int)m>(int)eRestore) )
 	{
 		kdError() << k_funcinfo << "Mode value " << (int)m << " is illegal"
-			", defaulting to FastSync." << endl;
-		fMode = eFastSync;
+			", defaulting to HotSync." << endl;
+		fMode = eHotSync;
 	}
 }
 
@@ -210,7 +201,6 @@
 {
 	switch(e)
 	{
-	case eFastSync : return i18n("FastSync");
 	case eHotSync : return i18n("HotSync");
 	case eFullSync : return i18n("Full Synchronization");
 	case eCopyPCToHH : return i18n("Copy PC to Handheld");
Index: kpilot/lib/pilotSerialDatabase.cc
===================================================================
--- kpilot/lib/pilotSerialDatabase.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotSerialDatabase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,32 +35,27 @@
 #include <pi-dlp.h>
 
 #include <qfile.h>
-#include <qtextcodec.h>
 
 #include <klocale.h>
 #include <kdebug.h>
 #include <kglobal.h>
 
-#include "pilotAppCategory.h"
+#include "pilotRecord.h"
 #include "pilotSerialDatabase.h"
+#include "kpilotdevicelink.h"
 
-static const char *pilotSerialDatabase_id =
-	"$Id$";
-
-PilotSerialDatabase::PilotSerialDatabase(int linksocket,
+PilotSerialDatabase::PilotSerialDatabase(KPilotDeviceLink *l,
 	const QString &dbName) :
 	PilotDatabase(dbName),
 	fDBName(QString::null),
 	fDBHandle(-1),
-	fDBSocket(linksocket)
+	fDBSocket(l->pilotSocket())
 {
 	FUNCTIONSETUP;
 	fDBName = dbName;
 
 	openDatabase();
 
-	/* NOTREACHED */
-	(void) pilotSerialDatabase_id;
 }
 
 PilotSerialDatabase::~PilotSerialDatabase()
@@ -80,15 +75,11 @@
 int PilotSerialDatabase::readAppBlock(unsigned char *buffer, int maxLen)
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return -1;
 	}
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	return dlp_ReadAppBlock(fDBSocket, getDBHandle(), 0, (void *) buffer,
-		maxLen);
-#else
 	pi_buffer_t *buf = pi_buffer_new(maxLen);
 	int r = dlp_ReadAppBlock(fDBSocket, getDBHandle(), 0 /* offset */, maxLen, buf);
 	if (r>=0)
@@ -97,14 +88,13 @@
 	}
 	pi_buffer_free(buf);
 	return r;
-#endif
 }
 
 // Writes the application block info.
 int PilotSerialDatabase::writeAppBlock(unsigned char *buffer, int len)
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return -1;
@@ -113,15 +103,18 @@
 }
 
 	// returns the number of records in the database
-int PilotSerialDatabase::recordCount()
+unsigned int PilotSerialDatabase::recordCount() const
 {
 	int idlen;
 	// dlp_ReadOpenDBInfo returns the number of bytes read and sets idlen to the # of recs
-	if (isDBOpen() && dlp_ReadOpenDBInfo(fDBSocket, getDBHandle(), &idlen)>0)
+	if (isOpen() && dlp_ReadOpenDBInfo(fDBSocket, getDBHandle(), &idlen)>0)
 	{
 		return idlen;
 	}
-	else return -1;
+	else
+	{
+		return 0;
+	}
 }
 
 
@@ -158,7 +151,7 @@
 	FUNCTIONSETUPL(3);
 	int index, attr, category;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return 0L;
@@ -169,19 +162,11 @@
 			<<id<<endl;;
 		return 0L;
 	}
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	char buffer[PilotRecord::APP_BUFFER_SIZE];
-	PI_SIZE_T size;
-	if (dlp_ReadRecordById(fDBSocket, getDBHandle(), id, buffer, &index,
-			&size, &attr, &category) >= 0)
-		return new PilotRecord(buffer, size, attr, category, id);
-#else
 	pi_buffer_t *b = pi_buffer_new(InitialBufferSize);
 	if (dlp_ReadRecordById(fDBSocket,getDBHandle(),id,b,&index,&attr,&category) >= 0)
 	{
 		return new PilotRecord(b, attr, category, id);
 	}
-#endif
 	return 0L;
 }
 
@@ -190,7 +175,7 @@
 {
 	FUNCTIONSETUPL(3);
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return 0L;
@@ -200,22 +185,12 @@
 	recordid_t id;
 	PilotRecord *rec = 0L;
 
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	char buffer[PilotRecord::APP_BUFFER_SIZE];
-	PI_SIZE_T size;
-	if (dlp_ReadRecordByIndex(fDBSocket, getDBHandle(), index,
-			buffer, &id, &size, &attr, &category) >= 0)
-	{
-		rec = new PilotRecord(buffer, size, attr, category, id);
-	}
-#else
 	pi_buffer_t *b = pi_buffer_new(InitialBufferSize);
 	if (dlp_ReadRecordByIndex(fDBSocket, getDBHandle(), index,
 		b, &id, &attr, &category) >= 0)
 	{
 		rec = new PilotRecord(b, attr, category, id);
 	}
-#endif
 
 
 	return rec;
@@ -228,23 +203,15 @@
 	int index, attr;
 	recordid_t id;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return 0L;
 	}
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	char buffer[PilotRecord::APP_BUFFER_SIZE];
-	PI_SIZE_T size;
-	if (dlp_ReadNextRecInCategory(fDBSocket, getDBHandle(),
-			category, buffer, &id, &index, &size, &attr) >= 0)
-		return new PilotRecord(buffer, size, attr, category, id);
-#else
 	pi_buffer_t *b = pi_buffer_new(InitialBufferSize);
 	if (dlp_ReadNextRecInCategory(fDBSocket, getDBHandle(),
 		category,b,&id,&index,&attr) >= 0)
 		return new PilotRecord(b, attr, category, id);
-#endif
 	return 0L;
 }
 
@@ -255,28 +222,17 @@
 	int index, attr, category;
 	recordid_t id;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return 0L;
 	}
-#if PILOT_LINK_NUMBER < PILOT_LINK_0_12_0
-	char buffer[PilotRecord::APP_BUFFER_SIZE];
-	PI_SIZE_T size;
-	if (dlp_ReadNextModifiedRec(fDBSocket, getDBHandle(), (void *) buffer,
-			&id, &index, &size, &attr, &category) >= 0)
-	{
-		if (ind) *ind=index;
-		return new PilotRecord(buffer, size, attr, category, id);
-	}
-#else
 	pi_buffer_t *b = pi_buffer_new(InitialBufferSize);
 	if (dlp_ReadNextModifiedRec(fDBSocket, getDBHandle(), b, &id, &index, &attr, &category) >= 0)
 	{
 		if (ind) *ind=index;
 		return new PilotRecord(b, attr, category, id);
 	}
-#endif
 	return 0L;
 }
 
@@ -287,7 +243,7 @@
 	recordid_t newid;
 	int success;
 
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return 0;
@@ -316,7 +272,7 @@
 int PilotSerialDatabase::deleteRecord(recordid_t id, bool all)
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo <<": DB not open"<<endl;
 		return -1;
@@ -329,7 +285,7 @@
 int PilotSerialDatabase::resetSyncFlags()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return -1;
@@ -341,7 +297,7 @@
 int PilotSerialDatabase::resetDBIndex()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return -1;
@@ -353,7 +309,7 @@
 int PilotSerialDatabase::cleanup()
 {
 	FUNCTIONSETUP;
-	if (isDBOpen() == false)
+	if (!isOpen())
 	{
 		kdError() << k_funcinfo << ": DB not open" << endl;
 		return -1;
@@ -409,11 +365,11 @@
 	int db;
 
 	// if the database is already open, we cannot create it again. How about completely resetting it? (i.e. deleting it and the createing it again)
-	if (isDBOpen()) return true;
+	if (isOpen()) return true;
 	// The latin1 seems ok, database names are latin1.
 	int res=dlp_CreateDB(fDBSocket,
 		creator, type, cardno, flags, version,
-		PilotAppCategory::codec()->fromUnicode(getDBName()), &db);
+		Pilot::toPilot(getDBName()), &db);
 	if (res<0) {
 		kdError() <<k_funcinfo
 			<< i18n("Cannot create database %1 on the handheld").arg(getDBName())<<endl;
@@ -428,7 +384,7 @@
 void PilotSerialDatabase::closeDatabase()
 {
 	FUNCTIONSETUP;
-	if (!isDBOpen() ) return;
+	if (!isOpen() ) return;
 
 	dlp_CloseDB(fDBSocket, getDBHandle());
 	setDBOpen(false);
@@ -438,9 +394,9 @@
 {
 	FUNCTIONSETUP;
 
-	if (isDBOpen()) closeDatabase();
+	if (isOpen()) closeDatabase();
 
-	return dlp_DeleteDB(fDBSocket, 0, PilotAppCategory::codec()->fromUnicode(fDBName));
+	return dlp_DeleteDB(fDBSocket, 0, Pilot::toPilot(fDBName));
 }
 
 
Index: kpilot/lib/pilotDatabase.h
===================================================================
--- kpilot/lib/pilotDatabase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotDatabase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,6 +4,7 @@
 **
 ** Copyright (C) 1998-2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2005-2006 Adriaan de Groot <groot@kde.org>
 **
 ** This is the abstract base class for databases, which is used both
 ** by local databases and by the serial databases held in the Pilot.
@@ -31,35 +32,9 @@
 */
 
 
-#include <qstring.h>
-#include <qvaluelist.h>
+#include "pilot.h"
 
-// Handle all time.h variations properly.
-// Required because pi-macros.h sometimes forgets it.
-//
-#ifdef TIME_WITH_SYS_TIME
-# include <sys/time.h>
-# include <time.h>
-#else
-# ifdef HAVE_SYS_TIME_H
-#  include <sys/time.h>
-# else
-#  include <time.h>
-# endif
-#endif
 
-#include "pilotLinkVersion.h"
-
-#include <pi-dlp.h>
-
-
-class PilotRecord;
-struct CategoryAppInfo;
-
-typedef QValueList<recordid_t> RecordIDList;
-
-
-
 /**
  * Methods to access a database on the pilot.
  *
@@ -81,7 +56,7 @@
 	* Debugging information: tally how many databases are created
 	* or destroyed. Returns the count of currently existing databases.
 	*/
-	static int count();
+	static int instanceCount();
 
 	/* -------------------- Abstract interface for subclasses ----------------- */
 
@@ -106,15 +81,18 @@
 	/** Writes the application block info. */
 	virtual int writeAppBlock(unsigned char* buffer, int len) = 0;
 
-	/** returns the number of records in the database */
-	virtual int recordCount()=0;
+	/** Returns the number of records in the database.
+	 *  If the database is not open, return -1.
+	 */
+	virtual unsigned int recordCount() const=0;
 
 	/** Returns a QValueList of all record ids in the database.
 	    This implementation is really bad. */
-	virtual RecordIDList idList();
+	virtual Pilot::RecordIDList idList();
+
 	/** Returns a list of all record ids that have been modified in the
 	    database. This implementation is really bad. */
-	virtual RecordIDList modifiedIDList();
+	virtual Pilot::RecordIDList modifiedIDList();
 
 
 	/** Reads a record from database by id, returns record length */
@@ -158,7 +136,7 @@
 	/** Purges all Archived/Deleted records from Palm Pilot database */
 	virtual int cleanup() = 0;
 
-	bool isDBOpen() const { return fDBOpen; }
+	bool isOpen() const { return fDBOpen; }
 
 	/** Returns some sensible human-readable identifier for
 	*   the database. Serial databases get Pilot:, local
@@ -191,149 +169,6 @@
 	QString fName;
 };
 
-/** Base class for all specific kinds of AppInfo. */
-class KDE_EXPORT PilotAppInfoBase
-{
-protected:
-	/** Constructor. This is for use by derived classes (using the template below
-	* only, and says that the category info in the base class aliases data in
-	* the derived class. Remember to call init()!
-	*/
-	PilotAppInfoBase() : fC(0L), fLen(0), fOwn(false) { } ;
-
-	/** Initialize class members after reading header, to alias data elsewhere.
-	* Only for use by the (derived) template classes below.
-	*/
-	void init(struct CategoryAppInfo *c, int len)
-	{
-		fC = c;
-		fLen = len ;
-	} ;
-
-public:
-	/** Maximum size of an AppInfo block, taken roughly from the pilot-link source. */
-	static const int MAX_APPINFO_SIZE=8192;
-
-	/** Constructor, intended for untyped access to the AppInfo only. This throws
-	* away everything but the category information. In this variety, the
-	* CategoryAppInfo structure is owned by the PilotAppInfoBase object.
-	*/
-	PilotAppInfoBase(PilotDatabase *d);
-	/** Destructor. */
-	virtual ~PilotAppInfoBase();
-
-	/** Retrieve the most basic part of the AppInfo block -- the category
-	* information which is guaranteed to be the first 240-odd bytes of
-	* a database.
-	*/
-	struct CategoryAppInfo *categoryInfo() { return fC; } ;
-	/** Const version of the above function. */
-	const struct CategoryAppInfo *categoryInfo() const { return fC; } ;
-	/** Returns the length of the (whole) AppInfo block. */
-	PI_SIZE_T length() const { return fLen; } ;
-
-	/** Search for the given category @p name in the list
-	* of categories; returns the category number. If @p unknownIsUnfiled
-	* is true, then map unknown categories to Unfiled instead of returning
-	* an error number.
-	*
-	* @return >=0   is a specific category based on the text-to-
-	*               category number mapping defined by the Pilot,
-	*               where 0 is always the 'unfiled' category.
-	*  @return -1   means unknown category selected when
-	*               @p unknownIsUnfiled is false.
-	*  @return  0   == Unfiled means unknown category selected when
-	*               @p unknownIsUnfiled is true.
-	*
-	*/
-	static int findCategory(const QString &name, bool unknownIsUnfiled, struct CategoryAppInfo *info);
-	/** Alternative to the above inconvenience function. */
-	int findCategory(const QString &name, bool unknownIsUnfiled = false)
-		{ return findCategory(name,unknownIsUnfiled,categoryInfo()); } ;
-
-	/** For debugging, display all the category names */
-	void dump() const;
-
-	/** For debugging, display category names for the given AppInfo
-	* structure. Called by dump().
-	*/
-	static void dumpCategories(const struct CategoryAppInfo &info);
-
-	/** Gets a single category name. Returns QString::null if there is no
-	* such category number @p i . */
-	QString category(unsigned int i);
-
-	/** Sets a category name. @return true if this succeeded. @return false
-	* on failure, e.g. the index @p i was out of range or the category name
-	* was invalid. Category names that are too long are truncated to 15 characters.
-	*/
-	bool setCategoryName(unsigned int i, const QString &s);
-
-private:
-	struct CategoryAppInfo *fC;
-	PI_SIZE_T fLen;
-	bool fOwn;
-} ;
-
-/** A template class for reading and interpreting AppInfo blocks;
-* the idea is that it handles all the boilerplate code for reading
-* the app block, converting it to the right kind, and then unpacking
-* it. Template parameters are the type (struct, from pilot-link probably)
-* of the interpreted appinfo, and the pack and unpack functions for it
-* (again, from pilot-link).
-*/
-template <typename appinfo,
-	int(*unpack)(appinfo *, unsigned char *, PI_SIZE_T),
-	int(*pack)(appinfo *, unsigned char *, PI_SIZE_T)>
-class PilotAppInfo : public PilotAppInfoBase
-{
-public:
-	/** Constructor. Read the appinfo from database @p d and
-	* interpret it.
-	*/
-	PilotAppInfo(PilotDatabase *d) : PilotAppInfoBase()
-	{
-		int appLen = MAX_APPINFO_SIZE;
-		unsigned char buffer[MAX_APPINFO_SIZE];
-
-		memset(&fInfo,0,sizeof(fInfo));
-		if (d && d->isDBOpen())
-		{
-			appLen = d->readAppBlock(buffer,appLen);
-			(*unpack)(&fInfo, buffer, appLen);
-		}
-		// fInfo is just a struct, so we can point to it anyway.
-		init(&fInfo.category,appLen);
-	} ;
-
-	/** Write this appinfo block to the database @p d; returns
-	* the number of bytes written or -1 on failure. This
-	* function is robust when called with a NULL database @p d.
-	*/
-	int write(PilotDatabase *d)
-	{
-		unsigned char buffer[MAX_APPINFO_SIZE];
-		if (!d || !d->isDBOpen())
-		{
-			return -1;
-		}
-		int appLen = (*pack)(&fInfo, buffer, length());
-		if (appLen > 0)
-		{
-			d->writeAppBlock(buffer,appLen);
-		}
-		return appLen;
-	} ;
-
-	/** Returns a (correctly typed) pointer to the interpreted
-	* appinfo block.
-	*/
-	appinfo *info() { return &fInfo; } ;
-
-protected:
-	appinfo fInfo;
-} ;
-
 /** A template class for reading and interpreting a database. This removes
 * the need for a lot of boilerplate code that does the conversions.
 * Parameters are two interpretation classes: one for the KDE side of
Index: kpilot/lib/kpilotlink.h
===================================================================
--- kpilot/lib/kpilotlink.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/kpilotlink.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,15 +4,10 @@
 **
 ** Copyright (C) 1998-2001 by Dan Pilone
 ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2006 Adriaan de Groot <groot@kde.org>
 **
 */
 
-/** @file
-** Encapsulates all the communication with the pilot. Also
-** does daemon-like polling of the Pilot. Interesting status
-** changes are signalled.
-*/
-
 /*
 ** This program is free software; you can redistribute it and/or modify
 ** it under the terms of the GNU Lesser General Public License as published by
@@ -38,7 +33,7 @@
 #include <pi-dlp.h>
 
 #include <qobject.h>
-#include <qptrlist.h>
+#include <qvaluelist.h>
 
 class QTimer;
 class QDateTime;
@@ -47,35 +42,20 @@
 class KPilotUser;
 class KPilotSysInfo;
 class KPilotCard;
+class PilotDatabase;
 struct DBInfo;
 
-/**
-** The struct db is a description class for Pilot databases
-** by Kenneth Albanowski. It's not really clear why it's *here*.
-** The macro pi_mktag is meant to be given four char (8-bit)
-** quantities, which are arranged into an unsigned long; for example
-** pi_mktag('l','n','c','h'). This is called the creator tag
-** of a database, and db.creator can be compared with such a
-** tag. The tag lnch is used by the Pilot's launcher app. Some
-** parts of KPilot require such a tag.
-*/
-struct db
-{
-	char name[256];
-	int flags;
-	unsigned long creator;
-	unsigned long type;
-	int maxblock;
-};
 
-#define pi_mktag(c1,c2,c3,c4) (((c1)<<24)|((c2)<<16)|((c3)<<8)|(c4))
 
-
-
-/** A class that handles some aspects of communication with the
-** Handheld. A KPilotLink object represents a connection to a device
-** (which may be active or inactive -- the latter in cases where
-** the link is @e waiting for a device to show up). The object
+/** @file
+** Encapsulates all the communication with the pilot. Also
+** does daemon-like polling of the Pilot. Interesting status
+** changes are signalled.
+**
+** This file defines three classes; these handle some aspects of
+** communication with a Handheld. A KPilotLink object represents a
+** connection to a device (which may be active or inactive -- the latter in
+** cases where the link is @e waiting for a device to show up). The object
 ** handles waiting, protocol initialization and some general
 ** tasks such as getting system information or user data.
 **
@@ -83,73 +63,19 @@
 ** PilotDatabase methods or use pilot-link dlp_* functions directly
 ** on handle().
 **
-**
 ** The KPilotLink class was originally a kind of C++ wrapper
 ** for the pilot-link library. It grew and grew and mutated
 ** until it was finally cleaned up again in 2001. In the meantime
 ** it had become something that wrapped a lot more than just
 ** pilot-link.
+**
+** This file defines an abstract base class KPilotLink, which may
+** be specialized for a real physical device that communicates
+** with DLP/SLP through the pilot-link library, or as a "fake"
+** device which uses data on the local filesystem to simulate
+** a device. These subclasses are KPilotDeviceLink and KPilotLocalLink.
 */
 
-class KDE_EXPORT KPilotDeviceLink : public QObject
-{
-friend class SyncAction;
-Q_OBJECT
-
-/*
-** Constructors and destructors.
-*/
-public:
-	/**
-	* Creates a pilot link that can sync to the pilot.
-	*
-	* Call reset() on it to start looking for a device.
-	*/
-	KPilotDeviceLink( QObject *parent = 0, const char *name = 0, const QString &tempDevice = QString::null );
-	/** Destructor. This rudely ends the communication with the handheld. */
-	virtual ~KPilotDeviceLink();
-
-
-/*
-** Status information
-*/
-
-public:
-	/**
-	* The link behaves like a state machine most of the time:
-	* it waits for the actual device to become available, and
-	* then becomes ready to handle syncing.
-	*/
-	typedef enum {
-		Init,
-		WaitingForDevice,
-		FoundDevice,
-		CreatedSocket,
-		DeviceOpen,
-		AcceptedDevice,
-		SyncDone,
-		PilotLinkError,
-		WorkaroundUSB
-		} LinkStatus;
-
-	/** Get the status (state enum) of this link.
-	* @return The LinkStatus enum for the link's current state.
-	*/
-	LinkStatus status() const { return fLinkStatus; } ;
-	/** Get a human-readable string for the given status @p l. */
-	static QString statusString(LinkStatus l);
-	/** Get a human-readable string for the status of this object. */
-	virtual QString statusString() const;
-
-	/**
-	* True if HotSync has been started but not finished yet
-	* (ie. the physical Pilot is waiting for sync commands)
-	*/
-	bool getConnected() const { return fLinkStatus == AcceptedDevice; }
-
-private:
-	LinkStatus fLinkStatus;
-
 /**
 * Tickle handling.
 *
@@ -213,270 +139,275 @@
 * with a non-zero timeout and that timeout has elapsed. The
 * tickler is stopped before timeout is emitted.
 */
-public slots:
-	bool tickle() const;
-protected:
-	void startTickle(unsigned int timeout=0);
-	void stopTickle();
-public:
-	virtual bool event(QEvent *e);
-	static const unsigned int TickleTimeoutEvent = 1066;
 
-signals:
-	void timeout();
+/** A list of DBInfo structures. */
+typedef QValueList<struct DBInfo> DBInfoList;
 
-private:
-	bool fTickleDone;
-	QThread *fTickleThread;
+/** This is the abstract base class for Handheld interaction.
+*   It tries to define all the behavior that we need; calls
+*   to virtual *Impl() functions are used to implement the
+*   specific behavior for subclasses.
+*/
+class KDE_EXPORT KPilotLink : public QObject
+{
+Q_OBJECT
+friend class SyncAction;
+public:
+	/** Constructor. Use reset() to start looking for a device. */
+	KPilotLink( QObject *parent = 0, const char *name = 0 );
+	/** Destructor. This rudely interrupts any communication in progress. */
+	virtual ~KPilotLink();
 
 
+	/** Provides a human-readable status string. */
+	virtual QString statusString() const = 0;
 
+	/**
+	* True if HotSync has been started but not finished yet
+	* (ie. the physical Pilot is waiting for sync commands)
+	*/
+	virtual bool isConnected() const = 0;
 
 
-/*
-** Used for initially attaching to the device.
-** deviceReady(KPilotDeviceLink*) is emitted when the device has been opened
-** and a Sync can start.
-*/
-public:
 	/**
 	* Information on what kind of device we're dealing with.
+	* A link is associated with a path -- either the node in
+	* /dev that the physical device is attached to, or an
+	* IP address, or a filesystem path for local links.
+	* Whichever is being used, this function returns its
+	* name in a human-readable form.
 	*/
 	QString pilotPath() const { return fPilotPath; } ;
 
 	/**
 	* Return the device link to the Init state and try connecting
-	* to the given device path (if it's non-empty).
+	* to the given device path (if it's non-empty). What the
+	* path means depends on the kind of link we're instantiating.
+	*
+	* @see reset()
+	* @see pilotPath()
 	*/
-	void reset(const QString &pilotPath);
+	virtual void reset(const QString &pilotPath) = 0;
 
+	/** Implementation detail to handle tickle timeouts. */
+	virtual bool event(QEvent *e);
 
-	/**
-	* Special-cases. Call this after a reset to set device-
-	* specific workarounds; the only one currently known
-	* is the Zire 31/72 T5 quirk of doing a non-HotSync
-	* connect when it's switched on.
+	/** Install the list of files (full paths!) named by @p l
+	*   onto the handheld (or whatever this link represents).
+	*   If @p deleteFiles  is true, the source files are removed.
+	*
+	*   @return the number of files successfully installed.
 	*/
-	void setWorkarounds(bool usb)
-	{
-		fWorkaroundUSB = usb;
-	} ;
+	unsigned int installFiles(const QStringList &l, const bool deleteFiles);
 
 	/**
-	* sets an additional device, which should be tried as fallback
-	* usefull for hotplug enviroments
+	* Write a log entry to the handheld. If @p log is true,
+	* then the signal logMessage() is also emitted. This
+	* function is supposed to @em only write to the handheld's
+	* log (with a physical device, that is what appears on
+	* screen at the end of a sync).
 	*/
-	void setTempDevice( const QString &device );
+	void addSyncLogEntry(const QString &entry,bool log=true);
 
-private:
-	bool fWorkaroundUSB;
-	QTimer *fWorkaroundUSBTimer;
+	/** Find a database with the given @p name (and optionally,
+	*   type @p type and creator ID (from pi_mktag) @p creator,
+	*   on searching from index @p index on the handheld.
+	*   Fills in the DBInfo structure if found, returns < 0
+	*   on error.
+	*/
+	virtual int findDatabase(const char *name, struct DBInfo*,
+		int index=0, unsigned long type=0, unsigned long creator=0) = 0;
 
-private slots:
-	void workaroundUSB();
-
-public slots:
 	/**
-	* Release all resources, including the master pilot socket,
-	* timers, notifiers, etc.
+	* Retrieve the database indicated by DBInfo @p *db into the
+	* local file @p path. This copies all the data, and you can
+	* create a PilotLocalDatabase from the resulting @p path .
+	*
+	* @return @c true on success
 	*/
-	void close();
+	virtual bool retrieveDatabase(const QString &path, struct DBInfo *db) = 0;
 
-	/**
-	* Assuming things have been set up at least once already by
-	* a call to reset() with parameters, use this slot to re-start
-	* with the same settings.
+	/** Fill the DBInfo structure @p db with information about
+	*   the next database (in some ordering) counting from
+	*   @p index.
+	*   @return < 0 on error
 	*/
-	void reset();
+	virtual int getNextDatabase(int index,struct DBInfo *db) = 0;
 
-protected slots:
-	/**
-	* Attempt to open the device. Called regularly to check
-	* if the device exists (to handle USB-style devices).
+	/** Returns a list of DBInfo structures describing all the
+	*   databases available on the link (ie. device) with the
+	*   given card number @p cardno and flags @p flags. No known
+	*   handheld uses a cardno other than 0; use flags to
+	*   indicate what kind of databases to fetch -- @c dlpDBListRAM
+	*   or @c dlpDBListROM.
+	*
+	*   @return list of DBInfo objects, one for each database
+	*   @note ownership of the DBInfo objects is passed to the
+	*         caller, who must delete the objects.
 	*/
-	void openDevice();
+	virtual DBInfoList getDBList(int cardno=0, int flags=dlpDBListRAM) = 0;
 
-	/**
-	* Called when the device is opened *and* activity occurs on the
-	* device. This indicates the beginning of a hotsync.
+	/** Return a database object for manipulating the database with
+	*    name @p name on the link. This database may be local or
+	*    remote, depending on the kind of link in use.
+	*
+	*    @return pointer to database object, or 0 on error.
+	*    @note ownership of the database object is given to the caller,
+	*          who must delete the object in time.
 	*/
-	void acceptDevice();
+	virtual PilotDatabase *database( const QString &name ) = 0;
 
-protected:
 	/**
-	* Does the low-level opening of the device and handles the
-	* pilot-link library initialisation.
+	* Retrieve the user information from the device. Ownership
+	* is kept by the link, and at the end of a sync the user
+	* information is synced back to the link -- so it may be
+	* modified, but don't make local copies of it.
+	*
+	* @note Do not call this before the sync begins!
 	*/
-	bool open( QString device = QString::null );
+	KPilotUser &getPilotUser() { return *fPilotUser; }
 
 	/**
-	* Check for device permissions and existence, emitting
-	* warnings for weird situations. This is primarily intended
-	* to inform the user.
+	* System information about the handheld. Ownership is kept
+	* by the link. For non-device links, something fake is
+	* returned.
+	*
+	* @note Do not call this before the sync begins!
 	*/
-	void checkDevice();
+	const KPilotSysInfo &getSysInfo() { return *fPilotSysInfo; }
 
 	/**
-	* Some messages are only printed once and are suppressed
-	* after that. These are indicated by flag bits in
-	* messages.
+	* Retrieve information about the data card @p card;
+	* I don't think that any pilot supports card numbers
+	* other than 0. Non-device links return something fake.
+	*
+	* This function may return NULL (non-device links or
+	* on error).
+	*
+	* @note Ownership of the KPilotCard object is given
+	*       to the caller, who must delete it.
 	*/
-	enum { OpenMessage=1, OpenFailMessage=2 } ;
-	int messages;
-	int messagesMask;
-	static const int messagesType;
+	virtual const KPilotCard *getCardInfo(int card=0) = 0;
 
-	void shouldPrint(int,const QString &);
+	/** End the sync in a gracuful manner. */
+	virtual void endOfSync() = 0;
+	/** End the sync in a graceful manner @em and update
+	*   the last-sync time and user information on the handheld.
+	*/
+	virtual void finishSync() = 0;
 
 signals:
+	/** A timeout associated with tickling has occurred. Each
+	*   time startTickle() is called, you can state how long
+	*   tickling should last (at most) before timing out.
+	*
+	*   You can only get a timeout when the Qt event loop is
+	*   running, which somewhat limits the usefulness of timeouts.
+	*/
+	void timeout();
+
+	/** Signal that a message has been written to the sync log. */
+	void logMessage(const QString &);
+	/** Signal that an error has occurred, for logging. */
+	void logError(const QString &);
+	/** Signal that progress has been made, for logging purposes.
+	*   @p p is the percentage completed (0 <= s <= 100).
+	*   The string @p s is logged as well, if non-Null.
+	*/
+	void logProgress(const QString &s, int p);
+
 	/**
 	* Emitted once the user information has been read and
 	* the HotSync is really ready to go.
 	*/
-	void deviceReady( KPilotDeviceLink* );
+	void deviceReady( KPilotLink* );
 
-protected:
-	int pilotSocket() const { return fCurrentPilotSocket; } ;
 
-
-private:
+public slots:
 	/**
-	* Path of the device special file that will be used.
-	* Usually /dev/pilot, /dev/ttySx, or /dev/usb/x.
+	* Release all resources, including the master pilot socket,
+	* timers, notifiers, etc.
 	*/
-	QString fPilotPath;
+	virtual void close() = 0;
+
 	/**
-	* Path with resolved symlinks, to prevent double binding
-	* to the same device.
+	* Assuming things have been set up at least once already by
+	* a call to reset() with parameters, use this slot to re-start
+	* with the same settings.
 	*/
-	QString fRealPilotPath;
+	virtual void reset() = 0;
 
+	/** Tickle the underlying device exactly once. */
+	virtual bool tickle() = 0;
+
+protected:
 	/**
-	* For transient devices: how often have we tried pi_bind()?
+	* Path of the device special file that will be used.
+	* Usually /dev/pilot, /dev/ttySx, or /dev/usb/x. May be
+	* a filesystem path for local links.
 	*/
-	int fRetries;
+	QString fPilotPath;
 
-	/**
-	* Timers and Notifiers for detecting activity on the device.
+	/** Start tickling the Handheld (every few seconds). This
+	*   lasts until @p timeout seconds have passed (or forever
+	*   if @p timeout is zero).
+	*
+	*   @note Do not call startTickle() twice with no intervening
+	*         stopTickle().
 	*/
-	QTimer *fOpenTimer;
-	QSocketNotifier *fSocketNotifier;
-	bool fSocketNotifierActive;
+	void startTickle(unsigned int timeout=0);
 
-	/**
-	* Pilot-link library handles for the device once it's opened.
+	/** Stop tickling the Handheld. This may block for some
+	*   time (less than a second) to allow the tickle thread
+	*   to finish.
 	*/
-	int fPilotMasterSocket;
-	int fCurrentPilotSocket;
-	QString fTempDevice;
+	void stopTickle();
 
-	/**
-	* Handle cases where we can't accept or open the device,
-	* and data remains available on the pilot socket.
+	/** Install a single file onto the device link. Full pathname
+	*   @p f is used; in addition, if @p deleteFile is true remove
+	*   the source file. Returns @c true if the install succeeded.
+	*
+	*   The default
 	*/
-	int fAcceptedCount;
-signals:
-	/**
-	* Whenever a conduit adds a Sync log entry (actually,
-	* KPilotLink itself adds some log entries itself),
-	* this signal is emitted.
-	*/
-	void logEntry(const char *);
+	virtual bool installFile( const QString &f, const bool deleteFile ) = 0;
 
-/*
-** File installation.
-*/
-public:
-	int installFiles(const QStringList &, const bool deleteFiles=true);
-protected:
-	bool installFile(const QString &, const bool deleteFile=true);
-
 	/**
-	* Write a log entry to the pilot. Note that the library
-	* function takes a char *, not const char * (which is
-	* highly dubious). Causes signal logEntry(const char *)
-	* to be emitted if @p log is true.
+	* Notify the Pilot user that a conduit is running now.
+	* On real devices, this prints out (on screen) which database
+	* is now opened; useful for progress reporting.
+	*
+	* @return -1 on error
+	* @note the default implementation returns 0
 	*/
-	void addSyncLogEntry(const QString &entry,bool log=true);
+	virtual int openConduit();
 
-signals:
-	/**
-	* Whenever a conduit adds a Sync log entry (actually,
-	* KPilotLink itself adds some log entries itself),
-	* this signal is emitted.
+	/** Returns a file handle for raw operations. Not recommended.
+	*   On links with no physical device backing, returns -1.
+	*
+	*   @note the default implementation returns -1
 	*/
-	void logMessage(const QString &);
-	void logError(const QString &);
-	void logProgress(const QString &, int);
+	virtual int pilotSocket() const;
 
-
-/*
-** Pilot User Identity functions.
-*/
-protected:
-	KPilotUser  *fPilotUser;
-	KPilotSysInfo *fPilotSysInfo;
-public:
-	/**
-	* Returns the user information as set in the KPilot settings dialog.
-	* The user information can also be set by the Pilot, and at the
-	* end of a HotSync the two user informations can be synced as well
-	* with finishSync -- this writes fPilotUser again, so don't make
-	* local copies of the KPilotUser structure and modify them.
+	/** Actually write an entry to the device link. The message
+	*   @p s is guaranteed to be non-Null.
 	*/
-	KPilotUser *getPilotUser() { return fPilotUser; }
-	KPilotSysInfo *getSysInfo() { return fPilotSysInfo; }
-	KPilotCard *getCardInfo(int card=0);
-	void endOfSync();
-	void finishSync();
+	virtual void addSyncLogEntryImpl( const QString &s ) = 0;
 
-/*
-** Actions intended just to abstract away the pilot-link library interface.
-*/
-protected:
-	/**
-	* Notify the Pilot user which conduit is running now.
+	/** User information structure. Should be filled in when a sync
+	*   starts, so that conduits can use the information.
 	*/
-	int openConduit();
-public:
-	int getNextDatabase(int index,struct DBInfo *);
-	int findDatabase(const char *name, struct DBInfo*,
-		int index=0, long type=0, long creator=0);
+	KPilotUser  *fPilotUser;
 
-	/**
-	* Retrieve the database indicated by DBInfo *db into the
-	* local file @p path.
+	/** System information about the device. Filled in when the
+	*   sync starts. Non-device links need to fake something.
 	*/
-	bool retrieveDatabase(const QString &path, struct DBInfo *db);
-	QPtrList<DBInfo> getDBList(int cardno=0, int flags=dlpDBListRAM);
+	KPilotSysInfo *fPilotSysInfo;
 
-public:
-	/**
-	 * Get the time from the handheld device into a QDateTime
-	 */
-	QDateTime getTime();
-	/**
-	 * Set the time on the handheld to the give QDateTime
-	 */
-	bool setTime(const time_t &pctime);
 
-	/**
-	 * Get the version number from the handheld
-	 */
-	unsigned long ROMversion() const;
-	/**
-	 * Get the major PalmOS version number
-	 */
-	unsigned long majorVersion() const;
-	/**
-	 * Get the minor PalmOS version number
-	 */
-	unsigned long minorVersion() const;
-
 private:
-	class KPilotDeviceLinkPrivate;
+	bool fTickleDone;
+	QThread *fTickleThread;
+
 } ;
 
-bool operator < ( const struct db &, const struct db &) ;
-
 #endif
Index: kpilot/lib/Makefile.am
===================================================================
--- kpilot/lib/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,48 +16,43 @@
 
 lib_LTLIBRARIES = libkpilot.la
 
-libkpilot_la_SOURCES = kpilotlibSettings.kcfgc options.cc uiDialog.cc plugin.cc syncAction.cc \
+libkpilot_la_SOURCES = kpilotlibSettings.kcfgc \
+	options.cc uiDialog.cc plugin.cc syncAction.cc \
 	kpilotlink.cc \
-	pilotRecord.cc pilotDatabase.cc \
+	pilot.cc \
+	pilotAppInfo.cc pilotRecord.cc pilotDatabase.cc \
 	pilotLocalDatabase.cc pilotSerialDatabase.cc \
-	pilotMemo.cc pilotAddress.cc \
-	pilotDateEntry.cc pilotTodoEntry.cc \
-	recordConduit.cc
+	pilotMemo.cc \
+	pilotAddress.cc \
+	pilotDateEntry.cc \
+	pilotTodoEntry.cc
 
-libkpilot_la_LDFLAGS = -no-undefined $(PISOCK_LDFLAGS) $(all_libraries) $(KDE_EXTRA_RPATH) $(KDE_RPATH)
-libkpilot_la_LIBADD = $(LIB_KDEUI) $(PISOCK_LIB) $(LIB_KABC) $(top_builddir)/libkcal/libkcal.la
+libkpilot_la_LDFLAGS = $(PISOCK_LDFLAGS) -no-undefined $(all_libraries) $(KDE_EXTRA_RPATH) $(KDE_RPATH)
+libkpilot_la_LIBADD = $(PISOCK_LIB) $(LIB_KDEUI) $(LIB_KABC) $(top_builddir)/libkcal/libkcal.la
 
 kpilotincludedir = $(includedir)/kpilot
-kpilotinclude_HEADERS = kpilotlink.h uiDialog.h \
-	plugin.h pluginfactory.h syncAction.h \
-	pilotRecord.h pilotDatabase.h \
-	pilotLocalDatabase.h pilotSerialDatabase.h \
-	pilotLinkVersion.h
+kpilotinclude_HEADERS = \
+	kpilotlink.h \
+	pilot.h \
+	pilotDatabase.h \
+	pilotLinkVersion.h \
+	pilotLocalDatabase.h \
+	pilotRecord.h \
+	pilotSerialDatabase.h \
+	plugin.h \
+	pluginfactory.h \
+	syncAction.h \
+	uiDialog.h
 
+
 kde_kcfg_DATA = kpilotlib.kcfg
 
-check_PROGRAMS = testactions testconstants testdatabase
-TESTS = testactions testconstants testdatabase
-
-testactions_SOURCES = testactions.cc
-testactions_LDFLAGS = $(PISOCK_LDFLAGS) $(all_libraries) $(KDE_RPATH)
-testactions_LDADD  = libkpilot.la $(PISOCK_LIB)
-
-testconstants_SOURCES = testconstants.cc
-testconstants_LDFLAGS = $(PISOCK_LDFLAGS) $(all_libraries) $(KDE_RPATH)
-testconstants_LDADD   = libkpilot.la $(PISOCK_LIB)
-
-testdatabase_SOURCES  = testdatabase.cc
-testdatabase_LDFLAGS  = $(PISOCK_LDFLAGS) $(all_libraries) $(KDE_RPATH)
-testdatabase_LDADD    = libkpilot.la $(PISOCK_LIB)
-testdatabase_CXXFLAGS = '-DSOURCE="$(srcdir)"'
-
 check-local:
 	rm -f FAILED
 	for i in $(srcdir)/*.h ; do \
 		( echo "#include <kdemacros.h>" ; echo "#include \"$$i\"" ; echo "int main(int argc,char **argv){return 0;}" ) > header-test.cc; \
 		echo "$$i" ; \
-		g++ $(all_includes) $(PISOCK_INCLUDE) -c header-test.cc || echo "$$i" >> FAILED; \
+		g++ $(all_includes) -c header-test.cc || echo "$$i" >> FAILED; \
 	done
 	test ! -e FAILED
 
Index: kpilot/lib/pilot.cc
===================================================================
--- kpilot/lib/pilot.cc	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/pilot.cc	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,242 @@
+/* pilot.cc			KPilot
+**
+** Copyright (C) 1998-2001 by Dan Pilone
+** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2003-2006 Adriaan de Groot <groot@kde.org>
+**
+** These are the base class structures that reside on the
+** handheld device -- databases and their parts.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include "options.h"
+
+#include <qtextcodec.h>
+#include <kcharsets.h>
+#include <kglobal.h>
+
+#include "pilot.h"
+#include "pilotDatabase.h"
+#include "pilotAppInfo.h"
+#include "pilotRecord.h"
+
+
+namespace Pilot
+{
+static QTextCodec *codec = 0L;
+
+
+QString fromPilot( const char *c, int len )
+{
+	return codec->toUnicode(c,len);
+}
+
+QString fromPilot( const char *c )
+{
+	return codec->toUnicode(c);
+}
+
+QCString toPilot( const QString &s )
+{
+	return codec->fromUnicode(s);
+}
+
+int toPilot( const QString &s, char *buf, int len)
+{
+	// See toPilot() below.
+	memset( buf, 0, len );
+	int used = len;
+	QCString cbuf = codec->fromUnicode(s,used);
+	if (used > len)
+	{
+		used=len;
+	}
+	memcpy( buf, cbuf.data(), used );
+	return used;
+}
+
+int toPilot( const QString &s, unsigned char *buf, int len)
+{
+	// Clear the buffer
+	memset( buf, 0, len );
+
+	// Convert to 8-bit encoding
+	int used = len;
+	QCString cbuf = codec->fromUnicode(s,used);
+
+	// Will it fit in the buffer?
+	if (used > len)
+	{
+		// Ought to be impossible, anyway, since 8-bit encodings
+		// are shorter than the UTF-8 encodings (1 byte per character
+		// vs. 1-or-more byte per character).
+		used=len;
+	}
+
+	// Fill the buffer with encoded data.
+	memcpy( buf, cbuf.data(), used );
+	return used;
+}
+
+bool setupPilotCodec(const QString &s)
+{
+	FUNCTIONSETUP;
+	QString encoding(KGlobal::charsets()->encodingForName(s));
+
+	DEBUGLIBRARY << fname << ": Using codec name " << s << endl;
+	DEBUGLIBRARY << fname << ": Creating codec " << encoding << endl;
+
+	// if the desired codec can't be found, latin1 will be returned anyway, no need to do this manually
+	codec = KGlobal::charsets()->codecForName(encoding);
+
+	if (codec)
+	{
+		DEBUGLIBRARY << fname << ": Got codec " << codec->name() << endl;
+	}
+
+	return codec;
+}
+
+QString codecName()
+{
+	return QString::fromLatin1(codec->name());
+}
+
+QString category(const struct CategoryAppInfo *info, unsigned int i)
+{
+	if (!info || (i>=CATEGORY_COUNT))
+	{
+		return QString::null;
+	}
+
+	return codec->toUnicode(info->name[i],CATEGORY_SIZE-1);
+}
+
+
+int findCategory(const struct CategoryAppInfo *info,
+	const QString &selectedCategory,
+	bool unknownIsUnfiled)
+{
+	FUNCTIONSETUP;
+
+	if (!info)
+	{
+		kdError() << k_funcinfo << "! Bad CategoryAppInfo pointer" << endl;
+		return -1;
+	}
+
+	int currentCatID = -1;
+	for (unsigned int i=0; i<CATEGORY_COUNT; i++)
+	{
+		if (!info->name[i][0]) continue;
+		if (selectedCategory == category(info, i))
+		{
+			currentCatID = i;
+			break;
+		}
+	}
+
+	if (-1 == currentCatID)
+	{
+		DEBUGLIBRARY << fname << ": Category name "
+			<< selectedCategory << " not found." << endl;
+	}
+	else
+	{
+		DEBUGLIBRARY << fname << ": Matched category " << currentCatID << endl;
+	}
+
+	if ((currentCatID == -1) && unknownIsUnfiled)
+		currentCatID = 0;
+	return currentCatID;
+}
+
+int insertCategory(struct CategoryAppInfo *info,
+	const QString &label,
+	bool unknownIsUnfiled)
+{
+	FUNCTIONSETUP;
+
+	if (!info)
+	{
+		kdError() << k_funcinfo << "! Bad CategoryAppInfo pointer" << endl;
+		return -1;
+	}
+
+
+	int c = findCategory(info,label,unknownIsUnfiled);
+	if (c<0)
+	{
+		// This is the case when the category is not known
+		// and unknownIsUnfiled is false.
+		for (unsigned int i=0; i<CATEGORY_COUNT; i++)
+		{
+			if (!info->name[i][0])
+			{
+				c = i;
+				break;
+			}
+		}
+
+		if ((c>0) && (c < (int)CATEGORY_COUNT))
+		{
+			// 0 is always unfiled, can't change that.
+			toPilot(label,info->name[c],CATEGORY_SIZE);
+		}
+		else
+		{
+			kdWarning() << k_funcinfo << "! Category name "
+				<< label
+				<< " could not be added." << endl;
+			c = -1;
+		}
+	}
+
+	return c;
+}
+
+void dumpCategories(const struct CategoryAppInfo *info)
+{
+	FUNCTIONSETUP;
+
+	if (!info)
+	{
+		kdWarning() << "! Dumping bad pointer." << endl;
+		return;
+	}
+
+	DEBUGLIBRARY << fname << " lastUniqueId: "
+		<< (int) info->lastUniqueID << endl;
+	for (unsigned int i = 0; i < CATEGORY_COUNT; i++)
+	{
+		if (!info->name[i][0]) continue;
+		DEBUGLIBRARY << fname << ": " << i << " = "
+			<< (int)(info->ID[i]) << " <"
+			<< info->name[i] << ">" << endl;
+	}
+}
+
+
+}
+
+
Index: kpilot/lib/pilotRecord.h
===================================================================
--- kpilot/lib/pilotRecord.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/lib/pilotRecord.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -34,22 +34,13 @@
 */
 
 
-#include <time.h>
-#include <unistd.h>
-#include <stdio.h>
-#include <kdemacros.h>
-
 #include "pilotLinkVersion.h"
 
-struct pi_buffer_t;
+#include "pilot.h"
 
-#include <pi-dlp.h>
-#include <pi-file.h>
+#include <pi-buffer.h>
 
-#define PILOT_CATEGORY_SIZE 16 // (sizeof(((struct CategoryAppInfo *)0)->name[0]))
-#define PILOT_CATEGORY_MAX 16 // ( (sizeof(((struct CategoryAppInfo *)0)->name)) / PILOT_CATEGORY_SIZE )
 
-
 /** All entries in the Handheld -- whether interpreted or binary blobs --
 * have some common characteristics, viz. an ID number, a category,
 * and some attributes defined by the handheld. PilotRecordBase is
@@ -60,68 +51,158 @@
 {
 public:
 	/** Constructor. Initialize the characteristics to the
-	* given values.
+	*   given values.
+	*
 	* @param attrib Attributes (bitfield) for this entry.
 	* @param cat Category for this entry. Should be in the
-	*        range 0 <= cat < PILOT_CATEGORY_MAX . Using an
+	*        range 0 <= cat < Pilot::CATEGORY_COUNT . Using an
 	*        invalid category means 0 (unfiled) is used.
 	* @param id Unique ID for this entry. May be 0 (non-unique) as well.
 	*/
 	PilotRecordBase(int attrib=0, int cat=0, recordid_t id=0) :
-		fAttrib(attrib),fCat(cat),fID(id) 
-	{ 
-		if ( !( (0<=cat) && (cat<PILOT_CATEGORY_MAX) ) ) fCat=0; 
+		fAttrib(attrib),fCat(0),fID(id)
+	{
+		setCategory(cat);
 	}
 
-	/** Attributes of this record (deleted, secret, ...); it's a bitfield. */
-	inline int attributes() const { return fAttrib; }
+	/** Constructor. Initializes the characteristics from
+	 *  the values the given record @p b has. When @p b is
+	 *  NULL (which is allowed), everything is assumed zero.
+	 *  No ownership is transferred.
+	 *
+	 *  @param b Record to take characteristics from.
+	 */
+	PilotRecordBase( const PilotRecordBase *b ) :
+		fAttrib( b ? b->attributes() : 0 ),
+		fCat( 0 ),
+		fID( b ? b->id() : 0 )
+	{
+		if (b)
+		{
+			setCategory( b->category() );
+		}
+	}
+
+	/** Destructor. Nothing to do for it. */
+	virtual ~PilotRecordBase() { } ;
+
+	/** Attributes of this record (deleted, secret, ...);
+	* it's a bitfield.
+	*/
+	inline int attributes() const 
+	{
+		return fAttrib;
+	}
+
 	/** Set the attributes of this record. */
-	inline void  setAttributes(int attrib) { fAttrib = attrib; }
-	int KDE_DEPRECATED getAttrib() const { return attributes(); }
-	void KDE_DEPRECATED setAttrib(int attrib) { setAttributes(attrib); }
+	inline void  setAttributes(int attrib)
+	{
+		fAttrib = attrib;
+	}
 
-	/** Returns the category number 0 <= < PILOT_CATEGORY_MAX of this record. */
-	int   category() const { return fCat; }
-	/** Sets the category number 0 <= < PILOT_CATEGORY_MAX of this record. 
-	* Trying to set an illegal category number files this one under 
+	/** Returns the category number [ 0 .. Pilot::CATEGORY_COUNT-1]
+	* of this record.
+	*/
+	inline int   category() const
+	{
+		return fCat;
+	}
+
+	/** Sets the category number [ 0 .. Pilot::CATEGORY_COUNT-1]
+	* of this record.
+	* Trying to set an illegal category number files this one under
 	* "Unfiled" (which is 0).
 	*/
-	void  setCategory(int cat) { if ( (cat<0) || (cat>=PILOT_CATEGORY_MAX)) cat=0; fCat = cat; }
-	int  KDE_DEPRECATED  getCat() const { return category(); }
-	void KDE_DEPRECATED  setCat(int cat) { return setCategory(cat); }
+	inline void  setCategory(int cat)
+	{
+		if ( (cat<0) || (cat>=(int)Pilot::CATEGORY_COUNT))
+		{
+			cat=0;
+		}
+		fCat = cat;
+	}
 
+	/** Sets the category number by looking up the string @p label
+	* in the category table @p info . Leaves the category unchanged
+	* if no match is found and returns @c false.
+	*
+	* @param info AppInfo structure containing the labels (in handheld
+	*        native encoding).
+	* @param label The label to look for.
+	*
+	* @return @c true on success, @c false on failure
+	*/
+	bool setCategory(const struct CategoryAppInfo *info, const QString &label)
+	{
+		if (!info)
+		{
+			return false;
+		}
+
+		int cat = Pilot::findCategory( info, label, false );
+		if ( (cat<0) || (cat>=(int)Pilot::CATEGORY_COUNT) )
+		{
+			return false;
+		}
+		else
+		{
+			setCategory( cat );
+			return true;
+		}
+	}
+
 	/** Returns the record ID for this record. Record IDs are unique for a given
 	* handheld and database.
 	*/
-	inline recordid_t id() const { return fID; }
+	inline recordid_t id() const
+	{
+		return fID;
+	}
+
 	/** Sets the record ID for this record. Use with caution -- you ca confuse
 	* the handheld by doing weird things here.
 	*/
-	void setID(recordid_t id) { fID = id; }
-	recordid_t KDE_DEPRECATED getID() const { return id(); }
+	void setID(recordid_t id)
+	{
+		fID = id;
+	}
 
 	/** Accessor for one bit of the record's attributes. Is this record marked
 	* deleted (on the handheld) ? Deleted records are not removed from the
 	* database until a HotSync is done (which normally calls purge deleted
 	* or so to really get rid of the records from storage.
 	*/
-	inline bool isDeleted() const { return fAttrib & dlpRecAttrDeleted; };
+	inline bool isDeleted() const
+	{
+		return fAttrib & dlpRecAttrDeleted;
+	}
+
 	/** Accessor for one bit of the record's attributes. Is this record secret?
 	* Secret records are not displayed on the desktop by default.
 	*/
-	inline bool isSecret() const { return fAttrib & dlpRecAttrSecret; } ;
+	inline bool isSecret() const
+	{
+		return fAttrib & dlpRecAttrSecret;
+	}
+
 	/** Accessor for one bit of the record's attributes. Is this record a
 	* to-be-archived record? When a record is deleted, it may be marked
 	* as "archive on PC" which means the PC should keep a copy. The
 	* PC data correspondng to an archived-but-deleted record must not
 	* be deleted.
 	*/
-	inline bool isArchived() const { return fAttrib & dlpRecAttrArchived; } ;
+	inline bool isArchived() const
+	{
+		return fAttrib & dlpRecAttrArchived;
+	}
+
 	/** Accessor for one bit of the record's attributes. Is this record modified?
 	* Modified records are those that have been modified since the last HotSync.
 	*/
-	inline bool isModified() const { return fAttrib & dlpRecAttrDirty; }
-	inline bool KDE_DEPRECATED isDirty() const { return isModified(); } ;
+	inline bool isModified() const
+	{
+		return fAttrib & dlpRecAttrDirty;
+	}
 
 #define SETTER(a) {\
 		if (d) { fAttrib |= a; } \
@@ -139,11 +220,11 @@
 	/** Mark a record as modified (or not). */
 	inline void setModified(bool d=true) SETTER(dlpRecAttrDirty)
 
-	void KDE_DEPRECATED makeDeleted() { setDeleted(true); }
-	void KDE_DEPRECATED makeSecret() { setSecret(true); }
-	void KDE_DEPRECATED makeArchived() { setArchived(true); }
 #undef SETTER
 
+	/** Returns a text representation of this record. */
+	virtual QString textRepresentation() const;
+
 private:
 	int fAttrib, fCat;
 	recordid_t fID;
@@ -162,9 +243,8 @@
 	*
 	* This constructor makes a copy of the data buffer (and owns that buffer).
 	*/
-	PilotRecord(void* data, int length, int attrib, int cat, recordid_t uid);
+	PilotRecord(void* data, int length, int attrib, int cat, recordid_t uid) KDE_DEPRECATED;
 
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 	/** Constructor. Using the given buffer @p buf (which carries its
 	* own data and length), create a record. Otherwise much like the
 	* above constructor @em except that this record assumes ownership
@@ -176,16 +256,33 @@
 		fData((char *)buf->data),
 		fLen(buf->used),
 		fBuffer(buf)
-	{ fAllocated++; }
-#endif
+	{
+		fAllocated++;
+	}
 
+	/** Constructor. Like the above, only take the attributes, category
+	* and id from the given @p entry.
+	*/
+	PilotRecord( pi_buffer_t *buf, const PilotRecordBase *entry ) :
+		PilotRecordBase( entry ),
+		fData((char *)buf->data),
+		fLen(buf->used),
+		fBuffer(buf)
+	{
+		fAllocated++;
+	}
+
 	/** Destructor. Dispose of the buffers in the right form. */
-	~PilotRecord()
+	virtual ~PilotRecord()
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-		if (fBuffer) { pi_buffer_free(fBuffer); } else
-#endif
-		{ delete [] fData; }
+		if (fBuffer)
+		{
+			pi_buffer_free(fBuffer);
+		}
+		else
+		{
+			delete [] fData;
+		}
 		fDeleted++;
 	}
 
@@ -200,24 +297,23 @@
 	*/
 	char *data() const
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
-		if (fBuffer) return (char *)(fBuffer->data); else
-#endif
-		return fData;
+		if (fBuffer)
+		{
+			return (char *)(fBuffer->data);
+		}
+		else
+		{
+			return fData;
+		}
 	}
-	char *KDE_DEPRECATED getData() const { return data(); }
 
 	/** Returns the size of the data for this record. */
 	int size() const
 	{
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 		if (fBuffer) return fBuffer->used; else
-#endif
 		return fLen;
 	}
-	int KDE_DEPRECATED getLen() const { return size(); }
 
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 	/** Returns the data buffer associated with this record. */
 	const pi_buffer_t *buffer() const { return fBuffer; }
 
@@ -232,26 +328,20 @@
 		fLen = b->used;
 		fBuffer = b;
 	}
-#endif
 
-	/** A constant, really left over from PalmOS 4 days, when records
-	* could be 64k in size at most. It is used in various places to
-	* dimension buffers, but should be considered deprecated.
-	*/
-	enum { APP_BUFFER_SIZE = 0xffff } ;
-
 	/** Assignment operator. Makes a copy of the @p orig record. */
 	PilotRecord& operator=(PilotRecord& orig);
 
 	/** Sets the data for this record. Makes a copy of the data buffer. */
 	void setData(const char* data, int len);
 
+	/** Returns a text representation of this record. */
+	virtual QString textRepresentation() const;
+
 private:
 	char* fData;
 	int   fLen;
-#if PILOT_LINK_NUMBER >= PILOT_LINK_0_12_0
 	pi_buffer_t *fBuffer;
-#endif
 
 public:
 	/**
Index: kpilot/lib/pilot.h
===================================================================
--- kpilot/lib/pilot.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/lib/pilot.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,303 @@
+#ifndef _KPILOT_PILOT_H
+#define _KPILOT_PILOT_H
+/* pilot.h			KPilot
+**
+** Copyright (C) 1998-2001 by Dan Pilone
+** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+** Copyright (C) 2003-2006 Adriaan de Groot <groot@kde.org>
+**
+** These are the base class structures that reside on the
+** handheld device -- databases and their parts.
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+class QTextCodec;
+
+class PilotDatabase;     // A database
+class PilotRecord;       // ... has records
+class PilotCategoryInfo; // ... and category information
+
+#include "pilotLinkVersion.h"
+
+#include <stdio.h>
+
+#include <pi-dlp.h>
+#include <pi-file.h>
+#include <pi-appinfo.h>
+#include <pi-buffer.h>
+
+#include <qstring.h>
+#include <qstringlist.h>
+#include <qvaluelist.h>
+
+/**
+* The Pilot namespace holds constants that are global for
+* the handheld data structures. Also contains some global
+* functions that deal with pilot-link structures as well
+* as mapping user-visible strings from UTF8 (KDE side) to
+* the encoding used on the handheld.
+*/
+
+namespace Pilot
+{
+	/** Maximum size of an AppInfo block, taken roughly from the pilot-link source. */
+	static const int MAX_APPINFO_SIZE=8192;
+
+	/** Maximum number of categories the handheld has */
+	static const unsigned int CATEGORY_COUNT=16;
+
+	/** Maximum size of a category label */
+	static const unsigned int CATEGORY_SIZE=16;
+
+	/** Category number for unfiled records */
+	static const int Unfiled = 0;
+
+	/** Maximum size (in bytes) of a record's data */
+	static const int MAX_RECORD_SIZE = 65535;
+
+	typedef QValueList<recordid_t> RecordIDList;
+
+	/** Static translation function that maps handheld native (8 bit,
+	* usually latin1 but sometimes someting else) encoded data to
+	* a Unicode string. Converts the @p len characters in @p c
+	* to a Unicode string.
+	*/
+	QString fromPilot( const char *c, int len );
+
+	/** Static translation function mapping a NUL-terminated
+	* string from the handheld's encoding to UTF-8.
+	* @param c the NUL-terminated string to decode
+	* @return QString (UTF-8) value of @p c
+	* @note NUL-terminated strings are rare on the handheld.
+	*/
+	QString fromPilot( const char *c );
+
+	/** Static translation function that maps a QString onto the
+	* native 8 bit encoding of the handheld. Writes the result into
+	* the buffer @p buf which has size @p len. Returns the length
+	* of the result. Zero-fills the buffer as needed.
+	*/
+	int toPilot( const QString &s, char *buf, int len);
+	int toPilot( const QString &s, unsigned char *buf, int len);
+
+	/** Static translation function that maps a QString onto the
+	* native 8 bit encoding of the handheld.
+	*
+	* @param s String to encode
+	* @return Encoded string in a QCString
+	*/
+	QCString toPilot( const QString &s );
+
+	/** Create a codec for translating handheld native 8 bit to Unicode,
+	* using the given codec @p name -- this will often be latin1, but
+	* might be something else for, say, Russian-language Pilots.
+	* If @p name is empty, use latin1.
+	*
+	* @return @c true on success, @c false otherwise
+	*/
+	bool setupPilotCodec(const QString &name);
+
+	/** Returns the name of the codec being used. */
+	QString codecName();
+
+	/** For debugging, display category names for the given AppInfo
+	* structure. Called by dump(). You must pass a valid reference.
+	*/
+	void dumpCategories(const struct CategoryAppInfo *info);
+
+	/** Returns the QString for the requested category @p i
+	* in the category structure @p info. Returns @c QString::null
+	* on error (bad pointer or bad category number). May also
+	* return @c QString::null if the category name is empty.
+	*/
+	inline QString categoryName(const struct CategoryAppInfo *info, unsigned int i)
+	{
+		if ( ( i < CATEGORY_COUNT ) && ( info->name[i][0] ) )
+		{
+			return fromPilot( info->name[i], CATEGORY_SIZE );
+		}
+		else
+		{
+			return QString::null;
+		}
+	}
+
+	/** Returns a list of all the category names available on the
+	*  handheld. This list is neither ordered nor does it contain
+	*  all sixteen categories -- empty category names on the
+	*  handheld are skipped.
+	*/
+	inline QStringList categoryNames(const struct CategoryAppInfo *info)
+	{
+		QStringList l;
+		if (!info)
+		{
+			return l;
+		}
+		for (unsigned int i=0; i<CATEGORY_COUNT; ++i)
+		{
+			QString s = categoryName(info,i);
+			if (!s.isEmpty())
+			{
+				l.append(s);
+			}
+		}
+		return l;
+	}
+
+	/** Search for the given category @p name in the list
+	* of categories; returns the category number. If @p unknownIsUnfiled
+	* is true, then map unknown categories to Unfiled instead of returning
+	* an error number.
+	*
+	* @return >=0   is a specific category based on the text-to-
+	*               category number mapping defined by the Pilot,
+	*               where 0 is always the 'unfiled' category.
+	*  @return -1   means unknown category selected when
+	*               @p unknownIsUnfiled is false.
+	*  @return  0   == Unfiled means unknown category selected when
+	*               @p unknownIsUnfiled is true.
+	*
+	*/
+	int findCategory(const struct CategoryAppInfo *info, const QString &name, bool unknownIsUnfiled);
+
+	/** Search for the given category @p name in the list
+	* of categories; returns the category number. If @p unknownIsUnfiled
+	* is @c true, then map unknown categories to Unfiled.
+	* If @p unknownIsUnfiled is @c false, insert a @em new
+	* category into the structure and return the category
+	* number of the new category. Return -1 if (and only if)
+	* @p unknownIsUnfiled is false and the category structure
+	* is already full.
+	*
+	* @return >=0   is a specific category based on the text-to-
+	*               category number mapping defined by the Pilot,
+	*               where 0 is always the 'unfiled' category.
+	* @return 0     Unknown category and @p unknownIsUnfiled is @c true
+	* @return -1    means unknown category selected when
+	*               @p unknownIsUnfiled is false and categories
+	*               are all full.
+	*
+	*/
+	int insertCategory(struct CategoryAppInfo *info, const QString &label, bool unknownIsUnfiled);
+
+	/** The handheld also holds data about each database
+	* in a DBInfo structure; check if the database described
+	* by this structure is a resource database.
+	*/
+	static inline bool isResource(struct DBInfo *info)
+	{
+		return (info->flags & dlpDBFlagResource);
+	}
+}
+
+
+template<typename t> struct dlp { } ;
+template<> struct dlp<short>
+{
+	enum { size = 2 };
+
+	static void append(pi_buffer_t *b, short v)
+	{
+		char buf[size];
+		set_short(buf,v);
+		pi_buffer_append(b,buf,size);
+	}
+
+	static int read(const pi_buffer_t *b, unsigned int &offset)
+	{
+		if ((offset>=b->used) || (offset>=b->allocated))
+		{
+			return -1;
+		}
+		else
+		{
+			int r = get_short(b->data + offset);
+			offset+=size;
+			return r;
+		}
+	}
+
+	static int read(const unsigned char *b, unsigned int &offset)
+	{
+		int r = get_short(b+offset);
+		offset+=size;
+		return r;
+	}
+} ;
+template<> struct dlp<long>
+{
+	enum { size = 4 };
+
+	static void append(pi_buffer_t *b, int v)
+	{
+		char buf[size];
+		set_long(buf,v);
+		pi_buffer_append(b,buf,size);
+	}
+
+	static int read(const pi_buffer_t *b, unsigned int &offset)
+	{
+		if ((offset>=b->used) || (offset>=b->allocated))
+		{
+			return -1;
+		}
+		else
+		{
+			int r = get_long(b->data + offset);
+			offset+=size;
+			return r;
+		}
+	}
+
+	static int read(const unsigned char *b, unsigned int &offset)
+	{
+		int r = get_long(b+offset);
+		offset+=size;
+		return r;
+	}
+} ;
+
+template<> struct dlp<char *>
+{
+	// No size enum, doesn't make sense
+	// No append, use pi_buffer_append
+	static int read(const pi_buffer_t *b, unsigned int &offset, unsigned char *v, size_t s)
+	{
+		if ( s+offset > b->allocated )
+		{
+			s = b->allocated - offset;
+		}
+		memcpy(v, b->data + offset, s);
+		offset+=s;
+		return s;
+	}
+
+	inline static int read(const pi_buffer_t *b, unsigned int &offset, char *v, size_t s)
+	{
+		return read(b,offset,(unsigned char *)v,s);
+	}
+} ;
+
+#endif
+

Zmiany atrybutów dla: kpilot/lib
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile.in
Makefile
   + .deps
.libs
Makefile.in
Makefile
*.moc
kpilotlibSettings.h
kpilotlibSettings.cc


Index: kpilot/Documentation/patch-standalone
===================================================================
--- kpilot/Documentation/patch-standalone	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/Documentation/patch-standalone	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,55 +0,0 @@
-Index: conduits/vcalconduit/Makefile.am
-===================================================================
-RCS file: /home/kde/kdepim/kpilot/conduits/vcalconduit/Makefile.am,v
-retrieving revision 1.51
-diff -u -3 -p -r1.51 Makefile.am
---- conduits/vcalconduit/Makefile.am	9 Jan 2005 18:57:11 -0000	1.51
-+++ conduits/vcalconduit/Makefile.am	23 Apr 2005 20:05:31 -0000
-@@ -21,16 +21,14 @@ libvcalconduit_shared_la_SOURCES = vcalc
- 	vcal-conduitbase.cc
- 
- conduit_vcal_la_SOURCES = vcal-conduit.cc vcal-factory.cc vcal-setup.cc
--conduit_vcal_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
-+conduit_vcal_la_LDFLAGS = -module $(KDE_PLUGIN) -lkcal $(all_libraries)
- conduit_vcal_la_LIBADD = ../../lib/libkpilot.la \
--	../../../libkcal/libkcal.la \
- 	libvcalconduit_shared.la
- conduit_vcal_la_COMPILE_FIRST = vcalconduitSettings.h korganizerConduit.h
- 
- conduit_todo_la_SOURCES = todo-factory.cc todo-setup.cc todo-conduit.cc
--conduit_todo_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
-+conduit_todo_la_LDFLAGS = -module $(KDE_PLUGIN) -lkcal $(all_libraries)
- conduit_todo_la_LIBADD = ../../lib/libkpilot.la \
--	../../../libkcal/libkcal.la \
- 	libvcalconduit_shared.la
- conduit_todo_la_COMPILE_FIRST = vcalconduitSettings.h korganizerConduit.h
- 
-Index: lib/options.h
-===================================================================
-RCS file: /home/kde/kdepim/kpilot/lib/options.h,v
-retrieving revision 1.70
-diff -u -3 -p -r1.70 options.h
---- lib/options.h	10 Apr 2005 23:06:43 -0000	1.70
-+++ lib/options.h	23 Apr 2005 20:05:31 -0000
-@@ -62,7 +62,7 @@
- // of to the KDE debugging facility (it does lose some niftiness then).
- //
- #ifndef DEBUG
--// #define DEBUG			(1)
-+#define DEBUG			(1)
- #endif
- // #define DEBUG_CERR			(1)
- 
-Index: lib/Makefile.am
-===================================================================
---- lib/Makefile.am	(revision 437137)
-+++ lib/Makefile.am	(working copy)
-@@ -25,7 +25,7 @@
- 	recordConduit.cc
- 
- libkpilot_la_LDFLAGS = -no-undefined $(PISOCK_LDFLAGS) $(all_libraries) $(KDE_EXTRA_RPATH) $(KDE_RPATH)
--libkpilot_la_LIBADD = $(LIB_KDEUI) $(PISOCK_LIB) $(LIB_KABC) $(top_builddir)/libkcal/libkcal.la
-+libkpilot_la_LIBADD = $(LIB_KDEUI) $(PISOCK_LIB) $(LIB_KABC) -lkcal
- 
- kpilotincludedir = $(includedir)/kpilot
- kpilotinclude_HEADERS = kpilotlink.h uiDialog.h plugin.h syncAction.h \
Index: kpilot/Documentation/merge-into-svn.sh
===================================================================
--- kpilot/Documentation/merge-into-svn.sh	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/Documentation/merge-into-svn.sh	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,165 @@
+#!/bin/bash
+COPYTO=$1
+
+if [ "x$COPYTO" = "x" ] || [ ! -d "$COPYTO" ]
+then
+  echo "$(basename $0) <directory to merge to>"
+  exit 1
+fi
+
+STARTDIR=$(pwd)
+
+COPYFILES=""
+DELFILES=""
+NEWFILES=""
+
+function isversioned {
+  F=$1
+  svn info $F 2>&1 | grep Checksum > /dev/null
+  rc=$?
+  if [ $rc -eq 0 ]
+  then
+    echo 1
+  else
+    echo 0
+  fi
+}
+
+function checkCopy {
+
+echo "[-] Checking for files that need to be copied to: [$COPYTO]..."
+echo "-----------------------------------------------------"
+
+# first pass is to copy all files we care about from current to destination
+for f in $(find . | egrep -vi \
+"aap|build-|\.svn|\.libs|Makefile$|Makefile.in|~$|\.la$")
+do
+if [ -f $f ]; then
+  F=$(printf "%-60s\n" $f)
+  C=$(sum -r $f)
+  O=$(sum -r $COPYTO/$f 2>/dev/null)
+  if [ "$C" = "$O" ] ; then
+    S="SAME"
+  elif [ ! -f $COPYTO/$f ]; then
+    S="NEW"
+  else
+    S="DIFF"
+  fi
+
+  if [ "$S" != "SAME" ]; then
+    echo "file: [$F], status: [$S]"
+    if [ "$S" = "DIFF" ]; then
+      COPY="y"
+    elif [ "$S" = "NEW" ] ; then
+      V=$(isversioned $f)
+      if [ "$V" -eq 0 ]; then
+        echo " - new file, but not versioned, so ignoring."
+	COPY="n"
+      elif [ "$V" -eq 1 ]; then
+        echo -n " - new file.  versioned. copy this one? (Y/N) -> "
+        read ANS
+        ANS=$(echo $ANS | tr '[A-Z]' '[a-z]')
+        if [ "$ANS" = "y" ]; then
+          COPY="y"
+	  NEWFILES="$NEWFILES $f"
+        else
+          COPY="n"
+        fi
+      fi
+    fi
+    if [ "$COPY" = "y" ]; then
+      echo "  - copying this file..."
+      COPYFILES="$COPYFILES $f"
+    else 
+      echo "  - not copying it..."
+    fi
+  fi
+fi
+done
+}
+
+function checkDelete {
+
+echo "[-] Checking for files that should be deleted from: [$COPYTO] ..."
+echo "-----------------------------------------------------"
+
+# now see if there's anything that was in dest, but is not in new and
+# remove it
+cd $COPYTO
+for f in $(find . | egrep -vi \
+"aap|build|.svn|.libs|Makefile|~$|lib/pilot-link|.la$|.deps|.moc$|.lo$|\.o$")
+do
+if [ -f $f ]; then
+  F=$(printf "%-60s\n" $f)
+  if [ ! -f $STARTDIR/$f ] ; then
+    V=$(isversioned $f)
+    if [ "$V" -eq 1 ]; then
+      echo -n " - file: [$F] looks like it's been deleted. should I remove it?  (Y/N) -> "
+      read ANS
+      ANS=$(echo $ANS | tr '[A-Z]' '[a-z]')
+      if [ "$ANS" = "y" ]; then
+        echo "  - okay, I'll remove this one..."
+        DELFILES="$DELFILES $f"
+      fi
+    fi
+  fi
+fi
+done
+}
+
+checkCopy
+checkDelete
+
+cd "$STARTDIR"
+
+echo "okay, here are the files that I'll copy:"
+for f in $(echo $COPYFILES)
+do
+  echo " - $f"
+done
+
+echo "and here are the files that I'll do an svn remove on:"
+for f in $(echo $DELFILES)
+do
+  echo " - $f"
+done
+
+echo "and here are the files that I'll do an svn add on:"
+for f in $(echo $NEWFILES)
+do
+  echo " - $f"
+done
+
+echo -n "Okay to proceed? (y/n) -> "
+read ANS
+ANS=$(echo $ANS | tr '[A-Z]' '[a-z]')
+if [ "$ANS" != "y" ]; then
+  echo "  - okay, stopping."
+  exit
+fi
+
+cd "$STARTDIR"
+
+echo "okay, copying..."
+for f in $(echo $COPYFILES)
+do
+  cp --parents -v "$f" "$COPYTO"
+done
+
+cd "$COPYTO"
+
+echo "doing svn remove..."
+for f in $(echo $DELFILES)
+do
+  echo " - $f"
+  svn remove "$f"
+done
+
+cd "$COPYTO"
+
+echo "doing svn add..."
+for f in $(echo $NEWFILES)
+do
+  echo " - $f"
+  svn add "$f"
+done

Zmiany atrybutów dla: kpilot/Documentation/merge-into-svn.sh
___________________________________________________________________
Nazwa: svn:executable
   + *

Index: kpilot/Documentation/HOWTO-CODE.txt
===================================================================
--- kpilot/Documentation/HOWTO-CODE.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/Documentation/HOWTO-CODE.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 C++ Source Code
 ===============
 
-There are coding guidelines for KDE somewhere. I think they say 
+There are coding guidelines for KDE somewhere. I think they say
 indent with 4 spaces, { on same line, } on separate line. I disagree,
 so code I write -- and code I maintain -- slowly mutates to
 
@@ -27,7 +27,7 @@
 Whether or not anyone else follows is irrelevant, and I do try to
 avoid gratuitous reformatting. Honest.
 
-What I might do every now and then to get stuff "into shape" (and 
+What I might do every now and then to get stuff "into shape" (and
 I'd really appreciate it if you did so too before sending me patches)
 is the following horrible invocation of indent:
 
@@ -72,17 +72,41 @@
 because the filename and the class don't always match up and not
 every file contains a class of interest.
 
-[I'm going to try to wrap all the #includes with the right #ifndef
-to reduce the number of includes (for the preprocessor) and speed
-up compilation just a little bit.] -- This paragraph has become 
-irrelevant since I found out that sensible C compilers (ie. gcc)
-have support to handle multiple inclusion efficiently, without even
-opening a header file more than once. It *does* mean that the #ifndef
-needs to move to the top of the .h file, but that's no real problem.
 
+DEBUG Output
+============
 
+There are macros defined in options.h (which every source file
+should include) that provide some uniform debugging output.
+These are:
 
+	* FUNCTIONSETUP - Use this at the beginning of every function
+	  (or those that are vaguely interesting). This will print out
+	  a call trace indicator when debugging is on. It also defines
+	  a local symbol fname for use with DEBUG* below.
+	* FUNCTIONSETUPL(level) - Use this at the beginning of a function.
+	  It is like FUNCTIONSETUP but only prints if the debug level
+	  is at least @p level. This avoids excessive debug output from
+	  common functions.
 
+For regular debugging output, use one of the three DEBUG* macros:
+
+	* DEBUGLIBRARY in code in lib/
+	* DEBUGKPILOT in code in kpilot/
+	* DEBUGCONDUIT in code in conduits/
+
+This sends the debug output to the appropriate debug area. A typical
+debug output stream looks like this:
+
+	DEBUGKPILOT << fname << ": "
+		<< actual debug info
+		<< endl;
+
+Here, DEBUGKPILOT depends on what bit of code is being debugged; fname
+is defined by FUNCTIONSETUP and takes care of proper indentation for
+the call trace, the colon is for consistency and the actual debug
+info can be whatever you want.
+
 	Adriaan de Groot
 	March 5th 2001
 	September 5th 2001 (revised)
Index: kpilot/Documentation/ConduitProgrammingTutorial/index.tex
===================================================================
--- kpilot/Documentation/ConduitProgrammingTutorial/index.tex	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/Documentation/ConduitProgrammingTutorial/index.tex	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -742,7 +742,7 @@
 \item\code{virtual int resetDBIndex()} ... Resets next record index to beginning
 \item\code{virtual int cleanup()} ... Purges all Archived/Deleted records 
 from Palm Pilot database
-\item\code{bool isDBOpen()} ... Returns false if the database could not be 
+\item\code{bool isOpen()} ... Returns false if the database could not be 
 opened, e.g. no connection to the handheld or file could not be created.
 \item\code{virtual QString dbPathName()} ... Returns some sensible human-readable 
 identifier for the database. Serial databases get Pilot:, local databases 
@@ -1322,14 +1322,14 @@
   // instance which points either to a local database or a database on the handheld.
   PilotDatabase *database = preSyncAction(sinfo);
 
-  if (database && ( !database->isDBOpen() ) ) {
+  if (database && ( !database->isOpen() ) ) {
     DEBUGCONDUIT<<"Database "<<sinfo.dbinfo.name<<" does not yet exist. Creating it:"<<endl;
     if (!database->createDatabase(dbcreator(), dbtype()) ) {
       DEBUGCONDUIT<<"Failed"<<endl;
     }
   }
 
-  if (database && database->isDBOpen()) {
+  if (database && database->isOpen()) {
     DOCConverter docconverter;
     connect(&docconverter, SIGNAL(logError(const QString &)), SIGNAL(logError(const QString &)));
     connect(&docconverter, SIGNAL(logMessage(const QString &)), SIGNAL(logMessage(const QString &)));
@@ -1424,7 +1424,7 @@
 
     if (QFile::exists(sinfo.docfilename)) sinfo.fPCStatus=eStatNew;
     else sinfo.fPCStatus=eStatDoesntExist;
-    if (docdb && docdb->isDBOpen()) sinfo.fPalmStatus=eStatNew;
+    if (docdb && docdb->isOpen()) sinfo.fPalmStatus=eStatNew;
     else sinfo.fPalmStatus=eStatDoesntExist;
     KPILOT_DELETE(docdb);
     
@@ -1452,7 +1452,7 @@
   } else {
     DEBUGCONDUIT<<"PC side has NOT changed!"<<endl;
   }
-  if (!docdb || !docdb->isDBOpen()) sinfo.fPalmStatus=eStatDeleted;
+  if (!docdb || !docdb->isOpen()) sinfo.fPalmStatus=eStatDeleted;
   else {
     PilotRecord *firstRec = docdb->readRecordByIndex(0);
     PilotDOCHead docHeader(firstRec);
Index: kpilot/Documentation/UML/vcal-classdiagram.xmi.tgz
===================================================================
Nie można wyświetlić: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybutów dla: kpilot/Documentation/UML/vcal-classdiagram.xmi.tgz
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kpilot/configure.in.bot
===================================================================
--- kpilot/configure.in.bot	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/configure.in.bot	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,14 +1,16 @@
 if test "$HAVE_PISOCK" = "0" ; then
 	echo ""
-	echo "You're missing the pisock library for kpilot."
+	echo "You're missing a compatible version of pilot-link for kpilot."
 	echo ""
 	all_tests=bad
 else
 	if test "x$HAVE_BAD_PISOCK" = "xYES" ; then
 		echo ""
-		echo "You have a version of pilot-link < 0.11.8."
-		echo "This version is deprecated and KPilot will soon stop"
-		echo "working with it."
+		echo "You have a version of pilot-link < 0.12.0."
+		echo "This version is old and is known to cause problems"
+		echo "with KPilot.  Please compile KPilot with "
+		echo "pilot-link version 0.12.0 or greater."
 		echo ""
+		all_tests=bad
 	fi
 fi
Index: kpilot/config.h.cmake
===================================================================
--- kpilot/config.h.cmake	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/config.h.cmake	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,43 @@
+#cmakedefine HAVE_STDINT_H
+#cmakedefine HAVE_ALLOCA_H
+#cmakedefine HAVE_SYS_TIME_H
+#cmakedefine HAVE_SYS_STAT_H
+#cmakedefine HAVE_CFSETSPEED
+#cmakedefine HAVE_STRDUP
+#cmakedefine HAVE_SETENV
+#cmakedefine HAVE_UNSETENV
+#cmakedefine HAVE_USLEEP
+#cmakedefine HAVE_RANDOM
+#cmakedefine HAVE_PUTENV
+#cmakedefine HAVE_SETEUID
+#cmakedefine HAVE_MKSTEMPS
+#cmakedefine HAVE_MKSTEMP
+#cmakedefine HAVE_MKDTEMP
+#cmakedefine HAVE_REVOKE
+#cmakedefine HAVE_STRLCPY
+#cmakedefine HAVE_STRLCAT
+#cmakedefine HAVE_INET_ATON
+
+#if !defined(HAVE_STRLCAT)
+#ifdef __cplusplus
+extern "C" {
+#endif
+unsigned long strlcat(char*, const char*, unsigned long);
+#ifdef __cplusplus
+}
+#endif
+#endif
+
+
+
+#if !defined(HAVE_STRLCPY)
+#ifdef __cplusplus
+extern "C" {
+#endif
+unsigned long strlcpy(char*, const char*, unsigned long);
+#ifdef __cplusplus
+}
+#endif
+#endif
+
+
Index: kpilot/NEWS
===================================================================
--- kpilot/NEWS	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kpilot/NEWS	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -3,6 +3,8 @@
 ChangeLog or the README files. There is also the
 history page on www.kpilot.org.
 
+* November 18, 2006: KDE 3.5.5 is getting KPilot backported
+  to it, and KPilot itself now uses CMake as its buildsystem.
 * November 4, 2004: KDE 3.3.1 contains KPilot 4.4.5; there is
   a 4.4.6 available from the website, but it is of dubious
   quality.
Index: kpilot/CMakeLists.txt
===================================================================
--- kpilot/CMakeLists.txt	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ kpilot/CMakeLists.txt	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,88 @@
+project(kpilot)
+
+
+# Search our own cmake modules path first
+set(CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake/modules")
+
+# Need 2.4.3 for its KDE3 support
+cmake_minimum_required(VERSION 2.4.3)
+
+CONFIGURE_FILE(
+  "${CMAKE_CURRENT_SOURCE_DIR}/cmake_uninstall.cmake.in"
+  "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake"
+  IMMEDIATE @ONLY)
+
+ADD_CUSTOM_TARGET(uninstall
+  "${CMAKE_COMMAND}" -P "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake")
+
+# Disallow in-source build
+STRING(COMPARE EQUAL "${kpilot_SOURCE_DIR}" "${kpilot_BINARY_DIR}" insource)
+if(insource)
+	MESSAGE(FATAL_ERROR 
+		"KPilot requires an out of source build. Please create a separate build
+directory and run 'cmake path_to_kpilot [options]' there."
+	)
+endif(insource)
+
+find_package(Qt3 REQUIRED) # find and setup Qt3 for this project
+find_package(KDE3 REQUIRED) # find and setup KDE3 for this project
+find_package(Pilotlink REQUIRED)
+find_package(Mal) # see if mal is available, but it's not required
+
+add_definitions(
+	${QT_DEFINITIONS}
+	${KDE3_DEFINITIONS}
+	-DQT_THREAD_SUPPORT
+)
+
+STRING(COMPARE EQUAL "${CMAKE_BUILD_TYPE}" "debug" builddebug)
+if (builddebug)
+	# Debug build, additional flags
+	add_definitions(-DDEBUG -DDEBUG_CERR)
+endif(builddebug)
+
+
+# Get the kde3 dir. This is a bit tricky, i'm not sure how well
+# this works on other systems.
+STRING(REPLACE "/lib" "" KDE3_DIR ${KDE3_LIB_DIR})
+
+# TODO: INSTALL PREFIX. RIGHT NOW EVERYTHING IS INSTALLED IN $KDEDIR
+if(NOT CMAKE_INSTALL_PREFIX)
+	set(CMAKE_INSTALL_PREFIX ${KDE3_DIR})
+endif(NOT CMAKE_INSTALL_PREFIX)
+set(KDE3_KCFG_DIR ${CMAKE_INSTALL_PREFIX}/share/config.kcfg)
+set(KDE3_SERVICETYPES_DIR ${CMAKE_INSTALL_PREFIX}/share/servicetypes)
+set(KDE3_SERVICES_DIR ${CMAKE_INSTALL_PREFIX}/share/services)
+set(KDE3_XDG_APPS_DIR ${CMAKE_INSTALL_PREFIX}/share/applications/kde)
+set(KDE3_LIB_INSTALL_DIR ${CMAKE_INSTALL_PREFIX}/lib)
+set(KDE3_PLUGIN_INSTALL_DIR ${KDE3_LIB_INSTALL_DIR}/kde3)
+
+# tell cmake where to search for libraries:
+link_directories(${KDE3_LIB_DIR})
+
+# tell cmake where to search for Qt/KDE headers:
+include_directories(${PILOTLINK_INCLUDE_DIR} ${KDE3_INCLUDE_DIR} ${QT_INCLUDE_DIR})
+
+# include custom macros
+INCLUDE(${CMAKE_SOURCE_DIR}/cmake/modules/KPilotCustom.cmake)
+
+# tell cmake to process CMakeLists.txt in that subdirectory
+add_subdirectory(lib)
+add_subdirectory(kpilot)
+add_subdirectory(conduits)
+
+
+STRING(COMPARE EQUAL "${ENABLE_TESTS}" "YES" buildtests)
+if (buildtests)
+	MESSAGE(STATUS "BUILD: Test suite enabled.")
+	enable_testing()
+	add_subdirectory(tests)
+endif(buildtests)
+
+if (builddebug)
+	MESSAGE(STATUS "BUILD: Debug build selected.")
+else(builddebug)
+	MESSAGE(STATUS "BUILD: Normal build selected.")
+endif(builddebug)
+
+

Zmiany atrybutów dla: kpilot
___________________________________________________________________
Nazwa: svn:ignore
   - Makefile
Makefile.in
   + Makefile
Makefile.in
CMakeOptions.txt
build-*
build


Index: knotes/knote.cpp
===================================================================
--- knotes/knote.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knotes/knote.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -167,29 +167,32 @@
     KXMLGUIFactory factory( &builder, this );
     factory.addClient( this );
 
-    m_menu = static_cast<KPopupMenu*>(factory.container( "note_context", this ));
-    m_edit_menu = static_cast<KPopupMenu*>(factory.container( "note_edit", this ));
-    m_tool = static_cast<KToolBar*>(factory.container( "note_tool", this ));
-    m_tool->setIconSize( 10 );
-    m_tool->setFixedHeight( 16 );
-    m_tool->setIconText( KToolBar::IconOnly );
+    m_menu = dynamic_cast<KPopupMenu*>(factory.container( "note_context", this ));
+    m_edit_menu = dynamic_cast<KPopupMenu*>(factory.container( "note_edit", this ));
+    m_tool = dynamic_cast<KToolBar*>(factory.container( "note_tool", this ));
 
-    // if there was just a way of making KComboBox adhere the toolbar height...
-    QObjectList *list = m_tool->queryList( "KComboBox" );
-    QObjectListIt it( *list );
-    while ( it.current() != 0 )
-    {
-        KComboBox *combo = (KComboBox *)it.current();
-        QFont font = combo->font();
-        font.setPointSize( 7 );
-        combo->setFont( font );
-        combo->setFixedHeight( 14 );
-        ++it;
+    if ( m_tool ) {
+      m_tool->setIconSize( 10 );
+      m_tool->setFixedHeight( 16 );
+      m_tool->setIconText( KToolBar::IconOnly );
+
+      // if there was just a way of making KComboBox adhere the toolbar height...
+      QObjectList *list = m_tool->queryList( "KComboBox" );
+      QObjectListIt it( *list );
+      while ( it.current() != 0 )
+      {
+          KComboBox *combo = (KComboBox *)it.current();
+          QFont font = combo->font();
+          font.setPointSize( 7 );
+          combo->setFont( font );
+          combo->setFixedHeight( 14 );
+          ++it;
+      }
+      delete list;
+
+      m_tool->hide();
     }
-    delete list;
 
-    m_tool->hide();
-
     setFocusProxy( m_editor );
 
     // create the resize handle
@@ -413,7 +416,10 @@
 void KNote::saveConfig() const
 {
     m_config->setWidth( width() );
-    m_config->setHeight( height() - (m_tool->isHidden() ? 0 : m_tool->height()) );
+    if ( m_tool )
+      m_config->setHeight( height() - (m_tool->isHidden() ? 0 : m_tool->height()) );
+    else
+      m_config->setHeight( 0 );
     m_config->setPosition( pos() );
 
     NETWinInfo wm_client( qt_xdisplay(), winId(), qt_xrootwin(), NET::WMDesktop );
@@ -1033,13 +1039,13 @@
 
         if ( !m_editor->isReadOnly() )
         {
-            if ( m_tool->isHidden() && m_editor->textFormat() == QTextEdit::RichText )
+            if ( m_tool && m_tool->isHidden() && m_editor->textFormat() == QTextEdit::RichText )
             {
                 m_tool->show();
                 setGeometry( x(), y(), width(), height() + m_tool->height() );
             }
         }
-        else if ( !m_tool->isHidden() )
+        else if ( m_tool && !m_tool->isHidden() )
         {
             m_tool->hide();
             setGeometry( x(), y(), width(), height() - m_tool->height() );
@@ -1053,7 +1059,7 @@
         m_button->hide();
         m_editor->cornerWidget()->hide();
 
-        if ( !m_tool->isHidden() )
+        if ( m_tool && !m_tool->isHidden() )
         {
             m_tool->hide();
             setGeometry( x(), y(), width(), height() - m_tool->height() );
@@ -1189,22 +1195,24 @@
         QPoint( contentsRect().x(),
                 contentsRect().y() + headerHeight + s_ppOffset ),
         QPoint( contentsRect().right(),
-                contentsRect().bottom() - (m_tool->isHidden() ? 0 : m_tool->height()) )
+                contentsRect().bottom() - ( m_tool ? (m_tool->isHidden() ? 0 : m_tool->height()) : 0 ) )
     ) );
 
-    m_tool->setGeometry(
-        contentsRect().x(),
-        contentsRect().bottom() - m_tool->height() + 1,
-        contentsRect().width(),
-        m_tool->height()
-    );
+    if( m_tool ) {
+      m_tool->setGeometry(
+          contentsRect().x(),
+          contentsRect().bottom() - m_tool->height() + 1,
+          contentsRect().width(),
+          m_tool->height()
+      );
+    }
 
     if ( s_ppOffset )
         m_fold->move( width() - 15, height() - 15 );
 
     setMinimumSize(
         m_editor->cornerWidget()->width() + margin*2,
-        headerHeight + s_ppOffset + (m_tool->isHidden() ? 0 : m_tool->height()) +
+        headerHeight + s_ppOffset + ( m_tool ? (m_tool->isHidden() ? 0 : m_tool->height() ) : 0 ) +
                 m_editor->cornerWidget()->height() + margin*2
     );
 
Index: knotes/local.desktop
===================================================================
--- knotes/local.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knotes/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 Name[es]=Avisos sobre el archivo local
 Name[et]=Märkmed kohalikus failis
 Name[eu]=Oharrak fitxategi lokalean
-Name[fa]=یادداشتها در پروندۀ محلی‌
+Name[fa]=یادداشتها در پروندۀ محلی
 Name[fi]=Muistiot paikallisessa tiedostossa
 Name[fr]=Notes dans un fichier local
 Name[ga]=Nótaí i gComhad Logánta
Index: knotes/knotes.desktop
===================================================================
--- knotes/knotes.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ knotes/knotes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -8,7 +8,6 @@
 
 GenericName=Popup Notes
 GenericName[af]=Opspring Notas
-GenericName[ar]=ملاحظات قافزة
 GenericName[bg]=Лепящи се бележки
 GenericName[bs]=Popup bilješke
 GenericName[ca]=Notes emergents
@@ -66,7 +65,6 @@
 
 Name=KNotes
 Name[af]=Knotas
-Name[ar]=كنوتس
 Name[be]=K Нататкі
 Name[cy]=KNodiadau
 Name[eo]=Notoj
Index: kontact/plugins/test/kptestplugin.desktop
===================================================================
--- kontact/plugins/test/kptestplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/test/kptestplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkptestplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 
 X-KDE-PluginInfo-Name=kptestplugin
 X-KDE-PluginInfo-Version=0.1
Index: kontact/plugins/akregator/akregator_plugin.h
===================================================================
--- kontact/plugins/akregator/akregator_plugin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/akregator/akregator_plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -64,6 +64,8 @@
     virtual QStringList configModules() const;
     virtual QStringList invisibleToolbarActions() const;
     virtual bool isRunningStandalone();
+    virtual void readProperties( KConfig *config );
+    virtual void saveProperties( KConfig *config );
 
   private slots:
     void showPart();
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_akregator
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libakregatorpart
 X-KDE-KontactPartLoadOnStart=false
 
@@ -28,6 +28,7 @@
 Comment[fi]=Akregator-liitännäinen
 Comment[fr]=Module pour Akregator
 Comment[ga]=Breiseán Akregator
+Comment[gl]=Extensión para Akregator
 Comment[he]=תוסף עבור Akregator
 Comment[hu]=Akregator bővítőmodul
 Comment[is]=Akregator íforrit
@@ -65,10 +66,11 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
+Name[gl]=Fontes
 Name[he]=ערוצים
 Name[hu]=Hírforrások
 Name[is]=Fréttastraumar
Index: kontact/plugins/akregator/akregatorplugin3.2.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,6 +27,7 @@
 Comment[fi]=Akregator-liitännäinen
 Comment[fr]=Module pour Akregator
 Comment[ga]=Breiseán Akregator
+Comment[gl]=Extensión para Akregator
 Comment[he]=תוסף עבור Akregator
 Comment[hu]=Akregator bővítőmodul
 Comment[is]=Akregator íforrit
@@ -64,10 +65,11 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
+Name[gl]=Fontes
 Name[he]=ערוצים
 Name[hu]=Hírforrások
 Name[is]=Fréttastraumar
Index: kontact/plugins/akregator/akregator_plugin.cpp
===================================================================
--- kontact/plugins/akregator/akregator_plugin.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/akregator/akregator_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,6 +40,7 @@
 #include <plugin.h>
 
 #include <akregator_options.h>
+#include <akregator_part.h>
 #include "akregator_plugin.h"
 namespace Akregator {
 
@@ -114,6 +115,22 @@
     return modules;
 }
 
+void Plugin::readProperties( KConfig *config )
+{
+    if ( part() ) {
+        Akregator::Part *myPart = static_cast<Akregator::Part*>( part() );    
+        myPart->readProperties( config );
+    }
+}
+
+void Plugin::saveProperties( KConfig *config )
+{
+    if ( part() ) {
+        Akregator::Part *myPart = static_cast<Akregator::Part*>( part() );    
+        myPart->saveProperties( config );
+    }
+}
+
 void UniqueAppHandler::loadCommandLineOptions()
 {
     KCmdLineArgs::addCmdLineOptions( akregator_options );
Index: kontact/plugins/kitchensync/kitchensync.desktop
===================================================================
--- kontact/plugins/kitchensync/kitchensync.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/kitchensync/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kitchensync
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkitchensyncpart
 
 X-KDE-PluginInfo-Name=kontact_kitchensync
@@ -60,7 +60,7 @@
 Comment[zh_CN]=KitchenSync 插件
 Comment[zh_TW]=KitchenSync 外掛程式
 Name=Synchronization
-Name[ar]=تزامن
+Name[ar]=التزامن
 Name[be]=Сынхранізацыя
 Name[bs]=Sinhronizacija
 Name[ca]=Sincronització
Index: kontact/plugins/karm/karmplugin.desktop
===================================================================
--- kontact/plugins/karm/karmplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/karm/karmplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_karm
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkarmpart
 
 X-KDE-PluginInfo-Name=kontact_karm
@@ -28,6 +28,7 @@
 Comment[fi]=KArm-liitännäinen
 Comment[fr]=Module pour KArm
 Comment[ga]=Breiseán KArm
+Comment[gl]=Extensión para KArm
 Comment[hu]=KArm bővítőmodul
 Comment[is]=KArm íforrit
 Comment[it]=Plugin KArm
@@ -56,7 +57,6 @@
 
 Name=KArm
 Name[af]=Karm
-Name[ar]=كارم
 Name[eo]=Tempomezurilo
 Name[hi]=के-आर्म
 Name[mk]=КРака
Index: kontact/plugins/summary/kcmkontactsummary.desktop
===================================================================
--- kontact/plugins/summary/kcmkontactsummary.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/summary/kcmkontactsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -21,10 +21,11 @@
 Name[el]=Στοιχεία
 Name[et]=Komponendid
 Name[eu]=Osagaiak
-Name[fa]=محتواها
+Name[fa]=محتویات
 Name[fi]=Komponentit
 Name[fr]=Composants
 Name[ga]=Comhpháirteanna
+Name[gl]=Compoñentes
 Name[he]=רכיבים
 Name[hu]=Komponensek
 Name[is]=Einingar
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_summaryplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 
 X-KDE-PluginInfo-Name=kontact_summaryplugin
 X-KDE-PluginInfo-Version=0.1
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kmailplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkmailpart
 X-KDE-KontactPartExecutableName=kmail
 X-KDE-KontactPartLoadOnStart=true
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -7,7 +7,7 @@
 
 X-KDE-Library=libkontact_weatherplugin
 X-KDE-KontactIdentifier=weather
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
@@ -29,7 +29,7 @@
 Comment[es]=Extensión de meteorología para Kontact
 Comment[et]=Kontacti ilmaplugin
 Comment[eu]=Kontact-en eguraldi plugin-a
-Comment[fa]=وصلۀ آب و هوای Kontact 
+Comment[fa]=وصلۀ آب و هوای Kontact
 Comment[fi]=Kontactin sääliitännäinen
 Comment[fr]=Module météo pour Kontact
 Comment[gl]=Extensión de clima para Kontact
@@ -78,6 +78,7 @@
 Name[fi]=Sääpalvelu
 Name[fr]=KWeatherService
 Name[ga]=Seirbhís Aimsire
+Name[gl]=Servicio do Tempo
 Name[he]=שירות מזג אוויר
 Name[hu]=Időjárás
 Name[is]=Veðurþjónusta
Index: kontact/plugins/multisynk/multisynk.desktop
===================================================================
--- kontact/plugins/multisynk/multisynk.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/multisynk/multisynk.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_multisynk
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libmultisynkpart
 
 X-KDE-PluginInfo-Name=kontact_multisynk
@@ -27,6 +27,7 @@
 Comment[fi]=MultiSynk-liitännäinen
 Comment[fr]=Module MultiSynk
 Comment[ga]=Breiseán MultiSynk
+Comment[gl]=Extensión MultiSynk
 Comment[hu]=MultiSynk bővítőmodul
 Comment[is]=MultiSynk íforrit
 Comment[it]=Plugin MultiSync
@@ -54,7 +55,7 @@
 Comment[zh_CN]=MultiSynk 插件
 Comment[zh_TW]=MultiSynk 外掛程式
 Name=Synchronization
-Name[ar]=تزامن
+Name[ar]=التزامن
 Name[be]=Сынхранізацыя
 Name[bs]=Sinhronizacija
 Name[ca]=Sincronització
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knodeplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libknodepart
 X-KDE-KontactPartExecutableName=knode
 
Index: kontact/plugins/specialdates/kcmsdsummary.desktop
===================================================================
--- kontact/plugins/specialdates/kcmsdsummary.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/specialdates/kcmsdsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -25,6 +25,7 @@
 Name[fi]=Erikoispäivät
 Name[fr]=Dates particulières
 Name[ga]=Dátaí Speisialta
+Name[gl]=Datas Especiais
 Name[he]=תאריכים מיוחדים
 Name[hu]=Fontos dátumok
 Name[is]=Sérstakir dagar
@@ -65,6 +66,7 @@
 Comment[fa]=برپایی خلاصۀ تاریخهای ویژه
 Comment[fi]=Erikoispäivien yhteenvedon asetukset
 Comment[fr]=Configuration du résumé des dates particulières
+Comment[gl]=Configuración do Resumo de Datas Especiais
 Comment[he]=תצורת תאריכים מיוחדים
 Comment[hu]=A fontos dátumok áttekintőjének beállításai
 Comment[is]=Yfirlitsuppsetning sérstakra daga
@@ -104,6 +106,7 @@
 Keywords[fa]=تولد، جشن سالانه، تعطیلات، پیکربندی، تنظیمات
 Keywords[fi]=syntymäpäivä, juhlapäivä, loma, aseta, asetukset
 Keywords[fr]=anniversaire,date de naissance,vacances,configurer,paramètres,préférences
+Keywords[gl]=cumpreanos, aniversario, vacacións, configurar, opcións
 Keywords[he]=birthday, anniversary, holiday, configure, settings, יום הולדת, הולדת, שנה, יום שנה, חג, חגים, תצורה, הגדרות
 Keywords[hu]=születésnap,évforduló,szabadság,konfigurálás,beállítások
 Keywords[is]=afmæli, frídagar, stillingar, stilla
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_specialdatesplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasPart=false
 X-KDE-KontactPluginHasSummary=true
 
@@ -28,6 +28,7 @@
 Name[fi]=Erikoispäivät
 Name[fr]=Dates particulières
 Name[ga]=Dátaí Speisialta
+Name[gl]=Datas Especiais
 Name[he]=תאריכים מיוחדים
 Name[hu]=Fontos dátumok
 Name[is]=Sérstakir dagar
@@ -68,6 +69,7 @@
 Comment[fa]=وصلۀ تاریخهای ویژه
 Comment[fi]=Kalenteriliitännäinen
 Comment[fr]=Module de dates particulières
+Comment[gl]=Extensión de Datas Especiais
 Comment[he]=תוסף תאריכים חשובים
 Comment[hu]=Fontos dátumok bővítőmodul
 Comment[is]=Sérstakir dagar íforrit
Index: kontact/plugins/kpilot/kpilotplugin.desktop
===================================================================
--- kontact/plugins/kpilot/kpilotplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/kpilot/kpilotplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -6,7 +6,7 @@
 
 X-KDE-Library=libkontact_kpilotplugin
 X-KDE-KontactIdentifier=kpilot
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knotesplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 
 X-KDE-PluginInfo-Website=http://pim.kde.org/components/knotes.php
Index: kontact/plugins/korganizer/summarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/summarywidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -21,20 +21,23 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include <qcursor.h>
 #include <qlabel.h>
 #include <qlayout.h>
+#include <qtooltip.h>
 
 #include <kdialog.h>
 #include <kglobal.h>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kparts/part.h>
+#include <kpopupmenu.h>
 #include <kstandarddirs.h>
 #include <kurllabel.h>
-#include <qtooltip.h>
 #include <libkcal/event.h>
 #include <libkcal/resourcecalendar.h>
 #include <libkcal/resourcelocal.h>
+#include <libkcal/incidenceformatter.h>
 #include <libkdepim/kpimprefs.h>
 
 #include "korganizeriface_stub.h"
@@ -97,20 +100,26 @@
   for ( dt=currentDate;
         dt<=currentDate.addDays( days - 1 );
         dt=dt.addDays(1) ) {
-    KCal::Event::List events = mCalendar->events( dt );
 
     KCal::Event *ev;
-    KCal::Event::List::ConstIterator it;
+
+    KCal::Event::List events_orig = mCalendar->events( dt );
+    KCal::Event::List::ConstIterator it = events_orig.begin();
+
+    KCal::Event::List events;
+    events.setAutoDelete( true );
     QDateTime qdt;
 
-    // Find recurring events, replacing the QDate with the currentDate
-    for ( it=events.begin(); it!=events.end(); ++it ) {
-      ev = *it;
+    // prevent implicitely sharing while finding recurring events
+    // replacing the QDate with the currentDate
+    for ( ; it != events_orig.end(); ++it ) {
+      ev = (*it)->clone();
       if ( ev->recursOn( dt ) ) {
         qdt = ev->dtStart();
         qdt.setDate( dt );
         ev->setDtStart( qdt );
       }
+      events.append( ev );
     }
 
     // sort the events for this date by summary
@@ -194,14 +203,22 @@
         newtext.append( QString(" (%1/%2)").arg( dayof ).arg( span ) );
       }
 
-      KURLLabel *urlLabel = new KURLLabel( ev->uid(), newtext, this );
+      KURLLabel *urlLabel = new KURLLabel( this );
+      urlLabel->setText( newtext );
+      urlLabel->setURL( ev->uid() );
       urlLabel->installEventFilter( this );
       urlLabel->setAlignment( urlLabel->alignment() | Qt::WordBreak );
       mLayout->addWidget( urlLabel, counter, 2 );
       mLabels.append( urlLabel );
 
-      if ( !ev->description().isEmpty() ) {
-        QToolTip::add( urlLabel, ev->description() );
+      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
+               this, SLOT( viewEvent( const QString& ) ) );
+      connect( urlLabel, SIGNAL( rightClickedURL( const QString& ) ),
+               this, SLOT( popupMenu( const QString& ) ) );
+
+      QString tipText( KCal::IncidenceFormatter::toolTipString( ev, true ) );
+      if ( !tipText.isEmpty() ) {
+        QToolTip::add( urlLabel, tipText );
       }
 
       // Fill Event Time Range Field (only for non-floating Events)
@@ -225,9 +242,6 @@
         mLabels.append( label );
       }
 
-      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
-               this, SLOT( selectEvent( const QString& ) ) );
-
       counter++;
     }
   }
@@ -246,13 +260,37 @@
     label->show();
 }
 
-void SummaryWidget::selectEvent( const QString &uid )
+void SummaryWidget::viewEvent( const QString &uid )
 {
   mPlugin->core()->selectPlugin( "kontact_korganizerplugin" ); //ensure loaded
   KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
   iface.editIncidence( uid );
 }
 
+void SummaryWidget::removeEvent( const QString &uid )
+{
+  mPlugin->core()->selectPlugin( "kontact_korganizerplugin" ); //ensure loaded
+  KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
+  iface.deleteIncidence( uid, false );
+}
+
+void SummaryWidget::popupMenu( const QString &uid )
+{
+  KPopupMenu popup( this );
+  popup.insertItem( i18n( "&Edit Appointment..." ), 0 );
+  popup.insertItem( KGlobal::iconLoader()->loadIcon( "editdelete", KIcon::Small),
+                    i18n( "&Delete Appointment" ), 1 );
+
+  switch ( popup.exec( QCursor::pos() ) ) {
+    case 0:
+      viewEvent( uid );
+      break;
+    case 1:
+      removeEvent( uid );
+      break;
+  }
+}
+
 bool SummaryWidget::eventFilter( QObject *obj, QEvent* e )
 {
   if ( obj->inherits( "KURLLabel" ) ) {
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -20,9 +20,10 @@
 Name[es]=Citas y tareas pendientes
 Name[et]=Kohtumised ja ülesanded
 Name[eu]=Hitzorduak eta egitekoak
-Name[fa]=قرارهای ملاقات و کارهایی که باید انجام شوند
+Name[fa]=قرار ملاقاتها و کارهایی که باید انجام شوند
 Name[fi]=Tapaamiset ja tehtävät
 Name[fr]=Évènements et tâches
+Name[gl]=Apuntamentos e Tarefas
 Name[he]=פגישות ומטלות
 Name[hu]=Találkozók és feladatok
 Name[is]=Fundir og verkþættir
@@ -56,9 +57,10 @@
 Comment[es]=Configuración del resumen de citas y de tareas pendientes
 Comment[et]=Kohtumiste ja ülesannete kokkuvõtte seadistus
 Comment[eu]=Hitzordu eta egitekoen laburpenen konfigurazioa
-Comment[fa]=برپایی خلاصۀ قرارهای ملاقات و کارهایی که باید انجام شوند.
+Comment[fa]=برپایی خلاصۀ قرار ملاقاتها و کارهایی که باید انجام شوند
 Comment[fi]=Tapaamiset ja tehtävät -yhteenvedon asetukset
 Comment[fr]=Configuration du résumé des évènements et des tâches
+Comment[gl]=Configuración de sumarios de tarefas e notas
 Comment[hu]=A találkozók és feladatok áttekintőjének beállítása
 Comment[is]=Uppsetning á yfirliti yfir fundi og verkþætti
 Comment[it]=Impostazioni sommario appuntamenti e cose da fare
Index: kontact/plugins/korganizer/summarywidget.h
===================================================================
--- kontact/plugins/korganizer/summarywidget.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/summarywidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -55,7 +55,9 @@
 
   private slots:
     void updateView();
-    void selectEvent( const QString &uid );
+    void popupMenu( const QString &uid );
+    void viewEvent( const QString &uid );
+    void removeEvent( const QString &uid );
 
   private:
     KOrganizerPlugin *mPlugin;
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_todoplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
@@ -30,6 +30,7 @@
 Comment[fi]=Kontact KOrganizer -tehtävät-liitännäinen
 Comment[fr]=Module de liste des tâches de KOrganizer pour Kontact
 Comment[ga]=Breiseán Tascliosta KOrganizer le haghaidh Kontact
+Comment[gl]=Extensión de Tarefas Pendentes para KOrganizer de Kontact
 Comment[hu]=Kontact-bővítőmodul a KOrganizer feladatlistához
 Comment[is]=Kontact KOrganizer verkþátta íforrit
 Comment[it]=Plugin Kontact per le cose da fare di KOrganizer
@@ -66,10 +67,11 @@
 Name[es]=Tareas pendientes
 Name[et]=Ülesanded
 Name[eu]=Egitekoen zerrenda
-Name[fa]=فهرست کارهایی که باید انجام شود
+Name[fa]=فهرست کارهای انجامی
 Name[fi]=Tehtäväluettelo
 Name[fr]=Liste de tâches
 Name[ga]=Tascliosta
+Name[gl]=Lista de Tarefas Pendentes
 Name[he]=רשימת מטלות
 Name[hu]=Feladatok
 Name[is]=Verkþættir
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_journalplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=false
@@ -29,6 +29,7 @@
 Comment[fa]=وصلۀ نشریۀ Kontact KOrganizer
 Comment[fi]=Päiväkirjaliitännäinen
 Comment[fr]=Module de journal KOrganizer pour Kontact
+Comment[gl]=Extensión para Xornal no KOrganizer de Kontact
 Comment[hu]=Kontact-bővítőmodul a KOrganizer-naplóhoz
 Comment[is]=Kontact KOrganizer dagbókar íforrit
 Comment[it]=Plugin Kontact per il diario di KOrganizer
@@ -66,6 +67,7 @@
 Name[fa]=نشریه
 Name[fi]=Päiväkirja
 Name[ga]=Iris
+Name[gl]=Xornal
 Name[he]=יומן
 Name[hu]=Napló
 Name[is]=Dagbók
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_korganizerplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
Index: kontact/plugins/korganizer/todosummarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/todosummarywidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/todosummarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -21,20 +21,23 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include <qcursor.h>
 #include <qlabel.h>
 #include <qlayout.h>
+#include <qtooltip.h>
 
 #include <kdialog.h>
 #include <kglobal.h>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kparts/part.h>
+#include <kpopupmenu.h>
 #include <kstandarddirs.h>
 #include <kurllabel.h>
-#include <qtooltip.h>
 #include <libkcal/resourcecalendar.h>
 #include <libkcal/resourcelocal.h>
 #include <libkcal/todo.h>
+#include <libkcal/incidenceformatter.h>
 #include <libkdepim/kpimprefs.h>
 
 #include "korganizeriface_stub.h"
@@ -44,6 +47,8 @@
 #include "todoplugin.h"
 
 #include "korganizer/stdcalendar.h"
+#include "korganizer/koglobals.h"
+#include "korganizer/incidencechanger.h"
 
 #include "todosummarywidget.h"
 
@@ -151,14 +156,22 @@
       if ( todo->relatedTo() ) { // show parent only, not entire ancestry
         sSummary = todo->relatedTo()->summary() + ":" + todo->summary();
       }
-      KURLLabel *urlLabel = new KURLLabel( todo->uid(), sSummary, this );
+      KURLLabel *urlLabel = new KURLLabel( this );
+      urlLabel->setText( sSummary );
+      urlLabel->setURL( todo->uid() );
       urlLabel->installEventFilter( this );
       urlLabel->setTextFormat( Qt::RichText );
       mLayout->addWidget( urlLabel, counter, 2 );
       mLabels.append( urlLabel );
 
-      if ( !todo->description().isEmpty() ) {
-        QToolTip::add( urlLabel, todo->description() );
+      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
+               this, SLOT( viewTodo( const QString& ) ) );
+      connect( urlLabel, SIGNAL( rightClickedURL( const QString& ) ),
+               this, SLOT( popupMenu( const QString& ) ) );
+
+      QString tipText( KCal::IncidenceFormatter::toolTipString( todo, true ) );
+      if ( !tipText.isEmpty() ) {
+        QToolTip::add( urlLabel, tipText );
       }
 
       label = new QLabel( stateText, this );
@@ -167,9 +180,6 @@
       mLayout->addWidget( label, counter, 3 );
       mLabels.append( label );
 
-      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
-               this, SLOT( selectEvent( const QString& ) ) );
-
       counter++;
     }
   }
@@ -185,13 +195,59 @@
     label->show();
 }
 
-void TodoSummaryWidget::selectEvent( const QString &uid )
+void TodoSummaryWidget::viewTodo( const QString &uid )
 {
   mPlugin->core()->selectPlugin( "kontact_todoplugin" );//ensure loaded
   KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
   iface.editIncidence( uid );
 }
 
+void TodoSummaryWidget::removeTodo( const QString &uid )
+{
+  mPlugin->core()->selectPlugin( "kontact_todoplugin" );//ensure loaded
+  KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
+  iface.deleteIncidence( uid, false );
+}
+
+void TodoSummaryWidget::completeTodo( const QString &uid )
+{
+  KCal::Todo *todo = mCalendar->todo( uid );
+  IncidenceChanger *changer = new IncidenceChanger( mCalendar, this );
+  if ( !todo->isReadOnly() && changer->beginChange( todo ) ) {
+    KCal::Todo *oldTodo = todo->clone();
+    todo->setCompleted( QDateTime::currentDateTime() );
+    changer->changeIncidence( oldTodo, todo, KOGlobals::COMPLETION_MODIFIED );
+    changer->endChange( todo );
+    delete oldTodo;
+    updateView();
+  }
+}
+
+void TodoSummaryWidget::popupMenu( const QString &uid )
+{
+  KPopupMenu popup( this );
+  popup.insertItem( i18n( "&Edit To-do..." ), 0 );
+  popup.insertItem( KGlobal::iconLoader()->loadIcon( "editdelete", KIcon::Small),
+                    i18n( "&Delete To-do" ), 1 );
+  KCal::Todo *todo = mCalendar->todo( uid );
+  if ( !todo->isCompleted() ) {
+    popup.insertItem( KGlobal::iconLoader()->loadIcon( "checkedbox", KIcon::Small),
+                      i18n( "&Mark To-do Completed" ), 2 );
+  }
+
+  switch ( popup.exec( QCursor::pos() ) ) {
+    case 0:
+      viewTodo( uid );
+      break;
+    case 1:
+      removeTodo( uid );
+      break;
+    case 2:
+      completeTodo( uid );
+      break;
+  }
+}
+
 bool TodoSummaryWidget::eventFilter( QObject *obj, QEvent* e )
 {
   if ( obj->inherits( "KURLLabel" ) ) {
Index: kontact/plugins/korganizer/Makefile.am
===================================================================
--- kontact/plugins/korganizer/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -2,6 +2,7 @@
 INCLUDES = -I$(top_srcdir)/kontact/interfaces \
   -I$(top_srcdir)/libkdepim \
   -I$(top_srcdir)/korganizer \
+  -I$(top_srcdir)/korganizer/interfaces \
   -I$(top_srcdir) $(all_includes)
 
 kde_module_LTLIBRARIES = libkontact_korganizerplugin.la \
@@ -27,7 +28,8 @@
 libkontact_todoplugin_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN)
 libkontact_todoplugin_la_LIBADD = libcommon.la \
     $(top_builddir)/kontact/interfaces/libkpinterfaces.la $(LIB_KPARTS) \
-    $(top_builddir)/korganizer/libkorganizer_calendar.la
+    $(top_builddir)/korganizer/libkorganizer_calendar.la \
+    $(top_builddir)/korganizer/libkorganizer.la
 libkontact_todoplugin_la_SOURCES = todoplugin.cpp \
                                    kcalendariface.stub \
                                    todosummarywidget.cpp \
Index: kontact/plugins/korganizer/todosummarywidget.h
===================================================================
--- kontact/plugins/korganizer/todosummarywidget.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/korganizer/todosummarywidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,7 +56,10 @@
 
   private slots:
     void updateView();
-    void selectEvent( const QString &uid );
+    void popupMenu( const QString &uid );
+    void viewTodo( const QString &uid );
+    void removeTodo( const QString &uid );
+    void completeTodo( const QString &uid );
 
   private:
     TodoPlugin *mPlugin;
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kaddressbookplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkaddressbookpart
 X-KDE-KontactPartExecutableName=kaddressbook
 X-KDE-KontactPluginHasSummary=false
Index: kontact/plugins/newsticker/kcmkontactknt.desktop
===================================================================
--- kontact/plugins/newsticker/kcmkontactknt.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/newsticker/kcmkontactknt.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -12,7 +12,6 @@
 X-KDE-CfgDlgHierarchy=KontactSummary
 
 Name=News Ticker
-Name[ar]=تجديد الأخبار
 Name[az]=Xəbər Gözləyici
 Name[br]=Kliker keleier
 Name[ca]=Teletip de notícies
@@ -77,6 +76,7 @@
 Comment[fa]=برپایی خلاصۀTicker اخبار
 Comment[fi]=Uutisnäyttimen yhteenvedon asetukset
 Comment[fr]=Configuration du résumé du téléscripteur de nouvelles
+Comment[gl]=Configuración do Resumo de Fontes de Novas
 Comment[he]=הגדרות תקציר חדשות רצות
 Comment[hu]=A hírmegjelenítő áttekintőjének beállításai
 Comment[is]=Uppsetning á yfirliti yfir fréttastrimla
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -6,7 +6,7 @@
 TryExec=rssservice
 
 X-KDE-Library=libkontact_newstickerplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
Index: kontact/interfaces/plugin.h
===================================================================
--- kontact/interfaces/plugin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/interfaces/plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -34,6 +34,7 @@
 class DCOPObject;
 class KAboutData;
 class KAction;
+class KConfig;
 class QWidget;
 namespace KParts { class ReadOnlyPart; }
 
@@ -41,7 +42,7 @@
   Increase this version number whenever you make a change
   in the API.
  */
-#define KONTACT_PLUGIN_VERSION 4
+#define KONTACT_PLUGIN_VERSION 5
 
 namespace Kontact
 {
@@ -231,6 +232,16 @@
     */
     virtual void processDropEvent( QDropEvent * ) {}
 
+    /**
+     * Session management: read properties
+     */
+    virtual void readProperties( KConfig * ) {}
+
+    /**
+     * Session management: save properties
+     */
+    virtual void saveProperties( KConfig * ) {}
+
     Core *core() const;
 
   public slots:
Index: kontact/interfaces/uniqueapphandler.cpp
===================================================================
--- kontact/interfaces/uniqueapphandler.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/interfaces/uniqueapphandler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,6 +27,8 @@
 #include <kwin.h>
 #include <dcopclient.h>
 #include <kdebug.h>
+#include <klocale.h>
+#include <kuniqueapplication.h>
 
 /*
  Test plan for the various cases of interaction between standalone apps and kontact:
@@ -64,6 +66,12 @@
  5c) close knode, type "knode news://foobar/group" -> kontact loads knode and pops up msgbox
  5d) type "knode" -> kontact is brought to front
 
+ 6) start "kontact --module summaryplugin"
+ 6a) type "dcop kmail kmail newInstance" -> kontact switches to kmail (#103775)
+ 6b) type "kmail" -> kontact is brought to front
+ 6c) type "kontact" -> kontact is brought to front
+ 6d) type "kontact --module summaryplugin" -> kontact switches to summary
+
 */
 
 using namespace Kontact;
@@ -89,7 +97,7 @@
     replyType = "int";
 
     KCmdLineArgs::reset(); // forget options defined by other "applications"
-    loadCommandLineOptions();
+    loadCommandLineOptions(); // implemented by plugin
 
     // This bit is duplicated from KUniqueApplication::processDelayed()
     QDataStream ds( data, IO_ReadOnly );
@@ -101,7 +109,14 @@
     }
 
     QDataStream _replyStream( replyData, IO_WriteOnly );
-    _replyStream << newInstance( );
+    _replyStream << newInstance();
+
+    // OK, we're done, reload the initial kontact command line options,
+    // so that "kontact --module foo" keeps working (#103775).
+
+    KCmdLineArgs::reset(); // forget options defined above
+    loadKontactCommandLineOptions();
+
   } else if ( fun == "load()" ) {
     replyType = "bool";
     (void)mPlugin->part(); // load the part without bringing it to front
@@ -168,4 +183,19 @@
   }
 }
 
+static KCmdLineOptions options[] =
+{
+    { "module <module>",   I18N_NOOP( "Start with a specific Kontact module" ), 0 },
+    { "iconify",   I18N_NOOP( "Start in iconified (minimized) mode" ), 0 },
+    { "list", I18N_NOOP( "List all possible modules and exit" ), 0 },
+    KCmdLineLastOption
+};
+
+void Kontact::UniqueAppHandler::loadKontactCommandLineOptions()
+{
+  KCmdLineArgs::addCmdLineOptions( options );
+  KUniqueApplication::addCmdLineOptions();
+  KApplication::addCmdLineOptions();
+}
+
 #include "uniqueapphandler.moc"
Index: kontact/interfaces/kontactplugin.desktop
===================================================================
--- kontact/interfaces/kontactplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/interfaces/kontactplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,7 +15,7 @@
 Name[es]=Plugin Kontact
 Name[et]=Kontacti plugin
 Name[eu]=Kontact plugin-a
-Name[fa]=وصلۀ 
+Name[fa]=وصلۀ Kontact
 Name[fi]=Kontact-liitännäinen
 Name[fr]=Module Kontact
 Name[ga]=Breiseán Kontact
Index: kontact/interfaces/uniqueapphandler.h
===================================================================
--- kontact/interfaces/uniqueapphandler.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/interfaces/uniqueapphandler.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,6 +52,9 @@
 
     Plugin* plugin() const { return mPlugin; }
 
+    /// Load the kontact command line options.
+    static void loadKontactCommandLineOptions();
+
   private:
     Plugin* mPlugin;
 };
Index: kontact/src/kcmkontact.cpp
===================================================================
--- kontact/src/kcmkontact.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/kcmkontact.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -104,6 +104,7 @@
 {
   mItem = item;
   mPluginCombo = new QComboBox( parent );
+  connect( mPluginCombo, SIGNAL( activated( int ) ), SIGNAL( changed() ) );
 }
 
 PluginSelection::~PluginSelection()
@@ -140,12 +141,6 @@
   mItem->setValue( ptr->property("X-KDE-PluginInfo-Name").toString() );
 }
 
-void PluginSelection::itemClicked( QListViewItem *item )
-{
-  if ( item )
-    emit changed();
-}
-
 QValueList<QWidget *> PluginSelection::widgets() const
 {
   QValueList<QWidget *> widgets;
Index: kontact/src/kcmkontact.h
===================================================================
--- kontact/src/kcmkontact.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/kcmkontact.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -60,9 +60,6 @@
     QValueList<QWidget *> widgets() const;
     QComboBox *comboBox() const { return mPluginCombo; }
 
-  private slots:
-    void itemClicked( QListViewItem* );
-
   private:
     QComboBox *mPluginCombo;
     QValueList<KService::Ptr> mPluginList;
Index: kontact/src/kontact.setdlg
===================================================================
--- kontact/src/kontact.setdlg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/kontact.setdlg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -60,6 +60,7 @@
 Comment[fa]=نمای خلاصه
 Comment[fi]=Yhteenvetonäyttö
 Comment[fr]=Vue résumée
+Comment[gl]=Vista de Sumario
 Comment[he]=תצוגת תקציר
 Comment[hu]=Áttekintő nézet
 Comment[is]=Yfirlitssýn
@@ -151,9 +152,10 @@
 Comment[es]=Componente de correo
 Comment[et]=E-posti komponent
 Comment[eu]=Posta osagaia
-Comment[fa]=محتوای نامه
+Comment[fa]=مؤلفۀ نامه
 Comment[fi]=Sähköpostiohjelma
 Comment[fr]=Composant messagerie
+Comment[gl]=Compoñente de Correo
 Comment[he]=רכיב דואר
 Comment[hu]=Levelezőkomponens
 Comment[is]=Pósthluti
@@ -244,9 +246,10 @@
 Comment[es]=Componente de la libreta de direcciones
 Comment[et]=Aadressiraamatu komponent
 Comment[eu]=Helbide-liburu osagaia
-Comment[fa]=محتوای کتاب نشانی
+Comment[fa]=مؤلفۀ کتاب نشانی
 Comment[fi]=Osoitekirja
 Comment[fr]=Composant de carnet d'adresses
+Comment[gl]=Compoñente do Caderno de Enderezos
 Comment[he]=רכיב פנקס כתובות
 Comment[hu]=Címjegyzék-komponens
 Comment[is]=Vistfangahluti
@@ -289,6 +292,7 @@
 Name[fa]=خلاصۀ تاریخهای ویژه
 Name[fi]=Erikoispäivien yhteenveto
 Name[fr]=Résumé des dates particulières
+Name[gl]=Resumo de Datas Especiais
 Name[he]=תקציר תאריכים מיוחדים
 Name[hu]=A fontos dátumok áttekintője
 Name[is]=Yfirlit sérstakra daga
@@ -325,9 +329,10 @@
 Comment[es]=Componente de resumen de fechas especiales
 Comment[et]=Tähtpäevade kokkuvõtte komponent
 Comment[eu]=Data berezien laburpenaren osagaia
-Comment[fa]=محتوای خلاصۀ تاریخهای ویژه
+Comment[fa]=مؤلفۀ خلاصۀ تاریخهای ویژه
 Comment[fi]=Erikoispäivien yhteenvedon komponentti
 Comment[fr]=Composant de résumé des dates particulières
+Comment[gl]=Compoñente de Resumo de Datas Especiais
 Comment[he]=רכיב תאריכים חשובים
 Comment[hu]=A fontos dátumok áttekintő komponense
 Comment[is]=Yfirlitshluti sérstakra daga
@@ -418,9 +423,10 @@
 Comment[es]=Componente de calendario
 Comment[et]=Kalendrikomponent
 Comment[eu]=Egutegi osagaia
-Comment[fa]=محتوای تقویم
+Comment[fa]=مؤلفۀ تقویم
 Comment[fi]=Kalenterikomponentti
 Comment[fr]=Composant d'agenda
+Comment[gl]=Compoñente de Calendario
 Comment[he]=רכיב לוח שנה
 Comment[hu]=Naptárkezelő komponens
 Comment[is]=Dagatalshluti
@@ -511,9 +517,10 @@
 Comment[es]=Componente de noticias
 Comment[et]=Uudistekomponent
 Comment[eu]=Berrien osagaia
-Comment[fa]=محتوای اخبار
+Comment[fa]=مؤلفۀ اخبار
 Comment[fi]=Uutiskomponentti
 Comment[fr]=Composant de Nouvelles
+Comment[gl]=Compoñente de Novas
 Comment[he]=רכיב חדשות
 Comment[hu]=Hírkezelő komponens
 Comment[is]=Fréttahluti
@@ -545,6 +552,7 @@
 
 [KWeather]
 Name=Weather
+Name[ar]=الطقس
 Name[be]=Надвор'е
 Name[br]=Amzer
 Name[bs]=Vrijeme
@@ -610,6 +618,7 @@
 Comment[fi]=Säätiedot
 Comment[fr]=Informations météo
 Comment[ga]=Eolas faoin aimsir
+Comment[gl]=Información do Tempo
 Comment[he]=מידע אודות מזג האוויר
 Comment[hu]=Időjárási adatok
 Comment[is]=Veðurupplýsingar
@@ -642,7 +651,6 @@
 
 [NewsTicker]
 Name=News Ticker
-Name[ar]=تجديد الأخبار
 Name[az]=Xəbər Gözləyici
 Name[br]=Kliker keleier
 Name[ca]=Teletip de notícies
@@ -704,9 +712,10 @@
 Comment[es]=Componente de teletipo de noticias
 Comment[et]=Uudistejälgija komponent
 Comment[eu]=Berri markatzaile osagaia
-Comment[fa]=محتوای Ticker اخبار
+Comment[fa]=مؤلفۀ Ticker اخبار
 Comment[fi]=Uutiskomponentti
 Comment[fr]=Composant d'affichage de nouvelles
+Comment[gl]=Compoñente de Fonte de Novas
 Comment[hu]=Hírmegjelenítő komponens
 Comment[is]=Fréttastrimilshluti
 Comment[it]=Ticker notizie
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -805,6 +805,46 @@
     new KRun( url, this );
 }
 
+void MainWindow::readProperties( KConfig *config )
+{
+  Core::readProperties( config );
+
+  QStringList activePlugins = config->readListEntry( "ActivePlugins" );
+  QValueList<Plugin*>::ConstIterator it = mPlugins.begin();
+  QValueList<Plugin*>::ConstIterator end = mPlugins.end();
+  for ( ; it != end; ++it ) {
+    Plugin *plugin = *it;
+    if ( !plugin->isRunningStandalone() ) {
+      QStringList::ConstIterator activePlugin = activePlugins.find( plugin->identifier() );
+      if ( activePlugin != activePlugins.end() ) {
+        plugin->readProperties( config );
+      }
+    }
+  }
+}
+
+void MainWindow::saveProperties( KConfig *config )
+{
+  Core::saveProperties( config );
+
+  QStringList activePlugins;
+
+  KPluginInfo::List::Iterator it = mPluginInfos.begin();
+  KPluginInfo::List::Iterator end = mPluginInfos.end();
+  for ( ; it != end; ++it ) {
+    KPluginInfo *info = *it;
+    if ( info->isPluginEnabled() ) {
+      Plugin *plugin = pluginFromInfo( info );
+      if ( plugin ) {
+        activePlugins.append( plugin->identifier() );
+        plugin->saveProperties( config );
+      }
+    }
+  }
+
+  config->writeEntry( "ActivePlugins", activePlugins );
+}
+
 bool MainWindow::queryClose()
 {
   if ( kapp->sessionSaving() || mReallyClose )
Index: kontact/src/mainwindow.h
===================================================================
--- kontact/src/mainwindow.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,6 +41,7 @@
 class QFrame;
 
 class KAction;
+class KConfig;
 class KPluginInfo;
 class KRSqueezedTextLabel;
 class KHTMLPart;
@@ -116,6 +117,8 @@
     void setupActions();
     void showTip( bool );
     virtual bool queryClose();
+    virtual void readProperties( KConfig *config );
+    virtual void saveProperties( KConfig *config );
     void paintAboutScreen( const QString& msg );
     static QString introductionString();
 
Index: kontact/src/main.cpp
===================================================================
--- kontact/src/main.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kontact/src/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -39,6 +39,7 @@
 
 #include "alarmclient.h"
 #include "mainwindow.h"
+#include <uniqueapphandler.h> // in ../interfaces
 
 using namespace std;
 
@@ -49,14 +50,22 @@
 
 class KontactApp : public KUniqueApplication {
   public:
-    KontactApp() : mMainWindow( 0 ) {}
+    KontactApp() : mMainWindow( 0 ), mSessionRestored( false ) {}
     ~KontactApp() {}
 
     int newInstance();
+    void setMainWindow( Kontact::MainWindow *window ) {
+        mMainWindow = window;
+        setMainWidget( window );
+    }
+    void setSessionRestored( bool restored ) {
+        mSessionRestored = restored;
+    }
 
   private:
     void startKOrgac();
     Kontact::MainWindow *mMainWindow;
+    bool mSessionRestored;
 };
 
 static void listPlugins()
@@ -75,14 +84,6 @@
   }
 }
 
-static KCmdLineOptions options[] =
-{
-    { "module <module>",   I18N_NOOP( "Start with a specific Kontact module" ), 0 },
-    { "iconify",   I18N_NOOP( "Start in iconified (minimized) mode" ), 0 },
-    { "list", I18N_NOOP( "List all possible modules and exit" ), 0 },
-    KCmdLineLastOption
-};
-
 int KontactApp::newInstance()
 {
   KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
@@ -94,15 +95,7 @@
     moduleName = QString::fromLocal8Bit( args->getOption( "module" ) );
   }
 
-  if ( isRestored() ) {
-    // There can only be one main window
-    if ( KMainWindow::canBeRestored( 1 ) ) {
-      mMainWindow = new Kontact::MainWindow();
-      setMainWidget( mMainWindow );
-      mMainWindow->show();
-      mMainWindow->restore( 1 );
-    }
-  } else {
+  if ( !mSessionRestored ) {
     if ( !mMainWindow ) {
       mMainWindow = new Kontact::MainWindow();
       if ( !moduleName.isEmpty() )
@@ -142,9 +135,7 @@
   about.addAuthor( "Matthias Hoelzer-Kluepfel", I18N_NOOP("Original Author"), "mhk@kde.org" );
 
   KCmdLineArgs::init( argc, argv, &about );
-  KCmdLineArgs::addCmdLineOptions( options );
-  KUniqueApplication::addCmdLineOptions();
-  KApplication::addCmdLineOptions();
+  Kontact::UniqueAppHandler::loadKontactCommandLineOptions();
 
   KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
   if ( args->isSet( "list" ) ) {
@@ -158,6 +149,17 @@
   }
 
   KontactApp app;
+  if ( app.restoringSession() ) {
+     // There can only be one main window
+    if ( KMainWindow::canBeRestored( 1 ) ) {
+      Kontact::MainWindow *mainWindow = new Kontact::MainWindow();
+      app.setMainWindow( mainWindow );
+      app.setSessionRestored( true );
+      mainWindow->show();
+      mainWindow->restore( 1 );
+    }
+  }
+
   bool ret = app.exec();
   while ( KMainWindow::memberList->first() )
     delete KMainWindow::memberList->first();
Index: kandy/src/kandy.desktop
===================================================================
--- kandy/src/kandy.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kandy/src/kandy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Comment[fa]=ابزار برای همگام‌سازی دادۀ کتاب نشانی با تلفنهای همراه
 Comment[fi]=Osoitekirjan tietojan ja kännykän liitostyökalu
 Comment[fr]=Outil pour synchroniser les données de carnets d'adresses avec les téléphones mobiles
+Comment[gl]=Ferramenta para sincronizar os datos do caderno de enderezos con teléfonos móbiles
 Comment[hu]=Segédprogram számítógép és mobiltelefon címjegyzékének szinkronizálásához
 Comment[is]=Tól sem samstillir vistfangagögn við farsíma
 Comment[it]=Strumento per sincronizzare i dati della rubrica indirizzi con i telefoni cellulari
@@ -49,7 +50,6 @@
 Type=Application
 GenericName=Mobile Phone Tool
 GenericName[af]=Mobiele Foon Program
-GenericName[ar]=أداة هاتف الموبايل
 GenericName[bg]=Мобилни телефони
 GenericName[bs]=Alat za mobilne telefone
 GenericName[ca]=Eina per a telèfons mòbils
@@ -62,9 +62,10 @@
 GenericName[es]=Gestor de teléfonos móviles
 GenericName[et]=Mobiiltelefoni rakendus
 GenericName[eu]=Telefono mugikorrendako Tresna
-GenericName[fa]=ابزار تلفن همراه‌
+GenericName[fa]=ابزار تلفن همراه
 GenericName[fi]=Matkapuhelintyökalu
 GenericName[fr]=Outil de connexion à votre téléphone portable
+GenericName[gl]=Ferramenta para o Teléfono Móbil
 GenericName[he]=כלי טלפון נייד
 GenericName[hi]=मोबाइल फोन उपकरण
 GenericName[hr]=Alat za mobitele
Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,4 +1,5 @@
 [Desktop Entry]
+Encoding=UTF-8
 Name=KTnef
 Name[sv]=Ktnef
 GenericName=TNEF File Viewer
@@ -16,6 +17,7 @@
 GenericName[fi]=TNEF-tiedostonäytin
 GenericName[fr]=Afficheur de fichiers TNEF
 GenericName[ga]=Amharcán Comhad TNEF
+GenericName[gl]=Visor de Ficheiros TNEF
 GenericName[hu]=TNEF-fájlnézegető
 GenericName[is]=TNEF skráarskoðari
 GenericName[it]=Visualizzatore file TNEF
@@ -57,9 +59,10 @@
 Comment[es]=A visor/extractor para archivos TNEF
 Comment[et]=TNEF-failide näitaja/ekstraktija
 Comment[eu]=TNEF fitxategien ikustaile/erauzlea
-Comment[fa]=یک مشاهده‌گر/استخراجگر برای پرونده‌های TNEF
+Comment[fa]=یک مشاهده‌گر/استخراج‌گر برای پرونده‌های TNEF
 Comment[fi]=Näytin/purkaja TNEF-tiedostoille
 Comment[fr]=Pour afficher / extraire des fichiers TNEF
+Comment[gl]=Un visor/extractor para ficheiros TNEF
 Comment[hi]=टीएनईएफ फ़ाइलों के लिए एक प्रदर्शक/एक्सट्रेक्टर
 Comment[hr]=Prikazivač/izdvajač za TNEF datoteke
 Comment[hu]=Nézegetőprogram TNEF-fájlokhoz
Index: ktnef/gui/ms-tnef.desktop
===================================================================
--- ktnef/gui/ms-tnef.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ ktnef/gui/ms-tnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -20,6 +20,7 @@
 Comment[fi]=TNEF-tiedosto
 Comment[fr]=Fichier TNEF
 Comment[ga]=Comhad TNEF
+Comment[gl]=Ficheiro TNEF
 Comment[he]=קובץ TNEF
 Comment[hi]=टीएनईएफ फ़ाइल
 Comment[hr]=TNEF datoteka
Index: kfile-plugins/rfc822/kfile_rfc822.desktop
===================================================================
--- kfile-plugins/rfc822/kfile_rfc822.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kfile-plugins/rfc822/kfile_rfc822.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -14,9 +14,10 @@
 Name[es]=Info de correo electrónico
 Name[et]=Kirja info
 Name[eu]=E-posta informazioa
-Name[fa]=اطلاعات رایانامه‌
+Name[fa]=اطلاعات رایانامه
 Name[fi]=Sähköpostitiedot
 Name[fr]=Informations sur le courrier électronique
+Name[gl]=Información de Correo-e
 Name[he]=מידע על דוא"ל
 Name[hi]=ई-मेल जानकारी
 Name[hr]=Email Informacije
Index: kfile-plugins/ics/kfile_ics.desktop
===================================================================
--- kfile-plugins/ics/kfile_ics.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kfile-plugins/ics/kfile_ics.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -16,6 +16,7 @@
 Name[fa]=اطلاعات ICS
 Name[fi]=ICS-tiedot
 Name[fr]=Information sur ICS
+Name[gl]=Información ICS
 Name[he]=מידע של ICS
 Name[hu]=ICS-jellemzők
 Name[is]=ICS upplýsingar
Index: kfile-plugins/palm-databases/kfile_palm.desktop
===================================================================
--- kfile-plugins/palm-databases/kfile_palm.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kfile-plugins/palm-databases/kfile_palm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Name[fi]=PalmOS-tietokannan tiedot
 Name[fr]=Informations sur les bases de données PalmOS
 Name[ga]=Eolas faoin Bhunachar Sonraí PalmOS
+Name[gl]=Información de Base de Datos de PalmOS
 Name[he]=מידע אודות בסיס הנתונים של PalmOS
 Name[hu]=PalmOS adatbázis-jellemzők
 Name[is]=PalmOS gagnagrunnsupplýsingar
Index: kfile-plugins/vcf/kfile_vcf.desktop
===================================================================
--- kfile-plugins/vcf/kfile_vcf.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ kfile-plugins/vcf/kfile_vcf.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -19,6 +19,7 @@
 Name[fa]=اطلاعات vCard
 Name[fi]=vCard-tiedot
 Name[fr]=Informations vCard
+Name[gl]=Información de vCard
 Name[he]=מידע vCard
 Name[hi]=वी-कार्ड जानकारी
 Name[hu]=VCard-jellemzők
Index: korganizer/korganizer_configfonts.desktop
===================================================================
--- korganizer/korganizer_configfonts.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configfonts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 X-KDE-CfgDlgHierarchy=KOrganizer
 
 Name=Fonts
-Name[ar]=الخطوط
+Name[ar]=المحارف
 Name[az]=Yazı növləri
 Name[be]=Шрыфты
 Name[bg]=Шрифтове
@@ -72,7 +72,7 @@
 Name[zh_CN]=字体
 Name[zh_TW]=字型
 Comment=KOrganizer Fonts Configuration
-Comment[ar]=إعداد خطوط KOrganizer
+Comment[ar]=إعداد المحارف لِــ KOrganizer
 Comment[be]=Канфігурацыя шрыфтоў "K Арганізатара"
 Comment[bg]=Настройки на шрифтовете за KOrganizer
 Comment[bs]=KOrganizer podešavanje fontova
Index: korganizer/aboutdata.cpp
===================================================================
--- korganizer/aboutdata.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/aboutdata.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,8 +28,6 @@
 
 using namespace KOrg;
 
-AboutData *AboutData::mSelf = 0;
-
 AboutData::AboutData()
   : KAboutData( "korganizer", I18N_NOOP("KOrganizer"), korgVersion,
                 I18N_NOOP("A Personal Organizer for KDE"),
@@ -75,9 +73,3 @@
   addCredit("Thomas Zander");
   addCredit("Fester Zigterman");
 }
-
-AboutData *AboutData::self()
-{
-  if ( !mSelf ) mSelf = new AboutData;
-  return mSelf;
-}
Index: korganizer/printing/calprinthelper.h
===================================================================
--- korganizer/printing/calprinthelper.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprinthelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,371 +0,0 @@
-/*
-    This file is part of KOrganizer.
-
-    Copyright (c) 1998 Preston Brown <pbrown@kde.org>
-    Copyright (c) 2003 Reinhold Kainhofer <reinhold@kainhofer.com>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-#ifndef CALPRINTBASE_H
-#define CALPRINTBASE_H
-
-#ifndef KORG_NOPRINTER
-
-#include <qdatetime.h>
-#include <kprinter.h>
-#include <libkcal/calendar.h>
-#include <libkcal/event.h>
-#include <libkcal/todo.h>
-#include <kdepimmacros.h>
-
-class PrintCellItem;
-
-namespace KCal {
-class Calendar;
-class Todo;
-class Event;
-}
-namespace KOrg {
-class CoreHelper;
-}
-class QWidget;
-
-using namespace KCal;
-
-class KDE_EXPORT CalPrintHelper
-{
-  public:
-    /**
-      Constructor
-
-      \param pr KPrinter object used to print.
-      \param cal Calendar to be printed.
-      \param cfg KConfig object for reading/writing printing configuration.
-      \param corehelper KOrganizer core helper, useful for all helper classes.
-    */
-    CalPrintHelper( KPrinter *pr, Calendar *cal, KConfig *cfg, KOrg::CoreHelper *corehelper );
-    virtual ~CalPrintHelper();
-
-    bool useColors() const { return mUseColors; }
-    void setUseColors( bool useColors ) { mUseColors = useColors; }
-
-  public:
-    Event *holiday( const QDate &dt );
-    /**
-      Determines the column of the given weekday ( 1=Monday, 7=Sunday ), taking the
-      start of the week setting into account as given in kcontrol.
-      \param weekday Index of the weekday
-    */
-    static int weekdayColumn( int weekday );
-    void setCategoryColors( QPainter &p, Incidence *incidence );
-
-    void setCalendarSystem( const KCalendarSystem *calsys ) { mCalSys = calsys; }
-    const KCalendarSystem *calendarSystem() const { return mCalSys; }
-
-    bool mUseColors;
-
-  public:
-    /**
-      Internal class representing the start of a todo.
-    */
-    class TodoParentStart;
-
-  public:
-    /**
-      Draw the gray header bar of the printout to the QPainter.
-      It prints the given text and optionally one or two small
-      month views, as specified by the two QDate. The printed
-      text can also contain a line feed.
-      If month2 is invalid, only the month that contains month1
-      is printed.
-      E.g. the filofax week view draws just the current month,
-      while the month view draws the previous and the next month.
-      \param p QPainter of the printout
-      \param title The string printed as the title of the page
-                   (e.g. the date, date range or todo list title)
-      \param month1 Date specifying the month for the left one of
-                    the small month views in the title bar. If left
-                    empty, only month2 will be printed (or none,
-                    it that is invalid as well).
-      \param month2 Date specifying the month for the right one of
-                    the small month views in the title bar. If left
-                    empty, only month1 will be printed (or none,
-                    it that is invalid as well).
-      \param x x-coordinate of the upper left coordinate of the title bar
-      \param y y-coordinate of the upper left coordinate of the title bar
-      \param width Width of the title bar
-      \param height Height of the title bar
-    */
-    void drawHeader( QPainter &p, QString title,
-                     const QDate &month1, const QDate &month2,
-                     int x, int y, int width, int height );
-    /**
-      Draw a small calendar with the days of a month into the given area.
-      Used for example in the title bar of the sheet.
-      \param p QPainter of the printout
-      \param qd Arbitrary Date within the month to be printed.
-      \param x x-coordinate of the upper left coordinate of the small calendar
-      \param y y-coordinate of the upper left coordinate of the small calendar
-      \param width Width of the small calendar
-      \param height Height of the small calendar
-    */
-    void drawSmallMonth( QPainter &p, const QDate &qd,
-                         int x, int y, int width, int height );
-
-    /**
-      Draw a horizontal bar with the weekday names of the given date range
-      in the given area of the painter.
-      This is used for the weekday-bar on top of the timetable view and the month view.
-      \param p QPainter of the printout
-      \param fromDate First date of the printed dates
-      \param toDate Last date of the printed dates
-      \param x x-coordinate of the upper left coordinate of the first day
-      \param y y-coordinate of the upper left coordinate of the first day
-      \param width Width of all the days of the week
-      \param height Height of all the days of the week
-    */
-    void drawDaysOfWeek( QPainter &p,
-                         const QDate &fromDate, const QDate &toDate,
-                         int x, int y, int width, int height );
-    /**
-      Draw a single weekday name in a box inside the given area of the painter.
-      This is called in a loop by drawDaysOfWeek.
-      \param p QPainter of the printout
-      \param qd Date of the printed day
-      \param x x-coordinate of the upper left coordinate of the weekbox
-      \param y y-coordinate of the upper left coordinate of the weekbox
-      \param width Width of the weekbox
-      \param height Height of the weekbox
-    */
-    void drawDaysOfWeekBox( QPainter &p, const QDate &qd,
-                            int x, int y, int width, int height );
-    /**
-      Draw a (vertical) time scale from time fromTime to toTime inside the given area of the painter.
-      Every hour will have a one-pixel line over the whole width, every
-      half-hour the line will only span the left half of the width.
-      This is used in the day and timetable print styles
-      \param p QPainter of the printout
-      \param fromTime Start time of the time range to display
-      \param toTime End time of the time range to display
-      \param x x-coordinate of the upper left coordinate of the timeline
-      \param y y-coordinate of the upper left coordinate of the timeline
-      \param width Width of the timeline
-      \param height Height of the timeline
-    */
-    void drawTimeLine( QPainter &p,
-                       const QTime &fromTime, const QTime &toTime,
-                       int x, int y, int width, int height );
-    /**
-      Draw the all-day box for the agenda print view (the box on top which
-      doesn't have a time on the time scale associated). If expandable is set,
-      height is the cell height of a single cell, and the returned height will
-      be the total height used for the all-day events. If !expandable, only one
-      cell will be used, and multiple events are concatenated using ", ".
-      \param p QPainter of the printout
-      \param eventList The list of all-day events that are supposed to be printed
-             inside this box
-      \param qd The date of the currently printed day
-      \param expandable If true, height is the height of one single cell, the printout
-             will use as many cells as events in the list and return the total height
-             needed for all of them. If false, height specifies the total height
-             allowed for all events, and the events are displayed in one cell,
-             with their summaries concatenated by ", ".
-      \param x x-coordinate of the upper left coordinate of the all day box.
-      \param y y-coordinate of the upper left coordinate of the all day box.
-      \param width Width of the all day box.
-      \param height Height of the all day box.
-    */
-    void drawAllDayBox( QPainter &p, Event::List &eventList,
-                        const QDate &qd, bool expandable,
-                        int x, int y, int width, int &height );
-    /**
-      Draw the agenda box for the day print style (the box showing all events of that day).
-      Also draws a grid with half-hour spacing of the grid lines.
-      \param p QPainter of the printout
-      \param eventList The list of the events that are supposed to be printed
-             inside this box
-      \param qd The date of the currently printed day
-      \param expandable If true, the start and end times are adjusted to include
-             the whole range of all events of that day, not just of the given time range.
-             The height of the box will not be affected by this (but the height
-             of one hour will be scaled down so that the whole range fits into
-             the box. fromTime and toTime receive the actual time range printed
-             by this function).
-      \param fromTime Start of the time range to be printed. Might be adjusted
-                      to include all events if expandable==true
-      \param toTime End of the time range to be printed. Might be adjusted
-                   to include all events if expandable==true
-      \param x x-coordinate of the upper left coordinate of the agenda day box.
-      \param y y-coordinate of the upper left coordinate of the agenda day box.
-      \param width Width of the agenda day box.
-      \param height Height of the agenda day box.
-    */
-    void drawAgendaDayBox( QPainter &p, Event::List &eventList,
-                           const QDate &qd, bool expandable,
-                           QTime &fromTime, QTime &toTime,
-                           int x, int y, int width, int height);
-
-    void drawAgendaItem( PrintCellItem *item, QPainter &p, const QDate &,
-                         const QDateTime &startPrintDate,
-                         const QDateTime &endPrintDate,
-                         float minlen, int x, int y, int width );
-    /**
-      Draw the box containing a list of all events of the given day (with their times,
-      of course). Used in the Filofax and the month print style.
-      \param p QPainter of the printout
-      \param qd The date of the currently printed day. All events of the calendar
-                that appear on that day will be printed.
-      \param x x-coordinate of the upper left coordinate of the day box.
-      \param y y-coordinate of the upper left coordinate of the day box.
-      \param width Width of the day box.
-      \param height Height of the day box.
-      \param fullDate Whether the title bar of the box should contain the full
-                      date string or just a short.
-      \param printRecurDaily Whether daily recurring incidences should be printed.
-      \param printRecurWeekly Whether weekly recurring incidences should be printed.
-    */
-    void drawDayBox( QPainter &p, const QDate &qd,
-                     int x, int y, int width, int height,
-                     bool fullDate = false, bool printRecurDaily = true,
-                     bool printRecurWeekly = true );
-    /**
-      Draw the week (filofax) table of the week containing the date qd. The first
-      three days of the week will be shown in the first column (using drawDayBox),
-      the remaining four in the second column, where the last two days of the week
-      (typically Saturday and Sunday) only get half the height of the other day boxes.
-      \param p QPainter of the printout
-      \param qd Arbitrary date within the week to be printed.
-      \param x x-coordinate of the upper left coordinate of the week.
-      \param y y-coordinate of the upper left coordinate of the week.
-      \param width Width of the week.
-      \param height Height of the week.
-    */
-    void drawWeek( QPainter &p, const QDate &qd,
-                   int x, int y, int width, int height );
-    /**
-      Draw the timetable view of the given time range from fromDate to toDate.
-      On the left side the time scale is printed (using drawTimeLine), then each
-      day gets one column (printed using drawAgendaDayBox),
-      and the events are displayed as boxes (like in korganizer's day/week view).
-      The first cell of each column contains the all-day events (using
-      drawAllDayBox with expandable=false).
-      The given time range cannot be expanded to include all events.
-      \param p QPainter of the printout
-      \param fromDate First day to be included in the page
-      \param toDate Last day to be included in the page
-      \param fromTime Start time of the displayed time range
-      \param toTime End time of the displayed time range
-      \param x x-coordinate of the upper left coordinate of the time table.
-      \param y y-coordinate of the upper left coordinate of the time table.
-      \param width Width of the time table.
-      \param height Height of the time table.
-    */
-    void drawTimeTable( QPainter &p, const QDate &fromDate, const QDate &toDate,
-                        QTime &fromTime, QTime &toTime,
-                        int x, int y, int width, int height );
-
-    /**
-      Draw the month table of the month containing the date qd. Each day gets one
-      box (using drawDayBox) that contains a list of all events on that day. They are arranged
-      in a matrix, with the first column being the first day of the
-      week (so it might display some days of the previous and the next month).
-      Above the matrix there is a bar showing the weekdays (drawn using drawDaysOfWeek).
-      \param p QPainter of the printout
-      \param qd Arbitrary date within the month to be printed.
-      \param recurDaily Whether daily recurring incidences should be printed.
-      \param recurWeekly Whether weekly recurring incidences should be printed.
-      \param weeknumbers Whether the week numbers are printed left of each row of the matrix
-      \param x x-coordinate of the upper left coordinate of the month.
-      \param y y-coordinate of the upper left coordinate of the month.
-      \param width Width of the month.
-      \param height Height of the month.
-    */
-    void drawMonth( QPainter &p, const QDate &qd, bool weeknumbers,
-                    bool recurDaily, bool recurWeekly,
-                    int x, int y, int width, int height );
-
-    /**
-      Draws single to-do and its (intented) sub-to-dos, optionally connects them by a tree-like line, and optionally shows due date, summary, description and priority.
-      \param count The number of the currently printed to-do (count will be incremented for each to-do drawn)
-      \param todo The to-do to be printed. It's sub-to-dos are recursively drawn, so drawTodo should only be called on the to-dos of the highest level.
-      \param p QPainter of the printout
-      \param sortField Specifies on which attribute of the todo you want to sort.
-      \param sortDir Specifies if you want to sort ascending or descending.
-      \param connectSubTodos Whether sub-to-dos shall be connected with their parent by a line (tree-like).
-      \param strikeoutCompleted Whether completed to-dos should be printed with strike-out summaries.
-      \param desc Whether to print the whole description of the to-do (the summary is always printed).
-      \param posPriority x-coordinate where the priority is supposed to be printed. If <0, no priority will be printed.
-      \param posSummary x-coordinate where the summary of the to-do is supposed to be printed.
-      \param posDueDt x-coordinate where the due date is supposed to the be printed. If <0, no due date will be printed.
-      \param posPercentComplete x-coordinate where the percentage complete is supposed to be printed. If <0, percentage complete will not be printed.
-      \param level Level of the current to-do in the to-do hierarchy (0 means highest level of printed to-dos, 1 are their sub-to-dos, etc.)
-      \param x x-coordinate of the upper left coordinate of the first to-do.
-      \param y y-coordinate of the upper left coordinate of the first to-do.
-      \param width width of the whole to-do list.
-      \param pageHeight Total height allowed for the to-do list on a page. If an to-do would be below that line, a new page is started.
-      \param todoList Contains a list of sub-todos for the specified @p todo .
-      \param r Internal (used when printing sub-to-dos to give information about its parent)
-    */
-    void drawTodo( int &count, Todo *todo, QPainter &p,
-                   TodoSortField sortField, SortDirection sortDir,
-                   bool connectSubTodos, bool strikeoutCompleted, bool desc,
-                   int posPriority, int posSummary, int posDueDt,
-                   int posPercentComplete, int level, int x, int &y,
-                   int width, int pageHeight,
-                   const Todo::List &todoList, TodoParentStart *r = 0 );
-
-    /**
-      Draws single journal item.
-      \param journal The item to be printed.
-      \param p QPainter of the printout
-      \param x x-coordinate of the upper left coordinate of the first item
-      \param y y-coordinate of the upper left coordinate of the first item
-      \param width width of the whole list
-      \param pageHeight Total height allowed for the list on a page. If an item
-                   would be below that line, a new page is started.
-    */
-    void drawJournal( Journal * journal, QPainter &p, int x, int &y,
-                      int width, int pageHeight );
-    void drawJournalField( QPainter &p, QString field, QString text,
-                           int x, int &y, int width, int pageHeight );
-
-    void drawSplitHeaderRight( QPainter &p, const QDate &fd, const QDate &td,
-                               const QDate &cd, int width, int height );
-
-
-  protected:
-    KPrinter *mPrinter;
-    Calendar *mCalendar;
-    KConfig *mConfig;
-    const KCalendarSystem *mCalSys;
-    KOrg::CoreHelper *mCoreHelper;
-
-    void drawIncidence( QPainter &p, QRect &dayBox, const QString &time,
-                        const QString &summary, int &textY );
-
-  public:
-    // FIXME: move these to the appropriate subclasses or set them globally.
-    int mHeaderHeight;
-    int mSubHeaderHeight;
-    int mMargin;
-};
-
-#endif
-
-#endif
Index: korganizer/printing/calprinthelper.cpp
===================================================================
--- korganizer/printing/calprinthelper.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprinthelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1,1130 +0,0 @@
-/*
-    This file is part of KOrganizer.
-
-    Copyright (c) 1998 Preston Brown <pbrown@kde.org>
-    Copyright (c) 2003 Reinhold Kainhofer <reinhold@kainhofer.com>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
-
-    As a special exception, permission is given to link this program
-    with any edition of Qt, and distribute the resulting executable,
-    without including the source code for Qt in the source distribution.
-*/
-
-#include <qpainter.h>
-#include <qlayout.h>
-#include <qframe.h>
-#include <qlabel.h>
-#include <qptrlist.h>
-#include <qintdict.h>
-
-#include <kglobal.h>
-#include <klocale.h>
-#include <kdebug.h>
-#include <kconfig.h>
-#include <kcalendarsystem.h>
-#include <kprinter.h>
-#include <kwordwrap.h>
-
-#include <libkcal/calendar.h>
-#include <libkcal/todo.h>
-#include <libkcal/event.h>
-
-#include "korganizer/corehelper.h"
-#include "cellitem.h"
-
-#include "calprinthelper.h"
-
-#ifndef KORG_NOPRINTER
-
-
-
-class CalPrintHelper::TodoParentStart
-{
-  public:
-    TodoParentStart( QRect pt = QRect(), bool page = true )
-      : mRect( pt ), mSamePage( page ) {}
-
-    QRect mRect;
-    bool mSamePage;
-};
-
-class PrintCellItem : public KOrg::CellItem
-{
-  public:
-    PrintCellItem( Event *event, const QDateTime &start, const QDateTime &end )
-      : mEvent( event ), mStart( start), mEnd( end )
-    {
-    }
-
-    Event *event() const { return mEvent; }
-
-    QString label() const { return mEvent->summary(); }
-
-    QDateTime start() const { return mStart; }
-    QDateTime end() const { return mEnd; }
-
-    /** Calculate the start and end date/time of the recurrence that
-        happens on the given day */
-    bool overlaps( KOrg::CellItem *o ) const
-    {
-      PrintCellItem *other = static_cast<PrintCellItem *>( o );
-
-#if 0
-      kdDebug(5850) << "PrintCellItem::overlaps() " << event()->summary()
-                    << " <-> " << other->event()->summary() << endl;
-      kdDebug(5850) << "  start     : " << start.toString() << endl;
-      kdDebug(5850) << "  end       : " << end.toString() << endl;
-      kdDebug(5850) << "  otherStart: " << otherStart.toString() << endl;
-      kdDebug(5850) << "  otherEnd  : " << otherEnd.toString() << endl;
-#endif
-
-      return !( other->start() >= end() || other->end() <= start() );
-    }
-
-  private:
-    Event *mEvent;
-    QDateTime mStart, mEnd;
-};
-
-CalPrintHelper::CalPrintHelper( KPrinter *pr, Calendar *cal, KConfig *cfg,
-                                KOrg::CoreHelper *corehelper )
-  : mPrinter( pr ), mCalendar( cal ), mConfig( cfg ),
-    mCoreHelper( corehelper ),
-    mHeaderHeight( 72 ), mSubHeaderHeight( 20 ), mMargin( 36 )
-{
-  if ( corehelper )
-    setCalendarSystem( mCoreHelper->calendarSystem() );
-}
-
-CalPrintHelper::~CalPrintHelper()
-{
-}
-
-
-
-void CalPrintHelper::setCategoryColors( QPainter &p, Incidence *incidence )
-{
-  if ( mCoreHelper ) {
-    QColor bgColor = mCoreHelper->categoryColor( incidence->categories() );
-    QColor textColor = mCoreHelper->textColor( bgColor );
-    p.setPen( textColor );
-    p.setBrush( bgColor );
-  }
-}
-
-
-
-///////////////////////////////////////////////////////////////////////////////
-
-void CalPrintHelper::drawHeader( QPainter &p, QString title,
-    const QDate &month1, const QDate &month2,
-    int x, int y, int width, int height )
-{
-  p.drawRect( x, y, width, height );
-  p.fillRect( x + 1, y + 1, width - 2, height - 2,
-              QBrush( Qt::Dense7Pattern ) );
-
-  int right=x+width;
-
-  // print previous month for month view, print current for to-do, day and week
-  int smallMonthWidth=width/4-10;
-  if (smallMonthWidth>100) smallMonthWidth=100;
-  if (month2.isValid()) {
-    right -= (10+smallMonthWidth);
-    drawSmallMonth(p, QDate(month2.year(), month2.month(), 1),
-                   right, y+2, smallMonthWidth, height-4);
-    right-=10;
-  }
-  if (month1.isValid()) {
-    right -= (10+smallMonthWidth);
-    drawSmallMonth(p, QDate(month1.year(), month1.month(), 1),
-                   right, y+2, smallMonthWidth, height-4);
-    right-=10;
-  }
-
-  // Print the titles...
-  QFont oldFont(p.font());
-  p.setFont( QFont("helvetica", 18, QFont::Bold) );
-  QRect textRect( x+5, y+5, right-10-x, height-10 );
-  p.drawText( textRect, Qt::AlignLeft | Qt::AlignTop | Qt::WordBreak, title );
-  p.setFont(oldFont);
-}
-
-
-void CalPrintHelper::drawSmallMonth(QPainter &p, const QDate &qd,
-    int x, int y, int width, int height)
-{
-  bool firstCol = true;
-  QDate monthDate(QDate(qd.year(), qd.month(), 1));
-  QDate monthDate2;
-  int month = monthDate.month();
-
-  // draw the title
-  QFont oldFont( p.font() );
-  p.setFont(QFont("helvetica", 8, QFont::Bold));
-  //  int lineSpacing = p.fontMetrics().lineSpacing();
-  if ( mCalSys )
-    p.drawText(x, y, width, height/4, Qt::AlignCenter,
-      mCalSys->monthName( qd ) );
-
-  int cellWidth = width/7;
-  int cellHeight = height/8;
-  QString tmpStr;
-
-  // correct begin of week
-  int weekdayCol = weekdayColumn( qd.dayOfWeek() );
-  monthDate2 = monthDate.addDays( -weekdayCol );
-
-  // draw days of week
-  if ( mCalSys ) {
-    for (int col = 0; col < 7; ++col) {
-      // tmpStr.sprintf("%c",(const char*)monthDate2.dayName(monthDate2.dayOfWeek()));
-      tmpStr=mCalSys->weekDayName( monthDate2 )[0].upper();
-      p.drawText( x + col*cellWidth, y + height/4, cellWidth, cellHeight,
-                 Qt::AlignCenter, tmpStr );
-      monthDate2 = monthDate2.addDays( 1 );
-    }
-  }
-
-  // draw separator line
-  p.drawLine( x, y + height/4 + cellHeight, x + width,
-      y + height/4 + cellHeight );
-
-  for ( int row = 0; row < 5; row++ ) {
-    for ( int col = 0; col < 7; col++ ) {
-      if ( monthDate.month() != month )
-        break;
-      if (firstCol) {
-        firstCol = true;
-        col = weekdayColumn( monthDate.dayOfWeek() );
-      }
-      p.drawText( x+col*cellWidth,
-                  y+height/4+cellHeight+(row*cellHeight),
-                  cellWidth, cellHeight, Qt::AlignCenter,
-                  tmpStr.setNum( monthDate.day() ) );
-      monthDate = monthDate.addDays(1);
-    }
-  }
-  p.setFont( oldFont );
-}
-
-
-///////////////////////////////////////////////////////////////////////////////
-
-/*
- * This routine draws a header box over the main part of the calendar
- * containing the days of the week.
- */
-void CalPrintHelper::drawDaysOfWeek(QPainter &p,
-    const QDate &fromDate, const QDate &toDate,
-    int x, int y, int width, int height)
-{
-  int cellWidth = width/(fromDate.daysTo( toDate )+1);
-  int currx=x;
-  QDate cellDate(fromDate);
-
-  while (cellDate<=toDate) {
-    drawDaysOfWeekBox(p, cellDate, currx, y, cellWidth, height);
-    currx+=cellWidth;
-    cellDate = cellDate.addDays(1);
-  }
-}
-
-
-void CalPrintHelper::drawDaysOfWeekBox(QPainter &p, const QDate &qd,
-    int x, int y, int width, int height)
-{
-  QFont oldFont( p.font() );
-  p.setFont( QFont( "helvetica", 10, QFont::Bold ) );
-  p.drawRect( x, y, width, height );
-  p.fillRect( x+1, y+1,
-              width-2, height-2,
-              QBrush( Qt::Dense7Pattern ) );
-  if ( mCalSys )
-    p.drawText( x+5, y, width-10, height, Qt::AlignCenter | Qt::AlignVCenter,
-             mCalSys->weekDayName( qd ) );
-  p.setFont( oldFont );
-}
-
-
-void CalPrintHelper::drawTimeLine(QPainter &p,
-    const QTime &fromTime, const QTime &toTime,
-    int x, int y, int width, int height)
-{
-  p.drawRect(x, y, width, height);
-
-  int totalsecs=fromTime.secsTo(toTime);
-  float minlen=(float)height*60./(float)totalsecs;
-  float cellHeight=(60.*(float)minlen);
-  float currY=y;
-
-  QTime curTime( fromTime );
-  QTime endTime( toTime );
-  if ( fromTime.minute() > 30 )
-    curTime = QTime( fromTime.hour()+1, 0, 0 );
-  else if ( fromTime.minute() > 0 ) {
-    curTime = QTime( fromTime.hour(), 30, 0 );
-    float yy = currY + minlen*(float)fromTime.secsTo( curTime )/60.;
-    p.drawLine( x+width/2, (int)yy, x+width, (int)yy );
-    curTime = QTime( fromTime.hour()+1, 0, 0 );
-  }
-  currY += ( fromTime.secsTo(curTime)*minlen/60 );
-
-  while ( curTime < endTime ) {
-    p.drawLine( x, (int)currY, x+width, (int)currY );
-    int newY=(int)(currY+cellHeight/2.);
-    QString numStr;
-    if (newY < y+height) {
-      QFont oldFont( p.font() );
-      p.drawLine(x+width/2, (int)newY, x+width, (int)newY);
-      // draw the time:
-      if ( !KGlobal::locale()->use12Clock() ) {
-        numStr.setNum(curTime.hour());
-        if (cellHeight > 30) {
-          p.setFont(QFont("helvetica", 16, QFont::Bold));
-        } else {
-          p.setFont(QFont("helvetica", 12, QFont::Bold));
-        }
-        p.drawText(x+2, (int)currY+2, width/2-2, (int)cellHeight,
-                  Qt::AlignTop | Qt::AlignRight, numStr);
-        p.setFont(QFont("helvetica", 10, QFont::Normal));
-        p.drawText(x+width/2, (int)currY+2, width/2+2, (int)(cellHeight/2)-3,
-                  Qt::AlignTop | Qt::AlignLeft, "00");
-      } else {
-        QTime time( curTime.hour(), 0 );
-        numStr = KGlobal::locale()->formatTime( time );
-        p.setFont(QFont("helvetica", 14, QFont::Bold));
-        p.drawText(x+2, (int)currY+2, width-4, (int)cellHeight/2-3,
-                  Qt::AlignTop|Qt::AlignLeft, numStr);
-      }
-      currY+=cellHeight;
-    p.setFont( oldFont );
-    } // enough space for half-hour line and time
-    if (curTime.secsTo(endTime)>3600)
-      curTime=curTime.addSecs(3600);
-    else curTime=endTime;
-  } // currTime<endTime
-}
-
-Event *CalPrintHelper::holiday( const QDate &dt )
-{
-#ifndef KORG_NOPLUGINS
-  if ( !mCoreHelper ) return 0;
-  QString hstring( mCoreHelper->holidayString( dt ) );
-  if ( !hstring.isEmpty() ) {
-    Event*holiday=new Event();
-    holiday->setDtStart( dt );
-    holiday->setDtEnd( dt );
-    holiday->setFloats( true );
-    holiday->setCategories( i18n("Holiday") );
-    return holiday;
-  }
-  return 0;
-#endif
-
-}
-
-///////////////////////////////////////////////////////////////////////////////
-
-/** prints the all-day box for the agenda print view. if expandable is set,
-    height is the cell height of a single cell, and the returned height will
-    be the total height used for the all-day events. If !expandable, only one
-    cell will be used, and multiple events are concatenated using ", ".
-*/
-void CalPrintHelper::drawAllDayBox(QPainter &p, Event::List &eventList,
-    const QDate &qd, bool expandable,
-    int x, int y, int width, int &height)
-{
-  Event::List::Iterator it, itold;
-
-  int offset=y;
-
-  QPen oldPen( p.pen() );
-  QColor oldBgColor( p.backgroundColor() );
-  QBrush oldBrush( p.brush() );
-  QString multiDayStr;
-
-  Event*hd = holiday( qd );
-  if ( hd ) eventList.prepend( hd );
-
-  it = eventList.begin();
-  Event *currEvent = 0;
-  // First, print all floating events
-  while( it!=eventList.end() ) {
-    currEvent=*it;
-    itold=it;
-    ++it;
-    if ( currEvent->doesFloat() ) {
-      // set the colors according to the categories
-      if ( expandable ) {
-        if ( mUseColors )
-          setCategoryColors( p, currEvent );
-
-        p.drawRect( x, offset, width, height );
-        p.drawText( x + 5, offset + 5, width - 10, height - 10,
-                    Qt::AlignCenter | Qt::AlignVCenter | Qt::AlignJustify |
-                    Qt::WordBreak,
-                    currEvent->summary() );
-        // reset the colors
-        p.setBrush( oldBrush );
-        p.setPen( oldPen );
-        p.setBackgroundColor( oldBgColor );
-
-        offset += height;
-      } else {
-        if ( !multiDayStr.isEmpty() ) multiDayStr += ", ";
-        multiDayStr += currEvent->summary() + "\n";
-      }
-      eventList.remove( itold );
-    }
-  }
-
-  if (!expandable) {
-    p.drawRect(x, offset, width, height);
-    if (!multiDayStr.isEmpty()) {
-      p.fillRect( x + 1, offset + 1, width - 2, height - 2,
-                  QBrush( Qt::Dense5Pattern ) );
-      p.drawText( x + 5, offset + 5, width - 10, height - 10,
-                  Qt::AlignCenter | Qt::AlignVCenter | Qt::AlignJustify |
-                  Qt::WordBreak,
-                  multiDayStr);
-    }
-  } else {
-    height=offset-y;
-  }
-  p.setBrush( oldBrush );
-}
-
-
-void CalPrintHelper::drawAgendaDayBox( QPainter &p, Event::List &events,
-                                     const QDate &qd, bool expandable,
-                                     QTime &fromTime, QTime &toTime,
-                                     int x, int y, int width, int height )
-{
-  p.drawRect( x, y, width, height );
-
-  Event *event;
-
-  if ( expandable ) {
-    // Adapt start/end times to include complete events
-    Event::List::ConstIterator it;
-    for ( it = events.begin(); it != events.end(); ++it ) {
-      event = *it;
-      if ( event->dtStart().time() < fromTime )
-        fromTime = event->dtStart().time();
-      if ( event->dtEnd().time() > toTime )
-        toTime = event->dtEnd().time();
-    }
-  }
-
-  // Show at least one hour
-  if ( fromTime.secsTo( toTime ) < 3600 ) {
-    fromTime = QTime( fromTime.hour(), 0, 0 );
-    toTime = fromTime.addSecs( 3600 );
-  }
-
-  // calculate the height of a cell and of a minute
-  int totalsecs = fromTime.secsTo( toTime );
-  float minlen = height * 60. / totalsecs;
-  float cellHeight = 60. * minlen;
-  float currY = y;
-
-  // print grid:
-  QTime curTime( QTime( fromTime.hour(), 0, 0 ) );
-  currY += fromTime.secsTo( curTime ) * minlen / 60;
-
-  while ( curTime < toTime && curTime.isValid() ) {
-    if ( currY > y ) p.drawLine( x, int( currY ), x + width, int( currY ) );
-    currY += cellHeight / 2;
-    if ( ( currY > y ) && ( currY < y + height ) ) {
-      QPen oldPen( p.pen() );
-      p.setPen( QColor( 192, 192, 192 ) );
-      p.drawLine( x, int( currY ), x + width, int( currY ) );
-      p.setPen( oldPen );
-    } // enough space for half-hour line
-    if ( curTime.secsTo( toTime ) > 3600 )
-      curTime = curTime.addSecs( 3600 );
-    else curTime = toTime;
-    currY += cellHeight / 2;
-  }
-
-  QDateTime startPrintDate = QDateTime( qd, fromTime );
-  QDateTime endPrintDate = QDateTime( qd, toTime );
-
-  // Calculate horizontal positions and widths of events taking into account
-  // overlapping events
-
-  QPtrList<KOrg::CellItem> cells;
-  cells.setAutoDelete( true );
-
-  Event::List::ConstIterator itEvents;
-  for( itEvents = events.begin(); itEvents != events.end(); ++itEvents ) {
-    QValueList<QDateTime> times = (*itEvents)->startDateTimesForDate( qd );
-    for ( QValueList<QDateTime>::ConstIterator it = times.begin();
-          it != times.end(); ++it ) {
-      cells.append( new PrintCellItem( *itEvents, (*it), (*itEvents)->endDateForStart( *it ) ) );
-    }
-  }
-
-  QPtrListIterator<KOrg::CellItem> it1( cells );
-  for( it1.toFirst(); it1.current(); ++it1 ) {
-    KOrg::CellItem *placeItem = it1.current();
-
-    KOrg::CellItem::placeItem( cells, placeItem );
-  }
-
-  QPen oldPen( p.pen() );
-  QColor oldBgColor( p.backgroundColor() );
-  QBrush oldBrush( p.brush() );
-  QFont oldFont( p.font() );
-
-  p.setFont( QFont( "helvetica", 10 ) );
-  p.setBrush( QBrush( Qt::Dense7Pattern ) );
-
-  for( it1.toFirst(); it1.current(); ++it1 ) {
-    PrintCellItem *placeItem = static_cast<PrintCellItem *>( it1.current() );
-
-    drawAgendaItem( placeItem, p, qd, startPrintDate, endPrintDate, minlen, x,
-                    y, width );
-
-    p.setBrush( oldBrush );
-    p.setPen( oldPen );
-    p.setBackgroundColor( oldBgColor );
-  }
-  p.setFont( oldFont );
-//  p.setBrush( QBrush( NoBrush ) );
-}
-
-
-void CalPrintHelper::drawAgendaItem( PrintCellItem *item, QPainter &p,
-                                   const QDate &qd,
-                                   const QDateTime &startPrintDate,
-                                   const QDateTime &endPrintDate,
-                                   float minlen, int x, int y, int width )
-{
-  Event *event = item->event();
-
-  // set the colors according to the categories
-  if ( mUseColors ) setCategoryColors( p, event );
-
-  // start/end of print area for event
-  QDateTime startTime = item->start();
-  QDateTime endTime = item->end();
-  if ( ( startTime < endPrintDate && endTime > startPrintDate ) ||
-       ( endTime > startPrintDate && startTime < endPrintDate ) ) {
-    if ( startTime < startPrintDate ) startTime = startPrintDate;
-    if ( endTime > endPrintDate ) endTime = endPrintDate;
-    int currentHeight = int( startTime.secsTo( endTime ) / 60. * minlen );
-    int currentYPos = int( y + startPrintDate.secsTo( startTime ) *
-                           minlen / 60. );
-    int currentWidth = width / item->subCells();
-    int currentX = x + item->subCell() * currentWidth;
-
-    p.drawRect( currentX, currentYPos, currentWidth, currentHeight );
-    int offset = 4;
-    // print the text vertically centered. If it doesn't fit inside the
-    // box, align it at the top so the beginning is visible
-    int flags = Qt::AlignLeft | Qt::WordBreak;
-    QRect bound = p.boundingRect ( currentX + offset, currentYPos,
-                                   currentWidth - 2 * offset, currentHeight,
-                                   flags, event->summary() );
-    flags |= Qt::AlignTop;
-    p.drawText( currentX+offset, currentYPos+offset, currentWidth-2*offset,
-                currentHeight-2*offset, flags, event->summary() );
-  }
-}
-
-void CalPrintHelper::drawDayBox( QPainter &p, const QDate &qd,
-    int x, int y, int width, int height,
-    bool fullDate, bool printRecurDaily, bool printRecurWeekly )
-{
-  QString dayNumStr;
-  QString ampm;
-  const KLocale*local = KGlobal::locale();
-
-
-  // This has to be localized
-  if ( fullDate && mCalSys ) {
-
-    dayNumStr = i18n("weekday month date", "%1 %2 %3")
-        .arg( mCalSys->weekDayName( qd ) )
-        .arg( mCalSys->monthName( qd ) )
-        .arg( qd.day() );
-//    dayNumStr = local->formatDate(qd);
-  } else {
-    dayNumStr = QString::number( qd.day() );
-  }
-
-  p.eraseRect( x, y, width, height );
-  QRect dayBox( x, y, width, height );
-  p.drawRect( dayBox );
-  p.drawRect( x, y, width, mSubHeaderHeight );
-  p.fillRect( x + 1, y + 1, width - 2, mSubHeaderHeight - 2,
-              QBrush( Qt::Dense7Pattern ) );
-  QString hstring;
-#ifndef KORG_NOPLUGINS
-  if ( mCoreHelper ) hstring = mCoreHelper->holidayString(qd);
-#endif
-  QFont oldFont( p.font() );
-
-  if (!hstring.isEmpty()) {
-    p.setFont( QFont( "helvetica", 8, QFont::Bold, true ) );
-
-    p.drawText( x+5, y, width-25, mSubHeaderHeight,
-                Qt::AlignLeft | Qt::AlignVCenter, hstring );
-  }
-  p.setFont(QFont("helvetica", 10, QFont::Bold));
-  p.drawText( x + 5, y, width - 10, mSubHeaderHeight,
-              Qt::AlignRight | Qt::AlignVCenter, dayNumStr);
-
-  Event::List eventList = mCalendar->events( qd,
-                                             EventSortStartDate,
-                                             SortDirectionAscending );
-  QString text;
-  p.setFont( QFont( "helvetica", 8 ) );
-
-  int textY=mSubHeaderHeight+3; // gives the relative y-coord of the next printed entry
-  Event::List::ConstIterator it;
-
-  for( it = eventList.begin(); it != eventList.end() && textY<height; ++it ) {
-    Event *currEvent = *it;
-    if ( ( !printRecurDaily  && currEvent->recurrenceType() == Recurrence::rDaily  ) ||
-         ( !printRecurWeekly && currEvent->recurrenceType() == Recurrence::rWeekly ) ) {
-      continue; }
-    if ( currEvent->doesFloat() || currEvent->isMultiDay() )
-      text = "";
-    else
-      text = local->formatTime( currEvent->dtStart().time() );
-
-    drawIncidence( p, dayBox, text, currEvent->summary(), textY );
-  }
-
-  if ( textY<height ) {
-    Todo::List todos = mCalendar->todos( qd );
-    Todo::List::ConstIterator it2;
-    for( it2 = todos.begin(); it2 != todos.end() && textY<height; ++it2 ) {
-      Todo *todo = *it2;
-      if ( ( !printRecurDaily  && todo->recurrenceType() == Recurrence::rDaily  ) ||
-           ( !printRecurWeekly && todo->recurrenceType() == Recurrence::rWeekly ) )
-        continue;
-      if ( todo->hasDueDate() && !todo->doesFloat() )
-        text += KGlobal::locale()->formatTime(todo->dtDue().time()) + " ";
-      else
-        text = "";
-      drawIncidence( p, dayBox, text, i18n("To-do: %1").arg(todo->summary()), textY );
-    }
-  }
-
-  p.setFont( oldFont );
-}
-
-void CalPrintHelper::drawIncidence( QPainter &p, QRect &dayBox, const QString &time, const QString &summary, int &textY )
-{
-  kdDebug(5850) << "summary = " << summary << endl;
-
-  int flags = Qt::AlignLeft;
-  QFontMetrics fm = p.fontMetrics();
-  QRect timeBound = p.boundingRect( dayBox.x() + 5, dayBox.y() + textY,
-                                    dayBox.width() - 10, fm.lineSpacing(),
-                                    flags, time );
-  p.drawText( timeBound, flags, time );
-
-  int summaryWidth = time.isEmpty() ? 0 : timeBound.width() + 4;
-  QRect summaryBound = QRect( dayBox.x() + 5 + summaryWidth, dayBox.y() + textY,
-                              dayBox.width() - summaryWidth -5, dayBox.height() );
-
-  KWordWrap *ww = KWordWrap::formatText( fm, summaryBound, flags, summary );
-  ww->drawText( &p, dayBox.x() + 5 + summaryWidth, dayBox.y() + textY, flags );
-
-  textY += ww->boundingRect().height();
-
-  delete ww;
-}
-
-
-///////////////////////////////////////////////////////////////////////////////
-
-void CalPrintHelper::drawWeek(QPainter &p, const QDate &qd,
-    int x, int y, int width, int height)
-{
-  QDate weekDate = qd;
-  bool portrait = ( height > width );
-  int cellWidth, cellHeight;
-  int vcells;
-  if (portrait) {
-    cellWidth = width/2;
-    vcells=3;
-  } else {
-    cellWidth = width/6;
-    vcells=1;
-  }
-  cellHeight = height/vcells;
-
-  // correct begin of week
-  int weekdayCol = weekdayColumn( qd.dayOfWeek() );
-  weekDate = qd.addDays( -weekdayCol );
-
-  for (int i = 0; i < 7; i++, weekDate = weekDate.addDays(1)) {
-    if (i<5) {
-      drawDayBox(p, weekDate, x+cellWidth*(int)(i/vcells), y+cellHeight*(i%vcells),
-        cellWidth, cellHeight, true);
-    } else if (i==5) {
-      drawDayBox(p, weekDate, x+cellWidth*(int)(i/vcells), y+cellHeight*(i%vcells),
-        cellWidth, cellHeight/2, true);
-    } else if (i==6) {
-      drawDayBox(p, weekDate, x+cellWidth*(int)((i-1)/vcells),
-        y+cellHeight*((i-1)%vcells)+cellHeight/2, cellWidth, cellHeight/2, true);
-    }
-  } // for i through all weekdays
-}
-
-
-void CalPrintHelper::drawTimeTable(QPainter &p,
-    const QDate &fromDate, const QDate &toDate,
-    QTime &fromTime, QTime &toTime,
-    int x, int y, int width, int height)
-{
-  // timeline is 1.5 hours:
-  int alldayHeight = (int)( 3600.*height/(fromTime.secsTo(toTime)+3600.) );
-  int timelineWidth = 50;
-  int cellWidth = (int)( (width-timelineWidth)/(fromDate.daysTo(toDate)+1) );
-  int currY=y;
-  int currX=x;
-
-  drawDaysOfWeek( p, fromDate, toDate, x+timelineWidth, currY, width-timelineWidth, mSubHeaderHeight);
-  currY+=mSubHeaderHeight;
-  drawTimeLine( p, fromTime, toTime, x, currY+alldayHeight,
-    timelineWidth, height-mSubHeaderHeight-alldayHeight );
-
-  currX=x+timelineWidth;
-  // draw each day
-  QDate curDate(fromDate);
-  while (curDate<=toDate) {
-    Event::List eventList = mCalendar->events(curDate,
-                                              EventSortStartDate,
-                                              SortDirectionAscending);
-    drawAllDayBox( p, eventList, curDate, false, currX, currY, cellWidth, alldayHeight);
-    drawAgendaDayBox( p, eventList, curDate, false, fromTime, toTime, currX,
-      currY+alldayHeight, cellWidth, height-mSubHeaderHeight-alldayHeight );
-    currX+=cellWidth;
-    curDate=curDate.addDays(1);
-  }
-
-}
-
-
-///////////////////////////////////////////////////////////////////////////////
-
-void CalPrintHelper::drawMonth(QPainter &p, const QDate &qd, bool weeknumbers,
-                               bool recurDaily, bool recurWeekly, int x, int y,
-                               int width, int height)
-{
-  int yoffset = mSubHeaderHeight;
-  int xoffset = 0;
-  QDate monthDate(QDate(qd.year(), qd.month(), 1));
-  QDate monthFirst(monthDate);
-  QDate monthLast(monthDate.addMonths(1).addDays(-1));
-
-
-  int weekdayCol = weekdayColumn( monthDate.dayOfWeek() );
-  monthDate = monthDate.addDays(-weekdayCol);
-
-  int rows=(weekdayCol + qd.daysInMonth() - 1)/7 +1;
-  int cellHeight = (height-yoffset) / rows;
-
-  if (weeknumbers) {
-    QFont oldFont(p.font());
-    QFont newFont(p.font());
-    newFont.setPointSize(6);
-    p.setFont(newFont);
-    xoffset += 14;
-    QDate weekDate(monthDate);
-    for (int row = 0; row<rows; ++row ) {
-      int calWeek = weekDate.weekNumber();
-      QRect rc( x, y + yoffset + cellHeight*row, xoffset - 1, cellHeight );
-      p.drawText( rc, Qt::AlignRight | Qt::AlignVCenter,
-                  QString::number( calWeek ) );
-      weekDate = weekDate.addDays( 7 );
-    }
-    p.setFont( oldFont );
-  }
-
-  drawDaysOfWeek( p, monthDate, monthDate.addDays( 6 ), x + xoffset,
-                  y, width - xoffset, mSubHeaderHeight );
-  int cellWidth = ( width - xoffset ) / 7;
-
-  QColor back = p.backgroundColor();
-  bool darkbg = false;
-  for ( int row = 0; row < rows; ++row ) {
-    for ( int col = 0; col < 7; ++col ) {
-      // show days from previous/next month with a grayed background
-      if ( (monthDate < monthFirst) || (monthDate > monthLast) ) {
-        p.setBackgroundColor( back.dark( 120 ) );
-        darkbg = true;
-      }
-      drawDayBox(p, monthDate, x+xoffset+col*cellWidth, y+yoffset+row*cellHeight,
-                 cellWidth, cellHeight, false,  recurDaily, recurWeekly );
-      if ( darkbg ) {
-        p.setBackgroundColor( back );
-        darkbg = false;
-      }
-      monthDate = monthDate.addDays(1);
-    }
-  }
-}
-
-
-///////////////////////////////////////////////////////////////////////////////
-
-void CalPrintHelper::drawTodo( int &count, Todo *todo, QPainter &p,
-                               TodoSortField sortField, SortDirection sortDir,
-                               bool connectSubTodos, bool strikeoutCompleted,
-                               bool desc, int posPriority, int posSummary,
-                               int posDueDt, int posPercentComplete,
-                               int level, int x, int &y, int width,
-                               int pageHeight, const Todo::List &todoList,
-                               TodoParentStart *r )
-{
-  QString outStr;
-  const KLocale *local = KGlobal::locale();
-  QRect rect;
-  TodoParentStart startpt;
-
-  // This list keeps all starting points of the parent to-dos so the connection
-  // lines of the tree can easily be drawn (needed if a new page is started)
-  static QPtrList<TodoParentStart> startPoints;
-  if ( level < 1 ) {
-    startPoints.clear();
-  }
-
-  // Compute the right hand side of the to-do box
-  int rhs = posPercentComplete;
-  if ( rhs < 0 ) rhs = posDueDt; //not printing percent completed
-  if ( rhs < 0 ) rhs = x+width;  //not printing due dates either
-
-  // size of to-do
-  outStr=todo->summary();
-  int left = posSummary + ( level*10 );
-  rect = p.boundingRect( left, y, ( rhs-left-5 ), -1, Qt::WordBreak, outStr );
-  if ( !todo->description().isEmpty() && desc ) {
-    outStr = todo->description();
-    rect = p.boundingRect( left+20, rect.bottom()+5, width-(left+10-x), -1,
-                           Qt::WordBreak, outStr );
-  }
-  // if too big make new page
-  if ( rect.bottom() > pageHeight ) {
-    // first draw the connection lines from parent to-dos:
-    if ( level > 0 && connectSubTodos ) {
-      TodoParentStart *rct;
-      for ( rct = startPoints.first(); rct; rct = startPoints.next() ) {
-        int start;
-        int center = rct->mRect.left() + (rct->mRect.width()/2);
-        int to = p.viewport().bottom();
-
-        // draw either from start point of parent or from top of the page
-        if ( rct->mSamePage )
-          start = rct->mRect.bottom() + 1;
-        else
-          start = p.viewport().top();
-        p.moveTo( center, start );
-        p.lineTo( center, to );
-        rct->mSamePage = false;
-      }
-    }
-    y=0;
-    mPrinter->newPage();
-  }
-
-  // If this is a sub-to-do, r will not be 0, and we want the LH side
-  // of the priority line up to the RH side of the parent to-do's priority
-  bool showPriority = posPriority>=0;
-  int lhs = posPriority;
-  if ( r ) {
-    lhs = r->mRect.right() + 1;
-  }
-
-  outStr.setNum( todo->priority() );
-  rect = p.boundingRect( lhs, y + 10, 5, -1, Qt::AlignCenter, outStr );
-  // Make it a more reasonable size
-  rect.setWidth(18);
-  rect.setHeight(18);
-
-  // Draw a checkbox
-  p.setBrush( QBrush( Qt::NoBrush ) );
-  p.drawRect( rect );
-  if ( todo->isCompleted() ) {
-    // cross out the rectangle for completed to-dos
-    p.drawLine( rect.topLeft(), rect.bottomRight() );
-    p.drawLine( rect.topRight(), rect.bottomLeft() );
-  }
-  lhs = rect.right() + 3;
-
-  // Priority
-  if ( todo->priority() > 0 && showPriority ) {
-    p.drawText( rect, Qt::AlignCenter, outStr );
-  }
-  startpt.mRect = rect; //save for later
-
-  // Connect the dots
-  if ( level > 0 && connectSubTodos ) {
-    int bottom;
-    int center( r->mRect.left() + (r->mRect.width()/2) );
-    if ( r->mSamePage )
-      bottom = r->mRect.bottom() + 1;
-    else
-      bottom = 0;
-    int to( rect.top() + (rect.height()/2) );
-    int endx( rect.left() );
-    p.moveTo( center, bottom );
-    p.lineTo( center, to );
-    p.lineTo( endx, to );
-  }
-
-  // summary
-  outStr=todo->summary();
-  rect = p.boundingRect( lhs, rect.top(), (rhs-(left + rect.width() + 5)),
-                         -1, Qt::WordBreak, outStr );
-
-  QRect newrect;
-  //FIXME: the following code prints underline rather than strikeout text
-#if 0
-  QFont f( p.font() );
-  if ( todo->isCompleted() && strikeoutCompleted ) {
-    f.setStrikeOut( true );
-    p.setFont( f );
-  }
-  p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
-  f.setStrikeOut( false );
-  p.setFont( f );
-#endif
-  //TODO: Remove this section when the code above is fixed
-  p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
-  if ( todo->isCompleted() && strikeoutCompleted ) {
-    // strike out the summary text if to-do is complete
-    // Note: we tried to use a strike-out font and for unknown reasons the
-    // result was underline instead of strike-out, so draw the lines ourselves.
-    int delta = p.fontMetrics().lineSpacing();
-    int lines = ( rect.height() / delta ) + 1;
-    for ( int i=0; i<lines; i++ ) {
-      p.moveTo( rect.left(),  rect.top() + ( delta/2 ) + ( i*delta ) );
-      p.lineTo( rect.right(), rect.top() + ( delta/2 ) + ( i*delta ) );
-    }
-  }
-
-  // due date
-  if ( todo->hasDueDate() && posDueDt>=0 ) {
-    outStr = local->formatDate( todo->dtDue().date(), true );
-    rect = p.boundingRect( posDueDt, y, x + width, -1,
-                           Qt::AlignTop | Qt::AlignLeft, outStr );
-    p.drawText( rect, Qt::AlignTop | Qt::AlignLeft, outStr );
-  }
-
-  // percentage completed
-  bool showPercentComplete = posPercentComplete>=0;
-  if ( showPercentComplete ) {
-    int lwidth = 24;
-    int lheight = 12;
-    //first, draw the progress bar
-    int progress = (int)(( lwidth*todo->percentComplete())/100.0 + 0.5);
-
-    p.setBrush( QBrush( Qt::NoBrush ) );
-    p.drawRect( posPercentComplete, y+3, lwidth, lheight );
-    if ( progress > 0 ) {
-      p.setBrush( QBrush( Qt::Dense5Pattern ) );
-      p.drawRect( posPercentComplete, y+3, progress, lheight );
-    }
-
-    //now, write the percentage
-    outStr = i18n( "%1%" ).arg( todo->percentComplete() );
-    rect = p.boundingRect( posPercentComplete+lwidth+3, y, x + width, -1,
-                           Qt::AlignTop | Qt::AlignLeft, outStr );
-    p.drawText( rect, Qt::AlignTop | Qt::AlignLeft, outStr );
-  }
-
-  // description
-  if ( !todo->description().isEmpty() && desc ) {
-    y = newrect.bottom() + 5;
-    outStr = todo->description();
-    rect = p.boundingRect( left+20, y, x+width-(left+10), -1,
-                           Qt::WordBreak, outStr );
-    p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
-  }
-
-  // Set the new line position
-  y = newrect.bottom() + 10; //set the line position
-
-  // If the to-do has sub-to-dos, we need to call ourselves recursively
-#if 0
-  Incidence::List l = todo->relations();
-  Incidence::List::ConstIterator it;
-  startPoints.append( &startpt );
-  for( it = l.begin(); it != l.end(); ++it ) {
-    count++;
-    // In the future, to-dos might also be related to events
-    // Manually check if the sub-to-do is in the list of to-dos to print
-    // The problem is that relations() does not apply filters, so
-    // we need to compare manually with the complete filtered list!
-    Todo* subtodo = dynamic_cast<Todo *>( *it );
-    if (subtodo && todoList.contains( subtodo ) ) {
-      drawTodo( count, subtodo, p, connectSubTodos, strikeoutCompleted,
-                desc, posPriority, posSummary, posDueDt, posPercentComplete,
-                level+1, x, y, width, pageHeight, todoList, &startpt );
-    }
-  }
-#endif
-  // Make a list of all the sub-to-dos related to this to-do.
-  Todo::List t;
-  Incidence::List l = todo->relations();
-  Incidence::List::ConstIterator it;
-  for( it=l.begin(); it!=l.end(); ++it ) {
-    // In the future, to-dos might also be related to events
-    // Manually check if the sub-to-do is in the list of to-dos to print
-    // The problem is that relations() does not apply filters, so
-    // we need to compare manually with the complete filtered list!
-    Todo* subtodo = dynamic_cast<Todo *>( *it );
-    if ( subtodo && todoList.contains( subtodo ) ) {
-      t.append( subtodo );
-    }
-  }
-
-  // Sort the sub-to-dos and then print them
-  Todo::List sl = mCalendar->sortTodos( &t, sortField, sortDir );
-  Todo::List::ConstIterator isl;
-  startPoints.append( &startpt );
-  for( isl = sl.begin(); isl != sl.end(); ++isl ) {
-    count++;
-    drawTodo( count, ( *isl ), p, sortField,  sortDir,
-              connectSubTodos, strikeoutCompleted,
-              desc, posPriority, posSummary, posDueDt, posPercentComplete,
-              level+1, x, y, width, pageHeight, todoList, &startpt );
-  }
-  startPoints.remove( &startpt );
-}
-
-int CalPrintHelper::weekdayColumn( int weekday )
-{
-  return ( weekday + 7 - KGlobal::locale()->weekStartDay() ) % 7;
-}
-
-void CalPrintHelper::drawJournalField( QPainter &p, QString field, QString text,
-                                       int x, int &y, int width, int pageHeight )
-{
-  if ( text.isEmpty() ) return;
-
-  QString entry( field.arg( text ) );
-
-  QRect rect( p.boundingRect( x, y, width, -1, Qt::WordBreak, entry) );
-  if ( rect.bottom() > pageHeight) {
-    // Start new page...
-    // FIXME: If it's a multi-line text, draw a few lines on this page, and the
-    // remaining lines on the next page.
-    y=0;
-    mPrinter->newPage();
-    rect = p.boundingRect( x, y, width, -1, Qt::WordBreak, entry);
-  }
-  QRect newrect;
-  p.drawText( rect, Qt::WordBreak, entry, -1, &newrect );
-  y = newrect.bottom() + 7;
-}
-
-void CalPrintHelper::drawJournal( Journal * journal, QPainter &p, int x, int &y,
-                                  int width, int pageHeight )
-{
-  QFont oldFont( p.font() );
-  p.setFont( QFont( "helvetica", 15 ) );
-  QString headerText;
-  QString dateText( KGlobal::locale()->
-        formatDate( journal->dtStart().date(), false ) );
-
-  if ( journal->summary().isEmpty() ) {
-    headerText = dateText;
-  } else {
-    headerText = i18n("Description - date", "%1 - %2")
-                     .arg( journal->summary() )
-                     .arg( dateText );
-  }
-
-  QRect rect( p.boundingRect( x, y, width, -1, Qt::WordBreak, headerText) );
-  if ( rect.bottom() > pageHeight) {
-    // Start new page...
-    y=0;
-    mPrinter->newPage();
-    rect = p.boundingRect( x, y, width, -1, Qt::WordBreak, headerText );
-  }
-  QRect newrect;
-  p.drawText( rect, Qt::WordBreak, headerText, -1, &newrect );
-  p.setFont( oldFont );
-
-  y = newrect.bottom() + 4;
-
-  p.drawLine( x + 3, y, x + width - 6, y );
-  y += 5;
-
-  drawJournalField( p, i18n("Person: %1"), journal->organizer().fullName(), x, y, width, pageHeight );
-  drawJournalField( p, i18n("%1"), journal->description(), x, y, width, pageHeight );
-  y += 10;
-}
-
-
-void CalPrintHelper::drawSplitHeaderRight( QPainter &p, const QDate &fd,
-                                           const QDate &td,
-                                           const QDate &,
-                                           int width, int )
-{
-  QFont oldFont( p.font() );
-
-  QPen oldPen( p.pen() );
-  QPen pen( Qt::black, 4 );
-
-  QString title;
-  if ( mCalSys ) {
-    if ( fd.month() == td.month() ) {
-      title = i18n("Date range: Month dayStart - dayEnd", "%1 %2 - %3")
-        .arg( mCalSys->monthName( fd.month(), false ) )
-        .arg( mCalSys->dayString( fd, false ) )
-        .arg( mCalSys->dayString( td, false ) );
-    } else {
-      title = i18n("Date range: monthStart dayStart - monthEnd dayEnd", "%1 %2 - %3 %4")
-        .arg( mCalSys->monthName( fd.month(), false ) )
-        .arg( mCalSys->dayString( fd, false ) )
-        .arg( mCalSys->monthName( td.month(), false ) )
-        .arg( mCalSys->dayString( td, false ) );
-    }
-  }
-
-  QFont serifFont("Times", 30);
-  p.setFont(serifFont);
-
-  int lineSpacing = p.fontMetrics().lineSpacing();
-  p.drawText( 0, lineSpacing * 0, width, lineSpacing,
-              Qt::AlignRight | Qt::AlignTop, title );
-
-  title.truncate(0);
-
-  p.setPen( pen );
-  p.drawLine(300, lineSpacing * 1, width, lineSpacing * 1);
-  p.setPen( oldPen );
-
-  p.setFont(QFont("Times", 20, QFont::Bold, TRUE));
-  int newlineSpacing = p.fontMetrics().lineSpacing();
-  title += QString::number(fd.year());
-  p.drawText( 0, lineSpacing * 1 + 4, width, newlineSpacing,
-              Qt::AlignRight | Qt::AlignTop, title );
-
-  p.setFont( oldFont );
-}
-
-#endif
Index: korganizer/printing/calprintdefaultplugins.cpp
===================================================================
--- korganizer/printing/calprintdefaultplugins.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprintdefaultplugins.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,27 +28,19 @@
 
 #include <qpainter.h>
 #include <qdatetimeedit.h>
-#include <qdatetime.h>
 #include <qcheckbox.h>
 #include <qlineedit.h>
 #include <qbuttongroup.h>
 
-#include <kglobal.h>
-#include <klocale.h>
 #include <kdebug.h>
-#include <kprinter.h>
 #include <kconfig.h>
 #include <kcalendarsystem.h>
+#include <knuminput.h>
+#include <kcombobox.h>
 
-#include <libkcal/todo.h>
-#include <libkcal/calendar.h>
-
-#include <libkdepim/kdateedit.h>
-
-#include "calprinthelper.h"
-#include "calprintpluginbase.h"
 #include "calprintdefaultplugins.h"
 
+#include "calprintincidenceconfig_base.h"
 #include "calprintdayconfig_base.h"
 #include "calprintweekconfig_base.h"
 #include "calprintmonthconfig_base.h"
@@ -56,6 +48,432 @@
 
 
 /**************************************************************
+ *           Print Incidence
+ **************************************************************/
+
+CalPrintIncidence::CalPrintIncidence() : CalPrintPluginBase()
+{
+}
+
+CalPrintIncidence::~CalPrintIncidence()
+{
+}
+
+QWidget *CalPrintIncidence::createConfigWidget( QWidget *w )
+{
+  return new CalPrintIncidenceConfig_Base( w );
+}
+
+void CalPrintIncidence::readSettingsWidget()
+{
+  CalPrintIncidenceConfig_Base *cfg =
+      dynamic_cast<CalPrintIncidenceConfig_Base*>( mConfigWidget );
+  if ( cfg ) {
+    mUseColors = cfg->mColors->isChecked();
+    mShowOptions = cfg->mShowDetails->isChecked();
+    mShowSubitemsNotes = cfg->mShowSubitemsNotes->isChecked();
+    mShowAttendees = cfg->mShowAttendees->isChecked();
+    mShowAttachments = cfg->mShowAttachments->isChecked();
+  }
+}
+
+void CalPrintIncidence::setSettingsWidget()
+{
+  CalPrintIncidenceConfig_Base *cfg =
+      dynamic_cast<CalPrintIncidenceConfig_Base*>( mConfigWidget );
+  if ( cfg ) {
+    cfg->mColors->setChecked( mUseColors );
+    cfg->mShowDetails->setChecked(mShowOptions);
+    cfg->mShowSubitemsNotes->setChecked(mShowSubitemsNotes);
+    cfg->mShowAttendees->setChecked(mShowAttendees);
+    cfg->mShowAttachments->setChecked(mShowAttachments);
+  }
+}
+
+void CalPrintIncidence::loadConfig()
+{
+  if ( mConfig ) {
+    mUseColors = mConfig->readBoolEntry( "Use Colors", false );
+    mShowOptions = mConfig->readBoolEntry( "Show Options", false );
+    mShowSubitemsNotes = mConfig->readBoolEntry( "Show Subitems and Notes", false );
+    mShowAttendees = mConfig->readBoolEntry( "Use Attendees", false );
+    mShowAttachments = mConfig->readBoolEntry( "Use Attachments", false );
+  }
+  setSettingsWidget();
+}
+
+void CalPrintIncidence::saveConfig()
+{
+  readSettingsWidget();
+  if ( mConfig ) {
+    mConfig->writeEntry( "Use Colors", mUseColors );
+    mConfig->writeEntry( "Show Options", mShowOptions );
+    mConfig->writeEntry( "Show Subitems and Notes", mShowSubitemsNotes );
+    mConfig->writeEntry( "Use Attendees", mShowAttendees );
+    mConfig->writeEntry( "Use Attachments", mShowAttachments );
+  }
+}
+
+
+class TimePrintStringsVisitor : public IncidenceBase::Visitor
+{
+  public:
+    TimePrintStringsVisitor() {}
+
+    bool act( IncidenceBase *incidence )
+    {
+      return incidence->accept( *this );
+    }
+    QString mStartCaption, mStartString;
+    QString mEndCaption, mEndString;
+    QString mDurationCaption, mDurationString;
+
+  protected:
+    bool visit( Event *event ) {
+      if ( event->dtStart().isValid() ) {
+        mStartCaption =  i18n("Start date: ");
+        // Show date/time or only date, depending on whether it's an all-day event
+// TODO: Add shortfmt param to dtStartStr, dtEndStr and dtDueStr!!!
+        mStartString = (event->doesFloat()) ? (event->dtStartDateStr(false)) : (event->dtStartStr());
+      } else {
+        mStartCaption = i18n("No start date");
+        mStartString = QString::null;
+      }
+    
+      if ( event->hasEndDate() ) {
+        mEndCaption = i18n("End date: ");
+        mEndString = (event->doesFloat()) ? (event->dtEndDateStr(false)) : (event->dtEndStr());
+      } else if ( event->hasDuration() ) {
+        mEndCaption = i18n("Duration: ");
+        int mins = event->duration() / 60;
+        if ( mins >= 60 ) {
+          mEndString += i18n( "1 hour ", "%n hours ", mins/60 );
+        }
+        if ( mins%60 > 0 ) {
+          mEndString += i18n( "1 minute ", "%n minutes ",  mins%60 );
+        }
+      } else {
+        mEndCaption = i18n("No end date");
+        mEndString = QString::null;
+      }
+      return true;
+    }
+    bool visit( Todo *todo ) {
+      if ( todo->hasStartDate() ) {
+        mStartCaption =  i18n("Start date: ");
+        // Show date/time or only date, depending on whether it's an all-day event
+// TODO: Add shortfmt param to dtStartStr, dtEndStr and dtDueStr!!!
+        mStartString = (todo->doesFloat()) ? (todo->dtStartDateStr(false)) : (todo->dtStartStr());
+      } else {
+        mStartCaption = i18n("No start date");
+        mStartString = QString::null;
+      }
+    
+      if ( todo->hasDueDate() ) {
+        mEndCaption = i18n("Due date: ");
+        mEndString = (todo->doesFloat()) ? (todo->dtDueDateStr(false)) : (todo->dtDueStr());
+      } else {
+        mEndCaption = i18n("No due date");
+        mEndString = QString::null;
+      }
+      return true;
+    }
+    bool visit( Journal *journal ) {
+      mStartCaption = i18n("Start date: ");
+// TODO: Add shortfmt param to dtStartStr, dtEndStr and dtDueStr!!!
+      mStartString = (journal->doesFloat()) ? (journal->dtStartDateStr(false)) : (journal->dtStartStr());
+      mEndCaption = QString::null;
+      mEndString = QString::null;
+      return true;
+    }
+};
+
+int CalPrintIncidence::printCaptionAndText( QPainter &p, const QRect &box, const QString &caption, const QString &text, QFont captionFont, QFont textFont )
+{
+  QFontMetrics captionFM( captionFont );
+  int textWd = captionFM.width( caption );
+  QRect textRect( box );
+
+  QFont oldFont( p.font() );
+  p.setFont( captionFont );
+  p.drawText( box, Qt::AlignLeft|Qt::AlignTop|Qt::SingleLine, caption );
+
+  if ( !text.isEmpty() ) {
+    textRect.setLeft( textRect.left() + textWd );
+    p.setFont( textFont );
+    p.drawText( textRect, Qt::AlignLeft|Qt::AlignTop|Qt::SingleLine, text );
+  }
+  p.setFont( oldFont );
+  return textRect.bottom();
+}
+
+#include <qfontdatabase.h>
+void CalPrintIncidence::print( QPainter &p, int width, int height )
+{
+  KLocale *local = KGlobal::locale();
+
+  QFont oldFont(p.font());
+  QFont textFont( "sans-serif", 11, QFont::Normal );
+  QFont captionFont( "sans-serif", 11, QFont::Bold );
+  p.setFont( textFont );
+  int lineHeight = p.fontMetrics().lineSpacing();
+  QString cap, txt;
+
+
+  Incidence::List::ConstIterator it;
+  for ( it=mSelectedIncidences.begin(); it!=mSelectedIncidences.end(); ++it ) {
+    // don't do anything on a 0-pointer!
+    if ( !(*it) ) continue;
+    if ( it != mSelectedIncidences.begin() ) mPrinter->newPage();
+
+
+    // PAGE Layout (same for landscape and portrait! astonishingly, it looks good with both!):
+    //  +-----------------------------------+
+    //  | Header:  Summary                  |
+    //  +===================================+
+    //  | start: ______   end: _________    |
+    //  | repeats: ___________________      |
+    //  | reminder: __________________      |
+    //  +-----------------------------------+
+    //  | Location: ______________________  |
+    //  +------------------------+----------+
+    //  | Description:           | Notes or |
+    //  |                        | Subitems |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  |                        |          |
+    //  +------------------------+----------+
+    //  | Attachments:           | Settings |
+    //  |                        |          |
+    //  +------------------------+----------+
+    //  | Attendees:                        |
+    //  |                                   |
+    //  +-----------------------------------+
+    //  | Categories: _____________________ |
+    //  +-----------------------------------+
+
+    QRect box( 0, 0, width, height );
+    QRect titleBox( box );
+    titleBox.setHeight( headerHeight() );
+    // Draw summary as header, no small calendars in title bar, expand height if needed
+    int titleBottom = drawHeader( p, (*it)->summary(), QDate(), QDate(), titleBox, true );
+    titleBox.setBottom( titleBottom );
+
+    QRect timesBox( titleBox );
+    timesBox.setTop( titleBox.bottom() + padding() );
+    timesBox.setHeight( height / 8 );
+    
+    TimePrintStringsVisitor stringVis;
+    int h = timesBox.top();
+    if ( stringVis.act(*it) ) {
+      QRect textRect( timesBox.left()+padding(), timesBox.top()+padding(), 0, lineHeight );
+      textRect.setRight( timesBox.center().x() );
+      h = printCaptionAndText( p, textRect, stringVis.mStartCaption, stringVis.mStartString, captionFont, textFont );
+
+      textRect.setLeft( textRect.right() );
+      textRect.setRight( timesBox.right() - padding() );
+      h = QMAX( printCaptionAndText( p, textRect, stringVis.mEndCaption, stringVis.mEndString, captionFont, textFont ), h );
+    }
+    
+    
+    if ( (*it)->doesRecur() ) {
+      QRect recurBox( timesBox.left()+padding(), h+padding(), timesBox.right()-padding(), lineHeight );
+      // TODO: Convert the recurrence to a string and print it out!
+      QString recurString( "TODO: Convert Repeat to String!" );
+      h = QMAX( printCaptionAndText( p, recurBox, i18n("Repeats: "), recurString, captionFont, textFont ), h );
+    }
+    
+    QRect alarmBox( timesBox.left()+padding(), h+padding(), timesBox.right()-padding(), lineHeight );
+    Alarm::List alarms = (*it)->alarms();
+    if ( alarms.count() == 0 ) {
+      cap = i18n("No reminders");
+      txt = QString::null;
+    } else {
+      cap = i18n("Reminder: ", "%n reminders: ", alarms.count() );
+      
+      QStringList alarmStrings;
+      KCal::Alarm::List::ConstIterator it;
+      for ( it = alarms.begin(); it != alarms.end(); ++it ) {
+        Alarm *alarm = *it;
+      
+        // Alarm offset, copied from koeditoralarms.cpp:
+        QString offsetstr;
+        int offset = 0;
+        if ( alarm->hasStartOffset() ) {
+          offset = alarm->startOffset().asSeconds();
+          if ( offset < 0 ) {
+            offsetstr = i18n("N days/hours/minutes before/after the start/end", "%1 before the start");
+            offset = -offset;
+          } else {
+            offsetstr = i18n("N days/hours/minutes before/after the start/end", "%1 after the start");
+          }
+        } else if ( alarm->hasEndOffset() ) {
+          offset = alarm->endOffset().asSeconds();
+          if ( offset < 0 ) {
+            offsetstr = i18n("N days/hours/minutes before/after the start/end", "%1 before the end");
+            offset = -offset;
+          } else {
+            offsetstr = i18n("N days/hours/minutes before/after the start/end", "%1 after the end");
+          }
+        }
+
+        offset = offset / 60; // make minutes
+        int useoffset = offset;
+
+        if ( offset % (24*60) == 0 && offset>0 ) { // divides evenly into days?
+          useoffset = offset / (24*60);
+          offsetstr = offsetstr.arg( i18n("1 day", "%n days", useoffset ) );
+        } else if (offset % 60 == 0 && offset>0 ) { // divides evenly into hours?
+          useoffset = offset / 60;
+          offsetstr = offsetstr.arg( i18n("1 hour", "%n hours", useoffset ) );
+        } else {
+          useoffset = offset;
+          offsetstr = offsetstr.arg( i18n("1 minute", "%n minutes", useoffset ) );
+        }
+        alarmStrings << offsetstr;
+      }
+      txt = alarmStrings.join( i18n("Spacer for the joined list of categories", ", ") );
+
+    }
+    h = QMAX( printCaptionAndText( p, alarmBox, cap, txt, captionFont, textFont ), h );
+
+
+    QRect organizerBox( timesBox.left()+padding(), h+padding(), timesBox.right()-padding(), lineHeight );
+    h = QMAX( printCaptionAndText( p, organizerBox, i18n("Organizer: "), (*it)->organizer().fullName(), captionFont, textFont ), h );
+    
+    // Finally, draw the frame around the time information...
+    timesBox.setBottom( QMAX( timesBox.bottom(), h+padding() ) );
+    drawBox( p, BOX_BORDER_WIDTH, timesBox );
+
+
+    QRect locationBox( timesBox );
+    locationBox.setTop( timesBox.bottom() + padding() );
+    locationBox.setHeight( 0 );
+    int locationBottom = drawBoxWithCaption( p, locationBox, i18n("Location: "),
+         (*it)->location(), /*sameLine=*/true, /*expand=*/true, captionFont, textFont );
+    locationBox.setBottom( locationBottom );
+
+
+    // Now start constructing the boxes from the bottom:
+    QRect categoriesBox( locationBox );
+    categoriesBox.setBottom( box.bottom() );
+    categoriesBox.setTop( categoriesBox.bottom() - lineHeight - 2*padding() );
+
+
+    QRect attendeesBox( box.left(), categoriesBox.top()-padding()-box.height()/9, box.width(), box.height()/9 );
+    if ( !mShowAttendees ) {
+      attendeesBox.setTop( categoriesBox.top() );
+    }
+    QRect attachmentsBox( box.left(), attendeesBox.top()-padding()-box.height()/9, box.width()*3/4 - padding(), box.height()/9 );
+    QRect optionsBox( attachmentsBox.right() + padding(), attachmentsBox.top(), 0, 0 );
+    optionsBox.setRight( box.right() );
+    optionsBox.setBottom( attachmentsBox.bottom() );
+    QRect notesBox( optionsBox.left(), locationBox.bottom() + padding(), optionsBox.width(), 0 );
+    notesBox.setBottom( optionsBox.top() - padding() );
+    
+    // TODO: Adjust boxes depending on the show options...
+//     if ( !mShowOptions ) {
+//       optionsBox.left()
+//     bool mShowOptions;
+// //     bool mShowSubitemsNotes;
+//     bool mShowAttendees;
+//     bool mShowAttachments;
+
+
+    QRect descriptionBox( notesBox );
+    descriptionBox.setLeft( box.left() );
+    descriptionBox.setRight( mShowOptions?(attachmentsBox.right()):(box.right()) );
+
+    drawBoxWithCaption( p, descriptionBox, i18n("Description:"), 
+                        (*it)->description(), /*sameLine=*/false, 
+                        /*expand=*/false, captionFont, textFont );
+    
+    if ( mShowSubitemsNotes ) {
+      if ( (*it)->relations().isEmpty() || (*it)->type() != "Todo" ) {
+        int notesPosition = drawBoxWithCaption( p, notesBox, i18n("Notes:"), 
+                         QString::null, /*sameLine=*/false, /*expand=*/false, 
+                         captionFont, textFont );
+        QPen oldPen( p.pen() );
+        p.setPen( Qt::DotLine );
+        while ( (notesPosition += int(1.5*lineHeight)) < notesBox.bottom() ) {
+          p.drawLine( notesBox.left()+padding(), notesPosition, notesBox.right()-padding(), notesPosition );
+        }
+        p.setPen( oldPen );
+      } else {
+        int subitemsStart = drawBoxWithCaption( p, notesBox, i18n("Subitems:"), 
+                            (*it)->description(), /*sameLine=*/false, 
+                            /*expand=*/false, captionFont, textFont );
+        // TODO: Draw subitems
+      }
+    }
+
+    if ( mShowAttachments ) {
+      int attachStart = drawBoxWithCaption( p, attachmentsBox, 
+                        i18n("Attachments:"), QString::null, /*sameLine=*/false, 
+                        /*expand=*/false, captionFont, textFont );
+      // TODO: Print out the attachments somehow
+    }
+
+    if ( mShowAttendees ) {
+      Attendee::List attendees = (*it)->attendees();
+      QString attendeeCaption;
+      if ( attendees.count() == 0 )
+        attendeeCaption = i18n("No Attendees");
+      else
+        attendeeCaption = i18n("1 Attendee:", "%n Attendees:", attendees.count() );
+      QString attendeeString;
+      for ( Attendee::List::ConstIterator ait = attendees.begin(); ait != attendees.end(); ++ait ) {
+        if ( !attendeeString.isEmpty() ) attendeeString += "\n";
+        attendeeString += i18n("Formatting of an attendee: "
+               "'Name (Role): Status', e.g. 'Reinhold Kainhofer "
+               "<reinhold@kainhofer.com> (Participant): Awaiting Response'",
+               "%1 (%2): %3")
+                       .arg( (*ait)->fullName() )
+                       .arg( (*ait)->roleStr() ).arg( (*ait)->statusStr() );
+      }
+      drawBoxWithCaption( p, attendeesBox, i18n("Attendees:"), attendeeString, 
+               /*sameLine=*/false, /*expand=*/false, captionFont, textFont );
+    }
+
+    if ( mShowOptions ) {
+      QString optionsString = i18n("Status: %1").arg( (*it)->statusStr() );
+      optionsString += "\n";
+      optionsString += i18n("Secrecy: %1").arg( (*it)->secrecyStr() );
+      optionsString += "\n";
+      if ( (*it)->type() == "Event" ) {
+        Event *e = static_cast<Event*>(*it);
+        if ( e->transparency() == Event::Opaque ) {
+          optionsString += i18n("Show as: Busy");
+        } else {
+          optionsString += i18n("Show as: Free");
+        }
+        optionsString += "\n";
+      } else if ( (*it)->type() == "Todo" ) {
+        Todo *t = static_cast<Todo*>(*it);
+        if ( t->isOverdue() ) {
+          optionsString += i18n("This task is overdue!");
+          optionsString += "\n";
+        }
+      } else if ( (*it)->type() == "Journal" ) {
+        //TODO: Anything Journal-specific?
+      }
+      drawBoxWithCaption( p, optionsBox, i18n("Settings: "),
+             optionsString, /*sameLine=*/false, /*expand=*/false, captionFont, textFont );
+    }
+    
+    drawBoxWithCaption( p, categoriesBox, i18n("Categories: "),
+           (*it)->categories().join( i18n("Spacer for the joined list of categories", ", ") ),
+           /*sameLine=*/true, /*expand=*/false, captionFont, textFont );
+  }
+  p.setFont( oldFont );
+}
+
+/**************************************************************
  *           Print Day
  **************************************************************/
 
@@ -110,7 +528,7 @@
 {
   if ( mConfig ) {
     QDate dt;
-    QTime tm1( mCoreHelper->dayStart() );
+    QTime tm1( dayStart() );
     QDateTime startTm( dt, tm1 );
     QDateTime endTm( dt, tm1.addSecs( 12 * 60 * 60 ) );
     mStartTime = mConfig->readDateTimeEntry( "Start time", &startTm ).time();
@@ -148,42 +566,43 @@
   QDate curDay( mFromDate );
 
   do {
-    int x = 0;
-    int y = 0;
-    int currHeight=( height - y ) / 20;
     QTime curStartTime( mStartTime );
     QTime curEndTime( mEndTime );
-    if ( curStartTime.secsTo( curEndTime ) <= 3600 ) {
-      if ( curStartTime.hour() == 0 ) {
-        curStartTime = QTime( 0, 0, 0 );
-        curEndTime = curStartTime.addSecs( 3600 );
-      } else if ( curEndTime.hour() == 23 ) {
-        curEndTime=QTime( 23, 59, 59 );
-        if ( curStartTime > QTime( 23, 0, 0 ) ) {
-          curStartTime = QTime( 23, 0, 0 );
-        }
-      } else {
-        curStartTime = curStartTime.addSecs( -1200 );
-      }
-      curEndTime = curEndTime.addSecs( 1200 );
+
+    // For an invalid time range, simply show one hour, starting at the hour
+    // before the given start time
+    if ( curEndTime <= curStartTime ) {
+      curStartTime = QTime( curStartTime.hour(), 0, 0 );
+      curEndTime = curStartTime.addSecs( 3600 );
     }
 
     KLocale *local = KGlobal::locale();
-    mHelper->drawHeader( p, local->formatDate( curDay, false ),
-                curDay, QDate(), 0, 0, width, mHelper->mHeaderHeight );
+    QRect headerBox( 0, 0, width, headerHeight() );
+    drawHeader( p, local->formatDate( curDay ), curDay, QDate(), headerBox );
 
-    y += mHelper->mHeaderHeight + 5;
-    x = 80;
+
     Event::List eventList = mCalendar->events( curDay,
                                                EventSortStartDate,
                                                SortDirectionAscending );
 
-    p.setFont( QFont( "helvetica", 12 ) );
-    mHelper->drawAllDayBox( p, eventList, curDay, true, x, y, width - x, currHeight );
-    y += currHeight;
-    mHelper->drawAgendaDayBox( p, eventList, curDay, mIncludeAllEvents,
-                      curStartTime, curEndTime, x, y, width - x, height - y );
-    mHelper->drawTimeLine( p, curStartTime, curEndTime, 0, y, x - 5, height - y );
+    p.setFont( QFont( "sans-serif", 12 ) );
+
+    // TODO: Find a good way to determine the height of the all-day box
+    QRect allDayBox( TIMELINE_WIDTH + padding(), headerBox.bottom() + padding(),
+                     0, height / 20 );
+    allDayBox.setRight( width );
+    int allDayHeight = drawAllDayBox( p, eventList, curDay, true, allDayBox );
+
+    QRect dayBox( allDayBox );
+    dayBox.setTop( allDayHeight /*allDayBox.bottom()*/ );
+    dayBox.setBottom( height );
+    drawAgendaDayBox( p, eventList, curDay, mIncludeAllEvents,
+                      curStartTime, curEndTime, dayBox );
+
+    QRect tlBox( dayBox );
+    tlBox.setLeft( 0 );
+    tlBox.setWidth( TIMELINE_WIDTH );
+    drawTimeLine( p, curStartTime, curEndTime, tlBox );
     curDay = curDay.addDays( 1 );
     if ( curDay <= mToDate ) mPrinter->newPage();
   } while ( curDay <= mToDate );
@@ -249,7 +668,7 @@
 {
   if ( mConfig ) {
     QDate dt;
-    QTime tm1( mCoreHelper->dayStart() );
+    QTime tm1( dayStart() );
     QDateTime startTm( dt, tm1  );
     QDateTime endTm( dt, tm1.addSecs( 43200 ) );
     mStartTime = mConfig->readDateTimeEntry( "Start time", &startTm ).time();
@@ -271,7 +690,7 @@
   }
 }
 
-KPrinter::Orientation CalPrintWeek::orientation()
+KPrinter::Orientation CalPrintWeek::defaultOrientation()
 {
   if ( mWeekPrintType == Filofax ) return KPrinter::Portrait;
   else if ( mWeekPrintType == SplitWeek ) return KPrinter::Portrait;
@@ -294,23 +713,33 @@
   QDate curWeek, fromWeek, toWeek;
 
   // correct begin and end to first and last day of week
-  int weekdayCol = mHelper->weekdayColumn( mFromDate.dayOfWeek() );
+  int weekdayCol = weekdayColumn( mFromDate.dayOfWeek() );
   fromWeek = mFromDate.addDays( -weekdayCol );
-  weekdayCol = mHelper->weekdayColumn( mFromDate.dayOfWeek() );
+  weekdayCol = weekdayColumn( mFromDate.dayOfWeek() );
   toWeek = mToDate.addDays( 6 - weekdayCol );
 
   curWeek = fromWeek.addDays( 6 );
   KLocale *local = KGlobal::locale();
 
+  QString line1, line2, title;
+  QRect headerBox( 0, 0, width, headerHeight() );
+  QRect weekBox( headerBox );
+  weekBox.setTop( headerBox.bottom() + padding() );
+  weekBox.setBottom( height );
+
   switch ( mWeekPrintType ) {
     case Filofax:
       do {
-        QString line1( local->formatDate( curWeek.addDays( -6 ) ) );
-        QString line2( local->formatDate( curWeek ) );
-        mHelper->drawHeader( p, line1 + "\n" + line2, curWeek.addDays( -6 ), QDate(),
-                    0, 0, width, mHelper->mHeaderHeight );
-        int top = mHelper->mHeaderHeight + 10;
-        mHelper->drawWeek( p, curWeek, 0, top, width, height - top );
+        line1 = local->formatDate( curWeek.addDays( -6 ) );
+        line2 = local->formatDate( curWeek );
+        if ( orientation() == KPrinter::Landscape ) {
+          title = i18n("date from-to", "%1 - %2");
+        } else {
+          title = i18n("date from-\nto", "%1 -\n%2");;
+        }
+        title = title.arg( line1 ).arg( line2 );
+        drawHeader( p, title, curWeek.addDays( -6 ), QDate(), headerBox );
+        drawWeek( p, curWeek, weekBox );
         curWeek = curWeek.addDays( 7 );
         if ( curWeek <= toWeek )
           mPrinter->newPage();
@@ -320,17 +749,20 @@
     case Timetable:
     default:
       do {
-        QString line1( local->formatDate( curWeek.addDays( -6 ) ) );
-        QString line2( local->formatDate( curWeek ) );
-        int hh = int(mHelper->mHeaderHeight * 2./3.);
-        mHelper->drawHeader( p, i18n("date from - to", "%1 - %2\nWeek %3")
-                             .arg( line1 )
-                             .arg( line2 )
-                             .arg( curWeek.weekNumber() ),
-                             curWeek, QDate(), 0, 0, width, hh );
-        mHelper->drawTimeTable( p, fromWeek, curWeek,
-                       mStartTime, mEndTime, 0, hh + 5,
-                       width, height - hh - 5 );
+        line1 = local->formatDate( curWeek.addDays( -6 ) );
+        line2 = local->formatDate( curWeek );
+        if ( orientation() == KPrinter::Landscape ) {
+          title = i18n("date from - to (week number)", "%1 - %2 (Week %3)");
+        } else {
+          title = i18n("date from -\nto (week number)", "%1 -\n%2 (Week %3)");
+        }
+        title = title.arg( line1 ).arg( line2 ).arg( curWeek.weekNumber() );
+        drawHeader( p, title, curWeek, QDate(), headerBox );
+        QRect weekBox( headerBox );
+        weekBox.setTop( headerBox.bottom() + padding() );
+        weekBox.setBottom( height );
+
+        drawTimeTable( p, fromWeek, curWeek, mStartTime, mEndTime, weekBox );
         fromWeek = fromWeek.addDays( 7 );
         curWeek = fromWeek.addDays( 6 );
         if ( curWeek <= toWeek )
@@ -338,27 +770,29 @@
       } while ( curWeek <= toWeek );
       break;
 
-    case SplitWeek:
+    case SplitWeek: {
+      QRect weekBox1( weekBox );
+      // On the left side there are four days (mo-th) plus the timeline,
+      // on the right there are only three days (fr-su) plus the timeline. Don't
+      // use the whole width, but rather give them the same width as on the left.
+      weekBox1.setRight( int( ( width - TIMELINE_WIDTH ) * 3. / 4. + TIMELINE_WIDTH ) );
       do {
-        QString line1( local->formatDate( curWeek.addDays( -6 ) ) );
-        QString line2( local->formatDate( curWeek ) );
         QDate endLeft( fromWeek.addDays( 3 ) );
-        int hh = mHelper->mHeaderHeight;
+        int hh = headerHeight();
 
-        mHelper->drawTimeTable( p, fromWeek, endLeft,
-                       mStartTime, mEndTime, 0, hh + 5,
-                       width, height - hh - 5 );
+        drawTimeTable( p, fromWeek, endLeft,
+                       mStartTime, mEndTime, weekBox );
         mPrinter->newPage();
-        mHelper->drawSplitHeaderRight( p, fromWeek, curWeek, QDate(), width, hh );
-        mHelper->drawTimeTable( p, endLeft.addDays( 1 ), curWeek,
-                       mStartTime, mEndTime, 0, hh + 5,
-                       int( ( width - 50 ) * 3. / 4. + 50 ), height - hh - 5 );
+        drawSplitHeaderRight( p, fromWeek, curWeek, QDate(), width, hh );
+        drawTimeTable( p, endLeft.addDays( 1 ), curWeek,
+                       mStartTime, mEndTime, weekBox1 );
 
         fromWeek = fromWeek.addDays( 7 );
         curWeek = fromWeek.addDays( 6 );
         if ( curWeek <= toWeek )
           mPrinter->newPage();
       } while ( curWeek <= toWeek );
+      }
       break;
   }
 }
@@ -388,8 +822,8 @@
   CalPrintMonthConfig_Base *cfg =
       dynamic_cast<CalPrintMonthConfig_Base *>( mConfigWidget );
   if ( cfg ) {
-    mFromDate = cfg->mFromDate->date();
-    mToDate = cfg->mToDate->date();
+    mFromDate = QDate( cfg->mFromYear->value(), cfg->mFromMonth->currentItem()+1, 1 );
+    mToDate = QDate( cfg->mToYear->value(), cfg->mToMonth->currentItem()+1, 1 );
 
     mWeekNumbers =  cfg->mWeekNumbers->isChecked();
     mRecurDaily = cfg->mRecurDaily->isChecked();
@@ -403,10 +837,8 @@
 {
   CalPrintMonthConfig_Base *cfg =
       dynamic_cast<CalPrintMonthConfig_Base *>( mConfigWidget );
+  setDateRange( mFromDate, mToDate );
   if ( cfg ) {
-    cfg->mFromDate->setDate( mFromDate );
-    cfg->mToDate->setDate( mToDate );
-
     cfg->mWeekNumbers->setChecked( mWeekNumbers );
     cfg->mRecurDaily->setChecked( mRecurDaily );
     cfg->mRecurWeekly->setChecked( mRecurWeekly );
@@ -442,9 +874,22 @@
   CalPrintPluginBase::setDateRange( from, to );
   CalPrintMonthConfig_Base *cfg =
       dynamic_cast<CalPrintMonthConfig_Base *>( mConfigWidget );
+  const KCalendarSystem *calSys = calendarSystem();
+  if ( cfg && calSys ) {
+    cfg->mFromMonth->clear();
+    for ( int i=0; i<calSys->monthsInYear( mFromDate ); ++i ) {
+      cfg->mFromMonth->insertItem( calSys->monthName( i+1, mFromDate.year() ) );
+    }
+    cfg->mToMonth->clear();
+    for ( int i=0; i<calSys->monthsInYear( mToDate ); ++i ) {
+      cfg->mToMonth->insertItem( calSys->monthName( i+1, mToDate.year() ) );
+    }
+  }
   if ( cfg ) {
-    cfg->mFromDate->setDate( from );
-    cfg->mToDate->setDate( to );
+    cfg->mFromMonth->setCurrentItem( from.month()-1 );
+    cfg->mFromYear->setValue( to.year() );
+    cfg->mToMonth->setCurrentItem( mToDate.month()-1 );
+    cfg->mToYear->setValue( mToDate.year() );
   }
 }
 
@@ -456,20 +901,24 @@
   toMonth = mToDate.addDays( mToDate.daysInMonth() - mToDate.day() );
 
   curMonth = fromMonth;
-  const KCalendarSystem *calSys = mHelper->calendarSystem();
+  const KCalendarSystem *calSys = calendarSystem();
+  if ( !calSys ) return;
+
+  QRect headerBox( 0, 0, width, headerHeight() );
+  QRect monthBox( 0, 0, width, height );
+  monthBox.setTop( headerBox.bottom() + padding() );
+
   do {
     QString title( i18n("monthname year", "%1 %2") );
     title = title.arg( calSys->monthName( curMonth ) )
                  .arg( curMonth.year() );
     QDate tmp( fromMonth );
-    int weekdayCol = mHelper->weekdayColumn( tmp.dayOfWeek() );
+    int weekdayCol = weekdayColumn( tmp.dayOfWeek() );
     tmp = tmp.addDays( -weekdayCol );
 
-    mHelper->drawHeader( p, title,
-                curMonth.addMonths( -1 ), curMonth.addMonths( 1 ),
-                0, 0, width, mHelper->mHeaderHeight );
-    mHelper->drawMonth( p, curMonth, mWeekNumbers, mRecurDaily, mRecurWeekly, 0, mHelper->mHeaderHeight + 5,
-               width, height - mHelper->mHeaderHeight - 5 );
+    drawHeader( p, title, curMonth.addMonths( -1 ), curMonth.addMonths( 1 ),
+                headerBox );
+    drawMonthTable( p, curMonth, mWeekNumbers, mRecurDaily, mRecurWeekly, monthBox );
     curMonth = curMonth.addDays( curMonth.daysInMonth() );
     if ( curMonth <= toMonth ) mPrinter->newPage();
   } while ( curMonth <= toMonth );
@@ -525,7 +974,7 @@
 
 void CalPrintTodos::setSettingsWidget()
 {
-  kdDebug() << "CalPrintTodos::setSettingsWidget" << endl;
+//   kdDebug(5850) << "CalPrintTodos::setSettingsWidget" << endl;
 
   CalPrintTodoConfig_Base *cfg =
       dynamic_cast<CalPrintTodoConfig_Base *>( mConfigWidget );
@@ -599,6 +1048,7 @@
 
 void CalPrintTodos::print( QPainter &p, int width, int height )
 {
+  // TODO: Find a good way to guarantee a nicely designed output
   int pospriority = 10;
   int possummary = 60;
   int posdue = width - 65;
@@ -607,15 +1057,15 @@
   int fontHeight = 10;
 
   // Draw the First Page Header
-  mHelper->drawHeader( p, mPageTitle, mFromDate, QDate(),
-                       0, 0, width, mHelper->mHeaderHeight );
+  drawHeader( p, mPageTitle, mFromDate, QDate(),
+                       QRect( 0, 0, width, headerHeight() ) );
 
   // Draw the Column Headers
-  int mCurrentLinePos = mHelper->mHeaderHeight + 5;
+  int mCurrentLinePos = headerHeight() + 5;
   QString outStr;
   QFont oldFont( p.font() );
 
-  p.setFont( QFont( "helvetica", 10, QFont::Bold ) );
+  p.setFont( QFont( "sans-serif", 10, QFont::Bold ) );
   lineSpacing = p.fontMetrics().lineSpacing();
   mCurrentLinePos += lineSpacing;
   if ( mIncludePriority ) {
@@ -648,7 +1098,7 @@
     posdue = -1;
   }
 
-  p.setFont( QFont( "helvetica", 10 ) );
+  p.setFont( QFont( "sans-serif", 10 ) );
   fontHeight = p.fontMetrics().height();
 
   Todo::List todoList;
@@ -656,7 +1106,7 @@
   Todo::List::ConstIterator it;
 
   // Convert sort options to the corresponding enums
-  TodoSortField sortField;
+  TodoSortField sortField = TodoSortSummary;
   switch( mTodoSortField ) {
   case TodoFieldSummary:
     sortField = TodoSortSummary; break;
@@ -716,7 +1166,7 @@
     // Skip sub-to-dos. They will be printed recursively in drawTodo()
     if ( !currEvent->relatedTo() ) {
       count++;
-      mHelper->drawTodo( count, currEvent, p,
+      drawTodo( count, currEvent, p,
                          sortField, sortDirection,
                          mConnectSubTodos,
                          mStrikeOutCompleted, mIncludeDescription,
Index: korganizer/printing/calprinter.cpp
===================================================================
--- korganizer/printing/calprinter.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprinter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,8 +40,6 @@
 
 #include "korganizer/corehelper.h"
 
-#include "calprinthelper.h"
-
 #include "calprinter.h"
 #ifndef KORG_NOPRINTER
 #include "calprinter.moc"
@@ -49,36 +47,27 @@
 #include "calprintdefaultplugins.h"
 
 CalPrinter::CalPrinter( QWidget *parent, Calendar *calendar, KOrg::CoreHelper *helper )
-  : QObject( parent, "CalPrinter" ), mHelper( 0 )
+  : QObject( parent, "CalPrinter" )
 {
   mParent = parent;
   mConfig = new KSimpleConfig( "korganizer_printing.rc" );
   mCoreHelper = helper;
 
-  init( new KPrinter, calendar );
+  init( calendar );
 }
 
 CalPrinter::~CalPrinter()
 {
   kdDebug(5850) << "~CalPrinter()" << endl;
 
-  KOrg::PrintPlugin::List::Iterator it = mPrintPlugins.begin();
-  for ( ; it != mPrintPlugins.end(); ++it ) {
-    (*it)->doSaveConfig();
-  }
   mPrintPlugins.clear();
 
   delete mConfig;
-  delete mPrintDialog;
-  delete mPrinter;
-  if ( mHelper ) delete mHelper;
 }
 
-void CalPrinter::init( KPrinter *printer, Calendar *calendar )
+void CalPrinter::init( Calendar *calendar )
 {
   mCalendar = calendar;
-  mPrinter = printer;
-  mHelper = new CalPrintHelper( mPrinter, mCalendar, mConfig, mCoreHelper );
 
   mPrintPlugins.clear();
   mPrintPlugins.setAutoDelete( true );
@@ -88,18 +77,16 @@
   mPrintPlugins.prepend( new CalPrintMonth() );
   mPrintPlugins.prepend( new CalPrintWeek() );
   mPrintPlugins.prepend( new CalPrintDay() );
+  mPrintPlugins.prepend( new CalPrintIncidence() );
 
-  mPrintDialog = new CalPrintDialog( mPrintPlugins, mPrinter, mParent );
-
   KOrg::PrintPlugin::List::Iterator it = mPrintPlugins.begin();
   for ( ; it != mPrintPlugins.end(); ++it ) {
-    (*it)->setConfig( mConfig );
-    (*it)->setCalendar( calendar );
-    (*it)->setPrinter( printer );
-    (*it)->setKOrgCoreHelper( mCoreHelper );
-    (*it)->setCalPrintHelper( mHelper );
-
-    (*it)->doLoadConfig();
+    if ( *it ) {
+      (*it)->setConfig( mConfig );
+      (*it)->setCalendar( mCalendar );
+      (*it)->setKOrgCoreHelper( mCoreHelper );
+      (*it)->doLoadConfig();
+    }
   }
 }
 
@@ -111,57 +98,63 @@
   }
 }
 
-void CalPrinter::preview( PrintType type, const QDate &fd, const QDate &td )
+void CalPrinter::print( int type, const QDate &fd, const QDate &td,
+                        Incidence::List selectedIncidences, bool preview )
 {
-  mPrintDialog->setPreview( true );
-  mPrintDialog->setPrintType( int( type ) );
+  KOrg::PrintPlugin::List::Iterator it = mPrintPlugins.begin();
+  for ( it = mPrintPlugins.begin(); it != mPrintPlugins.end(); ++it ) {
+    (*it)->setSelectedIncidences( selectedIncidences );
+  }
+  CalPrintDialog printDialog( mPrintPlugins, mParent );
+  printDialog.setOrientation( CalPrinter::ePrintOrientation( mConfig->readNumEntry("Orientation", 1 ) ) );
+  printDialog.setPreview( preview );
+  printDialog.setPrintType( type );
   setDateRange( fd, td );
 
-  if ( mPrintDialog->exec() == QDialog::Accepted ) {
-    doPrint( mPrintDialog->selectedPlugin(), true );
+  if ( printDialog.exec() == QDialog::Accepted ) {
+    mConfig->writeEntry( "Orientation", printDialog.orientation() );
+
+    // Save all changes in the dialog
+    for ( it = mPrintPlugins.begin(); it != mPrintPlugins.end(); ++it ) {
+      (*it)->doSaveConfig();
+    }
+    doPrint( printDialog.selectedPlugin(), printDialog.orientation(), preview );
   }
+  for ( it = mPrintPlugins.begin(); it != mPrintPlugins.end(); ++it ) {
+    (*it)->setSelectedIncidences( Incidence::List() );
+  }
 }
 
-void CalPrinter::print( PrintType type, const QDate &fd, const QDate &td )
+void CalPrinter::doPrint( KOrg::PrintPlugin *selectedStyle,
+                          CalPrinter::ePrintOrientation dlgorientation, bool preview )
 {
-  mPrintDialog->setPreview( false );
-  mPrintDialog->setPrintType( int( type ) );
-  setDateRange( fd, td );
-
-  if ( mPrintDialog->exec() == QDialog::Accepted ) {
-    doPrint( mPrintDialog->selectedPlugin(), false );
+  if ( !selectedStyle ) {
+    KMessageBox::error( mParent,
+                 i18n("Unable to print, no valid print style was returned."),
+                 i18n("Printing error") );
+    return;
   }
-}
+  KPrinter printer;
 
-void CalPrinter::doPrint( KOrg::PrintPlugin *selectedStyle, bool preview )
-{
-  if ( mHelper ) delete mHelper;
-  KPrinter::Orientation printerOrientation = mPrinter->orientation();
-
-  mHelper = new CalPrintHelper( mPrinter, mCalendar, mConfig, mCoreHelper );
-  if ( preview ) mPrinter->setPreviewOnly( true );
-  switch ( mPrintDialog->orientation() ) {
+  printer.setPreviewOnly( preview );
+  switch ( dlgorientation ) {
     case eOrientPlugin:
-      mPrinter->setOrientation( selectedStyle->orientation() );
+      printer.setOrientation( selectedStyle->defaultOrientation() );
       break;
     case eOrientPortrait:
-      mPrinter->setOrientation( KPrinter::Portrait );
+      printer.setOrientation( KPrinter::Portrait );
       break;
     case eOrientLandscape:
-      mPrinter->setOrientation( KPrinter::Landscape );
+      printer.setOrientation( KPrinter::Landscape );
       break;
     case eOrientPrinter:
     default:
       break;
   }
 
-  if ( preview || mPrinter->setup( mParent, i18n("Print Calendar") ) ) {
-  selectedStyle->setKOrgCoreHelper( mCoreHelper );
-  selectedStyle->setCalPrintHelper( mHelper );
-    selectedStyle->doPrint();
+  if ( preview || printer.setup( mParent, i18n("Print Calendar") ) ) {
+    selectedStyle->doPrint( &printer );
   }
-  mPrinter->setPreviewOnly( false );
-  mPrinter->setOrientation( printerOrientation );
 }
 
 ///////////////////////////////////////////////////////////////////////////////
@@ -174,10 +167,9 @@
 
 /****************************************************************************/
 
-CalPrintDialog::CalPrintDialog( KOrg::PrintPlugin::List plugins, KPrinter *p,
+CalPrintDialog::CalPrintDialog( KOrg::PrintPlugin::List plugins,
                                 QWidget *parent, const char *name )
-  : KDialogBase( parent, name, /*modal*/true, i18n("Print"), Ok | Cancel ),
-    mPrinter( p ), mPrintPlugins( plugins )
+  : KDialogBase( parent, name, /*modal*/true, i18n("Print"), Ok | Cancel )
 {
   QVBox *page = makeVBoxMainWidget();
 
@@ -211,21 +203,25 @@
 
   // signals and slots connections
   connect( mTypeGroup, SIGNAL( clicked( int ) ), SLOT( setPrintType( int ) ) );
-
-  // buddies
   orientationLabel->setBuddy( mOrientationSelection );
 
-  KOrg::PrintPlugin::List::Iterator it = mPrintPlugins.begin();
-  QRadioButton *radioButton;
-  int id = 0;
-  for ( ; it != mPrintPlugins.end(); ++it ) {
-    radioButton = new QRadioButton( (*it)->description(), mTypeGroup );
-    mTypeGroup->insert( radioButton, id );
-    radioButton->setMinimumHeight( radioButton->sizeHint().height() - 5 );
-
-    mConfigArea->addWidget( (*it)->configWidget( mConfigArea ), id );
-    id++;
+  // First insert the config widgets into the widget stack. This possibly assigns
+  // proper ids (when two plugins have the same sortID), so store them in a map
+  // and use these new IDs to later sort the plugins for the type selection.
+  for ( KOrg::PrintPlugin::List::Iterator it = plugins.begin();
+        it != plugins.end(); ++it ) {
+    int newid = mConfigArea->addWidget( (*it)->configWidget( mConfigArea ), (*it)->sortID() );
+    mPluginIDs[newid] = (*it);
   }
+  // Insert all plugins with in sorted order; plugins with clashing IDs will be first...
+  QMap<int, KOrg::PrintPlugin*>::ConstIterator mapit;
+  for ( mapit = mPluginIDs.begin(); mapit != mPluginIDs.end(); ++mapit ) {
+    KOrg::PrintPlugin *p = mapit.data();
+    QRadioButton *radioButton = new QRadioButton( p->description(), mTypeGroup );
+    radioButton->setEnabled( p->enabled() );
+    mTypeGroup->insert( radioButton, mapit.key() );
+//     radioButton->setMinimumHeight( radioButton->sizeHint().height() - 5 );
+  }
 
   setMinimumSize( minimumSizeHint() );
   resize( minimumSizeHint() );
@@ -246,27 +242,34 @@
 
 void CalPrintDialog::setPrintType( int i )
 {
-  // FIXME: Make a safe correlation between type and the radio button
-
   mTypeGroup->setButton( i );
   mConfigArea->raiseWidget( i );
 }
 
+void CalPrintDialog::setOrientation( CalPrinter::ePrintOrientation orientation )
+{
+  mOrientation = orientation;
+  mOrientationSelection->setCurrentItem( mOrientation );
+}
+
 KOrg::PrintPlugin *CalPrintDialog::selectedPlugin()
 {
-  int pos = mTypeGroup->id( mTypeGroup->selected() );
-  if ( pos < 0 ) return 0;
-  KOrg::PrintPlugin *retval = mPrintPlugins.at( pos );
-  return retval;
+  int id = mTypeGroup->selectedId();
+  if ( mPluginIDs.contains( id ) ) {
+    return mPluginIDs[id];
+  } else {
+    return 0;
+  }
 }
 
 void CalPrintDialog::slotOk()
 {
   mOrientation = (CalPrinter::ePrintOrientation)mOrientationSelection->currentItem();
 
-  KOrg::PrintPlugin::List::Iterator it = mPrintPlugins.begin();
-  for ( ; it != mPrintPlugins.end(); ++it ) {
-    (*it)->readSettingsWidget();
+  QMap<int, KOrg::PrintPlugin*>::Iterator it = mPluginIDs.begin();
+  for ( ; it != mPluginIDs.end(); ++it ) {
+    if ( it.data() )
+      it.data()->readSettingsWidget();
   }
 
   KDialogBase::slotOk();
Index: korganizer/printing/calprintpluginbase.cpp
===================================================================
--- korganizer/printing/calprintpluginbase.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprintpluginbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,25 +27,97 @@
 #include <qlayout.h>
 #include <qframe.h>
 #include <qlabel.h>
-#include <qptrlist.h>
-#include <qintdict.h>
 
-#include <kglobal.h>
-#include <klocale.h>
 #include <kdebug.h>
 #include <kconfig.h>
 #include <kcalendarsystem.h>
-#include <kprinter.h>
+#include <kwordwrap.h>
 
-#include <libkcal/todo.h>
-#include <libkcal/event.h>
-#include <libkcal/calendar.h>
-
-#include "calprinthelper.h"
 #include "calprintpluginbase.h"
+#include "cellitem.h"
 
 #ifndef KORG_NOPRINTER
 
+inline int round(const double x)
+ {
+ return int(x > 0.0 ? x + 0.5 : x - 0.5);
+ }
+/******************************************************************
+ **              The Todo positioning structure                  **
+ ******************************************************************/
+class CalPrintPluginBase::TodoParentStart
+{
+  public:
+    TodoParentStart( QRect pt = QRect(), bool page = true )
+      : mRect( pt ), mSamePage( page ) {}
+
+    QRect mRect;
+    bool mSamePage;
+};
+
+
+/******************************************************************
+ **                     The Print item                           **
+ ******************************************************************/
+
+
+class PrintCellItem : public KOrg::CellItem
+{
+  public:
+    PrintCellItem( Event *event, const QDateTime &start, const QDateTime &end )
+      : mEvent( event ), mStart( start), mEnd( end )
+    {
+    }
+
+    Event *event() const { return mEvent; }
+
+    QString label() const { return mEvent->summary(); }
+
+    QDateTime start() const { return mStart; }
+    QDateTime end() const { return mEnd; }
+
+    /** Calculate the start and end date/time of the recurrence that
+        happens on the given day */
+    bool overlaps( KOrg::CellItem *o ) const
+    {
+      PrintCellItem *other = static_cast<PrintCellItem *>( o );
+
+#if 0
+      kdDebug(5850) << "PrintCellItem::overlaps() " << event()->summary()
+                    << " <-> " << other->event()->summary() << endl;
+      kdDebug(5850) << "  start     : " << start.toString() << endl;
+      kdDebug(5850) << "  end       : " << end.toString() << endl;
+      kdDebug(5850) << "  otherStart: " << otherStart.toString() << endl;
+      kdDebug(5850) << "  otherEnd  : " << otherEnd.toString() << endl;
+#endif
+
+      return !( other->start() >= end() || other->end() <= start() );
+    }
+
+  private:
+    Event *mEvent;
+    QDateTime mStart, mEnd;
+};
+
+
+
+
+/******************************************************************
+ **                    The Print plugin                          **
+ ******************************************************************/
+
+
+CalPrintPluginBase::CalPrintPluginBase() : PrintPlugin(), mUseColors( true ),
+     mHeaderHeight(-1), mSubHeaderHeight( SUBHEADER_HEIGHT ),
+     mMargin( MARGIN_SIZE ), mPadding( PADDING_SIZE), mCalSys( 0 )
+{
+}
+CalPrintPluginBase::~CalPrintPluginBase()
+{
+}
+
+
+
 QWidget *CalPrintPluginBase::createConfigWidget( QWidget *w )
 {
   QFrame *wdg = new QFrame( w );
@@ -67,24 +139,35 @@
   return wdg;
 }
 
-void CalPrintPluginBase::doPrint()
+void CalPrintPluginBase::doPrint( KPrinter *printer )
 {
+  if ( !printer ) return;
+  mPrinter = printer;
   QPainter p;
 
   mPrinter->setColorMode( mUseColors?(KPrinter::Color):(KPrinter::GrayScale) );
 
-  p.begin(mPrinter);
+  p.begin( mPrinter );
+  // TODO: Fix the margins!!!
   // the painter initially begins at 72 dpi per the Qt docs.
   // we want half-inch margins.
-  p.setViewport( mHelper->mMargin, mHelper->mMargin,
-                p.viewport().width() - mHelper->mMargin,
-                p.viewport().height() - mHelper->mMargin );
-  int pageWidth = p.viewport().width();
-  int pageHeight = p.viewport().height();
+  int margins = margin();
+  p.setViewport( margins, margins,
+                 p.viewport().width() - 2*margins,
+                 p.viewport().height() - 2*margins );
+//   QRect vp( p.viewport() );
+// vp.setRight( vp.right()*2 );
+// vp.setBottom( vp.bottom()*2 );
+//   p.setWindow( vp );
+  int pageWidth = p.window().width();
+  int pageHeight = p.window().height();
+//   int pageWidth = p.viewport().width();
+//   int pageHeight = p.viewport().height();
 
-  print(p, pageWidth, pageHeight);
+  print( p, pageWidth, pageHeight );
 
   p.end();
+  mPrinter = 0;
 }
 
 void CalPrintPluginBase::doLoadConfig()
@@ -96,7 +179,7 @@
     mFromDate = mConfig->readDateTimeEntry( "FromDate", &currDate ).date();
     mToDate = mConfig->readDateTimeEntry( "ToDate" ).date();
     mUseColors = mConfig->readBoolEntry( "UseColors", true );
-    mHelper->setUseColors( mUseColors );
+    setUseColors( mUseColors );
     loadConfig();
   } else {
     kdDebug(5850) << "No config available in loadConfig!!!!" << endl;
@@ -117,4 +200,1475 @@
   }
 }
 
+
+
+
+void CalPrintPluginBase::setKOrgCoreHelper( KOrg::CoreHelper*helper )
+{
+  PrintPlugin::setKOrgCoreHelper( helper );
+  if ( helper )
+    setCalendarSystem( helper->calendarSystem() );
+}
+
+bool CalPrintPluginBase::useColors() const
+{
+  return mUseColors;
+}
+void CalPrintPluginBase::setUseColors( bool useColors )
+{
+  mUseColors = useColors;
+}
+
+KPrinter::Orientation CalPrintPluginBase::orientation() const
+{
+  return (mPrinter)?(mPrinter->orientation()):(KPrinter::Portrait);
+}
+
+
+
+QTime CalPrintPluginBase::dayStart()
+{
+  QTime start( 8,0,0 );
+  if ( mCoreHelper ) start = mCoreHelper->dayStart();
+  return start;
+}
+
+void CalPrintPluginBase::setCategoryColors( QPainter &p, Incidence *incidence )
+{
+  QColor bgColor = categoryBgColor( incidence );
+  if ( bgColor.isValid() )
+    p.setBrush( bgColor );
+  QColor tColor( textColor( bgColor ) );
+  if ( tColor.isValid() )
+    p.setPen( tColor );
+}
+
+QColor CalPrintPluginBase::categoryBgColor( Incidence *incidence )
+{
+  if (mCoreHelper && incidence) 
+    return mCoreHelper->categoryColor( incidence->categories() );
+  else 
+    return QColor();
+}
+
+QColor CalPrintPluginBase::textColor( const QColor &color )
+{
+  return (mCoreHelper)?(mCoreHelper->textColor( color )):QColor();
+}
+
+bool CalPrintPluginBase::isWorkingDay( const QDate &dt )
+{
+  return (mCoreHelper)?( mCoreHelper->isWorkingDay( dt ) ):true;
+}
+
+QString CalPrintPluginBase::holidayString( const QDate &dt )
+{
+  return (mCoreHelper)?(mCoreHelper->holidayString(dt)):(QString::null);
+}
+
+
+Event *CalPrintPluginBase::holiday( const QDate &dt )
+{
+  QString hstring( holidayString( dt ) );
+  if ( !hstring.isEmpty() ) {
+    Event*holiday=new Event();
+    holiday->setSummary( hstring );
+    holiday->setDtStart( dt );
+    holiday->setDtEnd( dt );
+    holiday->setFloats( true );
+    holiday->setCategories( i18n("Holiday") );
+    return holiday;
+  }
+  return 0;
+}
+
+const KCalendarSystem *CalPrintPluginBase::calendarSystem() const
+{
+  return mCalSys;
+}
+void CalPrintPluginBase::setCalendarSystem( const KCalendarSystem *calsys )
+{
+  mCalSys = calsys;
+}
+
+int CalPrintPluginBase::headerHeight() const
+{
+  if ( mHeaderHeight >= 0 )
+    return mHeaderHeight;
+  else if ( orientation() == KPrinter::Portrait )
+    return PORTRAIT_HEADER_HEIGHT;
+  else
+    return LANDSCAPE_HEADER_HEIGHT;
+}
+void CalPrintPluginBase::setHeaderHeight( const int height )
+{
+  mHeaderHeight = height;
+}
+
+int CalPrintPluginBase::subHeaderHeight() const
+{
+  return mSubHeaderHeight;
+}
+void CalPrintPluginBase::setSubHeaderHeight( const int height )
+{
+  mSubHeaderHeight = height;
+}
+
+int CalPrintPluginBase::margin() const
+{
+  return mMargin;
+}
+void CalPrintPluginBase::setMargin( const int margin )
+{
+  mMargin = margin;
+}
+
+int CalPrintPluginBase::padding() const
+{
+  return mPadding;
+}
+void CalPrintPluginBase::setPadding( const int padding )
+{
+  mPadding = padding;
+}
+
+int CalPrintPluginBase::borderWidth() const
+{
+  return mBorder;
+}
+void CalPrintPluginBase::setBorderWidth( const int borderwidth )
+{
+  mBorder = borderwidth;
+}
+
+
+
+
+void CalPrintPluginBase::drawBox( QPainter &p, int linewidth, const QRect &rect )
+{
+  QPen pen( p.pen() );
+  QPen oldpen( pen );
+  pen.setWidth( linewidth );
+  p.setPen( pen );
+  p.drawRect( rect );
+  p.setPen( oldpen );
+}
+
+void CalPrintPluginBase::drawShadedBox( QPainter &p, int linewidth, const QBrush &brush, const QRect &rect )
+{
+  QBrush oldbrush( p.brush() );
+  p.setBrush( brush );
+  drawBox( p, linewidth, rect );
+  p.setBrush( oldbrush );
+}
+
+void CalPrintPluginBase::printEventString( QPainter &p, const QRect &box, const QString &str, int flags )
+{
+  QRect newbox( box );
+  newbox.addCoords( 3, 1, -1, -1 );
+  p.drawText( newbox, (flags==-1)?(Qt::AlignTop | Qt::AlignJustify | Qt::BreakAnywhere):flags, str );
+}
+
+
+void CalPrintPluginBase::showEventBox( QPainter &p, const QRect &box, Incidence *incidence, const QString &str, int flags )
+{
+  QPen oldpen( p.pen() );
+  QBrush oldbrush( p.brush() );
+  QColor bgColor( categoryBgColor( incidence ) );
+  if ( mUseColors & bgColor.isValid() ) {
+    p.setBrush( bgColor );
+  } else {
+    p.setBrush( QColor( 232, 232, 232 ) );
+  }
+  drawBox( p, EVENT_BORDER_WIDTH, box );
+
+  if ( mUseColors && bgColor.isValid() ) {
+    p.setPen( textColor( bgColor ) );
+  }
+  printEventString( p, box, str, flags );
+  p.setPen( oldpen );
+  p.setBrush( oldbrush );
+}
+
+
+void CalPrintPluginBase::drawSubHeaderBox(QPainter &p, const QString &str,
+    const QRect &box )
+{
+  drawShadedBox( p, BOX_BORDER_WIDTH, QColor( 232, 232, 232 ), box );
+  QFont oldfont( p.font() );
+  p.setFont( QFont( "sans-serif", 10, QFont::Bold ) );
+  p.drawText( box, Qt::AlignCenter | Qt::AlignVCenter, str );
+  p.setFont( oldfont );
+}
+
+void CalPrintPluginBase::drawVerticalBox( QPainter &p, const QRect &box, const QString &str )
+{
+  p.save();
+  p.rotate( -90 );
+  QRect rotatedBox( -box.top()-box.height(), box.left(), box.height(), box.width() );
+  showEventBox( p, rotatedBox, 0, str, Qt::AlignLeft | Qt::AlignVCenter | Qt::SingleLine );
+
+  p.restore();
+}
+
+
+
+///////////////////////////////////////////////////////////////////////////////
+// Return value: If expand, bottom of the printed box, otherwise vertical end 
+// of the printed contents inside the box.
+
+int CalPrintPluginBase::drawBoxWithCaption( QPainter &p, const QRect &allbox, 
+        const QString &caption, const QString &contents, bool sameLine, bool expand, const QFont &captionFont, const QFont &textFont )
+{
+  QFont oldFont( p.font() );
+//   QFont captionFont( "sans-serif", 11, QFont::Bold );
+//   QFont textFont( "sans-serif", 11, QFont::Normal );
+//   QFont captionFont( "Tahoma", 11, QFont::Bold );
+//   QFont textFont( "Tahoma", 11, QFont::Normal );
+
+
+  QRect box( allbox );
+  
+  // Bounding rectangle for caption, single-line, clip on the right
+  QRect captionBox( box.left() + padding(), box.top() + padding(), 0, 0 );
+  p.setFont( captionFont );
+  captionBox = p.boundingRect( captionBox, Qt::AlignLeft | Qt::AlignTop | Qt::SingleLine, caption );
+  p.setFont( oldFont );
+  if ( captionBox.right() > box.right() ) 
+    captionBox.setRight( box.right() );
+  if ( expand && captionBox.bottom() + padding() > box.bottom() ) 
+    box.setBottom( captionBox.bottom() + padding() );
+  
+  // Bounding rectangle for the contents (if any), word break, clip on the bottom
+  QRect textBox( captionBox );
+  if ( !contents.isEmpty() ) {
+    if ( sameLine ) {
+      textBox.setLeft( captionBox.right() + padding() );
+    } else {
+      textBox.setTop( captionBox.bottom() + padding() );
+    }
+    textBox.setRight( box.right() );
+    textBox.setHeight( 0 );
+    p.setFont( textFont );
+    textBox = p.boundingRect( textBox, Qt::WordBreak | Qt::AlignTop | Qt::AlignLeft, contents );
+    p.setFont( oldFont );
+    if ( textBox.bottom() + padding() > box.bottom() ) {
+      if ( expand ) {
+        box.setBottom( textBox.bottom() + padding() );
+      } else {
+        textBox.setBottom( box.bottom() );
+      }
+    }
+  }
+  
+  drawBox( p, BOX_BORDER_WIDTH, box );
+  p.setFont( captionFont );
+  p.drawText( captionBox, Qt::AlignLeft | Qt::AlignTop | Qt::SingleLine, caption );
+  if ( !contents.isEmpty() ) {
+    p.setFont( textFont );
+    p.drawText( textBox, Qt::WordBreak | Qt::AlignTop | Qt::AlignLeft, contents );
+  }
+  p.setFont( oldFont );
+  
+  if ( expand ) {
+    return box.bottom();
+  } else {
+    return textBox.bottom();
+  }
+}
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+int CalPrintPluginBase::drawHeader( QPainter &p, QString title,
+    const QDate &month1, const QDate &month2, const QRect &allbox, bool expand )
+{
+  // print previous month for month view, print current for to-do, day and week
+  int smallMonthWidth = (allbox.width()/4) - 10;
+  if (smallMonthWidth>100) smallMonthWidth=100;
+
+  int right = allbox.right();
+  if ( month1.isValid() ) right -= (20+smallMonthWidth);
+  if ( month2.isValid() ) right -= (20+smallMonthWidth);
+  QRect box( allbox );
+  QRect textRect( allbox );
+  textRect.addCoords( 5, 0, 0, 0 );
+  textRect.setRight( right );
+  
+  
+  QFont oldFont( p.font() );
+  QFont newFont("sans-serif", (textRect.height()<60)?16:18, QFont::Bold);
+  if ( expand ) {
+    p.setFont( newFont );
+    QRect boundingR = p.boundingRect( textRect, Qt::AlignLeft | Qt::AlignVCenter | Qt::WordBreak, title );
+    p.setFont( oldFont );
+    int h = boundingR.height();
+    if ( h > allbox.height() ) {
+      box.setHeight( h );
+      textRect.setHeight( h );
+    }
+  }
+
+  drawShadedBox( p, BOX_BORDER_WIDTH, QColor( 232, 232, 232 ), box );
+
+  QRect monthbox( box.right()-10-smallMonthWidth, box.top(), smallMonthWidth, box.height() );
+  if (month2.isValid()) {
+    drawSmallMonth( p, QDate(month2.year(), month2.month(), 1), monthbox );
+    monthbox.moveBy( -20 - smallMonthWidth, 0 );
+  }
+  if (month1.isValid()) {
+    drawSmallMonth( p, QDate(month1.year(), month1.month(), 1), monthbox );
+    monthbox.moveBy( -20 - smallMonthWidth, 0 );
+  }
+
+  // Set the margins
+  p.setFont( newFont );
+  p.drawText( textRect, Qt::AlignLeft | Qt::AlignVCenter | Qt::WordBreak, title );
+  p.setFont( oldFont );
+  
+  return textRect.bottom();
+}
+
+
+void CalPrintPluginBase::drawSmallMonth(QPainter &p, const QDate &qd,
+    const QRect &box )
+{
+
+  int weekdayCol = weekdayColumn( qd.dayOfWeek() );
+  int month = qd.month();
+  QDate monthDate(QDate(qd.year(), qd.month(), 1));
+  // correct begin of week
+  QDate monthDate2( monthDate.addDays( -weekdayCol ) );
+
+  double cellWidth = double(box.width())/double(7);
+  int rownr = 3 + ( qd.daysInMonth() + weekdayCol - 1 ) / 7;
+  // 3 Pixel after month name, 2 after day names, 1 after the calendar
+  double cellHeight = (box.height() - 5) / rownr;
+  QFont oldFont( p.font() );
+  p.setFont(QFont("sans-serif", int(cellHeight-1), QFont::Normal));
+
+  // draw the title
+  if ( mCalSys ) {
+    QRect titleBox( box );
+    titleBox.setHeight( int(cellHeight+1) );
+    p.drawText( titleBox, Qt::AlignTop | Qt::AlignHCenter, mCalSys->monthName( qd ) );
+  }
+
+  // draw days of week
+  QRect wdayBox( box );
+  wdayBox.setTop( int( box.top() + 3 + cellHeight ) );
+  wdayBox.setHeight( int(2*cellHeight)-int(cellHeight) );
+
+  if ( mCalSys ) {
+    for (int col = 0; col < 7; ++col) {
+      QString tmpStr = mCalSys->weekDayName( monthDate2 )[0].upper();
+      wdayBox.setLeft( int(box.left() + col*cellWidth) );
+      wdayBox.setRight( int(box.left() + (col+1)*cellWidth) );
+      p.drawText( wdayBox, Qt::AlignCenter, tmpStr );
+      monthDate2 = monthDate2.addDays( 1 );
+    }
+  }
+
+  // draw separator line
+  int calStartY = wdayBox.bottom() + 2;
+  p.drawLine( box.left(), calStartY, box.right(), calStartY );
+  monthDate = monthDate.addDays( -weekdayCol );
+
+  for ( int row = 0; row < (rownr-2); row++ ) {
+    for ( int col = 0; col < 7; col++ ) {
+      if ( monthDate.month() == month ) {
+        QRect dayRect( int( box.left() + col*cellWidth ), int( calStartY + row*cellHeight ), 0, 0 );
+        dayRect.setRight( int( box.left() + (col+1)*cellWidth ) );
+        dayRect.setBottom( int( calStartY + (row+1)*cellHeight ) );
+        p.drawText( dayRect, Qt::AlignCenter, QString::number( monthDate.day() ) );
+      }
+      monthDate = monthDate.addDays(1);
+    }
+  }
+  p.setFont( oldFont );
+}
+
+
+
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+/*
+ * This routine draws a header box over the main part of the calendar
+ * containing the days of the week.
+ */
+void CalPrintPluginBase::drawDaysOfWeek(QPainter &p,
+    const QDate &fromDate, const QDate &toDate, const QRect &box )
+{
+  double cellWidth = double(box.width()) / double(fromDate.daysTo( toDate )+1);
+  QDate cellDate( fromDate );
+  QRect dateBox( box );
+  int i = 0;
+
+  while ( cellDate <= toDate ) {
+    dateBox.setLeft( box.left() + int(i*cellWidth) );
+    dateBox.setRight( box.left() + int((i+1)*cellWidth) );
+    drawDaysOfWeekBox(p, cellDate, dateBox );
+    cellDate = cellDate.addDays(1);
+    i++;
+  }
+}
+
+
+void CalPrintPluginBase::drawDaysOfWeekBox(QPainter &p, const QDate &qd,
+    const QRect &box )
+{
+  drawSubHeaderBox( p, (mCalSys)?(mCalSys->weekDayName( qd )):(QString::null), box );
+}
+
+
+void CalPrintPluginBase::drawTimeLine(QPainter &p,
+    const QTime &fromTime, const QTime &toTime,
+    const QRect &box)
+{
+  drawBox( p, BOX_BORDER_WIDTH, box );
+
+  int totalsecs=fromTime.secsTo(toTime);
+  float minlen=(float)box.height()*60./(float)totalsecs;
+  float cellHeight=(60.*(float)minlen);
+  float currY=box.top();
+  // TODO: Don't use half of the width, but less, for the minutes!
+  int xcenter = box.left()+box.width()/2;
+
+  QTime curTime( fromTime );
+  QTime endTime( toTime );
+  if ( fromTime.minute() > 30 )
+    curTime = QTime( fromTime.hour()+1, 0, 0 );
+  else if ( fromTime.minute() > 0 ) {
+    curTime = QTime( fromTime.hour(), 30, 0 );
+    float yy = currY + minlen*(float)fromTime.secsTo( curTime )/60.;
+    p.drawLine( xcenter, (int)yy, box.right(), (int)yy );
+    curTime = QTime( fromTime.hour()+1, 0, 0 );
+  }
+  currY += ( float( fromTime.secsTo(curTime)*minlen ) / 60. );
+
+  while ( curTime < endTime ) {
+    p.drawLine( box.left(), (int)currY, box.right(), (int)currY );
+    int newY=(int)(currY+cellHeight/2.);
+    QString numStr;
+    if ( newY < box.bottom() ) {
+      QFont oldFont( p.font() );
+      // draw the time:
+      if ( !KGlobal::locale()->use12Clock() ) {
+        p.drawLine( xcenter, (int)newY, box.right(), (int)newY);
+        numStr.setNum(curTime.hour());
+        if (cellHeight > 30) {
+          p.setFont(QFont("sans-serif", 16, QFont::Bold));
+        } else {
+          p.setFont(QFont("sans-serif", 12, QFont::Bold));
+        }
+        p.drawText( box.left()+2, (int)currY+2, box.width()/2-2, (int)cellHeight,
+                  Qt::AlignTop | Qt::AlignRight, numStr);
+        p.setFont(QFont("sans-serif", 10, QFont::Normal));
+        p.drawText( xcenter, (int)currY+2, box.width()/2+2, (int)(cellHeight/2)-3,
+                  Qt::AlignTop | Qt::AlignLeft, "00");
+      } else {
+        p.drawLine( box.left(), (int)newY, box.right(), (int)newY);
+        QTime time( curTime.hour(), 0 );
+        numStr = KGlobal::locale()->formatTime( time );
+        if ( box.width() < 60 ) {
+          p.setFont(QFont("sans-serif", 8, QFont::Bold)); // for weekprint
+        } else {
+          p.setFont(QFont("sans-serif", 12, QFont::Bold)); // for dayprint
+        }
+        p.drawText(box.left()+2, (int)currY+2, box.width()-4, (int)cellHeight/2-3,
+                  Qt::AlignTop|Qt::AlignLeft, numStr);
+      }
+      currY+=cellHeight;
+      p.setFont( oldFont );
+    } // enough space for half-hour line and time
+    if (curTime.secsTo(endTime)>3600)
+      curTime=curTime.addSecs(3600);
+    else curTime=endTime;
+  } // currTime<endTime
+}
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+/** prints the all-day box for the agenda print view. if expandable is set,
+    height is the cell height of a single cell, and the returned height will
+    be the total height used for the all-day events. If !expandable, only one
+    cell will be used, and multiple events are concatenated using ", ".
+*/
+int CalPrintPluginBase::drawAllDayBox(QPainter &p, Event::List &eventList,
+    const QDate &qd, bool expandable, const QRect &box )
+{
+  Event::List::Iterator it, itold;
+
+  int offset=box.top();
+
+  QString multiDayStr;
+
+  Event*hd = holiday( qd );
+  if ( hd ) eventList.prepend( hd );
+
+  it = eventList.begin();
+  Event *currEvent = 0;
+  // First, print all floating events
+  while( it!=eventList.end() ) {
+    currEvent=*it;
+    itold=it;
+    ++it;
+    if ( currEvent && currEvent->doesFloat() ) {
+      // set the colors according to the categories
+      if ( expandable ) {
+        QRect eventBox( box );
+        eventBox.setTop( offset );
+        showEventBox( p, eventBox, currEvent, currEvent->summary() );
+        offset += box.height();
+      } else {
+        if ( !multiDayStr.isEmpty() ) multiDayStr += ", ";
+        multiDayStr += currEvent->summary();
+      }
+      eventList.remove( itold );
+    }
+  }
+  if ( hd ) delete hd;
+
+  int ret = box.height();
+  QRect eventBox( box );
+  if (!expandable) {
+    if (!multiDayStr.isEmpty()) {
+      drawShadedBox( p, BOX_BORDER_WIDTH, QColor( 128, 128, 128 ), eventBox );
+      printEventString( p, eventBox, multiDayStr );
+    } else {
+      drawBox( p, BOX_BORDER_WIDTH, eventBox );
+    }
+  } else {
+    ret = offset - box.top();
+    eventBox.setBottom( ret );
+    drawBox( p, BOX_BORDER_WIDTH, eventBox );
+  }
+  return ret;
+}
+
+
+void CalPrintPluginBase::drawAgendaDayBox( QPainter &p, Event::List &events,
+                                     const QDate &qd, bool expandable,
+                                     QTime &fromTime, QTime &toTime,
+                                     const QRect &oldbox )
+{
+  if ( !isWorkingDay( qd ) ) {
+    drawShadedBox( p, BOX_BORDER_WIDTH, QColor( 232, 232, 232 ), oldbox );
+  } else {
+    drawBox( p, BOX_BORDER_WIDTH, oldbox );
+  }
+  QRect box( oldbox );
+  // Account for the border with and cut away that margin from the interior
+//   box.setRight( box.right()-BOX_BORDER_WIDTH );
+
+  Event *event;
+
+  if ( expandable ) {
+    // Adapt start/end times to include complete events
+    Event::List::ConstIterator it;
+    for ( it = events.begin(); it != events.end(); ++it ) {
+      event = *it;
+      if ( event->dtStart().time() < fromTime )
+        fromTime = event->dtStart().time();
+      if ( event->dtEnd().time() > toTime )
+        toTime = event->dtEnd().time();
+    }
+  }
+
+  // Show at least one hour
+//   if ( fromTime.secsTo( toTime ) < 3600 ) {
+//     fromTime = QTime( fromTime.hour(), 0, 0 );
+//     toTime = fromTime.addSecs( 3600 );
+//   }
+
+  // calculate the height of a cell and of a minute
+  int totalsecs = fromTime.secsTo( toTime );
+  float minlen = box.height() * 60. / totalsecs;
+  float cellHeight = 60. * minlen;
+  float currY = box.top();
+
+  // print grid:
+  QTime curTime( QTime( fromTime.hour(), 0, 0 ) );
+  currY += fromTime.secsTo( curTime ) * minlen / 60;
+
+  while ( curTime < toTime && curTime.isValid() ) {
+    if ( currY > box.top() )
+      p.drawLine( box.left(), int( currY ), box.right(), int( currY ) );
+    currY += cellHeight / 2;
+    if ( ( currY > box.top() ) && ( currY < box.bottom() ) ) {
+      // enough space for half-hour line
+      QPen oldPen( p.pen() );
+      p.setPen( QColor( 192, 192, 192 ) );
+      p.drawLine( box.left(), int( currY ), box.right(), int( currY ) );
+      p.setPen( oldPen );
+    }
+    if ( curTime.secsTo( toTime ) > 3600 )
+      curTime = curTime.addSecs( 3600 );
+    else curTime = toTime;
+    currY += cellHeight / 2;
+  }
+
+  QDateTime startPrintDate = QDateTime( qd, fromTime );
+  QDateTime endPrintDate = QDateTime( qd, toTime );
+
+  // Calculate horizontal positions and widths of events taking into account
+  // overlapping events
+
+  QPtrList<KOrg::CellItem> cells;
+  cells.setAutoDelete( true );
+
+  Event::List::ConstIterator itEvents;
+  for( itEvents = events.begin(); itEvents != events.end(); ++itEvents ) {
+    QValueList<QDateTime> times = (*itEvents)->startDateTimesForDate( qd );
+    for ( QValueList<QDateTime>::ConstIterator it = times.begin();
+          it != times.end(); ++it ) {
+      cells.append( new PrintCellItem( *itEvents, (*it), (*itEvents)->endDateForStart( *it ) ) );
+    }
+  }
+
+  QPtrListIterator<KOrg::CellItem> it1( cells );
+  for( it1.toFirst(); it1.current(); ++it1 ) {
+    KOrg::CellItem *placeItem = it1.current();
+    KOrg::CellItem::placeItem( cells, placeItem );
+  }
+
+//   p.setFont( QFont( "sans-serif", 10 ) );
+
+  for( it1.toFirst(); it1.current(); ++it1 ) {
+    PrintCellItem *placeItem = static_cast<PrintCellItem *>( it1.current() );
+    drawAgendaItem( placeItem, p, startPrintDate, endPrintDate, minlen, box );
+  }
+//   p.setFont( oldFont );
+}
+
+
+
+void CalPrintPluginBase::drawAgendaItem( PrintCellItem *item, QPainter &p,
+                                   const QDateTime &startPrintDate,
+                                   const QDateTime &endPrintDate,
+                                   float minlen, const QRect &box )
+{
+  Event *event = item->event();
+
+  // start/end of print area for event
+  QDateTime startTime = item->start();
+  QDateTime endTime = item->end();
+  if ( ( startTime < endPrintDate && endTime > startPrintDate ) ||
+       ( endTime > startPrintDate && startTime < endPrintDate ) ) {
+    if ( startTime < startPrintDate ) startTime = startPrintDate;
+    if ( endTime > endPrintDate ) endTime = endPrintDate;
+    int currentWidth = box.width() / item->subCells();
+    int currentX = box.left() + item->subCell() * currentWidth;
+    int currentYPos = int( box.top() + startPrintDate.secsTo( startTime ) *
+                           minlen / 60. );
+    int currentHeight = int( box.top() + startPrintDate.secsTo( endTime ) * minlen / 60. ) - currentYPos;
+
+    QRect eventBox( currentX, currentYPos, currentWidth, currentHeight );
+    showEventBox( p, eventBox, event, event->summary() );
+  }
+}
+
+//TODO TODO TODO
+void CalPrintPluginBase::drawDayBox( QPainter &p, const QDate &qd,
+    const QRect &box,
+    bool fullDate, bool printRecurDaily, bool printRecurWeekly )
+{
+  QString dayNumStr;
+  QString ampm;
+  const KLocale*local = KGlobal::locale();
+
+
+  // This has to be localized
+  if ( fullDate && mCalSys ) {
+
+    dayNumStr = i18n("weekday month date", "%1 %2 %3")
+        .arg( mCalSys->weekDayName( qd ) )
+        .arg( mCalSys->monthName( qd ) )
+        .arg( qd.day() );
+//    dayNumStr = local->formatDate(qd);
+  } else {
+    dayNumStr = QString::number( qd.day() );
+  }
+
+  QRect subHeaderBox( box );
+  subHeaderBox.setHeight( mSubHeaderHeight );
+  drawShadedBox( p, BOX_BORDER_WIDTH, p.backgroundColor(), box );
+  drawShadedBox( p, 0, QColor( 232, 232, 232 ), subHeaderBox );
+  drawBox( p, BOX_BORDER_WIDTH, box );
+  QString hstring( holidayString( qd ) );
+  QFont oldFont( p.font() );
+
+  QRect headerTextBox( subHeaderBox );
+  headerTextBox.setLeft( subHeaderBox.left()+5 );
+  headerTextBox.setRight( subHeaderBox.right()-5 );
+  if (!hstring.isEmpty()) {
+    p.setFont( QFont( "sans-serif", 8, QFont::Bold, true ) );
+
+    p.drawText( headerTextBox, Qt::AlignLeft | Qt::AlignVCenter, hstring );
+  }
+  p.setFont(QFont("sans-serif", 10, QFont::Bold));
+  p.drawText( headerTextBox, Qt::AlignRight | Qt::AlignVCenter, dayNumStr);
+
+  Event::List eventList = mCalendar->events( qd,
+                                             EventSortStartDate,
+                                             SortDirectionAscending );
+  QString text;
+  p.setFont( QFont( "sans-serif", 8 ) );
+
+  int textY=mSubHeaderHeight+3; // gives the relative y-coord of the next printed entry
+  Event::List::ConstIterator it;
+
+  for( it = eventList.begin(); it != eventList.end() && textY<box.height(); ++it ) {
+    Event *currEvent = *it;
+    if ( ( !printRecurDaily  && currEvent->recurrenceType() == Recurrence::rDaily  ) ||
+         ( !printRecurWeekly && currEvent->recurrenceType() == Recurrence::rWeekly ) ) {
+      continue; }
+    if ( currEvent->doesFloat() || currEvent->isMultiDay() )
+      text = "";
+    else
+      text = local->formatTime( currEvent->dtStart().time() );
+
+    drawIncidence( p, box, text, currEvent->summary(), textY );
+  }
+
+  if ( textY<box.height() ) {
+    Todo::List todos = mCalendar->todos( qd );
+    Todo::List::ConstIterator it2;
+    for( it2 = todos.begin(); it2 != todos.end() && textY<box.height(); ++it2 ) {
+      Todo *todo = *it2;
+      if ( ( !printRecurDaily  && todo->recurrenceType() == Recurrence::rDaily  ) ||
+           ( !printRecurWeekly && todo->recurrenceType() == Recurrence::rWeekly ) )
+        continue;
+      if ( todo->hasDueDate() && !todo->doesFloat() )
+        text += KGlobal::locale()->formatTime(todo->dtDue().time()) + " ";
+      else
+        text = "";
+      drawIncidence( p, box, text, i18n("To-do: %1").arg(todo->summary()), textY );
+    }
+  }
+
+  p.setFont( oldFont );
+}
+
+// TODO TODO TODO
+void CalPrintPluginBase::drawIncidence( QPainter &p, const QRect &dayBox, const QString &time, const QString &summary, int &textY )
+{
+  kdDebug(5850) << "summary = " << summary << endl;
+
+  int flags = Qt::AlignLeft;
+  QFontMetrics fm = p.fontMetrics();
+  QRect timeBound = p.boundingRect( dayBox.x() + 5, dayBox.y() + textY,
+                                    dayBox.width() - 10, fm.lineSpacing(),
+                                    flags, time );
+  p.drawText( timeBound, flags, time );
+
+  int summaryWidth = time.isEmpty() ? 0 : timeBound.width() + 4;
+  QRect summaryBound = QRect( dayBox.x() + 5 + summaryWidth, dayBox.y() + textY,
+                              dayBox.width() - summaryWidth -5, dayBox.height() );
+
+  KWordWrap *ww = KWordWrap::formatText( fm, summaryBound, flags, summary );
+  ww->drawText( &p, dayBox.x() + 5 + summaryWidth, dayBox.y() + textY, flags );
+
+  textY += ww->boundingRect().height();
+
+  delete ww;
+}
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+void CalPrintPluginBase::drawWeek(QPainter &p, const QDate &qd, const QRect &box )
+{
+  QDate weekDate = qd;
+  bool portrait = ( box.height() > box.width() );
+  int cellWidth, cellHeight;
+  int vcells;
+  if (portrait) {
+    cellWidth = box.width()/2;
+    vcells=3;
+  } else {
+    cellWidth = box.width()/6;
+    vcells=1;
+  }
+  cellHeight = box.height()/vcells;
+
+  // correct begin of week
+  int weekdayCol = weekdayColumn( qd.dayOfWeek() );
+  weekDate = qd.addDays( -weekdayCol );
+
+  for (int i = 0; i < 7; i++, weekDate = weekDate.addDays(1)) {
+    // Saturday and sunday share a cell, so we have to special-case sunday
+    int hpos = ((i<6)?i:(i-1)) / vcells;
+    int vpos = ((i<6)?i:(i-1)) % vcells;
+    QRect dayBox( box.left()+cellWidth*hpos, box.top()+cellHeight*vpos + ((i==6)?(cellHeight/2):0),
+        cellWidth, (i<5)?(cellHeight):(cellHeight/2) );
+    drawDayBox(p, weekDate, dayBox, true);
+  } // for i through all weekdays
+}
+
+
+void CalPrintPluginBase::drawTimeTable(QPainter &p,
+    const QDate &fromDate, const QDate &toDate,
+    QTime &fromTime, QTime &toTime,
+    const QRect &box)
+{
+  // timeline is 1 hour:
+  int alldayHeight = (int)( 3600.*box.height()/(fromTime.secsTo(toTime)+3600.) );
+  int timelineWidth = TIMELINE_WIDTH;
+
+  QRect dowBox( box );
+  dowBox.setLeft( box.left() + timelineWidth );
+  dowBox.setHeight( mSubHeaderHeight );
+  drawDaysOfWeek( p, fromDate, toDate, dowBox );
+
+  QRect tlBox( box );
+  tlBox.setWidth( timelineWidth );
+  tlBox.setTop( dowBox.bottom() + BOX_BORDER_WIDTH + alldayHeight );
+  drawTimeLine( p, fromTime, toTime, tlBox );
+
+  // draw each day
+  QDate curDate(fromDate);
+  int i=0;
+  double cellWidth = double(dowBox.width()) / double(fromDate.daysTo(toDate)+1);
+  while (curDate<=toDate) {
+    QRect allDayBox( dowBox.left()+int(i*cellWidth), dowBox.bottom() + BOX_BORDER_WIDTH,
+                     int((i+1)*cellWidth)-int(i*cellWidth), alldayHeight );
+    QRect dayBox( allDayBox );
+    dayBox.setTop( tlBox.top() );
+    dayBox.setBottom( box.bottom() );
+    Event::List eventList = mCalendar->events(curDate,
+                                              EventSortStartDate,
+                                              SortDirectionAscending);
+    alldayHeight = drawAllDayBox( p, eventList, curDate, false, allDayBox );
+    drawAgendaDayBox( p, eventList, curDate, false, fromTime, toTime, dayBox );
+    i++;
+    curDate=curDate.addDays(1);
+  }
+
+}
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+class MonthEventStruct
+{
+  public:
+    MonthEventStruct() : event(0) {}
+    MonthEventStruct( const QDateTime &s, const QDateTime &e, Event *ev)
+    {
+      event = ev;
+      start = s;
+      end = e;
+      if ( event->doesFloat() ) {
+        start = QDateTime( start.date(), QTime(0,0,0) );
+        end = QDateTime( end.date().addDays(1), QTime(0,0,0) ).addSecs(-1);
+      }
+    }
+    bool operator<(const MonthEventStruct &mes) { return start < mes.start; }
+    QDateTime start;
+    QDateTime end;
+    Event *event;
+};
+
+void CalPrintPluginBase::drawMonth( QPainter &p, const QDate &dt, const QRect &box, int maxdays, int subDailyFlags, int holidaysFlags )
+{
+  const KCalendarSystem *calsys = calendarSystem();
+  QRect subheaderBox( box );
+  subheaderBox.setHeight( subHeaderHeight() );
+  QRect borderBox( box );
+  borderBox.setTop( subheaderBox.bottom()+1 );
+  drawSubHeaderBox( p, calsys->monthName(dt), subheaderBox );
+  // correct for half the border width
+  int correction = (BOX_BORDER_WIDTH/*-1*/)/2;
+  QRect daysBox( borderBox );
+  daysBox.addCoords( correction, correction, -correction, -correction );
+
+  int daysinmonth = calsys->daysInMonth( dt );
+  if ( maxdays <= 0 ) maxdays = daysinmonth;
+  
+  int d;
+  float dayheight = float(daysBox.height()) / float( maxdays );
+  
+  QColor holidayColor( 240, 240, 240 );
+  QColor workdayColor( 255, 255, 255 );
+  int dayNrWidth = p.fontMetrics().width( "99" );
+  
+  // Fill the remaining space (if a month has less days than others) with a crossed-out pattern
+  if ( daysinmonth<maxdays ) {
+    QRect dayBox( box.left(), daysBox.top() + round(dayheight*daysinmonth), box.width(), 0 );
+    dayBox.setBottom( daysBox.bottom() );
+    p.fillRect( dayBox, Qt::DiagCrossPattern );
+  }
+  // Backgrounded boxes for each day, plus day numbers
+  QBrush oldbrush( p.brush() );
+  for ( d = 0; d < daysinmonth; ++d ) {
+    QDate day;
+    calsys->setYMD( day, dt.year(), dt.month(), d+1 );
+    QRect dayBox( daysBox.left()/*+rand()%50*/, daysBox.top() + round(dayheight*d), daysBox.width()/*-rand()%50*/, 0 );
+    // FIXME: When using a border width of 0 for event boxes, don't let the rectangles overlap, i.e. subtract 1 from the top or bottom!
+    dayBox.setBottom( daysBox.top()+round(dayheight*(d+1)) - 1 );
+    
+    p.setBrush( isWorkingDay( day )?workdayColor:holidayColor );
+    p.drawRect( dayBox );
+    QRect dateBox( dayBox );
+    dateBox.setWidth( dayNrWidth+3 );
+    p.drawText( dateBox, Qt::AlignRight | Qt::AlignVCenter | Qt::SingleLine, 
+                QString::number(d+1) );
+  }
+  p.setBrush( oldbrush );
+  int xstartcont = box.left() + dayNrWidth + 5;
+
+  QDate start, end;
+  calsys->setYMD( start, dt.year(), dt.month(), 1 );
+  end = calsys->addMonths( start, 1 );
+  end = calsys->addDays( end, -1 );
+
+  Event::List events = mCalendar->events( start, end );
+  QMap<int, QStringList> textEvents;
+  QPtrList<KOrg::CellItem> timeboxItems;
+  timeboxItems.setAutoDelete( true );
+
+
+  // 1) For multi-day events, show boxes spanning several cells, use CellItem
+  //    print the summary vertically
+  // 2) For sub-day events, print the concated summaries into the remaining
+  //    space of the box (optional, depending on the given flags)
+  // 3) Draw some kind of timeline showing free and busy times
+
+  // Holidays
+  Event::List holidays;
+  holidays.setAutoDelete( true );
+  for ( QDate d(start); d <= end; d = d.addDays(1) ) {
+    Event *e = holiday( d );
+    if ( e ) {
+      holidays.append( e );
+      if ( holidaysFlags & TimeBoxes ) {
+        timeboxItems.append( new PrintCellItem( e, QDateTime(d, QTime(0,0,0) ),
+            QDateTime( d.addDays(1), QTime(0,0,0) ) ) );
+      }
+      if ( holidaysFlags & Text ) {
+        textEvents[ d.day() ] << e->summary();
+      }
+    }
+  }
+  
+  QValueList<MonthEventStruct> monthentries;
+
+  for ( Event::List::ConstIterator evit = events.begin(); 
+        evit != events.end(); ++evit ) {
+    Event *e = (*evit);
+    if (!e) continue;
+    if ( e->doesRecur() ) {
+      if ( e->recursOn( start ) ) {
+        // This occurrence has possibly started before the beginning of the 
+        // month, so obtain the start date before the beginning of the month
+        QValueList<QDateTime> starttimes = e->startDateTimesForDate( start );
+        QValueList<QDateTime>::ConstIterator it = starttimes.begin();
+        for ( ; it != starttimes.end(); ++it ) {
+          monthentries.append( MonthEventStruct( *it, e->endDateForStart( *it ), e ) );
+        }
+      }
+      // Loop through all remaining days of the month and check if the event 
+      // begins on that day (don't use Event::recursOn, as that will 
+      // also return events that have started earlier. These start dates
+      // however, have already been treated!
+      Recurrence *recur = e->recurrence();
+      QDate d1( start.addDays(1) );
+      while ( d1 <= end ) {
+        if ( recur->recursOn(d1) ) {
+          TimeList times( recur->recurTimesOn( d1 ) );
+          for ( TimeList::ConstIterator it = times.begin();
+                it != times.end(); ++it ) {
+            QDateTime d1start( d1, *it );
+            monthentries.append( MonthEventStruct( d1start, e->endDateForStart( d1start ), e ) );
+          }
+        }
+        d1 = d1.addDays(1);
+      }
+    } else {
+      monthentries.append( MonthEventStruct( e->dtStart(), e->dtEnd(), e ) );
+    }
+  }
+  qHeapSort( monthentries );
+
+  QValueList<MonthEventStruct>::ConstIterator mit = monthentries.begin();
+  QDateTime endofmonth( end, QTime(0,0,0) );
+  endofmonth = endofmonth.addDays(1);
+  for ( ; mit != monthentries.end(); ++mit ) {
+    if ( (*mit).start.date() == (*mit).end.date() ) {
+      // Show also single-day events as time line boxes
+      if ( subDailyFlags & TimeBoxes ) {
+        timeboxItems.append( new PrintCellItem( (*mit).event, (*mit).start, (*mit).end ) );
+      }
+      // Show as text in the box
+      if ( subDailyFlags & Text ) {
+        textEvents[ (*mit).start.date().day() ] << (*mit).event->summary();
+      }
+    } else {
+      // Multi-day events are always shown as time line boxes
+      QDateTime thisstart( (*mit).start );
+      QDateTime thisend( (*mit).end );
+      if ( thisstart.date()<start ) thisstart = start;
+      if ( thisend>endofmonth ) thisend = endofmonth;
+      timeboxItems.append( new PrintCellItem( (*mit).event, thisstart, thisend ) );
+    }
+  }
+  
+  // For Multi-day events, line them up nicely so that the boxes don't overlap
+  QPtrListIterator<KOrg::CellItem> it1( timeboxItems );
+  for( it1.toFirst(); it1.current(); ++it1 ) {
+    KOrg::CellItem *placeItem = it1.current();
+    KOrg::CellItem::placeItem( timeboxItems, placeItem );
+  }
+  QDateTime starttime( start, QTime( 0, 0, 0 ) );
+  int newxstartcont = xstartcont;
+  
+  QFont oldfont( p.font() );
+  p.setFont( QFont( "sans-serif", 7 ) );
+  for( it1.toFirst(); it1.current(); ++it1 ) {
+    PrintCellItem *placeItem = static_cast<PrintCellItem *>( it1.current() );
+    int minsToStart = starttime.secsTo( placeItem->start() )/60;
+    int minsToEnd = starttime.secsTo( placeItem->end() )/60;
+
+    QRect eventBox( xstartcont + placeItem->subCell()*17, 
+           daysBox.top() + round( double( minsToStart*daysBox.height()) / double(maxdays*24*60) ), 
+           14, 0 );
+    eventBox.setBottom( daysBox.top() + round( double( minsToEnd*daysBox.height()) / double(maxdays*24*60) ) );
+    drawVerticalBox( p, eventBox, placeItem->event()->summary() );
+    newxstartcont = QMAX( newxstartcont, eventBox.right() );
+  }
+  xstartcont = newxstartcont;
+
+  // For Single-day events, simply print their summaries into the remaining
+  // space of the day's cell
+  for ( int d=0; d<daysinmonth; ++d ) {
+    QStringList dayEvents( textEvents[d+1] );
+    QString txt = dayEvents.join(", ");
+    QRect dayBox( xstartcont, daysBox.top()+round(dayheight*d), 0, 0 );
+    dayBox.setRight( box.right() );
+    dayBox.setBottom( daysBox.top()+round(dayheight*(d+1)) );
+    printEventString(p, dayBox, txt, Qt::AlignTop | Qt::AlignLeft | Qt::BreakAnywhere );
+  }
+  p.setFont( oldfont );
+//   p.setBrush( Qt::NoBrush );
+  drawBox( p, BOX_BORDER_WIDTH, borderBox );
+  p.restore();
+}
+
+///////////////////////////////////////////////////////////////////////////////
+
+void CalPrintPluginBase::drawMonthTable(QPainter &p, const QDate &qd, bool weeknumbers,
+                               bool recurDaily, bool recurWeekly,
+                               const QRect &box)
+{
+  int yoffset = mSubHeaderHeight;
+  int xoffset = 0;
+  QDate monthDate(QDate(qd.year(), qd.month(), 1));
+  QDate monthFirst(monthDate);
+  QDate monthLast(monthDate.addMonths(1).addDays(-1));
+
+
+  int weekdayCol = weekdayColumn( monthDate.dayOfWeek() );
+  monthDate = monthDate.addDays(-weekdayCol);
+
+  if (weeknumbers) {
+    xoffset += 14;
+  }
+
+  int rows=(weekdayCol + qd.daysInMonth() - 1)/7 +1;
+  double cellHeight = ( box.height() - yoffset ) / (1.*rows);
+  double cellWidth = ( box.width() - xoffset ) / 7.;
+
+  // Precalculate the grid...
+  // rows is at most 6, so using 8 entries in the array is fine, too!
+  int coledges[8], rowedges[8];
+  for ( int i = 0; i <= 7; i++ ) {
+    rowedges[i] = int( box.top() + yoffset + i*cellHeight );
+    coledges[i] = int( box.left() + xoffset + i*cellWidth );
+  }
+
+  if (weeknumbers) {
+    QFont oldFont(p.font());
+    QFont newFont(p.font());
+    newFont.setPointSize(6);
+    p.setFont(newFont);
+    QDate weekDate(monthDate);
+    for (int row = 0; row<rows; ++row ) {
+      int calWeek = weekDate.weekNumber();
+      QRect rc( box.left(), rowedges[row], coledges[0] - 3 - box.left(), rowedges[row+1]-rowedges[row] );
+      p.drawText( rc, Qt::AlignRight | Qt::AlignVCenter, QString::number( calWeek ) );
+      weekDate = weekDate.addDays( 7 );
+    }
+    p.setFont( oldFont );
+  }
+
+  QRect daysOfWeekBox( box );
+  daysOfWeekBox.setHeight( mSubHeaderHeight );
+  daysOfWeekBox.setLeft( box.left()+xoffset );
+  drawDaysOfWeek( p, monthDate, monthDate.addDays( 6 ), daysOfWeekBox );
+
+  QColor back = p.backgroundColor();
+  bool darkbg = false;
+  for ( int row = 0; row < rows; ++row ) {
+    for ( int col = 0; col < 7; ++col ) {
+      // show days from previous/next month with a grayed background
+      if ( (monthDate < monthFirst) || (monthDate > monthLast) ) {
+        p.setBackgroundColor( back.dark( 120 ) );
+        darkbg = true;
+      }
+      QRect dayBox( coledges[col], rowedges[row], coledges[col+1]-coledges[col], rowedges[row+1]-rowedges[row] );
+      drawDayBox(p, monthDate, dayBox, false, recurDaily, recurWeekly );
+      if ( darkbg ) {
+        p.setBackgroundColor( back );
+        darkbg = false;
+      }
+      monthDate = monthDate.addDays(1);
+    }
+  }
+}
+
+
+///////////////////////////////////////////////////////////////////////////////
+
+void CalPrintPluginBase::drawTodo( int &count, Todo *todo, QPainter &p,
+                               TodoSortField sortField, SortDirection sortDir,
+                               bool connectSubTodos, bool strikeoutCompleted,
+                               bool desc, int posPriority, int posSummary,
+                               int posDueDt, int posPercentComplete,
+                               int level, int x, int &y, int width,
+                               int pageHeight, const Todo::List &todoList,
+                               TodoParentStart *r )
+{
+  QString outStr;
+  const KLocale *local = KGlobal::locale();
+  QRect rect;
+  TodoParentStart startpt;
+
+  // This list keeps all starting points of the parent to-dos so the connection
+  // lines of the tree can easily be drawn (needed if a new page is started)
+  static QPtrList<TodoParentStart> startPoints;
+  if ( level < 1 ) {
+    startPoints.clear();
+  }
+
+  // Compute the right hand side of the to-do box
+  int rhs = posPercentComplete;
+  if ( rhs < 0 ) rhs = posDueDt; //not printing percent completed
+  if ( rhs < 0 ) rhs = x+width;  //not printing due dates either
+
+  // size of to-do
+  outStr=todo->summary();
+  int left = posSummary + ( level*10 );
+  rect = p.boundingRect( left, y, ( rhs-left-5 ), -1, Qt::WordBreak, outStr );
+  if ( !todo->description().isEmpty() && desc ) {
+    outStr = todo->description();
+    rect = p.boundingRect( left+20, rect.bottom()+5, width-(left+10-x), -1,
+                           Qt::WordBreak, outStr );
+  }
+  // if too big make new page
+  if ( rect.bottom() > pageHeight ) {
+    // first draw the connection lines from parent to-dos:
+    if ( level > 0 && connectSubTodos ) {
+      TodoParentStart *rct;
+      for ( rct = startPoints.first(); rct; rct = startPoints.next() ) {
+        int start;
+        int center = rct->mRect.left() + (rct->mRect.width()/2);
+        int to = p.viewport().bottom();
+
+        // draw either from start point of parent or from top of the page
+        if ( rct->mSamePage )
+          start = rct->mRect.bottom() + 1;
+        else
+          start = p.viewport().top();
+        p.moveTo( center, start );
+        p.lineTo( center, to );
+        rct->mSamePage = false;
+      }
+    }
+    y=0;
+    mPrinter->newPage();
+  }
+
+  // If this is a sub-to-do, r will not be 0, and we want the LH side
+  // of the priority line up to the RH side of the parent to-do's priority
+  bool showPriority = posPriority>=0;
+  int lhs = posPriority;
+  if ( r ) {
+    lhs = r->mRect.right() + 1;
+  }
+
+  outStr.setNum( todo->priority() );
+  rect = p.boundingRect( lhs, y + 10, 5, -1, Qt::AlignCenter, outStr );
+  // Make it a more reasonable size
+  rect.setWidth(18);
+  rect.setHeight(18);
+
+  // Draw a checkbox
+  p.setBrush( QBrush( Qt::NoBrush ) );
+  p.drawRect( rect );
+  if ( todo->isCompleted() ) {
+    // cross out the rectangle for completed to-dos
+    p.drawLine( rect.topLeft(), rect.bottomRight() );
+    p.drawLine( rect.topRight(), rect.bottomLeft() );
+  }
+  lhs = rect.right() + 3;
+
+  // Priority
+  if ( todo->priority() > 0 && showPriority ) {
+    p.drawText( rect, Qt::AlignCenter, outStr );
+  }
+  startpt.mRect = rect; //save for later
+
+  // Connect the dots
+  if ( level > 0 && connectSubTodos ) {
+    int bottom;
+    int center( r->mRect.left() + (r->mRect.width()/2) );
+    if ( r->mSamePage )
+      bottom = r->mRect.bottom() + 1;
+    else
+      bottom = 0;
+    int to( rect.top() + (rect.height()/2) );
+    int endx( rect.left() );
+    p.moveTo( center, bottom );
+    p.lineTo( center, to );
+    p.lineTo( endx, to );
+  }
+
+  // summary
+  outStr=todo->summary();
+  rect = p.boundingRect( lhs, rect.top(), (rhs-(left + rect.width() + 5)),
+                         -1, Qt::WordBreak, outStr );
+
+  QRect newrect;
+  //FIXME: the following code prints underline rather than strikeout text
+#if 0
+  QFont f( p.font() );
+  if ( todo->isCompleted() && strikeoutCompleted ) {
+    f.setStrikeOut( true );
+    p.setFont( f );
+  }
+  p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
+  f.setStrikeOut( false );
+  p.setFont( f );
 #endif
+  //TODO: Remove this section when the code above is fixed
+  p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
+  if ( todo->isCompleted() && strikeoutCompleted ) {
+    // strike out the summary text if to-do is complete
+    // Note: we tried to use a strike-out font and for unknown reasons the
+    // result was underline instead of strike-out, so draw the lines ourselves.
+    int delta = p.fontMetrics().lineSpacing();
+    int lines = ( rect.height() / delta ) + 1;
+    for ( int i=0; i<lines; i++ ) {
+      p.moveTo( rect.left(),  rect.top() + ( delta/2 ) + ( i*delta ) );
+      p.lineTo( rect.right(), rect.top() + ( delta/2 ) + ( i*delta ) );
+    }
+  }
+
+  // due date
+  if ( todo->hasDueDate() && posDueDt>=0 ) {
+    outStr = local->formatDate( todo->dtDue().date(), true );
+    rect = p.boundingRect( posDueDt, y, x + width, -1,
+                           Qt::AlignTop | Qt::AlignLeft, outStr );
+    p.drawText( rect, Qt::AlignTop | Qt::AlignLeft, outStr );
+  }
+
+  // percentage completed
+  bool showPercentComplete = posPercentComplete>=0;
+  if ( showPercentComplete ) {
+    int lwidth = 24;
+    int lheight = 12;
+    //first, draw the progress bar
+    int progress = (int)(( lwidth*todo->percentComplete())/100.0 + 0.5);
+
+    p.setBrush( QBrush( Qt::NoBrush ) );
+    p.drawRect( posPercentComplete, y+3, lwidth, lheight );
+    if ( progress > 0 ) {
+      p.setBrush( QColor( 128, 128, 128 ) );
+      p.drawRect( posPercentComplete, y+3, progress, lheight );
+    }
+
+    //now, write the percentage
+    outStr = i18n( "%1%" ).arg( todo->percentComplete() );
+    rect = p.boundingRect( posPercentComplete+lwidth+3, y, x + width, -1,
+                           Qt::AlignTop | Qt::AlignLeft, outStr );
+    p.drawText( rect, Qt::AlignTop | Qt::AlignLeft, outStr );
+  }
+
+  // description
+  if ( !todo->description().isEmpty() && desc ) {
+    y = newrect.bottom() + 5;
+    outStr = todo->description();
+    rect = p.boundingRect( left+20, y, x+width-(left+10), -1,
+                           Qt::WordBreak, outStr );
+    p.drawText( rect, Qt::WordBreak, outStr, -1, &newrect );
+  }
+
+  // Set the new line position
+  y = newrect.bottom() + 10; //set the line position
+
+  // If the to-do has sub-to-dos, we need to call ourselves recursively
+#if 0
+  Incidence::List l = todo->relations();
+  Incidence::List::ConstIterator it;
+  startPoints.append( &startpt );
+  for( it = l.begin(); it != l.end(); ++it ) {
+    count++;
+    // In the future, to-dos might also be related to events
+    // Manually check if the sub-to-do is in the list of to-dos to print
+    // The problem is that relations() does not apply filters, so
+    // we need to compare manually with the complete filtered list!
+    Todo* subtodo = dynamic_cast<Todo *>( *it );
+    if (subtodo && todoList.contains( subtodo ) ) {
+      drawTodo( count, subtodo, p, connectSubTodos, strikeoutCompleted,
+                desc, posPriority, posSummary, posDueDt, posPercentComplete,
+                level+1, x, y, width, pageHeight, todoList, &startpt );
+    }
+  }
+#endif
+  // Make a list of all the sub-to-dos related to this to-do.
+  Todo::List t;
+  Incidence::List l = todo->relations();
+  Incidence::List::ConstIterator it;
+  for( it=l.begin(); it!=l.end(); ++it ) {
+    // In the future, to-dos might also be related to events
+    // Manually check if the sub-to-do is in the list of to-dos to print
+    // The problem is that relations() does not apply filters, so
+    // we need to compare manually with the complete filtered list!
+    Todo* subtodo = dynamic_cast<Todo *>( *it );
+    if ( subtodo && todoList.contains( subtodo ) ) {
+      t.append( subtodo );
+    }
+  }
+
+  // Sort the sub-to-dos and then print them
+  Todo::List sl = mCalendar->sortTodos( &t, sortField, sortDir );
+  Todo::List::ConstIterator isl;
+  startPoints.append( &startpt );
+  for( isl = sl.begin(); isl != sl.end(); ++isl ) {
+    count++;
+    drawTodo( count, ( *isl ), p, sortField, sortDir,
+              connectSubTodos, strikeoutCompleted,
+              desc, posPriority, posSummary, posDueDt, posPercentComplete,
+              level+1, x, y, width, pageHeight, todoList, &startpt );
+  }
+  startPoints.remove( &startpt );
+}
+
+int CalPrintPluginBase::weekdayColumn( int weekday )
+{
+  return ( weekday + 7 - KGlobal::locale()->weekStartDay() ) % 7;
+}
+
+void CalPrintPluginBase::drawJournalField( QPainter &p, QString field, QString text,
+                                       int x, int &y, int width, int pageHeight )
+{
+  if ( text.isEmpty() ) return;
+
+  QString entry( field.arg( text ) );
+
+  QRect rect( p.boundingRect( x, y, width, -1, Qt::WordBreak, entry) );
+  if ( rect.bottom() > pageHeight) {
+    // Start new page...
+    // FIXME: If it's a multi-line text, draw a few lines on this page, and the
+    // remaining lines on the next page.
+    y=0;
+    mPrinter->newPage();
+    rect = p.boundingRect( x, y, width, -1, Qt::WordBreak, entry);
+  }
+  QRect newrect;
+  p.drawText( rect, Qt::WordBreak, entry, -1, &newrect );
+  y = newrect.bottom() + 7;
+}
+
+void CalPrintPluginBase::drawJournal( Journal * journal, QPainter &p, int x, int &y,
+                                  int width, int pageHeight )
+{
+  QFont oldFont( p.font() );
+  p.setFont( QFont( "sans-serif", 15 ) );
+  QString headerText;
+  QString dateText( KGlobal::locale()->
+        formatDate( journal->dtStart().date(), false ) );
+
+  if ( journal->summary().isEmpty() ) {
+    headerText = dateText;
+  } else {
+    headerText = i18n("Description - date", "%1 - %2")
+                     .arg( journal->summary() )
+                     .arg( dateText );
+  }
+
+  QRect rect( p.boundingRect( x, y, width, -1, Qt::WordBreak, headerText) );
+  if ( rect.bottom() > pageHeight) {
+    // Start new page...
+    y=0;
+    mPrinter->newPage();
+    rect = p.boundingRect( x, y, width, -1, Qt::WordBreak, headerText );
+  }
+  QRect newrect;
+  p.drawText( rect, Qt::WordBreak, headerText, -1, &newrect );
+  p.setFont( oldFont );
+
+  y = newrect.bottom() + 4;
+
+  p.drawLine( x + 3, y, x + width - 6, y );
+  y += 5;
+
+  drawJournalField( p, i18n("Person: %1"), journal->organizer().fullName(), x, y, width, pageHeight );
+  drawJournalField( p, i18n("%1"), journal->description(), x, y, width, pageHeight );
+  y += 10;
+}
+
+
+void CalPrintPluginBase::drawSplitHeaderRight( QPainter &p, const QDate &fd,
+                                           const QDate &td,
+                                           const QDate &,
+                                           int width, int )
+{
+  QFont oldFont( p.font() );
+
+  QPen oldPen( p.pen() );
+  QPen pen( Qt::black, 4 );
+
+  QString title;
+  if ( mCalSys ) {
+    if ( fd.month() == td.month() ) {
+      title = i18n("Date range: Month dayStart - dayEnd", "%1 %2 - %3")
+        .arg( mCalSys->monthName( fd.month(), false ) )
+        .arg( mCalSys->dayString( fd, false ) )
+        .arg( mCalSys->dayString( td, false ) );
+    } else {
+      title = i18n("Date range: monthStart dayStart - monthEnd dayEnd", "%1 %2 - %3 %4")
+        .arg( mCalSys->monthName( fd.month(), false ) )
+        .arg( mCalSys->dayString( fd, false ) )
+        .arg( mCalSys->monthName( td.month(), false ) )
+        .arg( mCalSys->dayString( td, false ) );
+    }
+  }
+
+  QFont serifFont("Times", 30);
+  p.setFont(serifFont);
+
+  int lineSpacing = p.fontMetrics().lineSpacing();
+  p.drawText( 0, lineSpacing * 0, width, lineSpacing,
+              Qt::AlignRight | Qt::AlignTop, title );
+
+  title.truncate(0);
+
+  p.setPen( pen );
+  p.drawLine(300, lineSpacing * 1, width, lineSpacing * 1);
+  p.setPen( oldPen );
+
+  p.setFont(QFont("Times", 20, QFont::Bold, TRUE));
+  int newlineSpacing = p.fontMetrics().lineSpacing();
+  title += QString::number(fd.year());
+  p.drawText( 0, lineSpacing * 1 + 4, width, newlineSpacing,
+              Qt::AlignRight | Qt::AlignTop, title );
+
+  p.setFont( oldFont );
+}
+
+#endif
Index: korganizer/printing/Makefile.am
===================================================================
--- korganizer/printing/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,10 +15,11 @@
 libkocorehelper_la_LIBADD  = $(LIB_KDEUI)
 libkocorehelper_la_SOURCES = cellitem.cpp
 
-libkorg_stdprinting_la_SOURCES = calprinter.cpp calprinthelper.cpp calprintpluginbase.cpp \
+libkorg_stdprinting_la_SOURCES = calprinter.cpp calprintpluginbase.cpp \
         calprintdefaultplugins.cpp \
         calprintdayconfig_base.ui calprintmonthconfig_base.ui \
-        calprinttodoconfig_base.ui calprintweekconfig_base.ui
+        calprinttodoconfig_base.ui calprintweekconfig_base.ui \
+        calprintincidenceconfig_base.ui
 libkorg_stdprinting_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) \
                                  -no-undefined -version-info 1:0
 libkorg_stdprinting_la_LIBADD = $(LIB_KDEUI) libkocorehelper.la \
@@ -28,6 +29,6 @@
 
 
 calprintdir = $(includedir)/korganizer
-calprint_HEADERS = calprinthelper.h calprintpluginbase.h calprinter.h
+calprint_HEADERS = calprintpluginbase.h calprinter.h
 noinst_HEADERS = cellitem.h
 
Index: korganizer/printing/calprintdefaultplugins.h
===================================================================
--- korganizer/printing/calprintdefaultplugins.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprintdefaultplugins.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -35,7 +35,48 @@
 }
 
 using namespace KCal;
+using namespace KOrg;
 
+class CalPrintIncidence : public CalPrintPluginBase
+{
+  public:
+    CalPrintIncidence();
+    virtual ~CalPrintIncidence();
+    virtual QString description() { return i18n("Print &incidence"); }
+    virtual QString info() { return i18n("Prints an incidence on one page"); }
+    virtual int sortID() { return CalPrinterBase::Incidence; }
+    // Enable the Print Incidence option only if there are selected incidences.
+    virtual bool enabled()
+      {
+        if ( mSelectedIncidences.count() > 0 ) {
+          return true;
+        } else {
+          return false;
+        }
+      }
+    virtual QWidget *createConfigWidget(QWidget*);
+    virtual KPrinter::Orientation defaultOrientation()
+      { return KPrinter::Portrait; }
+
+  public:
+    void print( QPainter &p, int width, int height );
+    virtual void readSettingsWidget();
+    virtual void setSettingsWidget();
+    virtual void loadConfig();
+    virtual void saveConfig();
+  protected:
+    int printCaptionAndText( QPainter &p, const QRect &box, const QString &caption, 
+           const QString &text, QFont captionFont, QFont textFont );
+  
+
+  protected:
+    bool mShowOptions;
+    bool mShowSubitemsNotes;
+    bool mShowAttendees;
+    bool mShowAttachments;
+};
+
+
 class CalPrintDay : public CalPrintPluginBase
 {
   public:
@@ -43,6 +84,8 @@
     virtual ~CalPrintDay();
     virtual QString description() { return i18n("Print da&y"); }
     virtual QString info() { return i18n("Prints all events of a single day on one page"); }
+    virtual int sortID() { return CalPrinterBase::Day; }
+    virtual bool enabled() { return true; }
     virtual QWidget *createConfigWidget( QWidget* );
 
   public:
@@ -66,8 +109,13 @@
     virtual ~CalPrintWeek();
     virtual QString description() { return i18n("Print &week"); }
     virtual QString info() { return i18n("Prints all events of one week on one page"); }
+    virtual int sortID() { return CalPrinterBase::Week; }
+    virtual bool enabled() { return true; }
     virtual QWidget *createConfigWidget(QWidget*);
-    virtual KPrinter::Orientation orientation();
+    /**
+      Returns the default orientation for the eWeekPrintType.
+    */
+    virtual KPrinter::Orientation defaultOrientation();
 
   public:
     void print(QPainter &p, int width, int height);
@@ -90,8 +138,10 @@
     virtual ~CalPrintMonth();
     virtual QString description() { return i18n("Print mont&h"); }
     virtual QString info() { return i18n("Prints all events of one month on one page"); }
+    virtual int sortID() { return CalPrinterBase::Month; }
+    virtual bool enabled() { return true; }
     virtual QWidget *createConfigWidget(QWidget*);
-    virtual KPrinter::Orientation orientation() { return KPrinter::Landscape; }
+    virtual KPrinter::Orientation defaultOrientation() { return KPrinter::Landscape; }
 
   public:
     void print(QPainter &p, int width, int height);
@@ -115,6 +165,8 @@
     virtual ~CalPrintTodos();
     virtual QString description() { return i18n("Print to-&dos"); }
     virtual QString info() { return i18n("Prints all to-dos in a (tree-like) list"); }
+    virtual int sortID() { return CalPrinterBase::Todolist; }
+    virtual bool enabled() { return true; }
     virtual QWidget *createConfigWidget(QWidget*);
 
   public:
Index: korganizer/printing/calprinter.h
===================================================================
--- korganizer/printing/calprinter.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprinter.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -40,14 +40,11 @@
 
 class QVButtonGroup;
 class QWidgetStack;
-class KPrinter;
 class CalPrintDialog;
 class KConfig;
 class QComboBox;
 class QLabel;
-class CalPrintHelper;
 
-
 /**
   CalPrinter is a class for printing Calendars.  It can print in several
   different formats (day, week, month).  It also provides a way for setting
@@ -73,7 +70,7 @@
     CalPrinter( QWidget *par, Calendar *cal, KOrg::CoreHelper *helper );
     virtual ~CalPrinter();
 
-    void init( KPrinter *printer, Calendar *calendar );
+    void init( Calendar *calendar );
 
     /**
       Set date range to be printed.
@@ -87,13 +84,12 @@
     void updateConfig();
 
   private slots:
-    void doPrint( KOrg::PrintPlugin *selectedStyle, bool preview );
+    void doPrint( KOrg::PrintPlugin *selectedStyle, CalPrinter::ePrintOrientation dlgorientation, bool preview = false );
 
   public:
-    void preview( PrintType type, const QDate &fd, const QDate &td );
-    void print( PrintType type, const QDate &fd, const QDate &td );
+    void print( int type, const QDate &fd, const QDate &td, 
+                Incidence::List selectedIncidences = Incidence::List(), bool preview = false );
 
-    KPrinter *printer() const;
     Calendar *calendar() const;
     KConfig *config() const;
 
@@ -101,23 +97,21 @@
     KOrg::PrintPlugin::List mPrintPlugins;
 
   private:
-    KPrinter *mPrinter;
     Calendar *mCalendar;
     QWidget *mParent;
     KConfig *mConfig;
     KOrg::CoreHelper *mCoreHelper;
-    CalPrintHelper *mHelper;
-    CalPrintDialog *mPrintDialog;
 };
 
 class CalPrintDialog : public KDialogBase
 {
     Q_OBJECT
   public:
-    CalPrintDialog( KOrg::PrintPlugin::List plugins, KPrinter *p,
+    CalPrintDialog( KOrg::PrintPlugin::List plugins,
                     QWidget *parent = 0, const char *name = 0 );
     virtual ~CalPrintDialog();
     KOrg::PrintPlugin *selectedPlugin();
+    void setOrientation( CalPrinter::ePrintOrientation orientation );
     CalPrinter::ePrintOrientation orientation() { return mOrientation; }
 
   public slots:
@@ -128,10 +122,9 @@
     void slotOk();
 
   private:
-    KPrinter *mPrinter;
     QVButtonGroup *mTypeGroup;
     QWidgetStack *mConfigArea;
-    KOrg::PrintPlugin::List mPrintPlugins;
+    QMap<int, KOrg::PrintPlugin*> mPluginIDs;
     QString mPreviewText;
     QComboBox *mOrientationSelection;
 
Index: korganizer/printing/calprintincidenceconfig_base.ui
===================================================================
--- korganizer/printing/calprintincidenceconfig_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/printing/calprintincidenceconfig_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,103 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>CalPrintIncidenceConfig_Base</class>
+<comment>Configuration page for printing incidences.</comment>
+<author>Reinhold Kainhofer &lt;reinhold@kainhofer.com&gt;</author>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>CalPrintIncidence_Base</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>277</width>
+            <height>206</height>
+        </rect>
+    </property>
+    <property name="caption">
+        <string>CalPrintIncidence_Base</string>
+    </property>
+    <vbox>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="QButtonGroup">
+            <property name="name">
+                <cstring>mComponentsGroup</cstring>
+            </property>
+            <property name="title">
+                <string>Include Information</string>
+            </property>
+            <property name="selectedId" stdset="0">
+                <number>-1</number>
+            </property>
+            <vbox>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QCheckBox">
+                    <property name="name">
+                        <cstring>mShowDetails</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Detai&amp;ls (visiblility, secrecy, etc.)</string>
+                    </property>
+                </widget>
+                <widget class="QCheckBox">
+                    <property name="name">
+                        <cstring>mShowSubitemsNotes</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Notes, Subitems</string>
+                    </property>
+                </widget>
+                <widget class="QCheckBox">
+                    <property name="name">
+                        <cstring>mShowAttendees</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Attendees</string>
+                    </property>
+                </widget>
+                <widget class="QCheckBox">
+                    <property name="name">
+                        <cstring>mShowAttachments</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Attach&amp;ments</string>
+                    </property>
+                </widget>
+            </vbox>
+        </widget>
+        <widget class="QCheckBox">
+            <property name="name">
+                <cstring>mColors</cstring>
+            </property>
+            <property name="text">
+                <string>&amp;Use colors</string>
+            </property>
+            <property name="whatsThis" stdset="0">
+                <string>If you want to use colors to distinguish certain categories on the print, check this option.</string>
+            </property>
+        </widget>
+        <spacer>
+            <property name="name">
+                <cstring>spacer3</cstring>
+            </property>
+            <property name="orientation">
+                <enum>Vertical</enum>
+            </property>
+            <property name="sizeType">
+                <enum>Expanding</enum>
+            </property>
+            <property name="sizeHint">
+                <size>
+                    <width>21</width>
+                    <height>201</height>
+                </size>
+            </property>
+        </spacer>
+    </vbox>
+</widget>
+<layoutdefaults spacing="6" margin="11"/>
+</UI>
Index: korganizer/printing/calprintpluginbase.h
===================================================================
--- korganizer/printing/calprintpluginbase.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprintpluginbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -31,21 +31,30 @@
 #include <qdatetime.h>
 #include <kprinter.h>
 #include <kdepimmacros.h>
+#include <libkcal/calendar.h>
 #include <libkcal/event.h>
+#include <libkcal/todo.h>
 #include "korganizer/printplugin.h"
 #include "korganizer/corehelper.h"
 
+
 class PrintCellItem;
-class CalPrintHelper;
 
-namespace KCal {
-class Calendar;
-class Todo;
-}
 class QWidget;
 
 using namespace KCal;
 
+
+#define PORTRAIT_HEADER_HEIGHT 72   // header height, for portrait orientation
+#define LANDSCAPE_HEADER_HEIGHT 54  // header height, for landscape orientation
+#define SUBHEADER_HEIGHT 20         // subheader height, for all orientations
+#define MARGIN_SIZE 36              // margins, for all orientations
+#define PADDING_SIZE 7              // padding between the various top-level boxes
+#define BOX_BORDER_WIDTH 2          // width of the border of all top-level boxes
+#define EVENT_BORDER_WIDTH 0        // with of the border of all incidence boxes
+
+#define TIMELINE_WIDTH 50           // width of timeline (day and timetable)
+
 /**
   Base class for KOrganizer printing classes. Each sub class represents one
   calendar print format.
@@ -53,11 +62,17 @@
 class KDE_EXPORT CalPrintPluginBase : public KOrg::PrintPlugin
 {
   public:
+    enum DisplayFlags {
+      Text=0x0001,
+      TimeBoxes=0x0002
+    };
+
+  public:
     /**
       Constructor
     */
-    CalPrintPluginBase() : KOrg::PrintPlugin() {}
-    virtual ~CalPrintPluginBase() {}
+    CalPrintPluginBase();
+    virtual ~CalPrintPluginBase();
 
     /**
       Returns widget for configuring the print format.
@@ -75,7 +90,7 @@
     /**
       Start printing.
     */
-    virtual void doPrint();
+    virtual void doPrint( KPrinter *printer );
 
     /**
       Load print format configuration from config file.
@@ -95,14 +110,403 @@
     */
     void doSaveConfig();
 
-  protected:
-    bool mUseColors;
-
+  /** HELPER FUNCTIONS */
   public:
+    void setKOrgCoreHelper( KOrg::CoreHelper*helper );
+    bool useColors() const;
+    void setUseColors( bool useColors );
+    
+    /** Helper functions to hide the KOrg::CoreHelper */
+    QColor categoryBgColor( Incidence *incidence );
+    QColor textColor( const QColor &color );
+    QTime dayStart();
+    bool isWorkingDay( const QDate &dt );
+    QString holidayString( const QDate &dt );
+    Event *holiday( const QDate &dt );
+    
     /**
+      Determines the column of the given weekday ( 1=Monday, 7=Sunday ), taking the
+      start of the week setting into account as given in kcontrol.
+      \param weekday Index of the weekday
+    */
+    static int weekdayColumn( int weekday );
+    void setCategoryColors( QPainter &p, Incidence *incidence );
+
+    KPrinter::Orientation orientation() const;
+
+    /** Returns the height of the page header. If the height was explicitly
+        set using setHeaderHeight, that value is returned, otherwise a 
+        default value based on the printer orientation.
+        \return height of the page header of the printout
+    */
+    int headerHeight() const;
+    void setHeaderHeight( const int height );
+
+    int subHeaderHeight() const;
+    void setSubHeaderHeight( const int height );
+
+    int margin() const;
+    void setMargin( const int margin );
+    
+    int padding() const;
+    void setPadding( const int margin );
+    
+    int borderWidth() const;
+    void setBorderWidth( const int border );
+
+    const KCalendarSystem *calendarSystem() const;
+    void setCalendarSystem( const KCalendarSystem *calsys );
+
+
+  /*****************************************************************
+   **               PRINTING HELPER FUNCTIONS                     **
+   *****************************************************************/
+  public: 
+    /**
+      Draw a box with given width at the given coordinates.
+      \param p The printer to be used
+      \param linewidth The border width of the box
+      \param rect The rectangle of the box
+    */
+    static void drawBox( QPainter &p, int linewidth, const QRect &rect );
+    /**
+      Draw a shaded box with given width at the given coordinates.
+      \param p The printer to be used
+      \param linewidth The border width of the box
+      \param brush The brush to fill the box
+      \param rect The rectangle of the box
+    */
+    static void drawShadedBox( QPainter &p, int linewidth, const QBrush &brush, const QRect &rect );
+  
+    /**
+      Print the given string (event summary) in the given rectangle. Margins
+      and justification (centered or not) are automatically adjusted.
+      \param p QPainter of the printout
+      \param box Coordinates of the surrounding event box
+      \param str The text to be printed in the box
+    */
+    void printEventString( QPainter &p, const QRect &box, const QString &str, int flags = -1 );
+
+    /**
+      Print the box for the given event with the given string.
+      \param p QPainer of the printout
+      \param box Coordinates of the event's box
+      \param incidence The incidence (if available), from which the category
+                       color will be deduced, if applicable.
+      \param str The string to print inside the box
+    */
+    void showEventBox( QPainter &p, const QRect &box, Incidence *incidence, const QString &str, int flags = -1 );
+    
+    /** 
+      Draw a subheader box with a shaded background and the given string
+      \param p QPainter of the printout
+      \param str Text to be printed inside the box
+      \param box Coordinates of the box
+    */
+    void drawSubHeaderBox(QPainter &p, const QString &str, const QRect &box );
+    
+    /**
+      Draw an event box with vertical text.
+      \param p QPainter of the printout
+      \param box Coordinates of the box
+      \param str ext to be printed inside the box
+    */
+    void drawVerticalBox( QPainter &p, const QRect &box, const QString &str );
+    
+    /**
+      Draw a component box with a heading (printed in bold). 
+      \param p QPainter of the printout
+      \param box Coordinates of the box
+      \param caption Caption string to be printed inside the box
+      \param contents Normal text contents of the box. If contents.isNull(),
+                      then no text will be printed, only the caption.
+      \param sameLine Whether the contents should start on the same line as
+                      the caption (the space below the caption text will be
+                      used as indentation in the subsequent lines) or on the 
+                      next line (no indentation of the contents)
+      \param expand Whether to expand the box vertically to fit the
+                    whole text in it.
+      \return The bottom of the printed box. If expand==true, the bottom of
+              the drawn box is returned, if expand==false, the vertical
+              end of the printed contents inside the box is returned.
+              If you want to print some custom graphics or text below
+              the contents, use the return value as the top-value of your
+              custom contents in that case.
+    */
+    int drawBoxWithCaption( QPainter &p, const QRect &box, const QString &caption,
+                            const QString &contents, 
+                            bool sameLine, bool expand, const QFont &captionFont, const QFont &textFont );
+
+    /**
+      Draw the gray header bar of the printout to the QPainter.
+      It prints the given text and optionally one or two small
+      month views, as specified by the two QDate. The printed
+      text can also contain a line feed.
+      If month2 is invalid, only the month that contains month1
+      is printed.
+      E.g. the filofax week view draws just the current month,
+      while the month view draws the previous and the next month.
+      \param p QPainter of the printout
+      \param title The string printed as the title of the page
+                   (e.g. the date, date range or todo list title)
+      \param month1 Date specifying the month for the left one of
+                    the small month views in the title bar. If left
+                    empty, only month2 will be printed (or none,
+                    it that is invalid as well).
+      \param month2 Date specifying the month for the right one of
+                    the small month views in the title bar. If left
+                    empty, only month1 will be printed (or none,
+                    it that is invalid as well).
+      \param box coordinates of the title bar
+      \param expand Whether to expand the box vertically to fit the
+                    whole title in it.
+      \return The bottom of the printed box. If expand==false, this 
+              is box.bottom, otherwise it is larger than box.bottom
+              and matches the y-coordinate of the surrounding rectangle.
+    */
+    int drawHeader( QPainter &p, QString title,
+                     const QDate &month1, const QDate &month2,
+                     const QRect &box, bool expand = false );
+    /**
+      Draw a small calendar with the days of a month into the given area.
+      Used for example in the title bar of the sheet.
+      \param p QPainter of the printout
+      \param qd Arbitrary Date within the month to be printed.
+      \param box coordinates of the small calendar
+    */
+    void drawSmallMonth( QPainter &p, const QDate &qd, const QRect &box );
+
+    /**
+      Draw a horizontal bar with the weekday names of the given date range
+      in the given area of the painter.
+      This is used for the weekday-bar on top of the timetable view and the month view.
+      \param p QPainter of the printout
+      \param fromDate First date of the printed dates
+      \param toDate Last date of the printed dates
+      \param box coordinates of the box for the days of the week
+    */
+    void drawDaysOfWeek( QPainter &p,
+                         const QDate &fromDate, const QDate &toDate,
+                         const QRect &box );
+    /**
+      Draw a single weekday name in a box inside the given area of the painter.
+      This is called in a loop by drawDaysOfWeek.
+      \param p QPainter of the printout
+      \param qd Date of the printed day
+      \param box coordinates of the weekbox
+    */
+    void drawDaysOfWeekBox( QPainter &p, const QDate &qd, const QRect &box );
+    /**
+      Draw a (vertical) time scale from time fromTime to toTime inside the given area of the painter.
+      Every hour will have a one-pixel line over the whole width, every
+      half-hour the line will only span the left half of the width.
+      This is used in the day and timetable print styles
+      \param p QPainter of the printout
+      \param fromTime Start time of the time range to display
+      \param toTime End time of the time range to display
+      \param box coordinates of the timeline
+    */
+    void drawTimeLine( QPainter &p,
+                       const QTime &fromTime, const QTime &toTime,
+                       const QRect &box );
+  
+    /**
+      Draw the all-day box for the agenda print view (the box on top which
+      doesn't have a time on the time scale associated). If expandable is set,
+      height is the cell height of a single cell, and the returned height will
+      be the total height used for the all-day events. If !expandable, only one
+      cell will be used, and multiple events are concatenated using ", ".
+      \param p QPainter of the printout
+      \param eventList The list of all-day events that are supposed to be printed
+             inside this box
+      \param qd The date of the currently printed day
+      \param expandable If true, height is the height of one single cell, the printout
+             will use as many cells as events in the list and return the total height
+             needed for all of them. If false, height specifies the total height
+             allowed for all events, and the events are displayed in one cell,
+             with their summaries concatenated by ", ".
+      \param box coordinates of the all day box.
+      \return The height used for the all-day box.
+    */
+    int drawAllDayBox( QPainter &p, Event::List &eventList,
+                        const QDate &qd, bool expandable,
+                        const QRect &box );
+    /**
+      Draw the agenda box for the day print style (the box showing all events of that day).
+      Also draws a grid with half-hour spacing of the grid lines.
+      \param p QPainter of the printout
+      \param eventList The list of the events that are supposed to be printed
+             inside this box
+      \param qd The date of the currently printed day
+      \param expandable If true, the start and end times are adjusted to include
+             the whole range of all events of that day, not just of the given time range.
+             The height of the box will not be affected by this (but the height
+             of one hour will be scaled down so that the whole range fits into
+             the box. fromTime and toTime receive the actual time range printed
+             by this function).
+      \param fromTime Start of the time range to be printed. Might be adjusted
+                      to include all events if expandable==true
+      \param toTime End of the time range to be printed. Might be adjusted
+                   to include all events if expandable==true
+      \param box coordinates of the agenda day box.
+    */
+    void drawAgendaDayBox( QPainter &p, Event::List &eventList,
+                           const QDate &qd, bool expandable,
+                           QTime &fromTime, QTime &toTime,
+                           const QRect &box );
+
+    void drawAgendaItem( PrintCellItem *item, QPainter &p,
+                         const QDateTime &startPrintDate,
+                         const QDateTime &endPrintDate,
+                         float minlen, const QRect &box );
+  
+    /**
+      Draw the box containing a list of all events of the given day (with their times,
+      of course). Used in the Filofax and the month print style.
+      \param p QPainter of the printout
+      \param qd The date of the currently printed day. All events of the calendar
+                that appear on that day will be printed.
+      \param box coordinates of the day box.
+      \param fullDate Whether the title bar of the box should contain the full
+                      date string or just a short.
+      \param printRecurDaily Whether daily recurring incidences should be printed.
+      \param printRecurWeekly Whether weekly recurring incidences should be printed.
+    */
+    void drawDayBox( QPainter &p, const QDate &qd,
+                     const QRect &box,
+                     bool fullDate = false, bool printRecurDaily = true,
+                     bool printRecurWeekly = true );
+    /**
+      Draw the week (filofax) table of the week containing the date qd. The first
+      three days of the week will be shown in the first column (using drawDayBox),
+      the remaining four in the second column, where the last two days of the week
+      (typically Saturday and Sunday) only get half the height of the other day boxes.
+      \param p QPainter of the printout
+      \param qd Arbitrary date within the week to be printed.
+      \param box coordinates of the week box.
+    */
+    void drawWeek( QPainter &p, const QDate &qd,
+                   const QRect &box );
+    /**
+      Draw the timetable view of the given time range from fromDate to toDate.
+      On the left side the time scale is printed (using drawTimeLine), then each
+      day gets one column (printed using drawAgendaDayBox),
+      and the events are displayed as boxes (like in korganizer's day/week view).
+      The first cell of each column contains the all-day events (using
+      drawAllDayBox with expandable=false).
+      The given time range cannot be expanded to include all events.
+      \param p QPainter of the printout
+      \param fromDate First day to be included in the page
+      \param toDate Last day to be included in the page
+      \param fromTime Start time of the displayed time range
+      \param toTime End time of the displayed time range
+      \param box coordinates of the time table.
+    */
+    void drawTimeTable( QPainter &p, const QDate &fromDate, const QDate &toDate,
+                        QTime &fromTime, QTime &toTime,
+                        const QRect &box );
+
+    /**
+      Draw the month table of the month containing the date qd. Each day gets one
+      box (using drawDayBox) that contains a list of all events on that day. They are arranged
+      in a matrix, with the first column being the first day of the
+      week (so it might display some days of the previous and the next month).
+      Above the matrix there is a bar showing the weekdays (drawn using drawDaysOfWeek).
+      \param p QPainter of the printout
+      \param qd Arbitrary date within the month to be printed.
+      \param recurDaily Whether daily recurring incidences should be printed.
+      \param recurWeekly Whether weekly recurring incidences should be printed.
+      \param weeknumbers Whether the week numbers are printed left of each row of the matrix
+      \param box coordinates of the month.
+    */
+    void drawMonthTable( QPainter &p, const QDate &qd, bool weeknumbers,
+                    bool recurDaily, bool recurWeekly,
+                    const QRect &box );
+    /**
+      Draw a vertical representation of the month containing the date dt. Each
+      day gets one line.
+      \param p QPainter of the printout
+      \param dt Arbitrary date within the month to be printed
+      \param box coordinates of the box reserved for the month
+      \param maxdays Days to print. If a value of -1 is given, the number of days
+                     is deduced from the month. If maxdays is larger than the 
+                     number of days in the month, the remaining boxes are 
+                     shaded to indicate they are not days of the month.
+      \param subDailyFlags Bitfield consisting of DisplayFlags flags to determine
+                           how events that do not cross midnight should be printed.
+      \param holidaysFlags Bitfield consisting of DisplayFlags flags to determine
+                           how holidays should be printed.
+    */
+    void drawMonth( QPainter &p, const QDate &dt, const QRect &box, int maxdays = -1, int subDailyFlags = TimeBoxes, int holidaysFlags = Text );
+
+    /**
       Internal class representing the start of a todo.
     */
     class TodoParentStart;
+
+    /**
+      Draws single to-do and its (intented) sub-to-dos, optionally connects them by a tree-like line, and optionally shows due date, summary, description and priority.
+      \param count The number of the currently printed to-do (count will be incremented for each to-do drawn)
+      \param todo The to-do to be printed. It's sub-to-dos are recursively drawn, so drawTodo should only be called on the to-dos of the highest level.
+      \param p QPainter of the printout
+      \param sortField Specifies on which attribute of the todo you want to sort.
+      \param sortDir Specifies if you want to sort ascending or descending.
+      \param connectSubTodos Whether sub-to-dos shall be connected with their parent by a line (tree-like).
+      \param strikeoutCompleted Whether completed to-dos should be printed with strike-out summaries.
+      \param desc Whether to print the whole description of the to-do (the summary is always printed).
+      \param posPriority x-coordinate where the priority is supposed to be printed. If <0, no priority will be printed.
+      \param posSummary x-coordinate where the summary of the to-do is supposed to be printed.
+      \param posDueDt x-coordinate where the due date is supposed to the be printed. If <0, no due date will be printed.
+      \param posPercentComplete x-coordinate where the percentage complete is supposed to be printed. If <0, percentage complete will not be printed.
+      \param level Level of the current to-do in the to-do hierarchy (0 means highest level of printed to-dos, 1 are their sub-to-dos, etc.)
+      \param x x-coordinate of the upper left coordinate of the first to-do.
+      \param y y-coordinate of the upper left coordinate of the first to-do.
+      \param width width of the whole to-do list.
+      \param pageHeight Total height allowed for the to-do list on a page. If an to-do would be below that line, a new page is started.
+      \param todoList Contains a list of sub-todos for the specified @p todo .
+      \param r Internal (used when printing sub-to-dos to give information about its parent)
+    */
+    void drawTodo( int &count, Todo *todo, QPainter &p,
+                   TodoSortField sortField, SortDirection sortDir,
+                   bool connectSubTodos, bool strikeoutCompleted, bool desc,
+                   int posPriority, int posSummary, int posDueDt,
+                   int posPercentComplete, int level, int x, int &y,
+                   int width, int pageHeight,
+                   const Todo::List &todoList, TodoParentStart *r = 0 );
+
+    /**
+      Draws single journal item.
+      \param journal The item to be printed.
+      \param p QPainter of the printout
+      \param x x-coordinate of the upper left coordinate of the first item
+      \param y y-coordinate of the upper left coordinate of the first item
+      \param width width of the whole list
+      \param pageHeight Total height allowed for the list on a page. If an item
+                   would be below that line, a new page is started.
+    */
+    void drawJournal( Journal * journal, QPainter &p, int x, int &y,
+                      int width, int pageHeight );
+    void drawJournalField( QPainter &p, QString field, QString text,
+                           int x, int &y, int width, int pageHeight );
+
+    void drawSplitHeaderRight( QPainter &p, const QDate &fd, const QDate &td,
+                               const QDate &cd, int width, int height );
+
+
+  protected:
+    void drawIncidence( QPainter &p, const QRect &dayBox, const QString &time,
+                        const QString &summary, int &textY );
+
+  protected:
+    bool mUseColors;
+    int mHeaderHeight;
+    int mSubHeaderHeight;
+    int mMargin;
+    int mPadding;
+    int mBorder;
+    const KCalendarSystem *mCalSys;
+
+  public:
 };
 
 #endif
Index: korganizer/printing/calprintmonthconfig_base.ui
===================================================================
--- korganizer/printing/calprintmonthconfig_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/printing/calprintmonthconfig_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -10,8 +10,8 @@
         <rect>
             <x>0</x>
             <y>0</y>
-            <width>401</width>
-            <height>173</height>
+            <width>463</width>
+            <height>161</height>
         </rect>
     </property>
     <grid>
@@ -45,90 +45,100 @@
             <property name="title">
                 <string>Date &amp;&amp; Time Range</string>
             </property>
-            <grid>
+            <hbox>
                 <property name="name">
                     <cstring>unnamed</cstring>
                 </property>
-                <spacer row="0" column="4">
+                <widget class="QLabel">
                     <property name="name">
-                        <cstring>spacer1</cstring>
+                        <cstring>mFromDateLabel</cstring>
                     </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
+                    <property name="text">
+                        <string>&amp;Start month:</string>
                     </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
+                    <property name="buddy" stdset="0">
+                        <cstring>mFromMonth</cstring>
                     </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>17</width>
-                            <height>21</height>
-                        </size>
+                    <property name="whatsThis" stdset="0">
+                        <string>When you want to print more months at once, you can define a month range. This option defines the first month to be printed. Use the option &lt;i&gt;End month&lt;/i&gt; to define the last month in this range.</string>
                     </property>
-                </spacer>
-                <widget class="QLabel" row="0" column="2">
+                </widget>
+                <widget class="KComboBox">
                     <property name="name">
+                        <cstring>mFromMonth</cstring>
+                    </property>
+                    <property name="whatsThis" stdset="0">
+                        <string>When you want to print more months at once, you can define a month range. This option defines the first month to be printed. Use the on &lt;i&gt;End month&lt;/i&gt; to define the last month in this range.</string>
+                    </property>
+                </widget>
+                <widget class="KIntSpinBox">
+                    <property name="name">
+                        <cstring>mFromYear</cstring>
+                    </property>
+                    <property name="maxValue">
+                        <number>3000</number>
+                    </property>
+                    <property name="value">
+                        <number>2007</number>
+                    </property>
+                    <property name="whatsThis" stdset="0">
+                        <string>When you want to print more months at once, you can define a month range. This option defines the first month to be printed. Use the on &lt;i&gt;End month&lt;/i&gt; to define the last month in this range.</string>
+                    </property>
+                </widget>
+                <widget class="QLabel">
+                    <property name="name">
                         <cstring>mToDateLabel</cstring>
                     </property>
                     <property name="text">
                         <string>&amp;End month:</string>
                     </property>
                     <property name="buddy" stdset="0">
-                        <cstring>mToDate</cstring>
+                        <cstring>mToMonth</cstring>
                     </property>
                     <property name="whatsThis" stdset="0">
                         <string>When you want to print more months at once, you can define a month range. This option defines the last month to be printed. Use the option &lt;i&gt;Start month&lt;/i&gt; to define the first month in this range.</string>
                     </property>
                 </widget>
-                <widget class="QLabel" row="0" column="0">
+                <widget class="KComboBox">
                     <property name="name">
-                        <cstring>mFromDateLabel</cstring>
+                        <cstring>mToMonth</cstring>
                     </property>
-                    <property name="text">
-                        <string>&amp;Start month:</string>
-                    </property>
-                    <property name="buddy" stdset="0">
-                        <cstring>mFromDate</cstring>
-                    </property>
                     <property name="whatsThis" stdset="0">
-                        <string>When you want to print more months at once, you can define a month range. This option defines the first month to be printed. Use the option &lt;i&gt;End month&lt;/i&gt; to define the last month in this range.</string>
+                        <string>When you want to print more months at once, you can define a month range. This option defines the last month to be printed. Use the option &lt;i&gt;Start month&lt;/i&gt; to define the first month in this range.</string>
                     </property>
                 </widget>
-                <widget class="KDateEdit" row="0" column="3">
+                <widget class="KIntSpinBox">
                     <property name="name">
-                        <cstring>mToDate</cstring>
+                        <cstring>mToYear</cstring>
                     </property>
-                    <property name="minimumSize">
-                        <size>
-                            <width>50</width>
-                            <height>0</height>
-                        </size>
+                    <property name="maxValue">
+                        <number>3000</number>
                     </property>
-                    <property name="focusPolicy">
-                        <enum>StrongFocus</enum>
+                    <property name="value">
+                        <number>2007</number>
                     </property>
                     <property name="whatsThis" stdset="0">
                         <string>When you want to print more months at once, you can define a month range. This option defines the last month to be printed. Use the option &lt;i&gt;Start month&lt;/i&gt; to define the first month in this range.</string>
                     </property>
                 </widget>
-                <widget class="KDateEdit" row="0" column="1">
+                <spacer>
                     <property name="name">
-                        <cstring>mFromDate</cstring>
+                        <cstring>spacer1</cstring>
                     </property>
-                    <property name="minimumSize">
+                    <property name="orientation">
+                        <enum>Horizontal</enum>
+                    </property>
+                    <property name="sizeType">
+                        <enum>Expanding</enum>
+                    </property>
+                    <property name="sizeHint">
                         <size>
-                            <width>50</width>
-                            <height>0</height>
+                            <width>17</width>
+                            <height>21</height>
                         </size>
                     </property>
-                    <property name="focusPolicy">
-                        <enum>StrongFocus</enum>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>When you want to print more months at once, you can define a month range. This option defines the first month to be printed.</string>
-                    </property>
-                </widget>
-            </grid>
+                </spacer>
+            </hbox>
         </widget>
         <widget class="QCheckBox" row="4" column="0">
             <property name="name">
@@ -179,9 +189,9 @@
         </widget>
     </grid>
 </widget>
+<customwidgets>
+</customwidgets>
 <tabstops>
-    <tabstop>mFromDate</tabstop>
-    <tabstop>mToDate</tabstop>
     <tabstop>mWeekNumbers</tabstop>
     <tabstop>mRecurDaily</tabstop>
     <tabstop>mRecurWeekly</tabstop>
@@ -192,7 +202,9 @@
 </includes>
 <layoutdefaults spacing="6" margin="11"/>
 <includehints>
-    <includehint>libkdepim/kdateedit.h</includehint>
-    <includehint>libkdepim/kdateedit.h</includehint>
+    <includehint>kcombobox.h</includehint>
+    <includehint>knuminput.h</includehint>
+    <includehint>kcombobox.h</includehint>
+    <includehint>knuminput.h</includehint>
 </includehints>
 </UI>
Index: korganizer/korganizer_configplugins.desktop
===================================================================
--- korganizer/korganizer_configplugins.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configplugins.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -29,6 +29,7 @@
 Name[fi]=Liitännäiset
 Name[fr]=Modules externes
 Name[ga]=Breiseáin
+Name[gl]=Extensións
 Name[he]=תוספים
 Name[hu]=Bővítőmodulok
 Name[is]=Íforrit
@@ -70,6 +71,7 @@
 Comment[fa]=پیکربندی وصلۀ KOrganizer
 Comment[fi]=KOrganizerin liitännäisen asetukset
 Comment[fr]=Configuration du module KOrganizer
+Comment[gl]=Configuración de Extensións de KOrganizer
 Comment[he]=הגדרות תוסף הארגונית
 Comment[hu]=A KOrganizer bővítőmodul beállításai
 Comment[is]=Stillingar KOrganizer íforrita
@@ -107,10 +109,11 @@
 Keywords[es]=korganizer,extensión,plugin,módulo
 Keywords[et]=korganizer,plugin,moodul
 Keywords[eu]=korganizer,plugin-a,modulua
-Keywords[fa]=korganizer،وصله،پیمانه
+Keywords[fa]=korganizer،وصله، پیمانه
 Keywords[fi]=korganizer,liitännäinen,moduuli
 Keywords[fr]=KOrganizer,module
 Keywords[ga]=korganizer,breiseán,modúl
+Keywords[gl]=korganizer,extensión,módulo
 Keywords[he]=korganizer,plugin,module,מודול,תוסף,ארגונית
 Keywords[hu]=korganizer,bővítőmodul,modul
 Keywords[is]=korganizer,íforrit,eining
Index: korganizer/koeditorgeneraltodo.cpp
===================================================================
--- korganizer/koeditorgeneraltodo.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeditorgeneraltodo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -69,13 +69,13 @@
 void KOEditorGeneralTodo::finishSetup()
 {
   QWidget::setTabOrder( mSummaryEdit, mLocationEdit );
-  QWidget::setTabOrder( mLocationEdit, mDueCheck );
+  QWidget::setTabOrder( mLocationEdit, mStartCheck );
+  QWidget::setTabOrder( mStartCheck, mStartDateEdit );
+  QWidget::setTabOrder( mStartDateEdit, mStartTimeEdit );
+  QWidget::setTabOrder( mStartTimeEdit, mDueCheck );
   QWidget::setTabOrder( mDueCheck, mDueDateEdit );
   QWidget::setTabOrder( mDueDateEdit, mDueTimeEdit );
-  QWidget::setTabOrder( mDueTimeEdit, mStartCheck );
-  QWidget::setTabOrder( mStartCheck, mStartDateEdit );
-  QWidget::setTabOrder( mStartDateEdit, mStartTimeEdit );
-  QWidget::setTabOrder( mStartTimeEdit, mTimeButton );
+  QWidget::setTabOrder( mDueTimeEdit, mTimeButton );
   QWidget::setTabOrder( mTimeButton, mCompletedCombo );
   QWidget::setTabOrder( mCompletedCombo, mPriorityCombo );
   QWidget::setTabOrder( mPriorityCombo, mAlarmButton );
@@ -110,10 +110,28 @@
   layoutTimeBox->setSpacing(topLayout->spacing());
 
 
-  QString whatsThis = i18n("Sets the due date for this to-do.");
+  QString whatsThis = i18n("Sets the start date for this to-do");
+  mStartCheck = new QCheckBox(i18n("Sta&rt:"),timeBoxFrame);
+  QWhatsThis::add( mStartCheck, whatsThis );
+  layoutTimeBox->addWidget(mStartCheck,0,0);
+  connect(mStartCheck,SIGNAL(toggled(bool)),SLOT(enableStartEdit(bool)));
+  connect(mStartCheck,SIGNAL(toggled(bool)),SLOT(startDateModified()));
+
+  mStartDateEdit = new KDateEdit(timeBoxFrame);
+  QWhatsThis::add( mStartDateEdit, whatsThis );
+  layoutTimeBox->addWidget(mStartDateEdit,0,1);
+  connect(mStartDateEdit,SIGNAL(dateChanged(const QDate&)),SLOT(startDateModified()));
+
+  mStartTimeEdit = new KTimeEdit(timeBoxFrame);
+  QWhatsThis::add( mStartTimeEdit,
+                   i18n("Sets the start time for this to-do.") );
+  layoutTimeBox->addWidget(mStartTimeEdit,0,2);
+  connect(mStartTimeEdit,SIGNAL(timeChanged(QTime)),SLOT(startDateModified()));
+
+  whatsThis = i18n("Sets the due date for this to-do.");
   mDueCheck = new QCheckBox(i18n("&Due:"),timeBoxFrame);
   QWhatsThis::add( mDueCheck, whatsThis );
-  layoutTimeBox->addWidget(mDueCheck,0,0);
+  layoutTimeBox->addWidget(mDueCheck,1,0);
   connect(mDueCheck,SIGNAL(toggled(bool)),SLOT(enableDueEdit(bool)));
   connect(mDueCheck,SIGNAL(toggled(bool)),SLOT(showAlarm()));
   connect(mDueCheck,SIGNAL(toggled(bool)),SIGNAL(dueDateEditToggle(bool)));
@@ -121,33 +139,15 @@
 
   mDueDateEdit = new KDateEdit(timeBoxFrame);
   QWhatsThis::add( mDueDateEdit, whatsThis );
-  layoutTimeBox->addWidget(mDueDateEdit,0,1);
+  layoutTimeBox->addWidget(mDueDateEdit,1,1);
   connect(mDueDateEdit,SIGNAL(dateChanged(const QDate&)),SLOT(dateChanged()));
 
   mDueTimeEdit = new KTimeEdit(timeBoxFrame);
   QWhatsThis::add( mDueTimeEdit,
                    i18n("Sets the due time for this to-do.") );
-  layoutTimeBox->addWidget(mDueTimeEdit,0,2);
+  layoutTimeBox->addWidget(mDueTimeEdit,1,2);
   connect(mDueTimeEdit,SIGNAL(timeChanged( QTime )),SLOT(dateChanged()));
 
-  whatsThis = i18n("Sets the start date for this to-do");
-  mStartCheck = new QCheckBox(i18n("Sta&rt:"),timeBoxFrame);
-  QWhatsThis::add( mStartCheck, whatsThis );
-  layoutTimeBox->addWidget(mStartCheck,1,0);
-  connect(mStartCheck,SIGNAL(toggled(bool)),SLOT(enableStartEdit(bool)));
-  connect(mStartCheck,SIGNAL(toggled(bool)),SLOT(startDateModified()));
-
-  mStartDateEdit = new KDateEdit(timeBoxFrame);
-  QWhatsThis::add( mStartDateEdit, whatsThis );
-  layoutTimeBox->addWidget(mStartDateEdit,1,1);
-  connect(mStartDateEdit,SIGNAL(dateChanged(const QDate&)),SLOT(startDateModified()));
-
-  mStartTimeEdit = new KTimeEdit(timeBoxFrame);
-  QWhatsThis::add( mStartTimeEdit,
-                   i18n("Sets the start time for this to-do.") );
-  layoutTimeBox->addWidget(mStartTimeEdit,1,2);
-  connect(mStartTimeEdit,SIGNAL(timeChanged(QTime)),SLOT(startDateModified()));
-
   mTimeButton = new QCheckBox(i18n("Ti&me associated"),timeBoxFrame);
   QWhatsThis::add( mTimeButton,
                    i18n("Sets whether or not this to-do's start and due dates "
@@ -224,6 +224,7 @@
 
 void KOEditorGeneralTodo::setDefaults( const QDateTime &due, bool allDay )
 {
+kdDebug()<<"KOEditorGeneralTodo::setDefaults: " << due <<endl;
   KOEditorGeneral::setDefaults(allDay);
 
   mTimeButton->setChecked( !allDay );
@@ -236,8 +237,8 @@
 
   enableTimeEdits( !allDay );
 
-  mDueCheck->setChecked(false);
-  enableDueEdit(false);
+  mDueCheck->setChecked( due.isValid() );
+  enableDueEdit( due.isValid() );
 
   enableAlarm(false);
 
@@ -353,6 +354,7 @@
     }
   }
 
+  // TODO: Don't use the due date for the recurrence, but the start date (cf. rfc 2445)
   if ( todo->doesRecur() && !mStartDateModified ) {
     todo->setDtDue( tmpDueDT );
   } else {
@@ -550,7 +552,7 @@
     setCompletedDate();
     break;
   case KOGlobals::CATEGORY_MODIFIED:
-    setCategories (todo->categoriesStr ());
+    setCategories( todo->categories() );
     break;
   case KOGlobals::UNKNOWN_MODIFIED: // fall through
   default:
Index: korganizer/koeditorgeneral.cpp
===================================================================
--- korganizer/koeditorgeneral.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeditorgeneral.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -55,6 +55,7 @@
 #include <libkcal/event.h>
 
 #include <libkdepim/kdateedit.h>
+#include <libkdepim/categoryselectdialog.h>
 
 #include "koprefs.h"
 #include "koglobals.h"
@@ -64,7 +65,7 @@
 #include "koeditorgeneral.moc"
 
 KOEditorGeneral::KOEditorGeneral(QObject* parent, const char* name) :
-  QObject( parent, name)
+  QObject( parent, name )
 {
   mAlarmList.setAutoDelete( true );
 }
@@ -135,7 +136,7 @@
   mCategoriesButton = new QPushButton(parent);
   mCategoriesButton->setText(i18n("Select Cate&gories..."));
   QWhatsThis::add( mCategoriesButton, whatsThis );
-  connect(mCategoriesButton,SIGNAL(clicked()),SIGNAL(openCategoryDialog()));
+  connect(mCategoriesButton,SIGNAL(clicked()),SLOT(selectCategories()));
   categoriesLayout->addWidget(mCategoriesButton);
 
   mCategoriesLabel = new KSqueezedTextLabel(parent);
@@ -230,6 +231,18 @@
 
 }
 
+void KOEditorGeneral::selectCategories()
+{
+  KPIM::CategorySelectDialog *categoryDialog = new KPIM::CategorySelectDialog( KOPrefs::instance(), mCategoriesButton	 );
+  KOGlobals::fitDialogToScreen( categoryDialog );
+  categoryDialog->setSelected( mCategories );
+  if ( categoryDialog->exec() ) {
+    setCategories( categoryDialog->selectedCategories() );
+  }
+  delete categoryDialog;
+}
+
+
 void KOEditorGeneral::editAlarms()
 {
   if ( mAlarmStack->id( mAlarmStack->visibleWidget() ) == SimpleAlarmPage ) {
@@ -253,10 +266,10 @@
   mAlarmEditButton->setEnabled( enable );
 }
 
-void KOEditorGeneral::setCategories(const QString &str)
+void KOEditorGeneral::setCategories( const QStringList &categories )
 {
-  mCategoriesLabel->setText(str);
-  mCategories = str;
+  mCategoriesLabel->setText( categories.join(",") );
+  mCategories = categories;
 }
 
 void KOEditorGeneral::setDefaults(bool /*allDay*/)
@@ -355,7 +368,7 @@
   updateDefaultAlarmTime();
   updateAlarmWidgets();
 
-  setCategories(event->categoriesStr());
+  setCategories(event->categories());
 }
 
 Alarm *KOEditorGeneral::alarmFromSimplePage() const
Index: korganizer/koeventeditor.cpp
===================================================================
--- korganizer/koeventeditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeventeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,7 +30,6 @@
 #include <qwidgetstack.h>
 #include <qwhatsthis.h>
 
-#include <kabc/addressee.h>
 #include <kiconloader.h>
 #include <kdebug.h>
 #include <klocale.h>
@@ -38,7 +37,6 @@
 #include <libkcal/calendarresources.h>
 #include <libkcal/resourcecalendar.h>
 
-#include <libkdepim/categoryselectdialog.h>
 #include <libkcal/calendarlocal.h>
 
 #include "koprefs.h"
@@ -56,7 +54,7 @@
 
 KOEventEditor::KOEventEditor( Calendar *calendar, QWidget *parent )
   : KOIncidenceEditor( QString::null, calendar, parent ),
-    mEvent( 0 )
+    mEvent( 0 ), mGeneral( 0 ), mRecurrence( 0 ), mFreeBusy( 0 )
 {
 }
 
@@ -91,12 +89,6 @@
   connect( mFreeBusy, SIGNAL( dateTimesChanged( const QDateTime &, const QDateTime & ) ),
            mGeneral, SLOT( setDateTimes( const QDateTime &, const QDateTime & ) ) );
 
-  // Category dialog
-  connect( mGeneral, SIGNAL( openCategoryDialog() ),
-           mCategoryDialog, SLOT( show() ) );
-  connect( mCategoryDialog, SIGNAL( categoriesSelected( const QString & ) ),
-           mGeneral, SLOT( setCategories( const QString & ) ) );
-
   connect( mGeneral, SIGNAL( focusReceivedSignal() ),
            SIGNAL( focusReceivedSignal() ) );
 }
@@ -209,70 +201,37 @@
   setCaption( i18n("Edit Event") );
 }
 
-void KOEventEditor::newEvent( const QDateTime &from, const QDateTime &to,
-                              bool allDay )
+void KOEventEditor::newEvent()
 {
   init();
-
   mEvent = 0;
-  setDefaults(from,to,allDay);
-
-  setCaption( i18n("New Event") );
-}
-
-void KOEventEditor::newEvent( const QString &text )
-{
-  init();
-
-  mEvent = 0;
-
   loadDefaults();
-
-  mGeneral->setDescription( text );
-
-  int pos = text.find( "\n" );
-  if ( pos > 0 ) {
-    mGeneral->setSummary( text.left( pos ) );
-    mGeneral->setDescription( text );
-  } else {
-    mGeneral->setSummary( text );
-  }
-
   setCaption( i18n("New Event") );
 }
 
-void KOEventEditor::newEvent( const QString &summary,
-                              const QString &description,
-                              const QString &attachment )
+void KOEventEditor::setDates( const QDateTime &from, const QDateTime &to, bool allDay )
 {
-  init();
-
-  mEvent = 0;
-
-  loadDefaults();
-
-  mGeneral->setSummary( summary );
-  mGeneral->setDescription( description );
-
-  if ( !attachment.isEmpty() ) {
-    mAttachments->addAttachment( attachment );
+  mGeneral->setDefaults( from, to, allDay );
+  mDetails->setDefaults();
+  mAttachments->setDefaults();
+  mRecurrence->setDefaults( from, to, allDay );
+  if( mFreeBusy ) {
+    if ( allDay )
+      mFreeBusy->setDateTimes( from, to.addDays( 1 ) );
+    else
+      mFreeBusy->setDateTimes( from, to );
   }
-
-  setCaption( i18n("New Event") );
 }
 
-void KOEventEditor::newEvent( const QString &summary,
-                              const QString &description,
-                              const QString &attachment,
-                              const QStringList &attendees )
+void KOEventEditor::setTexts( const QString &summary, const QString &description )
 {
-  newEvent( summary, description, attachment );
-
-  QStringList::ConstIterator it;
-  for ( it = attendees.begin(); it != attendees.end(); ++it ) {
-    QString name, email;
-    KABC::Addressee::parseEmailAddress( *it, name, email );
-    mDetails->insertAttendee( new Attendee( name, email ) );
+  if ( description.isEmpty() && summary.contains("\n") ) {
+    mGeneral->setDescription( summary );
+    int pos = summary.find( "\n" );
+    mGeneral->setSummary( summary.left( pos ) );
+  } else {
+    mGeneral->setSummary( summary );
+    mGeneral->setDescription( description );
   }
 }
 
@@ -283,7 +242,7 @@
                 ( KOPrefs::instance()->mDefaultDuration.time().minute()*60 );
   QDateTime to( from.addSecs( addSecs ) );
 
-  setDefaults( from, to, false );
+  setDates( from, to, false );
 }
 
 bool KOEventEditor::processInput()
@@ -347,20 +306,6 @@
   reject();
 }
 
-void KOEventEditor::setDefaults( const QDateTime &from, const QDateTime &to, bool allDay )
-{
-  mGeneral->setDefaults( from, to, allDay );
-  mDetails->setDefaults();
-  mAttachments->setDefaults();
-  mRecurrence->setDefaults( from, to, allDay );
-  if( mFreeBusy ) {
-    if ( allDay )
-      mFreeBusy->setDateTimes( from, to.addDays( 1 ) );
-    else
-      mFreeBusy->setDateTimes( from, to );
-   }
-}
-
 void KOEventEditor::readEvent( Event *event, bool tmpl )
 {
   mGeneral->readEvent( event, tmpl );
@@ -373,9 +318,6 @@
     mFreeBusy->triggerReload();
   }
 
-  // categories
-  mCategoryDialog->setSelected( event->categories() );
-
   createEmbeddedURLPages( event );
   readDesignerFields( event );
 }
Index: korganizer/kohelper.cpp
===================================================================
--- korganizer/kohelper.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kohelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -44,18 +44,19 @@
   if ( calendarResource ) {
     KCal::ResourceCalendar *resourceCalendar = calendarResource->resource( incidence );
 
-    QString identifier = resourceCalendar->identifier();
-    resourceColor = *KOPrefs::instance()->resourceColor( identifier );
+    if( resourceCalendar ) {
+      QString identifier = resourceCalendar->identifier();
+      resourceColor = *KOPrefs::instance()->resourceColor( identifier );
 
-    if ( !resourceCalendar->subresources().isEmpty() ) {
-      identifier = resourceCalendar->subresourceIdentifier( incidence );
-      if ( identifier.isEmpty() )
-        identifier = resourceCalendar->identifier();
-      QColor subrescolor( *KOPrefs::instance()->resourceColor( identifier ) );
-      if ( subrescolor.isValid() )
-        resourceColor = subrescolor;
+      if ( !resourceCalendar->subresources().isEmpty() ) {
+        identifier = resourceCalendar->subresourceIdentifier( incidence );
+       if ( identifier.isEmpty() )
+         identifier = resourceCalendar->identifier();
+       QColor subrescolor( *KOPrefs::instance()->resourceColor( identifier ) );
+       if ( subrescolor.isValid() )
+         resourceColor = subrescolor;
+      }
     }
-
 //   } else {
 //     kdDebug(5850) << "resourceColor: Calendar is not a CalendarResources" <<endl;
   }
Index: korganizer/korganizer_configgroupscheduling.desktop
===================================================================
--- korganizer/korganizer_configgroupscheduling.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configgroupscheduling.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -115,7 +115,7 @@
 Keywords[es]=korganizer,grupo,planificación
 Keywords[et]=korganizer,grupid,grupitöö,ajakavad
 Keywords[eu]=korganizer,taldea,antolaketa
-Keywords[fa]=korganizer،گروه،زمان‌بندی
+Keywords[fa]=korganizer،گروه، زمان‌بندی
 Keywords[fi]=korganizer,ryhmä,ajastus
 Keywords[fr]=KOrganizer,groupes,planification
 Keywords[gl]=korganizer,grupo,programar
Index: korganizer/koeventview.h
===================================================================
--- korganizer/koeventview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeventview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -36,7 +36,6 @@
 using namespace KCal;
 
 class KOEventPopupMenu;
-class CalPrinter;
 class QPopupMenu;
 
 /**
Index: korganizer/koeditorgeneral.h
===================================================================
--- korganizer/koeditorgeneral.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeditorgeneral.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -90,7 +90,8 @@
     QObject *typeAheadReceiver() const;
 
   public slots:
-    void setCategories(const QString &);
+    void setCategories(const QStringList &categories);
+    void selectCategories();
 
   protected slots:
     void editAlarms();
@@ -122,7 +123,7 @@
     enum AlarmStackPages { SimpleAlarmPage, AdvancedAlarmLabel };
 
   private:
-    QString mCategories;
+    QStringList mCategories;
     KCal::Alarm::List mAlarmList;
 };
 
Index: korganizer/koeventeditor.h
===================================================================
--- korganizer/koeventeditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeventeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -60,32 +60,25 @@
     void reload();
 
     /**
-      Clear eventwin for new event, and preset the dates and times with hint
+      Clear event win for new event
     */
-    void newEvent( const QDateTime &from, const QDateTime &to, bool allDay = false );
+    void newEvent();
+    
     /**
-      Edit new event. Set summary and description from given text.
+      Sets the given summary and description. If description is empty and the 
+      summary contains multiple lines, the summary will be used as description 
+      and only the first line of summary will be used as the summary.
     */
-    void newEvent( const QString & );
+    void setTexts( const QString &summary, const QString &description = QString::null );
     /**
-      Edit new event.
-    */
-    void newEvent( const QString &summary, const QString &description,
-                   const QString &attachment );
-    /**
-      Edit new event.
-    */
-    void newEvent( const QString &summary, const QString &description,
-                   const QString &attachment, const QStringList &attendees );
-    /**
       Edit an existing event.
     */
     void editIncidence( Incidence * );
 
     /**
-      Set widgets to default values
+      Set widgets to the given date/time values
     */
-    void setDefaults( const QDateTime &from, const QDateTime &to, bool allDay );
+    void setDates( const QDateTime &from, const QDateTime &to, bool allDay );
 
     /**
       Read event object and setup widgets accordingly. If tmpl is true, the
Index: korganizer/journalentry.h
===================================================================
--- korganizer/journalentry.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/journalentry.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -69,6 +69,7 @@
     void setDirty();
     void deleteItem();
     void editItem();
+    void printItem();
     void timeCheckBoxToggled(bool on);
   public slots:
     void setIncidenceChanger( IncidenceChangerBase *changer ) { mChanger = changer; }
@@ -99,6 +100,7 @@
     KTimeEdit *mTimeEdit;
     QButton *mDeleteButton;
     QButton *mEditButton;
+    QButton *mPrintButton;
 
     QGridLayout *mLayout;
 
Index: korganizer/kojournalview.h
===================================================================
--- korganizer/kojournalview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kojournalview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -51,6 +51,8 @@
     DateList selectedDates() { return DateList(); }
     void appendJournal( Journal*journal, const QDate &dt);
 
+    CalPrinterBase::PrintType printType();
+
   public slots:
     // Don't update the view when midnight passed, otherwise we'll have data loss (bug 79145)
     virtual void dayPassed( const QDate & ) {}
Index: korganizer/calendarview.h
===================================================================
--- korganizer/calendarview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/calendarview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -38,10 +38,10 @@
 class QWidgetStack;
 class QSplitter;
 
-class CalPrinter;
 class KOViewManager;
 class KODialogManager;
 class KOTodoView;
+class KOEventEditor;
 class DateNavigatorContainer;
 class DateNavigator;
 class KOIncidenceEditor;
@@ -267,22 +267,20 @@
 
     void connectIncidenceEditor( KOIncidenceEditor * );
 
-    /** create an editeventwin with supplied date/time, and if bool is true,
-     * make the event take all day. */
-    void newEvent( const QDateTime &, const QDateTime &, bool allDay = false );
-    void newEvent( const QDateTime &fh );
-    void newEvent( const QDate &dt );
     /** create new event without having a date hint. Takes current date as
      default hint. */
     void newEvent();
+    /** create an editeventwin with supplied date/time, and if bool is true,
+     * make the event take all day. */
+    void newEvent( const QDate &startDt );
+    void newEvent( const QDateTime &startDt );
+    void newEvent( const QDateTime &startDt, const QDateTime &EndDt, bool allDay = false );
     /**
-      Create new Event from given string.
+      Create new Event from given summary, description, attachment list and 
+      attendees list
     */
-    void newEvent( const QString & );
-    void newEvent( const QString &summary, const QString &description,
-                   const QString &attachment );
-    void newEvent( const QString &summary, const QString &description,
-                   const QString &attachment, const QStringList &attendees );
+    void newEvent( const QString &summary, const QString &description = QString::null,
+                   const QStringList &attachment = QStringList(), const QStringList &attendees = QStringList() );
     void newFloatingEvent();
 
     /** Create a read-only viewer dialog for the supplied incidence. It calls the correct showXXX method*/
@@ -334,19 +332,12 @@
     /** create new todo with a parent todo */
     void newSubTodo( Todo * );
 
-    void newTodo( const QString & );
-    void newTodo( const QString &summary, const QString &description,
-                  const QString &attachment );
-    void newTodo( const QString &summary, const QString &description,
-                  const QString &attachment, const QStringList &attendees );
+    void newTodo( const QString &summary, const QString &description = QString::null,
+                  const QStringList &attachments = QStringList(), const QStringList &attendees = QStringList() );
 
     void newJournal();
     void newJournal( const QDate &date );
-    void newJournal( const QString &text, const QDate &date );
-    void newJournal( const QString &text );
-    //TODO:
-    // void newJournal( const QString &summary,  const QString &description,
-    //                  const QString &attachment );
+    void newJournal( const QString &text, const QDate &date = QDate() );
 
     void toggleAlarm( Incidence * );
     void dissociateOccurrence( Incidence *, const QDate & );
@@ -550,12 +541,16 @@
 
     void warningChangeFailed( Incidence * );
     void checkForFilteredChange( Incidence *incidence );
+    /** Adjust the given date/times by valid defaults (selection or configured 
+        defaults, if invalid values are given) and allow the view to adjust the 
+        type. */
+    void dateTimesForNewEvent( QDateTime &startDt, QDateTime &endDt, bool &allDay );
+    KOEventEditor *newEventEditor( const QDateTime &startDtParam = QDateTime(), 
+         const QDateTime &endDtParam = QDateTime() , bool allDayParam = false );
 
   private:
     void init();
 
-    void createPrinter();
-
     void calendarModified( bool, Calendar * );
     // Helper function for purgeCompleted that recursively purges a todo and
     // its subitems. If it cannot delete a completed todo (because it has
@@ -564,8 +559,6 @@
 
     KOrg::History *mHistory;
 
-    CalPrinter *mCalPrinter;
-
     QSplitter    *mPanner;
     QSplitter    *mLeftSplitter;
     QWidget      *mLeftFrame;
Index: korganizer/koapp.cpp
===================================================================
--- korganizer/koapp.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koapp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -84,26 +84,38 @@
 
   KOGlobals::self()->alarmClient()->startDaemon();
 
-  // If filenames was given as argument load this as calendars, one per window.
-  if ( args->count() > 0 ) {
-    int i;
-    for( i = 0; i < args->count(); ++i ) {
+  // No filenames given => all other args are meaningless, show main Window
+  if ( args->count() <= 0 ) {
+    processCalendar( KURL() );
+    return 0;
+  }
+  
+  // If filenames wer given as arguments, load them as calendars, one per window.
+  if ( args->isSet( "open" ) ) {
+    for( int i = 0; i < args->count(); ++i ) {
       processCalendar( args->url( i ) );
     }
-    if ( args->isSet( "import" ) ) {
-      processCalendar( KURL() );
-    }
   } else {
+    // Import, merge, or ask => we need the resource calendar window anyway.
     processCalendar( KURL() );
-  }
-
-  if ( args->isSet( "import" ) ) {
     KOrg::MainWindow *korg = ActionManager::findInstance( KURL() );
     if ( !korg ) {
       kdError() << "Unable to find default calendar resources view." << endl;
+      return -1;
+    }
+    // Check for import, merge or ask
+    if ( args->isSet( "import" ) ) {
+      for( int i = 0; i < args->count(); ++i ) {
+        korg->actionManager()->addResource( args->url( i ) );
+      }
+    } else if ( args->isSet( "merge" ) ) {
+      for( int i = 0; i < args->count(); ++i ) {
+        korg->actionManager()->mergeURL( args->url( i ).url() );
+      }
     } else {
-      KURL url = KCmdLineArgs::makeURL( args->getOption( "import" ) );
-      korg->actionManager()->importCalendar( url );
+      for( int i = 0; i < args->count(); ++i ) {
+        korg->actionManager()->importCalendar( args->url( i ) );
+      }
     }
   }
 
Index: korganizer/koeditorgeneralevent.cpp
===================================================================
--- korganizer/koeditorgeneralevent.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeditorgeneralevent.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -260,13 +260,6 @@
     return;
 
   QDateTime newdt(newdate, mCurrEndDateTime.time());
-
-  if(newdt < mCurrStartDateTime) {
-    // oops, we can't let that happen.
-    newdt = mCurrStartDateTime;
-    mEndDateEdit->setDate(newdt.date());
-    mEndTimeEdit->setTime(newdt.time());
-  }
   mCurrEndDateTime = newdt;
 
   emit dateTimesChanged(mCurrStartDateTime,mCurrEndDateTime);
Index: korganizer/koglobals.h
===================================================================
--- korganizer/koglobals.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koglobals.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,7 +43,7 @@
     enum { PRIORITY_MODIFIED, COMPLETION_MODIFIED, CATEGORY_MODIFIED,
            DATE_MODIFIED, RELATION_MODIFIED, ALARM_MODIFIED,
            DESCRIPTION_MODIFIED, SUMMARY_MODIFIED,
-           UNKNOWN_MODIFIED };
+           COMPLETION_MODIFIED_WITH_RECURRENCE, UNKNOWN_MODIFIED };
 
     static void fitDialogToScreen( QWidget *widget, bool force=false );
     KConfig *config() const;
Index: korganizer/korgac/alarmdialog.cpp
===================================================================
--- korganizer/korgac/alarmdialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korgac/alarmdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -33,6 +33,7 @@
 #include <qdatastream.h>
 
 #include <kapplication.h>
+#include <kiconloader.h>
 #include <dcopclient.h>
 #include <klocale.h>
 #include <kprocess.h>
@@ -58,6 +59,8 @@
                  false, i18n("Suspend"), i18n("Edit...") ),
                  mSuspendTimer(this)
 {
+  KGlobal::iconLoader()->addAppDir( "kdepim" );
+
   QWidget *topBox = plainPage();
   QBoxLayout *topLayout = new QVBoxLayout( topBox );
   topLayout->setSpacing( spacingHint() );
@@ -73,9 +76,10 @@
   suspendBox->setSpacing( spacingHint() );
   topLayout->addWidget( suspendBox );
 
-  new QLabel( i18n("Suspend duration:"), suspendBox );
+  QLabel *l = new QLabel( i18n("Suspend &duration:"), suspendBox );
   mSuspendSpin = new QSpinBox( 1, 9999, 1, suspendBox );
   mSuspendSpin->setValue( 5 );  // default suspend duration
+  l->setBuddy( mSuspendSpin );
 
   mSuspendUnit = new KComboBox( suspendBox );
   mSuspendUnit->insertItem( i18n("minute(s)") );
@@ -83,10 +87,6 @@
   mSuspendUnit->insertItem( i18n("day(s)") );
   mSuspendUnit->insertItem( i18n("week(s)") );
 
-  connect( mSuspendSpin, SIGNAL( valueChanged(int) ), actionButton(User1), SLOT( setFocus() ) );
-  connect( mSuspendUnit, SIGNAL( activated(int) ), actionButton(User1), SLOT( setFocus() ) );
-  connect( mSuspendUnit, SIGNAL( activated(int) ), actionButton(User2), SLOT( setFocus() ) );
-
   // showButton( User2/*3*/, false );
 
   setMinimumSize( 300, 200 );
Index: korganizer/korgac/korgac.desktop
===================================================================
--- korganizer/korgac/korgac.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korgac/korgac.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -11,9 +11,10 @@
 Name[es]=Cliente de recordatorio para KOrganizer
 Name[et]=KOrganizeri meeldetuletuse klientprogramm
 Name[eu]=KOrganizer-en oroigarrien bezeroa
-Name[fa]=کارخواه یادآوری کنندۀ KOrganizer
+Name[fa]=کارخواه یادآوری‌کنندۀ KOrganizer
 Name[fi]=KOrganizer-hälytysasiakas
 Name[fr]=Client d'alarme de KOrganizer
+Name[gl]=Cliente de Lembranzas de KOrganizer
 Name[hu]=KOrganizer-emlékeztető kliens
 Name[is]=Áminningarforrit fyrir KOrganizer
 Name[it]=Client degli avvisi di KOrganizer
@@ -52,6 +53,7 @@
 GenericName[fa]=کارخواه شبح یادآوری KOrganizer
 GenericName[fi]=KOrganizer hälytyspalvelimen asiakas
 GenericName[fr]=Client pour le démon d'alarme de KOrganizer
+GenericName[gl]=Daemon do Cliente de Lembranzas de KOrganizer
 GenericName[hu]=KOrganizer emlékeztető szolgáltatás kliense
 GenericName[is]=Áminningarpúki fyrir KOrganizer
 GenericName[it]=Client del demone degli avvisi di KOrganizer
@@ -71,7 +73,7 @@
 GenericName[sr]=Клијент демона подсетника KOrganizer-а
 GenericName[sr@Latn]=Klijent demona podsetnika KOrganizer-a
 GenericName[sv]=Korganizer-alarmdemonklient
-GenericName[uk]=Даемон клієнта нагадування для KOrganizer
+GenericName[uk]=Демон клієнта нагадування для KOrganizer
 GenericName[zh_CN]=KOrganizer 定时守护进程的客户端程序
 GenericName[zh_TW]=KOrganizr 提醒守護程式客戶端
 Terminal=false
Index: korganizer/kocorehelper.h
===================================================================
--- korganizer/kocorehelper.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kocorehelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -47,6 +47,7 @@
     virtual QTime dayStart() { return KOPrefs::instance()->mDayBegins.time(); }
     virtual const KCalendarSystem *calendarSystem() { return KOGlobals::self()->calendarSystem(); }
     virtual KOrg::PrintPlugin::List loadPrintPlugins() { return KOCore::self()->loadPrintPlugins(); }
+    virtual bool isWorkingDay( const QDate &dt ) { return KOGlobals::self()->isWorkDay( dt ); }
 };
 
 #endif
Index: korganizer/Makefile.am
===================================================================
--- korganizer/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -171,7 +171,7 @@
 	$(XGETTEXT) `find . -name "*.cpp" -o -name "*.h"` -o $(podir)/korganizer.pot
 	rm -f tips.cpp
 
-xdg_apps_DATA = korganizer.desktop
+xdg_apps_DATA = korganizer.desktop korganizer-import.desktop
 
 kde_kcfg_DATA = korganizer.kcfg
 
Index: korganizer/koeventpopupmenu.h
===================================================================
--- korganizer/koeventpopupmenu.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeventpopupmenu.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,8 +30,8 @@
 #include <qpopupmenu.h>
 #include <qdatetime.h>
 
-namespace KCal { 
-class Incidence; 
+namespace KCal {
+class Incidence;
 }
 using namespace KCal;
 
@@ -39,7 +39,7 @@
     Q_OBJECT
   public:
     KOEventPopupMenu();
-  
+
     void addAdditionalItem(const QIconSet &icon,const QString &text,
                            const QObject *receiver, const char *member,
                            bool editOnly=false);
@@ -51,6 +51,7 @@
   protected slots:
     void popupShow();
     void popupEdit();
+    void print();
     void popupDelete();
     void popupCut();
     void popupCopy();
@@ -67,11 +68,11 @@
     void toggleAlarmSignal(Incidence *);
     void dissociateOccurrenceSignal( Incidence *, const QDate & );
     void dissociateFutureOccurrenceSignal( Incidence *, const QDate & );
-    
+
   private:
     Incidence *mCurrentIncidence;
     QDate mCurrentDate;
-    
+
     bool mHasAdditionalItems;
     QValueList<int> mEditOnlyItems;
     QValueList<int> mRecurrenceItems;
Index: korganizer/kotodoview.cpp
===================================================================
--- korganizer/kotodoview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kotodoview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -42,7 +42,6 @@
 #include <libkcal/resourcecalendar.h>
 #include <libkcal/calfilter.h>
 #include <libkcal/incidenceformatter.h>
-#include <libkcal/journal.h>
 
 #include <libkdepim/clicklineedit.h>
 #include <libkdepim/kdatepickerpopup.h>
@@ -59,8 +58,11 @@
 using namespace KOrg;
 #include "kotodoviewitem.h"
 #include "kotodoview.moc"
+#ifndef KORG_NOPRINTER
+#include "kocorehelper.h"
+#include "calprinter.h"
+#endif
 
-
 KOTodoListViewToolTip::KOTodoListViewToolTip (QWidget* parent,
                                               KOTodoListView* lv )
   :QToolTip(parent)
@@ -452,6 +454,9 @@
                              SLOT (showTodo()));
   mItemPopupMenu->insertItem(i18n("&Edit..."), this,
                              SLOT (editTodo()), 0, ePopupEdit );
+#ifndef KORG_NOPRINTER
+  mItemPopupMenu->insertItem(KOGlobals::self()->smallIcon("printer1"), i18n("&Print..."), this, SLOT( printTodo() ) );
+#endif
   mItemPopupMenu->insertItem(KOGlobals::self()->smallIconSet("editdelete"), i18n("&Delete"), this,
                              SLOT (deleteTodo()), 0, ePopupDelete );
   mItemPopupMenu->insertSeparator();
@@ -590,6 +595,9 @@
     // Use dynamic_cast, because in the future the related item might also be an event
     Todo *relatedTodo = dynamic_cast<Todo *>(incidence);
 
+    // just make sure we know we have this item already to avoid endless recursion (Bug 101696)
+    mTodoMap.insert(todo,0);
+
 //    kdDebug(5850) << "  has Related" << endl;
     QMap<Todo *,KOTodoViewItem *>::ConstIterator itemIterator;
     itemIterator = mTodoMap.find(relatedTodo);
@@ -599,7 +607,17 @@
     }
     // isn't this pretty stupid? We give one Todo  to the KOTodoViewItem
     // and one into the map. Sure finding is more easy but why? -zecke
-    KOTodoViewItem *todoItem = new KOTodoViewItem(*itemIterator,todo,this);
+    KOTodoViewItem *todoItem;
+
+    // in case we found a related parent, which has no KOTodoViewItem yet, this must
+    // be the case where 2 items refer to each other, therefore simply create item as root item
+    if ( *itemIterator == 0 ) {
+      todo->setRelatedTo(0);  // break the recursion, else we will have troubles later
+      todoItem = new KOTodoViewItem(mTodoListView,todo,this);
+    }
+    else
+      todoItem = new KOTodoViewItem(*itemIterator,todo,this);
+
     return mTodoMap.insert(todo,todoItem);
   } else {
 //    kdDebug(5850) << "  no Related" << endl;
@@ -729,9 +747,13 @@
   kdDebug(5850) << "KOTodoView::showIncidences( const Incidence::List & ): not yet implemented" << endl;
 }
 
-CalPrinter::PrintType KOTodoView::printType()
+CalPrinterBase::PrintType KOTodoView::printType()
 {
-  return CalPrinter::Todolist;
+  if ( mTodoListView->selectedItem() ) {
+    return CalPrinterBase::Incidence;
+  } else {
+    return CalPrinterBase::Todolist;
+  }
 }
 
 void KOTodoView::editItem( QListViewItem *item )
@@ -827,6 +849,22 @@
   showItem( mActiveItem );
 }
 
+void KOTodoView::printTodo()
+{
+#ifndef KORG_NOPRINTER
+  Calendar *cal;
+  KOCoreHelper helper;
+  CalPrinter printer( this, cal, &helper );
+  connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
+
+  Incidence::List selectedIncidences;
+  selectedIncidences.append( mActiveItem->todo() );
+
+  printer.print( KOrg::CalPrinterBase::Incidence,
+                 QDate(), QDate(), selectedIncidences );
+#endif
+}
+
 void KOTodoView::deleteTodo()
 {
   if (mActiveItem) {
@@ -879,7 +917,10 @@
       todo->setPercentComplete( percentage );
     }
     item->construct();
-    mChanger->changeIncidence( oldTodo, todo, KOGlobals::COMPLETION_MODIFIED );
+    if ( todo->doesRecur() && percentage == 100 )
+      mChanger->changeIncidence( oldTodo, todo, KOGlobals::COMPLETION_MODIFIED_WITH_RECURRENCE );
+    else
+      mChanger->changeIncidence( oldTodo, todo, KOGlobals::COMPLETION_MODIFIED );
     mChanger->endChange( todo );
     delete oldTodo;
   } else {
@@ -925,15 +966,13 @@
 
 void KOTodoView::copyTodoToDate( QDate date )
 {
-  QDateTime dt;
-  dt.setDate( date );
+  QDateTime dt( date );
 
   if ( mActiveItem && mChanger ) {
     Todo *newTodo = mActiveItem->todo()->clone();
     newTodo->recreate();
 
-   if ( date.isNull() )
-     newTodo->setHasDueDate( false );
+   newTodo->setHasDueDate( !date.isNull() );
    newTodo->setDtDue( dt );
    newTodo->setPercentComplete( 0 );
 
Index: korganizer/korganizer_options.h
===================================================================
--- korganizer/korganizer_options.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_options.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,9 +32,12 @@
 static const KCmdLineOptions korganizer_options[] =
 {
   { "i", 0, 0 },
-  { "import <url>", I18N_NOOP("Import calendar at <url> into default calendar"),
-    0 },
-  { "+[calendar]", I18N_NOOP("A calendar file to load"), 0 },
+  { "import", I18N_NOOP("Import the given calendars as new resources into the default calendar"), 0 },
+  { "m", 0, 0 },
+  { "merge", I18N_NOOP("Merge the given calendars into the standard calendar (i.e. copy the events)"), 0 },
+  { "o", 0, 0 },
+  { "open", I18N_NOOP("Open the given calendars in a new window"), 0 },
+  { "+[calendars]", I18N_NOOP("Calendar files or urls. Unless -i, -o or -m is explicitly specified, the user will be asked whether to import, merge or open in a separate window."), 0 },
   KCmdLineLastOption
 };
 
Index: korganizer/kojournalview.cpp
===================================================================
--- korganizer/kojournalview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kojournalview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -78,7 +78,7 @@
              entry, SLOT( journalEdited( Journal* ) ) );
     connect( this, SIGNAL( journalDeleted( Journal* ) ),
              entry, SLOT( journalDeleted( Journal* ) ) );
-    
+
     connect( entry, SIGNAL( editIncidence( Incidence* ) ),
              this, SIGNAL( editIncidenceSignal( Incidence* ) ) );
     connect( entry, SIGNAL( deleteIncidence( Incidence* ) ),
@@ -87,7 +87,7 @@
              this, SIGNAL( newJournalSignal( const QDate & ) ) );
     mEntries.insert( dt, entry );
   }
-  
+
   if ( entry && journal ) {
     entry->addJournal( journal );
   }
@@ -168,6 +168,11 @@
   }
 }
 
+CalPrinterBase::PrintType KOJournalView::printType()
+{
+  return CalPrinterBase::Journallist;
+}
+
 void KOJournalView::changeIncidenceDisplay(Incidence *incidence, int action)
 {
 //  kdDebug(5850) << "KOJournalView::changeIncidenceDisplay(): "<< endl;
Index: korganizer/interfaces/calendar/calendarplugin.desktop
===================================================================
--- korganizer/interfaces/calendar/calendarplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/calendar/calendarplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,7 +4,6 @@
 X-KDE-ServiceType=Calendar/Plugin
 Comment=Calendar Plugin
 Comment[af]=Kalender Inplak
-Comment[ar]=ملحق التقويم
 Comment[az]=Təqvim Əlavəsi
 Comment[be]=Дапаўненьне "Календар"
 Comment[bg]=Приставка за календар
Index: korganizer/interfaces/calendar/calendardecoration.desktop
===================================================================
--- korganizer/interfaces/calendar/calendardecoration.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/calendar/calendardecoration.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -4,7 +4,6 @@
 X-KDE-ServiceType=Calendar/Decoration
 Comment=Calendar Decoration Plugin
 Comment[af]=Kalender Versiering Inplak
-Comment[ar]=ملحق تزيين التقويم
 Comment[bg]=Приставка за декорация на календара
 Comment[br]=Lugent kinkladur an deiziadur
 Comment[bs]=Dodatak za ukrašavanje kalendara
Index: korganizer/interfaces/korganizer/printplugin.h
===================================================================
--- korganizer/interfaces/korganizer/printplugin.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/korganizer/printplugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -26,37 +26,46 @@
 #include <qdatetime.h>
 #include <kprinter.h>
 #include <calendar/plugin.h>
+#include <libkcal/incidence.h>
 
 namespace KCal {
 class Calendar;
 }
-class CalPrintHelper;
 
 namespace KOrg {
-
 class CoreHelper;
 
 /**
+  Base class of KOrganizer printer class.
+*/
+class CalPrinterBase
+{
+  public:
+    enum PrintType { Incidence = 100, Day=200, Week=300, Month=400, Todolist=1000, Journallist=2000 };
+};
+
+/**
   Base class for KOrganizer printing classes. Each sub class represents one
   calendar print format.
 */
 class PrintPlugin : public KOrg::Plugin
 {
   public:
-    PrintPlugin() : KOrg::Plugin(), mCoreHelper(0), mPrinter(0),
-         mCalendar(0), mConfig(0), mHelper(0) {}
+    PrintPlugin() : KOrg::Plugin(), mConfigWidget(0), mCoreHelper(0), mPrinter(0),
+         mCalendar(0), mConfig(0) {}
     virtual ~PrintPlugin() {}
 
     typedef QPtrList<PrintPlugin> List;
     static int interfaceVersion() { return 2; }
     static QString serviceType() { return "KOrganizer/PrintPlugin"; }
 
-    virtual void setCalPrintHelper( CalPrintHelper *helper ) { mHelper = helper; }
     virtual void setKOrgCoreHelper( KOrg::CoreHelper*helper ) { mCoreHelper = helper; }
     virtual void setConfig( KConfig *cfg ) { mConfig = cfg; }
     virtual void setCalendar( KCal::Calendar *cal ) { mCalendar = cal; }
-    virtual void setPrinter( KPrinter *pr ) { mPrinter = pr; }
+    virtual void setSelectedIncidences( KCal::Incidence::List inc ) { mSelectedIncidences = inc; }
+    virtual KCal::Incidence::List selectedIncidences() const { return mSelectedIncidences; }
 
+
     /**
       Returns short description of print format.
     */
@@ -66,10 +75,27 @@
     */
     virtual QString info() = 0;
 
+    /**
+      Returns the sort ID of the plugin. This value will be used to identify
+      the config widget in the widget stack, and to sort the plugin name in the
+      print style selection list.
+      If another plugin uses the same ID or a value of -1 is returned, a unique
+      (negative) ID will be automatically generated and thus the position of
+      the plugin in the selection list is undefined.
+    */
+    virtual int sortID() { return -1; }
+
+    /**
+      Returns true if the plugin should be enabled; false otherwise.
+    */
+    virtual bool enabled() { return false; }
+
     QWidget *configWidget( QWidget *w )
     {
-      mConfigWidget = createConfigWidget( w );
-      setSettingsWidget();
+      if ( !mConfigWidget ) {
+        mConfigWidget = createConfigWidget( w );
+        setSettingsWidget();
+      }
       return mConfigWidget;
     }
     /* Create the config widget. setSettingsWidget will be automatically
@@ -79,7 +105,7 @@
     /**
       Actually do the printing.
     */
-    virtual void doPrint() = 0;
+    virtual void doPrint( KPrinter *printer ) = 0;
 
     /**
       Orientation of printout. Default is Portrait. If your plugin wants
@@ -87,7 +113,7 @@
       config settings), implement this function in your subclass and
       return the desired orientation.
     */
-    virtual KPrinter::Orientation orientation() { return KPrinter::Portrait; }
+    virtual KPrinter::Orientation defaultOrientation() { return KPrinter::Portrait; }
 
     /**
       Load complete config.
@@ -125,13 +151,14 @@
   protected:
     QWidget *mConfigWidget;
     KOrg::CoreHelper *mCoreHelper;
+    /** The printer object. This will only be available in the doPrint method
+        of the selected plugin */
     KPrinter *mPrinter;
     KCal::Calendar *mCalendar;
+    KCal::Incidence::List mSelectedIncidences;
     KConfig *mConfig;
-    CalPrintHelper *mHelper;
 };
 
-
 class PrintPluginFactory : public PluginFactory
 {
   public:
Index: korganizer/interfaces/korganizer/korgprintplugin.desktop
===================================================================
--- korganizer/interfaces/korganizer/korgprintplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/korganizer/korgprintplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Comment[eu]=KOrganizer zatia
 Comment[fa]=بخش KOrganizer
 Comment[fr]=Composant KOrganizer
+Comment[gl]=Parte de KOrganizer
 Comment[he]=רכיב KOrganizer
 Comment[hi]=के-आर्गेनाइज़र हिस्सा
 Comment[hr]=KOrganizer komponenta
Index: korganizer/interfaces/korganizer/korganizerpart.desktop
===================================================================
--- korganizer/interfaces/korganizer/korganizerpart.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/korganizer/korganizerpart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -18,6 +18,7 @@
 Comment[eu]=KOrganizer zatia
 Comment[fa]=بخش KOrganizer
 Comment[fr]=Composant KOrganizer
+Comment[gl]=Parte de KOrganizer
 Comment[he]=רכיב KOrganizer
 Comment[hi]=के-आर्गेनाइज़र हिस्सा
 Comment[hr]=KOrganizer komponenta
Index: korganizer/interfaces/korganizer/baseview.h
===================================================================
--- korganizer/interfaces/korganizer/baseview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/korganizer/baseview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,25 +32,17 @@
 #include <kdepimmacros.h>
 #include "korganizer/incidencechangerbase.h"
 
+#include "printplugin.h"
+
 #include <libkcal/event.h>
 
 using namespace KCal;
 
 namespace KCal { class Calendar; }
-class CalPrinter;
 
 namespace KOrg {
 
-/**
-  Base class of KOrganizer printer class.
-*/
-class CalPrinterBase
-{
-  public:
-    enum PrintType { Day, Week, Month, Todolist };
-};
 
-
 /**
   This class provides an interface for all views being displayed within the main
   calendar view. It has functions to update the view, to specify date range and
Index: korganizer/interfaces/korganizer/corehelper.h
===================================================================
--- korganizer/interfaces/korganizer/corehelper.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/interfaces/korganizer/corehelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -45,6 +45,7 @@
     virtual QTime dayStart() = 0;
     virtual const KCalendarSystem *calendarSystem() = 0;
     virtual KOrg::PrintPlugin::List loadPrintPlugins() = 0;
+    virtual bool isWorkingDay( const QDate &dt ) = 0;
 };
 
 }
Index: korganizer/kotodoeditor.cpp
===================================================================
--- korganizer/kotodoeditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kotodoeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -30,12 +30,10 @@
 #include <qlayout.h>
 #include <qdatetime.h>
 
-#include <kabc/addressee.h>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kmessagebox.h>
 
-#include <libkdepim/categoryselectdialog.h>
 #include <libkcal/calendarlocal.h>
 #include <libkcal/calendarresources.h>
 #include <libkcal/resourcecalendar.h>
@@ -89,10 +87,6 @@
 {
   mGeneral = new KOEditorGeneralTodo(this);
 
-  connect(mGeneral,SIGNAL(openCategoryDialog()),mCategoryDialog,SLOT(show()));
-  connect(mCategoryDialog, SIGNAL(categoriesSelected(const QString &)),
-          mGeneral,SLOT(setCategories(const QString &)));
-
   if (KOPrefs::instance()->mCompactDialogs) {
     QFrame *topFrame = addPage(i18n("General"));
 
@@ -170,75 +164,30 @@
   setCaption( i18n("Edit To-do") );
 }
 
-void KOTodoEditor::newTodo( const QDateTime &due, Todo *relatedTodo, bool allDay)
+void KOTodoEditor::newTodo()
 {
   init();
-
   mTodo = 0;
-  setDefaults(due,relatedTodo,allDay);
-
   setCaption( i18n("New To-do") );
 }
 
-void KOTodoEditor::newTodo( const QString &text )
+void KOTodoEditor::setTexts( const QString &summary, const QString &description )
 {
-  init();
-
-  mTodo = 0;
-
-  loadDefaults();
-
-  mGeneral->setDescription( text );
-
-  int pos = text.find( "\n" );
-  if ( pos > 0 ) {
-    mGeneral->setSummary( text.left( pos ) );
-    mGeneral->setDescription( text );
+  if ( description.isEmpty() && summary.contains("\n") ) {
+    mGeneral->setDescription( summary );
+    int pos = summary.find( "\n" );
+    mGeneral->setSummary( summary.left( pos ) );
   } else {
-    mGeneral->setSummary( text );
+    mGeneral->setSummary( summary );
+    mGeneral->setDescription( description );
   }
-
-  setCaption( i18n("New To-do") );
 }
 
-void KOTodoEditor::newTodo( const QString &summary,
-                            const QString &description,
-                            const QString &attachment )
-{
-  init();
 
-  mTodo = 0;
 
-  loadDefaults();
-
-  mGeneral->setSummary( summary );
-  mGeneral->setDescription( description );
-
-  if ( !attachment.isEmpty() ) {
-    mAttachments->addAttachment( attachment );
-  }
-
-  setCaption( i18n("New To-do") );
-}
-
-void KOTodoEditor::newTodo( const QString &summary,
-                            const QString &description,
-                            const QString &attachment,
-                            const QStringList &attendees )
-{
-  newTodo( summary, description, attachment );
-
-  QStringList::ConstIterator it;
-  for ( it = attendees.begin(); it != attendees.end(); ++it ) {
-    QString name, email;
-    KABC::Addressee::parseEmailAddress( *it, name, email );
-    mDetails->insertAttendee( new Attendee( name, email ) );
-  }
-}
-
 void KOTodoEditor::loadDefaults()
 {
-  setDefaults(QDateTime::currentDateTime().addDays(7),0,false);
+  setDates( QDateTime::currentDateTime().addDays(7), true, 0 );
 }
 
 bool KOTodoEditor::processInput()
@@ -293,21 +242,19 @@
   reject();
 }
 
-void KOTodoEditor::setDefaults( const QDateTime &due, Todo *relatedEvent, bool allDay )
+void KOTodoEditor::setDates( const QDateTime &due, bool allDay, Todo *relatedEvent )
 {
   mRelatedTodo = relatedEvent;
 
   // inherit some properties from parent todo
   if ( mRelatedTodo ) {
-    mGeneral->setCategories( mRelatedTodo->categoriesStr() );
-    mCategoryDialog->setSelected( mRelatedTodo->categories() );
-    if ( mRelatedTodo->hasDueDate() )
-      mGeneral->setDefaults( mRelatedTodo->dtDue(), allDay );
-    else
-      mGeneral->setDefaults( due, allDay );
+    mGeneral->setCategories( mRelatedTodo->categories() );
   }
-  else
+  if ( !due.isValid() && mRelatedTodo && mRelatedTodo->hasDueDate() ) {
+    mGeneral->setDefaults( mRelatedTodo->dtDue(), allDay );
+  } else {
     mGeneral->setDefaults( due, allDay );
+  }
 
   mDetails->setDefaults();
   if ( mTodo )
@@ -319,6 +266,8 @@
 
 void KOTodoEditor::readTodo( Todo *todo )
 {
+  if ( !todo ) return;
+//   mRelatedTodo = todo->relatedTo();
   kdDebug(5850)<<"read todo"<<endl;
   mGeneral->readTodo( todo );
   mDetails->readEvent( todo );
@@ -326,8 +275,6 @@
   mRecurrence->readIncidence( todo );
   mAttachments->readIncidence( todo );
 
-  // categories
-  mCategoryDialog->setSelected( todo->categories() );
   createEmbeddedURLPages( todo );
   readDesignerFields( todo );
 }
@@ -348,7 +295,7 @@
   }
   writeDesignerFields( todo );
 
-  // set related event, i.e. parent to-do in this case.
+  // set related incidence, i.e. parent to-do in this case.
   if ( mRelatedTodo ) {
     todo->setRelatedTo( mRelatedTodo );
   }
Index: korganizer/koagenda.cpp
===================================================================
--- korganizer/koagenda.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koagenda.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1038,6 +1038,7 @@
 void KOAgenda::endItemAction()
 {
 //  kdDebug(5850) << "KOAgenda::endItemAction() " << endl;
+  mActionType = NOP;
   mScrollUpTimer.stop();
   mScrollDownTimer.stop();
   setCursor( arrowCursor );
@@ -1123,7 +1124,6 @@
     if ( modify ) {
       mActionItem->endMove();
       KOAgendaItem *placeItem = mActionItem->firstMultiItem();
-      // FIXME: A mChanger->changeIncidence is missing here!
       if  ( !placeItem ) {
         placeItem = mActionItem;
       }
@@ -1141,7 +1141,8 @@
         placeItem = placeItem->nextMultiItem();
       }
 
-      // Notify about change, so that agenda view can update the event data
+      // Notify about change
+      // the agenda view will apply the changes to the actual Incidence*!
       emit itemModified( modif );
     }
     // FIXME: If the change failed, we need to update the view!
@@ -1149,7 +1150,6 @@
   }
 
   mActionItem = 0;
-  mActionType = NOP;
   mItemMoved = false;
 
   if ( multiModify ) emit endMultiModify();
Index: korganizer/koagendaview.h
===================================================================
--- korganizer/koagendaview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koagendaview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -28,11 +28,11 @@
 #include <qscrollview.h>
 #include <qlabel.h>
 
-#include "calprinter.h"
 #include "koeventview.h"
 
 class QHBox;
 class QPushButton;
+class QBoxLayout;
 
 class KOAgenda;
 class KOAgendaItem;
@@ -163,7 +163,7 @@
     /** Remove all events from view */
     void clearView();
 
-    CalPrinter::PrintType printType();
+    CalPrinterBase::PrintType printType();
 
     /** start-datetime of selection */
     QDateTime selectionStart() { return mTimeSpanBegin; }
Index: korganizer/komonthview.cpp
===================================================================
--- korganizer/komonthview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/komonthview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -943,9 +943,9 @@
       if ( todo->hasDueDate() ) {
         mStartDate = todo->dtDue();
         mEndDate = todo->dtDue();
-        return true;
-      } else
-        return false;
+      }// else
+//         return false;
+      return true;
     }
     bool visit( Journal *journal ) {
       mStartDate = journal->dtStart();
Index: korganizer/kotodoview.h
===================================================================
--- korganizer/kotodoview.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kotodoview.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,7 +32,6 @@
 
 #include <libkcal/todo.h>
 #include <korganizer/baseview.h>
-#include "calprinter.h"
 
 class QDragEnterEvent;
 class QDragMoveEvent;
@@ -127,7 +126,7 @@
     /** Return number of shown dates. TodoView does not show dates, */
     int currentDateCount() { return 0; }
 
-    CalPrinter::PrintType printType();
+    CalPrinterBase::PrintType printType();
 
     void setDocumentId( const QString & );
 
@@ -157,6 +156,7 @@
     void newSubTodo();
     void showTodo();
     void editTodo();
+    void printTodo();
     void deleteTodo();
 
     void setNewPercentage( KOTodoViewItem *item, int percentage );
@@ -177,7 +177,7 @@
   signals:
     void unSubTodoSignal();
     void unAllSubTodoSignal();
-    
+
     void todoCompleted( Todo * );
 
     void purgeCompletedSignal();
@@ -235,7 +235,7 @@
       eDueDateColumn = 4,
       eCategoriesColumn = 5,
       eDescriptionColumn = 6
-    }; 
+    };
     enum {
       ePopupEdit = 1300,
       ePopupDelete = 1301,
@@ -244,7 +244,7 @@
       ePopupUnSubTodo = 1304,
       ePopupUnAllSubTodo = 1305
     };
-  
+
 };
 
 #endif
Index: korganizer/plugins/datenums/datenums.desktop
===================================================================
--- korganizer/plugins/datenums/datenums.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/datenums/datenums.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -15,6 +15,7 @@
 Name[fa]=وصلۀ عدد تاریخ برای تقویمها
 Name[fi]=Päivämääräliitännäinen kalentereihin
 Name[fr]=Module de numérotation des jours
+Name[gl]=Engadido para Números dos Días nos Calendarios
 Name[he]=תוסף מספרי תאריכים ללוחות שנה
 Name[hu]=Dátumkezelő bővítőmodul naptárakhoz
 Name[is]=Íforrit fyrir númer dags á dagatali
@@ -52,9 +53,10 @@
 Comment[es]=Para cada día, esta extensión mostrará el número del día en el año en la parte superior de la vista de la agenda. Por ejemplo, el 1 de febrero es el día número 32 del año.
 Comment[et]=See plugin näitab iga päevakavavaate ülaosas iga päeva järjekorranumbrit aastas. Näiteks 1. veebruar on aasta 32. päev.
 Comment[eu]=Egun bakoitzeko, plugin honek bere urteko egun-zenbakia erakutsiko du agenda ikuspegiaren goiko aldean. Adibidez, Otsailak 1 urtearen 32. eguna da.
-Comment[fa]=در هر روز، این وصله عدد مربوط به روز سال را در بالای نمای agenda را نمایش می‌دهد. مثلاً ۱ فوریه، سی و دومین روز سال می‌باشد.
+Comment[fa]=در هر روز، این وصله عدد مربوط به روز سال را در بالای نمای agenda  نمایش می‌دهد. مثلاً ۱ فوریه، سی و دومین روز سال می‌باشد.
 Comment[fi]=Tämä liitännäinen näyttää jokaisen päivän järjestysnumeron vuoden alusta agendanäkymässä. Esimerkiksi helmikuun ensimmäinen päivä on vuoden 32. päivä.
 Comment[fr]=Pour chaque jour, ce module montre le numéro du jour en haut de la vue agenda. Par exemple, le 1er février est le 32ème jour de l'année.
+Comment[gl]=Este engadido amosa cada día o número de día anual na vista superior da axenda. Por exemplo, o 1 de febreiro é o día 32 do ano.
 Comment[hu]=Megjeleníti az év elejétől eltelt napok számát az áttekintő nézet tetején. Például február elseje az év 32. napja.
 Comment[is]=Þetta íforrit sýnir efst í fundarskránni númer hvers dags í árinu. T.d. er 1. febrúar 32. dagurinn í árinu.
 Comment[it]=Per ciascun giorno, questo plugin mostra la data giuliana (numero progressivo a partire dal primo gennaio dell'anno corrente). Per esempio al primo di febbraio corrisponde il numero 32.
Index: korganizer/plugins/projectview/projectview.desktop
===================================================================
--- korganizer/plugins/projectview/projectview.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/projectview/projectview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -3,7 +3,6 @@
 X-KDE-Library=libkorg_projectview
 Name=Project View Plugin for KOrganizer
 Name[af]=Projek Besigtig Inplak vir Korganizer
-Name[ar]=ملحق عرض المشاريع للمنظم
 Name[az]=KOrganizer Layihə Nümayiş Əlavəsi
 Name[bg]=Приставка на организатора за преглед на проекти
 Name[br]=Lugent gwell raktres evit KOrganizer
@@ -72,6 +71,7 @@
 Comment[fa]=این وصله، برای KOrganizer یک نمای طراحی پروژه )مثل نماهای کارهای انجامی یا ماهانه( فراهم می‌‌کند. اگر این وصله را فعال کنید، می‌توانید به نمای پروژه سودهی کرده و مانند طراح پروژه، فهرست کارهای انجامی خود را مشاهده کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa projektin suunnittelunäkymän KOrganizeriin (kuten tehtävälista- tai kuukausinäkymän). Jos kytket tämän päälle, voit vaihtaa projektinäkymään ja katsoa tehtävälistaa kuten projektin suunnittelussa.
 Comment[fr]=Ce module propose une vue en projet pour KOrganizer. Si vous activez ce module, vous pourrez visualiser vos tâches sous la forme d'un planning projet.
+Comment[gl]=Este engadido fornece unha vista planificadora de proxectos para KOrganizer (como as vistas de tarefas ou mensuais). Se habilita este engadid, pode trocar á vista de proxecto e ver a súa lista de tarefas nun planificador de proxectos.
 Comment[hu]=Ezzel a modullal projekttervező nézet alakítható ki a KOrganizerben (például a feladatokhoz vagy a havi nézetekhez). Ha aktiválja ezt a modult, átválthat projektnézetbe, hogy a feladatok projekttervként legyenek megtekinthetők.
 Comment[is]=Þetta íforrit veitir verkskipulagssýn fyrir KOrganizer (svipað og verkþátta eða mánaðarsýn). Ef þú virkjar þetta íforrit, getur þú á einfaldan hátt skipt yfir í verkefnasýn og skoðað verkþáttalistann þinn í skipuleggjara.
 Comment[it]=Questo plugin fornisce una vista di pianificazione progetto per KOrganizer (come la vista delle cose da fare o quella mensile). Se abiliti questo plugin, puoi passare dalla vista progetto alla vista delle cose da fare come in un pianificatore di progetti.
Index: korganizer/plugins/exchange/exchange.desktop
===================================================================
--- korganizer/plugins/exchange/exchange.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/exchange/exchange.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -54,12 +54,13 @@
 Comment[es]=Esta extensión permite que los usuarios de korganizer trabajen con servidores de groupware de Microsoft Exchange 2000.
 Comment[et]=See plugin võimaldab KOrganizeri kasutajatel pruukida Microsoft Exchange 2000 grupitööservereid.
 Comment[eu]=Plugin honek korganizer-en erabiltzaileei Microsoft Exchange 2000 groupware zerbitzariekin lan egiteko aukera ematen die.
-Comment[fa]=این وصله به کاربران korganizer اجازه می‌دهد که با کارسازهای Microsoft Exchange 2000 groupware کار می‌کند.
+Comment[fa]=این وصله به کاربران korganizer اجازه می‌دهد که با کارسازهای Microsoft Exchange 2000 groupware کار کند.
 Comment[fi]=Tämä liitännäinen mahdollistaa KOrganizer-käyttäjien työskentelemisen Microsoft Exchange 2000 -ryhmätyöpalvelimien kanssa.
 Comment[fr]=Ce module permet à KOrganizer de fonctionner avec Microsoft Exchange 2000
+Comment[gl]=Este engadido permite que os usuarios de korganizer traballen con servidores de traballo en grupo Microsoft Exchange 2000
 Comment[hu]=Ez a modul lehetővé teszi KOrganizer-felhasználóknak Microsoft Exchange 2000-kiszolgálón tárolt csoportmunka-adatok elérését.
 Comment[is]=Þetta íforrit gerir KOrganizer kleyft að vinna með Microsoft Exchange 2000 hópvinnuþjónum.
-Comment[it]=Questo plugin pemette agli utenti di korganizer di lavorare con i server groupware Microsoft Exchange 2000.
+Comment[it]=Questo plugin permette agli utenti di korganizer di lavorare con i server groupware Microsoft Exchange 2000.
 Comment[ja]=本プラグインにより、korganizer のユーザは Microsoft Exchange 2000 グループウェアサーバとの同期が可能となります。
 Comment[km]=កម្មវិធី​ជំនួយ​នេះ​អនុញ្ញាត​ឲ្យ​អ្នក​ប្រើ​របស់ korganizer ធ្វើការ​ជាមួយ​ម៉ាស៊ីន​បម្រើ​កម្មវិធី​ពហុ​អ្នកប្រើ​របស់​ម៉ៃក្រូសូហ្វ Exchange ២០០០ ។
 Comment[lt]=Šis priedas leidžia korganizer dirbti su Microsoft Exchange 2000 groupware serveriais.
Index: korganizer/plugins/printing/year/yearprint.h
===================================================================
--- korganizer/plugins/printing/year/yearprint.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/plugins/printing/year/yearprint.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,65 @@
+/*
+    This file is part of KOrganizer.
+
+    Copyright (c) 2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+#ifndef YEARPRINT_H
+#define YEARPRINT_H
+
+#include <klocale.h>
+#include "calprintpluginbase.h"
+
+#ifndef KORG_NOPRINTER
+namespace KCal {
+class Calendar;
+}
+
+using namespace KCal;
+
+class CalPrintYear : public CalPrintPluginBase
+{
+  public:
+    CalPrintYear():CalPrintPluginBase() {}
+    virtual ~CalPrintYear() {}
+    virtual QString description() { return i18n("Print &Year"); }
+    virtual QString info() { return i18n("Prints a calendar for an entire year"); }
+    virtual int sortID() { return 900; }
+    virtual bool enabled() { return true; }
+    virtual QWidget *createConfigWidget( QWidget* );
+    virtual KPrinter::Orientation defaultOrientation();
+
+  public:
+    virtual void print(QPainter &p, int width, int height);
+    virtual void readSettingsWidget();
+    virtual void setSettingsWidget();
+    virtual void loadConfig();
+    virtual void saveConfig();
+    virtual void setDateRange( const QDate& from, const QDate& to );
+
+  protected:
+    int mYear;
+    int mPages;
+    int mSubDaysEvents, mHolidaysEvents;
+};
+
+
+#endif
+#endif
Index: korganizer/plugins/printing/year/yearprint.desktop
===================================================================
--- korganizer/plugins/printing/year/yearprint.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/plugins/printing/year/yearprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,51 @@
+[Desktop Entry]
+Encoding=UTF-8
+X-KDE-Library=libkorg_yearlyprint
+Name=Yearly Print Style
+Name[ca]=Estil d'impressió anual
+Name[cs]=Roční tiskový styl
+Name[da]=Yearly udskriftsstil
+Name[de]=Jahres-Druckstil
+Name[el]=Στυλ ετήσιας εκτύπωσης
+Name[es]=Estilo de impresión del diario
+Name[et]=Aastakalendri trükkimise stiil
+Name[fa]=سبک چاپ نشریه
+Name[gl]=Estilo de impresión anual
+Name[hu]=Éves naptár nyomtatási stílus
+Name[it]=Stile di stampa annuale
+Name[ja]=年毎印刷スタイル
+Name[km]=រចនាប័ទ្ម​បោះពុម្ព​ប្រចាំ​ឆ្នាំ
+Name[nds]=Johrkalenner-Druckstil
+Name[nl]=Printstijl voor jaarkalender
+Name[pt]=Estilo de Impressão em Anuário
+Name[pt_BR]=Estilo de Impressão em Anuário
+Name[ru]=Календарь на год
+Name[sv]=Årlig utskriftsstil
+Name[uk]=Стиль друку щорічником
+Name[zh_TW]=年度列印風格
+Comment=This plugin allows you to print out a yearly calendar.
+Comment[ca]=Aquest endollable us permet imprimir un calenadri anual.
+Comment[cs]=Tento modul umožňuje tisk ročního kalendáře.
+Comment[da]=Dette plugin gør at du kan udskrive en årlig kalender
+Comment[de]=Mit diesem Modul können Jahresübersichten gedruckt werden.
+Comment[el]=Αυτό το πρόσθετο σας επιτρέπει να εκτυπώσετε ένα ετήσιο ημερολόγιο.
+Comment[es]=Este plugin le permite imprimir entradas del diario.
+Comment[et]=See plugin võimaldab trükkida terve aasta kalendri.
+Comment[fa]=این وصله، به شما اجازه می‌دهد که مدخلهای نشریه )مدخلهای روزانه( را چاپ کنید.
+Comment[gl]=Este engadido permítelle imprimir un calendario anual.
+Comment[hu]=Ez a modul egy egész éves naptár kinyomtatását teszi lehetővé.
+Comment[it]=Questo plugin ti permette di stampare un calendario annuale.
+Comment[ja]=本プラグインにより年毎のカレンダーを印刷できるようになります。
+Comment[km]=កម្មវិធី​ជំនួយ​នេះ​អនុញ្ញាត​ឲ្យ​អ្នក​បោះពុម្ព​​ប្រតិទិន​ប្រចាំ​ឆ្នាំ ។
+Comment[nds]=Mit dit Moduul kannst Du en Kalenner för't hele Johr utdrucken.
+Comment[nl]=Deze plugin maakt het mogelijk om een jaarkalender af te drukken.
+Comment[pt]=Este 'plugin' permite-lhe imprimir um calendário anual.
+Comment[pt_BR]=Este 'plugin' permite-lhe imprimir um calendário anual.
+Comment[ru]=Этот модуль позволяет печатать календарь на год.
+Comment[sv]=Det här insticksprogrammet gör att du kan skriva ut en årlig kalender.
+Comment[uk]=Цей журнал надає можливість друкувати щорічний календар.
+Comment[zh_TW]=此外掛程式讓您印出年曆。
+Type=Service
+ServiceTypes=Calendar/Plugin,KOrganizer/PrintPlugin
+X-KDE-KOrganizer-HasSettings=false
+X-KDE-PluginInterfaceVersion=2
Index: korganizer/plugins/printing/year/Makefile.am
===================================================================
--- korganizer/plugins/printing/year/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/plugins/printing/year/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,14 @@
+INCLUDES = -I$(top_srcdir)/korganizer/interfaces -I$(top_srcdir)/korganizer/printing -I$(top_srcdir) $(all_includes) 
+
+kde_module_LTLIBRARIES = libkorg_yearlyprint.la
+
+libkorg_yearlyprint_la_SOURCES =calprintyearconfig_base.ui  yearprint.cpp
+libkorg_yearlyprint_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) 
+libkorg_yearlyprint_la_LIBADD = $(LIB_KDECORE) $(LIB_KDEUI) $(top_builddir)/korganizer/printing/libkorg_stdprinting.la
+
+noinst_HEADERS = 
+
+servicedir  = $(kde_servicesdir)/korganizer
+service_DATA = yearprint.desktop
+
+METASOURCES = AUTO
Index: korganizer/plugins/printing/year/calprintyearconfig_base.ui
===================================================================
--- korganizer/plugins/printing/year/calprintyearconfig_base.ui	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/plugins/printing/year/calprintyearconfig_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,200 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>CalPrintYearConfig_Base</class>
+<comment>Configuration page for the yearly print mode.</comment>
+<author>Reinhold Kainhofer &lt;reinhold@kainhofer.com&gt;</author>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>CalPrintYear_Base</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>340</width>
+            <height>237</height>
+        </rect>
+    </property>
+    <property name="caption">
+        <string>CalPrintYear_Base</string>
+    </property>
+    <vbox>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <property name="margin">
+            <number>0</number>
+        </property>
+        <widget class="QButtonGroup">
+            <property name="name">
+                <cstring>mDateRangeGroup</cstring>
+            </property>
+            <property name="title">
+                <string>Yearly print options</string>
+            </property>
+            <property name="selectedId" stdset="0">
+                <number>-1</number>
+            </property>
+            <grid>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QLabel" row="0" column="0">
+                    <property name="name">
+                        <cstring>mYearLabel</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Print &amp;Year:</string>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>mYear</cstring>
+                    </property>
+                </widget>
+                <widget class="QLabel" row="1" column="0">
+                    <property name="name">
+                        <cstring>mPagesLabel</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Number of &amp;pages:</string>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>mPages</cstring>
+                    </property>
+                </widget>
+                <widget class="QSpinBox" row="0" column="1">
+                    <property name="name">
+                        <cstring>mYear</cstring>
+                    </property>
+                    <property name="maxValue">
+                        <number>2500</number>
+                    </property>
+                    <property name="minValue">
+                        <number>0</number>
+                    </property>
+                    <property name="value">
+                        <number>2007</number>
+                    </property>
+                </widget>
+                <spacer row="0" column="2">
+                    <property name="name">
+                        <cstring>spacer4</cstring>
+                    </property>
+                    <property name="orientation">
+                        <enum>Horizontal</enum>
+                    </property>
+                    <property name="sizeType">
+                        <enum>Expanding</enum>
+                    </property>
+                    <property name="sizeHint">
+                        <size>
+                            <width>120</width>
+                            <height>21</height>
+                        </size>
+                    </property>
+                </spacer>
+                <widget class="QComboBox" row="1" column="1">
+                    <property name="name">
+                        <cstring>mPages</cstring>
+                    </property>
+                </widget>
+                <spacer row="1" column="2">
+                    <property name="name">
+                        <cstring>spacer5</cstring>
+                    </property>
+                    <property name="orientation">
+                        <enum>Horizontal</enum>
+                    </property>
+                    <property name="sizeType">
+                        <enum>Expanding</enum>
+                    </property>
+                    <property name="sizeHint">
+                        <size>
+                            <width>131</width>
+                            <height>21</height>
+                        </size>
+                    </property>
+                </spacer>
+            </grid>
+        </widget>
+        <widget class="QGroupBox">
+            <property name="name">
+                <cstring>mDisplayOptionsGroup</cstring>
+            </property>
+            <property name="title">
+                <string>Display Options</string>
+            </property>
+            <grid>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QLabel" row="0" column="0">
+                    <property name="name">
+                        <cstring>mSubDaysLabel</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Show sub-day events as:</string>
+                    </property>
+                </widget>
+                <widget class="QLabel" row="1" column="0">
+                    <property name="name">
+                        <cstring>mHolidaysLabel</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Show holidays as:</string>
+                    </property>
+                </widget>
+                <widget class="QComboBox" row="0" column="1">
+                    <item>
+                        <property name="text">
+                            <string>Text</string>
+                        </property>
+                    </item>
+                    <item>
+                        <property name="text">
+                            <string>Time Boxes</string>
+                        </property>
+                    </item>
+                    <property name="name">
+                        <cstring>mSubDays</cstring>
+                    </property>
+                    <property name="currentItem">
+                        <number>1</number>
+                    </property>
+                </widget>
+                <widget class="QComboBox" row="1" column="1">
+                    <item>
+                        <property name="text">
+                            <string>Text</string>
+                        </property>
+                    </item>
+                    <item>
+                        <property name="text">
+                            <string>Time Boxes</string>
+                        </property>
+                    </item>
+                    <property name="name">
+                        <cstring>mHolidays</cstring>
+                    </property>
+                </widget>
+            </grid>
+        </widget>
+        <spacer>
+            <property name="name">
+                <cstring>spacer3</cstring>
+            </property>
+            <property name="orientation">
+                <enum>Vertical</enum>
+            </property>
+            <property name="sizeType">
+                <enum>Expanding</enum>
+            </property>
+            <property name="sizeHint">
+                <size>
+                    <width>21</width>
+                    <height>40</height>
+                </size>
+            </property>
+        </spacer>
+    </vbox>
+</widget>
+<layoutdefaults spacing="6" margin="11"/>
+</UI>
Index: korganizer/plugins/printing/year/yearprint.cpp
===================================================================
--- korganizer/plugins/printing/year/yearprint.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/plugins/printing/year/yearprint.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,204 @@
+/*
+    This file is part of KOrganizer.
+
+    Copyright (c) 2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KORG_NOPRINTER
+
+#include "calprintyearconfig_base.h"
+#include "yearprint.h"
+
+#include <libkcal/calendar.h>
+
+#include <kconfig.h>
+#include <kdebug.h>
+#include <kcalendarsystem.h>
+#include <klocale.h>
+
+#include <qcheckbox.h>
+#include <qspinbox.h>
+#include <qcombobox.h>
+#include <qpainter.h>
+
+class YearPrintFactory : public KOrg::PrintPluginFactory {
+  public:
+    KOrg::PrintPlugin *create() { return new CalPrintYear; }
+};
+
+K_EXPORT_COMPONENT_FACTORY( libkorg_yearlyprint, YearPrintFactory )
+
+
+/**************************************************************
+ *           Print Year
+ **************************************************************/
+
+QWidget *CalPrintYear::createConfigWidget( QWidget *w )
+{
+  return new CalPrintYearConfig_Base( w );
+}
+
+void CalPrintYear::readSettingsWidget()
+{
+  CalPrintYearConfig_Base *cfg =
+      dynamic_cast<CalPrintYearConfig_Base*>( mConfigWidget );
+  if ( cfg ) {
+    mYear = cfg->mYear->value();
+    mPages = cfg->mPages->currentText().toInt();
+    mSubDaysEvents = (cfg->mSubDays->currentItem()==0)?Text:TimeBoxes;
+    mHolidaysEvents = (cfg->mHolidays->currentItem()==0)?Text:TimeBoxes;
+  }
+}
+
+void CalPrintYear::setSettingsWidget()
+{
+  CalPrintYearConfig_Base *cfg =
+      dynamic_cast<CalPrintYearConfig_Base*>( mConfigWidget );
+  if ( cfg ) {
+    const KCalendarSystem *calsys = calendarSystem();
+    QDate start;
+    calsys->setYMD( start, mYear, 1, 1 );
+    int months = calsys->monthsInYear( start );
+    int pages=0, prevPages=0;
+    for ( int i=1; i<= months; ++i ) {
+      pages = (months-1)/i + 1;
+      if ( pages != prevPages ) {
+        prevPages = pages;
+        cfg->mPages->insertItem( QString::number( pages ), 0 );
+      }
+    }
+
+    cfg->mYear->setValue( mYear );
+    cfg->mPages->setCurrentText( QString::number( mPages ) );
+
+    cfg->mSubDays->setCurrentItem( (mSubDaysEvents==Text)?0:1 );
+    cfg->mHolidays->setCurrentItem( (mHolidaysEvents==Text)?0:1 );
+  }
+}
+
+void CalPrintYear::loadConfig()
+{
+  if ( mConfig ) {
+    mYear = mConfig->readNumEntry( "Year", 2007 );
+    mPages = mConfig->readNumEntry( "Pages", 1 );
+    mSubDaysEvents = mConfig->readNumEntry( "ShowSubDayEventsAs", TimeBoxes );
+    mHolidaysEvents = mConfig->readNumEntry( "ShowHolidaysAs", Text );
+  }
+  setSettingsWidget();
+}
+
+void CalPrintYear::saveConfig()
+{
+  kdDebug(5850) << "CalPrintYear::saveConfig()" << endl;
+
+  readSettingsWidget();
+  if ( mConfig ) {
+    mConfig->writeEntry( "Year", mYear );
+    mConfig->writeEntry( "Pages", mPages );
+    mConfig->writeEntry( "Pages", mPages );
+    mConfig->writeEntry( "ShowSubDayEventsAs", mSubDaysEvents );
+    mConfig->writeEntry( "ShowHolidaysAs", mHolidaysEvents );
+  }
+}
+
+KPrinter::Orientation CalPrintYear::defaultOrientation()
+{
+  return ( mPages == 1 )?(KPrinter::Landscape):(KPrinter::Portrait);
+}
+
+
+void CalPrintYear::setDateRange( const QDate& from, const QDate& to )
+{
+  CalPrintPluginBase::setDateRange( from, to );
+  CalPrintYearConfig_Base *cfg =
+      dynamic_cast<CalPrintYearConfig_Base*>( mConfigWidget );
+  if ( cfg ) {
+    cfg->mYear->setValue( from.year() );
+  }
+}
+
+void CalPrintYear::print( QPainter &p, int width, int height )
+{
+kdDebug()<<"CalPrintYear::print, width: "<<width<<", height: "<<height<<endl;
+  QRect headerBox( 0, 0, width, headerHeight() );
+kdDebug()<<"headerBox: "<<headerBox<<endl;
+  const KCalendarSystem *calsys = calendarSystem();
+  KLocale *locale = KGlobal::locale();
+  if ( !calsys || !locale ) return;
+
+  QDate start;
+  calsys->setYMD( start, mYear, 1, 1 );
+
+  // Determine the nr of months and the max nr of days per month (dependent on
+  // calendar system!!!!)
+  QDate temp( start );
+  int months = calsys->monthsInYear( start );
+  int maxdays = 1;
+  for ( int i = 1; i< months; ++i ) {
+    maxdays = QMAX( maxdays, temp.daysInMonth() );
+    temp = calsys->addMonths( temp, 1 );
+  }
+
+  // Now determine the months per page so that the printout fits on
+  // exactly mPages pages
+  int monthsPerPage = (months-1) / mPages + 1;
+  int pages = (months-1) / monthsPerPage + 1;
+  int thismonth = 0;
+  temp = start;
+  for ( int page = 0; page < pages; ++page ) {
+    if ( page > 0 ) {
+      mPrinter->newPage();
+    }
+    QDate end( calsys->addMonths( start, monthsPerPage ) );
+    end = calsys->addDays( end, -1 );
+    QString title;
+    if ( orientation() == KPrinter::Landscape ) {
+      title = i18n("date from - to", "%1 - %2");
+    } else {
+      title = i18n("date from -\nto", "%1 -\n%2");
+    }
+    drawHeader( p, title
+        .arg( locale->formatDate( start ) )
+        .arg( locale->formatDate( end ) ),
+      calsys->addMonths( start, -1), calsys->addMonths( start, monthsPerPage ),
+      headerBox );
+
+    QRect monthesBox( headerBox );
+    monthesBox.setTop( monthesBox.bottom() + padding() );
+    monthesBox.setBottom( height );
+
+    drawBox( p, BOX_BORDER_WIDTH, monthesBox );
+    float monthwidth = float(monthesBox.width()) / float( monthsPerPage );
+
+    for ( int j=0; j<monthsPerPage; ++j ) {
+      if ( ++thismonth > months ) break;
+      int xstart = int(j*monthwidth + 0.5);
+      int xend = int((j+1)*monthwidth + 0.5);
+      QRect monthBox( xstart, monthesBox.top(), xend-xstart, monthesBox.height() );
+      drawMonth( p, temp, monthBox, maxdays, mSubDaysEvents, mHolidaysEvents );
+
+      temp = calsys->addMonths( temp, 1 );
+    }
+    start = calsys->addMonths( start, monthsPerPage );
+  }
+}
+
+#endif

Zmiany atrybutów dla: korganizer/plugins/printing/year
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile.in


Index: korganizer/plugins/printing/whatsnext/whatsnextprint.cpp
===================================================================
--- korganizer/plugins/printing/whatsnext/whatsnextprint.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/whatsnext/whatsnextprint.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,7 +27,6 @@
 #include "whatsnextprint.h"
 
 #include "calprintpluginbase.h"
-#include "calprinthelper.h"
 #include <libkcal/event.h>
 #include <libkcal/todo.h>
 #include <libkcal/calendar.h>
Index: korganizer/plugins/printing/whatsnext/whatsnextprint.h
===================================================================
--- korganizer/plugins/printing/whatsnext/whatsnextprint.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/whatsnext/whatsnextprint.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,6 +41,7 @@
     virtual ~CalPrintWhatsNext() {}
     virtual QString description() { return i18n("Print What's Next"); }
     virtual QString info() { return i18n("Prints a list of all upcoming events and todos."); }
+    virtual int sortID() { return 50; }
     virtual QWidget *createConfigWidget( QWidget* );
 
   public:
Index: korganizer/plugins/printing/whatsnext/whatsnextprint.desktop
===================================================================
--- korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fa]=سبک چاپ بعدی چیست
 Name[fi]=Mitä seuraavaksi -tulostustyyli
 Name[fr]=Impression de la suite du programme
+Name[gl]=Imprimir en Estilo Qué Vén Agora
 Name[hu]=A közeljövő eseményeinek kinyomtatása
 Name[is]=Hvað er næst prentstíll
 Name[it]=Stile di stampa "cosa viene dopo"
@@ -27,7 +28,7 @@
 Name[pl]=Styl drukowania "Do dalej"
 Name[pt]=Estilo de Impressão "O Que Se Segue"
 Name[pt_BR]=Estilo de impressão "A Seguir"
-Name[ru]=Стиль печати дайджеста "Что дальше?"
+Name[ru]=Даджест
 Name[sk]=Štýl tlače Čo nasleduje
 Name[sl]=Slog tiskanja v obliki »Kaj je naslednje«
 Name[sr]=Стил штампе „Шта је следеће“
@@ -51,6 +52,7 @@
 Comment[fa]=این وصله به شما اجازه می‌دهد که فهرستی از همۀ رویدادها و کارهای انجامی که بالا می‌آیند را چاپ کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa tulevien tapahtumien ja tehtävien tulostuksen listana.
 Comment[fr]=Ce module vous permet d'imprimer la liste des prochaines évènements et des prochaines tâches.
+Comment[gl]=Este engadido permítelle imprimir unha lista de todos os eventos e tarefas por vir.
 Comment[hu]=Ezzel a modullal kinyomtathatók a rövidesen aktuálissá váló feladatok és események.
 Comment[is]=Þetta íforrit gerir þér kleyft að prenta út lista yfir alla væntanlega atburði og verkþætti.
 Comment[it]=Questo plugin vi permette di stampare una lista dei prossimi eventi e cose da fare.
Index: korganizer/plugins/printing/Makefile.am
===================================================================
--- korganizer/plugins/printing/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -1 +1 @@
-SUBDIRS = journal
+SUBDIRS = journal year
Index: korganizer/plugins/printing/journal/journalprint.desktop
===================================================================
--- korganizer/plugins/printing/journal/journalprint.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/journal/journalprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fa]=سبک چاپ نشریه
 Name[fi]=Päiväkirjan tulostustyyli
 Name[fr]=Impression en journal
+Name[gl]=Imprimir en Estilo Xornal
 Name[hu]=Naplónyomtatási stílus
 Name[is]=Dagbókarprentstíll
 Name[it]=Stile di stampa a diario
@@ -27,7 +28,7 @@
 Name[pl]=Styl drukowania dziennika
 Name[pt]=Estilo de Impressão em Diário
 Name[pt_BR]=Estilo de Impressão de Diário
-Name[ru]=Стиль печати журнала
+Name[ru]=Журнал
 Name[sk]=Štýl tlače žurnálu
 Name[sl]=Dnevniški slog tiskanja
 Name[sr]=Дневнички стил штампе
@@ -51,6 +52,7 @@
 Comment[fa]=این وصله، به شما اجازه می‌دهد که مدخلهای نشریه )مدخلهای روزانه( را چاپ کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa päiväkirjan tulostuksen.
 Comment[fr]=Ce module vous permet d'imprimer l'ensemble de vos journaux personnels
+Comment[gl]=Este engadido permítelle imprimir as entradas do xornal (entradas do diario).
 Comment[hu]=Ez a modul naplóbejegyzések kinyomtatását teszi lehetővé.
 Comment[is]=Þetta íforrit gerir þér kleyft að prenta út dagbókarfærslur.
 Comment[it]=Questo plugin ti permette di stampare le registrazioni del diario.
Index: korganizer/plugins/printing/journal/journalprint.cpp
===================================================================
--- korganizer/plugins/printing/journal/journalprint.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/journal/journalprint.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,11 +27,10 @@
 #include "journalprint.h"
 
 #include "calprintpluginbase.h"
-#include "calprinthelper.h"
 #include <libkcal/journal.h>
 #include <libkcal/calendar.h>
 #include <libkdepim/kdateedit.h>
-#include <kconfig.h> 
+#include <kconfig.h>
 #include <kdebug.h>
 
 #include <qbuttongroup.h>
@@ -74,7 +73,7 @@
   if ( cfg ) {
     cfg->mFromDate->setDate( mFromDate );
     cfg->mToDate->setDate( mToDate );
-    
+
     cfg->mDateRangeGroup->setButton( (mUseDateRange)?1:0 );
   }
 }
@@ -123,13 +122,13 @@
       }
     }
   }
-  
-  mHelper->drawHeader( p, i18n("Journal entries"), QDate(), QDate(), 0, 0, width, mHelper->mHeaderHeight/2 );
-  y = mHelper->mHeaderHeight/2 + 15;
 
+  drawHeader( p, i18n("Journal entries"), QDate(), QDate(), QRect( 0, 0, width, headerHeight() ) );
+  y = headerHeight() + 15;
+
   Journal::List::Iterator it = journals.begin();
   for ( ; it != journals.end(); ++it ) {
-    mHelper->drawJournal( *it, p, x, y, width, height );
+    drawJournal( *it, p, x, y, width, height );
   }
 }
 
Index: korganizer/plugins/printing/journal/journalprint.h
===================================================================
--- korganizer/plugins/printing/journal/journalprint.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/journal/journalprint.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -33,14 +33,17 @@
 }
 
 using namespace KCal;
+using namespace KOrg;
 
 class CalPrintJournal : public CalPrintPluginBase
 {
   public:
     CalPrintJournal():CalPrintPluginBase() {}
     virtual ~CalPrintJournal() {}
-    virtual QString description() { return i18n("Print journal"); }
+    virtual QString description() { return i18n("Print &journal"); }
     virtual QString info() { return i18n("Prints all journals for a given date range"); }
+    virtual int sortID() { return CalPrinterBase::Journallist; }
+    virtual bool enabled() { return true; }
     virtual QWidget *createConfigWidget( QWidget* );
 
   public:
Index: korganizer/plugins/printing/list/listprint.desktop
===================================================================
--- korganizer/plugins/printing/list/listprint.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/list/listprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fa]=سبک چاپ فهرست
 Name[fi]=Listatulostustyyli
 Name[fr]=Impression en liste
+Name[gl]=Imprimir en Estilo de Lista
 Name[hu]=Eseménylista kinyomtatása
 Name[is]=Listaprentstíll
 Name[it]=Stile di stampa ad elenco
@@ -27,7 +28,7 @@
 Name[pl]=Styl drukowania listy
 Name[pt]=Estilo de Impressão em Lista
 Name[pt_BR]=Estilo de Impressão em Lista
-Name[ru]=Стиль печати списка
+Name[ru]=Список
 Name[sk]=Štýl tlače zoznamu
 Name[sl]=Slog tiskanja v obliki list
 Name[sr]=Листајући стил штампе
@@ -48,9 +49,10 @@
 Comment[es]=Esta extensión le permite imprimir eventos y tareas pendientes en forma de lista.
 Comment[et]=See plugin võimaldab trükkida sündmusi ja ülesandeid nimekirjana.
 Comment[eu]=Plugin honek gertaerak eta egitekoak zerrenda moduan inprimatzeko aukera ematen dizu.
-Comment[fa]=این وصله به شما اجازه می‌دهد که رویدادها و کارهایی که باید انجام شوند را در برگۀ فهرست چاپ کنید.
+Comment[fa]=این وصله به شما اجازه می‌دهد که رویدادها و کارهای انجامی را در برگۀ فهرست چاپ کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa tapahtumien ja tehtävien tulostuksen listana.
 Comment[fr]=Ce module vous permet d'imprimer les évènements et les tâches sous forme de liste
+Comment[gl]=Este plugin permítelle imprimir os eventos e as tarefas e forma de lista.
 Comment[hu]=Ezzel a modullal listaként kinyomtathatók a feladatok és események.
 Comment[is]=Þetta íforrit gerir þér kleyft að prenta út lista með atburðum og verkþáttum.
 Comment[it]=Questo plugin ti permette di stampare eventi e cose da fare in modalità elenco.
Index: korganizer/plugins/printing/list/listprint.cpp
===================================================================
--- korganizer/plugins/printing/list/listprint.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/list/listprint.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -27,7 +27,6 @@
 #include "listprint.h"
 
 #include "calprintpluginbase.h"
-#include "calprinthelper.h"
 #include <libkcal/event.h>
 #include <libkcal/todo.h>
 #include <libkcal/calendar.h>
Index: korganizer/plugins/printing/list/listprint.h
===================================================================
--- korganizer/plugins/printing/list/listprint.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/printing/list/listprint.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -41,6 +41,7 @@
     virtual ~CalPrintList() {}
     virtual QString description() { return i18n("Print list"); }
     virtual QString info() { return i18n("Prints a list of events and to-dos"); }
+    virtual int sortID() { return 950; }
     virtual QWidget *createConfigWidget( QWidget* );
 
   public:
Index: korganizer/plugins/timespanview/timespanview.desktop
===================================================================
--- korganizer/plugins/timespanview/timespanview.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/timespanview/timespanview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,6 +13,7 @@
 Name[fa]=وصلۀ نمای گسترۀ زمان برای KOrganizer
 Name[fi]=Ajankulkunäkymäliitännäinen Korganizeriin
 Name[fr]=Module d'affichage de planification pour KOrganizer
+Name[gl]=Extensión de Vista en Unidades de Tempo para KOrganizer
 Name[hu]=Időszakáttekintő bővítőmodul a KOrganizerhez
 Name[is]=Tímabilsskoðunar íforrit fyrir KOrganizer
 Name[it]=Plugin vista intervalli temporali per KOrganizer
@@ -48,9 +49,10 @@
 Comment[es]=Esta extensión proporciona una vista de timespan para korganizer (como la vista de tareas pendientes o la mensual). Si activa esta extensión, puede pasar a la vista de timespan y ver sus eventos como un diagrama de Gantt.
 Comment[et]=See plugin lisab KOrganizerile perioodivaate (nagu ülesannete või kuuvaade). Selle lubamisel saab lülituda perioodivaatele ning näha oma sündmusi Gantti diagrammina.
 Comment[eu]=Plugin honek KOrganizer-entzat denbora barruti ikuspegi bat eskeintzen du. Plugin hau gaitzen baduzu denbora-barruti ikuspegira alda zaitezke gertaerak Gantt diagrama batean bezala ikusi.
-Comment[fa]=این وصله، برای KOrganizer یک نمای گسترۀ زمان )مثل نماهای کارهای انجامی یا ماهانه( فراهم می‌‌کند. اگر این وصله را فعال کنید، می‌توانید به گسترۀ زمان سودهی کرده و مانند یک نمودار  Gantt، رویدادهای خود را مشاهده کنید.
+Comment[fa]=این وصله، برای KOrganizer یک نمای گسترۀ زمان )مثل نماهای کارهای انجامی یا ماهانه( فراهم می‌‌کند. اگر این وصله را فعال کنید، می‌توانید به گسترۀ زمان سودهی کرده و مانند نمودار  Gantt، رویدادهای خود را مشاهده کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa ajankulkunäkymän KOrganizeriin (kuten tehtävälista- tai kuukausinäkymän). Jos kytket tämän päälle, voit vaihtaa ajankulkunäkymään ja katsoa tapahtumia kuten Gantt-diagrammissa.
 Comment[fr]=Ce module vous permet d'avoir une vue de KOrganizer qui affiche les évènements selon l'axe temporel. Si vous activez cette vue, vous verrez vos évènements comme un diagramme de Gantt.
+Comment[gl]=Esta extensión fornece unha vista en unidades de tempo (como as vistas mensuais e a vista de tarefas). Se habilita esta extensión, pode trocar a vista en unidades de tempo e ver os seus eventos como un diagrama Gantt.
 Comment[hu]=Ezzel modullal egy időszakot lehet áttekinteni a KOrganizerben (például a feladatokat vagy a havi nézeteket). Ha aktiválja ezt a modult, átválthat időszakos nézetbe, hogy az események Gantt-diagramon legyenek megtekinthetők.
 Comment[is]=Þetta íforrit veitir tímabilssýn fyrir KOrganizer (svipað og verkþátta eða mánaðarsýn). Ef þú virkjar þetta íforrit getur þú skipt yfir í tímabilssýn og skoðað atburðina þína eins og á Gantt skýringarmynd.
 Comment[it]=Questo plugin fornisce una vista a intervalli temporali. Se abiliti questo plugin, potrai passare alla vista a intervalli temporali e vedere i tuoi eventi come in un diagramma di Gantt.
Index: korganizer/plugins/hebrew/hebrew.desktop
===================================================================
--- korganizer/plugins/hebrew/hebrew.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/plugins/hebrew/hebrew.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -56,6 +56,7 @@
 Comment[fa]=همۀ تاریخهای korganizer، همچنین سیستم تقویم یهودی را نمایش می‌دهد.
 Comment[fi]=Näyttää kaikki päivät KOrganizerissa myös Juutalaisen kalenterijärjestelmän mukaan.
 Comment[fr]=Affiche toutes les dates de KOrganizer selon le calendrier Juif
+Comment[gl]=Amosa todas as datas en korganizer, tamén o sistema de calendario xudeu.
 Comment[he]=מציג את כל התאריכים בארגונית גם בלוח השנה העברי
 Comment[hu]=A KOrganizer dátumait kiírja a hagyományos zsidó naptár szerint is.
 Comment[is]=Sýna alla dagsetningar í KOrganizer sem eru einnig í dagatali gyðinga.
Index: korganizer/korganizer.kcfg
===================================================================
--- korganizer/korganizer.kcfg	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -74,7 +74,7 @@
 
     <entry type="Bool" key="Html With Save">
       <label>Export to HTML with every save</label>
-      <whatsthis>Check this box to export the calendar to a HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
+      <whatsthis>Check this box to export the calendar to an HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
       <default>false</default>
     </entry>
     <entry type="Enum" key="Destination" name="Destination">
@@ -158,7 +158,7 @@
   <group name="Views">
     <entry type="Int" key="Hour Size">
       <label>Hour size</label>
-      <whatsthis>Select on this spin box the the height of the hour rows in the schedule view.</whatsthis>
+      <whatsthis>Select on this spin box the height of the hour rows in the schedule view.</whatsthis>
       <default>10</default>
       <min>4</min>
       <max>30</max>
@@ -272,7 +272,7 @@
 
     <entry type="Int" key="Next X Days">
       <label>Next x days</label>
-      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
+      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
       <default>3</default>
     </entry>
 
@@ -315,7 +315,7 @@
     </entry>
     <entry type="Bool" key="Use Groupware Communication">
       <label>Use Groupware communication</label>
-      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
+      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
       <default>true</default>
     </entry>
 
Index: korganizer/aboutdata.h
===================================================================
--- korganizer/aboutdata.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/aboutdata.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -33,11 +33,6 @@
 {
   public:
     AboutData();
-    
-    static AboutData *self();
-    
-  private:
-    static AboutData *mSelf;
 };
 
 }
Index: korganizer/kotodoeditor.h
===================================================================
--- korganizer/kotodoeditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kotodoeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -49,30 +49,21 @@
     void reload();
 
     /**
-      Clear editor for new todo, and preset the dates and times with hint.
+      Edit new todo. Use the set* methods to set appropriate default values if needed
     */
-    void newTodo( const QDateTime &due, Todo *relatedTodo=0, bool allDay=false);
+    void newTodo();
 
     /**
-      Edit new todo. Set summary and description from given text.
+      Sets the given summary and description. If description is empty and the 
+      summary contains multiple lines, the summary will be used as description 
+      and only the first line of summary will be used as the summary.
     */
-    void newTodo( const QString & );
-    /**
-      Edit new todo.
-    */
-    void newTodo( const QString &summary, const QString &description,
-                  const QString &attachment );
-    /**
-      Edit new todo.
-    */
-    void newTodo( const QString &summary, const QString &description,
-                  const QString &attachment, const QStringList &attendees );
-
+    void setTexts( const QString &summary, const QString &description = QString::null );
     /** Edit an existing todo. */
     void editIncidence(Incidence *);
 
     /** Set widgets to default values */
-    void setDefaults( const QDateTime &due, Todo *relatedTodo, bool allDay );
+    void setDates( const QDateTime &due, bool allDay = true, Todo *relatedTodo = 0 );
     /** Read event object and setup widgets accordingly */
     void readTodo(Todo *);
     /** Write event settings to event object */
@@ -95,7 +86,7 @@
   protected:
     void loadTemplate( /*const*/ CalendarLocal& );
     QStringList& templates() const;
-    QString type() { return "ToDo"; }
+    QString type() { return "Todo"; }
     void setupGeneral();
     void setupRecurrence();
     int msgItemDelete();
Index: korganizer/kojournaleditor.h
===================================================================
--- korganizer/kojournaleditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kojournaleditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -58,27 +58,21 @@
     void reload();
 
     /**
-      Clear editor for new Journal, and preset the dates and times with hint.
+      Clear editor for new Journal
     */
-    void newJournal( const QDate &date );
-    void newJournal( const QString &text, const QDate &date );
+    void newJournal();
 
     /**
-      Edit new Journal. Set summary and description from given text.
+      Sets the given summary and description. If description is empty and the 
+      summary contains multiple lines, the summary will be used as description 
+      and only the first line of summary will be used as the summary.
     */
-    void newJournal( const QString &text );
-    /**
-      Edit new Journal.
-    */
-    //TODO:
-    // void newJournal( const QString &summary, const QString &description,
-    //               const QString &attachment );
-
+    void setTexts( const QString &summary, const QString &description = QString::null );
     /** Edit an existing Journal. */
     void editIncidence(Incidence *);
 
     /** Set widgets to default values */
-    void setDefaults( const QDate &date );
+    void setDate( const QDate &date );
     /** Read event object and setup widgets accordingly */
     void readJournal( Journal * );
     /** Write event settings to event object */
Index: korganizer/version.h
===================================================================
--- korganizer/version.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/version.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -53,6 +53,6 @@
     3.2 alpha1
 */
 
-static const char korgVersion[] = "3.5.5";
+static const char korgVersion[] = "3.5.6";
 
 #endif
Index: korganizer/journalentry.cpp
===================================================================
--- korganizer/journalentry.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/journalentry.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -52,6 +52,10 @@
 
 #include "journalentry.h"
 #include "journalentry.moc"
+#ifndef KORG_NOPRINTER
+#include "kocorehelper.h"
+#include "calprinter.h"
+#endif
 
 class JournalTitleLable : public KActiveLabel
 {
@@ -223,9 +227,18 @@
   mLayout->addWidget( mEditButton, 0, 5 );
   connect( mEditButton, SIGNAL(clicked()), this, SLOT( editItem() ) );
 
-
+#ifndef KORG_NOPRINTER
+  mPrintButton = new QToolButton( this, "printButton" );
+  mPrintButton->setPixmap( KOGlobals::self()->smallIcon( "printer1" ) );
+  mPrintButton->setSizePolicy( QSizePolicy::Fixed, QSizePolicy::Fixed );
+  //FIXME: uncomment the next two lines after the string freeze is lifted
+//  QToolTip::add( mPrintButton, i18n("Print this journal entry") );
+//  QWhatsThis::add( mPrintButton, i18n("Opens the print dialog for this journal entry") );
+  mLayout->addWidget( mPrintButton, 0, 6 );
+  connect( mPrintButton, SIGNAL(clicked()), this, SLOT( printItem() ) );
+#endif
   mEditor = new KTextEdit(this);
-  mLayout->addMultiCellWidget( mEditor, 1, 2, 0, 5 );
+  mLayout->addMultiCellWidget( mEditor, 1, 2, 0, 6 );
 
   connect( mTitleEdit, SIGNAL(textChanged( const QString& )), SLOT(setDirty()) );
   connect( mTimeCheck, SIGNAL(toggled(bool)), SLOT(setDirty()) );
@@ -263,6 +276,25 @@
     emit editIncidence( mJournal );
 }
 
+void JournalEntry::printItem()
+{
+#ifndef KORG_NOPRINTER
+  writeJournal();
+  if ( mJournal ) {
+    Calendar *cal;
+    KOCoreHelper helper;
+    CalPrinter printer( this, cal, &helper );
+    connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
+
+    Incidence::List selectedIncidences;
+    selectedIncidences.append( mJournal );
+
+    printer.print( KOrg::CalPrinterBase::Incidence,
+                 QDate(), QDate(), selectedIncidences );
+  }
+#endif
+}
+
 void JournalEntry::setReadOnly( bool readonly )
 {
   mReadOnly = readonly;
Index: korganizer/korganizer_configfreebusy.desktop
===================================================================
--- korganizer/korganizer_configfreebusy.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configfreebusy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -111,7 +111,7 @@
 Keywords[es]=korganizer,libreocupado,planificación
 Keywords[et]=korganizer,vaba,hõivatud,ajakava
 Keywords[eu]=korganizer,libre, lanpetuta,antolaketa
-Keywords[fa]=korganizer،آزاد اشغال،زمان‌بندی
+Keywords[fa]=korganizer،آزاد اشغال، زمان‌بندی
 Keywords[fi]=korganizer,vapaa,varattu,ajastus
 Keywords[fr]=KOrganizer,disponibilité, planification
 Keywords[gl]=korganizer,dispoñibilidade,axenda

Zmiany atrybutów dla: korganizer/pixmaps
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: korganizer/korganizer_part.cpp
===================================================================
--- korganizer/korganizer_part.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_part.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -43,7 +43,6 @@
 #include <kpopupmenu.h>
 #include <kinstance.h>
 #include <klocale.h>
-#include <kaboutdata.h>
 #include <kiconloader.h>
 #include <kaction.h>
 #include <kdebug.h>
@@ -140,7 +139,7 @@
 
 KAboutData *KOrganizerPart::createAboutData()
 {
-  return KOrg::AboutData::self();
+  return new KOrg::AboutData;
 }
 
 void KOrganizerPart::startCompleted( KProcess *process )
Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -61,7 +61,7 @@
 Comment[zh_CN]=日历和日程安排程序
 Comment[zh_TW]=行事曆與排程軟體
 Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
-Exec=korganizer --import %u
+Exec=korganizer %U
 Icon=korganizer
 Path=
 DocPath=korganizer/index.html
@@ -69,7 +69,6 @@
 Terminal=false
 Name=KOrganizer
 Name[af]=Korganizer
-Name[ar]=منظم كيدي
 Name[be]=K Арганізатар
 Name[cy]=KTrefnydd
 Name[eo]=Organizilo
@@ -83,6 +82,7 @@
 Name[ven]=Mulugisi wa K
 Name[zh_TW]=KOrganizer 行事曆
 GenericName=Personal Organizer
+GenericName[ar]=المنظم الشخصي
 GenericName[be]=Пэрсанальны арганізатар
 GenericName[bg]=Организатор
 GenericName[bs]=Lični organizer
@@ -96,7 +96,7 @@
 GenericName[es]=Organizador personal
 GenericName[et]=Personaalne ajaarvestus
 GenericName[eu]=Antolatzaile pertsonala
-GenericName[fa]=سازمان‌دهندۀ شخصی‌
+GenericName[fa]=سازمان‌دهندۀ شخصی
 GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
 GenericName[fr]=Organiseur personnel
 GenericName[gl]=Organizador Persoal
Index: korganizer/calendarview.cpp
===================================================================
--- korganizer/calendarview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/calendarview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -125,8 +125,6 @@
   mReadOnly = false;
   mSelectedIncidence = 0;
 
-  mCalPrinter = 0;
-
   mFilters.setAutoDelete( true );
 
   mExtensions.setAutoDelete( true );
@@ -370,17 +368,6 @@
 }
 
 
-void CalendarView::createPrinter()
-{
-#ifndef KORG_NOPRINTER
-  if (!mCalPrinter) {
-    mCalPrinter = new CalPrinter( this, mCalendar, new KOCoreHelper() );
-    connect(this, SIGNAL(configChanged()), mCalPrinter, SLOT(updateConfig()));
-  }
-#endif
-}
-
-
 bool CalendarView::openCalendar(const QString& filename, bool merge)
 {
   kdDebug(5850) << "CalendarView::openCalendar(): " << filename << endl;
@@ -694,27 +681,29 @@
   }
   setModified( true );
   history()->recordEdit( oldIncidence, newIncidence );
-  
+
   // Record completed todos in journals, if enabled. we should to this here in
   // favour of the todolist. users can mark a task as completed in an editor
   // as well.
   if ( newIncidence->type() == "Todo"
     && KOPrefs::instance()->recordTodosInJournals()
-    && what == KOGlobals::COMPLETION_MODIFIED ) {
+    &&  ( what == KOGlobals::COMPLETION_MODIFIED
+    || what == KOGlobals::COMPLETION_MODIFIED_WITH_RECURRENCE ) ) {
 
       Todo *todo = static_cast<Todo *>(newIncidence);
-      if ( todo->isCompleted() ) {
+      if ( todo->isCompleted()
+      || what == KOGlobals::COMPLETION_MODIFIED_WITH_RECURRENCE ) {
         QString timeStr = KGlobal::locale()->formatTime( QTime::currentTime() );
         QString description = i18n( "To-do completed: %1 (%2)" ).arg(
           newIncidence->summary() ).arg( timeStr );
 
         Journal::List journals = calendar()->journals( QDate::currentDate() );
         Journal *journal;
-        
+
         if ( journals.isEmpty() ) {
           journal = new Journal();
           journal->setDtStart( QDateTime::currentDateTime() );
-          
+
           QString dateStr = KGlobal::locale()->formatDate( QDate::currentDate() );
           journal->setSummary( i18n("Journal of %1").arg( dateStr ) );
           journal->setDescription( description );
@@ -738,7 +727,7 @@
         }
       }
   }
-  
+
   changeIncidenceDisplay( newIncidence, KOGlobals::INCIDENCEEDITED );
   updateUnmanagedViews();
   checkForFilteredChange( newIncidence );
@@ -919,106 +908,92 @@
   mDialogManager->showOptionsDialog();
 }
 
-
-void CalendarView::newEvent()
+void CalendarView::dateTimesForNewEvent( QDateTime &startDt, QDateTime &endDt, bool &allDay )
 {
-  kdDebug(5850) << "CalendarView::newEvent()" << endl;
-  QDate date = mNavigator->selectedDates().first();
-  QTime startTime = KOPrefs::instance()->mStartTime.time();
-  QDateTime startDt( date, startTime );
-  int addSecs = ( KOPrefs::instance()->mDefaultDuration.time().hour()*3600 ) +
-                ( KOPrefs::instance()->mDefaultDuration.time().minute()*60 );
-  QDateTime endDt = ( startDt.addSecs( addSecs ) );
-  bool allDay = false;
-
-  // let the current view change the default start/end datetime
-  mViewManager->currentView()->eventDurationHint( startDt, endDt, allDay );
-
-  if ( allDay ) {
-    newEvent( startDt, endDt, true );
-  } else {
-    newEvent( startDt, endDt );
+  if ( !startDt.isValid() ) {
+    // Default start is the first selected date with the preferred time as set 
+    // in the config dlg.
+    if ( !startDt.date().isValid() ) {
+      startDt.setDate( mNavigator->selectedDates().first() );
+    }
+    if ( !startDt.time().isValid() ) {
+      startDt.setTime( KOPrefs::instance()->mStartTime.time() );
+    }
   }
+  if ( !endDt.isValid() ) {
+    int addSecs = ( KOPrefs::instance()->mDefaultDuration.time().hour()*3600 ) +
+                  ( KOPrefs::instance()->mDefaultDuration.time().minute()*60 );
+    endDt = startDt.addSecs( addSecs );
+  }
+  mViewManager->currentView()->eventDurationHint( startDt, endDt, allDay );
 }
 
-void CalendarView::newEvent( const QDateTime &fh )
+KOEventEditor *CalendarView::newEventEditor( const QDateTime &startDtParam, 
+     const QDateTime &endDtParam, bool allDayParam)
 {
-  int addSecs = ( KOPrefs::instance()->mDefaultDuration.time().hour()*3600 ) +
-                ( KOPrefs::instance()->mDefaultDuration.time().minute()*60 );
-  QDateTime endTime ( fh.addSecs( addSecs ) );
-  newEvent( fh, endTime );
-}
+  // let the current view change the default start/end datetime
+  bool allDay = allDayParam;
+  QDateTime startDt( startDtParam ), endDt( endDtParam );
+  // Adjust the start/end date times (i.e. replace invalid values by defaults, 
+  // and let the view adjust the type.
+  dateTimesForNewEvent( startDt, endDt, allDay );
 
-void CalendarView::newEvent( const QDate &dt )
-{
-  QTime startTime = KOPrefs::instance()->mStartTime.time();
-  int addSecs = ( KOPrefs::instance()->mDefaultDuration.time().hour()*3600 ) +
-                ( KOPrefs::instance()->mDefaultDuration.time().minute()*60 );
-  QTime endTime ( startTime.addSecs( addSecs ) );
-  newEvent(QDateTime(dt, startTime),
-           QDateTime(dt, endTime), true);
-}
-
-void CalendarView::newEvent( const QString &text )
-{
   KOEventEditor *eventEditor = mDialogManager->getEventEditor();
+  eventEditor->newEvent();
   connectIncidenceEditor( eventEditor );
-  eventEditor->newEvent( text );
+  eventEditor->setDates( startDt, endDt, allDay );
   mDialogManager->connectTypeAhead( eventEditor, viewManager()->agendaView() );
-  eventEditor->show();
+  return eventEditor;
 }
 
-void CalendarView::newEvent( const QString &summary, const QString &description,
-                             const QString &attachment )
+
+
+
+void CalendarView::newEvent()
 {
-  KOEventEditor *eventEditor = mDialogManager->getEventEditor();
-  connectIncidenceEditor( eventEditor );
-  eventEditor->newEvent( summary, description, attachment );
-  eventEditor->show();
+  kdDebug(5850) << "CalendarView::newEvent()" << endl;
+  newEvent( QDateTime(), QDateTime() );
 }
 
-void CalendarView::newEvent( const QString &summary, const QString &description,
-                             const QString &attachment, const QStringList &attendees )
+void CalendarView::newEvent( const QDate &dt )
 {
-  KOEventEditor *eventEditor = mDialogManager->getEventEditor();
-  connectIncidenceEditor( eventEditor );
-  eventEditor->newEvent( summary, description, attachment, attendees );
-  eventEditor->show();
+  QDateTime startDt( dt, KOPrefs::instance()->mStartTime.time() );
+  return newEvent( QDateTime( dt ), QDateTime() );
 }
 
-void CalendarView::newEvent( const QDateTime &fromHint, const QDateTime &toHint,
-                             bool allDay)
+void CalendarView::newEvent( const QDateTime &startDt )
 {
-  KOEventEditor *eventEditor = mDialogManager->getEventEditor();
-  connectIncidenceEditor( eventEditor );
-  eventEditor->newEvent(fromHint,toHint,allDay);
-  mDialogManager->connectTypeAhead( eventEditor, viewManager()->agendaView() );
-  eventEditor->show();
+  return newEvent( startDt, QDateTime() );
 }
 
-void CalendarView::newTodo( const QString &text )
+void CalendarView::newEvent( const QDateTime &startDt, const QDateTime &endDt,
+                             bool allDay )
 {
-  KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
-  connectIncidenceEditor( todoEditor );
-  todoEditor->newTodo( text );
-  todoEditor->show();
+  KOEventEditor *eventEditor = newEventEditor( startDt, endDt, allDay );
+  eventEditor->show();
 }
 
-void CalendarView::newTodo( const QString &summary, const QString &description,
-                             const QString &attachment )
+void CalendarView::newEvent( const QString &summary, const QString &description,
+                             const QStringList &attachments, const QStringList &attendees )
 {
-  KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
-  connectIncidenceEditor( todoEditor );
-  todoEditor->newTodo( summary, description, attachment );
-  todoEditor->show();
+  KOEventEditor *eventEditor = newEventEditor();
+  eventEditor->setTexts( summary, description );
+  // if attach or attendee list is empty, these methods don't do anything, so
+  // it's save to call them in every case
+  eventEditor->addAttachments( attachments );
+  eventEditor->addAttendees( attendees );
+  eventEditor->show();
 }
 
 void CalendarView::newTodo( const QString &summary, const QString &description,
-                            const QString &attachment, const QStringList &attendees )
+                            const QStringList &attachments, const QStringList &attendees )
 {
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
-  todoEditor->newTodo( summary, description, attachment, attendees );
+  todoEditor->newTodo();
+  todoEditor->setTexts( summary, description );
+  todoEditor->addAttachments( attachments );
+  todoEditor->addAttendees( attendees );
   todoEditor->show();
 }
 
@@ -1029,15 +1004,14 @@
   bool allday = true;
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
+  todoEditor->newTodo();
   if ( mViewManager->currentView()->isEventView() ) {
     dtDue.setDate( mNavigator->selectedDates().first() );
     QDateTime dtDummy = QDateTime::currentDateTime();
     mViewManager->currentView()->
-      eventDurationHint( dtDue , dtDummy , allday );
+      eventDurationHint( dtDue, dtDummy, allday );
+    todoEditor->setDates( dtDue, allday );
   }
-  else
-    dtDue = QDateTime::currentDateTime().addDays( 7 );
-  todoEditor->newTodo(dtDue,0,allday);
   todoEditor->show();
 }
 
@@ -1045,52 +1019,36 @@
 {
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
-  todoEditor->newTodo( QDateTime( date, QTime::currentTime() ), 0, true );
+  todoEditor->newTodo();
+  todoEditor->setDates( QDateTime( date, QTime::currentTime() ), true );
   todoEditor->show();
 }
 
 void CalendarView::newJournal()
 {
   kdDebug(5850) << "CalendarView::newJournal()" << endl;
-  QDate date = mNavigator->selectedDates().first();
-  newJournal( date );
+  newJournal( QString::null, QDate() );
 }
 
-void CalendarView::newJournal( const QDate &date )
+void CalendarView::newJournal( const QDate &date)
 {
-  KOJournalEditor *journalEditor = mDialogManager->getJournalEditor();
-  connectIncidenceEditor( journalEditor );
-  journalEditor->newJournal( date );
-  journalEditor->show();
+  newJournal( QString::null, date );
 }
 
 void CalendarView::newJournal( const QString &text, const QDate &date )
 {
   KOJournalEditor *journalEditor = mDialogManager->getJournalEditor();
   connectIncidenceEditor( journalEditor );
-  journalEditor->newJournal( text, date );
+  journalEditor->newJournal();
+  journalEditor->setTexts( text );
+  if ( !date.isValid() ) {
+    journalEditor->setDate( mNavigator->selectedDates().first() );
+  } else {
+    journalEditor->setDate( date );
+  }
   journalEditor->show();
 }
 
-void CalendarView::newJournal( const QString &text )
-{
-  KOJournalEditor *journalEditor = mDialogManager->getJournalEditor();
-  connectIncidenceEditor( journalEditor );
-  journalEditor->newJournal( text );
-  journalEditor->show();
-}
-
-//TODO:
-// void CalendarView::newJournal( const QString &summary,
-//                                const QString &description,
-//                                const QString &attachment )
-// {
-//   KOJournalEditor *journalEditor = mDialogManager->getJournalEditor();
-//   connectIncidenceEditor( journalEditor );
-//   journalEditor->newJournal( summary, description, attachment );
-//   journalEditor->show();
-// }
-
 void CalendarView::newSubTodo()
 {
   Todo *todo = selectedTodo();
@@ -1101,7 +1059,8 @@
 {
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
-  todoEditor->newTodo(QDateTime::currentDateTime().addDays(7),parentEvent,true);
+  todoEditor->newTodo();
+  todoEditor->setDates( QDateTime(), false, parentEvent );
   todoEditor->show();
 }
 
@@ -1493,16 +1452,21 @@
 void CalendarView::print()
 {
 #ifndef KORG_NOPRINTER
-  createPrinter();
+  KOCoreHelper helper;
+  CalPrinter printer( this, mCalendar, &helper );
+  connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
 
   KOrg::BaseView *currentView = mViewManager->currentView();
 
-  CalPrinter::PrintType printType = CalPrinter::Month;
-
+  CalPrinterBase::PrintType printType = CalPrinterBase::Month;
   if ( currentView ) printType = currentView->printType();
 
   DateList tmpDateList = mNavigator->selectedDates();
-  mCalPrinter->print( printType, tmpDateList.first(), tmpDateList.last() );
+  Incidence::List selectedIncidences;
+  if ( mViewManager->currentView() ) {
+    selectedIncidences = mViewManager->currentView()->selectedIncidences();
+  }
+  printer.print( printType, tmpDateList.first(), tmpDateList.last(), selectedIncidences );
 #endif
 }
 
Index: korganizer/kdatenavigator.h
===================================================================
--- korganizer/kdatenavigator.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kdatenavigator.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -99,16 +99,14 @@
   private:
     NavigatorBar *mNavigatorBar;
 
-    QLabel *headings[ 7 ];
-    QLabel *weeknos[ 7 ];
+    QLabel *mHeadings[ 7 ];
+    QLabel *mWeeknos[ 7 ];
 
     KODayMatrix *mDayMatrix;
 
     KCal::DateList mSelectedDates;
     QDate mBaseDate;
 
-    const QString *curHeaders;
-
     // Disabling copy constructor and assignment operator
     KDateNavigator( const KDateNavigator & );
     KDateNavigator &operator=( const KDateNavigator & );
Index: korganizer/kojournaleditor.cpp
===================================================================
--- korganizer/kojournaleditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kojournaleditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -106,48 +106,31 @@
   }
 }
 
-void KOJournalEditor::newJournal( const QDate &date )
-{
-  init();
 
-  mJournal = 0;
-  setDefaults( date );
-}
-
-void KOJournalEditor::newJournal( const QString &text )
+void KOJournalEditor::newJournal()
 {
   init();
-
   mJournal = 0;
-
   loadDefaults();
+}
 
-  mGeneral->setDescription( text );
-
-  int pos = text.find( "\n" );
-  if ( pos > 0 ) {
-    mGeneral->setSummary( text.left( pos ) );
-    mGeneral->setDescription( text );
+void KOJournalEditor::setTexts( const QString &summary, const QString &description )
+{
+  if ( description.isEmpty() && summary.contains("\n") ) {
+    mGeneral->setDescription( summary );
+    int pos = summary.find( "\n" );
+    mGeneral->setSummary( summary.left( pos ) );
   } else {
-    mGeneral->setSummary( text );
+    mGeneral->setSummary( summary );
+    mGeneral->setDescription( description );
   }
 }
 
-void KOJournalEditor::newJournal( const QString &text, const QDate &date )
-{
-  init();
 
-  mJournal = 0;
 
-  loadDefaults();
-
-  mGeneral->setDescription( text );
-  mGeneral->setDate( date );
-}
-
 void KOJournalEditor::loadDefaults()
 {
-  setDefaults( QDate::currentDate() );
+  setDate( QDate::currentDate() );
 }
 
 bool KOJournalEditor::processInput()
@@ -187,7 +170,7 @@
   reject();
 }
 
-void KOJournalEditor::setDefaults( const QDate &date )
+void KOJournalEditor::setDate( const QDate &date )
 {
   mGeneral->setDefaults( date );
   mDetails->setDefaults();
Index: korganizer/koincidenceeditor.cpp
===================================================================
--- korganizer/koincidenceeditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koincidenceeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -36,8 +36,8 @@
 #include <kmessagebox.h>
 #include <kinputdialog.h>
 #include <kio/netaccess.h>
+#include <kabc/addressee.h>
 
-#include <libkdepim/categoryselectdialog.h>
 #include <libkdepim/designerfields.h>
 #include <libkdepim/embeddedurlpage.h>
 
@@ -73,19 +73,12 @@
     setButtonText( Default, i18n("&Templates...") );
   }
 
-  mCategoryDialog = new KPIM::CategorySelectDialog( KOPrefs::instance(), this );
-  KOGlobals::fitDialogToScreen( mCategoryDialog );
-
-  connect( mCategoryDialog, SIGNAL( editCategories() ),
-           SIGNAL( editCategories() ) );
-
   connect( this, SIGNAL( defaultClicked() ), SLOT( slotManageTemplates() ) );
   connect( this, SIGNAL( finished() ), SLOT( delayedDestruct() ) );
 }
 
 KOIncidenceEditor::~KOIncidenceEditor()
 {
-  delete mCategoryDialog;
 }
 
 void KOIncidenceEditor::setupAttendeesTab()
@@ -129,7 +122,6 @@
 
 void KOIncidenceEditor::updateCategoryConfig()
 {
-  mCategoryDialog->updateCategoryConfig();
 }
 
 void KOIncidenceEditor::slotCancel()
@@ -160,8 +152,6 @@
 {
   kdDebug(5850) << "KOIncidenceEditor::manageTemplates()" << endl;
 
-  QString tp = type();
-
   TemplateManagementDialog * const d = new TemplateManagementDialog( this, templates() );
   connect( d, SIGNAL( loadTemplate( const QString& ) ),
            this, SLOT( slotLoadTemplate( const QString& ) ) );
@@ -378,4 +368,24 @@
   UriHandler::process( uri );
 }
 
+void KOIncidenceEditor::addAttachments( const QStringList &attachments )
+{
+  QStringList::ConstIterator it;
+  for ( it = attachments.begin(); it != attachments.end(); ++it ) {
+    mAttachments->addAttachment( *it );
+  }
+}
+
+void KOIncidenceEditor::addAttendees( const QStringList &attendees )
+{
+  QStringList::ConstIterator it;
+  for ( it = attendees.begin(); it != attendees.end(); ++it ) {
+    QString name, email;
+    KABC::Addressee::parseEmailAddress( *it, name, email );
+    mDetails->insertAttendee( new Attendee( name, email ) );
+  }
+}
+
+
+
 #include "koincidenceeditor.moc"
Index: korganizer/koeventpopupmenu.cpp
===================================================================
--- korganizer/koeventpopupmenu.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koeventpopupmenu.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -32,8 +32,13 @@
 
 #include "koglobals.h"
 
+#include <korganizer/baseview.h>
 #include "koeventpopupmenu.h"
 #include "koeventpopupmenu.moc"
+#include "kocorehelper.h"
+#ifndef KORG_NOPRINTER
+#include "calprinter.h"
+#endif
 
 KOEventPopupMenu::KOEventPopupMenu()
 {
@@ -41,24 +46,37 @@
   mCurrentDate = QDate();
   mHasAdditionalItems = false;
 
-  insertItem (i18n("&Show"),this,SLOT(popupShow()));
-  mEditOnlyItems.append(insertItem (i18n("&Edit..."),this,SLOT(popupEdit())));
-  mEditOnlyItems.append(insertSeparator());
-  mEditOnlyItems.append(insertItem (KOGlobals::self()->smallIcon("editcut"),i18n("&Cut"),
-                                   this,SLOT(popupCut())));
-  mEditOnlyItems.append(insertItem (KOGlobals::self()->smallIcon("editcopy"),i18n("&Copy"),
-                                   this,SLOT(popupCopy())));
-  mEditOnlyItems.append(insertItem (KOGlobals::self()->smallIcon("editdelete"),i18n("&Delete"),
-                                   this,SLOT(popupDelete())));
+  insertItem( i18n("&Show"), this, SLOT( popupShow() ) );
+  mEditOnlyItems.append(
+    insertItem(i18n("&Edit..."), this, SLOT( popupEdit() ) ) );
+#ifndef KORG_NOPRINTER
+  insertItem( KOGlobals::self()->smallIcon("printer1"), i18n("&Print..."),
+              this, SLOT( print() ) );
+#endif
+  //------------------------------------------------------------------------
   mEditOnlyItems.append( insertSeparator() );
-  mEditOnlyItems.append( insertItem( QIconSet( KOGlobals::self()->smallIcon("bell") ),
-                                     i18n("&Toggle Reminder"), this,
-                                     SLOT( popupAlarm() ) ) );
+  mEditOnlyItems.append(
+    insertItem( KOGlobals::self()->smallIcon("editcut"), i18n("&Cut"),
+                this, SLOT( popupCut() ) ) );
+  mEditOnlyItems.append(
+    insertItem( KOGlobals::self()->smallIcon("editcopy"), i18n("&Copy"),
+                this, SLOT( popupCopy() ) ) );
+  mEditOnlyItems.append(
+    insertItem( KOGlobals::self()->smallIcon("editdelete"), i18n("&Delete"),
+                this, SLOT( popupDelete() ) ) );
+  //------------------------------------------------------------------------
+  mEditOnlyItems.append( insertSeparator() );
+  mEditOnlyItems.append(
+    insertItem( KOGlobals::self()->smallIcon("bell"), i18n("&Toggle Reminder"),
+                this, SLOT( popupAlarm() ) ) );
+  //------------------------------------------------------------------------
   mRecurrenceItems.append( insertSeparator() );
-  mRecurrenceItems.append( insertItem( i18n("&Dissociate This Occurrence"),
-                                       this, SLOT( dissociateOccurrence() ) ) );
-  mRecurrenceItems.append( insertItem( i18n("&Dissociate Future Occurrences"),
-                                       this, SLOT( dissociateFutureOccurrence() ) ) );
+  mRecurrenceItems.append(
+    insertItem( i18n("&Dissociate This Occurrence"),
+                this, SLOT( dissociateOccurrence() ) ) );
+  mRecurrenceItems.append(
+    insertItem( i18n("&Dissociate Future Occurrences"),
+                this, SLOT( dissociateFutureOccurrence() ) ) );
 }
 
 void KOEventPopupMenu::showIncidencePopup( Incidence *incidence, const QDate &qd )
@@ -103,6 +121,22 @@
   if (mCurrentIncidence) emit editIncidenceSignal(mCurrentIncidence);
 }
 
+void KOEventPopupMenu::print()
+{
+#ifndef KORG_NOPRINTER
+  Calendar *cal;
+  KOCoreHelper helper;
+  CalPrinter printer( this, cal, &helper );
+  connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
+
+  Incidence::List selectedIncidences;
+  selectedIncidences.append( mCurrentIncidence );
+
+  printer.print( KOrg::CalPrinterBase::Incidence,
+                 mCurrentDate, mCurrentDate, selectedIncidences );
+#endif
+}
+
 void KOEventPopupMenu::popupDelete()
 {
   if (mCurrentIncidence) emit deleteIncidenceSignal(mCurrentIncidence);
Index: korganizer/urihandler.cpp
===================================================================
--- korganizer/urihandler.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/urihandler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -78,8 +78,7 @@
         KaddressBook is not already running.  Pass it the UID of the contact via the command line while starting it - its neater.
         We start it without its main interface
       */
-      KIconLoader *iconLoader = new KIconLoader();
-      QString iconPath = iconLoader->iconPath( "go", KIcon::Small );
+      QString iconPath = KGlobal::iconLoader()->iconPath( "go", KIcon::Small );
       QString tmpStr = "kaddressbook --editor-only --uid ";
       tmpStr += KProcess::quote( uri.mid( 6 ) );
       KRun::runCommand( tmpStr, "KAddressBook", iconPath );
@@ -90,6 +89,6 @@
     new KRun(KURL( uri ));
   }
 #endif
-  
+
   return false;
 }
Index: korganizer/korganizer_configdesignerfields.desktop
===================================================================
--- korganizer/korganizer_configdesignerfields.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configdesignerfields.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -24,7 +24,7 @@
 Name[es]=Páginas personalizadas
 Name[et]=Omaloodud leheküljed
 Name[eu]=Orri pertsonalizatuak
-Name[fa]=صفحات سفارشی‌
+Name[fa]=صفحات سفارشی
 Name[fi]=Omat sivut
 Name[fr]=Pages personnalisées
 Name[ga]=Leathanaigh Shaincheaptha
@@ -115,6 +115,7 @@
 Keywords[fi]=kaddressbook, aseta, asetukset,omat kentät
 Keywords[fr]=KOrganizer, configuration, configurer, champs personnalisés
 Keywords[ga]=korganizer, cumraigh, socruithe, réimsí saincheaptha
+Keywords[gl]=korganizer, configurar, opcións, campos personalizados
 Keywords[he]=korganizer, configure, settings, custom fields, הגדרות, תצורה, שדות, מותאמים אישית
 Keywords[hu]=korganizer,beállítás,beállítások,egyéni mezők
 Keywords[is]=korganizer, stillingar, stilla, sérsniðnir reitir
Index: korganizer/kdatenavigator.cpp
===================================================================
--- korganizer/kdatenavigator.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/kdatenavigator.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -64,21 +64,21 @@
 
   // Set up the heading fields.
   for( i = 0; i < 7; i++ ) {
-    headings[i] = new QLabel( this );
-    headings[i]->setFont( QFont( generalFont, 10, QFont::Bold ) );
-    headings[i]->setAlignment( AlignCenter );
+    mHeadings[i] = new QLabel( this );
+    mHeadings[i]->setFont( QFont( generalFont, 10, QFont::Bold ) );
+    mHeadings[i]->setAlignment( AlignCenter );
 
-    topLayout->addWidget( headings[i], 1, i + 1 );
+    topLayout->addWidget( mHeadings[i], 1, i + 1 );
   }
 
   // Create the weeknumber labels
   for( i = 0; i < 6; i++ ) {
-    weeknos[i] = new QLabel( this );
-    weeknos[i]->setAlignment( AlignCenter );
-    weeknos[i]->setFont( QFont( generalFont, 10 ) );
-    weeknos[i]->installEventFilter( this );
+    mWeeknos[i] = new QLabel( this );
+    mWeeknos[i]->setAlignment( AlignCenter );
+    mWeeknos[i]->setFont( QFont( generalFont, 10 ) );
+    mWeeknos[i]->installEventFilter( this );
 
-    topLayout->addWidget( weeknos[i], i + 2, 0 );
+    topLayout->addWidget( mWeeknos[i], i + 2, 0 );
   }
 
   mDayMatrix = new KODayMatrix( this, "KDateNavigator::dayMatrix" );
@@ -147,15 +147,14 @@
 
   const KCalendarSystem *calsys = KOGlobals::self()->calendarSystem();
   int m_fstDayOfWkCalsys = calsys->dayOfWeek( dayone );
+  int weekstart = KGlobal::locale()->weekStartDay();
 
   // If month begins on Monday and Monday is first day of week,
   // month should begin on second line. Sunday doesn't have this problem.
-  int nextLine = ( ( m_fstDayOfWkCalsys == 1) &&
-                   ( KGlobal::locale()->weekStartDay() == 1 ) ) ? 7 : 0;
+  int nextLine = m_fstDayOfWkCalsys <= weekstart ? 7 : 0;
 
   // update the matrix dates
-  int index = ( KGlobal::locale()->weekStartDay() == 1 ? 1 : 0 ) -
-              m_fstDayOfWkCalsys - nextLine;
+  int index = weekstart - m_fstDayOfWkCalsys - nextLine;
 
   dayone = dayone.addDays( index );
 
@@ -190,7 +189,7 @@
     } else {
       weeknum.setNum( weeknumstart );
     }
-    weeknos[i]->setText( weeknum );
+    mWeeknos[i]->setText( weeknum );
   }
 
 // each updateDates is followed by an updateView -> repaint is issued there !
@@ -215,18 +214,13 @@
 void KDateNavigator::updateConfig()
 {
   int day;
+  int weekstart = KGlobal::locale()->weekStartDay();
   for( int i = 0; i < 7; i++ ) {
-    // take the first letter of the day name to be the abbreviation
-    if ( KGlobal::locale()->weekStartDay() == 1 ) {
-      day = i + 1;
-    } else {
-      if ( i == 0 ) day = 7;
-      else day = i;
-    }
+    day = weekstart + i <= 7 ? weekstart + i : ( weekstart + i ) % 7;
     QString dayName = KOGlobals::self()->calendarSystem()->weekDayName( day,
                                                                         true );
     if ( KOPrefs::instance()->mCompactDialogs ) dayName = dayName.left( 1 );
-    headings[i]->setText( dayName );
+    mHeadings[i]->setText( dayName );
   }
 
   // FIXME: Use actual config setting here
@@ -237,9 +231,9 @@
 {
   for( int i = 0; i < 6; i++ ) {
     if( enabled )
-      weeknos[i]->show();
+      mWeeknos[i]->show();
     else
-      weeknos[i]->hide();
+      mWeeknos[i]->hide();
   }
 }
 
@@ -270,7 +264,7 @@
   if ( e->type() == QEvent::MouseButtonPress ) {
     int i;
     for( i = 0; i < 6; ++i ) {
-      if ( o == weeknos[ i ] ) {
+      if ( o == mWeeknos[ i ] ) {
         QDate weekstart = mDayMatrix->getDate( i * 7 );
         emit weekClicked( weekstart );
         break;
Index: korganizer/koagendaview.cpp
===================================================================
--- korganizer/koagendaview.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -972,6 +972,8 @@
 
   Incidence *incidence = item->incidence();
   if ( !incidence ) return;
+  if ( !mChanger || !mChanger->beginChange(incidence) ) return;
+  Incidence *oldIncidence = incidence->clone();
 
   QTime startTime(0,0,0), endTime(0,0,0);
   if ( incidence->doesFloat() ) {
@@ -997,6 +999,7 @@
     Event*ev = static_cast<Event*>(incidence);
     if( incidence->dtStart() == startDt && ev->dtEnd() == endDt ) {
       // No change
+      delete oldIncidence;
       return;
     }
     incidence->setDtStart( startDt );
@@ -1011,6 +1014,7 @@
 
     if( td->dtDue() == endDt ) {
       // No change
+      delete oldIncidence;
       return;
     }
   }
@@ -1170,6 +1174,10 @@
     td->setDtDue( endDt );
   }
 
+  mChanger->changeIncidence( oldIncidence, incidence );
+  mChanger->endChange(incidence);
+  delete oldIncidence;
+
   item->setItemDate( startDt.date() );
 
   KOIncidenceToolTip::remove( item );
@@ -1510,10 +1518,10 @@
   mAgenda->clear();
 }
 
-CalPrinter::PrintType KOAgendaView::printType()
+CalPrinterBase::PrintType KOAgendaView::printType()
 {
-  if ( currentDateCount() == 1 ) return CalPrinter::Day;
-  else return CalPrinter::Week;
+  if ( currentDateCount() == 1 ) return CalPrinterBase::Day;
+  else return CalPrinterBase::Week;
 }
 
 void KOAgendaView::updateEventIndicatorTop( int newY )
Index: korganizer/korganizer_configgroupautomation.desktop
===================================================================
--- korganizer/korganizer_configgroupautomation.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configgroupautomation.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,6 @@
 X-KDE-CfgDlgHierarchy=KOrganizer
 
 Name=Group Automation
-Name[ar]=أتمتة المجموعة
 Name[bg]=Организация
 Name[bs]=Automatizacija grupe
 Name[ca]=Automatització de grups
@@ -25,7 +24,7 @@
 Name[es]=Automatización del grupo
 Name[et]=Grupitöö
 Name[eu]=Talde automatizazioa
-Name[fa]=خودکار سازی گروه
+Name[fa]=خودکارسازی گروه
 Name[fi]=Ryhmän automatisointi
 Name[fr]=Automatisation des groupes
 Name[gl]=Automatización de Grupo
@@ -113,14 +112,14 @@
 Keywords[es]=korganizer,grupo,automatización
 Keywords[et]=korganizer,grupid,grupitöö
 Keywords[eu]=korganizer,taldea,automatizazioa
-Keywords[fa]=korganizer،گروه،خودکارسازی
+Keywords[fa]=korganizer،گروه، خودکارسازی
 Keywords[fi]=korganizer,ryhmä,automaatio
 Keywords[fr]=KOrganizer,groupes,automatisation
 Keywords[gl]=korganizer,grupo,automatización
 Keywords[hi]=के-आर्गेनाइज़र,समूह,स्वचालन
 Keywords[hu]=korganizer,csoport,csoportmunka
 Keywords[is]=korganizer,hópar,sjálfvirkni
-Keywords[it]=korganizer,grouppi,automazione
+Keywords[it]=korganizer,gruppi,automazione
 Keywords[ja]=korganizer,グループ,自動化
 Keywords[km]=korganizer,ក្រុម,ស្វ័យប្រតិកម្ម
 Keywords[lt]=korganizer,group,automation, grupės,automatizavimas
Index: korganizer/korganizer_configviews.desktop
===================================================================
--- korganizer/korganizer_configviews.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configviews.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,6 @@
 X-KDE-CfgDlgHierarchy=KOrganizer
 
 Name=Views
-Name[ar]=عروض
 Name[be]=Выгляды
 Name[bg]=Изгледи
 Name[br]=Gweloù
@@ -49,7 +48,7 @@
 Name[pt]=Janelas
 Name[pt_BR]=Visões
 Name[ro]=Vizualizări
-Name[ru]=Виды
+Name[ru]=Вид
 Name[se]=Čájeheamit
 Name[sk]=Pohľady
 Name[sl]=Prikazi
Index: korganizer/korganizer-import.desktop
===================================================================
--- korganizer/korganizer-import.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 0)
+++ korganizer/korganizer-import.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -0,0 +1,138 @@
+[Desktop Entry]
+Encoding=UTF-8
+NoDisplay=true
+Comment=Calendar and Scheduling Program
+Comment[af]=Kalender en Skedulering Program
+Comment[ar]=برنامج الجدولة والتقويم
+Comment[bg]=Програма за календар и разписание
+Comment[bs]=Kalendar i rokovnik
+Comment[ca]=Un programa de calendari i planificació
+Comment[cs]=Kalendářový a plánovací program
+Comment[cy]=Rhaglen Galendr a Drefnlennu
+Comment[da]=Kalender- og planlægningsprogram
+Comment[de]=Ein Kalender und Zeitplaner
+Comment[el]=Πρόγραμμα ημερολογίου και προγραμματισμού
+Comment[eo]=Kalendara kaj plana programo
+Comment[es]=Calendario y planificador
+Comment[et]=Kalendri ja ajakava haldamise rakendus
+Comment[eu]=Egutegi eta antolaketa progrmaa
+Comment[fa]=تقویم و برنامۀ زمان‌بندی
+Comment[fi]=Kalenteri ja ajanhallintaohjelma
+Comment[fr]=Calendrier et agenda personnel
+Comment[gl]=Programa de Calendario e Axenda
+Comment[he]=תוכניות לוח שנה ותזמון משימות
+Comment[hi]=कैलेन्डर तथा समय-सारणी प्रोग्राम
+Comment[hr]=Kalendar i rokovnik
+Comment[hu]=Határidőnapló és eseményszervező
+Comment[is]=Dagbók og skipulag
+Comment[it]=Programma di calendario e di agenda
+Comment[ja]=カレンダーとスケジュール管理プログラム
+Comment[km]=កម្មវិធី​ប្រតិទិន និង កាលវិភាគ
+Comment[lt]=Kalendoriaus ir planavimo programa
+Comment[lv]=Kalendāra un Plānošanas Programma
+Comment[mk]=Календар и роковник
+Comment[ms]=Kalendar dan Program Penjadualan 
+Comment[mt]=Programm b' kalendarju w skeda
+Comment[nb]=Et kalender- og tidsplanleggingsprogram
+Comment[nds]=Kalenner un Tietplaner
+Comment[nl]=Agenda- en afsprakenprogramma
+Comment[nn]=Kalender- og planleggingsprogram
+Comment[nso]=Lenaneo la Peakanyo ya Tshupamabaka
+Comment[pl]=Kalendarz i terminarz
+Comment[pt]=Calendário e Programa de Escalonamento
+Comment[pt_BR]=Programa de Calendário e Agenda
+Comment[ro]=Program de planificare şi calendar
+Comment[ru]=Календарь и личное расписание
+Comment[se]=Kaleandar- ja plánenprográmma
+Comment[sk]=Kalendár a plánovací program
+Comment[sl]=Program za koledar in razporejanje
+Comment[sr]=Календарски и планерски програм
+Comment[sr@Latn]=Kalendarski i planerski program
+Comment[sv]=Kalender- och schemaläggningsprogram
+Comment[ta]=நாள்காட்டி மற்றும் திட்ட நிரல்
+Comment[tg]=Тақвимот ва ҷадвали шахсӣ
+Comment[th]=โปรแกรมจัดการปฏิทินและตารางการนัดหมาย
+Comment[tr]=Takvim ve Zamanlama Programı
+Comment[uk]=Програма календаря та розкладу
+Comment[uz]=Календар ва режалаштириш дастури
+Comment[ven]=Khalenda na mbekanyamushumo ya u shedula
+Comment[vi]=Chương trình lịch và kế hoạch
+Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
+Comment[zh_CN]=日历和日程安排程序
+Comment[zh_TW]=行事曆與排程軟體
+Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
+Exec=korganizer --import %U
+Icon=korganizer
+Path=
+DocPath=korganizer/index.html
+Type=Application
+Terminal=false
+Name=KOrganizer
+Name[af]=Korganizer
+Name[be]=K Арганізатар
+Name[cy]=KTrefnydd
+Name[eo]=Organizilo
+Name[hi]=के-आर्गेनाइज़र
+Name[lv]=KOrganaizers
+Name[mk]=Организатор
+Name[nso]=KMokopanyi
+Name[pl]=Organizator
+Name[sv]=Korganizer
+Name[ta]=கேஅமைப்பாளர்
+Name[ven]=Mulugisi wa K
+Name[zh_TW]=KOrganizer 行事曆
+GenericName=Personal Organizer
+GenericName[ar]=المنظم الشخصي
+GenericName[be]=Пэрсанальны арганізатар
+GenericName[bg]=Организатор
+GenericName[bs]=Lični organizer
+GenericName[ca]=Organitzador personal
+GenericName[cs]=Osobní organizér
+GenericName[cy]=Trefnydd Personol
+GenericName[da]=Personlig organisering
+GenericName[de]=Persönliche Daten organisieren
+GenericName[el]=Προσωπικός οργανωτής
+GenericName[en_GB]=Personal Organiser
+GenericName[es]=Organizador personal
+GenericName[et]=Personaalne ajaarvestus
+GenericName[eu]=Antolatzaile pertsonala
+GenericName[fa]=سازمان‌دهندۀ شخصی
+GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
+GenericName[fr]=Organiseur personnel
+GenericName[gl]=Organizador Persoal
+GenericName[he]=מנהל זמן אישי
+GenericName[hi]=निजी प्रबंधक
+GenericName[hu]=Határidőnapló
+GenericName[is]=Persónuleg skipulagsbók
+GenericName[it]=Organizzatore personale
+GenericName[ja]=個人向けスケジュール管理
+GenericName[km]=កម្មវិធី​រៀបចំ​ផ្ទាល់​ខ្លួន
+GenericName[lt]=Asmeninės informacijos tvarkyklė
+GenericName[ms]=Penyusun Peribadi
+GenericName[nb]=Personlig planlegger
+GenericName[nds]=Persöönlich Mötenkalenner
+GenericName[nl]=Persoonlijke organizer
+GenericName[nn]=Personleg organiserar
+GenericName[pl]=Osobisty organizator
+GenericName[pt]=Organizador Pessoal
+GenericName[pt_BR]=Organizador Pessoal
+GenericName[ro]=Organizator personal
+GenericName[ru]=Персональный органайзер
+GenericName[sk]=Osobný plánovač
+GenericName[sl]=Osebni organizator
+GenericName[sr]=Лични планер
+GenericName[sr@Latn]=Lični planer
+GenericName[sv]=Filofax
+GenericName[ta]=தனிப்பயன் அமைப்பாளர்
+GenericName[tg]=Органайзери инфиродӣ
+GenericName[tr]=Kişisel Bilgi Yöneticisi
+GenericName[uk]=Персональний тижневик
+GenericName[uz]=Шахсий органайзер
+GenericName[zh_CN]=个人日程安排
+GenericName[zh_TW]=個人行程組織軟體
+ServiceTypes=Browser/View,DCOP/Organizer
+X-KDE-Library=libkorganizerpart
+X-KDE-StartupNotify=true
+X-DCOP-ServiceType=Unique
+X-DCOP-ServiceName=korganizer
+
Index: korganizer/koincidenceeditor.h
===================================================================
--- korganizer/koincidenceeditor.h	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/koincidenceeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -63,8 +63,6 @@
                        QWidget *parent );
     virtual ~KOIncidenceEditor();
 
-    /** Initialize editor. This function creates the tab widgets. */
-    virtual void init() = 0;
     /** This incidence has been modified externally */
     virtual void modified (int /*change*/=0) {}
 
@@ -76,6 +74,16 @@
     virtual void editIncidence(Incidence *) = 0;
     virtual void setIncidenceChanger( IncidenceChangerBase *changer ) {
         mChanger = changer; }
+    /** Initialize editor. This function creates the tab widgets. */
+    virtual void init() = 0;
+    /**
+      Adds attachments to the editor
+    */
+    void addAttachments( const QStringList &attachments );
+    /**
+      Adds attendees to the editor
+    */
+    void addAttendees( const QStringList &attendees );
 
 
   signals:
@@ -130,8 +138,6 @@
 
     Calendar *mCalendar;
 
-    KPIM::CategorySelectDialog *mCategoryDialog;
-
     KOEditorDetails *mDetails;
     KOEditorAttachments *mAttachments;
     KOrg::IncidenceChangerBase *mChanger;
Index: korganizer/korganizer_configmain.desktop
===================================================================
--- korganizer/korganizer_configmain.desktop	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ korganizer/korganizer_configmain.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -13,7 +13,7 @@
 X-KDE-CfgDlgHierarchy=KOrganizer
 
 Name=Personal
-Name[ar]=شخصي
+Name[ar]=الشخصي
 Name[be]=Пэрсанальныя
 Name[bg]=Персоналност
 Name[br]=Diouzhoc'h
@@ -119,7 +119,7 @@
 Keywords[es]=korganizer,principal,personal
 Keywords[et]=korganizer,peamine,isiklik
 Keywords[eu]=korganizer,nagusia,pertsonala
-Keywords[fa]=korganizer،اصلی،شخصی
+Keywords[fa]=korganizer،اصلی، شخصی
 Keywords[fi]=korganizer,pää,henkilökohtainen
 Keywords[fr]=KOrganizer,principal,personnel
 Keywords[gl]=korganizer,principal,persoal
Index: mimelib/entity.cpp
===================================================================
--- mimelib/entity.cpp	(.../tags/KDE/3.5.5/kdepim)	(wersja 620387)
+++ mimelib/entity.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 620387)
@@ -224,7 +224,8 @@
     // DwEntityParser skips the line separating the headers from the
     // body. So it's neither part of DwHeaders, nor of DwBody
     // -> we need to readd it here:
-    mString += DW_EOL;
+    if ( mString != "" )
+      mString += DW_EOL;
 
     mString += aBody.AsString();
     mIsModified = 0;

Zmiany atrybutów dla: .
___________________________________________________________________
Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


