diff -urN -x CVS kdepim.orig/Makefile.am.in kdepim/Makefile.am.in
--- kdepim.orig/Makefile.am.in	Thu Jun 17 10:17:20 2004
+++ kdepim/Makefile.am.in	Thu Oct  7 11:20:21 2004
@@ -10,7 +10,7 @@
 COMPILE_BEFORE_konsolekalendar = libkpimexchange
 COMPILE_BEFORE_kaddressbook = libkdepim certmanager
 COMPILE_BEFORE_kandy = libkdepim
-COMPILE_BEFORE_kmail= libkdepim libkpimidentities certmanager
+COMPILE_BEFORE_kmail= libkdepim libkpimidentities certmanager libkcal
 COMPILE_BEFORE_knode= libkdepim
 COMPILE_BEFORE_karm = libkdepim
 COMPILE_BEFORE_plugins = kmail libkdepim libkcal
@@ -18,7 +18,7 @@
 COMPILE_AFTER_mimelib = korn kmail
 COMPILE_AFTER_libkdenetwork = kmail knode certmanager
 COMPILE_AFTER_libksieve = kmail
-COMPILE_BEFORE_libkcal = libical
+COMPILE_BEFORE_libkcal = libical ktnef
 COMPILE_BEFORE_kontact = kaddressbook knotes korganizer
 COMPILE_BEFORE_libkpimexchange = kalarmd libkdepim
 COMPILE_BEFORE_kalarm = kalarmd libkdepim
diff -urN -x CVS kdepim.orig/certmanager/conf/kleopatra_config_appear.desktop kdepim/certmanager/conf/kleopatra_config_appear.desktop
--- kdepim.orig/certmanager/conf/kleopatra_config_appear.desktop	Thu Sep 30 16:03:44 2004
+++ kdepim/certmanager/conf/kleopatra_config_appear.desktop	Mon Oct  4 15:26:02 2004
@@ -45,7 +45,7 @@
 Name[sk]=Vzhľad
 Name[sl]=Videz
 Name[sr]=Изглед
-Name[sr@Latn]=Изглед
+Name[sr@Latn]=Izgled
 Name[sv]=Uppträdande
 Name[ta]=தோற்றம்
 Name[tg]=Намуди зоҳирӣ
@@ -68,6 +68,7 @@
 Comment[hu]=A színek és betűtípusok beállítása
 Comment[is]=Stilling lita og leturgerða
 Comment[it]=Configurazione tipi di carattere e colori
+Comment[ja]=色とフォント設定
 Comment[nb]=Oppsett av farger og skrifttyper
 Comment[nl]=Kleur- en lettertype-instellingen
 Comment[nn]=Oppsett av fargar og skrifter
@@ -79,7 +80,7 @@
 Comment[sk]=Nastavenie písiem a farieb
 Comment[sl]=Nastavitev pisav in barv
 Comment[sr]=Подешавање боја и фонтова
-Comment[sr@Latn]=Подешавање боја и фонтова
+Comment[sr@Latn]=Podešavanje boja i fontova
 Comment[sv]=Inställning av färger och teckensnitt
 Comment[ta]=வண்ணங்கள்& எழுத்துருக்கள் கட்டமைப்பு
 Comment[tg]=Танзимоти ранг ва ҳуруф
@@ -101,6 +102,7 @@
 Keywords[hu]=szín,betűtípus,beállítások
 Keywords[is]=litir,letur, stillingar
 Keywords[it]=colori, font, caratteri, configurazione
+Keywords[ja]=色 フォント 設定
 Keywords[nb]=farge,skrifttype,oppsett
 Keywords[nl]=kleur,kleuren,font,lettertype,configuratie,instellingen,setup
 Keywords[nn]=farge,skrift,oppsett
@@ -112,7 +114,7 @@
 Keywords[sk]=farba,písmo,nastavenie
 Keywords[sl]=barva,barve,pisava,pisave,nastavi,nastavitve
 Keywords[sr]=боја,фонт,подешавања
-Keywords[sr@Latn]=боја,фонт,подешавања
+Keywords[sr@Latn]=boja,font,podešavanja
 Keywords[sv]=färger,teckensnitt, inställningar
 Keywords[ta]=Comment=வண்ணம்,எழுத்துரு, கட்டமைப்பு
 Keywords[tg]=рангҳо,ҳуруфҳо,танзимот
diff -urN -x CVS kdepim.orig/certmanager/conf/kleopatra_config_dirserv.desktop kdepim/certmanager/conf/kleopatra_config_dirserv.desktop
--- kdepim.orig/certmanager/conf/kleopatra_config_dirserv.desktop	Sun Sep 12 15:56:47 2004
+++ kdepim/certmanager/conf/kleopatra_config_dirserv.desktop	Mon Oct  4 15:26:02 2004
@@ -28,6 +28,7 @@
 Name[hu]=Címtárszolgáltatások
 Name[is]=Nafnaþjónustur
 Name[it]=Servizi Directory
+Name[ja]=ディレクトリ サービス
 Name[nb]=Katalogtjenere
 Name[nl]=Mapdiensten
 Name[nn]=Katalogtenester
@@ -39,7 +40,7 @@
 Name[sk]=Adresárové služby
 Name[sl]=Imeniške storitve
 Name[sr]=Сервис директоријума
-Name[sr@Latn]=Сервис директоријума
+Name[sr@Latn]=Servis direktorijuma
 Name[sv]=Katalogtjänster
 Name[ta]= அடைவு சேவைகள்
 Name[tg]=Кӯмакҳои каталог
@@ -58,6 +59,7 @@
 Comment[he]=תצורה של שירותי ספרייה עבור LDAP
 Comment[hu]=Az LDAP címtárszolgáltatások beállításai
 Comment[it]=Configurazione servizi LDAP
+Comment[ja]=LDAP ディレクトリー サービスの設定
 Comment[nb]=Oppsett av LDAP katalogtjenester
 Comment[nl]=Configuratie voor LDAP-diensten
 Comment[nn]=Oppsett av LDAP-katalogtenester
@@ -69,7 +71,7 @@
 Comment[sk]=Nastavenie adresárových služieb LDAP
 Comment[sl]=Nastavitve imeniških storitev LDAP
 Comment[sr]= Подешавања LDAP сервиса директоријума
-Comment[sr@Latn]= Подешавања LDAP сервиса директоријума
+Comment[sr@Latn]= Podešavanja LDAP servisa direktorijuma
 Comment[sv]=Inställning av LDAP-katalogtjänster
 Comment[ta]= LDAP அடைவு சேவைகளின் கட்டமைப்பு
 Comment[tg]=Танзимоти кӯмакҳои каталоги LDAP
@@ -90,6 +92,7 @@
 Keywords[hu]=ldap,címtár,szolgáltatások
 Keywords[is]=ldap,directory,services,nafnaþjónusta
 Keywords[it]=ldap, servizi, directory
+Keywords[ja]=ldap,ディレクトリー,サービス
 Keywords[nb]=ldap,mappe,tjenester
 Keywords[nn]=ldap,katalog,tenester
 Keywords[pl]=ldap,katalog,usługi katalogowe,usługi,LDAP
@@ -100,7 +103,7 @@
 Keywords[sk]=ldap,adresár,služby
 Keywords[sl]=ldap,imenik,storitve
 Keywords[sr]=ldap,директоријум,сервиси
-Keywords[sr@Latn]=ldap,директоријум,сервиси
+Keywords[sr@Latn]=ldap,direktorijum,servisi
 Keywords[sv]=ldap,katalog,tjänster
 Keywords[ta]=ldap, அடைவு, சேவைகள்
 Keywords[tg]=ldap,кӯмакҳои каталог
diff -urN -x CVS kdepim.orig/certmanager/conf/kleopatra_config_dnorder.desktop kdepim/certmanager/conf/kleopatra_config_dnorder.desktop
--- kdepim.orig/certmanager/conf/kleopatra_config_dnorder.desktop	Thu Sep 30 16:03:44 2004
+++ kdepim/certmanager/conf/kleopatra_config_dnorder.desktop	Mon Oct  4 15:26:02 2004
@@ -27,6 +27,7 @@
 Name[he]=סדר של מאפייני DN
 Name[hu]=DN-attribútumsorrend
 Name[it]=Attributi DN, ordine
+Name[ja]=DNー属性 オーダー
 Name[nb]=DN-Attributtrekkefølge
 Name[nl]=DN-Attribuutvolgorde
 Name[nn]=DN-attributtrekkjefølgje
@@ -38,7 +39,7 @@
 Name[sk]=Poradie atribútov DN
 Name[sl]=Vrstni red atributov DN
 Name[sr]=DN-Атрибут ред
-Name[sr@Latn]=DN-Атрибут ред
+Name[sr@Latn]=DN-Atribut red
 Name[sv]=DN-egenskapsordning
 Name[ta]=DN-பண்புக்கூறு வரிசை
 Name[tg]=Тартиби мушаххасияти DN
@@ -56,6 +57,7 @@
 Comment[he]=הגדרה של הסדר שבהם מאפייני DN מוצגים
 Comment[hu]=A DN-attribútumok megjelenítési sorrendjének beállítása
 Comment[it]=Configuraz l'ordine in cui sono mostrati gli attributi DN
+Comment[ja]=DN-属性が示されるオーダーを設定します。
 Comment[nb]=Still inn rekkefølgen DN-attributtene er sortert i
 Comment[nl]=Stel de volgorde in van de DN-attributen
 Comment[nn]=Vel kva rekkjefølgje DN-attributtane er sorterte i
@@ -67,7 +69,7 @@
 Comment[sk]=Nastavenie poradia, v ktorom sú zobrazené atribúty DN
 Comment[sl]=Nastavite vrstni red, v katerem so prikazani atributi DN
 Comment[sr]=Подешава ред којим су приказани DN атрибути
-Comment[sr@Latn]=Подешава ред којим су приказани DN атрибути
+Comment[sr@Latn]=Podešava red kojim su prikazani DN atributi
 Comment[sv]=Anpassa ordningen som DN-egenskaper visas
 Comment[ta]= DN விவரங்கள் எந்த வரிசையில் உள்ளதோ அப்படியே அமை
 Comment[tg]=Танзимоти мушаххасиятҳои намоишшавандаи тартибии DN
@@ -86,6 +88,7 @@
 Keywords[he]=DN,סדר,RDN,מאפיין
 Keywords[hu]=DN,sorrend,RDN,attribútum
 Keywords[it]=DN,ordine,RDN,attributi
+Keywords[ja]=DN,オーダー,RDN,属性
 Keywords[nb]=DN,orden,RDN,attributt
 Keywords[nl]=DN,volgorde,RDN,attribuut
 Keywords[nn]=DN,rekkjefølgje,RDN,attributt
@@ -97,7 +100,7 @@
 Keywords[sk]=DN,poradie,RDN,atribút
 Keywords[sl]=DN,vrstni red,RDN,atribut
 Keywords[sr]=DN,ред,RDN,атрибут
-Keywords[sr@Latn]=DN,ред,RDN,атрибут
+Keywords[sr@Latn]=DN,red,RDN,atribut
 Keywords[sv]=DN,ordning,RDN,egenskap
 Keywords[ta]=DN,வரிசை,RDN,குணம்
 Keywords[tg]=DN,тартибот,RDN,мушаххасот
diff -urN -x CVS kdepim.orig/certmanager/kwatchgnupg/kwatchgnupgmainwin.cpp kdepim/certmanager/kwatchgnupg/kwatchgnupgmainwin.cpp
--- kdepim.orig/certmanager/kwatchgnupg/kwatchgnupgmainwin.cpp	Thu Sep  9 17:44:59 2004
+++ kdepim/certmanager/kwatchgnupg/kwatchgnupgmainwin.cpp	Wed Oct 13 17:53:41 2004
@@ -47,11 +47,13 @@
 #include <kconfig.h>
 #include <kfiledialog.h>
 #include <kedittoolbar.h>
+#include <kkeydialog.h>
+
 #include <qtextedit.h>
 #include <qdir.h>
 #include <qeventloop.h>
 #include <qtimer.h>
-#include <kkeydialog.h>
+#include <qtextcodec.h>
 
 #define WATCHGNUPGBINARY "watchgnupg"
 #define WATCHGNUPGSOCKET ( QDir::home().canonicalPath() + "/.gnupg/log-socket")
@@ -66,7 +68,7 @@
   mCentralWidget->setTextFormat( QTextEdit::LogText );
   setCentralWidget( mCentralWidget );
 
-  mWatcher = new KProcIO();
+  mWatcher = new KProcIO( QTextCodec::codecForMib( 106 /*utf-8*/ ) );
   connect( mWatcher, SIGNAL( processExited(KProcess*) ),
 		   this, SLOT( slotWatcherExited() ) );
   connect( mWatcher, SIGNAL( readReady(KProcIO*) ),
diff -urN -x CVS kdepim.orig/certmanager/lib/cryptplug.cpp kdepim/certmanager/lib/cryptplug.cpp
--- kdepim.orig/certmanager/lib/cryptplug.cpp	Thu Aug 26 21:42:16 2004
+++ kdepim/certmanager/lib/cryptplug.cpp	Fri Oct  8 23:48:59 2004
@@ -1989,11 +1989,13 @@
 {
   gpgme_ctx_t ctx;
   gpgme_error_t err;
+  gpgme_decrypt_result_t decryptresult;
   gpgme_data_t gCiphertext, gPlaintext;
   gpgme_sig_stat_t sigstatus = GPGME_SIG_STAT_NONE;
   size_t rCLen = 0;
   char*  rCiph = 0;
   bool bOk = false;
+  bool bWrongKeyUsage = false;
 
   if( !ciphertext )
     return false;
@@ -2018,6 +2020,13 @@
 
   err = gpgme_op_decrypt_verify( ctx, gCiphertext, gPlaintext );
   gpgme_data_release( gCiphertext );
+  
+  decryptresult = gpgme_op_decrypt_result( ctx );
+#ifdef HAVE_GPGME_WRONG_KEY_USAGE
+  if( decryptresult->wrong_key_usage )
+    bWrongKeyUsage = true;
+#endif
+  
   if( err ) {
     fprintf( stderr, "\ngpgme_op_decrypt_verify() returned this error code:  %i\n\n", err );
     if( errId )
@@ -2032,7 +2041,12 @@
     gpgme_release( ctx );
     return bOk;
   }
-
+  
+  if( bWrongKeyUsage ) {
+    if( errId )
+      *errId = CRYPTPLUG_ERR_WRONG_KEY_USAGE; // report the wrong key usage
+  }  
+  
   rCiph = gpgme_data_release_and_get_mem( gPlaintext,  &rCLen );
 
   *cleartext = (char*)malloc( rCLen + 1 );
diff -urN -x CVS kdepim.orig/certmanager/lib/cryptplug.h kdepim/certmanager/lib/cryptplug.h
--- kdepim.orig/certmanager/lib/cryptplug.h	Fri Jul  9 02:17:28 2004
+++ kdepim/certmanager/lib/cryptplug.h	Fri Oct  8 21:07:50 2004
@@ -412,7 +412,7 @@
    This function may be called prior to initialize().
   */
 int interfaceVersion (int *min_version);
-
+#define CRYPTPLUG_ERR_WRONG_KEY_USAGE 0x7070
 
 /*! \ingroup groupGeneral
     \brief This function sets up all internal structures.
diff -urN -x CVS kdepim.orig/certmanager/lib/kleo/kconfigbasedkeyfilter.h kdepim/certmanager/lib/kleo/kconfigbasedkeyfilter.h
--- kdepim.orig/certmanager/lib/kleo/kconfigbasedkeyfilter.h	Sat Jun  5 16:32:55 2004
+++ kdepim/certmanager/lib/kleo/kconfigbasedkeyfilter.h	Fri Oct  8 13:00:45 2004
@@ -91,7 +91,7 @@
       Is = 1,
       IsNot = 2,
       IsAtLeast = 3,
-      IsAtMost = 4,
+      IsAtMost = 4
     };
     LevelState mOwnerTrust;
     GpgME::Key::OwnerTrust mOwnerTrustReferenceLevel;
diff -urN -x CVS kdepim.orig/certmanager/lib/libkleopatrarc.desktop kdepim/certmanager/lib/libkleopatrarc.desktop
--- kdepim.orig/certmanager/lib/libkleopatrarc.desktop	Thu Sep 30 16:03:45 2004
+++ kdepim/certmanager/lib/libkleopatrarc.desktop	Mon Oct  4 15:26:03 2004
@@ -14,6 +14,7 @@
 Name[he]=מפתח לא מוודא
 Name[hu]=Nem ellenőrzött kulcs
 Name[it]=Chiave non valida
+Name[ja]=有効になったキーではない
 Name[nb]=Ikke gyldighets-sjekket nøkkel
 Name[nl]=Geen gevalideerde sleutel
 Name[nn]=Ikkje-validert nøkkel
@@ -24,7 +25,7 @@
 Name[sk]=Neoverený kľúč
 Name[sl]=Nepotrjen ključ
 Name[sr]=Неисправни кључ
-Name[sr@Latn]=Неисправни кључ
+Name[sr@Latn]=Neispravni ključ
 Name[sv]=Nyckeln har inte validerats
 Name[ta]=செல்லுபடியாகாத விசை
 Name[tg]=Кадиди озмоида нашуда
@@ -50,6 +51,7 @@
 Name[hu]=Lejárt kulcs
 Name[is]=Útrunninn lykill
 Name[it]=Chiave scaduta
+Name[ja]=期限切れになったキー
 Name[nb]=Utgått nøkkel
 Name[nl]=Verlopen sleutel
 Name[nn]=Utgått nøkkel
@@ -61,7 +63,7 @@
 Name[sk]=Vypršaný kľúč
 Name[sl]=Pretečen ključ
 Name[sr]=Истекли кључ
-Name[sr@Latn]=Истекли кључ
+Name[sr@Latn]=Istekli ključ
 Name[sv]=Utgången nyckel
 Name[ta]=காலம் கடந்த விசை
 Name[tg]=Калиди аз мӯҳлат баромада
@@ -84,6 +86,7 @@
 Name[he]=מפתח לא קביל
 Name[hu]=Visszavont kulcs
 Name[it]=Chiave revocata
+Name[ja]=無効になったキー
 Name[nb]=Tilbakekallet nøkkel
 Name[nl]=Ingetrokken sleutel
 Name[nn]=Tilbakekalla nøkkel
@@ -94,7 +97,7 @@
 Name[sk]=Kľúč so zrušenou platnosťou
 Name[sl]=Preklican ključ
 Name[sr]=Опозвани кључ
-Name[sr@Latn]=Опозвани кључ
+Name[sr@Latn]=Opozvani ključ
 Name[sv]=Återkallad nyckel
 Name[ta]=நீக்கிய விசை
 Name[tg]=Калиди барқароршуда
@@ -117,6 +120,7 @@
 Name[gl]=Certificado root autentificado
 Name[hu]=Megbízható gyökértanúsítvány
 Name[it]=Certificato radice affidabile
+Name[ja]=信頼されたルート証明書
 Name[nb]=Betrodd rot sertifikat
 Name[nl]=Vertrouwd hoofdcertificaat
 Name[nn]=Tiltrudd rotsertifikat
@@ -128,7 +132,7 @@
 Name[sk]=Dôveryhodný koreňový certifikát
 Name[sl]=Zaupan korenski certifikat
 Name[sr]=Коренски сертификат коме се верује
-Name[sr@Latn]=Коренски сертификат коме се верује
+Name[sr@Latn]=Korenski sertifikat kome se veruje
 Name[sv]=Pålitligt rotcertifikat
 Name[ta]=நம்பகமான மூல சான்றிதழ்
 Name[tg]=Сертификати решавии эътимод
@@ -150,6 +154,7 @@
 Name[fr]=Certificat racine pas de confiance
 Name[hu]=Nem megbízható gyökértanúsítvány
 Name[it]=Certificato radice non affidabile
+Name[ja]=信頼されたルート証明書ではない
 Name[nb]=Ikke betrodd rot sertifikat
 Name[nl]=Niet vertrouwd hoofdcertificaat
 Name[nn]=Ikkje tiltrudd rotsertifikat
@@ -161,7 +166,7 @@
 Name[sk]=Nedôveryhodný koreňový certifikát
 Name[sl]=Nezaupan korenski certifikat
 Name[sr]=Коренски сертификат коме се не верује
-Name[sr@Latn]=Коренски сертификат коме се не верује
+Name[sr@Latn]=Korenski sertifikat kome se ne veruje
 Name[sv]=Opålitligt rotcertifikat
 Name[ta]=நம்பமுடியாத மூல சான்றிதழ்
 Name[tg]=Сертификати решавии ғайриэътимод
@@ -185,6 +190,7 @@
 Name[hu]=Egyéb kulcsok
 Name[is]=Aðrir lyklar
 Name[it]=Altre chiavi
+Name[ja]=他のキー
 Name[nb]=Andre nøkler
 Name[nl]=Andere sleutels
 Name[nn]=Andre nøklar
@@ -196,7 +202,7 @@
 Name[sk]=Iné kľúče
 Name[sl]=Drugi ključi
 Name[sr]=Други кључеви
-Name[sr@Latn]=Други кључеви
+Name[sr@Latn]=Drugi ključevi
 Name[sv]=Andra nycklar
 Name[ta]=மற்ற விசைகள்
 Name[tg]=Дигар калидҳо
diff -urN -x CVS kdepim.orig/kaddressbook/editors/cryptosettings.desktop kdepim/kaddressbook/editors/cryptosettings.desktop
--- kdepim.orig/kaddressbook/editors/cryptosettings.desktop	Thu Sep 30 16:03:47 2004
+++ kdepim/kaddressbook/editors/cryptosettings.desktop	Mon Oct  4 15:26:06 2004
@@ -16,6 +16,7 @@
 Name[he]=מאפייני הצפנה
 Name[hu]=Titkosítási beállítások
 Name[it]=Preferenze crittografia
+Name[ja]=暗号プレファレンス
 Name[nb]=Krypterings instillinger
 Name[nl]=Versleutelingsinstellingen
 Name[nn]=Krypteringsinnstillinger
@@ -27,7 +28,7 @@
 Name[sk]=Nastavenie šifrovania
 Name[sl]=Lastnosti šifriranja
 Name[sr]=Криптографска подешавања
-Name[sr@Latn]=Криптографска подешавања
+Name[sr@Latn]=Kriptografska podešavanja
 Name[sv]=Krypteringsinställningar
 Name[ta]= க்ரிப்டோ முன்னுரிமைகள்
 Name[tg]=Танзимоти рамзгузорӣ
diff -urN -x CVS kdepim.orig/kaddressbook/editors/imaddresseditor.desktop kdepim/kaddressbook/editors/imaddresseditor.desktop
--- kdepim.orig/kaddressbook/editors/imaddresseditor.desktop	Thu Sep 30 16:03:47 2004
+++ kdepim/kaddressbook/editors/imaddresseditor.desktop	Mon Oct  4 15:26:06 2004
@@ -21,7 +21,7 @@
 Name[sk]=Rozhovor
 Name[sl]=Takojšno sporočanje
 Name[sr]=Тренутне поруке
-Name[sr@Latn]=Тренутне поруке
+Name[sr@Latn]=Trenutne poruke
 Name[sv]=Direktmeddelanden
 Name[ta]=உடனடி செய்தி பரிமாற்றம்
 Name[tg]=Хизматгоҳи мубодилаи иттилоот
@@ -39,6 +39,7 @@
 Comment[he]=עורך כתובות מסרים מידיים
 Comment[hu]=IM-címszerkesztő
 Comment[it]=Editor degli indirizzi per messaggi istantanei
+Comment[ja]=インスタント メッセージ アドレス 編集
 Comment[nb]=Lynmelding adresse redigerer
 Comment[nl]=Instant Messaging Adresbewerker
 Comment[nn]=Adresseredigering for lynmelding
@@ -50,7 +51,7 @@
 Comment[sk]=Editor adries pre Instant Messaging
 Comment[sl]=Urejevalnik naslovov takojšnega sporočanja
 Comment[sr]=Едитор адреса тренутних порука
-Comment[sr@Latn]=Едитор адреса тренутних порука
+Comment[sr@Latn]=Editor adresa trenutnih poruka
 Comment[sv]=Adresseditor för direktmeddelanden
 Comment[ta]= உடனடி செய்தி பரிமாற்றத்தின் முகவரி தொகுப்பான்
 Comment[tg]=Муҳаррири алоқоти хизматгоҳҳои мубодилаи иттилоот
diff -urN -x CVS kdepim.orig/kaddressbook/editors/kaddressbookimprotocol.desktop kdepim/kaddressbook/editors/kaddressbookimprotocol.desktop
--- kdepim.orig/kaddressbook/editors/kaddressbookimprotocol.desktop	Thu Sep 30 16:03:47 2004
+++ kdepim/kaddressbook/editors/kaddressbookimprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -14,6 +14,7 @@
 Name[he]=פרוטוקול מסרים מידיים של KAddressbook
 Name[hu]=KAddressbook azonnali üzenetküldési protokoll
 Name[it]=KAddressbook protocollo messaggistica istantanea
+Name[ja]=KAddressbook インスタント メッセージ プロトコル
 Name[nb]=KAdressbook lynmeldings protokoll
 Name[nl]=KAddressbook Instant Messaging-protocol
 Name[nn]=Lynmeldingsprotokoll for KDE-adresseboka
@@ -25,7 +26,7 @@
 Name[sk]=Protokol pre KDE Adresár Instant Messaging
 Name[sl]=Protokol takojšnega sporočanja za Adresar
 Name[sr]=KAddressbook протокол тренутних адреса
-Name[sr@Latn]=KAddressbook протокол тренутних адреса
+Name[sr@Latn]=KAddressbook protokol trenutnih adresa
 Name[sv]=Direktmeddelandeprotokoll för adressboken
 Name[ta]=கேஅட்ரஸ்புக் உடனடி செய்தி பரிமாற்றம்
 Name[tg]=Протоколи мубодилаи иттилооти китоби адресии KDE
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/aimprotocol.desktop kdepim/kaddressbook/editors/protocols/aimprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/aimprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/aimprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול AIM
 Comment[hu]=AIM protokoll
 Comment[it]=Protocollo AIM
+Comment[ja]=AIM プロトコル
 Comment[nb]=AIM protokoll
 Comment[nl]=AIM-protocol
 Comment[nn]=AIM-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol AIM
 Comment[sl]=Protokol AIM
 Comment[sr]=AIM протокол
-Comment[sr@Latn]=AIM протокол
+Comment[sr@Latn]=AIM protokol
 Comment[sv]=AIM-protokoll
 Comment[ta]=AIM நெறிமுறை
 Comment[tg]=Протоколи AIM
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/gaduprotocol.desktop kdepim/kaddressbook/editors/protocols/gaduprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/gaduprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/gaduprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול Gadu-Gadu
 Comment[hu]=Gadu-Gadu protokoll
 Comment[it]=Protocollo Gadu-Gadu
+Comment[ja]=Gadu-Gadu プロトコル
 Comment[nb]=Gadu-Gadu protokoll
 Comment[nl]=Gadu-Gadu-protocol
 Comment[nn]=Gadu-Gadu-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol Gadu-Gadu
 Comment[sl]=Protokol Gadu-Gadu
 Comment[sr]=Gadu-Gadu протокол
-Comment[sr@Latn]=Gadu-Gadu протокол
+Comment[sr@Latn]=Gadu-Gadu protokol
 Comment[sv]=Gadu-Gadu-protokoll
 Comment[ta]=கடு-கடு நெறிமுறை
 Comment[tg]=протоколи Gadu-Gadu
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/icqprotocol.desktop kdepim/kaddressbook/editors/protocols/icqprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/icqprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/icqprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול ICQ
 Comment[hu]=ICQ protokoll
 Comment[it]=Protocollo ICQ
+Comment[ja]=ICQ プロトコル
 Comment[nb]=ICQ protokoll
 Comment[nl]=ICQ-protocol
 Comment[nn]=ICQ-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol ICQ
 Comment[sl]=Protokol ICQ
 Comment[sr]=ICQ протокол
-Comment[sr@Latn]=ICQ протокол
+Comment[sr@Latn]=ICQ protokol
 Comment[sv]=ICQ-protokoll
 Comment[ta]=ICQ நெறிமுறை
 Comment[tg]=Протоколи ICQ
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/ircprotocol.desktop kdepim/kaddressbook/editors/protocols/ircprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/ircprotocol.desktop	Tue Aug 24 08:31:46 2004
+++ kdepim/kaddressbook/editors/protocols/ircprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -7,12 +7,13 @@
 Comment=Internet Relay Chat
 Comment[bg]=Протокол IRC
 Comment[hu]=IRC (Internet Relay Chat)
+Comment[ja]=インターネット・リレー・チャット
 Comment[pl]=IRC (Internet Relay Chat)
 Comment[pt_BR]=Protocolo de Bate-papo na Internet - IRC
 Comment[ru]=IRC
 Comment[sl]=Internet Relay Chat (»internetno prenešen klepet«)
 Comment[sr]=Ћаскање преко интернета
-Comment[sr@Latn]=Ћаскање преко интернета
+Comment[sr@Latn]=Ćaskanje preko interneta
 Comment[ta]=இணைய வழங்கும் அறட்டை
 Comment[tg]=IRC (Internet Relay Chat)
 Comment[zh_CN]=Internet 聊天
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/jabberprotocol.desktop kdepim/kaddressbook/editors/protocols/jabberprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/jabberprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/jabberprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול Jabber
 Comment[hu]=Jabber protokoll
 Comment[it]=Protocollo Jabber
+Comment[ja]=Jabber プロトコル
 Comment[nb]=Jabber protokoll
 Comment[nl]=Jabber-protocol
 Comment[nn]=Jabber-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol Jabber
 Comment[sl]=Protokol Jabber
 Comment[sr]=Jabber протокол
-Comment[sr@Latn]=Jabber протокол
+Comment[sr@Latn]=Jabber protokol
 Comment[sv]=Jabber-protokoll
 Comment[ta]=ஜாபர் நெறிமுறை
 Comment[tg]=протоколи Jabber
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/msnprotocol.desktop kdepim/kaddressbook/editors/protocols/msnprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/msnprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/msnprotocol.desktop	Sun Oct  3 15:37:51 2004
@@ -11,5 +11,6 @@
 Name=MSN Messenger
 Name[bg]=MSN
 Name[cy]=Negesydd MSN
+Name[ja]=MSN メッセンジャー
 Name[ta]=MSN மெசஞ்சர்
 
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/smsprotocol.desktop kdepim/kaddressbook/editors/protocols/smsprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/smsprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/smsprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול SMS
 Comment[hu]=SMS protokoll
 Comment[it]=Protocollo SMS
+Comment[ja]=SMS プロトコル
 Comment[nb]=SMS Protokoll
 Comment[nl]=SMS-protocol
 Comment[nn]=SMS-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol SMS
 Comment[sl]=Protokol SMS
 Comment[sr]=SMS протокол
-Comment[sr@Latn]=SMS протокол
+Comment[sr@Latn]=SMS protokol
 Comment[sv]=SMS-protokoll
 Comment[ta]=SMS நெறிமுறை
 Comment[tg]=протоколи SMS
diff -urN -x CVS kdepim.orig/kaddressbook/editors/protocols/yahooprotocol.desktop kdepim/kaddressbook/editors/protocols/yahooprotocol.desktop
--- kdepim.orig/kaddressbook/editors/protocols/yahooprotocol.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/editors/protocols/yahooprotocol.desktop	Mon Oct  4 15:26:06 2004
@@ -19,6 +19,7 @@
 Comment[he]=פרוטוקול Yahoo
 Comment[hu]=Yahoo protokoll
 Comment[it]=Protocollo Yahoo
+Comment[ja]=Yahoo プロトコル
 Comment[nb]=Yahoo Protokollen
 Comment[nl]=Yahoo-protocol
 Comment[nn]=Yahoo-protokoll
@@ -30,7 +31,7 @@
 Comment[sk]=Protokol Yahoo
 Comment[sl]=Protokol Yahoo
 Comment[sr]=Yahoo протокол
-Comment[sr@Latn]=Yahoo протокол
+Comment[sr@Latn]=Yahoo protokol
 Comment[sv]=Yahoo-protokoll
 Comment[ta]=Yahoo நெறிமுறை
 Comment[tg]=Протоколи Yahoo
diff -urN -x CVS kdepim.orig/kaddressbook/features/distributionlist.desktop kdepim/kaddressbook/features/distributionlist.desktop
--- kdepim.orig/kaddressbook/features/distributionlist.desktop	Fri Sep  3 15:56:38 2004
+++ kdepim/kaddressbook/features/distributionlist.desktop	Mon Oct  4 15:26:06 2004
@@ -30,7 +30,7 @@
 Name[sk]=KAB plugin distribučného zoznamu
 Name[sl]=Vstavek za distribucijski seznam KAB
 Name[sr]=Прикључак KAB-а за дистрибуционе листе
-Name[sr@Latn]=Dodatak KAB-a za distribucione liste
+Name[sr@Latn]=Priključak KAB-a za distribucione liste
 Name[sv]=Adressbokens insticksprogram för distributionslistor
 Name[ta]=KABயின் பகிர்ந்தளித்தல் பட்டியல் சொருகுப்பொருள்
 Name[tg]=Рӯйхати ба ҳар тараф мефиристодагӣ
@@ -71,7 +71,7 @@
 Comment[sk]=Plugin pre správu distribučných zoznamov
 Comment[sl]=Vstavek za upravljanje distribucijskih seznamov
 Comment[sr]=Прикључак за управљање дистрибуционим листама
-Comment[sr@Latn]=Dodatak za upravljanje distribucionim listama
+Comment[sr@Latn]=Priključak za upravljanje distribucionim listama
 Comment[sv]=Insticksprogram för att hantera distributionslistor
 Comment[ta]=பகிர்தல் பட்டியல் நிர்வகித்தலின் சொருகுப்பொருள்
 Comment[tg]=Кор бо рӯйхати ба ҳар тараф мефиристодагӣ
diff -urN -x CVS kdepim.orig/kaddressbook/features/distributionlistwidget.cpp kdepim/kaddressbook/features/distributionlistwidget.cpp
--- kdepim.orig/kaddressbook/features/distributionlistwidget.cpp	Sat May 15 10:02:04 2004
+++ kdepim/kaddressbook/features/distributionlistwidget.cpp	Wed Oct 13 00:58:53 2004
@@ -226,9 +226,10 @@
   KABC::DistributionList *list = mManager->list( oldName );
   list->setName( newName );
 
+  int pos = mNameCombo->currentItem();
   mNameCombo->clear();
   mNameCombo->insertStringList( mManager->listNames() );
-  mNameCombo->setCurrentItem( mNameCombo->count() - 1 );
+  mNameCombo->setCurrentItem( pos );
 
   updateContactView();
 
diff -urN -x CVS kdepim.orig/kaddressbook/features/resourceselection.desktop kdepim/kaddressbook/features/resourceselection.desktop
--- kdepim.orig/kaddressbook/features/resourceselection.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/features/resourceselection.desktop	Mon Oct  4 15:26:06 2004
@@ -15,6 +15,7 @@
 Name[he]=תוסף ניהול פנקסי כתובות
 Name[hu]=Címjegyzékkezelő bővítőmodul
 Name[it]=Plugin per gestire rubriche indirizzi
+Name[ja]=住所録管理プラグイン
 Name[nb]=Programtillegg for adressebok behandling
 Name[nl]=Plugin voor adresboekbeheer
 Name[nn]=Programtillegg for adressebokhandtering
@@ -25,7 +26,7 @@
 Name[sk]=Modul pre správu adresára
 Name[sl]=Vstavek Upravitelj adresarjev
 Name[sr]=Прикључак управљања адресаром
-Name[sr@Latn]=Прикључак управљања адресаром
+Name[sr@Latn]=Priključak upravljanja adresarom
 Name[sv]=Insticksprogram för adressbokshantering
 Name[ta]=முகவரி புத்தகம் மேலாண்மை சொருகுப்பொருள்
 Name[tg]=Идоракунии китоби адресӣ
@@ -45,6 +46,7 @@
 Comment[he]=תוסף המאפשר ניהול של פנקסי כתובות
 Comment[hu]=Bővítőmodul címjegyzékek kezeléséhez
 Comment[it]=Plugin per gestire rubriche indirizzi
+Comment[ja]=住所録管理用プラグイン
 Comment[nb]=Tilleggsprogram for å håndtere adressebøker
 Comment[nl]=Plugin voor het beheren van adresboeken
 Comment[nn]=Programtillegg for handtering av adressebøker
@@ -55,7 +57,7 @@
 Comment[sk]=Modul pre správu adresárov
 Comment[sl]=Vstavek za upravljanje adresarjev
 Comment[sr]=Прикључак за управљање адресарима
-Comment[sr@Latn]=Прикључак за управљање адресарима
+Comment[sr@Latn]=Priključak za upravljanje adresarima
 Comment[sv]=Insticksprogram för att hantera adressböcker
 Comment[ta]=பகிர்தல் பட்டியல் நிர்வகித்தலின் சொருகுப்பொருள்
 Comment[tg]=Идоракунии китобҳои адресӣ
diff -urN -x CVS kdepim.orig/kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop kdepim/kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop
--- kdepim.orig/kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/interfaces/kaddressbook_contacteditorwidget.desktop	Tue Oct  5 15:20:44 2004
@@ -5,6 +5,7 @@
 Comment=KAddressBook Contact Editor Widget Plugin
 Comment[bg]=Приставка за редактиране на контактите от адресника
 Comment[bs]=KAddressBook dodatak za prozor za izmjenu kontakta
+Comment[ca]=Endollable de l'estri editor de contactes de la llibreta d'adreces
 Comment[da]=KAddressBook plugin til kontakteditorkontrol
 Comment[de]=Addressbuch Kontakteditor-Widget Plugin
 Comment[es]=Accesorio de elemento de editor de contactos para KAddressBook
@@ -12,6 +13,7 @@
 Comment[fr]=Module d'édition de contacts de KAddressBook
 Comment[hu]=KAddressBook névjegyszerkesztő bővítőmodul
 Comment[it]=Plugin editor dei contatti di KAddressbook
+Comment[ja]=KAddressbook コンタクト エディター ウィジェット プラグイン
 Comment[nb]=KAddressbook programtillegg for kontakt redigeringselement
 Comment[nl]=KAddressBook Contacteditor-plugin
 Comment[nn]=Programtillegg for kontaktredigering i KDE-adresseboka
@@ -22,7 +24,7 @@
 Comment[sk]=KAddressBook modul pre editor kontaktov
 Comment[sl]=Vstavek gradnika urejevalnika stikov za Adresar
 Comment[sr]=KAddressBook прикључак контроле едитора контаката
-Comment[sr@Latn]=KAddressBook прикључак контроле едитора контаката
+Comment[sr@Latn]=KAddressBook priključak kontrole editora kontakata
 Comment[sv]=Kadressbok-insticksprogram för kontakteditor
 Comment[ta]=கேமுகவரிபுத்தகம் தொடர்பு தொகுப்பான் சாளர சொருகுப்பொருள்
 Comment[tg]=Муҳаррири алоқоти китоби адресии KDE
diff -urN -x CVS kdepim.orig/kaddressbook/interfaces/kaddressbook_extension.desktop kdepim/kaddressbook/interfaces/kaddressbook_extension.desktop
--- kdepim.orig/kaddressbook/interfaces/kaddressbook_extension.desktop	Tue Aug 24 08:31:47 2004
+++ kdepim/kaddressbook/interfaces/kaddressbook_extension.desktop	Mon Oct  4 15:26:07 2004
@@ -34,7 +34,7 @@
 Comment[sk]=KAddressBook plugin rozšírení
 Comment[sl]=Razširitveni vstavek za Adresar
 Comment[sr]=Прикључак KAddressBook-а за проширења
-Comment[sr@Latn]=Dodatak KAddressBook-a za proširenja
+Comment[sr@Latn]=Priključak KAddressBook-a za proširenja
 Comment[sv]=Kadressbok-utökningsinsticksprogram
 Comment[ta]=கேமுகவரிப்புத்தகம் விரிவாக்க சொருகுப்பொருள்
 Comment[tg]=Модули вусъатоти китоби адресии KDE
diff -urN -x CVS kdepim.orig/kaddressbook/interfaces/kaddressbook_xxport.desktop kdepim/kaddressbook/interfaces/kaddressbook_xxport.desktop
--- kdepim.orig/kaddressbook/interfaces/kaddressbook_xxport.desktop	Fri Sep  3 15:56:38 2004
+++ kdepim/kaddressbook/interfaces/kaddressbook_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -33,7 +33,7 @@
 Comment[sk]=KAddressBook import/export plugin
 Comment[sl]=Vstavek za uvoz in izvoz iz Adresarja
 Comment[sr]=Прикључак KAddressBook-а за увоз/извоз 
-Comment[sr@Latn]=Dodatak KAddressBook-a za uvoz/izvoz 
+Comment[sr@Latn]=Priključak KAddressBook-a za uvoz/izvoz 
 Comment[sv]=Kadressbok-insticksprogram för import/export
 Comment[ta]=கேமுகவரிப்புத்தகம் ஏற்றுமதி/இறக்குமதி சொருகுப்பொருள்
 Comment[tg]=Содирот ва воридоти китоби адрес
diff -urN -x CVS kdepim.orig/kaddressbook/kabcore.cpp kdepim/kaddressbook/kabcore.cpp
--- kdepim.orig/kaddressbook/kabcore.cpp	Sun Oct  3 00:10:46 2004
+++ kdepim/kaddressbook/kabcore.cpp	Thu Oct 14 23:28:06 2004
@@ -820,7 +820,7 @@
   }
 
   if ( !mLdapSearchDialog ) {
-    mLdapSearchDialog = new LDAPSearchDialog( mAddressBook, mWidget );
+    mLdapSearchDialog = new LDAPSearchDialog( mAddressBook, this, mWidget );
     connect( mLdapSearchDialog, SIGNAL( addresseesAdded() ), mSearchManager,
             SLOT( addressBookChanged() ) );
     connect( mLdapSearchDialog, SIGNAL( addresseesAdded() ),
diff -urN -x CVS kdepim.orig/kaddressbook/kaddressbook_view.desktop kdepim/kaddressbook/kaddressbook_view.desktop
--- kdepim.orig/kaddressbook/kaddressbook_view.desktop	Tue Aug 24 08:31:45 2004
+++ kdepim/kaddressbook/kaddressbook_view.desktop	Mon Oct  4 15:26:05 2004
@@ -34,7 +34,7 @@
 Comment[sk]=KAddressBook plugin prehliadača
 Comment[sl]=Vstavek za ogled v Adresarju
 Comment[sr]=Прикључак KAddressBook-а за преглед
-Comment[sr@Latn]=Dodatak KAddressBook-a za pregled
+Comment[sr@Latn]=Priključak KAddressBook-a za pregled
 Comment[sv]=Kadressbok-visningsinsticksprogram
 Comment[ta]=கேமுகவரிப்புத்தகம் காட்சி சொருகுப்பொருள்
 Comment[tg]=Модули намоиши китоби адресии KDE
diff -urN -x CVS kdepim.orig/kaddressbook/kcmconfigs/kabconfig.desktop kdepim/kaddressbook/kcmconfigs/kabconfig.desktop
--- kdepim.orig/kaddressbook/kcmconfigs/kabconfig.desktop	Fri Sep  3 15:56:38 2004
+++ kdepim/kaddressbook/kcmconfigs/kabconfig.desktop	Thu Oct 14 15:36:08 2004
@@ -3,6 +3,7 @@
 Icon=kaddressbook
 Type=Service
 ServiceTypes=KCModule
+DocPath=kaddressbook/preferences.html
 
 X-KDE-ModuleType=Library
 X-KDE-Library=kabconfig
diff -urN -x CVS kdepim.orig/kaddressbook/kcmconfigs/kabcustomfields.desktop kdepim/kaddressbook/kcmconfigs/kabcustomfields.desktop
--- kdepim.orig/kaddressbook/kcmconfigs/kabcustomfields.desktop	Thu Sep 30 16:03:48 2004
+++ kdepim/kaddressbook/kcmconfigs/kabcustomfields.desktop	Thu Oct 14 15:36:08 2004
@@ -3,7 +3,7 @@
 Icon=dlgedit
 Type=Service
 ServiceTypes=KCModule
-DocPath=
+DocPath=kaddressbook/preferences.html
 
 X-KDE-ModuleType=Library
 X-KDE-Library=kabcustomfields
@@ -28,6 +28,7 @@
 Name[hu]=Egyéni lapok
 Name[is]=Sérsniðnar síður
 Name[it]=Pagine personalizzate
+Name[ja]=カスタム ページ
 Name[nb]=Tilpassede sider
 Name[nl]=Aangepaste pagina's
 Name[nn]=Tilpassa sider
@@ -38,7 +39,7 @@
 Name[sk]=Vlastné stránky
 Name[sl]=Prilagojene strani
 Name[sr]=Произвољне странице
-Name[sr@Latn]=Произвољне странице
+Name[sr@Latn]=Proizvoljne stranice
 Name[sv]=Egna sidor
 Name[ta]=தனிபயன் பக்கங்கள்
 Name[tg]=Варақаҳои замимавии истифодашаванда
@@ -59,6 +60,7 @@
 Comment[hu]=Az egyéni lapok beállítása
 Comment[is]=Stilla sérsniðnu síðurnar
 Comment[it]=Configura le pagine personalizzate
+Comment[ja]=カスタム ページの設定
 Comment[nb]=Konfigurere de tilpassede sidene
 Comment[nl]=Hier kunt u de aangepaste pagina's instellen
 Comment[nn]=Set opp dei tilpassa sidene
@@ -69,7 +71,7 @@
 Comment[sk]=Nastavenie vlastných stránok
 Comment[sl]=Nastavi prilagojene strani
 Comment[sr]=Подешавање произвољних страница
-Comment[sr@Latn]=Подешавање произвољних страница
+Comment[sr@Latn]=Podešavanje proizvoljnih stranica
 Comment[sv]=Anpassa egna sidor
 Comment[ta]=தனிபயன் பக்கங்களை கட்டமை
 Comment[tg]=Танзимоти варақаҳои замимавии истифодашаванда
@@ -90,6 +92,7 @@
 Keywords[hu]=kaddressbook, beállítás, beállítások, egyéni mezők
 Keywords[is]=kaddressbook, stillingar, stilla, sérsniðnir reitir
 Keywords[it]=kaddressbook, configura, impostazioni, campi personalizzati
+Keywords[ja]=kaddressbook、設定、設定,カスタムフィールド
 Keywords[nb]=kaddressbook, sette opp, innstillinger
 Keywords[nl]=adresboek,KAB,kab,kaddressbook,instellingen,configuratie,aangepaste velden
 Keywords[nn]=adressebok, oppsett, innstillingar, tilpassa felt
@@ -100,7 +103,7 @@
 Keywords[sk]=kaddressbook,nastavenie,vlastné polia
 Keywords[sl]=kaddressbook, adresar, nastavi, nastavitve, polja, prilagojena
 Keywords[sr]=kaddressbook, подеси, поставке, произвољна поља
-Keywords[sr@Latn]=kaddressbook, подеси, поставке, произвољна поља
+Keywords[sr@Latn]=kaddressbook, podesi, postavke, proizvoljna polja
 Keywords[sv]=adressbok, anpassa, inställningar, egna fält
 Keywords[ta]=கேமுகவரிப்புத்தகம்,கட்டமை, அமைவுகள், தனிபயன் புலங்கள்
 Keywords[tg]=kaddressbook,китоби адрес,танзимот
diff -urN -x CVS kdepim.orig/kaddressbook/ldapsearchdialog.cpp kdepim/kaddressbook/ldapsearchdialog.cpp
--- kdepim.orig/kaddressbook/ldapsearchdialog.cpp	Thu Jul 22 19:27:00 2004
+++ kdepim/kaddressbook/ldapsearchdialog.cpp	Thu Oct 14 23:24:57 2004
@@ -18,6 +18,7 @@
  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA
  */
 
+
 #include <qcheckbox.h>
 #include <qgroupbox.h>
 #include <qheader.h>
@@ -34,7 +35,9 @@
 #include <klocale.h>
 #include <kmessagebox.h>
 
+#include "kabcore.h"
 #include "ldapsearchdialog.h"
+#include "kablock.h"
 
 static QString asUtf8( const QByteArray &val )
 {
@@ -108,11 +111,11 @@
     }
 };
 
-LDAPSearchDialog::LDAPSearchDialog( KABC::AddressBook *ab, QWidget* parent,
-                                            const char* name )
+LDAPSearchDialog::LDAPSearchDialog( KABC::AddressBook *ab, KABCore *core,
+                                    QWidget* parent, const char* name )
   : KDialogBase( Plain, i18n( "Search for Addresses in Directory" ), Help | User1 |
     User2 | User3 | Cancel, Default, parent, name, false, true ),
-    mAddressBook( ab )
+    mAddressBook( ab ), mCore( core )
 {
   setButtonCancel( KStdGuiItem::close() );
   QFrame *page = plainPage();
@@ -453,6 +456,11 @@
 
 void LDAPSearchDialog::slotUser3()
 {
+  
+  KABC::Resource *resource = mCore->requestResource( this );
+  if ( !resource ) return;
+  KABLock::self( mAddressBook )->lock( resource );
+
   ContactListItem* cli = static_cast<ContactListItem*>( mResultListView->firstChild() );
   while ( cli ) {
     if ( cli->isSelected() ) {
@@ -510,13 +518,15 @@
       pagerNr.setType( KABC::PhoneNumber::Pager );
       addr.insertPhoneNumber( pagerNr );
 
-      if ( mAddressBook )
+      if ( mAddressBook ) {
+        addr.setResource( resource );
         mAddressBook->insertAddressee( addr );
+      }
     }
-
     cli = static_cast<ContactListItem*>( cli->nextSibling() );
   }
 
+  KABLock::self( mAddressBook )->unlock( resource );
   emit addresseesAdded();
 }
 
diff -urN -x CVS kdepim.orig/kaddressbook/ldapsearchdialog.h kdepim/kaddressbook/ldapsearchdialog.h
--- kdepim.orig/kaddressbook/ldapsearchdialog.h	Sat Jul  3 23:56:33 2004
+++ kdepim/kaddressbook/ldapsearchdialog.h	Thu Oct 14 23:24:57 2004
@@ -34,13 +34,14 @@
 class QCheckBox;
 class QListView;
 class QPushButton;
+class KABCore;
 
 class LDAPSearchDialog : public KDialogBase
 { 
   Q_OBJECT
 
   public:
-    LDAPSearchDialog( KABC::AddressBook *ab, QWidget* parent, const char* name = 0 );
+    LDAPSearchDialog( KABC::AddressBook *ab, KABCore *core, QWidget* parent, const char* name = 0 );
     ~LDAPSearchDialog();
 
     bool isOK() const { return mIsOK; }
@@ -78,6 +79,7 @@
     QPtrList<KPIM::LdapClient> mLdapClientList;
     bool mIsOK;
     KABC::AddressBook *mAddressBook;
+    KABCore *mCore;
 
     KComboBox* mFilterCombo;
     KComboBox* mSearchType;
diff -urN -x CVS kdepim.orig/kaddressbook/viewmanager.cpp kdepim/kaddressbook/viewmanager.cpp
--- kdepim.orig/kaddressbook/viewmanager.cpp	Thu Jun 17 02:06:09 2004
+++ kdepim/kaddressbook/viewmanager.cpp	Thu Oct 14 09:56:39 2004
@@ -437,6 +437,10 @@
   KABC::VCardConverter converter;
   QString vcards = converter.createVCards( addrList );
 
+  // Best text representation is given by textdrag, so it must be first
+  drag->addDragObject( new QTextDrag( AddresseeUtil::addresseesToEmails( addrList ), this ) );
+  drag->addDragObject( new KVCardDrag( vcards, this ) );
+
   KTempDir tempDir;
   if ( tempDir.status() == 0 ) {
     QString fileName;
@@ -455,9 +459,6 @@
     }
   }
 
-  drag->addDragObject( new KVCardDrag( vcards, this ) );
-  drag->addDragObject( new QTextDrag( AddresseeUtil::addresseesToEmails( addrList ), this ) );
-
   drag->setPixmap( KGlobal::iconLoader()->loadIcon( "vcard", KIcon::Desktop ) );
   drag->dragCopy();
 }
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/bookmark_xxport.desktop kdepim/kaddressbook/xxport/bookmark_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/bookmark_xxport.desktop	Fri Sep  3 15:56:39 2004
+++ kdepim/kaddressbook/xxport/bookmark_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -29,7 +29,7 @@
 Name[sk]=KAB modul pre xxport záložiek
 Name[sl]=Vstavek KAB Bookmark XXPort
 Name[sr]=XXPort прикључак KAB-а за маркере
-Name[sr@Latn]=XXPort dodatak KAB-a za markere
+Name[sr@Latn]=XXPort priključak KAB-a za markere
 Name[sv]=Adressbokens överföringsinsticksprogram för bokmärken
 Name[ta]=KAB புக்மார்க் ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Содироти поягузор
@@ -66,7 +66,7 @@
 Comment[sk]=Modul pre export webových adries kontaktov ako záložiek
 Comment[sl]=Vstavek za izvoz spletnih naslovov stikov v obliki zaznamkov
 Comment[sr]=Прикључак за извоз веб-адреса контаката као маркера
-Comment[sr@Latn]=Dodatak za izvoz veb-adresa kontakata kao markera
+Comment[sr@Latn]=Priključak za izvoz veb-adresa kontakata kao markera
 Comment[sv]=Insticksprogram för export av kontaktwebbadresser som bokmärken
 Comment[ta]=இணைய முகவரிகளின் தொடர்புகளை புத்தக குறிப்புகளாக ஏற்றுவதற்கு சொருகுப்பொருள்
 Comment[tg]=Модул барои содироти веб-адресҳои алоқа ҳамчун поягузор
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/csv_xxport.desktop kdepim/kaddressbook/xxport/csv_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/csv_xxport.desktop	Fri Sep  3 15:56:39 2004
+++ kdepim/kaddressbook/xxport/csv_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -27,7 +27,7 @@
 Name[ru]=Экспорт/импорт в файлы CSV
 Name[sl]=Vstavek KAB CSV XXPort
 Name[sr]=XXPort прикључак KAB-а за CSV
-Name[sr@Latn]=XXPort dodatak KAB-a za CSV
+Name[sr@Latn]=XXPort priključak KAB-a za CSV
 Name[sv]=Adressbokens CSV-överföringsinsticksprogram
 Name[ta]=KAB CSV ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Содирот/воридот ба файлҳои CSV
@@ -65,7 +65,7 @@
 Comment[sk]=Modul pre import a export kontaktov vo formáte CSV
 Comment[sl]=Vstavek za uvoz in izvoz stikov v obliki CSV
 Comment[sr]=Прикључак за увоз и извоз контаката у CSV формат
-Comment[sr@Latn]=Dodatak za uvoz i izvoz kontakata u CSV format
+Comment[sr@Latn]=Priključak za uvoz i izvoz kontakata u CSV format
 Comment[sv]=Insticksprogram för import och export av kontakter med CSV-format
 Comment[ta]=CSV வடிவத்தில் ஏற்றுமதி மற்றும் இறக்குமதி தொடர்புகளுக்கான சொருகுப்பொருள்
 Comment[tg]=Модул барои воридот ва содироти алоқа ба формати CSV
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/eudora_xxport.desktop kdepim/kaddressbook/xxport/eudora_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/eudora_xxport.desktop	Fri Sep  3 15:56:39 2004
+++ kdepim/kaddressbook/xxport/eudora_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -28,7 +28,7 @@
 Name[sk]=KAB modul pre xxport Eudora
 Name[sl]=Vstavek KAB Eudora XXPort
 Name[sr]=XXPort прикључак KAB-а за Eudora-у
-Name[sr@Latn]=XXPort dodatak KAB-a za Eudora-u
+Name[sr@Latn]=XXPort priključak KAB-a za Eudora-u
 Name[sv]=Adressbokens Eudora-överföringsinsticksprogram
 Name[ta]=KAB யுடோரா XXபோர்ட் சொருகுப்பொருள்
 Name[tg]=Мубодилаи иттилоот бо Eudora
@@ -67,7 +67,7 @@
 Comment[sk]=Modul pre import a export kontaktov Eudora
 Comment[sl]=Vstavek za uvoz in izvoz stikov Eudore
 Comment[sr]=Прикључак за увоз и извоз Eudora контаката
-Comment[sr@Latn]=Dodatak za uvoz i izvoz Eudora kontakata
+Comment[sr@Latn]=Priključak za uvoz i izvoz Eudora kontakata
 Comment[sv]=Insticksprogram för import och export av Eudora-kontakter
 Comment[ta]=யுடோரா ஏற்றுமதி மற்றும் இறக்குமதி செய்ய சொருகுப்பொருள்
 Comment[tg]=Модул барои воридот ва содироти алоқаи Eudora
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/gnokii_xxport.desktop kdepim/kaddressbook/xxport/gnokii_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/gnokii_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/gnokii_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -29,7 +29,7 @@
 Name[sk]=KAB modul pre xxport z mobilu
 Name[sl]=Vstavek KAB Mobile Phone XXPort
 Name[sr]=XXPort прикључак KAB-а за мобилне телефоне
-Name[sr@Latn]=XXPort dodatak KAB-a za mobilne telefone
+Name[sr@Latn]=XXPort priključak KAB-a za mobilne telefone
 Name[sv]=Adressbokens överföringsinsticksprogram för mobiltelefon
 Name[ta]=KAB நடமாடும் தொலைபேசி XXபோர்ட் சொருகுப்பொருள்
 Name[tg]=Синхронизатсия бо телефони мобилӣ
@@ -66,7 +66,7 @@
 Comment[sk]=Modul pre import a export kontaktov z modulu
 Comment[sl]=Vstavek za uvoz in izvoz vnosov v adresarju prenosnih telefonov.
 Comment[sr]=Прикључак за увоз и извоз ставки из адресара у мобилни телефон
-Comment[sr@Latn]=Dodatak za uvoz i izvoz stavki iz adresara u mobilni telefon
+Comment[sr@Latn]=Priključak za uvoz i izvoz stavki iz adresara u mobilni telefon
 Comment[sv]=Insticksprogram för import och export av adressboksposter till mobiltelefon
 Comment[ta]=முகவரி புத்தகத்தின் உள்ளிடுகளை ஏற்றுமதி மற்றும் இறக்குமதி செய்ய செல்பேசி மூலம் சொருகுப்பொருள்
 Comment[tg]=Модул барои воридот ва содироти алоқаи телефони мобилӣ
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/kde2_xxport.desktop kdepim/kaddressbook/xxport/kde2_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/kde2_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/kde2_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -28,7 +28,7 @@
 Name[ru]=Импорт адресной книги KDE2
 Name[sl]=Vstavek KAB KDE2 XXPort
 Name[sr]=XXPort прикључак KAB-а за KDE2
-Name[sr@Latn]=XXPort dodatak KAB-a za KDE2
+Name[sr@Latn]=XXPort priključak KAB-a za KDE2
 Name[sv]=Adressbokens KDE 2-överföringsinsticksprogram
 Name[ta]=KAB KDE2  ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Воридоти китоби адресии KDE2
@@ -66,7 +66,7 @@
 Comment[sk]=Plugin pre import starej knihy adries z KDE 2
 Comment[sl]=Vstavek za uvoz starih adresarjev iz KDE 2
 Comment[sr]=Прикључак за увоз старог KDE 2 адресара
-Comment[sr@Latn]=Dodatak za uvoz starog KDE 2 adresara
+Comment[sr@Latn]=Priključak za uvoz starog KDE 2 adresara
 Comment[sv]=Insticksprogram för import av den gamla KDE 2 adressboken
 Comment[ta]=பழைய KDE 2 கேமுகவரிபுத்தகத்தை ஏற்றுமதி செய்ய சொருகுப்பொருள்
 Comment[tg]=Модул барои воридоти файлҳои китобиадресии KDE2
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/ldif_xxport.desktop kdepim/kaddressbook/xxport/ldif_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/ldif_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/ldif_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -29,7 +29,7 @@
 Name[sk]=KAB modul pre xxport LDIF
 Name[sl]=Vstavek KAB LDIF XXPort
 Name[sr]=XXPort прикључак KAB-а за LDIF
-Name[sr@Latn]=XXPort dodatak KAB-a za LDIF
+Name[sr@Latn]=XXPort priključak KAB-a za LDIF
 Name[sv]=Adressbokens LDIF-överföringsinsticksprogram
 Name[ta]=KAB LDIF சோதனை சொருகுப்பொருள்
 Name[tg]=Мубодилаи иттилоот аз KDE2
@@ -67,7 +67,7 @@
 Comment[sk]=Modul pre import a export kontaktov z Netscape a Mozilla formátu LDIF
 Comment[sl]=Vstavek za uvoz in izvoz stikov v obliki LDIF (Netscape in Mozilla)
 Comment[sr]=Прикључак за увоз и извоз контаката у Netscape и Mozilla LDIF формат
-Comment[sr@Latn]=Dodatak za uvoz i izvoz kontakata u Netscape i Mozilla LDIF format
+Comment[sr@Latn]=Priključak za uvoz i izvoz kontakata u Netscape i Mozilla LDIF format
 Comment[sv]=Insticksprogram för import och export av kontakter med Netscapes och Mozillas LDIF-format
 Comment[ta]=நெட்ஸ்கேப் மற்றும் மொசில்லா LDIF வடிவமைப்பை ஏற்றுமதி/இறக்குமதியில் தொடர்புக்கொள்ள சொருகுப்பொருள்
 Comment[tg]=Модул барои воридот ва содироти алоқа аз формати LDIF Netscape ва Mozilla
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/opera_xxport.desktop kdepim/kaddressbook/xxport/opera_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/opera_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/opera_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -27,7 +27,7 @@
 Name[sk]=KAB modul pre xxport z Opera
 Name[sl]=Vstavek KAB Opera XXPort
 Name[sr]=XXPort прикључак KAB-а за Opera-у
-Name[sr@Latn]=XXPort dodatak KAB-a za Opera-u
+Name[sr@Latn]=XXPort priključak KAB-a za Opera-u
 Name[sv]=AdressbokensOpera-överföringsinsticksprogram
 Name[ta]=KAB ஓப்பெரா ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Мубодилаи иттилоот бо Opera
@@ -65,7 +65,7 @@
 Comment[sk]=Plugin pre import kontaktov z Opera
 Comment[sl]=Vstavek za uvoz stikov iz Opere
 Comment[sr]=Прикључак за увоз Opera контаката
-Comment[sr@Latn]=Dodatak za uvoz Opera kontakata
+Comment[sr@Latn]=Priključak za uvoz Opera kontakata
 Comment[sv]=Insticksprogram för import av Opera-kontakter
 Comment[ta]=ஓப்பெரா தொடர்புகளை இறக்குமதி செய்ய சொருகுப்பொருள்
 Comment[tg]=Модул барои воридоти алоқаи Opera
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/pab_xxport.desktop kdepim/kaddressbook/xxport/pab_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/pab_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/pab_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -28,7 +28,7 @@
 Name[sk]=KAB modul pre xxport z osobného adresára MS Exchange
 Name[sl]=Vstavek KAB MS Exchange Personal Addressbook XXPort
 Name[sr]=XXPort прикључак KAB-а за MS Exchange лични адресар
-Name[sr@Latn]=XXPort dodatak KAB-a za MS Exchange lični adresar
+Name[sr@Latn]=XXPort priključak KAB-a za MS Exchange lični adresar
 Name[sv]=Adressbokens överföringsinsticksprogram för MS Exchange personlig adressbok
 Name[ta]=KAB MS Exchange Personal Address Books ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Воридоти алоқаҳои MS Exchange
@@ -65,7 +65,7 @@
 Comment[sk]=Modul pre import osobných adresárov MS Exchange
 Comment[sl]=Vstavek za uvoz osebnih adresarjev MS Exchange
 Comment[sr]=Прикључак за увоз MS Exchange личних адресара
-Comment[sr@Latn]=Dodatak za uvoz MS Exchange ličnih adresara
+Comment[sr@Latn]=Priključak za uvoz MS Exchange ličnih adresara
 Comment[sv]=Insticksprogram för import av MS Exchange personliga adressböcker
 Comment[ta]=MS Exchange Personal Address Books இறக்குமதி செய்ய சொருகுப்பொருள்
 Comment[tg]=Модул барои воридоти китобҳои адреси шахсии MS Exchange
diff -urN -x CVS kdepim.orig/kaddressbook/xxport/vcard_xxport.desktop kdepim/kaddressbook/xxport/vcard_xxport.desktop
--- kdepim.orig/kaddressbook/xxport/vcard_xxport.desktop	Wed Sep 29 16:06:23 2004
+++ kdepim/kaddressbook/xxport/vcard_xxport.desktop	Mon Oct  4 15:26:07 2004
@@ -28,7 +28,7 @@
 Name[sk]=KAB modul pre xxport z vCard
 Name[sl]=Vstavek KAB vCard XXPort
 Name[sr]=XXPort прикључак KAB-а за vCard
-Name[sr@Latn]=XXPort dodatak KAB-a za vCard
+Name[sr@Latn]=XXPort priključak KAB-a za vCard
 Name[sv]=Adressbokens vCard-överföringsinsticksprogram
 Name[ta]=kab vஅட்டைxxபோர்ட் சொருகுப்பொருள்
 Name[tg]=Кор бо vCard
@@ -66,7 +66,7 @@
 Comment[sk]=Plugin pre import a export kontaktov v vCard formáte
 Comment[sl]=Vstavek za uvoz in izvoz stikov v obliki vCard
 Comment[sr]=Прикључак за увоз и извоз контаката у vCard формат
-Comment[sr@Latn]=Dodatak za uvoz i izvoz kontakata u vCard format
+Comment[sr@Latn]=Priključak za uvoz i izvoz kontakata u vCard format
 Comment[sv]=Insticksprogram för import och export av kontakter med vCard-format
 Comment[ta]=ஏற்றுமதி மற்றும் இறக்குமதி தொடர்புகளை vஅட்டை வடிவமைப்பில் செலுத்த சொருகுப்பொருள்
 Comment[tg]=Модул барои воридот ва содироти алоқот ба формати vCard
diff -urN -x CVS kdepim.orig/kalarm/templatedlg.cpp kdepim/kalarm/templatedlg.cpp
--- kdepim.orig/kalarm/templatedlg.cpp	Sat Jul 24 16:00:01 2004
+++ kdepim/kalarm/templatedlg.cpp	Fri Oct 15 00:39:46 2004
@@ -25,6 +25,7 @@
 #include <qwhatsthis.h>
 
 #include <klocale.h>
+#include <kguiitem.h>
 #include <kmessagebox.h>
 #include <kdebug.h>
 
diff -urN -x CVS kdepim.orig/kandy/src/kandy.desktop kdepim/kandy/src/kandy.desktop
--- kdepim.orig/kandy/src/kandy.desktop	Thu Sep 30 16:03:51 2004
+++ kdepim/kandy/src/kandy.desktop	Mon Oct  4 15:26:09 2004
@@ -17,6 +17,7 @@
 Comment[he]=כלי לסנכרון המידע של פנקס הכתובות על טלפונים נידיים
 Comment[hu]=Segédprogram számítógép és mobiltelefon címjegyzékének szinkronizálásához
 Comment[it]=Strumento per sincronizzare i dati della rubrica indirizzi con i telefoni cellulari
+Comment[ja]=携帯電話を備えた住所録データを同期するためのツール
 Comment[nl]=Hulpmiddel om adresboekgegevens te synchroniseren met mobiele telefoons
 Comment[nn]=Verktøy for å synkronisera adresseboka med mobiltelefonar
 Comment[pl]=Narzędzie do synchronizacji książki adresowej z telefonami komórkowymi
@@ -26,7 +27,7 @@
 Comment[sk]=Nástroj pre synchronizáciu adresára s mobilmi
 Comment[sl]=Orodje za usklajevanje podatkov adresarja z mobilnim telefonom
 Comment[sr]=Алат за синхронизацију адресара са мобилним телефонима
-Comment[sr@Latn]=Алат за синхронизацију адресара са мобилним телефонима
+Comment[sr@Latn]=Alat za sinhronizaciju adresara sa mobilnim telefonima
 Comment[sv]=Verktyg för att synkronisera adressboksdata med mobiltelefoner
 Comment[ta]= செல்பேசி கொண்ட முகவரி புத்தக தரவின் ஒன்றிணைக்கப்படுவதற்கான கருவி
 Comment[tg]=Барномаи синхронизатсияи китоби адресӣ бо телефони мобилӣ
diff -urN -x CVS kdepim.orig/kfile-plugins/palm-databases/kfile_palm.desktop kdepim/kfile-plugins/palm-databases/kfile_palm.desktop
--- kdepim.orig/kfile-plugins/palm-databases/kfile_palm.desktop	Thu Sep 30 16:03:53 2004
+++ kdepim/kfile-plugins/palm-databases/kfile_palm.desktop	Mon Oct  4 15:26:11 2004
@@ -15,6 +15,7 @@
 Name[hu]=PalmOS adatbázis-jellemzők
 Name[is]=PalmOS gagnagrunnsupplýsingar
 Name[it]=Informazioni database PalmOs
+Name[ja]=PalmOS データベース 情報
 Name[nb]=PalmOS Database info
 Name[nl]=PalmOS-database informatie
 Name[nn]=PalmOS-databaseinfo
@@ -25,7 +26,7 @@
 Name[sk]=Informácie o databázach PalmOS
 Name[sl]=Informacije zbirke podatkov za PalmOS
 Name[sr]=Информације о PalmOS базама података
-Name[sr@Latn]=Информације о PalmOS базама података
+Name[sr@Latn]=Informacije o PalmOS bazama podataka
 Name[sv]=PalmOS-databasinformation
 Name[ta]=பால்ம்OS தரவுத்தள தகவல்
 Name[tg]=Иттилоот дар бораи бонки додаҳои PalmOS
diff -urN -x CVS kdepim.orig/kitchensync/devicemimetypes/cellphone.desktop kdepim/kitchensync/devicemimetypes/cellphone.desktop
--- kdepim.orig/kitchensync/devicemimetypes/cellphone.desktop	Thu Sep 30 16:03:55 2004
+++ kdepim/kitchensync/devicemimetypes/cellphone.desktop	Mon Oct  4 15:26:13 2004
@@ -17,6 +17,7 @@
 Comment[hu]=Csatlakoztatott mobiltelefon
 Comment[is]=Tengdur farsími
 Comment[it]=Telefono cellulare connesso
+Comment[ja]=携帯電話に接続しました
 Comment[nb]=Tilkoblet mobiltelefon
 Comment[nl]=Verbonden mobiele telefoon
 Comment[nn]=Tilkopla mobiltelefon
@@ -27,7 +28,7 @@
 Comment[sk]=Pripojený mobil
 Comment[sl]=Povezan mobilni telefon
 Comment[sr]=Повезан мобилни телефон
-Comment[sr@Latn]=Повезан мобилни телефон
+Comment[sr@Latn]=Povezan mobilni telefon
 Comment[sv]=Ansluten mobiltelefon
 Comment[ta]=செல்பேசியுடன் இணைக்கப்பட்டுள்ளது
 Comment[tg]=Телефони сотавии пайвастшуда
diff -urN -x CVS kdepim.orig/kitchensync/kitchensync/backup/restore.desktop kdepim/kitchensync/kitchensync/backup/restore.desktop
--- kdepim.orig/kitchensync/kitchensync/backup/restore.desktop	Thu Sep 30 16:03:55 2004
+++ kdepim/kitchensync/kitchensync/backup/restore.desktop	Tue Oct  5 15:20:46 2004
@@ -2,6 +2,7 @@
 Type=Service
 Name=Konnector Restore
 Name[bs]=Konnector osvježi
+Name[ca]=Recuperació de còpia de seguretat Konnector
 Name[da]=Konnector genopret
 Name[de]=Konnector-Wiederhestellung
 Name[es]=Konnector para restauración
@@ -10,6 +11,7 @@
 Name[he]=שחזור של Konnector
 Name[hu]=Konnector helyreállítás
 Name[it]=Ripristina Konnector
+Name[ja]=Konnector 回復
 Name[nb]=Konnector gjenoppretting
 Name[nl]=Konnector-herstel
 Name[nn]=Konnector-gjenoppretting
@@ -19,7 +21,7 @@
 Name[sk]=Obnova Konnector
 Name[sl]=Povrnitev Konnectorja
 Name[sr]=Konnector поврати
-Name[sr@Latn]=Konnector поврати
+Name[sr@Latn]=Konnector povrati
 Name[sv]=Konnector återställning
 Name[ta]=இணைப்பானைத் திரும்பப் பெறுதல் 
 Name[tg]=Барқарор кардани Konnector
diff -urN -x CVS kdepim.orig/kitchensync/kitchensync/viewer/viewer.desktop kdepim/kitchensync/kitchensync/viewer/viewer.desktop
--- kdepim.orig/kitchensync/kitchensync/viewer/viewer.desktop	Thu Sep 30 16:03:56 2004
+++ kdepim/kitchensync/kitchensync/viewer/viewer.desktop	Mon Oct  4 15:26:14 2004
@@ -13,6 +13,7 @@
 Name[hu]=Adatnézegető
 Name[is]=Gagnaskoðari
 Name[it]=Vista dati
+Name[ja]=データ ビューワ
 Name[nb]=Datavisning
 Name[nl]=Gegevensweergave
 Name[nn]=Datavising
@@ -23,7 +24,7 @@
 Name[sk]=Prehliadač dát
 Name[sl]=Pregledovalnik podatkov
 Name[sr]=Приказивач података
-Name[sr@Latn]=Приказивач података
+Name[sr@Latn]=Prikazivač podataka
 Name[sv]=Datavisning
 Name[ta]=தரவு காட்சியகம்
 Name[tg]=Намоиши маълумот
diff -urN -x CVS kdepim.orig/kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop kdepim/kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop
--- kdepim.orig/kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop	Thu Sep 30 16:03:56 2004
+++ kdepim/kitchensync/libkonnector2/plugins/kabc/kabckonnector.desktop	Tue Oct  5 15:20:47 2004
@@ -6,6 +6,7 @@
 
 Name=AddressBook Konnector
 Name[bs]=Adresar Konnector
+Name[ca]=Llibreta d'adreces Konnector
 Name[cs]=Konektor Knihy adres
 Name[de]=Adressbuch Konnektor
 Name[es]=Konnector para libreta de direcciones
@@ -13,6 +14,7 @@
 Name[fr]=Konnector pour le carnet d'adresses
 Name[hu]=Címjegyzék-konnektor
 Name[it]=Konnector AddressBook
+Name[ja]=住所録 Konnector
 Name[nb]=Addressebok Konnector
 Name[nl]=Adresboek Konnector
 Name[nn]=TIlkopling til adressebok
@@ -23,7 +25,7 @@
 Name[sk]=Konnector pre adresár
 Name[sl]=Konektor za Adresar
 Name[sr]=Адресар Konnector
-Name[sr@Latn]=Адресар Konnector
+Name[sr@Latn]=Adresar Konnector
 Name[sv]=Adressbok Konnector
 Name[ta]=முகவரிப்புத்தக இணைப்புகள்
 Name[tg]=Коннектор ба китоби адрес
diff -urN -x CVS kdepim.orig/kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop kdepim/kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop
--- kdepim.orig/kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop	Thu Sep 30 16:03:56 2004
+++ kdepim/kitchensync/libkonnector2/plugins/kcal/kcalkonnector.desktop	Tue Oct  5 15:20:47 2004
@@ -6,6 +6,7 @@
 
 Name=Calendar Konnector
 Name[bs]=Kalendar Konnector
+Name[ca]=Calendari Konnector
 Name[cs]=Konektor kalendáře
 Name[da]=Kalenderforbinder
 Name[de]=Kalender Konnector
@@ -14,6 +15,7 @@
 Name[fr]=Konnector pour l'agenda
 Name[hu]=Naptár-konnektor
 Name[it]=Konnector calendario
+Name[ja]=カレンダー Konnector
 Name[nb]=Kalender Konnector
 Name[nl]=Agenda Konnector
 Name[nn]=Tilkopling til kalender
@@ -24,7 +26,7 @@
 Name[sk]=Konnector pre kalendár
 Name[sl]=Konektor za koledar
 Name[sr]=Календар Konnector
-Name[sr@Latn]=Календар Konnector
+Name[sr@Latn]=Kalendar Konnector
 Name[sv]=Kalender Konnector
 Name[ta]=நாள்காட்டி இணைப்பான்
 Name[tg]=Конекктор
diff -urN -x CVS kdepim.orig/kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop kdepim/kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop
--- kdepim.orig/kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop	Thu Sep 30 16:03:57 2004
+++ kdepim/kitchensync/libkonnector2/plugins/remote/remotekonnector.desktop	Tue Oct  5 15:20:47 2004
@@ -6,6 +6,7 @@
 
 Name=Remote Konnector
 Name[bs]=Udaljeni Konnector
+Name[ca]=Konnector remot
 Name[cs]=Vzdálený konektor
 Name[da]=Ekstern konnector
 Name[de]=Fern-Konnector
@@ -15,6 +16,7 @@
 Name[he]=Konnector מרוחק
 Name[hu]=Távoli konnektor
 Name[it]=Konnector remoto
+Name[ja]=リモート Konnector
 Name[nb]=Ekstern Konnector
 Name[nl]=Konnector op afstand
 Name[nn]=Ekstern tilkopling
@@ -25,7 +27,7 @@
 Name[sk]=Vzdialený Konnector
 Name[sl]=Oddaljeni Konnector
 Name[sr]=Удаљени Konnector
-Name[sr@Latn]=Удаљени Konnector
+Name[sr@Latn]=Udaljeni Konnector
 Name[sv]=Fjärr-Konnector
 Name[ta]=தொலைதூர இணைப்பான்
 Name[tg]=Коннектори ҳузфшуда
diff -urN -x CVS kdepim.orig/kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop kdepim/kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop
--- kdepim.orig/kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop	Tue Aug 31 09:23:10 2004
+++ kdepim/kitchensync/libkonnector2/plugins/threadedkonnector/threadedkonnector.desktop	Tue Oct  5 15:20:48 2004
@@ -6,7 +6,7 @@
 
 Name=Demo konnector for a threaded implementation
 Name[bs]=Demo konnector za implementaciju threadova
-Name[ca]=Demostració de konnector per a una implementació per fils
+Name[ca]=Demostració de konnector per a una implementació amb fils
 Name[cy]=Kysylltydd arddangosol ar gyfer weithredoliant edafeddedig
 Name[da]=Demo-konnector for en trådet implementation
 Name[de]=Demo-Konnector zur Implementierung von Threads
diff -urN -x CVS kdepim.orig/kmail/Makefile.am kdepim/kmail/Makefile.am
--- kdepim.orig/kmail/Makefile.am	Fri Jul 30 16:13:13 2004
+++ kdepim/kmail/Makefile.am	Tue Oct 19 09:03:19 2004
@@ -19,7 +19,8 @@
 	../libkdenetwork/libkdenetwork.la ../libkdepim/libkdepim.la \
 	../libkpimidentities/libkpimidentities.la ../mimelib/libmimelib.la \
 	../libksieve/libksieve.la \
-	../certmanager/lib/libkleopatra.la
+	../certmanager/lib/libkleopatra.la \
+        ../libkcal/libkcal.la
 
 kde_module_LTLIBRARIES = kcm_kmail.la libkmailpart.la libkmail_bodypartformatter_application_octetstream.la
 libkmailpart_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -version-info 1:0 -no-undefined
@@ -49,8 +50,6 @@
 		kmreaderwin.cpp htmlstatusbar.cpp kmmsgdict.cpp \
 		kmgroupware.cpp folderstorage.cpp \
 		csshelper.cpp klistboxdialog.cpp \
-		signatureconfigurationdialog.ui \
-		encryptionconfigurationdialog.ui \
 		actionscheduler.cpp messageproperty.cpp \
 		kmmsgpart.cpp kmmsginfo.cpp \
 		kmacctmgr.cpp kmacctfolder.cpp kmdict.cpp \
@@ -71,9 +70,6 @@
 		vacationdialog.cpp vacation.cpp sieveconfig.cpp sievejob.cpp \
 		kmpopheaders.cpp kmpopfiltercnfrmdlg.cpp \
 		kmmimeparttree.cpp \
-		certificatehandlingdialog.ui \
-		certificatehandlingdialogimpl.cpp \
-		certificatewizard.ui certificatewizardimpl.cpp \
 		mailinglist-magic.cpp kmacctmaildir.cpp \
 		attachmentstrategy.cpp \
 		headerstrategy.cpp headerstyle.cpp khtmlparthtmlwriter.cpp \
@@ -81,8 +77,7 @@
                 mailcomposerIface.skel objecttreeparser.cpp \
 		attachmentcollector.cpp \
 		bodypartformatter.cpp bodypartformatterfactory.cpp \
-		partNode.cpp signatureconfigurationdialogimpl.cpp \
-		encryptionconfigurationdialogimpl.cpp mailsourceviewer.cpp \
+		partNode.cpp mailsourceviewer.cpp \
 		kmcommands.cpp kmreadermainwin.cpp \
 		kmstartup.cpp kmmainwidget.cpp \
                 folderpropertiesdialog.ui kmfolderindex.cpp \
diff -urN -x CVS kdepim.orig/kmail/antispamwizard.cpp kdepim/kmail/antispamwizard.cpp
--- kdepim.orig/kmail/antispamwizard.cpp	Fri Sep 24 22:54:04 2004
+++ kdepim/kmail/antispamwizard.cpp	Mon Oct 11 10:48:08 2004
@@ -502,6 +502,11 @@
     mConfig = new KConfig( "kmail.antivirusrc", true );
 }
 
+AntiSpamWizard::ConfigReader::~ConfigReader( )
+{
+  delete mConfig;
+}
+
 
 void AntiSpamWizard::ConfigReader::readAndMergeConfig()
 {
diff -urN -x CVS kdepim.orig/kmail/antispamwizard.h kdepim/kmail/antispamwizard.h
--- kdepim.orig/kmail/antispamwizard.h	Tue Jul 13 23:07:18 2004
+++ kdepim/kmail/antispamwizard.h	Mon Oct 11 10:48:08 2004
@@ -196,6 +196,7 @@
           ConfigReader( WizardMode mode,
                         QValueList<SpamToolConfig> & configList );
 
+	~ConfigReader( );
           QValueList<SpamToolConfig> & getToolList() { return mToolList; }
 
           void readAndMergeConfig();
diff -urN -x CVS kdepim.orig/kmail/application_octetstream.desktop kdepim/kmail/application_octetstream.desktop
--- kdepim.orig/kmail/application_octetstream.desktop	Thu Sep 30 16:03:59 2004
+++ kdepim/kmail/application_octetstream.desktop	Tue Oct  5 15:20:50 2004
@@ -1,9 +1,11 @@
 [Misc]
 Encoding=UTF-8
 Name=Application Octetstream
+Name[ca]=Aplicació Octetstream
 Name[da]=Program oktetstrøm
 Name[es]=Aplicación en flujo de octetos
 Name[hu]=Alkalmazás-adatfolyam
+Name[ja]=アプリケーション オクテット ストリーム
 Name[nb]=Program Octetstrøm
 Name[nl]=Applicatie octetstroom
 Name[nn]=Oktettstraum frå program
@@ -13,7 +15,7 @@
 Name[ru]=Бинарный поток приложения
 Name[sl]=Programski Octetstream
 Name[sr]=Апликација Octetstream
-Name[sr@Latn]=Апликација Octetstream
+Name[sr@Latn]=Aplikacija Octetstream
 Name[sv]=Program-oktettström
 Name[ta]=பயன்பாட்டு எண்மம்
 Name[tg]=Миқдори зиёди бинарии барномот
@@ -21,6 +23,7 @@
 Comment=A bodypart formatter plugin for application/octet-stream
 Comment[bg]=Приставка за форматиране на двоични данни
 Comment[bs]=Dodatak za formatiranje tijela poruke za application/octet-stream
+Comment[ca]=Un endollable formatador del cos per application/octet-stream
 Comment[da]=Et bodypart formateringsplugin for application/octet-stream
 Comment[de]=Ein Bodypart-Formatierplugin für application/octet-stream
 Comment[es]=Un accesorio de formato para el cuerpo de application/octet-stream
@@ -28,6 +31,7 @@
 Comment[fr]=Un module formateur de partie du coprs pourr application/octet-stream
 Comment[hu]=Formázómodul application/octet-stream típusú adatfolyamokhoz
 Comment[it]=Un plugin per formattare application/octet-stream
+Comment[ja]=application/octet-stream の Bodypart フォーマッタプラグイン
 Comment[nb]=Et meldingstekst formaterings programtillegg for application/octet-stream
 Comment[nl]=Een opmaakplugin voor application/octet-stream
 Comment[nn]=Eit programtillegg for formatering av meldingstekst i application/octet-stream
@@ -38,7 +42,7 @@
 Comment[sk]=Formátovač tela pre MIME typ application/octet-stream
 Comment[sl]=Oblikovni vstavek za application/octet-stream
 Comment[sr]=Прукључак форматер тела application/octet-stream тока
-Comment[sr@Latn]=Прукључак форматер тела application/octet-stream тока
+Comment[sr@Latn]=Pruključak formater tela application/octet-stream toka
 Comment[sv]=Ett insticksprogram för brevtextformatering av application/octet-stream
 Comment[ta]=பயன்பாடு அல்லது எண்மத்திற்கான அங்க அமைப்பு சொருகி
 Comment[tg]=Модули ба андозадарории application/octet-stream
diff -urN -x CVS kdepim.orig/kmail/bodypartformatter.cpp kdepim/kmail/bodypartformatter.cpp
--- kdepim.orig/kmail/bodypartformatter.cpp	Thu May 27 00:47:32 2004
+++ kdepim/kmail/bodypartformatter.cpp	Mon Oct 18 11:31:03 2004
@@ -107,12 +107,10 @@
 
   CREATE_BODY_PART_FORMATTER(TextPlain)
   CREATE_BODY_PART_FORMATTER(TextHtml)
-  CREATE_BODY_PART_FORMATTER(TextVCal)
   //CREATE_BODY_PART_FORMATTER(TextEnriched)
 
   CREATE_BODY_PART_FORMATTER(ApplicationOctetStream)
   CREATE_BODY_PART_FORMATTER(ApplicationPkcs7Mime)
-  //CREATE_BODY_PART_FORMATTER(ApplicationMsTnef)
   //CREATE_BODY_PART_FORMATTER(ApplicationPgp)
 
   CREATE_BODY_PART_FORMATTER(MessageRfc822)
@@ -145,14 +143,12 @@
   { "octet-stream", &ApplicationOctetStreamBodyPartFormatter::create },
   { "pkcs7-mime", &ApplicationPkcs7MimeBodyPartFormatter::create },
   { "x-pkcs7-mime", &ApplicationPkcs7MimeBodyPartFormatter::create },
-  //{ "ms-tnef", &ApplicationMsTnefBodyPartFormatter::create },
   { "pgp", &ApplicationPgpBodyPartFormatter::create },
 };
 
 static const SubtypeBuiltin textSubtypeBuiltins[] = {
   { "html", &TextHtmlBodyPartFormatter::create },
   //{ "enriched", &TextEnrichedBodyPartFormatter::create },
-  { "calendar", &TextVCalBodyPartFormatter::create },
   { "x-vcard", &AnyTypeBodyPartFormatter::create },
   { "vcard", &AnyTypeBodyPartFormatter::create },
   { "rtf", &AnyTypeBodyPartFormatter::create },
@@ -220,11 +216,6 @@
       if ( qstricmp( subtype, "html" ) == 0 )
 	return TextHtmlBodyPartFormatter::create();
       break;
-    case 'c':
-    case 'C':
-      if ( qstricmp( subtype, "calendar" ) == 0 )
-	return TextVCalBodyPartFormatter::create();
-      break;
     case 'r':
     case 'R':
       if ( qstricmp( subtype, "rtf" ) == 0 )
diff -urN -x CVS kdepim.orig/kmail/callback.cpp kdepim/kmail/callback.cpp
--- kdepim.orig/kmail/callback.cpp	Sat Sep 18 00:20:59 2004
+++ kdepim/kmail/callback.cpp	Fri Oct  8 09:56:47 2004
@@ -69,10 +69,6 @@
    * has been sent successfully. Set a link header which accomplishes that. */
   msg->link( mMsg, KMMsgStatusDeleted );
 
-  KMComposeWin *cWin = new KMComposeWin(msg);
-  // cWin->setCharset( "", true );
-  cWin->slotWordWrapToggled( false );
-
   // Outlook will only understand the reply if the From: header is the
   // same as the To: header of the invitation message.
   KConfigGroup options( KMKernel::config(), "Groupware" );
@@ -83,8 +79,13 @@
     if( identity != KPIM::Identity::null )
       // Identity found. Use this
       msg->setFrom( identity.fullEmailAddr() );
+      msg->setHeaderField("X-KMail-Identity", QString::number( identity.uoid() ));
   }
 
+  KMComposeWin *cWin = new KMComposeWin(msg);
+  // cWin->setCharset( "", true );
+  cWin->slotWordWrapToggled( false );
+
   // TODO: These are no longer available. It was an internal
   // implementation detail of kmcomposewin, anyway. Please find
   // another way...
diff -urN -x CVS kdepim.orig/kmail/certificatehandlingdialog.ui kdepim/kmail/certificatehandlingdialog.ui
--- kdepim.orig/kmail/certificatehandlingdialog.ui	Thu Dec 26 08:54:21 2002
+++ kdepim/kmail/certificatehandlingdialog.ui	Thu Jan  1 01:00:00 1970
@@ -1,230 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>CertificateHandlingDialog</class>
-<widget class="QWidget">
-    <property name="name">
-        <cstring>CertificateHandlingDialog</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>533</width>
-            <height>330</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Certificate Management</string>
-    </property>
-    <grid>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <property name="margin">
-            <number>11</number>
-        </property>
-        <property name="spacing">
-            <number>6</number>
-        </property>
-        <widget class="QLabel" row="0" column="0" rowspan="1" colspan="2">
-            <property name="name">
-                <cstring>TextLabel8</cstring>
-            </property>
-            <property name="text">
-                <string>Certificate used for signing messages:</string>
-            </property>
-        </widget>
-        <widget class="QLabel" row="1" column="2" rowspan="1" colspan="3">
-            <property name="name">
-                <cstring>encryptCertLA</cstring>
-            </property>
-            <property name="sizePolicy">
-                <sizepolicy>
-                    <hsizetype>3</hsizetype>
-                    <vsizetype>5</vsizetype>
-                    <horstretch>0</horstretch>
-                    <verstretch>0</verstretch>
-                </sizepolicy>
-            </property>
-            <property name="frameShape">
-                <enum>WinPanel</enum>
-            </property>
-            <property name="frameShadow">
-                <enum>Sunken</enum>
-            </property>
-            <property name="text">
-                <string>---</string>
-            </property>
-        </widget>
-        <widget class="QLabel" row="0" column="2" rowspan="1" colspan="3">
-            <property name="name">
-                <cstring>signCertLA</cstring>
-            </property>
-            <property name="sizePolicy">
-                <sizepolicy>
-                    <hsizetype>3</hsizetype>
-                    <vsizetype>5</vsizetype>
-                    <horstretch>0</horstretch>
-                    <verstretch>0</verstretch>
-                </sizepolicy>
-            </property>
-            <property name="frameShape">
-                <enum>WinPanel</enum>
-            </property>
-            <property name="frameShadow">
-                <enum>Sunken</enum>
-            </property>
-            <property name="text">
-                <string>---</string>
-            </property>
-        </widget>
-        <widget class="QLabel" row="1" column="0" rowspan="1" colspan="2">
-            <property name="name">
-                <cstring>TextLabel10</cstring>
-            </property>
-            <property name="text">
-                <string>Certificate used for encrypting messages:</string>
-            </property>
-        </widget>
-        <widget class="QListView" row="2" column="0" rowspan="1" colspan="5">
-            <column>
-                <property name="text">
-                    <string>Certificate</string>
-                </property>
-                <property name="clickable">
-                    <bool>true</bool>
-                </property>
-                <property name="resizable">
-                    <bool>true</bool>
-                </property>
-            </column>
-            <column>
-                <property name="text">
-                    <string>Checksum</string>
-                </property>
-                <property name="clickable">
-                    <bool>true</bool>
-                </property>
-                <property name="resizable">
-                    <bool>true</bool>
-                </property>
-            </column>
-            <column>
-                <property name="text">
-                    <string>Possible Usage</string>
-                </property>
-                <property name="clickable">
-                    <bool>true</bool>
-                </property>
-                <property name="resizable">
-                    <bool>true</bool>
-                </property>
-            </column>
-            <column>
-                <property name="text">
-                    <string>Current Usage</string>
-                </property>
-                <property name="clickable">
-                    <bool>true</bool>
-                </property>
-                <property name="resizable">
-                    <bool>true</bool>
-                </property>
-            </column>
-            <property name="name">
-                <cstring>certificatesLV</cstring>
-            </property>
-        </widget>
-        <widget class="QPushButton" row="3" column="0">
-            <property name="name">
-                <cstring>useForEncryptingPB</cstring>
-            </property>
-            <property name="enabled">
-                <bool>false</bool>
-            </property>
-            <property name="text">
-                <string>Use for &amp;Encrypting</string>
-            </property>
-        </widget>
-        <widget class="QPushButton" row="3" column="1" rowspan="1" colspan="2">
-            <property name="name">
-                <cstring>useForSigningPB</cstring>
-            </property>
-            <property name="enabled">
-                <bool>false</bool>
-            </property>
-            <property name="text">
-                <string>Use for &amp;Signing</string>
-            </property>
-        </widget>
-        <widget class="QPushButton" row="3" column="3">
-            <property name="name">
-                <cstring>requestPB</cstring>
-            </property>
-            <property name="text">
-                <string>&amp;Request...</string>
-            </property>
-        </widget>
-        <widget class="QPushButton" row="3" column="4">
-            <property name="name">
-                <cstring>deletePB</cstring>
-            </property>
-            <property name="enabled">
-                <bool>false</bool>
-            </property>
-            <property name="text">
-                <string>&amp;Delete</string>
-            </property>
-        </widget>
-    </grid>
-</widget>
-<connections>
-    <connection>
-        <sender>certificatesLV</sender>
-        <signal>selectionChanged(QListViewItem*)</signal>
-        <receiver>CertificateHandlingDialog</receiver>
-        <slot>slotCertificateSelectionChanged(QListViewItem*)</slot>
-    </connection>
-    <connection>
-        <sender>useForSigningPB</sender>
-        <signal>clicked()</signal>
-        <receiver>CertificateHandlingDialog</receiver>
-        <slot>slotUseForSigning()</slot>
-    </connection>
-    <connection>
-        <sender>useForEncryptingPB</sender>
-        <signal>clicked()</signal>
-        <receiver>CertificateHandlingDialog</receiver>
-        <slot>slotUseForEncrypting()</slot>
-    </connection>
-    <connection>
-        <sender>deletePB</sender>
-        <signal>clicked()</signal>
-        <receiver>CertificateHandlingDialog</receiver>
-        <slot>slotDeleteCertificate()</slot>
-    </connection>
-</connections>
-<includes>
-    <include location="global" impldecl="in implementation">qpopupmenu.h</include>
-    <include location="local" impldecl="in implementation">certificatehandlingdialog.ui.h</include>
-</includes>
-<forwards>
-    <forward>class QPopupMenu;</forward>
-</forwards>
-<variables>
-    <variable>QPopupMenu* requestPopup;</variable>
-</variables>
-<slots>
-    <slot access="protected">slotDeleteCertificate()</slot>
-    <slot access="protected">slotCertificateSelectionChanged( QListViewItem * )</slot>
-    <slot access="protected">slotRequestChangedCertificate()</slot>
-    <slot access="protected">slotRequestExtendedCertificate()</slot>
-    <slot access="protected">slotRequestNewCertificate()</slot>
-    <slot access="protected">slotUseForEncrypting()</slot>
-    <slot access="protected">slotUseForSigning()</slot>
-    <slot access="private">slotRequestMenu( int id )</slot>
-</slots>
-<functions>
-    <function access="private" specifier="non virtual">init()</function>
-</functions>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
diff -urN -x CVS kdepim.orig/kmail/certificatehandlingdialog.ui.h kdepim/kmail/certificatehandlingdialog.ui.h
--- kdepim.orig/kmail/certificatehandlingdialog.ui.h	Thu Nov 28 16:49:44 2002
+++ kdepim/kmail/certificatehandlingdialog.ui.h	Thu Jan  1 01:00:00 1970
@@ -1,70 +0,0 @@
-/****************************************************************************
-** ui.h extension file, included from the uic-generated form implementation.
-**
-** If you wish to add, delete or rename functions respectively slots use
-** Qt Designer which will update this file, preserving your code. Create an
-** init() function in place of a constructor, and a destroy() function in
-** place of a destructor.
-*****************************************************************************/
-
-void CertificateHandlingDialog::init()
-{
-    requestPopup = new QPopupMenu(this);
-    requestPopup->insertItem(i18n("New"), 0);
-    requestPopup->insertItem(i18n("Extension"), 1);
-    requestPopup->insertItem(i18n("Change"), 2);
-    
-    requestPB->setPopup(requestPopup);
-}
-
-void CertificateHandlingDialog::slotDeleteCertificate()
-{
-
-}
-
-void CertificateHandlingDialog::slotCertificateSelectionChanged( QListViewItem * )
-{
-
-}
-
-void CertificateHandlingDialog::slotRequestChangedCertificate()
-{
-
-}
-
-void CertificateHandlingDialog::slotRequestExtendedCertificate()
-{
-
-}
-
-void CertificateHandlingDialog::slotRequestNewCertificate()
-{
-
-}
-
-void CertificateHandlingDialog::slotUseForEncrypting()
-{
-
-}
-
-void CertificateHandlingDialog::slotUseForSigning()
-{
-
-}
-
-
-void CertificateHandlingDialog::slotRequestMenu( int id )
-{
-    switch (id)
-    {
-    case 0:
-	slotRequestNewCertificate();
-	break;
-    case 1:
-	slotRequestExtendedCertificate();
-	break;
-    case 2:
-	slotRequestChangedCertificate();
-	break;
-    };
-}
diff -urN -x CVS kdepim.orig/kmail/certificatehandlingdialogimpl.cpp kdepim/kmail/certificatehandlingdialogimpl.cpp
--- kdepim.orig/kmail/certificatehandlingdialogimpl.cpp	Sun Jan 11 22:57:07 2004
+++ kdepim/kmail/certificatehandlingdialogimpl.cpp	Thu Jan  1 01:00:00 1970
@@ -1,170 +0,0 @@
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-
-#include "certificatehandlingdialogimpl.h"
-#include "certificatewizardimpl.h"
-
-#include <qlistview.h>
-#include <qpopupmenu.h>
-#include <qpushbutton.h>
-#include <qlabel.h>
-
-#include <klocale.h>
-#include <kdebug.h>
-/*
- *  Constructs a CertificateHandlingDialogImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- */
-CertificateHandlingDialogImpl::CertificateHandlingDialogImpl( QWidget* parent,  const char* name, WFlags fl )
-    : CertificateHandlingDialog( parent, name, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-CertificateHandlingDialogImpl::~CertificateHandlingDialogImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotDeleteCertificate()
-{
-    // PENDING(khz) Add code to delete certificate.
-
-    QListViewItem* item = certificatesLV->selectedItem();
-    Q_ASSERT( item );
-    delete item;
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotCertificateSelectionChanged( QListViewItem* item )
-{
-    if( item ) {
-        requestPopup->setItemEnabled(1, true);
-        requestPopup->setItemEnabled(2, true);
-        deletePB->setEnabled( true );
-        if( item->text( 2 ) == i18n( "Sign/Encrypt" ) ) {
-            useForSigningPB->setEnabled( true );
-            useForEncryptingPB->setEnabled( true );
-        } else if( item->text( 2 ) == i18n( "Sign" ) ) {
-            useForSigningPB->setEnabled( true );
-            useForEncryptingPB->setEnabled( false );
-        } else if( item->text( 2 ) == i18n( "Encrypt" ) ) {
-            useForSigningPB->setEnabled( false );
-            useForEncryptingPB->setEnabled( true );
-        } else {
-            // should not happen, such a certificate would be pretty useless
-            useForSigningPB->setEnabled( false );
-            useForEncryptingPB->setEnabled( false );
-        }
-    } else {
-        useForSigningPB->setEnabled( false );
-        useForEncryptingPB->setEnabled( false );
-        requestPopup->setItemEnabled(1, false);
-        requestPopup->setItemEnabled(2, true);
-        deletePB->setEnabled( false );
-    }
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotRequestChangedCertificate()
-{
-    // PENDING(khz) Send change request to CA
-    kdWarning() << "CertificateHandlingDialogImpl::slotRequestChangedCertificate() not yet implemented!" << endl;
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotRequestExtendedCertificate()
-{
-    // PENDING(khz) Send extension request CA
-    kdWarning() << "CertificateHandlingDialogImpl::slotRequestExtendedCertificate() not yet implemented!" << endl;
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotRequestNewCertificate()
-{
-    CertificateWizardImpl wizard;
-    if( wizard.exec() == QDialog::Accepted ) {
-        // PENDING(khz) Handle the created certificates.
-
-        // Insert a dummy certificate.
-        // PENDING(khz) Remove this code.
-        new QListViewItem( certificatesLV, "BlahCertificate", "0x58643BFE", i18n( "Sign/Encrypt" ) );
-    }
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotUseForEncrypting()
-{
-    QListViewItem* item = certificatesLV->selectedItem();
-    Q_ASSERT( item );
-    if( item ) {
-        // show the used certificate in label
-        encryptCertLA->setText( item->text( 0 ) );
-
-        // iterate over the listview and reset all usage markings
-        QListViewItemIterator it( certificatesLV );
-        QListViewItem* current;
-        while( ( current = it.current() ) ) {
-            if( current->text( 3 ) == i18n( "Sign/Encrypt" ) )
-                current->setText( 3, i18n( "Sign" ) );
-            else if( current->text( 3 ) == i18n( "Encrypt" ) )
-                current->setText( 3, "" );
-            ++it;
-        }
-
-        // mark the current one as used
-        if( item->text( 3 ) == i18n( "Sign" ) )
-            item->setText( 3, i18n( "Sign/Encrypt" ) );
-        else if( item->text( 3 ).isEmpty() )
-            item->setText( 3, i18n( "Encrypt" ) );
-    }
-}
-
-/*
- * protected slot
- */
-void CertificateHandlingDialogImpl::slotUseForSigning()
-{
-    QListViewItem* item = certificatesLV->selectedItem();
-    Q_ASSERT( item );
-    if( item ) {
-        // show the used certificate in label
-        signCertLA->setText( item->text( 0 ) );
-
-        // iterate over the listview and reset all usage markings
-        QListViewItemIterator it( certificatesLV );
-        QListViewItem* current;
-        while( ( current = it.current() ) ) {
-            ++it;
-            if( current->text( 3 ) == i18n( "Sign/Encrypt" ) )
-                current->setText( 3, i18n( "Encrypt" ) );
-            else if( current->text( 3 ) == i18n( "Sign" ) )
-                current->setText( 3, "" );
-        }
-
-        // mark the current one as used
-        if( item->text( 3 ) == i18n( "Encrypt" ) )
-            item->setText( 3, i18n( "Sign/Encrypt" ) );
-        else if( item->text( 3 ).isEmpty() )
-            item->setText( 3, i18n( "Sign" ) );
-    }
-}
-
-
-#include "certificatehandlingdialogimpl.moc"
diff -urN -x CVS kdepim.orig/kmail/certificatehandlingdialogimpl.h kdepim/kmail/certificatehandlingdialogimpl.h
--- kdepim.orig/kmail/certificatehandlingdialogimpl.h	Mon Apr 22 08:04:06 2002
+++ kdepim/kmail/certificatehandlingdialogimpl.h	Thu Jan  1 01:00:00 1970
@@ -1,24 +0,0 @@
-#ifndef CERTIFICATEHANDLINGDIALOGIMPL_H
-#define CERTIFICATEHANDLINGDIALOGIMPL_H
-#include "certificatehandlingdialog.h"
-
-class CertificateHandlingDialogImpl : public CertificateHandlingDialog
-{ 
-    Q_OBJECT
-
-public:
-    CertificateHandlingDialogImpl( QWidget* parent = 0, const char* name = 0, WFlags fl = 0 );
-    ~CertificateHandlingDialogImpl();
-
-protected slots:
-    void slotDeleteCertificate();
-    void slotCertificateSelectionChanged( QListViewItem* );
-    void slotRequestChangedCertificate();
-    void slotRequestExtendedCertificate();
-    void slotRequestNewCertificate();
-    void slotUseForEncrypting();
-    void slotUseForSigning();
-
-};
-
-#endif // CERTIFICATEHANDLINGDIALOGIMPL_H
diff -urN -x CVS kdepim.orig/kmail/certificatewizard.ui kdepim/kmail/certificatewizard.ui
--- kdepim.orig/kmail/certificatewizard.ui	Tue Feb  3 20:43:16 2004
+++ kdepim/kmail/certificatewizard.ui	Thu Jan  1 01:00:00 1970
@@ -1,373 +0,0 @@
-<!DOCTYPE UI><UI version="3.2" stdsetdef="1">
-<class>CertificateWizard</class>
-<widget class="QWizard">
-    <property name="name">
-        <cstring>CertificateWizard</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>705</width>
-            <height>444</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Certificate Wizard</string>
-    </property>
-    <property name="titleFont">
-        <font>
-            <pointsize>16</pointsize>
-            <bold>1</bold>
-        </font>
-    </property>
-    <widget class="QWidget">
-        <property name="name">
-            <cstring>page</cstring>
-        </property>
-        <attribute name="title">
-            <string>Certificate Wizard</string>
-        </attribute>
-        <vbox>
-            <property name="name">
-                <cstring>unnamed</cstring>
-            </property>
-            <property name="margin">
-                <number>11</number>
-            </property>
-            <property name="spacing">
-                <number>6</number>
-            </property>
-            <widget class="QLabel">
-                <property name="name">
-                    <cstring>TextLabel1</cstring>
-                </property>
-                <property name="text">
-                    <string>&lt;b&gt;Welcome to the Certificate Wizard.&lt;/b&gt;
-&lt;br&gt;
-&lt;br&gt;
-In a few easy steps, this wizard will help you with the creation of a certificate. You use your certificates in order to sign messages, to encrypt messages and to decrypt messages that other people send to you in encrypted form.
-&lt;p&gt;
-The certificates can either be generated in a centralized or a decentralized manner. Please contact your local help desk if you are unsure how to create a certificate in your organization.</string>
-                </property>
-            </widget>
-        </vbox>
-    </widget>
-    <widget class="QWidget">
-        <property name="name">
-            <cstring>page</cstring>
-        </property>
-        <attribute name="title">
-            <string>Your Personal Data</string>
-        </attribute>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>TextLabel2</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>11</x>
-                    <y>11</y>
-                    <width>456</width>
-                    <height>123</height>
-                </rect>
-            </property>
-            <property name="text">
-                <string>On this page, you will enter some personal data that will be stored in your certificate and that will help other people to determine that it is actually you who is sending a message.</string>
-            </property>
-            <property name="alignment">
-                <set>WordBreak|AlignVCenter</set>
-            </property>
-        </widget>
-        <widget class="QLineEdit">
-            <property name="name">
-                <cstring>nameED</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>130</x>
-                    <y>143</y>
-                    <width>336</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="toolTip" stdset="0">
-                <string>Enter your name here</string>
-            </property>
-            <property name="whatsThis" stdset="0">
-                <string>Enter your name here as it should be shown in the certificate.</string>
-            </property>
-        </widget>
-        <widget class="QLineEdit">
-            <property name="name">
-                <cstring>organizationED</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>130</x>
-                    <y>173</y>
-                    <width>336</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="toolTip" stdset="0">
-                <string>Enter your organization here</string>
-            </property>
-            <property name="whatsThis" stdset="0">
-                <string>Enter your organization (e.g. your company, your department, or your authority) here as it should appear on the certificate.</string>
-            </property>
-        </widget>
-        <widget class="QLineEdit">
-            <property name="name">
-                <cstring>departmentED</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>130</x>
-                    <y>203</y>
-                    <width>336</width>
-                    <height>22</height>
-                </rect>
-            </property>
-        </widget>
-        <widget class="QLineEdit">
-            <property name="name">
-                <cstring>emailED</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>130</x>
-                    <y>233</y>
-                    <width>336</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="toolTip" stdset="0">
-                <string>Enter your email address here</string>
-            </property>
-            <property name="whatsThis" stdset="0">
-                <string>Enter the email address here which you want to use in connection with the certificate.</string>
-            </property>
-        </widget>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>nameLA</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>12</x>
-                    <y>143</y>
-                    <width>110</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="text">
-                <string>&amp;Name:</string>
-            </property>
-            <property name="buddy" stdset="0">
-                <cstring>nameED</cstring>
-            </property>
-        </widget>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>departmentLA</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>12</x>
-                    <y>203</y>
-                    <width>110</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="text">
-                <string>&amp;Department:</string>
-            </property>
-            <property name="buddy" stdset="0">
-                <cstring>departmentED</cstring>
-            </property>
-        </widget>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>emailLA</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>12</x>
-                    <y>233</y>
-                    <width>110</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="text">
-                <string>&amp;Email address:</string>
-            </property>
-            <property name="buddy" stdset="0">
-                <cstring>emailED</cstring>
-            </property>
-        </widget>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>organizationLA</cstring>
-            </property>
-            <property name="geometry">
-                <rect>
-                    <x>10</x>
-                    <y>170</y>
-                    <width>110</width>
-                    <height>22</height>
-                </rect>
-            </property>
-            <property name="text">
-                <string>&amp;Organization:</string>
-            </property>
-            <property name="buddy" stdset="0">
-                <cstring>organizationED</cstring>
-            </property>
-        </widget>
-    </widget>
-    <widget class="QWidget">
-        <property name="name">
-            <cstring>page</cstring>
-        </property>
-        <attribute name="title">
-            <string>Certificate Generation</string>
-        </attribute>
-        <vbox>
-            <property name="name">
-                <cstring>unnamed</cstring>
-            </property>
-            <property name="margin">
-                <number>11</number>
-            </property>
-            <property name="spacing">
-                <number>6</number>
-            </property>
-            <widget class="QLabel">
-                <property name="name">
-                    <cstring>TextLabel4</cstring>
-                </property>
-                <property name="text">
-                    <string>On this page, you will select whether certificate generation is done centralized or decentralized. Please check with your local help desk if you are unsure what to select here.</string>
-                </property>
-                <property name="alignment">
-                    <set>WordBreak|AlignVCenter</set>
-                </property>
-            </widget>
-            <widget class="QButtonGroup">
-                <property name="name">
-                    <cstring>ButtonGroup7</cstring>
-                </property>
-                <property name="title">
-                    <string>Certificate &amp;Generation</string>
-                </property>
-                <vbox>
-                    <property name="name">
-                        <cstring>unnamed</cstring>
-                    </property>
-                    <property name="margin">
-                        <number>11</number>
-                    </property>
-                    <property name="spacing">
-                        <number>6</number>
-                    </property>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>centralizedRB</cstring>
-                        </property>
-                        <property name="text">
-                            <string>&amp;Centralized generation</string>
-                        </property>
-                    </widget>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>decentralizedRB</cstring>
-                        </property>
-                        <property name="text">
-                            <string>&amp;Decentralized generation</string>
-                        </property>
-                        <property name="checked">
-                            <bool>true</bool>
-                        </property>
-                    </widget>
-                    <widget class="QLayoutWidget">
-                        <property name="name">
-                            <cstring>Layout9</cstring>
-                        </property>
-                        <hbox>
-                            <property name="name">
-                                <cstring>unnamed</cstring>
-                            </property>
-                            <property name="margin">
-                                <number>0</number>
-                            </property>
-                            <property name="spacing">
-                                <number>6</number>
-                            </property>
-                            <widget class="QLabel">
-                                <property name="name">
-                                    <cstring>TextLabel5</cstring>
-                                </property>
-                                <property name="text">
-                                    <string>&amp;Email address of the CA that issues certificates:</string>
-                                </property>
-                                <property name="buddy" stdset="0">
-                                    <cstring>caEmailED</cstring>
-                                </property>
-                            </widget>
-                            <widget class="QLineEdit">
-                                <property name="name">
-                                    <cstring>caEmailED</cstring>
-                                </property>
-                            </widget>
-                        </hbox>
-                    </widget>
-                </vbox>
-            </widget>
-        </vbox>
-    </widget>
-    <widget class="QWidget">
-        <property name="name">
-            <cstring>page</cstring>
-        </property>
-        <attribute name="title">
-            <string>Your Certificate is Ready to Be Sent</string>
-        </attribute>
-        <vbox>
-            <property name="name">
-                <cstring>unnamed</cstring>
-            </property>
-            <property name="margin">
-                <number>11</number>
-            </property>
-            <property name="spacing">
-                <number>6</number>
-            </property>
-            <widget class="QLabel">
-                <property name="name">
-                    <cstring>TextLabel7</cstring>
-                </property>
-                <property name="text">
-                    <string>&lt;qt&gt;
-Your signature key pair is now ready to be sent to the CA (certification authority) which will generate a certificate for you and send it back via email. Please review the certificate shown below. You should also write down the checksum so that you can match it against the certificate sent back by the CA.
-&lt;p&gt;
-If you want to change anything, press Back and make your changes. Otherwise press Finish to send the signature key pair to the CA.
-&lt;/qt&gt;</string>
-                </property>
-                <property name="alignment">
-                    <set>WordBreak|AlignVCenter</set>
-                </property>
-            </widget>
-            <widget class="QTextEdit">
-                <property name="name">
-                    <cstring>certificateTE</cstring>
-                </property>
-            </widget>
-        </vbox>
-    </widget>
-</widget>
-<slots>
-    <slot access="protected">slotCreatePSE()</slot>
-</slots>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
diff -urN -x CVS kdepim.orig/kmail/certificatewizardimpl.cpp kdepim/kmail/certificatewizardimpl.cpp
--- kdepim.orig/kmail/certificatewizardimpl.cpp	Sun Jan 11 22:57:07 2004
+++ kdepim/kmail/certificatewizardimpl.cpp	Thu Jan  1 01:00:00 1970
@@ -1,36 +0,0 @@
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-
-#include "certificatewizardimpl.h"
-#include <kdebug.h>
-/*
- *  Constructs a CertificateWizardImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- *
- *  The wizard will by default be modeless, unless you set 'modal' to
- *  TRUE to construct a modal wizard.
- */
-CertificateWizardImpl::CertificateWizardImpl( QWidget* parent,  const char* name, bool modal, WFlags fl )
-    : CertificateWizard( parent, name, modal, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-CertificateWizardImpl::~CertificateWizardImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-/*
- * protected slot
- */
-void CertificateWizardImpl::slotCreatePSE()
-{
-    kdWarning() << "CertificateWizardImpl::slotCreatePSE() not yet implemented!" << endl;
-}
-
-
-#include "certificatewizardimpl.moc"
diff -urN -x CVS kdepim.orig/kmail/certificatewizardimpl.h kdepim/kmail/certificatewizardimpl.h
--- kdepim.orig/kmail/certificatewizardimpl.h	Mon Apr 22 08:04:06 2002
+++ kdepim/kmail/certificatewizardimpl.h	Thu Jan  1 01:00:00 1970
@@ -1,18 +0,0 @@
-#ifndef CERTIFICATEWIZARDIMPL_H
-#define CERTIFICATEWIZARDIMPL_H
-#include "certificatewizard.h"
-
-class CertificateWizardImpl : public CertificateWizard
-{ 
-    Q_OBJECT
-
-public:
-    CertificateWizardImpl( QWidget* parent = 0, const char* name = 0, bool modal = FALSE, WFlags fl = 0 );
-    ~CertificateWizardImpl();
-
-protected slots:
-    void slotCreatePSE();
-
-};
-
-#endif // CERTIFICATEWIZARDIMPL_H
diff -urN -x CVS kdepim.orig/kmail/encryptionconfigurationdialog.ui kdepim/kmail/encryptionconfigurationdialog.ui
--- kdepim.orig/kmail/encryptionconfigurationdialog.ui	Thu Mar 18 12:53:14 2004
+++ kdepim/kmail/encryptionconfigurationdialog.ui	Thu Jan  1 01:00:00 1970
@@ -1,687 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>EncryptionConfigurationDialog</class>
-<widget class="QWidget">
-    <property name="name">
-        <cstring>EncryptionConfigurationDialog</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>445</width>
-            <height>481</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Encryption Configuration</string>
-    </property>
-    <vbox>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <property name="margin">
-            <number>11</number>
-        </property>
-        <property name="spacing">
-            <number>6</number>
-        </property>
-        <widget class="QButtonGroup">
-            <property name="name">
-                <cstring>encryptMessagesBG</cstring>
-            </property>
-            <property name="title">
-                <string>Encryption</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QLabel" row="0" column="0">
-                    <property name="name">
-                        <cstring>encryptionAlgorithmLA</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Encryption &amp;algorithm:</string>
-                    </property>
-                    <property name="buddy" stdset="0">
-                        <cstring>encryptionAlgorithmCO</cstring>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>storeEncryptedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Store sent messages &amp;encrypted</string>
-                    </property>
-                    <property name="checked">
-                        <bool>false</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to store messages encrypted </string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Store Messages Encrypted&lt;/h1&gt;
-When this box is checked, sent messages are stored encrypted like they were sent. This is not recommended, as you will not be able to read the messages any longer if a necessary certificate expires.
-&lt;p&gt;
-However, there may be local rules that require you to turn this option on. When in doubt, check with your local administrator.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="1" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>encryptAllPartsRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Encr&amp;ypt all message parts</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have all message parts encrypted by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Encrypt All Message Parts By Default&lt;/h1&gt;
-If this option is selected, all parts of a message (i.e. the main message body and all attachments) are encrypted by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="2" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>askEachPartRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Ask &amp;before encrypting each part</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be asked for each part whether to encrypt</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Ask Before Encrypting Each Part&lt;/h1&gt;
-When this option is selected, you will be asked for each part of the message (i.e. the main message body as well as all attachments) individually whether you want the part to be encrypted.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="3" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>dontEncryptRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Do not encrypt messages</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check for not encrypting a message by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Do Not Encrypt Messages&lt;/h1&gt;
-If this option is selected, messages are not encrypted by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual setting.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QComboBox" row="0" column="1">
-                    <item>
-                        <property name="text">
-                            <string>Triple-DES</string>
-                        </property>
-                    </item>
-                    <property name="name">
-                        <cstring>encryptionAlgorithmCO</cstring>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects the encryption algorithm</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Encryption Algorithm&lt;/h1&gt;
-An algorithm is a description for the computer on how it should perform a certain task. The encryption algorithm describes how the computer applies your recipient's key to your message so that only the intended receiver can read the message.
-&lt;p&gt;
-The selection of a certain encryption algorithm determines how easy or how difficult it is to intercept and read a message. However, all algorithms provided in the SPHINX environment are considered to be very safe. Generally, the default will work just fine here.
-&lt;p&gt;
-This setting is a default, you can override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <spacer row="0" column="2">
-                    <property name="name">
-                        <cstring>Spacer19</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-            </grid>
-        </widget>
-        <widget class="QButtonGroup">
-            <property name="name">
-                <cstring>certBG</cstring>
-            </property>
-            <property name="title">
-                <string>Certificates</string>
-            </property>
-            <vbox>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <widget class="QButtonGroup">
-                    <property name="name">
-                        <cstring>certificatePathCheckBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <spacer row="1" column="0" rowspan="2" colspan="1">
-                            <property name="name">
-                                <cstring>Spacer1_2_2</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <widget class="QRadioButton" row="2" column="1">
-                            <property name="name">
-                                <cstring>pathMayEndLocallyCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Check can end with locally sa&amp;ved certificate</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to end with locally saved certificate.</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Certificate Check Can End With Locally Saved Certificate&lt;/h1&gt;
-If this option is checked, the check of the certificate chain can end with a locally saved certificate.
-&lt;p&gt;
-Locally saved certificates are your own certificates as well as the certificates of communication partners and certification authorities (CAs).
-&lt;/h1&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="1" column="1">
-                            <property name="name">
-                                <cstring>alwaysCheckRootRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always c&amp;heck to root certificate</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check here to check up to the root certificate</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Always Check Certificate Path To Root Certificate&lt;/h1&gt;
-If this option is turned on, the certificate path belonging to the receiver's certificate will always be checked all the way to the root certificate.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                            <property name="name">
-                                <cstring>checkCertificatePathCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Check certificate &amp;path</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check here to have the whole certificate path checked</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Check Certificate Path&lt;/h1&gt;
-If this option is turned on, the whole path of the receiver's certificate up to the root will be checked.
-&lt;p&gt;
-Note that it is not possible to turn off checking the receiver's certificate itself.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                    </grid>
-                </widget>
-                <widget class="QButtonGroup">
-                    <property name="name">
-                        <cstring>crlBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                            <property name="name">
-                                <cstring>useCRLsCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>&amp;Use certificate revocation lists (CRLs)</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to use CRLs</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Use Certificate Revocation Lists (CRLs)&lt;/h1&gt;
-A certificate revocation list contains certificates that have been withdrawn and should not be used for encryption purposes any longer. A user may wish to have his or her certificate revoked because he or she suspects that the certificate's integrity has been compromised (e.g. somebody has guessed the PIN).
-&lt;p&gt;
-It is recommended to use CRLs for maximum security. In the configuration dialog for certificate and CRL management, you can select where to retrieve the CRLs from.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QCheckBox" row="1" column="1">
-                            <property name="name">
-                                <cstring>warnCRLExpireCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Warn if CRL e&amp;xpires in less than</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to be warned if a CRL expires in the near future</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CRL Expires In The Near Future&lt;/h1&gt;
-If this box is checked, you will be warned if one of the CRLs you are using is about to expire in the near future.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QSpinBox" row="1" column="2">
-                            <property name="name">
-                                <cstring>warnCRLExpireSB</cstring>
-                            </property>
-                            <property name="suffix">
-                                <string> days</string>
-                            </property>
-                            <property name="maxValue">
-                                <number>999</number>
-                            </property>
-                            <property name="value">
-                                <number>7</number>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Number of days before warning</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CRL Expires In The Near Future&lt;/h1&gt;
-In this field you can specify how soon before a CRL expires you are warned about this expiry.
-&lt;p&gt;
-The recommended setting for the SPHINX environment is 7 days.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <spacer row="1" column="0">
-                            <property name="name">
-                                <cstring>Spacer1_2</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <spacer row="1" column="3">
-                            <property name="name">
-                                <cstring>Spacer8</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Expanding</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                    </grid>
-                </widget>
-                <widget class="QCheckBox">
-                    <property name="name">
-                        <cstring>alwaysEncryptToSelfCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Always encrypt &amp;to self</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have encrypted messages also encrypted using your own key.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Always encrypt to self&lt;/h1&gt;
-If this box is checked, encrypted messages sent by you will also be encrypted using your own key.
-&lt;p&gt;
-It is recommended to leave this option turned on to enable you to read the messages you have sent.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </vbox>
-        </widget>
-        <widget class="QGroupBox">
-            <property name="name">
-                <cstring>encryptionSettingsBG</cstring>
-            </property>
-            <property name="title">
-                <string>Warnings</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>warnUnencryptedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Warn when trying to send unencrypted messages</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned when sending unencrypted messages.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn When Trying To Send Unencrypted Messages&lt;/h1&gt;
-If this box is checked, you will be warned when you try to send parts of or the whole message unencrypted.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="4" column="1" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnChainCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If A Certificate In The Chain Expires&lt;/h1&gt;
-Select the minimum number of days all certificates in the chain should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0">
-                    <property name="name">
-                        <cstring>warnChainCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if a certificate in &amp;the chain expires in less than</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for encrypting that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="3" column="1" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnReceiverCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Encryption Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the encryption certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="3" column="0">
-                    <property name="name">
-                        <cstring>warnReceiverCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if &amp;receiver certificate expires in less than</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for encrypting that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <spacer row="3" column="3" rowspan="2" colspan="1">
-                    <property name="name">
-                        <cstring>Spacer7</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-                <widget class="QCheckBox" row="1" column="0" rowspan="2" colspan="2">
-                    <property name="name">
-                        <cstring>warnReceiverNotInCertificateCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if receiver's email address is &amp;not in certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the address is not in the certificate</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Receiver's Email Address Is Not In Certificate&lt;/h1&gt;
-If this option is checked, a warning is issued if the email address of the receiver is not contained in the certificate used for encrypting.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum security.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </grid>
-        </widget>
-        <spacer>
-            <property name="name">
-                <cstring>Spacer17</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Vertical</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Expanding</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-    </vbox>
-</widget>
-<connections>
-    <connection>
-        <sender>warnReceiverCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnReceiverCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnChainCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnChainCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>checkCertificatePathCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>alwaysCheckRootRB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>checkCertificatePathCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>pathMayEndLocallyCB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>useCRLsCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireCB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>useCRLsCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnCRLExpireCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-</connections>
-<tabstops>
-    <tabstop>encryptAllPartsRB</tabstop>
-    <tabstop>askEachPartRB</tabstop>
-    <tabstop>dontEncryptRB</tabstop>
-    <tabstop>warnUnencryptedCB</tabstop>
-    <tabstop>useCRLsCB</tabstop>
-    <tabstop>warnCRLExpireCB</tabstop>
-    <tabstop>warnCRLExpireSB</tabstop>
-    <tabstop>encryptionAlgorithmCO</tabstop>
-    <tabstop>warnReceiverCertificateExpiresCB</tabstop>
-    <tabstop>warnReceiverCertificateExpiresSB</tabstop>
-    <tabstop>warnChainCertificateExpiresCB</tabstop>
-    <tabstop>warnChainCertificateExpiresSB</tabstop>
-    <tabstop>warnReceiverNotInCertificateCB</tabstop>
-    <tabstop>storeEncryptedCB</tabstop>
-    <tabstop>checkCertificatePathCB</tabstop>
-    <tabstop>alwaysCheckRootRB</tabstop>
-    <tabstop>pathMayEndLocallyCB</tabstop>
-</tabstops>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
diff -urN -x CVS kdepim.orig/kmail/encryptionconfigurationdialogimpl.cpp kdepim/kmail/encryptionconfigurationdialogimpl.cpp
--- kdepim.orig/kmail/encryptionconfigurationdialogimpl.cpp	Sun Jan 11 22:57:07 2004
+++ kdepim/kmail/encryptionconfigurationdialogimpl.cpp	Thu Jan  1 01:00:00 1970
@@ -1,83 +0,0 @@
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-
-#include "encryptionconfigurationdialogimpl.h"
-#include "cryptplugwrapper.h"
-
-#include <qbuttongroup.h>
-#include <qradiobutton.h>
-#include <qcheckbox.h>
-#include <qspinbox.h>
-
-
-
-
-#define FULLTEST false
-
-
-
-
-/*
- *  Constructs a EncryptionConfigurationDialogImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- */
-EncryptionConfigurationDialogImpl::EncryptionConfigurationDialogImpl( QWidget* parent,  const char* name, WFlags fl )
-    : EncryptionConfigurationDialog( parent, name, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-EncryptionConfigurationDialogImpl::~EncryptionConfigurationDialogImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-
-/**
-   Enables or disables the widgets in this dialog according to the
-   capabilities of the current plugin passed as a parameter.
-*/
-void EncryptionConfigurationDialogImpl::enableDisable( CryptPlugWrapper* cryptPlug )
-{
-    // disable the whole page if the plugin does not support encryption
-    setEnabled( cryptPlug->hasFeature( Feature_EncryptMessages ) );
-    
-    // enable/disable individual components depending on the plugin features
-    crlBG->setEnabled( cryptPlug->hasFeature( Feature_EncryptionCRLs ) );
-    warnReceiverCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnReceiverCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnChainCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnChainCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnReceiverNotInCertificateCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptEmailNotInCertificate ) );
-    storeEncryptedCB->setEnabled( cryptPlug->hasFeature( Feature_StoreMessagesEncrypted ) );
-    certificatePathCheckBG->setEnabled( cryptPlug->hasFeature( Feature_CheckCertificatePath ) );
-    
-    if( ! FULLTEST ) {
-        askEachPartRB                 ->hide(); // We won't implement that.
-        
-//        encryptionSettingsBG          ->hide(); // Will implement that later.
-        
-        certBG                         ->hide(); // Will implement that later.
-
-        warnCRLExpireCB               ->hide(); // Will implement that later.
-        warnCRLExpireSB               ->hide(); // Will implement that later.
-        
-//        warnReceiverCertificateExpiresCB->hide();//Will implement that later.
-//        warnReceiverCertificateExpiresSB->hide();//Will implement that later.
-        
-        warnChainCertificateExpiresCB ->hide(); // Will implement that later.
-        warnChainCertificateExpiresSB ->hide(); // Will implement that later.
-        warnReceiverNotInCertificateCB->hide(); // Will implement that later.
-        
-        alwaysCheckRootRB             ->hide(); // Will implement that later.
-        
-        /*enable:*/
-        pathMayEndLocallyCB           ->setEnabled( true );
-        
-    }
-}
-
-#include "encryptionconfigurationdialogimpl.moc"
diff -urN -x CVS kdepim.orig/kmail/encryptionconfigurationdialogimpl.h kdepim/kmail/encryptionconfigurationdialogimpl.h
--- kdepim.orig/kmail/encryptionconfigurationdialogimpl.h	Mon Apr 22 09:42:10 2002
+++ kdepim/kmail/encryptionconfigurationdialogimpl.h	Thu Jan  1 01:00:00 1970
@@ -1,19 +0,0 @@
-#ifndef ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
-#define ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
-#include "encryptionconfigurationdialog.h"
-
-class CryptPlugWrapper;
-
-class EncryptionConfigurationDialogImpl : public EncryptionConfigurationDialog
-{
-    Q_OBJECT
-
-public:
-    EncryptionConfigurationDialogImpl( QWidget* parent = 0, 
-                                       const char* name = 0, WFlags fl = 0 );
-    ~EncryptionConfigurationDialogImpl();
-
-    void enableDisable( CryptPlugWrapper* wrapper );
-};
-
-#endif // ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
diff -urN -x CVS kdepim.orig/kmail/eventsrc kdepim/kmail/eventsrc
--- kdepim.orig/kmail/eventsrc	Thu Sep 30 16:03:59 2004
+++ kdepim/kmail/eventsrc	Mon Oct  4 15:26:17 2004
@@ -21,6 +21,7 @@
 Name[he]=דוא"ל חדש הגיע
 Name[hu]=Új levél érkezett
 Name[it]=Nuova posta arrivata
+Name[ja]=新規メール着信
 Name[nb]=Ny e-post ankommet
 Name[nl]=Nieuwe berichten gearriveerd
 Name[nn]=Ny e-post er komen
@@ -31,7 +32,7 @@
 Name[sk]=Prišla nová pošta
 Name[sl]=Prispela je nova pošta
 Name[sr]=Стигла је нова пошта
-Name[sr@Latn]=Стигла је нова пошта
+Name[sr@Latn]=Stigla je nova pošta
 Name[sv]=Ny post har anlänt
 Name[ta]=புதிய அஞ்சல் வந்துள்ளது
 Name[tg]=Почтаи нав қабул шуд
@@ -50,6 +51,7 @@
 Comment[he]=דוא"ל חדש הגיע
 Comment[hu]=Új levél érkezett
 Comment[it]=Nuova posta
+Comment[ja]=新規メール着信
 Comment[nb]=Ny e-post ankommet
 Comment[nl]=Nieuw bericht ontvangen
 Comment[nn]=Ny e-post er komen
@@ -60,7 +62,7 @@
 Comment[sk]=Prišla nová pošta
 Comment[sl]=Prispela je nova pošta
 Comment[sr]=Стигла је нова пошта
-Comment[sr@Latn]=Стигла је нова пошта
+Comment[sr@Latn]=Stigla je nova pošta
 Comment[sv]=Ny post har anlänt
 Comment[ta]=புதிய அஞ்சல் வந்துள்ளது
 Comment[tg]=Почтаи нав қабул шуд
diff -urN -x CVS kdepim.orig/kmail/folderstorage.cpp kdepim/kmail/folderstorage.cpp
--- kdepim.orig/kmail/folderstorage.cpp	Fri Sep 24 15:42:34 2004
+++ kdepim/kmail/folderstorage.cpp	Wed Oct 13 15:25:14 2004
@@ -3,7 +3,7 @@
 
     This file is part of KMail.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -715,7 +715,7 @@
   if (mAutoCreateIndex)
     writeConfig();
   emit changed();
-  emit expunged();
+  emit expunged( folder() );
 
   return 0;
 }
diff -urN -x CVS kdepim.orig/kmail/folderstorage.h kdepim/kmail/folderstorage.h
--- kdepim.orig/kmail/folderstorage.h	Fri Sep 24 15:42:34 2004
+++ kdepim/kmail/folderstorage.h	Wed Oct 13 15:25:14 2004
@@ -3,7 +3,7 @@
 
     This file is part of KMail.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -416,7 +416,7 @@
 
   /** Emitted after an expunge. If not quiet, changed() will be
       emmitted first. */
-  void expunged();
+  void expunged( KMFolder* );
 
   /** Emitted when the name of the folder changes. */
   void nameChanged();
diff -urN -x CVS kdepim.orig/kmail/imapaccountbase.cpp kdepim/kmail/imapaccountbase.cpp
--- kdepim.orig/kmail/imapaccountbase.cpp	Thu Jul 29 23:45:13 2004
+++ kdepim/kmail/imapaccountbase.cpp	Sun Oct  3 22:23:45 2004
@@ -93,6 +93,7 @@
       mPasswordDialogIsActive( false ),
       mACLSupport( true ),
       mSlaveConnected( false ),
+      mSlaveConnectionError( false ),
       mListDirProgressItem( 0 )
   {
     mPort = imapDefaultPort;
@@ -481,9 +482,12 @@
       handleError( errorCode, errorMsg, 0, QString::null, true );
       if ( mAskAgain )
         makeConnection();
-      else
+      else {
+        if ( !mSlaveConnected )
+          mSlaveConnectionError = true;
         emit connectionResult( errorCode, errorMsg );
   }
+  }
 
   //-----------------------------------------------------------------------------
   void ImapAccountBase::slotSchedulerSlaveConnected(KIO::Slave *aSlave)
diff -urN -x CVS kdepim.orig/kmail/imapaccountbase.h kdepim/kmail/imapaccountbase.h
--- kdepim.orig/kmail/imapaccountbase.h	Thu Jul 22 21:24:11 2004
+++ kdepim/kmail/imapaccountbase.h	Sun Oct  3 22:23:45 2004
@@ -366,6 +366,7 @@
     bool mPasswordDialogIsActive : 1;
     bool mACLSupport : 1;
     bool mSlaveConnected : 1;
+    bool mSlaveConnectionError : 1;
 
 	// folders that should be checked for new mails
 	QValueList<QGuardedPtr<KMFolder> > mMailCheckFolders;
diff -urN -x CVS kdepim.orig/kmail/imapjob.cpp kdepim/kmail/imapjob.cpp
--- kdepim.orig/kmail/imapjob.cpp	Sat Oct  2 23:05:22 2004
+++ kdepim/kmail/imapjob.cpp	Sun Oct  3 12:52:04 2004
@@ -492,7 +492,7 @@
   if (job->error())
   {
     if ( (*it).progressItem )
-      (*it).progressItem->setStatus("Uploading message data failed.");
+      (*it).progressItem->setStatus( i18n("Uploading message data failed.") );
     account->handlePutError( job, *it, mDestFolder );
     return;
   } else {
@@ -506,7 +506,7 @@
     }
     msg = 0;
     if ( (*it).progressItem )
-      (*it).progressItem->setStatus("Uploading message data completed.");
+      (*it).progressItem->setStatus( i18n("Uploading message data completed.") );
   }
   if (account->slave()) {
     account->removeJob(it);
diff -urN -x CVS kdepim.orig/kmail/interfaces/bodypartformatter.h kdepim/kmail/interfaces/bodypartformatter.h
--- kdepim.orig/kmail/interfaces/bodypartformatter.h	Fri Apr 30 14:25:47 2004
+++ kdepim/kmail/interfaces/bodypartformatter.h	Mon Oct 18 15:44:42 2004
@@ -61,7 +61,7 @@
 
 	 @return the result code (see above)
       */
-      virtual Result format( BodyPart * part, HtmlWriter * writer ) const = 0;
+      virtual Result format( BodyPart * part, KMail::HtmlWriter * writer ) const = 0;
     };
 
     /**
diff -urN -x CVS kdepim.orig/kmail/kleo_util.h kdepim/kmail/kleo_util.h
--- kdepim.orig/kmail/kleo_util.h	Thu Jan  1 01:00:00 1970
+++ kdepim/kmail/kleo_util.h	Mon Oct 18 15:20:39 2004
@@ -0,0 +1,81 @@
+/*  -*- c++ -*-
+    kleo_util.h
+
+    This file is part of KMail, the KDE mail client.
+    Copyright (c) 2004 Marc Mutz <mutz@kde.org>
+
+    KMail is free software; you can redistribute it and/or modify it
+    under the terms of the GNU General Public License, version 2, as
+    published by the Free Software Foundation.
+
+    KMail is distributed in the hope that it will be useful, but
+    WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef __KDEPIM_KMAIL_KLEO_UTIL_H__
+#define __KDEPIM_KMAIL_KLEO_UTIL_H__
+
+#include <kleo/enum.h>
+
+static const Kleo::CryptoMessageFormat cryptoMessageFormats[] = {
+  Kleo::AutoFormat,
+  Kleo::InlineOpenPGPFormat,
+  Kleo::OpenPGPMIMEFormat,
+  Kleo::SMIMEFormat,
+  Kleo::SMIMEOpaqueFormat
+};
+static const int numCryptoMessageFormats = sizeof cryptoMessageFormats / sizeof *cryptoMessageFormats ;
+
+static const Kleo::CryptoMessageFormat concreteCryptoMessageFormats[] = {
+  Kleo::OpenPGPMIMEFormat,
+  Kleo::SMIMEFormat,
+  Kleo::SMIMEOpaqueFormat,
+  Kleo::InlineOpenPGPFormat
+};
+static const unsigned int numConcreteCryptoMessageFormats
+  = sizeof concreteCryptoMessageFormats / sizeof *concreteCryptoMessageFormats ;
+
+static inline Kleo::CryptoMessageFormat cb2format( int idx ) {
+  return cryptoMessageFormats[ idx >= 0 && idx < numCryptoMessageFormats ? idx : 0 ];
+}
+
+static inline int format2cb( Kleo::CryptoMessageFormat f ) {
+  for ( int i = 0 ; i < numCryptoMessageFormats ; ++i )
+    if ( f == cryptoMessageFormats[i] )
+      return i;
+  return 0;
+}
+
+
+//
+// some helper functions indicating the need for CryptoMessageFormat
+// to be a class type :)
+//
+
+static inline bool isSMIME( Kleo::CryptoMessageFormat f ) {
+  return f ==  Kleo::SMIMEFormat || f == Kleo::SMIMEOpaqueFormat ;
+}
+
+static inline bool isOpenPGP( Kleo::CryptoMessageFormat f ) {
+  return f == Kleo::InlineOpenPGPFormat || f == Kleo::OpenPGPMIMEFormat ;
+}
+
+
+#endif // __KDEPIM_KMAIL_KLEO_UTIL_H__
diff -urN -x CVS kdepim.orig/kmail/kmacctcachedimap.cpp kdepim/kmail/kmacctcachedimap.cpp
--- kdepim.orig/kmail/kmacctcachedimap.cpp	Fri Sep 24 12:56:14 2004
+++ kdepim/kmail/kmacctcachedimap.cpp	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  kmacctcachedimap.cpp
  *
- *  Copyright (c) 2002-2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2002-2004 Bo Thorsen <bo@sonofthor.dk>
  *  Copyright (c) 2002-2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -urN -x CVS kdepim.orig/kmail/kmacctcachedimap.h kdepim/kmail/kmacctcachedimap.h
--- kdepim.orig/kmail/kmacctcachedimap.h	Fri Sep 24 12:56:14 2004
+++ kdepim/kmail/kmacctcachedimap.h	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  kmacctcachedimap.h
  *
- *  Copyright (c) 2002-2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2002-2004 Bo Thorsen <bo@sonofthor.dk>
  *  Copyright (c) 2002-2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -urN -x CVS kdepim.orig/kmail/kmacctimap.cpp kdepim/kmail/kmacctimap.cpp
--- kdepim.orig/kmail/kmacctimap.cpp	Thu Jul 29 23:45:13 2004
+++ kdepim/kmail/kmacctimap.cpp	Sun Oct  3 22:23:45 2004
@@ -54,6 +54,7 @@
   mOpenFolders.setAutoDelete(true);
   connect(kmkernel->imapFolderMgr(), SIGNAL(changed()),
       this, SLOT(slotUpdateFolderList()));
+  connect(&mErrorTimer, SIGNAL(timeout()), SLOT(slotResetConnectionError()));
 }
 
 
@@ -414,4 +415,20 @@
   return mFolder;
 }
 
+ImapAccountBase::ConnectionState KMAcctImap::makeConnection() 
+{
+    if ( mSlaveConnectionError )
+    {
+       mErrorTimer.start(100, true); // Clear error flag
+       return Error;
+    }
+    return ImapAccountBase::makeConnection();
+}
+
+void KMAcctImap::slotResetConnectionError()
+{
+  mSlaveConnectionError = false;
+  kdDebug(5006) << k_funcinfo << endl;
+}
+
 #include "kmacctimap.moc"
diff -urN -x CVS kdepim.orig/kmail/kmacctimap.h kdepim/kmail/kmacctimap.h
--- kdepim.orig/kmail/kmacctimap.h	Thu Jul 22 21:24:11 2004
+++ kdepim/kmail/kmacctimap.h	Sun Oct  3 22:23:45 2004
@@ -54,6 +54,7 @@
    */
   virtual QString type(void) const;
   virtual void processNewMail(bool);
+  ConnectionState makeConnection();
 
   /**
    * Kill all jobs related the the specified folder/msg
@@ -124,7 +125,14 @@
    */
   void slotMailCheckCanceled();
 
+  /**
+   * called to reset the connection error status
+   */
+  void slotResetConnectionError();
+
 private:
+  /** used to reset connection errors */
+  QTimer mErrorTimer;
   int mCountRemainChecks;
 };
 
diff -urN -x CVS kdepim.orig/kmail/kmaddrbook.cpp kdepim/kmail/kmaddrbook.cpp
--- kdepim.orig/kmail/kmaddrbook.cpp	Wed Apr 14 21:39:43 2004
+++ kdepim/kmail/kmaddrbook.cpp	Tue Oct 19 00:10:22 2004
@@ -22,68 +22,6 @@
 
 #include <qregexp.h>
 
-void KabcBridge::addresses(QStringList& result) // includes lists
-{
-  KCursorSaver busy(KBusyPtr::busy()); // loading might take a while
-
-  KABC::AddressBook *addressBook = KABC::StdAddressBook::self();
-  KABC::AddressBook::ConstIterator it;
-  for( it = addressBook->begin(); it != addressBook->end(); ++it ) {
-    const QStringList emails = (*it).emails();
-    QString n = (*it).prefix() + " " +
-		(*it).givenName() + " " +
-		(*it).additionalName() + " " +
-	        (*it).familyName() + " " +
-		(*it).suffix();
-    n = n.simplifyWhiteSpace();
-
-    QRegExp needQuotes("[^ 0-9A-Za-z\\x0080-\\xFFFF]");
-    QString endQuote = "\" ";
-    QStringList::ConstIterator mit;
-    QString addr, email;
-
-    for ( mit = emails.begin(); mit != emails.end(); ++mit ) {
-      email = *mit;
-      if (!email.isEmpty()) {
-	if (n.isEmpty() || (email.find( '<' ) != -1))
-	  addr = QString::null;
-	else { // do we really need quotes around this name ?
-          if (n.find(needQuotes) != -1)
-	    addr = '"' + n + endQuote;
-	  else
-	    addr = n + ' ';
-	}
-
-	if (!addr.isEmpty() && (email.find( '<' ) == -1)
-	    && (email.find( '>' ) == -1)
-	    && (email.find( ',' ) == -1))
-	  addr += '<' + email + '>';
-	else
-	  addr += email;
-	addr = addr.stripWhiteSpace();
-	result.append( addr );
-      }
-    }
-  }
-  KABC::DistributionListManager manager( addressBook );
-  manager.load();
-  result += manager.listNames();
-
-  result.sort();
-}
-
-QStringList KabcBridge::addresses()
-{
-    QStringList entries;
-    KABC::AddressBook::ConstIterator it;
-
-    const KABC::AddressBook *addressBook = KABC::StdAddressBook::self();
-    for( it = addressBook->begin(); it != addressBook->end(); ++it ) {
-        entries += (*it).fullEmail();
-    }
-    return entries;
-}
-
 //-----------------------------------------------------------------------------
 QString KabcBridge::expandNickName( const QString& nickName )
 {
diff -urN -x CVS kdepim.orig/kmail/kmaddrbook.h kdepim/kmail/kmaddrbook.h
--- kdepim.orig/kmail/kmaddrbook.h	Wed Apr 14 18:20:15 2004
+++ kdepim/kmail/kmaddrbook.h	Tue Oct 19 00:10:23 2004
@@ -14,8 +14,6 @@
 
 class KabcBridge {
 public:
-  static QStringList addresses();
-  static void addresses(QStringList& result);
   static QString expandNickName( const QString& nickName );
    /**
     	Returns all categories found in the addressbook.
diff -urN -x CVS kdepim.orig/kmail/kmail_config_appearance.desktop kdepim/kmail/kmail_config_appearance.desktop
--- kdepim.orig/kmail/kmail_config_appearance.desktop	Thu Sep 30 16:03:59 2004
+++ kdepim/kmail/kmail_config_appearance.desktop	Mon Oct  4 15:26:17 2004
@@ -44,7 +44,7 @@
 Name[sk]=Vzhľad
 Name[sl]=Videz
 Name[sr]=Изглед
-Name[sr@Latn]=Изглед
+Name[sr@Latn]=Izgled
 Name[sv]=Uppträdande
 Name[ta]=தோற்றம்
 Name[tg]=Намуди зоҳирӣ
@@ -65,6 +65,7 @@
 Comment[he]=הגדרת מראה
 Comment[hu]=A grafikai megjelenés testreszabása
 Comment[it]=Personalizza l'aspetto
+Comment[ja]=視覚的な外観をカスタマイズ
 Comment[nb]=Tilpass visuellt utseende
 Comment[nl]=Pas het uiterlijk aan
 Comment[nn]=Tilpass utsjånad
@@ -75,7 +76,7 @@
 Comment[sk]=Prispôsobenie vzhľadu
 Comment[sl]=Prilagodi videz
 Comment[sr]=Прилагодите визуелни приказ
-Comment[sr@Latn]=Прилагодите визуелни приказ
+Comment[sr@Latn]=Prilagodite vizuelni prikaz
 Comment[sv]=Anpassa visuellt uppträdande
 Comment[ta]=பார்க்கும் தோற்றத்தை தனிபயனாக்கு
 Comment[tg]=Танзимоти намуди зоҳирӣ
@@ -83,6 +84,7 @@
 Keywords=kmail,appearance
 Keywords[be]=K Пошта,зьнешні выгляд,kmail,appearance
 Keywords[bg]=пощенски, клиент, е-поща, външен вид, външност, появяване kmail, appearance
+Keywords[br]=kmail,neuziadur
 Keywords[bs]=kmail,appearance,izgled
 Keywords[ca]=kmail,aparença
 Keywords[cs]=kmail,vzhled
@@ -97,6 +99,7 @@
 Keywords[hu]=kmail,megjelenés
 Keywords[is]=kmail,útlit
 Keywords[it]=kmail,aspetto
+Keywords[ja]=kmail,外観
 Keywords[nb]=kmail,utseende
 Keywords[nl]=kmail,uiterlijk
 Keywords[nn]=KMail,utsjånad
@@ -107,7 +110,7 @@
 Keywords[sk]=kmail,vzhľad
 Keywords[sl]=kmail,videz,izgled
 Keywords[sr]=kmail,изглед
-Keywords[sr@Latn]=kmail,изглед
+Keywords[sr@Latn]=kmail,izgled
 Keywords[sv]=kmail,utseende
 Keywords[ta]=கேஅஞ்சல், தோற்றம்
 Keywords[tg]=kmail,намуди зоҳирӣ
diff -urN -x CVS kdepim.orig/kmail/kmail_config_composer.desktop kdepim/kmail/kmail_config_composer.desktop
--- kdepim.orig/kmail/kmail_config_composer.desktop	Thu Sep 30 16:03:59 2004
+++ kdepim/kmail/kmail_config_composer.desktop	Mon Oct  4 15:26:17 2004
@@ -36,7 +36,7 @@
 Name[sk]=Editor správ
 Name[sl]=Sestavljalnik
 Name[sr]=Састављач
-Name[sr@Latn]=Састављач
+Name[sr@Latn]=Sastavljač
 Name[sv]=Brevfönster
 Name[ta]=கம்போசர்
 Name[tg]=Муҳаррири мактубҳо
@@ -56,6 +56,7 @@
 Comment[he]=ביטויים והתנהגות כללית
 Comment[hu]=Kifejezések, általános működési jellemzők
 Comment[it]=Frasi e comportamento generale
+Comment[ja]=言いまわし & 一般的な振る舞い
 Comment[nb]=Fraser & generell oppførsel
 Comment[nl]=Zinnen & Algemeen gedrag
 Comment[nn]=Frasar og generell åtferd
@@ -66,7 +67,7 @@
 Comment[sk]=Frázy a všeobecné chovanie
 Comment[sl]=Fraze in splošno obnašanje
 Comment[sr]=Фразе и опште понашање
-Comment[sr@Latn]=Фразе и опште понашање
+Comment[sr@Latn]=Fraze i opšte ponašanje
 Comment[sv]=Fraser och allmänt uppträdande
 Comment[ta]=சொற்றொடர்கள் & பொதுவான நடப்பு
 Comment[tg]=Ибораҳо ва параметрҳои умумӣ
@@ -95,7 +96,7 @@
 Keywords[sk]=kmail,editor správ
 Keywords[sl]=kmail,composer,sestavljalnik
 Keywords[sr]=kmail,састављач
-Keywords[sr@Latn]=kmail,састављач
+Keywords[sr@Latn]=kmail,sastavljač
 Keywords[sv]=kmail,brevfönster
 Keywords[ta]=கேஅஞ்சல்,கம்போசர்
 Keywords[tg]=kmail,composer,мактуб
diff -urN -x CVS kdepim.orig/kmail/kmail_config_identity.desktop kdepim/kmail/kmail_config_identity.desktop
--- kdepim.orig/kmail/kmail_config_identity.desktop	Sat Oct  2 16:30:20 2004
+++ kdepim/kmail/kmail_config_identity.desktop	Mon Oct  4 15:26:17 2004
@@ -29,6 +29,7 @@
 Name[hu]=Azonosítók
 Name[is]=Auðkenni
 Name[it]=Identità
+Name[ja]=身元
 Name[nb]=Identiteter
 Name[nl]=Identiteiten
 Name[nn]=Identitetar
@@ -39,7 +40,7 @@
 Name[sk]=Identity
 Name[sl]=Identitete
 Name[sr]=Идентитети
-Name[sr@Latn]=Идентитети
+Name[sr@Latn]=Identiteti
 Name[sv]=Identiteter
 Name[ta]=அடையாளங்கள்
 Name[tg]=Профилҳо
@@ -61,6 +62,7 @@
 Comment[hu]=Az azonosítók kezelése
 Comment[is]=Stjórna auðkennum
 Comment[it]=Gestisce le identità
+Comment[ja]=身元管理
 Comment[nb]=Identitet behandling
 Comment[nl]=Identiteiten beheren
 Comment[nn]=Handter identitetar
@@ -71,7 +73,7 @@
 Comment[sk]=Správa identít
 Comment[sl]=Upravljanje z identitetami
 Comment[sr]=Управљање идентитетима
-Comment[sr@Latn]=Управљање идентитетима
+Comment[sr@Latn]=Upravljanje identitetima
 Comment[sv]=Hantera identiteter
 Comment[ta]=அடையாளங்களை நிர்வகி
 Comment[tg]=Идоракунӣ бо профилҳо
@@ -93,6 +95,7 @@
 Keywords[hu]=kmail,azonosító
 Keywords[is]=kmail,auðkenni
 Keywords[it]=kmail,identità
+Keywords[ja]=kmail,身元
 Keywords[nb]=kmail,identitet
 Keywords[nl]=kmail,identiteit
 Keywords[nn]=KMail,identitet
@@ -102,7 +105,7 @@
 Keywords[ru]=kmail,identity,профиль
 Keywords[sl]=kmail,identiteta
 Keywords[sr]=kmail,идентитет
-Keywords[sr@Latn]=kmail,идентитет
+Keywords[sr@Latn]=kmail,identitet
 Keywords[sv]=kmail,identifiera
 Keywords[ta]=கேஅஞ்சல்,அடையாளம்
 Keywords[tg]=kmail,identity,профил
diff -urN -x CVS kdepim.orig/kmail/kmail_config_misc.desktop kdepim/kmail/kmail_config_misc.desktop
--- kdepim.orig/kmail/kmail_config_misc.desktop	Sat Oct  2 16:30:20 2004
+++ kdepim/kmail/kmail_config_misc.desktop	Mon Oct  4 15:26:17 2004
@@ -15,6 +15,7 @@
 Name=Misc
 Name[be]=Рознае
 Name[bg]=Разни
+Name[br]=A bep seurt
 Name[bs]=Razno
 Name[ca]=Varis
 Name[cs]=Různé
@@ -29,6 +30,7 @@
 Name[hu]=Egyéb
 Name[is]=Ýmislegt
 Name[it]=Varie
+Name[ja]=そのほか
 Name[nb]=Div
 Name[nl]=Diversen
 Name[nn]=Ymse
@@ -39,7 +41,7 @@
 Name[sk]=Rôzne
 Name[sl]=Razno
 Name[sr]=Разно
-Name[sr@Latn]=Разно
+Name[sr@Latn]=Razno
 Name[sv]=Diverse
 Name[ta]=இதர
 Name[tg]=Ғайра
@@ -60,6 +62,7 @@
 Comment[hu]=A máshová nem besorolható beállítások
 Comment[is]=Stillingar sem passa ekki annars staðar
 Comment[it]=Impostazioni che non rientrano in altre categorie
+Comment[ja]=他のところに適合しない設定
 Comment[nb]=Instillinger som ikke passer andre steder
 Comment[nl]=Instellingen die nergens echt passen
 Comment[nn]=Innstillingar som ikkje passar andre stader
@@ -70,7 +73,7 @@
 Comment[sk]=Nastavenie, ktoré sa inam nehodí
 Comment[sl]=Nastavitve, ki ne spadajo drugam
 Comment[sr]=Поставке које не припадају другде
-Comment[sr@Latn]=Поставке које не припадају другде
+Comment[sr@Latn]=Postavke koje ne pripadaju drugde
 Comment[sv]=Inställningar som inte passar någon annanstans
 Comment[ta]=அமைப்புகள் எந்த இடத்திலும் பொருந்தவில்லை
 Comment[tg]=Дигар танзимотҳо
@@ -91,6 +94,7 @@
 Keywords[hu]=kmail,egyéb
 Keywords[is]=kmail,ýmislegt
 Keywords[it]=kmail,varie
+Keywords[ja]=kmail,そのほか
 Keywords[nb]=kmail,div
 Keywords[nl]=kmail,diversen
 Keywords[nn]=KMail,ymse
@@ -101,7 +105,7 @@
 Keywords[sk]=kmail,rôzne
 Keywords[sl]=kmail,razno
 Keywords[sr]=kmail,разно
-Keywords[sr@Latn]=kmail,разно
+Keywords[sr@Latn]=kmail,razno
 Keywords[sv]=kmail,diverse
 Keywords[ta]=கேஅஞ்சல், இதர
 Keywords[tg]=kmail,misc,ғайра,дигар
diff -urN -x CVS kdepim.orig/kmail/kmail_config_network.desktop kdepim/kmail/kmail_config_network.desktop
--- kdepim.orig/kmail/kmail_config_network.desktop	Sat Oct  2 16:30:20 2004
+++ kdepim/kmail/kmail_config_network.desktop	Mon Oct  4 15:26:17 2004
@@ -57,7 +57,7 @@
 Name[sl]=Omrežje
 Name[sq]=Rrjeta
 Name[sr]=Мрежа
-Name[sr@Latn]=Мрежа
+Name[sr@Latn]=Mreža
 Name[ss]=Luchungechunge
 Name[sv]=Nätverk
 Name[ta]=பிணையம்
@@ -83,6 +83,7 @@
 Comment[he]=הגדרות עבור קבלה ושליחת הודעות
 Comment[hu]=Küldési és fogadási beállítások
 Comment[it]=Impostazioni per spedire e ricevere messaggi
+Comment[ja]=メッセージを送受信する為の設定
 Comment[nb]=Oppset for mottak og sending av meldinger
 Comment[nl]=Instellingen voor het verzenden en ontvangen van berichten
 Comment[nn]=Oppsett av sending og mottak av meldingar
@@ -93,7 +94,7 @@
 Comment[sk]=Nastavenie príjmu a odosielania správ
 Comment[sl]=Nastavitve za pošiljanje in prejemanje sporočil
 Comment[sr]=Подешавање слања и примања порука
-Comment[sr@Latn]=Подешавање слања и примања порука
+Comment[sr@Latn]=Podešavanje slanja i primanja poruka
 Comment[sv]=Inställningar för att skicka och ta emot post
 Comment[ta]=அனுப்புதல் மற்றும் பெறுதல் தகவல்களுக்கான அமைப்பு
 Comment[tg]=Танзимоти фиристодан ва қабул кардани иттилоот
@@ -114,6 +115,7 @@
 Keywords[he]=kmail,רשת
 Keywords[hu]=kmail,hálózat
 Keywords[is]=kmail,net
+Keywords[ja]=kmail,ネットワーク
 Keywords[nb]=kmail,nettverk
 Keywords[nl]=kmail,netwerk
 Keywords[nn]=KMail,nettverk
@@ -124,7 +126,7 @@
 Keywords[sk]=kmail,sieť
 Keywords[sl]=kmail,omrežje
 Keywords[sr]=kmail,мрежа
-Keywords[sr@Latn]=kmail,мрежа
+Keywords[sr@Latn]=kmail,mreža
 Keywords[sv]=kmail,nätverk
 Keywords[ta]=கேஅஞ்சல்,பிணையம்
 Keywords[tg]=kmail,network,шабақа
diff -urN -x CVS kdepim.orig/kmail/kmail_config_security.desktop kdepim/kmail/kmail_config_security.desktop
--- kdepim.orig/kmail/kmail_config_security.desktop	Sat Oct  2 16:30:20 2004
+++ kdepim/kmail/kmail_config_security.desktop	Mon Oct  4 15:26:17 2004
@@ -15,6 +15,7 @@
 Name=Security
 Name[be]=Бясьпека
 Name[bg]=Сигурност
+Name[br]=Surentez
 Name[bs]=Sigurnost
 Name[ca]=Seguretat
 Name[cs]=Bezpečnost
@@ -29,6 +30,7 @@
 Name[hu]=Biztonság
 Name[is]=Öryggi
 Name[it]=Sicurezza
+Name[ja]=セキュリティー
 Name[nb]=Sikkerhet
 Name[nl]=Beveiliging
 Name[nn]=Tryggleik
@@ -39,7 +41,7 @@
 Name[sk]=Zabezpečenie
 Name[sl]=Varnost
 Name[sr]=Сигурност
-Name[sr@Latn]=Сигурност
+Name[sr@Latn]=Sigurnost
 Name[sv]=Säkerhet
 Name[ta]=பாதுகாப்பு
 Name[tg]=Амният
@@ -62,6 +64,7 @@
 Comment[he]=הגדרות אבטחה ופרטיות
 Comment[hu]=Biztonsági és adatvédelmi beállítások
 Comment[it]=Impostazioni sicurezza e privacy
+Comment[ja]=セキュリティー & プライバシースの設定
 Comment[nb]=Sikkerhet & Personvern instillinger
 Comment[nl]=Beveiligings- en privacy-instellingen
 Comment[nn]=Innstillingar for tryggleik og personvern
@@ -72,7 +75,7 @@
 Comment[sk]=Zabezpečenie a súkromie
 Comment[sl]=Nastavitve varnosti in zasebnosti
 Comment[sr]=Поставке сигурности и приватности
-Comment[sr@Latn]=Поставке сигурности и приватности
+Comment[sr@Latn]=Postavke sigurnosti i privatnosti
 Comment[sv]=Inställningar för säkerhet och integritet
 Comment[ta]=பாதுகாப்பு & தனிப்பட்ட அமைவுகள்
 Comment[tg]=Танзимоти амният
@@ -80,6 +83,7 @@
 Keywords=kmail,security
 Keywords[be]=K Пошта,бясьпека,kmail,security
 Keywords[bg]=пощенски, клиент, е-поща, сигурност, конфиденциалност, kmail, security
+Keywords[br]=kmail,surentez
 Keywords[bs]=kmail,security,sigurnost
 Keywords[ca]=kmail,seguretat
 Keywords[cs]=kmail,bezpečnost
@@ -94,6 +98,7 @@
 Keywords[hu]=kmail,biztonság
 Keywords[is]=kmail,öryggi
 Keywords[it]=kmail,sicurezza
+Keywords[ja]=kmail,セキュリティー
 Keywords[nb]=kmail,sikkerhet
 Keywords[nl]=kmail,beveiliging
 Keywords[nn]=KMail,tryggleik
@@ -104,7 +109,7 @@
 Keywords[sk]=kmail,zabezpečenie
 Keywords[sl]=kmail,varnost
 Keywords[sr]=kmail,сигурност
-Keywords[sr@Latn]=kmail,сигурност
+Keywords[sr@Latn]=kmail,sigurnost
 Keywords[sv]=kmail,säkerhet
 Keywords[ta]=கேஅஞ்சல்,பாதுகாப்பு
 Keywords[tg]=kmail,security,амният
diff -urN -x CVS kdepim.orig/kmail/kmail_part.cpp kdepim/kmail/kmail_part.cpp
--- kdepim.orig/kmail/kmail_part.cpp	Wed Sep  8 20:04:59 2004
+++ kdepim/kmail/kmail_part.cpp	Sun Oct 17 21:48:32 2004
@@ -214,6 +214,7 @@
 {
   kdDebug(5006) << "KMailPart::guiActivateEvent" << endl;
   KParts::ReadOnlyPart::guiActivateEvent(e);
+  mainWidget->initializeFilterActions();
 }
 
 void KMailPart::exit()
diff -urN -x CVS kdepim.orig/kmail/kmailicalIface.h kdepim/kmail/kmailicalIface.h
--- kdepim.orig/kmail/kmailicalIface.h	Tue Jul 27 00:05:27 2004
+++ kdepim/kmail/kmailicalIface.h	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /*
     This file is part of KMail.
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kmail/kmailicalifaceimpl.cpp kdepim/kmail/kmailicalifaceimpl.cpp
--- kdepim.orig/kmail/kmailicalifaceimpl.cpp	Wed Sep 29 14:39:44 2004
+++ kdepim/kmail/kmailicalifaceimpl.cpp	Wed Oct 13 16:58:50 2004
@@ -2,7 +2,7 @@
     This file is part of KMail.
 
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -204,7 +204,7 @@
       KMMessage *msg = f->getMsg( i );
       Q_ASSERT( msg );
       if( msg->isComplete() ) {
-        if( KMGroupware::vPartFoundAndDecoded( msg, s ) ) {
+        if( vPartFoundAndDecoded( msg, s ) ) {
           QString uid( "UID" );
           vPartMicroParser( s, uid );
           const Q_UINT32 sernum = msg->getMsgSerNum();
@@ -241,7 +241,7 @@
   Accumulator *ac = mAccumulators.find( parent->location() );
   if( ac ) {
     QString s;
-    if ( !KMGroupware::vPartFoundAndDecoded( msg, s ) ) return;
+    if ( !vPartFoundAndDecoded( msg, s ) ) return;
     QString uid( "UID" );
     vPartMicroParser( s, uid );
     const Q_UINT32 sernum = msg->getMsgSerNum();
@@ -304,7 +304,7 @@
   if( !mUseResourceIMAP )
     return false;
 
-  if( entries.count() & 2 == 1 )
+  if( entries.count() % 2 == 1 )
     // Something is wrong - an odd amount of strings should not happen
     return false;
 
@@ -387,7 +387,7 @@
     KMMessage *msg = folder->getMsg( i );
     if( !msg ) return;
     if( msg->isComplete() ) {
-      if ( !KMGroupware::vPartFoundAndDecoded( msg, s ) ) return;
+      if ( !vPartFoundAndDecoded( msg, s ) ) return;
       kdDebug(5006) << "Emitting DCOP signal incidenceAdded( " << type
                     << ", " << folder->location() << ", " << s << " )" << endl;
       QString uid( "UID" );
@@ -440,7 +440,7 @@
     // Read the iCal or vCard
     bool unget = !folder->isMessage( i );
     QString s;
-    if( KMGroupware::vPartFoundAndDecoded( folder->getMsg( i ), s ) ) {
+    if( vPartFoundAndDecoded( folder->getMsg( i ), s ) ) {
       QString uid( "UID" );
       vPartMicroParser( s, uid );
       kdDebug(5006) << "Emitting DCOP signal incidenceDeleted( "
@@ -463,6 +463,13 @@
   }
 }
 
+void KMailICalIfaceImpl::slotRefreshFolder( KMFolder* folder )
+{
+  const QString type = icalFolderType( folder );
+  if ( !type.isEmpty() )
+    slotRefresh( type );
+}
+
 
 /****************************
  * The folder and message stuff code
@@ -657,12 +664,16 @@
                 this, SLOT( slotIncidenceAdded( KMFolder*, Q_UINT32 ) ) );
     disconnect( folder, SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ),
                 this, SLOT( slotIncidenceDeleted( KMFolder*, Q_UINT32 ) ) );
+    disconnect( folder, SIGNAL( expunged( KMFolder* ) ),
+                this, SLOT( slotRefreshFolder( KMFolder* ) ) );
 
     // And listen to changes from it
     connect( folder, SIGNAL( msgAdded( KMFolder*, Q_UINT32 ) ),
              this, SLOT( slotIncidenceAdded( KMFolder*, Q_UINT32 ) ) );
     connect( folder, SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ),
              this, SLOT( slotIncidenceDeleted( KMFolder*, Q_UINT32 ) ) );
+    connect( folder, SIGNAL( expunged( KMFolder* ) ),
+             this, SLOT( slotRefreshFolder( KMFolder* ) ) );
   }
 
   // Tell about the new resource
@@ -811,16 +822,6 @@
   mContacts = initFolder( KFolderTreeItem::Contacts, "GCo" );
   mNotes    = initFolder( KFolderTreeItem::Notes, "GNo" );
 
-  // Connect the expunged signal
-  connect( mCalendar, SIGNAL( expunged() ), this, SLOT( slotRefreshCalendar() ) );
-  connect( mTasks,    SIGNAL( expunged() ), this, SLOT( slotRefreshTasks() ) );
-  connect( mJournals, SIGNAL( expunged() ), this, SLOT( slotRefreshJournals() ) );
-  connect( mContacts, SIGNAL( expunged() ), this, SLOT( slotRefreshContacts() ) );
-  connect( mNotes,    SIGNAL( expunged() ), this, SLOT( slotRefreshNotes() ) );
-
-  // Bad hack
-  connect( mNotes,    SIGNAL( changed() ),  this, SLOT( slotRefreshNotes() ) );
-
   // Make KOrganizer re-read everything
   slotRefresh( "Calendar" );
   slotRefresh( "Task" );
@@ -845,12 +846,6 @@
   }
 }
 
-void KMailICalIfaceImpl::slotRefreshCalendar() { slotRefresh( "Calendar" ); }
-void KMailICalIfaceImpl::slotRefreshTasks() { slotRefresh( "Task" ); }
-void KMailICalIfaceImpl::slotRefreshJournals() { slotRefresh( "Journal" ); }
-void KMailICalIfaceImpl::slotRefreshContacts() { slotRefresh( "Contact" ); }
-void KMailICalIfaceImpl::slotRefreshNotes() { slotRefresh( "Notes" ); }
-
 KMFolder* KMailICalIfaceImpl::initFolder( KFolderTreeItem::Type itemType,
                                           const char* typeString )
 {
@@ -886,11 +881,15 @@
               this, SLOT( slotIncidenceAdded( KMFolder*, Q_UINT32 ) ) );
   disconnect( folder, SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ),
               this, SLOT( slotIncidenceDeleted( KMFolder*, Q_UINT32 ) ) );
+  disconnect( folder, SIGNAL( expunged( KMFolder* ) ),
+              this, SLOT( slotRefreshFolder( KMFolder* ) ) );
   // Setup the signals to listen for changes
   connect( folder, SIGNAL( msgAdded( KMFolder*, Q_UINT32 ) ),
            this, SLOT( slotIncidenceAdded( KMFolder*, Q_UINT32 ) ) );
   connect( folder, SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ),
            this, SLOT( slotIncidenceDeleted( KMFolder*, Q_UINT32 ) ) );
+  connect( folder, SIGNAL( expunged( KMFolder* ) ),
+           this, SLOT( slotRefreshFolder( KMFolder* ) ) );
 
   return folder;
 }
diff -urN -x CVS kdepim.orig/kmail/kmailicalifaceimpl.h kdepim/kmail/kmailicalifaceimpl.h
--- kdepim.orig/kmail/kmailicalifaceimpl.h	Wed Sep 29 14:39:44 2004
+++ kdepim/kmail/kmailicalifaceimpl.h	Wed Oct 13 16:58:50 2004
@@ -2,7 +2,7 @@
     This file is part of KMail.
 
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -36,7 +36,6 @@
 
 #include "kmailicalIface.h"
 #include "kmfoldertype.h"
-
 #include <kfoldertree.h>
 
 #include <qdict.h>
@@ -164,12 +163,7 @@
   void slotRefresh( const QString& type);
 
 private slots:
-  void slotRefreshCalendar();
-  void slotRefreshTasks();
-  void slotRefreshJournals();
-  void slotRefreshContacts();
-  void slotRefreshNotes();
-
+  void slotRefreshFolder( KMFolder* folder );
   void slotCheckDone();
   void slotMessageRetrieved( KMMessage* );
 
diff -urN -x CVS kdepim.orig/kmail/kmcommands.cpp kdepim/kmail/kmcommands.cpp
--- kdepim.orig/kmail/kmcommands.cpp	Sun Sep 19 23:04:26 2004
+++ kdepim/kmail/kmcommands.cpp	Mon Oct 18 22:17:42 2004
@@ -1572,7 +1572,7 @@
 
 KMCopyCommand::KMCopyCommand( KMFolder* destFolder,
                               const QPtrList<KMMsgBase> &msgList )
-  :mDestFolder( destFolder ), mMsgList( msgList )
+:mDestFolder( destFolder ), mMsgList( msgList )
 {
 }
 
@@ -1690,6 +1690,12 @@
   mMsgList.append( msgBase );
 }
 
+KMMoveCommand::KMMoveCommand( Q_UINT32 )
+:mProgressItem( 0 )
+{
+  setDeletesItself( true );
+}
+
 KMCommand::Result KMMoveCommand::execute()
 {
   setEmitsCompletedItself( true );
@@ -1879,15 +1885,25 @@
 // srcFolder doesn't make much sense for searchFolders
 KMDeleteMsgCommand::KMDeleteMsgCommand( KMFolder* srcFolder,
   const QPtrList<KMMsgBase> &msgList )
-:KMMoveCommand(findTrashFolder( srcFolder ), msgList)
+:KMMoveCommand( findTrashFolder( srcFolder ), msgList)
 {
 }
 
 KMDeleteMsgCommand::KMDeleteMsgCommand( KMFolder* srcFolder, KMMessage * msg )
-:KMMoveCommand(findTrashFolder( srcFolder ), msg)
+:KMMoveCommand( findTrashFolder( srcFolder ), msg)
 {
 }
 
+KMDeleteMsgCommand::KMDeleteMsgCommand( Q_UINT32 sernum )
+:KMMoveCommand( sernum )
+{
+  KMFolder *srcFolder;
+  int idx;
+  kmkernel->msgDict()->getLocation( sernum, &srcFolder, &idx );
+  KMMsgBase *msg = srcFolder->getMsgBase( idx );
+  addMsg( msg );
+  setDestFolder( findTrashFolder( srcFolder ) );
+}
 
 KMFolder * KMDeleteMsgCommand::findTrashFolder( KMFolder * folder )
 {
@@ -1899,6 +1915,7 @@
   return 0;
 }
 
+
 KMUrlClickedCommand::KMUrlClickedCommand( const KURL &url, uint identity,
   KMReaderWin *readerWin, bool htmlPref, KMMainWidget *mainWidget )
   :mUrl( url ), mIdentity( identity ), mReaderWin( readerWin ),
diff -urN -x CVS kdepim.orig/kmail/kmcommands.h kdepim/kmail/kmcommands.h
--- kdepim.orig/kmail/kmcommands.h	Sun Sep 19 23:04:26 2004
+++ kdepim/kmail/kmcommands.h	Mon Oct 18 22:17:42 2004
@@ -652,6 +652,12 @@
   void slotMsgAddedToDestFolder(KMFolder *folder, Q_UINT32 serNum);
   void slotMoveCanceled();
 
+protected:
+  // Needed for KMDeleteCommand for "move to trash"
+  KMMoveCommand( Q_UINT32 sernum );
+  void setDestFolder( KMFolder* folder ) { mDestFolder = folder; }
+  void addMsg( KMMsgBase *msg ) { mMsgList.append( msg ); }
+
 private:
   virtual Result execute();
   void completeMove( Result result );
@@ -671,9 +677,11 @@
 public:
   KMDeleteMsgCommand( KMFolder* srcFolder, const QPtrList<KMMsgBase> &msgList );
   KMDeleteMsgCommand( KMFolder* srcFolder, KMMessage * msg );
+  KMDeleteMsgCommand( Q_UINT32 sernum );
 
 private:
   static KMFolder * findTrashFolder( KMFolder * srcFolder );
+
 };
 
 class KMUrlClickedCommand : public KMCommand
diff -urN -x CVS kdepim.orig/kmail/kmcomposewin.cpp kdepim/kmail/kmcomposewin.cpp
--- kdepim.orig/kmail/kmcomposewin.cpp	Wed Sep 29 19:57:56 2004
+++ kdepim/kmail/kmcomposewin.cpp	Sat Oct 16 11:36:41 2004
@@ -39,8 +39,6 @@
 using KPIM::MailListDrag;
 #include "recentaddresses.h"
 using KRecentAddress::RecentAddresses;
-#include "attachmentcollector.h"
-#include "objecttreeparser.h"
 
 #include <libkpimidentities/identitymanager.h>
 #include <libkpimidentities/identitycombo.h>
@@ -269,7 +267,10 @@
   readConfig();
   setupStatusBar();
   setupEditor();
-  setupActions();
+  if( !aMsg || aMsg->headerField("X-KMail-CryptoFormat").isEmpty() )
+    setupActions();
+  else
+    setupActions( aMsg->headerField("X-KMail-CryptoFormat").stripWhiteSpace().toInt() );
 
   applyMainWindowSettings(KMKernel::config(), "Composer");
 
@@ -933,7 +934,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::setupActions(void)
+void KMComposeWin::setupActions(int aCryptoMessageFormat)
 {
   if (kmkernel->msgSender()->sendImmediate()) //default == send now?
   {
@@ -1157,9 +1158,9 @@
   }
 
   connect(mEncryptAction, SIGNAL(toggled(bool)),
-                         SLOT(slotEncryptToggled( bool )));
-  connect(mSignAction,    SIGNAL(toggled(bool)),
-                         SLOT(slotSignToggled(    bool )));
+                          SLOT(slotEncryptToggled( bool )));
+  connect(mSignAction,   SIGNAL(toggled(bool)),
+                         SLOT(slotSignToggled(     bool )));
 
   QStringList l;
   for ( int i = 0 ; i < numCryptoMessageFormats ; ++i )
@@ -1169,7 +1170,11 @@
 					   this, SLOT(slotSelectCryptoModule()),
 					   actionCollection(), "options_select_crypto" );
   mCryptoModuleAction->setItems( l );
-  mCryptoModuleAction->setCurrentItem( format2cb( ident.preferredCryptoMessageFormat() ) );
+  mCryptoModuleAction->setCurrentItem(
+    format2cb(   (0 <= aCryptoMessageFormat)
+               ? (Kleo::CryptoMessageFormat)aCryptoMessageFormat
+               : ident.preferredCryptoMessageFormat() ) );
+  
   slotSelectCryptoModule();
 
   QStringList styleItems;
@@ -1490,6 +1495,15 @@
   mLastIdentityHasSigningKey = !ident.pgpSigningKey().isEmpty() || !ident.smimeSigningKey().isEmpty();
   mLastIdentityHasEncryptionKey = !ident.pgpEncryptionKey().isEmpty() || !ident.smimeEncryptionKey().isEmpty();
 
+  if( !mMsg->headerField("X-KMail-CryptoFormat").isEmpty() ){
+    const int format = mMsg->headerField("X-KMail-CryptoFormat").stripWhiteSpace().toInt();
+    if( 0 <= format ){
+      mCryptoModuleAction->setCurrentItem( 
+        format2cb( (Kleo::CryptoMessageFormat)format ) );
+      slotSelectCryptoModule();
+    }
+  }
+
   if ( Kleo::CryptoBackendFactory::instance()->openpgp() || Kleo::CryptoBackendFactory::instance()->smime() ) {
     const bool canOpenPGPSign = Kleo::CryptoBackendFactory::instance()->openpgp()
       && !ident.pgpSigningKey().isEmpty();
@@ -1524,58 +1538,6 @@
 
   mDictionaryCombo->setCurrentByDictionary( ident.dictionary() );
 
-  partNode * root = partNode::fromMessage( mMsg );
-
-  KMail::ObjectTreeParser otp; // all defaults are ok
-  otp.parseObjectTree( root );
-
-  KMail::AttachmentCollector ac;
-  ac.setDiveIntoEncryptions( true );
-  ac.setDiveIntoSignatures( true );
-  ac.setDiveIntoMessages( false );
-
-  ac.collectAttachmentsFrom( root );
-
-  for ( std::vector<partNode*>::const_iterator it = ac.attachments().begin() ; it != ac.attachments().end() ; ++it )
-    addAttach( new KMMessagePart( (*it)->msgPart() ) );
-
-  kdDebug(5006) << endl << endl << "TEXTUAL CONTENT: " << endl << otp.textualContent() << endl;
-  mEditor->setText( otp.textualContent() );
-
-  mCharset = otp.textualContentCharset();
-  if ( mCharset.isEmpty() )
-    mCharset = mMsg->charset();
-  if ( mCharset.isEmpty() )
-    mCharset = mDefCharset;
-  setCharset( mCharset );
-
-  if ( partNode * n = root->findType( DwMime::kTypeText, DwMime::kSubtypeHtml ) )
-    if ( partNode * p = n->parentNode() )
-      if ( p->hasType( DwMime::kTypeMultipart ) &&
-           p->hasSubType( DwMime::kSubtypeAlternative ) )
-        if ( mMsg->headerField( "X-KMail-Markup" ) == "true" )
-          toggleMarkup( true );
-
-  /* Handle the special case of non-mime mails */
-  if ( mMsg->numBodyParts() == 0 ) {
-    mCharset=mMsg->charset();
-    if ( mCharset.isEmpty() ||  mCharset == "default" )
-      mCharset = mDefCharset;
-
-    QCString bodyDecoded = mMsg->bodyDecoded();
-
-    if( allowDecryption )
-      decryptOrStripOffCleartextSignature( bodyDecoded );
-
-    const QTextCodec *codec = KMMsgBase::codecForName(mCharset);
-    if (codec) {
-      mEditor->setText(codec->toUnicode(bodyDecoded));
-    } else
-      mEditor->setText(QString::fromLocal8Bit(bodyDecoded));
-  }
-
-
-#ifdef BROKEN_FOR_OPAQUE_SIGNED_OR_ENCRYPTED_MAILS
   const int num = mMsg->numBodyParts();
   kdDebug(5006) << "KMComposeWin::setMsg() mMsg->numBodyParts="
                 << mMsg->numBodyParts() << endl;
@@ -1665,7 +1627,6 @@
   }
 
   setCharset(mCharset);
-#endif // BROKEN_FOR_OPAQUE_SIGNED_OR_ENCRYPTED_MAILS
 
   if( mAutoSign && mayAutoSign ) {
     //
@@ -3056,6 +3017,9 @@
       (!hf.isEmpty() && (hf != mTransport->text(0))))
     mMsg->setHeaderField("X-KMail-Transport", mTransport->currentText());
 
+  if( saveInDrafts )
+    mMsg->setHeaderField("X-KMail-CryptoFormat", QString::number(cryptoMessageFormat()));
+  
   mDisableBreaking = saveInDrafts;
 
   const bool neverEncrypt = saveInDrafts && mNeverEncryptWhenSavingInDrafts;
@@ -4049,6 +4013,7 @@
     QStringList::Iterator it = recent.begin();
     QString name, email;
     for ( ; it != recent.end(); ++it ) {
+      //kdDebug(5006) << "KMLineEdit::loadContacts() found: \"" << *it << "\"" << endl;
       KABC::Addressee addr;
       KPIM::getNameAndMail(*it, name, email);
       addr.setNameFromString( name );
diff -urN -x CVS kdepim.orig/kmail/kmcomposewin.h kdepim/kmail/kmcomposewin.h
--- kdepim.orig/kmail/kmcomposewin.h	Tue Sep 28 10:40:27 2004
+++ kdepim/kmail/kmcomposewin.h	Sat Oct 16 11:36:41 2004
@@ -612,7 +612,7 @@
   /**
    * Initialization methods
    */
-  void setupActions();
+  void setupActions(int aCryptoMessageFormat=-1);
   void setupStatusBar();
   void setupEditor();
 
diff -urN -x CVS kdepim.orig/kmail/kmfolder.cpp kdepim/kmail/kmfolder.cpp
--- kdepim.orig/kmail/kmfolder.cpp	Thu Aug  5 23:58:23 2004
+++ kdepim/kmail/kmfolder.cpp	Wed Oct 13 15:25:14 2004
@@ -62,7 +62,8 @@
   // Resend all mStorage signals
   connect( mStorage, SIGNAL( changed() ), SIGNAL( changed() ) );
   connect( mStorage, SIGNAL( cleared() ), SIGNAL( cleared() ) );
-  connect( mStorage, SIGNAL( expunged() ), SIGNAL( expunged() ) );
+  connect( mStorage, SIGNAL( expunged( KMFolder* ) ),
+           SIGNAL( expunged( KMFolder* ) ) );
   connect( mStorage, SIGNAL( nameChanged() ), SIGNAL( nameChanged() ) );
   connect( mStorage, SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ),
            SIGNAL( msgRemoved( KMFolder*, Q_UINT32 ) ) );
@@ -118,7 +119,7 @@
   mIdentity = config->readUnsignedNumEntry("Identity",0);
 
   setUserWhoField( config->readEntry("WhoField"), false );
-  uint savedId = config->readUnsignedNumEntry("Id", 0); 
+  uint savedId = config->readUnsignedNumEntry("Id", 0);
   // make sure that we don't overwrite a valid id
   if ( savedId != 0 && mId == 0 )
     mId = savedId;
diff -urN -x CVS kdepim.orig/kmail/kmfolder.h kdepim/kmail/kmfolder.h
--- kdepim.orig/kmail/kmfolder.h	Thu Jul 22 21:17:09 2004
+++ kdepim/kmail/kmfolder.h	Wed Oct 13 15:25:14 2004
@@ -506,7 +506,7 @@
 
   /** Emitted after an expunge. If not quiet, changed() will be
       emmitted first. */
-  void expunged();
+  void expunged( KMFolder* );
 
   /** Emitted when the icon paths are set. */
   void iconsChanged();
diff -urN -x CVS kdepim.orig/kmail/kmfoldercachedimap.cpp kdepim/kmail/kmfoldercachedimap.cpp
--- kdepim.orig/kmail/kmfoldercachedimap.cpp	Tue Sep 28 13:45:38 2004
+++ kdepim/kmail/kmfoldercachedimap.cpp	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  kmfoldercachedimap.cpp
  *
- *  Copyright (c) 2002-2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2002-2004 Bo Thorsen <bo@sonofthor.dk>
  *  Copyright (c) 2002-2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -urN -x CVS kdepim.orig/kmail/kmfoldercachedimap.h kdepim/kmail/kmfoldercachedimap.h
--- kdepim.orig/kmail/kmfoldercachedimap.h	Tue Sep 28 13:45:38 2004
+++ kdepim/kmail/kmfoldercachedimap.h	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  kmfoldercachedimap.cpp
  *
- *  Copyright (c) 2002-2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2002-2004 Bo Thorsen <bo@sonofthor.dk>
  *  Copyright (c) 2002-2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -urN -x CVS kdepim.orig/kmail/kmfoldersearch.cpp kdepim/kmail/kmfoldersearch.cpp
--- kdepim.orig/kmail/kmfoldersearch.cpp	Wed Aug  4 19:09:06 2004
+++ kdepim/kmail/kmfoldersearch.cpp	Wed Oct 13 13:11:35 2004
@@ -3,6 +3,8 @@
 
 //Factor byteswap stuff into one header file
 
+#include <config.h>
+
 #include "kmfoldersearch.h"
 #include "kmfolderimap.h"
 #include "kmfoldermgr.h"
@@ -26,7 +28,6 @@
 #include <sys/stat.h>
 #include <sys/file.h>
 #include <utime.h>
-#include <config.h>
 
 #ifdef HAVE_BYTESWAP_H
 #include <byteswap.h>
@@ -36,6 +37,7 @@
 // on platforms where bswap_NN happens to be a function instead of a define.
 
 /* Swap bytes in 32 bit value.  */
+#ifndef kmail_swap_32
 #ifdef bswap_32
 #define kmail_swap_32(x) bswap_32(x)
 #else
@@ -43,12 +45,13 @@
      ((((x) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >>  8) |               \
       (((x) & 0x0000ff00) <<  8) | (((x) & 0x000000ff) << 24))
 #endif
+#endif // kmail_swap_32
 
 // Current version of the .index.search files
-#define IDS_VERSION 1000
+#define IDS_SEARCH_VERSION 1000
 // The asterisk at the end is important
-#define IDS_HEADER "# KMail-Search-IDs V%d\n*"
-#define IDS_HEADER_LEN 30
+#define IDS_SEARCH_HEADER "# KMail-Search-IDs V%d\n*"
+#define IDS_SEARCH_HEADER_LEN 30
 
 
 KMSearch::KMSearch(QObject * parent, const char * name)
@@ -785,7 +788,7 @@
         truncate(QFile::encodeName(filename), 0);
         return -1;
     }
-    fprintf(tmpIndexStream, IDS_HEADER, IDS_VERSION);
+    fprintf(tmpIndexStream, IDS_SEARCH_HEADER, IDS_SEARCH_VERSION);
     Q_UINT32 byteOrder = 0x12345678;
     fwrite(&byteOrder, sizeof(byteOrder), 1, tmpIndexStream);
 
@@ -837,8 +840,8 @@
         return false;
 
     int version = 0;
-    fscanf(mIdsStream, IDS_HEADER, &version);
-    if (version != IDS_VERSION) {
+    fscanf(mIdsStream, IDS_SEARCH_HEADER, &version);
+    if (version != IDS_SEARCH_VERSION) {
         fclose(mIdsStream);
         mIdsStream = 0;
         return false;
@@ -955,7 +958,7 @@
 
 void KMFolderSearch::truncateIndex()
 {
-    truncate(QFile::encodeName(indexLocation()), IDS_HEADER_LEN);
+    truncate(QFile::encodeName(indexLocation()), IDS_SEARCH_HEADER_LEN);
 }
 
 void KMFolderSearch::examineAddedMessage(KMFolder *aFolder, Q_UINT32 serNum)
diff -urN -x CVS kdepim.orig/kmail/kmgroupware.cpp kdepim/kmail/kmgroupware.cpp
--- kdepim.orig/kmail/kmgroupware.cpp	Fri Jun  4 02:04:09 2004
+++ kdepim/kmail/kmgroupware.cpp	Thu Oct  7 13:05:00 2004
@@ -3,7 +3,7 @@
 
     This file is part of KMail.
 
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
     Copyright (c) 2002 Karl-Heinz Zimmer <khz@klaralvdalens-datakonsult.se>
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
 
@@ -35,66 +35,15 @@
 */
 
 #include "kmgroupware.h"
-
-#include "kmmainwin.h"
-#include "kmmainwidget.h"
-#include "kmfoldertree.h"
-#include "kmcomposewin.h"
-#include <libkpimidentities/identity.h>
-#include <libkpimidentities/identitymanager.h>
-#include <libkdepim/email.h>
-#include "kmkernel.h"
-
-#include <kurl.h>
-#include <kmessagebox.h>
-#include <dcopclient.h>
-#include <kdcopservicestarter.h>
-#include <kconfig.h>
-#include <kapplication.h>
-#include <kinputdialog.h>
+#include "kmmessage.h"
+#include "kmmsgpart.h"
+#include "libkcal/incidenceformatter.h"
 #include <kdebug.h>
-#include <qregexp.h>
-
 #include <mimelib/enum.h>
-
 #include <assert.h>
 
-#include "korganizeriface_stub.h"
-
-
-// Handle KOrganizer connection
-static bool connectToKOrganizer();
-static KOrganizerIface_stub* mKOrganizerIfaceStub;
-
 
-//-----------------------------------------------------------------------------
-KMGroupware::KMGroupware( QObject* parent, const char* name )
-  : QObject( parent, name ), mUseGroupware( false )
-{
-  // Make the connection to KOrganizer ready
-  mKOrganizerIfaceStub = 0;
-  kapp->dcopClient()->setNotifications( true );
-  connect( kapp->dcopClient(), SIGNAL( applicationRemoved( const QCString& ) ),
-           this, SLOT( unregisteredFromDCOP( const QCString& ) ) );
-
-  // Listen to config changes
-  connect( kmkernel, SIGNAL( configChanged() ), this, SLOT( readConfig() ) );
-}
-
-//-----------------------------------------------------------------------------
-KMGroupware::~KMGroupware()
-{
-  kapp->dcopClient()->setNotifications( false );
-  delete mKOrganizerIfaceStub;
-}
-
-void KMGroupware::readConfig()
-{
-  KConfigGroup options( KMKernel::config(), "Groupware" );
-  mUseGroupware = options.readBoolEntry( "Enabled", false );
-}
-
-bool KMGroupware::vPartFoundAndDecoded( KMMessage* msg, QString& s )
+bool vPartFoundAndDecoded( KMMessage* msg, QString& s )
 {
   assert( msg );
 
@@ -119,12 +68,8 @@
       // kdDebug(5006) << "KMGroupware analyzing TNEF data" << endl;
       KMMessagePart msgPart;
       KMMessage::bodyPart(dwPart, &msgPart);
-      if ( !connectToKOrganizer() )
-        kdError() << "DCOP error during KMGroupware::vPartFoundAndDecoded()\n";
-      else {
-        s = mKOrganizerIfaceStub->msTNEFToVPart( msgPart.bodyDecodedBinary() );
-        return !s.isEmpty();
-      }
+      s = KCal::IncidenceFormatter::msTNEFToVPart( msgPart.bodyDecodedBinary() );
+      return !s.isEmpty();
     } else {
       dwPart = msg->findDwBodyPart( DwMime::kTypeText, DwMime::kSubtypeVCal );
       if (dwPart) {
@@ -141,279 +86,3 @@
 
   return false;
 }
-
-/*
- * Message part formatting
- */
-
-QString KMGroupware::vPartToHTML( const QString& /*iCal*/ )
-{
-  return "<b>This is an iCalendar attachment handled by the wrong bodypart"
-         "formatterplugin.</b><p/>";
-#if 0
-  QString html;
-
-  if( mUseGroupware ) {
-    // Call KOrganizer and make that format the mail
-    if ( !connectToKOrganizer() ) {
-      kdError() << "DCOP error during KMGroupware::processVCalRequest()\n";
-    } else {
-      html = mKOrganizerIfaceStub->formatICal( iCal );
-      kdDebug(5006) << "KOrganizer call succeeded, html = " << html << endl;
-    }
-  }
-
-  return html;
-#endif
-}
-
-QString KMGroupware::msTNEFToHTML( const QByteArray& tnef )
-{
-  QString html;
-
-  if( mUseGroupware ) {
-    // Call KOrganizer and make that format the mail
-    if ( !connectToKOrganizer() ) {
-      kdError() << "DCOP error during KMGroupware::processVCalRequest()\n";
-    } else {
-      html = mKOrganizerIfaceStub->formatTNEF( tnef );
-      kdDebug(5006) << "KOrganizer call succeeded, html = " << html << endl;
-    }
-  }
-
-  return html;
-}
-
-/*
- * Groupware URL handling
- */
-
-static void iCalRequest( const QString& receiver, const QString& iCal,
-                         const QString& choice )
-{
-#if 0
-  // FIXME: Reinstate Outlook workaround
-  // If we are in legacy mode, and there is more than one receiver, we
-  // need to ask the user which address to use
-  KMMessage* msgOld = mMainWidget->headers()->currentMsg();
-  KConfigGroup options( KMKernel::config(), "Groupware" );
-  QString fromAddress; // this variable is only used in legacy mode
-  if( options.readBoolEntry( "LegacyMangleFromToHeaders", false ) ) {
-      QStringList toAddresses = KPIM::splitEmailAddrList( msgOld->to() );
-      if( toAddresses.count() <= 1 )
-          // only one address: no problem, we can spare the user the dialog
-          // and just take the from address
-          fromAddress = msgOld->to();
-      else {
-          // We have more than one To: address and are in legacy mode. Next
-          // try is to search the identities for one of the email addresses
-          // in the toAddresses list.
-          for( QStringList::Iterator sit = toAddresses.begin();
-               sit != toAddresses.end(); ++sit ) {
-              if( KPIM::getEmailAddr( *sit ) ==
-                  kmkernel->identityManager()->defaultIdentity().emailAddr().local8Bit() ) {
-                  // our default identity was contained in the To: list,
-                  // copy that from To: to From:
-                  fromAddress = *sit;
-                  break; // We are done
-              }
-          }
-
-          // If we still haven't found anything, we have to ask the user
-          // what to do.
-          if( fromAddress.isEmpty() ) {
-              bool bOk;
-              fromAddress = KInputDialog::getItem( i18n( "Select Address" ),
-                                                   i18n( "In order to let Outlook recognize you as the receiver, you need to indicate which one of the following addresses is your email address:" ),
-                                                   toAddresses, 0, false, &bOk,
-                                                   kmkernel->mainWin() );
-              if( !bOk )
-                  // If the user didn't select anything, just take the
-                  // first one so that we have something at all.
-                  fromAddress = toAddresses.first();
-          }
-      }
-  }
-#endif
-
-  if ( !connectToKOrganizer() )
-    kdError() << "DCOP error during KMGroupware::processVCalRequest()\n";
-  else {
-    bool rc = mKOrganizerIfaceStub->eventRequest( choice, receiver, iCal );
-    kdDebug(5006) << "KOrganizer call succeeded, rc = " << rc << endl;
-
-#if 0
-    // TODO(bo): We need to delete the msg somehow
-    if( rc && mMainWidget ) mMainWidget->slotTrashMsg();
-#endif
-  }
-}
-
-static void iCalReply( const QString& iCal )
-{
-  bool event;
-  if( iCal.find( QRegExp( "BEGIN:\\s*VEVENT" ) ) != -1 )
-    event = true;
-  else if( iCal.find( QRegExp( "BEGIN:\\s*VTODO" ) ) != -1 )
-    event = false;
-  else {
-    kdDebug(5006) << "processVCalReply called with something that is not a iCal\n";
-    return;
-  }
-
-  // Step 1: call Organizer
-  if ( !connectToKOrganizer() )
-    kdError() << "DCOP error during KMGroupware::processVCalReply()\n";
-  else {
-    bool rc = mKOrganizerIfaceStub->eventReply( iCal );
-    kdDebug(5006) << "KOrganizer call succeeded, rc = " << rc << endl;
-
-    // step 2: inform user that Organizer was updated
-    KMessageBox::information( kmkernel->mainWin(),
-                              (event ?
-                               i18n("The answer was registered in your calendar.") :
-                               i18n("The answer was registered in your task list.")),
-                              QString::null, "groupwareBox");
-
-#if 0
-    // An answer was saved, so trash the message
-    if( mMainWidget ) mMainWidget->slotTrashMsg();
-#endif
-  }
-}
-
-static void iCalCancel( const QString& iCal )
-{
-  if ( !connectToKOrganizer() )
-    kdError() << "DCOP error during KMGroupware::iCalCancel()\n";
-  else {
-    bool rc = mKOrganizerIfaceStub->cancelEvent( iCal );
-    kdDebug(5006) << "KOrganizer call succeeded, rc = " << rc << endl;
-
-#if 0
-    // An answer was saved, so trash the message
-    if( mMainWidget ) mMainWidget->slotTrashMsg();
-#endif
-  }
-}
-
-// Return the part up until the first '_' or '#', or all of it
-// Chop off the used part of the string
-static QString urlPart( QString& aUrl )
-{
-  QString result;
-  int i = aUrl.find( '_' );
-  if( i < 0 ) i = aUrl.find( '#' );
-  if( i < 0 ) {
-    // Just take the remaining part
-    result = aUrl;
-    aUrl.truncate( 0 );
-  } else {
-    result = aUrl.left( i );
-    aUrl = aUrl.mid( i + 1 );
-  }
-  return result;
-}
-
-bool KMGroupware::handleLink( const KURL &url, KMMessage* msg )
-{
-  QString aUrl = url.path();
-  if( urlPart( aUrl ) != "groupware" ) return false;
-  QString gwAction = urlPart( aUrl );
-
-  // Find the part of the message with the iCal
-  QString iCal;
-  if( !vPartFoundAndDecoded( msg, iCal ) ) {
-    kdDebug(5006) << "Could not find the iCal for this link\n";
-    return false;
-  }
-
-  if( gwAction == "request" ) {
-    // Find the receiver if we can
-    QString receiver;
-    if( msg ) {
-      KPIM::Identity ident =
-        kmkernel->identityManager()->identityForAddress( msg->to() );
-      if( ident != KPIM::Identity::null ) {
-        receiver = ident.emailAddr();
-      } else {
-        QStringList addrs = KPIM::splitEmailAddrList( msg->to() );
-        if( addrs.count() == 1 )
-          // Don't ask the user to choose between 1 items
-          receiver = addrs[0];
-        else {
-          bool ok;
-          receiver = KInputDialog::
-            getItem( i18n("Select Address"),
-                     i18n("None of your identities match the receiver "
-                          "of this message,<br> please choose which of "
-                          "the following addresses is yours:"),
-                     addrs, 0, FALSE, &ok, kmkernel->mainWin() );
-          if( !ok ) return false;
-        }
-      }
-    }
-    iCalRequest( receiver, iCal, urlPart( aUrl ) );
-  } else if( gwAction == "reply" )
-    iCalReply( iCal );
-  else if( gwAction == "cancel" )
-    iCalCancel( iCal );
-  else {
-    // What what what?
-    kdDebug(5006) << "Unknown groupware action " << gwAction << endl;
-    return false;
-  }
-
-  return true;
-}
-
-/*
- * Handle connection to KOrganizer.
- */
-
-static const QCString dcopObjectId = "KOrganizerIface";
-
-static bool connectToKOrganizer()
-{
-  if ( !mKOrganizerIfaceStub ) {
-    QString error;
-    QCString dcopService;
-    int result = KDCOPServiceStarter::self()->
-      findServiceFor( "DCOP/Organizer", QString::null,
-                      QString::null, &error, &dcopService );
-    if ( result != 0 ) {
-      kdDebug(5800) << "Could not connect to KOrganizer\n";
-      // TODO: You might want to show "error" (if not empty) here,
-      // using e.g. KMessageBox
-      return false;
-    }
-
-    QCString dummy;
-    // OK, so korganizer (or kontact) is running. Now ensure the object we want is available.
-    if ( !kapp->dcopClient()->findObject( dcopService, dcopObjectId, "", QByteArray(), dcopService, dummy ) ) {
-      KDCOPServiceStarter::self()->startServiceFor( "DCOP/Organizer", QString::null,
-                                                    QString::null, &error, &dcopService );
-      if( !kapp->dcopClient()->findObject( dcopService, dcopObjectId, "", QByteArray(), dcopService, dummy ) )
-        return false;
-    }
-
-    mKOrganizerIfaceStub = new KOrganizerIface_stub( kapp->dcopClient(),
-                                                     dcopService,
-                                                     dcopObjectId );
-  }
-
-  return ( mKOrganizerIfaceStub != 0 );
-}
-
-void KMGroupware::unregisteredFromDCOP( const QCString& appId )
-{
-  if ( mKOrganizerIfaceStub && mKOrganizerIfaceStub->app() == appId ) {
-    // Delete the stub so that the next time we need the organizer,
-    // we'll know that we need to start a new one.
-    delete mKOrganizerIfaceStub;
-    mKOrganizerIfaceStub = 0;
-  }
-}
-
-
-#include "kmgroupware.moc"
diff -urN -x CVS kdepim.orig/kmail/kmgroupware.h kdepim/kmail/kmgroupware.h
--- kdepim.orig/kmail/kmgroupware.h	Mon Mar 29 17:33:01 2004
+++ kdepim/kmail/kmgroupware.h	Thu Oct  7 11:20:22 2004
@@ -3,7 +3,7 @@
 
     This file is part of KMail.
 
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
     Copyright (c) 2002 Karl-Heinz Zimmer <khz@klaralvdalens-datakonsult.se>
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
 
@@ -37,52 +37,10 @@
 #ifndef KMGROUPWARE_H
 #define KMGROUPWARE_H
 
-#include <qguardedptr.h>
+#include <qstring.h>
 
-class KMAccount;
 class KMMessage;
-class KMMainWidget;
-class KURL;
-
-
-class KMGroupware : public QObject
-{
-  Q_OBJECT
-
-public:
-  KMGroupware( QObject* parent = 0, const char* name = 0 );
-  ~KMGroupware();
-
-  bool isEnabled() const { return mUseGroupware; }
-
-  /**
-     Retrieve matching body part (either text/vCal (or vCard) or
-     application/ms-tnef) and decode it.
-
-     If return value is true, s holds a readable vPart.
-  */
-  static bool vPartFoundAndDecoded( KMMessage* msg, QString& s );
-
-  // functions to be called by KMReaderWin for 'print formatting'
-  QString vPartToHTML( const QString& iCal );
-  QString msTNEFToHTML( const QByteArray& tnef );
-
-  /**
-     KMReaderWin calls this with a URL. Return true if a groupware
-     url was handled.
-  */
-  bool handleLink( const KURL &aUrl, KMMessage* msg );
-
-public slots:
-  /* (Re-)Read configuration file */
-  void readConfig();
-
-private slots:
-  void unregisteredFromDCOP( const QCString& );
-
-private:
-  bool mUseGroupware;
-};
 
+bool vPartFoundAndDecoded( KMMessage* msg, QString& s );
 
 #endif /* KMGROUPWARE_H */
diff -urN -x CVS kdepim.orig/kmail/kmheaders.cpp kdepim/kmail/kmheaders.cpp
--- kdepim.orig/kmail/kmheaders.cpp	Fri Sep 24 22:55:56 2004
+++ kdepim/kmail/kmheaders.cpp	Wed Oct 13 15:25:14 2004
@@ -925,7 +925,7 @@
                  this, SLOT(msgChanged()));
       disconnect(mFolder, SIGNAL(cleared()),
                  this, SLOT(folderCleared()));
-      disconnect(mFolder, SIGNAL(expunged()),
+      disconnect(mFolder, SIGNAL(expunged( KMFolder* )),
                  this, SLOT(folderCleared()));
       disconnect( mFolder, SIGNAL( statusMsg( const QString& ) ),
                   BroadcastStatus::instance(), SLOT( setStatusMsg( const QString& ) ) );
@@ -955,7 +955,7 @@
               this, SLOT(msgChanged()));
       connect(mFolder, SIGNAL(cleared()),
               this, SLOT(folderCleared()));
-      connect(mFolder, SIGNAL(expunged()),
+      connect(mFolder, SIGNAL(expunged( KMFolder* )),
                  this, SLOT(folderCleared()));
       connect(mFolder, SIGNAL(statusMsg(const QString&)),
               BroadcastStatus::instance(), SLOT( setStatusMsg( const QString& ) ) );
@@ -1020,7 +1020,7 @@
 //-----------------------------------------------------------------------------
 void KMHeaders::msgChanged()
 {
-  emit maybeDeleting();
+ // emit maybeDeleting();
   if (mFolder->count() == 0) { // Folder cleared
     clear();
     return;
diff -urN -x CVS kdepim.orig/kmail/kmkernel.cpp kdepim/kmail/kmkernel.cpp
--- kdepim.orig/kmail/kmkernel.cpp	Tue Sep 28 10:40:27 2004
+++ kdepim/kmail/kmkernel.cpp	Tue Oct 12 00:00:41 2004
@@ -35,11 +35,8 @@
 #include "configuredialog.h"
 #include "kmcommands.h"
 #include "kmsystemtray.h"
-// #### disabled for now #include "startupwizard.h"
-
 
 #include <kwin.h>
-#include "kmgroupware.h"
 #include "kmailicalifaceimpl.h"
 #include "mailserviceimpl.h"
 using KMail::MailServiceImpl;
@@ -124,8 +121,6 @@
   // would be unexpected
   GlobalSettings::self();
 
-  mGroupware = new KMGroupware( this );
-
   // Set up DCOP interface
   mICalIface = new KMailICalIfaceImpl();
 
@@ -423,20 +418,22 @@
   if ( !body.isEmpty() ) msg->setBody(body.utf8());
 
   bool iCalAutoSend = false;
+  bool noWordWrap = false;
   KConfigGroup options( config(), "Groupware" );
   if (  !attachData.isEmpty() ) {
     if ( attachName == "cal.ics" && attachType == "text" &&
-	attachSubType == "calendar" && attachParamAttr == "method" &&
-	options.readBoolEntry( "LegacyBodyInvites", false ) ) {
+        attachSubType == "calendar" && attachParamAttr == "method" &&
+        options.readBoolEntry( "LegacyBodyInvites", false ) ) {
       // KOrganizer invitation caught and to be sent as body instead
       msg->setBody( attachData );
       msg->setHeaderField( "Content-Type",
-			   QString( "text/calendar; method=%1; "
+                           QString( "text/calendar; method=%1; "
                                     "charset=\"utf-8\"" ).
-			   arg( attachParamValue ) );
+                           arg( attachParamValue ) );
 
       // Don't show the composer window, if the automatic sending is checked
       iCalAutoSend = options.readBoolEntry( "AutomaticSending", true );
+      noWordWrap = true; // we shant word wrap inline invitations
     } else {
       // Just do what we're told to do
       msgPart = new KMMessagePart;
@@ -448,16 +445,16 @@
       msgPart->setParameter( attachParamAttr, attachParamValue );
       msgPart->setContentDisposition( attachContDisp );
       if( !attachCharset.isEmpty() ) {
-	// kdDebug(5006) << "KMKernel::openComposer set attachCharset to "
+        // kdDebug(5006) << "KMKernel::openComposer set attachCharset to "
         // << attachCharset << endl;
-	msgPart->setCharset( attachCharset );
+        msgPart->setCharset( attachCharset );
       }
     }
   }
 
   KMComposeWin *cWin = new KMComposeWin( msg );
   cWin->setAutoDelete( true );
-  if( iCalAutoSend )
+  if( noWordWrap )
     cWin->slotWordWrapToggled( false );
   else
     cWin->setCharset( "", true );
@@ -686,7 +683,7 @@
 QStringList KMKernel::folderList() const
 {
   QStringList folders;
-  const QString localPrefix = i18n( "/Local" );
+  const QString localPrefix = "/Local";
   folders << localPrefix;
   the_folderMgr->getFolderURLS( folders, localPrefix );
   the_imapFolderMgr->getFolderURLS( folders );
@@ -696,7 +693,7 @@
 
 DCOPRef KMKernel::getFolder( const QString& vpath )
 {
-  const QString localPrefix = i18n( "/Local" );
+  const QString localPrefix = "/Local";
   if ( the_folderMgr->getFolderByURL( vpath ) )
     return DCOPRef( new FolderIface( vpath ) );
   else if ( vpath.startsWith( localPrefix ) &&
@@ -1028,7 +1025,6 @@
     }
   }
   readConfig();
-  mGroupware->readConfig();
   mICalIface->readConfig();
   // filterMgr->dump();
 #if 0 //disabled for now..
@@ -1366,11 +1362,6 @@
                       const KURL &messageFile,
                       const KURL::List &attachURLs)
 {
-  // Run the groupware setup wizard. It doesn't do anything if this isn't
-  // the first run. Replace this with a general wizard later
-  // #### Disabled until we have a general startup wizard.
-  // StartupWizard::run();
-
   if (mailto)
     openComposer (to, cc, bcc, subj, body, 0, messageFile, attachURLs);
   else
@@ -1644,12 +1635,6 @@
   return mySelf->mConfig;
 }
 
-KMGroupware & KMKernel::groupware()
-{
-  assert( mGroupware );
-  return *mGroupware;
-}
-
 KMailICalIfaceImpl& KMKernel::iCalIface()
 {
   assert( mICalIface );
@@ -1659,7 +1644,7 @@
 void KMKernel::selectFolder( QString folderPath )
 {
   kdDebug(5006)<<"Selecting a folder "<<folderPath<<endl;
-  const QString localPrefix = i18n( "/Local" );
+  const QString localPrefix = "/Local";
   KMFolder *folder = kmkernel->folderMgr()->getFolderByURL( folderPath );
   if ( !folder && folderPath.startsWith( localPrefix ) )
     folder = the_folderMgr->getFolderByURL( folderPath.mid( localPrefix.length() ) );
diff -urN -x CVS kdepim.orig/kmail/kmkernel.h kdepim/kmail/kmkernel.h
--- kdepim.orig/kmail/kmkernel.h	Sun Sep  5 18:06:40 2004
+++ kdepim/kmail/kmkernel.h	Thu Oct  7 11:20:22 2004
@@ -53,7 +53,6 @@
 class KPassivePopup;
 class KMMainWin;
 class KMainWindow;
-class KMGroupware;
 class KMailICalIfaceImpl;
 class KMReaderWin;
 class KSystemTray;
@@ -207,7 +206,6 @@
   /** Expire all folders, used for the gui action */
   void expireAllFoldersNow();
 
-  KMGroupware& groupware();
   KMailICalIfaceImpl& iCalIface();
 
   bool firstStart() { return the_firstStart; }
@@ -354,7 +352,6 @@
   QTimer *mDeadLetterTimer;
   int mDeadLetterInterval;
   QTimer *mBackgroundTasksTimer;
-  KMGroupware * mGroupware;
   KMailICalIfaceImpl* mICalIface;
   JobScheduler* mJobScheduler;
   // temporary mainwin
diff -urN -x CVS kdepim.orig/kmail/kmmainwidget.cpp kdepim/kmail/kmmainwidget.cpp
--- kdepim.orig/kmail/kmmainwidget.cpp	Mon Sep 20 21:19:42 2004
+++ kdepim/kmail/kmmainwidget.cpp	Sun Oct 17 21:17:24 2004
@@ -101,7 +101,7 @@
 static KStaticDeleter<QPtrList<KMMainWidget> > mwlsd;
 
 //-----------------------------------------------------------------------------
-KMMainWidget::KMMainWidget(QWidget *parent, const char *name, 
+KMMainWidget::KMMainWidget(QWidget *parent, const char *name,
                            KXMLGUIClient *aGUIClient,
                            KActionCollection *actionCollection, KConfig* config ) :
     QWidget(parent, name),
@@ -1470,7 +1470,7 @@
 void KMMainWidget::slotPrintMsg()
 {
   bool htmlOverride = mMsgView ? mMsgView->htmlOverride() : false;
-  KMCommand *command = 
+  KMCommand *command =
     new KMPrintCommand( this, mHeaders->currentMsg(),
                         htmlOverride, mCodec );
   command->start();
@@ -2010,7 +2010,6 @@
   newMessage->setMsgSerNum( msg->getMsgSerNum() );
   newMessage->setReadyToShow( true );
   win->showMsg( mCodec, newMessage );
-  win->resize( 550, 600 );
   win->show();
 }
 
@@ -3145,12 +3144,19 @@
 
 void KMMainWidget::slotShowStartupFolder()
 {
+  if ( mFolderTree ) {
+    mFolderTree->reload();
+    mFolderTree->readConfig();
+    // get rid of old-folders
+    mFolderTree->cleanupConfigFile();
+  }
+
   connect( kmkernel->filterMgr(), SIGNAL( filterListUpdated() ),
 	   this, SLOT( initializeFilterActions() ));
 
   // plug shortcut filter actions now
   initializeFilterActions();
-  
+
   QString newFeaturesMD5 = KMReaderWin::newFeaturesMD5();
   if ( kmkernel->firstStart() ||
        GlobalSettings::previousNewFeaturesMD5() != newFeaturesMD5 ) {
@@ -3166,12 +3172,8 @@
   if ( !startup )
     startup = kmkernel->inboxFolder();
 
-  if ( mFolderTree ) 
-  {
-    mFolderTree->reload();
+  if ( mFolderTree ) {
     mFolderTree->showFolder( startup );
-    // get rid of old-folders
-    mFolderTree->cleanupConfigFile();
   }
 }
 
@@ -3266,12 +3268,8 @@
 
 
 //-----------------------------------------------------------------------------
-void KMMainWidget::initializeFilterActions()
+void KMMainWidget::clearFilterActions()
 {
-  QString filterName, normalizedName;
-  KMMetaFilterActionCommand *filterCommand;
-  KAction *filterAction = 0;
-  
   if ( !mFilterTBarActions.isEmpty() ) {
     if ( mGUIClient->factory() )
       mGUIClient->unplugActionList( "toolbar_filter_actions" );
@@ -3284,6 +3282,17 @@
     mFilterMenuActions.clear();
   }
   mFilterCommands.clear();
+}
+
+
+//-----------------------------------------------------------------------------
+void KMMainWidget::initializeFilterActions()
+{
+  QString filterName, normalizedName;
+  KMMetaFilterActionCommand *filterCommand;
+  KAction *filterAction = 0;
+
+  clearFilterActions();
   for ( QPtrListIterator<KMFilter> it(*kmkernel->filterMgr()) ;
         it.current() ; ++it ) {
     if (!(*it)->isEmpty() && (*it)->configureShortcut()) {
@@ -3304,7 +3313,7 @@
       mFilterMenuActions.append(filterAction);
       // FIXME
       // uncomment the next if statement after the filter dialog supports
-      // separate activation of filters for the toolbar - currently 
+      // separate activation of filters for the toolbar - currently
       // we better depend on whether an icon is defined, so the current
       // IF statement is intermediate
       // if ( (*it)->configureToolbar() )
diff -urN -x CVS kdepim.orig/kmail/kmmainwidget.h kdepim/kmail/kmmainwidget.h
--- kdepim.orig/kmail/kmmainwidget.h	Fri Sep  3 15:13:03 2004
+++ kdepim/kmail/kmmainwidget.h	Sun Oct 17 21:17:24 2004
@@ -185,6 +185,10 @@
   /** The columns of the foldertree changed */
   void slotFolderTreeColumnsChanged();
 
+  /** Clear and create actions for marked filters */
+  void clearFilterActions();
+  void initializeFilterActions();
+ 
 signals:
   void messagesTransfered( bool );
   void captionChangeRequest( const QString & caption );
@@ -347,8 +351,6 @@
   /** changes the caption and displays the foldername */
   void slotChangeCaption(QListViewItem*);
   void removeDuplicates();
-  /** Create actions for marked filters */
-  void initializeFilterActions();
 
   /** Slot to reply to a message */
   void slotReplyToMsg();
diff -urN -x CVS kdepim.orig/kmail/kmmainwin.cpp kdepim/kmail/kmmainwin.cpp
--- kdepim.orig/kmail/kmmainwin.cpp	Wed Sep  8 20:04:59 2004
+++ kdepim/kmail/kmmainwin.cpp	Sun Oct 17 21:17:24 2004
@@ -111,6 +111,9 @@
 
 void KMMainWin::slotEditToolbars()
 {
+  // remove dynamically created actions before editing
+  mKMMainWidget->clearFilterActions();
+  
   saveMainWindowSettings(KMKernel::config(), "Main Window");
   KEditToolbar dlg(actionCollection(), "kmmainwin.rc");
 
@@ -118,6 +121,8 @@
 	   SLOT(slotUpdateToolbars()) );
 
   dlg.exec();
+  // plug dynamically created actions again
+  mKMMainWidget->initializeFilterActions();
 }
 
 void KMMainWin::slotUpdateToolbars()
diff -urN -x CVS kdepim.orig/kmail/kmreadermainwin.cpp kdepim/kmail/kmreadermainwin.cpp
--- kdepim.orig/kmail/kmreadermainwin.cpp	Sun Sep 19 23:04:26 2004
+++ kdepim/kmail/kmreadermainwin.cpp	Sun Oct  3 17:40:54 2004
@@ -63,7 +63,6 @@
     const QTextCodec *codec, char *name )
   : KMail::SecondaryWindow( name ), mMsg( 0 )
 {
-  resize( 550, 600 );
   mReaderWin = new KMReaderWin( this, this, actionCollection() ); //new reader
   mReaderWin->setOverrideCodec( codec );
   mReaderWin->setMsgPart( aMsgPart, aHTML, aFileName, pname );
diff -urN -x CVS kdepim.orig/kmail/kmreaderwin.cpp kdepim/kmail/kmreaderwin.cpp
--- kdepim.orig/kmail/kmreaderwin.cpp	Sat Oct  2 13:08:10 2004
+++ kdepim/kmail/kmreaderwin.cpp	Sun Oct  3 13:40:29 2004
@@ -418,14 +418,14 @@
 kdDebug(5006) << "is Simple part or invalid Multipart, processing single body (if inline encrypted):" << endl;
         // Problem: body text may be inline PGP encrypted, so we can not just dump it.
         // resultingData += part->Body().AsString().c_str();
-        
+
         // Note: parseObjectTree() does no inline PGP decrypting anymore.
         ObjectTreeParser otp( 0, 0, false, false, true );
         dataNode->setProcessed( false, true );
         otp.setKeepEncryptions( false );
         otp.parseObjectTree( curNode );
         //resultingData += otp.rawReplyString();  // re-enable this, once ObjectTreeParser is updated.
-        
+
 
         // Temporary solution, to be replaced by a Kleo::CryptoBackend job inside ObjectTreeParser:
         bool bDecryptedInlinePGP = false;
@@ -447,8 +447,8 @@
         if( !bDecryptedInlinePGP )
           resultingData += otp.rawReplyString();
         // end of temporary solution.
-        
-        
+
+
 kdDebug(5006) << "decrypting of single body - DONE" << endl;
       }
     } else {
@@ -1226,7 +1226,7 @@
   bool emitReplaceMsgByUnencryptedVersion = false;
   const KConfigGroup reader( KMKernel::config(), "Reader" );
   if ( reader.readBoolEntry( "store-displayed-messages-unencrypted", false ) ) {
-  
+
     // Hack to make sure the S/MIME CryptPlugs follows the strict requirement
     // of german government:
     // --> All received encrypted messages *must* be stored in unencrypted form
@@ -1238,7 +1238,7 @@
     //       This could be changed in the objectTreeToDecryptedMsg() function
     //       by deciding when (or when not, resp.) to set the 'dataNode' to
     //       something different than 'curNode'.
-  
+
 kdDebug(5006) << "\n\n\nKMReaderWin::parseMsg()  -  special post-encryption handling:\n1." << endl;
 /*
 kdDebug(5006) << "(aMsg == msg) = "                               << (aMsg == message()) << endl;
@@ -1270,7 +1270,7 @@
       decryptedData.appendNULL();
       QCString resultString( decryptedData.data() );
 kdDebug(5006) << "KMReaderWin  -  resulting data:" << resultString << endl;
-  
+
       if( !resultString.isEmpty() ) {
 kdDebug(5006) << "KMReaderWin  -  composing unencrypted message" << endl;
         // try this:
@@ -1674,7 +1674,6 @@
   msg->setReadyToShow(true);
   KMReaderMainWin *win = new KMReaderMainWin();
   win->showMsg( overrideCodec(), msg );
-  win->resize(550,600);
   win->show();
 }
 
@@ -1911,7 +1910,7 @@
   KURL::List lst;
   KURL url;
   bool autoDelete = true;
-  QString fname = createAtmFileLink(); 
+  QString fname = createAtmFileLink();
 
   if ( fname == QString::null ) {
     autoDelete = false;
@@ -1934,7 +1933,7 @@
     KURL::List lst;
     KURL url;
     bool autoDelete = true;
-    QString fname = createAtmFileLink(); 
+    QString fname = createAtmFileLink();
 
     if ( fname == QString::null ) {
       autoDelete = false;
diff -urN -x CVS kdepim.orig/kmail/kmsearchpattern.cpp kdepim/kmail/kmsearchpattern.cpp
--- kdepim.orig/kmail/kmsearchpattern.cpp	Sat Jul 31 15:47:10 2004
+++ kdepim/kmail/kmsearchpattern.cpp	Sat Oct  9 22:37:07 2004
@@ -175,7 +175,7 @@
 {
   if ( field.isEmpty() || field[0] == '<' )
     mBmHeaderField = 0;
-  else //TODO handle the unrealistic case of the message starting with mField
+  else // make sure you handle the unrealistic case of the message starting with mField
     mBmHeaderField = new DwBoyerMoore(("\n" + field + ": ").data());
 }
 
@@ -239,7 +239,10 @@
     if ( endOfHeader == DwString::npos )
       endOfHeader = lfcrlf.FindIn( aStr, 0 );
     const DwString headers = ( endOfHeader == DwString::npos ) ? aStr : aStr.substr( 0, endOfHeader );
-    size_t start = headerField->FindIn( headers, 0, false );
+    // In case the searched header is at the beginning, we have to prepend 
+    // a newline - see the comment in KMSearchRuleString constructor
+    DwString fakedHeaders( "\n" );
+    size_t start = headerField->FindIn( fakedHeaders.append( headers ), 0, false );
     // if the header field doesn't exist then return false for positive
     // functions and true for negated functions (e.g. "does not
     // contain"); note that all negated string functions correspond
diff -urN -x CVS kdepim.orig/kmail/kmsender.cpp kdepim/kmail/kmsender.cpp
--- kdepim.orig/kmail/kmsender.cpp	Sat Sep 18 00:20:59 2004
+++ kdepim/kmail/kmsender.cpp	Sat Oct 16 11:36:41 2004
@@ -149,6 +149,7 @@
     aMsg->setTo("Undisclosed.Recipients: ;");
   }
 
+  aMsg->removeHeaderField( "X-KMail-CryptoFormat" );
 
   // Handle redirections
   QString from  = aMsg->headerField("X-KMail-Redirect-From");
diff -urN -x CVS kdepim.orig/kmail/messagecomposer.cpp kdepim/kmail/messagecomposer.cpp
--- kdepim.orig/kmail/messagecomposer.cpp	Thu Sep 23 01:48:40 2004
+++ kdepim/kmail/messagecomposer.cpp	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  messagecomposer.cpp
  *
- *  Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/kmail/messagecomposer.h kdepim/kmail/messagecomposer.h
--- kdepim.orig/kmail/messagecomposer.h	Mon May 31 20:35:02 2004
+++ kdepim/kmail/messagecomposer.h	Thu Oct  7 13:05:00 2004
@@ -1,7 +1,7 @@
 /**
  *  messagecomposer.cpp
  *
- *  Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ *  Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/kmail/objecttreeparser.cpp kdepim/kmail/objecttreeparser.cpp
--- kdepim.orig/kmail/objecttreeparser.cpp	Sat Jul 17 16:15:41 2004
+++ kdepim/kmail/objecttreeparser.cpp	Fri Oct  8 09:04:46 2004
@@ -38,7 +38,6 @@
 // other KMail headers
 #include "kmreaderwin.h"
 #include "partNode.h"
-#include "kmgroupware.h"
 #include "kmkernel.h"
 #include <libkdepim/kfileio.h>
 #include <libkdepim/email.h>
@@ -746,44 +745,6 @@
   return bDecryptionOk;
 }
 
-QString ObjectTreeParser::byteArrayToTempFile( KMReaderWin* reader,
-                                               const QString& dirExt,
-                                               const QString& orgName,
-                                               const QByteArray& theBody )
-{
-  KTempFile *tempFile = new KTempFile( QString::null, "." + dirExt );
-  tempFile->setAutoDelete(true);
-  QString fname = tempFile->name();
-  delete tempFile;
-
-  bool bOk = true;
-
-  if (access(QFile::encodeName(fname), W_OK) != 0) // Not there or not writable
-    if (mkdir(QFile::encodeName(fname), 0) != 0
-      || chmod (QFile::encodeName(fname), S_IRWXU) != 0)
-        bOk = false; //failed create
-
-  if ( bOk )
-  {
-    QString fileName( orgName );
-    if ( reader )
-      reader->mTempDirs.append(fname);
-    //fileName.replace(QRegExp("[/\"\']"),"");
-    // strip of a leading path
-    int slashPos = fileName.findRev( '/' );
-    if ( -1 != slashPos )
-      fileName = fileName.mid( slashPos + 1 );
-    if (fileName.isEmpty()) fileName = "unnamed";
-    fname += "/" + fileName;
-
-    if (!KPIM::kByteArrayToFile(theBody, fname, false, false, false))
-      bOk = false;
-    if ( reader )
-      reader->mTempFiles.append(fname);
-  }
-  return bOk ? fname : QString::null;
-}
-
   bool ObjectTreeParser::processTextHtmlSubtype( partNode * curNode, ProcessResult & ) {
     QCString cstr( curNode->msgPart().bodyDecoded() );
 
@@ -830,25 +791,6 @@
     }
     return false;
   }
-
-  bool ObjectTreeParser::processTextVCalSubtype( partNode * curNode,
-                                                 ProcessResult & result ) {
-    // It doesn't make sense to display raw vCals inline
-    result.setNeverDisplayInline( true );
-
-    // For special treatment of invitations etc. we need a reader window
-    if ( !mReader )
-      return false;
-
-    QString iCal = curNode->msgPart().bodyToUnicode();
-    QString html = kmkernel->groupware().vPartToHTML( iCal );
-    if( !html.isEmpty() )
-      htmlWriter()->queue( html );
-    htmlWriter()->queue( quotedHTML( iCal ) );
-
-    return true;
-  }
-
 } // namespace KMail
 
 static bool isMailmanMessage( partNode * curNode ) {
@@ -1056,43 +998,6 @@
     if ( !child )
       return false;
 
-#if 0
-    // Might be a Kroupware message,
-    // let's look for the parts contained in the mixture:
-    partNode * dataPlain = child->findType( DwMime::kTypeText,
-                                            DwMime::kSubtypePlain, false, true );
-
-    // special treatment of vCal attachment (might be invitation or similar)
-    partNode * dataCal = child->findType( DwMime::kTypeText,
-                                          DwMime::kSubtypeVCal, false, true );
-    if ( dataCal ) {
-      ProcessResult dummy;
-      if ( processTextVCalSubtype( dataCal, dummy ) ) {
-        // Kroupware message found,
-        // we can ignore the plain text part
-        if ( dataPlain )
-          dataPlain->setProcessed( true, false );
-        return true;
-      }
-    }
-#endif
-
-#if 0
-    // special treatment of TNEF attachment (might be invitation or similar)
-    partNode * dataTNEF = child->findType( DwMime::kTypeApplication,
-                                           DwMime::kSubtypeMsTNEF, false, true );
-    if ( dataTNEF ) {
-      ProcessResult dummy;
-      if ( processApplicationMsTnefSubtype( dataTNEF, dummy ) ) {
-        // encoded Kroupware message found,
-        // we can ignore the plain text part
-        if ( dataPlain )
-          dataPlain->setProcessed( true, false );
-        return true;
-      }
-    }
-#endif
-
     // normal treatment of the parts in the mp/mixed container
     stdChildHandling( child );
     return true;
@@ -1637,24 +1542,6 @@
     return isSigned || isEncrypted;
   }
 
-  bool ObjectTreeParser::processApplicationMsTnefSubtype( partNode * curNode,
-                                                          ProcessResult & )
-  {
-    // For special treatment of invitations etc. we need a reader window
-    if ( !mReader )
-      return false;
-
-    QByteArray theBody = curNode->msgPart().bodyDecodedBinary();
-    QString html = kmkernel->groupware().msTNEFToHTML( theBody );
-    if( !html.isEmpty() && theBody.size() > 0 )
-      htmlWriter()->queue( html );
-    else
-      return false;
-
-    return true;
-  }
-
-
   void ObjectTreeParser::writeBodyString( const QCString & bodyString,
                                           const QString & fromAddress,
                                           const QTextCodec * codec,
diff -urN -x CVS kdepim.orig/kmail/objecttreeparser.h kdepim/kmail/objecttreeparser.h
--- kdepim.orig/kmail/objecttreeparser.h	Sun Jun  6 19:41:24 2004
+++ kdepim/kmail/objecttreeparser.h	Fri Oct  8 09:04:46 2004
@@ -153,17 +153,6 @@
     //  and it will be replaced once KMime is alive.
     void parseObjectTree( partNode * node );
 
-    /** Save a QByteArray into a new temp. file using the extension
-        given in dirExt to compose the directory name and
-        the name given in fileName as file name
-        and return the path+filename.
-        If parameter reader is valid the directory and file names are added
-        to the reader's temp directories and temp files lists. */
-    static QString byteArrayToTempFile( KMReaderWin* reader,
-                                        const QString& dirExt,
-                                        const QString& fileName,
-                                        const QByteArray& theBody );
-
   private:
     /** Standard children handling a.k.a. multipart/mixed (w/o
 	kroupware hacks) */
@@ -214,7 +203,6 @@
   public:// (during refactoring)
 
     bool processTextHtmlSubtype( partNode * node, ProcessResult & result );
-    bool processTextVCalSubtype( partNode * node, ProcessResult & result );
     bool processTextPlainSubtype( partNode * node, ProcessResult & result );
 
     bool processMultiPartMixedSubtype( partNode * node, ProcessResult & result );
@@ -228,7 +216,6 @@
 
     bool processApplicationOctetStreamSubtype( partNode * node, ProcessResult & result );
     bool processApplicationPkcs7MimeSubtype( partNode * node, ProcessResult & result );
-    bool processApplicationMsTnefSubtype( partNode * node, ProcessResult & result );
 
   private:
     void writeBodyString( const QCString & bodyString,
diff -urN -x CVS kdepim.orig/kmail/partmetadata.h kdepim/kmail/partmetadata.h
--- kdepim.orig/kmail/partmetadata.h	Sat Jul 26 16:51:50 2003
+++ kdepim/kmail/partmetadata.h	Fri Oct  8 08:55:21 2004
@@ -35,7 +35,8 @@
         isEncrypted( false ),
         isDecryptable( false ),
         technicalProblem( false ),
-        isEncapsulatedRfc822Message( false ) {}
+        isEncapsulatedRfc822Message( false ),
+        isWrongKeyUsage( false ) {}
     bool isSigned;
     bool isGoodSignature;
     CryptPlugWrapper::SigStatusFlags sigStatusFlags;
@@ -53,6 +54,7 @@
     QString decryptionError;
     bool technicalProblem;
     bool isEncapsulatedRfc822Message;
+    bool isWrongKeyUsage;
   };
 
 } // namespace KMail
diff -urN -x CVS kdepim.orig/kmail/signatureconfigurationdialog.ui kdepim/kmail/signatureconfigurationdialog.ui
--- kdepim.orig/kmail/signatureconfigurationdialog.ui	Thu Mar 18 12:53:15 2004
+++ kdepim/kmail/signatureconfigurationdialog.ui	Thu Jan  1 01:00:00 1970
@@ -1,810 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>SignatureConfigurationDialog</class>
-<widget class="QWidget">
-    <property name="name">
-        <cstring>SignatureConfigurationDialog</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>1018</width>
-            <height>519</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Signature Configuration</string>
-    </property>
-    <grid>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <widget class="QButtonGroup" row="0" column="1">
-            <property name="name">
-                <cstring>sendCertificatesBG</cstring>
-            </property>
-            <property name="title">
-                <string>Sending Certificates</string>
-            </property>
-            <vbox>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>dontSendCertificatesRB</cstring>
-                    </property>
-                    <property name="focusPolicy">
-                        <enum>NoFocus</enum>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Do not send certificates</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendYourOwnCertificateRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send &amp;your own certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendChainWithoutRootRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send certificate chain &amp;without root</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendChainWithRootRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send certificate c&amp;hain with root</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </vbox>
-        </widget>
-        <spacer row="0" column="0">
-            <property name="name">
-                <cstring>Spacer1_2_2_2</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Horizontal</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Fixed</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-        <widget class="QButtonGroup" row="0" column="0" rowspan="2" colspan="1">
-            <property name="name">
-                <cstring>pinEntryBG</cstring>
-            </property>
-            <property name="title">
-                <string>Signatures</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <spacer row="1" column="2">
-                    <property name="name">
-                        <cstring>Spacer22</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-                <widget class="QRadioButton" row="2" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>signAllPartsRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Sign all message &amp;parts</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have all message parts signed by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Sign All Message Parts By Default&lt;/h1&gt;
-If this option is selected, all parts of a message (i.e. the main message body and all attachments) are signed by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="3" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>askEachPartRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Ask &amp;before signing each part</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be asked for each part whether to sign</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Ask Before Signing Each Part&lt;/h1&gt;
-When this option is selected, you will be asked for each part of the message (i.e. the main message body as well as all attachments) individually whether you want the part to be signed.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="4" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>dontSignRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Do no&amp;t sign messages</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check for not signing a message by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Do Not Sign Messages&lt;/h1&gt;
-If this option is selected, messages are not signed by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual setting.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="0" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>TextLabel1</cstring>
-                    </property>
-                    <property name="text">
-                        <string>The signature certificate is configured on the &lt;em&gt;Certificates&lt;/em&gt; page.</string>
-                    </property>
-                    <property name="alignment">
-                        <set>AlignVCenter</set>
-                    </property>
-                </widget>
-                <widget class="QComboBox" row="1" column="1">
-                    <item>
-                        <property name="text">
-                            <string>RSA + SHA-1</string>
-                        </property>
-                    </item>
-                    <property name="name">
-                        <cstring>signatureAlgorithmCO</cstring>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects the signature algorithm</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Signature Algorithm&lt;/h1&gt;
-An algorithm is a description for the computer on how it should perform a certain task. The signature algorithm describes how the computer applies your signature key to your message so that the receiver can determine whether the message really is from you.
-&lt;p&gt;
-The selection of a certain signature algorithm determines how easy or how difficult it is to forge a message. However, all algorithms provided in the SPHINX environment are considered to be very safe. Generally, the default will work just fine here.
-&lt;p&gt;
-This setting is a default, you can override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="1" column="0">
-                    <property name="name">
-                        <cstring>signatureAlgorithmLA</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Signature &amp;algorithm:</string>
-                    </property>
-                    <property name="alignment">
-                        <set>AlignVCenter|AlignRight</set>
-                    </property>
-                    <property name="buddy" stdset="0">
-                        <cstring>signatureAlgorithmCO</cstring>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="5" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>saveSentSigsCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Store messages with signatures</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to store messages with their signatures</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Store Messages With Signatures&lt;/h1&gt;
-When this box is checked, sent messages are stored together with the signatures applied to them. This is recommended, because it enables you to check later whether you signed a message or a certain part of it.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QButtonGroup" row="6" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>sigCompoundModeBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <widget class="QLabel">
-                        <property name="name">
-                            <cstring>TextLabel4</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>1</x>
-                                <y>1</y>
-                                <width>564</width>
-                                <height>16</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Compound mode:</string>
-                        </property>
-                    </widget>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>sendSigMultiPartRB</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>28</x>
-                                <y>23</y>
-                                <width>536</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Standa&amp;rd MIME</string>
-                        </property>
-                        <property name="toolTip" stdset="0">
-                            <string>A Multipart/Signed holding Signature and signed data.</string>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>&lt;qt&gt;
-&lt;h1&gt;Multipart detached signature&lt;/h1&gt;
-When this option is selected, the signature and the signed data will be separate parts of a Multipart/Signed message part. Signed message data will be readable even by Mail User Agents not supporting the signaturing algorithm and not supporting ASN.1 decoding.
-&lt;/qt&gt;</string>
-                        </property>
-                    </widget>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>sendSigOpaqueRB</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>28</x>
-                                <y>49</y>
-                                <width>536</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Opa&amp;que (only recommended for SPHINX)</string>
-                        </property>
-                        <property name="toolTip" stdset="0">
-                            <string>Signature and signed data encoded in one ASN.1 block.</string>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>&lt;qt&gt;
-&lt;h1&gt;Opaque signed messages&lt;/h1&gt;
-When this option is selected, both the signature and the signed data will be encoded into one ASN.1 block. Messages will be readable only by Mail User Agents supporting ASN.1 decoding.
-&lt;/qt&gt;</string>
-                        </property>
-                    </widget>
-                    <spacer>
-                        <property name="name">
-                            <cstring>Spacer1_2_2</cstring>
-                        </property>
-                        <property name="orientation">
-                            <enum>Horizontal</enum>
-                        </property>
-                        <property name="sizeType">
-                            <enum>Fixed</enum>
-                        </property>
-                        <property name="sizeHint">
-                            <size>
-                                <width>20</width>
-                                <height>20</height>
-                            </size>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>0</x>
-                                <y>20</y>
-                                <width>20</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                    </spacer>
-                </widget>
-                <widget class="QButtonGroup" row="7" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>ButtonGroup15</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <widget class="QLabel" row="0" column="0" rowspan="1" colspan="4">
-                            <property name="name">
-                                <cstring>TextLabel5</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Entering PIN is required:</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="3" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAddCertificatesRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>When adding certificates</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;&lt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="1" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinOncePerSessionRB</cstring>
-                            </property>
-                            <property name="focusPolicy">
-                                <enum>NoFocus</enum>
-                            </property>
-                            <property name="text">
-                                <string>Once per session</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;&lt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="4" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAlwaysWhenSigningRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always when signing</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;&lt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="2" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAlwaysRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;&lt;</string>
-                            </property>
-                        </widget>
-                        <spacer row="3" column="0">
-                            <property name="name">
-                                <cstring>Spacer1_2_2_3</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <widget class="QRadioButton" row="5" column="1">
-                            <property name="name">
-                                <cstring>pinIntervalRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>After</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;&lt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QSpinBox" row="5" column="2">
-                            <property name="name">
-                                <cstring>pinIntervalSB</cstring>
-                            </property>
-                            <property name="enabled">
-                                <bool>false</bool>
-                            </property>
-                            <property name="suffix">
-                                <string> min</string>
-                            </property>
-                            <property name="value">
-                                <number>10</number>
-                            </property>
-                        </widget>
-                        <spacer row="5" column="3">
-                            <property name="name">
-                                <cstring>Spacer29</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Expanding</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                    </grid>
-                </widget>
-            </grid>
-        </widget>
-        <widget class="QGroupBox" row="1" column="1">
-            <property name="name">
-                <cstring>signatureSettingsBG</cstring>
-            </property>
-            <property name="title">
-                <string>Warnings</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnUnsignedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn when trying to send &amp;unsigned messages</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned when sending unsigned messages.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn When Trying To Send Unsigned Messages&lt;/h1&gt;
-If this box is checked, you will be warned when you try to send parts of or the whole message unsigned.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="3" column="0">
-                    <property name="name">
-                        <cstring>warnCACertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if CA certificate e&amp;xpires in less than</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="2" column="1">
-                    <property name="name">
-                        <cstring>warnSignatureCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Signature Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the signature certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="2" column="0">
-                    <property name="name">
-                        <cstring>warnSignatureCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if s&amp;ignature certificate expires in less than</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0">
-                    <property name="name">
-                        <cstring>warnRootCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if root certificate expires in &amp;less than</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="3" column="1">
-                    <property name="name">
-                        <cstring>warnCACertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CA Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the CA certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="4" column="1">
-                    <property name="name">
-                        <cstring>warnRootCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Root Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the root certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="1" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnAddressNotInCertificateCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if signer's email address is &amp;not in certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the address is not in the certificate</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Signer's Email Address Is Not In Certificate&lt;/h1&gt;
-If this option is checked, a warning is issued if the email address of the signer is not contained in the certificate used for signing.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </grid>
-        </widget>
-        <spacer row="2" column="0">
-            <property name="name">
-                <cstring>Spacer19</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Vertical</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Expanding</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-    </grid>
-</widget>
-<connections>
-    <connection>
-        <sender>warnSignatureCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnSignatureCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnCACertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCACertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnRootCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnRootCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>pinIntervalRB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>pinIntervalSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-</connections>
-<tabstops>
-    <tabstop>signAllPartsRB</tabstop>
-    <tabstop>askEachPartRB</tabstop>
-    <tabstop>dontSignRB</tabstop>
-    <tabstop>warnUnsignedCB</tabstop>
-    <tabstop>dontSendCertificatesRB</tabstop>
-    <tabstop>sendYourOwnCertificateRB</tabstop>
-    <tabstop>sendChainWithoutRootRB</tabstop>
-    <tabstop>sendChainWithRootRB</tabstop>
-    <tabstop>signatureAlgorithmCO</tabstop>
-    <tabstop>warnSignatureCertificateExpiresCB</tabstop>
-    <tabstop>warnSignatureCertificateExpiresSB</tabstop>
-    <tabstop>warnCACertificateExpiresCB</tabstop>
-    <tabstop>warnCACertificateExpiresSB</tabstop>
-    <tabstop>warnRootCertificateExpiresCB</tabstop>
-    <tabstop>warnRootCertificateExpiresSB</tabstop>
-    <tabstop>warnAddressNotInCertificateCB</tabstop>
-    <tabstop>pinOncePerSessionRB</tabstop>
-    <tabstop>pinAlwaysRB</tabstop>
-    <tabstop>pinAddCertificatesRB</tabstop>
-    <tabstop>pinAlwaysWhenSigningRB</tabstop>
-    <tabstop>pinIntervalRB</tabstop>
-    <tabstop>pinIntervalSB</tabstop>
-    <tabstop>saveSentSigsCB</tabstop>
-</tabstops>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
diff -urN -x CVS kdepim.orig/kmail/signatureconfigurationdialogimpl.cpp kdepim/kmail/signatureconfigurationdialogimpl.cpp
--- kdepim.orig/kmail/signatureconfigurationdialogimpl.cpp	Thu Dec 26 08:54:23 2002
+++ kdepim/kmail/signatureconfigurationdialogimpl.cpp	Thu Jan  1 01:00:00 1970
@@ -1,83 +0,0 @@
-#include <config.h>
-#include "signatureconfigurationdialogimpl.h"
-#include "cryptplugwrapper.h"
-
-#include <qbuttongroup.h>
-#include <qradiobutton.h>
-#include <qcheckbox.h>
-#include <qspinbox.h>
-
-
-
-
-#define FULLTEST false
-
-
-
-
-/*
- *  Constructs a SignatureConfigurationDialogImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- */
-SignatureConfigurationDialogImpl::SignatureConfigurationDialogImpl( QWidget* parent,  const char* name, WFlags fl )
-    : SignatureConfigurationDialog( parent, name, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-SignatureConfigurationDialogImpl::~SignatureConfigurationDialogImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-
-/**
-   Enables or disables the widgets in this dialog according to the
-   capabilities of the current plugin passed as a parameter.
-*/
-void SignatureConfigurationDialogImpl::enableDisable( CryptPlugWrapper* cryptPlug )
-{
-    // disable the whole page if the plugin does not support
-    // signatures (e.g. encryption only)
-    setEnabled( cryptPlug->hasFeature( Feature_SignMessages ) );
-
-    // enable and disable the various components depending on the
-    // availability of a feature in the crypto plugin
-    sendCertificatesBG->setEnabled( cryptPlug->hasFeature( Feature_SendCertificates ) );
-    sigCompoundModeBG->setEnabled( cryptPlug->hasFeature( Feature_SendCertificates ) );
-    warnSignatureCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnSignatureCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnCACertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnCACertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnRootCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnRootCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnAddressNotInCertificateCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignEmailNotInCertificate ) );
-    pinEntryBG->setEnabled( cryptPlug->hasFeature( Feature_PinEntrySettings ) );
-    saveSentSigsCB->setEnabled( cryptPlug->hasFeature( Feature_StoreMessagesWithSigs ) );
-    
-    if( ! FULLTEST ){
-        askEachPartRB                ->hide(); // We won't implement that.
-        
-        sendCertificatesBG           ->hide(); // Will implement that later
-        
-        pinEntryBG                   ->hide(); // Will implement that later
-        
-        saveSentSigsCB->hide(); // We won't implement that.
-        
-        dontSendCertificatesRB       ->hide(); // Will implement that later.
-        sendChainWithoutRootRB       ->hide(); // Will implement that later.
-        sendChainWithRootRB          ->hide(); // Will implement that later.
-        
-        pinOncePerSessionRB          ->hide(); // Will implement that later.
-        pinAddCertificatesRB         ->hide(); // Will implement that later.
-        pinAlwaysWhenSigningRB       ->hide(); // Will implement that later.
-        pinIntervalRB                ->hide(); // Will implement that later.
-        pinIntervalSB                ->hide(); // Will implement that later.
-        
-        saveSentSigsCB               ->hide(); // We won't implement that.
-    }
-}
-
-#include "signatureconfigurationdialogimpl.moc"
diff -urN -x CVS kdepim.orig/kmail/signatureconfigurationdialogimpl.h kdepim/kmail/signatureconfigurationdialogimpl.h
--- kdepim.orig/kmail/signatureconfigurationdialogimpl.h	Mon Apr 22 09:42:10 2002
+++ kdepim/kmail/signatureconfigurationdialogimpl.h	Thu Jan  1 01:00:00 1970
@@ -1,19 +0,0 @@
-#ifndef SIGNATURECONFIGURATIONDIALOGIMPL_H
-#define SIGNATURECONFIGURATIONDIALOGIMPL_H
-#include "signatureconfigurationdialog.h"
-
-class CryptPlugWrapper;
-
-class SignatureConfigurationDialogImpl : public SignatureConfigurationDialog
-{
-    Q_OBJECT
-
-public:
-    SignatureConfigurationDialogImpl( QWidget* parent = 0, 
-                                      const char* name = 0, WFlags fl = 0 );
-    ~SignatureConfigurationDialogImpl();
-
-    void enableDisable( CryptPlugWrapper* );
-};
-
-#endif // SIGNATURECONFIGURATIONDIALOGIMPL_H
diff -urN -x CVS kdepim.orig/kmail/startupwizard.cpp kdepim/kmail/startupwizard.cpp
--- kdepim.orig/kmail/startupwizard.cpp	Fri Jun  4 02:04:09 2004
+++ kdepim/kmail/startupwizard.cpp	Thu Jan  1 01:00:00 1970
@@ -1,765 +0,0 @@
-/*
-    This file is part of KMail.
-
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-
-    This library is free software; you can redistribute it and/or
-    modify it under the terms of the GNU Library General Public
-    License as published by the Free Software Foundation; either
-    version 2 of the License, or (at your option) any later version.
-
-    This library is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-    Library General Public License for more details.
-
-    You should have received a copy of the GNU Library General Public License
-    along with this library; see the file COPYING.LIB.  If not, write to
-    the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-    Boston, MA 02111-1307, USA.
-
-    In addition, as a special exception, the copyright holders give
-    permission to link the code of this program with any edition of
-    the Qt library by Trolltech AS, Norway (or with modified versions
-    of Qt that use the same license as Qt), and distribute linked
-    combinations including the two.  You must obey the GNU General
-    Public License in all respects for all of the code used other than
-    Qt.  If you modify this file, you may extend this exception to
-    your version of the file, but you are not obligated to do so.  If
-    you do not wish to do so, delete this exception statement from
-    your version.
-*/
-
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-
-#include "startupwizard.h"
-
-#include "kmfoldercombobox.h"
-#include "configuredialog_p.h"
-#include "kmacctmgr.h"
-#include "kmcomposewin.h"
-#include "kmfoldermgr.h"
-#include "kmacctcachedimap.h"
-#include "kmfoldercachedimap.h"
-#include <libkpimidentities/identity.h>
-#include <libkpimidentities/identitymanager.h>
-#include "kmtransport.h"
-#include "kmsender.h"
-#include "kmgroupware.h"
-#include "kmkernel.h"
-#include "kmailicalifaceimpl.h"
-#include "globalsettings.h"
-
-#include <kdebug.h>
-#include <klocale.h>
-#include <knuminput.h>
-#include <kapplication.h>
-#include <kconfig.h>
-
-#include <qvbox.h>
-#include <qvbuttongroup.h>
-#include <qtextbrowser.h>
-#include <qwhatsthis.h>
-#include <qvalidator.h>
-
-WizardIdentityPage::WizardIdentityPage( QWidget * parent, const char * name )
-  : QWidget( parent, name )
-{
-  // First either get the default identity or make a new one
-  KPIM::IdentityManager *im = kmkernel->identityManager();
-  if( im->identities().count() > 0 )
-    mIdentity = im->defaultIdentity().uoid();
-  else {
-    mIdentity = im->newFromScratch( "Kolab Identity" ).uoid();
-    im->setAsDefault( mIdentity );
-  }
-
-  KPIM::Identity & ident = im->identityForUoid( mIdentity );
-
-  QGridLayout *grid = new QGridLayout( this, 3, 2, KDialog::marginHint(),
-				       KDialog::spacingHint() );
-  grid->addColSpacing( 1, fontMetrics().maxWidth()*15 );
-  grid->setRowStretch( 15, 10 );
-  grid->setColStretch( 1, 10 );
-
-  QLabel *label = new QLabel( i18n("&Your name:"), this );
-  QWhatsThis::add( label, i18n("Write your name here.") );
-  grid->addWidget( label, 0, 0 );
-  nameEdit = new QLineEdit( ident.fullName(), this );
-  nameEdit->setFocus();
-  label->setBuddy( nameEdit );
-  grid->addWidget( nameEdit, 0, 1 );
-
-  label = new QLabel( i18n("Organi&zation:"), this );
-  QWhatsThis::add( label, i18n("You can write the company or organization you work for.") );
-  grid->addWidget( label, 1, 0 );
-  orgEdit = new QLineEdit( ident.organization(), this );
-  label->setBuddy( orgEdit );
-  grid->addWidget( orgEdit, 1, 1 );
-
-  label = new QLabel( i18n("&Email address:"), this );
-  grid->addWidget( label, 2, 0 );
-  emailEdit = new QLineEdit( ident.emailAddr(), this );
-  label->setBuddy( emailEdit );
-  grid->addWidget( emailEdit, 2, 1 );
-}
-
-void WizardIdentityPage::apply() const {
-  // Save the identity settings
-  KPIM::Identity & ident = identity();
-  ident.setFullName( nameEdit->text().stripWhiteSpace() );
-  ident.setOrganization( orgEdit->text().stripWhiteSpace() );
-  ident.setEmailAddr( emailEdit->text().stripWhiteSpace() );
-  kmkernel->identityManager()->sort();
-  kmkernel->identityManager()->commit();
-}
-
-KPIM::Identity & WizardIdentityPage::identity() const {
-  return kmkernel->identityManager()->identityForUoid( mIdentity );
-}
-
-WizardKolabPage::WizardKolabPage( QWidget * parent, const char * name )
-  : QWidget( parent, name ), mFolder(0), mAccount(0), mTransport( 0 )
-{
-  QGridLayout *grid = new QGridLayout( this, 7, 2, KDialog::marginHint(),
-				       KDialog::spacingHint() );
-  grid->addColSpacing( 1, fontMetrics().maxWidth()*15 );
-  grid->setRowStretch( 15, 10 );
-  grid->setColStretch( 1, 10 );
-
-  QLabel *label = new QLabel( i18n("&Login:"), this );
-  QWhatsThis::add( label, i18n("Your Internet Service Provider gave you a <em>user name</em> which is used to authenticate you with their servers. It usually is the first part of your email address (the part before <em>@</em>).") );
-  grid->addWidget( label, 0, 0 );
-  loginEdit = new QLineEdit( this );
-  label->setBuddy( loginEdit );
-  grid->addWidget( loginEdit, 0, 1 );
-
-  label = new QLabel( i18n("P&assword:"), this );
-  grid->addWidget( label, 1, 0 );
-  passwordEdit = new QLineEdit( this );
-  passwordEdit->setEchoMode( QLineEdit::Password );
-  label->setBuddy( passwordEdit );
-  grid->addWidget( passwordEdit, 1, 1 );
-
-  label = new QLabel( i18n("Ho&st:"), this );
-  grid->addWidget( label, 2, 0 );
-  hostEdit = new QLineEdit( this );
-  // only letters, digits, '-', '.', ':' (IPv6) and '_' (for Windows
-  // compatibility) are allowed
-  hostEdit->setValidator(new QRegExpValidator( QRegExp( "[A-Za-z0-9-_:.]*" ), 0 ) );
-  label->setBuddy( hostEdit );
-  grid->addWidget( hostEdit, 2, 1 );
-
-  storePasswordCheck =
-    new QCheckBox( i18n("Sto&re IMAP password in configuration file"), this );
-  storePasswordCheck->setChecked( true );
-  grid->addMultiCellWidget( storePasswordCheck, 3, 3, 0, 1 );
-
-  excludeCheck = new QCheckBox( i18n("E&xclude from \"Check Mail\""), this );
-  grid->addMultiCellWidget( excludeCheck, 4, 4, 0, 1 );
-
-  intervalCheck = new QCheckBox( i18n("Enable &interval mail checking"), this );
-  intervalCheck->setChecked( true );
-  grid->addMultiCellWidget( intervalCheck, 5, 5, 0, 2 );
-  intervalLabel = new QLabel( i18n("Check inter&val:"), this );
-  grid->addWidget( intervalLabel, 6, 0 );
-  intervalSpin = new KIntNumInput( this );
-  intervalSpin->setRange( 1, 60, 1, FALSE );
-  intervalSpin->setValue( 1 );
-  intervalSpin->setSuffix( i18n( " min" ) );
-  intervalLabel->setBuddy( intervalSpin );
-  connect( intervalCheck, SIGNAL(toggled(bool)), intervalSpin, SLOT(setEnabled(bool)) );
-  grid->addWidget( intervalSpin, 6, 1 );
-}
-
-void WizardKolabPage::init( const QString &email )
-{
-  static bool first = true;
-  if( !first ) return;
-  first = false;
-
-  // Workaround since Qt can't have default focus on more than one page
-  loginEdit->setFocus();
-
-  int at = email.find('@');
-  if( at > 1 && email.length() > (uint)at ) {
-    // Set reasonable login and host defaults
-    loginEdit->setText( email );
-    hostEdit->setText( email.mid( at + 1 ) );
-  }
-}
-
-void WizardKolabPage::apply()
-{
-  // Handle the account
-  if( mAccount == 0 ) {
-    // Create the account
-    mAccount = static_cast<KMAcctCachedImap*>
-      ( kmkernel->acctMgr()->create( QString("cachedimap"), "Kolab" ) );
-    mAccount->init(); // fill the account fields with good default values
-    kmkernel->acctMgr()->add(mAccount);
-
-    // Set all default settings
-    // TODO: read these from a system wide settings file
-    mAccount->setAuth( "PLAIN" );
-    mAccount->setPrefix( "/" );
-    mAccount->setUseSSL( false );
-    mAccount->setUseTLS( true );
-    mAccount->setSieveConfig( KMail::SieveConfig( true ) );
-    kmkernel->cleanupImapFolders();
-    assert( mAccount->folder() );
-
-    // This Must Be False!!
-    mAccount->setAutoExpunge( false );
-  }
-
-  mAccount->setLogin( loginEdit->text().stripWhiteSpace() );
-  mAccount->setPasswd( passwordEdit->text() );
-  mAccount->setHost( hostEdit->text().stripWhiteSpace() );
-  mAccount->setStorePasswd( storePasswordCheck->isChecked() );
-  mAccount->setCheckExclude( excludeCheck->isChecked() );
-
-  kmkernel->acctMgr()->writeConfig( false );
-
-  // Sync new IMAP account ASAP
-  kdDebug(5006) << mAccount->folder()->name() << endl;
-
-  if( mFolder == 0 ) {
-    KMFolderDir *child = mAccount->folder()->child();
-    if( child == 0 )
-      child = mAccount->folder()->createChildFolder();
-
-    mFolder = kmkernel->dimapFolderMgr()->
-      createFolder( "INBOX", false, KMFolderTypeCachedImap, child );
-    static_cast<KMFolderCachedImap*>(mFolder)->setSilentUpload( true );
-  }
-  if ( !mAccount->checkingMail() ) {
-    mAccount->setCheckingMail( true );
-    mAccount->processNewMail( false );
-  }
-
-  // Handle SMTP transport
-  if( mTransport == 0 ) {
-    mTransport = new KMTransportInfo();
-    mTransport->type = "smtp";
-    mTransport->name = "Kolab";
-    mTransport->port = "25";
-    mTransport->encryption = "TLS";
-    mTransport->authType = "PLAIN";
-    mTransport->auth = true;
-    mTransport->precommand = "";
-  }
-
-  mTransport->host = hostEdit->text().stripWhiteSpace();
-  mTransport->user = loginEdit->text().stripWhiteSpace();
-  mTransport->pass = passwordEdit->text();
-  mTransport->storePass = storePasswordCheck->isChecked();
-
-  // Save transports:
-  KConfigGroup general( KMKernel::config(), "General" );
-  KConfigGroup composer( KMKernel::config(), "Composer" );
-  // TODO: Set more transports
-  general.writeEntry( "transports", 1/*mTransportInfoList.count()*/ );
-//   QPtrListIterator<KMTransportInfo> it( mTransportInfoList );
-//   for ( int i = 1 ; it.current() ; ++it, ++i )
-//     (*it)->writeConfig(i);
-  mTransport->writeConfig(1);
-
-  // Save common options:
-  general.writeEntry( "sendOnCheck", false );
-  kmkernel->msgSender()->setSendImmediate( true );
-}
-
-
-StartupWizard::StartupWizard( QWidget* parent, const char* name, bool modal )
-  : QWizard( parent, name, modal ), mGroupwareEnabled(true)
-{
-  addPage( mIntroPage = createIntroPage(), i18n("Groupware Functionality for KMail") );
-  addPage( mIdentityPage = createIdentityPage(), i18n("Your Identity") );
-  addPage( mKolabPage = createKolabPage(), i18n("Kolab Groupware Settings") );
-  addPage( mAccountPage = createAccountPage(), i18n("Accounts") );
-  addPage( mFolderSelectionPage = createFolderSelectionPage(), i18n("Folder Selection") );
-  addPage( mLanguagePage = createLanguagePage(), i18n("Folder Language") );
-  addPage( mFolderCreationPage = createFolderCreationPage(), i18n("Folder Creation") );
-  addPage( mOutroPage = createOutroPage(), i18n("Done") );
-}
-
-int StartupWizard::language() const
-{
-  return mLanguageCombo->currentItem();
-}
-
-KMFolder* StartupWizard::folder() const
-{
-  if( groupwareEnabled() && useDefaultKolabSettings() )
-    return mKolabWidget->folder();
-  else
-    return mFolderCombo->getFolder();
-}
-
-void StartupWizard::setAppropriatePages()
-{
-  setAppropriate( mKolabPage, groupwareEnabled() && useDefaultKolabSettings() );
-  setAppropriate( mAccountPage, !groupwareEnabled() || !useDefaultKolabSettings() );
-  setAppropriate( mLanguagePage, groupwareEnabled() );
-  setAppropriate( mFolderSelectionPage, groupwareEnabled() && !useDefaultKolabSettings() );
-  setAppropriate( mFolderCreationPage, groupwareEnabled() );
-  setAppropriate( mOutroPage, !groupwareEnabled() );
-  setNextEnabled( mOutroPage, false);
-  setFinishEnabled( mOutroPage, true );
-  setFinishEnabled( mFolderCreationPage, true );
-}
-
-void StartupWizard::slotGroupwareEnabled( int i )
-{
-  mGroupwareEnabled = (i == 0);
-  serverSettings->setEnabled( mGroupwareEnabled );
-}
-
-void StartupWizard::slotServerSettings( int i )
-{
-  mUseDefaultKolabSettings = (i == 0);
-}
-
-QWidget* StartupWizard::createIntroPage()
-{
-  QWidget* page = new QWidget(this, "intro_page");
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText( i18n("<b>You do not seem to have any groupware folders "
-		    "configured in KMail.</b><br>"
-		    "This is probably because you are running KMail for the first time, or "
-		    "because you have enabled the groupware functionality for the first time.<br>"
-		    "You now have the choice between disabling the groupware functionality, "
-		    "or leaving it enabled and going through this wizard.<br>"
-		    "If you disable the groupware functionality for now, you can always enable it again from "
-		    "the KMail configure dialog."));
-  top->addWidget( text );
-
-  QVBox* rightSide = new QVBox( page );
-  top->addWidget( rightSide, 1 );
-
-  QButtonGroup* bg = new QVButtonGroup( i18n("Groupware Functions"), rightSide );
-
-  (new QRadioButton( i18n("Enable groupware functions"), bg ))->setChecked( TRUE );
-  (void)new QRadioButton( i18n("Disable groupware functions"), bg );
-  connect( bg, SIGNAL( clicked(int) ), this, SLOT( slotGroupwareEnabled(int) ) );
-
-  bg = serverSettings = new QVButtonGroup( i18n("Groupware Server Setup"), rightSide );
-  (new QRadioButton( i18n("Use standard groupware server settings"), bg ))->setChecked(TRUE);
-  (void)new QRadioButton( i18n("Advanced server setup"), bg );
-  connect( bg, SIGNAL( clicked(int) ), this, SLOT(slotServerSettings(int) ) );
-
-  // Set the groupware setup to the right settings
-  slotGroupwareEnabled( 0 );
-  slotServerSettings( 0 );
-  setHelpEnabled( page, false );
-  setBackEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createIdentityPage()
-{
-  QWidget* page = new QWidget( this, "identity_page" );
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText( i18n("Please set at least your name and email address.") );
-  top->addWidget( text );
-
-  mIdentityWidget = new WizardIdentityPage( page, "identity_page" );
-  top->addWidget( mIdentityWidget, 1 );
-  setHelpEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createKolabPage()
-{
-  QWidget* page = new QWidget( this, "kolabserver_page" );
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText( i18n("If the groupware server is a kolab server with default"
-		      " settings, you only need to set these settings.") );
-  top->addWidget( text );
-
-  mKolabWidget = new WizardKolabPage( page, "kolabserver_page" );
-  top->addWidget( mKolabWidget, 1 );
-  setHelpEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createAccountPage()
-{
-  QWidget* page = new QWidget( this, "account_page");
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText(i18n("If you want, you can create new accounts before going on with"
-		     " groupware configuration."));
-  top->addWidget( text );
-
-  mAccountWidget = new NetworkPage( page, "account_page" );
-  mAccountWidget->setup();
-  top->addWidget( mAccountWidget, 1 );
-  setHelpEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createLanguagePage()
-{
-  QWidget* page = new QWidget(this, "language_page");
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser(  page );
-  text->setText( i18n("If you want to make your groupware folders work with other "
-		    "applications, you might want to select a different language "
-		    "than English.<br>"
-		    "If this is not an issue, leave the language as is."));
-  top->addWidget( text );
-
-  QVBox* rightSide = new QVBox( page );
-  top->addWidget( rightSide, 1 );
-
-  mLanguageLabel = new QLabel( rightSide );
-
-  mLanguageCombo = new QComboBox( false, rightSide );
-
-  QStringList lst;
-  lst << i18n("English") << i18n("German") << i18n("French") << i18n("Dutch");
-  mLanguageCombo->insertStringList( lst );
-
-  setLanguage( 0, false );
-  setHelpEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createFolderSelectionPage()
-{
-  QWidget* page = new QWidget(this, "foldersel_page");
-  QBoxLayout* top = new QHBoxLayout( page );
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText(i18n("The groupware functionality needs some special folders to store "
-		   "the contents of the calendar, contacts, tasks etc.<br>"
-		   "Please select the folder that the groupware folders should "
-		   "be subfolders of."));
-  top->addWidget( text );
-  mFolderCombo = new KMFolderComboBox( page );
-  top->addWidget( mFolderCombo, 1 );
-  connect( mFolderCombo, SIGNAL( activated(int) ),
-	   this, SLOT( slotUpdateParentFolderName() ) );
-  setHelpEnabled( page, false );
-  return page;
-}
-
-void StartupWizard::slotUpdateParentFolderName()
-{
-  KMFolder* folder = mFolderCombo->getFolder();
-  QString fldrName = i18n("<unnamed>");
-  if( folder ) fldrName = folder->name();
-  mFolderCreationText
-    ->setText( i18n("You have chosen the folder <b>%1</b> as parent of the "
-		    "groupware folders. When pressing the Finish button, "
-		    "those folders will be created if "
-		    "they do not already exist").arg( fldrName ));
-}
-
-void StartupWizard::setLanguage( int language, bool guessed )
-{
-  mLanguageCombo->setCurrentItem( language );
-  if( guessed ) {
-    mLanguageLabel->setText( i18n("The folders present indicates that you want to use the selected folder language"));
-  } else {
-    mLanguageLabel->setText( i18n("The folder language cannot be guessed, please select a language:"));
-  }
-}
-
-QWidget* StartupWizard::createFolderCreationPage()
-{
-  QHBox* page = new QHBox(this, "foldercre_page");
-  mFolderCreationText = new QTextBrowser( page );
-  slotUpdateParentFolderName();
-  setFinishEnabled( page, true );
-  setNextEnabled( page, false);
-  setHelpEnabled( page, false );
-  return page;
-}
-
-QWidget* StartupWizard::createOutroPage()
-{
-  QHBox* page = new QHBox(this, "outtro_page");
-  QTextBrowser* text = new QTextBrowser( page );
-  text->setText( i18n("The groupware functionality has been disabled.") );
-  setFinishEnabled( page, true );
-  setNextEnabled( page, false);
-  setHelpEnabled( page, false );
-  return page;
-}
-
-void StartupWizard::back()
-{
-  QWizard::back();
-}
-
-void StartupWizard::next()
-{
-  if( currentPage() == mAccountPage ) {
-    kdDebug(5006) << "AccountPage appropriate: " << appropriate(mAccountPage) << endl;
-    mAccountWidget->apply();
-  } else if( currentPage() == mFolderSelectionPage ) {
-    /* Find the list of folders and guess the language */
-    guessExistingFolderLanguage();
-  } else if( currentPage() == mKolabPage ) {
-    // Apply all settings to the account
-    mKolabWidget->apply();
-    /* Find the list of folders and guess the language */
-    // TODO: guessExistingFolderLanguage();
-
-    // Finally, just set the message at the end of the wizard
-    mFolderCreationText->setText( i18n("You have chosen to use standard kolab settings.\nPress Finish to proceed.") );
-
-  } else if( currentPage() == mIdentityPage ) {
-    mIdentityWidget->apply();
-    mKolabWidget->init( userIdentity().emailAddr() );
-  }
-
-  // Set which ones apply, given the present state of answers
-  setAppropriatePages();
-
-  QWizard::next();
-}
-
-static bool checkSubfolders( KMFolderDir* dir, int language )
-{
-  KMailICalIfaceImpl& ical = kmkernel->iCalIface();
-  return dir->hasNamedFolder( ical.folderName( KFolderTreeItem::Inbox, language ) ) &&
-    dir->hasNamedFolder( ical.folderName( KFolderTreeItem::Calendar, language ) ) &&
-    dir->hasNamedFolder( ical.folderName( KFolderTreeItem::Contacts, language ) ) &&
-    dir->hasNamedFolder( ical.folderName( KFolderTreeItem::Notes, language ) ) &&
-    dir->hasNamedFolder( ical.folderName( KFolderTreeItem::Tasks, language ) );
-}
-
-void StartupWizard::guessExistingFolderLanguage()
-{
-  KMFolderDir* dir = folder()->child();
-
-  if(  checkSubfolders( dir, 0 ) ) {
-    // Check English
-    setLanguage( 0, true );
-  } else if( checkSubfolders( dir, 1 ) ) {
-    // Check German
-    setLanguage( 1, true );
-  } else {
-    setLanguage( 0, false );
-  }
-}
-
-KPIM::Identity &StartupWizard::userIdentity()
-{
-  return mIdentityWidget->identity();
-}
-
-const KPIM::Identity &StartupWizard::userIdentity() const
-{
-  return mIdentityWidget->identity();
-}
-
-QString StartupWizard::name() const
-{
-  return userIdentity().fullName();
-}
-
-QString StartupWizard::login() const
-{
-  return mKolabWidget->loginEdit->text().stripWhiteSpace();
-}
-
-QString StartupWizard::host() const
-{
-  return mKolabWidget->hostEdit->text().stripWhiteSpace();
-}
-
-QString StartupWizard::email() const
-{
-  return userIdentity().emailAddr();
-}
-
-QString StartupWizard::passwd() const
-{
-  return KMAccount::encryptStr( mKolabWidget->passwordEdit->text() );
-}
-
-bool StartupWizard::storePasswd() const
-{
-  return mKolabWidget->storePasswordCheck->isChecked();
-}
-
-
-void StartupWizard::run()
-{
-  /* 
-   *
-   * FIXME the below is no longer up to date. If you, dear reader are here
-   * because you want to fix it, know this:
-   *
-   * 1 ) I applaud your efforts : )
-   * 2 ) please look in kmail.kcfg and use KConfigXT
-   * 
-   */
-  KConfigGroup options( KMKernel::config(), "Groupware" );
-
-  // Check if this wizard was previously run
-  if( options.readEntry( "Enabled", "notset" ) != "notset" )
-    return;
-
-  StartupWizard wiz(0, "groupware wizard", TRUE );
-  int rc = wiz.exec();
-
-  options.writeEntry( "Enabled", rc == QDialog::Accepted && wiz.groupwareEnabled() );
-  if( rc == QDialog::Accepted ) {
-    options.writeEntry( "FolderLanguage", wiz.language() );
-    options.writeEntry( "GroupwareFolder", wiz.folder()->idString() );
-
-    kmkernel->groupware().readConfig();
-
-    if( wiz.groupwareEnabled() && wiz.useDefaultKolabSettings() ) {
-      // Write the apps configs
-      writeKOrganizerConfig( wiz );
-      writeKAbcConfig();
-      writeKAddressbookConfig( wiz );
-    }
-  }
-}
-
-
-// Write the KOrganizer settings
-void StartupWizard::writeKOrganizerConfig( const StartupWizard& wiz ) {
-  KConfig config( "korganizerrc" );
-
-  KConfigGroup optionsKOrgGeneral( &config, "Personal Settings" );
-  optionsKOrgGeneral.writeEntry( "user_name", wiz.name() );
-  optionsKOrgGeneral.writeEntry( "user_email", wiz.email() );
-
-  KConfigGroup optionsKOrgGroupware( &config, "Groupware" );
-  optionsKOrgGroupware.writeEntry( "Publish FreeBusy lists", true );
-  optionsKOrgGroupware.writeEntry( "Publish FreeBusy days", 60 );
-  optionsKOrgGroupware.writeEntry( "Publish to Kolab server", true );
-  optionsKOrgGroupware.writeEntry( "Publish to Kolab server name", wiz.host() );
-  optionsKOrgGroupware.writeEntry( "Publish user name", wiz.login() );
-  optionsKOrgGroupware.writeEntry( "Remember publish password", wiz.storePasswd() );
-  if( wiz.storePasswd() ) {
-    optionsKOrgGroupware.writeEntry( "Publish Server Password", wiz.passwd() );
-    optionsKOrgGroupware.writeEntry( "Retrieve Server Password", wiz.passwd() );
-  }
-  optionsKOrgGroupware.writeEntry( "Retrieve FreeBusy lists", true );
-  optionsKOrgGroupware.writeEntry( "Retrieve from Kolab server", true );
-  optionsKOrgGroupware.writeEntry( "Retrieve from Kolab server name", wiz.host() );
-  optionsKOrgGroupware.writeEntry( "Retrieve user name", wiz.login() );
-  optionsKOrgGroupware.writeEntry( "Remember retrieve password", wiz.storePasswd() );
-
-  config.sync();
-}
-
-
-// Write the KABC settings
-void StartupWizard::writeKAbcConfig() {
-  KConfig config( "kabcrc" );
-  KConfigGroup optionsKAbcGeneral( &config, "General" );
-  QString standardKey = optionsKAbcGeneral.readEntry( "Standard" );
-  QString newStandardKey;
-
-  QStringList activeKeys = optionsKAbcGeneral.readListEntry( "ResourceKeys" );
-  QStringList passiveKeys = optionsKAbcGeneral.readListEntry( "PassiveResourceKeys" );
-  QStringList keys = activeKeys + passiveKeys;
-  for ( QStringList::Iterator it = keys.begin(); it != keys.end(); ++it ) {
-    KConfigGroup entry( &config, "Resource_" + (*it) );
-    if( entry.readEntry( "ResourceType" ) == "imap" && newStandardKey.isNull() ) {
-      // This is the IMAP resource that must now be the standard
-      newStandardKey = *it;
-
-      // We want to be able to write to this
-      entry.writeEntry( "ResourceIsReadOnly", false );
-    } else
-      // Not an IMAP resource, so don't write to it anymore
-      entry.writeEntry( "ResourceIsReadOnly", true );
-  }
-
-  if( newStandardKey.isNull() ) {
-    // No IMAP resource was found, make one
-    newStandardKey = KApplication::randomString( 10 );
-    KConfigGroup entry( &config, "Resource_" + newStandardKey );
-    entry.writeEntry( "ResourceName", "imap-resource" );
-    entry.writeEntry( "ResourceType", "imap" );
-    entry.writeEntry( "ResourceIsReadOnly", false );
-    entry.writeEntry( "ResourceIsFast", true );
-    activeKeys += newStandardKey;
-  } else if( passiveKeys.remove( newStandardKey ) > 0 )
-    // This used to be passive. Make it active
-    activeKeys += newStandardKey;
-
-  // Set the keys
-  optionsKAbcGeneral.writeEntry( "ResourceKeys", activeKeys );
-  optionsKAbcGeneral.writeEntry( "PassiveResourceKeys", passiveKeys );
-  optionsKAbcGeneral.writeEntry( "Standard", newStandardKey );
-
-  config.sync();
-}
-
-
-// Write the KAddressbook settings
-void StartupWizard::writeKAddressbookConfig( const StartupWizard& wiz ) {
-  KConfig config( "kaddressbookrc" );
-  KConfigGroup options( &config, "LDAP" );
-
-  QString hostBase = QString( "dc=" ) + wiz.host();
-  hostBase.replace( '.', ",dc=" );
-
-  // Read all servers and try finding one that matches us
-  uint count = options.readUnsignedNumEntry( "NumSelectedHosts");
-  for ( uint i = 0; i < count; ++i ) {
-    QString host = options.readEntry( QString( "SelectedHost%1").arg( i ) );
-    int port = options.readUnsignedNumEntry( QString( "SelectedPort%1" ).arg( i ) );
-    QString base = options.readEntry( QString( "SelectedBase%1" ).arg( i ) );
-
-    if( host == wiz.host() && port == 389 && base == hostBase )
-      // We found a match, and it's selected
-      return;
-  }
-
-  // No match among the selected ones, try the unselected
-  count = options.readUnsignedNumEntry( "NumHosts" );
-  for ( uint i = 0; i < count; ++i ) {
-    QString host = options.readEntry( QString( "SelectedHost%1").arg( i ) );
-    int port = options.readUnsignedNumEntry( QString( "SelectedPort%1" ).arg( i ) );
-    QString base = options.readEntry( QString( "SelectedBase%1" ).arg( i ) );
-
-    if( host == wiz.host() && port == 389 && base == hostBase ) {
-      // We found a match. Remove it from this list
-      for( ++i; i < count; ++i ) {
-	host = options.readEntry( QString( "Host%1" ).arg( i ) );
-	port = options.readUnsignedNumEntry( QString( "Port%1" ).arg( i ) );
-	base = options.readEntry( QString( "Base%1" ).arg( i ) );
-	options.writeEntry( QString( "Host%1" ).arg( i-1 ), host );
-	options.writeEntry( QString( "Port%1" ).arg( i-1 ), port );
-	options.writeEntry( QString( "Base%1" ).arg( i-1 ), base );
-      }
-
-      // Now all the previous ones were overwritten, so remove the last one
-      --count;
-      options.deleteEntry( QString( "Host%1" ).arg( count ) );
-      options.deleteEntry( QString( "Port%1" ).arg( count ) );
-      options.deleteEntry( QString( "Base%1" ).arg( count ) );
-      options.writeEntry( "NumHosts", count );
-      break;
-    }
-  }
-
-  // Now write the selected ldap server
-  count = options.readUnsignedNumEntry( "NumSelectedHosts");
-  options.writeEntry( QString( "SelectedHost%1" ).arg( count ), wiz.host() );
-  options.writeEntry( QString( "SelectedPort%1" ).arg( count ), 389 );
-  options.writeEntry( QString( "SelectedBase%1" ).arg( count ), hostBase );
-  options.writeEntry( "NumSelectedHosts", count+1 );
-}
-
-
-#include "startupwizard.moc"
diff -urN -x CVS kdepim.orig/kmail/startupwizard.h kdepim/kmail/startupwizard.h
--- kdepim.orig/kmail/startupwizard.h	Fri May 14 13:44:37 2004
+++ kdepim/kmail/startupwizard.h	Thu Jan  1 01:00:00 1970
@@ -1,170 +0,0 @@
-/*
-    This file is part of KMail.
-
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-
-    This library is free software; you can redistribute it and/or
-    modify it under the terms of the GNU Library General Public
-    License as published by the Free Software Foundation; either
-    version 2 of the License, or (at your option) any later version.
-
-    This library is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-    Library General Public License for more details.
-
-    You should have received a copy of the GNU Library General Public License
-    along with this library; see the file COPYING.LIB.  If not, write to
-    the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-    Boston, MA 02111-1307, USA.
-
-    In addition, as a special exception, the copyright holders give
-    permission to link the code of this program with any edition of
-    the Qt library by Trolltech AS, Norway (or with modified versions
-    of Qt that use the same license as Qt), and distribute linked
-    combinations including the two.  You must obey the GNU General
-    Public License in all respects for all of the code used other than
-    Qt.  If you modify this file, you may extend this exception to
-    your version of the file, but you are not obligated to do so.  If
-    you do not wish to do so, delete this exception statement from
-    your version.
-*/
-
-#ifndef STARTUPWIZARD_H
-#define STARTUPWIZARD_H
-
-#include <qwizard.h>
-
-class KMFolder;
-class KMFolderComboBox;
-class KMAcctCachedImap;
-class NetworkPage;
-namespace KPIM { class Identity; }
-class KMTransportInfo;
-
-class QLabel;
-class QComboBox;
-class QLineEdit;
-class QCheckBox;
-class QButtonGroup;
-class QTextBrowser;
-class KIntNumInput;
-
-class WizardIdentityPage : public QWidget {
-  Q_OBJECT
-public:
-  WizardIdentityPage( QWidget *parent, const char *name );
-
-  void apply() const;
-
-  KPIM::Identity &identity() const;
-
-private:
-  int mIdentity;
-
-  QLineEdit *nameEdit, *orgEdit, *emailEdit;
-};
-
-
-class WizardKolabPage : public QWidget {
-  Q_OBJECT
-public:
-  WizardKolabPage( QWidget * parent, const char * name );
-
-  void apply();
-  void init( const QString &userEmail );
-  KMFolder *folder() const { return mFolder; }
-
-  QLineEdit    *loginEdit;
-  QLineEdit    *passwordEdit;
-  QLineEdit    *hostEdit;
-  QCheckBox    *storePasswordCheck;
-  QCheckBox    *excludeCheck;
-  QCheckBox    *intervalCheck;
-  QLabel       *intervalLabel;
-  KIntNumInput *intervalSpin;
-
-  KMFolder *mFolder;
-  KMAcctCachedImap *mAccount;
-  KMTransportInfo *mTransport;
-};
-
-
-class StartupWizard : public QWizard {
-  Q_OBJECT
-public:
-  // Call this to execute the thing
-  static void run();
-
-private slots:
-  virtual void back();
-  virtual void next();
-
-  void slotGroupwareEnabled( int );
-  void slotServerSettings( int i );
-  void slotUpdateParentFolderName();
-
-private:
-  StartupWizard( QWidget* parent = 0, const char* name = 0, bool modal = FALSE );
-
-  int language() const;
-  KMFolder* folder() const;
-
-  bool groupwareEnabled() const { return mGroupwareEnabled; }
-  bool useDefaultKolabSettings() const { return mUseDefaultKolabSettings; }
-
-  QString name() const;
-  QString login() const;
-  QString host() const;
-  QString email() const;
-  QString passwd() const;
-  bool storePasswd() const;
-
-  void setAppropriatePages();
-  void guessExistingFolderLanguage();
-  void setLanguage( int, bool );
-
-  // Write the KOrganizer settings
-  static void writeKOrganizerConfig( const StartupWizard& );
-
-  // Write the KABC settings
-  static void writeKAbcConfig();
-
-  // Write the KAddressbook settings
-  static void writeKAddressbookConfig( const StartupWizard& );
-
-  KPIM::Identity& userIdentity();
-  const KPIM::Identity& userIdentity() const;
-
-  QWidget* createIntroPage();
-  QWidget* createIdentityPage();
-  QWidget* createKolabPage();
-  QWidget* createAccountPage();
-  QWidget* createLanguagePage();
-  QWidget* createFolderSelectionPage();
-  QWidget* createFolderCreationPage();
-  QWidget* createOutroPage();
-
-  QWidget *mIntroPage, *mIdentityPage, *mKolabPage, *mAccountPage, *mLanguagePage,
-    *mFolderSelectionPage, *mFolderCreationPage, *mOutroPage;
-
-  QComboBox* mLanguageCombo;
-  KMFolderComboBox* mFolderCombo;
-  QTextBrowser* mFolderCreationText;
-  QLabel* mLanguageLabel;
-
-  WizardIdentityPage* mIdentityWidget;
-  WizardKolabPage* mKolabWidget;
-  NetworkPage* mAccountWidget;
-
-  QButtonGroup *serverSettings;
-
-  bool mGroupwareEnabled;
-  bool mUseDefaultKolabSettings;
-
-  KMFolder *mFolder;
-};
-
-
-#endif // STARTUPWIZARD_H
diff -urN -x CVS kdepim.orig/kmail/stl_util.h kdepim/kmail/stl_util.h
--- kdepim.orig/kmail/stl_util.h	Thu Jan  1 01:00:00 1970
+++ kdepim/kmail/stl_util.h	Mon Oct 18 15:20:39 2004
@@ -0,0 +1,47 @@
+/*  -*- c++ -*-
+    stl_util.h
+
+    This file is part of KMail, the KDE mail client.
+    Copyright (c) 2004 Marc Mutz <mutz@kde.org>
+
+    KMail is free software; you can redistribute it and/or modify it
+    under the terms of the GNU General Public License, version 2, as
+    published by the Free Software Foundation.
+
+    KMail is distributed in the hope that it will be useful, but
+    WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef __KDEPIM__KMAIL__STL_UTIL_H__
+#define __KDEPIM__KMAIL__STL_UTIL_H__
+
+template <typename T>
+static inline void DeleteAndSetToZero( const T* & t ) {
+  delete t; t = 0;
+}
+
+template <typename T>
+static inline void deleteAll( T & c ) {
+  for ( typename T::iterator it = c.begin() ; it != c.end() ; ++it ) {
+    delete *it ; *it = 0;
+  }
+}
+
+#endif // __KDEPIM__KMAIL__STL_UTIL_H__
diff -urN -x CVS kdepim.orig/kmail/urlhandlermanager.cpp kdepim/kmail/urlhandlermanager.cpp
--- kdepim.orig/kmail/urlhandlermanager.cpp	Fri Sep 24 23:05:00 2004
+++ kdepim/kmail/urlhandlermanager.cpp	Wed Oct  6 17:53:23 2004
@@ -78,18 +78,6 @@
     QString statusBarMessage( const KURL &, KMReaderWin * ) const;
   };
 
-  class GroupwareURLHandler : public KMail::URLHandler {
-  public:
-    GroupwareURLHandler() : KMail::URLHandler() {}
-    ~GroupwareURLHandler() {}
-
-    bool handleClick( const KURL &, KMReaderWin * ) const;
-    bool handleContextMenuRequest( const KURL &, const QPoint &, KMReaderWin * ) const {
-      return false;
-    }
-    QString statusBarMessage( const KURL &, KMReaderWin * ) const;
-  };
-
   class MailToURLHandler : public KMail::URLHandler {
   public:
     MailToURLHandler() : KMail::URLHandler() {}
@@ -261,7 +249,6 @@
 KMail::URLHandlerManager::URLHandlerManager() {
   registerHandler( new ShowHtmlSwitchURLHandler() );
   registerHandler( new SMimeURLHandler() );
-//  registerHandler( new GroupwareURLHandler() );
   registerHandler( new MailToURLHandler() );
   registerHandler( new HtmlAnchorHandler() );
   registerHandler( new AttachmentURLHandler() );
@@ -328,7 +315,6 @@
 
 // these includes are temporary and should not be needed for the code
 // above this line, so they appear only here:
-#include "kmgroupware.h"
 #include "kmmessage.h"
 #include "kmkernel.h"
 #include "kmreaderwin.h"
@@ -399,25 +385,6 @@
   }
 }
 
-namespace {
-  bool GroupwareURLHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
-    if ( !kmkernel->groupware().isEnabled() )
-      return false;
-    return !w || kmkernel->groupware().handleLink( url, w->message() );
-  }
-
-  QString GroupwareURLHandler::statusBarMessage( const KURL & url, KMReaderWin * ) const {
-    QString type, action, action2, dummy;
-    if ( url.url().find( "groupware_" ) == -1 ) return QString::null;
-    //if ( !KMGroupware::foundGroupwareLink( url.url(), type, action, action2, dummy ) )
-    //  return QString::null;
-    QString result = type + ' ' + action;
-    if ( !action2.isEmpty() )
-      result += ' ' + action2;
-    return i18n("Groupware: \"%1\"").arg( result );
-  }
-}
-
 namespace {
   bool HtmlAnchorHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
     if ( url.hasHost() || url.path() != "/" || !url.hasRef() )
diff -urN -x CVS kdepim.orig/kmobile/kioslave/mimetypes/mobile_notes.desktop kdepim/kmobile/kioslave/mimetypes/mobile_notes.desktop
--- kdepim.orig/kmobile/kioslave/mimetypes/mobile_notes.desktop	Tue Aug 24 08:32:17 2004
+++ kdepim/kmobile/kioslave/mimetypes/mobile_notes.desktop	Sun Oct  3 15:38:04 2004
@@ -14,7 +14,6 @@
 Comment[fi]=Mobiililaitteen muistio
 Comment[fr]=Notes dans un périphérique mobile
 Comment[gl]=Notas no Dispositivo Móbil
-Comment[he]==הערות על התקן נייד
 Comment[hi]=मोबाइल उपकरण में टीप
 Comment[hu]=Feljegyzések a mobiltelefonon
 Comment[is]=Áminningar í farsíma eða lófatölvu
diff -urN -x CVS kdepim.orig/knode/knode_config_accounts.desktop kdepim/knode/knode_config_accounts.desktop
--- kdepim.orig/knode/knode_config_accounts.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_accounts.desktop	Mon Oct  4 15:26:19 2004
@@ -15,6 +15,7 @@
 Name=Accounts
 Name[be]=Рахункі
 Name[bg]=Сметки
+Name[br]=Kontoù
 Name[bs]=Računi
 Name[ca]=Comptes
 Name[cs]=Účty
@@ -29,6 +30,7 @@
 Name[hu]=Fiókok
 Name[is]=Tengingar
 Name[it]=Account
+Name[ja]=アカウント
 Name[nb]=Kontoer
 Name[nn]=Kontoar
 Name[pl]=Konta
@@ -38,7 +40,7 @@
 Name[sk]=Účty
 Name[sl]=Računi
 Name[sr]=Налози
-Name[sr@Latn]=Налози
+Name[sr@Latn]=Nalozi
 Name[sv]=Konton
 Name[ta]=கணக்குகள்
 Name[tg]=Қайдҳои баҳисобгирӣ
@@ -59,6 +61,7 @@
 Comment[he]=הגדרות עבור שרתי דואר או חדשות )newsgroups(
 Comment[hu]=Hír- és levelezési kiszolgálók beállítása
 Comment[it]=Impostazioni per newsgroup e server di posta
+Comment[ja]=ニュースグループとメールサーバの設定
 Comment[nb]=Oppsett av nyhetsgruppe- og e-post tjenere
 Comment[nl]=Instellingen voor nieuws- en mailservers
 Comment[nn]=Oppsett av Usenet- og e-post-tenarar
@@ -69,7 +72,7 @@
 Comment[sk]=Nastavenie serverov pre poštu a diskusné skupiny
 Comment[sl]=Nastavitve za novične in poštne strežnike
 Comment[sr]=Поставке за групе новости и сервере поште
-Comment[sr@Latn]=Поставке за групе новости и сервере поште
+Comment[sr@Latn]=Postavke za grupe novosti i servere pošte
 Comment[sv]=Inställningar för diskussionsgrupp och postservrar
 Comment[ta]=செய்திக்குழு மற்றும் மின்னஞ்சல் சேவைகளுக்கான அமைப்பு
 Comment[tg]=Қайдҳои баҳисобгирӣ дар серверҳои почтавӣ ва серверҳои телеконференсия
diff -urN -x CVS kdepim.orig/knode/knode_config_appearance.desktop kdepim/knode/knode_config_appearance.desktop
--- kdepim.orig/knode/knode_config_appearance.desktop	Thu Sep 30 16:04:01 2004
+++ kdepim/knode/knode_config_appearance.desktop	Mon Oct  4 15:26:19 2004
@@ -44,7 +44,7 @@
 Name[sk]=Vzhľad
 Name[sl]=Videz
 Name[sr]=Изглед
-Name[sr@Latn]=Изглед
+Name[sr@Latn]=Izgled
 Name[sv]=Uppträdande
 Name[ta]=தோற்றம்
 Name[tg]=Намуди зоҳирӣ
@@ -65,6 +65,7 @@
 Comment[he]=הגדרת מראה
 Comment[hu]=A grafikai megjelenés testreszabása
 Comment[it]=Personalizza l'aspetto
+Comment[ja]=視覚的な外観をカスタマイズ
 Comment[nb]=Tilpass visuellt utseende
 Comment[nl]=Pas het uiterlijk aan
 Comment[nn]=Tilpass utsjånad
@@ -75,7 +76,7 @@
 Comment[sk]=Prispôsobenie vzhľadu
 Comment[sl]=Prilagodi videz
 Comment[sr]=Прилагодите визуелни приказ
-Comment[sr@Latn]=Прилагодите визуелни приказ
+Comment[sr@Latn]=Prilagodite vizuelni prikaz
 Comment[sv]=Anpassa visuellt uppträdande
 Comment[ta]=பார்க்கும் தோற்றத்தை தனிபயனாக்கு
 Comment[tg]=Танзимоти намуди зоҳирӣ
diff -urN -x CVS kdepim.orig/knode/knode_config_cleanup.desktop kdepim/knode/knode_config_cleanup.desktop
--- kdepim.orig/knode/knode_config_cleanup.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_cleanup.desktop	Mon Oct  4 15:26:19 2004
@@ -26,6 +26,7 @@
 Name[he]=נקיון
 Name[hu]=Tisztítás
 Name[it]=Pulizia
+Name[ja]=クリーンナップ
 Name[nb]=Rydd opp
 Name[nl]=Opschoning
 Name[nn]=Rydd opp
@@ -36,7 +37,7 @@
 Name[sk]=Vyčistenie
 Name[sl]=Čiščenje
 Name[sr]=Чишћење
-Name[sr@Latn]=Чишћење
+Name[sr@Latn]=Čišćenje
 Name[sv]=Upprensning
 Name[ta]=சுத்தம் செய்
 Name[tg]=Тозакунии диск
@@ -54,6 +55,7 @@
 Comment[he]=שמירה על מקום בכונן
 Comment[hu]=A lemezterület megőrzése
 Comment[it]=Risparmia lo spazio su disco
+Comment[ja]=ディスク・スペースの保存
 Comment[nb]=Bevarer disk plass
 Comment[nl]=Besparing van schrijfruimte
 Comment[nn]=Frigjer diskplass
@@ -64,7 +66,7 @@
 Comment[sk]=Úspora miesta na disku
 Comment[sl]=Ohranjanje prostora na disku
 Comment[sr]=Чување простора на диску
-Comment[sr@Latn]=Чување простора на диску
+Comment[sr@Latn]=Čuvanje prostora na disku
 Comment[sv]=Bevara diskutrymme
 Comment[ta]=தட்டின் இடத்தை சேமித்தல்
 Comment[tg]=Нигоҳ доштани ҷое дар диск
diff -urN -x CVS kdepim.orig/knode/knode_config_identity.desktop kdepim/knode/knode_config_identity.desktop
--- kdepim.orig/knode/knode_config_identity.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_identity.desktop	Mon Oct  4 15:26:19 2004
@@ -27,6 +27,7 @@
 Name[hu]=Azonosító
 Name[is]=Auðkenni
 Name[it]=Identità
+Name[ja]=身元
 Name[nb]=Identitet
 Name[nl]=Identiteit
 Name[nn]=Identitet
@@ -37,7 +38,7 @@
 Name[sk]=Identita
 Name[sl]=Identiteta
 Name[sr]=Идентитет
-Name[sr@Latn]=Идентитет
+Name[sr@Latn]=Identitet
 Name[sv]=Identitet
 Name[ta]=அடையாளம்
 Name[tg]=Профил
@@ -58,6 +59,7 @@
 Comment[hu]=Személyi adatok
 Comment[is]=Persónuupplýsingar
 Comment[it]=Informazioni personali
+Comment[ja]=個人の情報
 Comment[nl]=Persoonlijke informatie
 Comment[nn]=Personleg informasjon
 Comment[pl]=Informacje osobiste
@@ -67,7 +69,7 @@
 Comment[sk]=Osobné informácie
 Comment[sl]=Osebne informacije
 Comment[sr]=Лична информација
-Comment[sr@Latn]=Лична информација
+Comment[sr@Latn]=Lična informacija
 Comment[sv]=Personlig information
 Comment[ta]=சொந்த தகவல்
 Comment[tg]=Маълумоти шахсӣ
diff -urN -x CVS kdepim.orig/knode/knode_config_post_news.desktop kdepim/knode/knode_config_post_news.desktop
--- kdepim.orig/knode/knode_config_post_news.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_post_news.desktop	Mon Oct  4 15:26:19 2004
@@ -26,6 +26,7 @@
 Name[he]=שליחת חדשות
 Name[hu]=Hírek írása
 Name[it]=Invio news
+Name[ja]=ニュースの投稿
 Name[nb]=Legge inn Njus
 Name[nl]=Nieuws posten
 Name[nn]=Send innlegg
@@ -36,7 +37,7 @@
 Name[sk]=Posielanie príspevkov
 Name[sl]=Pošiljanje novic
 Name[sr]=Слање новости
-Name[sr@Latn]=Слање новости
+Name[sr@Latn]=Slanje novosti
 Name[sv]=Skicka inlägg
 Name[ta]=செய்திகளை அனுப்புதல் 
 Name[tg]=Ҷойгиркунии мақола
diff -urN -x CVS kdepim.orig/knode/knode_config_privacy.desktop kdepim/knode/knode_config_privacy.desktop
--- kdepim.orig/knode/knode_config_privacy.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_privacy.desktop	Mon Oct  4 15:26:19 2004
@@ -26,6 +26,7 @@
 Name[he]=חתימה/וידוא
 Name[hu]=Aláírás/ellenőrzés
 Name[it]=Firma/verifica
+Name[ja]=署名/確認
 Name[nb]=Signering/Verifisering
 Name[nl]=Ondertekening/Verifiëring
 Name[nn]=Signering/stadfesting
@@ -36,7 +37,7 @@
 Name[sk]=Podpis/overenie
 Name[sl]=Podpisovanje/Preverjanje
 Name[sr]=Потписивање-проверавање
-Name[sr@Latn]=Потписивање-проверавање
+Name[sr@Latn]=Potpisivanje-proveravanje
 Name[sv]=Signera och verifiera
 Name[ta]=கையெழுத்து இடுதல்/சரிபார்த்தல்
 Name[tg]=Имзо ва тафтиш
@@ -52,6 +53,7 @@
 Comment[fr]=Protection de votre vie privée lors de la signature et vérification des envois
 Comment[hu]=Az adatok védelme az üzenetek elektronikus aláírásával, titkosításával
 Comment[it]=Proteggi la tua privacy firmando e verificando i messaggi
+Comment[ja]=署名および確認の通達によりあなたのプライバシーを保護します
 Comment[nb]=Besykkt privatlivet ditt ved å signere og verifisere oppslag
 Comment[nl]=Bescherm uw privacy door uw berichten te ondertekenen en te verifiëren
 Comment[nn]=Vern om privatlivet med signerte og stadfesta innlegg
@@ -62,7 +64,7 @@
 Comment[sk]=Chráňte svoje súkromie digitálnymi podpismi a overovaním príspevkov
 Comment[sl]=Zaščitite vašo zasebnost s podpisovanjem ali preverjanjem člankov
 Comment[sr]=Заштитите вашу приватност потписивајући и проверавајући поруке
-Comment[sr@Latn]=Заштитите вашу приватност потписивајући и проверавајући поруке
+Comment[sr@Latn]=Zaštitite vašu privatnost potpisivajući i proveravajući poruke
 Comment[sv]=Skyddar din integritet genom att signera och verifiera meddelanden
 Comment[tg]=Муҳофизати иттилоот ба воситаи имзо ва тафтиши ахборот
 Comment[zh_CN]=通过对发表的文件进行签名和校验来保护您的隐私
diff -urN -x CVS kdepim.orig/knode/knode_config_read_news.desktop kdepim/knode/knode_config_read_news.desktop
--- kdepim.orig/knode/knode_config_read_news.desktop	Sat Oct  2 16:30:22 2004
+++ kdepim/knode/knode_config_read_news.desktop	Mon Oct  4 15:26:19 2004
@@ -27,6 +27,7 @@
 Name[he]=קריאת חדשות
 Name[hu]=Hírek olvasása
 Name[it]=Lettura News
+Name[ja]=ニュースを読む
 Name[nb]=Lese Njus
 Name[nl]=Nieuws lezen
 Name[nn]=Les innlegg
@@ -37,7 +38,7 @@
 Name[sk]=Čítanie diskusných skupín
 Name[sl]=Branje novic
 Name[sr]=Читање новости
-Name[sr@Latn]=Читање новости
+Name[sr@Latn]=Čitanje novosti
 Name[sv]=Läsa inlägg
 Name[ta]=செய்திகளைப் படித்தல்
 Name[tg]=Хондани ахборот
diff -urN -x CVS kdepim.orig/knotes/ChangeLog kdepim/knotes/ChangeLog
--- kdepim.orig/knotes/ChangeLog	Fri Aug 20 21:55:47 2004
+++ kdepim/knotes/ChangeLog	Mon Oct  4 22:51:49 2004
@@ -1,6 +1,76 @@
 ChangeLog for KNotes
 ====================
 
+2004/09/27  Michael Brade <brade@kde.org>
+
+    * no compile-time dependency on kdebase allowed, so read kwinrc directly
+
+2004/08/31  Michael Brade <brade@kde.org>
+
+    * now KNotes always saves the desktop of its notes since this is what one
+      would expect, I guess. Visible change: if you hide a note, change to
+      another desktop and show it again, the note will be shown on the desktop
+      where it has been hidden. And more important, if a note is sticky it will
+      still be sticky after it is first hidden and then shown again. Let's see
+      what the users' feedback will be.
+
+      This will also make it possible to properly implement the often requested
+      hide all/show all notes feature.
+    * fixed #29242, #44761, #65090: implemented Show All/Hide All Notes and
+      added a global shortcut for both actions. Thanks to Jakob Schroeter for
+      the initial patch on which this is based and the idea to add the global
+      shortcut. With my previous patch to properly store the desktop this
+      feature is now usable.
+
+2004/08/29  Michael Brade <brade@kde.org>
+
+    * fixed #77202: removing the global event filter where I not only returned
+      the proper boolean value but also (incorrectly) changed the accept/ignore
+      flag of key events fixed the endless loop that caused the stack overflow.
+    * fixed #68031, #81888: configuring shortcuts is possible now and changes
+      are preserved between several KNotes sessions. All possible interactions
+      with KNotes can have custom shortcuts, there are no hidden features
+      anymore.
+
+2004/08/28  Michael Brade <brade@kde.org>
+
+    * fixed #71593, #86711: add the possibility to save a note to a file, either
+      in plain text or rich text format. Initial patch by Jakob Schroeter,
+      js AT camaya DOT net, thanks!
+
+2004/08/27  Michael Brade <brade@kde.org>
+
+    * fixed #50104, #75485: finally (!) use KWin to move the note windows. Thanks
+      to Luboš for telling me that just the XUngrabPointer line was missing to
+      make it work.
+      This enables the active desktop borders and snap zones for KNotes.
+    * fixed #68481: Also using a tip from Luboš I made KNotes put its close
+      button where all the other windows have it as well. KNotes needs to be
+      restarted though to make a change take effect. Needs a fix.
+
+2004/08/26  Michael Brade <brade@kde.org>
+
+    * fixed jumping/moving of the title text on focusIn/Out events, still not
+      perfect
+
+2004/08/25  Michael Brade <brade@kde.org>
+
+    * split KNotes into 5 static libraries to provide for reusability of parts
+      of KNotes.
+
+2004/08/22  Michael Brade <brade@kde.org>
+
+    * fixed #81672: when there are no notes don't put the toolbar in the system
+      tray *blush* by splitting the XMLGUI file for the system tray and the
+      notes
+    * still share the parsed note xmlgui file between the notes by parsing it
+      and creating a QDomDocument in KNotesApp already
+    * when there is no note after restoring a session, still show the "No Notes"
+      item in the notes menu
+    * each note now has its own KXMLGUIBilder to get rid of the reparent-call,
+      the builder's parent will be the widgets' parent
+    * fixed #87696: allow default sizes as small as 50x50 pixels
+
 2004/08/20  Michael Brade <brade@kde.org>
 
     * fixed #85973: respect newlines when switching from plain text to
diff -urN -x CVS kdepim.orig/knotes/KNotesAppIface.h kdepim/knotes/KNotesAppIface.h
--- kdepim.orig/knotes/KNotesAppIface.h	Thu Jan  1 01:00:00 1970
+++ kdepim/knotes/KNotesAppIface.h	Mon Oct  4 22:51:49 2004
@@ -0,0 +1,162 @@
+/*******************************************************************
+ KNotesIface.h  --  This file defines the DCOP interface for KNotes.
+
+ Copyright (C) 2004 by Michael Brade <brade@kde.org>
+
+ This program is free software; you can redistribute it and/or
+ modify it under the terms of the GNU General Public License
+ as published by the Free Software Foundation; either version 2
+ of the License, or (at your option) any later version.
+
+ This program is distributed in the hope that it will be useful,
+ but WITHOUT ANY WARRANTY; without even the implied warranty of
+ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ GNU General Public License for more details.
+
+ You should have received a copy of the GNU General Public License
+ along with this program; if not, write to the Free Software
+ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+ In addition, as a special exception, the copyright holders give
+ permission to link the code of this program with any edition of
+ the Qt library by Trolltech AS, Norway (or with modified versions
+ of Qt that use the same license as Qt), and distribute linked
+ combinations including the two.  You must obey the GNU General
+ Public License in all respects for all of the code used other than
+ Qt.  If you modify this file, you may extend this exception to
+ your version of the file, but you are not obligated to do so.  If
+ you do not wish to do so, delete this exception statement from
+ your version.
+*******************************************************************/
+
+#ifndef __KNotesAppIface_h__
+#define __KNotesAppIface_h__
+
+#include <qstring.h>
+#include <qmap.h>
+
+#include <dcopobject.h>
+
+
+class KNotesAppIface : virtual public DCOPObject
+{
+    K_DCOP
+k_dcop:
+    /**
+     * Create a new note.
+     * @param name the name (title) of the new note, if it is empty,
+     *        KNotes will choose an appropriate name
+     * @param text the body of the new note
+     * @return the new notes' id
+     */
+    virtual QString newNote( const QString& name = QString::null,
+                             const QString& text = QString::null ) = 0;
+
+    /**
+     * Create a new note and inserts the current text in the clipboard
+     * as text.
+     *
+     * @param name the name (title) of the new note, if it is empty,
+     *        KNotes will choose an appropriate name
+     * @return the new notes' id
+     */
+    virtual QString newNoteFromClipboard( const QString& name = QString::null ) = 0;
+
+    /**
+     * Deletes a note forever.
+     * @param noteId the id of the note to kill
+     */
+    virtual ASYNC killNote( const QString& noteId ) = 0;
+
+    /**
+     * Deletes a note forever.
+     * @param noteId the id of the note to kill
+     * @param force do not request confirmation
+     */
+    virtual ASYNC killNote( const QString& noteId, bool force ) = 0;
+
+    /**
+     * Get all the notes including their ids.
+     * @return a QMap that maps the id of a note to its name
+     */
+    virtual QMap<QString,QString> notes() const = 0;
+
+    /**
+     * Changes the title/name of a note.
+     * @param noteId the id of the note to be modified
+     * @param newName the new title
+     */
+    virtual ASYNC setName( const QString& noteId, const QString& newName ) = 0;
+
+    /**
+     * Sets the text of a note. This will delete the old text!
+     * @param noteId the id of the note
+     * @param newText the new text for the note
+     */
+    virtual ASYNC setText( const QString& noteId, const QString& newText ) = 0;
+
+    /**
+     * Returns the title/name of a note.
+     * @param noteId the id of the note in question
+     * @return the name as a QString
+     */
+    virtual QString name( const QString& noteId ) const = 0;
+
+    /**
+     * Returns the text of a note.
+     * @param noteId the id of the note in question
+     * @return the body as a QString
+     */
+    virtual QString text( const QString& noteId ) const = 0;
+
+
+    /******** HERE STARTS THE KNotesAppIface DCOP INTERFACE EXTENSION ********/
+
+    /**
+     * Show a note as if it had been selected from the "notes" menu.
+     * @param noteId the id of the note to show
+     */
+    virtual ASYNC showNote( const QString& noteId ) const = 0;
+
+    /**
+     * Hide a note.
+     * @param noteId the id of the note to hide
+     */
+    virtual ASYNC hideNote( const QString& noteId ) const = 0;
+
+    /**
+     * Show all notes on their respective desktops.
+     */
+    virtual ASYNC showAllNotes() const = 0;
+
+    /**
+     * Hide all notes.
+     */
+    virtual ASYNC hideAllNotes() const = 0;
+
+    /**
+     * This tells KNotes that a specific app has synchronized with all the notes.
+     * @param app the app that has synced with KNotes
+     */
+    virtual ASYNC sync( const QString& app ) = 0;
+
+    /**
+     * Test if a note was created new after the last sync.
+     * @param app the app that wants to get the status since the last sync
+     * @param noteId the id of the note
+     * @return true if the note is new, false if not or if the note does
+     *         not exist
+     */
+    virtual bool isNew( const QString& app, const QString& noteId ) const = 0;
+
+    /**
+     * Test if a note was modified since the last sync.
+     * @param app the app that wants to get the status since the last sync
+     * @param noteId the id of the note
+     * @return true if modified (note that this will return true if the note is
+     *         new as well!) and false if the note is not modified or doesn't exist
+     */
+    virtual bool isModified( const QString& app, const QString& noteId ) const = 0;
+};
+
+#endif
diff -urN -x CVS kdepim.orig/knotes/KNotesIface.h kdepim/knotes/KNotesIface.h
--- kdepim.orig/knotes/KNotesIface.h	Wed Feb 25 00:37:28 2004
+++ kdepim/knotes/KNotesIface.h	Mon Oct  4 22:51:49 2004
@@ -53,18 +53,6 @@
     virtual QString newNoteFromClipboard( const QString& name = QString::null ) = 0;
 
     /**
-     * Show a note as if it had been selected from the "notes" menu.
-     * @param noteId the id of the note to show
-     */
-    virtual ASYNC showNote( const QString& noteId ) const = 0;
-
-    /**
-     * Hide a note.
-     * @param noteId the id of the note to hide
-     */
-    virtual ASYNC hideNote( const QString& noteId ) const = 0;
-
-    /**
      * Deletes a note forever.
      * @param noteId the id of the note to kill
      */
@@ -110,30 +98,6 @@
      * @return the body as a QString
      */
     virtual QString text( const QString& noteId ) const = 0;
-
-    /**
-     * This tells KNotes that a specific app has synchronized with all the notes.
-     * @param app the app that has synced with KNotes
-     */
-    virtual ASYNC sync( const QString& app ) = 0;
-
-    /**
-     * Test if a note was created new after the last sync.
-     * @param app the app that wants to get the status since the last sync
-     * @param noteId the id of the note
-     * @return true if the note is new, false if not or if the note does
-     *         not exist
-     */
-    virtual bool isNew( const QString& app, const QString& noteId ) const = 0;
-
-    /**
-     * Test if a note was modified since the last sync.
-     * @param app the app that wants to get the status since the last sync
-     * @param noteId the id of the note
-     * @return true if modified (note that this will return true if the note is
-     *         new as well!) and false if the note is not modified or doesn't exist
-     */
-    virtual bool isModified( const QString& app, const QString& noteId ) const = 0;
 };
 
 #endif
diff -urN -x CVS kdepim.orig/knotes/Makefile.am kdepim/knotes/Makefile.am
--- kdepim.orig/knotes/Makefile.am	Tue Apr 20 22:22:04 2004
+++ kdepim/knotes/Makefile.am	Mon Oct  4 22:51:49 2004
@@ -4,39 +4,47 @@
 
 bin_PROGRAMS    = knotes
 
-include_HEADERS = KNotesIface.h
+include_HEADERS = KNotesIface.h KNotesAppIface.h
 noinst_HEADERS  = knotesapp.h knote.h knoteedit.h knotebutton.h knoteconfigdlg.h \
-						knoteslegacy.h resourcemanager.h resourcenotes.h resourcelocal.h \
-						knotesnetrecv.h knotesnetsend.h knotehostdlg.h
+                  knoteslegacy.h resourcemanager.h resourcenotes.h resourcelocal.h \
+                  knotesnetrecv.h knotesnetsend.h knotehostdlg.h
 
-noinst_LTLIBRARIES = libknotes.la
-libknotes_la_SOURCES = knotesapp.cpp knote.cpp knoteedit.cpp knotebutton.cpp \
-							  knoteconfigdlg.cpp knoteconfig.kcfgc knotesglobalconfig.kcfgc \
-							  KNotesIface.skel knoteslegacy.cpp \
-							  resourcemanager.cpp resourcenotes.cpp resourcelocal.cpp \
-							  knotesnetrecv.cpp knotesnetsend.cpp knotehostdlg.cpp
+noinst_LTLIBRARIES = libknote.la libknoteseditor.la libknoteslegacy.la libknotesconfig.la \
+                     libknotesresources.la libknotesnetwork.la
 
-knotes_SOURCES  = main.cpp
-knotes_LDADD    = libknotes.la $(LIB_KIO) -lkresources -lkdeprint $(top_builddir)/libkcal/libkcal.la
+libknoteslegacy_la_SOURCES = knoteslegacy.cpp
+libknotesconfig_la_SOURCES = knoteconfig.kcfgc knotesglobalconfig.kcfgc
+libknoteseditor_la_SOURCES = knoteedit.cpp
+libknotesnetwork_la_SOURCES = knotesnetrecv.cpp knotesnetsend.cpp
+libknotesresources_la_SOURCES = resourcemanager.cpp resourcenotes.cpp resourcelocal.cpp
+libknote_la_SOURCES = knote.cpp knotebutton.cpp knoteconfigdlg.cpp knotehostdlg.cpp
+
+knotes_SOURCES  = main.cpp knotesapp.cpp KNotesAppIface.skel
+knotes_LDADD    = libknote.la libknoteseditor.la libknotesnetwork.la libknotesresources.la \
+                  libknoteslegacy.la libknotesconfig.la  $(top_builddir)/libkcal/libkcal.la $(LIB_KIO) \
+                  -lkresources -lkdeprint
 knotes_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
+knotes_COMPILE_FIRST = libknotesconfig.la
 
-kde_module_LTLIBRARIES = knotes_local.la
+kde_module_LTLIBRARIES  = knotes_local.la
 knotes_local_la_SOURCES = resourcelocal_plugin.cpp
 knotes_local_la_LDFLAGS = $(KDE_LDFLAGS) -module $(KDE_PLUGIN)
-knotes_local_la_LIBADD  = libknotes.la $(top_builddir)/libkcal/libkcal.la -lkdeprint
-
+knotes_local_la_LIBADD  = libknotesresources.la libknotesconfig.la \
+                          $(top_builddir)/libkcal/libkcal.la -lkdeprint
 
 METASOURCES     = AUTO
 
 xdg_apps_DATA   = knotes.desktop
 kde_kcfg_DATA   = knoteconfig.kcfg knotesglobalconfig.kcfg
 
-ui_DATA         = knotesui.rc
+ui_DATA         = knotesappui.rc knotesui.rc
 uidir           = $(kde_datadir)/knotes
 
 service_DATA    = local.desktop
 servicedir      = $(kde_servicesdir)/kresources/knotes
 
+KDE_OPTIONS = nofinal
+
 messages: rc.cpp
 	$(XGETTEXT) *.cpp -o $(podir)/knotes.pot
 
diff -urN -x CVS kdepim.orig/knotes/TODO kdepim/knotes/TODO
--- kdepim.orig/knotes/TODO	Sun Apr 25 01:39:25 2004
+++ kdepim/knotes/TODO	Mon Oct  4 22:51:49 2004
@@ -29,6 +29,7 @@
    reflect that
 
 TODO:
+ * F1 should open Help
  * do not copy the knotesrc file anymore
    => use the static KNotesGlobalConfig object and copy the important stuff over
       Disadv: some keys and defaults must be defined in both config files
@@ -56,6 +57,8 @@
  * transparent notes
  * shadow for the notes
  * icons for the notes (small, put in the note menu and note title)
+ * gradients
+ * action to keep all notes on top
 
 older TODOs from Wynn:
  * inserting calendar
diff -urN -x CVS kdepim.orig/knotes/knote.cpp kdepim/knotes/knote.cpp
--- kdepim.orig/knotes/knote.cpp	Tue Aug 31 17:11:22 2004
+++ kdepim/knotes/knote.cpp	Mon Oct  4 22:51:49 2004
@@ -27,6 +27,8 @@
 #include <qpaintdevicemetrics.h>
 #include <qsimplerichtext.h>
 #include <qobjectlist.h>
+#include <qfile.h>
+#include <qcheckbox.h>
 
 #include <kapplication.h>
 #include <kdebug.h>
@@ -35,18 +37,19 @@
 #include <kcombobox.h>
 #include <ktoolbar.h>
 #include <kpopupmenu.h>
+#include <kxmlguibuilder.h>
 #include <kxmlguifactory.h>
 #include <kcolordrag.h>
 #include <kiconeffect.h>
 #include <kprinter.h>
 #include <klocale.h>
 #include <kstandarddirs.h>
-#include <ksimpleconfig.h>
 #include <kmessagebox.h>
 #include <kprocess.h>
 #include <kinputdialog.h>
 #include <kmdcodec.h>
 #include <kglobalsettings.h>
+#include <kfiledialog.h>
 #include <kio/netaccess.h>
 
 #include <libkcal/journal.h>
@@ -63,18 +66,18 @@
 
 #include <kwin.h>
 #include <netwm.h>
-//#include <kdecoration.h>
 
 #include <fixx11h.h>
 
 using namespace KCal;
 
+extern Time qt_x_time;
 
-KNote::KNote( KXMLGUIBuilder* builder, QDomDocument buildDoc, Journal *j,
-              QWidget* parent, const char* name )
+
+KNote::KNote( QDomDocument buildDoc, Journal *j, QWidget *parent, const char *name )
   : QFrame( parent, name, WStyle_Customize | WStyle_NoBorder | WDestructiveClose ),
-    m_label( 0 ), m_button( 0 ), m_tool( 0 ), m_editor( 0 ),
-    m_config( 0 ), m_journal( j )
+    m_label( 0 ), m_button( 0 ), m_tool( 0 ), m_editor( 0 ), m_config( 0 ),
+    m_journal( j ), m_kwinConf( KSharedConfig::openConfig( "kwinrc", true ) )
 {
     // be explicit
     KWin::setIcons( winId(), kapp->icon(), kapp->miniIcon() );
@@ -82,6 +85,11 @@
     setAcceptDrops( true );
     actionCollection()->setWidget( this );
 
+    setDOMDocument( buildDoc );
+
+    // just set the name of the file to save the actions to, do NOT reparse it
+    setXMLFile( instance()->instanceName() + "ui.rc", false, false );
+
     // if there is no title yet, use the start date if valid
     // (KOrganizer's journals don't have titles but a valid start date)
     if ( m_journal->summary().isNull() && m_journal->dtStart().isValid() )
@@ -91,12 +99,12 @@
     }
 
     // create the menu items for the note - not the editor...
-    // rename, mail, print, insert date, close, delete, new note
+    // rename, mail, print, save as, insert date, close, delete, new note
     new KAction( i18n("New"), "filenew", 0,
         this, SIGNAL(sigRequestNewNote()), actionCollection(), "new_note" );
     new KAction( i18n("Rename..."), "text", 0,
         this, SLOT(slotRename()), actionCollection(), "rename_note" );
-    new KAction( i18n("Hide"), "fileclose" , 0,
+    new KAction( i18n("Hide"), "fileclose" , Key_Escape,
         this, SLOT(slotClose()), actionCollection(), "hide_note" );
     new KAction( i18n("Delete"), "knotes_delete", 0,
         this, SLOT(slotKill()), actionCollection(), "delete_note" );
@@ -107,6 +115,8 @@
         this, SLOT(slotSend()), actionCollection(), "send_note" );
     new KAction( i18n("Mail..."), "mail_send", 0,
         this, SLOT(slotMail()), actionCollection(), "mail_note" );
+//    new KAction( i18n("Save As..."), "filesaveas", 0,
+//        this, SLOT(slotSaveAs()), actionCollection(), "save_note" );
     KStdAction::print( this, SLOT(slotPrint()), actionCollection(), "print_note" );
     new KAction( i18n("Preferences..."), "configure", 0,
         this, SLOT(slotPreferences()), actionCollection(), "configure_note" );
@@ -123,27 +133,49 @@
         this, SLOT(slotPopupActionToDesktop(int)), actionCollection(), "to_desktop" );
     connect( m_toDesktop->popupMenu(), SIGNAL(aboutToShow()), this, SLOT(slotUpdateDesktopActions()) );
 
-    // create the note header, button and label...
-    m_button = new KNoteButton( "knotes_close", this );
-    connect( m_button, SIGNAL(clicked()), this, SLOT(slotClose()) );
+    // invisible action to walk through the notes to make this configurable
+    new KAction( QString::null, 0, SHIFT+Key_BackTab,
+                 this, SIGNAL(sigShowNextNote()), actionCollection(), "walk_notes" );
+//    new KAction( i18n("Walk Through Notes"), 0, SHIFT+Key_BackTab,
+//                 this, SIGNAL(sigShowNextNote()), actionCollection(), "walk_notes" );
 
+    // create the note header, button and label...
     m_label = new QLabel( this );
     m_label->installEventFilter( this );  // receive events (for dragging & action menu)
     setName( m_journal->summary() );      // don't worry, no signals are connected at this stage yet
 
+    m_button = new KNoteButton( "knotes_close", this );
+    connect( m_button, SIGNAL(clicked()), this, SLOT(slotClose()) );
+
     // create the note editor
     m_editor = new KNoteEdit( actionCollection(), this );
     m_editor->installEventFilter( this ); // receive events (for modified)
     m_editor->viewport()->installEventFilter( this );
 
-    setDOMDocument( buildDoc );
-    KXMLGUIFactory factory( builder, this, "guifactory" );
+    KXMLGUIBuilder builder( this );
+    KXMLGUIFactory factory( &builder, this );
     factory.addClient( this );
 
     m_menu = static_cast<KPopupMenu*>(factory.container( "note_context", this ));
     m_edit_menu = static_cast<KPopupMenu*>(factory.container( "note_edit", this ));
     m_tool = static_cast<KToolBar*>(factory.container( "note_tool", this ));
-    m_tool->reparent( this, QPoint( 0, 0 ) );
+    m_tool->setIconSize( 10 );
+    m_tool->setFixedHeight( 16 );
+
+    // if there was just a way of making KComboBox adhere the toolbar height...
+    QObjectList *list = m_tool->queryList( "KComboBox" );
+    QObjectListIt it( *list );
+    while ( it.current() != 0 )
+    {
+        KComboBox *combo = (KComboBox *)it.current();
+        QFont font = combo->font();
+        font.setPointSize( 7 );
+        combo->setFont( font );
+        combo->setFixedHeight( 14 );
+        ++it;
+    }
+    delete list;
+
     m_tool->hide();
 
     setFocusProxy( m_editor );
@@ -187,7 +219,7 @@
 
     if ( newNote )
     {
-        // until kdelibs provides copying of KConfigSkeletons (KDE 3.3)
+        // until kdelibs provides copying of KConfigSkeletons (KDE 3.4)
         KNotesGlobalConfig *globalConfig = KNotesGlobalConfig::self();
         m_config->setBgColor( globalConfig->bgColor() );
         m_config->setFgColor( globalConfig->fgColor() );
@@ -201,6 +233,7 @@
         m_config->setTabSize( globalConfig->tabSize() );
 
         m_config->setDesktop( globalConfig->desktop() );
+        m_config->setHideNote( globalConfig->hideNote() );
         m_config->setPosition( globalConfig->position() );
         m_config->setShowInTaskbar( globalConfig->showInTaskbar() );
         m_config->setKeepAbove( globalConfig->keepAbove() );
@@ -232,6 +265,25 @@
     if ( desk.intersects( QRect( position, QSize( width, height ) ) ) )
         move( position );           // do before calling show() to avoid flicker
 
+    // config items in the journal have priority
+    QString property = m_journal->customProperty( "KNotes", "FgColor" );
+    if ( property != QString::null )
+        m_config->setFgColor( QColor( property ) );
+    else
+        m_journal->setCustomProperty( "KNotes", "FgColor", m_config->fgColor().name() );
+
+    property = m_journal->customProperty( "KNotes", "BgColor" );
+    if ( property != QString::null )
+        m_config->setBgColor( QColor( property ) );
+    else
+        m_journal->setCustomProperty( "KNotes", "BgColor", m_config->bgColor().name() );
+
+    property = m_journal->customProperty( "KNotes", "RichText" );
+    if ( property != QString::null )
+        m_config->setRichText( property == "true" ? true : false );
+    else
+        m_journal->setCustomProperty( "KNotes", "RichText", m_config->richText() ? "true" : "false" );
+
     // read configuration settings...
     slotApplyConfig();
 
@@ -242,22 +294,15 @@
         desktop = KWin::currentDesktop();
 
     // show the note if desired
-    if ( desktop != 0 && !isVisible() )
+    if ( desktop != 0 && !m_config->hideNote() )
     {
-        // HACK HACK
-        if ( desktop != NETWinInfo::OnAllDesktops )
-        {
-            // to avoid flicker, call this before show()
-            toDesktop( desktop );
-            show();
-        }
-        else
-        {
-            show();
-            // if this is called before show(),
-            // it won't work for sticky notes!!!
+        // to avoid flicker, call this before show()
+        toDesktop( desktop );
+        show();
+
+        // because KWin forgets about that for hidden windows
+        if ( desktop == NETWinInfo::OnAllDesktops )
             toDesktop( desktop );
-        }
     }
 
     m_editor->setText( m_journal->description() );
@@ -304,6 +349,9 @@
 {
     m_journal->setSummary( m_label->text() );
     m_journal->setDescription( m_editor->text() );
+    m_journal->setCustomProperty( "KNotes", "FgColor", paletteForegroundColor().name() );
+    m_journal->setCustomProperty( "KNotes", "BgColor", paletteBackgroundColor().name() );
+    m_journal->setCustomProperty( "KNotes", "RichText", m_config->richText() ? "true" : "false" );
 
     emit sigDataChanged();
     m_editor->setModified( false );
@@ -315,8 +363,9 @@
     m_config->setHeight( height() - (m_tool->isHidden() ? 0 : m_tool->height()) );
     m_config->setPosition( pos() );
 
-    NETWinInfo wm_client( qt_xdisplay(), winId(), qt_xrootwin(), NET::WMDesktop | NET::WMState );
-    m_config->setDesktop( wm_client.desktop() );
+    NETWinInfo wm_client( qt_xdisplay(), winId(), qt_xrootwin(), NET::WMDesktop );
+    if ( wm_client.desktop() == NETWinInfo::OnAllDesktops || wm_client.desktop() > 0 )
+        m_config->setDesktop( wm_client.desktop() );
 
     // actually store the config on disk
     m_config->writeConfig();
@@ -407,14 +456,6 @@
         return true;
 }
 
-void KNote::toDesktop( int desktop )
-{
-    if ( desktop == 0 || desktop == NETWinInfo::OnAllDesktops )
-        KWin::setOnAllDesktops( winId(), true );
-    else
-        KWin::setOnDesktop( winId(), desktop );
-}
-
 
 // ------------------ private slots (menu actions) ------------------ //
 
@@ -432,8 +473,15 @@
 
 void KNote::slotClose()
 {
+    NETWinInfo wm_client( qt_xdisplay(), winId(), qt_xrootwin(), NET::WMDesktop );
+    if ( wm_client.desktop() == NETWinInfo::OnAllDesktops || wm_client.desktop() > 0 )
+        m_config->setDesktop( wm_client.desktop() );
+
     m_editor->clearFocus();
-    hide(); //just hide the note so it's still available from the dock window
+    m_config->setHideNote( true );
+
+    // just hide the note so it's still available from the dock window
+    hide();
 }
 
 void KNote::slotInsDate()
@@ -471,24 +519,19 @@
     }
 
     // Send the note
-    (void)new KNotesNetworkSender( host, name(), text() );
+    KNotesNetworkSender *sender = new KNotesNetworkSender( host, KNotesGlobalConfig::port() );
+    sender->setSenderId( KNotesGlobalConfig::senderID() );
+    sender->setNote( name(), text() );
+    sender->connect();
 }
 
 void KNote::slotMail()
 {
-    saveData();
-
     QString msg_body = m_editor->text();
 
     // convert rich text to plain text first
     if ( m_editor->textFormat() == RichText )
-    {
-        QTextEdit conv;
-        conv.setTextFormat( RichText );
-        conv.setText( msg_body );
-        conv.setTextFormat( PlainText );
-        msg_body = conv.text();
-    }
+        msg_body = toPlainText( msg_body );
 
     // get the mail action command
     QStringList cmd_list = QStringList::split( QChar(' '), KNotesGlobalConfig::mailAction() );
@@ -570,11 +613,43 @@
     }
 }
 
+void KNote::slotSaveAs()
+{
+/*
+    QString msg_body = m_editor->text();
+    QCheckBox *convert = 0;
+
+    if ( m_editor->textFormat() == RichText )
+    {
+        convert = new QCheckBox( 0 );
+        convert->setText( i18n("Save note as plain text") );
+    }
+
+    KFileDialog dlg( QString::null, QString::null, this, "filedialog", true, convert );
+    dlg.setOperationMode( KFileDialog::Saving );
+    dlg.setCaption( i18n("Save As") );
+    dlg.exec();
+
+    QString fileName = dlg.selectedFile();
+    if ( fileName.isEmpty() )
+        return;
+
+    // convert rich text to plain text first
+    if ( convert && convert->isChecked() )
+        msg_body = toPlainText( msg_body );
+
+    QFile file( fileName );
+    if ( file.open( IO_WriteOnly ) )
+    {
+        QTextStream stream( &file );
+        stream << msg_body;
+    }
+*/
+}
+
 void KNote::slotPopupActionToDesktop( int id )
 {
-    if( id > 1 )
-      --id;      // compensate for the menu separator
-    toDesktop( id );
+    toDesktop( id - 1 ); // compensate for the menu separator, -1 == all desktops
 }
 
 
@@ -661,6 +736,26 @@
 
 // -------------------- private methods -------------------- //
 
+QString KNote::toPlainText( const QString& text )
+{
+    QTextEdit conv;
+    conv.setTextFormat( RichText );
+    conv.setText( text );
+    conv.setTextFormat( PlainText );
+    return conv.text();
+}
+
+void KNote::toDesktop( int desktop )
+{
+    if ( desktop == 0 )
+        return;
+
+    if ( desktop == NETWinInfo::OnAllDesktops )
+        KWin::setOnAllDesktops( winId(), true );
+    else
+        KWin::setOnDesktop( winId(), desktop );
+}
+
 void KNote::setColor( const QColor &fg, const QColor &bg )
 {
     QPalette newpalette = palette();
@@ -741,13 +836,13 @@
     // So we have to write our own layout manager...
 
     const int headerHeight = m_label->sizeHint().height();
-    const int toolHeight = m_tool->isHidden() ? 0 : 16;
     const int margin = m_editor->margin();
     static const int border = 2;
     bool closeLeft = false;
 
-//    if ( KDecoration::options()->customButtonPositions() )
-//       closeLeft = KDecoration::options()->titleButtonsLeft().find( 'X' ) > -1;
+    m_kwinConf->setGroup( "Style" );
+    if ( m_kwinConf->readBoolEntry( "CustomButtonPositions" ) )
+        closeLeft = m_kwinConf->readEntry( "ButtonsOnLeft" ).find( 'X' ) > -1;
 
     m_button->setGeometry(
         closeLeft ? frameRect().x() + border
@@ -758,44 +853,26 @@
     );
 
     m_label->setGeometry(
-        frameRect().x() + border + (closeLeft && !m_button->isHidden() ? headerHeight : 0),
-        frameRect().y() + border,
-        frameRect().width() - (m_button->isHidden() ? 0 : headerHeight) - border*2,
-        headerHeight
+        frameRect().x() + border, frameRect().y() + border,
+        frameRect().width() - border*2, headerHeight
     );
 
     m_editor->setGeometry(
         contentsRect().x(),
         contentsRect().y() + headerHeight + border,
         contentsRect().width(),
-        contentsRect().height() - headerHeight - toolHeight - border*2
+        contentsRect().height() - headerHeight -
+                (m_tool->isHidden() ? 0 : m_tool->height()) - border*2
     );
 
     m_tool->setGeometry(
-        contentsRect().x(),
-        contentsRect().height() - 16,
-        contentsRect().width(),
-        16
+        contentsRect().x(), contentsRect().height() - m_tool->height(),
+        contentsRect().width(), m_tool->height()
     );
-    m_tool->setIconSize( 10 );
-
-    // if there was just a way of making KComboBox adhere the toolbar height...
-    QObjectList *list = m_tool->queryList( "KComboBox" );
-    QObjectListIt it( *list );
-    while ( it.current() != 0 && toolHeight )
-    {
-        KComboBox *combo = (KComboBox *)it.current();
-        QFont font = combo->font();
-        font.setPointSize( 7 );
-        combo->setFont( font );
-        combo->setFixedHeight( m_tool->height() - 2 );
-        ++it;
-    }
-    delete list;
 
     setMinimumSize(
         m_editor->cornerWidget()->width() + margin*2 + border*2,
-        headerHeight + toolHeight +
+        headerHeight + (m_tool->isHidden() ? 0 : m_tool->height()) +
                 m_editor->cornerWidget()->height() + margin*2 + border*2
     );
 
@@ -806,9 +883,14 @@
 
 void KNote::showEvent( QShowEvent * )
 {
-    // KWin does not preserve these properties for hidden windows
-    slotUpdateKeepAboveBelow();
-    slotUpdateShowInTaskbar();
+    if ( m_config->hideNote() )
+    {
+        // KWin does not preserve these properties for hidden windows
+        slotUpdateKeepAboveBelow();
+        slotUpdateShowInTaskbar();
+        toDesktop( m_config->desktop() );
+        m_config->setHideNote( false );
+    }
 }
 
 void KNote::resizeEvent( QResizeEvent *qre )
@@ -822,14 +904,6 @@
     slotClose();
 }
 
-void KNote::keyPressEvent( QKeyEvent *e )
-{
-    if ( e->key() == Key_Escape )
-        slotClose();
-    else
-        e->ignore();
-}
-
 void KNote::dragEnterEvent( QDragEnterEvent *e )
 {
     e->accept( KColorDrag::canDecode( e ) );
@@ -841,6 +915,7 @@
     if ( KColorDrag::decode( e, bg ) )
     {
         setColor( paletteForegroundColor(), bg );
+        m_journal->setCustomProperty( "KNotes", "BgColor", bg.name() );
         m_config->setBgColor( bg );
     }
 }
@@ -884,40 +959,15 @@
         if ( ev->type() == QEvent::MouseButtonDblClick )
             slotRename();
 
-        if ( ev->type() == QEvent::MouseButtonRelease &&
-             (e->button() == LeftButton || e->button() == MidButton) )
-        {
-            m_dragging = false;
-            m_label->releaseMouse();
-            return true;
-        }
-
         if ( ev->type() == QEvent::MouseButtonPress &&
              (e->button() == LeftButton || e->button() == MidButton))
         {
-            m_pointerOffset = e->pos();
-            m_label->grabMouse( sizeAllCursor );
-
             e->button() == LeftButton ? KWin::raiseWindow( winId() )
                                       : KWin::lowerWindow( winId() );
 
-            return true;
-        }
-
-        if ( ev->type() == QEvent::MouseMove && m_label == mouseGrabber() )
-        {
-            if ( m_dragging )
-                move( QCursor::pos() - m_pointerOffset );
-            else
-            {
-                m_dragging = (
-                    (e->pos().x() - m_pointerOffset.x()) *
-                    (e->pos().x() - m_pointerOffset.x())
-                    +
-                    (e->pos().y() - m_pointerOffset.y()) *
-                    (e->pos().y() - m_pointerOffset.y())   >= 9
-                );
-            }
+            XUngrabPointer( qt_xdisplay(), qt_x_time );
+            NETRootInfo wm_root( qt_xdisplay(), NET::WMMoveResize );
+            wm_root.moveResizeRequest( winId(), e->globalX(), e->globalY(), NET::Move );
             return true;
         }
 
@@ -964,5 +1014,6 @@
     return false;
 }
 
+
 #include "knote.moc"
 #include "knotebutton.moc"
diff -urN -x CVS kdepim.orig/knotes/knote.h kdepim/knotes/knote.h
--- kdepim.orig/knotes/knote.h	Wed Apr 21 01:04:20 2004
+++ kdepim/knotes/knote.h	Mon Oct  4 22:51:49 2004
@@ -27,6 +27,7 @@
 #include <qpoint.h>
 #include <qcolor.h>
 
+#include <kconfig.h>
 #include <kxmlguiclient.h>
 
 class QLabel;
@@ -50,8 +51,8 @@
 {
     Q_OBJECT
 public:
-    KNote( KXMLGUIBuilder *builder, QDomDocument buildDoc, KCal::Journal *journal,
-           QWidget *parent=0, const char *name=0 );
+    KNote( QDomDocument buildDoc, KCal::Journal *journal, QWidget *parent = 0,
+           const char *name = 0 );
     ~KNote();
 
     void saveData();
@@ -67,13 +68,13 @@
     void sync( const QString& app );
     bool isNew( const QString& app ) const;
     bool isModified( const QString& app ) const;
-    void toDesktop( int desktop );
 
 public slots:
     void slotKill( bool force = false );
 
 signals:
     void sigRequestNewNote();
+    void sigShowNextNote();
     void sigNameChanged();
     void sigDataChanged();
     void sigColorChanged();
@@ -83,7 +84,6 @@
     virtual void showEvent( QShowEvent* );
     virtual void resizeEvent( QResizeEvent* );
     virtual void closeEvent( QCloseEvent* );
-    virtual void keyPressEvent( QKeyEvent* );
     virtual void dropEvent( QDropEvent* );
     virtual void dragEnterEvent( QDragEnterEvent* );
 
@@ -98,6 +98,7 @@
     void slotSend();
     void slotMail();
     void slotPrint();
+    void slotSaveAs();
     void slotInsDate();
     void slotPreferences();
     void slotPopupActionToDesktop( int id );
@@ -113,10 +114,11 @@
     void updateLabelAlignment();
     void setColor( const QColor&, const QColor& );
 
-private:
-    QPoint m_pointerOffset;
-    bool   m_dragging;
+    void toDesktop( int desktop );
 
+    QString toPlainText( const QString& );
+
+private:
     QLabel        *m_label;
     KNoteButton   *m_button;
     KToolBar      *m_tool;
@@ -131,6 +133,8 @@
     KListAction   *m_toDesktop;
     KToggleAction *m_keepAbove;
     KToggleAction *m_keepBelow;
+
+    KSharedConfig::Ptr m_kwinConf;
 };
 
 #endif
diff -urN -x CVS kdepim.orig/knotes/knoteconfig.kcfg kdepim/knotes/knoteconfig.kcfg
--- kdepim.orig/knotes/knoteconfig.kcfg	Mon Apr 19 21:37:43 2004
+++ kdepim/knotes/knoteconfig.kcfg	Mon Oct  4 22:51:49 2004
@@ -55,6 +55,10 @@
       <default>-10</default>
     </entry>
 
+    <entry name="HideNote" type="Bool">
+      <default>false</default>
+    </entry>
+
     <entry name="Position" type="Point" key="position">
       <default code="true">QPoint( -10000, -10000 )</default>
     </entry>
diff -urN -x CVS kdepim.orig/knotes/knoteconfig_addons.h kdepim/knotes/knoteconfig_addons.h
--- kdepim.orig/knotes/knoteconfig_addons.h	Tue Apr 20 23:10:39 2004
+++ kdepim/knotes/knoteconfig_addons.h	Mon Oct  4 22:51:49 2004
@@ -45,6 +45,9 @@
   KConfigSkeleton::ItemInt  *itemDesktop;
   itemDesktop = new KConfigSkeleton::ItemInt( currentGroup(), QString::fromLatin1( "desktop" ), mDesktop, -10 );
   addItem( itemDesktop, QString::fromLatin1( "Desktop" ) );
+  KConfigSkeleton::ItemBool  *itemHideNote;
+  itemHideNote = new KConfigSkeleton::ItemBool( currentGroup(), QString::fromLatin1( "HideNote" ), mHideNote, false );
+  addItem( itemHideNote, QString::fromLatin1( "HideNote" ) );
   KConfigSkeleton::ItemPoint  *itemPosition;
   itemPosition = new KConfigSkeleton::ItemPoint( currentGroup(), QString::fromLatin1( "position" ), mPosition, QPoint( -10000, -10000 ) );
   addItem( itemPosition, QString::fromLatin1( "Position" ) );
diff -urN -x CVS kdepim.orig/knotes/knoteconfigdlg.cpp kdepim/knotes/knoteconfigdlg.cpp
--- kdepim.orig/knotes/knoteconfigdlg.cpp	Tue Apr 27 22:38:57 2004
+++ kdepim/knotes/knoteconfigdlg.cpp	Mon Oct  4 22:51:49 2004
@@ -113,14 +113,14 @@
 
         KIntNumInput *kcfg_Width = new KIntNumInput( displayPage, "kcfg_Width" );
         label_Width->setBuddy( kcfg_Width );
-        kcfg_Width->setRange( 100, 2000, 10, false );
+        kcfg_Width->setRange( 50, 2000, 10, false );
         layout->addWidget( kcfg_Width, 2, 1 );
 
         QLabel *label_Height = new QLabel( i18n("Default &height:"), displayPage, "label_Height" );
         layout->addWidget( label_Height, 3, 0 );
 
         KIntNumInput *kcfg_Height = new KIntNumInput( displayPage, "kcfg_Height" );
-        kcfg_Height->setRange( 100, 2000, 10, false );
+        kcfg_Height->setRange( 50, 2000, 10, false );
         label_Height->setBuddy( kcfg_Height );
         layout->addWidget( kcfg_Height, 3, 1 );
 
@@ -221,5 +221,4 @@
     return networkPage;
 }
 
-
 #include "knoteconfigdlg.moc"
diff -urN -x CVS kdepim.orig/knotes/knoteedit.cpp kdepim/knotes/knoteedit.cpp
--- kdepim.orig/knotes/knoteedit.cpp	Tue Aug 31 17:11:22 2004
+++ kdepim/knotes/knoteedit.cpp	Mon Oct  4 22:51:49 2004
@@ -29,7 +29,6 @@
 #include <kcolordialog.h>
 
 #include "knoteedit.h"
-#include "knotebutton.h"
 
 static const short SEP = 5;
 static const short ICON_SIZE = 10;
@@ -202,7 +201,7 @@
     {
         QString t = text();
         KTextEdit::setTextFormat( f );
-        
+
         // if the note contains html/xml source try to display it, otherwise
         // get the modified text again and set it to preserve newlines
         if ( QStyleSheet::mightBeRichText( t ) )
diff -urN -x CVS kdepim.orig/knotes/knotesapp.cpp kdepim/knotes/knotesapp.cpp
--- kdepim.orig/knotes/knotesapp.cpp	Wed Jul 14 21:13:46 2004
+++ kdepim/knotes/knotesapp.cpp	Mon Oct  4 22:51:49 2004
@@ -25,6 +25,7 @@
 #include <kdebug.h>
 #include <kaction.h>
 #include <kxmlguifactory.h>
+#include <kxmlguibuilder.h>
 #include <ksystemtray.h>
 #include <klocale.h>
 #include <kiconeffect.h>
@@ -38,10 +39,10 @@
 #include <kextsock.h>
 
 #include <libkcal/journal.h>
+#include <libkcal/calendarlocal.h>
 
 #include "knotesapp.h"
 #include "knote.h"
-#include "knoteconfig.h"
 #include "knoteconfigdlg.h"
 #include "knotesglobalconfig.h"
 #include "knoteslegacy.h"
@@ -50,6 +51,35 @@
 #include "knotes/resourcemanager.h"
 
 
+class KNotesKeyDialog : public KDialogBase
+{
+public:
+    KNotesKeyDialog( KGlobalAccel *globals, QWidget *parent, const char* name = 0 )
+        : KDialogBase( parent, name, true, QString::null, Default|Ok|Cancel, Ok )
+//        : KDialogBase( parent, name, true, i18n("Configure Shortcuts"), Default|Ok|Cancel, Ok )
+    {
+        m_keyChooser = new KKeyChooser( globals, this );
+        setMainWidget( m_keyChooser );
+        connect( this, SIGNAL(defaultClicked()), m_keyChooser, SLOT(allDefault()) );
+    }
+
+    void insert( KActionCollection *actions )
+    {
+        //m_keyChooser->insert( actions, i18n("Note Actions") );
+        m_keyChooser->insert( actions );
+    }
+
+    void configure()
+    {
+        if ( exec() == Accepted )
+            m_keyChooser->save();
+    }
+
+private:
+    KKeyChooser *m_keyChooser;
+};
+
+
 int KNotesApp::KNoteActionList::compareItems( QPtrCollection::Item s1, QPtrCollection::Item s2 )
 {
     if ( ((KAction*)s1)->text() == ((KAction*)s2)->text() )
@@ -60,7 +90,6 @@
 
 KNotesApp::KNotesApp()
     : DCOPObject("KNotesIface"), QLabel( 0, 0, WType_TopLevel ),
-      KXMLGUIBuilder( this ),
       m_listener( 0 )
 {
     connect( kapp, SIGNAL(lastWindowClosed()), kapp, SLOT(quit()) );
@@ -79,20 +108,29 @@
         this, SLOT(newNote()), actionCollection(), "new_note" );
     new KAction( i18n("New Note From Clipboard"), "editpaste", 0,
         this, SLOT(newNoteFromClipboard()), actionCollection(), "new_note_clipboard" );
+//    new KAction( i18n("Show All Notes"), "knotes", 0,
+//        this, SLOT(showAllNotes()), actionCollection(), "show_all_notes" );
+//    new KAction( i18n("Hide All Notes"), "fileclose", 0,
+//        this, SLOT(hideAllNotes()), actionCollection(), "hide_all_notes" );
     new KHelpMenu( this, kapp->aboutData(), false, actionCollection() );
 
     KStdAction::preferences( this, SLOT(slotPreferences()), actionCollection() );
     KStdAction::keyBindings( this, SLOT(slotConfigureAccels()), actionCollection() );
     KStdAction::quit( this, SLOT(slotQuit()), actionCollection() )->setShortcut( 0 );
 
-    setXMLFile( QString( instance()->instanceName() + "ui.rc" ) );
+    setXMLFile( instance()->instanceName() + "appui.rc" );
 
-    m_guiFactory = new KXMLGUIFactory( this, this, "guifactory" );
+    m_guiBuilder = new KXMLGUIBuilder( this );
+    m_guiFactory = new KXMLGUIFactory( m_guiBuilder, this );
     m_guiFactory->addClient( this );
 
     m_context_menu = static_cast<KPopupMenu*>(m_guiFactory->container( "knotes_context", this ));
     m_note_menu = static_cast<KPopupMenu*>(m_guiFactory->container( "notes_menu", this ));
 
+    m_noteGUI.setContent(
+        KXMLGUIFactory::readConfigFile( instance()->instanceName() + "ui.rc", instance() )
+    );
+
     // create accels for global shortcuts
     m_globalAccel = new KGlobalAccel( this, "global accel" );
     m_globalAccel->insert( "global_new_note", i18n("New Note"), "",
@@ -101,6 +139,12 @@
     m_globalAccel->insert( "global_new_note_clipboard", i18n("New Note From Clipboard"), "",
                            ALT+SHIFT+Key_C, ALT+SHIFT+Key_C,
                            this, SLOT(newNoteFromClipboard()), true, true );
+//    m_globalAccel->insert( "global_hide_all_notes", i18n("Hide All Notes"), "",
+//                           ALT+SHIFT+Key_H, ALT+SHIFT+Key_H ,
+//                           this, SLOT(hideAllNotes()), true, true );
+//    m_globalAccel->insert( "global_show_all_notes", i18n("Show All Notes"), "",
+//                           ALT+SHIFT+Key_S, ALT+SHIFT+Key_S,
+//                           this, SLOT(showAllNotes()), true, true );
 
     m_globalAccel->readSettings();
 
@@ -123,7 +167,17 @@
     // read the notes
     m_manager->load();
 
-    kapp->installEventFilter( this );
+    // read the old config files, convert and add them
+    KCal::CalendarLocal calendar;
+    if ( KNotesLegacy::convert( &calendar ) )
+    {
+        KCal::Journal::List notes = calendar.journals();
+        KCal::Journal::List::ConstIterator it;
+        for ( it = notes.begin(); it != notes.end(); ++it )
+            m_manager->addNewNote( *it );
+
+        m_manager->save();
+    }
 
     // create the socket and possibly start listening for connections
     m_listener = new KExtendedSocket();
@@ -133,6 +187,8 @@
 
     if ( m_noteList.count() == 0 && !kapp->isRestored() )
         newNote();
+
+    updateNoteActions();  // in case there is no note yet
 }
 
 KNotesApp::~KNotesApp()
@@ -145,6 +201,7 @@
 
     delete m_listener;
     delete m_manager;
+    delete m_guiBuilder;
 }
 
 bool KNotesApp::commitData( QSessionManager& )
@@ -182,6 +239,23 @@
     return newNote( name, text );
 }
 
+void KNotesApp::hideAllNotes() const
+{
+    QDictIterator<KNote> it( m_noteList );
+    for ( ; *it; ++it )
+        (*it)->close();
+}
+
+void KNotesApp::showAllNotes() const
+{
+    QDictIterator<KNote> it( m_noteList );
+    for ( ; *it; ++it )
+    {
+        (*it)->show();
+        (*it)->setFocus();
+    }
+}
+
 void KNotesApp::showNote( const QString& id ) const
 {
     KNote* note = m_noteList[id];
@@ -316,38 +390,6 @@
     }
 }
 
-bool KNotesApp::eventFilter( QObject* o, QEvent* ev )
-{
-    if ( ev->type() == QEvent::KeyPress )
-    {
-        QKeyEvent* ke = (QKeyEvent*)ev;
-
-        if ( ke->key() == Key_BackTab )         // Shift+Tab
-        {
-            // show next note
-            QDictIterator<KNote> it( m_noteList );
-            KNote *first = it.toFirst();
-            for ( ; it.current(); ++it )
-                if ( it.current()->hasFocus() )
-                {
-                    if ( ++it )
-                        showNote( it.current() );
-                    else
-                        showNote( first );
-                    break;
-                }
-
-            ke->accept();
-            return true;
-        }
-        else
-            ke->ignore();
-    }
-
-    return QLabel::eventFilter( o, ev );
-}
-
-
 // -------------------- protected slots -------------------- //
 
 void KNotesApp::slotShowNote()
@@ -356,6 +398,22 @@
     showNote( QString::fromUtf8( sender()->name() ) );
 }
 
+void KNotesApp::slotWalkThroughNotes()
+{
+    // show next note
+    QDictIterator<KNote> it( m_noteList );
+    KNote *first = it.toFirst();
+    for ( ; *it; ++it )
+        if ( (*it)->hasFocus() )
+        {
+            if ( ++it )
+                showNote( *it );
+            else
+                showNote( first );
+            break;
+        }
+}
+
 void KNotesApp::slotPreferences()
 {
     // reuse the dialog if possible
@@ -371,25 +429,39 @@
 
 void KNotesApp::slotConfigureAccels()
 {
-    KKeyDialog keys( false, this );
-    keys.insert( actionCollection() );
+    KNotesKeyDialog keys( m_globalAccel, this );
     QDictIterator<KNote> notes( m_noteList );
     if ( !m_noteList.isEmpty() )
-        keys.insert( notes.current()->actionCollection() );
+        keys.insert( (*notes)->actionCollection() );
     keys.configure();
 
-    notes.toFirst();
-    for( ; notes.current(); ++notes )
-        notes.current()->reloadXML();
-
     m_globalAccel->writeSettings();
     updateGlobalAccels();
+
+    // update GUI doc for new notes
+    m_noteGUI.setContent(
+        KXMLGUIFactory::readConfigFile( instance()->instanceName() + "ui.rc", instance() )
+    );
+
+    if ( m_noteList.isEmpty() )
+        return;
+
+    notes.toFirst();
+    QValueList<KAction *> list = (*notes)->actionCollection()->actions();
+    for ( QValueList<KAction *>::iterator it = list.begin(); it != list.end(); ++it )
+    {
+        notes.toFirst();
+        for ( ++notes; *notes; ++notes )
+        {
+            KAction *toChange = (*notes)->actionCollection()->action( (*it)->name() );
+            if ( toChange->shortcut() != (*it)->shortcut() )
+                toChange->setShortcut( (*it)->shortcut() );
+        }
+    }
 }
 
 void KNotesApp::slotNoteKilled( KCal::Journal *journal )
 {
-    // this kills the KNote object
-    m_noteList.remove( journal->uid() );
     m_manager->deleteNote( journal );
 
     saveNotes();
@@ -407,31 +479,19 @@
 
 void KNotesApp::showNote( KNote* note ) const
 {
-    if ( !note->isHidden() )
-    {
-        // if it's already showing, we need to change to its desktop
-        // and give it focus
-        KWin::setCurrentDesktop( KWin::windowInfo( note->winId() ).desktop() );
-        KWin::forceActiveWindow( note->winId() );
-        note->setFocus();
-    }
-    else
-    {
-        // if not, show note on the current desktop
-        note->show();
-        note->toDesktop( KWin::currentDesktop() );
-        KWin::forceActiveWindow( note->winId() );
-        note->setFocus();
-    }
+    note->show();
+    KWin::setCurrentDesktop( KWin::windowInfo( note->winId() ).desktop() );
+    KWin::forceActiveWindow( note->winId() );
+    note->setFocus();
 }
 
 void KNotesApp::createNote( KCal::Journal *journal )
 {
-    KNote *newNote = new KNote( this, domDocument(), journal,
-                                0, journal->uid().utf8() );
+    KNote *newNote = new KNote( m_noteGUI, journal, 0, journal->uid().utf8() );
     m_noteList.insert( newNote->noteId(), newNote );
 
     connect( newNote, SIGNAL(sigRequestNewNote()), SLOT(newNote()) );
+    connect( newNote, SIGNAL(sigShowNextNote()), SLOT(slotWalkThroughNotes()) );
     connect( newNote, SIGNAL(sigKillNote( KCal::Journal* )),
                         SLOT(slotNoteKilled( KCal::Journal* )) );
     connect( newNote, SIGNAL(sigNameChanged()), SLOT(updateNoteActions()) );
@@ -509,6 +569,12 @@
         action = actionCollection()->action( "new_note_clipboard" );
         if ( action )
             action->setShortcut( m_globalAccel->shortcut( "global_new_note_clipboard" ) );
+        action = actionCollection()->action( "hide_all_notes" );
+        if ( action )
+            action->setShortcut( m_globalAccel->shortcut( "global_hide_all_notes" ) );
+        action = actionCollection()->action( "show_all_notes" );
+        if ( action )
+            action->setShortcut( m_globalAccel->shortcut( "global_show_all_notes" ) );
 
         m_globalAccel->updateConnections();
     }
@@ -520,6 +586,12 @@
         action = actionCollection()->action( "new_note_clipboard" );
         if ( action )
             action->setShortcut( 0 );
+        action = actionCollection()->action( "hide_all_notes" );
+        if ( action )
+            action->setShortcut( 0 );
+        action = actionCollection()->action( "show_all_notes" );
+        if ( action )
+            action->setShortcut( 0 );
     }
 }
 
diff -urN -x CVS kdepim.orig/knotes/knotesapp.h kdepim/knotes/knotesapp.h
--- kdepim.orig/knotes/knotesapp.h	Mon Jul  5 21:46:53 2004
+++ kdepim/knotes/knotesapp.h	Mon Oct  4 22:51:49 2004
@@ -25,12 +25,12 @@
 #include <qdict.h>
 #include <qptrlist.h>
 #include <qlabel.h>
+#include <qdom.h>
 
 #include <kapplication.h>
 #include <kxmlguiclient.h>
-#include <kxmlguibuilder.h>
 
-#include "KNotesIface.h"
+#include "KNotesAppIface.h"
 
 class KNote;
 class KPopupMenu;
@@ -38,6 +38,7 @@
 class KActionMenu;
 class KGlobalAccel;
 class KXMLGUIFactory;
+class KXMLGUIBuilder;
 class KExtendedSocket;
 class KNotesResourceManager;
 
@@ -46,8 +47,8 @@
 }
 
 
-class KNotesApp : public QLabel, virtual public KNotesIface, public KSessionManaged,
-    public KXMLGUIBuilder, virtual public KXMLGUIClient
+class KNotesApp : public QLabel, public KSessionManaged, virtual public KXMLGUIClient,
+    virtual public KNotesAppIface
 {
     Q_OBJECT
 public:
@@ -79,12 +80,15 @@
                      const QString& text = QString::null );
     QString newNoteFromClipboard( const QString& name = QString::null );
 
+    void hideAllNotes() const;
+    void showAllNotes() const;
+
 protected:
     void mousePressEvent( QMouseEvent* );
-    bool eventFilter( QObject*, QEvent* );
 
 protected slots:
     void slotShowNote();
+    void slotWalkThroughNotes();
 
     void slotPreferences();
     void slotConfigureAccels();
@@ -126,6 +130,9 @@
 
     KGlobalAccel    *m_globalAccel;
     KXMLGUIFactory  *m_guiFactory;
+    KXMLGUIBuilder  *m_guiBuilder;
+
+    QDomDocument    m_noteGUI;
 };
 
 #endif
diff -urN -x CVS kdepim.orig/knotes/knotesappui.rc kdepim/knotes/knotesappui.rc
--- kdepim.orig/knotes/knotesappui.rc	Thu Jan  1 01:00:00 1970
+++ kdepim/knotes/knotesappui.rc	Mon Oct  4 22:51:49 2004
@@ -0,0 +1,33 @@
+<!DOCTYPE kpartgui SYSTEM "kpartgui.dtd">
+
+<kpartgui name="KNotes" version="2">
+
+<Menu name="knotes_context" noMerge="1"><text>KNotes</text>
+    <title icon="knotes">KNotes</title>
+    <Action name="new_note"/>
+    <Action name="new_note_clipboard"/>
+    <Separator/>
+    <Action name="show_all_notes"/>
+    <Action name="hide_all_notes"/>
+    <Separator/>
+    <Action name="options_configure_keybinding"/>
+    <Action name="options_configure"/>
+    <Separator/>
+    <Menu name="help" icon="help" noMerge="1"><text>&amp;Help</text>
+        <Action name="help_contents"/>
+        <Separator/>
+        <Action name="help_report_bug"/>
+        <Separator/>
+        <Action name="help_about_app"/>
+        <Action name="help_about_kde"/>
+    </Menu>
+    <Separator/>
+    <Action name="file_quit"/>
+</Menu>
+
+<Menu name="notes_menu" noMerge="1"><text>Notes</text>
+    <title>Notes</title>
+    <ActionList name="notes"/>
+</Menu>
+
+</kpartgui>
diff -urN -x CVS kdepim.orig/knotes/knotesnetsend.cpp kdepim/knotes/knotesnetsend.cpp
--- kdepim.orig/knotes/knotesnetsend.cpp	Tue Apr 27 22:38:57 2004
+++ kdepim/knotes/knotesnetsend.cpp	Mon Oct  4 22:51:49 2004
@@ -2,6 +2,7 @@
  KNotes -- Notes for the KDE project
 
  Copyright (c) 2003, Daniel Martin <daniel.martin@pirack.com>
+               2004, Michael Brade <brade@kde.org>
 
  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
@@ -34,21 +35,13 @@
 #include <ksockaddr.h>
 
 #include "knotesnetsend.h"
-#include "knotesglobalconfig.h"
 
 // This comes in seconds!
 #define CONNECT_TIMEOUT 10
 
 
-KNotesNetworkSender::KNotesNetworkSender( const QString& hostname,
-                const QString& title, const QString& text )
-  : KExtendedSocket( hostname, KNotesGlobalConfig::port() ),
-    // TODO: support for unicode and richtext.
-    // Mmmmmm... how to behave with such heterogeneous environment?
-    // AFAIK, ATnotes does not allow UNICODE.
-    m_note( text.ascii() ),
-    m_title( title.ascii() ),
-    m_index( 0 )
+KNotesNetworkSender::KNotesNetworkSender( const QString& hostname, int port )
+  : KExtendedSocket( hostname, port )
 {
     enableRead( false );
     enableWrite( false );
@@ -59,18 +52,28 @@
     QObject::connect( this, SIGNAL(connectionFailed( int )), SLOT(slotError( int )) );
     QObject::connect( this, SIGNAL(closed( int )), SLOT(slotClosed( int )) );
     QObject::connect( this, SIGNAL(readyWrite()), SLOT(slotReadyWrite()) );
+}
 
-    // The error signal will take care of errors
-    connect();
+void KNotesNetworkSender::setSenderId( const QString& sender )
+{
+    m_sender = sender.ascii();
+}
+
+void KNotesNetworkSender::setNote( const QString& title, const QString& text )
+{
+    // TODO: support for unicode and richtext.
+    // Mmmmmm... how to behave with such heterogeneous environment?
+    // AFAIK, ATnotes does not allow UNICODE.
+    m_title = title.ascii();
+    m_note = text.ascii();
 }
 
 void KNotesNetworkSender::slotConnected()
 {
-    const QString& sender = KNotesGlobalConfig::senderID();
-    if ( sender.isEmpty() )
+    if ( m_sender.isEmpty() )
         m_note.prepend( m_title + "\n");
     else
-        m_note.prepend( m_title + " (" + sender.ascii() + ")\n" );
+        m_note.prepend( m_title + " (" + m_sender + ")\n" );
 
     enableWrite( true );
 }
diff -urN -x CVS kdepim.orig/knotes/knotesnetsend.h kdepim/knotes/knotesnetsend.h
--- kdepim.orig/knotes/knotesnetsend.h	Tue Apr 27 22:38:57 2004
+++ kdepim/knotes/knotesnetsend.h	Mon Oct  4 22:51:49 2004
@@ -2,6 +2,7 @@
  KNotes -- Notes for the KDE project
 
  Copyright (c) 2003, Daniel Martin <daniel.martin@pirack.com>
+               2004, Michael Brade <brade@kde.org>
 
  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
@@ -41,7 +42,10 @@
 {
     Q_OBJECT
 public:
-    KNotesNetworkSender( const QString &, const QString &, const QString & );
+    KNotesNetworkSender( const QString &host, int port );
+
+    void setSenderId( const QString& sender );
+    void setNote( const QString &title, const QString &text );
 
 protected slots:
     void slotConnected();
@@ -53,6 +57,7 @@
 private:
     QCString m_note;
     QCString m_title;
+    QCString m_sender;
     uint m_index;
 };
 
diff -urN -x CVS kdepim.orig/knotes/knotesui.rc kdepim/knotes/knotesui.rc
--- kdepim.orig/knotes/knotesui.rc	Wed Apr 14 21:48:52 2004
+++ kdepim/knotes/knotesui.rc	Mon Oct  4 22:51:49 2004
@@ -1,31 +1,6 @@
 <!DOCTYPE kpartgui SYSTEM "kpartgui.dtd">
 
-<kpartgui name="KNotes" version="4">
-
-<Menu name="knotes_context" noMerge="1"><text>KNotes</text>
-    <title icon="knotes">KNotes</title>
-    <Action name="new_note"/>
-    <Action name="new_note_clipboard"/>
-    <Separator/>
-    <Action name="options_configure_keybinding"/>
-    <Action name="options_configure"/>
-    <Separator/>
-    <Menu name="help" icon="help" noMerge="1"><text>&amp;Help</text>
-        <Action name="help_contents"/>
-        <Separator/>
-        <Action name="help_report_bug"/>
-        <Separator/>
-        <Action name="help_about_app"/>
-        <Action name="help_about_kde"/>
-    </Menu>
-    <Separator/>
-    <Action name="file_quit"/>
-</Menu>
-
-<Menu name="notes_menu" noMerge="1"><text>Notes</text>
-    <title>Notes</title>
-    <ActionList name="notes"/>
-</Menu>
+<kpartgui name="KNotes" version="6">
 
 <Menu name="note_context" noMerge="1">
     <Action name="insert_date"/>
diff -urN -x CVS kdepim.orig/knotes/local.desktop kdepim/knotes/local.desktop
--- kdepim.orig/knotes/local.desktop	Sun Oct  3 15:38:08 2004
+++ kdepim/knotes/local.desktop	Mon Oct  4 15:26:21 2004
@@ -27,7 +27,7 @@
 Name[sk]=Poznámky v lokálnom súbore
 Name[sl]=Notice v krajevni datoteki
 Name[sr]=Забелешке у локалном фајлу
-Name[sr@Latn]=Забелешке у локалном фајлу
+Name[sr@Latn]=Zabeleške u lokalnom fajlu
 Name[sv]=Anteckningar i lokal fil
 Name[ta]=உள் கோப்பில் உள்ள குறிப்புகள்
 Name[tg]=Хабарҳо дар файли локалӣ
diff -urN -x CVS kdepim.orig/knotes/resourcelocal.cpp kdepim/knotes/resourcelocal.cpp
--- kdepim.orig/knotes/resourcelocal.cpp	Mon Sep 27 13:49:19 2004
+++ kdepim/knotes/resourcelocal.cpp	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
                2004, Michael Brade <brade@kde.org>
 
  This program is free software; you can redistribute it and/or modify
@@ -37,8 +37,6 @@
 
 #include <libkcal/icalformat.h>
 
-#include "knoteslegacy.h"
-
 #include "knotes/resourcelocal.h"
 #include "knotes/resourcemanager.h"
 
@@ -59,15 +57,6 @@
 {
     mCalendar.load( KGlobal::dirs()->saveLocation( "data" ) + "knotes/notes.ics" );
 
-    // TODO
-    // initialize the Calendar
-    //mCalendar.setOwner(..);
-    //mCalendar.setEmail(..);
-
-    // read the old config files into mCalendar and convert them
-    if ( KNotesLegacy::convert( &mCalendar ) )
-        save();
-
     KCal::Journal::List notes = mCalendar.journals();
     KCal::Journal::List::ConstIterator it;
     for ( it = notes.begin(); it != notes.end(); ++it )
@@ -78,7 +67,7 @@
 
 bool ResourceLocal::save()
 {
-    QString file = KGlobal::dirs()->saveLocation( "data", "knotes" ) + "notes.ics";
+    QString file = KGlobal::dirs()->saveLocation( "data", "knotes/" ) + "notes.ics";
 
     if ( !mCalendar.save( file, new KCal::ICalFormat() ) )
     {
diff -urN -x CVS kdepim.orig/knotes/resourcelocal.h kdepim/knotes/resourcelocal.h
--- kdepim.orig/knotes/resourcelocal.h	Thu Mar 11 15:26:11 2004
+++ kdepim/knotes/resourcelocal.h	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
 
  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/knotes/resourcelocal_plugin.cpp kdepim/knotes/resourcelocal_plugin.cpp
--- kdepim.orig/knotes/resourcelocal_plugin.cpp	Tue Mar  9 17:46:44 2004
+++ kdepim/knotes/resourcelocal_plugin.cpp	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
 
  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/knotes/resourcemanager.cpp kdepim/knotes/resourcemanager.cpp
--- kdepim.orig/knotes/resourcemanager.cpp	Mon Jul  5 21:58:50 2004
+++ kdepim/knotes/resourcemanager.cpp	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
                2004, Michael Brade <brade@kde.org>
 
  This program is free software; you can redistribute it and/or modify
@@ -108,6 +108,9 @@
     // Remove the journal from the resource it came from
     m_resourceMap[ uid ]->deleteNote( journal );
     m_resourceMap.remove( uid );
+
+    // libkcal does not delete the journal immediately, therefore it is ok to
+    // emit the journal here
     emit sigDeregisteredNote( journal );
 }
 
diff -urN -x CVS kdepim.orig/knotes/resourcemanager.h kdepim/knotes/resourcemanager.h
--- kdepim.orig/knotes/resourcemanager.h	Tue Jul 20 13:55:21 2004
+++ kdepim/knotes/resourcemanager.h	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
                2004, Michael Brade <brade@kde.org>
 
  This program is free software; you can redistribute it and/or modify
diff -urN -x CVS kdepim.orig/knotes/resourcenotes.cpp kdepim/knotes/resourcenotes.cpp
--- kdepim.orig/knotes/resourcenotes.cpp	Fri Apr 23 23:16:10 2004
+++ kdepim/knotes/resourcenotes.cpp	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
 
  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/knotes/resourcenotes.h kdepim/knotes/resourcenotes.h
--- kdepim.orig/knotes/resourcenotes.h	Mon Mar 15 12:59:57 2004
+++ kdepim/knotes/resourcenotes.h	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*******************************************************************
  This file is part of KNotes.
 
- Copyright (c) 2004, Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+ Copyright (c) 2004, Bo Thorsen <bo@sonofthor.dk>
 
  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
diff -urN -x CVS kdepim.orig/knotes/version.h kdepim/knotes/version.h
--- kdepim.orig/knotes/version.h	Sun Oct  3 15:00:54 2004
+++ kdepim/knotes/version.h	Wed Oct  6 23:38:21 2004
@@ -1 +1,2 @@
+// The version has to be a double!
 #define KNOTES_VERSION 3.3
diff -urN -x CVS kdepim.orig/kontact/Makefile.am kdepim/kontact/Makefile.am
--- kdepim.orig/kontact/Makefile.am	Thu Oct 23 11:27:28 2003
+++ kdepim/kontact/Makefile.am	Sat Oct 16 11:15:56 2004
@@ -5,4 +5,4 @@
 
 messages: rc.cpp
 	$(EXTRACTRC) src/*.kcfg >> rc.cpp
-	$(XGETTEXT) src/*.cpp interfaces/*.cpp plugins/*/*.cpp -o $(podir)/kontact.pot
+	$(XGETTEXT) src/*.cpp interfaces/*.cpp plugins/*/*.cpp plugins/*/*.h -o $(podir)/kontact.pot
diff -urN -x CVS kdepim.orig/kontact/interfaces/kontactplugin.desktop kdepim/kontact/interfaces/kontactplugin.desktop
--- kdepim.orig/kontact/interfaces/kontactplugin.desktop	Tue Aug 24 08:32:26 2004
+++ kdepim/kontact/interfaces/kontactplugin.desktop	Mon Oct  4 15:26:23 2004
@@ -32,7 +32,7 @@
 Name[ru]=Модуль Kontact
 Name[sl]=Vstavek za Kontact
 Name[sr]=Прикључак Kontact-а
-Name[sr@Latn]=Dodatak Kontact-a
+Name[sr@Latn]=Priključak Kontact-a
 Name[sv]=Kontact-insticksprogram
 Name[ta]=சொருகுப்பொருளை தொடர்புக்கொள்
 Name[tg]=Модули Kontact
diff -urN -x CVS kdepim.orig/kontact/plugins/kaddressbook/kaddressbookplugin.desktop kdepim/kontact/plugins/kaddressbook/kaddressbookplugin.desktop
--- kdepim.orig/kontact/plugins/kaddressbook/kaddressbookplugin.desktop	Tue Aug 24 08:32:27 2004
+++ kdepim/kontact/plugins/kaddressbook/kaddressbookplugin.desktop	Mon Oct  4 15:26:24 2004
@@ -46,7 +46,7 @@
 Comment[ru]=Модуль Kontact для доступа к адресной книге
 Comment[sl]=Vstavek Adresarja za Kontact
 Comment[sr]=Прикључак Kontact-а за KAddressBook
-Comment[sr@Latn]=Dodatak Kontact-a za KAddressBook
+Comment[sr@Latn]=Priključak Kontact-a za KAddressBook
 Comment[sv]=Kontact-insticksprogram för adressbok
 Comment[ta]= கேமுகவரிப்புத்தக சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба китоби адресӣ
diff -urN -x CVS kdepim.orig/kontact/plugins/kaddressbook/kcmkabsummary.desktop kdepim/kontact/plugins/kaddressbook/kcmkabsummary.desktop
--- kdepim.orig/kontact/plugins/kaddressbook/kcmkabsummary.desktop	Sat Oct  2 16:30:26 2004
+++ kdepim/kontact/plugins/kaddressbook/kcmkabsummary.desktop	Mon Oct  4 15:26:24 2004
@@ -25,6 +25,7 @@
 Name[he]=תמצית פנקס כתובות
 Name[hu]=Címjegyzék-áttekintés
 Name[it]=Sommario rubrica indirizzi
+Name[ja]=住所録の要約
 Name[nb]=Addressebok sammendrag
 Name[nl]=Adresboek overzicht
 Name[nn]=Samandrag av adressebok
@@ -35,7 +36,7 @@
 Name[sk]=Súhrn adresára
 Name[sl]=Povzetek Adresarja
 Name[sr]=Сажетак адресара
-Name[sr@Latn]=Сажетак адресара
+Name[sr@Latn]=Sažetak adresara
 Name[sv]=Adressboksöversikt
 Name[ta]=முகவரிப் புத்தகச் சுருக்கம்
 Name[tg]=Дайджести китоби адрес
@@ -54,6 +55,7 @@
 Comment[he]=תצורה של תמצית פנקס כתובות
 Comment[hu]=A címjegyzék-áttekintés beállításai
 Comment[it]=Plugin impostazioni rubrica indirizzi
+Comment[ja]=住所録の記要約の設定
 Comment[nb]=Oppsett av adressebok sammendrag
 Comment[nl]=KAddressBook Overzichts-plugin
 Comment[nn]=Oppsett av samandrag av adresseboka
@@ -64,7 +66,7 @@
 Comment[sk]=Nastavenie súhrnu adresára
 Comment[sl]=Nastavitve povzetka Adresarja
 Comment[sr]=Подешавање сажетка адресара
-Comment[sr@Latn]=Подешавање сажетка адресара
+Comment[sr@Latn]=Podešavanje sažetka adresara
 Comment[sv]=Inställning av adressboksöversikt
 Comment[ta]=முகவரி புத்தக சுருக்க அமைப்பு
 Comment[tg]=Модули дайджести китоби адрес
@@ -84,6 +86,7 @@
 Keywords[he]=הולדת, שנה, תצורה, הגדרות
 Keywords[hu]=születésnap,évforduló,konfigurálás,beállítások
 Keywords[it]=compleanno, anniversario, configura, impostazioni
+Keywords[ja]=誕生日,記念日,設定,設定
 Keywords[nb]=fødselsdag, jubileum, sette opp, innstillinger
 Keywords[nl]=verjaardag,instellingen,configuratie
 Keywords[nn]=fødselsdag,bursdag,gebursdag,jubileum,oppsett,innstillingar
@@ -94,7 +97,7 @@
 Keywords[sk]=narodeniny,výročie,nastavenie
 Keywords[sl]=rojstni dan,obletnica,nastavi,nastavitve
 Keywords[sr]=рођендан, годишњица, подеси, поставке
-Keywords[sr@Latn]=рођендан, годишњица, подеси, поставке
+Keywords[sr@Latn]=rođendan, godišnjica, podesi, postavke
 Keywords[sv]=födelsedag, bröllopsdag, anpassa, inställningar
 Keywords[ta]=பிறந்தநாள், ஆண்டுவிழா, கட்டமைப்பு,அமைவுகள்
 Keywords[tg]=birthday, anniversary, configure, settings, рӯзҳои таваллуд,танзимот
diff -urN -x CVS kdepim.orig/kontact/plugins/kitchensync/kitchensync.desktop kdepim/kontact/plugins/kitchensync/kitchensync.desktop
--- kdepim.orig/kontact/plugins/kitchensync/kitchensync.desktop	Tue Aug 24 08:32:27 2004
+++ kdepim/kontact/plugins/kitchensync/kitchensync.desktop	Mon Oct  4 15:26:24 2004
@@ -43,7 +43,7 @@
 Comment[sk]=Modul pre KitchenSync
 Comment[sl]=Vstavek KitchenSync
 Comment[sr]=Прикључак KitchenSync-а
-Comment[sr@Latn]=Dodatak KitchenSync-a
+Comment[sr@Latn]=Priključak KitchenSync-a
 Comment[sv]=Kitchensync-insticksprogram
 Comment[ta]=கிச்சன் ஒன்றிணை சொருகுப்பொருள்
 Comment[tg]=Модули KitchenSync
diff -urN -x CVS kdepim.orig/kontact/plugins/kmail/kcmkmailsummary.desktop kdepim/kontact/plugins/kmail/kcmkmailsummary.desktop
--- kdepim.orig/kontact/plugins/kmail/kcmkmailsummary.desktop	Sat Oct  2 16:30:26 2004
+++ kdepim/kontact/plugins/kmail/kcmkmailsummary.desktop	Mon Oct  4 15:26:24 2004
@@ -26,6 +26,7 @@
 Name[hu]=A levelek áttekintése
 Name[is]=Póstyfirlit
 Name[it]=Sommario posta
+Name[ja]=メール 要約
 Name[nb]=E-post sammendrag
 Name[nl]=E-mail Overzicht
 Name[nn]=E-postsamandrag
@@ -36,7 +37,7 @@
 Name[sk]=Súhrn poštypošty
 Name[sl]=Povzetek pošte
 Name[sr]=Сажетак поште
-Name[sr@Latn]=Сажетак поште
+Name[sr@Latn]=Sažetak pošte
 Name[sv]=Postöversikt
 Name[ta]=அஞ்சல் சுருக்கம்
 Name[tg]=Дайджести почта
@@ -56,6 +57,7 @@
 Comment[hu]=A levelek áttekintésének beállításai
 Comment[is]=Uppsetning póstyfirlits
 Comment[it]=Impostazioni sommario posta
+Comment[ja]=メール 要約の設定
 Comment[nb]=E-post sammendrag oppsett
 Comment[nl]=E-mail Overzichts-instellingen
 Comment[nn]=Oppsett av e-postsamandrag
@@ -66,7 +68,7 @@
 Comment[sk]=Nastavenie súhrnu pošty
 Comment[sl]=Nastavitve povzetka pošte
 Comment[sr]=Подешавање сажетка поште
-Comment[sr@Latn]=Подешавање сажетка поште
+Comment[sr@Latn]=Podešavanje sažetka pošte
 Comment[sv]=Inställning av postöversikt
 Comment[ta]=அஞ்சல் சுருக்க அமைப்பு
 Comment[tg]=Танзимоти дайджести почта
@@ -85,6 +87,7 @@
 Keywords[he]=דוא"ל, תמצית, תצורה, הגדרות
 Keywords[hu]=e-mail,áttekintés,konfigurálás,beállítások
 Keywords[it]=posta elettronica, email, sommario, configura, impostazioni
+Keywords[ja]=メール,要約,設定,設定
 Keywords[nb]=e-post, sammendrag, oppsett, innstillinger
 Keywords[nl]=email,e-mail,overzicht,samenvatting,instellingen,configuratie
 Keywords[nn]=e-post,samandrag,oppsett,innstillingar
@@ -95,7 +98,7 @@
 Keywords[sk]=email,súhrn,nastavenie
 Keywords[sl]=e-pošta,pošta,povzetek,nastavi,nastavitve
 Keywords[sr]=емаил, сажетак, подеси, поставке
-Keywords[sr@Latn]=емаил, сажетак, подеси, поставке
+Keywords[sr@Latn]=email, sažetak, podesi, postavke
 Keywords[sv]=e-post, översikt, anpassa, inställningar
 Keywords[ta]=மின்னஞ்சல்,சுருக்கம்,கட்டமைப்பு,அமைவுகள்
 Keywords[tg]=email, summary, configure, settings,танзимот, дайджест,почта
diff -urN -x CVS kdepim.orig/kontact/plugins/kmail/kmailplugin.desktop kdepim/kontact/plugins/kmail/kmailplugin.desktop
--- kdepim.orig/kontact/plugins/kmail/kmailplugin.desktop	Thu Sep 30 16:04:06 2004
+++ kdepim/kontact/plugins/kmail/kmailplugin.desktop	Mon Oct  4 15:26:24 2004
@@ -48,7 +48,7 @@
 Comment[ru]=Модуль Kontact для доступа к KMail
 Comment[sl]=Vstavek KMaila za Kontact
 Comment[sr]=Прикључак Kontact-а за KMail
-Comment[sr@Latn]=Dodatak Kontact-a za KMail
+Comment[sr@Latn]=Priključak Kontact-a za KMail
 Comment[sv]=Kontact-insticksprogram för Kmail
 Comment[ta]=கேஅஞ்சல் சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули Kontact барои дастрасӣ барои KMail
diff -urN -x CVS kdepim.orig/kontact/plugins/knode/knodeplugin.desktop kdepim/kontact/plugins/knode/knodeplugin.desktop
--- kdepim.orig/kontact/plugins/knode/knodeplugin.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/knode/knodeplugin.desktop	Mon Oct  4 15:26:25 2004
@@ -45,7 +45,7 @@
 Comment[sk]=Modul KNode pre Kontact
 Comment[sl]=Vstavek KNode za Kontact
 Comment[sr]=Прикључак Kontact-а за KNode
-Comment[sr@Latn]=Dodatak Kontact-a za KNode
+Comment[sr@Latn]=Priključak Kontact-a za KNode
 Comment[sv]=Kontact insticksdelprogram för Knode
 Comment[ta]=கேநோடு சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба KNode
diff -urN -x CVS kdepim.orig/kontact/plugins/knotes/Makefile.am kdepim/kontact/plugins/knotes/Makefile.am
--- kdepim.orig/kontact/plugins/knotes/Makefile.am	Tue Aug 31 17:11:23 2004
+++ kdepim/kontact/plugins/knotes/Makefile.am	Wed Oct  6 13:06:17 2004
@@ -5,10 +5,11 @@
 libkontact_knotesplugin_la_LIBADD = $(top_builddir)/kontact/interfaces/libkpinterfaces.la \
                                     $(LIB_KPARTS) $(top_builddir)/libkdepim/libkdepim.la \
                                     $(top_builddir)/libkcal/libkcal.la -lkresources \
-                                    $(top_builddir)/knotes/libknotes.la -lkdeprint
+                                    $(top_builddir)/knotes/libknotesresources.la \
+				    $(top_builddir)/knotes/libknoteseditor.la
 
 libkontact_knotesplugin_la_SOURCES = knotes_plugin.cpp knotes_part.cpp summarywidget.cpp \
-                                     knotetip.cpp
+                                     knotetip.cpp KNotesIface.skel
 
 METASOURCES = AUTO
 
@@ -17,3 +18,5 @@
 
 partdir = $(kde_datadir)/knotes
 part_DATA = knotes_part.rc
+
+KNotesIface_DIR = $(top_srcdir)/knotes
diff -urN -x CVS kdepim.orig/kontact/plugins/knotes/knotesplugin.desktop kdepim/kontact/plugins/knotes/knotesplugin.desktop
--- kdepim.orig/kontact/plugins/knotes/knotesplugin.desktop	Tue Aug 24 08:32:28 2004
+++ kdepim/kontact/plugins/knotes/knotesplugin.desktop	Mon Oct  4 15:26:25 2004
@@ -44,7 +44,7 @@
 Comment[ru]=Модуль Kontact для доступа к заметкам
 Comment[sl]=Vstavek KNotes za Kontact
 Comment[sr]=Прикључак Kontact-а за KNotes
-Comment[sr@Latn]=Dodatak Kontact-a za KNotes
+Comment[sr@Latn]=Priključak Kontact-a za KNotes
 Comment[sv]=Kontact insticksdelprogram för Knotes
 Comment[ta]= கேகுறிப்புகளை சொருகுப்பொருளை தொடர்புகொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба ахборот
diff -urN -x CVS kdepim.orig/kontact/plugins/korganizer/kcmkorgsummary.desktop kdepim/kontact/plugins/korganizer/kcmkorgsummary.desktop
--- kdepim.orig/kontact/plugins/korganizer/kcmkorgsummary.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/korganizer/kcmkorgsummary.desktop	Mon Oct  4 15:26:25 2004
@@ -26,6 +26,7 @@
 Name[he]=תזמון
 Name[hu]=Szervezés
 Name[it]=Pianifica
+Name[ja]=スケジュール
 Name[nb]=Planlegging
 Name[nl]=Tijdschema
 Name[nn]=Plan
@@ -36,7 +37,7 @@
 Name[sk]=Plánovanie
 Name[sl]=Razpored
 Name[sr]=Закажи
-Name[sr@Latn]=Закажи
+Name[sr@Latn]=Zakaži
 Name[sv]=Schema
 Name[ta]= திட்டம்
 Name[tg]=Ҷадвал
@@ -54,6 +55,7 @@
 Comment[he]=תצורת תזמון
 Comment[hu]=A szervezés beállításai
 Comment[it]=Setup pianificazione
+Comment[ja]=スケジュール設定
 Comment[nb]=Planlegger oppsett
 Comment[nl]=Tijdschema-instellingen
 Comment[nn]=Oppsett av plan
@@ -64,7 +66,7 @@
 Comment[sk]=Nastavenie plánovania
 Comment[sl]=nastavitve razporeda
 Comment[sr]=Подешавање заказивања
-Comment[sr@Latn]=Подешавање заказивања
+Comment[sr@Latn]=Podešavanje zakazivanja
 Comment[sv]=Inställning av schema
 Comment[ta]=திட்ட அமைப்பு
 Comment[tg]=Танзимоти ҷадвал
@@ -84,6 +86,7 @@
 Keywords[he]=לוח, משימות, תצורה, הגדרה
 Keywords[hu]=naptár,feladatok,konfigurálás,beállítások
 Keywords[it]=calendario, cose da fare, configura, impostazioni
+Keywords[ja]=スケジュール,todos,設定,設定
 Keywords[nb]=klaender, oppgavelister, oppsett, innstillinger
 Keywords[nl]=kalender,agenda,taken,todo,instellingen,configuratie
 Keywords[nn]=kalender,hugselister,oppsett,innstillingar
@@ -94,7 +97,7 @@
 Keywords[sk]=kalendár,úlohy,nastavenie
 Keywords[sl]=koledar,za narediti,nastavitve,nastavi
 Keywords[sr]=календар, задаци, подеси, поставке
-Keywords[sr@Latn]=календар, задаци, подеси, поставке
+Keywords[sr@Latn]=kalendar, zadaci, podesi, postavke
 Keywords[sv]=kalender, att-göra, anpassa, inställningar
 Keywords[ta]=நாள்காட்டி,செய்யவேண்டியவைகள்,கட்டமைப்பு,அமைவுகள்
 Keywords[tg]=calendar, todos, configure, settings,танзимот, тақвим,вазифа
diff -urN -x CVS kdepim.orig/kontact/plugins/korganizer/korganizerplugin.desktop kdepim/kontact/plugins/korganizer/korganizerplugin.desktop
--- kdepim.orig/kontact/plugins/korganizer/korganizerplugin.desktop	Tue Aug 31 09:23:20 2004
+++ kdepim/kontact/plugins/korganizer/korganizerplugin.desktop	Mon Oct  4 15:26:25 2004
@@ -46,7 +46,7 @@
 Comment[ru]=Модуль Kontact для доступа к органайзеру
 Comment[sl]=Vstavek KOrganizer za Kontact
 Comment[sr]=Прикључак Kontact-а за KOrganizer
-Comment[sr@Latn]=Dodatak Kontact-a za KOrganizer
+Comment[sr@Latn]=Priključak Kontact-a za KOrganizer
 Comment[sv]=Kontact-insticksprogram för Korganizer
 Comment[ta]=கேஅமைப்பாளரை சொருகுப்பொருளை தொடர்புகொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба органайзер
diff -urN -x CVS kdepim.orig/kontact/plugins/korganizer/todoplugin.desktop kdepim/kontact/plugins/korganizer/todoplugin.desktop
--- kdepim.orig/kontact/plugins/korganizer/todoplugin.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/korganizer/todoplugin.desktop	Mon Oct  4 15:26:25 2004
@@ -46,7 +46,7 @@
 Comment[sk]=KOrganizer modul zoznamu úloh pre Kontact
 Comment[sl]=Vstavek opravil KOrganizerja za Kontact
 Comment[sr]=Прикључак Kontact-а за KOrganizer-ову листу задатака
-Comment[sr@Latn]=Dodatak Kontact-a za KOrganizer-ovu listu zadataka
+Comment[sr@Latn]=Priključak Kontact-a za KOrganizer-ovu listu zadataka
 Comment[sv]=Kontact-insticksprogram för Korganizers att-göra-lista
 Comment[ta]=கேஅமைப்பாளர் செய்யவேண்டிய பட்டியல் சொருகுப்பொருளை தொடர்புகொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба рӯйхати вазифоти органайзер
diff -urN -x CVS kdepim.orig/kontact/plugins/kpilot/kpilotplugin.desktop kdepim/kontact/plugins/kpilot/kpilotplugin.desktop
--- kdepim.orig/kontact/plugins/kpilot/kpilotplugin.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/kpilot/kpilotplugin.desktop	Mon Oct  4 15:26:25 2004
@@ -30,6 +30,7 @@
 Comment[hu]=Kontact KPilot-bővítőmodul
 Comment[is]=Kontact KPilot íforrit
 Comment[it]=Plugin KPilot Kontact
+Comment[ja]=Kontact ＫPilot プラグイン
 Comment[nb]=Kontact programtillegg for KPilot
 Comment[nl]=Kontact KPilot-plugin
 Comment[nn]=Kontact-programtillegg for KPilot
@@ -40,7 +41,7 @@
 Comment[sk]=Modul KPilot pre Kontact
 Comment[sl]=Vstavek KPilota za Kontact
 Comment[sr]=Прикључак Kontact-а за KPilot-а
-Comment[sr@Latn]=Прикључак Kontact-а за KPilot-а
+Comment[sr@Latn]=Priključak Kontact-a za KPilot-a
 Comment[sv]=Kontact-insticksprogram för Kpilot
 Comment[ta]=கேபைலட் சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули Kontact барои дастрасӣ ба KPilot
@@ -59,6 +60,7 @@
 Name[hu]=A KPilot beállításai
 Name[is]=KPilot stillingar
 Name[it]=Configurazione KPilot
+Name[ja]=KPilotの設定
 Name[nb]=KPilot oppsett
 Name[nl]=KPilot instellingen
 Name[nn]=KPilot-oppsett
@@ -69,7 +71,7 @@
 Name[sk]=Nastavenie KPilot
 Name[sl]=Nastavitve KPilota
 Name[sr]=KPilot подешавање
-Name[sr@Latn]=KPilot подешавање
+Name[sr@Latn]=KPilot podešavanje
 Name[sv]=Inställning av Kpilot
 Name[ta]=Kபைலட் கட்டமைப்பு
 Name[tg]=Танзимоти KPilot
diff -urN -x CVS kdepim.orig/kontact/plugins/newsticker/kcmkontactknt.desktop kdepim/kontact/plugins/newsticker/kcmkontactknt.desktop
--- kdepim.orig/kontact/plugins/newsticker/kcmkontactknt.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/newsticker/kcmkontactknt.desktop	Mon Oct  4 15:26:26 2004
@@ -25,6 +25,7 @@
 Name[hu]=Hírforrások
 Name[is]=Fréttaveitur
 Name[it]=Fonti Notizie
+Name[ja]=ニュース ソース
 Name[nb]=Nyhetskilder
 Name[nl]=Nieuwsbronnen
 Name[nn]=Nyhendekjelder
@@ -35,7 +36,7 @@
 Name[sk]=Zdroje správ
 Name[sl]=Viri novic
 Name[sr]=Извори вести
-Name[sr@Latn]=Извори вести
+Name[sr@Latn]=Izvori vesti
 Name[sv]=Nyhetskällor
 Name[ta]=செய்திகள் மூலங்கள்
 Name[tg]=Махзани маълумот
@@ -53,6 +54,7 @@
 Comment[hu]=A hírforrások beállításai
 Comment[is]=Uppsetning fréttaveitna
 Comment[it]=Impostazione nuove fonti
+Comment[ja]=ニュース ソースの設定
 Comment[nb]=Oppsett av nyhetskilder
 Comment[nl]=Nieuwsbroninstellingen
 Comment[nn]=Oppsett av nyhendekjelder
@@ -63,7 +65,7 @@
 Comment[sk]=Nastavenie zdrojov správ
 Comment[sl]=Nastavitve virov novic
 Comment[sr]=Подешавање извора вести
-Comment[sr@Latn]=Подешавање извора вести
+Comment[sr@Latn]=Podešavanje izvora vesti
 Comment[sv]=Inställning av nyhetskällor
 Comment[ta]=திட்ட அமைப்பு
 Comment[tg]=Танзимотгоҳи махзани маълумот
@@ -80,6 +82,7 @@
 Keywords[gl]=capturador de novas, configurar, opcións
 Keywords[hu]=hírmegjelenítő,konfigurálás,beállítások
 Keywords[it]=ticker notizie, configura, impostazioni
+Keywords[ja]=ニュース ティッカー,設定,設定
 Keywords[nb]=nyhetstelegraf, oppsett, innstillinger
 Keywords[nl]=newsticker,instellingen,configuratie,nieuws
 Keywords[nn]=nyhendetelegraf,oppsett,innstillingar
@@ -89,7 +92,7 @@
 Keywords[ru]=news ticker, configure, settings, настройка, новости
 Keywords[sk]=zdroje správ,nastavenie
 Keywords[sr]=news ticker, подеси, поставке
-Keywords[sr@Latn]=news ticker, подеси, поставке
+Keywords[sr@Latn]=news ticker, podesi, postavke
 Keywords[sv]=nyhetsövervakare, anpassa, inställningar
 Keywords[ta]=கேமுகவரிப்புத்தகம்,கட்டமைப்பு,அமைவுகள்
 Keywords[tg]=news ticker, configure, settings, танзимот
diff -urN -x CVS kdepim.orig/kontact/plugins/newsticker/newstickerplugin.desktop kdepim/kontact/plugins/newsticker/newstickerplugin.desktop
--- kdepim.orig/kontact/plugins/newsticker/newstickerplugin.desktop	Sat Oct  2 16:30:27 2004
+++ kdepim/kontact/plugins/newsticker/newstickerplugin.desktop	Mon Oct  4 15:26:26 2004
@@ -27,6 +27,7 @@
 Comment[hu]=Kontact KNewsTicker-bővítőmodul
 Comment[is]=Kontact Fréttastrimilsíforrit
 Comment[it]=Plugin Kontact Ticker Notizie
+Comment[ja]=Kontact ニュース ティッカー プラグイン
 Comment[nb]=Kontact nyhetstelegraf programtillegg
 Comment[nl]=Kontact NewsTicker-plugin
 Comment[nn]=Programtillegg for nyhendetelegraf i Kontact
@@ -36,7 +37,7 @@
 Comment[ru]=Модуль ленты новостей Kontact
 Comment[sk]=Modul správ pre Kontact
 Comment[sr]=Прикључак News Ticker-а за Kontact
-Comment[sr@Latn]=Прикључак News Ticker-а за Kontact
+Comment[sr@Latn]=Priključak News Ticker-a za Kontact
 Comment[sv]=Kontact insticksprogram för Nyhetsövervakaren
 Comment[ta]= செய்திகள் டிக்கர் சொருகுப்பொருளை தொடர்புகொள்
 Comment[tg]=Тамос гирифтан бо NewsTicker Plugin
@@ -51,6 +52,7 @@
 Name[hu]=Hírmegjelenítő - RSS
 Name[is]=Fréttastrimill
 Name[it]=Ticker notizie
+Name[ja]=ニュース ティッカー
 Name[nb]=Nyhetstelegraf
 Name[nn]=Nyhendetelegraf
 Name[pt]=Notícias
diff -urN -x CVS kdepim.orig/kontact/plugins/summary/kcmkontactsummary.desktop kdepim/kontact/plugins/summary/kcmkontactsummary.desktop
--- kdepim.orig/kontact/plugins/summary/kcmkontactsummary.desktop	Sat Oct  2 16:30:28 2004
+++ kdepim/kontact/plugins/summary/kcmkontactsummary.desktop	Mon Oct  4 15:26:26 2004
@@ -61,6 +61,7 @@
 Comment[gl]=Configuración xeral para a vista de resumo de Kontact
 Comment[hu]=A Kontact áttekintő nézetének beállításai
 Comment[it]=Configurazione generale della vista sommario di Kontact
+Comment[ja]=Kontactの要約表示の一般的な設定
 Comment[nb]=Generell konfigurasjon av Kontact's sammendrags oversikt
 Comment[nl]=Algemene instellingen van Kontact's overzichtsweergave
 Comment[nn]=Generelt oppsett av samandragsvisinga i Kontact
@@ -71,7 +72,7 @@
 Comment[sk]=Všeobecné nastavenie súhrnu Kontact
 Comment[sl]=Splošne nastavitve za prikaz povzetka v Kontract
 Comment[sr]=Општо подешавање Kontact-овог приказа сажетка
-Comment[sr@Latn]=Општо подешавање Kontact-овог приказа сажетка
+Comment[sr@Latn]=Opšto podešavanje Kontact-ovog prikaza sažetka
 Comment[sv]=Allmän inställning av Kontacts översiktsvy
 Comment[ta]=கான்டாக்கின் சுருக்க காட்சியின் பொது கட்டமைப்பு
 Comment[tg]=Танзимотҳои умумии дайджести Kontact
diff -urN -x CVS kdepim.orig/kontact/plugins/summary/summaryplugin.desktop kdepim/kontact/plugins/summary/summaryplugin.desktop
--- kdepim.orig/kontact/plugins/summary/summaryplugin.desktop	Tue Aug 24 08:32:29 2004
+++ kdepim/kontact/plugins/summary/summaryplugin.desktop	Mon Oct  4 15:26:26 2004
@@ -41,7 +41,7 @@
 Comment[sk]=Modul súhrnu pre Kontact
 Comment[sl]=Vstavek povzetega pogleda za Kontact
 Comment[sr]=Прикључак Kontact-а за приказ сажетка
-Comment[sr@Latn]=Dodatak Kontact-a za SummaryView
+Comment[sr@Latn]=Priključak Kontact-a za prikaz sažetka
 Comment[sv]=Kontact-insticksprogram för översikt
 Comment[ta]=சுருக்கக்காட்சி சொருகுப்பொருளை தொடர்புகொள்
 Comment[tg]=Модули дайджести Kontact
diff -urN -x CVS kdepim.orig/kontact/plugins/test/kptestplugin.desktop kdepim/kontact/plugins/test/kptestplugin.desktop
--- kdepim.orig/kontact/plugins/test/kptestplugin.desktop	Thu Sep 30 16:04:07 2004
+++ kdepim/kontact/plugins/test/kptestplugin.desktop	Mon Oct  4 15:26:26 2004
@@ -40,7 +40,7 @@
 Comment[ru]=Проверочный модуль Kontact
 Comment[sl]=Preizkusni vstavek za Kontact
 Comment[sr]=Пробни прикључак Kontact-а
-Comment[sr@Latn]=Probni dodatak Kontact-a
+Comment[sr@Latn]=Probni priključak Kontact-a
 Comment[sv]=Kontact-testinsticksprogram
 Comment[ta]=பரிசோதனை சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули матнии Kontact
@@ -73,7 +73,7 @@
 Name[sk]=TestModul
 Name[sl]=Preizkusni vstavek
 Name[sr]=Пробни прикључак
-Name[sr@Latn]=Probni dodatak
+Name[sr@Latn]=Probni priključak
 Name[sv]=Testinsticksprogram
 Name[ta]=சோதனை சொருகுப்பொருள்
 Name[tg]=Модули матнӣ
diff -urN -x CVS kdepim.orig/kontact/plugins/weather/weatherplugin.desktop kdepim/kontact/plugins/weather/weatherplugin.desktop
--- kdepim.orig/kontact/plugins/weather/weatherplugin.desktop	Thu Sep 30 16:04:07 2004
+++ kdepim/kontact/plugins/weather/weatherplugin.desktop	Mon Oct  4 15:26:26 2004
@@ -46,7 +46,7 @@
 Comment[sk]=Modul počasia pre Kontact
 Comment[sl]=Vremenski vstavek za Kontact
 Comment[sr]=Прикључак Kontact-а за време
-Comment[sr@Latn]=Dodatak Kontact-a za vreme
+Comment[sr@Latn]=Priključak Kontact-a za vreme
 Comment[sv]=Kontact-väderinsticksprogram
 Comment[ta]=வானிலை சொருகுப்பொருளை தொடர்பு கொள்
 Comment[tg]=Модули пешгӯии ҳавои Kontact
diff -urN -x CVS kdepim.orig/korganizer/Makefile.am kdepim/korganizer/Makefile.am
--- kdepim.orig/korganizer/Makefile.am	Wed Sep 15 15:54:53 2004
+++ kdepim/korganizer/Makefile.am	Thu Oct  7 11:59:24 2004
@@ -105,7 +105,6 @@
 	alarmclient.cpp \
 	actionmanager.cpp resourceview.cpp \
 	navigatorbar.cpp kogroupware.cpp \
-	kogroupwareincomingdialog_base.ui kogroupwareincomingdialog.cpp \
 	history.cpp \
 	koprefs_base.kcfgc \
 	koincidencetooltip.cpp aboutdata.cpp \
@@ -155,7 +154,7 @@
 	outgoingdialog.h incomingdialog.h publishdialog.h koeditorfreebusy.h \
 	koeventview.h statusdialog.h customlistviewitem.h \
 	alarmclient.h \
-	navigatorbar.h kogroupware.h kogroupwareincomingdialog.h \
+	navigatorbar.h kogroupware.h \
 	koincidencetooltip.h korganizerifaceimpl.h
 
 tip_DATA = tips
diff -urN -x CVS kdepim.orig/korganizer/actionmanager.cpp kdepim/korganizer/actionmanager.cpp
--- kdepim.orig/korganizer/actionmanager.cpp	Sun Aug  1 23:23:48 2004
+++ kdepim/korganizer/actionmanager.cpp	Thu Oct  7 10:38:22 2004
@@ -1220,27 +1220,6 @@
   return mCalendarView->deleteEvent(uid);
 }
 
-bool ActionManager::eventRequest( const QString& request,
-				  const QString& receiver,
-				  const QString& ical)
-{
-  if( !KOGroupware::instance() ) return false;
-  return KOGroupware::instance()->incomingEventRequest(request, receiver,
-                                                       ical);
-}
-
-bool ActionManager::eventReply( const QString& ical )
-{
-  if( !KOGroupware::instance() ) return false;
-  return KOGroupware::instance()->incidenceAnswer( ical );
-}
-
-bool ActionManager::cancelEvent( const QString& ical )
-{
-  if( !KOGroupware::instance() ) return false;
-  return KOGroupware::instance()->cancelIncidence( ical );
-}
-
 void ActionManager::configureDateTimeFinished(KProcess *proc)
 {
   delete proc;
diff -urN -x CVS kdepim.orig/korganizer/actionmanager.h kdepim/korganizer/actionmanager.h
--- kdepim.orig/korganizer/actionmanager.h	Mon Jul 26 15:50:10 2004
+++ kdepim/korganizer/actionmanager.h	Wed Oct  6 17:53:24 2004
@@ -133,14 +133,6 @@
     /** Delete event with the given unique id from current calendar. */
     virtual bool deleteEvent( const QString& uid );
 
-    /** Handle incoming event scheduling */
-    bool eventRequest( const QString& request, const QString& receiver,
-		       const QString& ical );
-    /** Handle event replies */
-    bool eventReply( const QString& ical );
-    /** Handle cancelling an event */
-    bool cancelEvent( const QString& ical );
-
     bool editIncidence( const QString& uid );
 
     //// Implementation of the DCOP interface
diff -urN -x CVS kdepim.orig/korganizer/calendarview.cpp kdepim/korganizer/calendarview.cpp
--- kdepim.orig/korganizer/calendarview.cpp	Fri Sep 24 18:55:08 2004
+++ kdepim/korganizer/calendarview.cpp	Thu Oct  7 11:20:11 2004
@@ -1139,7 +1139,7 @@
     return;
   }
   if (KOPrefs::instance()->mConfirm && (!KOPrefs::instance()->mUseGroupwareCommunication ||
-                                        KOPrefs::instance()->thatIsMe( todo->organizer() ))) {
+                                        KOPrefs::instance()->thatIsMe( todo->organizer().email() ))) {
     switch (msgItemDelete()) {
       case KMessageBox::Continue: // OK
         if (!todo->relations().isEmpty()) {
@@ -1183,7 +1183,7 @@
     return;
   }
   if (KOPrefs::instance()->mConfirm && (!KOPrefs::instance()->mUseGroupwareCommunication ||
-                                        KOPrefs::instance()->thatIsMe( journal->organizer() ))) {
+                                        KOPrefs::instance()->thatIsMe( journal->organizer().email() ))) {
     switch (msgItemDelete()) {
       case KMessageBox::Continue: // OK
         bool doDelete = true;
@@ -1241,7 +1241,7 @@
     switch(km) {
       case KMessageBox::No: // Continue // all
       case KMessageBox::Continue:
-        if (KOPrefs::instance()->thatIsMe( anEvent->organizer() ) && anEvent->attendeeCount()>0
+        if (KOPrefs::instance()->thatIsMe( anEvent->organizer().email() ) && anEvent->attendeeCount()>0
             && !KOPrefs::instance()->mUseGroupwareCommunication) {
           schedule(Scheduler::Cancel,anEvent);
         } else if( KOPrefs::instance()->mUseGroupwareCommunication ) {
@@ -1273,7 +1273,7 @@
         break;
     }
   } else {
-    bool userIsOrganizer = KOPrefs::instance()->thatIsMe( anEvent->organizer() );
+    bool userIsOrganizer = KOPrefs::instance()->thatIsMe( anEvent->organizer().email() );
     if (KOPrefs::instance()->mConfirm && (!KOPrefs::instance()->mUseGroupwareCommunication ||
                                           userIsOrganizer)) {
       bool doDelete = true;
@@ -1499,7 +1499,8 @@
   QDateTime end = start.addDays(daysToPublish);
 
   FreeBusy *freebusy = new FreeBusy(mCalendar, start, end);
-  freebusy->setOrganizer(KOPrefs::instance()->email());
+  freebusy->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                      KOPrefs::instance()->email() ) );
 
   kdDebug(5850) << "calendarview: schedule_publish_freebusy: startDate: "
      << KGlobal::locale()->formatDateTime( start ) << " End Date: "
@@ -1733,7 +1734,7 @@
   bool subtodo = false;
 
   if ( incidence ) {
-    organizerEvents = KOPrefs::instance()->thatIsMe( incidence->organizer() );
+    organizerEvents = KOPrefs::instance()->thatIsMe( incidence->organizer().email() );
     groupEvents = incidence->attendeeByMails( KOPrefs::instance()->allEmails() );
     if ( incidence && incidence->type() == "Event" ) {
 //      Event *event = static_cast<Event *>( incidence );
@@ -1817,7 +1818,8 @@
 
   if (!incidence) return;
 
-  incidence->setOrganizer(KOPrefs::instance()->email());
+  incidence->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                           KOPrefs::instance()->email() ) );
   incidence->recreate();
   incidence->setReadOnly(false);
 
@@ -1830,7 +1832,8 @@
   Incidence::List::Iterator it;
 
   for ( it = incidences.begin(); it != incidences.end(); it++ ) {
-    (*it)->setOrganizer(KOPrefs::instance()->email());
+    (*it)->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                         KOPrefs::instance()->email() ) );
     (*it)->recreate();
     (*it)->setReadOnly(false);
   }
diff -urN -x CVS kdepim.orig/korganizer/freebusymanager.cpp kdepim/korganizer/freebusymanager.cpp
--- kdepim.orig/korganizer/freebusymanager.cpp	Wed Sep 29 09:28:20 2004
+++ kdepim/korganizer/freebusymanager.cpp	Thu Oct  7 11:20:11 2004
@@ -125,7 +125,8 @@
   QDateTime end = start.addDays( KOPrefs::instance()->mFreeBusyPublishDays );
 
   FreeBusy *freebusy = new FreeBusy( mCalendar, start, end );
-  freebusy->setOrganizer( KOPrefs::instance()->email() );
+  freebusy->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                          KOPrefs::instance()->email() ) );
 
   return freebusy;
 }
@@ -460,9 +461,9 @@
   return iCalToFreeBusy( str.utf8() );
 }
 
-bool FreeBusyManager::saveFreeBusy( FreeBusy *freebusy, const QString &email )
+bool FreeBusyManager::saveFreeBusy( FreeBusy *freebusy, const Person &person )
 {
-  kdDebug() << "FreeBusyManager::saveFreeBusy(): " << email << endl;
+  kdDebug() << "FreeBusyManager::saveFreeBusy(): " << person.fullName() << endl;
 
   QString fbd = freeBusyDir();
 
@@ -479,7 +480,7 @@
 
   QString filename( fbd );
   filename += "/";
-  filename += email;
+  filename += person.email();
   filename += ".ifb";
   QFile f( filename );
 
@@ -487,7 +488,7 @@
             << endl;
 
   freebusy->clearAttendees();
-  freebusy->setOrganizer( email );
+  freebusy->setOrganizer( person );
 
   QString messageText = mFormat.createScheduleMessage( freebusy,
                                                        Scheduler::Publish );
diff -urN -x CVS kdepim.orig/korganizer/freebusymanager.h kdepim/korganizer/freebusymanager.h
--- kdepim.orig/korganizer/freebusymanager.h	Tue Jun  8 14:10:07 2004
+++ kdepim/korganizer/freebusymanager.h	Thu Oct  7 11:20:11 2004
@@ -107,7 +107,8 @@
     /**
       Store freebusy information belonging to email.
     */
-    bool saveFreeBusy( KCal::FreeBusy *, const QString &email );
+    bool saveFreeBusy( KCal::FreeBusy *freebusy, const KCal::Person &person );
+//    bool saveFreeBusy( KCal::FreeBusy *, const QString &email );
 
     /**
       Return URL of freeBusy information for given email address.
diff -urN -x CVS kdepim.orig/korganizer/incomingdialog.cpp kdepim/korganizer/incomingdialog.cpp
--- kdepim.orig/korganizer/incomingdialog.cpp	Tue Jun  8 14:31:58 2004
+++ kdepim/korganizer/incomingdialog.cpp	Thu Oct  7 11:20:11 2004
@@ -99,7 +99,7 @@
   else {
     mItem->setText(3,"");
   }
-  mItem->setText(5,e->organizer()+" ");
+  mItem->setText(5,e->organizer().fullName() );
 
   return true;
 }
@@ -119,7 +119,7 @@
       mItem->setText(2,e->dtDueTimeStr());
     }
   }
-  mItem->setText(5,e->organizer()+" ");
+  mItem->setText(5,e->organizer().fullName() );
 
   return true;
 }
@@ -197,7 +197,7 @@
       item->setText(2, KGlobal::locale()->formatTime( fb->dtStart().time() ) );
       item->setText(3, KGlobal::locale()->formatDate( fb->dtEnd().date() ) );
       item->setText(4, KGlobal::locale()->formatTime( fb->dtEnd().time() ) );
-      item->setText(5, fb->organizer());
+      item->setText(5, fb->organizer().fullName());
     }
     automaticAction(item);
   }
@@ -421,7 +421,7 @@
     QDateTime end = start.addDays(inc->duration()/86400);
 
     FreeBusy *freebusy = new FreeBusy(mCalendar, start, end);
-    freebusy->setOrganizer(inc->organizer());
+    freebusy->setOrganizer( inc->organizer() );
     Attendee *att = new Attendee(KOPrefs::instance()->fullName(),
                                KOPrefs::instance()->email());
     freebusy->addAttendee(att);
@@ -453,7 +453,7 @@
     if ( method==Scheduler::Request ) {
       if ( KOPrefs::instance()->mIMIPAutoFreeBusy==KOPrefs::addressbookAuto ) {
         // reply freebusy information
-        if ( checkOrganizerInAddressbook(inc->organizer()) ) {
+        if ( checkOrganizerInAddressbook( inc->organizer().email() ) ) {
           incomeRequest(item);
         }
       } else return false;
@@ -469,7 +469,7 @@
         if ( method==Scheduler::Publish) {
           if ( KOPrefs::instance()->mIMIPAutoFreeBusy==KOPrefs::addressbookAuto ) {
             // insert freebusy information
-            //if ( checkOrganizerInAddressbook(inc->organizer()) )
+            //if ( checkOrganizerInAddressbook(inc->organizer().email()) )
 
           }
         } else return false;
@@ -481,7 +481,7 @@
     if ( method==Scheduler::Request || method==Scheduler::Publish ) {
       if ( KOPrefs::instance()->mIMIPAutoInsertRequest==KOPrefs::addressbookAuto ) {
         // insert event
-        if ( checkOrganizerInAddressbook(inc->organizer()) )
+        if ( checkOrganizerInAddressbook(inc->organizer().email()) )
           autoAction = acceptMessage(item);
       } else return false;
     } else {
diff -urN -x CVS kdepim.orig/korganizer/interfaces/calendar/calendardecoration.desktop kdepim/korganizer/interfaces/calendar/calendardecoration.desktop
--- kdepim.orig/korganizer/interfaces/calendar/calendardecoration.desktop	Tue Aug 31 09:23:24 2004
+++ kdepim/korganizer/interfaces/calendar/calendardecoration.desktop	Mon Oct  4 15:26:29 2004
@@ -42,7 +42,7 @@
 Comment[sk]=Modul pre skrášlenie kalendára
 Comment[sl]=Vstavek besedilnega okrasa za Koledar
 Comment[sr]=Прикључак за декорацију календара
-Comment[sr@Latn]=Dodatak za dekoraciju kalendara
+Comment[sr@Latn]=Priključak za dekoraciju kalendara
 Comment[sv]=Insticksprogram för kalenderdekoration
 Comment[ta]=நாள்காட்டி அலங்கார சொருகுப்பொருள்
 Comment[tg]=Модул барои ороиш додани тақвимот
diff -urN -x CVS kdepim.orig/korganizer/interfaces/calendar/calendarplugin.desktop kdepim/korganizer/interfaces/calendar/calendarplugin.desktop
--- kdepim.orig/korganizer/interfaces/calendar/calendarplugin.desktop	Tue Aug 31 09:23:24 2004
+++ kdepim/korganizer/interfaces/calendar/calendarplugin.desktop	Mon Oct  4 15:26:29 2004
@@ -45,7 +45,7 @@
 Comment[sk]=Modul Calendar
 Comment[sl]=Vstavek za Koledar
 Comment[sr]=Прикључак за календар
-Comment[sr@Latn]=Dodatak za kalendar
+Comment[sr@Latn]=Priključak za kalendar
 Comment[sv]=Insticksprogram för kalender
 Comment[ta]=நாள்காட்டி சொருகுப்பொருள்
 Comment[tg]=Модул барои тақвимот
diff -urN -x CVS kdepim.orig/korganizer/koagenda.cpp kdepim/korganizer/koagenda.cpp
--- kdepim.orig/korganizer/koagenda.cpp	Sun Sep  5 00:38:56 2004
+++ kdepim/korganizer/koagenda.cpp	Sat Oct 16 00:39:53 2004
@@ -23,6 +23,7 @@
     with any edition of Qt, and distribute the resulting executable,
     without including the source code for Qt in the source distribution.
 */
+#include <assert.h>
 
 #include <qintdict.h>
 #include <qdatetime.h>
@@ -194,6 +195,11 @@
   return ( mSelectedItem ? mSelectedItem->itemDate() : QDate() );
 }
 
+const QString KOAgenda::lastSelectedUid() const
+{
+  return mSelectedUid;
+}
+
 
 void KOAgenda::init()
 {
@@ -231,6 +237,7 @@
   mItemMoved = false;
 
   mSelectedItem = 0;
+  mSelectedUid = QString::null;
 
   setAcceptDrops( true );
   installEventFilter( this );
@@ -1524,17 +1531,22 @@
   int width = XEnd - XBegin + 1;
   int count = 0;
   KOAgendaItem *current = 0;
+  int visibleCount = mSelectedDates.first().daysTo(mSelectedDates.last());
   QPtrList<KOAgendaItem> multiItems;
   for ( cellX = XBegin; cellX <= XEnd; ++cellX ) {
-    if ( cellX == XBegin ) cellYTop = YTop;
-    else cellYTop = 0;
-    if ( cellX == XEnd ) cellYBottom = YBottom;
-    else cellYBottom = rows() - 1;
-    newtext = QString("(%1/%2): ").arg( ++count ).arg( width );
-    newtext.append( event->summary() );
-    current = insertItem( event, qd, cellX, cellYTop, cellYBottom );
-    current->setText( newtext );
-    multiItems.append( current );
+    ++count;
+    //Only add the items that are visible.
+    if( cellX >=0 && cellX <= visibleCount ) {
+      if ( cellX == XBegin ) cellYTop = YTop;
+      else cellYTop = 0;
+      if ( cellX == XEnd ) cellYBottom = YBottom;
+      else cellYBottom = rows() - 1;
+      newtext = QString("(%1/%2): ").arg( count ).arg( width );
+      newtext.append( event->summary() );
+      current = insertItem( event, qd, cellX, cellYTop, cellYBottom );
+      current->setText( newtext );
+      multiItems.append( current );
+    }
   }
 
   KOAgendaItem *next = 0;
@@ -1755,6 +1767,8 @@
   }
   mSelectedItem = item;
   mSelectedItem->select();
+  assert( mSelectedItem->incidence() );
+  mSelectedUid = mSelectedItem->incidence()->uid();
   emit incidenceSelected( mSelectedItem->incidence() );
 }
 
diff -urN -x CVS kdepim.orig/korganizer/koagenda.h kdepim/korganizer/koagenda.h
--- kdepim.orig/korganizer/koagenda.h	Sat Sep  4 17:46:26 2004
+++ kdepim/korganizer/koagenda.h	Wed Oct  6 12:35:45 2004
@@ -73,6 +73,11 @@
 
     Incidence *selectedIncidence() const;
     QDate selectedIncidenceDate() const;
+    /**
+     * Returns the uid of the last incidence that was selected. This
+     * persists across reloads and clear, so that if the same uid
+     * reappears, it can be reselected. */
+    const QString lastSelectedUid() const;
 
     virtual bool eventFilter ( QObject *, QEvent * );
 
@@ -318,6 +323,10 @@
 
     // Currently selected item
     QGuardedPtr<KOAgendaItem> mSelectedItem;
+    // Uid of the last selected item. Used for reselecting in situations
+    // where the selected item points to a no longer valid incidence, for
+    // example during resource reload.
+    QString mSelectedUid;
 
     // The Marcus Bains Line widget.
     MarcusBains *mMarcusBains;
diff -urN -x CVS kdepim.orig/korganizer/koagendaitem.cpp kdepim/korganizer/koagendaitem.cpp
--- kdepim.orig/korganizer/koagendaitem.cpp	Mon Jul 12 16:24:38 2004
+++ kdepim/korganizer/koagendaitem.cpp	Thu Oct  7 11:20:11 2004
@@ -82,7 +82,7 @@
   mIconRecur = mIncidence->doesRecur();
   mIconAlarm = mIncidence->isAlarmEnabled();
   if ( mIncidence->attendeeCount() > 0 ) {
-    if ( KOPrefs::instance()->thatIsMe( mIncidence->organizer() ) ) {
+    if ( KOPrefs::instance()->thatIsMe( mIncidence->organizer().email() ) ) {
       mIconReply = false;
       mIconGroup = false;
       mIconOrganizer = true;
diff -urN -x CVS kdepim.orig/korganizer/koagendaview.cpp kdepim/korganizer/koagendaview.cpp
--- kdepim.orig/korganizer/koagendaview.cpp	Sat Sep  4 17:46:26 2004
+++ kdepim/korganizer/koagendaview.cpp	Fri Oct  8 14:43:46 2004
@@ -786,6 +786,8 @@
     ev->setDtEnd( endDt );
   } else if ( i->type() == "Todo" ) {
     Todo *td = static_cast<Todo*>(i);
+    startDt = td->dtStart();
+    startDt = startDt.addDays( daysOffset );
     endDt = td->dtDue();
     endDt = endDt.addDays( daysOffset );
     endDt.setTime( endTime );
@@ -1161,11 +1163,9 @@
 {
   /* Remember the uids of the selected items. In case one of the
    * items was deleted and re-added, we want to reselect it. */
-  const QString &selectedAgendaUid = 
-    mAgenda->selectedIncidence()? mAgenda->selectedIncidence()->uid():QString::null;
-  const QString &selectedAllDayAgendaUid = 
-    mAllDayAgenda->selectedIncidence()? mAllDayAgenda->selectedIncidence()->uid():QString::null;
-  
+  const QString &selectedAgendaUid = mAgenda->lastSelectedUid();
+  const QString &selectedAllDayAgendaUid = mAllDayAgenda->lastSelectedUid();
+
   enableAgendaUpdate( true );
   clearView();
 
@@ -1209,11 +1209,11 @@
       Event *event = *dayEvents.at(numEvent);
 //      kdDebug(5850) << " Event: " << event->summary() << endl;
       insertIncidence( event, currentDate, curCol );
-      if( event->uid() == selectedAgendaUid && !selectedAgendaUid.isEmpty() ) {
+      if( event->uid() == selectedAgendaUid && !selectedAgendaUid.isNull() ) {
         mAgenda->selectItemByUID( event->uid() );
         somethingReselected = true;
       }
-      if( event->uid() == selectedAllDayAgendaUid && !selectedAllDayAgendaUid.isEmpty() ) {
+      if( event->uid() == selectedAllDayAgendaUid && !selectedAllDayAgendaUid.isNull() ) {
         mAllDayAgenda->selectItemByUID( event->uid() );
         somethingReselected = true;
       }
diff -urN -x CVS kdepim.orig/korganizer/kodaymatrix.cpp kdepim/korganizer/kodaymatrix.cpp
--- kdepim.orig/korganizer/kodaymatrix.cpp	Mon Sep  6 21:53:20 2004
+++ kdepim/korganizer/kodaymatrix.cpp	Sat Oct  9 12:29:10 2004
@@ -117,6 +117,7 @@
   mSelectedDaysColor = QColor( "white" );
   mTodayMarginWidth = 2;
   mSelEnd = mSelStart = NOSELECTION;
+  setBackgroundMode( NoBackground );
 }
 
 void KODayMatrix::setCalendar( Calendar *cal )
@@ -556,21 +557,23 @@
 //  P A I N T   E V E N T   H A N D L I N G
 // ----------------------------------------------------------------------------
 
-void KODayMatrix::paintEvent( QPaintEvent *pevent )
+void KODayMatrix::paintEvent( QPaintEvent * )
 {
-//kdDebug(5850) << "KODayMatrix::paintEvent() BEGIN" << endl;
-
-  QPainter p(this);
+// kdDebug(5850) << "KODayMatrix::paintEvent() BEGIN" << endl;
 
+  QPainter p;
   QRect sz = frameRect();
+  QPixmap pm( sz.size() );
   int dheight = mDaySize.height();
   int dwidth = mDaySize.width();
   int row,col;
   int selw, selh;
   bool isRTL = KOGlobals::self()->reverseLayout();
 
-  // draw background and topleft frame
-  p.fillRect(pevent->rect(), mDefaultBackColor);
+  p.begin(  &pm, this );
+  pm.fill( mDefaultBackColor );
+
+  // draw topleft frame
   p.setPen(mDefaultTextColor);
   p.drawRect(0, 0, sz.width()+1, sz.height()+1);
   // don't paint over borders
@@ -686,6 +689,8 @@
       p.setFont(myFont);
     }
   }
+  p.end();
+  bitBlt(  this, 0, 0, &pm );
 }
 
 // ----------------------------------------------------------------------------
diff -urN -x CVS kdepim.orig/korganizer/koeditordetails.cpp kdepim/korganizer/koeditordetails.cpp
--- kdepim.orig/korganizer/koeditordetails.cpp	Wed Sep  8 13:18:10 2004
+++ kdepim/korganizer/koeditordetails.cpp	Fri Oct 15 14:46:56 2004
@@ -133,7 +133,7 @@
   QString name;
   QString email;
   KPIM::getNameAndMail( newAttendee, name, email );
-  emit dropped( new Attendee( name, email ) );
+  emit dropped( new Attendee( name, email, true ) );
 }
 
 void KOAttendeeListView::contentsDropEvent( QDropEvent *e )
@@ -335,7 +335,8 @@
       else partStat = KCal::Attendee::NeedsAction;
       insertAttendee( new Attendee( a.realName(), a.preferredEmail(),
                                     !myself, partStat,
-                                    KCal::Attendee::ReqParticipant, a.uid() ) );
+                                    KCal::Attendee::ReqParticipant, a.uid() ),
+                      true );
     }
   }
   delete dia;
@@ -361,8 +362,8 @@
 void KOEditorDetails::addNewAttendee()
 {
   Attendee *a = new Attendee( i18n("Firstname Lastname"),
-                              i18n("name@domain.com") );
-  insertAttendee( a );
+                              i18n("name@domain.com"), true );
+  insertAttendee( a, false );
   // We don't want the hint again
   mNameEdit->setClickMessage( "" );
   mNameEdit->setFocus();
@@ -372,9 +373,14 @@
 
 void KOEditorDetails::insertAttendee( Attendee *a )
 {
+  insertAttendee( a, true );
+}
+
+void KOEditorDetails::insertAttendee( Attendee *a, bool goodEmailAddress )
+{
   AttendeeListItem *item = new AttendeeListItem( a, mListView );
   mListView->setSelected( item, true );
-  if( mFreeBusy ) mFreeBusy->insertAttendee( a );
+  if( mFreeBusy ) mFreeBusy->insertAttendee( a, goodEmailAddress );
 }
 
 void KOEditorDetails::setDefaults()
@@ -397,11 +403,11 @@
   Attendee::List al = event->attendees();
   Attendee::List::ConstIterator it;
   for( it = al.begin(); it != al.end(); ++it )
-    insertAttendee( new Attendee( **it ) );
+    insertAttendee( new Attendee( **it ), true );
 
   mListView->setSelected( mListView->firstChild(), true );
 
-  if ( KOPrefs::instance()->thatIsMe( event->organizer() ) ) {
+  if ( KOPrefs::instance()->thatIsMe( event->organizer().email() ) ) {
     if ( !mOrganizerCombo ) {
       mOrganizerCombo = new QComboBox( mOrganizerHBox );
       fillOrganizerCombo();
@@ -409,12 +415,12 @@
     mOrganizerLabel->setText( i18n( "Identity as organizer:" ) );
 
     // This might not be enough, if the combo as a full name too, hence the loop below
-    // mOrganizerCombo->setCurrentText( event->organizer() );
+    // mOrganizerCombo->setCurrentText( event->organizer().fullName() );
     for ( int i = 0 ; i < mOrganizerCombo->count(); ++i ) {
       QString itemTxt = KPIM::getEmailAddr( mOrganizerCombo->text( i ) );
-      if ( KPIM::compareEmail( event->organizer(), itemTxt, false ) ) {
+      if ( KPIM::compareEmail( event->organizer().email(), itemTxt, false ) ) {
         // Make sure we match the organizer setting completely
-        mOrganizerCombo->changeItem( event->organizer(), i );
+        mOrganizerCombo->changeItem( event->organizer().fullName(), i );
         mOrganizerCombo->setCurrentItem( i );
         break;
       }
@@ -424,7 +430,7 @@
       delete mOrganizerCombo;
       mOrganizerCombo = 0;
     }
-    mOrganizerLabel->setText( i18n( "Organizer: %1" ).arg( event->organizer() ) );
+    mOrganizerLabel->setText( i18n( "Organizer: %1" ).arg( event->organizer().fullName() ) );
   }
 
   // Reinstate free/busy view updates
@@ -442,6 +448,7 @@
     event->addAttendee(new Attendee(*(a->data())));
   }
   if ( mOrganizerCombo ) {
+    // TODO: Don't take a string and split it up... Is there a better way?
     event->setOrganizer( mOrganizerCombo->currentText() );
   }
 }
@@ -521,10 +528,21 @@
   if ( !aItem ) return;
 
   Attendee *a = aItem->data();
-
   QString name;
   QString email;
   KPIM::getNameAndMail(mNameEdit->text(), name, email);
+
+  bool myself = KOPrefs::instance()->thatIsMe( email );
+  if ( myself ) {
+    mStatusCombo->setCurrentItem( KCal::Attendee::Accepted );
+    mRsvpButton->setChecked( false );
+    mRsvpButton->setEnabled( false );
+  } else if ( KOPrefs::instance()->thatIsMe ( a->email() ) ) {
+    // this was me, but is no longer, reset
+    mStatusCombo->setCurrentItem( KCal::Attendee::NeedsAction );
+    mRsvpButton->setChecked( true );
+    mRsvpButton->setEnabled( true );
+  }
   a->setName( name );
   a->setUid( mUidEdit->text() );
   a->setEmail( email );
@@ -545,7 +563,7 @@
   Q_ASSERT( mOrganizerCombo );
   // Get all emails from KOPrefs (coming from various places),
   // and insert them - removing duplicates
-  const QStringList lst = KOPrefs::instance()->allEmails();
+  const QStringList lst = KOPrefs::instance()->fullEmails();
   QStringList uniqueList;
   for( QStringList::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
     if ( uniqueList.find( *it ) == uniqueList.end() )
diff -urN -x CVS kdepim.orig/korganizer/koeditordetails.h kdepim/korganizer/koeditordetails.h
--- kdepim.orig/korganizer/koeditordetails.h	Tue Jun  8 14:31:58 2004
+++ kdepim/korganizer/koeditordetails.h	Wed Oct 13 14:35:44 2004
@@ -40,7 +40,7 @@
 class Incidence;
 }
 using namespace KCal;
-    
+
 namespace KPIM {
 class AddresseeLineEdit;
 }
@@ -110,6 +110,8 @@
     virtual bool eventFilter( QObject *, QEvent *);
     void fillOrganizerCombo();
 
+    void insertAttendee( Attendee*, bool goodEmailAddress );
+
   private:
     bool mDisableItemUpdate;
 
diff -urN -x CVS kdepim.orig/korganizer/koeditorfreebusy.cpp kdepim/korganizer/koeditorfreebusy.cpp
--- kdepim.orig/korganizer/koeditorfreebusy.cpp	Thu Sep  2 16:31:31 2004
+++ kdepim/korganizer/koeditorfreebusy.cpp	Wed Oct 13 14:35:44 2004
@@ -54,7 +54,8 @@
 {
   public:
     FreeBusyItem( Attendee *attendee, KDGanttView *parent ) :
-      KDGanttViewTaskItem( parent ), mAttendee( attendee )
+      KDGanttViewTaskItem( parent ), mAttendee( attendee ), mTimerID( 0 ),
+      mIsDownloading( false )
     {
       Q_ASSERT( attendee );
       updateItem();
@@ -87,11 +88,28 @@
 
     QString email() const { return mAttendee->email(); }
 
+    void setUpdateTimerID( int id ) { mTimerID = id; }
+    int updateTimerID() const { return mTimerID; }
+
+    void startDownload() {
+      mIsDownloading = true;
+      FreeBusyManager *m = KOGroupware::instance()->freeBusyManager();
+      m->retrieveFreeBusy( attendee()->email() );
+    }
+    void setIsDownloading( bool d ) { mIsDownloading = d; }
+    bool isDownloading() const { return mIsDownloading; }
+
   private:
     Attendee *mAttendee;
     KCal::FreeBusy *mFreeBusy;
 
     QMap<int,QString> mKeyMap;
+
+    // This is used for the update timer
+    int mTimerID;
+
+    // Only run one download job at a time
+    bool mIsDownloading;
 };
 
 void FreeBusyItem::updateItem()
@@ -143,6 +161,9 @@
       setFreeBusy( 0 );
       setShowNoInformation( true );
   }
+
+  // We are no longer downloading
+  mIsDownloading = false;
 }
 
 
@@ -169,7 +190,7 @@
   QLabel *label = new QLabel( i18n( "Scale: " ), this );
   controlLayout->addWidget( label );
 
-  scaleCombo = new QComboBox( this ); 
+  scaleCombo = new QComboBox( this );
   scaleCombo->insertItem( i18n( "Hour" ) );
   scaleCombo->insertItem( i18n( "Day" ) );
   scaleCombo->insertItem( i18n( "Week" ) );
@@ -235,8 +256,6 @@
                                                       const QDateTime & ) ),
            mGanttView, SLOT( zoomToSelection( const QDateTime &,
                                               const  QDateTime & ) ) );
-//  connect( mGanttView, SIGNAL( lvItemDoubleClicked( KDGanttViewItem * ) ),
-//           SLOT( updateFreeBusyData( KDGanttViewItem * ) ) );
   connect( mGanttView, SIGNAL( lvItemDoubleClicked( KDGanttViewItem * ) ),
            SLOT( editFreeBusyUrl( KDGanttViewItem * ) ) );
 
@@ -257,6 +276,8 @@
       static_cast<FreeBusyItem *>( mGanttView->firstChild() );
   while( anItem ) {
     if( anItem->attendee() == attendee ) {
+      if ( anItem->updateTimerID() != 0 )
+        killTimer( anItem->updateTimerID() );
       delete anItem;
       updateStatusSummary();
       break;
@@ -265,12 +286,11 @@
   }
 }
 
-void KOEditorFreeBusy::insertAttendee( Attendee *attendee )
+void KOEditorFreeBusy::insertAttendee( Attendee *attendee, bool readFBList )
 {
-  (void)new FreeBusyItem( attendee, mGanttView );
-#if 0
-  updateFreeBusyData( attendee );
-#endif
+  FreeBusyItem* item = new FreeBusyItem( attendee, mGanttView );
+  if ( readFBList )
+    updateFreeBusyData( item );
   updateStatusSummary();
 }
 
@@ -281,7 +301,7 @@
   while( anItem ) {
     if( anItem->attendee() == attendee ) {
       anItem->updateItem();
-      updateFreeBusyData( attendee );
+      updateFreeBusyData( anItem );
       updateStatusSummary();
       break;
     }
@@ -309,14 +329,14 @@
 void KOEditorFreeBusy::readEvent( Event *event )
 {
   setDateTimes( event->dtStart(), event->dtEnd() );
-  mIsOrganizer = KOPrefs::instance()->thatIsMe( event->organizer() );
+  mIsOrganizer = KOPrefs::instance()->thatIsMe( event->organizer().email() );
   updateStatusSummary();
 }
 
 
 void KOEditorFreeBusy::setDateTimes( QDateTime start, QDateTime end )
 {
- 
+
   slotUpdateGanttView( start, end );
 }
 
@@ -328,27 +348,42 @@
   slotCenterOnStart();
 }
 
-void KOEditorFreeBusy::slotCenterOnStart() 
+void KOEditorFreeBusy::slotCenterOnStart()
 {
   mGanttView->centerTimeline( mDtStart );
 }
 
-void KOEditorFreeBusy::slotZoomToTime() 
+void KOEditorFreeBusy::slotZoomToTime()
 {
   mGanttView->zoomToFit();
 }
 
-void KOEditorFreeBusy::updateFreeBusyData( KDGanttViewItem *item )
+void KOEditorFreeBusy::updateFreeBusyData( FreeBusyItem* item )
 {
-  FreeBusyItem *g = static_cast<FreeBusyItem *>( item );
-  updateFreeBusyData( g->attendee() );
+  if ( item->isDownloading() )
+    // This item is already in the process of fetching the FB list
+    return;
+
+  if ( item->updateTimerID() != 0 )
+    // An update timer is already running. Reset it
+    killTimer( item->updateTimerID() );
+
+  // This item does not have a download running, and no timer is set
+  // Do the download in five seconds
+  item->setUpdateTimerID( startTimer( 5000 ) );
 }
 
-void KOEditorFreeBusy::updateFreeBusyData( Attendee *attendee )
+void KOEditorFreeBusy::timerEvent( QTimerEvent* event )
 {
-  if( KOGroupware::instance() && attendee->name() != "(EmptyName)" ) {
-    FreeBusyManager *m = KOGroupware::instance()->freeBusyManager();
-    m->retrieveFreeBusy( attendee->email() );
+  killTimer( event->timerId() );
+  FreeBusyItem *item = static_cast<FreeBusyItem *>( mGanttView->firstChild() );
+  while( item ) {
+    if( item->updateTimerID() == event->timerId() ) {
+      item->setUpdateTimerID( 0 );
+      item->startDownload();
+      return;
+    }
+    item = static_cast<FreeBusyItem *>( item->nextSibling() );
   }
 }
 
@@ -378,7 +413,7 @@
 */
 
 void KOEditorFreeBusy::slotUpdateGanttView( QDateTime dtFrom, QDateTime dtTo )
-{ 
+{
   mDtStart = dtFrom;
   mDtEnd = dtTo;
   bool block = mGanttView->getUpdateEnabled( );
@@ -387,7 +422,7 @@
   mGanttView->setHorizonStart( horizonStart  );
   mGanttView->setHorizonEnd( dtTo.addDays( 15 ) );
   mGanttView->clearBackgroundColor();
-  mGanttView->setIntervalBackgroundColor( dtFrom, dtTo, Qt::magenta ); 
+  mGanttView->setIntervalBackgroundColor( dtFrom, dtTo, Qt::magenta );
   mGanttView->setUpdateEnabled( block );
   mGanttView->centerTimelineAfterShow( dtFrom );
 }
@@ -574,7 +609,7 @@
 
   FreeBusyItem *item = static_cast<FreeBusyItem *>( mGanttView->firstChild() );
   while( item ) {
-    updateFreeBusyData( item->attendee() );
+    updateFreeBusyData( item );
     item = static_cast<FreeBusyItem *>( item->nextSibling() );
   }
 }
@@ -585,7 +620,7 @@
   if ( !item ) return;
 
   Attendee *attendee = item->attendee();
-  
+
   FreeBusyUrlDialog dialog( attendee, this );
   dialog.exec();
 }
diff -urN -x CVS kdepim.orig/korganizer/koeditorfreebusy.h kdepim/korganizer/koeditorfreebusy.h
--- kdepim.orig/korganizer/koeditorfreebusy.h	Thu Sep  2 16:31:31 2004
+++ kdepim/korganizer/koeditorfreebusy.h	Wed Oct 13 14:35:44 2004
@@ -50,7 +50,7 @@
     void setUpdateEnabled( bool enabled );
     bool updateEnabled() const;
 
-    void insertAttendee( KCal::Attendee * );
+    void insertAttendee( KCal::Attendee *, bool readFBList );
     void removeAttendee( KCal::Attendee * );
     void updateAttendee( KCal::Attendee * );
     void clearAttendees();
@@ -79,11 +79,11 @@
 
     void reload();
 
-  private slots:
-    void updateFreeBusyData( KDGanttViewItem * );
+  protected:
+    void timerEvent( QTimerEvent* );
 
   private:
-    void updateFreeBusyData( KCal::Attendee * );
+    void updateFreeBusyData( FreeBusyItem * );
 
     bool findFreeSlot( QDateTime &dtFrom, QDateTime &dtTo );
     bool tryDate( QDateTime &tryFrom, QDateTime &tryTo );
diff -urN -x CVS kdepim.orig/korganizer/koeditorgeneral.cpp kdepim/korganizer/koeditorgeneral.cpp
--- kdepim.orig/korganizer/koeditorgeneral.cpp	Wed Jun 30 00:45:13 2004
+++ kdepim/korganizer/koeditorgeneral.cpp	Thu Oct  7 11:20:11 2004
@@ -198,6 +198,7 @@
 void KOEditorGeneral::pickAlarmSound()
 {
   QString prefix = KGlobal::dirs()->findResourceDir("data", "korganizer/sounds/alert.wav");
+  prefix += "/korganizer/sounds/alert.wav";
   if (!mAlarmSoundButton->isOn()) {
     mAlarmSound = "";
     QToolTip::remove(mAlarmSoundButton);
@@ -312,7 +313,7 @@
 
 #if 0
   // organizer information
-  mOwnerLabel->setText(i18n("Owner: ") + event->organizer());
+  mOwnerLabel->setText(i18n("Owner: ") + event->organizer().fullName() );
 #endif
 
   enableAlarmEdit( event->isAlarmEnabled() );
diff -urN -x CVS kdepim.orig/korganizer/koeventeditor.cpp kdepim/korganizer/koeventeditor.cpp
--- kdepim.orig/korganizer/koeventeditor.cpp	Wed Sep  8 16:03:38 2004
+++ kdepim/korganizer/koeventeditor.cpp	Thu Oct  7 11:20:11 2004
@@ -298,7 +298,8 @@
     return rc;
   } else {
     mEvent = new Event;
-    mEvent->setOrganizer( KOPrefs::instance()->email() );
+    mEvent->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                          KOPrefs::instance()->email() ) );
     writeEvent( mEvent );
     if ( KOPrefs::instance()->mUseGroupwareCommunication ) {
       if ( !KOGroupware::instance()->sendICalMessage( this,
@@ -340,7 +341,7 @@
   if (mEvent) {
     bool groupwareCheck = KOPrefs::instance()->mConfirm &&
           (!KOPrefs::instance()->mUseGroupwareCommunication ||
-           KOPrefs::instance()->thatIsMe( mEvent->organizer() ) );
+           KOPrefs::instance()->thatIsMe( mEvent->organizer().email() ) );
     if (!groupwareCheck || (msgItemDelete()==KMessageBox::Continue)) {
       // Either no groupware check needed, or OK pressed
       emit incidenceToBeDeleted(mEvent);
diff -urN -x CVS kdepim.orig/korganizer/koeventviewer.cpp kdepim/korganizer/koeventviewer.cpp
--- kdepim.orig/korganizer/koeventviewer.cpp	Wed Sep 15 15:54:53 2004
+++ kdepim/korganizer/koeventviewer.cpp	Thu Oct  7 11:20:11 2004
@@ -248,19 +248,7 @@
     // Add organizer link
     addTag( "h3", i18n("Organizer") );
     mText.append( "<ul>" );
-    QString name, email, organizer;
-    organizer = event->organizer();
-    if ( organizer.length() > 1 ) {
-      // If the organizer does not have a name, it looks like <foo@bar.org>
-      // which can not be shown in a rich text widget. Filter those <> out
-      if ( organizer[0] == '<' && organizer[organizer.length()-1] == '>' )
-        organizer = organizer.mid( 1, organizer.length() - 2 );
-    }
-    if ( KPIM::getNameAndMail( organizer, name, email ) )
-      linkPerson( email, name, "", iconPath );
-    else
-      // Doesn't seem to be a valid address. Just show whatever we have
-      mText += "<li>" + organizer + "</li>\n";
+    linkPerson( event->organizer().email(), event->organizer().fullName(), "", iconPath );
     mText += "</ul>";
 
     // Add attendees links
diff -urN -x CVS kdepim.orig/korganizer/kogroupware.cpp kdepim/korganizer/kogroupware.cpp
--- kdepim.orig/korganizer/kogroupware.cpp	Tue Aug 17 16:47:38 2004
+++ kdepim/korganizer/kogroupware.cpp	Thu Oct  7 11:59:24 2004
@@ -35,50 +35,20 @@
 */
 
 #include "kogroupware.h"
-
 #include "freebusymanager.h"
 #include "calendarview.h"
 #include "mailscheduler.h"
-#include "kogroupwareincomingdialog.h"
-#include "koviewmanager.h"
-#include "kocore.h"
-
+#include "koprefs.h"
 #include <libkdepim/email.h>
-#include <ktnef/ktnefparser.h>
-#include <ktnef/ktnefmessage.h>
-#include <ktnef/ktnefdefs.h>
-
-#include <libkcal/incidencebase.h>
 #include <libkcal/attendee.h>
-#include <libkcal/freebusy.h>
 #include <libkcal/journal.h>
-#include <libkcal/calendarlocal.h>
-#include <libkcal/icalformat.h>
-
-#include <kabc/phonenumber.h>
-#include <kabc/vcardconverter.h>
-
 #include <kdebug.h>
 #include <kmessagebox.h>
-#include <ktempfile.h>
-#include <kio/netaccess.h>
-#include <kapplication.h>
-#include <kconfig.h>
-#include <dcopclient.h>
-#include <dcopref.h>
 #include <kstandarddirs.h>
 #include <kdirwatch.h>
-
 #include <qfile.h>
-#include <qbuffer.h>
 #include <qregexp.h>
-
-#include <mimelib/enum.h>
-
-#include <stdlib.h>
-#include <time.h>
 #include <qdir.h>
-#include "koprefs.h"
 
 FreeBusyManager *KOGroupware::mFreeBusyManager = 0;
 
@@ -202,681 +172,6 @@
   mView->updateView();
 }
 
-static void vPartMicroParser( const QString& str, QString& s )
-{
-  QString line;
-  uint len = str.length();
-
-  for( uint i=0; i<len; ++i) {
-    if( str[i] == '\r' || str[i] == '\n' ) {
-      if( str[i] == '\r' )
-        ++i;
-      if( i+1 < len && str[i+1] == ' ' ) {
-        // Found a continuation line, skip it's leading blanc
-        ++i;
-      } else {
-        // Found a logical line end, process the line
-        if( line.startsWith( s ) ) {
-          s = line.mid( s.length() + 1 );
-          return;
-        }
-        line = "";
-      }
-    } else {
-      line += str[i];
-    }
-  }
-  s.truncate(0);
-}
-
-static void string2HTML( QString& str ) {
-  str.replace( QChar( '&' ), "&amp;" );
-  str.replace( QChar( '<' ), "&lt;" );
-  str.replace( QChar( '>' ), "&gt;" );
-  str.replace( QChar( '\"' ), "&quot;" );
-  str.replace( "\\n", "<br>" );
-  str.replace( "\\,", "," );
-}
-
-static QString meetingDetails( Incidence* incidence, Event* event )
-{
-  // Meeting details are formatted into an HTML table
-
-  QString html;
-
-  QString sSummary = i18n( "Summary unspecified" );
-  if ( incidence ) {
-    if ( ! incidence->summary().isEmpty() ) {
-      sSummary = incidence->summary();
-      string2HTML( sSummary );
-    }
-  }
-
-  QString sLocation = i18n( "Location unspecified" );
-  if ( incidence ) {
-    if ( ! incidence->location().isEmpty() ) {
-      sLocation = incidence->location();
-      string2HTML( sLocation );
-    }
-  }
-
-  QString dir = ( QApplication::reverseLayout() ? "rtl" : "ltr" );
-  html = QString("<div dir=\"%1\">\n").arg(dir);
-
-  html += "<table border=\"0\" cellpadding=\"1\" cellspacing=\"1\">\n";
-
-  // Meeting Summary Row
-  html += "<tr>";
-  html += "<td>" + i18n( "What:" ) + "</td>";
-  html += "<td>" + sSummary + "</td>";
-  html += "</tr>\n";
-
-  // Meeting Location Row
-  html += "<tr>";
-  html += "<td>" + i18n( "Where:" ) + "</td>";
-  html += "<td>" + sLocation + "</td>";
-  html += "</tr>\n";
-
-  // Meeting Start Time Row
-  html += "<tr>";
-  html += "<td>" + i18n( "Start Time:" ) + "</td>";
-  html += "<td>";
-  if ( ! event->doesFloat() ) {
-    html +=  i18n("%1: Start Date, %2: Start Time", "%1 %2")
-             .arg( event->dtStartDateStr(), event->dtStartTimeStr() );
-  } else {
-    html += i18n("%1: Start Date", "%1 (time unspecified)")
-            .arg( event->dtStartDateStr() );
-  }
-  html += "</td>";
-  html += "</tr>\n";
-
-  // Meeting End Time Row
-  html += "<tr>";
-  html += "<td>" + i18n( "End Time:" ) + "</td>";
-  html += "<td>";
-  if ( event->hasEndDate() ) {
-    if ( ! event->doesFloat() ) {
-      html +=  i18n("%1: End Date, %2: End Time", "%1 %2")
-               .arg( event->dtEndDateStr(), event->dtEndTimeStr() );
-    } else {
-      html += i18n("%1: End Date", "%1 (time unspecified)")
-              .arg( event->dtEndDateStr() );
-    }
-  } else {
-    html += i18n( "Unspecified" );
-  }
-  html += "</td>";
-  html += "</tr>\n";
-
-  // Meeting Duration Row
-  if ( !event->doesFloat() && event->hasEndDate() ) {
-    html += "<tr>";
-    QTime sDuration, t;
-    int secs = event->dtStart().secsTo( event->dtEnd() );
-    t = sDuration.addSecs( secs );
-    html += "<td>" + i18n( "Duration:" ) + "</td>";
-    html += "<td>";
-    if ( t.hour() > 0 ) {
-      html += i18n( "1 hour ", "%n hours ", t.hour() );
-    }
-    if ( t.minute() > 0 ) {
-      html += i18n( "1 minute ", "%n minutes ",  t.minute() );
-    }
-    html += "</td>";
-    html += "</tr>\n";
-  }
-
-  html += "</table>\n";
-  html += "</div>\n";
-
-  return html;
-}
-
-static QString taskDetails( Incidence* incidence )
-{
-  // Task details are formatted into an HTML table
-
-  QString html;
-
-  QString sSummary = i18n( "Summary unspecified" );
-  QString sDescr = i18n( "Description unspecified" );
-  if ( incidence ) {
-    if ( ! incidence->summary().isEmpty() ) {
-      sSummary = incidence->summary();
-    }
-    if ( ! incidence->description().isEmpty() ) {
-      sDescr = incidence->description();
-    }
-  }
-  html = "<table border=\"0\" cellpadding=\"1\" cellspacing=\"1\">\n";
-
-  // Task Summary Row
-  html += "<tr>";
-  html += "<td>" + i18n( "Summary:" ) + "</td>";
-  html += "<td>" + sSummary + "</td>";
-  html += "</tr>\n";
-
-  // Task Description Row
-  html += "<tr>";
-  html += "<td>" + i18n( "Description:" ) + "</td>";
-  html += "<td>" + sDescr + "</td>";
-  html += "</tr>\n";
-
-  html += "</table>\n";
-
-  return html;
-}
-
-QString KOGroupware::formatICal( const QString& iCal )
-{
-  KCal::CalendarLocal cl( mCalendar->timeZoneId() );
-  ICalFormat format;
-  format.fromString( &cl, iCal );
-
-  // Make a shallow copy of the event and task lists
-  if( cl.events().count() == 0 && cl.todos().count() == 0 ) {
-    kdDebug(5850) << "No iCal in this one\n";
-    return QString();
-  }
-
-  // Parse the first event out of the vcal
-  // TODO: Is it legal to have several events/todos per mail part?
-  Incidence* incidence = 0;
-  Event* event = 0;
-  Todo* todo = 0;
-  if( cl.events().count() > 0 )
-    incidence = event = cl.events().first();
-  else
-    incidence = todo = cl.todos().first();
-
-  // TODO: Actually the scheduler needs to do this:
-  QString sMethod; // = incidence->method();
-  // TODO: This is a temporary workaround to get the method
-  sMethod = "METHOD";
-  vPartMicroParser( iCal, sMethod );
-  sMethod = sMethod.lower();
-
-  // First make the text of the message
-  QString html;
-  if( sMethod == "request" ) {
-    if( event ) {
-      html = i18n( "<h2>You have been invited to this meeting</h2>" );
-      html += meetingDetails( incidence, event );
-    } else {
-      html = i18n( "<h2>You have been assigned this task</h2>" );
-      html += taskDetails( incidence );
-    }
-  } else if( sMethod == "reply" ) {
-    Attendee::List attendees = incidence->attendees();
-    if( attendees.count() == 0 ) {
-      kdDebug(5850) << "No attendees in the iCal reply!\n";
-      return QString();
-    }
-    if( attendees.count() != 1 )
-      kdDebug(5850) << "Warning: attendeecount in the reply should be 1 "
-                    << "but is " << attendees.count() << endl;
-    Attendee* attendee = *attendees.begin();
-
-    switch( attendee->status() ) {
-    case Attendee::Accepted:
-      if( event ) {
-        html = i18n( "<h2>Sender accepts this meeting invitation</h2>" );
-        html += meetingDetails( incidence, event );
-      } else {
-        html = i18n( "<h2>Sender accepts this task</h2>" );
-        html += taskDetails( incidence );
-      }
-      break;
-
-    case Attendee::Tentative:
-      if( event ) {
-        html = i18n( "<h2>Sender tentatively accepts this "
-                     "meeting invitation</h2>" );
-        html += meetingDetails( incidence, event );
-      } else {
-        html = i18n( "<h2>Sender tentatively accepts this task</h2>" );
-        html += taskDetails( incidence );
-      }
-      break;
-
-    case Attendee::Declined:
-      if( event ) {
-        html = i18n( "<h2>Sender declines this meeting invitation</h2>" );
-        html += meetingDetails( incidence, event );
-      } else {
-        html = i18n( "<h2>Sender declines this task</h2>" );
-        html += taskDetails( incidence );
-      }
-      break;
-
-    default:
-      if( event ) {
-        html = i18n( "<h2>Unknown response to this meeting invitation</h2>" );
-        html += meetingDetails( incidence, event );
-      } else {
-        html = i18n( "<h2>Unknown response to this task</h2>" );
-        html += taskDetails( incidence );
-      }
-    }
-  } else if( sMethod == "cancel" ) {
-    if( event ) {
-      html = i18n( "<h2>This meeting has been canceled</h2>" );
-      html += meetingDetails( incidence, event );
-    } else {
-      html = i18n( "<h2>This task was canceled</h2>" );
-      html += taskDetails( incidence );
-    }
-  }
-
-  // Add the groupware URLs
-  html += "<br>&nbsp;<br>&nbsp;<br>";
-  html += "<table border=\"0\" cellspacing=\"0\"><tr><td>&nbsp;</td><td>";
-  if( sMethod == "request" || sMethod == "update" ) {
-    // Accept
-    html += "<a href=\"kmail:groupware_request_accept\"><b>";
-    html += i18n( "[Accept]" );
-    html += "</b></a></td><td> &nbsp; </td><td>";
-    // Accept conditionally
-    html += "<a href=\"kmail:groupware_request_accept conditionally\"><b>";
-    html += i18n( "Accept conditionally", "[Accept cond.]" );
-    html += "</b></a></td><td> &nbsp; </td><td>";
-    // Decline
-    html += "<a href=\"kmail:groupware_request_decline\"><b>";
-    html += i18n( "[Decline]" );
-    if( event ) {
-      // Check my calendar...
-      html += "</b></a></td><td> &nbsp; </td><td>";
-      html += "<a href=\"kmail:groupware_request_check\"><b>";
-      html += i18n("[Check my calendar...]" );
-    }
-  } else if( sMethod == "reply" ) {
-    // Enter this into my calendar
-    html += "<a href=\"kmail:groupware_reply#%1\"><b>";
-    if( event )
-      html += i18n( "[Enter this into my calendar]" );
-    else
-      html += i18n( "[Enter this into my task list]" );
-  } else if( sMethod == "cancel" ) {
-    // Cancel event from my calendar
-    html += "<a href=\"kmail:groupware_cancel\"><b>";
-    html += i18n( "[Remove this from my calendar]" );
-  }
-  html += "</b></a></td></tr></table>";
-
-  QString sDescr = incidence->description();
-  if( ( sMethod == "request" || sMethod == "cancel" ) && !sDescr.isEmpty() ) {
-    string2HTML( sDescr );
-    html += "<br>&nbsp;<br>&nbsp;<br><u>" + i18n("Description:")
-      + "</u><br><table border=\"0\"><tr><td>&nbsp;</td><td>";
-    html += sDescr + "</td></tr></table>";
-  }
-  html += "&nbsp;<br>&nbsp;<br><u>" + i18n( "Original message:" ) + "</u>";
-
-  return html;
-}
-
-QString KOGroupware::formatTNEF( const QByteArray& tnef )
-{
-  QString vPart = msTNEFToVPart( tnef );
-  QString iCal = formatICal( vPart );
-  if( !iCal.isEmpty() )
-    return iCal;
-  return vPart;
-}
-
-bool KOGroupware::incomingEventRequest( const QString& request,
-                                        const QString& receiver,
-                                        const QString& vCalIn )
-{
-  // This was the code to accept a choice from KMail. Needs porting
-  EventState state;
-  if( request == "accept" )
-    state = Accepted;
-  else if( request == "accept conditionally" )
-    state = ConditionallyAccepted;
-  else if( request == "decline" )
-    state = Declined;
-  else if( request == "check" )
-    state = Request;
-  else
-    return false;
-
-  // Parse the event request into a ScheduleMessage; this needs to
-  // be done in any case.
-  KCal::ScheduleMessage *message = mFormat.parseScheduleMessage( mCalendar,
-                                                                 vCalIn );
-  if( message ) {
-    kdDebug(5850) << "KOGroupware::incomingEventRequest: got message '"
-                  << vCalIn << "'" << endl;
-  } else {
-    QString errorMessage;
-    if( mFormat.exception() ) {
-      errorMessage = mFormat.exception()->message();
-    }
-    kdDebug(5850) << "KOGroupware::incomingEventRequest() Error parsing "
-                  << "message: " << errorMessage << endl;
-    // If the message was broken, there's nothing we can do.
-    return false;
-  }
-
-  KCal::Incidence* event = dynamic_cast<KCal::Incidence*>( message->event() );
-  Q_ASSERT( event );
-  if( !event ) { // something bad happened, just to be safe
-    kdDebug(5850) << "KOGroupware::incomingEventRequest(): Not an event???\n";
-    return false;
-  }
-
-  // Now check if the event needs to be accepted or if this is
-  // already done.
-  if( state == Request ) {
-    // Need to accept, present it to the user
-    KOGroupwareIncomingDialog dlg( event );
-    int ret = dlg.exec();
-    if( ret == QDialog::Rejected ) {
-      // User declined to make a choice, we can't send a vCal back
-      kdDebug(5850) << "KOGroupware::incomingEventRequest(): User canceled\n";
-      return false;
-    }
-
-    if( dlg.isDeclined() )
-      state = Declined;
-    else if( dlg.isConditionallyAccepted() )
-      state = ConditionallyAccepted;
-    else if( dlg.isAccepted() )
-      state = Accepted;
-    else
-      kdDebug(5850) << "KOGroupware::incomingEventRequest(): unknown "
-                                        << "event request state" << endl;
-  }
-
-  // If the event has an alarm, make sure it doesn't have a negative time.
-  // This is yet another OL workaround
-#if 0
-  // PENDING(bo): Disabled for now, until I figure out how the old offset
-  // matches the two new offsets
-  Alarm::List alarms = event->alarms();
-  Alarm::List::ConstIterator it;
-  for ( it = alarms.begin(); it != alarms.end(); ++it) {
-    if ( (*it)->hasTime() ) {
-      QDateTime t = (*it)->time();
-      int offset = event->dtStart().secsTo( t );
-      if( offset > 0 )
-       // PENDING(Bo): Not implemented yet
-       kdDebug(5850) << "Warning: Alarm fires after the event\n";
-    } else {
-      int offset = (*it)->offset().asSeconds();
-      if( offset > 0 ) {
-       // This number should be negative so the alarm fires before the event
-       Duration d( -offset );
-       (*it)->setOffset( d );
-      }
-    }
-  }
-#endif
-
-  // Enter the event into the calendar. We just create a
-  // Scheduler, because all the code we need is already there. We
-  // take an MailScheduler, because we need a concrete one, but we
-  // really only want code from Scheduler.
-  // PENDING(kalle) Handle tentative acceptance differently.
-  KCal::MailScheduler scheduler( mCalendar );
-  if( state == Accepted || state == ConditionallyAccepted ) {
-    scheduler.acceptTransaction( event,
-                                 (KCal::Scheduler::Method)message->method(),
-                                 message->status() );
-    mView->updateView();
-  }
-
-  KCal::Attendee::List attendees = event->attendees();
-  KCal::Attendee::List::ConstIterator it;
-  KCal::Attendee* myself = 0;
-  // Find myself, there will always be all attendees listed, even if
-  // only I need to answer it.
-  for ( it = attendees.begin(); it != attendees.end(); ++it ) {
-    if( (*it)->email() == receiver ) {
-      // We are the current one, and even the receiver, note
-      // this and quit searching.
-      myself = (*it);
-      break;
-    }
-
-    if ( KOPrefs::instance()->thatIsMe( (*it)->email() ) ) {
-      // If we are the current one, note that. Still continue to
-      // search in case we find the receiver himself.
-      myself = (*it);
-    }
-  }
-
-  Q_ASSERT( myself );
-
-  KCal::Attendee* newMyself = 0;
-  if( myself ) {
-    switch( state ) {
-    case Accepted:
-      myself->setStatus( KCal::Attendee::Accepted );
-      break;
-    case ConditionallyAccepted:
-      myself->setStatus( KCal::Attendee::Tentative );
-      break;
-    case Declined:
-      myself->setStatus( KCal::Attendee::Declined );
-      break;
-    default:
-      ;
-    };
-
-    // No more request response
-    myself->setRSVP(false);
-
-    event->updated();
-
-    newMyself = new KCal::Attendee( myself->name(),
-                                    receiver.isEmpty() ?
-                                    myself->email() :
-                                    receiver,
-                                    myself->RSVP(),
-                                    myself->status(),
-                                    myself->role(),
-                                    myself->uid() );
-  }
-
-  event->updated();
-
-  // Send back the answer; construct it on the base of state. We
-  // make a clone of the event since we need to manipulate it here.
-  // NOTE: This contains a workaround around a libkcal bug: REPLY
-  // vCals may not have more than one ATTENDEE (as libical correctly
-  // specifies), but libkcal always writes out all the ATTENDEEs,
-  // thus producing invalid vCals. We make a clone of the vEvent
-  // here and remove all attendees except ourselves.
-  Incidence* newIncidence = event->clone();
-  Event* newEvent = static_cast<KCal::Event*>( newIncidence );
-
-#if 0
-  // OL compatibility thing. To be ported.
-  // The problem is that OL is braindead when it comes to receiving
-  // events that mention alarms. So strip them before sending to OL
-  // people
-  bool stripAlarms = false;
-  emit getStripAlarmsForSending( stripAlarms );
-  if( stripAlarms )
-    // Strip alarms from the send
-    newEvent->clearAlarms();
-#endif
-
-  newEvent->clearAttendees();
-  if( newMyself )
-    newEvent->addAttendee( newMyself );
-
-  // Create the outgoing vCal
-  QString messageText =
-    mFormat.createScheduleMessage( newEvent, KCal::Scheduler::Reply );
-  scheduler.performTransaction( newEvent, KCal::Scheduler::Reply );
-
-  // Fix broken OL appointments
-  if( vCalIn.contains( "PRODID:-//Microsoft" ) ) {
-    // OL doesn't send the organizer as an attendee as it should
-    Attendee* organizer = new KCal::Attendee( i18n("Organizer"),
-                                             event->organizer(), false,
-                                             KCal::Attendee::Accepted );
-    event->addAttendee( organizer );
-  }
-
-  kdDebug(5850) << "Done" << endl;
-  return true;
-}
-
-/*!
-  This method processes resource requests. KMail has at this point
-  already decided whether the request should be accepted or declined.
-*/
-void KOGroupware::incomingResourceRequest( const QValueList<QPair<QDateTime,
-                                           QDateTime> >& busy,
-                                           const QCString& resource,
-                                           const QString& vCalIn,
-                                           bool& vCalInOK,
-                                           QString& vCalOut,
-                                           bool& vCalOutOK,
-                                           bool& isFree,
-                                           QDateTime& start,
-                                           QDateTime& end )
-{
-  // Parse the event request into a ScheduleMessage; this needs to
-  // be done in any case.
-  KCal::ScheduleMessage *message = mFormat.parseScheduleMessage( mCalendar,
-                                                                 vCalIn );
-  if( message )
-    vCalInOK = true;
-  else {
-    QString errorMessage;
-    if( mFormat.exception() ) {
-      errorMessage = mFormat.exception()->message();
-    }
-    kdDebug(5850) << "KOGroupware::incomingResourceRequest() Error parsing "
-      "message: " << errorMessage << endl;
-    vCalInOK = false;
-    // If the message was broken, there's nothing we can do.
-    return;
-  }
-
-  KCal::Event* event = dynamic_cast<KCal::Event*>( message->event() );
-  Q_ASSERT( event );
-  if( !event ) {
-    // Something has gone badly wrong
-    vCalInOK = false;
-    return;
-  }
-
-  // Now find out whether the resource is free at the requested
-  // time, take the opportunity to assign the reference parameters.
-  start = event->dtStart();
-  end = event->dtEnd();
-  isFree = true;
-  QValueList<QPair<QDateTime, QDateTime> >::ConstIterator it;
-  for( it = busy.begin(); it != busy.end(); ++it ) {
-    if( (*it).second <= start || (*it).first >= end )
-      // Busy period ends before try period or starts after try period
-      continue;
-    else {
-      isFree = false;
-      break; // no need to search further
-    }
-  }
-
-  // Send back the answer; construct it on the base of state
-  KCal::Attendee::List attendees = event->attendees();
-  KCal::Attendee* resourceAtt = 0;
-
-  // Find the resource addresse, there will always be all attendees
-  // listed, even if only one needs to answer it.
-  KCal::Attendee::List::ConstIterator it2;
-  for( it2 = attendees.begin(); it2 != attendees.end(); ++it2 ) {
-    if( (*it2)->email().utf8() == resource ) {
-      resourceAtt = *it2;
-      break;
-    }
-  }
-  Q_ASSERT( resourceAtt );
-  if( resourceAtt ) {
-    if( isFree )
-      resourceAtt->setStatus( KCal::Attendee::Accepted );
-    else
-      resourceAtt->setStatus( KCal::Attendee::Declined );
-  } else {
-    vCalOutOK = false;
-    return;
-  }
-
-  // Create the outgoing vCal
-  QString messageText =
-    mFormat.createScheduleMessage( event, KCal::Scheduler::Reply );
-  // kdDebug(5850) << "Sending vCal back to KMail: " << messageText << endl;
-  vCalOut = messageText;
-  vCalOutOK = true;
-  return;
-}
-
-
-/*!
-  This method is called when the user has invited people and is now
-  receiving the answers to the invitation.
-*/
-bool KOGroupware::incidenceAnswer( const QString& vCal )
-{
-  // Parse the event reply
-  KCal::ScheduleMessage *message = mFormat.parseScheduleMessage( mCalendar,
-                                                                 vCal );
-  if( !message ) {
-    // a parse error of some sort
-    KMessageBox::
-      error( mView,
-             i18n( "<b>There was a problem parsing the iCal data:</b><br>%1" )
-             .arg( mFormat.exception()->message() ) );
-    return false;
-  }
-
-  KCal::IncidenceBase* incidence = message->event();
-
-  // Enter the answer into the calendar.
-  QString uid = incidence->uid();
-  KCal::MailScheduler scheduler( mCalendar );
-  if( !scheduler.acceptTransaction( incidence,
-                                    (KCal::Scheduler::Method)message->method(),
-                                    message->status() ) ) {
-    KMessageBox::error( mView, i18n("Scheduling failed") );
-    return false;
-  }
-
-  mView->updateView();
-  return true;
-}
-
-bool KOGroupware::cancelIncidence( const QString& iCal )
-{
-  // Parse the event reply
-  KCal::ScheduleMessage *message = mFormat.parseScheduleMessage( mCalendar,
-                                                                 iCal );
-  if( !message ) {
-    // a parse error of some sort
-    KMessageBox::
-      error( mView,
-             i18n( "<b>There was a problem parsing the iCal data:</b><br>%1" )
-             .arg( mFormat.exception()->message() ) );
-    return false;
-  }
-
-  KCal::IncidenceBase* incidence = message->event();
-
-  // Enter the answer into the calendar.
-  Event* event = mCalendar->event( incidence->uid() );
-  if( !event )
-    return false;
-
-  mCalendar->deleteEvent( event );
-  return true;
-}
-
 /* This function sends mails if necessary, and makes sure the user really
  * want to change his calendar.
  *
@@ -887,7 +182,7 @@
                                    KCal::Scheduler::Method method,
                                    Incidence* incidence, bool isDeleting )
 {
-  bool isOrganizer = KOPrefs::instance()->thatIsMe( incidence->organizer() );
+  bool isOrganizer = KOPrefs::instance()->thatIsMe( incidence->organizer().email() );
 
   int rc = 0;
   if( isOrganizer ) {
@@ -964,439 +259,4 @@
 }
 
 
-//-----------------------------------------------------------------------------
-
-static QString stringProp( KTNEFMessage* tnefMsg, const Q_UINT32& key,
-                           const QString& fallback = QString::null)
-{
-  return tnefMsg->findProp( key < 0x10000 ? key & 0xFFFF : key >> 16,
-                            fallback );
-}
-
-static QString sNamedProp( KTNEFMessage* tnefMsg, const QString& name,
-                           const QString& fallback = QString::null )
-{
-  return tnefMsg->findNamedProp( name, fallback );
-}
-
-struct save_tz { char* old_tz; char* tz_env_str; };
-
-/* temporarily go to a different timezone */
-static struct save_tz set_tz( const char* _tc )
-{
-  const char *tc = _tc?_tc:"UTC";
-
-  struct save_tz rv;
-
-  rv.old_tz = 0;
-  rv.tz_env_str = 0;
-
-  //kdDebug(5006) << "set_tz(), timezone before = " << timezone << endl;
-
-  char* tz_env = 0;
-  if( getenv( "TZ" ) ) {
-    tz_env = strdup( getenv( "TZ" ) );
-    rv.old_tz = tz_env;
-  }
-  char* tmp_env = (char*)malloc( strlen( tc ) + 4 );
-  strcpy( tmp_env, "TZ=" );
-  strcpy( tmp_env+3, tc );
-  putenv( tmp_env );
-
-  rv.tz_env_str = tmp_env;
-
-  /* tmp_env is not free'ed -- it is part of the environment */
-
-  tzset();
-  //kdDebug(5006) << "set_tz(), timezone after = " << timezone << endl;
-
-  return rv;
-}
-
-/* restore previous timezone */
-static void unset_tz( struct save_tz old_tz )
-{
-  if( old_tz.old_tz ) {
-    char* tmp_env = (char*)malloc( strlen( old_tz.old_tz ) + 4 );
-    strcpy( tmp_env, "TZ=" );
-    strcpy( tmp_env+3, old_tz.old_tz );
-    putenv( tmp_env );
-    /* tmp_env is not free'ed -- it is part of the environment */
-    free( old_tz.old_tz );
-  } else {
-    /* clear TZ from env */
-    putenv( strdup("TZ") );
-  }
-  tzset();
-
-  /* is this OK? */
-  if( old_tz.tz_env_str ) free( old_tz.tz_env_str );
-}
-
-static QDateTime utc2Local( const QDateTime& utcdt )
-{
-  struct tm tmL;
-
-  save_tz tmp_tz = set_tz("UTC");
-  time_t utc = utcdt.toTime_t();
-  unset_tz( tmp_tz );
-
-  localtime_r( &utc, &tmL );
-  return QDateTime( QDate( tmL.tm_year+1900, tmL.tm_mon+1, tmL.tm_mday ),
-                    QTime( tmL.tm_hour, tmL.tm_min, tmL.tm_sec ) );
-}
-
-static QDateTime pureISOToLocalQDateTime( const QString& dtStr,
-                                          bool bDateOnly = false )
-{
-  QDate tmpDate;
-  QTime tmpTime;
-  int year, month, day, hour, minute, second;
-
-  if( bDateOnly ) {
-    year = dtStr.left( 4 ).toInt();
-    month = dtStr.mid( 4, 2 ).toInt();
-    day = dtStr.mid( 6, 2 ).toInt();
-    hour = 0;
-    minute = 0;
-    second = 0;
-  } else {
-    year = dtStr.left( 4 ).toInt();
-    month = dtStr.mid( 4, 2 ).toInt();
-    day = dtStr.mid( 6, 2 ).toInt();
-    hour = dtStr.mid( 9, 2 ).toInt();
-    minute = dtStr.mid( 11, 2 ).toInt();
-    second = dtStr.mid( 13, 2 ).toInt();
-  }
-  tmpDate.setYMD( year, month, day );
-  tmpTime.setHMS( hour, minute, second );
-
-  if( tmpDate.isValid() && tmpTime.isValid() ) {
-    QDateTime dT = QDateTime( tmpDate, tmpTime );
-
-    if( !bDateOnly ) {
-      // correct for GMT ( == Zulu time == UTC )
-      if (dtStr.at(dtStr.length()-1) == 'Z') {
-        //dT = dT.addSecs( 60 * KRFCDate::localUTCOffset() );
-        //localUTCOffset( dT ) );
-        dT = utc2Local( dT );
-      }
-    }
-    return dT;
-  } else
-    return QDateTime();
-}
-
-QString KOGroupware::msTNEFToVPart( const QByteArray& tnef )
-{
-  bool bOk = false;
-
-  KTNEFParser parser;
-  QBuffer buf( tnef );
-  CalendarLocal cal;
-  KABC::Addressee addressee;
-  KABC::VCardConverter cardConv;
-  ICalFormat calFormat;
-  Event* event = new Event();
-
-  if( parser.openDevice( &buf ) ) {
-    KTNEFMessage* tnefMsg = parser.message();
-    //QMap<int,KTNEFProperty*> props = parser.message()->properties();
-
-    // Everything depends from property PR_MESSAGE_CLASS
-    // (this is added by KTNEFParser):
-    QString msgClass = tnefMsg->findProp( 0x001A, QString::null, true )
-      .upper();
-    if( !msgClass.isEmpty() ) {
-      // Match the old class names that might be used by Outlook for
-      // compatibility with Microsoft Mail for Windows for Workgroups 3.1.
-      bool bCompatClassAppointment = false;
-      bool bCompatMethodRequest = false;
-      bool bCompatMethodCancled = false;
-      bool bCompatMethodAccepted = false;
-      bool bCompatMethodAcceptedCond = false;
-      bool bCompatMethodDeclined = false;
-      if( msgClass.startsWith( "IPM.MICROSOFT SCHEDULE." ) ) {
-        bCompatClassAppointment = true;
-        if( msgClass.endsWith( ".MTGREQ" ) )
-          bCompatMethodRequest = true;
-        if( msgClass.endsWith( ".MTGCNCL" ) )
-          bCompatMethodCancled = true;
-        if( msgClass.endsWith( ".MTGRESPP" ) )
-          bCompatMethodAccepted = true;
-        if( msgClass.endsWith( ".MTGRESPA" ) )
-          bCompatMethodAcceptedCond = true;
-        if( msgClass.endsWith( ".MTGRESPN" ) )
-          bCompatMethodDeclined = true;
-      }
-      bool bCompatClassNote = ( msgClass == "IPM.MICROSOFT MAIL.NOTE" );
-
-      if( bCompatClassAppointment || "IPM.APPOINTMENT" == msgClass ) {
-        // Compose a vCal
-        bool bIsReply = false;
-        QString prodID = "-//Microsoft Corporation//Outlook ";
-        prodID += tnefMsg->findNamedProp( "0x8554", "9.0" );
-        prodID += "MIMEDIR/EN\n";
-        prodID += "VERSION:2.0\n";
-        calFormat.setApplication( "Outlook", prodID );
-
-        Scheduler::Method method;
-        if( bCompatMethodRequest )
-          method = Scheduler::Request;
-        else if( bCompatMethodCancled )
-          method = Scheduler::Cancel;
-        else if( bCompatMethodAccepted || bCompatMethodAcceptedCond ||
-                 bCompatMethodDeclined ) {
-          method = Scheduler::Reply;
-          bIsReply = true;
-        } else {
-          // pending(khz): verify whether "0x0c17" is the right tag ???
-          //
-          // at the moment we think there are REQUESTS and UPDATES
-          //
-          // but WHAT ABOUT REPLIES ???
-          //
-          //
-
-          if( tnefMsg->findProp(0x0c17) == "1" )
-            bIsReply = true;
-          method = Scheduler::Request;
-        }
-
-        /// ###  FIXME Need to get this attribute written
-        ScheduleMessage schedMsg(event, method, ScheduleMessage::Unknown );
-
-        QString sSenderSearchKeyEmail( tnefMsg->findProp( 0x0C1D ) );
-
-        if( !sSenderSearchKeyEmail.isEmpty() ) {
-          int colon = sSenderSearchKeyEmail.find( ':' );
-          // May be e.g. "SMTP:KHZ@KDE.ORG"
-          if( sSenderSearchKeyEmail.find( ':' ) == -1 )
-            sSenderSearchKeyEmail.remove( 0, colon+1 );
-        }
-
-        QString s( tnefMsg->findProp( 0x0e04 ) );
-        QStringList attendees = QStringList::split( ';', s );
-        if( attendees.count() ) {
-          for( QStringList::Iterator it = attendees.begin();
-               it != attendees.end(); ++it ) {
-            // Skip all entries that have no '@' since these are
-            // no mail addresses
-            if( (*it).find('@') == -1 ) {
-              s = (*it).stripWhiteSpace();
-
-              Attendee *attendee = new Attendee( s, s, true );
-              if( bIsReply ) {
-                if( bCompatMethodAccepted )
-                  attendee->setStatus( Attendee::Accepted );
-                if( bCompatMethodDeclined )
-                  attendee->setStatus( Attendee::Declined );
-                if( bCompatMethodAcceptedCond )
-                  attendee->setStatus(Attendee::Tentative);
-              } else {
-                attendee->setStatus( Attendee::NeedsAction );
-                attendee->setRole( Attendee::ReqParticipant );
-              }
-              event->addAttendee(attendee);
-            }
-          }
-        } else {
-          // Oops, no attendees?
-          // This must be old style, let us use the PR_SENDER_SEARCH_KEY.
-          s = sSenderSearchKeyEmail;
-          if( !s.isEmpty() ) {
-            Attendee *attendee = new Attendee( QString::null, QString::null,
-                                               true );
-            if( bIsReply ) {
-              if( bCompatMethodAccepted )
-                attendee->setStatus( Attendee::Accepted );
-              if( bCompatMethodAcceptedCond )
-                attendee->setStatus( Attendee::Declined );
-              if( bCompatMethodDeclined )
-                attendee->setStatus( Attendee::Tentative );
-            } else {
-              attendee->setStatus(Attendee::NeedsAction);
-              attendee->setRole(Attendee::ReqParticipant);
-            }
-            event->addAttendee(attendee);
-          }
-        }
-        s = tnefMsg->findProp( 0x0c1f ); // look for organizer property
-        if( s.isEmpty() && !bIsReply )
-          s = sSenderSearchKeyEmail;
-        if( !s.isEmpty() )
-          event->setOrganizer( s );
-
-        s = tnefMsg->findProp( 0x8516 ).replace( QChar( '-' ), QString::null )
-          .replace( QChar( ':' ), QString::null );
-        event->setDtStart( QDateTime::fromString( s ) ); // ## Format??
-
-        s = tnefMsg->findProp( 0x8517 ).replace( QChar( '-' ), QString::null )
-          .replace( QChar( ':' ), QString::null );
-        event->setDtEnd( QDateTime::fromString( s ) );
-
-        s = tnefMsg->findProp( 0x8208 );
-        event->setLocation( s );
-
-        // is it OK to set this to OPAQUE always ??
-        //vPart += "TRANSP:OPAQUE\n"; ###FIXME, portme!
-        //vPart += "SEQUENCE:0\n";
-
-        // is "0x0023" OK  -  or should we look for "0x0003" ??
-        s = tnefMsg->findProp( 0x0023 );
-        event->setUid( s );
-
-        // PENDING(khz): is this value in local timezone? Must it be
-        // adjusted? Most likely this is a bug in the server or in
-        // Outlook - we ignore it for now.
-        s = tnefMsg->findProp( 0x8202 ).replace( QChar( '-' ), QString::null )
-          .replace( QChar( ':' ), QString::null );
-        // ### libkcal always uses currentDateTime()
-        // event->setDtStamp(QDateTime::fromString(s));
-
-        s = tnefMsg->findNamedProp( "Keywords" );
-        event->setCategories( s );
-
-        s = tnefMsg->findProp( 0x1000 );
-        event->setDescription( s );
-
-        s = tnefMsg->findProp( 0x0070 );
-        event->setSummary( s );
-
-        s = tnefMsg->findProp( 0x0026 );
-        event->setPriority( s.toInt() );
-
-        // is reminder flag set ?
-        if(!tnefMsg->findProp(0x8503).isEmpty()) {
-          Alarm *alarm = new Alarm(event);
-          QDateTime highNoonTime =
-            pureISOToLocalQDateTime( tnefMsg->findProp( 0x8502 )
-                                     .replace( QChar( '-' ), "" )
-                                     .replace( QChar( ':' ), "" ) );
-          QDateTime wakeMeUpTime =
-            pureISOToLocalQDateTime( tnefMsg->findProp( 0x8560, "" )
-                                     .replace( QChar( '-' ), "" )
-                                     .replace( QChar( ':' ), "" ) );
-          alarm->setTime(wakeMeUpTime);
-
-          if( highNoonTime.isValid() && wakeMeUpTime.isValid() )
-            alarm->setStartOffset( Duration( highNoonTime, wakeMeUpTime ) );
-          else
-            // default: wake them up 15 minutes before the appointment
-            alarm->setStartOffset( Duration( 15*60 ) );
-          alarm->setDisplayAlarm( i18n( "Reminder" ) );
-
-          // Sorry: the different action types are not known (yet)
-          //        so we always set 'DISPLAY' (no sounds, no images...)
-          event->addAlarm( alarm );
-        }
-        cal.addEvent( event );
-        bOk = true;
-        // we finished composing a vCal
-      } else if( bCompatClassNote || "IPM.CONTACT" == msgClass ) {
-        addressee.setUid( stringProp( tnefMsg, attMSGID ) );
-        addressee.setFormattedName( stringProp( tnefMsg, MAPI_TAG_PR_DISPLAY_NAME ) );
-        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL1EMAILADDRESS ), true );
-        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL2EMAILADDRESS ), false );
-        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL3EMAILADDRESS ), false );
-        addressee.insertCustom( "KADDRESSBOOK", "X-IMAddress", sNamedProp( tnefMsg, MAPI_TAG_CONTACT_IMADDRESS ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-SpousesName", stringProp( tnefMsg, MAPI_TAG_PR_SPOUSE_NAME ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-ManagersName", stringProp( tnefMsg, MAPI_TAG_PR_MANAGER_NAME ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-AssistantsName", stringProp( tnefMsg, MAPI_TAG_PR_ASSISTANT ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-Department", stringProp( tnefMsg, MAPI_TAG_PR_DEPARTMENT_NAME ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-Office", stringProp( tnefMsg, MAPI_TAG_PR_OFFICE_LOCATION ) );
-        addressee.insertCustom( "KADDRESSBOOK", "X-Profession", stringProp( tnefMsg, MAPI_TAG_PR_PROFESSION ) );
-
-        QString s = tnefMsg->findProp( MAPI_TAG_PR_WEDDING_ANNIVERSARY )
-          .replace( QChar( '-' ), QString::null )
-          .replace( QChar( ':' ), QString::null );
-        if( !s.isEmpty() )
-          addressee.insertCustom( "KADDRESSBOOK", "X-Anniversary", s );
-
-        addressee.setUrl( KURL( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_WEBPAGE )  ) );
-
-        // collect parts of Name entry
-        addressee.setFamilyName( stringProp( tnefMsg, MAPI_TAG_PR_SURNAME ) );
-        addressee.setGivenName( stringProp( tnefMsg, MAPI_TAG_PR_GIVEN_NAME ) );
-        addressee.setAdditionalName( stringProp( tnefMsg, MAPI_TAG_PR_MIDDLE_NAME ) );
-        addressee.setPrefix( stringProp( tnefMsg, MAPI_TAG_PR_DISPLAY_NAME_PREFIX ) );
-        addressee.setSuffix( stringProp( tnefMsg, MAPI_TAG_PR_GENERATION ) );
-
-        addressee.setNickName( stringProp( tnefMsg, MAPI_TAG_PR_NICKNAME ) );
-        addressee.setRole( stringProp( tnefMsg, MAPI_TAG_PR_TITLE ) );
-        addressee.setOrganization( stringProp( tnefMsg, MAPI_TAG_PR_COMPANY_NAME ) );
-        /*
-        the MAPI property ID of this (multiline) )field is unknown:
-        vPart += stringProp(tnefMsg, "\n","NOTE", ... , "" );
-        */
-
-        KABC::Address adr;
-        adr.setPostOfficeBox( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_PO_BOX ) );
-        adr.setStreet( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_STREET ) );
-        adr.setLocality( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_CITY ) );
-        adr.setRegion( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_STATE_OR_PROVINCE ) );
-        adr.setPostalCode( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_POSTAL_CODE ) );
-        adr.setCountry( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_COUNTRY ) );
-        adr.setType(KABC::Address::Home);
-        addressee.insertAddress(adr);
-
-        adr.setPostOfficeBox( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSPOBOX ) );
-        adr.setStreet( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSSTREET ) );
-        adr.setLocality( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSCITY ) );
-        adr.setRegion( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSSTATE ) );
-        adr.setPostalCode( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSPOSTALCODE ) );
-        adr.setCountry( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSCOUNTRY ) );
-        adr.setType( KABC::Address::Work );
-        addressee.insertAddress( adr );
-
-        adr.setPostOfficeBox( stringProp( tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_PO_BOX ) );
-        adr.setStreet( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_STREET ) );
-        adr.setLocality( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_CITY ) );
-        adr.setRegion( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_STATE_OR_PROVINCE ) );
-        adr.setPostalCode( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_POSTAL_CODE ) );
-        adr.setCountry( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_COUNTRY ) );
-        adr.setType( KABC::Address::Dom );
-        addressee.insertAddress(adr);
-
-        // problem: the 'other' address was stored by KOrganizer in
-        //          a line looking like the following one:
-        // vPart += "\nADR;TYPE=dom;TYPE=intl;TYPE=parcel;TYPE=postal;TYPE=work;TYPE=home:other_pobox;;other_str1\nother_str2;other_loc;other_region;other_pocode;other_country
-
-        QString nr;
-        nr = stringProp( tnefMsg, MAPI_TAG_PR_HOME_TELEPHONE_NUMBER );
-        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Home ) );
-        nr = stringProp( tnefMsg, MAPI_TAG_PR_BUSINESS_TELEPHONE_NUMBER );
-        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Work ) );
-        nr = stringProp( tnefMsg, MAPI_TAG_PR_MOBILE_TELEPHONE_NUMBER );
-        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Cell ) );
-        nr = stringProp( tnefMsg, MAPI_TAG_PR_HOME_FAX_NUMBER );
-        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Fax | KABC::PhoneNumber::Home ) );
-        nr = stringProp( tnefMsg, MAPI_TAG_PR_BUSINESS_FAX_NUMBER );
-        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Fax | KABC::PhoneNumber::Work ) );
-
-        s = tnefMsg->findProp( MAPI_TAG_PR_BIRTHDAY )
-          .replace( QChar( '-' ), QString::null )
-          .replace( QChar( ':' ), QString::null );
-        if( !s.isEmpty() )
-          addressee.setBirthday( QDateTime::fromString( s ) );
-
-        bOk = ( !addressee.isEmpty() );
-      } else if( "IPM.NOTE" == msgClass ) {
-
-      } // else if ... and so on ...
-    }
-  }
-
-  // Compose return string
-  QString iCal = calFormat.toString( &cal );
-  if( !iCal.isEmpty() )
-    // This was an iCal
-    return iCal;
-
-  // Not an iCal - try a vCard
-  KABC::VCardConverter converter;
-  return converter.createVCard( addressee );
-}
-
-
 #include "kogroupware.moc"
diff -urN -x CVS kdepim.orig/korganizer/kogroupware.h kdepim/korganizer/kogroupware.h
--- kdepim.orig/korganizer/kogroupware.h	Tue Jun  8 14:31:58 2004
+++ kdepim/korganizer/kogroupware.h	Thu Oct  7 11:42:13 2004
@@ -71,35 +71,6 @@
     // THIS IS THE ACTUAL KM/KO API
     enum EventState { Accepted, ConditionallyAccepted, Declined, Request };
 
-    // Event initiated by somebody else, coming into KO from KM, returning
-    // resulting state
-    bool incomingEventRequest( const QString& request,
-                               const QString& receiver,
-                               const QString& vCalIn );
-    void incomingResourceRequest( const QValueList<QPair<QDateTime, QDateTime> >& busy,
-                                  const QCString& resource,
-                                  const QString& vCalIn,
-                                  bool& vCalInOK,
-                                  QString& vCalOut,
-                                  bool& vCalOutOK,
-                                  bool& isFree,
-                                  QDateTime& start, QDateTime& end );
-
-    // Answer to invitation
-    bool incidenceAnswer( const QString& vCal );
-
-    // Cancel an invitation
-    bool cancelIncidence( const QString& iCal );
-
-    // These are supposed to be moved to the upcoming HTML
-    // body part formatter plugin
-    // Format an iCal as an HTML file
-    QString formatICal( const QString& iCal );
-    // Format a TNEF attachment to an HTML mail
-    QString formatTNEF( const QByteArray& tnef );
-    // Transform a TNEF attachment to an iCal or vCard
-    QString msTNEFToVPart( const QByteArray& tnef );
-
   private slots:
     /** Handle iCals given by KMail. */
     void incomingDirChanged( const QString& path );
diff -urN -x CVS kdepim.orig/korganizer/kogroupwareincomingdialog.cpp kdepim/korganizer/kogroupwareincomingdialog.cpp
--- kdepim.orig/korganizer/kogroupwareincomingdialog.cpp	Sun Jan 18 23:11:08 2004
+++ kdepim/korganizer/kogroupwareincomingdialog.cpp	Thu Jan  1 01:00:00 1970
@@ -1,101 +0,0 @@
-/*
-    This file is part of KOrganizer.
-
-    Copyright (c) 2002-2004 Klarlvdalens Datakonsult AB
-        <info@klaralvdalens-datakonsult.se>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-    In addition, as a special exception, the copyright holders give
-    permission to link the code of this program with any edition of
-    the Qt library by Trolltech AS, Norway (or with modified versions
-    of Qt that use the same license as Qt), and distribute linked
-    combinations including the two.  You must obey the GNU General
-    Public License in all respects for all of the code used other than
-    Qt.  If you modify this file, you may extend this exception to
-    your version of the file, but you are not obligated to do so.  If
-    you do not wish to do so, delete this exception statement from
-    your version.
-*/
-#include "kogroupwareincomingdialog.h"
-
-#include <libkcal/event.h>
-#include <qlabel.h>
-#include <qtextedit.h>
-
-
-/*
- *  Constructs a KOGroupwareIncomingDialog which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- *
- *  The dialog will by default be modeless, unless you set 'modal' to
- *  true to construct a modal dialog.
- */
-KOGroupwareIncomingDialog::KOGroupwareIncomingDialog( KCal::Incidence *evt,
-                                                      QWidget *parent,
-                                                      const char *name,
-                                                      bool modal,
-                                                      WFlags fl )
-  : KOGroupwareIncomingDialog_base( parent, name, modal, fl )
-{
-  mAccepted = false;
-  mConditionallyAccepted = false;
-  mDeclined = false;
-
-  fromLA->setText( evt->dtStartDateStr() + ", " + evt->dtStartTimeStr() );
-  if( evt->type() == "Event" ) {
-    KCal::Event* event = static_cast<KCal::Event*>(evt);
-    toLA->setText( event->dtEndDateStr() + ", " + event->dtEndTimeStr() );
-  }
-  locationLA->setText( evt->location() );
-  summaryLA->setText( evt->summary() );
-  descriptionTE->setText( evt->description() );
-}
-
-KOGroupwareIncomingDialog::~KOGroupwareIncomingDialog()
-{
-}
-
-/*
- * protected slot
- */
-void KOGroupwareIncomingDialog::slotAcceptEvent()
-{
-  mAccepted = true;
-  mConditionallyAccepted = false;
-  mDeclined = false;
-}
-
-/*
- * protected slot
- */
-void KOGroupwareIncomingDialog::slotAcceptEventConditionally()
-{
-  mAccepted = false;
-  mConditionallyAccepted = true;
-  mDeclined = false;
-}
-
-/*
- * protected slot
- */
-void KOGroupwareIncomingDialog::slotDeclineEvent()
-{
-  mAccepted = false;
-  mConditionallyAccepted = false;
-  mDeclined = true;
-}
-
-#include "kogroupwareincomingdialog.moc"
diff -urN -x CVS kdepim.orig/korganizer/kogroupwareincomingdialog.h kdepim/korganizer/kogroupwareincomingdialog.h
--- kdepim.orig/korganizer/kogroupwareincomingdialog.h	Sun Jan 18 23:11:08 2004
+++ kdepim/korganizer/kogroupwareincomingdialog.h	Thu Jan  1 01:00:00 1970
@@ -1,64 +0,0 @@
-/*
-    This file is part of KOrganizer.
-
-    Copyright (c) 2002-2004 Klarlvdalens Datakonsult AB
-        <info@klaralvdalens-datakonsult.se>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-    In addition, as a special exception, the copyright holders give
-    permission to link the code of this program with any edition of
-    the Qt library by Trolltech AS, Norway (or with modified versions
-    of Qt that use the same license as Qt), and distribute linked
-    combinations including the two.  You must obey the GNU General
-    Public License in all respects for all of the code used other than
-    Qt.  If you modify this file, you may extend this exception to
-    your version of the file, but you are not obligated to do so.  If
-    you do not wish to do so, delete this exception statement from
-    your version.
-*/
-#ifndef KOGROUPWAREINCOMINGDIALOG_H
-#define KOGROUPWAREINCOMINGDIALOG_H
-
-#include "kogroupwareincomingdialog_base.h"
-
-namespace KCal { class Incidence; }
-
-
-class KOGroupwareIncomingDialog : public KOGroupwareIncomingDialog_base
-{
-    Q_OBJECT
-  public:
-    KOGroupwareIncomingDialog( KCal::Incidence*, QWidget* parent = 0,
-                               const char* name = 0, bool modal = false,
-                               WFlags fl = 0 );
-    ~KOGroupwareIncomingDialog();
-
-    bool isAccepted() const { return mAccepted; }
-    bool isConditionallyAccepted() const { return mConditionallyAccepted; }
-    bool isDeclined() const { return mDeclined; }
-
-  protected slots:
-    void slotAcceptEvent();
-    void slotAcceptEventConditionally();
-    void slotDeclineEvent();
-
-  private:
-    bool mAccepted;
-    bool mConditionallyAccepted;
-    bool mDeclined;
-};
-
-#endif
diff -urN -x CVS kdepim.orig/korganizer/kogroupwareincomingdialog_base.ui kdepim/korganizer/kogroupwareincomingdialog_base.ui
--- kdepim.orig/korganizer/kogroupwareincomingdialog_base.ui	Sat Sep 13 23:11:09 2003
+++ kdepim/korganizer/kogroupwareincomingdialog_base.ui	Thu Jan  1 01:00:00 1970
@@ -1,277 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>KOGroupwareIncomingDialog_base</class>
-<widget class="QDialog">
-    <property name="name">
-        <cstring>KOGroupwareIncomingDialog_base</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>594</width>
-            <height>306</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Meeting Request</string>
-    </property>
-    <vbox>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <widget class="QLabel">
-            <property name="name">
-                <cstring>TextLabel1</cstring>
-            </property>
-            <property name="font">
-                <font>
-                    <bold>1</bold>
-                </font>
-            </property>
-            <property name="text">
-                <string>You have received a request for participating in a meeting with the following data:</string>
-            </property>
-            <property name="alignment">
-                <set>WordBreak|AlignVCenter</set>
-            </property>
-        </widget>
-        <widget class="QLayoutWidget">
-            <property name="name">
-                <cstring>Layout5</cstring>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <widget class="QLabel" row="0" column="2">
-                    <property name="name">
-                        <cstring>TextLabel3</cstring>
-                    </property>
-                    <property name="text">
-                        <string>To:</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="0" column="3">
-                    <property name="name">
-                        <cstring>toLA</cstring>
-                    </property>
-                    <property name="sizePolicy">
-                        <sizepolicy>
-                            <hsizetype>3</hsizetype>
-                            <vsizetype>5</vsizetype>
-                            <horstretch>0</horstretch>
-                            <verstretch>0</verstretch>
-                        </sizepolicy>
-                    </property>
-                    <property name="minimumSize">
-                        <size>
-                            <width>100</width>
-                            <height>0</height>
-                        </size>
-                    </property>
-                    <property name="frameShape">
-                        <enum>Panel</enum>
-                    </property>
-                    <property name="frameShadow">
-                        <enum>Sunken</enum>
-                    </property>
-                    <property name="text">
-                        <string></string>
-                    </property>
-                </widget>
-                <widget class="QTextEdit" row="3" column="1" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>descriptionTE</cstring>
-                    </property>
-                    <property name="readOnly">
-                        <bool>true</bool>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="2" column="1" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>summaryLA</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>Panel</enum>
-                    </property>
-                    <property name="frameShadow">
-                        <enum>Sunken</enum>
-                    </property>
-                    <property name="text">
-                        <string></string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="3" column="0">
-                    <property name="name">
-                        <cstring>TextLabel10</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Description:</string>
-                    </property>
-                    <property name="alignment">
-                        <set>AlignTop</set>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="2" column="0">
-                    <property name="name">
-                        <cstring>TextLabel8</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Summary:</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="0" column="1">
-                    <property name="name">
-                        <cstring>fromLA</cstring>
-                    </property>
-                    <property name="sizePolicy">
-                        <sizepolicy>
-                            <hsizetype>3</hsizetype>
-                            <vsizetype>5</vsizetype>
-                            <horstretch>0</horstretch>
-                            <verstretch>0</verstretch>
-                        </sizepolicy>
-                    </property>
-                    <property name="minimumSize">
-                        <size>
-                            <width>100</width>
-                            <height>0</height>
-                        </size>
-                    </property>
-                    <property name="frameShape">
-                        <enum>Panel</enum>
-                    </property>
-                    <property name="frameShadow">
-                        <enum>Sunken</enum>
-                    </property>
-                    <property name="text">
-                        <string></string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="0" column="0">
-                    <property name="name">
-                        <cstring>TextLabel2</cstring>
-                    </property>
-                    <property name="text">
-                        <string>From:</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="1" column="1" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>locationLA</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>Panel</enum>
-                    </property>
-                    <property name="frameShadow">
-                        <enum>Sunken</enum>
-                    </property>
-                    <property name="text">
-                        <string></string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="1" column="0">
-                    <property name="name">
-                        <cstring>TextLabel6</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Location:</string>
-                    </property>
-                </widget>
-            </grid>
-        </widget>
-        <widget class="QLayoutWidget">
-            <property name="name">
-                <cstring>Layout2</cstring>
-            </property>
-            <hbox>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <widget class="QPushButton">
-                    <property name="name">
-                        <cstring>PushButton1</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Accept</string>
-                    </property>
-                </widget>
-                <widget class="QPushButton">
-                    <property name="name">
-                        <cstring>PushButton2</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Accept C&amp;onditionally</string>
-                    </property>
-                </widget>
-                <widget class="QPushButton">
-                    <property name="name">
-                        <cstring>PushButton3</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Decline</string>
-                    </property>
-                </widget>
-                <widget class="QPushButton">
-                    <property name="name">
-                        <cstring>PushButton4</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Cancel</string>
-                    </property>
-                </widget>
-            </hbox>
-        </widget>
-    </vbox>
-</widget>
-<connections>
-    <connection>
-        <sender>PushButton1</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>slotAcceptEvent()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton2</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>slotAcceptEvent()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton3</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>slotDeclineEvent()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton1</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>accept()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton2</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>accept()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton3</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>accept()</slot>
-    </connection>
-    <connection>
-        <sender>PushButton4</sender>
-        <signal>clicked()</signal>
-        <receiver>KOGroupwareIncomingDialog_base</receiver>
-        <slot>reject()</slot>
-    </connection>
-</connections>
-<slots>
-    <slot access="protected">slotAcceptEvent()</slot>
-    <slot access="protected">slotAcceptEventConditionally()</slot>
-    <slot access="protected">slotDeclineEvent()</slot>
-</slots>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
diff -urN -x CVS kdepim.orig/korganizer/koincidenceeditor.cpp kdepim/korganizer/koincidenceeditor.cpp
--- kdepim.orig/korganizer/koincidenceeditor.cpp	Sun Jun 27 16:57:54 2004
+++ kdepim/korganizer/koincidenceeditor.cpp	Thu Oct  7 11:20:11 2004
@@ -130,7 +130,7 @@
   
   // cancelAttendeeEvent removes all attendees from the incidence, 
   // and then only adds those that need to be cancelled (i.e. a mail needs to be sent to them).
-  if ( KOPrefs::instance()->thatIsMe( incidence->organizer() ) ) {
+  if ( KOPrefs::instance()->thatIsMe( incidence->organizer().email() ) ) {
     Incidence *ev = incidence->clone();
     ev->registerObserver( 0 );
     mDetails->cancelAttendeeEvent( ev );
diff -urN -x CVS kdepim.orig/korganizer/kojournaleditor.cpp kdepim/korganizer/kojournaleditor.cpp
--- kdepim.orig/korganizer/kojournaleditor.cpp	Sun Jun 27 16:57:54 2004
+++ kdepim/korganizer/kojournaleditor.cpp	Thu Oct  7 11:20:11 2004
@@ -155,6 +155,8 @@
   } else {
     mJournal = new Journal;
 //    mJournal->setOrganizer( KOPrefs::instance()->email() );
+    mJournal->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                            KOPrefs::instance()->email() ) );
 
     writeJournal( mJournal );
 
diff -urN -x CVS kdepim.orig/korganizer/kolistview.cpp kdepim/korganizer/kolistview.cpp
--- kdepim.orig/korganizer/kolistview.cpp	Sun Jul 25 12:54:54 2004
+++ kdepim/korganizer/kolistview.cpp	Thu Oct  7 18:12:22 2004
@@ -379,8 +379,10 @@
     break;
     case KOGlobals::INCIDENCEDELETED: {
       item = getItemForIncidence(incidence);
-      if (item)
+      if (item) {
         delete item;
+        mUidDict.remove( incidence->uid() );
+      }
       break;
     }
     default:
diff -urN -x CVS kdepim.orig/korganizer/komailclient.cpp kdepim/korganizer/komailclient.cpp
--- kdepim.orig/korganizer/komailclient.cpp	Wed Sep 29 15:01:59 2004
+++ kdepim/korganizer/komailclient.cpp	Thu Oct  7 11:20:11 2004
@@ -57,8 +57,8 @@
   Attendee::List attendees = incidence->attendees();
   if (attendees.count() == 0) return false;
 
-  const QString from = incidence->organizer();
-  const QString organizerEmail = KPIM::getEmailAddr( incidence->organizer() );
+  const QString from = incidence->organizer().fullName();
+  const QString organizerEmail = incidence->organizer().email();
   QStringList toList;
   for(uint i=0; i<attendees.count();++i) {
     const QString email = (*attendees.at(i))->email();
@@ -90,7 +90,7 @@
 
 bool KOMailClient::mailOrganizer(IncidenceBase *incidence,const QString &attachment)
 {
-  QString to = incidence->organizer();
+  QString to = incidence->organizer().fullName();
 
   QString from = KOPrefs::instance()->email();
 
@@ -313,7 +313,7 @@
       i18n("Yearly"), i18n("Yearly"), i18n("Yearly")};
 
     if (!selectedEvent->organizer().isEmpty()) {
-      body += i18n("Organizer: %1").arg(selectedEvent->organizer());
+      body += i18n("Organizer: %1").arg(selectedEvent->organizer().fullName());
       body += CR;
     }
     body += i18n("Summary: %1").arg(selectedEvent->summary());
@@ -374,7 +374,7 @@
   if (incidence->type()=="Todo") {
     Todo *selectedEvent = static_cast<Todo *>(incidence);
     if (!selectedEvent->organizer().isEmpty()) {
-      body += i18n("Organizer: %1").arg(selectedEvent->organizer());
+      body += i18n("Organizer: %1").arg(selectedEvent->organizer().fullName());
       body += CR;
     }
     body += i18n("Summary: %1").arg(selectedEvent->summary());
diff -urN -x CVS kdepim.orig/korganizer/koprefs.cpp kdepim/korganizer/koprefs.cpp
--- kdepim.orig/korganizer/koprefs.cpp	Wed Sep  8 17:56:01 2004
+++ kdepim/korganizer/koprefs.cpp	Thu Oct  7 11:30:19 2004
@@ -301,6 +301,36 @@
   return lst;
 }
 
+QStringList KOPrefs::fullEmails()
+{
+  QStringList fullEmails;
+  // The user name and email from the config dialog:
+  fullEmails << QString("%1 <%2>").arg( fullName() ).arg( email() );
+  
+  QStringList::Iterator it;
+  // Grab emails from the email identities
+  KPIM::IdentityManager *idmanager = KOCore::self()->identityManager();
+  QStringList lst = idmanager->identities();
+  KPIM::IdentityManager::ConstIterator it1;
+  for ( it1 = idmanager->begin() ; it1 != idmanager->end() ; ++it1 ) {
+    fullEmails << (*it1).fullEmailAddr();
+  }
+  // Add emails configured in korganizer
+  lst = mAdditionalMails;
+  for ( it = lst.begin(); it != lst.end(); ++it ) {
+    fullEmails << QString("%1 <%2>").arg( fullName() ).arg( *it );
+  }
+  // Add emails from the user's kaddressbook entry
+  KABC::Addressee me = KABC::StdAddressBook::self()->whoAmI();
+  lst = me.emails();
+  for ( it = lst.begin(); it != lst.end(); ++it ) {
+    fullEmails << me.fullEmail( *it );
+  }
+
+  // Warning, this list could contain duplicates.
+  return fullEmails;
+}
+
 bool KOPrefs::thatIsMe( const QString& _email )
 {
   if ( KOCore::self()->identityManager()->thatIsMe( _email ) )
diff -urN -x CVS kdepim.orig/korganizer/koprefs.h kdepim/korganizer/koprefs.h
--- kdepim.orig/korganizer/koprefs.h	Tue May 18 17:35:29 2004
+++ kdepim/korganizer/koprefs.h	Thu Oct  7 11:30:19 2004
@@ -76,6 +76,8 @@
     QString email();
     /// Returns all email addresses for the user.
     QStringList allEmails();
+    /// Returns all email addresses together with the full username for the user.
+    QStringList fullEmails();
     /// Return true if the given email belongs to the user
     bool thatIsMe( const QString& email );
 
diff -urN -x CVS kdepim.orig/korganizer/korgac/korgac.desktop kdepim/korganizer/korgac/korgac.desktop
--- kdepim.orig/korganizer/korgac/korgac.desktop	Sat Oct  2 16:30:30 2004
+++ kdepim/korganizer/korgac/korgac.desktop	Mon Oct  4 15:26:29 2004
@@ -68,6 +68,7 @@
 GenericName[gl]=Demo do Cliente de Alarma de KOrganizer
 GenericName[hu]=Emlékeztetőprogram
 GenericName[it]=Client del demone degli avvisi di KOrganizer
+GenericName[ja]=KOrganizer アラーム デーモン クライアント
 GenericName[nb]=KOrganizer alarmnisse-klient
 GenericName[nl]=KOrganizer herinneringsdaemon-client
 GenericName[nn]=Alarmnisseklient for KOrganizer
@@ -78,7 +79,7 @@
 GenericName[sk]=Klient KOrganizer pre démona alarmov
 GenericName[sl]=Odjemalec za alarmski strežnik KOrganizerja
 GenericName[sr]=Алармни демон клијент KOrganizer-а
-GenericName[sr@Latn]=Алармни демон клијент KOrganizer-а
+GenericName[sr@Latn]=Alarmni demon klijent KOrganizer-a
 GenericName[sv]=Korganizer-alarmdemonklient
 GenericName[ta]=கேஅமைப்பாளர் எச்சரிக்கை டெமான் உறுப்பினர்
 GenericName[tg]=Коргири демони соати зангдори рӯимизии KOrganizer
diff -urN -x CVS kdepim.orig/korganizer/korganizeriface.h kdepim/korganizer/korganizeriface.h
--- kdepim.orig/korganizer/korganizeriface.h	Mon May 17 23:52:22 2004
+++ kdepim/korganizer/korganizeriface.h	Thu Oct  7 11:20:23 2004
@@ -35,17 +35,6 @@
     virtual QString getCurrentURLasString() const = 0;
     virtual bool editIncidence(QString uid) = 0;
     virtual bool deleteEvent(QString uid) = 0;
-
-    virtual bool eventRequest(QString request, QString receiver,
-                              QString iCal) = 0;
-    virtual bool eventReply(QString iCal) = 0;
-    virtual bool cancelEvent(QString iCal) = 0;
-
-    // These are supposed to be moved to the upcoming HTML
-    // body part formatter plugin
-    virtual QString formatICal(QString iCal) = 0;
-    virtual QString formatTNEF(QByteArray tnef) = 0;
-    virtual QString msTNEFToVPart(QByteArray tnef) = 0;
 };
 
 #endif
diff -urN -x CVS kdepim.orig/korganizer/korganizerifaceimpl.cpp kdepim/korganizer/korganizerifaceimpl.cpp
--- kdepim.orig/korganizer/korganizerifaceimpl.cpp	Mon May 17 23:52:22 2004
+++ kdepim/korganizer/korganizerifaceimpl.cpp	Thu Oct  7 13:05:01 2004
@@ -1,7 +1,7 @@
 /*
     This file is part of KOrganizer.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This program is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -32,7 +32,6 @@
 
 #include "korganizerifaceimpl.h"
 #include "actionmanager.h"
-#include "kogroupware.h"
 
 
 KOrganizerIfaceImpl::KOrganizerIfaceImpl( ActionManager* actionManager,
@@ -85,37 +84,3 @@
 {
   return mActionManager->editIncidence( uid );
 }
-
-bool KOrganizerIfaceImpl::eventRequest( QString request, QString receiver,
-                                        QString ical )
-{
-  return mActionManager->eventRequest( request, receiver, ical );
-}
-
-bool KOrganizerIfaceImpl::eventReply( QString ical )
-{
-  return mActionManager->eventReply( ical );
-}
-
-bool KOrganizerIfaceImpl::cancelEvent( QString ical )
-{
-  return mActionManager->cancelEvent( ical );
-}
-
-QString KOrganizerIfaceImpl::formatICal( QString iCal )
-{
-  if( !KOGroupware::instance() ) return QString();
-  return KOGroupware::instance()->formatICal( iCal );
-}
-
-QString KOrganizerIfaceImpl::formatTNEF( QByteArray tnef )
-{
-  if( !KOGroupware::instance() ) return QString();
-  return KOGroupware::instance()->formatTNEF( tnef );
-}
-
-QString KOrganizerIfaceImpl::msTNEFToVPart( QByteArray tnef )
-{
-  if( !KOGroupware::instance() ) return QString();
-  return KOGroupware::instance()->msTNEFToVPart( tnef );
-}
diff -urN -x CVS kdepim.orig/korganizer/korganizerifaceimpl.h kdepim/korganizer/korganizerifaceimpl.h
--- kdepim.orig/korganizer/korganizerifaceimpl.h	Mon May 17 23:52:22 2004
+++ kdepim/korganizer/korganizerifaceimpl.h	Thu Oct  7 11:20:23 2004
@@ -53,15 +53,6 @@
 
   bool editIncidence( QString uid );
   bool deleteEvent( QString uid );
-  bool eventRequest( QString request, QString receiver, QString iCal );
-  bool eventReply( QString iCal );
-  bool cancelEvent( QString iCal );
-
-  // These are supposed to be moved to the upcoming HTML
-  // body part formatter plugin
-  QString formatICal( QString iCal );
-  QString formatTNEF( QByteArray tnef );
-  QString msTNEFToVPart( QByteArray tnef );
 
 private:
   ActionManager* mActionManager;
diff -urN -x CVS kdepim.orig/korganizer/kotodoeditor.cpp kdepim/korganizer/kotodoeditor.cpp
--- kdepim.orig/korganizer/kotodoeditor.cpp	Tue Sep 28 09:32:10 2004
+++ kdepim/korganizer/kotodoeditor.cpp	Thu Oct  7 11:20:11 2004
@@ -272,7 +272,8 @@
 
   } else {
     mTodo = new Todo;
-    mTodo->setOrganizer( KOPrefs::instance()->email() );
+    mTodo->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                         KOPrefs::instance()->email() ) );
 
     writeTodo( mTodo );
     if ( KOPrefs::instance()->mUseGroupwareCommunication ) {
diff -urN -x CVS kdepim.orig/korganizer/kotodoview.cpp kdepim/korganizer/kotodoview.cpp
--- kdepim.orig/korganizer/kotodoview.cpp	Sat Aug 14 12:45:41 2004
+++ kdepim/korganizer/kotodoview.cpp	Fri Oct  8 14:43:46 2004
@@ -988,16 +988,19 @@
 
 void KOTodoView::addQuickTodo()
 {
-  Todo *todo = new Todo();
-  todo->setSummary( mQuickAdd->text() );
-  todo->setOrganizer( KOPrefs::instance()->email() );
-  if ( !calendar()->addTodo( todo ) ) {
-    KODialogManager::errorSaveTodo( this );
-    return;
+  if ( ! mQuickAdd->text().stripWhiteSpace().isEmpty() ) {
+    Todo *todo = new Todo();
+    todo->setSummary( mQuickAdd->text() );
+    todo->setOrganizer( Person( KOPrefs::instance()->fullName(), 
+                        KOPrefs::instance()->email() ) );
+    if ( !calendar()->addTodo( todo ) ) {
+      KODialogManager::errorSaveTodo( this );
+      return;
+    }
+    mQuickAdd->setText( QString::null );
+    emit incidenceAdded( todo );
+    updateView();
   }
-  mQuickAdd->setText( QString::null );
-  emit incidenceAdded( todo );
-  updateView();
 }
 
 void KOTodoView::emitCompletedSignal( Todo *todo )
diff -urN -x CVS kdepim.orig/korganizer/outgoingdialog.cpp kdepim/korganizer/outgoingdialog.cpp
--- kdepim.orig/korganizer/outgoingdialog.cpp	Tue Jun  8 14:31:58 2004
+++ kdepim/korganizer/outgoingdialog.cpp	Thu Oct  7 11:20:11 2004
@@ -281,11 +281,9 @@
     case Scheduler::Add: {
       sendText += i18n("All attendees");
       break; }
-    case Scheduler::Reply: {
-      sendText += i18n("The organizer %1").arg(item->event()->organizer());
-      break; }
+    case Scheduler::Reply:
     case Scheduler::Counter: {
-      sendText += i18n("The organizer %1").arg(item->event()->organizer());
+      sendText += i18n("The organizer %1").arg( item->event()->organizer().fullName() );
       break; }
     case Scheduler::Declinecounter: {
       sendText += i18n("All attendees");
diff -urN -x CVS kdepim.orig/korganizer/plugins/datenums/datenums.desktop kdepim/korganizer/plugins/datenums/datenums.desktop
--- kdepim.orig/korganizer/plugins/datenums/datenums.desktop	Sat Oct  2 16:30:31 2004
+++ kdepim/korganizer/plugins/datenums/datenums.desktop	Mon Oct  4 15:26:29 2004
@@ -13,6 +13,7 @@
 Name[fr]=Module de date pour les agendas
 Name[hu]=Dátumkezelő bővítőmodul naptárakhoz
 Name[it]=Plugin delle date per i calendari
+Name[ja]=カレンダの日付プラグイン
 Name[nb]=Datonummer programtillegg for Kalender
 Name[nl]=Datumgetallenplugin voor agenda's
 Name[nn]=Datonummer programtillegg for Kalender
@@ -23,7 +24,7 @@
 Name[sk]=Modul dátumov pre kalendáre
 Name[sl]=Datumski vstavek za koledarje
 Name[sr]=Прикључак календара за бројеве датума
-Name[sr@Latn]=Прикључак календара за бројеве датума
+Name[sr@Latn]=Priključak kalendara za brojeve datuma
 Name[sv]=Datuminsticksprogram för kalendrar
 Name[ta]=நாள்காட்டிகளுக்கான தேதி எண்களின் சொருகுப்பொருள்
 Name[tg]=Санаҳои тақвим
diff -urN -x CVS kdepim.orig/korganizer/plugins/exchange/exchange.desktop kdepim/korganizer/plugins/exchange/exchange.desktop
--- kdepim.orig/korganizer/plugins/exchange/exchange.desktop	Sat Oct  2 16:30:31 2004
+++ kdepim/korganizer/plugins/exchange/exchange.desktop	Mon Oct  4 15:26:30 2004
@@ -16,6 +16,7 @@
 Name[hu]=Microsoft Exchange 2000-bővítőmodul a KOrganizerhez
 Name[is]=Microsoft Exchange 2000 íforrit fyrir KSkipulag
 Name[it]=Plugin Microsoft Exchange 2000 per KOrganizer
+Name[ja]=KOrganizerの Microsoft Exchange 2000 プラグイン
 Name[nb]=Microsoft Exchange 2000 programtillegg for KOrganizer
 Name[nl]=Microsoft Exchange 2000 plugin voor KOrganizer
 Name[nn]=Microsoft Exchange 2000 programtillegg for KOrganizer
@@ -26,7 +27,7 @@
 Name[sk]=KOrganizer modul pre Microsoft Exchange 2000
 Name[sl]=Vstavek za Microsoft Exchange 2000 za KOrganizer
 Name[sr]=Прикључак KOrganizer-а за Microsoft Exchange 2000
-Name[sr@Latn]=Прикључак KOrganizer-а за Microsoft Exchange 2000
+Name[sr@Latn]=Priključak KOrganizer-a za Microsoft Exchange 2000
 Name[sv]=Microsoft Exchange 2000-insticksprogram för Korganizer
 Name[ta]=கேஅமைப்பாளருக்கான மைக்ரோசாஃப்ட் எக்ஸ்சேன்ஜ் 2000 சொருகுப்பொருள்
 Name[tg]=Дастрасӣ ба Microsoft Exchange 2000
diff -urN -x CVS kdepim.orig/korganizer/plugins/hebrew/hebrew.desktop kdepim/korganizer/plugins/hebrew/hebrew.desktop
--- kdepim.orig/korganizer/plugins/hebrew/hebrew.desktop	Sat Oct  2 16:30:31 2004
+++ kdepim/korganizer/plugins/hebrew/hebrew.desktop	Mon Oct  4 15:26:30 2004
@@ -15,6 +15,7 @@
 Name[hu]=Bővítőmodul a zsidó naptár kezeléséhez
 Name[is]=Gyðingadagatalsíforrit
 Name[it]=Plugin calendario ebraico
+Name[ja]=ユダヤ歴カレンダプラグイン
 Name[nb]=Programtillegg for jødisk kalender
 Name[nl]=Joodse kalenderplugin
 Name[nn]=Programtillegg for jødisk kalender
@@ -25,7 +26,7 @@
 Name[sk]=Modul Židovského kalendára
 Name[sl]=Vstavek za židovski koledar
 Name[sr]=Прикључак календара за јеврејски календар
-Name[sr@Latn]=Прикључак календара за јеврејски календар
+Name[sr@Latn]=Priključak kalendara za jevrejski kalendar
 Name[sv]=Insticksprogram för judisk kalender
 Name[ta]=ஜூவிஷ் நாள்காட்டி சொருகுப்பொருள்
 Name[tg]=Тақвимоти яҳудӣ
diff -urN -x CVS kdepim.orig/korganizer/plugins/holidays/holidays/holiday_nz kdepim/korganizer/plugins/holidays/holidays/holiday_nz
--- kdepim.orig/korganizer/plugins/holidays/holidays/holiday_nz	Mon Aug 27 01:30:04 2001
+++ kdepim/korganizer/plugins/holidays/holidays/holiday_nz	Sun Oct  3 20:33:19 2004
@@ -2,12 +2,15 @@
 : New Zealand holiday file. Copy to ~/.holiday
 :
 : Author: Miles Leonard-Taylor (m.leonardtaylor@irl.cri.nz)
-: 13 September 2000
+: 13 September 2000 (first version)
+: 24 September 2004 (update with spelling corrections)
+: Thanks to various people for pointing out all my spelling mistakes...
 
 : Holidays as defined by the government's "Holidays Acts, 1981-1991"
 : and the Visits and Ceremonial office of the Department of Internal Affairs
-: and also at http://www.nzir.dol.govt.nz/rights/leave/dates/2000.html
-:
+: and was also at http://www.nzir.dol.govt.nz/rights/leave/dates/2000.html
+: but now located under http://www.ers.dol.govt.nz/holidays_act_2003/dates/
+
 small "Christmas" weekend on december 25
 small "Boxing Day" weekend on december 26
 small "New Year's Day" weekend on january 1
@@ -28,11 +31,11 @@
 small "Mother's Day" on second sunday in may
 small "Father's Day" on first sunday in september
 small "Halloween" on october 31
-small "Guy Falk's" on november 5
+small "Guy Fawkes" on november 5
 small "Melbourne Cup" on first tuesday in november 
 
 : Daylight Savings Reminders, defined by Internal Affairs
-small "Clocks Foward" on first sunday in october
+small "Clocks Forward" on first sunday in october
 small "Clocks Back" on third sunday in march
 
 : Additional Easter dates and other Solemneties, defined by Catholic Church
@@ -75,8 +78,8 @@
 small "Hawkes Bay Day" on fourth monday in october minus 3 days
 : Wellington		22 January	Moves to nearest monday
 small "Wellington Day" on monday after 19 january
-: Malborough		1 November	Moves to first monday after Labour day
-small "Malborough Day" on fourth monday in october plus 7 days
+: Marlborough		1 November	Moves to first monday after Labour day
+small "Marlborough Day" on fourth monday in october plus 7 days
 : Nelson		1 February	Moves to nearest monday
 small "Nelson Day" on monday after 29 january
 : Canterbury		16 December	Moves to 2nd Fri after 1st Tues in Nov
@@ -90,5 +93,5 @@
 : Southland		17 January	Moves to nearest monday
 small "Southland Day" on monday after 14 march
 : Chatham Islands	30 November	Moves to nearest monday
-small "Chatam's Day" on monday after 27 november
+small "Chatham's Day" on monday after 27 november
 
diff -urN -x CVS kdepim.orig/korganizer/plugins/holidays/holidays/holiday_se kdepim/korganizer/plugins/holidays/holidays/holiday_se
--- kdepim.orig/korganizer/plugins/holidays/holidays/holiday_se	Fri Jul 23 18:32:45 2004
+++ kdepim/korganizer/plugins/holidays/holidays/holiday_se	Sun Oct  3 19:15:09 2004
@@ -19,7 +19,7 @@
 black "Nationaldagen" black on 6.6
 black "Midsommarafton" black on friday before 26.6
 weekend "Midsommardagen" weekend on saturday before 27.6
-blue "Vintertid" on last sunday in september
+blue "Vintertid" on last sunday in october
 weekend "Alla helgons dag" weekend on first sunday in november minus 1
 black "1. Advent" on sunday before 23.12 minus 21 days
 black "2. Advent" on sunday before 23.12 minus 14 days
diff -urN -x CVS kdepim.orig/korganizer/plugins/holidays/holidays.cpp kdepim/korganizer/plugins/holidays/holidays.cpp
--- kdepim.orig/korganizer/plugins/holidays/holidays.cpp	Fri Jul 23 18:32:44 2004
+++ kdepim/korganizer/plugins/holidays/holidays.cpp	Sun Oct  3 20:33:19 2004
@@ -17,7 +17,7 @@
     Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
 
-// $Id$
+// $Id$
 
 #include <qfile.h>
 
@@ -91,7 +91,7 @@
   //static int lastYear = 0;
   int lastYear = 0;
 
-  if (mHolidayFile.isEmpty()) return QString::null;
+  if (mHolidayFile.isEmpty() || qd.isNull()) return QString::null;
 
   //if ((lastYear == 0) || (qd.year() != lastYear)) {
   if ((yearLast == 0) || (qd.year() != yearLast)) {
diff -urN -x CVS kdepim.orig/korganizer/plugins/holidays/holidays.desktop kdepim/korganizer/plugins/holidays/holidays.desktop
--- kdepim.orig/korganizer/plugins/holidays/holidays.desktop	Sat Oct  2 16:30:31 2004
+++ kdepim/korganizer/plugins/holidays/holidays.desktop	Mon Oct  4 15:26:30 2004
@@ -15,6 +15,7 @@
 Name[hu]=Szabadságnyilvántartó bővítőmodul naptárakhoz
 Name[is]=Frídagaíforrit fyrir dagatal
 Name[it]=Plugin vacanze per i calendari
+Name[ja]=カレンダ用休日プラグイン
 Name[nb]=Ferie-programtilleg for Kalendere
 Name[nl]=Vakantieplugin voor agenda's
 Name[nn]=Ferieprogramtillegg for Kalenderar
@@ -25,7 +26,7 @@
 Name[sk]=Modul sviatkov pre kalendáre
 Name[sl]=Vstavek za počitnice za koledarje
 Name[sr]=Прикључак календара за празнике
-Name[sr@Latn]=Прикључак календара за празнике
+Name[sr@Latn]=Priključak kalendara za praznike
 Name[sv]=Semesterinsticksprogram för kalendrar
 Name[ta]=நாள்காட்டிக்கான விடுமுறை சொருகுப்பொருள்
 Name[tg]=Рӯзҳои истироҳат
diff -urN -x CVS kdepim.orig/korganizer/plugins/projectview/projectview.desktop kdepim/korganizer/plugins/projectview/projectview.desktop
--- kdepim.orig/korganizer/plugins/projectview/projectview.desktop	Tue Aug 31 09:23:26 2004
+++ kdepim/korganizer/plugins/projectview/projectview.desktop	Mon Oct  4 15:26:31 2004
@@ -41,7 +41,7 @@
 Name[sk]=KOrganizer modul pre projektový pohľad
 Name[sl]=Vstavek za projektni prikaz za KOrganizer
 Name[sr]=Прикључак KOrganizer-а за приказ пројекта
-Name[sr@Latn]=Dodatak KOrganizer-a za prikaz projekta
+Name[sr@Latn]=Priključak KOrganizer-a za prikaz projekta
 Name[sv]=Projektvyinsticksprogram för Korganizer
 Name[ta]=கேஅமைப்பாளருக்கான திட்டக் காட்சி சொருகுப்பொருள்
 Name[tg]=Намоиши нақшот
diff -urN -x CVS kdepim.orig/korganizer/plugins/webexport/webexport.desktop kdepim/korganizer/plugins/webexport/webexport.desktop
--- kdepim.orig/korganizer/plugins/webexport/webexport.desktop	Sat Oct  2 16:30:32 2004
+++ kdepim/korganizer/plugins/webexport/webexport.desktop	Mon Oct  4 15:26:31 2004
@@ -14,6 +14,7 @@
 Name[gl]=Extensión para Exportaxe Web para KOrganizer
 Name[hu]=Webes exportáló bővítőmodul a KOrganizerhez
 Name[it]=Plugin di esportazione Web per KOrganizer
+Name[ja]=KOrganizer 用ウェブエクスポートプラグイン
 Name[nb]=Vev-eksport-programtillegg for KOrganizer
 Name[nl]=Webexportplugin voor KOrganizer
 Name[nn]=Programtillegg for vev-eksport for KOrganizer
@@ -24,7 +25,7 @@
 Name[sk]=Modul KOrganizer pre web export
 Name[sl]=Vstavek za spletni izvoz za KOrganizer
 Name[sr]=Прикључак KOrganizer-а за веб извоз
-Name[sr@Latn]=Прикључак KOrganizer-а за веб извоз
+Name[sr@Latn]=Priključak KOrganizer-a za veb izvoz
 Name[sv]=Webbexportinsticksprogram för Korganizer
 Name[ta]=கேஅமைப்பாளருக்கான இணைய ஏற்றுமதி சொருகுப்பொருள்
 Name[tg]=Содирот ба намуди саҳифаи веб
diff -urN -x CVS kdepim.orig/kpilot/conduits/docconduit/.cvsignore kdepim/kpilot/conduits/docconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/docconduit/.cvsignore	Fri Mar 12 22:29:28 2004
+++ kdepim/kpilot/conduits/docconduit/.cvsignore	Thu Oct  7 10:54:33 2004
@@ -8,8 +8,11 @@
 kpalmdoc_dlgbase.cc
 kpalmdoc_dlgbase.cpp
 docconduitSettings.cc
+docconduitSettings.cpp
 docconduitSettings.h
 kpalmdocSettings.cc
+kpalmdocSettings.cpp
 kpalmdocSettings.h
 docconduitSettings.cc
+docconduitSettings.cpp
 kpalmdocSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/knotes/.cvsignore kdepim/kpilot/conduits/knotes/.cvsignore
--- kdepim.orig/kpilot/conduits/knotes/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/conduits/knotes/.cvsignore	Thu Oct  7 10:54:33 2004
@@ -9,4 +9,5 @@
 *_stub.cc
 *_stub.cpp
 knotesconduitSettings.cc
+knotesconduitSettings.cpp
 knotesconduitSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/malconduit/.cvsignore kdepim/kpilot/conduits/malconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/malconduit/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/conduits/malconduit/.cvsignore	Thu Oct  7 10:54:35 2004
@@ -5,4 +5,5 @@
 mal-setup_dialog.cpp
 libmalconduit.la
 malconduitSettings.cc
+malconduitSettings.cpp
 malconduitSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/notepadconduit/notepad-conduit.desktop kdepim/kpilot/conduits/notepadconduit/notepad-conduit.desktop
--- kdepim.orig/kpilot/conduits/notepadconduit/notepad-conduit.desktop	Sat Oct  2 16:30:34 2004
+++ kdepim/kpilot/conduits/notepadconduit/notepad-conduit.desktop	Tue Oct  5 15:20:53 2004
@@ -8,6 +8,7 @@
 Name[es]=Bloc de notas
 Name[gl]=Caderno de Notas
 Name[hu]=Notepad
+Name[ja]=ノートパット
 Name[nb]=NotisBlokk
 Name[nn]=NotisBlokk
 Name[pl]=Notatnik
@@ -19,6 +20,7 @@
 Comment=This conduit backs up NotePad drawings to a local folder
 Comment[bg]=Създаване на архивни копия на изображенията създадени с NotePad в локална директория
 Comment[bs]=Ovaj pomoćnik čuva backup NotePad crteža u lokalnom direktoriju
+Comment[ca]=Aquest conducte copia els dibuixos NotePad a una carpeta local
 Comment[da]=Denne kanal sikkerhedskopierer NotePad's tegninger til en lokal mappe
 Comment[de]=Diese Abgleicher sichert NotePad-Zeichnungen in einen lokalen Ordner
 Comment[es]=Este conducto copia los dibujos del bloc de notas en una carpeta local
@@ -26,6 +28,7 @@
 Comment[fr]=Ce conduit sauvegarde les dessins NotePad dans un dossier local
 Comment[hu]=Bővítőmodul NotePad-rajzok helyi könyvtárba történő lementéséhez
 Comment[it]=Questo conduit archivia i disegni NotePad drawings in una cartella locale
+Comment[ja]=ローカルフォルダーへのノートパッド図面をバックアップします。
 Comment[nb]=Denne kanalen tar sikkerhetskopi av NotePad tegninger til en lokal mappe
 Comment[nl]=Dit conduit maakt een backup van de notitie-aantekeningen naar een lokale map
 Comment[nn]=Denne kanalen tek tryggingskopi av NotisBlokk-teikningar til ei lokal mappe
@@ -36,7 +39,7 @@
 Comment[sk]=Táto spojka zálohuje poznámky NotePad do lokálneho priečinku
 Comment[sl]=Ta veznik arhivira risanja z NotePadom v krajevno mapo
 Comment[sr]=Овај провод прави резервне копија NotePad цртежа у локалну фасциклу
-Comment[sr@Latn]=Овај провод прави резервне копија NotePad цртежа у локалну фасциклу
+Comment[sr@Latn]=Ovaj provod pravi rezervne kopija NotePad crteža u lokalnu fasciklu
 Comment[sv]=Den här kanalen säkerhetskopierar ritade anteckningar i en lokal katalog
 Comment[ta]=இது நோட்பேடின் வரைபடங்களை உள்ளடைவுக்கு சேமிக்கிறது
 Comment[tg]=Канали эҷоди нусхаҳои захиравии эзоҳот
diff -urN -x CVS kdepim.orig/kpilot/conduits/null/.cvsignore kdepim/kpilot/conduits/null/.cvsignore
--- kdepim.orig/kpilot/conduits/null/.cvsignore	Fri Jan 23 23:24:47 2004
+++ kdepim/kpilot/conduits/null/.cvsignore	Thu Oct  7 10:54:35 2004
@@ -3,3 +3,4 @@
 null_conduit
 setup_base.h
 setup_base.cc
+setup_base.cpp
diff -urN -x CVS kdepim.orig/kpilot/conduits/perlconduit/.cvsignore kdepim/kpilot/conduits/perlconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/perlconduit/.cvsignore	Wed Mar 17 23:13:17 2004
+++ kdepim/kpilot/conduits/perlconduit/.cvsignore	Thu Oct  7 10:54:37 2004
@@ -2,4 +2,5 @@
 Makefile
 perl-setup.h
 perlconduit.cc
+perlconduit.cpp
 perlconduit.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/perlconduit/perl-conduit.desktop kdepim/kpilot/conduits/perlconduit/perl-conduit.desktop
--- kdepim.orig/kpilot/conduits/perlconduit/perl-conduit.desktop	Sat Oct  2 16:30:35 2004
+++ kdepim/kpilot/conduits/perlconduit/perl-conduit.desktop	Mon Oct  4 15:26:34 2004
@@ -15,6 +15,7 @@
 Name[hu]=Perl (példa)
 Name[is]=Perl (Dæmi)
 Name[it]=Perl (esempio)
+Name[ja]=Perl (例)
 Name[nb]=Perl (prøve)
 Name[nl]=Perl (voorbeeld)
 Name[nn]=Perl (prøve)
@@ -25,7 +26,7 @@
 Name[sk]=Perl (Ukážka)
 Name[sl]=Perl (primer)
 Name[sr]=Перл (пример)
-Name[sr@Latn]=Перл (пример)
+Name[sr@Latn]=Perl (primer)
 Name[sv]=Perl (exempel)
 Name[ta]=பர்ல்(மாதிரி)
 Name[tg]=Perl (намуна)
@@ -41,6 +42,7 @@
 Comment[fr]=Cet exemple de canal lance un interpréteur Perl.
 Comment[hu]=Ez a mintacsatoló a Perl-értelmezőt futtatja
 Comment[it]=Questo conduit avvia un interprete Perl.
+Comment[ja]=このサンプルはPerlインタープリターを実行します。
 Comment[nb]=Denne kanalen kjører en Perl tolker
 Comment[nl]=Dit voorbeeld-conduit start een Perl-interpreteerder.
 Comment[nn]=Denne kanalen køyrer ein Perl-tolkar.
@@ -51,7 +53,7 @@
 Comment[sk]=Táto ukážková spojka spúšťa interpreter Perl.
 Comment[sl]=Ta preprost veznik poganja tolmač za Perl.
 Comment[sr]=Овај пример провода стартује Перл интерпретера.
-Comment[sr@Latn]=Овај пример провода стартује Перл интерпретера.
+Comment[sr@Latn]=Ovaj primer provoda startuje Perl interpretera.
 Comment[sv]=Den här exempelkanalen kör en Perl-tolk.
 Comment[ta]=இந்த மாதிரி காப்புக் குழாய் பர்ல் மொழிப்பெயர்ப்பில் ஓடுகிறது
 Comment[tg]=Канали ба кор андозии ҳуруфотҳои Perl.
diff -urN -x CVS kdepim.orig/kpilot/conduits/popmail/.cvsignore kdepim/kpilot/conduits/popmail/.cvsignore
--- kdepim.orig/kpilot/conduits/popmail/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/conduits/popmail/.cvsignore	Thu Oct  7 10:54:37 2004
@@ -5,4 +5,5 @@
 setup-dialog.cc
 setup-dialog.cpp
 popmailSettings.cc
+popmailSettings.cpp
 popmailSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/pythonconduit/python-conduit.desktop kdepim/kpilot/conduits/pythonconduit/python-conduit.desktop
--- kdepim.orig/kpilot/conduits/pythonconduit/python-conduit.desktop	Sat Oct  2 16:30:35 2004
+++ kdepim/kpilot/conduits/pythonconduit/python-conduit.desktop	Mon Oct  4 15:26:34 2004
@@ -15,6 +15,7 @@
 Name[hu]=Python (példa)
 Name[is]=Python (Dæmi)
 Name[it]=Python (esempio)
+Name[ja]=Python (例)
 Name[nb]=Python (prøve)
 Name[nl]=Python (voorbeeld)
 Name[nn]=Python (prøve)
@@ -25,7 +26,7 @@
 Name[sk]=Python (Ukážka)
 Name[sl]=Python (primer)
 Name[sr]=Python (пример)
-Name[sr@Latn]=Python (пример)
+Name[sr@Latn]=Python (primer)
 Name[sv]=Python (exempel)
 Name[ta]=பைத்தன்(மாதிரி)
 Name[tg]=Python (намуна)
@@ -41,6 +42,7 @@
 Comment[fr]=Cet exemple de canal lance un interpréteur Python.
 Comment[hu]=Ez a mintacsatoló a Python-értelmezőt futtatja
 Comment[it]=Questo conduit avvia un interprete Phython.
+Comment[ja]=このサンプルは Python インタープリターを実行します。
 Comment[nb]=Denne prøve kanalen kjører en Python tolker
 Comment[nl]=Dit voorbeeld-conduit start een Python-interpreteerder.
 Comment[nn]=Denne prøvekanalen køyrer en Python-tolkar.
@@ -51,7 +53,7 @@
 Comment[sk]=Táto ukážková spojka spúšťa interpreter Python.
 Comment[sl]=Ta preprost veznik poganja tolmač za Python.
 Comment[sr]=Овај пример провода стартује Python интерпретера.
-Comment[sr@Latn]=Овај пример провода стартује Python интерпретера.
+Comment[sr@Latn]=Ovaj primer provoda startuje Python interpretera.
 Comment[sv]=Den här exempelkanalen kör en Python-tolk.
 Comment[ta]=இந்த மாதிரி காப்புக் குழாய் பைத்தன் மொழிப்பெயர்ப்பில் ஓடுகிறது
 Comment[tg]=Канали ба кор андозии ҳуруфотҳои Python
diff -urN -x CVS kdepim.orig/kpilot/conduits/sysinfoconduit/.cvsignore kdepim/kpilot/conduits/sysinfoconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/sysinfoconduit/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/conduits/sysinfoconduit/.cvsignore	Thu Oct  7 10:54:37 2004
@@ -4,4 +4,5 @@
 sysinfo-setup_dialog.cc
 sysinfo-setup_dialog.cpp
 sysinfoSettings.cc
+sysinfoSettings.cpp
 sysinfoSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/timeconduit/.cvsignore kdepim/kpilot/conduits/timeconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/timeconduit/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/conduits/timeconduit/.cvsignore	Thu Oct  7 10:54:38 2004
@@ -4,4 +4,5 @@
 time-setup_dialog.cc
 time-setup_dialog.cpp
 timeConduitSettings.cc
+timeConduitSettings.cpp
 timeConduitSettings.h
diff -urN -x CVS kdepim.orig/kpilot/conduits/vcalconduit/.cvsignore kdepim/kpilot/conduits/vcalconduit/.cvsignore
--- kdepim.orig/kpilot/conduits/vcalconduit/.cvsignore	Mon Jan 26 17:31:59 2004
+++ kdepim/kpilot/conduits/vcalconduit/.cvsignore	Thu Oct  7 10:54:39 2004
@@ -10,4 +10,5 @@
 vcalconduitSettings.cc
 korganizertodoConduit.h
 korganizertodoConduit.cc
+korganizertodoConduit.cpp
 
diff -urN -x CVS kdepim.orig/kpilot/conduits/vcalconduit/todo-conduit.desktop kdepim/kpilot/conduits/vcalconduit/todo-conduit.desktop
--- kdepim.orig/kpilot/conduits/vcalconduit/todo-conduit.desktop	Sat Oct  2 16:30:36 2004
+++ kdepim/kpilot/conduits/vcalconduit/todo-conduit.desktop	Mon Oct  4 15:26:34 2004
@@ -59,7 +59,7 @@
 Name[sk]=Úlohy (KOrganizer)
 Name[sl]=Čakajoča opravila (KOrganizer)
 Name[sr]=Задаци (KOrganizer)
-Name[sr@Latn]=Задаци (KOrganizer)
+Name[sr@Latn]=Zadaci (KOrganizer)
 Name[sv]=Att-göra (Korganizer)
 Name[ta]=செய்ய வேண்டியவை(கேஅமைப்பாளர்)
 Name[tg]=Вазифот (KOrganizer)
diff -urN -x CVS kdepim.orig/kpilot/conduits/vcalconduit/vcal-conduit.desktop kdepim/kpilot/conduits/vcalconduit/vcal-conduit.desktop
--- kdepim.orig/kpilot/conduits/vcalconduit/vcal-conduit.desktop	Sat Oct  2 16:30:36 2004
+++ kdepim/kpilot/conduits/vcalconduit/vcal-conduit.desktop	Mon Oct  4 15:26:34 2004
@@ -49,6 +49,7 @@
 Name[hu]=Naptár (KOrganizer)
 Name[is]=Dagbók (KSkipulag)
 Name[it]=Calendario (KOrganizer)
+Name[ja]=カレンダー (KOrganizer)
 Name[nb]=Kalender (KOrganizer)
 Name[nl]=Agenda (KOrganizer)
 Name[nn]=Kalender (KOrganizer)
@@ -59,7 +60,7 @@
 Name[sk]=Kalendár (KOrganizer)
 Name[sl]=Koledar (KOrganizer)
 Name[sr]=Календар (KOrganizer)
-Name[sr@Latn]=Календар (KOrganizer)
+Name[sr@Latn]=Kalendar (KOrganizer)
 Name[sv]=Kalender (Korganizer)
 Name[ta]=நாள்காட்டி(கேஅமைப்பாளர்)
 Name[tg]=Тақвимот (KOrganizer)
diff -urN -x CVS kdepim.orig/kpilot/kpilot/.cvsignore kdepim/kpilot/kpilot/.cvsignore
--- kdepim.orig/kpilot/kpilot/.cvsignore	Fri Jun 11 22:18:47 2004
+++ kdepim/kpilot/kpilot/.cvsignore	Thu Oct  7 10:54:39 2004
@@ -35,3 +35,15 @@
 kpilotConfigWizard_vcal.cc
 kpilotConfigWizard_vcal.h
 
+*_skel.cpp
+*_stub.cpp
+*_base.cpp
+*_base1.cpp
+*_base2.cpp
+*_base3.cpp
+kpilotSettings.cpp
+kpilotConfigDialog_backup.cpp
+kpilotConfigDialog_viewers.cpp
+kpilotConfigWizard_address.cpp
+kpilotConfigWizard_notes.cpp
+kpilotConfigWizard_vcal.cpp
diff -urN -x CVS kdepim.orig/kpilot/kpilot/Makefile.am kdepim/kpilot/kpilot/Makefile.am
--- kdepim.orig/kpilot/kpilot/Makefile.am	Sun Apr 18 21:44:49 2004
+++ kdepim/kpilot/kpilot/Makefile.am	Wed Oct  6 16:41:54 2004
@@ -4,7 +4,7 @@
 ### executables and one library from the sources in this dir.
 ###
 ###
-### $Id$
+### $Id$
 ###
 
 SUBDIRS = Icons
@@ -52,8 +52,7 @@
 	datebookWidget.cc \
 	todoWidget.cc todoEditor.cc todoEditor_base.ui \
 	fileInstaller.cc fileInstallWidget.cc \
-	listItems.cc \
-	kroupware.cc
+	listItems.cc
 kpilot_COMPILE_FIRST = kpilotSettings.h
 
 
@@ -61,7 +60,7 @@
 	pilotDaemonDCOP.skel kpilotDCOP.stub loggerDCOP.stub loggerDCOP.skel \
 	pilotDaemon.cc logFile.cc \
 	hotSync.cc internalEditorAction.cc interactiveSync.cc syncStack.cc \
-	fileInstaller.cc kroupware.cc
+	fileInstaller.cc
 
 kpilotTest_SOURCES = \
 	logWidget.cc pilotComponent.cc \
diff -urN -x CVS kdepim.orig/kpilot/kpilot/conduitConfigDialog.cc kdepim/kpilot/kpilot/conduitConfigDialog.cc
--- kdepim.orig/kpilot/kpilot/conduitConfigDialog.cc	Fri Apr 16 21:43:03 2004
+++ kdepim/kpilot/kpilot/conduitConfigDialog.cc	Wed Oct  6 16:41:54 2004
@@ -28,7 +28,7 @@
 */
 
 static const char *conduitconfigdialog_id =
-	"$Id$";
+	"$Id$";
 
 #include "options.h"
 
@@ -412,8 +412,6 @@
 	if (potentiallyInstalled.findIndex(p->text(CONDUIT_DESKTOP))>=0) \
 		p->setOriginalState(true);
 
-	IC("Kroupware","kroupware",
-		"Sync the handheld with a Kroupware client (for example, KMail).");
 	IC("Install Files","fileinstall",
 		"Install files that are dragged to KPilot onto the handheld.");
 #undef IC
diff -urN -x CVS kdepim.orig/kpilot/kpilot/kpilotConfig.cc kdepim/kpilot/kpilot/kpilotConfig.cc
--- kdepim.orig/kpilot/kpilot/kpilotConfig.cc	Fri Jun 11 20:38:33 2004
+++ kdepim/kpilot/kpilot/kpilotConfig.cc	Wed Oct  6 16:41:54 2004
@@ -45,7 +45,7 @@
 #include "kpilotConfig.h"
 
 static const char kpilotconfig_id[] =
-	"$Id$";
+	"$Id$";
 
 // This is a number indicating what configuration version
 // we're dealing with. Whenever new configuration options are
@@ -212,18 +212,14 @@
 	KConfig*c = KPilotSettings::self()->config();
 ///	c->resetGroup();
 	c->setGroup( QString::null );
-	bool useKroupware = c->readBoolEntry("SyncWithKMail",false);
 	bool installFiles = c->readBoolEntry("SyncFiles",true);
-	if (useKroupware) conduits.append( CSL1("internal_kroupware") );
 	if (installFiles) conduits.append( CSL1("internal_fileinstall") );
-	c->deleteEntry("SyncWithKMail");
 	c->deleteEntry("SyncFiles");
 	KPilotSettings::setInstalledConduits(conduits);
 	c->sync();
-	if (useKroupware || installFiles)
+	if (installFiles)
 		KMessageBox::information(0L,
-			i18n("The settings for Kroupware syncing with KMail "
-				"and the file installer have been moved to the "
+			i18n("The settings for the file installer have been moved to the "
 				"conduits configuration. Check the installed "
 				"conduits list."),
 			i18n("Settings Updated"));
diff -urN -x CVS kdepim.orig/kpilot/kpilot/kpilot_config.desktop kdepim/kpilot/kpilot/kpilot_config.desktop
--- kdepim.orig/kpilot/kpilot/kpilot_config.desktop	Sat Oct  2 16:30:36 2004
+++ kdepim/kpilot/kpilot/kpilot_config.desktop	Mon Oct  4 15:26:34 2004
@@ -25,6 +25,7 @@
 Name[hu]=A KPilot beállításai
 Name[is]=KPilot stillingar
 Name[it]=Configurazione KPilot
+Name[ja]=KPilotの設定
 Name[nb]=KPilot oppsett
 Name[nl]=KPilot instellingen
 Name[nn]=KPilot-oppsett
@@ -35,7 +36,7 @@
 Name[sk]=Nastavenie KPilot
 Name[sl]=Nastavitve KPilota
 Name[sr]=KPilot подешавање
-Name[sr@Latn]=KPilot подешавање
+Name[sr@Latn]=KPilot podešavanje
 Name[sv]=Inställning av Kpilot
 Name[ta]=Kபைலட் கட்டமைப்பு
 Name[tg]=Танзимоти KPilot
@@ -55,6 +56,7 @@
 Comment[he]=תצורה ראשית של KPilot
 Comment[hu]=A KPilot legfontosabb beállításai
 Comment[it]=Configurazione principale di KPilot
+Comment[ja]=KPilot 主要設定
 Comment[nb]=KPilot hovedoppsett
 Comment[nl]=KPilot algemene instellingen
 Comment[nn]=KPilot hovudoppsett
@@ -65,7 +67,7 @@
 Comment[sk]=Hlavné nastavenie KPilot
 Comment[sl]=Glavne nastavitve KPilota
 Comment[sr]=Главна подешавања у KPilot-у
-Comment[sr@Latn]=Главна подешавања у KPilot-у
+Comment[sr@Latn]=Glavna podešavanja u KPilot-u
 Comment[sv]=Kpilots huvudinställning
 Comment[ta]=கேபைலட் முக்கிய கட்டமைப்பு
 Comment[tg]=Параметрҳои умумии KPilot
@@ -84,6 +86,7 @@
 Keywords[he]=kpilot,ראשי,פאלם
 Keywords[hu]=kpilot,alap
 Keywords[it]=kpilot,principale
+Keywords[ja]=kpilot,主要
 Keywords[nb]=kpilot,hoved
 Keywords[nl]=kpilot,algemeen
 Keywords[nn]=kpilot,hovud
@@ -94,7 +97,7 @@
 Keywords[sk]=kpilot,hlavné
 Keywords[sl]=kpilot,glavne
 Keywords[sr]=kpilot,главно
-Keywords[sr@Latn]=kpilot,главно
+Keywords[sr@Latn]=kpilot,glavno
 Keywords[sv]=kpilot, huvudinställning
 Keywords[ta]=கேபைலட்,முக்கிய
 Keywords[tg]=kpilot,main,умумӣ,танзимот
diff -urN -x CVS kdepim.orig/kpilot/kpilot/pilotDaemon.cc kdepim/kpilot/kpilot/pilotDaemon.cc
--- kdepim.orig/kpilot/kpilot/pilotDaemon.cc	Wed Aug 25 20:43:45 2004
+++ kdepim/kpilot/kpilot/pilotDaemon.cc	Wed Oct  6 16:41:54 2004
@@ -28,10 +28,7 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 static const char *pilotdaemon_id =
-	"$Id$";
-
-// Heck yeah.
-#define ENABLE_KROUPWARE
+	"$Id$";
 
 #include "options.h"
 
@@ -70,10 +67,6 @@
 
 #include "kpilotConfig.h"
 
-#ifdef ENABLE_KROUPWARE
-#include "kroupware.h"
-#endif
-
 
 #include "kpilotDCOP_stub.h"
 #include "kpilotDCOP.h"
@@ -698,7 +691,6 @@
 		conduitNameMap = new QDict<QString>;
 		// Fill with internal settings.
 		conduitNameMap->insert(CSL1("internal_fileinstall"),new QString(i18n("File Installer")));
-		conduitNameMap->insert(CSL1("internal_kroupware"),new QString(i18n("Kroupware")));
 
 		conduitNameMap->setAutoDelete(true);
 	}
@@ -885,55 +877,6 @@
 	return true;
 }
 
-static int checkKroupware(ActionQueue *fSyncStack,
-	KPilotDeviceLink *pilotLink,
-	const QStringList &conduits,
-	QString &errreturn,
-	bool &syncWithKMail)
-{
-	FUNCTIONSETUP;
-	int _kroupwareParts = 0;
-#ifdef ENABLE_KROUPWARE
-
-	syncWithKMail =  (conduits.findIndex( CSL1("internal_kroupware") ) >= 0) ;
-	if (!syncWithKMail) return 0;
-
-	QString errmsg;
-	if (!KroupwareSync::startKMail(&errmsg))
-	{
-		errreturn = i18n("Could not start KMail. The "
-			"error message was: %1.").arg(errmsg);
-	}
-
-	if (conduits.findIndex( CSL1("vcal-conduit") ) >= 0 )
-		_kroupwareParts |= KroupwareSync::Cal ;
-	if (conduits.findIndex( CSL1("todo-conduit") ) >= 0 )
-		_kroupwareParts |= KroupwareSync::Todo ;
-	if (conduits.findIndex( CSL1("knotes-conduit") ) >= 0 )
-		_kroupwareParts |= KroupwareSync::Notes ;
-	if (conduits.findIndex( CSL1("abbrowser_conduit") ) >= 0 )
-		_kroupwareParts |= KroupwareSync::Address ;
-
-	fSyncStack->addAction(new KroupwareSync(true /* pre-sync */,
-		_kroupwareParts,pilotLink));
-#endif
-	return _kroupwareParts;
-}
-
-static void finishKroupware(ActionQueue *fSyncStack,
-	KPilotDeviceLink *pilotLink,
-	int kroupwareParts,
-	bool syncWithKMail)
-{
-#ifdef ENABLE_KROUPWARE
-	if (syncWithKMail)
-	{
-		fSyncStack->addAction(new KroupwareSync(false /* post-sync */ ,
-			kroupwareParts,pilotLink));
-	}
-#endif
-}
-
 static void queueInstaller(ActionQueue *fSyncStack,
 	FileInstaller *fInstaller,
 	const QStringList &c)
@@ -971,8 +914,6 @@
 
 	bool pcchanged=false; // If last PC to sync was a different one (implies full sync, normally)
 	QStringList conduits ; // list of conduits to run
-	bool syncWithKMail = false; // if kroupware sync is enabled
-	int _kroupwareParts = 0; // which parts to sync
 	QString s; // a generic string for stuff
 	KPilotUser *usr = 0L; // Pointer to user data on Pilot
 
@@ -1020,14 +961,6 @@
 	fSyncStack->queueInit(true);
 
 
-	// Add kroupware to the mix, if needed.
-	_kroupwareParts = checkKroupware(fSyncStack,pilotLink,conduits,s,syncWithKMail);
-	if (syncWithKMail) logMessage( i18n("Kroupware syncing is enabled.") );
-	if (!s.isEmpty()) logError(s);
-
-
-
-
 	conduits = KPilotSettings::installedConduits() ;
 
 	switch (fNextSyncType)
@@ -1084,8 +1017,6 @@
 #endif
 	}
 
-	finishKroupware(fSyncStack,pilotLink,_kroupwareParts,syncWithKMail);
-
 
 // Jump here to finalize the connections to the sync action
 // queue and start the actual sync.
diff -urN -x CVS kdepim.orig/kpilot/lib/.cvsignore kdepim/kpilot/lib/.cvsignore
--- kdepim.orig/kpilot/lib/.cvsignore	Thu Mar 11 00:29:21 2004
+++ kdepim/kpilot/lib/.cvsignore	Thu Oct  7 10:54:40 2004
@@ -1,4 +1,5 @@
 Makefile
 Makefile.in
 kpilotlibSettings.cc
+kpilotlibSettings.cpp
 kpilotlibSettings.h
diff -urN -x CVS kdepim.orig/kpilot/lib/pilotAddress.cc kdepim/kpilot/lib/pilotAddress.cc
--- kdepim.orig/kpilot/lib/pilotAddress.cc	Tue Apr 20 01:49:11 2004
+++ kdepim/kpilot/lib/pilotAddress.cc	Mon Oct  4 00:40:24 2004
@@ -28,7 +28,7 @@
 
 
 static const char *pilotadress_id =
-	"$Id$";
+	"$Id$";
 
 #ifndef _KPILOT_OPTIONS_H
 #include "options.h"
@@ -241,33 +241,7 @@
 
 bool PilotAddress::setCategory(const QString &label)
 {
-	FUNCTIONSETUPL(4);
-	if (label.isEmpty())
-	{
-		setCat(0);
-		return true;
-	}
-	for (int catId = 1; catId < 16; catId++)
-	{
-		QString aCat = codec()->toUnicode(fAppInfo.category.name[catId]);
-
-		if (label == aCat)
-		{
-			setCat(catId);
-			return true;
-		}
-		else
-			// if empty, then no more labels; add it
-		if (aCat.isEmpty())
-		{
-			qstrncpy(fAppInfo.category.name[catId],
-				codec()->fromUnicode(label), 16);
-			setCat(catId);
-			return true;
-		}
-	}
-	// if got here, the category slots were full
-	return false;
+	PILOTAPPCATEGORY_SETCATEGORY(fAppInfo,label)
 }
 
 QString PilotAddress::getCategoryLabel() const
diff -urN -x CVS kdepim.orig/kpilot/lib/pilotAppCategory.h kdepim/kpilot/lib/pilotAppCategory.h
--- kdepim.orig/kpilot/lib/pilotAppCategory.h	Wed Sep 29 10:50:44 2004
+++ kdepim/kpilot/lib/pilotAppCategory.h	Mon Oct  4 00:40:24 2004
@@ -154,4 +154,27 @@
 	static QString codecName();
 };
 
+
+/*
+** Lacking templates, we need to do this with a macro. Since the
+** AppInfo for each class may be different, this needs to get
+** expanded in a context where the type of the AppInfo is known.
+*/
+
+#define PILOTAPPCATEGORY_SETCATEGORY(appinfo,label) \
+	int emptyAvailable = -1; \
+	if (label.isEmpty()) { setCat(0); return true; } \
+	for (int catId = 1; catId < 16; catId++) { \
+		QString aCat; \
+		if (!appinfo.category.name[catId][0]) { \
+			emptyAvailable=catId; continue; \
+		} \
+		aCat = codec()->toUnicode(appinfo.category.name[catId]); \
+		if (label == aCat) { setCat(catId); return true; } \
+	} \
+	if (emptyAvailable<0) return false; \
+	qstrncpy(appinfo.category.name[emptyAvailable], codec()->fromUnicode(label), 16); \
+	setCat(emptyAvailable); \
+	return true;
+
 #endif
diff -urN -x CVS kdepim.orig/kpilot/lib/pilotTodoEntry.cc kdepim/kpilot/lib/pilotTodoEntry.cc
--- kdepim.orig/kpilot/lib/pilotTodoEntry.cc	Tue Apr 20 01:49:11 2004
+++ kdepim/kpilot/lib/pilotTodoEntry.cc	Mon Oct  4 00:40:24 2004
@@ -36,7 +36,7 @@
 
 #include "pilotTodoEntry.h"
 
-static const char *pilotTodoEntry_id = "$Id$";
+static const char *pilotTodoEntry_id = "$Id$";
 
 
 PilotTodoEntry::PilotTodoEntry(struct ToDoAppInfo &appInfo):PilotAppCategory(), fAppInfo(appInfo)
@@ -143,33 +143,7 @@
 
 bool PilotTodoEntry::setCategory(const QString &label)
 {
-	FUNCTIONSETUP;
-	if (label.isEmpty())
-	{
-		setCat(0);
-		return true;
-	}
-	for (int catId = 0; catId < 16; catId++)
-	{
-		QString aCat = codec()->toUnicode(fAppInfo.category.name[catId]);
-
-		if (label == aCat)
-		{
-			setCat(catId);
-			return true;
-		}
-		else
-			// if empty, then no more labels; add it
-		if (aCat.isEmpty())
-		{
-			qstrncpy(fAppInfo.category.name[catId],
-				codec()->fromUnicode(label), 16);
-			setCat(catId);
-			return true;
-		}
-	}
-	// if got here, the category slots were full
-	return false;
+	PILOTAPPCATEGORY_SETCATEGORY(fAppInfo,label)
 }
 
 QString PilotTodoEntry::getCategoryLabel() const
diff -urN -x CVS kdepim.orig/kresources/egroupware/Makefile.am kdepim/kresources/egroupware/Makefile.am
--- kdepim.orig/kresources/egroupware/Makefile.am	Mon Jul 19 12:26:06 2004
+++ kdepim/kresources/egroupware/Makefile.am	Wed Oct  6 12:26:32 2004
@@ -22,7 +22,7 @@
 libknotes_xmlrpc_la_SOURCES = knotes_resourcexmlrpc.cpp knotes_resourcexmlrpcconfig.cpp xmlrpciface.cpp
 libknotes_xmlrpc_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -version-info 1:0:0 -no-undefined
 libknotes_xmlrpc_la_LIBADD = $(top_builddir)/libkcal/libkcal.la -lkdeprint \
-                             $(top_builddir)/knotes/libknotes.la
+                             $(top_builddir)/knotes/libknotesresources.la
 
 kabcincludedir = $(includedir)/kabc
 kabcinclude_HEADERS = kabc_resourcexmlrpc.h kcal_resourcexmlrpc.h
diff -urN -x CVS kdepim.orig/kresources/exchange/exchange.desktop kdepim/kresources/exchange/exchange.desktop
--- kdepim.orig/kresources/exchange/exchange.desktop	Sat Oct  2 16:30:38 2004
+++ kdepim/kresources/exchange/exchange.desktop	Mon Oct  4 15:26:37 2004
@@ -19,6 +19,7 @@
 Name[gl]=Calendario no Servidor Exchange2000
 Name[hu]=Exchange 2000 kiszolgálón tárolt naptár
 Name[it]=Calendario su un server Exchange2000
+Name[ja]=Exchange2000 サーバ上のカレンダ
 Name[nb]=Kalender på Exchange 2000-tjener
 Name[nl]=Agenda op Exchange2000-server
 Name[nn]=Kalender på Exchange 2000-tener
@@ -29,7 +30,7 @@
 Name[sk]=Kalendár na Exchange2000 serveri
 Name[sl]=Koledar na strežniku Exchange2000
 Name[sr]=Календар на Exchange2000 серверу
-Name[sr@Latn]=Календар на Exchange2000 серверу
+Name[sr@Latn]=Kalendar na Exchange2000 serveru
 Name[sv]=Kalender på en Exchange 2000-server
 Name[ta]=எக்ஸ்சேன்ஜ்2000  சேவையகத்தின் நாள்காட்டி
 Name[tg]=Тақвимоти Microsoft Exchange 2000
diff -urN -x CVS kdepim.orig/kresources/imap/kcal/imap.desktop kdepim/kresources/imap/kcal/imap.desktop
--- kdepim.orig/kresources/imap/kcal/imap.desktop	Sat Oct  2 16:30:38 2004
+++ kdepim/kresources/imap/kcal/imap.desktop	Mon Oct  4 15:26:37 2004
@@ -12,6 +12,7 @@
 Name[fr]=Calendrier sur un serveur IMAP via KMail
 Name[hu]=IMAP-kiszolgálón tárolt, a KMailen keresztül kezelt naptár
 Name[it]=Calendario su server IMAP via KMail
+Name[ja]=kmail 経由での IMAP サーバ上のカレンダ
 Name[nb]=Kalender på IMAP-tjener via KMail
 Name[nl]=Agenda op IMAP-server via KMail
 Name[nn]=Kalender på IMAP-tener via KMail
@@ -22,7 +23,7 @@
 Name[sk]=Kalendár na IMAP-serveri pomocou KMail
 Name[sl]=Koledar na strežniku IMAP preko KMaila
 Name[sr]=Календар на IMAP серверу преко Kmail-а
-Name[sr@Latn]=Календар на IMAP серверу преко Kmail-а
+Name[sr@Latn]=Kalendar na IMAP serveru preko Kmail-a
 Name[sv]=Kalender på en IMAP-server via Kmail
 Name[ta]=IMAP சேவையக வழியாக கேஅஞ்சலில் நாள்காட்டி
 Name[tg]=Тақвимот дар сервери IMAP аз KMail
diff -urN -x CVS kdepim.orig/kresources/imap/kcal/resourceimap.cpp kdepim/kresources/imap/kcal/resourceimap.cpp
--- kdepim.orig/kresources/imap/kcal/resourceimap.cpp	Wed Sep 29 10:13:20 2004
+++ kdepim/kresources/imap/kcal/resourceimap.cpp	Thu Oct  7 13:05:02 2004
@@ -2,7 +2,7 @@
     This file is part of libkcal.
 
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/kcal/resourceimap.h kdepim/kresources/imap/kcal/resourceimap.h
--- kdepim.orig/kresources/imap/kcal/resourceimap.h	Wed Aug  4 10:06:21 2004
+++ kdepim/kresources/imap/kcal/resourceimap.h	Thu Oct  7 13:05:02 2004
@@ -2,7 +2,7 @@
     This file is part of the libkcal IMAP resource.
 
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/kcal/resourceimap_plugin.cpp kdepim/kresources/imap/kcal/resourceimap_plugin.cpp
--- kdepim.orig/kresources/imap/kcal/resourceimap_plugin.cpp	Wed Aug  4 10:06:21 2004
+++ kdepim/kresources/imap/kcal/resourceimap_plugin.cpp	Thu Oct  7 13:05:02 2004
@@ -2,7 +2,7 @@
     This file is part of libkcal.
 
     Copyright (c) 2003 Steffen Hansen <steffen@klaralvdalens-datakonsult.se>
-    Copyright (c) 2003 - 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2003 - 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/knotes/Makefile.am kdepim/kresources/imap/knotes/Makefile.am
--- kdepim.orig/kresources/imap/knotes/Makefile.am	Thu Jul 15 11:21:53 2004
+++ kdepim/kresources/imap/knotes/Makefile.am	Wed Oct  6 12:28:04 2004
@@ -11,7 +11,7 @@
 libknotes_imap_la_LDFLAGS = $(all_libraries)
 libknotes_imap_la_LIBADD = -lkresources -lkdeprint \
 	$(top_builddir)/kresources/imap/shared/libresourceimapshared.la \
-	$(top_builddir)/knotes/libknotes.la \
+	$(top_builddir)/knotes/libknotesresources.la \
 	$(top_builddir)/libkcal/libkcal.la
 
 kde_module_LTLIBRARIES = knotes_imap.la
diff -urN -x CVS kdepim.orig/kresources/imap/knotes/resourceimap.cpp kdepim/kresources/imap/knotes/resourceimap.cpp
--- kdepim.orig/kresources/imap/knotes/resourceimap.cpp	Tue Jul 27 00:01:06 2004
+++ kdepim/kresources/imap/knotes/resourceimap.cpp	Fri Oct  8 14:43:47 2004
@@ -1,6 +1,6 @@
 /*
     This file is part of the IMAP resources.
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -84,8 +84,10 @@
   mSilent = true;
   for ( QStringList::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
     KCal::Journal* journal = parseJournal( *it );
-    if( journal )
+    if( journal ) {
       addNote( journal, resource );
+      mManager->registerNote( this, journal );
+    }
   }
   mSilent = silent;
   return true;
diff -urN -x CVS kdepim.orig/kresources/imap/knotes/resourceimap.h kdepim/kresources/imap/knotes/resourceimap.h
--- kdepim.orig/kresources/imap/knotes/resourceimap.h	Tue Jul 27 00:01:06 2004
+++ kdepim/kresources/imap/knotes/resourceimap.h	Thu Oct  7 13:05:02 2004
@@ -1,6 +1,6 @@
 /*
     This file is part of the IMAP resources.
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -85,7 +85,7 @@
 
   // Listen to KMail telling us the async load finished
   void asyncLoadResult( const QStringList&, const QString&, const QString& );
-  
+
   /** Return the list of subresources. */
   QStringList subresources() const;
 
@@ -103,7 +103,7 @@
 
   // parse a list of notes and add the result to the resource
   bool populate( const QStringList&, const QString& resource );
-  
+
   QString configFile() const {
     return ResourceIMAPBase::ResourceIMAPShared::configFile( "knotes" );
   }
diff -urN -x CVS kdepim.orig/kresources/imap/shared/kmailconnection.cpp kdepim/kresources/imap/shared/kmailconnection.cpp
--- kdepim.orig/kresources/imap/shared/kmailconnection.cpp	Tue Jul 27 00:01:07 2004
+++ kdepim/kresources/imap/shared/kmailconnection.cpp	Thu Oct  7 13:05:02 2004
@@ -1,7 +1,7 @@
 /*
     This file is part of the IMAP resources.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/shared/kmailconnection.h kdepim/kresources/imap/shared/kmailconnection.h
--- kdepim.orig/kresources/imap/shared/kmailconnection.h	Tue Jul 27 00:01:07 2004
+++ kdepim/kresources/imap/shared/kmailconnection.h	Thu Oct  7 13:05:02 2004
@@ -1,7 +1,7 @@
  /*
     This file is part of libkcal.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/shared/resourceimapshared.cpp kdepim/kresources/imap/shared/resourceimapshared.cpp
--- kdepim.orig/kresources/imap/shared/resourceimapshared.cpp	Sun Jun 27 16:57:56 2004
+++ kdepim/kresources/imap/shared/resourceimapshared.cpp	Thu Oct  7 13:05:02 2004
@@ -1,7 +1,7 @@
 /*
     This file is part of the IMAP resources.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/imap/shared/resourceimapshared.h kdepim/kresources/imap/shared/resourceimapshared.h
--- kdepim.orig/kresources/imap/shared/resourceimapshared.h	Tue Jul 27 00:01:07 2004
+++ kdepim/kresources/imap/shared/resourceimapshared.h	Thu Oct  7 13:05:02 2004
@@ -1,7 +1,7 @@
  /*
     This file is part of libkcal.
 
-    Copyright (c) 2004 Bo Thorsen <bo@klaralvdalens-datakonsult.se>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
diff -urN -x CVS kdepim.orig/kresources/remote/resourceremote_plugin.cpp kdepim/kresources/remote/resourceremote_plugin.cpp
--- kdepim.orig/kresources/remote/resourceremote_plugin.cpp	Mon Jul 19 12:26:08 2004
+++ kdepim/kresources/remote/resourceremote_plugin.cpp	Sun Oct 10 21:22:29 2004
@@ -31,6 +31,7 @@
 {
   void *init_kcal_remote()
   {
+    KGlobal::locale()->insertCatalogue( "libkcal" );
     KGlobal::locale()->insertCatalogue( "kres_remote" );
     return new KRES::PluginFactory<ResourceRemote,ResourceRemoteConfig>();
   }
diff -urN -x CVS kdepim.orig/kresources/slox/kcal_slox.desktop kdepim/kresources/slox/kcal_slox.desktop
--- kdepim.orig/kresources/slox/kcal_slox.desktop	Sat Oct  2 16:30:39 2004
+++ kdepim/kresources/slox/kcal_slox.desktop	Mon Oct  4 15:26:37 2004
@@ -12,6 +12,7 @@
 Name[fr]=Ressources de calendrier SLOX
 Name[hu]=SLOX naptár-erőforrás
 Name[it]=Risorsa calendario SLOX
+Name[ja]=SLOX カレンダー リソース
 Name[nb]=SLOX kalender kilde
 Name[nl]=SLOX Agendahulpbron
 Name[nn]=SLOX kalenderkjelde
@@ -22,7 +23,7 @@
 Name[sk]=Kalendárový zdroj SLOX
 Name[sl]=Koledarski vir SLOX
 Name[sr]=SLOX ресурс календара
-Name[sr@Latn]=SLOX ресурс календара
+Name[sr@Latn]=SLOX resurs kalendara
 Name[sv]=SLOX-kalenderresurs
 Name[ta]=SLOX நாள்காட்டி மூலம்
 Name[tg]=Тақвимоти SLOX
diff -urN -x CVS kdepim.orig/kresources/slox/kcalresourceslox_plugin.cpp kdepim/kresources/slox/kcalresourceslox_plugin.cpp
--- kdepim.orig/kresources/slox/kcalresourceslox_plugin.cpp	Mon Jul 19 12:26:08 2004
+++ kdepim/kresources/slox/kcalresourceslox_plugin.cpp	Sun Oct 10 21:24:36 2004
@@ -30,6 +30,7 @@
 {
   void *init_kcal_slox()
   {
+    KGlobal::locale()->insertCatalogue( "libkcal" );
     KGlobal::locale()->insertCatalogue( "kabc_slox" );
     return new KRES::PluginFactory<KCalResourceSlox,KCalResourceSloxConfig>();
   }
diff -urN -x CVS kdepim.orig/kresources/slox/webdavhandler.cpp kdepim/kresources/slox/webdavhandler.cpp
--- kdepim.orig/kresources/slox/webdavhandler.cpp	Tue Sep 28 16:25:44 2004
+++ kdepim/kresources/slox/webdavhandler.cpp	Fri Oct  8 01:35:53 2004
@@ -20,7 +20,13 @@
 
 #include "webdavhandler.h"
 
+#ifdef HAVE_VALUES_H
 #include <values.h>
+#else
+#ifdef HAVE_SYS_LIMITS_H
+#include <sys/limits.h>
+#endif
+#endif
 
 #include <libkdepim/kpimprefs.h>
 
@@ -150,9 +156,9 @@
 
   if (preEpoch) {
     dt.setTime_t( 0, Qt::UTC );
-    if (ticks > MAXINT) {
-      dt = dt.addSecs(-MAXINT);
-      ticks -= MAXINT;
+    if (ticks > INT_MAX) {
+      dt = dt.addSecs(-INT_MAX);
+      ticks -= INT_MAX;
     }
     dt = dt.addSecs(-((long) ticks));
   }
diff -urN -x CVS kdepim.orig/ktnef/ktnef/ktnefwriter.h kdepim/ktnef/ktnef/ktnefwriter.h
--- kdepim.orig/ktnef/ktnef/ktnefwriter.h	Wed Nov 27 22:44:39 2002
+++ kdepim/ktnef/ktnef/ktnefwriter.h	Thu Oct  7 13:05:03 2004
@@ -1,7 +1,7 @@
 /*
     ktnefwriter.cpp
 
-    Copyright (C) 2002 Bo Thorsen  <bo@klaralvdalens-datakonsult.se>
+    Copyright (C) 2002 Bo Thorsen  <bo@sonofthor.dk>
 
     This file is part of KTNEF, the KDE TNEF support library/program.
 
@@ -52,7 +52,7 @@
 
   enum PartStat {
     NeedsAction, Accepted, Declined, Tentative,
-    Delegated, Completed, InProcess    
+    Delegated, Completed, InProcess
   };
 
   enum Priority {
@@ -68,7 +68,7 @@
   void setMessageType(MessageType m);
   void setMethod( Method m );
   void clearAttendees();
-  void addAttendee( const QString& cn, Role r, PartStat p, bool rsvp, 
+  void addAttendee( const QString& cn, Role r, PartStat p, bool rsvp,
                     const QString& mailto );
   void setOrganizer( const QString& organizer ); // Is that the same as sender???
   void setDtStart( const QDateTime& dtStart );
diff -urN -x CVS kdepim.orig/ktnef/lib/ktnefwriter.cpp kdepim/ktnef/lib/ktnefwriter.cpp
--- kdepim.orig/ktnef/lib/ktnefwriter.cpp	Wed Nov 27 22:44:39 2002
+++ kdepim/ktnef/lib/ktnefwriter.cpp	Thu Oct  7 13:05:03 2004
@@ -1,7 +1,7 @@
 /*
     ktnefwriter.cpp
 
-    Copyright (C) 2002 Bo Thorsen  <bo@klaralvdalens-datakonsult.se>
+    Copyright (C) 2002 Bo Thorsen  <bo@sonofthor.dk>
 
     This file is part of KTNEF, the KDE TNEF support library/program.
 
@@ -397,20 +397,20 @@
 
 void KTNEFWriter::setMethod( Method )
 {
-    
+
 }
 
 
 void KTNEFWriter::clearAttendees()
 {
-    
+
 }
 
 
 void KTNEFWriter::addAttendee( const QString& /*cn*/, Role /*r*/, PartStat /*p*/,
 			       bool /*rsvp*/, const QString& /*mailto*/ )
 {
-    
+
 }
 
 
@@ -447,7 +447,7 @@
 
 void KTNEFWriter::setLocation( const QString& /*location*/ )
 {
-    
+
 }
 
 
@@ -466,7 +466,7 @@
 
 void KTNEFWriter::setCategories( const QStringList& )
 {
-    
+
 }
 
 
@@ -493,5 +493,5 @@
 void KTNEFWriter::setAlarm( const QString& /*description*/, AlarmAction /*action*/,
                             const QDateTime& /*wakeBefore*/ )
 {
-    
+
 }
diff -urN -x CVS kdepim.orig/libkcal/Makefile.am kdepim/libkcal/Makefile.am
--- kdepim.orig/libkcal/Makefile.am	Tue Jul 13 02:04:17 2004
+++ kdepim/libkcal/Makefile.am	Fri Oct  8 15:04:39 2004
@@ -1,6 +1,6 @@
 SUBDIRS = versit tests
 
-INCLUDES = -I$(top_srcdir)/libical/src/libical \
+INCLUDES = -I$(top_srcdir)/libical/src/libical -I$(top_srcdir)/ktnef \
   -I$(top_srcdir)/libical/src/libicalss -I$(top_builddir)/libical/src/libical \
   -I$(top_builddir)/libical/src/libicalss -I$(srcdir)/versit -I$(top_srcdir)/ \
   $(all_includes)
@@ -10,6 +10,7 @@
 libkcal_la_LIBADD  = versit/libversit.la $(LIB_KIO) \
                      $(top_builddir)/libical/src/libical/libical.la \
                      $(top_builddir)/libical/src/libicalss/libicalss.la \
+                     $(top_builddir)/ktnef/lib/libktnef.la \
                      -lkresources -lkabc
 
 libkcal_la_COMPILE_FIRST = $(top_builddir)/libical/src/libical/ical.h $(top_builddir)/libical/src/libicalss/icalss.h
@@ -18,6 +19,7 @@
 	freebusy.cpp attendee.cpp attachment.cpp recurrence.cpp alarm.cpp \
 	customproperties.cpp calendar.cpp calendarlocal.cpp \
 	calformat.cpp vcalformat.cpp icalformat.cpp icalformatimpl.cpp \
+        incidenceformatter.cpp \
 	vcaldrag.cpp icaldrag.cpp \
 	exceptions.cpp \
 	scheduler.cpp imipscheduler.cpp dummyscheduler.cpp \
@@ -39,7 +41,7 @@
   calendarlocal.h calendarnull.h calendarresources.h calfilter.h calformat.h \
   calstorage.h compat.h customproperties.h dndfactory.h duration.h event.h \
   exceptions.h filestorage.h freebusy.h htmlexport.h icaldrag.h icalformat.h \
-  incidencebase.h incidence.h journal.h kcalversion.h listbase.h period.h person.h \
+  incidencebase.h incidence.h incidenceformatter.h journal.h kcalversion.h listbase.h period.h person.h \
   qtopiaformat.h recurrence.h resourcecached.h resourcecalendar.h \
   resourcelocalconfig.h resourcelocaldirconfig.h resourcelocaldir.h \
   resourcelocal.h scheduler.h \
diff -urN -x CVS kdepim.orig/libkcal/freebusycache.h kdepim/libkcal/freebusycache.h
--- kdepim.orig/libkcal/freebusycache.h	Tue Jan 27 23:00:29 2004
+++ kdepim/libkcal/freebusycache.h	Thu Oct  7 11:20:12 2004
@@ -33,7 +33,8 @@
     /**
       Save freebusy information belonging to an email.
     */
-    virtual bool saveFreeBusy( FreeBusy *, const QString &email ) = 0;
+    virtual bool saveFreeBusy( FreeBusy *freebusy, const Person &person ) = 0;
+//    virtual bool saveFreeBusy( FreeBusy *, const QString &email ) = 0;
 
     /**
       Load freebusy information belonging to an email.
diff -urN -x CVS kdepim.orig/libkcal/htmlexport.cpp kdepim/libkcal/htmlexport.cpp
--- kdepim.orig/libkcal/htmlexport.cpp	Sat Feb 21 23:58:17 2004
+++ kdepim/libkcal/htmlexport.cpp	Thu Oct  7 11:20:12 2004
@@ -499,15 +499,15 @@
 #ifndef KORG_NOKABC
     KABC::AddressBook *add_book = KABC::StdAddressBook::self();
     KABC::Addressee::List addressList;
-    addressList = add_book->findByEmail(event->organizer());
+    addressList = add_book->findByEmail(event->organizer().email());
     KABC::Addressee o = addressList.first();
     if (!o.isEmpty() && addressList.size()<2) {
-      *ts << "<a href=\"mailto:" << event->organizer() << "\">";
+      *ts << "<a href=\"mailto:" << event->organizer().email() << "\">";
       *ts << cleanChars(o.formattedName()) << "</a>\n";
     }
-		else *ts << event->organizer();
+		else *ts << event->organizer().fullName();
 #else
-	  *ts << event->organizer();
+	  *ts << event->organizer().fullName();
 #endif
     *ts << "</em><br />";
     Attendee::List::ConstIterator it;
diff -urN -x CVS kdepim.orig/libkcal/icalformatimpl.cpp kdepim/libkcal/icalformatimpl.cpp
--- kdepim.orig/libkcal/icalformatimpl.cpp	Sat Aug 14 15:19:29 2004
+++ kdepim/libkcal/icalformatimpl.cpp	Wed Oct 13 10:16:05 2004
@@ -707,8 +707,7 @@
       writeICalDateTime( QDateTime::currentDateTime() ) ) );
 
   // organizer stuff
-  icalcomponent_add_property( parent, icalproperty_new_organizer(
-      ( "MAILTO:" + incidenceBase->organizer() ).utf8() ) );
+  icalcomponent_add_property( parent, writeOrganizer( incidenceBase->organizer() ) );
 
   // attendees
   if ( incidenceBase->attendeeCount() > 0 ) {
@@ -739,6 +738,19 @@
   }
 }
 
+icalproperty *ICalFormatImpl::writeOrganizer( const Person &organizer )
+{
+  icalproperty *p = icalproperty_new_organizer("MAILTO:" + organizer.email().utf8());
+
+  if (!organizer.name().isEmpty()) {
+    icalproperty_add_parameter( p, icalparameter_new_cn(organizer.name().utf8()) );
+  }
+  // TODO: Write dir, senty-by and language
+
+  return p;
+}
+
+
 icalproperty *ICalFormatImpl::writeAttendee(Attendee *attendee)
 {
   icalproperty *p = icalproperty_new_attendee("mailto:" + attendee->email().utf8());
@@ -1429,6 +1441,25 @@
   return new Attendee( name, email, rsvp, status, role, uid );
 }
 
+Person ICalFormatImpl::readOrganizer( icalproperty *organizer )
+{
+  QString email = QString::fromUtf8(icalproperty_get_organizer(organizer));
+  if ( email.startsWith("mailto:", false ) ) {
+    email = email.remove(0,7);
+  }
+  QString cn;
+  
+  icalparameter *p = icalproperty_get_first_parameter( 
+             organizer, ICAL_CN_PARAMETER );
+  
+  if ( p ) {
+    cn = QString::fromUtf8( icalparameter_get_cn( p ) );
+  }
+  Person org( cn, email );
+  // TODO: Treat sent-by, dir and language here, too
+  return org;
+}
+
 Attachment *ICalFormatImpl::readAttachment(icalproperty *attach)
 {
   icalattachtype *a = icalproperty_get_attach(attach);
@@ -1637,7 +1668,7 @@
         break;
 
       case ICAL_ORGANIZER_PROPERTY:  // organizer
-        incidenceBase->setOrganizer(QString::fromUtf8(icalproperty_get_organizer(p)));
+        incidenceBase->setOrganizer( readOrganizer(p));
         break;
 
       case ICAL_ATTENDEE_PROPERTY:  // attendee
@@ -2498,10 +2529,24 @@
 
   icalcomponent_add_property(message,icalproperty_new_method(icalmethod));
 
-  // TODO: check, if dynamic cast is required
   if(incidence->type() == "Todo") {
     Todo *todo = static_cast<Todo *>(incidence);
-    icalcomponent_add_component(message,writeTodo(todo));
+    icalcomponent *vtodo = writeTodo(todo);
+    /*
+     * RFC 2446 states in section 3.4.3 ( REPLY to a VTODO ), that
+     * a REQUEST-STATUS property has to be present. Until we do more 
+     * fine grained handling, assume all is well. Note that this is the 
+     * status of the _request_, not the attendee. Just to avoid confusion.
+     * - till
+     */
+    if ( icalmethod == ICAL_METHOD_REPLY ) {
+      struct icalreqstattype rst;
+      rst.code = ICAL_2_0_SUCCESS_STATUS;
+      rst.desc = 0;
+      rst.debug = 0;
+      icalcomponent_add_property( vtodo, icalproperty_new_requeststatus( rst ) );
+    }
+    icalcomponent_add_component(message,vtodo);
   }
   if(incidence->type() == "Event") {
     Event *event = static_cast<Event *>(incidence);
diff -urN -x CVS kdepim.orig/libkcal/icalformatimpl.h kdepim/libkcal/icalformatimpl.h
--- kdepim.orig/libkcal/icalformatimpl.h	Fri Dec 19 18:00:05 2003
+++ kdepim/libkcal/icalformatimpl.h	Thu Oct  7 11:20:12 2004
@@ -58,6 +58,7 @@
     icalcomponent *writeJournal(Journal *journal);
     void writeIncidence(icalcomponent *parent,Incidence *incidence);
     icalproperty *writeAttendee(Attendee *attendee);
+    icalproperty *writeOrganizer( const Person &organizer );
     icalproperty *writeAttachment(Attachment *attach);
     icalproperty *writeRecurrenceRule(Recurrence *);
     icalproperty *writeAlarm(Alarm *alarm);
@@ -68,6 +69,7 @@
     FreeBusy *readFreeBusy(icalcomponent *vfreebusy);
     Journal *readJournal(icalcomponent *vjournal);
     Attendee *readAttendee(icalproperty *attendee);
+    Person readOrganizer( icalproperty *organizer );
     Attachment *readAttachment(icalproperty *attach);
     void readIncidence(icalcomponent *parent,Incidence *incidence);
     void readRecurrenceRule(icalproperty *rrule,Incidence *event);
diff -urN -x CVS kdepim.orig/libkcal/incidencebase.cpp kdepim/libkcal/incidencebase.cpp
--- kdepim.orig/libkcal/incidencebase.cpp	Sun Sep 26 15:20:11 2004
+++ kdepim/libkcal/incidencebase.cpp	Thu Oct  7 11:20:12 2004
@@ -133,19 +133,27 @@
   return mLastModified;
 }
 
-void IncidenceBase::setOrganizer(const QString &o)
+void IncidenceBase::setOrganizer( const Person &o )
 {
   // we don't check for readonly here, because it is
   // possible that by setting the organizer we are changing
   // the event's readonly status...
   mOrganizer = o;
-  if (mOrganizer.left(7).upper() == "MAILTO:")
-    mOrganizer = mOrganizer.remove(0,7);
 
   updated();
 }
 
-QString IncidenceBase::organizer() const
+void IncidenceBase::setOrganizer(const QString &o)
+{
+  QString mail( o );
+  if ( mail.startsWith("MAILTO:", false) )
+    mail = mail.remove( 0, 7 );
+  // split the string into full name plus email.
+  Person organizer( mail );
+  setOrganizer( organizer );
+}
+
+Person IncidenceBase::organizer() const
 {
   return mOrganizer;
 }
diff -urN -x CVS kdepim.orig/libkcal/incidencebase.h kdepim/libkcal/incidencebase.h
--- kdepim.orig/libkcal/incidencebase.h	Sun Jul 25 12:23:24 2004
+++ kdepim/libkcal/incidencebase.h	Thu Oct  7 11:20:12 2004
@@ -63,8 +63,9 @@
     QDateTime lastModified() const;
 
     /** sets the organizer for the event */
+    void setOrganizer( const Person &o );
     void setOrganizer( const QString &o );
-    QString organizer() const;
+    Person organizer() const;
 
     /** Set readonly status. */
     virtual void setReadOnly( bool );
@@ -201,7 +202,7 @@
   private:
     // base components
     QDateTime mDtStart;
-    QString mOrganizer;
+    Person mOrganizer;
     QString mUid;
     QDateTime mLastModified;
     Attendee::List mAttendees;
diff -urN -x CVS kdepim.orig/libkcal/incidenceformatter.cpp kdepim/libkcal/incidenceformatter.cpp
--- kdepim.orig/libkcal/incidenceformatter.cpp	Thu Jan  1 01:00:00 1970
+++ kdepim/libkcal/incidenceformatter.cpp	Thu Oct  7 11:20:23 2004
@@ -0,0 +1,490 @@
+/*
+    This file is part of libkcal.
+    Copyright (c) 2001 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+    Boston, MA 02111-1307, USA.
+*/
+
+#include "incidenceformatter.h"
+
+#include <libkcal/attachment.h>
+#include <libkcal/event.h>
+#include <libkcal/todo.h>
+#include <libkcal/journal.h>
+#include <libkcal/calendar.h>
+#include <libkcal/calendarlocal.h>
+#include <libkcal/icalformat.h>
+#include <libkcal/freebusy.h>
+
+#include <libkdepim/email.h>
+
+#include <ktnef/ktnefparser.h>
+#include <ktnef/ktnefmessage.h>
+#include <ktnef/ktnefdefs.h>
+#include <kabc/phonenumber.h>
+#include <kabc/vcardconverter.h>
+#include <kabc/stdaddressbook.h>
+
+#include <kapplication.h>
+// #include <kdebug.h>
+
+#include <klocale.h>
+#include <kiconloader.h>
+
+#include <qbuffer.h>
+
+#include <time.h>
+
+
+using namespace KCal;
+
+
+static QString stringProp( KTNEFMessage* tnefMsg, const Q_UINT32& key,
+                           const QString& fallback = QString::null)
+{
+  return tnefMsg->findProp( key < 0x10000 ? key & 0xFFFF : key >> 16,
+                            fallback );
+}
+
+static QString sNamedProp( KTNEFMessage* tnefMsg, const QString& name,
+                           const QString& fallback = QString::null )
+{
+  return tnefMsg->findNamedProp( name, fallback );
+}
+
+struct save_tz { char* old_tz; char* tz_env_str; };
+
+/* temporarily go to a different timezone */
+static struct save_tz set_tz( const char* _tc )
+{
+  const char *tc = _tc?_tc:"UTC";
+
+  struct save_tz rv;
+
+  rv.old_tz = 0;
+  rv.tz_env_str = 0;
+
+  //kdDebug(5006) << "set_tz(), timezone before = " << timezone << endl;
+
+  char* tz_env = 0;
+  if( getenv( "TZ" ) ) {
+    tz_env = strdup( getenv( "TZ" ) );
+    rv.old_tz = tz_env;
+  }
+  char* tmp_env = (char*)malloc( strlen( tc ) + 4 );
+  strcpy( tmp_env, "TZ=" );
+  strcpy( tmp_env+3, tc );
+  putenv( tmp_env );
+
+  rv.tz_env_str = tmp_env;
+
+  /* tmp_env is not free'ed -- it is part of the environment */
+
+  tzset();
+  //kdDebug(5006) << "set_tz(), timezone after = " << timezone << endl;
+
+  return rv;
+}
+
+/* restore previous timezone */
+static void unset_tz( struct save_tz old_tz )
+{
+  if( old_tz.old_tz ) {
+    char* tmp_env = (char*)malloc( strlen( old_tz.old_tz ) + 4 );
+    strcpy( tmp_env, "TZ=" );
+    strcpy( tmp_env+3, old_tz.old_tz );
+    putenv( tmp_env );
+    /* tmp_env is not free'ed -- it is part of the environment */
+    free( old_tz.old_tz );
+  } else {
+    /* clear TZ from env */
+    putenv( strdup("TZ") );
+  }
+  tzset();
+
+  /* is this OK? */
+  if( old_tz.tz_env_str ) free( old_tz.tz_env_str );
+}
+
+static QDateTime utc2Local( const QDateTime& utcdt )
+{
+  struct tm tmL;
+
+  save_tz tmp_tz = set_tz("UTC");
+  time_t utc = utcdt.toTime_t();
+  unset_tz( tmp_tz );
+
+  localtime_r( &utc, &tmL );
+  return QDateTime( QDate( tmL.tm_year+1900, tmL.tm_mon+1, tmL.tm_mday ),
+                    QTime( tmL.tm_hour, tmL.tm_min, tmL.tm_sec ) );
+}
+
+
+static QDateTime pureISOToLocalQDateTime( const QString& dtStr,
+                                          bool bDateOnly = false )
+{
+  QDate tmpDate;
+  QTime tmpTime;
+  int year, month, day, hour, minute, second;
+
+  if( bDateOnly ) {
+    year = dtStr.left( 4 ).toInt();
+    month = dtStr.mid( 4, 2 ).toInt();
+    day = dtStr.mid( 6, 2 ).toInt();
+    hour = 0;
+    minute = 0;
+    second = 0;
+  } else {
+    year = dtStr.left( 4 ).toInt();
+    month = dtStr.mid( 4, 2 ).toInt();
+    day = dtStr.mid( 6, 2 ).toInt();
+    hour = dtStr.mid( 9, 2 ).toInt();
+    minute = dtStr.mid( 11, 2 ).toInt();
+    second = dtStr.mid( 13, 2 ).toInt();
+  }
+  tmpDate.setYMD( year, month, day );
+  tmpTime.setHMS( hour, minute, second );
+
+  if( tmpDate.isValid() && tmpTime.isValid() ) {
+    QDateTime dT = QDateTime( tmpDate, tmpTime );
+
+    if( !bDateOnly ) {
+      // correct for GMT ( == Zulu time == UTC )
+      if (dtStr.at(dtStr.length()-1) == 'Z') {
+        //dT = dT.addSecs( 60 * KRFCDate::localUTCOffset() );
+        //localUTCOffset( dT ) );
+        dT = utc2Local( dT );
+      }
+    }
+    return dT;
+  } else
+    return QDateTime();
+}
+
+
+
+QString IncidenceFormatter::msTNEFToVPart( const QByteArray& tnef )
+{
+  bool bOk = false;
+
+  KTNEFParser parser;
+  QBuffer buf( tnef );
+  CalendarLocal cal;
+  KABC::Addressee addressee;
+  KABC::VCardConverter cardConv;
+  ICalFormat calFormat;
+  Event* event = new Event();
+
+  if( parser.openDevice( &buf ) ) {
+    KTNEFMessage* tnefMsg = parser.message();
+    //QMap<int,KTNEFProperty*> props = parser.message()->properties();
+
+    // Everything depends from property PR_MESSAGE_CLASS
+    // (this is added by KTNEFParser):
+    QString msgClass = tnefMsg->findProp( 0x001A, QString::null, true )
+      .upper();
+    if( !msgClass.isEmpty() ) {
+      // Match the old class names that might be used by Outlook for
+      // compatibility with Microsoft Mail for Windows for Workgroups 3.1.
+      bool bCompatClassAppointment = false;
+      bool bCompatMethodRequest = false;
+      bool bCompatMethodCancled = false;
+      bool bCompatMethodAccepted = false;
+      bool bCompatMethodAcceptedCond = false;
+      bool bCompatMethodDeclined = false;
+      if( msgClass.startsWith( "IPM.MICROSOFT SCHEDULE." ) ) {
+        bCompatClassAppointment = true;
+        if( msgClass.endsWith( ".MTGREQ" ) )
+          bCompatMethodRequest = true;
+        if( msgClass.endsWith( ".MTGCNCL" ) )
+          bCompatMethodCancled = true;
+        if( msgClass.endsWith( ".MTGRESPP" ) )
+          bCompatMethodAccepted = true;
+        if( msgClass.endsWith( ".MTGRESPA" ) )
+          bCompatMethodAcceptedCond = true;
+        if( msgClass.endsWith( ".MTGRESPN" ) )
+          bCompatMethodDeclined = true;
+      }
+      bool bCompatClassNote = ( msgClass == "IPM.MICROSOFT MAIL.NOTE" );
+
+      if( bCompatClassAppointment || "IPM.APPOINTMENT" == msgClass ) {
+        // Compose a vCal
+        bool bIsReply = false;
+        QString prodID = "-//Microsoft Corporation//Outlook ";
+        prodID += tnefMsg->findNamedProp( "0x8554", "9.0" );
+        prodID += "MIMEDIR/EN\n";
+        prodID += "VERSION:2.0\n";
+        calFormat.setApplication( "Outlook", prodID );
+
+        Scheduler::Method method;
+        if( bCompatMethodRequest )
+          method = Scheduler::Request;
+        else if( bCompatMethodCancled )
+          method = Scheduler::Cancel;
+        else if( bCompatMethodAccepted || bCompatMethodAcceptedCond ||
+                 bCompatMethodDeclined ) {
+          method = Scheduler::Reply;
+          bIsReply = true;
+        } else {
+          // pending(khz): verify whether "0x0c17" is the right tag ???
+          //
+          // at the moment we think there are REQUESTS and UPDATES
+          //
+          // but WHAT ABOUT REPLIES ???
+          //
+          //
+
+          if( tnefMsg->findProp(0x0c17) == "1" )
+            bIsReply = true;
+          method = Scheduler::Request;
+        }
+
+        /// ###  FIXME Need to get this attribute written
+        ScheduleMessage schedMsg(event, method, ScheduleMessage::Unknown );
+
+        QString sSenderSearchKeyEmail( tnefMsg->findProp( 0x0C1D ) );
+
+        if( !sSenderSearchKeyEmail.isEmpty() ) {
+          int colon = sSenderSearchKeyEmail.find( ':' );
+          // May be e.g. "SMTP:KHZ@KDE.ORG"
+          if( sSenderSearchKeyEmail.find( ':' ) == -1 )
+            sSenderSearchKeyEmail.remove( 0, colon+1 );
+        }
+
+        QString s( tnefMsg->findProp( 0x0e04 ) );
+        QStringList attendees = QStringList::split( ';', s );
+        if( attendees.count() ) {
+          for( QStringList::Iterator it = attendees.begin();
+               it != attendees.end(); ++it ) {
+            // Skip all entries that have no '@' since these are
+            // no mail addresses
+            if( (*it).find('@') == -1 ) {
+              s = (*it).stripWhiteSpace();
+
+              Attendee *attendee = new Attendee( s, s, true );
+              if( bIsReply ) {
+                if( bCompatMethodAccepted )
+                  attendee->setStatus( Attendee::Accepted );
+                if( bCompatMethodDeclined )
+                  attendee->setStatus( Attendee::Declined );
+                if( bCompatMethodAcceptedCond )
+                  attendee->setStatus(Attendee::Tentative);
+              } else {
+                attendee->setStatus( Attendee::NeedsAction );
+                attendee->setRole( Attendee::ReqParticipant );
+              }
+              event->addAttendee(attendee);
+            }
+          }
+        } else {
+          // Oops, no attendees?
+          // This must be old style, let us use the PR_SENDER_SEARCH_KEY.
+          s = sSenderSearchKeyEmail;
+          if( !s.isEmpty() ) {
+            Attendee *attendee = new Attendee( QString::null, QString::null,
+                                               true );
+            if( bIsReply ) {
+              if( bCompatMethodAccepted )
+                attendee->setStatus( Attendee::Accepted );
+              if( bCompatMethodAcceptedCond )
+                attendee->setStatus( Attendee::Declined );
+              if( bCompatMethodDeclined )
+                attendee->setStatus( Attendee::Tentative );
+            } else {
+              attendee->setStatus(Attendee::NeedsAction);
+              attendee->setRole(Attendee::ReqParticipant);
+            }
+            event->addAttendee(attendee);
+          }
+        }
+        s = tnefMsg->findProp( 0x0c1f ); // look for organizer property
+        if( s.isEmpty() && !bIsReply )
+          s = sSenderSearchKeyEmail;
+        // TODO: Use the common name?
+        if( !s.isEmpty() )
+          event->setOrganizer( s );
+
+        s = tnefMsg->findProp( 0x8516 ).replace( QChar( '-' ), QString::null )
+          .replace( QChar( ':' ), QString::null );
+        event->setDtStart( QDateTime::fromString( s ) ); // ## Format??
+
+        s = tnefMsg->findProp( 0x8517 ).replace( QChar( '-' ), QString::null )
+          .replace( QChar( ':' ), QString::null );
+        event->setDtEnd( QDateTime::fromString( s ) );
+
+        s = tnefMsg->findProp( 0x8208 );
+        event->setLocation( s );
+
+        // is it OK to set this to OPAQUE always ??
+        //vPart += "TRANSP:OPAQUE\n"; ###FIXME, portme!
+        //vPart += "SEQUENCE:0\n";
+
+        // is "0x0023" OK  -  or should we look for "0x0003" ??
+        s = tnefMsg->findProp( 0x0023 );
+        event->setUid( s );
+
+        // PENDING(khz): is this value in local timezone? Must it be
+        // adjusted? Most likely this is a bug in the server or in
+        // Outlook - we ignore it for now.
+        s = tnefMsg->findProp( 0x8202 ).replace( QChar( '-' ), QString::null )
+          .replace( QChar( ':' ), QString::null );
+        // ### libkcal always uses currentDateTime()
+        // event->setDtStamp(QDateTime::fromString(s));
+
+        s = tnefMsg->findNamedProp( "Keywords" );
+        event->setCategories( s );
+
+        s = tnefMsg->findProp( 0x1000 );
+        event->setDescription( s );
+
+        s = tnefMsg->findProp( 0x0070 );
+        event->setSummary( s );
+
+        s = tnefMsg->findProp( 0x0026 );
+        event->setPriority( s.toInt() );
+
+        // is reminder flag set ?
+        if(!tnefMsg->findProp(0x8503).isEmpty()) {
+          Alarm *alarm = new Alarm(event);
+          QDateTime highNoonTime =
+            pureISOToLocalQDateTime( tnefMsg->findProp( 0x8502 )
+                                     .replace( QChar( '-' ), "" )
+                                     .replace( QChar( ':' ), "" ) );
+          QDateTime wakeMeUpTime =
+            pureISOToLocalQDateTime( tnefMsg->findProp( 0x8560, "" )
+                                     .replace( QChar( '-' ), "" )
+                                     .replace( QChar( ':' ), "" ) );
+          alarm->setTime(wakeMeUpTime);
+
+          if( highNoonTime.isValid() && wakeMeUpTime.isValid() )
+            alarm->setStartOffset( Duration( highNoonTime, wakeMeUpTime ) );
+          else
+            // default: wake them up 15 minutes before the appointment
+            alarm->setStartOffset( Duration( 15*60 ) );
+          alarm->setDisplayAlarm( i18n( "Reminder" ) );
+
+          // Sorry: the different action types are not known (yet)
+          //        so we always set 'DISPLAY' (no sounds, no images...)
+          event->addAlarm( alarm );
+        }
+        cal.addEvent( event );
+        bOk = true;
+        // we finished composing a vCal
+      } else if( bCompatClassNote || "IPM.CONTACT" == msgClass ) {
+        addressee.setUid( stringProp( tnefMsg, attMSGID ) );
+        addressee.setFormattedName( stringProp( tnefMsg, MAPI_TAG_PR_DISPLAY_NAME ) );
+        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL1EMAILADDRESS ), true );
+        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL2EMAILADDRESS ), false );
+        addressee.insertEmail( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_EMAIL3EMAILADDRESS ), false );
+        addressee.insertCustom( "KADDRESSBOOK", "X-IMAddress", sNamedProp( tnefMsg, MAPI_TAG_CONTACT_IMADDRESS ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-SpousesName", stringProp( tnefMsg, MAPI_TAG_PR_SPOUSE_NAME ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-ManagersName", stringProp( tnefMsg, MAPI_TAG_PR_MANAGER_NAME ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-AssistantsName", stringProp( tnefMsg, MAPI_TAG_PR_ASSISTANT ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-Department", stringProp( tnefMsg, MAPI_TAG_PR_DEPARTMENT_NAME ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-Office", stringProp( tnefMsg, MAPI_TAG_PR_OFFICE_LOCATION ) );
+        addressee.insertCustom( "KADDRESSBOOK", "X-Profession", stringProp( tnefMsg, MAPI_TAG_PR_PROFESSION ) );
+
+        QString s = tnefMsg->findProp( MAPI_TAG_PR_WEDDING_ANNIVERSARY )
+          .replace( QChar( '-' ), QString::null )
+          .replace( QChar( ':' ), QString::null );
+        if( !s.isEmpty() )
+          addressee.insertCustom( "KADDRESSBOOK", "X-Anniversary", s );
+
+        addressee.setUrl( KURL( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_WEBPAGE )  ) );
+
+        // collect parts of Name entry
+        addressee.setFamilyName( stringProp( tnefMsg, MAPI_TAG_PR_SURNAME ) );
+        addressee.setGivenName( stringProp( tnefMsg, MAPI_TAG_PR_GIVEN_NAME ) );
+        addressee.setAdditionalName( stringProp( tnefMsg, MAPI_TAG_PR_MIDDLE_NAME ) );
+        addressee.setPrefix( stringProp( tnefMsg, MAPI_TAG_PR_DISPLAY_NAME_PREFIX ) );
+        addressee.setSuffix( stringProp( tnefMsg, MAPI_TAG_PR_GENERATION ) );
+
+        addressee.setNickName( stringProp( tnefMsg, MAPI_TAG_PR_NICKNAME ) );
+        addressee.setRole( stringProp( tnefMsg, MAPI_TAG_PR_TITLE ) );
+        addressee.setOrganization( stringProp( tnefMsg, MAPI_TAG_PR_COMPANY_NAME ) );
+        /*
+        the MAPI property ID of this (multiline) )field is unknown:
+        vPart += stringProp(tnefMsg, "\n","NOTE", ... , "" );
+        */
+
+        KABC::Address adr;
+        adr.setPostOfficeBox( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_PO_BOX ) );
+        adr.setStreet( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_STREET ) );
+        adr.setLocality( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_CITY ) );
+        adr.setRegion( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_STATE_OR_PROVINCE ) );
+        adr.setPostalCode( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_POSTAL_CODE ) );
+        adr.setCountry( stringProp( tnefMsg, MAPI_TAG_PR_HOME_ADDRESS_COUNTRY ) );
+        adr.setType(KABC::Address::Home);
+        addressee.insertAddress(adr);
+
+        adr.setPostOfficeBox( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSPOBOX ) );
+        adr.setStreet( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSSTREET ) );
+        adr.setLocality( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSCITY ) );
+        adr.setRegion( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSSTATE ) );
+        adr.setPostalCode( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSPOSTALCODE ) );
+        adr.setCountry( sNamedProp( tnefMsg, MAPI_TAG_CONTACT_BUSINESSADDRESSCOUNTRY ) );
+        adr.setType( KABC::Address::Work );
+        addressee.insertAddress( adr );
+
+        adr.setPostOfficeBox( stringProp( tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_PO_BOX ) );
+        adr.setStreet( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_STREET ) );
+        adr.setLocality( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_CITY ) );
+        adr.setRegion( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_STATE_OR_PROVINCE ) );
+        adr.setPostalCode( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_POSTAL_CODE ) );
+        adr.setCountry( stringProp(tnefMsg, MAPI_TAG_PR_OTHER_ADDRESS_COUNTRY ) );
+        adr.setType( KABC::Address::Dom );
+        addressee.insertAddress(adr);
+
+        // problem: the 'other' address was stored by KOrganizer in
+        //          a line looking like the following one:
+        // vPart += "\nADR;TYPE=dom;TYPE=intl;TYPE=parcel;TYPE=postal;TYPE=work;TYPE=home:other_pobox;;other_str1\nother_str2;other_loc;other_region;other_pocode;other_country
+
+        QString nr;
+        nr = stringProp( tnefMsg, MAPI_TAG_PR_HOME_TELEPHONE_NUMBER );
+        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Home ) );
+        nr = stringProp( tnefMsg, MAPI_TAG_PR_BUSINESS_TELEPHONE_NUMBER );
+        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Work ) );
+        nr = stringProp( tnefMsg, MAPI_TAG_PR_MOBILE_TELEPHONE_NUMBER );
+        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Cell ) );
+        nr = stringProp( tnefMsg, MAPI_TAG_PR_HOME_FAX_NUMBER );
+        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Fax | KABC::PhoneNumber::Home ) );
+        nr = stringProp( tnefMsg, MAPI_TAG_PR_BUSINESS_FAX_NUMBER );
+        addressee.insertPhoneNumber( KABC::PhoneNumber( nr, KABC::PhoneNumber::Fax | KABC::PhoneNumber::Work ) );
+
+        s = tnefMsg->findProp( MAPI_TAG_PR_BIRTHDAY )
+          .replace( QChar( '-' ), QString::null )
+          .replace( QChar( ':' ), QString::null );
+        if( !s.isEmpty() )
+          addressee.setBirthday( QDateTime::fromString( s ) );
+
+        bOk = ( !addressee.isEmpty() );
+      } else if( "IPM.NOTE" == msgClass ) {
+
+      } // else if ... and so on ...
+    }
+  }
+
+  // Compose return string
+  QString iCal = calFormat.toString( &cal );
+  if( !iCal.isEmpty() )
+    // This was an iCal
+    return iCal;
+
+  // Not an iCal - try a vCard
+  KABC::VCardConverter converter;
+  return converter.createVCard( addressee );
+}
diff -urN -x CVS kdepim.orig/libkcal/incidenceformatter.h kdepim/libkcal/incidenceformatter.h
--- kdepim.orig/libkcal/incidenceformatter.h	Thu Jan  1 01:00:00 1970
+++ kdepim/libkcal/incidenceformatter.h	Thu Oct  7 11:20:23 2004
@@ -0,0 +1,38 @@
+/*
+    This file is part of libkcal.
+
+    Copyright (c) 2001-2003 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+    Boston, MA 02111-1307, USA.
+*/
+#ifndef KCAL_INCIDENCEFORMATTER_H
+#define KCAL_INCIDENCEFORMATTER_H
+
+#include <qstring.h>
+
+namespace KCal {
+
+class IncidenceFormatter
+{
+  public:
+    // Transform a TNEF attachment to an iCal or vCard
+    static QString msTNEFToVPart( const QByteArray& tnef );
+};
+
+}
+
+#endif
diff -urN -x CVS kdepim.orig/libkcal/person.cpp kdepim/libkcal/person.cpp
--- kdepim.orig/libkcal/person.cpp	Fri Dec 20 19:48:13 2002
+++ kdepim/libkcal/person.cpp	Thu Oct  7 13:08:20 2004
@@ -21,25 +21,181 @@
 #include <kdebug.h>
 #include <klocale.h>
 
+
 #include "person.h"
 
 using namespace KCal;
 
+// Copy of KPIM::getNameAndMail from libkdepim/email.cpp, which we can't link to.
+// HEAD has a better solution, with a shared lib.
+static bool getNameAndMail(const QString& aStr, QString& name, QString& mail)
+{
+  name = QString::null;
+  mail = QString::null;
+
+  const int len=aStr.length();
+  const char cQuotes = '"';
+
+  bool bInComment, bInQuotesOutsideOfEmail;
+  int i=0, iAd=0, iMailStart=0, iMailEnd=0;
+  QChar c;
+
+  // Find the '@' of the email address
+  // skipping all '@' inside "(...)" comments:
+  bInComment = false;
+  while( i < len ){
+    c = aStr[i];
+    if( !bInComment ){
+      if( '(' == c ){
+        bInComment = true;
+      }else{
+        if( '@' == c ){
+          iAd = i;
+          break; // found it
+        }
+      }
+    }else{
+      if( ')' == c ){
+        bInComment = false;
+      }
+    }
+    ++i;
+  }
+
+  if( !iAd ){
+    // We suppose the user is typing the string manually and just
+    // has not finished typing the mail address part.
+    // So we take everything that's left of the '<' as name and the rest as mail
+    for( i = 0; len > i; ++i ) {
+      c = aStr[i];
+      if( '<' != c )
+        name.append( c );
+      else
+        break;
+    }
+    mail = aStr.mid( i+1 );
+
+  }else{
+
+    // Loop backwards until we find the start of the string
+    // or a ',' that is outside of a comment
+    //          and outside of quoted text before the leading '<'.
+    bInComment = false;
+    bInQuotesOutsideOfEmail = false;
+    for( i = iAd-1; 0 <= i; --i ) {
+      c = aStr[i];
+      if( bInComment ){
+        if( '(' == c ){
+          if( !name.isEmpty() )
+            name.prepend( ' ' );
+          bInComment = false;
+        }else{
+          name.prepend( c ); // all comment stuff is part of the name
+        }
+      }else if( bInQuotesOutsideOfEmail ){
+        if( cQuotes == c )
+          bInQuotesOutsideOfEmail = false;
+        name.prepend( c );
+      }else{
+        // found the start of this addressee ?
+        if( ',' == c )
+          break;
+        // stuff is before the leading '<' ?
+        if( iMailStart ){
+          if( cQuotes == c )
+            bInQuotesOutsideOfEmail = true; // end of quoted text found
+          name.prepend( c );
+        }else{
+          switch( c ){
+            case '<':
+              iMailStart = i;
+              break;
+            case ')':
+              if( !name.isEmpty() )
+                name.prepend( ' ' );
+              bInComment = true;
+              break;
+            default:
+              if( ' ' != c )
+                mail.prepend( c );
+          }
+        }
+      }
+    }
+
+    name = name.simplifyWhiteSpace();
+    mail = mail.simplifyWhiteSpace();
+
+    if( mail.isEmpty() )
+      return false;
+
+    mail.append('@');
+
+    // Loop forward until we find the end of the string
+    // or a ',' that is outside of a comment
+    //          and outside of quoted text behind the trailing '>'.
+    bInComment = false;
+    bInQuotesOutsideOfEmail = false;
+    for( i = iAd+1; len > i; ++i ) {
+      c = aStr[i];
+      if( bInComment ){
+        if( ')' == c ){
+          if( !name.isEmpty() )
+            name.append( ' ' );
+          bInComment = false;
+        }else{
+          name.append( c ); // all comment stuff is part of the name
+        }
+      }else if( bInQuotesOutsideOfEmail ){
+        if( cQuotes == c )
+          bInQuotesOutsideOfEmail = false;
+        name.append( c );
+      }else{
+        // found the end of this addressee ?
+        if( ',' == c )
+          break;
+        // stuff is behind the trailing '>' ?
+        if( iMailEnd ){
+          if( cQuotes == c )
+            bInQuotesOutsideOfEmail = true; // start of quoted text found
+          name.append( c );
+        }else{
+          switch( c ){
+            case '>':
+              iMailEnd = i;
+              break;
+            case '(':
+              if( !name.isEmpty() )
+                name.append( ' ' );
+              bInComment = true;
+              break;
+            default:
+              if( ' ' != c )
+                mail.append( c );
+          }
+        }
+      }
+    }
+  }
+
+  name = name.simplifyWhiteSpace();
+  mail = mail.simplifyWhiteSpace();
+
+  return ! (name.isEmpty() || mail.isEmpty());
+}
+
 Person::Person( const QString &fullName )
 {
-  int emailPos = fullName.find( '<' );
-  if ( emailPos < 0 ) {
-    setEmail(fullName);
-  } else {
-    setEmail(fullName.mid( emailPos + 1, fullName.length() - 1 ));
-    setName(fullName.left( emailPos - 2 ));
-  }
+  QString name, email;
+  getNameAndMail( fullName, name, email );
+  setName( name );
+  setEmail( email );
 }
 
 Person::Person( const QString &name, const QString &email )
 {
-  setName(name);
-  setEmail(email);
+  setName( name );
+  setEmail( email );
 }
 
 
@@ -62,6 +218,11 @@
   }
 }
 
+bool Person::isEmpty() const
+{
+  return mEmail.isEmpty() && mName.isEmpty();
+}
+
 void Person::setName(const QString &name)
 {
   mName = name;
@@ -69,7 +230,7 @@
 
 void Person::setEmail(const QString &email)
 {
-  if (email.left(7).lower() == "mailto:") {
+  if ( email.startsWith( "mailto:", false ) ) {
     mEmail = email.mid(7);
   } else {
     mEmail = email;
diff -urN -x CVS kdepim.orig/libkcal/person.h kdepim/libkcal/person.h
--- kdepim.orig/libkcal/person.h	Fri Dec 19 18:00:05 2003
+++ kdepim/libkcal/person.h	Thu Oct  7 11:20:12 2004
@@ -34,6 +34,7 @@
     Person() {}
     Person( const QString &fullName );
     Person( const QString &name, const QString &email );
+    bool isEmpty() const;
 
     QString fullName( ) const;
 
diff -urN -x CVS kdepim.orig/libkcal/scheduler.cpp kdepim/libkcal/scheduler.cpp
--- kdepim.orig/libkcal/scheduler.cpp	Wed Aug 18 10:08:37 2004
+++ kdepim/libkcal/scheduler.cpp	Thu Oct  7 11:20:12 2004
@@ -363,7 +363,7 @@
 
   kdDebug(5800) << "acceptFreeBusy:: freeBusyDirName: " << freeBusyDir() << endl;
 
-  QString from;
+  Person from;
   if(method == Scheduler::Publish) {
     from = freebusy->organizer();
   }
diff -urN -x CVS kdepim.orig/libkcal/vcalformat.cpp kdepim/libkcal/vcalformat.cpp
--- kdepim.orig/libkcal/vcalformat.cpp	Sun Mar 14 14:57:40 2004
+++ kdepim/libkcal/vcalformat.cpp	Thu Oct  7 11:20:12 2004
@@ -233,7 +233,8 @@
   addPropValue(vtodo, VCLastModifiedProp, tmpStr.local8Bit());
 
   // organizer stuff
-  tmpStr = "MAILTO:" + anEvent->organizer();
+  // @TODO: How about the common name?
+  tmpStr = "MAILTO:" + anEvent->organizer().email();
   addPropValue(vtodo, ICOrganizerProp, tmpStr.local8Bit());
 
   // attendees
@@ -394,7 +395,8 @@
   addPropValue(vevent, VCLastModifiedProp, tmpStr.local8Bit());
 
   // attendee and organizer stuff
-  tmpStr = "MAILTO:" + anEvent->organizer();
+  // TODO: What to do with the common name?
+  tmpStr = "MAILTO:" + anEvent->organizer().email();
   addPropValue(vevent, ICOrganizerProp, tmpStr.local8Bit());
 
   // TODO: Put this functionality into Attendee class
@@ -684,10 +686,11 @@
   // organizer
   // if our extension property for the event's ORGANIZER exists, add it.
   if ((vo = isAPropertyOf(vtodo, ICOrganizerProp)) != 0) {
-    anEvent->setOrganizer(s = fakeCString(vObjectUStringZValue(vo)));
+    anEvent->setOrganizer( s = fakeCString(vObjectUStringZValue(vo) ) );
     deleteStr(s);
   } else {
-    anEvent->setOrganizer(mCalendar->getEmail());
+    // TODO: Use the common name, too!
+    anEvent->setOrganizer( mCalendar->getEmail());
   }
 
   // attendees.
@@ -911,10 +914,12 @@
   // organizer
   // if our extension property for the event's ORGANIZER exists, add it.
   if ((vo = isAPropertyOf(vevent, ICOrganizerProp)) != 0) {
-    anEvent->setOrganizer(s = fakeCString(vObjectUStringZValue(vo)));
+    // @TODO: Fix this to remove the mailto:
+    anEvent->setOrganizer( s = fakeCString(vObjectUStringZValue(vo) ) );
     deleteStr(s);
   } else {
-    anEvent->setOrganizer(mCalendar->getEmail());
+    // @TODO: Use the common name?
+    anEvent->setOrganizer( mCalendar->getEmail() );
   }
 
   // deal with attendees.
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/Makefile.am kdepim/libkdenetwork/gpgmepp/Makefile.am
--- kdepim.orig/libkdenetwork/gpgmepp/Makefile.am	Mon May 31 19:28:54 2004
+++ kdepim/libkdenetwork/gpgmepp/Makefile.am	Thu Oct 14 11:52:48 2004
@@ -40,7 +40,12 @@
 			encryptionresult.cpp \
 			engineinfo.cpp
 
-libgpgme___la_LDFLAGS = -no-undefined -version-info 0:0:0
+# --version-info CURRENT:REVISION:AGE
+#   (Code changed:                      REVISION++)
+#   (Interfaces added/removed/changed:  CURRENT++, REVISION=0)
+#   (Interfaces added:                  AGE++)
+#   (Interfaces removed/changed:        AGE=0)
+libgpgme___la_LDFLAGS = -no-undefined -version-info 1:0:1
 libgpgme___la_LIBADD = $(GPGME_LIBS)
 libgpgme___la_DEPENDENCIES = $(GPGME_LIBS_DEP)
 
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/configure.in.in kdepim/libkdenetwork/gpgmepp/configure.in.in
--- kdepim.orig/libkdenetwork/gpgmepp/configure.in.in	Mon Jul 12 15:11:12 2004
+++ kdepim/libkdenetwork/gpgmepp/configure.in.in	Fri Oct  8 23:47:55 2004
@@ -125,6 +125,18 @@
 	], [
 		AC_MSG_RESULT([no])
 	])
+
+	AC_MSG_CHECKING([if gpgme has gpgme_decrypt_result_t->wrong_key_usage])
+	AC_TRY_COMPILE([#include <gpgme.h>], [
+		gpgme_decrypt_result_t res;
+		unsigned int wku = res->wrong_key_usage;
+	], [
+		AC_DEFINE(HAVE_GPGME_WRONG_KEY_USAGE, 1, [Define to 1 if your gpgme's gpgme_decrypt_result_t has the wrong_key_usage member])
+		AC_MSG_RESULT([yes])
+	], [
+		AC_MSG_RESULT([no])
+	])
+
 	CFLAGS="$kdepim_gpgmepp_save_cflags"
 	LIBS="$kdepim_gpgmepp_save_libs"
 	AC_LANG_RESTORE
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/context_p.h kdepim/libkdenetwork/gpgmepp/context_p.h
--- kdepim.orig/libkdenetwork/gpgmepp/context_p.h	Mon Feb  9 15:20:19 2004
+++ kdepim/libkdenetwork/gpgmepp/context_p.h	Fri Oct  8 12:52:13 2004
@@ -46,7 +46,7 @@
 
       KeyGen    = 0x080,
       KeyList   = 0x100,
-      TrustList = 0x200,// gpgme_trustlist_result_t, but nevertheless...
+      TrustList = 0x200 // gpgme_trustlist_result_t, but nevertheless...
     };
 
     Private( gpgme_ctx_t c=0 )
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/decryptionresult.cpp kdepim/libkdenetwork/gpgmepp/decryptionresult.cpp
--- kdepim.orig/libkdenetwork/gpgmepp/decryptionresult.cpp	Sun Apr  4 21:31:41 2004
+++ kdepim/libkdenetwork/gpgmepp/decryptionresult.cpp	Thu Oct 14 11:52:48 2004
@@ -63,3 +63,11 @@
 const char * GpgME::DecryptionResult::unsupportedAlgortihm() const {
   return d ? d->res.unsupported_algorithm : 0 ;
 }
+
+bool GpgME::DecryptionResult::wrongKeyUsage() const {
+#ifdef HAVE_GPGME_WRONG_KEY_USAGE
+  if ( d )
+    return d->res.wrong_key_usage;
+#endif
+  return false;
+}
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/decryptionresult.h kdepim/libkdenetwork/gpgmepp/decryptionresult.h
--- kdepim.orig/libkdenetwork/gpgmepp/decryptionresult.h	Sun Apr  4 21:31:41 2004
+++ kdepim/libkdenetwork/gpgmepp/decryptionresult.h	Thu Oct 14 11:52:48 2004
@@ -41,6 +41,8 @@
 
     const char * unsupportedAlgortihm() const;
 
+    bool wrongKeyUsage() const;
+
   private:
     class Private;
     Private * d;
diff -urN -x CVS kdepim.orig/libkdenetwork/gpgmepp/result_p.h kdepim/libkdenetwork/gpgmepp/result_p.h
--- kdepim.orig/libkdenetwork/gpgmepp/result_p.h	Sun Apr  4 21:31:41 2004
+++ kdepim/libkdenetwork/gpgmepp/result_p.h	Sun Oct 17 23:14:21 2004
@@ -56,7 +56,7 @@
   d = 0; \
 }
 
-#define make_isNull(x) bool GpgME::x::isNull() const { return !d; }
+#define make_isNull(x) bool GpgME::x::isNull() const { return !d && !error(); }
 
 #define make_standard_stuff(x) \
 make_copy_ctor(x) \
diff -urN -x CVS kdepim.orig/libkdepim/addresseelineedit.cpp kdepim/libkdepim/addresseelineedit.cpp
--- kdepim.orig/libkdepim/addresseelineedit.cpp	Wed Sep 22 19:22:10 2004
+++ kdepim/libkdepim/addresseelineedit.cpp	Thu Oct 14 09:56:39 2004
@@ -275,23 +275,29 @@
       eot--;
       contents.truncate( eot );
     }
+    bool mailtoURL = false;
     // append the mailto URLs
     for ( KURL::List::Iterator it = uriList.begin();
           it != uriList.end(); ++it ) {
       if ( !contents.isEmpty() )
         contents.append( ", " );
       KURL u( *it );
+      if ( u.protocol() == "mailto" ) {
+        mailtoURL = true;
       contents.append( (*it).path() );
     }
+    }
+    if ( mailtoURL ) {
     setText( contents );
     setEdited( true );
+      return;
+    }
   }
-  else {
+
     if ( m_useCompletion )
        m_smartPaste = true;
     QLineEdit::dropEvent( e );
     m_smartPaste = false;
-  }
 }
 
 void AddresseeLineEdit::cursorAtEnd()
diff -urN -x CVS kdepim.orig/libkdepim/calendardiffalgo.cpp kdepim/libkdepim/calendardiffalgo.cpp
--- kdepim.orig/libkdepim/calendardiffalgo.cpp	Thu Jul 15 11:46:34 2004
+++ kdepim/libkdepim/calendardiffalgo.cpp	Tue Oct 19 01:10:16 2004
@@ -40,17 +40,17 @@
   return attendee->name() + "<" + attendee->email() + ">";
 }
 
-static QString toString( KCal::Alarm *alarm )
+static QString toString( KCal::Alarm * )
 {
   return QString::null;
 }
 
-static QString toString( KCal::Incidence *incidence )
+static QString toString( KCal::Incidence * )
 {
   return QString::null;
 }
 
-static QString toString( KCal::Attachment *attachment )
+static QString toString( KCal::Attachment * )
 {
   return QString::null;
 }
@@ -113,8 +113,8 @@
   if ( left->dtStart() != right->dtStart() )
     conflictField( i18n( "Start time" ), left->dtStartStr(), right->dtStartStr() );
 
-  if ( !compareString( left->organizer(), right->organizer() ) )
-    conflictField( i18n( "Organizer" ), left->organizer(), right->organizer() );
+  if ( !compareString( left->organizer().fullName(), right->organizer().fullName() ) )
+    conflictField( i18n( "Organizer" ), left->organizer().fullName(), right->organizer().fullName() );
 
   if ( !compareString( left->uid(), right->uid() ) )
     conflictField( i18n( "UID" ), left->uid(), right->uid() );
diff -urN -x CVS kdepim.orig/libkdepim/kdateedit.cpp kdepim/libkdepim/kdateedit.cpp
--- kdepim.orig/libkdepim/kdateedit.cpp	Tue Apr 27 22:47:22 2004
+++ kdepim/libkdepim/kdateedit.cpp	Fri Oct  8 14:43:47 2004
@@ -137,10 +137,8 @@
 
 QDate KDateEdit::date() const
 {
-  QDate dt;
-  if (readDate(dt) && (mHandleInvalid || dt.isValid())) {
-    return dt;
-  }
+  if ( mHandleInvalid || value.isValid() )
+    return value;
   return defaultValue;
 }
 
@@ -179,10 +177,8 @@
 
   mDateFrame->move( popupPoint );
 
-  QDate date;
-  readDate(date);
-  if (date.isValid()) {
-    mDatePicker->setDate( date );
+  if (value.isValid()) {
+    mDatePicker->setDate( value );
   } else {
     mDatePicker->setDate( defaultValue );
   }
diff -urN -x CVS kdepim.orig/libkdepim/komposer/core/komposereditor.desktop kdepim/libkdepim/komposer/core/komposereditor.desktop
--- kdepim.orig/libkdepim/komposer/core/komposereditor.desktop	Sat Oct  2 16:30:41 2004
+++ kdepim/libkdepim/komposer/core/komposereditor.desktop	Mon Oct  4 15:26:39 2004
@@ -14,6 +14,7 @@
 Comment[gl]=Editor Komposer
 Comment[hu]=Komposer
 Comment[it]=Komposer editor
+Comment[ja]=Komposer,エディタ
 Comment[nb]=Komposer redigerer
 Comment[nl]=Komposer-editor
 Comment[nn]=Komposer redigerar
@@ -24,7 +25,7 @@
 Comment[sk]=Editor Komposer
 Comment[sl]=Urejevalnik Komposer
 Comment[sr]=Komposer едитор
-Comment[sr@Latn]=Komposer едитор
+Comment[sr@Latn]=Komposer editor
 Comment[sv]=Komposer editor
 Comment[ta]=கம்போசர் தொகுப்பான்
 Comment[tg]=Муҳаррири Komposer
diff -urN -x CVS kdepim.orig/libkdepim/komposer/core/komposerplugin.desktop kdepim/libkdepim/komposer/core/komposerplugin.desktop
--- kdepim.orig/libkdepim/komposer/core/komposerplugin.desktop	Tue Aug 24 08:32:56 2004
+++ kdepim/libkdepim/komposer/core/komposerplugin.desktop	Mon Oct  4 15:26:39 2004
@@ -31,7 +31,7 @@
 Name[sk]=Modul Komposer
 Name[sl]=Vstavek za Komposer
 Name[sr]=Прикључак састављача
-Name[sr@Latn]=Dodatak sastavljača
+Name[sr@Latn]=Priključak sastavljača
 Name[sv]=Komposer-insticksprogram
 Name[ta]=கம்போசர் சொருகுப்பொருள்
 Name[tg]=Модули Komposer
diff -urN -x CVS kdepim.orig/libkdepim/komposer/plugins/krichtext/krichtextplugin.desktop kdepim/libkdepim/komposer/plugins/krichtext/krichtextplugin.desktop
--- kdepim.orig/libkdepim/komposer/plugins/krichtext/krichtextplugin.desktop	Sat Oct  2 16:30:42 2004
+++ kdepim/libkdepim/komposer/plugins/krichtext/krichtextplugin.desktop	Mon Oct  4 15:26:40 2004
@@ -26,6 +26,7 @@
 Name[hu]=RichText-es szerkesztő
 Name[is]=RichText ritill
 Name[it]=Editor rich text
+Name[ja]=リッチ テキスト エディタ
 Name[nb]=RikTekst redigerer
 Name[nl]=RichText-editor
 Name[nn]=RikTekst redigerar
@@ -36,7 +37,7 @@
 Name[sk]=Editor s formátovaním
 Name[sl]=Urejevalnik bogatega besedila
 Name[sr]=RichText едитор
-Name[sr@Latn]=RichText едитор
+Name[sr@Latn]=RichText editor
 Name[sv]=Richtext editor
 Name[ta]=ரிச் உரை தொகுப்பான்
 Name[tg]=Муҳаррири RichText
@@ -68,7 +69,7 @@
 Comment[sk]=Modul písania správ
 Comment[sl]=Vstavek KRichRext za Komposer
 Comment[sr]=Прикључак састављача за богати текст
-Comment[sr@Latn]=Dodatak sastavljača za bogati tekst
+Comment[sr@Latn]=Priključak sastavljača za bogati tekst
 Comment[sv]=Komposer Krichtext-insticksprogram
 Comment[ta]=கம்போசர் கேரிச் உரை சொருகுப்பொருள்
 Comment[tg]=Модули ба андозадарории Komposer
diff -urN -x CVS kdepim.orig/libkpimexchange/core/exchangedownload.cpp kdepim/libkpimexchange/core/exchangedownload.cpp
--- kdepim.orig/libkpimexchange/core/exchangedownload.cpp	Sat Mar  6 19:07:22 2004
+++ kdepim/libkpimexchange/core/exchangedownload.cpp	Thu Oct  7 11:20:13 2004
@@ -407,6 +407,7 @@
   }
 
   QString organizer = prop.namedItem( "organizer" ).toElement().text();
+  // TODO: Does outlook have a common name? Or does the organizer already contain both?
   event->setOrganizer( organizer );
   // kdDebug() << "Got organizer: " << organizer << endl;
 
diff -urN -x CVS kdepim.orig/mimelib/token.cpp kdepim/mimelib/token.cpp
--- kdepim.orig/mimelib/token.cpp	Fri Apr  2 18:55:55 2004
+++ kdepim/mimelib/token.cpp	Fri Oct  8 12:57:39 2004
@@ -3,8 +3,8 @@
 // Contents:   Definitions for DwTokenizer, DwRfc822Tokenizer
 // Maintainer: Doug Sauder <dwsauder@fwb.gulf.net>
 // WWW:        http://www.fwb.gulf.net/~dwsauder/mimepp.html
-// $Revision$
-// $Date$
+// $Revision$
+// $Date$
 //
 // Copyright (c) 1996, 1997 Douglas W. Sauder
 // All rights reserved.
@@ -279,17 +279,15 @@
      case ']':
      // isspace()
      case ' ':
+         return true;
      //case '\r': included in iscntrl()
      //case '\f': included in iscntrl()
      //case '\t': included in iscntrl()
      //case '\n': included in iscntrl()
      //case '\v': included in iscntrl()
      // iscntrl()
-     case 0 ... 15:
-     case 17 ... 31:
-        return true;
      default:
-        return false;
+         return ( (c >= 0 && c <= 15) || (c >= 17 && c <= 31) );
   }
 }
 
@@ -304,11 +302,9 @@
      //case '\n': included in iscntrl()
      //case '\v': included in iscntrl()
      // iscntrl()
-     case 0 ... 15:
-     case 17 ... 31:
         return false;
      default:
-        return true;
+         return !( (c >= 0 && c <= 15) || (c >= 17 && c <= 31) );
   }
 }
 
@@ -443,17 +439,15 @@
      case '=':
      // isspace()
      case ' ':
+         return true;
      //case '\r': included in iscntrl()
      //case '\f': included in iscntrl()
      //case '\t': included in iscntrl()
      //case '\n': included in iscntrl()
      //case '\v': included in iscntrl()
      // iscntrl()
-     case 0 ... 15:
-     case 17 ... 31:
-        return true;
      default:
-        return false;
+        return ( ( c >= 0 && c <= 15) || (c >= 17 && c <= 31) );
   }
  }
 
diff -urN -x CVS kdepim.orig/plugins/kmail/bodypartformatter/text_calendar.cpp kdepim/plugins/kmail/bodypartformatter/text_calendar.cpp
--- kdepim.orig/plugins/kmail/bodypartformatter/text_calendar.cpp	Tue Aug 17 16:13:00 2004
+++ kdepim/plugins/kmail/bodypartformatter/text_calendar.cpp	Thu Oct  7 11:20:13 2004
@@ -528,7 +528,7 @@
         subject = i18n( "Answer: %1" ).arg( incidence->summary() );
       else
         subject = i18n( "Answer: Incidence with no summary" );
-      return callback.mailICal( incidence->organizer(), msg, subject );
+      return callback.mailICal( incidence->organizer().fullName(), msg, subject );
     }
 
     bool saveFile( const QString& receiver, const QString& iCal,
diff -urN -x CVS kdepim.orig/plugins/kmail/bodypartformatter/text_calendar.desktop kdepim/plugins/kmail/bodypartformatter/text_calendar.desktop
--- kdepim.orig/plugins/kmail/bodypartformatter/text_calendar.desktop	Sat Oct  2 16:30:44 2004
+++ kdepim/plugins/kmail/bodypartformatter/text_calendar.desktop	Tue Oct  5 15:20:55 2004
@@ -1,9 +1,11 @@
 [Misc]
 Encoding=UTF-8
 Name=Application Octetstream
+Name[ca]=Aplicació Octetstream
 Name[da]=Program oktetstrøm
 Name[es]=Aplicación en flujo de octetos
 Name[hu]=Alkalmazás-adatfolyam
+Name[ja]=アプリケーション オクテット ストリーム
 Name[nb]=Program Octetstrøm
 Name[nl]=Applicatie octetstroom
 Name[nn]=Oktettstraum frå program
@@ -13,13 +15,14 @@
 Name[ru]=Бинарный поток приложения
 Name[sl]=Programski Octetstream
 Name[sr]=Апликација Octetstream
-Name[sr@Latn]=Апликација Octetstream
+Name[sr@Latn]=Aplikacija Octetstream
 Name[sv]=Program-oktettström
 Name[ta]=பயன்பாட்டு எண்மம்
 Name[tg]=Миқдори зиёди бинарии барномот
 Name[zh_CN]=应用程序 Octetstream
 Comment=A bodypart formatter plugin for text/calendar
 Comment[bs]=Dodatak za formatiranje tijela poruke za text/calendar
+Comment[ca]=Un endollable formatador del cos per a text/calendar
 Comment[cs]=Formátovač těla emailu pro typ text/calendar
 Comment[da]=Et bodypart formateringsplugin for text/calendar
 Comment[de]=Ein Textinhalt-Formatierer für text/calendar
@@ -28,6 +31,8 @@
 Comment[fr]=Module de formatage pour le text/calendar
 Comment[hu]=Formázómodul text/calendar adatfolyamok kezeléséhez
 Comment[it]=Un plugin per formattare il corpo di text/calendar
+Comment[ja]=text/calendar 用の Bodypart フォーマッタ プラグイン
+Comment[nb]=En formaterer for meldingstekster i tekst/kalender
 Comment[nl]=Een opmaakplugin voor text/calendar
 Comment[nn]=Eit programtillegg for meldingstekstformatering i tekst/kalender
 Comment[pl]=Wtyczka formatująca dla typu text/calendar
@@ -37,7 +42,7 @@
 Comment[sk]=Modul pre formátovanie tela pre text/calendar
 Comment[sl]=Oblikovalni vstavek za text/calendar
 Comment[sr]=Прикључак форматер тела за текст-календар
-Comment[sr@Latn]=Прикључак форматер тела за текст-календар
+Comment[sr@Latn]=Priključak formater tela za tekst-kalendar
 Comment[sv]=Ett insticksprogram för brevtextformatering av text/calendar
 Comment[ta]=உரை அல்லது நாள்காட்டிகான அங்க அமைப்பு சொருகி
 Comment[tg]=Модули ба андозадарории text/calendar
diff -urN -x CVS kdepim.orig/plugins/kmail/bodypartformatter/text_vcard.desktop kdepim/plugins/kmail/bodypartformatter/text_vcard.desktop
--- kdepim.orig/plugins/kmail/bodypartformatter/text_vcard.desktop	Sat Oct  2 16:30:44 2004
+++ kdepim/plugins/kmail/bodypartformatter/text_vcard.desktop	Tue Oct  5 15:20:55 2004
@@ -1,9 +1,11 @@
 [Misc]
 Encoding=UTF-8
 Name=Application Octetstream
+Name[ca]=Aplicació Octetstream
 Name[da]=Program oktetstrøm
 Name[es]=Aplicación en flujo de octetos
 Name[hu]=Alkalmazás-adatfolyam
+Name[ja]=アプリケーション オクテット ストリーム
 Name[nb]=Program Octetstrøm
 Name[nl]=Applicatie octetstroom
 Name[nn]=Oktettstraum frå program
@@ -13,13 +15,14 @@
 Name[ru]=Бинарный поток приложения
 Name[sl]=Programski Octetstream
 Name[sr]=Апликација Octetstream
-Name[sr@Latn]=Апликација Octetstream
+Name[sr@Latn]=Aplikacija Octetstream
 Name[sv]=Program-oktettström
 Name[ta]=பயன்பாட்டு எண்மம்
 Name[tg]=Миқдори зиёди бинарии барномот
 Name[zh_CN]=应用程序 Octetstream
 Comment=A bodypart formatter plugin for text/vcard
 Comment[bs]=Dodatak za formatiranje tijela poruke za text/vcard
+Comment[ca]=Un endollable formatador del cos per a text/vcard
 Comment[cs]=Formátovač těla emailu pro typ text/vcard
 Comment[da]=Et bodypart formateringsplugin for text/vcard
 Comment[de]=Ein Textinhalt-Formatierer für text/vcard
@@ -28,6 +31,7 @@
 Comment[fr]=Un formateur de partie de coprs pour text/vcard
 Comment[hu]=Formázómodul text/vcard adatfolyamok kezeléséhez
 Comment[it]=Un plugin per formattare il corpo di text/vcard
+Comment[ja]=text/vcard 用の Bodypart フォーマッタ プラグイン
 Comment[nb]=Et brødtekst formaterins programillegg for tekst/vcard
 Comment[nl]=Een opmaakplugin voor text/vcard
 Comment[nn]=Eit programtillegg for brødtekstformatering i tekst/vCard
@@ -38,7 +42,7 @@
 Comment[sk]=Modul pre formátovanie tela pre text/vcard
 Comment[sl]=Oblikovalni vstavek za text/vcard
 Comment[sr]=Прикључак форматер тела за текст-vcard
-Comment[sr@Latn]=Прикључак форматер тела за текст-vcard
+Comment[sr@Latn]=Priključak formater tela za tekst-vcard
 Comment[sv]=Ett insticksprogram för brevtextformatering av text/vcard
 Comment[ta]=உரை அல்லது விஅட்டைக்கான அங்க அமைப்பு சொருகி
 Comment[tg]=Модули ба андозадарории text/vcard
