Index: akregator/src/akregator.desktop
===================================================================
--- akregator/src/akregator.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ akregator/src/akregator.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -98,5 +98,5 @@
 Comment[zh_CN]=KDE RSS 新闻收集器
 Comment[zh_TW]=KDE 的 RSS 收集器
 Terminal=false
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;News;
 X-DCOP-ServiceType=Unique
Index: kmobile/kioslave/mimetypes/mobile_notes.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmobile/kioslave/mimetypes/mobile_notes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -33,7 +33,7 @@
 Comment[ms]=Nota dalam Peranti Mudah Alih
 Comment[nb]=Notater i mobil enhet
 Comment[nds]=Notizen op Mobilreedschap
-Comment[ne]=मोबाइल यन्त्र भित्रका द्रष्टव्य
+Comment[ne]=मोबाइल यन्त्र भित्रका टिपोट
 Comment[nl]=Notities in mobiel apparaat
 Comment[nn]=Notat i mobileiningar
 Comment[pl]=Notatki w urządzeniu przenośnym
Index: wizards/groupwarewizard.desktop
===================================================================
--- wizards/groupwarewizard.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ wizards/groupwarewizard.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -48,4 +48,4 @@
 Icon=kontact
 Terminal=false
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Network;Email;
Index: wizards/kmailchanges.h
===================================================================
--- wizards/kmailchanges.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ wizards/kmailchanges.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -25,6 +25,10 @@
 #include <kconfigpropagator.h>
 #include <kconfig.h>
 
+namespace KWallet {
+  class Wallet;
+}
+
 class CreateImapAccount : public KConfigPropagator::Change
 {
   public:
@@ -73,6 +77,9 @@
     void setCustomWriter( CustomWriter * );
 
   protected:
+    bool writeToWallet( const QString &type, int id );
+
+  protected:
     QString mAccountName;
 
     QString mServer;
@@ -95,6 +102,9 @@
     int mExistingTransportId;
 
     CustomWriter *mCustomWriter;
+
+  private:
+    static KWallet::Wallet *mWallet;
 };
 
 class CreateDisconnectedImapAccount : public CreateImapAccount
Index: wizards/kmailchanges.cpp
===================================================================
--- wizards/kmailchanges.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ wizards/kmailchanges.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,6 +30,8 @@
 #include <identity.h>
 #include <kdebug.h>
 #include <kstringhandler.h>
+#include <kwallet.h>
+using namespace KWallet;
 
 static const char* s_folderContentsType[] = {
   I18N_NOOP( "Calendar" ),
@@ -38,6 +40,7 @@
   I18N_NOOP( "Tasks" ),
   I18N_NOOP( "Journal" ) };
 
+Wallet* CreateImapAccount::mWallet = 0;
 
 CreateImapAccount::CreateImapAccount( const QString &accountName, const QString &title )
   : KConfigPropagator::Change( title ),
@@ -192,7 +195,14 @@
     c.writeEntry( "use-tls", true );
   }
 
+  if ( mEnableSavePassword ) {
+    if ( !writeToWallet( "account", accountId ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "store-passwd", true );
+    }
+  }
 
+
   c.setGroup( QString("Folder-%1").arg( uid ) );
   c.writeEntry( "isOpen", true );
 
@@ -219,8 +229,10 @@
   }
   c.writeEntry( "user", mUser );
   if ( mEnableSavePassword ) {
-    c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
-    c.writeEntry( "storepass", "true" );
+    if ( !writeToWallet( "transport", transportId ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "storepass", true );
+    }
   }
 
   // Write email in "default kcontrol settings", used by IdentityManager
@@ -273,22 +285,24 @@
   c.writeEntry( "Folder", uid );
   c.writeEntry( "Id", uid );
   c.writeEntry( "Type", "imap" );
-  c.writeEntry( "auth", true );
+  c.writeEntry( "auth", "*" );
   c.writeEntry( "Name", mAccountName );
   c.writeEntry( "host", mServer );
 
   c.writeEntry( "login", mUser );
 
   if ( mEnableSavePassword ) {
-    c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
-    c.writeEntry( "store-passwd", true );
+    if ( !writeToWallet( "account", accCnt+1 ) ) {
+      c.writeEntry( "pass", KStringHandler::obscure( mPassword ) );
+      c.writeEntry( "store-passwd", true );
+    }
   }
   c.writeEntry( "port", "993" );
 
   if ( mEncryption == SSL ) {
-    c.writeEntry( "encryption", "SSL" );
+    c.writeEntry( "use-ssl", true );
   } else if ( mEncryption == TLS ) {
-    c.writeEntry( "encryption", "TLS" );
+    c.writeEntry( "use-tls", true );
   }
 
   if ( mAuthenticationSend == PLAIN ) {
@@ -310,3 +324,22 @@
   c.setGroup( QString("Folder-%1").arg( uid ) );
   c.writeEntry( "isOpen", true );
 }
+
+bool CreateImapAccount::writeToWallet(const QString & type, int id)
+{
+  if ( !Wallet::isEnabled() )
+    return false;
+  if ( !mWallet || !mWallet->isOpen() ) {
+    delete mWallet;
+    WId window = 0;
+    if ( qApp->activeWindow() )
+      window = qApp->activeWindow()->winId();
+    mWallet = Wallet::openWallet( Wallet::NetworkWallet(), window );
+    if ( !mWallet )
+      return false;
+    if ( !mWallet->hasFolder( "kmail" ) )
+      mWallet->createFolder( "kmail" );
+    mWallet->setFolder( "kmail" );
+  }
+  return mWallet->writePassword( type + "-" + QString::number( id ), mPassword );
+}
Index: kresources/egroupware/xmlrpciface.h
===================================================================
--- kresources/egroupware/xmlrpciface.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/egroupware/xmlrpciface.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -90,8 +90,8 @@
 
       template <typename T>
       void call( const QString &method, const QValueList<T> &arg,
-        QObject* obj, const char* faultSlot,
-        QObject* obj, const char* messageSlot, const QVariant &id = QVariant() );
+        QObject* obj1, const char* faultSlot,
+        QObject* obj2, const char* messageSlot, const QVariant &id = QVariant() );
 
 
     public slots:
Index: kresources/groupwise/soap/Makefile.am
===================================================================
--- kresources/groupwise/soap/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/groupwise/soap/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -11,13 +11,13 @@
                    $(top_builddir)/libkdepim/libkdepim.la
 soapdebug_SOURCES = soapdebug.cpp
 
-noinst_LTLIBRARIES = libgwsoap.la
+lib_LTLIBRARIES = libgwsoap.la
 
 libgwsoap_la_SOURCES = contactconverter.cpp gwconverter.cpp incidenceconverter.cpp \
                        groupwiseserver.cpp gwjobs.cpp ksslsocket.cpp \
                        soapC.cpp soapClient.cpp stdsoap2.cpp
-libgwsoap_la_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-libgwsoap_la_LIBADD	= -lkabc
+libgwsoap_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -no-undefined
+libgwsoap_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la
 
 # the following rule does:
 # make a header file from the wsdl
Index: kresources/kolab/kabc/resourcekolab.cpp
===================================================================
--- kresources/kolab/kabc/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kabc/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -507,7 +507,8 @@
 void KABC::ResourceKolab::fromKMailAddSubresource( const QString& type,
                                                    const QString& subResource,
                                                    const QString& label,
-                                                   bool writable )
+                                                   bool writable,
+                                                   bool )
 {
   if( type != s_kmailContentsType ) return;
 
Index: kresources/kolab/kabc/resourcekolab.h
===================================================================
--- kresources/kolab/kabc/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kabc/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -107,7 +107,8 @@
 
   // Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& id,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& id );
 
   bool fromKMailAddIncidence( const QString& type, const QString& resource,
Index: kresources/kolab/knotes/resourcekolab.cpp
===================================================================
--- kresources/kolab/knotes/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/knotes/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -328,7 +328,8 @@
 void ResourceKolab::fromKMailAddSubresource( const QString& type,
                                              const QString& subResource,
                                              const QString& mimetype,
-                                             bool writable )
+                                             bool writable,
+                                             bool /*alarmRelevant*/ )
 {
   if ( type != kmailContentsType )
     // Not ours
Index: kresources/kolab/knotes/resourcekolab.h
===================================================================
--- kresources/kolab/knotes/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/knotes/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -88,7 +88,8 @@
 
   /// Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& resource,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& resource );
 
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
Index: kresources/kolab/shared/resourcekolabbase.h
===================================================================
--- kresources/kolab/shared/resourcekolabbase.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/shared/resourcekolabbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -90,7 +90,8 @@
   virtual void fromKMailAddSubresource( const QString& type,
                                         const QString& resource,
                                         const QString& label,
-                                        bool writable ) = 0;
+                                        bool writable,
+                                        bool alarmRelevant ) = 0;
   virtual void fromKMailDelSubresource( const QString& type,
                                         const QString& resource ) = 0;
 
Index: kresources/kolab/shared/subresource.cpp
===================================================================
--- kresources/kolab/shared/subresource.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/shared/subresource.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -34,13 +34,21 @@
 
 using namespace Kolab;
 
-SubResource::SubResource( bool active, bool writable, const QString& label,
+SubResource::SubResource( bool active, bool writable, 
+                          bool alarmRelevant, const QString& label,
                           int completionWeight )
-  : mActive( active ),  mWritable( writable ), mLabel( label ),
-    mCompletionWeight( completionWeight )
+  : mActive( active ),  mWritable( writable ), mAlarmRelevant( alarmRelevant ),
+    mLabel( label ), mCompletionWeight( completionWeight )
 {
 }
 
+SubResource::SubResource( bool active, bool writable, 
+                          const QString& label, int completionWeight )
+  : mActive( active ),  mWritable( writable ), mAlarmRelevant( false ),
+    mLabel( label ), mCompletionWeight( completionWeight )
+{
+}
+
 SubResource::~SubResource()
 {
 }
@@ -55,6 +63,16 @@
   return mActive;
 }
 
+void SubResource::setAlarmRelevant( bool active )
+{
+  mAlarmRelevant = active;
+}
+
+bool SubResource::alarmRelevant() const
+{
+  return mAlarmRelevant;
+}
+
 void SubResource::setWritable( bool writable )
 {
   mWritable = writable;
Index: kresources/kolab/shared/kmailconnection.h
===================================================================
--- kresources/kolab/shared/kmailconnection.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/shared/kmailconnection.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -59,7 +59,9 @@
   void fromKMailDelIncidence( const QString& type, const QString& resource,
                               const QString& xml );
   void fromKMailRefresh( const QString& type, const QString& resource );
-  void fromKMailAddSubresource( const QString& type, const QString& resource, const QString& label );
+  void fromKMailAddSubresource( const QString& type, const QString& resource, 
+                                const QString& label, bool writable, 
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& resource );
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map, const QString& type,
                                  const QString& folder );
Index: kresources/kolab/shared/subresource.h
===================================================================
--- kresources/kolab/shared/subresource.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/shared/subresource.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -50,6 +50,9 @@
 
   SubResource( bool active, bool writable, const QString& label,
                int completionWeight = 100 );
+
+  SubResource( bool active, bool writable, bool alarmRelevant,
+               const QString& label, int completionWeight = 100 );
   virtual ~SubResource();
 
   virtual void setActive( bool active );
@@ -58,6 +61,9 @@
   virtual void setWritable( bool writable );
   virtual bool writable() const;
 
+  virtual void setAlarmRelevant( bool active );
+  virtual bool alarmRelevant() const;
+
   virtual void setLabel( const QString& label );
   virtual QString label() const;
 
@@ -67,6 +73,8 @@
 private:
   bool mActive;   // Controlled by the applications
   bool mWritable; // Set if the KMail folder is writable
+  bool mAlarmRelevant; // Set if the alarms from this resource are of 
+                      // interest to the user, as per folder acls
   QString mLabel; // The GUI name of this resource
 
   // This is just for the abc plugin. But as long as only this is here,
Index: kresources/kolab/shared/kmailconnection.cpp
===================================================================
--- kresources/kolab/shared/kmailconnection.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/shared/kmailconnection.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -98,8 +98,8 @@
     if ( !connectKMailSignal( "signalRefresh(QString,QString)",
                               "fromKMailRefresh(QString,QString)" ) )
       kdError(5650) << "DCOP connection to signalRefresh failed" << endl;
-    if ( !connectKMailSignal( "subresourceAdded( QString, QString, QString )",
-                              "fromKMailAddSubresource( QString, QString, QString )" ) )
+    if ( !connectKMailSignal( "subresourceAdded( QString, QString, QString, bool, bool )",
+                              "fromKMailAddSubresource( QString, QString, QString, bool, bool )" ) )
       kdError(5650) << "DCOP connection to subresourceAdded failed" << endl;
     if ( !connectKMailSignal( "subresourceDeleted(QString,QString)",
                               "fromKMailDelSubresource(QString,QString)" ) )
@@ -144,17 +144,14 @@
 
 void KMailConnection::fromKMailAddSubresource( const QString& type,
                                                const QString& resource,
-                                               const QString& label )
+                                               const QString& label,
+                                               bool writable,
+                                               bool alarmRelevant )
 {
 //   kdDebug(5650) << "KMailConnection::fromKMailAddSubresource( " << type << ", "
 //                 << resource << " )\n";
-  bool writable = true;
-
-  // TODO: This should be told by KMail right away
-  if ( connectToKMail() )
-    writable = mKMailIcalIfaceStub->isWritableFolder( type, resource );
-
-  mResource->fromKMailAddSubresource( type, resource, label, writable );
+  mResource->fromKMailAddSubresource( type, resource, label, 
+                                      writable, alarmRelevant );
 }
 
 void KMailConnection::fromKMailDelSubresource( const QString& type,
Index: kresources/kolab/kcal/resourcekolab.cpp
===================================================================
--- kresources/kolab/kcal/resourcekolab.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kcal/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -67,7 +67,8 @@
 
 ResourceKolab::ResourceKolab( const KConfig *config )
   : ResourceCalendar( config ), ResourceKolabBase( "ResourceKolab-libkcal" ),
-    mCalendar( QString::fromLatin1("UTC") ), mOpen( false )
+    mCalendar( QString::fromLatin1("UTC") ), mOpen( false ),mResourceChangedTimer( 0,
+        "mResourceChangedTimer" )
 {
   setType( "imap" );
   connect( &mResourceChangedTimer, SIGNAL( timeout() ),
@@ -87,11 +88,13 @@
                                            const QString& name,
                                            const QString& label,
                                            bool writable,
+                                           bool alarmRelevant,
                                            ResourceMap& subResource )
 {
   KConfigGroup group( &config, name );
   bool active = group.readBoolEntry( "Active", true );
-  subResource.insert( name, Kolab::SubResource( active, writable, label ) );
+  subResource.insert( name, Kolab::SubResource( active, writable,
+                                                alarmRelevant, label ) );
 }
 
 bool ResourceKolab::openResource( KConfig& config, const char* contentType,
@@ -104,7 +107,8 @@
   map.clear();
   QValueList<KMailICalIface::SubResource>::ConstIterator it;
   for ( it = subResources.begin(); it != subResources.end(); ++it )
-    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, map );
+    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, 
+                           (*it).alarmRelevant, map );
   return true;
 }
 
@@ -492,12 +496,12 @@
       }
     }
   } else { /* KMail told us */
-    bool ourOwnUpdate = false;
+    bool ourOwnUpdate = mUidsPendingUpdate.contains(  uid );
     /* Check if we updated this one, which means kmail deleted and added it.
      * We know the new state, so lets just not do much at all. The old incidence
      * in the calendar remains valid, but the serial number changed, so we need to
      * update that */
-    if ( ourOwnUpdate = mUidsPendingUpdate.contains( uid ) ) {
+    if ( ourOwnUpdate ) {
       mUidsPendingUpdate.remove( uid );
       mUidMap.remove( uid );
       mUidMap[ uid ] = StorageReference( subResource, sernum );
@@ -697,15 +701,41 @@
   return mCalendar.rawJournalsForDate( date );
 }
 
+KCal::Alarm::List ResourceKolab::relevantAlarms( const KCal::Alarm::List &alarms )
+{
+  KCal::Alarm::List relevantAlarms;
+  KCal::Alarm::List::ConstIterator it( alarms.begin() );
+  while ( it != alarms.end() ) {
+    KCal::Alarm *a = (*it);
+    ++it;
+    const QString &uid = a->parent()->uid();
+     if ( mUidMap.contains( uid ) ) {
+       const QString &sr = mUidMap[ uid ].resource();
+       Kolab::SubResource *subResource = 0;
+       if ( mEventSubResources.contains( sr ) )
+          subResource = &( mEventSubResources[ sr ] );
+       else if ( mTodoSubResources.contains( sr ) )
+          subResource = &( mTodoSubResources[ sr ] );
+       assert( subResource );
+       if ( subResource->alarmRelevant() )
+           relevantAlarms.append ( a );
+       else {
+         kdDebug(5650) << "Alarm skipped, not relevant." << endl;
+       }
+     }
+  }
+  return relevantAlarms;
+}
+
 KCal::Alarm::List ResourceKolab::alarms( const QDateTime& from,
                                          const QDateTime& to )
 {
-  return mCalendar.alarms( from, to );
+  return relevantAlarms( mCalendar.alarms( from, to ) );
 }
 
 KCal::Alarm::List ResourceKolab::alarmsTo( const QDateTime& to )
 {
-  return mCalendar.alarmsTo(to);
+  return relevantAlarms( mCalendar.alarmsTo(to) );
 }
 
 void ResourceKolab::setTimeZoneId( const QString& tzid )
@@ -794,7 +824,7 @@
 void ResourceKolab::fromKMailAddSubresource( const QString& type,
                                              const QString& subResource,
                                              const QString& label,
-                                             bool writable )
+                                             bool writable, bool alarmRelevant )
 {
   ResourceMap* map = 0;
   const char* mimetype = 0;
@@ -819,7 +849,8 @@
   config.setGroup( subResource );
 
   bool active = config.readBoolEntry( subResource, true );
-  (*map)[ subResource ] = Kolab::SubResource( active, writable, label );
+  (*map)[ subResource ] = Kolab::SubResource( active, writable, 
+                                              alarmRelevant, label );
   loadSubResource( subResource, mimetype );
   emit signalSubresourceAdded( this, type, subResource, label );
 }
Index: kresources/kolab/kcal/incidence.cpp
===================================================================
--- kresources/kolab/kcal/incidence.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -42,12 +42,10 @@
 using namespace Kolab;
 
 
-Incidence::Incidence( const QString& tz, KCal::Incidence* incidence )
+Incidence::Incidence( const QString& tz )
   : KolabBase( tz ), mFloatingStatus( Unset ), mHasAlarm( false ),
     mRevision( 0 )
 {
-  if ( incidence )
-    setFields( incidence );
 }
 
 Incidence::~Incidence()
Index: kresources/kolab/kcal/resourcekolab.h
===================================================================
--- kresources/kolab/kcal/resourcekolab.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kcal/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -110,7 +110,8 @@
 
   /// Listen to KMail changes in the amount of sub resources
   void fromKMailAddSubresource( const QString& type, const QString& subResource,
-                                const QString& label, bool writable );
+                                const QString& label, bool writable,
+                                bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& subResource );
 
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
@@ -136,6 +137,12 @@
   void useGlobalMode();
 protected slots:
    void slotEmitResourceChanged();
+protected:
+  /** 
+   * Return list of alarms which are relevant for the current user. These
+   * are the ones coming from folders which the user has "Administer" rights
+   * for, as per ACL */
+  KCal::Alarm::List relevantAlarms( const KCal::Alarm::List &alarms );
 
 private:
   void removeIncidences( const QCString& incidenceType );
@@ -167,7 +174,7 @@
                      Kolab::ResourceMap& map );
   void loadSubResourceConfig( KConfig& config, const QString& name,
                               const QString& label, bool writable,
-                              Kolab::ResourceMap& subResource );
+                              bool alarmRelevant, Kolab::ResourceMap& subResource );
   bool loadSubResource( const QString& subResource, const char* mimetype );
 
   QString configFile() const {
Index: kresources/kolab/kcal/incidence.h
===================================================================
--- kresources/kolab/kcal/incidence.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kresources/kolab/kcal/incidence.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -73,7 +73,10 @@
     QString role;
   };
 
-  explicit Incidence( const QString& tz, KCal::Incidence* incidence = 0 );
+protected:
+  explicit Incidence( const QString& tz );
+
+public:
   virtual ~Incidence();
 
   void saveTo( KCal::Incidence* incidence );
Index: certmanager/kleopatra_import.desktop
===================================================================
--- certmanager/kleopatra_import.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ certmanager/kleopatra_import.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -9,6 +9,6 @@
 Exec=kleopatra --import-certificate %u
 #Icon=kleopatra
 NoDisplay=true
-MimeType=application/pkcs7-mime;application/x-x509-ca-cert;application/x-pkcs12
+MimeType=application/pkcs7-mime;application/x-x509-ca-cert;application/x-pkcs12;
 
 X-KDE-StartupNotify=true
Index: certmanager/certificateinfowidgetimpl.cpp
===================================================================
--- certmanager/certificateinfowidgetimpl.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ certmanager/certificateinfowidgetimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -267,6 +267,7 @@
   if ( !proc->start( KProcess::NotifyOnExit, (KProcess::Communication)(KProcess::Stdout | KProcess::Stderr) ) ) {
     QString wmsg = i18n("Failed to execute gpgsm:\n%1").arg( i18n( "program not found" ) );
     dumpView->setText( wmsg );
+    delete proc;
   }
 }
 
Index: certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ certmanager/lib/backends/qgpgme/qgpgmecryptoconfig.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -306,7 +306,7 @@
   }
   else if( rc != 0 ) // Happens due to bugs in gpgconf (e.g. issues 104/115)
   {
-    QString wmsg = i18n( "Error from gpgconf while saving configuration: %1" ).arg( strerror( rc ) );
+    QString wmsg = i18n( "Error from gpgconf while saving configuration: %1" ).arg( QString::fromLocal8Bit( strerror( rc ) ) );
     kdWarning(5150) << k_funcinfo << ":" << strerror( rc ) << endl;
     KMessageBox::error(0, wmsg);
   }
Index: certmanager/lib/ui/dnattributeorderconfigwidget.cpp
===================================================================
--- certmanager/lib/ui/dnattributeorderconfigwidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ certmanager/lib/ui/dnattributeorderconfigwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -105,9 +105,9 @@
   d->currentLV->setSorting( -1 );
   glay->addWidget( d->currentLV, row, 2 );
 
-  connect( d->availableLV, SIGNAL(selectionChanged(QListViewItem*)),
+  connect( d->availableLV, SIGNAL(clicked( QListViewItem * )),
 	   SLOT(slotAvailableSelectionChanged(QListViewItem*)) );
-  connect( d->currentLV, SIGNAL(selectionChanged(QListViewItem*)),
+  connect( d->currentLV, SIGNAL(clicked(QListViewItem*)),
 	   SLOT(slotCurrentOrderSelectionChanged(QListViewItem*)) );
 
   d->placeHolderItem = new QListViewItem( d->availableLV, "_X_", i18n("All others") );
Index: libkpgp/kpgpui.cpp
===================================================================
--- libkpgp/kpgpui.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkpgp/kpgpui.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -304,8 +304,8 @@
 
   resize( dialogSize );
 
-  mCheckSelectionTimer = new QTimer( this );
-  mStartSearchTimer = new QTimer( this );
+  mCheckSelectionTimer = new QTimer( this, "mCheckSelectionTimer" );
+  mStartSearchTimer = new QTimer( this, "mStartSearchTimer" );
 
   // load the key status icons
   mKeyGoodPix    = new QPixmap( UserIcon("key_ok") );
Index: libkmime/boolflags.cpp
===================================================================
--- libkmime/boolflags.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkmime/boolflags.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -28,7 +28,7 @@
     n=0;
   }
   else { //second byte
-    p=(1 << i-8);
+    p=(1 << ( i-8 ));
     n=1;
   }
 
Index: karm/ktimewidget.cpp
===================================================================
--- karm/ktimewidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ karm/ktimewidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,9 +30,6 @@
       if ( ! ok )
         return Invalid;
 
-      if ( str.contains('-') != 0 )
-        return Invalid;
-
       if ( _tp==MINUTE && val >= 60  )
         return Invalid;
       else
Index: karm/support/karm.desktop
===================================================================
--- karm/support/karm.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ karm/support/karm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -77,4 +77,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Multi
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Calendar;
Index: libkpimexchange/core/exchangemonitor.cpp
===================================================================
--- libkpimexchange/core/exchangemonitor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkpimexchange/core/exchangemonitor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -109,12 +109,12 @@
   }
 
   if ( mPollMode == Poll ) {
-    mPollTimer = new QTimer( this );
+    mPollTimer = new QTimer( this, "mPollTimer" );
     connect( mPollTimer, SIGNAL(timeout()), this, SLOT(slotPollTimer()) );
     mPollTimer->start( 60000 ); // 1 minute timer
   }
 
-  mRenewTimer = new QTimer( this );
+  mRenewTimer = new QTimer( this, "mRenewTimer" );
   connect( mRenewTimer, SIGNAL(timeout()), this, SLOT(slotRenewTimer()) );
   mRenewTimer->start( mSubscriptionLifetime * 900 ); // 10% early so as to be in time
 }
Index: kdgantt/KDGanttViewSubwidgets.cpp
===================================================================
--- kdgantt/KDGanttViewSubwidgets.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kdgantt/KDGanttViewSubwidgets.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -58,7 +58,8 @@
 #include <kcalendarsystem.h>
 #include <kdebug.h>
 
-KDTimeTableWidget:: KDTimeTableWidget( QWidget* parent,KDGanttView* myGantt):QCanvas (parent)
+KDTimeTableWidget:: KDTimeTableWidget( QWidget* parent,KDGanttView* myGantt)
+    : QCanvas (parent)
 {
     myGanttView = myGantt;
     taskLinksVisible = true;
@@ -3163,7 +3164,8 @@
 
 
 
-KDGanttCanvasView::KDGanttCanvasView( KDGanttView* sender,QCanvas* canvas, QWidget* parent,  const char* name ) : QCanvasView ( canvas, parent, name )
+KDGanttCanvasView::KDGanttCanvasView( KDGanttView* sender,QCanvas* canvas, QWidget* parent,  const
+    char* name ) : QCanvasView ( canvas, parent, name ), scrollBarTimer( 0, "scrollBarTimer" )
 {
     setHScrollBarMode (QScrollView::AlwaysOn );
     setVScrollBarMode( QScrollView::AlwaysOn );
@@ -3228,7 +3230,7 @@
     // If they needed a scrollbar timer in scrollview...
     connect( &scrollBarTimer, SIGNAL(timeout()), this, SLOT(myUpdateScrollBars() ) );
     
-    myScrollTimer = new QTimer( this );
+    myScrollTimer = new QTimer( this, "myScrollTimer" );
     connect( myScrollTimer, SIGNAL( timeout() ), SLOT( slotScrollTimer() ) );
     autoScrollEnabled = false;
 }
Index: kmail/kmfoldersearch.h
===================================================================
--- kmail/kmfoldersearch.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldersearch.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -173,7 +173,7 @@
   virtual int open(const char *owner);
   virtual int canAccess();
   virtual void sync();
-  virtual void close(const char *owner, bool force=FALSE);
+  virtual void reallyDoClose(const char *owner);
   virtual int create();
   virtual int compact( bool );
   virtual bool isReadOnly() const;
Index: kmail/folderstorage.h
===================================================================
--- kmail/folderstorage.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/folderstorage.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -256,7 +256,8 @@
 
   /** Close folder. If force is TRUE the files are closed even if
     others still use it (e.g. other mail reader windows). */
-  virtual void close(const char * owner,bool force=FALSE) = 0;
+  void close(const char * owner, bool force=FALSE);
+  virtual void reallyDoClose(const char * owner) = 0;
 
   /** Try releasing @p folder if possible, something is attempting an exclusive access to it.
       Currently used for KMFolderSearch and the background tasks like expiry. */
Index: kmail/kmail.antispamrc
===================================================================
--- kmail/kmail.antispamrc	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmail.antispamrc	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -22,8 +22,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #2]
 Ident=bogofilter
@@ -141,8 +141,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #8]
 Ident=spamassassin
@@ -165,8 +165,8 @@
 ScoreName=Spamassassin
 ScoreHeader=X-Spam-Status
 ScoreType=Adjusted
-ScoreValueRegexp=(?:hits|score)=([\d\.-]+)\s
-ScoreThresholdRegexp=required=([\d\.-]+)\s
+ScoreValueRegexp=(?:hits|score)=([\d\.-]+)[^\d\.]
+ScoreThresholdRegexp=required=([\d\.-]+)[^\d\.]
 
 [Spamtool #9]
 Ident=bsfilter
@@ -229,4 +229,9 @@
 UseRegExp=0
 SupportsBayes=1
 SupportsUnsure=1
+ScoreName=CRM114
+ScoreHeader=X-CRM114-Status
+ScoreType=Bool
+ScoreValueRegexp=SPAM
+ScoreThresholdRegexp=
 
Index: kmail/imapaccountbase.cpp
===================================================================
--- kmail/imapaccountbase.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/imapaccountbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -81,6 +81,8 @@
 
   ImapAccountBase::ImapAccountBase( AccountManager * parent, const QString & name, uint id )
     : NetworkAccount( parent, name, id ),
+      mIdleTimer( 0, "mIdleTimer" ),
+      mNoopTimer( 0, "mNoopTimer" ),
       mTotal( 0 ),
       mCountUnread( 0 ),
       mCountLastUnread( 0 ),
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -52,6 +52,7 @@
 #include "accountmanager.h"
 #include "kmfoldercachedimap.h"
 #include "kmacctcachedimap.h"
+#include "acljobs.h"
 
 #include <mimelib/enum.h>
 #include <mimelib/utility.h>
@@ -412,8 +413,8 @@
        && itmime != attachmentMimetypes.end()
        && iturl != attachmentURLs.end();
        ++itname, ++iturl, ++itmime ){
-    bool bymimetype = (*itmime).startsWith( "application/x-vnd.kolab." );
-    if( !updateAttachment( *msg, *iturl, *itname, *itmime, !bymimetype ) ){
+    bool byname = !(*itmime).startsWith( "application/x-vnd.kolab." );
+    if( !updateAttachment( *msg, *iturl, *itname, *itmime, byname ) ){
       kdWarning(5006) << "Attachment error, can not add Incidence." << endl;
       bAttachOK = false;
       break;
@@ -473,6 +474,8 @@
 int KMailICalIfaceImpl::incidencesKolabCount( const QString& mimetype,
                                               const QString& resource )
 {
+  Q_UNUSED( mimetype ); // honouring that would be too slow...
+
   if( !mUseResourceIMAP )
     return 0;
 
@@ -485,7 +488,7 @@
   f->open("kolabcount");
   int n = f->count();
   f->close("kolabcount");
-  kdDebug(5006) << "KMailICalIfaceImpl::incidencesKolabCount( " << mimetype << ", "
+  kdDebug(5006) << "KMailICalIfaceImpl::incidencesKolabCount( "
                 << resource << " ) returned " << n << endl;
   return n;
 }
@@ -610,7 +613,8 @@
   // Add the default one
   KMFolder* f = folderFromType( contentsType, QString::null );
   if ( f ) {
-    subResources.append( SubResource( f->location(),  f->prettyURL(), !f->isReadOnly() ) );
+    subResources.append( SubResource( f->location(),  f->prettyURL(),
+                                      !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
     kdDebug(5006) << "Adding(1) folder " << f->location() << "    " <<
       ( f->isReadOnly() ? "readonly" : "" ) << endl;
   }
@@ -621,7 +625,8 @@
   for ( ; it.current(); ++it ){
     f = it.current()->folder;
     if ( f && f->storage()->contentsType() == t ) {
-      subResources.append( SubResource( f->location(), f->prettyURL(), !f->isReadOnly() ) );
+      subResources.append( SubResource( f->location(), f->prettyURL(),
+                                        !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
       kdDebug(5006) << "Adding(2) folder " << f->location() << "     " <<
               ( f->isReadOnly() ? "readonly" : "" ) << endl;
     }
@@ -779,8 +784,8 @@
           && itmime != attachmentMimetypes.end()
           && itname != attachmentNames.end();
           ++iturl, ++itname, ++itmime ){
-        bool bymimetype = (*itname).startsWith( "application/x-vnd.kolab." );
-        if( !updateAttachment( *newMsg, *iturl, *itname, *itmime, bymimetype ) ){
+        bool byname = !(*itmime).startsWith( "application/x-vnd.kolab." );
+        if( !updateAttachment( *newMsg, *iturl, *itname, *itmime, byname ) ){
           kdDebug(5006) << "Attachment error, can not update attachment " << *iturl << endl;
           break;
         }
@@ -1258,7 +1263,8 @@
     connectFolder( folder );
   }
   // Tell about the new resource
-  subresourceAdded( folderContentsType( contentsType ), location, folder->prettyURL() );
+  subresourceAdded( folderContentsType( contentsType ), location, folder->prettyURL(),
+                    !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 }
 
 KMFolder* KMailICalIfaceImpl::extraFolder( const QString& type,
@@ -1402,8 +1408,8 @@
     const QString contentsTypeStr = folderContentsType( folder->storage()->contentsType() );
     subresourceDeleted( contentsTypeStr, location );
 
-    subresourceAdded( contentsTypeStr, location, folder->prettyURL()  /*,
-                      !folder->isReadOnly() , folderIsAlarmRelevant( folder ) TODO */ );
+    subresourceAdded( contentsTypeStr, location, folder->prettyURL(),
+                      !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 
   }
 }
@@ -1642,11 +1648,11 @@
 
   // END TILL TODO
 
-  subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label() );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label() );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label(), true, true );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label(), true, true );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label(), true, false );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label(), true, false );
+  subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label(), true, false );
 
   reloadFolderTree();
 }
@@ -1870,6 +1876,36 @@
   }
 }
 
+/* We treat all folders as relevant wrt alarms for which we have Administer
+ * rights or for which the "Incidences relevant for everyone" annotation has
+ * been set. It can be reasonably assumed that those are "ours". All local folders
+ * must be ours anyhow. */
+bool KMailICalIfaceImpl::folderIsAlarmRelevant( const KMFolder *folder )
+{
+  bool administerRights = true;
+  bool relevantForOwner = true;
+  bool relevantForEveryone = false;
+  if ( folder->folderType() == KMFolderTypeImap ) {
+    const KMFolderImap *imapFolder = static_cast<const KMFolderImap*>( folder->storage() );
+    administerRights =
+      imapFolder->userRights() <= 0 || imapFolder->userRights() & KMail::ACLJobs::Administer;
+  }
+  if ( folder->folderType() == KMFolderTypeCachedImap ) {
+    const KMFolderCachedImap *dimapFolder = static_cast<const KMFolderCachedImap*>( folder->storage() );
+    administerRights =
+      dimapFolder->userRights() <= 0 || dimapFolder->userRights() & KMail::ACLJobs::Administer;
+    relevantForOwner = dimapFolder->incidencesFor () == KMFolderCachedImap::IncForAdmins;
+    relevantForEveryone = ( dimapFolder->incidencesFor() == KMFolderCachedImap::IncForReaders );
+  }
+#if 0
+  kdDebug(5006) << k_funcinfo << endl;
+  kdDebug(5006) << "Folder: " << folder->label() << " has administer rights: " << administerRights << endl;
+  kdDebug(5006) << "and is relevant for owner: " << relevantForOwner <<  endl;
+  kdDebug(5006) << "and relevant for everyone: "  << relevantForEveryone << endl;
+#endif
+  return ( administerRights && relevantForOwner ) || relevantForEveryone;
+}
+
 void KMailICalIfaceImpl::setResourceQuiet(bool q)
 {
   mResourceQuiet = q;
Index: kmail/kmheaders.cpp
===================================================================
--- kmail/kmheaders.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmheaders.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -2077,7 +2077,9 @@
 void KMHeaders::resetCurrentTime()
 {
     mDate.reset();
-    QTimer::singleShot( 1000, this, SLOT( resetCurrentTime() ) );
+    // only reset exactly during minute switch
+    QTimer::singleShot( ( 60-QTime::currentTime().second() ) * 1000, 
+        this, SLOT( resetCurrentTime() ) );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/khtmlparthtmlwriter.cpp
===================================================================
--- kmail/khtmlparthtmlwriter.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/khtmlparthtmlwriter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -49,7 +49,7 @@
   KHtmlPartHtmlWriter::KHtmlPartHtmlWriter( KHTMLPart * part,
 					    QObject * parent, const char * name )
     : QObject( parent, name ), HtmlWriter(),
-      mHtmlPart( part ), mState( Ended )
+      mHtmlPart( part ), mState( Ended ), mHtmlTimer( 0, "mHtmlTimer" )
   {
     assert( part );
     connect( &mHtmlTimer, SIGNAL(timeout()), SLOT(slotWriteNextHtmlChunk()) );
Index: kmail/kmail.antispamrc-HOWTO
===================================================================
--- kmail/kmail.antispamrc-HOWTO	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kmail/kmail.antispamrc-HOWTO	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,154 @@
+
+HOWTO for setting up a KMail antispam wizard configuration entry
+================================================================
+
+This is a HOWTO for setting up a KMail antispam wizard configuration
+entry. Since this possibly is more developer related, I put this as
+text file into the source SVN. Possibly some of this should go to the
+user documentation.
+
+I gathered the information from several mails and comments by Andreas
+Gungl, the original developer of the antispam wizard for KMail, and
+Ingo Kloecker.
+
+When you have questions do not hesitate to ask me, Martin Steigerwald, 
+Andreas or Ingo.
+
+
+Basics
+------
+
+The configuration file for the KMail antispam wizard "kmail.antispamrc"
+consists of one entry for each spamfilter that the antispam wizard
+shall support.
+
+At the beginning of the file in the section "General" the option "tools" 
+specifies the count of configured spam filters. Increase that by one 
+when you add a new entry:
+
+[General]
+tools=11
+
+
+A spam filter configuration entry starts with a header like this:
+
+[Spamtool #11]
+
+
+After this you place all the options for the spam filter. Please use
+an ordering that is similar to the other entries in the configuration
+file so that things are unified a bit.
+
+
+General options
+---------------
+
+- Ident: Specifies the internal identifier for the entry
+
+- Version: Specifies the version of the entry (FIXME what is this for?)
+
+- Priority: Specifies the priority of the filter. This value is used to
+  place faster filters before the slower ones in the selection list. If the
+  user chooses the top item, he gets the fastest filter. Provider sided
+  "filters" (which produce headers tough) like the GMX filter have a prio
+  at about 70, they are very fast as they don't consume time on the client
+  side. Since CRM114 is almost as fast it gets 65 ;-).
+
+- VisibleName: This is the name that is presented to the user
+
+Or:
+
+- HeadersOnly=yes: This is used for entries where KMail should just parse
+  the mail headers for the spam score display (see Razor filter and below
+  for spam score display details).
+
+
+Spam filter options
+-------------------
+
+These specify details about the spamfilter.
+
+- Executable: Specifies a test whether the executable of the spamfilter
+  can be started. You should provide something which can be run on the
+  command line and returns [ $? -eq 0 ], i.e. it doesn't wait for any input 
+  etc. It usually make sense to assume the program in the $PATH, so you
+  should better avoid /usr/bin. Set executable to "echo" for provider based 
+  filters.
+  Example: Executable=crm -v | grep "CRM114"
+
+- URL: URL to the homepage of the filter
+
+- PipeFilterName: Name of the pipe-through filter used to send mails to the
+  spamfilter and get them back with added spam filter headers.
+
+- PipeCmdDetect: Command used to pipe the mail into.
+
+- ExecCmdSpam: Command used to mark a mail as spam.
+
+- ExecCmdHam: Command used to mark a mail as ham.
+
+- SupportsBayes: Set to 1 if you have a spam filter that can learn. Only
+  in this case KMail uses ExecCmdSpam and ExecCmdHam to let the user mark
+  mail as ham or spam.
+
+
+Spam detection options
+----------------------
+
+These specify how KMail shall detect whether a mail is spam, unsure or good.
+
+- DetectionHeader: The name of the header where the spam filter puts the spam
+  status of a mail into.
+
+- DetectionPattern: The pattern the spam filter uses for marking a mail as
+  spam.
+
+- DetectionPattern2: The pattern the spam filter uses for marking a mail as
+  unsure. Set "SupportsUnsure=1" when you use this.
+
+- DetectionOnly: Don't pipe mails through the spam filter, but just use headers
+  from outside, e.g. a provider based spam filter (See GMX).
+
+- UseRegExp: Set to 1 if you need to use regular expressions in the detection
+  patterns. KMail can operate faster when they are not required.
+
+- SupportsUnsure: Set to 1 if you have a spam filter that supports
+  classying mails as unsure to tell the user to train those.
+
+
+Spam score display
+------------------
+
+Those regular expressions are used to extract the actual "spamicity" 
+score and the threshold (i.e. the upper bound for non-spam) from 
+SpamAssassin's ScoreHeader. The score and the threshold are then used 
+for showing the spam status in the message header, i.e. the small 
+colorbar.
+
+You need to specify the following values:
+
+- ScoreName: The name that will be shown in the message header.
+
+- ScoreHeader: The message header containing the score value.
+
+- ScoreType: The type of the score, cf. below.
+
+- ScoreValueRegexp: A regular expression for extracting the score from 
+  the ScoreHeader.
+
+- ScoreThresholdRegexp: A regular expression for extracting the threshold 
+  from the ScoreHeader; only needed for Adjusted type. Please set to 
+  nothing (ScoreThresholdRegexp=) if not needed.
+
+
+KMail supports the following ScoreType values:
+
+- Bool: Simple Yes or No (Razor)
+
+- Decimal: For probability between 0.0 and 1.0 (BogoFilter)
+
+- Percentage: For straight percentages between 0.0 and 100.0
+
+- Adjusted: Use this when we need to compare against a threshold
+  (SpamAssasssin)
+
Index: kmail/bodyvisitor.cpp
===================================================================
--- kmail/bodyvisitor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/bodyvisitor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -45,6 +45,7 @@
     mBasicList += "APPLICATION/PKCS7-SIGNATURE";
     // groupware
     mBasicList += "APPLICATION/MS-TNEF";
+    mBasicList += "TEXT/CALENDAR";
   }
 
   //-----------------------------------------------------------------------------
@@ -75,7 +76,7 @@
     {
       ++it;
       // skip this part if the parent part is already loading
-      if ( part->parent() && 
+      if ( part->parent() &&
            selected.contains( part->parent() ) &&
            part->loadPart() )
         continue;
@@ -91,7 +92,7 @@
         selected.append( fake );
         break;
       }
-        
+
       if ( headerCheck && !part->partSpecifier().endsWith(".HEADER") )
       {
         // this is an embedded simple message (not multipart) so we get no header part
@@ -102,15 +103,15 @@
         fake->setPartSpecifier( partId );
         fake->setOriginalContentTypeStr("");
         fake->setLoadPart( true );
-        if ( addPartToList( fake ) ) 
+        if ( addPartToList( fake ) )
           selected.append( fake );
       }
-      
+
       if ( part->originalContentTypeStr() == "MESSAGE/RFC822" )
         headerCheck = true;
       else
         headerCheck = false;
-      
+
       // check whether to load this part or not:
       // look at the basic list, ask the subclass and check the parent
       if ( mBasicList.contains( part->originalContentTypeStr() ) ||
@@ -127,7 +128,7 @@
       if ( !part->partSpecifier().endsWith(".HEADER") &&
            part->typeStr() != "MULTIPART" )
         part->setLoadHeaders( true ); // load MIME header
-      
+
       if ( part->loadHeaders() || part->loadPart() )
         selected.append( part );
     }
@@ -205,5 +206,5 @@
 
     return false;
   }
-  
+
 }
Index: kmail/kmailicalIface.h
===================================================================
--- kmail/kmailicalIface.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmailicalIface.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -51,11 +51,12 @@
   struct SubResource {
     //dcopidl barfs on those constructors, but dcopidlng works
     SubResource() {} // for QValueList
-    SubResource( const QString& loc, const QString& lab, bool rw )
-      : location( loc ), label( lab ), writable( rw ) {}
+    SubResource( const QString& loc, const QString& lab, bool rw, bool ar )
+      : location( loc ), label( lab ), writable( rw ), alarmRelevant( ar ) {}
     QString location; // unique
     QString label;    // shown to the user
     bool writable;
+    bool alarmRelevant;
   };
 
   /// The format of the mails containing other contents than actual mail
@@ -94,7 +95,7 @@
 
   /// Return the number of mails that need to be looked at by incidencesKolab.
   /// This allows to call incidencesKolab in chunks.
-  virtual int incidencesKolabCount( const QString& mimetype,
+  virtual int incidencesKolabCount( const QString& mimetype /*ignored*/,
                                     const QString& resource ) = 0;
 
   virtual QMap<Q_UINT32, QString> incidencesKolab( const QString& mimetype,
@@ -121,18 +122,18 @@
                          const QString& uid );
   void signalRefresh( const QString& type, const QString& folder );
   void subresourceAdded( const QString& type, const QString& resource,
-                         const QString& label );
+                         const QString& label, bool writable, bool alarmRelevant );
   void subresourceDeleted( const QString& type, const QString& resource );
 };
 
 inline QDataStream& operator<<( QDataStream& str, const KMailICalIface::SubResource& subResource )
 {
-  str << subResource.location << subResource.label << subResource.writable;
+  str << subResource.location << subResource.label << subResource.writable << subResource.alarmRelevant;
   return str;
 }
 inline QDataStream& operator>>( QDataStream& str, KMailICalIface::SubResource& subResource )
 {
-  str >> subResource.location >> subResource.label >> subResource.writable;
+  str >> subResource.location >> subResource.label >> subResource.writable >> subResource.alarmRelevant;
   return str;
 }
 
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -219,22 +219,8 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMaildir::close(const char *, bool aForced)
+void KMFolderMaildir::reallyDoClose(const char *)
 {
-  if (mOpenCount <= 0) return;
-  if (mOpenCount > 0) mOpenCount--;
-
-  if (mOpenCount > 0 && !aForced) return;
-
-#if 0 // removed hack that prevented closing system folders (see kmail-devel discussion about mail expiring)
-  if ( (folder() != kmkernel->inboxFolder())
-       && folder()->isSystemFolder() && !aForced)
-  {
-     mOpenCount = 1;
-     return;
-  }
-#endif
-
   if (mAutoCreateIndex)
   {
       updateIndex();
Index: kmail/jobscheduler.cpp
===================================================================
--- kmail/jobscheduler.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/jobscheduler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -35,7 +35,7 @@
 using namespace KMail;
 
 JobScheduler::JobScheduler( QObject* parent, const char* name )
-  : QObject( parent, name ), mTimer( this ),
+  : QObject( parent, name ), mTimer( this, "mTimer" ),
     mPendingImmediateTasks( 0 ),
     mCurrentTask( 0 ), mCurrentJob( 0 )
 {
Index: kmail/globalsettings.cpp
===================================================================
--- kmail/globalsettings.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/globalsettings.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -40,7 +40,7 @@
 
 GlobalSettings::GlobalSettings()
 {
-  mConfigSyncTimer = new QTimer( this );
+  mConfigSyncTimer = new QTimer( this, "mConfigSyncTimer" );
   connect( mConfigSyncTimer, SIGNAL( timeout() ), this, SLOT( slotSyncNow() ) );
 }
 
Index: kmail/searchwindow.cpp
===================================================================
--- kmail/searchwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/searchwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -117,7 +117,7 @@
   mSortColumn(0),
   mSortOrder(Ascending),
   mFolder(0),
-  mTimer(new QTimer(this)),
+  mTimer(new QTimer(this, "mTimer")),
   mLastFocus(0),
   mKMMainWidget(w)
 {
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -509,7 +509,10 @@
     mSelectEncodingAction( 0 ),
     mToggleFixFontAction( 0 ),
     mHtmlWriter( 0 ),
-    mSavedRelativePosition( 0 )
+    mSavedRelativePosition( 0 ),
+    updateReaderWinTimer( 0, "updateReaderWinTimer" ),
+    mResizeTimer( 0, "mResizeTimer" ),
+    mDelayedMarkTimer( 0, "mDelayedMarkTimer" )
 {
   mSplitterSizes << 180 << 100;
   mMimeTreeMode = 1;
Index: kmail/kmailicalifaceimpl.h
===================================================================
--- kmail/kmailicalifaceimpl.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmailicalifaceimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -274,6 +274,8 @@
 
   StorageFormat globalStorageFormat() const;
 
+  static bool folderIsAlarmRelevant( const KMFolder * );
+
 private:
   QGuardedPtr<KMFolder> mContacts;
   QGuardedPtr<KMFolder> mCalendar;
Index: kmail/kmaccount.cpp
===================================================================
--- kmail/kmaccount.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -324,7 +324,7 @@
   if (mInterval <= 0) return;
   if(!mTimer)
   {
-    mTimer = new QTimer();
+    mTimer = new QTimer(0, "mTimer");
     connect(mTimer,SIGNAL(timeout()),SLOT(mailCheck()));
   }
   else
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -699,6 +699,10 @@
   KMMessage *newMsg = new KMMessage( new DwMessage( *msg->asDwMessage() ) );
   newMsg->setComplete( msg->isComplete() );
 
+  // these fields need to be regenerated for the new message
+  newMsg->removeHeaderField("Date");
+  newMsg->removeHeaderField("Message-ID");
+
   KMail::Composer *win = KMail::makeComposer();
   newMsg->setTransferInProgress( false ); // From here on on, the composer owns the message.
   win->setMsg( newMsg, FALSE, TRUE );
@@ -1217,7 +1221,7 @@
     for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
       TemplateParser parser( fwdMsg, TemplateParser::Forward,
         msg->body(), false, false, false, false);
-        parser.process( msg, false, true );
+        parser.process( msg, 0, true );
 
       fwdMsg->link( msg, KMMsgStatusForwarded );
     }
@@ -1242,7 +1246,7 @@
     {
       KMail::Composer * win = KMail::makeComposer( fwdMsg, id );
       win->setCharset( fwdMsg->codec()->mimeName(), true );
-      // win->setBody( QString::fromUtf8( msg->createForwardBody() ) );
+      win->setBody( fwdMsg->bodyToUnicode() );
       win->show();
     }
   }
@@ -1521,7 +1525,7 @@
     for ( KMMessage *msg = linklist.first(); msg; msg = linklist.next() ) {
       TemplateParser parser( fwdMsg, TemplateParser::Forward,
         msg->body(), false, false, false, false);
-        parser.process( msg, false, true );
+        parser.process( msg, 0, true );
 
       fwdMsg->link( msg, KMMsgStatusForwarded );
     }
@@ -1924,7 +1928,7 @@
   for (msgBase = mMsgList.first(); msgBase; msgBase = mMsgList.next() )
   {
     KMFolder *srcFolder = msgBase->parent();
-    if (isMessage = msgBase->isMessage())
+    if (( isMessage = msgBase->isMessage() ))
     {
       msg = static_cast<KMMessage*>(msgBase);
     } else {
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -203,12 +203,15 @@
 
 KMFolderCachedImap::~KMFolderCachedImap()
 {
+  if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
+}
+
+void KMFolderCachedImap::reallyDoClose( const char * owner )
+{
   if( !mFolderRemoved ) {
-    writeConfig();
     writeUidCache();
   }
-
-  if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
+  KMFolderMaildir::reallyDoClose( owner );
 }
 
 void KMFolderCachedImap::initializeFrom( KMFolderCachedImap* parent )
@@ -272,6 +275,12 @@
   if ( mImapPath.isEmpty() ) {
     mImapPathCreation = config->readEntry("ImapPathCreation");
   }
+
+  QStringList uids = config->readListEntry( "UIDSDeletedSinceLastSync" );
+//  kdDebug( 5006 ) << "READING IN UIDSDeletedSinceLastSync: " << folder()->prettyURL() << endl << uids << endl;
+  for ( QStringList::iterator it = uids.begin(); it != uids.end(); it++ ) {
+      mDeletedUIDsSinceLastSync.insert( (*it).toULong(), 0);
+  }
 }
 
 void KMFolderCachedImap::writeConfig()
@@ -287,6 +296,15 @@
     } else {
       configGroup.deleteEntry( "ImapPathCreation" );
     }
+    if ( !mDeletedUIDsSinceLastSync.isEmpty() ) {
+        QValueList<ulong> uids = mDeletedUIDsSinceLastSync.keys();
+        QStringList uidstrings;
+        for( QValueList<ulong>::iterator it = uids.begin(); it != uids.end(); it++ ) {
+            uidstrings.append(  QString::number( (*it) ) );
+        }
+        configGroup.writeEntry( "UIDSDeletedSinceLastSync", uidstrings );
+//        kdDebug( 5006 ) << "WRITING OUT UIDSDeletedSinceLastSync in: " << folder( )->prettyURL( ) << endl << uidstrings << endl;
+    }
   }
   writeConfigKeysWhichShouldNotGetOverwrittenByReadConfig();
   KMFolderMaildir::writeConfig();
@@ -361,11 +379,12 @@
       if( cacheVersion == UIDCACHE_VERSION ) {
         len = uidcache.readLine( buf, sizeof(buf) );
         if( len > 0 ) {
-          setUidValidity( QString::fromLocal8Bit( buf).stripWhiteSpace() );
+          setUidValidity( QString::fromLocal8Bit(buf).stripWhiteSpace() );
           len = uidcache.readLine( buf, sizeof(buf) );
           if( len > 0 ) {
+//            kdDebug(5006) << "Reading in last uid from cache: " << QString::fromLocal8Bit(buf).stripWhiteSpace() << " in " << folder()->prettyURL() << endl;
             // load the last known highest uid from the on disk cache
-            setLastUid( QString::fromLocal8Bit( buf).stripWhiteSpace().toULong() );
+            setLastUid( QString::fromLocal8Bit(buf).stripWhiteSpace().toULong() );
             return 0;
           }
         }
@@ -384,6 +403,7 @@
     return 0;
   }
 
+//  kdDebug(5006) << "Writing out UID cache lastuid: " << lastUid()  << " in: " << folder()->prettyURL() << endl;
   QFile uidcache( uidCacheLocation() );
   if( uidcache.open( IO_WriteOnly ) ) {
     QTextStream str( &uidcache );
@@ -425,6 +445,7 @@
 KMMessage* KMFolderCachedImap::take(int idx)
 {
   uidMapDirty = true;
+  rememberDeletion( idx );
   return KMFolderMaildir::take(idx);
 }
 
@@ -457,11 +478,21 @@
   return rc;
 }
 
+void KMFolderCachedImap::rememberDeletion( int idx )
+{
+  KMMsgBase *msg = getMsgBase( idx );
+  assert(msg);
+  ulong uid = msg->UID();
+  assert(uid>=0);
+  mDeletedUIDsSinceLastSync.insert(uid, 0);
+//  kdDebug(5006) << "Explicit delete of UID " << uid << " at index: " << idx << " in " << folder()->prettyURL();
+}
 
 /* Reimplemented from KMFolderMaildir */
 void KMFolderCachedImap::removeMsg(int idx, bool imapQuiet)
 {
   uidMapDirty = true;
+  rememberDeletion( idx );
   // Remove it from disk
   KMFolderMaildir::removeMsg(idx,imapQuiet);
 }
@@ -518,6 +549,7 @@
 
 void KMFolderCachedImap::setLastUid( ulong uid )
 {
+//  kdDebug(5006) << "Setting mLastUid to: " << uid  <<  " in " << folder()->prettyURL() << endl;
   mLastUid = uid;
   if( uidWriteTimer == -1 )
     // Write in one minute
@@ -549,6 +581,7 @@
   if( it != uidMap.end() ) {
     KMMsgBase *msg = getMsgBase( *it );
 #if MAIL_LOSS_DEBUGGING
+    kdDebug(5006) << "Folder: " << folder()->prettyURL() << endl;
     kdDebug(5006) << "UID " << uid << " is supposed to be in the map" << endl;
     kdDebug(5006) << "UID's index is to be " << *it << endl;
     kdDebug(5006) << "There is a message there? " << (msg != 0) << endl;
@@ -1538,6 +1571,9 @@
   if ( job->error() ) {
     // Skip the EXPUNGE state if deleting didn't work, no need to show two error messages
     mSyncState = SYNC_STATE_GET_MESSAGES;
+  } else {
+    // deleting on the server went fine, clear the pending deletions cache
+    mDeletedUIDsSinceLastSync.clear();
   }
   mProgress += 10;
   serverSyncInternal();
@@ -1676,14 +1712,24 @@
         // kdDebug(5006) << "KMFolderCachedImap::slotGetMessagesData() : folder "<<label()<<" already has msg="<<msg->headerField("Subject") << ", UID="<<uid << ", lastUid = " << mLastUid << endl;
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
-          if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
+//           kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should delete it" << endl;
+          // double check we deleted it since the last sync
+           if ( mDeletedUIDsSinceLastSync.contains(uid) ) {
+               if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
 #if MAIL_LOSS_DEBUGGING
-            kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+                   kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
 #endif
-            uidsForDeletionOnServer << uid;
-          } else {
-            redownload = true;
-          }
+                   uidsForDeletionOnServer << uid;
+               } else {
+                   redownload = true;
+               }
+           } else {
+//               kdDebug(5006) << "WARNING: ####### " << endl;
+//               kdDebug(5006) << "Message locally missing but not deleted in folder: " << folder()->prettyURL() << endl;
+//               kdDebug(5006) << "The missing UID: " << uid << ". It will be redownloaded " << endl;
+               redownload = true;
+           }
+
         } else {
           // if this is a read only folder, ignore status updates from the server
           // since we can't write our status back our local version is what has to
@@ -1696,6 +1742,7 @@
         // kdDebug(5006) << "message with uid " << uid << " found in the local cache. " << endl;
       }
       if ( uid > lastUid() || redownload ) {
+//      kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should download it" << endl;
         // The message is new since the last sync, but we might have just uploaded it, in which case
         // the uid map already contains it.
         if ( !uidMap.contains( uid ) ) {
@@ -1705,8 +1752,10 @@
             mUidsForDownload << uid;
         }
         // Remember the highest uid and once the download is completed, update mLastUid
-        if ( uid > mTentativeHighestUid )
+        if ( uid > mTentativeHighestUid ) {
+//          kdDebug(5006) << "Setting the tentative highest UID to: " << uid << endl;
           mTentativeHighestUid = uid;
+        }
       }
     }
     (*it).cdata.remove(0, pos);
@@ -2640,8 +2689,37 @@
 
 void KMFolderCachedImap::slotUpdateLastUid()
 {
-  if( mTentativeHighestUid != 0 )
-    setLastUid( mTentativeHighestUid );
+  if( mTentativeHighestUid != 0 ) {
+    
+      // Sanity checking:
+      // By now all new mails should be downloaded, which means
+      // that iteration over the folder should yield only UIDs
+      // lower or equal to what we think the highes ist, and the
+      // highest one as well. If not, our notion of the highest
+      // uid we've seen thus far is wrong, which is dangerous, so
+      // don't update the mLastUid, then.
+      bool sane = false;
+
+      for (int i=0;i<count(); i++ ) {
+          ulong uid = getMsgBase(i)->UID();
+          if ( uid > mTentativeHighestUid && uid > lastUid() ) {
+              kdWarning(5006) << "DANGER: Either the server listed a wrong highest uid, "
+                  "or we parsed it wrong. Send email to adam@kde.org, please, and include this log." << endl;
+              kdWarning(5006) << "uid: " << uid << " mTentativeHighestUid: " << mTentativeHighestUid << endl;
+              assert( false );
+              break;
+          } else if ( uid == mTentativeHighestUid || lastUid() ) {
+              // we've found our highest uid, all is well
+              sane = true;
+          } else {
+              // must be smaller, that's ok, let's wait for bigger fish
+          }
+      }
+      if (sane) {
+//          kdDebug(5006) << "Tentative highest UID test was sane, writing out: " << mTentativeHighestUid << endl;
+          setLastUid( mTentativeHighestUid );
+      }
+  }
   mTentativeHighestUid = 0;
 }
 
Index: kmail/renamejob.cpp
===================================================================
--- kmail/renamejob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/renamejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -51,6 +51,23 @@
 
 using namespace KMail;
 
+template <typename T> static QStringList imapPaths( FolderStorage* storage )
+{
+  QStringList rv;
+  rv.append( static_cast<T>( storage )->imapPath() );
+  KMFolderDir* dir = storage->folder()->child();
+  if ( dir ) {
+    KMFolderNode *node = dir->first();
+    while ( node ) {
+      if ( !node->isDir() ) {
+        rv += imapPaths<T>( static_cast<KMFolder*>( node )->storage() );
+      }
+      node = dir->next();
+    }
+  }
+  return rv;
+}
+
 RenameJob::RenameJob( FolderStorage* storage, const QString& newName,
     KMFolderDir* newParent )
  : FolderJob( 0, tOther, (storage ? storage->folder() : 0) ),
@@ -62,8 +79,10 @@
     mOldName = storage->name();
     if ( storage->folderType() == KMFolderTypeImap ) {
       mOldImapPath = static_cast<KMFolderImap*>(storage)->imapPath();
+//       mOldImapPaths = imapPaths<KMFolderImap*>( storage );
     } else if ( storage->folderType() == KMFolderTypeCachedImap ) {
       mOldImapPath = static_cast<KMFolderCachedImap*>(storage)->imapPath();
+      mOldImapPaths = imapPaths<KMFolderCachedImap*>( storage );
     }
   }
 }
@@ -215,8 +234,10 @@
   {
     // tell the account (see KMFolderCachedImap::listDirectory2)
     KMAcctCachedImap* acct = static_cast<KMFolderCachedImap*>(mStorage)->account();
-    if ( acct )
-      acct->addDeletedFolder( mOldImapPath );
+    if ( acct ) {
+      for ( QStringList::ConstIterator it = mOldImapPaths.constBegin(); it != mOldImapPaths.constEnd(); ++it )
+        acct->addDeletedFolder( *it );
+    }
     kmkernel->dimapFolderMgr()->remove( mStorage->folder() );
   } else if ( mStorage->folderType() == KMFolderTypeSearch )
   {
Index: kmail/index.cpp
===================================================================
--- kmail/index.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/index.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -85,7 +85,7 @@
 	mIndex( 0 ),
 #endif
 	mIndexPath( QFile::encodeName( defaultPath() ) ),
-	mTimer( new QTimer( this ) ),
+	mTimer( new QTimer( this, "mTimer" ) ),
 	//mSyncState( ss_none ),
 	//mSyncTimer( new QTimer( this ) ),
 	mSlowDown( false ) {
@@ -532,7 +532,7 @@
 
 KMMsgIndex::Search::Search( KMSearch* s ):
 	mSearch( s ),
-	mTimer( new QTimer( this ) ),
+	mTimer( new QTimer( this, "mTimer" ) ),
 	mResidual( new KMSearchPattern ),
 	mState( s_starting ) {
 	connect( mTimer, SIGNAL( timeout() ), SLOT( act() ) );
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1464,6 +1464,9 @@
     kdDebug(5006) << k_funcinfo << "foldersPath (after transferMail): '" << foldersPath << "'" << endl;
   }
 
+  // moved up here because KMMessage::stripOffPrefixes is used below
+  KMMessage::readConfig();
+
   the_undoStack     = new UndoStack(20);
   the_folderMgr     = new KMFolderMgr(foldersPath);
   the_imapFolderMgr = new KMFolderMgr( KMFolderImap::cacheLocation(), KMImapDir);
@@ -1479,8 +1482,6 @@
   the_popFilterMgr     = new KMFilterMgr(true);
   the_filterActionDict = new KMFilterActionDict;
 
-  // moved up here because KMMessage::stripOffPrefixes is used below -ta
-  KMMessage::readConfig();
   initFolders(cfg);
   the_acctMgr->readConfig();
   the_filterMgr->readConfig();
@@ -1521,7 +1522,7 @@
   connect( the_searchFolderMgr, SIGNAL( folderRemoved(KMFolder*) ),
            this, SIGNAL( folderRemoved(KMFolder*) ) );
 
-  mBackgroundTasksTimer = new QTimer( this );
+  mBackgroundTasksTimer = new QTimer( this, "mBackgroundTasksTimer" );
   connect( mBackgroundTasksTimer, SIGNAL( timeout() ), this, SLOT( slotRunBackgroundTasks() ) );
 #ifdef DEBUG_SCHEDULER // for debugging, see jobscheduler.h
   mBackgroundTasksTimer->start( 10000, true ); // 10s minute, singleshot
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -101,6 +101,9 @@
   KMFolderCachedImap(KMFolder* folder, const char* name=0);
   virtual ~KMFolderCachedImap();
 
+  /**  @reimpl */
+  void reallyDoClose( const char * owner );
+
   /** Initialize this storage from another one. Used when creating a child folder */
   void initializeFrom( KMFolderCachedImap* parent );
 
@@ -398,6 +401,7 @@
 private:
   void setReadOnly( bool readOnly );
   QString state2String( int state ) const;
+  void rememberDeletion( int );
 
   /** State variable for the synchronization mechanism */
   enum {
@@ -503,6 +507,7 @@
   int mNamespacesToCheck;
   bool mPersonalNamespacesCheckDone;
   QString mImapPathCreation;
+  QMap<ulong,void*> mDeletedUIDsSinceLastSync;
 
   QuotaInfo mQuotaInfo;
 };
Index: kmail/renamejob.h
===================================================================
--- kmail/renamejob.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/renamejob.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -84,6 +84,7 @@
   QString mNewImapPath;
   QString mOldName;
   QString mOldImapPath;
+  QStringList mOldImapPaths;
   KMFolder* mNewFolder;
   CopyFolderJob *mCopyFolderJob;
 };
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmcommands.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -858,7 +858,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListCommand( QWidget *parent, KMFolder *folder );
 private:
   virtual Result execute();
 private slots:
@@ -873,7 +873,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListPostCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListPostCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -882,7 +882,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListSubscribeCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListSubscribeCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -891,7 +891,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListUnsubscribeCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListUnsubscribeCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -900,7 +900,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListArchivesCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListArchivesCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
@@ -909,7 +909,7 @@
 {
   Q_OBJECT
 public:
-  KMMailingListHelpCommand( QWidget *parent, KMFolder *parent );
+  KMMailingListHelpCommand( QWidget *parent, KMFolder *folder );
 protected:
   virtual KURL::List urls() const;
 };
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -4623,7 +4623,7 @@
   }
   else {
     if ( !mAutoSaveTimer ) {
-      mAutoSaveTimer = new QTimer( this );
+      mAutoSaveTimer = new QTimer( this, "mAutoSaveTimer" );
       connect( mAutoSaveTimer, SIGNAL( timeout() ),
                this, SLOT( autoSaveMessage() ) );
     }
Index: kmail/kmail_view.desktop
===================================================================
--- kmail/kmail_view.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmail_view.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -16,7 +16,7 @@
 Icon=kmail
 DocPath=kmail/index.html
 NoDisplay=true
-MimeType=message/rfc822;application/mbox;application/x-mimearchive
+MimeType=message/rfc822;application/mbox;application/x-mimearchive;
 
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
Index: kmail/folderstorage.cpp
===================================================================
--- kmail/folderstorage.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/folderstorage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -78,7 +78,7 @@
   mNoContent      = false;
   mNoChildren     = false;
   mRDict = 0;
-  mDirtyTimer = new QTimer(this);
+  mDirtyTimer = new QTimer(this, "mDirtyTimer");
   connect(mDirtyTimer, SIGNAL(timeout()),
 	  this, SLOT(updateIndex()));
 
@@ -98,6 +98,14 @@
 }
 
 
+void FolderStorage::close( const char * owner, bool aForced )
+{
+  if (mOpenCount <= 0) return;
+  if (mOpenCount > 0) mOpenCount--;
+  if (mOpenCount > 0 && !aForced) return;
+    reallyDoClose( owner );
+}
+
 //-----------------------------------------------------------------------------
 QString FolderStorage::dotEscape(const QString& aStr)
 {
@@ -200,7 +208,7 @@
      * a timer is created when a folder is checked
      */
     if ( !mEmitChangedTimer) {
-      mEmitChangedTimer= new QTimer( this );
+      mEmitChangedTimer= new QTimer( this, "mEmitChangedTimer" );
       connect( mEmitChangedTimer, SIGNAL( timeout() ),
       this, SLOT( slotEmitChangedTimer() ) );
     }
Index: kmail/sievedebugdialog.cpp
===================================================================
--- kmail/sievedebugdialog.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/sievedebugdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -198,6 +198,7 @@
         mAccountList.append( a );
 
     mEdit = new QTextEdit( this );
+    mEdit->setReadOnly(true);
     setMainWidget( mEdit );
 
     mEdit->setText( i18n( "Collecting diagnostic information about Sieve support...\n\n" ) );
Index: kmail/kmfolderimap.cpp
===================================================================
--- kmail/kmfolderimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfolderimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -106,21 +106,13 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderImap::close(const char *owner, bool aForced)
+void KMFolderImap::reallyDoClose(const char *owner)
 {
-  if (mOpenCount > 0) mOpenCount--;
-  if (mOpenCount == 0 && isSelected() && !aForced) {
+  if ( isSelected() ) {
       kdWarning(5006) << "Trying to close the selected folder " << label() <<
         " - ignoring! " << kdBacktrace() << endl;
-      mOpenCount++;
       return;
   }
-  if (mOpenCount > 0 && !aForced) {
-    // The inherited close will decrement again, so we have to adjust.
-    mOpenCount++;
-    KMFolderMbox::close(owner, aForced);
-    return;
-  }
 
   // FIXME is this still needed?
   if (account())
@@ -136,9 +128,7 @@
 
   mCheckingValidity = false;
 
-  // The inherited close will decrement again, so we have to adjust.
-  mOpenCount++;
-  KMFolderMbox::close(owner, aForced);
+  KMFolderMbox::reallyDoClose(owner);
 }
 
 KMFolder* KMFolderImap::trashFolder() const
@@ -549,8 +539,6 @@
     QPtrList<KMMessage> temp_msgs = splitMessageList(*it, msgList);
 
     ImapJob *job = new ImapJob(temp_msgs, *it, ImapJob::tCopyMessage, this);
-    connect(job, SIGNAL(messageCopied(QPtrList<KMMessage>)),
-            SLOT(addMsgQuiet(QPtrList<KMMessage>)));
     connect(job, SIGNAL(result(KMail::FolderJob*)),
             SLOT(slotCopyMsgResult(KMail::FolderJob*)));
     job->start();
@@ -1132,6 +1120,7 @@
       // we notice when this changes
       account()->handleJobError( job, i18n("Error while querying the server status.") );
     }
+    kdDebug() << "error in slotCheckValidityResult\n";
     mContentState = imapNoInformation;
     emit folderComplete(this, FALSE);
     close("checkvalidity");
@@ -1212,6 +1201,7 @@
   mGuessedUnreadMsgs = -1;
   if (mNoContent)
   {
+    kdDebug() << "getFolder " << force << " " << mContentState << endl;
     mContentState = imapFinished;
     emit folderComplete(this, true);
     return;
@@ -1260,6 +1250,7 @@
       mMailCheckProgressItem->setStatus( i18n("Retrieving messages") );
     url.setPath(imapPath() + ";UID=" + startUid
       + ":*;SECTION=ENVELOPE");
+    kdDebug() << folder()->name() << " download " << url << endl;
     KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     ImapAccountBase::jobData jd( url.url(), folder() );
@@ -1369,6 +1360,7 @@
     KURL url = account()->getUrl();
     url.setPath(imapPath() + ";UID=" + *i + ";SECTION=ENVELOPE");
     KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
+    kdDebug() << folder()->name() << " download " << url << endl;
     jd.url = url.url();
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     account()->insertJob(newJob, jd);
@@ -1908,11 +1900,13 @@
        account()->setImapStatus(folder(), imappath, flags);
      }
   }
+  kdDebug() << folder()->name() << " setStatus " << mContentState << endl;
   if ( mContentState == imapListingInProgress ) {
     // we're currently get'ing this folder
     // to make sure that we get the latest flags abort the current listing and
     // create a new one
     kdDebug(5006) << "Set status during folder listing, restarting listing." << endl;
+    kdDebug() << "disconnct slotListFolderResult\n";
     disconnect(this, SLOT(slotListFolderResult(KIO::Job *)));
     quiet( false );
     reallyGetFolder( QString::null );
@@ -2372,6 +2366,7 @@
 
 void KMFolderImap::finishMailCheck( const char *dbg, imapState state )
 {
+  kdDebug() << folder()->name() << " finishMailCheck " << dbg << " " << state << endl;
   quiet( false );
   mContentState = state;
   emit folderComplete( this, mContentState == imapFinished );
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -55,7 +55,8 @@
 //-----------------------------------------------------------------------------
 PopAccount::PopAccount(AccountManager* aOwner, const QString& aAccountName, uint id)
   : NetworkAccount(aOwner, aAccountName, id),
-    headerIt(headersOnServer)
+    headerIt(headersOnServer),
+    processMsgsTimer( 0, "processMsgsTimer" )
 {
   init();
   job = 0;
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -39,7 +39,6 @@
 #include <kprocess.h>
 #include <kconfig.h>
 
-#include <ctype.h>
 #include <stdio.h>
 #include <errno.h>
 #include <assert.h>
@@ -256,24 +255,8 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMbox::close(const char *owner, bool aForced)
+void KMFolderMbox::reallyDoClose(const char *owner)
 {
-  if (!aForced)
-     assert(mOpenCount >= 0);
-
-  if (mOpenCount <= 0 || !mStream) { mOpenCount = 0; return; }
-  if (mOpenCount > 0) mOpenCount--;
-  if (mOpenCount > 0 && !aForced) { assert(mStream); return; }
-
-#if 0 // removed hack that prevented closing system folders (see kmail-devel discussion about mail expiring)
-  if ( (folder() != kmkernel->inboxFolder())
-        && folder()->isSystemFolder() && !aForced )
-  {
-      mOpenCount = 1;
-      return;
-  }
-#endif
-
   if (mAutoCreateIndex)
   {
       if (KMFolderIndex::IndexOk != indexStatus()) {
Index: kmail/kmfolderimap.h
===================================================================
--- kmail/kmfolderimap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfolderimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -131,10 +131,8 @@
   /** Remove the IMAP folder on the server and if successful also locally */
   virtual void remove();
 
-  /** Close folder. If force is TRUE the files are closed even if
-    others still use it (e.g. other mail reader windows). This also
-    cancels all pending jobs. */
-  virtual void close(const char *owner, bool force=FALSE);
+  /** Closes and cancels all pending jobs. */
+  virtual void reallyDoClose(const char *owner);
 
   /** Automatically expunge deleted messages when leaving the folder */
   bool autoExpunge();
Index: kmail/KMail.desktop
===================================================================
--- kmail/KMail.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/KMail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -89,4 +89,4 @@
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=kmail
 ServiceTypes=DCOP/ResourceBackend/IMAP,DCOP/Mailer
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;Office;Email;
Index: kmail/compactionjob.cpp
===================================================================
--- kmail/compactionjob.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/compactionjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -51,7 +51,7 @@
 #define COMPACTIONJOB_TIMERINTERVAL 100
 
 MboxCompactionJob::MboxCompactionJob( KMFolder* folder, bool immediate )
- : ScheduledJob( folder, immediate ), mTimer( this ), mTmpFile( 0 ),
+ : ScheduledJob( folder, immediate ), mTimer( this, "mTimer" ), mTmpFile( 0 ),
    mCurrentIndex( 0 ), mFolderOpen( false ), mSilent( false )
 {
 }
@@ -194,7 +194,7 @@
 ////
 
 MaildirCompactionJob::MaildirCompactionJob( KMFolder* folder, bool immediate )
- : ScheduledJob( folder, immediate ), mTimer( this ),
+ : ScheduledJob( folder, immediate ), mTimer( this, "mTimer" ),
    mCurrentIndex( 0 ), mFolderOpen( false ), mSilent( false )
 {
 }
Index: kmail/kmfoldersearch.cpp
===================================================================
--- kmail/kmfoldersearch.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldersearch.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -80,7 +80,7 @@
     mFoundCount = 0;
     mSearchCount = 0;
 
-    mProcessNextBatchTimer = new QTimer();
+    mProcessNextBatchTimer = new QTimer(0, "mProcessNextBatchTimer");
     connect(mProcessNextBatchTimer, SIGNAL(timeout()), this, SLOT(slotProcessNextBatch()));
 }
 
@@ -367,7 +367,7 @@
     connect(kmkernel->dimapFolderMgr(), SIGNAL(msgHeaderChanged(KMFolder*,int)),
             this, SLOT(propagateHeaderChanged(KMFolder*,int)));
 
-  mExecuteSearchTimer = new QTimer();
+  mExecuteSearchTimer = new QTimer(0, "mExecuteSearchTimer");
   connect(mExecuteSearchTimer, SIGNAL(timeout()),
           this, SLOT(executeSearch()));
 }
@@ -539,12 +539,8 @@
     }
 }
 
-void KMFolderSearch::close(const char *, bool force)
+void KMFolderSearch::reallyDoClose(const char *)
 {
-    if (mOpenCount <= 0) return;
-    if (mOpenCount > 0) mOpenCount--;
-    if (mOpenCount > 0 && !force) return;
-
     if (mAutoCreateIndex) {
         if (mSearch)
             mSearch->write(location());
Index: kmail/kmacctimap.cpp
===================================================================
--- kmail/kmacctimap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmacctimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -57,7 +57,8 @@
 //-----------------------------------------------------------------------------
 KMAcctImap::KMAcctImap(AccountManager* aOwner, const QString& aAccountName, uint id):
   KMail::ImapAccountBase(aOwner, aAccountName, id),
-  mCountRemainChecks( 0 )
+  mCountRemainChecks( 0 ),
+  mErrorTimer( 0, "mErrorTimer" )
 {
   mFolder = 0;
   mScheduler = 0;
Index: kmail/kmfoldermaildir.h
===================================================================
--- kmail/kmfoldermaildir.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldermaildir.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -68,7 +68,7 @@
 
   /** Close folder. If force is TRUE the files are closed even if
     others still use it (e.g. other mail reader windows). */
-  virtual void close(const char *owner, bool force=FALSE);
+  virtual void reallyDoClose(const char *owner);
 
   /** Create the necessary folders for a maildir folder. Usually you will
       want to use create() instead.
Index: kmail/kmfoldertree.cpp
===================================================================
--- kmail/kmfoldertree.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -331,6 +331,8 @@
 KMFolderTree::KMFolderTree( KMMainWidget *mainWidget, QWidget *parent,
                             const char *name )
   : KFolderTree( parent, name )
+  , mUpdateTimer( 0, "mUpdateTimer" )
+  , autoopen_timer( 0, "autoopen_timer" )
 {
   oldSelected = 0;
   oldCurrent = 0;
@@ -339,7 +341,7 @@
   mReloading = false;
   mCutFolder = false;
 
-  mUpdateCountTimer= new QTimer( this );
+  mUpdateCountTimer= new QTimer( this, "mUpdateCountTimer" );
 
   setDragEnabled( true );
   addAcceptableDropMimetype(MailListDrag::format(), false);
@@ -1443,6 +1445,12 @@
 
     QListViewItem *item = itemAt( contentsToViewport(e->pos()) );
     KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>(item);
+    if (fti && mCopySourceFolders.count() == 1)
+    {
+      KMFolder *source = mCopySourceFolders.first();
+      // if we are dragging to ourselves or to our parent, set fti to 0 so nothing is done
+      if (source == fti->folder() || source->parent()->owner() == fti->folder()) fti = 0;
+    }
     if (fti && acceptDrag(e) && ( fti != oldSelected || e->source() != mMainWidget->headers()->viewport() ) )
     {
       int action = -1;
Index: kmail/kmfoldermbox.h
===================================================================
--- kmail/kmfoldermbox.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/kmfoldermbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -78,9 +78,8 @@
     fopen call otherwise (errno). */
   virtual int open(const char *owner);
 
-  /** Close folder. If force is TRUE the files are closed even if
-    others still use it (e.g. other mail reader windows). */
-  virtual void close(const char *owner, bool force=FALSE);
+  /** @reimpl */
+  virtual void reallyDoClose(const char *owner);
 
   virtual int canAccess();
 
Index: kmail/actionscheduler.cpp
===================================================================
--- kmail/actionscheduler.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kmail/actionscheduler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -81,19 +81,19 @@
   mAccount = false;
   lastCommand = 0;
   lastJob = 0;
-  finishTimer = new QTimer( this );
+  finishTimer = new QTimer( this, "finishTimer" );
   connect( finishTimer, SIGNAL(timeout()), this, SLOT(finish()));
-  fetchMessageTimer = new QTimer( this );
+  fetchMessageTimer = new QTimer( this, "fetchMessageTimer" );
   connect( fetchMessageTimer, SIGNAL(timeout()), this, SLOT(fetchMessage()));
-  tempCloseFoldersTimer = new QTimer( this );
+  tempCloseFoldersTimer = new QTimer( this, "tempCloseFoldersTimer" );
   connect( tempCloseFoldersTimer, SIGNAL(timeout()), this, SLOT(tempCloseFolders()));
-  processMessageTimer = new QTimer( this );
+  processMessageTimer = new QTimer( this, "processMessageTimer" );
   connect( processMessageTimer, SIGNAL(timeout()), this, SLOT(processMessage()));
-  filterMessageTimer = new QTimer( this );
+  filterMessageTimer = new QTimer( this, "filterMessageTimer" );
   connect( filterMessageTimer, SIGNAL(timeout()), this, SLOT(filterMessage()));
-  timeOutTimer = new QTimer( this );
+  timeOutTimer = new QTimer( this, "timeOutTimer" );
   connect( timeOutTimer, SIGNAL(timeout()), this, SLOT(timeOut()));
-  fetchTimeOutTimer = new QTimer( this );
+  fetchTimeOutTimer = new QTimer( this, "fetchTimeOutTimer" );
   connect( fetchTimeOutTimer, SIGNAL(timeout()), this, SLOT(fetchTimeOut()));
 
   QValueList<KMFilter*>::Iterator it = filters.begin();
Index: networkstatus/networkstatus.desktop
===================================================================
--- networkstatus/networkstatus.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ networkstatus/networkstatus.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -28,7 +28,7 @@
 Name[ms]=Daemon Berstatus Rangkaian
 Name[nb]=Statusnisse for nettverket
 Name[nds]=Nettwarkstatus-Dämoon
-Name[ne]=सञ्जाल स्थिति डेइमोन
+Name[ne]=सञ्जाल स्थिति डेइमन
 Name[nl]=Netwerkstatusdaemon
 Name[nn]=Statusnisse for nettverket
 Name[pl]=Usługa stanu sieci
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knode/KNode.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -82,4 +82,4 @@
 GenericName[zu]=Umfundi wezindaba
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Network;
+Categories=Qt;KDE;Network;News;
Index: kioslaves/imap4/imapparser.cc
===================================================================
--- kioslaves/imap4/imapparser.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kioslaves/imap4/imapparser.cc	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -59,6 +59,19 @@
 #include <kasciistricmp.h>
 #include <kasciistringtools.h>
 
+#ifdef HAVE_LIBSASL2
+static sasl_callback_t client_callbacks[] = {
+    { SASL_CB_ECHOPROMPT, NULL, NULL },
+    { SASL_CB_NOECHOPROMPT, NULL, NULL },
+    { SASL_CB_GETREALM, NULL, NULL },
+    { SASL_CB_USER, NULL, NULL },
+    { SASL_CB_AUTHNAME, NULL, NULL },
+    { SASL_CB_PASS, NULL, NULL },
+    { SASL_CB_CANON_USER, NULL, NULL },
+    { SASL_CB_LIST_END, NULL, NULL }
+};
+#endif
+
 imapParser::imapParser ()
 {
   sentQueue.setAutoDelete (false);
@@ -222,7 +235,7 @@
   result = sasl_client_new( "imap", /* FIXME: with cyrus-imapd, even imaps' digest-uri
                                        must be 'imap'. I don't know if it's good or bad. */
                        aFQDN.latin1(),
-                       0, 0, 0, 0, &conn );
+                       0, 0, client_callbacks, 0, &conn );
 
   if ( result != SASL_OK ) {
     kdDebug(7116) << "sasl_client_new failed with: " << result << endl;
@@ -1800,7 +1813,7 @@
     QString temp = (*it);
 
     int pt = temp.find ('/');
-    if (pt > 0) 
+    if (pt > 0)
     {
       if (temp.findRev ('"', pt) == -1 || temp.find('"', pt) == -1)
       {
@@ -1832,7 +1845,7 @@
     if (!_box.isEmpty () && _box[_box.length () - 1] == '/')
       _box.truncate(_box.length() - 1);
   }
-  kdDebug(7116) << "URL: box= " << _box << ", section= " << _section << ", type= " 
+  kdDebug(7116) << "URL: box= " << _box << ", section= " << _section << ", type= "
     << _type << ", uid= " << _uid << ", validity= " << _validity << ", info= " << _info << endl;
 }
 
Index: kioslaves/imap4/imapcommand.cc
===================================================================
--- kioslaves/imap4/imapcommand.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kioslaves/imap4/imapcommand.cc	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -396,7 +396,7 @@
 imapCommand *
 imapCommand::clientGetQuotaroot( const QString& box )
 {
-  QString parameter = rfcDecoder::toIMAP (box);
+  QString parameter = QString("\"") + rfcDecoder::toIMAP (box) + '"';
   return new imapCommand ("GETQUOTAROOT", parameter);
 }
 
Index: kioslaves/sieve/sieve.cpp
===================================================================
--- kioslaves/sieve/sieve.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kioslaves/sieve/sieve.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -14,7 +14,7 @@
  *                                                                         *
  ***************************************************************************/
 
-/** 
+/**
  * Portions adapted from the SMTP ioslave.
  * Copyright (c) 2000, 2001 Alex Zepeda <jazepeda@pacbell.net>
  * Copyright (c) 2001 Michael Hckel <Michael@Haeckel.Net>
@@ -60,7 +60,7 @@
 #endif
 
 #define SIEVE_DEFAULT_PORT 2000
-  
+
 static sasl_callback_t callbacks[] = {
     { SASL_CB_ECHOPROMPT, NULL, NULL },
     { SASL_CB_NOECHOPROMPT, NULL, NULL },
@@ -73,6 +73,17 @@
     { SASL_CB_LIST_END, NULL, NULL }
 };
 
+static sasl_callback_t client_callbacks[] = {
+    { SASL_CB_ECHOPROMPT, NULL, NULL },
+    { SASL_CB_NOECHOPROMPT, NULL, NULL },
+    { SASL_CB_GETREALM, NULL, NULL },
+    { SASL_CB_USER, NULL, NULL },
+    { SASL_CB_AUTHNAME, NULL, NULL },
+    { SASL_CB_PASS, NULL, NULL },
+    { SASL_CB_CANON_USER, NULL, NULL },
+    { SASL_CB_LIST_END, NULL, NULL }
+};
+
 static const unsigned int SIEVE_DEFAULT_RECIEVE_BUFFER = 512;
 
 using namespace KIO;
@@ -81,7 +92,7 @@
 	KDE_EXPORT int kdemain(int argc, char **argv)
 	{
 		KInstance instance("kio_sieve" );
-		
+
 		ksDebug() << "*** Starting kio_sieve " << endl;
 
 		if (argc != 4) {
@@ -230,17 +241,17 @@
 bool kio_sieveProtocol::parseCapabilities(bool requestCapabilities/* = false*/)
 {
 	ksDebug() << k_funcinfo << endl;
-	
+
 	// Setup...
 	bool ret = false;
-	
+
 	if (requestCapabilities) {
 		sendData("CAPABILITY");
 	}
 
 	while (receiveData()) {
 		ksDebug() << "Looping receive" << endl;
-		
+
 		if (r.getType() == kio_sieveResponse::ACTION) {
 			if ( r.getAction().contains("ok", false) != -1 ) {
 				ksDebug() << "Sieve server ready & awaiting authentication." << endl;
@@ -271,12 +282,12 @@
 			ksDebug() << "Server supports TLS" << endl;
 			m_supportsTLS = true;
 			setMetaData("tlsSupported", "true");
-			
+
 		} else {
 			ksDebug() << "Unrecognised key " << r.getKey() << endl;
 		}
 	}
-	
+
 	if (!m_supportsTLS) {
 		setMetaData("tlsSupported", "false");
 	}
@@ -301,7 +312,7 @@
 		if ( query.startsWith("?") ) query.remove( 0, 1 );
 		QStringList q = QStringList::split( ",", query );
 		QStringList::iterator it;
-  
+
 		for ( it = q.begin(); it != q.end(); ++it ) {
 			if ( ( (*it).section('=',0,0) ).lower() == "x-mech" ) {
 				auth = ( (*it).section('=',1) ).upper();
@@ -325,7 +336,7 @@
 bool kio_sieveProtocol::connect(bool useTLSIfAvailable)
 {
 	ksDebug() << k_funcinfo << endl;
-	
+
 	if (isConnectionValid()) return true;
 
 	infoMessage(i18n("Connecting to %1...").arg( m_sServer));
@@ -334,7 +345,7 @@
 		error(ERR_CONNECTION_BROKEN, i18n("The connection to the server was lost."));
 		return false;
 	}
-	
+
 	setBlockConnection(true);
 
 	if (!connectToHost(m_sServer, m_iPort, true)) {
@@ -406,7 +417,7 @@
 /*void kio_sieveProtocol::slave_status()
 {
 	slaveStatus(isConnectionValid() ? m_sServer : "", isConnectionValid());
-	
+
 	finished();
 }*/
 
@@ -600,7 +611,7 @@
 
 	if (operationSuccessful())
 		ksDebug() << "Script upload complete." << endl;
-	
+
 	else {
 		/* The managesieve server parses received scripts and rejects
 		 * scripts which are not syntactically correct. Here we expect
@@ -766,7 +777,7 @@
 	}
 
 	infoMessage(i18n("Done."));
-	
+
 	finished();
 }
 
@@ -783,7 +794,7 @@
     error(ERR_CANNOT_CHMOD, i18n("Cannot chmod to anything but 0700 (active) or 0600 (inactive script)."));
     return;
   }
-  
+
   finished();
 }
 
@@ -823,7 +834,7 @@
 
 		while(receiveData()) {
 			if (r.getType() == kio_sieveResponse::ACTION) {
-				if (r.getAction().contains("OK", false) == 1) 
+				if (r.getAction().contains("OK", false) == 1)
 					// Script list completed
 					break;
 
@@ -924,7 +935,7 @@
   //some mechanisms do not require username && pass, so it doesn't need a popup
   //window for getting this info
   for ( ; interact->id != SASL_CB_LIST_END; interact++ ) {
-    if ( interact->id == SASL_CB_AUTHNAME || 
+    if ( interact->id == SASL_CB_AUTHNAME ||
          interact->id == SASL_CB_PASS ) {
 
 	    if (m_sUser.isEmpty() || m_sPass.isEmpty()) {
@@ -938,7 +949,7 @@
       break;
     }
   }
-  
+
   interact = ( sasl_interact_t * ) in;
   while( interact->id != SASL_CB_LIST_END ) {
     ksDebug() << "SASL_INTERACT id: " << interact->id << endl;
@@ -993,7 +1004,7 @@
 
   result = sasl_client_new( "sieve",
                        m_sServer.latin1(),
-                       0, 0, NULL, 0, &conn );
+                       0, 0, client_callbacks, 0, &conn );
 
   if ( result != SASL_OK ) {
     ksDebug() << "sasl_client_new failed with: " << result << endl;
@@ -1013,7 +1024,7 @@
     result = sasl_client_start(conn, strList.join(" ").latin1(), &client_interact,
                        &out, &outlen, &mechusing);
 
-    if (result == SASL_INTERACT) 
+    if (result == SASL_INTERACT)
       if ( !saslInteract( client_interact, ai ) ) {
         sasl_dispose( &conn );
         return false;
@@ -1042,15 +1053,15 @@
   ksDebug() << "firstCommand: " << firstCommand << endl;
 	if (!sendData( firstCommand.latin1() ))
 		return false;
-	
+
 	QCString command;
-	
+
 	do {
 		receiveData();
-		
+
 		if (operationResult() != OTHER)
 			break;
-		
+
 		ksDebug() << "Challenge len  " << r.getQuantity() << endl;
 
 		if (r.getType() != kio_sieveResponse::QUANTITY) {
@@ -1085,7 +1096,7 @@
                                   &client_interact,
                                   &out, &outlen);
 
-      if (result == SASL_INTERACT) 
+      if (result == SASL_INTERACT)
         if ( !saslInteract( client_interact, ai ) ) {
           sasl_dispose( &conn );
           return false;
@@ -1099,7 +1110,7 @@
       sasl_dispose( &conn );
       return false;
     }
-   
+
     tmp.setRawData( out, outlen );
     KCodecs::base64Encode( tmp, challenge );
     tmp.resetRawData( out, outlen );
@@ -1110,7 +1121,7 @@
 
 	ksDebug() << "Challenges finished." << endl;
   sasl_dispose( &conn );
-    
+
 	if (operationResult() == OK) {
 		// Authentication succeeded.
 		return true;
@@ -1264,6 +1275,6 @@
 			return BYE;
 		}
 	}
-	
+
 	return OTHER;
 }
Index: libkdenetwork/gpgmepp/importresult.cpp
===================================================================
--- libkdenetwork/gpgmepp/importresult.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkdenetwork/gpgmepp/importresult.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -28,6 +28,7 @@
 
 #include <gpgme.h>
 #include <cstdlib>
+#include <cstring>
 
 class GpgME::ImportResult::Private : public GpgME::Shared {
 public:
Index: libkdenetwork/gpgmepp/callbacks.cpp
===================================================================
--- libkdenetwork/gpgmepp/callbacks.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkdenetwork/gpgmepp/callbacks.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -32,6 +32,7 @@
 #include <cerrno>
 #include <unistd.h>
 #include <stdlib.h>
+#include <string.h>
 
 static inline gpg_error_t makeErrorFromErrno() {
   return gpg_err_make_from_errno( (gpg_err_source_t)22, errno );
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.cpp  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -1211,7 +1211,7 @@
 		if (!mTemplate)
 			dt = mAlarmDateTime.dateTime();
 		else if (mTemplateUseTime->isOn())
-			dt.setTime(mTemplateTime->time());
+			dt = QDateTime(QDate(2000,1,1), mTemplateTime->time());
 	}
 	KAEvent::Action type = getAlarmType();
 	event.set(dt, text, mBgColourChoose->color(), mFontColourButton->fgColour(), mFontColourButton->font(),
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.12"
+#define KALARM_VERSION "1.4.14"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1071,8 +1071,7 @@
 */
 void MainWindow::slotPreferences()
 {
-	KAlarmPrefDlg prefDlg;
-	prefDlg.exec();
+	KAlarmPrefDlg::display();
 }
 
 /******************************************************************************
Index: kalarm/sounddlg.h
===================================================================
--- kalarm/sounddlg.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/sounddlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -27,6 +27,8 @@
 
 class QHBox;
 class QPushButton;
+class KArtsDispatcher;
+namespace KDE { class PlayObject; }
 class LineEdit;
 class PushButton;
 class CheckBox;
@@ -40,6 +42,7 @@
 	public:
 		SoundDlg(const QString& file, float volume, float fadeVolume, int fadeSeconds, bool repeat,
 		         const QString& caption, QWidget* parent, const char* name = 0);
+		~SoundDlg();
 		void           setReadOnly(bool);
 		bool           isReadOnly() const    { return mReadOnly; }
 		QString        getFile() const       { return mFileName; }
@@ -63,8 +66,10 @@
 		void           slotVolumeToggled(bool on);
 		void           slotFadeToggled(bool on);
 		void           playSound();
+		void           checkAudioPlay();
 
 	private:
+		void           stopPlay();
 		bool           checkFile();
 
 		QPushButton*   mFilePlay;
@@ -81,6 +86,13 @@
 		QString        mDefaultDir;     // current default directory for mFileEdit
 		QString        mFileName;
 		bool           mReadOnly;
+		// Sound file playing
+		KArtsDispatcher* mArtsDispatcher;
+		KDE::PlayObject* mPlayObject;
+		QTimer*          mPlayTimer;       // timer for playing the sound file
+		QString          mLocalAudioFile;  // local copy of audio file
+		QTime            mAudioFileStart;  // time when audio file loading started, or when play started
+		bool             mPlayStarted;      // the sound file has started playing
 };
 
 #endif
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -55,7 +55,7 @@
 {
 		Q_OBJECT
 	public:
-		KAlarmPrefDlg();
+		static void display();
 		~KAlarmPrefDlg();
 
 		FontColourPrefTab* mFontColourPage;
@@ -72,7 +72,10 @@
 		virtual void slotCancel();
 
 	private:
+		KAlarmPrefDlg();
 		void            restore();
+
+		static KAlarmPrefDlg* mInstance;
 		bool            mValid;
 };
 
Index: kalarm/kalarmd/kalarmd.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/kalarmd/kalarmd.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,7 +30,7 @@
 Name[ms]=Daemon KAlarm 
 Name[nb]=KAlarm-nisse
 Name[nds]=KAlarm-Dämoon
-Name[ne]=केडीई संसूचक डेइमोन
+Name[ne]=केडीई संसूचक डेइमन
 Name[nn]=KAlarm-nisse
 Name[pl]=Demon alarmowy
 Name[pt]=Servidor do KAlarm
Index: kalarm/kalarmd/kalarmd.autostart.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.autostart.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/kalarmd/kalarmd.autostart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,7 +30,7 @@
 Name[ms]=Daemon KAlarm 
 Name[nb]=KAlarm-nisse
 Name[nds]=KAlarm-Dämoon
-Name[ne]=केडीई संसूचक डेइमोन
+Name[ne]=केडीई संसूचक डेइमन
 Name[nn]=KAlarm-nisse
 Name[pl]=Demon alarmowy
 Name[pt]=Servidor do KAlarm
@@ -77,7 +77,7 @@
 Comment[ms]= Automula daemon penggera KAlarm semasa log masuk
 Comment[nb]=start alarmnisse ved innlogging
 Comment[nds]=KAlarm-Dämoon bi't Anmellen automaatsch starten
-Comment[ne]=लगइनमा केडीई संसूचक संसूचक डेइमोन स्वत: सुरुआत हुन्छ
+Comment[ne]=लगइनमा केडीई संसूचक संसूचक डेइमन स्वत: सुरुआत हुन्छ
 Comment[nl]=KAlarm alarmdaemon automatisch starten bij login
 Comment[nn]=Start alarmnisse ved innlogging
 Comment[pl]=Demon alarmu KOrganizera uruchamiany przy zalogowaniu
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,12 +1,20 @@
 KAlarm
 
-=== Version 1.4.12 --- 11 May 2007 ===
+=== Version 1.4.14 --- 9 June 2007 ===
+In sound file dialogue change Play button to a Stop button while playing a file.
+
+=== Version 1.4.13 --- 18 May 2007 ===
+Fix time value in templates not being stored.
+Expand time spin boxes to make room for all digits.
+Make Preferences dialogue non-modal.
+
+=== Version 1.4.12 (KDE 3.5.7) --- 11 May 2007 ===
 Display advance reminders for each occurrence of recurring alarms.
 Fix Undo of deletion of active alarms.
 Disable simple repetition controls if repetitions can't fit between recurrences.
 Make the system tray tooltip take account of alarm repetitions.
 Show repetition & special action status by button states in alarm edit dialogue.
-Fix reminder alarms displaying very large numbers for time until alarm is due.
+Fix reminder alarms displaying very big numbers for how long until alarm is due.
 Fix KMail omitting attachments from email alarms (if KMail is the email client).
 
 === Version 1.4.11 --- 16 April 2007 ===
Index: kalarm/kalarmapp.cpp
===================================================================
--- kalarm/kalarmapp.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/kalarmapp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1683,11 +1683,7 @@
 				kdDebug(5950) << "KAlarmApp::execAlarm(): COMMAND: (script)" << endl;
 				QString tmpfile = createTempScriptFile(command, false, event, alarm);
 				if (tmpfile.isEmpty())
-				{
-					QStringList errmsgs(i18n("Error creating temporary script file"));
-					(new MessageWin(event, alarm.dateTime(), errmsgs))->show();
 					result = 0;
-				}
 				else
 					result = doShellCommand(tmpfile, event, &alarm, (flags | ProcData::TEMP_FILE));
 			}
Index: kalarm/sounddlg.cpp
===================================================================
--- kalarm/sounddlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/sounddlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -34,7 +34,15 @@
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kiconloader.h>
+#ifdef WITHOUT_ARTS
 #include <kaudioplayer.h>
+#else
+#include <qtimer.h>
+#include <arts/kartsdispatcher.h>
+#include <arts/kartsserver.h>
+#include <arts/kplayobjectfactory.h>
+#include <arts/kplayobject.h>
+#endif
 #include <kmessagebox.h>
 #include <kio/netaccess.h>
 #include <kdebug.h>
@@ -42,6 +50,7 @@
 #include "checkbox.h"
 #include "functions.h"
 #include "lineedit.h"
+#include "mainwindow.h"
 #include "pushbutton.h"
 #include "slider.h"
 #include "soundpicker.h"
@@ -62,7 +71,10 @@
 SoundDlg::SoundDlg(const QString& file, float volume, float fadeVolume, int fadeSeconds, bool repeat,
                    const QString& caption, QWidget* parent, const char* name)
 	: KDialogBase(parent, name, true, caption, Ok|Cancel, Ok, false),
-	  mReadOnly(false)
+	  mReadOnly(false),
+	  mArtsDispatcher(0),
+	  mPlayObject(0),
+	  mPlayTimer(0)
 {
 	QWidget* page = new QWidget(this);
 	setMainWidget(page);
@@ -179,6 +191,11 @@
 	slotVolumeToggled(volume >= 0);
 }
 
+SoundDlg::~SoundDlg()
+{
+	stopPlay();
+}
+
 /******************************************************************************
 * Set the read-only status of the dialogue.
 */
@@ -261,31 +278,125 @@
 }
 
 /******************************************************************************
-* Called when the file play button is clicked.
+* Called when the file play/stop button is clicked.
 */
 void SoundDlg::playSound()
 {
+#ifdef WITHOUT_ARTS
 	if (checkFile())
 		KAudioPlayer::play(QFile::encodeName(mFileName));
+#else
+	if (mPlayObject)
+	{
+		stopPlay();
+		return;
+	}
+	if (!checkFile())
+		return;
+	KURL url(mFileName);
+	MainWindow* mmw = MainWindow::mainMainWindow();
+	if (!url.isValid()  ||  !KIO::NetAccess::exists(url, true, mmw)
+	||  !KIO::NetAccess::download(url, mLocalAudioFile, mmw))
+	{
+		kdError(5950) << "SoundDlg::playAudio(): Open failure: " << mFileName << endl;
+		KMessageBox::error(this, i18n("Cannot open audio file:\n%1").arg(mFileName));
+		return;
+	}
+	mPlayTimer = new QTimer(this);
+	connect(mPlayTimer, SIGNAL(timeout()), SLOT(checkAudioPlay()));
+	mArtsDispatcher = new KArtsDispatcher;
+	mPlayStarted = false;
+	mAudioFileStart = QTime::currentTime();
+	KArtsServer aserver;
+	Arts::SoundServerV2 sserver = aserver.server();
+	KDE::PlayObjectFactory factory(sserver);
+	mPlayObject = factory.createPlayObject(mLocalAudioFile, true);
+	mFilePlay->setPixmap(SmallIcon("player_stop"));
+	QToolTip::add(mFilePlay, i18n("Stop sound"));
+	QWhatsThis::add(mFilePlay, i18n("Stop playing the sound"));
+	connect(mPlayObject, SIGNAL(playObjectCreated()), SLOT(checkAudioPlay()));
+	if (!mPlayObject->object().isNull())
+		checkAudioPlay();
+#endif
 }
 
 /******************************************************************************
+*  Called when the audio file has loaded and is ready to play, or on a timer
+*  when play is expected to have completed.
+*  If it is ready to play, start playing it (for the first time or repeated).
+*  If play has not yet completed, wait a bit longer.
+*/
+void SoundDlg::checkAudioPlay()
+{
+#ifndef WITHOUT_ARTS
+	if (!mPlayObject)
+		return;
+	if (mPlayObject->state() == Arts::posIdle)
+	{
+		// The file has loaded and is ready to play, or play has completed
+		if (mPlayStarted)
+		{
+			// Play has completed
+			stopPlay();
+			return;
+		}
+
+		// Start playing the file
+		kdDebug(5950) << "SoundDlg::checkAudioPlay(): start\n";
+		mPlayStarted = true;
+		mPlayObject->play();
+	}
+
+	// The sound file is still playing
+	Arts::poTime overall = mPlayObject->overallTime();
+	Arts::poTime current = mPlayObject->currentTime();
+	int time = 1000*(overall.seconds - current.seconds) + overall.ms - current.ms;
+	if (time < 0)
+		time = 0;
+	kdDebug(5950) << "SoundDlg::checkAudioPlay(): wait for " << (time+100) << "ms\n";
+	mPlayTimer->start(time + 100, true);
+#endif
+}
+
+/******************************************************************************
+*  Called when play completes, the Silence button is clicked, or the window is
+*  closed, to terminate audio access.
+*/
+void SoundDlg::stopPlay()
+{
+#ifndef WITHOUT_ARTS
+	delete mPlayObject;      mPlayObject = 0;
+	delete mArtsDispatcher;  mArtsDispatcher = 0;
+	delete mPlayTimer;       mPlayTimer = 0;
+	if (!mLocalAudioFile.isEmpty())
+	{
+		KIO::NetAccess::removeTempFile(mLocalAudioFile);   // removes it only if it IS a temporary file
+		mLocalAudioFile = QString::null;
+	}
+	mFilePlay->setPixmap(SmallIcon("player_play"));
+	QToolTip::add(mFilePlay, i18n("Test the sound"));
+	QWhatsThis::add(mFilePlay, i18n("Play the selected sound file."));
+#endif
+}
+
+/******************************************************************************
 * Check whether the specified sound file exists.
 * Note that KAudioPlayer::play() can only cope with local files.
 */
 bool SoundDlg::checkFile()
 {
-	QString file = mFileEdit->text();
+	mFileName = mFileEdit->text();
 	KURL url;
-	if (KURL::isRelativeURL(file))
+	if (KURL::isRelativeURL(mFileName))
 	{
 		// It's not an absolute URL, so check for an absolute path
-		QFileInfo f(file);
+		QFileInfo f(mFileName);
 		if (!f.isRelative())
-			url.setPath(file);
+			url.setPath(mFileName);
 	}
 	else
-		url = KURL::fromPathOrURL(file);   // it's an absolute URL
+		url = KURL::fromPathOrURL(mFileName);   // it's an absolute URL
+#ifdef WITHOUT_ARTS
 	if (!url.isEmpty())
 	{
 		// It's an absolute path or URL.
@@ -297,6 +408,9 @@
 		}
 	}
 	else
+#else
+	if (url.isEmpty())
+#endif
 	{
 		// It's a relative path.
 		// Find the first sound resource that contains files.
@@ -311,7 +425,7 @@
 				if (dir.isReadable() && dir.count() > 2)
 				{
 					url.setPath(*it);
-					url.addPath(file);
+					url.addPath(mFileName);
 					if (KIO::NetAccess::exists(url, true, this))
 					{
 						mFileName = url.path();
@@ -321,16 +435,20 @@
 			}
 		}
 		url.setPath(QDir::homeDirPath());
-		url.addPath(file);
+		url.addPath(mFileName);
 		if (KIO::NetAccess::exists(url, true, this))
 		{
 			mFileName = url.path();
 			return true;
 		}
 	}
+#ifdef WITHOUT_ARTS
 	KMessageBox::sorry(this, i18n("File not found"));
 	mFileName = QString::null;
 	return false;
+#else
+	return true;
+#endif
 }
 
 /******************************************************************************
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.cpp  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -43,6 +43,9 @@
 #include <kiconloader.h>
 #include <kcolorcombo.h>
 #include <kstdguiitem.h>
+#ifdef Q_WS_X11
+#include <kwin.h>
+#endif
 #include <kdebug.h>
 
 #include <kalarmd/kalarmd.h>
@@ -92,9 +95,31 @@
 = Class KAlarmPrefDlg
 =============================================================================*/
 
+KAlarmPrefDlg* KAlarmPrefDlg::mInstance = 0;
+
+void KAlarmPrefDlg::display()
+{
+	if (!mInstance)
+	{
+		mInstance = new KAlarmPrefDlg;
+		mInstance->show();
+	}
+	else
+	{
+#ifdef Q_WS_X11
+		KWin::WindowInfo info = KWin::windowInfo(mInstance->winId(), NET::WMGeometry | NET::WMDesktop);
+		KWin::setCurrentDesktop(info.desktop());
+#endif
+		mInstance->showNormal();   // un-minimise it if necessary
+		mInstance->raise();
+		mInstance->setActiveWindow();
+	}
+}
+
 KAlarmPrefDlg::KAlarmPrefDlg()
-	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", true, true)
+	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", false, true)
 {
+	setWFlags(Qt::WDestructiveClose);
 	setIconListAllVisible(true);
 
 	QVBox* frame = addVBoxPage(i18n("General"), i18n("General"), DesktopIcon("misc"));
@@ -118,6 +143,7 @@
 
 KAlarmPrefDlg::~KAlarmPrefDlg()
 {
+	mInstance = 0;
 }
 
 // Restore all defaults in the options...
Index: kalarm/lib/timespinbox.cpp
===================================================================
--- kalarm/lib/timespinbox.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/lib/timespinbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.cpp  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2004,2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -268,6 +268,20 @@
 	mPm = mValidator->mPm = (value >= 720);
 }
 
+QSize TimeSpinBox::sizeHint() const
+{
+	QSize sz = SpinBox2::sizeHint();
+	QFontMetrics fm(font());
+	return QSize(sz.width() + fm.width(":"), sz.height());
+}
+
+QSize TimeSpinBox::minimumSizeHint() const
+{
+	QSize sz = SpinBox2::minimumSizeHint();
+	QFontMetrics fm(font());
+	return QSize(sz.width() + fm.width(":"), sz.height());
+}
+
 /******************************************************************************
  * Validate the time spin box input.
  * The entered time must either be 4 digits, or it must contain a colon, but
Index: kalarm/lib/timespinbox.h
===================================================================
--- kalarm/lib/timespinbox.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/lib/timespinbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.h  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -52,7 +52,7 @@
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
-		TimeSpinBox(bool use24hour, QWidget* parent = 0, const char* name = 0);
+		explicit TimeSpinBox(bool use24hour, QWidget* parent = 0, const char* name = 0);
 		/** Constructor for a non-wrapping time spin box which can be used to enter a length of time.
 		 *  @param minMinute The minimum value which the spin box can hold, in minutes.
 		 *  @param maxMinute  The maximum value which the spin box can hold, in minutes.
@@ -86,6 +86,9 @@
 		 */
 		static QString  shiftWhatsThis();
 
+		virtual QSize   sizeHint() const;
+		virtual QSize   minimumSizeHint() const;
+
 	public slots:
 		/** Sets the value of the spin box.
 		 *  @param minutes The new value of the spin box, expressed in minutes.
Index: kalarm/kalarm.desktop
===================================================================
--- kalarm/kalarm.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/kalarm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -72,4 +72,4 @@
 Terminal=false
 X-DCOP-ServiceType=Unique
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;Office;Calendar;
Index: kalarm/traywindow.cpp
===================================================================
--- kalarm/traywindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kalarm/traywindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -145,8 +145,7 @@
 */
 void TrayWindow::slotPreferences()
 {
-	KAlarmPrefDlg prefDlg;
-	prefDlg.exec();
+	KAlarmPrefDlg::display();
 }
 
 /******************************************************************************
Index: korn/KOrn.desktop
===================================================================
--- korn/KOrn.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/KOrn.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -74,4 +74,4 @@
 Name[ta]=கார்ன்
 Name[zh_TW]=Korn 信件通知
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Network;X-KDE-More;
+Categories=Qt;KDE;Network;X-KDE-More;Office;Email;
Index: korn/mailsubject.cpp
===================================================================
--- korn/mailsubject.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/mailsubject.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,8 +1,13 @@
 #include"mailsubject.h"
 
-#include<kdebug.h>
+#include <kmime_codecs.h>
+#include <kcharsets.h>
+#include <kdebug.h>
+#include <kglobal.h>
 #include <klocale.h>
 #include <qdatetime.h>
+#include <qtextcodec.h>
+#include <ctype.h>
 
 KornMailSubject::KornMailSubject() : _id(0), _drop(0), _size(-1), _date(-1), _fullMessage(false)
 {
@@ -51,3 +56,134 @@
 		+ ", " + i18n("Sender:") + " " + _sender + ", " + i18n("Size:") + " " + QString::number(_size)
 		+ ", " + i18n("Date:") + " " + date.toString(Qt::ISODate);
 }
+
+QString KornMailSubject::decodeRFC2047String(const QCString& aStr)
+{
+	if ( aStr.isEmpty() )
+		return QString::null;
+
+	const QCString str = unfold( aStr );
+
+	if ( str.isEmpty() )
+		return QString::null;
+
+	if ( str.find( "=?" ) < 0 ) {
+		// No need to decode
+		return QString(str);
+	}
+
+	QString result;
+	QCString LWSP_buffer;
+	bool lastWasEncodedWord = false;
+
+	for ( const char * pos = str.data() ; *pos ; ++pos ) {
+		// collect LWSP after encoded-words,
+		// because we might need to throw it out
+		// (when the next word is an encoded-word)
+		if ( lastWasEncodedWord && isBlank( pos[0] ) ) {
+			LWSP_buffer += pos[0];
+			continue;
+		}
+		// verbatimly copy normal text
+		if (pos[0]!='=' || pos[1]!='?') {
+			result += LWSP_buffer + pos[0];
+			LWSP_buffer = 0;
+			lastWasEncodedWord = false;
+			continue;
+		}
+		// found possible encoded-word
+		const char * const beg = pos;
+		{
+			// parse charset name
+			QCString charset;
+			int i = 2;
+			pos += 2;
+			for ( ; *pos != '?' && ( *pos==' ' || ispunct(*pos) || isalnum(*pos) ); ++i, ++pos ) {
+				charset += *pos;
+			}
+			if ( *pos!='?' || i<4 )
+				goto invalid_encoded_word;
+
+			// get encoding and check delimiting question marks
+			const char encoding[2] = { pos[1], '\0' };
+			if (pos[2]!='?' || (encoding[0]!='Q' && encoding[0]!='q' &&
+			    encoding[0]!='B' && encoding[0]!='b'))
+				goto invalid_encoded_word;
+			pos+=3; i+=3; // skip ?x?
+			const char * enc_start = pos;
+			// search for end of encoded part
+			while ( *pos && !(*pos=='?' && *(pos+1)=='=') ) {
+				i++;
+				pos++;
+			}
+			if ( !*pos )
+				goto invalid_encoded_word;
+
+			// valid encoding: decode and throw away separating LWSP
+			const KMime::Codec * c = KMime::Codec::codecForName( encoding );
+			kdFatal( !c ) << "No \"" << encoding << "\" codec!?" << endl;
+
+			QByteArray in; in.setRawData( enc_start, pos - enc_start );
+			const QByteArray enc = c->decode( in );
+			in.resetRawData( enc_start, pos - enc_start );
+
+			const QTextCodec * codec = codecForName(charset);
+			if (!codec) return QString::null;
+			result += codec->toUnicode(enc);
+			lastWasEncodedWord = true;
+
+			++pos; // eat '?' (for loop eats '=')
+			LWSP_buffer = 0;
+		}
+		continue;
+invalid_encoded_word:
+		// invalid encoding, keep separating LWSP.
+		pos = beg;
+		if ( !LWSP_buffer.isNull() )
+		result += LWSP_buffer;
+		result += "=?";
+		lastWasEncodedWord = false;
+		++pos; // eat '?' (for loop eats '=')
+		LWSP_buffer = 0;
+	}
+	return result;
+}
+
+QCString KornMailSubject::unfold( const QCString & header )
+{
+	if ( header.isEmpty() )
+		return QCString();
+
+	QCString result( header.size() ); // size() >= length()+1 and size() is O(1)
+	char * d = result.data();
+
+	for ( const char * s = header.data() ; *s ; )
+		if ( *s == '\r' ) { // ignore
+			++s;
+			continue;
+		} else if ( *s == '\n' ) { // unfold
+			while ( this->isBlank( *++s ) );
+			*d++ = ' ';
+		} else
+			*d++ = *s++;
+
+	*d++ = '\0';
+
+	result.truncate( d - result.data() );
+	return result;
+}
+
+//-----------------------------------------------------------------------------
+const QTextCodec* KornMailSubject::codecForName(const QCString& _str)
+{
+	if (_str.isEmpty()) return 0;
+		QCString codec = _str;
+	return KGlobal::charsets()->codecForName(codec);
+}
+
+void KornMailSubject::decodeHeaders()
+{
+	_subject = decodeRFC2047String( _subject.latin1() );
+	_sender = decodeRFC2047String( _sender.latin1() );
+}
+
Index: korn/password.cpp
===================================================================
--- korn/password.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/password.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -46,10 +46,10 @@
 	open();
 
 	if( !m_wallet || !m_wallet->isOpen() || m_openFailed )
-		return fallbackConfig.readEntry( "pass" );
+		return KMailDecrypt( fallbackConfig.readEntry( "pass" ) );
 
 	if( !m_wallet->hasFolder( "kmail" ) )
-		return fallbackConfig.readEntry( "pass" );
+		return KMailDecrypt( fallbackConfig.readEntry( "pass" ));
 	m_wallet->setFolder( "kmail" );
 
 	if( m_wallet->readPassword( QString( "account-%1" ).arg( accountnr ), password ) != 0 )
@@ -241,7 +241,7 @@
 {
 	QString result;
 	for (uint i = 0; i < enc.length(); i++)
-		result += (enc[i].unicode() < 0x20) ? enc[i] : QChar(0x1001F - enc[i].unicode());
+		result += (enc[i].unicode() <= 0x21) ? enc[i] : QChar(0x1001F - enc[i].unicode());
 
 	return result;
 }
Index: korn/kmail_proto.cpp
===================================================================
--- korn/kmail_proto.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/kmail_proto.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -59,7 +59,9 @@
 
 	if( type == "imap" )
 		return Protocols::getProto( "imap" );
-	if( type == "pop3" )
+        if( type == "cachedimap" )
+                return Protocols::getProto( "imap" );
+	if( type == "pop" )
 		return Protocols::getProto( "pop3" );
 	if( type == "local" )
 		return Protocols::getProto( "mbox" );
@@ -77,7 +79,7 @@
 	KConfig kmailconfig( "kmailrc", true, false );
 	QString type = getTypeAndConfig( config->readEntry( "kmailname" ), kmailconfig, id );
 
-	if( type == "imap" || type == "cachedimap" || type == "pop3" || type == "local" || type == "maildir" )
+	if( type == "imap" || type == "cachedimap" || type == "pop" || type == "local" || type == "maildir" )
 		return new KKioDrop();
 	
 	kdWarning() << "KMail configuration not found" << endl;
@@ -118,7 +120,7 @@
 		result->insert( "password", readPassword( kmailconfig.readBoolEntry( "store-passwd", false ), kmailconfig, id ) );
 		result->insert( "savepassword", kmailconfig.readEntry( "store-passwd", "false" ) );
 	}
-	if( type == "pop3" )
+	if( type == "pop" )
 	{
 		//Constructing metadata
 		if( kmailconfig.hasKey( "auth" ) )
@@ -188,7 +190,7 @@
 		kmailconfig.setGroup( QString( kmailGroupName ).arg( nummer ) );
 		type = kmailconfig.readEntry( kmailKeyType, QString::null );
 		name = kmailconfig.readEntry( kmailKeyName, QString::null );
-		if( type == "imap" || type == "cachedimap" || type == "pop3" || type == "local" )
+		if( type == "imap" || type == "cachedimap" || type == "pop" || type == "local" )
 		{
 			accountList.insert( name, name );
 		}
Index: korn/mailsubject.h
===================================================================
--- korn/mailsubject.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/mailsubject.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,6 +1,8 @@
 #ifndef MailSubject_h
 #define MailSubject_h
 
+class QTextCodec;
+
 class KMailDrop;
 
 #include "mailid.h"
@@ -147,6 +149,39 @@
 	 * Returns the KMailDrop instance of the Maildrop which owns the subject
 	 */
 	KMailDrop* getMailDrop() const { return _drop; }
+
+        /**
+         * decodes headers using decodeRFC2047String
+         */
+        void decodeHeaders();
+
+private:
+
+        /**
+         * Decode a string based on RFC2047
+         */
+        QString decodeRFC2047String(const QCString& aStr);
+
+        /**
+         * Unfolding a string (basically changing tabs to spaces
+         */
+        QCString unfold( const QCString & header );
+
+        /**
+         * Returns true if the parameter is a blank (or tab)
+         *
+         * Note from KMail's code, where this function is taken from:
+         * don't rely on isblank(), which is a GNU extension in
+         * <cctype>. But if someone wants to write a configure test for
+         * isblank(), we can then rename this function to isblank and #ifdef
+         * it's definition...
+         */
+        inline bool isBlank( char ch ) { return ch == ' ' || ch == '\t' ; }
+
+        /**
+         * ??
+         */
+        const QTextCodec* codecForName(const QCString& _str);
 };
 
 #endif
Index: korn/kio_single_subject.cpp
===================================================================
--- korn/kio_single_subject.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/kio_single_subject.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -142,6 +142,7 @@
 	} else {
 		KornMailSubject * mailSubject = new KornMailSubject( new KornStringId( *_name ), 0 );
 		parseMail( _message, mailSubject, _protocol->fullMessage() );
+		mailSubject->decodeHeaders();
 		mailSubject->setSize( _size );
 		emit readSubject( mailSubject );
 	}
Index: korn/Makefile.am
===================================================================
--- korn/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korn/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1,13 +1,14 @@
 KDE_CXXFLAGS = $(USE_RTTI)
 
-INCLUDES = $(all_includes)
+INCLUDES = -I$(top_srcdir)/libkmime \
+  	$(all_includes)
 #INCLUDES = -I$(top_srcdir)/mimelib -I$(top_srcdir)/libkmime $(all_includes)
 AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
 METASOURCES = AUTO
 
 bin_PROGRAMS = korn
-korn_LDADD = $(LIB_KIO)
+korn_LDADD = $(LIB_KIO) $(top_builddir)/libkmime/libkmime.la
 #korn_LDADD = $(top_builddir)/mimelib/libmimelib.la $(LIB_KFILE) $(LIBSOCKET) $(top_builddir)/libkmime/libkmime.la
 
 korn_SOURCES = \
Index: kaddressbook/kaddressbook.desktop
===================================================================
--- kaddressbook/kaddressbook.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/kaddressbook.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -74,7 +74,7 @@
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=kaddressbook
-MimeType=text/x-vcard;text/x-ldif
+MimeType=text/x-vcard;text/x-ldif;
 ServiceTypes=KParts/ReadOnlyPart,Browser/View,DCOP/AddressBook
 X-KDE-Library=libkaddressbookpart
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;ContactManagement;
Index: kaddressbook/editors/protocols/ircprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/ircprotocol.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/editors/protocols/ircprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -13,7 +13,7 @@
 Comment[kk]=Internet Relay Chat хабарласу
 Comment[km]=ជជែក​កំសាន្ត​តាមអ៊ីនធឺណិត
 Comment[lt]=Estafetinis Interneto pokalbis
-Comment[ne]=इन्टरनेटबाट प्रसारण च्याट
+Comment[ne]=इन्टरनेटबाट प्रसारण कुराकानी
 Comment[pl]=IRC (Internet Relay Chat)
 Comment[pt_BR]=Protocolo de Bate-papo na Internet - IRC
 Comment[ru]=IRC
Index: kaddressbook/editors/kaddressbookimprotocol.desktop
===================================================================
--- kaddressbook/editors/kaddressbookimprotocol.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/editors/kaddressbookimprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,7 +30,7 @@
 Name[ms]=Protokol Penghantaran Mesej Segera KAddressbook 
 Name[nb]=KAdressbook lynmeldingsprotokoll
 Name[nds]=KAddressbook-Kortnarichten-Protokoll
-Name[ne]=के ठेगाना पुस्तिका दृष्टान्त संदेशन प्रोटोकल
+Name[ne]=केडीई ठेगानापुस्तिका दृष्टान्त संदेशन प्रोटोकल
 Name[nl]=KAddressbook Instant Messaging-protocol
 Name[nn]=Lynmeldingsprotokoll for KDE-adresseboka
 Name[pl]=Protokół komunikacji internetowej KAddressbook
Index: kaddressbook/thumbnailcreator/ldifvcardcreator.cpp
===================================================================
--- kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -154,6 +154,8 @@
     mSplitter = new KPixmapSplitter;
     QString pixmap = locate( "data", "konqueror/pics/thumbnailfont_7x4.png" );
     if ( pixmap.isEmpty() ) {
+      delete mSplitter;
+      mSplitter=0;
       kdWarning() << "VCard_LDIFCreator: Font image \"thumbnailfont_7x4.png\" not found!\n";
       return false;
     }
Index: kaddressbook/features/distributionlistwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistwidget.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/features/distributionlistwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -446,8 +446,11 @@
   if ( !contactItem )
     return;
 
+  bool canceled = false;
   const QString email = EmailSelector::getEmail( contactItem->addressee().emails(),
-                                                 contactItem->email(), this );
+                                                 contactItem->email(), this, canceled);
+  if( canceled)
+     return;
   dist.removeEntry( contactItem->addressee(), contactItem->email() );
   dist.insertEntry( contactItem->addressee(), email );
 
@@ -620,7 +623,7 @@
 
 EmailSelector::EmailSelector( const QStringList &emails,
                               const QString &current, QWidget *parent )
-  : KDialogBase( KDialogBase::Plain, i18n("Select Email Address"), Ok, Ok,
+  : KDialogBase( KDialogBase::Plain, i18n("Select Email Address"), Ok|Cancel, Ok,
                parent )
 {
   QFrame *topFrame = plainPage();
@@ -654,12 +657,16 @@
 }
 
 QString EmailSelector::getEmail( const QStringList &emails,
-                                 const QString &current, QWidget *parent )
+                                 const QString &current, QWidget *parent, bool &canceled )
 {
   EmailSelector dlg( emails, current, parent );
-  dlg.exec();
-
-  return dlg.selected();
+  if(dlg.exec())
+  {
+    canceled = false;
+    return dlg.selected();
+  }
+  canceled = true;
+  return QString();
 }
 
 
Index: kaddressbook/features/distributionlistwidget.h
===================================================================
--- kaddressbook/features/distributionlistwidget.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kaddressbook/features/distributionlistwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -130,7 +130,7 @@
     QString selected() const;
 
     static QString getEmail( const QStringList &emails, const QString &current,
-                             QWidget *parent );
+                             QWidget *parent, bool &canceled );
 
   private:
     QButtonGroup *mButtonGroup;
Index: kitchensync/src/configguijescs.cpp
===================================================================
--- kitchensync/src/configguijescs.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguijescs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,77 @@
+#include "configguijescs.h"
+
+#include <qcheckbox.h>
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiJescs::ConfigGuiJescs( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiJescs::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "url" ) {
+      mUrl->setText( element.text() );
+    } else if ( element.tagName() == "username" ) {
+      mUsername->setText( element.text() );
+    } else if ( element.tagName() == "password" ) {
+      mPassword->setText( element.text() );
+    } else if ( element.tagName() == "del_notify" ) {
+      mDelNotify->setChecked( element.text() == "1" );
+    }
+  }
+}
+
+QString ConfigGuiJescs::save() const
+{
+  int delNotifyState;
+  QString config = "<config>\n";
+
+  config += QString( "<url>%1</url>\n" ).arg( mUrl->text() );
+  config += QString( "<username>%1</username>\n" ).arg( mUsername->text() );
+  config += QString( "<password>%1</password>\n" ).arg( mPassword->text() );
+  if ( mDelNotify->isChecked() ) { delNotifyState = 1;
+  }  else { delNotifyState = 0;
+  }
+  config += QString( "<del_notify>%1</del_notify>\n" ).arg( delNotifyState );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiJescs::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "URL:" ), this ), 0, 0 );
+  mUrl = new KLineEdit( this );
+  layout->addMultiCellWidget( mUrl, 0, 0, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Username:" ), this ), 1, 0 );
+  mUsername = new KLineEdit( this );
+  layout->addMultiCellWidget( mUsername, 1, 1, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Password:" ), this ), 2, 0 );
+  mPassword = new KLineEdit( this );
+  mPassword->setEchoMode( KLineEdit::Password );
+  layout->addMultiCellWidget( mPassword, 2, 2, 1, 2 );
+
+  mDelNotify = new QCheckBox( this );
+  mDelNotify->setText( "Notify attendees about event/task deletion" );
+  layout->addMultiCellWidget( mDelNotify, 3, 3, 0, 2 );
+}
Index: kitchensync/src/configgui.cpp
===================================================================
--- kitchensync/src/configgui.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configgui.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -33,6 +33,10 @@
 #include "configguisyncmlhttp.h"
 #include "configguisyncmlobex.h"
 #include "configguigcalendar.h"
+#include "configguijescs.h"
+#include "configguievo2.h"
+#include "configguimoto.h"
+#include "configguisynce.h"
 
 #include "memberinfo.h"
 
@@ -96,6 +100,14 @@
     return new ConfigGuiLdap( member, parent );
   } else if ( name == "kdepim-sync" ) {
     return new ConfigGuiBlank( member, parent ); 
+  } else if ( name == "jescs-sync" ) {
+    return new ConfigGuiJescs( member, parent );
+  } else if ( name == "evo2-sync" ) {
+    return new ConfigGuiEvo2( member, parent );
+  } else if ( name == "moto-sync" ) {
+    return new ConfigGuiMoto( member, parent );
+  } else if ( name == "synce-plugin" ) {
+    return new ConfigGuiSynce( member, parent );
   } else {
     return new ConfigGuiXml( member, parent );
   }
@@ -114,7 +126,7 @@
   mTextEdit->setText( xml );
 }
 
-QString ConfigGuiXml::save()
+QString ConfigGuiXml::save() const
 {
   return mTextEdit->text();
 }
Index: kitchensync/src/configguignokii.h
===================================================================
--- kitchensync/src/configguignokii.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguignokii.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -39,7 +39,7 @@
     ConfigGuiGnokii( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QComboBox *mConnection;
Index: kitchensync/src/configguiblank.h
===================================================================
--- kitchensync/src/configguiblank.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiblank.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -29,7 +29,7 @@
     ConfigGuiBlank( const QSync::Member &member, QWidget *parent = 0 );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 };
 
 #endif
Index: kitchensync/src/configguipalm.h
===================================================================
--- kitchensync/src/configguipalm.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguipalm.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -36,7 +36,7 @@
     ConfigGuiPalm( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     void initGUI();
Index: kitchensync/src/configguiirmc.h
===================================================================
--- kitchensync/src/configguiirmc.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiirmc.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -42,7 +42,7 @@
     ConfigGuiIRMC( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   protected slots:
     void connectionTypeChanged( int type );
Index: kitchensync/src/configguisyncmlhttp.cpp
===================================================================
--- kitchensync/src/configguisyncmlhttp.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguisyncmlhttp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -186,7 +186,7 @@
   }
 }
 
-QString ConfigGuiSyncmlHttp::save()
+QString ConfigGuiSyncmlHttp::save() const
 {
   QString xml;
   xml = "<config>\n";
Index: kitchensync/src/configguigpe.cpp
===================================================================
--- kitchensync/src/configguigpe.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguigpe.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -64,7 +64,7 @@
   }
 }
 
-QString ConfigGuiGpe::save()
+QString ConfigGuiGpe::save() const
 {
   QString config = "<config>";
 
Index: kitchensync/src/configguijescs.h
===================================================================
--- kitchensync/src/configguijescs.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguijescs.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,30 @@
+#ifndef CONFIGGUIJESCS_H
+#define CONFIGGUIJESCS_H
+
+#include "configgui.h"
+
+class KLineEdit;
+class QCheckBox;
+
+class ConfigGuiJescs : public ConfigGui
+{
+  public:
+    ConfigGuiJescs( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KLineEdit *mUrl;
+
+    KLineEdit *mUsername;
+
+    KLineEdit *mPassword;
+
+    QCheckBox *mDelNotify;
+};
+
+#endif
Index: kitchensync/src/configguifile.cpp
===================================================================
--- kitchensync/src/configguifile.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguifile.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -66,7 +66,7 @@
   }
 }
 
-QString ConfigGuiFile::save()
+QString ConfigGuiFile::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/configguignokii.cpp
===================================================================
--- kitchensync/src/configguignokii.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguignokii.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -188,7 +188,7 @@
   }
 }
 
-QString ConfigGuiGnokii::save()
+QString ConfigGuiGnokii::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/configgui.h
===================================================================
--- kitchensync/src/configgui.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configgui.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -44,7 +44,7 @@
     QString instanceName() const;
 
     virtual void load( const QString &xml ) = 0;
-    virtual QString save() = 0;
+    virtual QString save() const = 0;
 
     QSync::Member member() const { return mMember; }
 
@@ -63,7 +63,7 @@
     ConfigGuiXml( const QSync::Member &, QWidget *parent );
 
     void load( const QString & );
-    QString save();
+    QString save() const;
 
   private:
     QTextEdit *mTextEdit;
Index: kitchensync/src/configguigcalendar.h
===================================================================
--- kitchensync/src/configguigcalendar.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguigcalendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -32,7 +32,7 @@
     ConfigGuiGoogleCalendar( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QLineEdit *mUsername;
Index: kitchensync/src/configguildap.h
===================================================================
--- kitchensync/src/configguildap.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguildap.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -39,7 +39,7 @@
     ConfigGuiLdap( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private slots:
     void bindModeChanged( bool );
Index: kitchensync/src/configguiirmc.cpp
===================================================================
--- kitchensync/src/configguiirmc.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiirmc.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -91,7 +91,7 @@
   mCableWidget->load( docElement );
 }
 
-QString ConfigGuiIRMC::save()
+QString ConfigGuiIRMC::save() const
 {
   QDomDocument doc;
   QDomElement config = doc.createElement( "config" );
Index: kitchensync/src/configguisyncmlhttp.h
===================================================================
--- kitchensync/src/configguisyncmlhttp.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguisyncmlhttp.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -41,7 +41,7 @@
     ConfigGuiSyncmlHttp( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QGridLayout *mGridLayout;
Index: kitchensync/src/configguievo2.cpp
===================================================================
--- kitchensync/src/configguievo2.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguievo2.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,70 @@
+#include "configguievo2.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qstring.h>
+
+#include <kurlrequester.h>
+#include <kurl.h>
+#include <kfile.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiEvo2::ConfigGuiEvo2( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiEvo2::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "address_path" ) {
+      mAddressPath->setURL( element.text() );
+    } else if ( element.tagName() == "calendar_path" ) {
+      mCalendarPath->setURL( element.text() ) ;
+    } else if ( element.tagName() == "tasks_path" ) {
+      mTasksPath->setURL( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiEvo2::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<address_path>%1</address_path>\n" ).arg( mAddressPath->url() );
+  config += QString( "<calendar_path>%1</calendar_path>\n" ).arg( mCalendarPath->url() );
+  config += QString( "<tasks_path>%1</tasks_path>\n" ).arg( mTasksPath->url() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiEvo2::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "Address Book location:" ), this ), 0, 0 );
+  mAddressPath = new KURLRequester( this );
+  mAddressPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mAddressPath, 0, 0, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Calendar location:" ), this ), 1, 0 );
+  mCalendarPath = new KURLRequester( this );
+  mCalendarPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mCalendarPath, 1, 1, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Task list location:" ), this ), 2, 0 );
+  mTasksPath = new KURLRequester( this );
+  mTasksPath->setMode( KFile::Directory );
+  layout->addMultiCellWidget( mTasksPath, 2, 2, 1, 2 );
+}
Index: kitchensync/src/configguigcalendar.cpp
===================================================================
--- kitchensync/src/configguigcalendar.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguigcalendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -80,7 +80,7 @@
   }
 }
 
-QString ConfigGuiGoogleCalendar::save()
+QString ConfigGuiGoogleCalendar::save() const
 {
   QDomDocument doc;
   QDomElement root = doc.createElement("config");
Index: kitchensync/src/configguigpe.h
===================================================================
--- kitchensync/src/configguigpe.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguigpe.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -35,7 +35,7 @@
     ConfigGuiGpe( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     void initGUI();
Index: kitchensync/src/configguildap.cpp
===================================================================
--- kitchensync/src/configguildap.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguildap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -100,7 +100,7 @@
   }
 }
 
-QString ConfigGuiLdap::save()
+QString ConfigGuiLdap::save() const
 {
   QString config = "<config>";
 
Index: kitchensync/src/configguisynce.cpp
===================================================================
--- kitchensync/src/configguisynce.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisynce.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,71 @@
+#include "configguisynce.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiSynce::ConfigGuiSynce( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiSynce::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "contact" ) {
+      mContacts->setText( element.text() );
+    } else if ( element.tagName() == "todos" ) {
+      mTodos->setText( element.text() );
+    } else if ( element.tagName() == "calendar" ) {
+      mCalendar->setText( element.text() );
+    } else if ( element.tagName() == "file" ) {
+      mFile->setText( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiSynce::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<contact>%1</contact>\n" ).arg( mContacts->text() );
+  config += QString( "<todos>%1</todos>\n" ).arg( mTodos->text() );
+  config += QString( "<calendar>%1</calendar>\n" ).arg( mCalendar->text() );
+  config += QString( "<file>%1</file>\n" ).arg( mFile->text() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiSynce::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 4, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "Contacts:" ), this ), 0, 0 );
+  mContacts = new KLineEdit( this );
+  layout->addMultiCellWidget( mContacts, 0, 0, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Todo List:" ), this ), 1, 0 );
+  mTodos = new KLineEdit( this );
+  layout->addMultiCellWidget( mTodos, 1, 1, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "Calendar:" ), this ), 2, 0 );
+  mCalendar = new KLineEdit( this );
+  layout->addMultiCellWidget( mCalendar, 2, 2, 1, 2 );
+
+  layout->addWidget( new QLabel( i18n( "File:" ), this ), 3, 0 );
+  mFile = new KLineEdit( this );
+  layout->addMultiCellWidget( mFile, 3, 3, 1, 2 );
+}
Index: kitchensync/src/configguisyncmlobex.cpp
===================================================================
--- kitchensync/src/configguisyncmlobex.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguisyncmlobex.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -237,7 +237,7 @@
   }
 }
 
-QString ConfigGuiSyncmlObex::save()
+QString ConfigGuiSyncmlObex::save() const
 {
   QString xml;
   xml = "<config>\n";
Index: kitchensync/src/configguimoto.h
===================================================================
--- kitchensync/src/configguimoto.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguimoto.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,23 @@
+#ifndef CONFIGGUIMOTO_H
+#define CONFIGGUIMOTO_H
+
+#include "configgui.h"
+
+class KLineEdit;
+
+class ConfigGuiMoto : public ConfigGui
+{
+  public:
+    ConfigGuiMoto( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KLineEdit *mDeviceString;
+};
+
+#endif
Index: kitchensync/src/configguifile.h
===================================================================
--- kitchensync/src/configguifile.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguifile.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -32,7 +32,7 @@
     ConfigGuiFile( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     KURLRequester *mFilename;
Index: kitchensync/src/memberinfo.cpp
===================================================================
--- kitchensync/src/memberinfo.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/memberinfo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -64,7 +64,8 @@
     nameMap.insert( "google-calendar", i18n( "Google Calendar" ) );
     nameMap.insert( "gpe-sync", i18n( "Handheld" ) );
     nameMap.insert( "sunbird-sync", i18n( "Sunbird Calendar" ) );
-
+    nameMap.insert( "jescs-sync", i18n( "Java Enterprise System Calendar" ) );
+    nameMap.insert( "synce-plugin", i18n( "WinCE Devices" ) );
   }
 
   if ( mMember.name().isEmpty() )
@@ -82,6 +83,7 @@
   if ( pluginName == "irmc-sync" ) return "mobile_phone";
   if ( pluginName == "evo2-sync" ) return "evolution";
   if ( pluginName == "opie-sync" ) return "pda_blue";
+  if ( pluginName == "synce-plugin" ) return "pda_blue";
   if ( pluginName == "ldap-sync" ) return "contents2";
   if ( pluginName == "syncml-obex-client" ) return "mobile_phone";
   if ( pluginName == "syncml-http-server" ) return "pda_blue";
@@ -90,6 +92,7 @@
   if ( pluginName == "google-calendar" ) return "www";
   if ( pluginName == "gpe-sync" ) return "pda_blue";
   if ( pluginName == "sunbird-sync" ) return "www";
+  if ( pluginName == "jescs-sync" ) return "www";
 
 
   return QString::null;
Index: kitchensync/src/configguiopie.h
===================================================================
--- kitchensync/src/configguiopie.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiopie.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -33,7 +33,7 @@
     ConfigGuiOpie( const QSync::Member &, QWidget *parent );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   private:
     QLineEdit *mDeviceIP;
Index: kitchensync/src/configguimoto.cpp
===================================================================
--- kitchensync/src/configguimoto.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguimoto.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,50 @@
+#include "configguimoto.h"
+
+#include <qdom.h>
+#include <qlabel.h>
+#include <qlayout.h>
+
+#include <klineedit.h>
+#include <kdialog.h>
+#include <klocale.h>
+
+ConfigGuiMoto::ConfigGuiMoto( const QSync::Member &member, QWidget *parent )
+  : ConfigGui( member, parent )
+{
+  initGUI();
+}
+
+void ConfigGuiMoto::load( const QString &xml )
+{
+  QDomDocument doc;
+  doc.setContent( xml );
+  QDomElement docElement = doc.documentElement();
+  QDomNode node;
+  for( node = docElement.firstChild(); !node.isNull(); node = node.nextSibling() ) {
+    QDomElement element = node.toElement();
+    if ( element.tagName() == "device" ) {
+      mDeviceString->setText( element.text() );
+    }
+  }
+}
+
+QString ConfigGuiMoto::save() const
+{
+  QString config = "<config>\n";
+
+  config += QString( "<device>%1</device>\n" ).arg( mDeviceString->text() );
+
+  config += "</config>";
+
+  return config;
+}
+
+void ConfigGuiMoto::initGUI()
+{
+  QGridLayout *layout = new QGridLayout( topLayout(), 12, 3, KDialog::spacingHint() );
+  layout->setMargin( KDialog::marginHint() );
+
+  layout->addWidget( new QLabel( i18n( "Device String:" ), this ), 0, 0 );
+  mDeviceString = new KLineEdit( this );
+  layout->addMultiCellWidget( mDeviceString, 0, 0, 1, 2 );
+}
Index: kitchensync/src/configguievo2.h
===================================================================
--- kitchensync/src/configguievo2.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguievo2.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,27 @@
+#ifndef CONFIGGUIEVO2_H
+#define CONFIGGUIEVO2_H
+
+#include "configgui.h"
+
+class KURLRequester;
+
+class ConfigGuiEvo2 : public ConfigGui
+{
+  public:
+    ConfigGuiEvo2( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KURLRequester *mAddressPath;
+
+    KURLRequester *mCalendarPath;
+
+    KURLRequester *mTasksPath;
+};
+
+#endif
Index: kitchensync/src/configguisynce.h
===================================================================
--- kitchensync/src/configguisynce.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 0)
+++ kitchensync/src/configguisynce.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -0,0 +1,29 @@
+#ifndef CONFIGGUISYNCE_H
+#define CONFIGGUISYNCE_H
+
+#include "configgui.h"
+
+class KLineEdit;
+
+class ConfigGuiSynce : public ConfigGui
+{
+  public:
+    ConfigGuiSynce( const QSync::Member &, QWidget *parent );
+
+    void load( const QString &xml );
+
+    QString save() const;
+
+  private:
+    void initGUI();
+
+    KLineEdit *mContacts;
+
+    KLineEdit *mTodos;
+
+    KLineEdit *mCalendar;
+
+    KLineEdit *mFile;
+};
+
+#endif
Index: kitchensync/src/configguiblank.cpp
===================================================================
--- kitchensync/src/configguiblank.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiblank.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -37,7 +37,7 @@
 {
 }
 
-QString ConfigGuiBlank::save()
+QString ConfigGuiBlank::save() const
 {
   QString xml = "<config></config>";
   return xml;
Index: kitchensync/src/configguisyncmlobex.h
===================================================================
--- kitchensync/src/configguisyncmlobex.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguisyncmlobex.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -43,7 +43,7 @@
     ConfigGuiSyncmlObex( const QSync::Member &, QWidget *parent = 0 );
 
     void load( const QString &xml );
-    QString save();
+    QString save() const;
 
   public slots:
      void slotConnectionChanged( int pos );
Index: kitchensync/src/configguipalm.cpp
===================================================================
--- kitchensync/src/configguipalm.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguipalm.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -88,7 +88,7 @@
   }
 }
 
-QString ConfigGuiPalm::save()
+QString ConfigGuiPalm::save() const
 {
   QString config = "<config>";
 
Index: kitchensync/src/configguiopie.cpp
===================================================================
--- kitchensync/src/configguiopie.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/configguiopie.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -119,7 +119,7 @@
   }
 }
 
-QString ConfigGuiOpie::save()
+QString ConfigGuiOpie::save() const
 {
   QString xml;
   xml = "<config>";
Index: kitchensync/src/Makefile.am
===================================================================
--- kitchensync/src/Makefile.am	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kitchensync/src/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -28,7 +28,8 @@
                             htmldiffalgodisplay.cpp genericdiffalgo.cpp multiconflictdialog.cpp \
                             configguiirmc.cpp \
                             configguisyncmlobex.cpp configguisyncmlhttp.cpp configguiopie.cpp  \
-                            configguignokii.cpp configguigcalendar.cpp configguildap.cpp configguigpe.cpp
+                            configguignokii.cpp configguigcalendar.cpp configguildap.cpp configguigpe.cpp \
+			    configguijescs.cpp configguievo2.cpp configguimoto.cpp configguisynce.cpp
 libkitchensync_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -no-undefined
 libkitchensync_la_LIBADD = $(LIB_KIO) $(LIB_KHTML) $(top_builddir)/kitchensync/libqopensync/libqopensync.la \
                            $(LIB_KABC) $(top_builddir)/libkdepim/libkdepim.la $(top_builddir)/libkcal/libkcal.la
Index: libkdepim/recentaddresses.cpp
===================================================================
--- libkdepim/recentaddresses.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkdepim/recentaddresses.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -28,6 +28,7 @@
  *  your version.
  */
 #include "recentaddresses.h"
+#include "libemailfunctions/email.h"
 
 #include <kstaticdeleter.h>
 #include <kconfig.h>
@@ -98,24 +99,33 @@
 
 void RecentAddresses::add( const QString& entry )
 {
-    if ( !entry.isEmpty() && m_maxCount > 0 ) {
-        QString email;
-        QString fullName;
-        KABC::Addressee addr;
+  if ( !entry.isEmpty() && m_maxCount > 0 ) {
+    QStringList list = KPIM::splitEmailAddrList( entry );
+    for( QStringList::const_iterator e_it = list.begin(); e_it != list.end(); ++e_it ) {
+      KPIM::EmailParseResult errorCode = KPIM::isValidEmailAddress( *e_it );
+      if ( errorCode != KPIM::AddressOk ) 
+        continue;
+      QString email;
+      QString fullName;
+      KABC::Addressee addr;
 
-        KABC::Addressee::parseEmailAddress( entry, fullName, email );
+      KABC::Addressee::parseEmailAddress( *e_it, fullName, email );
 
-        for ( KABC::Addressee::List::Iterator it = m_addresseeList.begin();
-              it != m_addresseeList.end(); ++it )
-        {
-            if ( email == (*it).preferredEmail() )
-                return;//already inside
+      for ( KABC::Addressee::List::Iterator it = m_addresseeList.begin();
+          it != m_addresseeList.end(); ++it )
+      {
+        if ( email == (*it).preferredEmail() ) {
+          //already inside, remove it here and add it later at pos==1
+          m_addresseeList.remove( it );
+          break;
         }
-        addr.setNameFromString( fullName );
-        addr.insertEmail( email, true );
-        m_addresseeList.prepend( addr );
-        adjustSize();
+      }
+      addr.setNameFromString( fullName );
+      addr.insertEmail( email, true );
+      m_addresseeList.prepend( addr );
+      adjustSize();
     }
+  }
 }
 
 void RecentAddresses::setMaxCount( int count )
Index: libkcal/kcal_manager.desktop
===================================================================
--- libkcal/kcal_manager.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkcal/kcal_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -51,6 +51,7 @@
 Name[sv]=Kalender
 Name[ta]=நாள்காட்டி
 Name[tg]=Тақвим
+Name[th]=บันทึกประจำวัน
 Name[tr]=Takvim
 Name[uk]=Календар
 Name[uz]=Календар
Index: libkcal/vcalformat.cpp
===================================================================
--- libkcal/vcalformat.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkcal/vcalformat.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -182,7 +182,10 @@
   // TODO: Use all data.
   Event::List events = calendar->events();
   Event *event = events.first();
-  if ( !event ) return QString::null;
+  if ( !event ) {
+    cleanVObject( vcal );
+    return QString::null;
+  }
 
   VObject *vevent = eventToVEvent( event );
 

Zmiany atrybutów dla: libkcal/libical/zoneinfo
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -161,7 +161,7 @@
 QDateTime Todo::dtStart( bool first ) const
 {
   if ( doesRecur() && !first )
-    return mDtRecurrence.addDays( dtDue( true ).daysTo( IncidenceBase::dtStart() ) );
+    return mDtRecurrence.addDays( dtDue( first ).daysTo( IncidenceBase::dtStart() ) );
   else
     return IncidenceBase::dtStart();
 }
Index: libkcal/resourcecached.cpp
===================================================================
--- libkcal/resourcecached.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ libkcal/resourcecached.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -44,9 +44,10 @@
 
 ResourceCached::ResourceCached( const KConfig* config )
   : ResourceCalendar( config ), mCalendar( QString::fromLatin1( "UTC" ) ),
-    mReloadPolicy( ReloadNever ),  mReloadInterval( 10 ), mReloaded( false ),
+    mReloadPolicy( ReloadNever ),  mReloadInterval( 10 ), 
+    mReloadTimer( 0, "mReloadTimer" ), mReloaded( false ),
     mSavePolicy( SaveNever ), mSaveInterval( 10 ),
-    mIdMapper( "kcal/uidmaps/" )
+    mSaveTimer( 0, "mSaveTimer" ), mIdMapper( "kcal/uidmaps/" )
 {
   connect( &mReloadTimer, SIGNAL( timeout() ), SLOT( slotReload() ) );
   connect( &mSaveTimer, SIGNAL( timeout() ), SLOT( slotSave() ) );
Index: kpilot/conduits/timeconduit/time_conduit.desktop
===================================================================
--- kpilot/conduits/timeconduit/time_conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/timeconduit/time_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -30,7 +30,7 @@
 Comment[ms]=Saluran ini mengeset waktu pada komputer telapak anda dari jam PC.
 Comment[nb]=Denne kanalen stiller klokka på PDA-en fra PC-klokka.
 Comment[nds]=Synkroniseert stellt Handreekner-Klock na de PC-Klock.
-Comment[ne]=यो कन्ड्युटले पीसी घडिबाट ह्यान्डहेल्डमा समय सेट गर्दछ ।
+Comment[ne]=यो कन्ड्युटले पीसी घडीबाट ह्यान्डहेल्डमा समय सेट गर्दछ ।
 Comment[nl]=Dit conduit stelt de tijd van uw handheld in aan de hand van de pc-klok.
 Comment[nn]=Denne koplinga set tida på den handheldte eininga di frå PC-klokka.
 Comment[pl]=Ten łącznik ustawia zegar na palmtopie zgodnie z zegarem komputera.
Index: kpilot/conduits/docconduit/kpalmdoc.desktop
===================================================================
--- kpilot/conduits/docconduit/kpalmdoc.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/docconduit/kpalmdoc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -61,4 +61,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-File;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-File;Office;PDA;
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -93,6 +93,7 @@
 Name[sv]=Brev
 Name[ta]=அஞ்சல்
 Name[tg]=Мактуб
+Name[th]=จดหมาย
 Name[tr]=Posta
 Name[uk]=Пошта
 Name[uz]=Хат-хабар
Index: kpilot/conduits/recordconduit/record-conduit.desktop
===================================================================
--- kpilot/conduits/recordconduit/record-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/recordconduit/record-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -65,7 +65,7 @@
 Comment[ms]=Saluran ini tidak berbuat apa-apa.
 Comment[nb]=Denne kanalen gjør ingenting.
 Comment[nds]=Disse Kanaal deit gor nix.
-Comment[ne]=यो कन्ड्युटले केहि पनि गर्दैन ।
+Comment[ne]=यो कन्ड्युटले केही पनि गर्दैन ।
 Comment[nl]=Dit conduit doet niets.
 Comment[nn]=Denne koplinga gjer ingenting.
 Comment[pl]=Ten łącznik nic nie robi.
Index: kpilot/conduits/null/null-conduit.desktop
===================================================================
--- kpilot/conduits/null/null-conduit.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/null/null-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -39,7 +39,7 @@
 Comment[ms]=Saluran ini tidak berbuat apa-apa.
 Comment[nb]=Denne kanalen gjør ingenting.
 Comment[nds]=Disse Kanaal deit gor nix.
-Comment[ne]=यो कन्ड्युटले केहि पनि गर्दैन ।
+Comment[ne]=यो कन्ड्युटले केही पनि गर्दैन ।
 Comment[nl]=Dit conduit doet niets.
 Comment[nn]=Denne koplinga gjer ingenting.
 Comment[pl]=Ten łącznik nic nie robi.
Index: kpilot/conduits/vcalconduit/vcal-conduitbase.cc
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/conduits/vcalconduit/vcal-conduitbase.cc	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -605,18 +605,18 @@
 {
 	KPILOT_DELETE( fState );
 	fState = s;
-};
+}
 
 /* virtual */ void VCalConduitBase::postSync( )
 {
 	FUNCTIONSETUP;
 	if (fCtrPC && fP)
 		fCtrPC->setEndCount(fP->count());
-};
+}
 
 /* virtual */ void VCalConduitBase::preSync( )
 {
 	FUNCTIONSETUP;
 	if (fCtrPC && fP)
 		fCtrPC->setStartCount(fP->count());
-};
+}
Index: kpilot/kpilot/kpilot.desktop
===================================================================
--- kpilot/kpilot/kpilot.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/kpilot/kpilot.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -84,4 +84,4 @@
 Terminal=false
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;Office;PDA;
Index: kpilot/kpilot/kpilotdaemon.desktop
===================================================================
--- kpilot/kpilot/kpilotdaemon.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/kpilot/kpilotdaemon.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -20,7 +20,7 @@
 Name[lv]=KPilotDēmons
 Name[ms]=Daemon KPilot
 Name[nds]=KPilot-Dämoon
-Name[ne]=केडीई पाइलट डेइमोन
+Name[ne]=केडीई पाइलट डेइमन
 Name[nso]=Daemon ya KPilot
 Name[pl]=demon KPilota
 Name[pt_BR]=Servidor do KPilot
@@ -40,4 +40,4 @@
 Type=Application
 Terminal=false
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;
+Categories=Qt;KDE;Utility;Office;PDA;
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/lib/options.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -140,7 +140,7 @@
 #define FUNCTIONSETUPL(a) const int fname = a; Q_UNUSED(fname);
 #endif
 
-#define KPILOT_VERSION	"4.9.1 (rabid dolphin)"
+#define KPILOT_VERSION	"4.9.2-pre1 (moribund alleycat)"
 
 
 // Function to expand newlines in rich text to <br>\n
Index: kpilot/lib/plugin.h
===================================================================
--- kpilot/lib/plugin.h	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kpilot/lib/plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -407,7 +407,7 @@
 	*/
 	unsigned long pluginVersion(const KLibrary *);
 	QString pluginVersionString(const KLibrary *);
-} ;
+}
 
 /**
 * All KPilot conduits should subclass KLibFactory like this.
Index: knotes/local.desktop
===================================================================
--- knotes/local.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knotes/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -33,7 +33,7 @@
 Name[ms]=Nota dalam fail setempat
 Name[nb]=Notater i lokal fil
 Name[nds]=Notizen in lokaal Datei
-Name[ne]=स्थानीय फाइलका द्रष्टव्य
+Name[ne]=स्थानीय फाइलका टिपोट
 Name[nl]=Notities in lokaal bestand
 Name[nn]=Notat i lokal fil
 Name[pl]=Notatki w pliku lokalnym
Index: knotes/knotesnetrecv.cpp
===================================================================
--- knotes/knotesnetrecv.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knotes/knotesnetrecv.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -77,7 +77,7 @@
     m_sock->enableRead( true );
 
     // Setup the timer
-    m_timer = new QTimer( this );
+    m_timer = new QTimer( this, "m_timer" );
     connect( m_timer, SIGNAL(timeout()), SLOT(slotReceptionTimeout()) );
     m_timer->start( MAXTIME, true );
 }
Index: knotes/knotesalarm.cpp
===================================================================
--- knotes/knotesalarm.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knotes/knotesalarm.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -44,7 +44,8 @@
 
 KNotesAlarm::KNotesAlarm( KNotesResourceManager *manager, QObject *parent, const char *name )
   : QObject( parent, name ),
-    m_manager( manager )
+    m_manager( manager ),
+    m_checkTimer( 0, "m_checkTimer" )
 {
     // TODO: fix timezone stuff?
 
Index: knotes/knotes_manager.desktop
===================================================================
--- knotes/knotes_manager.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knotes/knotes_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -32,7 +32,7 @@
 Name[mk]=Белешки
 Name[ms]=Nota
 Name[nds]=Notizen
-Name[ne]=द्रष्टव्य
+Name[ne]=टिपोट
 Name[nl]=Notities
 Name[nn]=Notat
 Name[pl]=Notatki
@@ -48,6 +48,7 @@
 Name[sv]=Anteckningar
 Name[ta]=குறிப்புகள்
 Name[tg]=Ахборот
+Name[th]=บันทึกช่วยจำ
 Name[tr]=Notlar
 Name[uk]=Примітки
 Name[uz]=Ёзма хотира
Index: knotes/knotes.desktop
===================================================================
--- knotes/knotes.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ knotes/knotes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -42,7 +42,7 @@
 GenericName[mt]=Noti żgħar
 GenericName[nb]=Oppsprett-notater
 GenericName[nds]=Opduk-Notizen
-GenericName[ne]=पपअप द्रष्टव्य
+GenericName[ne]=पपअप टिपोट
 GenericName[nl]=Notities
 GenericName[nn]=Oppsprettnotat
 GenericName[nso]=Ditshwao tsa Thlarogo
@@ -88,4 +88,4 @@
 
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Desktop;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Desktop;Office;
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -110,6 +110,7 @@
 Name[sr]=Време
 Name[sr@Latn]=Vreme
 Name[sv]=Väderleksprognos
+Name[th]=รายงานอากาศ
 Name[tr]=Hava Durumu Servisi
 Name[uk]=Служба погоди
 Name[uz]=Об-ҳаво хизмати
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -117,6 +117,7 @@
 Name[sv]=Nyheter
 Name[ta]=செய்திகள்
 Name[tg]=Ахборот
+Name[th]=ข่าว
 Name[tr]=Haberler
 Name[uk]=Новини
 Name[uz]=Янгиликлар
Index: kontact/plugins/specialdates/kcmsdsummary.desktop
===================================================================
--- kontact/plugins/specialdates/kcmsdsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/specialdates/kcmsdsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -54,6 +54,7 @@
 Name[sr@Latn]=Posebni datumi
 Name[sv]=Speciella datum
 Name[ta]=விசேஷ தேதிகள்
+Name[th]=วันพิเศษ
 Name[tr]=Özel Tarihler
 Name[uk]=Особливі дати
 Name[uz]=Махсус кунлар
@@ -100,6 +101,7 @@
 Comment[sr@Latn]=Podešavanje sažetka posebnih datuma
 Comment[sv]=Inställning av översikt av speciella datum
 Comment[ta]=விசேஷ தேதிகள் சுருக்க அமைப்பு
+Comment[th]=ต้้งค่าส่วนสรุปวันพิเศษ
 Comment[tr]=Özel Tarih Özeti Yapılandırması
 Comment[uk]=Налаштування підсумку особливих дат
 Comment[zh_CN]=特殊日期摘要设置
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -57,6 +57,7 @@
 Name[sr@Latn]=Posebni datumi
 Name[sv]=Speciella datum
 Name[ta]=விசேஷ தேதிகள்
+Name[th]=วันพิเศษ
 Name[tr]=Özel Tarihler
 Name[uk]=Особливі дати
 Name[uz]=Махсус кунлар
@@ -103,6 +104,7 @@
 Comment[sr@Latn]=Priključak za posebne datume
 Comment[sv]=Insticksprogram för speciella datum
 Comment[ta]=விசேஷ தேதிகள் சொருகுப்பொருள்
+Comment[th]=โปรแกรมเสริมวันพิเศษ
 Comment[tr]=Özel Tarihler Eklentisi
 Comment[uk]=Втулок особливих дат
 Comment[zh_CN]=特殊日期插件
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -47,7 +47,7 @@
 Comment[ms]=Plugin KNotes Kontact KNotes 
 Comment[nb]=Kontact programtillegg for KNotes
 Comment[nds]=KNotes-Moduul för Kontact
-Comment[ne]=केडीई द्रष्टव्य प्लगइन सम्पर्क गर्नुहोस्
+Comment[ne]=सम्पर्क केडीई टिपोट प्लगइन
 Comment[nl]=Kontact KNotes-plugin
 Comment[nn]=Kontact-programtillegg for KNotes
 Comment[pl]=Wtyczka Kontact do współpracy z KNotes
@@ -98,7 +98,7 @@
 Name[mk]=Белешки
 Name[ms]=Nota
 Name[nds]=Notizen
-Name[ne]=द्रष्टव्य
+Name[ne]=टिपोट
 Name[nl]=Notities
 Name[nn]=Notat
 Name[pl]=Notatki
@@ -114,6 +114,7 @@
 Name[sv]=Anteckningar
 Name[ta]=குறிப்புகள்
 Name[tg]=Ахборот
+Name[th]=บันทึกช่วยจำ
 Name[tr]=Notlar
 Name[uk]=Примітки
 Name[uz]=Ёзма хотира
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -119,6 +119,7 @@
 Name[sv]=Kontakter
 Name[ta]=தொடர்புகள்
 Name[tg]=Алоқот
+Name[th]=ที่อยู่ติดต่อ
 Name[tr]=Bağlantılar
 Name[uk]=Контакти
 Name[uz]=Алоқалар
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -49,6 +49,7 @@
 Name[sr]=Састанци и обавезе
 Name[sr@Latn]=Sastanci i obaveze
 Name[sv]=Möten och uppgifter
+Name[th]=กำหนดนัดหมายและสิ่งที่จะทำ
 Name[uk]=Зустрічі і завдання
 Name[zh_CN]=约会和待办
 Name[zh_TW]=約會與待辦事項
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -104,6 +104,7 @@
 Name[sr@Latn]=Lista poslova
 Name[sv]=Uppgiftslista
 Name[ta]=செய்யவேண்டிய பட்டியல்
+Name[th]=รายการสิ่งที่จะทำ
 Name[tr]=Yapılacaklar Listesi
 Name[uk]=Список завдань
 Name[uz]=Вазифалар
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -42,7 +42,7 @@
 Comment[ms]=Plugin Jurnal KOrganizer Kontact 
 Comment[nb]=Kontact programtillegg for KOrganizer dagbok
 Comment[nds]=KOrganizer-Daagbookmoduul för Kontact
-Comment[ne]=केडीई आयोजक जर्नल प्लगइन सम्पर्क गर्नुहोस्
+Comment[ne]=सम्पर्क केडीई आयोजक जर्नल प्लगइन
 Comment[nl]=Kontact KOrganizer Journaalplugin
 Comment[nn]=Kontact-programtillegg for KOrganizer-dagbøker
 Comment[pl]=Wtyczka Kontact do współpracy z dziennikiem KOrganizera
@@ -96,6 +96,7 @@
 Name[sk]=Žurnál
 Name[sl]=Dnevnik
 Name[ta]=பத்திரிகை
+Name[th]=วารสาร
 Name[tr]=Günlük
 Name[uk]=Журнал
 Name[uz]=Кундалик
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -120,6 +120,7 @@
 Name[sv]=Kalender
 Name[ta]=நாள்காட்டி
 Name[tg]=Тақвим
+Name[th]=บันทึกประจำวัน
 Name[tr]=Takvim
 Name[uk]=Календар
 Name[uz]=Календар
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -121,6 +121,7 @@
 Name[sv]=Brev
 Name[ta]=அஞ்சல்
 Name[tg]=Мактуб
+Name[th]=จดหมาย
 Name[tr]=Posta
 Name[uk]=Пошта
 Name[uz]=Хат-хабар
Index: kontact/plugins/kmail/kcmkmailsummary.desktop
===================================================================
--- kontact/plugins/kmail/kcmkmailsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/kmail/kcmkmailsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -61,6 +61,7 @@
 Name[sv]=Brev
 Name[ta]=அஞ்சல்
 Name[tg]=Мактуб
+Name[th]=จดหมาย
 Name[tr]=Posta
 Name[uk]=Пошта
 Name[uz]=Хат-хабар
@@ -111,6 +112,7 @@
 Comment[sv]=Inställning av postöversikt
 Comment[ta]=அஞ்சல் சுருக்க அமைப்பு
 Comment[tg]=Танзимоти дайджести почта
+Comment[th]=ตั้งค่าส่วนสรุปจดหมาย
 Comment[tr]=E-posta Özeti Yapılandırması
 Comment[uk]=Налаштування підсумку пошти
 Comment[zh_CN]=邮件摘要设置
Index: kontact/plugins/summary/kcmkontactsummary.desktop
===================================================================
--- kontact/plugins/summary/kcmkontactsummary.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/summary/kcmkontactsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -54,6 +54,7 @@
 Name[sr@Latn]=Komponente
 Name[sv]=Komponenter
 Name[ta]=பகுதிகள்
+Name[th]=ส่วนประกอบ
 Name[tr]=Bileşenler
 Name[uk]=Компоненти
 Name[uz]=Қисмлар
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -110,6 +110,7 @@
 Name[sv]=Översikt
 Name[ta]=சுருக்கம்
 Name[tg]=Дайджест
+Name[th]=หน้าสรุป
 Name[tr]=Özet
 Name[uk]=Зведення
 Name[uz]=Ҳисобот
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -93,5 +93,6 @@
 Name[sl]=Prikazovalnik novic
 Name[sv]=Nyhetsövervakare
 Name[ta]=செய்திகள் குறிப்பான்
+Name[th]=ตั๋วข่าว
 Name[tr]=Haberİzleyici
 Name[zh_CN]=新闻点点通
Index: kontact/src/kontact.setdlg
===================================================================
--- kontact/src/kontact.setdlg	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/src/kontact.setdlg	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -48,6 +48,7 @@
 Name[sv]=Översikt
 Name[ta]=சுருக்கம்
 Name[tg]=Дайджест
+Name[th]=หน้าสรุป
 Name[tr]=Özet
 Name[uk]=Зведення
 Name[uz]=Ҳисобот
@@ -153,6 +154,7 @@
 Name[sv]=Brev
 Name[ta]=அஞ்சல்
 Name[tg]=Мактуб
+Name[th]=จดหมาย
 Name[tr]=Posta
 Name[uk]=Пошта
 Name[uz]=Хат-хабар
@@ -260,6 +262,7 @@
 Name[sv]=Kontakter
 Name[ta]=தொடர்புகள்
 Name[tg]=Алоқот
+Name[th]=ที่อยู่ติดต่อ
 Name[tr]=Bağlantılar
 Name[uk]=Контакти
 Name[uz]=Алоқалар
@@ -357,6 +360,7 @@
 Name[sr@Latn]=Sažetak posebnih datuma
 Name[sv]=Översikt av speciella datum
 Name[ta]=விசேஷ செய்திகளின் சுருக்கம்
+Name[th]=สรุปวันพิเศษ
 Name[tr]=Özel Tarihler Özeti
 Name[uk]=Короткий підсумок особливих дат
 Name[zh_CN]=特殊日期摘要
@@ -460,6 +464,7 @@
 Name[sv]=Kalender
 Name[ta]=நாள்காட்டி
 Name[tg]=Тақвим
+Name[th]=บันทึกประจำวัน
 Name[tr]=Takvim
 Name[uk]=Календар
 Name[uz]=Календар
@@ -565,6 +570,7 @@
 Name[sv]=Nyheter
 Name[ta]=செய்திகள்
 Name[tg]=Ахборот
+Name[th]=ข่าว
 Name[tr]=Haberler
 Name[uk]=Новини
 Name[uz]=Янгиликлар
@@ -670,6 +676,7 @@
 Name[sv]=Väder
 Name[ta]=வானிலை
 Name[tg]=Пешгӯии ҳаво
+Name[th]=รายงานอากาศ
 Name[tr]=Hava Durumu
 Name[uk]=Погода
 Name[uz]=Об-ҳаво
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -787,7 +787,8 @@
 
 void MainWindow::slotNewToolbarConfig()
 {
-  createGUI( mCurrentPlugin->part() );
+  if ( mCurrentPlugin && mCurrentPlugin->part() )
+    createGUI( mCurrentPlugin->part() );
   applyMainWindowSettings( KGlobal::config(), "MainWindow" );
 }
 
Index: kontact/src/Kontact.desktop
===================================================================
--- kontact/src/Kontact.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kontact/src/Kontact.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -65,5 +65,5 @@
 GenericName[zh_TW]=個人資訊管理者
 Terminal=false
 X-KDE-StartupNotify=true
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;Network;Email;
 DocPath=kontact/index.html
Index: kandy/src/kandy.desktop
===================================================================
--- kandy/src/kandy.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ kandy/src/kandy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -117,4 +117,4 @@
 GenericName[zu]=Ithuluzi Lamakhala ekhukhwini
 Terminal=false
 X-DCOP-ServiceType=Multi
-Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;
+Categories=Qt;KDE;Utility;X-KDE-Utilities-Peripherals;Network;Telephony;
Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -5,6 +5,7 @@
 GenericName=TNEF File Viewer
 GenericName[af]=TNEF lêer leser
 GenericName[bg]=Преглед на файлове TNEF
+GenericName[br]=Gweler restr TNEF
 GenericName[ca]=Visor de fitxers TNEF
 GenericName[cs]=Prohlížeč TNEF souborů
 GenericName[cy]=Syllwr Ffeil TNEF
@@ -103,4 +104,4 @@
 Comment[zh_TW]=TNEF 檔案檢視器
 Terminal=false
 MimeType=application/ms-tnef;
-Categories=Qt;KDE;Utility;X-KDE-Utilities-PIM;
+Categories=Qt;KDE;X-KDE-Utilities-PIM;Office;Network;Email;
Index: korganizer/komailclient.cpp
===================================================================
--- korganizer/komailclient.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/komailclient.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -196,7 +196,8 @@
       int idx = attachment.find("METHOD");
       if (idx>=0) {
         idx = attachment.find(':',idx)+1;
-        meth = attachment.mid(idx,attachment.find('\n',idx)-idx);
+        const int newline = attachment.find('\n',idx);
+        meth = attachment.mid(idx, newline - idx - 1);
         meth = meth.lower().stripWhiteSpace();
       } else {
         meth = "publish";
Index: korganizer/datechecker.cpp
===================================================================
--- korganizer/datechecker.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/datechecker.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -54,7 +54,7 @@
     case FollowDay:
     case FollowMonth:
       if ( !mUpdateTimer ) {
-        mUpdateTimer = new QTimer( this );
+        mUpdateTimer = new QTimer( this, "mUpdateTimer" );
         connect( mUpdateTimer, SIGNAL( timeout() ),
                  SLOT( possiblyPastMidnight() ) );
       }
Index: korganizer/koeventeditor.cpp
===================================================================
--- korganizer/koeventeditor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/koeventeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -25,6 +25,7 @@
 
 #include <qtooltip.h>
 #include <qframe.h>
+#include <qguardedptr.h>
 #include <qpixmap.h>
 #include <qlayout.h>
 #include <qwidgetstack.h>
@@ -254,6 +255,8 @@
 
   if ( !validateInput() || !mChanger ) return false;
 
+  QGuardedPtr<KOEditorFreeBusy> freeBusy( mFreeBusy );
+
   if ( mEvent ) {
     bool rc = true;
     Event *oldEvent = mEvent->clone();
@@ -286,9 +289,9 @@
       return false;
     }
   }
+  // if "this" was deleted, freeBusy is 0 (being a guardedptr)
+  if ( freeBusy ) freeBusy->cancelReload();
 
-  if ( mFreeBusy ) mFreeBusy->cancelReload();
-
   return true;
 }
 
Index: korganizer/korgac/korgac.desktop
===================================================================
--- korganizer/korgac/korgac.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/korgac/korgac.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -71,7 +71,7 @@
 GenericName[lt]=KOrganizer priminimų tarnybos klientas
 GenericName[nb]=KOrganizer klient for påminningstjenesten
 GenericName[nds]=Client för den Anstötendämoon vun KOrganizer
-GenericName[ne]=केडीई आयोजक रिमाइन्डर डेइमोन क्लाइन्ट
+GenericName[ne]=केडीई आयोजक रिमाइन्डर डेइमन क्लाइन्ट
 GenericName[nl]=KOrganizer herinneringsdaemon
 GenericName[nn]=Alarmnisseklient for KOrganizer
 GenericName[pl]=Klient demona przypominania KOrganizera
Index: korganizer/interfaces/calendar/calendarplugin.desktop
===================================================================
--- korganizer/interfaces/calendar/calendarplugin.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/interfaces/calendar/calendarplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -58,7 +58,7 @@
 Comment[sv]=Insticksprogram för kalender
 Comment[ta]=நாள்காட்டி சொருகுப்பொருள்
 Comment[tg]=Модул барои тақвимот
-Comment[th]=ปลั๊กอินปฏิทิน
+Comment[th]=โปรแกรมเสริมบันทึกประจำวัน
 Comment[tr]=Takvim Eklentisi
 Comment[uk]=Втулок календаря
 Comment[uz]=Календар плагини
Index: korganizer/interfaces/calendar/calendardecoration.desktop
===================================================================
--- korganizer/interfaces/calendar/calendardecoration.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/interfaces/calendar/calendardecoration.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -55,7 +55,7 @@
 Comment[sv]=Insticksprogram för kalenderdekoration
 Comment[ta]=நாள்காட்டி அலங்கார சொருகுப்பொருள்
 Comment[tg]=Модул барои ороиш додани тақвимот
-Comment[th]=ปลั๊กอินการตกแต่งปฏิทิน
+Comment[th]=โปรแกรมเสริมตกแต่งบันทึกประจำวัน
 Comment[tr]=Takvim Dekorasyon Eklentisi
 Comment[uk]=Втулок прикрас календаря
 Comment[ven]=Pulagini yo khavhisiwaho ya khalenda
Index: korganizer/koagenda.cpp
===================================================================
--- korganizer/koagenda.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/koagenda.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1044,6 +1044,7 @@
   setCursor( arrowCursor );
   bool multiModify = false;
   // FIXME: do the cloning here...
+  Incidence* inc = mActionItem->incidence();
 
   if ( mItemMoved ) {
     bool modify = true;
@@ -1146,7 +1147,7 @@
       emit itemModified( modif );
     }
     // FIXME: If the change failed, we need to update the view!
-    mChanger->endChange( mActionItem->incidence() );
+    mChanger->endChange( inc );
   }
 
   mActionItem = 0;
Index: korganizer/plugins/hebrew/hebrew.cpp
===================================================================
--- korganizer/plugins/hebrew/hebrew.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/plugins/hebrew/hebrew.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -108,4 +108,5 @@
   ConfigDialog *dlg = new ConfigDialog(parent);        //parent?
 
   dlg->exec();
+  delete dlg;
 }
Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -54,7 +54,7 @@
 Comment[sv]=Kalender- och schemaläggningsprogram
 Comment[ta]=நாள்காட்டி மற்றும் திட்ட நிரல்
 Comment[tg]=Тақвимот ва ҷадвали шахсӣ
-Comment[th]=โปรแกรมจัดการปฏิทินและตารางการนัดหมาย
+Comment[th]=โปรแกรมจัดการบันทึกประจำวันและตารางการนัดหมาย
 Comment[tr]=Takvim ve Zamanlama Programı
 Comment[uk]=Програма календаря та розкладу
 Comment[uz]=Календар ва режалаштириш дастури
@@ -143,4 +143,4 @@
 X-KDE-StartupNotify=true
 X-DCOP-ServiceType=Unique
 X-DCOP-ServiceName=korganizer
-Categories=Qt;KDE;Office;
+Categories=Qt;KDE;Office;ProjectManagement;
Index: korganizer/koincidenceeditor.cpp
===================================================================
--- korganizer/koincidenceeditor.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/koincidenceeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -24,6 +24,7 @@
 
 #include <qtooltip.h>
 #include <qframe.h>
+#include <qguardedptr.h>
 #include <qpixmap.h>
 #include <qlayout.h>
 #include <qwidgetstack.h>
@@ -117,7 +118,11 @@
 
 void KOIncidenceEditor::slotOk()
 {
-  if ( processInput() ) accept();
+  // "this" can be deleted before processInput() returns (processInput() opens 
+  // a non-modal dialog when Kolab is used). So accept should only be executed
+  // when "this" is still valid
+  QGuardedPtr<QWidget> ptr( this );
+  if ( processInput() && ptr ) accept();
 }
 
 void KOIncidenceEditor::updateCategoryConfig()
Index: korganizer/koagendaview.cpp
===================================================================
--- korganizer/koagendaview.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/koagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -1174,15 +1174,15 @@
     td->setDtDue( endDt );
   }
 
-  mChanger->changeIncidence( oldIncidence, incidence );
-  mChanger->endChange(incidence);
-  delete oldIncidence;
-
   item->setItemDate( startDt.date() );
 
   KOIncidenceToolTip::remove( item );
   KOIncidenceToolTip::add( item, incidence, KOAgendaItem::toolTipGroup() );
 
+  mChanger->changeIncidence( oldIncidence, incidence );
+  mChanger->endChange(incidence);
+  delete oldIncidence;
+
   // don't update the agenda as the item already has the correct coordinates.
   // an update would delete the current item and recreate it, but we are still
   // using a pointer to that item! => CRASH
Index: korganizer/freebusymanager.cpp
===================================================================
--- korganizer/freebusymanager.cpp	(.../tags/KDE/3.5.7/kdepim)	(wersja 686795)
+++ korganizer/freebusymanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 686795)
@@ -109,11 +109,10 @@
     mManager->saveFreeBusy( fb, p );
   }
   emit freeBusyDownloaded( fb, mEmail );
-  // PENDING(steffen): Is this safe?
-  //job->deleteLater();
-  delete this;
+  deleteLater();
 }
 
+////
 
 FreeBusyManager::FreeBusyManager( QObject *parent, const char *name )
   : QObject( parent, name ),
@@ -159,7 +158,7 @@
 
 void FreeBusyManager::slotPerhapsUploadFB()
 {
-  // user has automtic uploading disabled, bail out
+  // user has automatic uploading disabled, bail out
   if ( !KOPrefs::instance()->freeBusyPublishAuto() ||
        KOPrefs::instance()->freeBusyPublishUrl().isEmpty() )
      return;
@@ -364,7 +363,7 @@
 
   KURL sourceURL = freeBusyUrl( email );
 
-  kdDebug(5850) << "FreeBusyManager::processRetrieveQueue(): url: " << sourceURL.url()
+  kdDebug(5850) << "FreeBusyManager::processRetrieveQueue(): url: " << sourceURL
             << endl;
 
   if ( !sourceURL.isValid() ) {
@@ -400,7 +399,7 @@
   cfg.setGroup( email );
   QString url = cfg.readEntry( "url" );
   if ( !url.isEmpty() ) {
-    kdDebug(5850) << "found cached url: " << url << endl; 
+    kdDebug(5850) << "found cached url: " << url << endl;
     return KURL( url );
   }
   // Try with the url configurated by preferred email in kaddressbook
@@ -414,16 +413,19 @@
         "Preferred email of " << email << " is " << pref << endl;
       cfg.setGroup( pref );
       url = cfg.readEntry ( "url" );
-      if ( !url.isEmpty() )
+      if ( !url.isEmpty() ) {
         kdDebug( 5850 ) << "FreeBusyManager::freeBusyUrl():" <<
           "Taken url from preferred email:" << url << endl;
         return KURL( url );
+      }
     }
   }
   // None found. Check if we do automatic FB retrieving then
-  if ( !KOPrefs::instance()->mFreeBusyRetrieveAuto )
+  if ( !KOPrefs::instance()->mFreeBusyRetrieveAuto ) {
+    kdDebug( 5850 ) << "no auto retrieving" << endl;
     // No, so no FB list here
     return KURL();
+  }
 
   // Sanity check: Don't download if it's not a correct email
   // address (this also avoids downloading for "(empty email)").
@@ -449,7 +451,7 @@
       << email << '\'' << endl;
     return KURL();
 }
-  kdDebug(5850) << "Server FreeBusy url: " << sourceURL.url() << endl;
+  kdDebug(5850) << "Server FreeBusy url: " << sourceURL << endl;
   if ( KOPrefs::instance()->mFreeBusyFullDomainRetrieval )
     sourceURL.setFileName( email + ".ifb" );
   else
@@ -457,7 +459,7 @@
   sourceURL.setUser( KOPrefs::instance()->mFreeBusyRetrieveUser );
   sourceURL.setPass( KOPrefs::instance()->mFreeBusyRetrievePassword );
 
-  kdDebug(5850) << "Results in generated: " << sourceURL.url() << endl;
+  kdDebug(5850) << "Results in generated: " << sourceURL << endl;
   return sourceURL;
 }
 

Zmiany atrybutów dla: .
___________________________________________________________________
Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


