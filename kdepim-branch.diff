Index: akregator/src/articlelistview.cpp
===================================================================
--- akregator/src/articlelistview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ akregator/src/articlelistview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -148,7 +148,10 @@
         private:
             Article m_article;
             time_t m_pubDate;
-            static QPixmap m_keepFlag;
+            static QPixmap keepFlag() {
+                   static QPixmap s_keepFlag = QPixmap(locate("data", "akregator/pics/akregator_flag.png"));
+                   return s_keepFlag;
+	    }
 };
 
 // FIXME: Remove resolveEntities for KDE 4.0, it's now done in the parser
@@ -156,7 +159,7 @@
     : KListViewItem( parent, KCharsets::resolveEntities(a.title()), a.feed()->title(), KGlobal::locale()->formatDateTime(a.pubDate(), true, false) ), m_article(a), m_pubDate(a.pubDate().toTime_t())
 {
     if (a.keep())
-        setPixmap(0, m_keepFlag);
+        setPixmap(0, keepFlag());
 }
  
 ArticleListView::ArticleItem::~ArticleItem()
@@ -168,8 +171,6 @@
     return m_article;
 }
 
-QPixmap ArticleListView::ArticleItem::m_keepFlag = QPixmap(locate("data", "akregator/pics/akregator_flag.png"));
-
 // paint ze peons
 void ArticleListView::ArticleItem::paintCell ( QPainter * p, const QColorGroup & cg, int column, int width, int align )
 {
@@ -193,7 +194,7 @@
 void ArticleListView::ArticleItem::updateItem(const Article& article)
 {
     m_article = article;
-    setPixmap(0, m_article.keep() ? m_keepFlag : QPixmap());
+    setPixmap(0, m_article.keep() ? keepFlag() : QPixmap());
     setText(0, KCharsets::resolveEntities(m_article.title()));
     setText(1, m_article.feed()->title());
     setText(2, KGlobal::locale()->formatDateTime(m_article.pubDate(), true, false));
Index: akregator/src/librss/tools_p.cpp
===================================================================
--- akregator/src/librss/tools_p.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ akregator/src/librss/tools_p.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -181,9 +181,13 @@
     
     name = str.simplifyWhiteSpace();
     
-    // str might have the format "foo@bar.com (Foo M. Bar)".
-    // We cut off parentheses if there are any
-    QRegExp rename("\\(([^\\)]*)\\)");
+    // after removing the email, str might have 
+    // the format "(Foo M. Bar)". We cut off 
+    // parentheses if there are any. However, if
+    // str is of the format "Foo M. Bar (President)",
+    // we should not cut anything.
+
+    QRegExp rename("^\\(([^\\)]*)\\)");
     
     pos = rename.search(name);
     
Index: kmobile/devices/skeleton/libkmobile_skeleton.desktop
===================================================================
--- kmobile/devices/skeleton/libkmobile_skeleton.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmobile/devices/skeleton/libkmobile_skeleton.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Name[da]=Skeleton-enhed
 Name[de]=Skeleton-Ger√§t
 Name[el]=Œ£œÖœÉŒ∫ŒµœÖŒÆ Skeleton
+Name[eo]=Skelet-aparato
 Name[es]=Dispositivo Skeleton
 Name[et]=Mallseade
 Name[eu]=Skeleton dispositiboa
@@ -61,6 +62,7 @@
 Comment[da]=Mobil skeleton-enhed
 Comment[de]=Mobiles Skeleton-Ger√§t
 Comment[el]=Œ¶ŒøœÅŒ∑œÑŒÆ œÉœÖœÉŒ∫ŒµœÖŒÆ Skeleton
+Comment[eo]=Mobila skelet-aparato
 Comment[es]=Dispositivo m√≥vil Skeleton
 Comment[et]=Mobiili mallseade
 Comment[eu]=Skeleton dispositibo mugikorra
Index: kmobile/devices/digicam/libkmobile_digicam.desktop
===================================================================
--- kmobile/devices/digicam/libkmobile_digicam.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmobile/devices/digicam/libkmobile_digicam.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Digitalt kamera
 Name[de]=Digitalkamera
 Name[el]=Œ®Œ∑œÜŒπŒ±Œ∫ŒÆ Œ∫Œ¨ŒºŒµœÅŒ±
+Name[eo]=Cifereca fotilo
 Name[es]=C√°mara digital
 Name[et]=Digitaalkaamera
 Name[eu]=Kamera digitala
Index: kmobile/kmobile.desktop
===================================================================
--- kmobile/kmobile.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmobile/kmobile.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,6 +28,7 @@
 GenericName[da]=H√•ndt√©r mobil-enheder
 GenericName[de]=Mobiltelefone verwalten
 GenericName[el]=ŒîŒπŒ±œáŒµŒØœÅŒπœÉŒ∑ œÜŒøœÅŒ∑œÑœéŒΩ œÉœÖœÉŒ∫ŒµœÖœéŒΩ
+GenericName[eo]=Administri mobilajn aparatojn
 GenericName[es]=Gestiona dispositivos m√≥viles
 GenericName[et]=Mobiilihaldur
 GenericName[eu]=Dispositibo mugikorrak kudeatu
@@ -82,6 +83,7 @@
 Comment[da]=En KDE-h√•ndtering af mobil-enheder
 Comment[de]=Verwaltung f√ºr mobile Ger√§te
 Comment[el]=ŒàŒΩŒ±œÇ Œ¥ŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ œÜŒøœÅŒ∑œÑœéŒΩ œÉœÖœÉŒ∫ŒµœÖœéŒΩ œÑŒøœÖ KDE
+Comment[eo]=KDE-mobilaparat-administrilo
 Comment[es]=A gestor de dispositivos m√≥viles para KDE
 Comment[et]=KDE mobiilihaldur
 Comment[eu]=KDE-ren dispositibo mugikorren kudeatzailea
Index: kmobile/kioslave/mimetypes/mobile_calendar.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_calendar.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmobile/kioslave/mimetypes/mobile_calendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Comment[da]=Kalender i mobil-enhed
 Comment[de]=Kalender f√ºr Mobiltelefon
 Comment[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø œÉœÑŒ∑ œÜŒøœÅŒ∑œÑŒÆ œÉœÖœÉŒ∫ŒµœÖŒÆ
+Comment[eo]=Kalendaro en mobila aparato
 Comment[es]=Calendario del dispositivo m√≥vil
 Comment[et]=Mobiili kalender
 Comment[eu]=Egutegia dispositibo mugikorrean
Index: kmobile/kioslave/mimetypes/mobile_device.desktop
===================================================================
--- kmobile/kioslave/mimetypes/mobile_device.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmobile/kioslave/mimetypes/mobile_device.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Comment[da]=Mobil-enhed
 Comment[de]=Mobilger√§t
 Comment[el]=Œ¶ŒøœÅŒ∑œÑŒÆ œÉœÖœÉŒ∫ŒµœÖŒÆ
+Comment[eo]=Mobila aparato
 Comment[es]=Dispositivo m√≥vil
 Comment[et]=Mobiil
 Comment[eu]=Dispositibo mugikorra
Index: wizards/scalixkmailchanges.h
===================================================================
--- wizards/scalixkmailchanges.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixkmailchanges.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,28 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+#ifndef SCALIXKMAILCHANGES_H
+#define SCALIXKMAILCHANGES_H
+
+#include <kconfigpropagator.h>
+
+void createKMailChanges( KConfigPropagator::Change::List& );
+
+#endif
Index: wizards/scalixconfig.kcfgc
===================================================================
--- wizards/scalixconfig.kcfgc	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixconfig.kcfgc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,9 @@
+# Code generation options for kconfig_compiler
+File=scalix.kcfg
+ClassName=ScalixConfig
+Singleton=true
+Mutators=true
+MemberVariables=public
+GlobalEnums=true
+ItemAccessors=true
+SetUserTexts=true
Index: wizards/scalixwizard.cpp
===================================================================
--- wizards/scalixwizard.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixwizard.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,546 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2004 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2004 Daniel Molkentin <molkentin@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "scalixwizard.h"
+#include "scalixconfig.h"
+
+#include "scalixkmailchanges.h"
+
+#include "kresources/scalix/kcal/resourcescalix.h"
+#include "kresources/scalix/kabc/resourcescalix.h"
+
+#include <libkcal/resourcecalendar.h>
+#include <kabc/resource.h>
+
+#include <dcopref.h>
+#include <kcombobox.h>
+#include <kdcopservicestarter.h>
+#include <klineedit.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+#include <kstringhandler.h>
+
+#include <qapplication.h>
+#include <qcheckbox.h>
+#include <qhbuttongroup.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qwhatsthis.h>
+
+#include <unistd.h>
+
+class SetupLDAPSearchAccount : public KConfigPropagator::Change
+{
+  public:
+    SetupLDAPSearchAccount()
+      : KConfigPropagator::Change( i18n("Setup LDAP Search Account") )
+    {
+    }
+
+    void apply()
+    {
+      const QString host = ScalixConfig::self()->server();
+
+      QString basedn( "o=Scalix" );
+
+      { // while we're here, write default domain
+        KConfig c( "kmailrc" );
+        c.setGroup( "General" );
+        c.writeEntry( "Default domain", basedn );
+      }
+
+      // Set the changes
+      KConfig c( "kabldaprc" );
+      c.setGroup( "LDAP" );
+      bool hasMyServer = false;
+      uint selHosts = c.readNumEntry("NumSelectedHosts", 0);
+      for ( uint i = 0 ; i < selHosts && !hasMyServer; ++i )
+        if ( c.readEntry( QString("SelectedHost%1").arg(i) ) == host )
+          hasMyServer = true;
+      if ( !hasMyServer ) {
+        c.writeEntry( "NumSelectedHosts", selHosts + 1 );
+        c.writeEntry( QString("SelectedHost%1").arg(selHosts), host);
+        c.writeEntry( QString("SelectedBase%1").arg(selHosts), basedn);
+        c.writeEntry( QString("SelectedPort%1").arg(selHosts), "389");
+      }
+    }
+
+};
+
+class SetupScalixAdmin : public KConfigPropagator::Change
+{
+  public:
+    SetupScalixAdmin()
+      : KConfigPropagator::Change( i18n( "Setup ScalixAdmin Account" ) )
+    {
+    }
+
+    void apply()
+    {
+      KConfig c( "scalixadminrc" );
+      c.setGroup( "Account" );
+
+      c.writeEntry( "user", ScalixConfig::self()->user() );
+      c.writeEntry( "pass", KStringHandler::obscure( ScalixConfig::self()->password() ) );
+      c.writeEntry( "host", ScalixConfig::self()->server() );
+      if ( ScalixConfig::self()->security() == ScalixConfig::None )
+        c.writeEntry( "port", 143 );
+      else
+        c.writeEntry( "port", 993 );
+
+      switch ( ScalixConfig::self()->security() ) {
+        case ScalixConfig::None:
+          c.writeEntry( "use-ssl", "false" );
+          c.writeEntry( "use-tls", "false" );
+          break;
+        case ScalixConfig::TLS:
+          c.writeEntry( "use-ssl", "false" );
+          c.writeEntry( "use-tls", "true" );
+          break;
+        case ScalixConfig::SSL:
+          c.writeEntry( "use-ssl", "true" );
+          c.writeEntry( "use-tls", "false" );
+          break;
+      }
+      switch ( ScalixConfig::self()->authentication() ) {
+        case ScalixConfig::Password:
+          c.writeEntry( "auth", "*" );
+          break;
+        case ScalixConfig::NTLM_SPA:
+          c.writeEntry( "auth", "NTLM" );
+          break;
+        case ScalixConfig::GSSAPI:
+          c.writeEntry( "auth", "GSSAPI" );
+          break;
+        case ScalixConfig::DIGEST_MD5:
+          c.writeEntry( "auth", "DIGEST-MD5" );
+          break;
+        case ScalixConfig::CRAM_MD5:
+          c.writeEntry( "auth", "CRAM-MD5" );
+          break;
+      }
+
+      c.setGroup( "LDAP" );
+
+      c.writeEntry( "host", ScalixConfig::self()->server() );
+      c.writeEntry( "port", "389" );
+      c.writeEntry( "base", "o=Scalix" );
+      c.writeEntry( "bindDn", "" );
+      c.writeEntry( "password", "" );
+    }
+};
+
+class CreateCalendarImapResource : public KConfigPropagator::Change
+{
+  public:
+    CreateCalendarImapResource()
+      : KConfigPropagator::Change( i18n("Create Calendar IMAP Resource") )
+    {
+    }
+
+    void apply()
+    {
+      KCal::CalendarResourceManager m( "calendar" );
+      m.readConfig();
+      KCal::ResourceScalix *r = new KCal::ResourceScalix( 0 );
+      r->setResourceName( i18n("Scalix Server") );
+      m.add( r );
+      m.setStandardResource( r );
+      m.writeConfig();
+    }
+};
+
+class CreateContactImapResource : public KConfigPropagator::Change
+{
+  public:
+    CreateContactImapResource()
+      : KConfigPropagator::Change( i18n("Create Contact IMAP Resource") )
+    {
+    }
+
+    void apply()
+    {
+      KRES::Manager<KABC::Resource> m( "contact" );
+      m.readConfig();
+      KABC::ResourceScalix *r = new KABC::ResourceScalix( 0 );
+      r->setResourceName( i18n("Scalix Server") );
+      m.add( r );
+      m.setStandardResource( r );
+      m.writeConfig();
+    }
+
+};
+
+class SynchronizeScalixAccount : public KConfigPropagator::Change
+{
+  public:
+    SynchronizeScalixAccount()
+      : KConfigPropagator::Change( i18n("Synchronize Scalix Account") )
+    {
+    }
+
+    void apply()
+    {
+      QMessageBox *msg = new QMessageBox( qApp->mainWidget() );
+      msg->setText( "Preparing initial synchronization with Scalix server..." );
+      msg->show();
+      qApp->processEvents();
+      sleep( 1 );
+      qApp->processEvents();
+
+      QString error;
+      QCString dcopService;
+      int result = KDCOPServiceStarter::self()->
+        findServiceFor( "DCOP/ResourceBackend/IMAP", QString::null,
+                        QString::null, &error, &dcopService );
+      if ( result != 0 ) {
+        KMessageBox::error( 0, i18n( "Unable to start KMail to trigger initial synchronization with Scalix server" ) );
+        delete msg;
+        return;
+      }
+
+      DCOPRef ref( dcopService, "KMailIface" );
+
+      // loop until dcop iface is set up correctly
+      QStringList list;
+      while ( list.isEmpty() ) {
+        ref.call( "accounts()" ).get( list );
+      }
+
+      ref.call( "checkAccount(QString)", i18n( "Scalix Server" ) );
+
+      // ugly hack, but kmail needs a second before accepting the second dcop call
+      sleep( 5 );
+      ref.call( "checkAccount(QString)", i18n( "Scalix Server" ) );
+
+      delete msg;
+    }
+
+};
+
+
+class ScalixPropagator : public KConfigPropagator
+{
+  public:
+    ScalixPropagator()
+      : KConfigPropagator( ScalixConfig::self(), "scalix.kcfg" )
+    {
+    }
+
+  protected:
+    void addKorganizerChanges( Change::List &changes )
+    {
+      KURL freeBusyBaseUrl = "scalix://" + ScalixConfig::self()->server() + "/freebusy/";
+      freeBusyBaseUrl.setUser( ScalixConfig::self()->user() );
+
+      ChangeConfig *c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyRetrieveUrl";
+      c->value = freeBusyBaseUrl.url() + ScalixConfig::self()->eMail();
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyRetrieveUser";
+      c->value = ScalixConfig::self()->user();
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyRetrievePassword";
+      c->value = ScalixConfig::self()->password();
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyPublishUrl";
+      c->value = freeBusyBaseUrl.url() + "Calendar/" + ScalixConfig::self()->eMail();
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyPublishUser";
+      c->value = ScalixConfig::self()->user();
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyPublishPassword";
+      c->value = ScalixConfig::self()->password();
+      changes.append( c );
+
+      // Use full email address for retrieval of free/busy lists
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyFullDomainRetrieval";
+      c->value = "true";
+      changes.append( c );
+
+      // Disable hostname checking
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyCheckHostname";
+      c->value = "false";
+      changes.append( c );
+
+      // Enable automatic retrieval
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "FreeBusy";
+      c->name = "FreeBusyRetrieveAuto";
+      c->value = "true";
+      changes.append( c );
+
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "Group Scheduling";
+      c->name = "Use Groupware Communication";
+      c->value = "true";
+      changes.append( c );
+
+      // Use identity "from control center", i.e. from emaildefaults
+      c = new ChangeConfig;
+      c->file = "korganizerrc";
+      c->group = "Personal Settings";
+      c->name = "Use Control Center Email";
+      c->value = "true";
+      changes.append( c );
+    }
+
+    virtual void addCustomChanges( Change::List &changes )
+    {
+      addKorganizerChanges( changes );
+
+      // KMail cruft has been outsourced to kolabkmailchanges.cpp
+      createKMailChanges( changes );
+
+      changes.append( new SetupLDAPSearchAccount );
+
+      KCal::CalendarResourceManager m( "calendar" );
+      m.readConfig();
+      KCal::CalendarResourceManager::Iterator it;
+      for ( it = m.begin(); it != m.end(); ++it ) {
+        if ( (*it)->type() == "scalix" ) break;
+      }
+      if ( it == m.end() ) {
+        changes.append( new CreateCalendarImapResource );
+        changes.append( new CreateContactImapResource );
+      }
+
+      changes.append( new SetupScalixAdmin );
+
+      changes.append( new SynchronizeScalixAccount );
+    }
+};
+
+ScalixWizard::ScalixWizard() : KConfigWizard( new ScalixPropagator )
+{
+  QFrame *page = createWizardPage( i18n("Scalix Server") );
+
+  QGridLayout *topLayout = new QGridLayout( page );
+  topLayout->setSpacing( spacingHint() );
+
+  QLabel *label = new QLabel( i18n( "Full name:" ), page );
+  topLayout->addWidget( label, 0, 0 );
+  mRealNameEdit = new KLineEdit( page );
+  topLayout->addWidget( mRealNameEdit, 0, 1 );
+  label->setBuddy( mRealNameEdit );
+  QWhatsThis::add( mRealNameEdit, i18n( "Your full name. "
+                                        "Example: <i>Joe User</i>" ) );
+
+  label = new QLabel( i18n( "Email address:" ), page );
+  topLayout->addWidget( label, 1, 0 );
+  mEMailEdit = new KLineEdit( page );
+  topLayout->addWidget( mEMailEdit, 1, 1 );
+  label->setBuddy( mEMailEdit );
+  QWhatsThis::add( mEMailEdit, i18n( "Your email address on the Scalix Server. "
+                                     "Example: <i>name@crossplatform.com</i>" ) );
+
+  label = new QLabel( i18n( "Server:" ), page );
+  topLayout->addWidget( label, 2, 0 );
+  mServerEdit = new KLineEdit( page );
+  topLayout->addWidget( mServerEdit, 2, 1 );
+  label->setBuddy( mServerEdit );
+  QWhatsThis::add( mServerEdit, i18n( "The name or IP of the Scalix Server. "
+                                      "Example: <i>scalix.domain.com</i>" ) );
+
+  label = new QLabel( i18n("Username:"), page );
+  topLayout->addWidget( label, 3, 0 );
+  mUserEdit = new KLineEdit( page );
+  topLayout->addWidget( mUserEdit, 3, 1 );
+  label->setBuddy( mUserEdit );
+  QWhatsThis::add( mUserEdit, i18n( "The user respectively login name. "
+                                    "Example: <i>joe</i>" ) );
+
+  label = new QLabel( i18n("Password:"), page );
+  topLayout->addWidget( label, 4, 0 );
+  mPasswordEdit = new KLineEdit( page );
+  mPasswordEdit->setEchoMode( KLineEdit::Password );
+  topLayout->addWidget( mPasswordEdit, 4, 1 );
+  label->setBuddy( mPasswordEdit );
+  QWhatsThis::add( mPasswordEdit, i18n( "The password to your login." ) );
+
+  mSavePasswordCheck = new QCheckBox( i18n("Save password"), page );
+  topLayout->addMultiCellWidget( mSavePasswordCheck, 5, 5, 0, 1 );
+  QWhatsThis::add( mSavePasswordCheck, i18n( "Shall the password be saved in KWallet?." ) );
+
+  label = new QLabel( i18n( "Use Secure Connection:" ), page );
+  topLayout->addWidget( label, 6, 0 );
+  mSecurity = new KComboBox( page );
+  mSecurity->insertItem( i18n( "No encryption" ) );
+  mSecurity->insertItem( i18n( "TLS encryption" ) );
+  mSecurity->insertItem( i18n( "SSL encryption" ) );
+  topLayout->addWidget( mSecurity, 6, 1 );
+  label->setBuddy( mSecurity );
+  QWhatsThis::add( mSecurity, i18n( "Choose the encryption type that is supported by your server." ) );
+
+  label = new QLabel( i18n( "Authentication Type:" ), page );
+  topLayout->addWidget( label, 7, 0 );
+  mAuthentication = new KComboBox( page );
+  mAuthentication->insertItem( i18n( "Password" ) );
+  mAuthentication->insertItem( i18n( "NTLM / SPA" ) );
+  mAuthentication->insertItem( i18n( "GSSAPI" ) );
+  mAuthentication->insertItem( i18n( "DIGEST-MD5" ) );
+  mAuthentication->insertItem( i18n( "CRAM-MD5" ) );
+  topLayout->addWidget( mAuthentication, 7, 1 );
+  label->setBuddy( mAuthentication );
+  QWhatsThis::add( mAuthentication, i18n( "Choose the authentication type that is supported by your server." ) );
+
+  topLayout->setRowStretch( 8, 1 );
+
+  //DF: I don't see the point in showing the user those pages.
+  //They are very 'internal' and of no use to anyone other than developers.
+  //(This is even more true for the rules page. The changes page is sort of OK)
+
+  setupRulesPage();
+  setupChangesPage();
+
+  setInitialSize( QSize( 600, 300 ) );
+}
+
+ScalixWizard::~ScalixWizard()
+{
+}
+
+QString ScalixWizard::validate()
+{
+  if ( mRealNameEdit->text().isEmpty() ||
+       mEMailEdit->text().isEmpty() ||
+       mServerEdit->text().isEmpty() ||
+       mUserEdit->text().isEmpty() ||
+       mPasswordEdit->text().isEmpty() )
+    return i18n( "Please fill in all fields." );
+
+  return QString::null;
+}
+
+void ScalixWizard::usrReadConfig()
+{
+  mRealNameEdit->setText( ScalixConfig::self()->realName() );
+  mEMailEdit->setText( ScalixConfig::self()->eMail() );
+  mServerEdit->setText( ScalixConfig::self()->server() );
+  mUserEdit->setText( ScalixConfig::self()->user() );
+  mPasswordEdit->setText( ScalixConfig::self()->password() );
+  mSavePasswordCheck->setChecked( ScalixConfig::self()->savePassword() );
+
+  switch ( ScalixConfig::self()->security() ) {
+    default:
+    case ScalixConfig::None:
+      mSecurity->setCurrentItem( 0 );
+      break;
+    case ScalixConfig::TLS:
+      mSecurity->setCurrentItem( 1 );
+      break;
+    case ScalixConfig::SSL:
+      mSecurity->setCurrentItem( 2 );
+      break;
+  }
+
+  switch ( ScalixConfig::self()->authentication() ) {
+    default:
+    case ScalixConfig::Password:
+      mAuthentication->setCurrentItem( 0 );
+      break;
+    case ScalixConfig::NTLM_SPA:
+      mAuthentication->setCurrentItem( 1 );
+      break;
+    case ScalixConfig::GSSAPI:
+      mAuthentication->setCurrentItem( 2 );
+      break;
+    case ScalixConfig::DIGEST_MD5:
+      mAuthentication->setCurrentItem( 3 );
+      break;
+    case ScalixConfig::CRAM_MD5:
+      mAuthentication->setCurrentItem( 4 );
+      break;
+  }
+}
+
+void ScalixWizard::usrWriteConfig()
+{
+  ScalixConfig::self()->setRealName( mRealNameEdit->text() );
+  ScalixConfig::self()->setEMail( mEMailEdit->text() );
+  ScalixConfig::self()->setServer( mServerEdit->text() );
+  ScalixConfig::self()->setUser( mUserEdit->text() );
+  ScalixConfig::self()->setPassword( mPasswordEdit->text() );
+  ScalixConfig::self()->setSavePassword( mSavePasswordCheck->isChecked() );
+
+  switch ( mSecurity->currentItem() ) {
+    default:
+    case 0:
+      ScalixConfig::self()->setSecurity( ScalixConfig::None );
+      break;
+    case 1:
+      ScalixConfig::self()->setSecurity( ScalixConfig::TLS );
+      break;
+    case 2:
+      ScalixConfig::self()->setSecurity( ScalixConfig::SSL );
+      break;
+  }
+
+  switch ( mAuthentication->currentItem() ) {
+    default:
+    case 0:
+      ScalixConfig::self()->setAuthentication( ScalixConfig::Password );
+      break;
+    case 1:
+      ScalixConfig::self()->setAuthentication( ScalixConfig::NTLM_SPA );
+      break;
+    case 2:
+      ScalixConfig::self()->setAuthentication( ScalixConfig::GSSAPI );
+      break;
+    case 3:
+      ScalixConfig::self()->setAuthentication( ScalixConfig::DIGEST_MD5 );
+      break;
+    case 4:
+      ScalixConfig::self()->setAuthentication( ScalixConfig::CRAM_MD5 );
+      break;
+  }
+}
Index: wizards/scalix.kcfg
===================================================================
--- wizards/scalix.kcfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalix.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,48 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<kcfg xmlns="http://www.kde.org/standards/kcfg/1.0"
+      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+      xsi:schemaLocation="http://www.kde.org/standards/kcfg/1.0
+      http://www.kde.org/standards/kcfg/1.0/kcfg.xsd" >
+  <kcfgfile name="scalixrc"/>
+
+  <group name="General">
+    <entry name="Server" type="String">
+      <default></default>
+    </entry>
+    <entry name="User" type="String">
+      <default></default>
+    </entry>
+    <entry name="RealName" type="String">
+      <default></default>
+    </entry>
+    <entry name="EMail" type="String">
+      <default></default>
+    </entry>
+    <entry name="Password" type="Password">
+      <default></default>
+    </entry>
+    <entry name="SavePassword" type="Bool">
+      <default>false</default>
+    </entry>
+  </group>
+  <group name="IMAP">
+    <entry name="Security" type="Enum">
+      <choices>
+        <choice name="None"/>
+        <choice name="TLS"/>
+        <choice name="SSL"/>
+      </choices>
+      <default>None</default>
+    </entry>
+    <entry name="Authentication" type="Enum">
+      <choices>
+        <choice name="Password"/>
+        <choice name="NTLM_SPA"/>
+        <choice name="GSSAPI"/>
+        <choice name="DIGEST_MD5"/>
+        <choice name="CRAM_MD5"/>
+      </choices>
+      <default>Password</default>
+    </entry>
+  </group>
+</kcfg>
Index: wizards/groupwise.kcfg
===================================================================
--- wizards/groupwise.kcfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ wizards/groupwise.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,7 +11,7 @@
     </entry>
     <entry key="Port" type="UInt" >
       <label>Port</label>
-      <default>8201</default>
+      <default>7191</default>
     </entry>
     <entry key="User" type="String" >
       <label>User name</label>
Index: wizards/scalixkmailchanges.cpp
===================================================================
--- wizards/scalixkmailchanges.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixkmailchanges.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,171 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "scalixkmailchanges.h"
+
+#include "scalixconfig.h"
+#include "kmailchanges.h"
+
+#include <klocale.h>
+#include <kconfig.h>
+#include <kdebug.h>
+
+class ScalixCustomWriter : public CreateDisconnectedImapAccount::CustomWriter
+{
+  void writeFolder( KConfig &c, int id )
+  {
+    c.setGroup( "IMAP Resource" );
+    c.writeEntry( "TheIMAPResourceAccount", id );
+    c.writeEntry( "TheIMAPResourceFolderParent", QString(".%1.directory/INBOX").arg( id ) );
+    c.writeEntry( "HideGroupwareFolders", false );
+  }
+  void writeIds( int, int ) {}
+};
+
+void createKMailChanges( KConfigPropagator::Change::List& changes )
+{
+  KConfigPropagator::ChangeConfig *c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "Groupware";
+  c->name = "Enabled";
+  c->value = "true";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "Groupware";
+  c->name = "AutoAccept";
+  c->value = "false";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "Groupware";
+  c->name = "AutoDeclConflict";
+  c->value = "false";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "Groupware";
+  c->name = "LegacyMangleFromToHeaders";
+  c->value = "true";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "Groupware";
+  c->name = "LegacyBodyInvites";
+  c->value = "true";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "IMAP Resource";
+  c->name = "Enabled";
+  c->value = "true";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "IMAP Resource";
+  c->name = "TheIMAPResourceEnabled";
+  c->value = "true";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "IMAP Resource";
+  c->name = "TheIMAPResourceStorageFormat";
+  c->value = "IcalVcard";
+  changes.append( c );
+
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "IMAP Resource";
+  c->name = "Folder Language";
+  c->value = "0";
+  changes.append( c );
+
+  // Don't show the account wizard as we created an account already
+  c = new KConfigPropagator::ChangeConfig;
+  c->file = "kmailrc";
+  c->group = "AccountWizard";
+  c->name = "ShowOnStartup";
+  c->value = "false";
+  changes.append( c );
+
+  CreateDisconnectedImapAccount *account =
+    new CreateDisconnectedImapAccount( i18n("Scalix Server") );
+
+  account->setServer( ScalixConfig::self()->server() );
+  account->setUser( ScalixConfig::self()->user() );
+  account->setPassword( ScalixConfig::self()->password() );
+  account->setRealName( ScalixConfig::self()->realName() );
+  account->setEmail( ScalixConfig::self()->eMail() );
+  if ( ScalixConfig::self()->security() == ScalixConfig::None )
+    account->setPort( 143 );
+  else
+    account->setPort( 993 );
+
+  account->enableSieve( false );
+  account->enableSavePassword( ScalixConfig::self()->savePassword() );
+
+  switch ( ScalixConfig::self()->security() ) {
+    case ScalixConfig::None:
+      account->setEncryption( CreateImapAccount::None );
+      break;
+    case ScalixConfig::TLS:
+      account->setEncryption( CreateImapAccount::TLS );
+      break;
+    case ScalixConfig::SSL:
+      account->setEncryption( CreateImapAccount::SSL );
+      break;
+  }
+
+  switch ( ScalixConfig::self()->authentication() ) {
+    case ScalixConfig::Password:
+      account->setAuthentication( CreateImapAccount::NONE );
+      break;
+    case ScalixConfig::NTLM_SPA:
+      account->setAuthentication( CreateImapAccount::NTLM_SPA );
+      break;
+    case ScalixConfig::GSSAPI:
+      account->setAuthentication( CreateImapAccount::GSSAPI );
+      break;
+    case ScalixConfig::DIGEST_MD5:
+      account->setAuthentication( CreateImapAccount::DIGEST_MD5 );
+      break;
+    case ScalixConfig::CRAM_MD5:
+      account->setAuthentication( CreateImapAccount::CRAM_MD5 );
+      break;
+  }
+
+  account->setAuthenticationSend( CreateDisconnectedImapAccount::PLAIN );
+  account->setSmtpPort( 465 );
+  account->setDefaultDomain( ScalixConfig::self()->server() );
+  account->enableLocalSubscription( false );
+  account->setGroupwareType( CreateDisconnectedImapAccount::GroupwareScalix );
+
+  account->setCustomWriter( new ScalixCustomWriter );
+
+  changes.append( account );
+}
Index: wizards/kmailchanges.h
===================================================================
--- wizards/kmailchanges.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ wizards/kmailchanges.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,6 +46,7 @@
     void setUser( const QString & );
     void setPassword( const QString & );
     void setRealName( const QString & );
+    void setPort( int );
     /**
       Set email. Default is "user@server".
     */
@@ -58,11 +59,11 @@
     void enableSavePassword( bool );
 
     enum Encryption { None, SSL, TLS };
+    enum Authentication { NONE, PLAIN, LOGIN, NTLM_SPA, GSSAPI, DIGEST_MD5, CRAM_MD5 };
 
     void setEncryption( Encryption );
+    void setAuthentication( Authentication );
 
-    enum Authentication { PLAIN, LOGIN };
-
     void setAuthenticationSend( Authentication );
 
     void setSmtpPort( int );
@@ -86,6 +87,7 @@
     QString mUser;
     QString mPassword;
     QString mRealName;
+    int mPort;
     QString mEmail;
     QString mDefaultDomain;
 
@@ -94,6 +96,7 @@
     bool mEnableSavePassword;
 
     Encryption mEncryption;
+    Authentication mAuthentication;
     Authentication mAuthenticationSend;
 
     int mSmtpPort;
@@ -110,13 +113,22 @@
 class CreateDisconnectedImapAccount : public CreateImapAccount
 {
   public:
+    enum GroupwareType
+    {
+      GroupwareNone,
+      GroupwareKolab,
+      GroupwareScalix
+    };
+
     CreateDisconnectedImapAccount( const QString &accountName );
     virtual void apply();
 
     void enableLocalSubscription( bool b ) { mLocalSubscription = b; }
+    void setGroupwareType( GroupwareType type ) { mGroupwareType = type; }
 
   private:
     bool mLocalSubscription;
+    GroupwareType mGroupwareType;
 };
 
 class CreateOnlineImapAccount : public CreateImapAccount
Index: wizards/kolabwizard.cpp
===================================================================
--- wizards/kolabwizard.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ wizards/kolabwizard.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -297,13 +297,6 @@
   mKolab2 = new QRadioButton( i18n ( "Kolab 2" ), bg );
   topLayout->addMultiCellWidget( bg, 6, 6, 0, 1 );
 
-  //DF: I don't see the point in showing the user those pages.
-  //They are very 'internal' and of no use to anyone other than developers.
-  //(This is even more true for the rules page. The changes page is sort of OK)
-
-  setupRulesPage();
-  setupChangesPage();
-
   setInitialSize( QSize( 600, 300 ) );
 }
 
Index: wizards/scalixwizard.h
===================================================================
--- wizards/scalixwizard.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixwizard.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2004 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+#ifndef SCALIXWIZARD_H
+#define SCALIXWIZARD_H
+
+#include <kconfigwizard.h>
+#include <kdepimmacros.h>
+
+class KComboBox;
+class KLineEdit;
+class QCheckBox;
+
+class KDE_EXPORT ScalixWizard : public KConfigWizard
+{
+  public:
+    ScalixWizard();
+    ~ScalixWizard();
+
+    QString validate();
+    void usrReadConfig();
+    void usrWriteConfig();
+
+  private:
+    KLineEdit *mServerEdit;
+    KLineEdit *mUserEdit;
+    KLineEdit *mEMailEdit;
+    KLineEdit *mRealNameEdit;
+    KLineEdit *mPasswordEdit;
+    QCheckBox *mSavePasswordCheck;
+    KComboBox *mSecurity;
+    KComboBox *mAuthentication;
+};
+
+#endif
Index: wizards/kmailchanges.cpp
===================================================================
--- wizards/kmailchanges.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ wizards/kmailchanges.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -44,8 +44,8 @@
 
 CreateImapAccount::CreateImapAccount( const QString &accountName, const QString &title )
   : KConfigPropagator::Change( title ),
-    mAccountName( accountName ), mEnableSieve( false ), mEnableSavePassword( true ),
-    mEncryption( None ), mAuthenticationSend( PLAIN ), mSmtpPort( 25 ),
+    mAccountName( accountName ), mPort( 993 ), mEnableSieve( false ), mEnableSavePassword( true ),
+    mEncryption( None ), mAuthentication( NONE ), mAuthenticationSend( PLAIN ), mSmtpPort( 25 ),
     mExistingAccountId( -1 ), mExistingTransportId( -1 ),
     mCustomWriter( 0 )
 {
@@ -76,6 +76,11 @@
   mRealName = s;
 }
 
+void CreateImapAccount::setPort( int port )
+{
+  mPort = port;
+}
+
 void CreateImapAccount::setEmail( const QString &s )
 {
   mEmail = s;
@@ -102,6 +107,12 @@
   mEncryption = e;
 }
 
+void CreateImapAccount::setAuthentication(
+  CreateImapAccount::Authentication a )
+{
+  mAuthentication = a;
+}
+
 void CreateImapAccount::setDefaultDomain(const QString &d)
 {
   mDefaultDomain = d;
@@ -137,7 +148,7 @@
 
 CreateDisconnectedImapAccount::CreateDisconnectedImapAccount(const QString & accountName) :
     CreateImapAccount( accountName, i18n("Create Disconnected IMAP Account for KMail") ),
-    mLocalSubscription( false )
+    mLocalSubscription( false ), mGroupwareType( GroupwareKolab )
 {
 }
 
@@ -175,11 +186,37 @@
   }
   c.writeEntry( "Id", uid );
   c.writeEntry( "Type", "cachedimap");
-  c.writeEntry( "auth", "*");
+
+  switch ( mAuthentication ) {
+    case NONE:
+      c.writeEntry( "auth", "*" );
+      break;
+    case PLAIN:
+      c.writeEntry( "auth", "PLAIN" );
+      break;
+    case LOGIN:
+      c.writeEntry( "auth", "LOGIN" );
+      break;
+    case NTLM_SPA:
+      c.writeEntry( "auth", "NTLM" );
+      break;
+    case GSSAPI:
+      c.writeEntry( "auth", "GSSAPI" );
+      break;
+    case DIGEST_MD5:
+      c.writeEntry( "auth", "DIGEST-MD5" );
+      break;
+    case CRAM_MD5:
+      c.writeEntry( "auth", "CRAM-MD5" );
+      break;
+  }
+
   c.writeEntry( "Name", mAccountName );
   c.writeEntry( "host", mServer );
-  c.writeEntry( "port", "993" );
+  c.writeEntry( "port", mPort );
 
+  c.writeEntry( "groupwareType", mGroupwareType );
+
   // in case the user wants to get rid of some groupware folders
   c.writeEntry( "locally-subscribed-folders", mLocalSubscription );
 
Index: wizards/Makefile.am
===================================================================
--- wizards/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ wizards/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,16 +5,16 @@
            -I$(top_srcdir)/knotes \
            -I$(top_srcdir)/certmanager/lib \
            -I$(top_builddir)/kresources/groupwise \
-	   -I$(top_builddir)/kresources/lib \
+           -I$(top_builddir)/kresources/lib \
            -I$(top_srcdir)/kresources/lib \
            $(all_includes)
 
 bin_PROGRAMS = groupwarewizard egroupwarewizard sloxwizard kolabwizard \
-               groupwisewizard exchangewizard
+               groupwisewizard exchangewizard scalixwizard
 
 kde_module_LTLIBRARIES = libegroupwarewizard.la libsloxwizard.la \
                          libkolabwizard.la libgroupwisewizard.la \
-                         libexchangewizard.la
+                         libexchangewizard.la libscalixwizard.la
 
 
 groupwarewizard_LDFLAGS = $(all_libraries) $(KDE_RPATH)
@@ -91,11 +91,25 @@
 exchangewizard_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 exchangewizard_SOURCES = exchangemain.cpp
 
+# Scalix
+libscalixwizard_la_LDFLAGS = -avoid-version -no-undefined $(all_libraries)
+libscalixwizard_la_LIBADD = $(top_builddir)/kresources/scalix/kcal/libkcalscalix.la \
+                           $(top_builddir)/kresources/scalix/kabc/libkabcscalix.la \
+                           $(top_builddir)/libkcal/libkcal.la \
+                           $(top_builddir)/libkdepim/libkdepim.la \
+                           $(top_builddir)/libkpimidentities/libkpimidentities.la
 
+libscalixwizard_la_SOURCES = scalixwizard.cpp kmailchanges.cpp scalixconfig.kcfgc \
+  scalixkmailchanges.cpp
+
+scalixwizard_LDADD = libscalixwizard.la $(LIB_KDEUI)
+scalixwizard_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+scalixwizard_SOURCES = scalixmain.cpp
+
 noinst_HEADERS = egroupwarewizard.h kmailchanges.h kolabwizard.h sloxwizard.h \
                  groupwisewizard.h exchangewizard.h
 
-kde_kcfg_DATA = egroupware.kcfg slox.kcfg kolab.kcfg groupwise.kcfg
+kde_kcfg_DATA = egroupware.kcfg slox.kcfg kolab.kcfg groupwise.kcfg scalix.kcfg
 
 messages: rc.cpp
 	$(XGETTEXT) *.cpp -o $(podir)/kdepimwizards.pot
Index: wizards/scalixmain.cpp
===================================================================
--- wizards/scalixmain.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ wizards/scalixmain.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,57 @@
+/*
+    This file is part of kdepim.
+
+    Copyright (c) 2004 Cornelius Schumacher <schumacher@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "scalixwizard.h"
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <kcmdlineargs.h>
+#include <kglobal.h>
+#include <klocale.h>
+
+static const KCmdLineOptions options[] =
+{
+  {"verbose", "Verbose output", 0},
+  KCmdLineLastOption
+};
+
+int main(int argc,char **argv)
+{
+  KLocale::setMainCatalogue( "kdepimwizards" );
+
+  KAboutData aboutData( "scalixwizard", I18N_NOOP( "Scalix Configuration Wizard" ), "0.1" );
+  KCmdLineArgs::init( argc, argv, &aboutData );
+  KCmdLineArgs::addCmdLineOptions( options );
+
+  KApplication app;
+
+  KGlobal::locale()->insertCatalogue( "libkdepim" );
+
+  KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+  bool verbose = false;
+  if ( args->isSet( "verbose" ) ) verbose = true;
+
+  ScalixWizard wizard;
+
+  wizard.exec();
+}
Index: kresources/scalix/kabc/contact.h
===================================================================
--- kresources/scalix/kabc/contact.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/contact.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,37 @@
+/*
+ *   This file is part of the scalix resource.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef SCALIX_CONTACT_H
+#define SCALIX_CONTACT_H
+
+#include <kabc/addressee.h>
+
+namespace Scalix {
+
+class Contact
+{
+  public:
+    static QString toXml( const KABC::Addressee &addr );
+    static KABC::Addressee fromXml( const QString &xml );
+};
+
+}
+
+#endif
Index: kresources/scalix/kabc/resourcescalix.h
===================================================================
--- kresources/scalix/kabc/resourcescalix.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/resourcescalix.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,170 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef KABC_RESOURCESCALIX_H
+#define KABC_RESOURCESCALIX_H
+
+#include <libkdepim/resourceabc.h>
+#include <dcopobject.h>
+#include "../shared/resourcescalixbase.h"
+#include "../shared/subresource.h"
+#include <kmail/kmailicalIface.h>
+#include <kdepimmacros.h>
+
+namespace KABC {
+
+  class FormatPlugin;
+
+/**
+ * This class implements a KAddressBook resource that keeps its
+ * addresses in an Scalix folder in KMail (or other conforming email
+ * clients).
+ */
+class KDE_EXPORT ResourceScalix : public KPIM::ResourceABC,
+                     public Scalix::ResourceScalixBase
+{
+  Q_OBJECT
+
+public:
+  /**
+   * Constructor
+   */
+  ResourceScalix( const KConfig* );
+
+  /**
+   * Destructor.
+   */
+  virtual ~ResourceScalix();
+
+  /**
+   * Open the contacts list
+   */
+  virtual bool doOpen();
+
+  /**
+   * Request a ticket, you have to pass through save() to
+   * allow locking.
+   */
+  virtual Ticket *requestSaveTicket();
+
+  /**
+     Releases the ticket previousely requested with requestSaveTicket().
+     The resource has to remove its locks in this function.
+  */
+  virtual void releaseSaveTicket( Ticket* );
+
+  /**
+  * Load all addressees to the addressbook
+   */
+  virtual bool load();
+
+  /**
+  * Save all addressees to the addressbook.
+   *
+   * @param ticket The ticket you get by requestSaveTicket()
+   */
+  virtual bool save( Ticket *ticket );
+
+  /**
+     Insert an addressee into the resource.
+  */
+  virtual void insertAddressee( const Addressee& );
+
+  /**
+  * Removes a addressee from resource. This method is mainly
+   * used by record-based resources like LDAP or SQL.
+   */
+  virtual void removeAddressee( const Addressee& addr );
+
+  // Listen to KMail changes in the amount of sub resources
+  void fromKMailAddSubresource( const QString& type, const QString& id,
+                                const QString& label, bool writable );
+  void fromKMailDelSubresource( const QString& type, const QString& id );
+
+  bool fromKMailAddIncidence( const QString& type, const QString& resource,
+                              Q_UINT32 sernum, int format, const QString& contact );
+  void fromKMailDelIncidence( const QString& type, const QString& resource,
+                              const QString& contact );
+  void fromKMailRefresh( const QString& type, const QString& resource );
+
+  void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                 const QString& type,
+                                 const QString& folder );
+
+  /// Return the list of subresources.
+  QStringList subresources() const;
+
+  /// Is this subresource active?
+  bool subresourceActive( const QString& ) const;
+  /// Is this subresource writabel?
+  bool subresourceWritable( const QString& ) const;
+
+  virtual void setSubresourceActive( const QString &, bool );
+
+  /// Completion weight for a given subresource
+  virtual int subresourceCompletionWeight( const QString& ) const;
+
+  /// Label for a given subresource
+  virtual QString subresourceLabel( const QString& ) const;
+
+  /// Set completion weight for a given subresource
+  virtual void setSubresourceCompletionWeight( const QString&, int );
+
+  /// Give the uidmap. Used for ordered searching
+  QMap<QString, QString> uidToResourceMap() const;
+
+protected:
+  bool kmailUpdateAddressee( const Addressee& );
+
+  void doClose();
+
+  void loadSubResourceConfig( KConfig& config, const QString& name,
+                              const QString& label, bool writable );
+  bool loadSubResource( const QString& subResource );
+  bool loadSubResourceHelper( const QString& subResource, const char* mimetype, KMailICalIface::StorageFormat format );
+  QString loadContact( const QString& contactData, const QString& subResource,
+                       Q_UINT32 sernum, const KMailICalIface::StorageFormat format );
+
+  QString configFile() const {
+    return Scalix::ResourceScalixBase::configFile( "kabc" );
+  }
+
+  // The list of subresources
+  Scalix::ResourceMap mSubResources;
+  QString mCachedSubresource;
+  bool mLocked;
+};
+
+}
+
+#endif // KABC_RESOURCESCALIX_H
Index: kresources/scalix/kabc/Makefile.am
===================================================================
--- kresources/scalix/kabc/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,27 @@
+METASOURCES = AUTO
+
+INCLUDES = -I$(top_srcdir)/kresources/scalix/shared -I$(top_srcdir) $(all_includes)
+
+# The scalix wizard links to this library too
+lib_LTLIBRARIES = libkabcscalix.la
+
+libkabcscalix_la_SOURCES = resourcescalix.cpp contact.cpp
+libkabcscalix_la_LDFLAGS = $(all_libraries) -no-undefined
+libkabcscalix_la_LIBADD =  \
+	$(top_builddir)/kresources/scalix/shared/libresourcescalixshared.la \
+	-lkresources -lkabc
+
+kde_module_LTLIBRARIES = kabc_scalix.la
+
+noinst_HEADERS = resourcescalix.h
+
+kabc_scalix_la_SOURCES = resourcescalix_plugin.cpp
+kabc_scalix_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
+kabc_scalix_la_LIBADD = libkabcscalix.la
+
+servicedir = $(kde_servicesdir)/kresources/kabc
+service_DATA = scalix.desktop
+
+install-data-local: $(srcdir)/../uninstall.desktop
+	$(mkinstalldirs) $(DESTDIR)$(servicedir)
+	$(INSTALL_DATA) $(srcdir)/../uninstall.desktop $(DESTDIR)$(servicedir)/imap.desktop
Index: kresources/scalix/kabc/resourcescalix_plugin.cpp
===================================================================
--- kresources/scalix/kabc/resourcescalix_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/resourcescalix_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+using namespace Scalix;
+
+class ScalixFactory : public KRES::PluginFactoryBase
+{
+  public:
+    KRES::Resource *resource( const KConfig *config )
+    {
+      return new KABC::ResourceScalix( config );
+    }
+
+    KRES::ConfigWidget *configWidget( QWidget* )
+    {
+      return 0;
+    }
+};
+
+K_EXPORT_COMPONENT_FACTORY(kabc_scalix,ScalixFactory)
+
Index: kresources/scalix/kabc/scalix.desktop
===================================================================
--- kresources/scalix/kabc/scalix.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,13 @@
+[Desktop Entry]
+Encoding=UTF-8
+Name=Addressbook on Scalix Server via KMail
+Name[bg]=–ê–¥—Ä–µ—Å–Ω–∏–∫ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ Scalix —á—Ä–µ–∑ KMail
+Name[da]=Adressebog p√• Scalix-server via KMail
+Name[el]=ŒíŒπŒ≤ŒªŒØŒø Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ œÉŒµ ŒµŒæœÖœÄŒ∑œÅŒµœÑŒ∑œÑŒÆ Scalix ŒºŒ≠œÉœâ œÑŒøœÖ KMail
+Name[sk]=Adres√°r na Scalix serveri pomocou KMail
+Name[sv]=Adressbok p√• Scalix-server via Kmail
+X-KDE-Library=kabc_scalix
+Type=Service
+ServiceTypes=KResources/Plugin
+X-KDE-ResourceFamily=contact
+X-KDE-ResourceType=scalix
Index: kresources/scalix/kabc/contact.cpp
===================================================================
--- kresources/scalix/kabc/contact.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/contact.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,377 @@
+/*
+ *   This file is part of the scalix resource.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qdom.h>
+
+#include <libkdepim/distributionlist.h>
+#include <kstaticdeleter.h>
+
+#include "contact.h"
+
+using namespace Scalix;
+
+static QMap<QString, QString> *s_distListMap = 0;
+static KStaticDeleter< QMap<QString, QString> > sd;
+
+static QString custom( const QString &name, const KABC::Addressee &addr, const QString &defaultValue = QString() )
+{
+  const QString value = addr.custom( "Scalix", name );
+  if ( value.isEmpty() )
+    return defaultValue;
+  else
+    return value;
+}
+
+static void setCustom( const QString &name, const QString &value, KABC::Addressee &addr )
+{
+  addr.insertCustom( "Scalix", name, value );
+}
+
+QString Contact::toXml( const KABC::Addressee &addr )
+{
+  /**
+   * Handle distribution lists.
+   */
+  if ( KPIM::DistributionList::isDistributionList( addr ) ) {
+    if ( s_distListMap )
+      return (*s_distListMap)[ addr.uid() ];
+    else
+      return QString();
+  }
+
+  /**
+   * Handle normal contacts.
+   */
+  QString xml;
+  xml += "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
+  xml += "<contact>\n";
+
+  xml += "<direct_ref>" + addr.uid() + "</direct_ref>\n";
+  xml += "<sensitivity>" + custom( "sensitivity", addr, "0" ) + "</sensitivity>\n";
+
+  xml += "<message_class>IPM.Contact</message_class>\n";
+  xml += "<is_recurring>" + custom( "is_recurring", addr, "false" ) + "</is_recurring>\n";
+  xml += "<reminder_set>" + custom( "reminder_set", addr, "false" ) + "</reminder_set>\n";
+  xml += "<send_rich_info>" + custom( "send_rich_info", addr, "false" ) + "</send_rich_info>\n";
+  xml += "<subject>" + addr.formattedName() + "</subject>\n";
+  xml += "<last_modification_time>" + addr.revision().toString( Qt::ISODate ) + "</last_modification_time>\n";
+
+  xml += "<display_name_prefix>" + addr.prefix() + "</display_name_prefix>\n";
+  xml += "<first_name>" + addr.givenName() + "</first_name>\n";
+  xml += "<middle_name>" + addr.additionalName() + "</middle_name>\n";
+  xml += "<last_name>" + addr.familyName() + "</last_name>\n";
+  xml += "<suffix>" + addr.suffix() + "</suffix>\n";
+  xml += "<display_name>" + addr.assembledName() + "</display_name>\n";
+  xml += "<file_as>" + addr.formattedName() + "</file_as>\n";
+  xml += "<nickname>" + addr.nickName() + "</nickname>\n";
+
+  xml += "<web_page_address>" + addr.url().url() + "</web_page_address>\n";
+  xml += "<company_name>" + addr.organization() + "</company_name>\n";
+  xml += "<job_title>" + addr.title() + "</job_title>\n";
+
+  QStringList emails = addr.emails();
+  for ( uint i = 0; i < 3; ++i ) {
+    QString type, address, comment, display;
+
+    if ( i < emails.count() ) {
+      type = "SMTP";
+      address = emails[ i ];
+
+      /**
+       * If the contact was created by kontact use the email address as
+       * display name and the formatted name as comment, otherwise we use
+       * the values from the server.
+       */
+      if ( custom( "comes_from_scalix", addr ) != "true" ) {
+        comment = addr.formattedName();
+        display = emails[ i ];
+      } else {
+        comment = custom( QString( "email%1_address_with_comment" ).arg( i + 1 ), addr );
+        display = custom( QString( "email%1_display_name" ).arg( i + 1 ), addr );
+      }
+    }
+
+    xml += QString( "<email%1_address_type>" ).arg( i + 1 ) + type +
+           QString( "</email%1_address_type>" ).arg( i + 1 ) +"\n";
+    xml += QString( "<email%1_address>" ).arg( i + 1 ) + address +
+           QString( "</email%1_address>" ).arg( i + 1 ) +"\n";
+    xml += QString( "<email%1_address_with_comment>" ).arg( i + 1 ) + comment +
+           QString( "</email%1_address_with_comment>" ).arg( i + 1 ) + "\n";
+    xml += QString( "<email%1_display_name>" ).arg( i + 1 ) + display +
+           QString( "</email%1_display_name>" ).arg( i + 1 ) + "\n";
+  }
+
+  KABC::PhoneNumber phone = addr.phoneNumber( KABC::PhoneNumber::Home );
+  xml += "<home_phone_number>" + phone.number() + "</home_phone_number>\n";
+
+  phone = addr.phoneNumber( KABC::PhoneNumber::Work );
+  xml += "<work_phone_number>" + phone.number() + "</work_phone_number>\n";
+
+  phone = addr.phoneNumber( KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax );
+  xml += "<work_fax_number>" + phone.number() + "</work_fax_number>\n";
+
+  phone = addr.phoneNumber( KABC::PhoneNumber::Cell );
+  xml += "<mobile_phone_number>" + phone.number() + "</mobile_phone_number>\n";
+
+  const KABC::Address workAddress = addr.address( KABC::Address::Work );
+  xml += "<work_address_street>" + workAddress.street() + "</work_address_street>\n";
+  xml += "<work_address_zip>" + workAddress.postalCode() + "</work_address_zip>\n";
+  xml += "<work_address_city>" + workAddress.locality() + "</work_address_city>\n";
+  xml += "<work_address_state>" + workAddress.region() + "</work_address_state>\n";
+  xml += "<work_address_country>" + workAddress.country() + "</work_address_country>\n";
+
+  const KABC::Address homeAddress = addr.address( KABC::Address::Home );
+  xml += "<home_address_street>" + homeAddress.street() + "</home_address_street>\n";
+  xml += "<home_address_zip>" + homeAddress.postalCode() + "</home_address_zip>\n";
+  xml += "<home_address_city>" + homeAddress.locality() + "</home_address_city>\n";
+  xml += "<home_address_state>" + homeAddress.region() + "</home_address_state>\n";
+  xml += "<home_address_country>" + homeAddress.country() + "</home_address_country>\n";
+
+  const KABC::Address otherAddress = addr.address( KABC::Address::Dom );
+  xml += "<other_address_street>" + otherAddress.street() + "</other_address_street>\n";
+  xml += "<other_address_zip>" + otherAddress.postalCode() + "</other_address_zip>\n";
+  xml += "<other_address_city>" + otherAddress.locality() + "</other_address_city>\n";
+  xml += "<other_address_state>" + otherAddress.region() + "</other_address_state>\n";
+  xml += "<other_address_country>" + otherAddress.country() + "</other_address_country>\n";
+
+  if ( homeAddress.type() & KABC::Address::Pref )
+    xml += "<selected_mailing_address>1</selected_mailing_address>\n";
+  else if ( workAddress.type() & KABC::Address::Pref )
+    xml += "<selected_mailing_address>2</selected_mailing_address>\n";
+  else if ( otherAddress.type() & KABC::Address::Pref )
+    xml += "<selected_mailing_address>3</selected_mailing_address>\n";
+
+  xml += "<im_address>" + addr.custom( "KADDRESSBOOK", "X-IMAddress" ) + "</im_address>\n";
+  xml += "<manager>" + addr.custom( "KADDRESSBOOK", "X-ManagersName" ) + "</manager>\n";
+  xml += "<department>" + addr.custom( "KADDRESSBOOK", "X-Department" ) + "</department>\n";
+  xml += "<assistant>" + addr.custom( "KADDRESSBOOK", "X-AssistantsName" ) + "</assistant>\n";
+  xml += "<profession>" + addr.custom( "KADDRESSBOOK", "X-Profession" ) + "</profession>\n";
+  xml += "<office_location>" + addr.custom( "KADDRESSBOOK", "X-Office" ) + "</office_location>\n";
+  xml += "<spouse>" + addr.custom( "KADDRESSBOOK", "X-SpousesName" ) + "</spouse>\n";
+
+  xml += "<bday>" + addr.birthday().toString( Qt::ISODate ) + "</bday>\n";
+  xml += "<anniversary>" + addr.custom( "KADDRESSBOOK", "X-Anniversary" ) + "</anniversary>\n";
+
+  xml += "<mapi_charset>" + custom( "mapi_charset", addr, "UTF8" ) + "</mapi_charset>";
+
+  xml += "</contact>\n";
+
+  return xml;
+}
+
+KABC::Addressee Contact::fromXml( const QString &xml )
+{
+  QDomDocument document;
+
+  QString errorMsg;
+  int errorLine, errorColumn;
+  if ( !document.setContent( xml, true, &errorMsg, &errorLine, &errorColumn ) ) {
+    qDebug( "Error parsing XML in Scalix::Contact::fromXml: %s (%d,%d)", errorMsg.latin1(), errorLine, errorColumn );
+    return KABC::Addressee();
+  }
+
+  QDomElement contactElement = document.documentElement();
+  if ( contactElement.tagName() != "contact" ) {
+    if ( contactElement.tagName() == "distlist" ) {
+      const QDomNodeList names = contactElement.elementsByTagName( "display_name" );
+      const QString listName = ( names.count() == 1 ? names.item( 0 ).toElement().text() : "Scalix Dummy List" );
+
+      /**
+       * As we can't provide distribution list functionality we store the entry
+       * here and return it on save.
+       */
+      KPIM::DistributionList list;
+      list.setName( listName );
+
+      if ( !s_distListMap )
+        sd.setObject( s_distListMap, new QMap<QString, QString>() );
+
+      s_distListMap->insert( list.uid(), xml );
+
+      return list;
+    } else {
+      qDebug( "Error interpreting XML in Scalix::Contact::fromXml: no 'contact' or 'distlist' tag found" );
+      return KABC::Addressee();
+    }
+  }
+
+  QString emails[ 3 ];
+  KABC::Address homeAddress( KABC::Address::Home );
+  KABC::Address workAddress( KABC::Address::Work );
+  KABC::Address otherAddress( KABC::Address::Dom );
+
+  KABC::Addressee addr;
+  setCustom( "comes_from_scalix", "true", addr );
+
+  QDomNode node = contactElement.firstChild();
+  while ( !node.isNull() ) {
+    QDomElement element = node.toElement();
+    if ( !element.isNull() ) {
+      if ( element.tagName() == "direct_ref" )
+        addr.setUid( element.text() );
+      else if ( element.tagName() == "sensitivity" )
+        setCustom( "sensitivity", element.text(), addr );
+      else if ( element.tagName() == "is_recurring" )
+        setCustom( "is_recurring", element.text(), addr );
+      else if ( element.tagName() == "reminder_set" )
+        setCustom( "reminder_set", element.text(), addr );
+      else if ( element.tagName() == "send_rich_info" )
+        setCustom( "send_rich_info", element.text(), addr );
+      else if ( element.tagName() == "last_modification_time" )
+        addr.setRevision( QDateTime::fromString( element.text(), Qt::ISODate ) );
+
+      // name
+      else if ( element.tagName() == "display_name_prefix" )
+        addr.setPrefix( element.text() );
+      else if ( element.tagName() == "first_name" )
+        addr.setGivenName( element.text() );
+      else if ( element.tagName() == "middle_name" )
+        addr.setAdditionalName( element.text() );
+      else if ( element.tagName() == "last_name" )
+        addr.setFamilyName( element.text() );
+      else if ( element.tagName() == "suffix" )
+        addr.setSuffix( element.text() );
+      else if ( element.tagName() == "file_as" )
+        addr.setFormattedName( element.text() );
+      else if ( element.tagName() == "nickname" )
+        addr.setNickName( element.text() );
+
+      // job
+      else if ( element.tagName() == "web_page_address" )
+        addr.setUrl( element.text() );
+      else if ( element.tagName() == "company_name" )
+        addr.setOrganization( element.text() );
+      else if ( element.tagName() == "job_title" )
+        addr.setTitle( element.text() );
+
+      // emails
+      else if ( element.tagName().startsWith( "email" ) ) {
+        if ( element.tagName() == "email1_address" )
+          emails[ 0 ] = element.text();
+        else if ( element.tagName() == "email2_address" )
+          emails[ 1 ] = element.text();
+        else if ( element.tagName() == "email3_address" )
+          emails[ 2 ] = element.text();
+        else
+          setCustom( element.tagName(), element.text(), addr );
+      }
+
+      // phone numbers
+      else if ( element.tagName() == "home_phone_number" )
+        addr.insertPhoneNumber( KABC::PhoneNumber( element.text(), KABC::PhoneNumber::Home ) );
+      else if ( element.tagName() == "work_phone_number" )
+        addr.insertPhoneNumber( KABC::PhoneNumber( element.text(), KABC::PhoneNumber::Work ) );
+      else if ( element.tagName() == "work_fax_number" )
+        addr.insertPhoneNumber( KABC::PhoneNumber( element.text(), KABC::PhoneNumber::Work | KABC::PhoneNumber::Fax ) );
+      else if ( element.tagName() == "mobile_phone_number" )
+        addr.insertPhoneNumber( KABC::PhoneNumber( element.text(), KABC::PhoneNumber::Cell ) );
+
+      // address (work)
+      else if ( element.tagName() == "work_address_street" )
+        workAddress.setStreet( element.text() );
+      else if ( element.tagName() == "work_address_zip" )
+        workAddress.setPostalCode( element.text() );
+      else if ( element.tagName() == "work_address_city" )
+        workAddress.setLocality( element.text() );
+      else if ( element.tagName() == "work_address_state" )
+        workAddress.setRegion( element.text() );
+      else if ( element.tagName() == "work_address_country" )
+        workAddress.setCountry( element.text() );
+
+      // address (home)
+      else if ( element.tagName() == "home_address_street" )
+        homeAddress.setStreet( element.text() );
+      else if ( element.tagName() == "home_address_zip" )
+        homeAddress.setPostalCode( element.text() );
+      else if ( element.tagName() == "home_address_city" )
+        homeAddress.setLocality( element.text() );
+      else if ( element.tagName() == "home_address_state" )
+        homeAddress.setRegion( element.text() );
+      else if ( element.tagName() == "home_address_country" )
+        homeAddress.setCountry( element.text() );
+
+      // address (other)
+      else if ( element.tagName() == "other_address_street" )
+        otherAddress.setStreet( element.text() );
+      else if ( element.tagName() == "other_address_zip" )
+        otherAddress.setPostalCode( element.text() );
+      else if ( element.tagName() == "other_address_city" )
+        otherAddress.setLocality( element.text() );
+      else if ( element.tagName() == "other_address_state" )
+        otherAddress.setRegion( element.text() );
+      else if ( element.tagName() == "other_address_country" )
+        otherAddress.setCountry( element.text() );
+
+      else if ( element.tagName() == "selected_mailing_address" )
+        switch ( element.text().toInt() ) {
+          case 1:
+            homeAddress.setType( homeAddress.type() | KABC::Address::Pref );
+            break;
+          case 2:
+            workAddress.setType( workAddress.type() | KABC::Address::Pref );
+            break;
+          case 3:
+            otherAddress.setType( otherAddress.type() | KABC::Address::Pref );
+            break;
+          default:
+            Q_ASSERT( !"Unknown selected_mailing_address enum" );
+            break;
+        }
+
+      // misc
+      else if ( element.tagName() == "im_address" )
+        addr.insertCustom( "KADDRESSBOOK", "X-IMAddress", element.text() );
+      else if ( element.tagName() == "manager" )
+        addr.insertCustom( "KADDRESSBOOK", "X-ManagersName", element.text() );
+      else if ( element.tagName() == "department" )
+        addr.insertCustom( "KADDRESSBOOK", "X-Department", element.text() );
+      else if ( element.tagName() == "assistant" )
+        addr.insertCustom( "KADDRESSBOOK", "X-AssistantsName", element.text() );
+      else if ( element.tagName() == "profession" )
+        addr.insertCustom( "KADDRESSBOOK", "X-Profession", element.text() );
+      else if ( element.tagName() == "office_location" )
+        addr.insertCustom( "KADDRESSBOOK", "X-Office", element.text() );
+      else if ( element.tagName() == "spouse" )
+        addr.insertCustom( "KADDRESSBOOK", "X-SpousesName", element.text() );
+
+      else if ( element.tagName() == "bday" )
+        addr.setBirthday( QDateTime::fromString( element.text(), Qt::ISODate ) );
+      else if ( element.tagName() == "anniversary" )
+        addr.insertCustom( "KADDRESSBOOK", "X-Anniversary", element.text() );
+      else
+        setCustom( element.tagName(), element.text(), addr );
+    }
+
+    node = node.nextSibling();
+  }
+
+  for ( int i = 0; i < 3; ++i )
+    if ( !emails[ i ].isEmpty() )
+      addr.insertEmail( emails[ i ] );
+
+  if ( !homeAddress.isEmpty() )
+    addr.insertAddress( homeAddress );
+  if ( !workAddress.isEmpty() )
+    addr.insertAddress( workAddress );
+  if ( !otherAddress.isEmpty() )
+    addr.insertAddress( otherAddress );
+
+  return addr;
+}
Index: kresources/scalix/kabc/resourcescalix.cpp
===================================================================
--- kresources/scalix/kabc/resourcescalix.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kabc/resourcescalix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,628 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+#include <kdebug.h>
+#include <kglobal.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+#include <ktempfile.h>
+#include <kio/observer.h>
+#include <kio/uiserver_stub.h>
+#include <kmainwindow.h>
+#include <kapplication.h>
+#include <dcopclient.h>
+
+#include <qobject.h>
+#include <qtimer.h>
+#include <qstring.h>
+#include <qfile.h>
+#include <qapplication.h>
+
+#include <assert.h>
+
+#include "contact.h"
+
+using namespace Scalix;
+
+class ScalixFactory : public KRES::PluginFactoryBase
+{
+  public:
+    KRES::Resource *resource( const KConfig *config )
+    {
+      return new KABC::ResourceScalix( config );
+    }
+
+    KRES::ConfigWidget *configWidget( QWidget* )
+    {
+      return 0;
+    }
+};
+
+K_EXPORT_COMPONENT_FACTORY(kabc_scalix,ScalixFactory)
+
+static const char* s_kmailContentsType = "Contact";
+static const char* s_attachmentMimeTypeContact = "application/x-vnd.kolab.contact";
+static const char* s_attachmentMimeTypeDistList = "application/x-vnd.kolab.contact.distlist";
+static const char* s_inlineMimeType = "application/scalix-properties";
+
+KABC::ResourceScalix::ResourceScalix( const KConfig *config )
+  : KPIM::ResourceABC( config ),
+    Scalix::ResourceScalixBase( "ResourceScalix-KABC" ),
+    mCachedSubresource( QString::null ), mLocked( false )
+{
+  setType( "scalix" );
+}
+
+KABC::ResourceScalix::~ResourceScalix()
+{
+  // The resource is deleted on exit (StdAddressBook's KStaticDeleter),
+  // and it wasn't closed before that, so close here to save the config.
+  if ( isOpen() ) {
+    close();
+  }
+}
+
+void KABC::ResourceScalix::loadSubResourceConfig( KConfig& config,
+                                                 const QString& name,
+                                                 const QString& label,
+                                                 bool writable )
+{
+  KConfigGroup group( &config, name );
+  bool active = group.readBoolEntry( "Active", true );
+  int completionWeight = group.readNumEntry( "CompletionWeight", 80 );
+  mSubResources.insert( name, Scalix::SubResource( active, writable, label,
+                                                   completionWeight ) );
+}
+
+bool KABC::ResourceScalix::doOpen()
+{
+  KConfig config( configFile() );
+
+  // Read the calendar entries
+  QValueList<KMailICalIface::SubResource> subResources;
+  if ( !kmailSubresources( subResources, s_kmailContentsType ) )
+    return false;
+  mSubResources.clear();
+  QValueList<KMailICalIface::SubResource>::ConstIterator it;
+  for ( it = subResources.begin(); it != subResources.end(); ++it ) {
+    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable );
+  }
+
+  return true;
+}
+
+void KABC::ResourceScalix::doClose()
+{
+  KConfig config( configFile() );
+
+  Scalix::ResourceMap::ConstIterator it;
+  for ( it = mSubResources.begin(); it != mSubResources.end(); ++it ) {
+    config.setGroup( it.key() );
+    config.writeEntry( "Active", it.data().active() );
+    config.writeEntry( "CompletionWeight", it.data().completionWeight() );
+  }
+}
+
+KABC::Ticket * KABC::ResourceScalix::requestSaveTicket()
+{
+  if ( !addressBook() ) {
+    kdError() << "no addressbook" << endl;
+    return 0;
+  }
+  mLocked = true;
+
+  return createTicket( this );
+}
+
+void KABC::ResourceScalix::releaseSaveTicket( Ticket* ticket )
+{
+  mLocked = false;
+  mCachedSubresource = QString::null;
+  delete ticket;
+}
+
+QString KABC::ResourceScalix::loadContact( const QString& contactData,
+                                          const QString& subResource,
+                                          Q_UINT32 sernum,
+                                          KMailICalIface::StorageFormat )
+{
+  KABC::Addressee addr = Contact::fromXml( contactData );
+
+  addr.setResource( this );
+  addr.setChanged( false );
+  KABC::Resource::insertAddressee( addr ); // same as mAddrMap.insert( addr.uid(), addr );
+  mUidMap[ addr.uid() ] = StorageReference( subResource, sernum );
+  kdDebug(5650) << "Loaded contact uid=" << addr.uid() << " sernum=" << sernum << " fullName=" << addr.name() << endl;
+  return addr.uid();
+}
+
+bool KABC::ResourceScalix::loadSubResource( const QString& subResource )
+{
+  bool scalixcontacts = loadSubResourceHelper( subResource, s_attachmentMimeTypeContact, KMailICalIface::StorageXML );
+  bool scalixdistlists = loadSubResourceHelper( subResource, s_attachmentMimeTypeDistList, KMailICalIface::StorageXML );
+  bool vcardstyle = loadSubResourceHelper( subResource, s_inlineMimeType, KMailICalIface::StorageIcalVcard );
+  return scalixcontacts && scalixdistlists && vcardstyle;
+}
+
+bool KABC::ResourceScalix::loadSubResourceHelper( const QString& subResource,
+                                                 const char* mimetype,
+                                                 KMailICalIface::StorageFormat format )
+{
+  int count = 0;
+  if ( !kmailIncidencesCount( count, mimetype, subResource ) ) {
+    kdError() << "Communication problem in KABC::ResourceScalix::loadSubResourceHelper()\n";
+    return false;
+  }
+  if ( !count )
+    return true;
+
+  // Read that many contacts at a time.
+  // If this number is too small we lose time in kmail.
+  // If it's too big the progressbar is jumpy.
+  const int nbMessages = 200;
+
+  (void)Observer::self(); // ensure kio_uiserver is running
+  UIServer_stub uiserver( "kio_uiserver", "UIServer" );
+  int progressId = 0;
+  if ( count > 200 ) {
+    progressId = uiserver.newJob( kapp->dcopClient()->appId(), true );
+    uiserver.totalFiles( progressId, count );
+    uiserver.infoMessage( progressId, i18n( "Loading contacts..." ) );
+    uiserver.transferring( progressId, "Contacts" );
+  }
+
+  for ( int startIndex = 0; startIndex < count; startIndex += nbMessages ) {
+    QMap<Q_UINT32, QString> lst;
+
+    if ( !kmailIncidences( lst, mimetype, subResource, startIndex, nbMessages ) ) {
+      kdError() << "Communication problem in ResourceScalix::load()\n";
+      if ( progressId )
+        uiserver.jobFinished( progressId );
+      return false;
+    }
+
+    for( QMap<Q_UINT32, QString>::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
+      loadContact( it.data(), subResource, it.key(), format );
+    }
+    if ( progressId ) {
+      uiserver.processedFiles( progressId, startIndex );
+      uiserver.percent( progressId, 100 * startIndex / count );
+    }
+  }
+
+  kdDebug(5650) << "Contacts scalix resource: got " << count << " contacts in " << subResource << endl;
+
+  if ( progressId )
+    uiserver.jobFinished( progressId );
+  return true;
+}
+
+bool KABC::ResourceScalix::load()
+{
+  mUidMap.clear();
+  mAddrMap.clear();
+
+  bool rc = true;
+  Scalix::ResourceMap::ConstIterator itR;
+  for ( itR = mSubResources.begin(); itR != mSubResources.end(); ++itR ) {
+    if ( !itR.data().active() )
+      // This resource is disabled
+      continue;
+
+    rc &= loadSubResource( itR.key() );
+  }
+
+  return rc;
+}
+
+bool KABC::ResourceScalix::save( Ticket* )
+{
+  bool rc = true;
+
+  for( ConstIterator it = begin(); it != end(); ++it )
+    if( (*it).changed() ) {
+      rc &= kmailUpdateAddressee( *it );
+    }
+
+  if ( !rc )
+    kdDebug(5650) << k_funcinfo << " failed." << endl;
+  return rc;
+}
+
+namespace Scalix {
+struct AttachmentList {
+  QStringList attachmentURLs;
+  QStringList attachmentNames;
+  QStringList attachmentMimeTypes;
+  QStringList deletedAttachments;
+  QValueList<KTempFile *> tempFiles;
+
+  void addAttachment( const QString& url, const QString& name, const QString& mimetype ) {
+    attachmentURLs.append( url );
+    attachmentNames.append( name );
+    attachmentMimeTypes.append( mimetype );
+  }
+
+  void updatePictureAttachment( const QImage& image, const QString& name );
+  void updateAttachment( const QByteArray& data, const QString& name, const char* mimetype );
+};
+} // namespace
+
+void AttachmentList::updatePictureAttachment( const QImage& image, const QString& name )
+{
+  assert( !name.isEmpty() );
+  if ( !image.isNull() ) {
+    KTempFile* tempFile = new KTempFile;
+    image.save( tempFile->file(), "PNG" );
+    tempFile->close();
+    KURL url;
+    url.setPath( tempFile->name() );
+    kdDebug(5650) << "picture saved to " << url.path() << endl;
+    addAttachment( url.url(), name, "image/png" );
+  } else {
+    deletedAttachments.append( name );
+  }
+}
+
+void AttachmentList::updateAttachment( const QByteArray& data, const QString& name, const char* mimetype )
+{
+  assert( !name.isEmpty() );
+  if ( !data.isNull() ) {
+    KTempFile* tempFile = new KTempFile;
+    tempFile->file()->writeBlock( data );
+    tempFile->close();
+    KURL url;
+    url.setPath( tempFile->name() );
+    kdDebug(5650) << "data saved to " << url.path() << endl;
+    addAttachment( url.url(), name, mimetype );
+  } else {
+    deletedAttachments.append( name );
+  }
+}
+
+bool KABC::ResourceScalix::kmailUpdateAddressee( const Addressee& addr )
+{
+  const QString uid = addr.uid();
+  QString subResource;
+  Q_UINT32 sernum;
+  if ( mUidMap.find( uid ) != mUidMap.end() ) {
+    subResource = mUidMap[ uid ].resource();
+    if ( !subresourceWritable( subResource ) ) {
+      kdWarning() << "Wow! Something tried to update a non-writable addressee! Fix this caller: " << kdBacktrace() << endl;
+      return false;
+    }
+    sernum = mUidMap[ uid ].serialNumber();
+  } else {
+    if ( !mCachedSubresource.isNull() ) {
+      subResource = mCachedSubresource;
+    } else {
+      subResource = findWritableResource( mSubResources );
+      // We were locked, remember the subresource we are working with until
+      // we are unlocked
+      if ( mLocked )
+        mCachedSubresource = subResource;
+    }
+    if ( subResource.isEmpty() )
+      return false;
+    sernum = 0;
+  }
+
+  AttachmentList att;
+  QString subject = addr.formattedName();
+
+  QString mimetype = s_inlineMimeType;
+
+  QString data = Contact::toXml( addr );
+
+  CustomHeaderMap customHeaders;
+  customHeaders.insert( "X-Scalix-Class", "IPM.Contact" );
+
+  bool rc = kmailUpdate( subResource, sernum, data, mimetype, subject,
+                         customHeaders,
+                         att.attachmentURLs, att.attachmentMimeTypes, att.attachmentNames,
+                         att.deletedAttachments );
+  if ( !rc )
+    kdDebug(5650) << "kmailUpdate returned false!" << endl;
+  if ( rc ) {
+    kdDebug(5650) << "kmailUpdate returned, now sernum=" << sernum << " for uid=" << uid << endl;
+    mUidMap[ uid ] = StorageReference( subResource, sernum );
+    // This is ugly, but it's faster than doing
+    // mAddrMap.find(addr.uid()), which would give the same :-(
+    // Reason for this: The Changed attribute of Addressee should
+    // be mutable
+    const_cast<Addressee&>(addr).setChanged( false );
+  }
+
+  for( QValueList<KTempFile *>::Iterator it = att.tempFiles.begin(); it != att.tempFiles.end(); ++it ) {
+    (*it)->setAutoDelete( true );
+    delete (*it);
+  }
+  return rc;
+}
+
+void KABC::ResourceScalix::insertAddressee( const Addressee& addr )
+{
+  const QString uid = addr.uid();
+  //kdDebug(5650) << k_funcinfo << uid << endl;
+  bool ok = false;
+  if ( mUidMap.contains( uid ) ) {
+    mUidsPendingUpdate.append( uid );
+  } else {
+    mUidsPendingAdding.append( uid );
+  }
+
+  ok = kmailUpdateAddressee( addr );
+
+  if ( ok )
+    Resource::insertAddressee( addr );
+}
+
+void KABC::ResourceScalix::removeAddressee( const Addressee& addr )
+{
+  const QString uid = addr.uid();
+  if ( mUidMap.find( uid ) == mUidMap.end() ) return;
+  //kdDebug(5650) << k_funcinfo << uid << endl;
+  const QString resource = mUidMap[ uid ].resource();
+  if ( !subresourceWritable( resource ) ) {
+    kdWarning() << "Wow! Something tried to delete a non-writable addressee! Fix this caller: " << kdBacktrace() << endl;
+    return;
+  }
+  /* The user told us to delete, tell KMail */
+  kmailDeleteIncidence( resource,
+                        mUidMap[ uid ].serialNumber() );
+  mUidsPendingDeletion.append( uid );
+  mUidMap.remove( uid );
+
+  Resource::removeAddressee( addr );
+}
+
+/*
+ * These are the DCOP slots that KMail call to notify when something
+ * changed.
+ */
+bool KABC::ResourceScalix::fromKMailAddIncidence( const QString& type,
+                                                 const QString& subResource,
+                                                 Q_UINT32 sernum,
+                                                 int format,
+                                                 const QString& contactXML )
+{
+  // Check if this is a contact
+  if( type != s_kmailContentsType || !subresourceActive( subResource ) )
+    return false;
+
+  // Load contact to find the UID
+  const QString uid = loadContact( contactXML, subResource, sernum,
+      ( KMailICalIface::StorageFormat )format );
+
+  //kdDebug(5650) << k_funcinfo << uid << endl;
+
+  // Emit "addressbook changed" if this comes from kmail and not from the GUI
+  if ( !mUidsPendingAdding.contains( uid )
+       && !mUidsPendingUpdate.contains( uid ) ) {
+    addressBook()->emitAddressBookChanged();
+  } else {
+    mUidsPendingAdding.remove( uid );
+    mUidsPendingUpdate.remove( uid );
+  }
+
+  return true;
+}
+
+void KABC::ResourceScalix::fromKMailDelIncidence( const QString& type,
+                                                 const QString& subResource,
+                                                 const QString& uid )
+{
+  // Check if this is a contact
+  if( type != s_kmailContentsType || !subresourceActive( subResource ) )
+    return;
+
+  //kdDebug(5650) << k_funcinfo << uid << endl;
+
+  // Can't be in both, by contract
+  if ( mUidsPendingDeletion.contains( uid ) ) {
+    mUidsPendingDeletion.remove( uid );
+  } else if ( mUidsPendingUpdate.contains( uid ) ) {
+    // It's good to know if was deleted, but we are waiting on a new one to
+    // replace it, so let's just sit tight.
+  } else {
+    // We didn't trigger this, so KMail did, remove the reference to the uid
+    mAddrMap.remove( uid );
+    mUidMap.remove( uid );
+    addressBook()->emitAddressBookChanged();
+  }
+}
+
+void KABC::ResourceScalix::fromKMailRefresh( const QString& type,
+                                            const QString& /*subResource*/ )
+{
+  // Check if this is a contact
+  if( type != s_kmailContentsType ) return;
+
+  //kdDebug(5650) << k_funcinfo << endl;
+
+  load(); // ### should call loadSubResource(subResource) probably
+  addressBook()->emitAddressBookChanged();
+}
+
+void KABC::ResourceScalix::fromKMailAddSubresource( const QString& type,
+                                                   const QString& subResource,
+                                                   const QString& label,
+                                                   bool writable )
+{
+  if( type != s_kmailContentsType ) return;
+
+  if ( mSubResources.contains( subResource ) )
+    // Already registered
+    return;
+
+  KConfig config( configFile() );
+  config.setGroup( "Contact" );
+  loadSubResourceConfig( config, subResource, label, writable );
+  loadSubResource( subResource );
+  addressBook()->emitAddressBookChanged();
+  emit signalSubresourceAdded( this, type, subResource );
+}
+
+void KABC::ResourceScalix::fromKMailDelSubresource( const QString& type,
+                                                   const QString& subResource )
+{
+  if( type != s_kmailContentsType ) return;
+
+  if ( !mSubResources.contains( subResource ) )
+    // Not registered
+    return;
+
+  // Ok, it's our job, and we have it here
+  mSubResources.erase( subResource );
+
+  KConfig config( configFile() );
+  config.deleteGroup( subResource );
+  config.sync();
+
+  // Make a list of all uids to remove
+  Scalix::UidMap::ConstIterator mapIt;
+  QStringList uids;
+  for ( mapIt = mUidMap.begin(); mapIt != mUidMap.end(); ++mapIt )
+    if ( mapIt.data().resource() == subResource )
+      // We have a match
+      uids << mapIt.key();
+
+  // Finally delete all the incidences
+  if ( !uids.isEmpty() ) {
+    QStringList::ConstIterator it;
+    for ( it = uids.begin(); it != uids.end(); ++it ) {
+      mAddrMap.remove( *it );
+      mUidMap.remove( *it );
+    }
+
+    addressBook()->emitAddressBookChanged();
+  }
+
+  emit signalSubresourceRemoved( this, type, subResource );
+}
+
+
+
+void KABC::ResourceScalix::fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                                    const QString& /* type */,
+                                                    const QString& folder )
+{
+  // FIXME
+  KMailICalIface::StorageFormat format = KMailICalIface::StorageXML;
+  for( QMap<Q_UINT32, QString>::ConstIterator it = map.begin(); it != map.end(); ++it ) {
+    loadContact( it.data(), folder, it.key(), format );
+  }
+  if ( !addressBook() ){
+    kdDebug(5650) << "asyncLoadResult() : addressBook() returning NULL pointer.\n";
+  }else
+    addressBook()->emitAddressBookChanged();
+}
+
+QStringList KABC::ResourceScalix::subresources() const
+{
+  return mSubResources.keys();
+}
+
+bool KABC::ResourceScalix::subresourceActive( const QString& subresource ) const
+{
+  if ( mSubResources.contains( subresource ) ) {
+    return mSubResources[ subresource ].active();
+  }
+
+  // Safe default bet:
+  kdDebug(5650) << "subresourceActive( " << subresource << " ): Safe bet\n";
+
+  return true;
+}
+
+bool KABC::ResourceScalix::subresourceWritable( const QString& subresource ) const
+{
+  if ( mSubResources.contains( subresource ) ) {
+    return mSubResources[ subresource ].writable();
+  }
+  return false; //better a safe default
+}
+
+int KABC::ResourceScalix::subresourceCompletionWeight( const QString& subresource ) const
+{
+  if ( mSubResources.contains( subresource ) ) {
+    return mSubResources[ subresource ].completionWeight();
+  }
+
+  kdDebug(5650) << "subresourceCompletionWeight( " << subresource << " ): not found, using default\n";
+
+  return 80;
+}
+
+QString KABC::ResourceScalix::subresourceLabel( const QString& subresource ) const
+{
+  if ( mSubResources.contains( subresource ) ) {
+    return mSubResources[ subresource ].label();
+  }
+
+  kdDebug(5650) << "subresourceLabel( " << subresource << " ): not found!\n";
+  return QString::null;
+}
+
+void KABC::ResourceScalix::setSubresourceCompletionWeight( const QString& subresource, int completionWeight )
+{
+  if ( mSubResources.contains( subresource ) ) {
+    mSubResources[ subresource ].setCompletionWeight( completionWeight );
+  } else {
+    kdDebug(5650) << "setSubresourceCompletionWeight: subresource " << subresource << " not found" << endl;
+  }
+}
+
+QMap<QString, QString> KABC::ResourceScalix::uidToResourceMap() const
+{
+  // TODO: Couldn't this be made simpler?
+  QMap<QString, QString> map;
+  Scalix::UidMap::ConstIterator mapIt;
+  for ( mapIt = mUidMap.begin(); mapIt != mUidMap.end(); ++mapIt )
+    map[ mapIt.key() ] = mapIt.data().resource();
+  return map;
+}
+
+void KABC::ResourceScalix::setSubresourceActive( const QString &subresource, bool active )
+{
+  if ( mSubResources.contains( subresource ) ) {
+    mSubResources[ subresource ].setActive( active );
+    load();
+  } else {
+    kdDebug(5650) << "setSubresourceCompletionWeight: subresource " << subresource << " not found" << endl;
+  }
+}
+
+#include "resourcescalix.moc"

Zmiany atrybut√≥w dla: kresources/scalix/kabc
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/scalix/uninstall.desktop
===================================================================
--- kresources/scalix/uninstall.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/uninstall.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,3 @@
+[Desktop Entry]
+Encoding=UTF-8
+Hidden=true
Index: kresources/scalix/knotes/resourcescalix.h
===================================================================
--- kresources/scalix/knotes/resourcescalix.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/knotes/resourcescalix.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,127 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef KNOTES_RESOURCESCALIX_H
+#define KNOTES_RESOURCESCALIX_H
+
+#include <resourcenotes.h>
+#include <libkcal/incidencebase.h>
+#include <libkcal/calendarlocal.h>
+#include "../shared/resourcescalixbase.h"
+#include "../shared/subresource.h"
+#include <kdepimmacros.h>
+
+
+namespace Scalix {
+
+/**
+ * This class implements a KNotes resource that keeps its
+ * addresses in an IMAP folder in KMail (or other conforming email
+ * clients).
+ */
+class KDE_EXPORT ResourceScalix : public ResourceNotes,
+                      public KCal::IncidenceBase::Observer,
+                      public ResourceScalixBase
+{
+  Q_OBJECT
+
+public:
+  ResourceScalix( const KConfig* );
+  virtual ~ResourceScalix();
+
+  /// Load resource data.
+  bool load();
+
+  /// Save resource data.
+  bool save();
+
+  /// Open the notes resource.
+  bool doOpen();
+  /// Close the notes resource.
+  void doClose();
+
+  bool addNote( KCal::Journal* );
+
+  bool deleteNote( KCal::Journal* );
+
+  KCal::Alarm::List alarms( const QDateTime& from, const QDateTime& to );
+
+  /// Reimplemented from IncidenceBase::Observer to know when a note was changed
+  void incidenceUpdated( KCal::IncidenceBase* );
+
+  /// The ResourceScalixBase methods called by KMail
+  bool fromKMailAddIncidence( const QString& type, const QString& resource,
+                              Q_UINT32 sernum, int format, const QString& note );
+  void fromKMailDelIncidence( const QString& type, const QString& resource,
+                              const QString& uid );
+  void fromKMailRefresh( const QString& type, const QString& resource );
+
+  /// Listen to KMail changes in the amount of sub resources
+  void fromKMailAddSubresource( const QString& type, const QString& resource,
+                                const QString& label, bool writable );
+  void fromKMailDelSubresource( const QString& type, const QString& resource );
+
+  void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                 const QString& type,
+                                 const QString& folder );
+
+  /** Return the list of subresources. */
+  QStringList subresources() const;
+
+  /** Is this subresource active? */
+  bool subresourceActive( const QString& ) const;
+
+signals:
+  void signalSubresourceAdded( Resource*, const QString&, const QString& );
+  void signalSubresourceRemoved( Resource*, const QString&, const QString& );
+
+private:
+  bool addNote( KCal::Journal* journal, const QString& resource,
+                Q_UINT32 sernum );
+  KCal::Journal* addNote( const QString& data, const QString& subresource,
+                          Q_UINT32 sernum, const QString &mimetype );
+
+  bool loadSubResource( const QString& resource, const QString& mimetype );
+
+  QString configFile() const {
+    return ResourceScalixBase::configFile( "knotes" );
+  }
+
+  KCal::CalendarLocal mCalendar;
+
+  // The list of subresources
+  Scalix::ResourceMap mSubResources;
+};
+
+}
+
+#endif // KNOTES_RESOURCESCALIX_H
Index: kresources/scalix/knotes/Makefile.am
===================================================================
--- kresources/scalix/knotes/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/knotes/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,28 @@
+METASOURCES = AUTO
+
+INCLUDES = -I$(top_srcdir)/kresources/scalix/shared \
+	-I$(top_srcdir) -I$(top_srcdir)/knotes -I$(top_builddir)/libkdepim $(all_includes)
+
+# The scalix wizard links to this library too
+lib_LTLIBRARIES = libknotesscalix.la
+
+libknotesscalix_la_SOURCES = resourcescalix.cpp
+libknotesscalix_la_LDFLAGS = $(all_libraries) -no-undefined
+libknotesscalix_la_LIBADD = \
+	$(top_builddir)/kresources/scalix/shared/libresourcescalixshared.la \
+	$(top_builddir)/knotes/libknotesresources.la \
+	$(top_builddir)/libkcal/libkcal.la \
+	-lkresources -lkdeprint
+
+kde_module_LTLIBRARIES = knotes_scalix.la
+
+knotes_scalix_la_SOURCES = resourcescalix_plugin.cpp
+knotes_scalix_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
+knotes_scalix_la_LIBADD = libknotesscalix.la
+
+servicedir = $(kde_servicesdir)/kresources/knotes
+service_DATA = scalix.desktop
+
+install-data-local: $(srcdir)/../uninstall.desktop
+	$(mkinstalldirs) $(DESTDIR)$(servicedir)
+	$(INSTALL_DATA) $(srcdir)/../uninstall.desktop $(DESTDIR)$(servicedir)/scalix.desktop
Index: kresources/scalix/knotes/resourcescalix_plugin.cpp
===================================================================
--- kresources/scalix/knotes/resourcescalix_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/knotes/resourcescalix_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,50 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+class ScalixFactory : public KRES::PluginFactoryBase
+{
+public:
+  KRES::Resource *resource( const KConfig *config )
+  {
+    return new Scalix::ResourceScalix( config );
+  }
+
+  KRES::ConfigWidget *configWidget( QWidget* )
+  {
+    return 0;
+  }
+};
+
+K_EXPORT_COMPONENT_FACTORY( knotes_scalix, ScalixFactory() )
Index: kresources/scalix/knotes/scalix.desktop
===================================================================
--- kresources/scalix/knotes/scalix.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/knotes/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,13 @@
+[Desktop Entry]
+Encoding=UTF-8
+Name=Notes on Scalix Server via KMail
+Name[bg]=–ë–µ–ª–µ–∂–∫–∏ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ Scalix —á—Ä–µ–∑ KMail
+Name[da]=Noter p√• Scalix-server via KMail
+Name[el]=Œ£Œ∑ŒºŒµŒπœéœÉŒµŒπœÇ œÉŒµ ŒµŒæœÖœÄŒ∑œÅŒµœÑŒ∑œÑŒÆ Scalix ŒºŒ≠œÉœâ œÑŒøœÖ KMail
+Name[sk]=Pozn√°mky na Scalix serveri pomocou KMail
+Name[sv]=Anteckningar p√• Scalix-server via Kmail
+X-KDE-Library=knotes_scalix
+Type=Service
+ServiceTypes=KResources/Plugin
+X-KDE-ResourceFamily=notes
+X-KDE-ResourceType=scalix
Index: kresources/scalix/knotes/resourcescalix.cpp
===================================================================
--- kresources/scalix/knotes/resourcescalix.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/knotes/resourcescalix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,425 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+    Copyright (c) 2004 Till Adam <adam@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+#include <knotes/resourcemanager.h>
+
+#include <libkcal/icalformat.h>
+
+#include <kdebug.h>
+#include <kglobal.h>
+
+using namespace Scalix;
+
+static const char* configGroupName = "Note";
+static const char* kmailContentsType = "Note";
+static const char* attachmentMimeType = "application/x-vnd.kolab.note";
+static const char* inlineMimeType = "text/calendar";
+
+ResourceScalix::ResourceScalix( const KConfig *config )
+  : ResourceNotes( config ), ResourceScalixBase( "ResourceScalix-KNotes" ),
+    mCalendar( QString::fromLatin1("UTC") )
+{
+  setType( "scalix" );
+}
+
+ResourceScalix::~ResourceScalix()
+{
+}
+
+bool ResourceScalix::doOpen()
+{
+  KConfig config( configFile() );
+  config.setGroup( configGroupName );
+
+  // Get the list of Notes folders from KMail
+  QValueList<KMailICalIface::SubResource> subResources;
+  if ( !kmailSubresources( subResources, kmailContentsType ) )
+    return false;
+
+  // Make the resource map from the folder list
+  QValueList<KMailICalIface::SubResource>::ConstIterator it;
+  mSubResources.clear();
+  for ( it = subResources.begin(); it != subResources.end(); ++it ) {
+    const QString subResource = (*it).location;
+    const bool active = config.readBoolEntry( subResource, true );
+    mSubResources[ subResource ] = Scalix::SubResource( active, (*it).writable, (*it).label );
+  }
+
+  return true;
+}
+
+void ResourceScalix::doClose()
+{
+  KConfig config( configFile() );
+  config.setGroup( configGroupName );
+  Scalix::ResourceMap::ConstIterator it;
+  for ( it = mSubResources.begin(); it != mSubResources.end(); ++it )
+    config.writeEntry( it.key(), it.data().active() );
+}
+
+bool ResourceScalix::loadSubResource( const QString& subResource,
+                                     const QString &mimetype )
+{
+  // Get the list of journals
+  int count = 0;
+  if ( !kmailIncidencesCount( count, mimetype, subResource ) ) {
+    kdError() << "Communication problem in ResourceScalix::load()\n";
+    return false;
+  }
+
+  QMap<Q_UINT32, QString> lst;
+  if( !kmailIncidences( lst, mimetype, subResource, 0, count ) ) {
+    kdError(5500) << "Communication problem in "
+                  << "ResourceScalix::getIncidenceList()\n";
+    return false;
+  }
+
+  kdDebug(5500) << "Notes scalix resource: got " << lst.count() << " notes in " << subResource << endl;
+
+  // Populate with the new entries
+  const bool silent = mSilent;
+  mSilent = true;
+  QMap<Q_UINT32, QString>::Iterator it;
+  for ( it = lst.begin(); it != lst.end(); ++it ) {
+    KCal::Journal* journal = addNote( it.data(), subResource, it.key(), mimetype );
+    if ( !journal )
+      kdDebug(5500) << "loading note " << it.key() << " failed" << endl;
+    else
+      manager()->registerNote( this, journal );
+  }
+  mSilent = silent;
+
+  return true;
+}
+
+bool ResourceScalix::load()
+{
+  // We get a fresh list of events, so clean out the old ones
+  mCalendar.deleteAllEvents();
+  mUidMap.clear();
+
+  bool rc = true;
+  Scalix::ResourceMap::ConstIterator itR;
+  for ( itR = mSubResources.begin(); itR != mSubResources.end(); ++itR ) {
+    if ( !itR.data().active() )
+      // This subResource is disabled
+      continue;
+
+    QString mimetype = inlineMimeType;
+    rc &= loadSubResource( itR.key(), mimetype );
+    mimetype = attachmentMimeType;
+    rc &= loadSubResource( itR.key(), mimetype );
+  }
+
+  return rc;
+}
+
+bool ResourceScalix::save()
+{
+  // Nothing to do here, we save everything in incidenceUpdated()
+  return true;
+}
+
+bool ResourceScalix::addNote( KCal::Journal* journal )
+{
+  return addNote( journal, QString::null, 0 );
+}
+
+KCal::Journal* ResourceScalix::addNote( const QString& data, const QString& subresource,
+                             Q_UINT32 sernum, const QString& )
+{
+  KCal::Journal* journal = 0;
+    // FIXME: This does not take into account the time zone!
+  KCal::ICalFormat formatter;
+  journal = static_cast<KCal::Journal*>( formatter.fromString( data ) );
+
+  Q_ASSERT( journal );
+  if( journal && !mUidMap.contains( journal->uid() ) )
+    if ( addNote( journal, subresource, sernum ) )
+      return journal;
+    else
+      delete journal;
+  return 0;
+}
+
+bool ResourceScalix::addNote( KCal::Journal* journal,
+                             const QString& subresource, Q_UINT32 sernum )
+{
+  kdDebug(5500) << "ResourceScalix::addNote( KCal::Journal*, '" << subresource << "', " << sernum << " )\n";
+
+  journal->registerObserver( this );
+
+  // Find out if this note was previously stored in KMail
+  bool newNote = subresource.isEmpty();
+  mCalendar.addJournal( journal );
+
+  QString resource =
+    newNote ? findWritableResource( mSubResources ) : subresource;
+  if ( resource.isEmpty() ) // canceled
+    return false;
+
+  if ( !mSilent ) {
+    KCal::ICalFormat formatter;
+    const QString xml = formatter.toString( journal );
+    kdDebug(5500) << k_funcinfo << "XML string:\n" << xml << endl;
+
+    if( !kmailUpdate( resource, sernum, xml, attachmentMimeType, journal->uid() ) ) {
+      kdError(5500) << "Communication problem in ResourceScalix::addNote()\n";
+      return false;
+    }
+  }
+
+  if ( !resource.isEmpty() && sernum != 0 ) {
+    mUidMap[ journal->uid() ] = StorageReference( resource, sernum );
+    return true;
+  }
+
+  return false;
+}
+
+bool ResourceScalix::deleteNote( KCal::Journal* journal )
+{
+  const QString uid = journal->uid();
+  if ( !mUidMap.contains( uid ) )
+    // Odd
+    return false;
+
+  if ( !mSilent ) {
+    kmailDeleteIncidence( mUidMap[ uid ].resource(),
+                          mUidMap[ uid ].serialNumber() );
+  }
+  mUidMap.remove( uid );
+  manager()->deleteNote( journal );
+  mCalendar.deleteJournal( journal );
+  return true;
+}
+
+KCal::Alarm::List ResourceScalix::alarms( const QDateTime& from, const QDateTime& to )
+{
+    KCal::Alarm::List alarms;
+    KCal::Journal::List notes = mCalendar.journals();
+    KCal::Journal::List::ConstIterator note;
+    for ( note = notes.begin(); note != notes.end(); ++note )
+    {
+        QDateTime preTime = from.addSecs( -1 );
+        KCal::Alarm::List::ConstIterator it;
+        for( it = (*note)->alarms().begin(); it != (*note)->alarms().end(); ++it )
+        {
+            if ( (*it)->enabled() )
+            {
+                QDateTime dt = (*it)->nextRepetition( preTime );
+                if ( dt.isValid() && dt <= to )
+                    alarms.append( *it );
+            }
+        }
+    }
+
+    return alarms;
+}
+
+void ResourceScalix::incidenceUpdated( KCal::IncidenceBase* i )
+{
+  QString subResource;
+  Q_UINT32 sernum;
+  if ( mUidMap.contains( i->uid() ) ) {
+    subResource = mUidMap[ i->uid() ].resource();
+    sernum = mUidMap[ i->uid() ].serialNumber();
+  } else { // can this happen?
+    subResource = findWritableResource( mSubResources );
+    if ( subResource.isEmpty() ) // canceled
+      return;
+    sernum = 0;
+  }
+
+  KCal::Journal* journal = dynamic_cast<KCal::Journal*>( i );
+  KCal::ICalFormat formatter;
+  const QString xml = formatter.toString( journal );
+  if( !xml.isEmpty() && kmailUpdate( subResource, sernum, xml, attachmentMimeType, journal->uid() ) )
+    mUidMap[ i->uid() ] = StorageReference( subResource, sernum );
+}
+
+/*
+ * These are the DCOP slots that KMail call to notify when something
+ * changed.
+ */
+bool ResourceScalix::fromKMailAddIncidence( const QString& type,
+                                           const QString& subResource,
+                                           Q_UINT32 sernum,
+                                           int,
+                                           const QString& note )
+{
+  // Check if this is a note
+  if( type != kmailContentsType ) return false;
+
+  const bool silent = mSilent;
+  mSilent = true;
+  QString mimetype = inlineMimeType;
+  KCal::Journal* journal = addNote( note, subResource, sernum, mimetype );
+  if ( journal )
+    manager()->registerNote( this, journal );
+  mSilent = silent;
+  return true;
+}
+
+void ResourceScalix::fromKMailDelIncidence( const QString& type,
+                                           const QString& /*subResource*/,
+                                           const QString& uid )
+{
+  // Check if this is a note
+  if( type != kmailContentsType ) return;
+
+  kdDebug(5500) << "ResourceScalix::fromKMailDelIncidence( " << type << ", " << uid
+                << " )" << endl;
+
+  const bool silent = mSilent;
+  mSilent = true;
+  KCal::Journal* j = mCalendar.journal( uid );
+  if( j )
+    deleteNote( j );
+  mSilent = silent;
+}
+
+void ResourceScalix::fromKMailRefresh( const QString& type,
+                                      const QString& /*subResource*/ )
+{
+  if ( type == kmailContentsType )
+    load(); // ### should call loadSubResource(subResource) probably
+}
+
+void ResourceScalix::fromKMailAddSubresource( const QString& type,
+                                             const QString& subResource,
+                                             const QString& mimetype,
+                                             bool writable )
+{
+  if ( type != kmailContentsType )
+    // Not ours
+    return;
+
+  if ( mSubResources.contains( subResource ) )
+    // Already registered
+    return;
+
+  KConfig config( configFile() );
+  config.setGroup( configGroupName );
+
+  bool active = config.readBoolEntry( subResource, true );
+  mSubResources[ subResource ] = Scalix::SubResource( active, writable, subResource );
+  loadSubResource( subResource, mimetype );
+  emit signalSubresourceAdded( this, type, subResource );
+}
+
+void ResourceScalix::fromKMailDelSubresource( const QString& type,
+                                             const QString& subResource )
+{
+  if ( type != configGroupName )
+    // Not ours
+    return;
+
+  if ( !mSubResources.contains( subResource ) )
+    // Not registered
+    return;
+
+  // Ok, it's our job, and we have it here
+  mSubResources.erase( subResource );
+
+  KConfig config( configFile() );
+  config.setGroup( configGroupName );
+  config.deleteEntry( subResource );
+  config.sync();
+
+  // Make a list of all uids to remove
+  Scalix::UidMap::ConstIterator mapIt;
+  QStringList uids;
+  for ( mapIt = mUidMap.begin(); mapIt != mUidMap.end(); ++mapIt )
+    if ( mapIt.data().resource() == subResource )
+      // We have a match
+      uids << mapIt.key();
+
+  // Finally delete all the incidences
+  if ( !uids.isEmpty() ) {
+    const bool silent = mSilent;
+    mSilent = true;
+    QStringList::ConstIterator it;
+    for ( it = uids.begin(); it != uids.end(); ++it ) {
+      KCal::Journal* j = mCalendar.journal( *it );
+      if( j )
+        deleteNote( j );
+    }
+    mSilent = silent;
+  }
+
+  emit signalSubresourceRemoved( this, type, subResource );
+}
+
+void ResourceScalix::fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                              const QString& type,
+                                              const QString& folder )
+{
+  // We are only interested in notes
+  if ( ( type != attachmentMimeType ) && ( type != inlineMimeType ) ) return;
+  // Populate with the new entries
+  const bool silent = mSilent;
+  mSilent = true;
+  QString mimetype = inlineMimeType;
+  for( QMap<Q_UINT32, QString>::ConstIterator it = map.begin(); it != map.end(); ++it ) {
+    KCal::Journal* journal = addNote( it.data(), folder, it.key(), mimetype );
+    if ( !journal )
+      kdDebug(5500) << "loading note " << it.key() << " failed" << endl;
+    else
+      manager()->registerNote( this, journal );
+  }
+  mSilent = silent;
+}
+
+
+QStringList ResourceScalix::subresources() const
+{
+  return mSubResources.keys();
+}
+
+bool ResourceScalix::subresourceActive( const QString& res ) const
+{
+  if ( mSubResources.contains( res ) ) {
+    return mSubResources[ res ].active();
+  }
+
+  // Safe default bet:
+  kdDebug(5650) << "subresourceActive( " << res << " ): Safe bet\n";
+
+  return true;
+}
+
+
+#include "resourcescalix.moc"

Zmiany atrybut√≥w dla: kresources/scalix/knotes
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/scalix/shared/scalixbase.cpp
===================================================================
--- kresources/scalix/shared/scalixbase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/scalixbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,446 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "scalixbase.h"
+
+#include <kabc/addressee.h>
+#include <libkcal/journal.h>
+#include <libkdepim/kpimprefs.h>
+#include <kdebug.h>
+#include <qfile.h>
+
+using namespace Scalix;
+
+
+ScalixBase::ScalixBase( const QString& tz )
+  : mCreationDate( QDateTime::currentDateTime() ),
+    mLastModified( QDateTime::currentDateTime() ),
+    mSensitivity( Public ), mTimeZoneId( tz ),
+    mHasPilotSyncId( false ),  mHasPilotSyncStatus( false )
+{
+}
+
+ScalixBase::~ScalixBase()
+{
+}
+
+void ScalixBase::setFields( const KCal::Incidence* incidence )
+{
+  // So far unhandled KCal::IncidenceBase fields:
+  // mPilotID, mSyncStatus, mFloats
+
+  setUid( incidence->uid() );
+  setBody( incidence->description() );
+  setCategories( incidence->categoriesStr() );
+  setCreationDate( localToUTC( incidence->created() ) );
+  setLastModified( localToUTC( incidence->lastModified() ) );
+  setSensitivity( static_cast<Sensitivity>( incidence->secrecy() ) );
+  // TODO: Attachments
+}
+
+void ScalixBase::saveTo( KCal::Incidence* incidence ) const
+{
+  incidence->setUid( uid() );
+  incidence->setDescription( body() );
+  incidence->setCategories( categories() );
+  incidence->setCreated( utcToLocal( creationDate() ) );
+  incidence->setLastModified( utcToLocal( lastModified() ) );
+  incidence->setSecrecy( sensitivity() );
+  // TODO: Attachments
+}
+
+void ScalixBase::setFields( const KABC::Addressee* addressee )
+{
+  // An addressee does not have a creation date, so somehow we should
+  // make one, if this is a new entry
+
+  setUid( addressee->uid() );
+  setBody( addressee->note() );
+  setCategories( addressee->categories().join( "," ) );
+
+  // Set creation-time and last-modification-time
+  const QString creationString = addressee->custom( "KOLAB", "CreationDate" );
+  kdDebug(5006) << "Creation time string: " << creationString << endl;
+  QDateTime creationDate;
+  if ( creationString.isEmpty() ) {
+    creationDate = QDateTime::currentDateTime();
+    kdDebug(5006) << "Creation date set to current time\n";
+  }
+  else {
+    creationDate = stringToDateTime( creationString );
+    kdDebug(5006) << "Creation date loaded\n";
+  }
+  QDateTime modified = addressee->revision();
+  if ( !modified.isValid() )
+    modified = QDateTime::currentDateTime();
+  setLastModified( modified );
+  if ( modified < creationDate ) {
+    // It's not possible that the modification date is earlier than creation
+    creationDate = modified;
+    kdDebug(5006) << "Creation date set to modification date\n";
+  }
+  setCreationDate( creationDate );
+  const QString newCreationDate = dateTimeToString( creationDate );
+  if ( creationString != newCreationDate ) {
+    // We modified the creation date, so store it for future reference
+    const_cast<KABC::Addressee*>( addressee )
+      ->insertCustom( "KOLAB", "CreationDate", newCreationDate );
+    kdDebug(5006) << "Creation date modified. New one: " << newCreationDate << endl;
+  }
+
+  switch( addressee->secrecy().type() ) {
+  case KABC::Secrecy::Private:
+    setSensitivity( Private );
+    break;
+  case KABC::Secrecy::Confidential:
+    setSensitivity( Confidential );
+    break;
+  default:
+    setSensitivity( Public );
+  }
+
+  // TODO: Attachments
+}
+
+void ScalixBase::saveTo( KABC::Addressee* addressee ) const
+{
+  addressee->setUid( uid() );
+  addressee->setNote( body() );
+  addressee->setCategories( QStringList::split( ',', categories() ) );
+  addressee->setRevision( lastModified() );
+  addressee->insertCustom( "KOLAB", "CreationDate",
+                           dateTimeToString( creationDate() ) );
+
+  switch( sensitivity() ) {
+  case Private:
+    addressee->setSecrecy( KABC::Secrecy( KABC::Secrecy::Private ) );
+    break;
+  case Confidential:
+    addressee->setSecrecy( KABC::Secrecy( KABC::Secrecy::Confidential ) );
+    break;
+  default:
+    addressee->setSecrecy( KABC::Secrecy( KABC::Secrecy::Public ) );
+    break;
+  }
+
+  // TODO: Attachments
+}
+
+void ScalixBase::setUid( const QString& uid )
+{
+  mUid = uid;
+}
+
+QString ScalixBase::uid() const
+{
+  return mUid;
+}
+
+void ScalixBase::setBody( const QString& body )
+{
+  mBody = body;
+}
+
+QString ScalixBase::body() const
+{
+  return mBody;
+}
+
+void ScalixBase::setCategories( const QString& categories )
+{
+  mCategories = categories;
+}
+
+QString ScalixBase::categories() const
+{
+  return mCategories;
+}
+
+void ScalixBase::setCreationDate( const QDateTime& date )
+{
+  mCreationDate = date;
+}
+
+QDateTime ScalixBase::creationDate() const
+{
+  return mCreationDate;
+}
+
+void ScalixBase::setLastModified( const QDateTime& date )
+{
+  mLastModified = date;
+}
+
+QDateTime ScalixBase::lastModified() const
+{
+  return mLastModified;
+}
+
+void ScalixBase::setSensitivity( Sensitivity sensitivity )
+{
+  mSensitivity = sensitivity;
+}
+
+ScalixBase::Sensitivity ScalixBase::sensitivity() const
+{
+  return mSensitivity;
+}
+
+void ScalixBase::setPilotSyncId( unsigned long id )
+{
+  mHasPilotSyncId = true;
+  mPilotSyncId = id;
+}
+
+bool ScalixBase::hasPilotSyncId() const
+{
+  return mHasPilotSyncId;
+}
+
+unsigned long ScalixBase::pilotSyncId() const
+{
+  return mPilotSyncId;
+}
+
+void ScalixBase::setPilotSyncStatus( int status )
+{
+  mHasPilotSyncStatus = true;
+  mPilotSyncStatus = status;
+}
+
+bool ScalixBase::hasPilotSyncStatus() const
+{
+  return mHasPilotSyncStatus;
+}
+
+int ScalixBase::pilotSyncStatus() const
+{
+  return mPilotSyncStatus;
+}
+
+bool ScalixBase::loadEmailAttribute( QDomElement& element, Email& email )
+{
+  for ( QDomNode n = element.firstChild(); !n.isNull(); n = n.nextSibling() ) {
+    if ( n.isComment() )
+      continue;
+    if ( n.isElement() ) {
+      QDomElement e = n.toElement();
+      QString tagName = e.tagName();
+
+      if ( tagName == "display-name" )
+        email.displayName = e.text();
+      else if ( tagName == "smtp-address" )
+        email.smtpAddress = e.text();
+      else
+        // TODO: Unhandled tag - save for later storage
+        kdDebug() << "Warning: Unhandled tag " << e.tagName() << endl;
+    } else
+      kdDebug() << "Node is not a comment or an element???" << endl;
+  }
+
+  return true;
+}
+
+void ScalixBase::saveEmailAttribute( QDomElement& element, const Email& email,
+                                    const QString& tagName ) const
+{
+  QDomElement e = element.ownerDocument().createElement( tagName );
+  element.appendChild( e );
+  writeString( e, "display-name", email.displayName );
+  writeString( e, "smtp-address", email.smtpAddress );
+}
+
+bool ScalixBase::loadAttribute( QDomElement& element )
+{
+  QString tagName = element.tagName();
+
+  if ( tagName == "uid" )
+    setUid( element.text() );
+  else if ( tagName == "body" )
+    setBody( element.text() );
+  else if ( tagName == "categories" )
+    setCategories( element.text() );
+  else if ( tagName == "creation-date" )
+    setCreationDate( stringToDateTime( element.text() ) );
+  else if ( tagName == "last-modification-date" )
+    setLastModified( stringToDateTime( element.text() ) );
+  else if ( tagName == "sensitivity" )
+    setSensitivity( stringToSensitivity( element.text() ) );
+  else if ( tagName == "product-id" )
+    return true; // ignore this field
+  else if ( tagName == "pilot-sync-id" )
+    setPilotSyncId( element.text().toULong() );
+  else if ( tagName == "pilot-sync-status" )
+    setPilotSyncStatus( element.text().toInt() );
+  else
+    return false;
+
+  // Handled here
+  return true;
+}
+
+bool ScalixBase::saveAttributes( QDomElement& element ) const
+{
+  writeString( element, "product-id", productID() );
+  writeString( element, "uid", uid() );
+  writeString( element, "body", body() );
+  writeString( element, "categories", categories() );
+  writeString( element, "creation-date", dateTimeToString( creationDate() ) );
+  writeString( element, "last-modification-date",
+               dateTimeToString( lastModified() ) );
+  writeString( element, "sensitivity", sensitivityToString( sensitivity() ) );
+  if ( hasPilotSyncId() )
+    writeString( element, "pilot-sync-id", QString::number( pilotSyncId() ) );
+  if ( hasPilotSyncStatus() )
+    writeString( element, "pilot-sync-status", QString::number( pilotSyncStatus() ) );
+  return true;
+}
+
+bool ScalixBase::load( const QString& xml )
+{
+  QString errorMsg;
+  int errorLine, errorColumn;
+  QDomDocument document;
+  bool ok = document.setContent( xml, &errorMsg, &errorLine, &errorColumn );
+
+  if ( !ok ) {
+    qWarning( "Error loading document: %s, line %d, column %d",
+              errorMsg.latin1(), errorLine, errorColumn );
+    return false;
+  }
+
+  // XML file loaded into tree. Now parse it
+  return loadXML( document );
+}
+
+bool ScalixBase::load( QFile& xml )
+{
+  QString errorMsg;
+  int errorLine, errorColumn;
+  QDomDocument document;
+  bool ok = document.setContent( &xml, &errorMsg, &errorLine, &errorColumn );
+
+  if ( !ok ) {
+    qWarning( "Error loading document: %s, line %d, column %d",
+              errorMsg.latin1(), errorLine, errorColumn );
+    return false;
+  }
+
+  // XML file loaded into tree. Now parse it
+  return loadXML( document );
+}
+
+QDomDocument ScalixBase::domTree()
+{
+  QDomDocument document;
+
+  QString p = "version=\"1.0\" encoding=\"UTF-8\"";
+  document.appendChild(document.createProcessingInstruction( "xml", p ) );
+
+  return document;
+}
+
+
+QString ScalixBase::dateTimeToString( const QDateTime& time )
+{
+  return time.toString( Qt::ISODate ) + 'Z';
+}
+
+QString ScalixBase::dateToString( const QDate& date )
+{
+  return date.toString( Qt::ISODate );
+}
+
+QDateTime ScalixBase::stringToDateTime( const QString& _date )
+{
+  QString date( _date );
+  if ( date.endsWith( "Z" ) )
+    date.truncate( date.length() - 1 );
+  return QDateTime::fromString( date, Qt::ISODate );
+}
+
+QDate ScalixBase::stringToDate( const QString& date )
+{
+  return QDate::fromString( date, Qt::ISODate );
+}
+
+QString ScalixBase::sensitivityToString( Sensitivity s )
+{
+  switch( s ) {
+  case Private: return "private";
+  case Confidential: return "confidential";
+  case Public: return "public";
+  }
+
+  return "What what what???";
+}
+
+ScalixBase::Sensitivity ScalixBase::stringToSensitivity( const QString& s )
+{
+  if ( s == "private" )
+    return Private;
+  if ( s == "confidential" )
+    return Confidential;
+  return Public;
+}
+
+QString ScalixBase::colorToString( const QColor& color )
+{
+  // Color is in the format "#RRGGBB"
+  return color.name();
+}
+
+QColor ScalixBase::stringToColor( const QString& s )
+{
+  return QColor( s );
+}
+
+void ScalixBase::writeString( QDomElement& element, const QString& tag,
+                             const QString& tagString )
+{
+  if ( !tagString.isEmpty() ) {
+    QDomElement e = element.ownerDocument().createElement( tag );
+    QDomText t = element.ownerDocument().createTextNode( tagString );
+    e.appendChild( t );
+    element.appendChild( e );
+  }
+}
+
+QDateTime ScalixBase::localToUTC( const QDateTime& time ) const
+{
+  return KPimPrefs::localTimeToUtc( time, mTimeZoneId );
+}
+
+QDateTime ScalixBase::utcToLocal( const QDateTime& time ) const
+{
+  return KPimPrefs::utcToLocalTime( time, mTimeZoneId );
+}
Index: kresources/scalix/shared/subresource.cpp
===================================================================
--- kresources/scalix/shared/subresource.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/subresource.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,116 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "subresource.h"
+
+using namespace Scalix;
+
+SubResource::SubResource( bool active, bool writable, const QString& label,
+                          int completionWeight )
+  : mActive( active ),  mWritable( writable ), mLabel( label ),
+    mCompletionWeight( completionWeight )
+{
+}
+
+SubResource::~SubResource()
+{
+}
+
+void SubResource::setActive( bool active )
+{
+  mActive = active;
+}
+
+bool SubResource::active() const
+{
+  return mActive;
+}
+
+void SubResource::setWritable( bool writable )
+{
+  mWritable = writable;
+}
+
+bool SubResource::writable() const
+{
+  return mWritable;
+}
+
+void SubResource::setLabel( const QString& label )
+{
+  mLabel = label;
+}
+
+QString SubResource::label() const
+{
+  return mLabel;
+}
+
+void SubResource::setCompletionWeight( int completionWeight )
+{
+  mCompletionWeight = completionWeight;
+}
+
+int SubResource::completionWeight() const
+{
+  return mCompletionWeight;
+}
+
+StorageReference::StorageReference( const QString& resource, Q_UINT32 sernum )
+  : mResource( resource ), mSerialNumber( sernum )
+{
+}
+
+StorageReference::~StorageReference()
+{
+}
+
+void StorageReference::setResource( const QString& resource )
+{
+  mResource = resource;
+}
+
+QString StorageReference::resource() const
+{
+  return mResource;
+}
+
+void StorageReference::setSerialNumber( Q_UINT32 serialNumber )
+{
+  mSerialNumber = serialNumber;
+}
+
+Q_UINT32 StorageReference::serialNumber() const
+{
+  return mSerialNumber;
+}
Index: kresources/scalix/shared/kmailconnection.h
===================================================================
--- kresources/scalix/shared/kmailconnection.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/kmailconnection.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,117 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef KMAILCONNECTION_H
+#define KMAILCONNECTION_H
+
+#include <dcopobject.h>
+#include <kmail/kmailicalIface.h>
+
+class KURL;
+class DCOPClient;
+class KMailICalIface_stub;
+
+namespace Scalix {
+
+class ResourceScalixBase;
+
+/**
+  This class provides the kmail connectivity for IMAP resources.
+*/
+class KMailConnection : public QObject, public DCOPObject {
+  Q_OBJECT
+  K_DCOP
+
+  // These are the methods called by KMail when the resource changes
+k_dcop:
+  bool fromKMailAddIncidence( const QString& type, const QString& resource,
+                              Q_UINT32 sernum, int format, const QString& xml );
+  void fromKMailDelIncidence( const QString& type, const QString& resource,
+                              const QString& xml );
+  void fromKMailRefresh( const QString& type, const QString& resource );
+  void fromKMailAddSubresource( const QString& type, const QString& resource, const QString& label );
+  void fromKMailDelSubresource( const QString& type, const QString& resource );
+  void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map, const QString& type,
+                                 const QString& folder );
+
+public:
+  KMailConnection( ResourceScalixBase* resource, const QCString& objId );
+  virtual ~KMailConnection();
+
+  /**
+   * Do the connection to KMail.
+   */
+  bool connectToKMail();
+
+  // Call the DCOP methods
+  bool kmailSubresources( QValueList<KMailICalIface::SubResource>& lst,
+                          const QString& contentsType );
+  bool kmailIncidencesCount( int& count,
+                             const QString& mimetype,
+                             const QString& resource );
+  bool kmailIncidences( QMap<Q_UINT32, QString>& lst, const QString& mimetype,
+                        const QString& resource,
+                        int startIndex,
+                        int nbMessages );
+
+  bool kmailGetAttachment( KURL& url, const QString& resource, Q_UINT32 sernum,
+                           const QString& filename );
+  bool kmailDeleteIncidence( const QString& resource, Q_UINT32 sernum );
+  bool kmailUpdate( const QString& resource,
+                    Q_UINT32& sernum,
+                    const QString& subject,
+                    const QString& plainTextBody,
+                    const QMap<QCString, QString>& customHeaders,
+                    const QStringList& attachmentURLs,
+                    const QStringList& attachmentMimetypes,
+                    const QStringList& attachmentNames,
+                    const QStringList& deletedAttachments );
+
+  bool kmailStorageFormat( KMailICalIface::StorageFormat& type, const QString& folder);
+
+  bool kmailTriggerSync( const QString& contentsType );
+
+private slots:
+  virtual void unregisteredFromDCOP( const QCString& );
+
+private:
+  /** Connect a signal from KMail to a local slot. */
+  bool connectKMailSignal( const QCString&, const QCString& );
+
+  ResourceScalixBase* mResource;
+  DCOPClient* mDCOPClient;
+  KMailICalIface_stub* mKMailIcalIfaceStub;
+};
+
+}
+
+#endif // KMAILCONNECTION_H
Index: kresources/scalix/shared/scalixbase.h
===================================================================
--- kresources/scalix/shared/scalixbase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/scalixbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,176 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef SCALIXBASE_H
+#define SCALIXBASE_H
+
+#include <qdom.h>
+#include <qdatetime.h>
+#include <qcolor.h>
+
+class QFile;
+
+namespace KCal {
+  class Incidence;
+}
+
+namespace KABC {
+  class Addressee;
+}
+
+namespace Scalix {
+
+class ScalixBase {
+public:
+  struct Email {
+  public:
+    Email( const QString& name = QString::null,
+           const QString& email = QString::null )
+      : displayName( name ), smtpAddress( email )
+    {
+    }
+
+    QString displayName;
+    QString smtpAddress;
+  };
+
+  enum Sensitivity { Public = 0, Private = 1, Confidential = 2 };
+
+  explicit ScalixBase( const QString& timezone = QString::null );
+  virtual ~ScalixBase();
+
+  // Return a string identifying this type
+  virtual QString type() const = 0;
+
+  virtual void setUid( const QString& uid );
+  virtual QString uid() const;
+
+  virtual void setBody( const QString& body );
+  virtual QString body() const;
+
+  virtual void setCategories( const QString& categories );
+  virtual QString categories() const;
+
+  virtual void setCreationDate( const QDateTime& date );
+  virtual QDateTime creationDate() const;
+
+  virtual void setLastModified( const QDateTime& date );
+  virtual QDateTime lastModified() const;
+
+  virtual void setSensitivity( Sensitivity sensitivity );
+  virtual Sensitivity sensitivity() const;
+
+  virtual void setPilotSyncId( unsigned long id );
+  virtual bool hasPilotSyncId() const;
+  virtual unsigned long pilotSyncId() const;
+
+  virtual void setPilotSyncStatus( int status );
+  virtual bool hasPilotSyncStatus() const;
+  virtual int pilotSyncStatus() const;
+
+  // String - Date conversion methods
+  static QString dateTimeToString( const QDateTime& time );
+  static QString dateToString( const QDate& date );
+  static QDateTime stringToDateTime( const QString& time );
+  static QDate stringToDate( const QString& date );
+
+  // String - Sensitivity conversion methods
+  static QString sensitivityToString( Sensitivity );
+  static Sensitivity stringToSensitivity( const QString& );
+
+  // String - Color conversion methods
+  static QString colorToString( const QColor& );
+  static QColor stringToColor( const QString& );
+
+  // Load this object by reading the XML file
+  bool load( const QString& xml );
+  bool load( QFile& xml );
+
+  // Load this QDomDocument
+  virtual bool loadXML( const QDomDocument& xml ) = 0;
+
+  // Serialize this object to an XML string
+  virtual QString saveXML() const = 0;
+
+protected:
+  /// Read all known fields from this ical incidence
+  void setFields( const KCal::Incidence* );
+
+  /// Save all known fields into this ical incidence
+  void saveTo( KCal::Incidence* ) const;
+
+  /// Read all known fields from this contact
+  void setFields( const KABC::Addressee* );
+
+  /// Save all known fields into this contact
+  void saveTo( KABC::Addressee* ) const;
+
+  // This just makes the initial dom tree with version and doctype
+  static QDomDocument domTree();
+
+  bool loadEmailAttribute( QDomElement& element, Email& email );
+
+  void saveEmailAttribute( QDomElement& element, const Email& email,
+                           const QString& tagName = "email" ) const;
+
+  // Load the attributes of this class
+  virtual bool loadAttribute( QDomElement& );
+
+  // Save the attributes of this class
+  virtual bool saveAttributes( QDomElement& ) const;
+
+  // Return the product ID
+  virtual QString productID() const = 0;
+
+  // Write a string tag
+  static void writeString( QDomElement&, const QString&, const QString& );
+
+  QDateTime localToUTC( const QDateTime& time ) const;
+  QDateTime utcToLocal( const QDateTime& time ) const;
+
+  QString mUid;
+  QString mBody;
+  QString mCategories;
+  QDateTime mCreationDate;
+  QDateTime mLastModified;
+  Sensitivity mSensitivity;
+  QString mTimeZoneId;
+
+  // KPilot synchronization stuff
+  bool mHasPilotSyncId,  mHasPilotSyncStatus;
+  unsigned long mPilotSyncId;
+  int mPilotSyncStatus;
+};
+
+}
+
+#endif // SCALIXBASE_H
Index: kresources/scalix/shared/resourcescalixbase.cpp
===================================================================
--- kresources/scalix/shared/resourcescalixbase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/resourcescalixbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,177 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalixbase.h"
+#include "kmailconnection.h"
+
+#include <klocale.h>
+#include <kstandarddirs.h>
+#include <kinputdialog.h>
+#include <kurl.h>
+#include <ktempfile.h>
+#include <kmessagebox.h>
+#include <qtextstream.h>
+#include <kdebug.h>
+
+using namespace Scalix;
+
+static unsigned int uniquifier = 0;
+
+ResourceScalixBase::ResourceScalixBase( const QCString& objId )
+  : mSilent( false )
+{
+  KGlobal::locale()->insertCatalogue( "kres_scalix" );
+  KGlobal::locale()->insertCatalogue( "libkcal" );
+  QString uniqueObjId = QString( objId ) + QString::number( uniquifier++ );
+  mConnection = new KMailConnection( this, uniqueObjId.utf8() );
+}
+
+ResourceScalixBase::~ResourceScalixBase()
+{
+  delete mConnection;
+}
+
+
+bool ResourceScalixBase::kmailSubresources( QValueList<KMailICalIface::SubResource>& lst,
+                                           const QString& contentsType ) const
+{
+  return mConnection->kmailSubresources( lst, contentsType );
+}
+
+bool ResourceScalixBase::kmailTriggerSync( const QString& contentsType ) const
+{
+  return mConnection->kmailTriggerSync( contentsType );
+}
+
+
+bool ResourceScalixBase::kmailIncidencesCount( int &count,
+                                              const QString& mimetype,
+                                              const QString& resource ) const
+{
+  return mConnection->kmailIncidencesCount( count, mimetype, resource );
+}
+
+bool ResourceScalixBase::kmailIncidences( QMap<Q_UINT32, QString>& lst,
+                                         const QString& mimetype,
+                                         const QString& resource,
+                                         int startIndex,
+                                         int nbMessages ) const
+{
+  return mConnection->kmailIncidences( lst, mimetype, resource, startIndex, nbMessages );
+}
+
+bool ResourceScalixBase::kmailGetAttachment( KURL& url, const QString& resource,
+                                            Q_UINT32 sernum,
+                                            const QString& filename ) const
+{
+  return mConnection->kmailGetAttachment( url, resource, sernum, filename );
+}
+
+bool ResourceScalixBase::kmailDeleteIncidence( const QString& resource,
+                                              Q_UINT32 sernum )
+{
+  return mSilent || mConnection->kmailDeleteIncidence( resource, sernum );
+}
+
+bool ResourceScalixBase::kmailUpdate( const QString& resource,
+                                     Q_UINT32& sernum,
+                                     const QString& xml,
+                                     const QString& mimetype,
+                                     const QString& subject,
+                                     const CustomHeaderMap& _customHeaders,
+                                     const QStringList& _attachmentURLs,
+                                     const QStringList& _attachmentMimetypes,
+                                     const QStringList& _attachmentNames,
+                                     const QStringList& deletedAttachments )
+{
+  if ( mSilent )
+    return true;
+
+  QString subj = subject;
+  if ( subj.isEmpty() )
+    subj = i18n("Internal kolab data: Do not delete this mail.");
+
+  // ical style, simply put the data inline
+  return mConnection->kmailUpdate( resource, sernum, subj, xml, _customHeaders,
+    _attachmentURLs, _attachmentMimetypes, _attachmentNames, deletedAttachments );
+}
+
+QString ResourceScalixBase::configFile( const QString& type ) const
+{
+  return locateLocal( "config",
+                      QString( "kresources/scalix/%1rc" ).arg( type ) );
+}
+
+bool ResourceScalixBase::connectToKMail() const
+{
+  return mConnection->connectToKMail();
+}
+
+QString ResourceScalixBase::findWritableResource( const ResourceMap& resources )
+{
+  // I have to use the label (shown in the dialog) as key here. But given how the
+  // label is made up, it should be unique. If it's not, well the dialog would suck anyway...
+  QMap<QString, QString> possible;
+  QStringList labels;
+  ResourceMap::ConstIterator it;
+  for ( it = resources.begin(); it != resources.end(); ++it ) {
+    if ( it.data().writable() && it.data().active() ) {
+      // Writable and active possibility
+      possible[ it.data().label() ] = it.key();
+    }
+  }
+
+  if ( possible.isEmpty() ) { // None found!!
+    kdWarning(5650) << "No writable resource found!" << endl;
+    KMessageBox::error( 0, i18n( "No writable resource was found, saving will not be possible. Reconfigure KMail first." ) );
+    return QString::null;
+  }
+  if ( possible.count() == 1 )
+    // Just one found
+    return possible.begin().data(); // yes this is the subresource key, i.e. location
+
+  // Several found, ask the user
+  QString chosenLabel = KInputDialog::getItem( i18n( "Select Resource Folder" ),
+                                               i18n( "You have more than one writable resource folder. "
+                                                     "Please select the one you want to write to." ),
+                                               possible.keys() );
+  if ( chosenLabel.isEmpty() ) // cancelled
+    return QString::null;
+  return possible[chosenLabel];
+}
+
+KMailICalIface::StorageFormat ResourceScalixBase::kmailStorageFormat( const QString &folder ) const
+{
+  KMailICalIface::StorageFormat format = (KMailICalIface::StorageFormat) 3;
+  mConnection->kmailStorageFormat( format, folder );
+  return format;
+}
Index: kresources/scalix/shared/subresource.h
===================================================================
--- kresources/scalix/shared/subresource.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/subresource.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,110 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef SUBRESOURCE_H
+#define SUBRESOURCE_H
+
+#include <qstring.h>
+#include <qmap.h>
+
+
+namespace Scalix {
+
+/**
+ * This class is used to store in a map from resource id to this, providing
+ * a lookup of the subresource settings.
+ */
+class SubResource {
+public:
+  // This is just for QMap
+  SubResource() {}
+
+  SubResource( bool active, bool writable, const QString& label,
+               int completionWeight = 100 );
+  virtual ~SubResource();
+
+  virtual void setActive( bool active );
+  virtual bool active() const;
+
+  virtual void setWritable( bool writable );
+  virtual bool writable() const;
+
+  virtual void setLabel( const QString& label );
+  virtual QString label() const;
+
+  virtual void setCompletionWeight( int completionWeight );
+  virtual int completionWeight() const;
+
+private:
+  bool mActive;   // Controlled by the applications
+  bool mWritable; // Set if the KMail folder is writable
+  QString mLabel; // The GUI name of this resource
+
+  // This is just for the abc plugin. But as long as only this is here,
+  // it's just as cheap to have it in here as making a d-pointer that
+  // subclasses could add to. If more are added, then we should refactor
+  // to a d-pointer instead.
+  int mCompletionWeight;
+};
+
+typedef QMap<QString, SubResource> ResourceMap;
+
+/**
+ * This class is used to store a mapping from the XML UID to the KMail
+ * serial number of the mail it's stored in and the resource. That provides
+ * a quick way to access the storage in KMail.
+ */
+class StorageReference {
+public:
+  // Just for QMap
+  StorageReference() {}
+
+  StorageReference( const QString& resource, Q_UINT32 sernum );
+  virtual ~StorageReference();
+
+  virtual void setResource( const QString& resource );
+  virtual QString resource() const;
+
+  virtual void setSerialNumber( Q_UINT32 serialNumber );
+  virtual Q_UINT32 serialNumber() const;
+
+private:
+  QString mResource;
+  Q_UINT32 mSerialNumber;
+};
+
+typedef QMap<QString, StorageReference> UidMap;
+
+}
+
+#endif // SUBRESOURCE_H
Index: kresources/scalix/shared/Makefile.am
===================================================================
--- kresources/scalix/shared/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,17 @@
+INCLUDES = -I$(top_srcdir) $(all_includes)
+
+noinst_HEADERS = resourcescalixbase.h scalixbase.h subresource.h
+
+noinst_LTLIBRARIES = libresourcescalixshared.la
+
+libresourcescalixshared_la_SOURCES = \
+	resourcescalixbase.cpp kmailconnection.cpp scalixbase.cpp \
+  subresource.cpp \
+	kmailconnection.skel kmailicalIface.stub
+libresourcescalixshared_la_METASOURCES = AUTO
+libresourcescalixshared_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la
+libresourcescalixshared_la_LDFLAGS = -no-undefined
+
+kmailicalIface_DCOPIDLNG = true
+
+kmailicalIface_DIR = $(top_srcdir)/kmail
Index: kresources/scalix/shared/resourcescalixbase.h
===================================================================
--- kresources/scalix/shared/resourcescalixbase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/resourcescalixbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,180 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef RESOURCESCALIXBASE_H
+#define RESOURCESCALIXBASE_H
+
+#include <qstring.h>
+#include <qmap.h>
+#include <qstringlist.h>
+
+#include "subresource.h"
+#include <kmail/kmailicalIface.h>
+
+class QCString;
+class KURL;
+
+namespace Scalix {
+
+class KMailConnection;
+
+/**
+  This class provides the kmail connectivity for IMAP resources.
+
+  The main methods are:
+
+  fromKMail...() : calls made _by_ KMail to add/delete data representation in the resource.
+
+  kmail...()     : calls _into_ KMail made by the resource.
+
+  e.g. fromKMailAddIncidence() is called by KMail
+       when a new iCard is there after an IMAP sync.
+
+       By calling fromKMailAddIncidence() KMail notifies
+       the resource about the new incidence, so in the
+       addressbook a new address will appear like magic.
+
+  e.g. kmailAddIncidence() is called by the resource when
+       iCard must be stored by KMail because the user has added
+       an address in the addressbook.
+
+       By calling kmailAddIncidence() the resource causes
+       KMail to store the new address in the (IMAP) folder.
+*/
+class ResourceScalixBase {
+public:
+  ResourceScalixBase( const QCString& objId );
+  virtual ~ResourceScalixBase();
+
+  // These are the methods called by KMail when the resource changes
+  virtual bool fromKMailAddIncidence( const QString& type,
+                                      const QString& resource,
+                                      Q_UINT32 sernum,
+                                      int format,
+                                      const QString& data ) = 0;
+  virtual void fromKMailDelIncidence( const QString& type,
+                                      const QString& resource,
+                                      const QString& xml ) = 0;
+  virtual void fromKMailRefresh( const QString& type,
+                                 const QString& resource ) = 0;
+  virtual void fromKMailAddSubresource( const QString& type,
+                                        const QString& resource,
+                                        const QString& label,
+                                        bool writable ) = 0;
+  virtual void fromKMailDelSubresource( const QString& type,
+                                        const QString& resource ) = 0;
+
+  virtual void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                         const QString& type,
+                                         const QString& folder ) = 0;
+protected:
+  /// Do the connection to KMail.
+  bool connectToKMail() const;
+
+  // These are the KMail dcop function connections. The docs here say
+  // "Get", which here means that the first argument is the return arg
+
+  /// List all folders with a certain contentsType. Returns a QMap with
+  /// resourcename/writable pairs
+  bool kmailSubresources( QValueList<KMailICalIface::SubResource>& lst,
+                          const QString& contentsType ) const;
+
+  /// Get the number of messages in this folder.
+  /// Used to iterate over kmailIncidences by chunks
+  bool kmailIncidencesCount( int& count, const QString& mimetype,
+                             const QString& resource ) const;
+
+  /// Get the mimetype attachments from a chunk of messages from this folder.
+  /// Returns a QMap with serialNumber/attachment pairs.
+  bool kmailIncidences( QMap<Q_UINT32, QString>& lst, const QString& mimetype,
+                        const QString& resource,
+                        int startIndex,
+                        int nbMessages ) const;
+
+  bool kmailTriggerSync( const QString& contentType ) const;
+
+public: // for Contact
+  /// Get an attachment from a mail. Returns a URL to it. This can
+  /// be called by the resource after obtaining the incidence.
+  /// The resource must delete the temp file.
+  bool kmailGetAttachment( KURL& url, const QString& resource,
+                           Q_UINT32 sernum,
+                           const QString& filename ) const;
+
+protected:
+  /// Delete an incidence.
+  bool kmailDeleteIncidence( const QString& resource, Q_UINT32 sernum );
+
+  KMailICalIface::StorageFormat kmailStorageFormat( const QString& folder ) const;
+
+  typedef QMap<QCString, QString> CustomHeaderMap;
+
+  /// Update an incidence. The list of attachments are URLs.
+  /// The parameter sernum is updated with the right KMail serial number
+  bool kmailUpdate( const QString& resource, Q_UINT32& sernum,
+                    const QString& xml,
+                    const QString& mimetype,
+                    const QString& subject,
+                    const CustomHeaderMap& customHeaders = CustomHeaderMap(),
+                    const QStringList& attachmentURLs = QStringList(),
+                    const QStringList& attachmentMimetypes = QStringList(),
+                    const QStringList& attachmentNames = QStringList(),
+                    const QStringList& deletedAttachments = QStringList() );
+
+  /// Get the full path of the config file.
+  QString configFile( const QString& type ) const;
+
+  /// If only one of these is writable, return that. Otherwise return null.
+  QString findWritableResource( const ResourceMap& resources );
+
+  bool mSilent;
+
+  /**
+   * This is used to store a mapping from the XML UID to the KMail
+   * serial number of the mail it's stored in. That provides a quick way
+   * to access the storage in KMail.
+   */
+  UidMap mUidMap;
+
+  /// This is used to distinguish operations triggered by the user,
+  /// from operations triggered by KMail
+  QStringList mUidsPendingAdding;
+  QStringList mUidsPendingDeletion;
+  QStringList mUidsPendingUpdate;
+
+private:
+  mutable KMailConnection* mConnection;
+};
+
+}
+
+#endif // RESOURCEKOLABBASE_H
Index: kresources/scalix/shared/kmailconnection.cpp
===================================================================
--- kresources/scalix/shared/kmailconnection.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/shared/kmailconnection.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,281 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "kmailconnection.h"
+#include "resourcescalixbase.h"
+
+#include <kdebug.h>
+#include <dcopclient.h>
+#include <kapplication.h>
+#include <kdcopservicestarter.h>
+#include <klocale.h>
+
+#include "kmailicalIface_stub.h"
+
+
+using namespace Scalix;
+
+
+KMailConnection::KMailConnection( ResourceScalixBase* resource,
+                                  const QCString& objId )
+  : DCOPObject( objId ), mResource( resource ), mKMailIcalIfaceStub( 0 )
+{
+  // Make the connection to KMail ready
+  mDCOPClient = new DCOPClient();
+  mDCOPClient->attach();
+  mDCOPClient->registerAs( objId, true );
+
+  kapp->dcopClient()->setNotifications( true );
+  connect( kapp->dcopClient(), SIGNAL( applicationRemoved( const QCString& ) ),
+           this, SLOT( unregisteredFromDCOP( const QCString& ) ) );
+}
+
+KMailConnection::~KMailConnection()
+{
+  kapp->dcopClient()->setNotifications( false );
+  delete mKMailIcalIfaceStub;
+  mKMailIcalIfaceStub = 0;
+  delete mDCOPClient;
+  mDCOPClient = 0;
+}
+
+static const QCString dcopObjectId = "KMailICalIface";
+bool KMailConnection::connectToKMail()
+{
+  if ( !mKMailIcalIfaceStub ) {
+    QString error;
+    QCString dcopService;
+    int result = KDCOPServiceStarter::self()->
+      findServiceFor( "DCOP/ResourceBackend/IMAP", QString::null,
+                      QString::null, &error, &dcopService );
+    if ( result != 0 ) {
+      kdError(5650) << "Couldn't connect to the IMAP resource backend\n";
+      // TODO: You might want to show "error" (if not empty) here,
+      // using e.g. KMessageBox
+      return false;
+    }
+
+    mKMailIcalIfaceStub = new KMailICalIface_stub( kapp->dcopClient(),
+                                                   dcopService, dcopObjectId );
+
+    // Attach to the KMail signals
+    if ( !connectKMailSignal( "incidenceAdded(QString,QString,Q_UINT32,int,QString)",
+                              "fromKMailAddIncidence(QString,QString,Q_UINT32,int,QString)" ) )
+      kdError(5650) << "DCOP connection to incidenceAdded failed" << endl;
+    if ( !connectKMailSignal( "incidenceDeleted(QString,QString,QString)",
+                              "fromKMailDelIncidence(QString,QString,QString)" ) )
+      kdError(5650) << "DCOP connection to incidenceDeleted failed" << endl;
+    if ( !connectKMailSignal( "signalRefresh(QString,QString)",
+                              "fromKMailRefresh(QString,QString)" ) )
+      kdError(5650) << "DCOP connection to signalRefresh failed" << endl;
+    if ( !connectKMailSignal( "subresourceAdded( QString, QString, QString )",
+                              "fromKMailAddSubresource( QString, QString, QString )" ) )
+      kdError(5650) << "DCOP connection to subresourceAdded failed" << endl;
+    if ( !connectKMailSignal( "subresourceDeleted(QString,QString)",
+                              "fromKMailDelSubresource(QString,QString)" ) )
+      kdError(5650) << "DCOP connection to subresourceDeleted failed" << endl;
+    if ( !connectKMailSignal( "asyncLoadResult(QMap<Q_UINT32, QString>, QString, QString)",
+                              "fromKMailAsyncLoadResult(QMap<Q_UINT32, QString>, QString, QString)" ) )
+      kdError(5650) << "DCOP connection to asyncLoadResult failed" << endl;
+  }
+
+  return ( mKMailIcalIfaceStub != 0 );
+}
+
+bool KMailConnection::fromKMailAddIncidence( const QString& type,
+                                             const QString& folder,
+                                             Q_UINT32 sernum,
+                                             int format,
+                                             const QString& data )
+{
+  if ( format != KMailICalIface::StorageXML
+      && format != KMailICalIface::StorageIcalVcard )
+    return false;
+//   kdDebug(5650) << "KMailConnection::fromKMailAddIncidence( " << type << ", "
+//                 << folder << " ). iCal:\n" << ical << endl;
+  return mResource->fromKMailAddIncidence( type, folder, sernum, format, data );
+}
+
+void KMailConnection::fromKMailDelIncidence( const QString& type,
+                                             const QString& folder,
+                                             const QString& xml )
+{
+//   kdDebug(5650) << "KMailConnection::fromKMailDelIncidence( " << type << ", "
+//                 << folder << ", " << uid << " )\n";
+  mResource->fromKMailDelIncidence( type, folder, xml );
+}
+
+void KMailConnection::fromKMailRefresh( const QString& type, const QString& folder )
+{
+//   kdDebug(5650) << "KMailConnection::fromKMailRefresh( " << type << ", "
+//                 << folder << " )\n";
+  mResource->fromKMailRefresh( type, folder );
+}
+
+void KMailConnection::fromKMailAddSubresource( const QString& type,
+                                               const QString& resource,
+                                               const QString& label )
+{
+//   kdDebug(5650) << "KMailConnection::fromKMailAddSubresource( " << type << ", "
+//                 << resource << " )\n";
+  bool writable = true;
+
+  // TODO: This should be told by KMail right away
+  if ( connectToKMail() )
+    writable = mKMailIcalIfaceStub->isWritableFolder( type, resource );
+
+  mResource->fromKMailAddSubresource( type, resource, label, writable );
+}
+
+void KMailConnection::fromKMailDelSubresource( const QString& type,
+                                               const QString& resource )
+{
+//   kdDebug(5650) << "KMailConnection::fromKMailDelSubresource( " << type << ", "
+//                 << resource << " )\n";
+  mResource->fromKMailDelSubresource( type, resource );
+}
+
+void KMailConnection::fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                                const QString& type,
+                                                const QString& folder )
+{
+  mResource->fromKMailAsyncLoadResult( map, type, folder );
+}
+
+bool KMailConnection::connectKMailSignal( const QCString& signal,
+                                          const QCString& method )
+{
+  return connectDCOPSignal( "kmail", dcopObjectId, signal, method, false )
+    && connectDCOPSignal( "kontact", dcopObjectId, signal, method, false );
+}
+
+bool KMailConnection::kmailSubresources( QValueList<KMailICalIface::SubResource>& lst,
+                                         const QString& contentsType )
+{
+  if ( !connectToKMail() )
+    return false;
+
+  lst = mKMailIcalIfaceStub->subresourcesKolab( contentsType );
+  return mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailIncidencesCount( int& count,
+                                            const QString& mimetype,
+                                            const QString& resource )
+{
+  if ( !connectToKMail() )
+    return false;
+
+  count = mKMailIcalIfaceStub->incidencesKolabCount( mimetype, resource );
+  return mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailIncidences( QMap<Q_UINT32, QString>& lst,
+                                       const QString& mimetype,
+                                       const QString& resource,
+                                       int startIndex,
+                                       int nbMessages )
+{
+  if ( !connectToKMail() )
+    return false;
+
+  lst = mKMailIcalIfaceStub->incidencesKolab( mimetype, resource, startIndex, nbMessages );
+  return mKMailIcalIfaceStub->ok();
+}
+
+
+bool KMailConnection::kmailGetAttachment( KURL& url,
+                                          const QString& resource,
+                                          Q_UINT32 sernum,
+                                          const QString& filename )
+{
+  if ( !connectToKMail() )
+    return false;
+
+  url = mKMailIcalIfaceStub->getAttachment( resource, sernum, filename );
+  return mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailDeleteIncidence( const QString& resource,
+                                            Q_UINT32 sernum )
+{
+  return connectToKMail()
+    && mKMailIcalIfaceStub->deleteIncidenceKolab( resource, sernum )
+    && mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailUpdate( const QString& resource,
+                                   Q_UINT32& sernum,
+                                   const QString& subject,
+                                   const QString& plainTextBody,
+                                   const QMap<QCString, QString>& customHeaders,
+                                   const QStringList& attachmentURLs,
+                                   const QStringList& attachmentMimetypes,
+                                   const QStringList& attachmentNames,
+                                   const QStringList& deletedAttachments )
+{
+  //kdDebug(5006) << kdBacktrace() << endl;
+  if ( connectToKMail() ) {
+    sernum = mKMailIcalIfaceStub->update( resource, sernum, subject, plainTextBody, customHeaders,
+                                          attachmentURLs, attachmentMimetypes, attachmentNames,
+                                          deletedAttachments );
+    return sernum && mKMailIcalIfaceStub->ok();
+  } else
+    return false;
+}
+
+bool KMailConnection::kmailStorageFormat( KMailICalIface::StorageFormat& type,
+                                          const QString& folder )
+{
+  bool ok = connectToKMail();
+  type = mKMailIcalIfaceStub->storageFormat( folder );
+  return ok && mKMailIcalIfaceStub->ok();
+}
+
+
+bool KMailConnection::kmailTriggerSync( const QString &contentsType )
+{
+  bool ok = connectToKMail();
+  return ok && mKMailIcalIfaceStub->triggerSync( contentsType );
+}
+
+void KMailConnection::unregisteredFromDCOP( const QCString& appId )
+{
+  if ( mKMailIcalIfaceStub && mKMailIcalIfaceStub->app() == appId ) {
+    // Delete the stub so that the next time we need to talk to kmail,
+    // we'll know that we need to start a new one.
+    delete mKMailIcalIfaceStub;
+    mKMailIcalIfaceStub = 0;
+  }
+}
+
+#include "kmailconnection.moc"

Zmiany atrybut√≥w dla: kresources/scalix/shared
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/scalix/Makefile.am
===================================================================
--- kresources/scalix/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,4 @@
+SUBDIRS = shared kabc kcal kioslave knotes scalixadmin
+
+messages: rc.cpp
+	$(XGETTEXT) shared/*.cpp kabc/*.cpp kcal/*.cpp knotes/*.cpp -o $(podir)/kres_scalix.pot
Index: kresources/scalix/kcal/resourcescalix.h
===================================================================
--- kresources/scalix/kcal/resourcescalix.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kcal/resourcescalix.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,221 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+                  2004 Till Adam <till@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef KCAL_RESOURCESCALIX_H
+#define KCAL_RESOURCESCALIX_H
+
+#include <qtimer.h>
+
+#include <kdepimmacros.h>
+#include <libkcal/calendarlocal.h>
+#include <libkcal/icalformat.h>
+#include <libkcal/resourcecalendar.h>
+#include "../shared/resourcescalixbase.h"
+
+namespace KCal {
+
+struct TemporarySilencer;
+
+class KDE_EXPORT ResourceScalix : public KCal::ResourceCalendar,
+                      public KCal::IncidenceBase::Observer,
+                      public Scalix::ResourceScalixBase
+{
+  Q_OBJECT
+    friend struct TemporarySilencer;
+
+public:
+  ResourceScalix( const KConfig* );
+  virtual ~ResourceScalix();
+
+  /// Load resource data.
+  bool doLoad();
+
+  /// Save resource data.
+  bool doSave();
+
+  /// Open the notes resource.
+  bool doOpen();
+  /// Close the notes resource.
+  void doClose();
+
+  // The libkcal functions. See the resource for descriptions
+  bool addEvent( KCal::Event* anEvent );
+  bool deleteEvent( KCal::Event* );
+  KCal::Event* event( const QString &UniqueStr );
+  KCal::Event::List rawEvents( EventSortField sortField = EventSortUnsorted, SortDirection sortDirection = SortDirectionAscending );
+  KCal::Event::List rawEventsForDate(
+    const QDate& date,
+    EventSortField sortField=EventSortUnsorted,
+    SortDirection sortDirection=SortDirectionAscending );
+  KCal::Event::List rawEventsForDate( const QDateTime& qdt );
+  KCal::Event::List rawEvents( const QDate& start, const QDate& end,
+                               bool inclusive = false );
+
+  bool addTodo( KCal::Todo* todo );
+  bool deleteTodo( KCal::Todo* );
+  KCal::Todo* todo( const QString& uid );
+  KCal::Todo::List rawTodos( TodoSortField sortField = TodoSortUnsorted, SortDirection sortDirection = SortDirectionAscending );
+  KCal::Todo::List rawTodosForDate( const QDate& date );
+
+  bool addJournal( KCal::Journal* );
+  bool deleteJournal( KCal::Journal* );
+  KCal::Journal* journal( const QString& uid );
+  KCal::Journal::List rawJournals( JournalSortField sortField = JournalSortUnsorted, SortDirection sortDirection = SortDirectionAscending );
+  KCal::Journal::List rawJournalsForDate( const QDate &date );
+
+  KCal::Alarm::List alarms( const QDateTime& from, const QDateTime& to );
+  KCal::Alarm::List alarmsTo( const QDateTime& to );
+
+  void setTimeZoneId( const QString& tzid );
+
+  bool deleteIncidence( KCal::Incidence* i );
+
+  /// The ResourceScalixBase methods called by KMail
+  bool fromKMailAddIncidence( const QString& type, const QString& subResource,
+                              Q_UINT32 sernum, int format, const QString& data );
+  void fromKMailDelIncidence( const QString& type, const QString& subResource,
+                              const QString& uid );
+  void fromKMailRefresh( const QString& type, const QString& subResource );
+
+  /// Listen to KMail changes in the amount of sub resources
+  void fromKMailAddSubresource( const QString& type, const QString& subResource,
+                                const QString& label, bool writable );
+  void fromKMailDelSubresource( const QString& type, const QString& subResource );
+
+  void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                 const QString& type,
+                                 const QString& folder );
+
+  /** Return the list of subresources. */
+  QStringList subresources() const;
+
+  /** Is this subresource active? */
+  bool subresourceActive( const QString& ) const;
+  /** (De)activate the subresource */
+  virtual void setSubresourceActive( const QString &, bool );
+
+  /** What is the label for this subresource? */
+  virtual const QString labelForSubresource( const QString& resource ) const;
+
+  virtual QString subresourceIdentifier( Incidence *incidence );
+
+  KABC::Lock* lock();
+
+signals:
+  void useGlobalMode();
+protected slots:
+   void slotEmitResourceChanged();
+
+private:
+  void removeIncidences( const QCString& incidenceType );
+  void resolveConflict( KCal::Incidence*, const QString& subresource, Q_UINT32 sernum );
+
+  void addIncidence( const char* mimetype, const QString& xml,
+                     const QString& subResource, Q_UINT32 sernum );
+
+  bool addIncidence( KCal::Incidence* i, const QString& subresource,
+                     Q_UINT32 sernum );
+/*
+  void addEvent( const QString& xml, const QString& subresource,
+                 Q_UINT32 sernum );
+  void addTodo( const QString& xml, const QString& subresource,
+                Q_UINT32 sernum );
+  void addJournal( const QString& xml, const QString& subresource,
+                   Q_UINT32 sernum );
+*/
+
+  bool loadAllEvents();
+  bool loadAllTodos();
+  bool loadAllJournals();
+
+  bool doLoadAll( Scalix::ResourceMap& map, const char* mimetype );
+
+  /// Reimplemented from IncidenceBase::Observer to know when an incidence was changed
+  void incidenceUpdated( KCal::IncidenceBase* );
+
+  bool openResource( KConfig& config, const char* contentType,
+                     Scalix::ResourceMap& map );
+  void loadSubResourceConfig( KConfig& config, const QString& name,
+                              const QString& label, bool writable,
+                              Scalix::ResourceMap& subResource );
+  bool loadSubResource( const QString& subResource, const char* mimetype );
+
+  QString configFile() const {
+    return ResourceScalixBase::configFile( "kcal" );
+  }
+
+  Scalix::ResourceMap* subResourceMap( const QString& contentsType );
+
+  bool sendKMailUpdate( KCal::IncidenceBase* incidence, const QString& _subresource,
+                        Q_UINT32 sernum );
+
+
+  KCal::CalendarLocal mCalendar;
+
+  // The list of subresources
+  Scalix::ResourceMap mEventSubResources, mTodoSubResources, mJournalSubResources;
+
+  bool mOpen; // If the resource is open, this is true
+  QDict<KCal::IncidenceBase> mPendingUpdates;
+  QTimer mResourceChangedTimer;
+  ICalFormat mFormat;
+
+  /**
+    This map contains the association between a new added incidence
+    and the subresource it belongs to.
+    That's needed to return the correct mapping in subresourceIdentifier().
+
+    We can't trust on mUidMap here, because it contains only non-pending uids.
+   */
+  QMap<QString, QString> mNewIncidencesMap;
+  int mProgressDialogIncidenceLimit;
+};
+
+struct TemporarySilencer {
+ TemporarySilencer( ResourceScalix *_resource )
+  {
+    resource = _resource;
+    oldValue = resource->mSilent;
+    resource->mSilent = true;
+  }
+  ~TemporarySilencer()
+  {
+    resource->mSilent = oldValue;
+  }
+  ResourceScalix *resource;
+  bool oldValue;
+};
+
+}
+
+#endif // KCAL_RESOURCESCALIX_H
Index: kresources/scalix/kcal/Makefile.am
===================================================================
--- kresources/scalix/kcal/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kcal/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,27 @@
+METASOURCES = AUTO
+
+INCLUDES = -I$(top_srcdir)/kresources/scalix/shared -I$(top_srcdir) \
+        -I$(top_builddir)/libkdepim $(all_includes)
+
+# The scalix wizard links to this library too
+lib_LTLIBRARIES = libkcalscalix.la
+
+libkcalscalix_la_SOURCES = resourcescalix.cpp
+libkcalscalix_la_LDFLAGS = $(all_libraries) -no-undefined
+libkcalscalix_la_LIBADD = $(top_builddir)/libkcal/libkcal.la \
+	$(top_builddir)/kresources/scalix/shared/libresourcescalixshared.la \
+	-lkresources
+
+kde_module_LTLIBRARIES = kcal_scalix.la
+
+kcal_scalix_la_SOURCES = resourcescalix_plugin.cpp
+kcal_scalix_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
+kcal_scalix_la_LIBADD = libkcalscalix.la
+
+servicedir = $(kde_servicesdir)/kresources/kcal
+service_DATA = scalix.desktop
+
+install-data-local: $(srcdir)/../uninstall.desktop
+	$(mkinstalldirs) $(DESTDIR)$(servicedir)
+	$(INSTALL_DATA) $(srcdir)/../uninstall.desktop $(DESTDIR)$(servicedir)/imap.desktop
+
Index: kresources/scalix/kcal/resourcescalix_plugin.cpp
===================================================================
--- kresources/scalix/kcal/resourcescalix_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kcal/resourcescalix_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,50 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+        <info@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+class ScalixFactory : public KRES::PluginFactoryBase
+{
+public:
+  KRES::Resource *resource( const KConfig *config )
+  {
+    return new KCal::ResourceScalix( config );
+  }
+
+  KRES::ConfigWidget *configWidget( QWidget* )
+  {
+    return 0;
+  }
+};
+
+K_EXPORT_COMPONENT_FACTORY(kcal_scalix,ScalixFactory)
Index: kresources/scalix/kcal/scalix.desktop
===================================================================
--- kresources/scalix/kcal/scalix.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kcal/scalix.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,13 @@
+[Desktop Entry]
+Encoding=UTF-8
+Name=Calendar on Scalix Server via KMail
+Name[bg]=–ö–∞–ª–µ–Ω–¥–∞—Ä –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞ Scalix —á—Ä–µ–∑ KMail
+Name[da]=Kalender p√• Scalix-server via KMail
+Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø œÉŒµ ŒµŒæœÖœÄŒ∑œÅŒµœÑŒ∑œÑŒÆ Scalix ŒºŒ≠œÉœâ œÑŒøœÖ KMail
+Name[sk]=Kalend√°r na Scalix serveri pomocou KMail
+Name[sv]=Kalender p√• Scalix-server via Kmail
+X-KDE-Library=kcal_scalix
+Type=Service
+ServiceTypes=KResources/Plugin
+X-KDE-ResourceFamily=calendar
+X-KDE-ResourceType=scalix
Index: kresources/scalix/kcal/resourcescalix.cpp
===================================================================
--- kresources/scalix/kcal/resourcescalix.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kcal/resourcescalix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,885 @@
+/*
+    This file is part of the scalix resource - based on the kolab resource.
+
+    Copyright (c) 2004 Bo Thorsen <bo@sonofthor.dk>
+                  2004 Till Adam <till@klaralvdalens-datakonsult.se>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include "resourcescalix.h"
+
+#include <kio/observer.h>
+#include <kio/uiserver_stub.h>
+#include <kapplication.h>
+#include <dcopclient.h>
+#include <libkcal/icalformat.h>
+#include <libkdepim/kincidencechooser.h>
+#include <kabc/locknull.h>
+#include <kmainwindow.h>
+#include <klocale.h>
+
+#include <qobject.h>
+#include <qtimer.h>
+#include <qapplication.h>
+
+#include <assert.h>
+
+using namespace KCal;
+using namespace Scalix;
+
+static const char* kmailCalendarContentsType = "Calendar";
+static const char* kmailTodoContentsType = "Task";
+static const char* kmailJournalContentsType = "Journal";
+static const char* eventAttachmentMimeType = "application/x-vnd.kolab.event";
+static const char* todoAttachmentMimeType = "application/x-vnd.kolab.task";
+static const char* journalAttachmentMimeType = "application/x-vnd.kolab.journal";
+static const char* incidenceInlineMimeType = "text/calendar";
+
+
+ResourceScalix::ResourceScalix( const KConfig *config )
+  : ResourceCalendar( config ), ResourceScalixBase( "ResourceScalix-libkcal" ),
+    mCalendar( QString::fromLatin1("UTC") ), mOpen( false )
+{
+  setType( "scalix" );
+  connect( &mResourceChangedTimer, SIGNAL( timeout() ),
+           this, SLOT( slotEmitResourceChanged() ) );
+}
+
+ResourceScalix::~ResourceScalix()
+{
+  // The resource is deleted on exit (StdAddressBook's KStaticDeleter),
+  // and it wasn't closed before that, so close here to save the config.
+  if ( mOpen ) {
+    close();
+  }
+}
+
+void ResourceScalix::loadSubResourceConfig( KConfig& config,
+                                           const QString& name,
+                                           const QString& label,
+                                           bool writable,
+                                           ResourceMap& subResource )
+{
+  KConfigGroup group( &config, name );
+  bool active = group.readBoolEntry( "Active", true );
+  subResource.insert( name, Scalix::SubResource( active, writable, label ) );
+}
+
+bool ResourceScalix::openResource( KConfig& config, const char* contentType,
+                                  ResourceMap& map )
+{
+  // Read the subresource entries from KMail
+  QValueList<KMailICalIface::SubResource> subResources;
+  if ( !kmailSubresources( subResources, contentType ) )
+    return false;
+  map.clear();
+  QValueList<KMailICalIface::SubResource>::ConstIterator it;
+  for ( it = subResources.begin(); it != subResources.end(); ++it )
+    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, map );
+  return true;
+}
+
+bool ResourceScalix::doOpen()
+{
+  if ( mOpen )
+    // Already open
+    return true;
+  mOpen = true;
+
+  KConfig config( configFile() );
+  config.setGroup( "General" );
+  mProgressDialogIncidenceLimit = config.readNumEntry("ProgressDialogIncidenceLimit", 200);
+
+  return openResource( config, kmailCalendarContentsType, mEventSubResources )
+    && openResource( config, kmailTodoContentsType, mTodoSubResources )
+    && openResource( config, kmailJournalContentsType, mJournalSubResources );
+}
+
+static void closeResource( KConfig& config, ResourceMap& map )
+{
+  ResourceMap::ConstIterator it;
+  for ( it = map.begin(); it != map.end(); ++it ) {
+    config.setGroup( it.key() );
+    config.writeEntry( "Active", it.data().active() );
+  }
+}
+
+void ResourceScalix::doClose()
+{
+  if ( !mOpen )
+    // Not open
+    return;
+  mOpen = false;
+
+  KConfig config( configFile() );
+  closeResource( config, mEventSubResources );
+  closeResource( config, mTodoSubResources );
+  closeResource( config, mJournalSubResources );
+}
+
+bool ResourceScalix::loadSubResource( const QString& subResource,
+                                     const char* mimetype )
+{
+  int count = 0;
+  if ( !kmailIncidencesCount( count, mimetype, subResource ) ) {
+    kdError(5650) << "Communication problem in ResourceScalix::load()\n";
+    return false;
+  }
+
+  if ( !count )
+    return true;
+
+  const int nbMessages = 200; // read 200 mails at a time (see kabc resource)
+
+  const QString labelTxt = !strcmp(mimetype, "application/x-vnd.kolab.task") ? i18n( "Loading tasks..." )
+                           : !strcmp(mimetype, "application/x-vnd.kolab.journal") ? i18n( "Loading journals..." )
+                           : i18n( "Loading events..." );
+  const bool useProgress = qApp && qApp->type() != QApplication::Tty && count > mProgressDialogIncidenceLimit;
+  if ( useProgress )
+    (void)::Observer::self(); // ensure kio_uiserver is running
+  UIServer_stub uiserver( "kio_uiserver", "UIServer" );
+  int progressId = 0;
+  if ( useProgress ) {
+    progressId = uiserver.newJob( kapp->dcopClient()->appId(), true );
+    uiserver.totalFiles( progressId, count );
+    uiserver.infoMessage( progressId, labelTxt );
+    uiserver.transferring( progressId, labelTxt );
+  }
+
+  for ( int startIndex = 0; startIndex < count; startIndex += nbMessages ) {
+    QMap<Q_UINT32, QString> lst;
+    if ( !kmailIncidences( lst, mimetype, subResource, startIndex, nbMessages ) ) {
+      kdError(5650) << "Communication problem in ResourceScalix::load()\n";
+      if ( progressId )
+        uiserver.jobFinished( progressId );
+      return false;
+    }
+
+    { // for RAII scoping below
+      TemporarySilencer t( this );
+      for( QMap<Q_UINT32, QString>::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
+        addIncidence( mimetype, it.data(), subResource, it.key() );
+      }
+    }
+    if ( progressId ) {
+      uiserver.processedFiles( progressId, startIndex );
+      uiserver.percent( progressId, 100 * startIndex / count );
+    }
+  }
+
+  if ( progressId )
+    uiserver.jobFinished( progressId );
+  return true;
+}
+
+bool ResourceScalix::doLoad()
+{
+  mUidMap.clear();
+
+  return loadAllEvents() & loadAllTodos() & loadAllJournals();
+}
+
+bool ResourceScalix::doLoadAll( ResourceMap& map, const char* mimetype )
+{
+  bool rc = true;
+  for ( ResourceMap::ConstIterator it = map.begin(); it != map.end(); ++it ) {
+    if ( !it.data().active() )
+      // This resource is disabled
+      continue;
+
+    rc &= loadSubResource( it.key(), mimetype );
+  }
+  return rc;
+}
+
+bool ResourceScalix::loadAllEvents()
+{
+  removeIncidences( "Event" );
+  mCalendar.deleteAllEvents();
+  return doLoadAll( mEventSubResources, incidenceInlineMimeType );
+}
+
+bool ResourceScalix::loadAllTodos()
+{
+  removeIncidences( "Todo" );
+  mCalendar.deleteAllTodos();
+  return doLoadAll( mTodoSubResources, incidenceInlineMimeType );
+}
+
+bool ResourceScalix::loadAllJournals()
+{
+  removeIncidences( "Journal" );
+  mCalendar.deleteAllJournals();
+  return doLoadAll( mJournalSubResources, incidenceInlineMimeType );
+}
+
+void ResourceScalix::removeIncidences( const QCString& incidenceType )
+{
+  Scalix::UidMap::Iterator mapIt = mUidMap.begin();
+  while ( mapIt != mUidMap.end() )
+  {
+    Scalix::UidMap::Iterator it = mapIt++;
+    // Check the type of this uid: event, todo or journal.
+    // Need to look up in mCalendar for that. Given the implementation of incidence(uid),
+    // better call event(uid), todo(uid) etc. directly.
+
+    // A  faster but hackish way would probably be to check the type of the resource,
+    // like mEventSubResources.find( it.data().resource() ) != mEventSubResources.end() ?
+    const QString& uid = it.key();
+    if ( incidenceType == "Event" && mCalendar.event( uid ) )
+      mUidMap.remove( it );
+    else if ( incidenceType == "Todo" && mCalendar.todo( uid ) )
+      mUidMap.remove( it );
+    else if ( incidenceType == "Journal" && mCalendar.journal( uid ) )
+      mUidMap.remove( it );
+  }
+}
+
+bool ResourceScalix::doSave()
+{
+  return true;
+}
+
+void ResourceScalix::incidenceUpdated( KCal::IncidenceBase* incidencebase )
+{
+  if ( incidencebase->isReadOnly() ) return; // Should not happen (TM)
+  incidencebase->setSyncStatus( KCal::Event::SYNCMOD );
+  incidencebase->setLastModified( QDateTime::currentDateTime() );
+  // we should probably update the revision number here,
+  // or internally in the Event itself when certain things change.
+  // need to verify with ical documentation.
+
+  const QString uid = incidencebase->uid();
+
+  if ( mUidsPendingUpdate.contains( uid ) || mUidsPendingAdding.contains( uid ) ) {
+    /* We are currently processing this event ( removing and readding or
+     * adding it ). If so, ignore this update. Keep the last of these around
+     * and process once we hear back from KMail on this event. */
+    mPendingUpdates.replace( uid, incidencebase );
+    return;
+  }
+
+  QString subResource;
+  Q_UINT32 sernum = 0;
+  if ( mUidMap.contains( uid ) ) {
+    subResource = mUidMap[ uid ].resource();
+    sernum = mUidMap[ uid ].serialNumber();
+    mUidsPendingUpdate.append( uid );
+  }
+  sendKMailUpdate( incidencebase, subResource, sernum );
+}
+
+void ResourceScalix::resolveConflict( KCal::Incidence* inc, const QString& subresource, Q_UINT32 sernum )
+{
+    if ( ! inc )
+        return;
+    if ( ! mResolveConflict ) {
+        // we should do no conflict resolution
+        delete inc;
+        return;
+    }
+    Incidence* local = mCalendar.incidence( inc->uid() );
+    Incidence* localIncidence = 0;
+    Incidence* addedIncidence = 0;
+    if ( local ) {
+        KIncidenceChooser* ch = new KIncidenceChooser();
+        ch->setIncidence( local ,inc );
+        if ( KIncidenceChooser::chooseMode == KIncidenceChooser::ask ) {
+            connect ( this, SIGNAL( useGlobalMode() ), ch, SLOT (  useGlobalMode() ) );
+            if ( ch->exec() )
+                if ( KIncidenceChooser::chooseMode != KIncidenceChooser::ask )
+                    emit useGlobalMode() ;
+        }
+        Incidence* result = ch->getIncidence();
+      delete ch;
+      if ( result == local ) {
+          localIncidence = local->clone();
+          delete inc;
+      } else  if ( result == inc ) {
+          addedIncidence = inc;
+      } else if ( result == 0 ) { // take both
+          localIncidence = local->clone();
+          localIncidence->recreate();
+          localIncidence->setSummary( i18n("Copy of: %1").arg(localIncidence->summary()) );
+          addedIncidence = inc;
+      }
+      bool silent = mSilent;
+      mSilent = false;
+      deleteIncidence( local ); // remove local from kmail
+      kmailDeleteIncidence( subresource, sernum );// remove new from kmail
+      if ( localIncidence ) {
+        addIncidence( localIncidence, subresource, 0  );
+        mUidsPendingAdding.remove( localIncidence->uid() ); // we do want to inform KOrg also
+      }
+      if ( addedIncidence  ) {
+        addIncidence( addedIncidence, subresource, 0  );
+        mUidsPendingAdding.remove( addedIncidence->uid() ); // we do want to inform KOrg also
+      }
+      mSilent = silent;
+  }
+}
+void ResourceScalix::addIncidence( const char* mimetype, const QString& data,
+                                  const QString& subResource, Q_UINT32 sernum )
+{
+  // This uses pointer comparison, so it only works if we use the static
+  // objects defined in the top of the file
+  Incidence *inc = mFormat.fromString( data );
+  addIncidence( inc, subResource, sernum );
+}
+
+
+bool ResourceScalix::sendKMailUpdate( KCal::IncidenceBase* incidencebase, const QString& subresource,
+                                     Q_UINT32 sernum )
+{
+  const QString& type = incidencebase->type();
+  const char* mimetype = 0;
+  QString data;
+  if ( type == "Event" ) {
+    mimetype = incidenceInlineMimeType;
+    data = mFormat.createScheduleMessage( static_cast<KCal::Event *>(incidencebase),
+        Scheduler::Publish );
+  } else if ( type == "Todo" ) {
+    mimetype = incidenceInlineMimeType;
+    data = mFormat.createScheduleMessage( static_cast<KCal::Todo *>(incidencebase),
+        Scheduler::Publish );
+  } else if ( type == "Journal" ) {
+    mimetype = incidenceInlineMimeType;
+    data = mFormat.createScheduleMessage( static_cast<KCal::Journal *>(incidencebase),
+        Scheduler::Publish );
+  } else {
+    kdWarning(5006) << "Can't happen: unhandled type=" << type << endl;
+  }
+
+//  kdDebug() << k_funcinfo << "Data string:\n" << data << endl;
+
+  KCal::Incidence* incidence = static_cast<KCal::Incidence *>( incidencebase );
+  CustomHeaderMap customHeaders;
+
+  if ( type == "Event" )
+    customHeaders.insert( "X-Scalix-Class", "IPM.Appointment" );
+  else if ( type == "Todo" )
+    customHeaders.insert( "X-Scalix-Class", "IPM.Task" );
+
+  QString subject = incidence->summary();
+
+  // behold, sernum is an in-parameter
+  const bool rc = kmailUpdate( subresource, sernum, data, mimetype, subject, customHeaders );
+  // update the serial number
+  if ( mUidMap.contains( incidencebase->uid() ) ) {
+    mUidMap[ incidencebase->uid() ].setSerialNumber( sernum );
+  }
+  return rc;
+}
+
+bool ResourceScalix::addIncidence( KCal::Incidence* incidence, const QString& _subresource,
+                                  Q_UINT32 sernum )
+{
+  Q_ASSERT( incidence );
+  if ( !incidence ) return false;
+  const QString &uid = incidence->uid();
+  QString subResource = _subresource;
+
+  Scalix::ResourceMap *map = &mEventSubResources; // don't use a ref here!
+
+  const QString& type = incidence->type();
+  if ( type == "Event" )
+    map = &mEventSubResources;
+  else if ( type == "Todo" )
+    map = &mTodoSubResources;
+  else if ( type == "Journal" )
+    map = &mJournalSubResources;
+  else
+    kdWarning() << "unknown type " << type << endl;
+
+  if ( !mSilent ) { /* We got this one from the user, tell KMail. */
+    // Find out if this event was previously stored in KMail
+    bool newIncidence = _subresource.isEmpty();
+    if ( newIncidence ) {
+      subResource = findWritableResource( *map );
+    }
+
+    if ( subResource.isEmpty() )
+      return false;
+
+    mNewIncidencesMap.insert( uid, subResource );
+
+    if ( !sendKMailUpdate( incidence, subResource, sernum ) ) {
+      kdError(5650) << "Communication problem in ResourceScalix::addIncidence()\n";
+      return false;
+    } else {
+      // KMail is doing it's best to add the event now, put a sticker on it,
+      // so we know it's one of our transient ones
+      mUidsPendingAdding.append( uid );
+
+      /* Add to the cache immediately if this is a new event coming from
+       * KOrganizer. It relies on the incidence being in the calendar when
+       * addIncidence returns. */
+      if ( newIncidence ) {
+        mCalendar.addIncidence( incidence );
+        incidence->registerObserver( this );
+      }
+    }
+  } else { /* KMail told us */
+    bool ourOwnUpdate = false;
+    /* Check if we updated this one, which means kmail deleted and added it.
+     * We know the new state, so lets just not do much at all. The old incidence
+     * in the calendar remains valid, but the serial number changed, so we need to
+     * update that */
+    if ( ourOwnUpdate = mUidsPendingUpdate.contains( uid ) ) {
+      mUidsPendingUpdate.remove( uid );
+      mUidMap.remove( uid );
+      mUidMap[ uid ] = StorageReference( subResource, sernum );
+    } else {
+      /* This is a real add, from KMail, we didn't trigger this ourselves.
+       * If this uid already exists in this folder, do conflict resolution,
+       * unless the folder is read-only, in which case the user should not be
+       * offered a means of putting mails in a folder she'll later be unable to
+       * upload. Skip the incidence, in this case. */
+      if ( mUidMap.contains( uid )
+          && ( mUidMap[ uid ].resource() == subResource ) ) {
+        if ( (*map)[ subResource ].writable() ) {
+          resolveConflict( incidence, subResource, sernum );
+        } else {
+          kdWarning( 5650 ) << "Duplicate event in a read-only folder detected! "
+            "Please inform the owner of the folder. " << endl;
+        }
+        return true;
+      }
+      /* Add to the cache if the add didn't come from KOrganizer, in which case
+       * we've already added it, and listen to updates from KOrganizer for it. */
+      if ( !mUidsPendingAdding.contains( uid ) ) {
+        mCalendar.addIncidence( incidence );
+        incidence->registerObserver( this );
+      }
+      if ( !subResource.isEmpty() && sernum != 0 ) {
+        mUidMap[ uid ] = StorageReference( subResource, sernum );
+        incidence->setReadOnly( !(*map)[ subResource ].writable() );
+      }
+    }
+    /* Check if there are updates for this uid pending and if so process them. */
+    if ( KCal::IncidenceBase *update = mPendingUpdates.find( uid ) ) {
+      mSilent = false; // we do want to tell KMail
+      mPendingUpdates.remove( uid );
+      incidenceUpdated( update );
+    } else {
+      /* If the uid was added by KMail, KOrganizer needs to be told, so
+       * schedule emitting of the resourceChanged signal. */
+      if ( !mUidsPendingAdding.contains( uid ) ) {
+        if ( !ourOwnUpdate ) mResourceChangedTimer.changeInterval( 100 );
+      } else {
+        mUidsPendingAdding.remove( uid );
+      }
+    }
+
+    mNewIncidencesMap.remove( uid );
+  }
+  return true;
+}
+
+
+bool ResourceScalix::addEvent( KCal::Event* event )
+{
+  if ( mUidMap.contains( event->uid() ) )
+    return true; //noop
+  else
+    return addIncidence( event, QString::null, 0 );
+}
+
+bool ResourceScalix::deleteIncidence( KCal::Incidence* incidence )
+{
+  if ( incidence->isReadOnly() ) return false;
+
+  const QString uid = incidence->uid();
+  if( !mUidMap.contains( uid ) ) return false; // Odd
+  /* The user told us to delete, tell KMail */
+  if ( !mSilent ) {
+    kmailDeleteIncidence( mUidMap[ uid ].resource(),
+                          mUidMap[ uid ].serialNumber() );
+    mUidsPendingDeletion.append( uid );
+    incidence->unRegisterObserver( this );
+    mCalendar.deleteIncidence( incidence );
+    mUidMap.remove( uid );
+  } else {
+    assert( false ); // If this still happens, something is very wrong
+  }
+  return true;
+}
+
+bool ResourceScalix::deleteEvent( KCal::Event* event )
+{
+  return deleteIncidence( event );
+}
+
+KCal::Event* ResourceScalix::event( const QString& uid )
+{
+  return mCalendar.event(uid);
+}
+
+KCal::Event::List ResourceScalix::rawEvents( EventSortField sortField, SortDirection sortDirection )
+{
+  return mCalendar.rawEvents( sortField, sortDirection );
+}
+
+KCal::Event::List ResourceScalix::rawEventsForDate( const QDate& date,
+                                                   EventSortField sortField,
+                                                   SortDirection sortDirection )
+{
+  return mCalendar.rawEventsForDate( date, sortField, sortDirection );
+}
+
+KCal::Event::List ResourceScalix::rawEventsForDate( const QDateTime& qdt )
+{
+  return mCalendar.rawEventsForDate( qdt );
+}
+
+KCal::Event::List ResourceScalix::rawEvents( const QDate& start,
+                                            const QDate& end,
+                                            bool inclusive )
+{
+  return mCalendar.rawEvents( start, end, inclusive );
+}
+
+bool ResourceScalix::addTodo( KCal::Todo* todo )
+{
+  if ( mUidMap.contains( todo->uid() ) )
+    return true; //noop
+  else
+    return addIncidence( todo, QString::null, 0 );
+}
+
+bool ResourceScalix::deleteTodo( KCal::Todo* todo )
+{
+  return deleteIncidence( todo );
+}
+
+KCal::Todo* ResourceScalix::todo( const QString& uid )
+{
+  return mCalendar.todo( uid );
+}
+
+KCal::Todo::List ResourceScalix::rawTodos( TodoSortField sortField, SortDirection sortDirection )
+{
+  return mCalendar.rawTodos( sortField, sortDirection );
+}
+
+KCal::Todo::List ResourceScalix::rawTodosForDate( const QDate& date )
+{
+  return mCalendar.rawTodosForDate( date );
+}
+
+bool ResourceScalix::addJournal( KCal::Journal* journal )
+{
+  if ( mUidMap.contains( journal->uid() ) )
+    return true; //noop
+  else
+    return addIncidence( journal, QString::null, 0 );
+}
+
+bool ResourceScalix::deleteJournal( KCal::Journal* journal )
+{
+  return deleteIncidence( journal );
+}
+
+KCal::Journal* ResourceScalix::journal( const QString& uid )
+{
+  return mCalendar.journal(uid);
+}
+
+KCal::Journal::List ResourceScalix::rawJournals( JournalSortField sortField, SortDirection sortDirection )
+{
+  return mCalendar.rawJournals( sortField, sortDirection );
+}
+
+KCal::Journal::List ResourceScalix::rawJournalsForDate( const QDate &date )
+{
+  return mCalendar.rawJournalsForDate( date );
+}
+
+KCal::Alarm::List ResourceScalix::alarms( const QDateTime& from,
+                                         const QDateTime& to )
+{
+  return mCalendar.alarms( from, to );
+}
+
+KCal::Alarm::List ResourceScalix::alarmsTo( const QDateTime& to )
+{
+  return mCalendar.alarmsTo(to);
+}
+
+void ResourceScalix::setTimeZoneId( const QString& tzid )
+{
+  mCalendar.setTimeZoneId( tzid );
+  mFormat.setTimeZone( mCalendar.timeZoneId(), !mCalendar.isLocalTime() );
+}
+
+bool ResourceScalix::fromKMailAddIncidence( const QString& type,
+                                           const QString& subResource,
+                                           Q_UINT32 sernum,
+                                           int /*format*/,
+                                           const QString& data )
+{
+  bool rc = true;
+  TemporarySilencer t( this ); // RAII
+  if ( type != kmailCalendarContentsType && type != kmailTodoContentsType
+       && type != kmailJournalContentsType )
+    // Not ours
+    return false;
+  if ( !subresourceActive( subResource ) ) return true;
+
+  Incidence *inc = mFormat.fromString( data );
+  if ( !inc )
+    rc = false;
+  else
+    addIncidence( inc, subResource, sernum );
+
+  return rc;
+}
+
+void ResourceScalix::fromKMailDelIncidence( const QString& type,
+                                           const QString& subResource,
+                                           const QString& uid )
+{
+  if ( type != kmailCalendarContentsType && type != kmailTodoContentsType
+       && type != kmailJournalContentsType )
+    // Not ours
+    return;
+  if ( !subresourceActive( subResource ) ) return;
+
+  // Can't be in both, by contract
+  if ( mUidsPendingDeletion.contains( uid ) ) {
+    mUidsPendingDeletion.remove( uid );
+  } else if ( mUidsPendingUpdate.contains( uid ) ) {
+    // It's good to know if was deleted, but we are waiting on a new one to
+    // replace it, so let's just sit tight.
+  } else {
+    // We didn't trigger this, so KMail did, remove the reference to the uid
+    KCal::Incidence* incidence = mCalendar.incidence( uid );
+    if( incidence ) {
+      incidence->unRegisterObserver( this );
+      mCalendar.deleteIncidence( incidence );
+    }
+    mUidMap.remove( uid );
+    mResourceChangedTimer.changeInterval( 100 );
+  }
+}
+
+void ResourceScalix::fromKMailRefresh( const QString& type,
+                                      const QString& /*subResource*/ )
+{
+  // TODO: Only load the specified subResource
+  if ( type == "Calendar" )
+    loadAllEvents();
+  else if ( type == "Task" )
+    loadAllTodos();
+  else if ( type == "Journal" )
+    loadAllJournals();
+  else
+    kdWarning(5006) << "KCal Scalix resource: fromKMailRefresh: unknown type " << type << endl;
+  mResourceChangedTimer.changeInterval( 100 );
+}
+
+void ResourceScalix::fromKMailAddSubresource( const QString& type,
+                                             const QString& subResource,
+                                             const QString& label,
+                                             bool writable )
+{
+  ResourceMap* map = 0;
+  const char* mimetype = 0;
+  if ( type == kmailCalendarContentsType ) {
+    map = &mEventSubResources;
+    mimetype = eventAttachmentMimeType;
+  } else if ( type == kmailTodoContentsType ) {
+    map = &mTodoSubResources;
+    mimetype = todoAttachmentMimeType;
+  } else if ( type == kmailJournalContentsType ) {
+    map = &mJournalSubResources;
+    mimetype = journalAttachmentMimeType;
+  } else
+    // Not ours
+    return;
+
+  if ( map->contains( subResource ) )
+    // Already registered
+    return;
+
+  KConfig config( configFile() );
+  config.setGroup( subResource );
+
+  bool active = config.readBoolEntry( subResource, true );
+  (*map)[ subResource ] = Scalix::SubResource( active, writable, label );
+  loadSubResource( subResource, mimetype );
+  emit signalSubresourceAdded( this, type, subResource, label );
+}
+
+void ResourceScalix::fromKMailDelSubresource( const QString& type,
+                                             const QString& subResource )
+{
+  ResourceMap* map = subResourceMap( type );
+  if ( !map ) // not ours
+    return;
+  if ( map->contains( subResource ) )
+    map->erase( subResource );
+  else
+    // Not registered
+    return;
+
+  // Delete from the config file
+  KConfig config( configFile() );
+  config.deleteGroup( subResource );
+  config.sync();
+
+  // Make a list of all uids to remove
+  Scalix::UidMap::ConstIterator mapIt;
+  QStringList uids;
+  for ( mapIt = mUidMap.begin(); mapIt != mUidMap.end(); ++mapIt )
+    if ( mapIt.data().resource() == subResource )
+      // We have a match
+      uids << mapIt.key();
+
+  // Finally delete all the incidences
+  if ( !uids.isEmpty() ) {
+    TemporarySilencer t( this );
+    QStringList::ConstIterator it;
+    for ( it = uids.begin(); it != uids.end(); ++it ) {
+      KCal::Incidence* incidence = mCalendar.incidence( *it );
+      if( incidence )
+        mCalendar.deleteIncidence( incidence );
+      mUidMap.remove( *it );
+    }
+  }
+
+  emit signalSubresourceRemoved( this, type, subResource );
+}
+
+QStringList ResourceScalix::subresources() const
+{
+  // Workaround: The ResourceView in KOrganizer wants to know this
+  // before it opens the resource :-( Make sure we are open
+  const_cast<ResourceScalix*>( this )->doOpen();
+  return ( mEventSubResources.keys()
+         + mTodoSubResources.keys()
+         + mJournalSubResources.keys() );
+}
+
+const QString
+ResourceScalix::labelForSubresource( const QString& subresource ) const
+{
+  if ( mEventSubResources.contains( subresource ) )
+    return mEventSubResources[ subresource ].label();
+  if ( mTodoSubResources.contains( subresource ) )
+    return mTodoSubResources[ subresource ].label();
+  if ( mJournalSubResources.contains( subresource ) )
+    return mJournalSubResources[ subresource ].label();
+  return subresource;
+}
+
+QString ResourceScalix::subresourceIdentifier( Incidence *incidence )
+{
+  QString uid = incidence->uid();
+  if ( mUidMap.contains( uid ) )
+    return mUidMap[ uid ].resource();
+  else
+    if ( mNewIncidencesMap.contains( uid ) )
+      return mNewIncidencesMap[ uid ];
+    else
+      return QString();
+}
+
+void ResourceScalix::fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
+                                              const QString& type,
+                                              const QString& folder )
+{
+  TemporarySilencer t( this );
+  for( QMap<Q_UINT32, QString>::ConstIterator it = map.begin(); it != map.end(); ++it )
+    addIncidence( type.latin1(), it.data(), folder, it.key() );
+}
+
+bool ResourceScalix::subresourceActive( const QString& subresource ) const
+{
+  // Workaround: The ResourceView in KOrganizer wants to know this
+  // before it opens the resource :-( Make sure we are open
+  const_cast<ResourceScalix*>( this )->doOpen();
+
+  if ( mEventSubResources.contains( subresource ) )
+    return mEventSubResources[ subresource ].active();
+  if ( mTodoSubResources.contains( subresource ) )
+    return mTodoSubResources[ subresource ].active();
+  if ( mJournalSubResources.contains( subresource ) )
+    return mJournalSubResources[ subresource ].active();
+
+  // Safe default bet:
+  kdDebug(5650) << "subresourceActive( " << subresource << " ): Safe bet\n";
+
+  return true;
+}
+
+void ResourceScalix::setSubresourceActive( const QString &subresource, bool v )
+{
+  ResourceMap *map = 0;
+
+  if ( mEventSubResources.contains( subresource ) )
+     map = &mEventSubResources;
+  if ( mTodoSubResources.contains( subresource ) )
+     map = &mTodoSubResources;
+  if ( mJournalSubResources.contains( subresource ) )
+     map = &mJournalSubResources;
+
+  if ( map && ( ( *map )[ subresource ].active() != v ) ) {
+    ( *map )[ subresource ].setActive( v );
+    doLoad();                     // refresh the mCalendar cache
+    mResourceChangedTimer.changeInterval( 100 );
+  }
+}
+
+void ResourceScalix::slotEmitResourceChanged()
+{
+   kdDebug(5650) << "KCal Scalix resource: emitting resource changed " << endl;
+   mResourceChangedTimer.stop();
+   emit resourceChanged( this );
+}
+
+KABC::Lock* ResourceScalix::lock()
+{
+  return new KABC::LockNull( true );
+}
+
+
+Scalix::ResourceMap* ResourceScalix::subResourceMap( const QString& contentsType )
+{
+  if ( contentsType == kmailCalendarContentsType ) {
+    return &mEventSubResources;
+  } else if ( contentsType == kmailTodoContentsType ) {
+    return &mTodoSubResources;
+  } else if ( contentsType == kmailJournalContentsType ) {
+    return &mJournalSubResources;
+  }
+  // Not ours
+  return 0;
+}
+
+#include "resourcescalix.moc"

Zmiany atrybut√≥w dla: kresources/scalix/kcal
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/scalix/scalixadmin/delegatedialog.h
===================================================================
--- kresources/scalix/scalixadmin/delegatedialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatedialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef DELEGATEDIALOG_H
+#define DELEGATEDIALOG_H
+
+#include <qmap.h>
+
+#include <kdialogbase.h>
+
+class QCheckBox;
+class QLineEdit;
+
+namespace Scalix {
+class Delegate;
+}
+
+class DelegateDialog : public KDialogBase
+{
+  Q_OBJECT
+
+  public:
+    DelegateDialog( QWidget *parent = 0 );
+
+    void setDelegate( const Scalix::Delegate &delegate );
+    Scalix::Delegate delegate() const;
+
+  private slots:
+    void selectEmail();
+
+  private:
+    QLineEdit *mEmail;
+    QMap<int, QCheckBox*> mRights;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/passwordpage.cpp
===================================================================
--- kresources/scalix/scalixadmin/passwordpage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/passwordpage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,190 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qapplication.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qlineedit.h>
+#include <qpushbutton.h>
+
+#include <kconfig.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+#include <kstringhandler.h>
+#include <kwallet.h>
+
+#include "jobs.h"
+#include "settings.h"
+
+#include "passwordpage.h"
+
+PasswordPage::PasswordPage( QWidget *parent )
+  : QWidget( parent ), mJob( 0 )
+{
+  QGridLayout *layout = new QGridLayout( this, 2, 3, 11, 6 );
+
+  QLabel *label = new QLabel( i18n( "New password:" ), this );
+  layout->addWidget( label, 0, 0 );
+
+  mPassword = new QLineEdit( this );
+  mPassword->setEchoMode( QLineEdit::Password );
+  label->setBuddy( mPassword );
+  layout->addWidget( mPassword, 0, 1 );
+
+  label = new QLabel( i18n( "Retype new password:" ), this );
+  layout->addWidget( label, 1, 0 );
+
+  mPasswordRetype = new QLineEdit( this );
+  mPasswordRetype->setEchoMode( QLineEdit::Password );
+  label->setBuddy( mPasswordRetype );
+  layout->addWidget( mPasswordRetype, 1, 1 );
+
+  mButton = new QPushButton( i18n( "Change" ), this );
+  mButton->setEnabled( false );
+  layout->addWidget( mButton, 2, 1 );
+
+  layout->setRowSpacing( 3, 1 );
+
+  connect( mPassword, SIGNAL( textChanged( const QString& ) ), this, SLOT( textChanged() ) );
+  connect( mPasswordRetype, SIGNAL( textChanged( const QString& ) ), this, SLOT( textChanged() ) );
+  connect( mButton, SIGNAL( clicked() ), this, SLOT( buttonClicked() ) );
+}
+
+void PasswordPage::buttonClicked()
+{
+  if ( !mJob ) {
+    if ( mPassword->text() != mPasswordRetype->text() ) {
+      KMessageBox::error( this, i18n( "The two passwords differ!" ) );
+      return;
+    }
+
+    mJob = Scalix::setPassword( Settings::self()->globalSlave(), Settings::self()->accountUrl(),
+                                Settings::self()->accountPassword(), mPassword->text() );
+    connect( mJob, SIGNAL( result( KIO::Job* ) ), this, SLOT( finished( KIO::Job* ) ) );
+
+    updateState( true );
+  } else {
+    mJob->kill();
+    mJob = 0;
+
+    updateState( false );
+  }
+}
+
+void PasswordPage::updateState( bool isWorking )
+{
+  if ( isWorking ) {
+    mPassword->setEnabled( false );
+    mPasswordRetype->setEnabled( false );
+    mButton->setText( i18n( "Stop" ) );
+  } else {
+    mPassword->setEnabled( true );
+    mPasswordRetype->setEnabled( true );
+    mButton->setText( i18n( "Change" ) );
+  }
+}
+
+void PasswordPage::textChanged()
+{
+  mButton->setEnabled( !mPassword->text().isEmpty() &&
+                       !mPasswordRetype->text().isEmpty() );
+}
+
+void PasswordPage::finished( KIO::Job* job )
+{
+  mJob = 0;
+
+  updateState( false );
+
+  if ( job->error() ) {
+    KMessageBox::error( this, i18n( "Unable to change the password" ) + "\n" + job->errorString() );
+    return;
+  }
+
+  // Update configuration files to the new password as well
+
+  const QString newPassword = mPassword->text();
+
+  { // ScalixAdmin config
+    KConfig config( "scalixadminrc" );
+    KConfigGroup group( &config, "Account" );
+    group.writeEntry( "pass", KStringHandler::obscure( newPassword ) );
+  }
+
+  { // ScalixWizard config
+    KConfig config( "scalixrc" );
+    KConfigGroup group( &config, "General" );
+    group.writeEntry( "Password", KStringHandler::obscure( newPassword ) );
+  }
+
+  { // KMail config
+    KConfig config( "kmailrc" );
+
+    // Try to find account group for Scalix
+    QString scalixAccount;
+    const QStringList groupList = config.groupList();
+    for ( uint i = 0; i < groupList.count(); ++i ) {
+      if ( groupList[ i ].startsWith( "Account " ) ) {
+        KConfigGroup group( &config, groupList[ i ] );
+        if ( group.hasKey( "groupwareType" ) && group.readNumEntry( "groupwareType" ) == 2 ) {
+          scalixAccount = groupList[ i ];
+          break;
+        }
+      }
+    }
+
+    if ( scalixAccount.isEmpty() ) {
+      qWarning( "No Scalix Groupware Account found in kmailrc!" );
+      return;
+    }
+
+    const int accountId = scalixAccount.mid( 8 ).toInt();
+
+    KConfigGroup group( &config, scalixAccount );
+
+    // Save only if the user choose it before
+    bool storePassword = group.readBoolEntry( "store-passwd", false );
+    if ( storePassword ) {
+      // First try to store in KWallet
+      if ( KWallet::Wallet::isEnabled() ) {
+        WId window = 0;
+        if ( qApp->activeWindow() )
+          window = qApp->activeWindow()->winId();
+
+        KWallet::Wallet *wallet = KWallet::Wallet::openWallet( KWallet::Wallet::NetworkWallet(), window );
+        if ( wallet ) {
+          if ( !wallet->hasFolder( "kmail" ) )
+            wallet->createFolder( "kmail" );
+          wallet->setFolder( "kmail" );
+          wallet->writePassword( "account-" + QString::number( accountId ), newPassword );
+        }
+      } else {
+        group.writeEntry( "pass", KStringHandler::obscure( newPassword ) );
+      }
+
+      KConfigGroup fileGroup( &config, QString( "Folder-%1" ).arg( group.readNumEntry( "Folder" ) ) );
+      fileGroup.writeEntry( "pass", KStringHandler::obscure( newPassword ) );
+    }
+  }
+
+  KMessageBox::information( this, i18n( "Password was changed successfully" ) );
+}
+
+#include "passwordpage.moc"
Index: kresources/scalix/scalixadmin/ldapdialog.cpp
===================================================================
--- kresources/scalix/scalixadmin/ldapdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/ldapdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,43 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <klocale.h>
+
+#include "ldapview.h"
+
+#include "ldapdialog.h"
+
+LdapDialog::LdapDialog( QWidget *parent )
+  : KDialogBase( parent, "", true, "", Ok | Cancel, Ok, true )
+{
+  setCaption( i18n( "User Account Selection" ) );
+
+  mView = new LdapView( this );
+  setMainWidget( mView );
+
+  mView->setQuery( "cn=*" );
+
+  resize( 400, 250 );
+}
+
+QString LdapDialog::selectedUser() const
+{
+  return mView->selectedUser();
+}
Index: kresources/scalix/scalixadmin/settings.cpp
===================================================================
--- kresources/scalix/scalixadmin/settings.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/settings.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,136 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <kconfig.h>
+#include <kio/scheduler.h>
+#include <kstringhandler.h>
+
+#include "settings.h"
+
+Settings* Settings::mSelf = 0;
+
+Settings::Settings()
+{
+  mSlave = KIO::Scheduler::getConnectedSlave( accountUrl(),
+                                              accountData() );
+}
+
+Settings::~Settings()
+{
+}
+
+Settings* Settings::self()
+{
+  if ( !mSelf )
+    mSelf = new Settings;
+
+  return mSelf;
+}
+
+KIO::MetaData Settings::accountData() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "Account" );
+
+  KIO::MetaData data;
+  data.insert( "auth", group.readEntry( "auth" ) );
+  data.insert( "tls", group.readBoolEntry( "use-tls" ) ? "on" : "off" );
+
+  return data;
+}
+
+KURL Settings::accountUrl() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "Account" );
+
+  KURL url;
+  url.setProtocol( group.readBoolEntry( "use-ssl" ) ? "imaps" : "imap" );
+  url.setUser( group.readEntry( "user" ) );
+  url.setPass( KStringHandler::obscure( group.readEntry( "pass" ) ) );
+  url.setHost( group.readEntry( "host" ) );
+  url.setPort( group.readNumEntry( "port" ) );
+
+  return url;
+}
+
+QString Settings::accountPassword() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "Account" );
+
+  return KStringHandler::obscure( group.readEntry( "pass" ) );
+}
+
+KIO::Slave* Settings::globalSlave() const
+{
+  return mSlave;
+}
+
+QString Settings::rulesWizardUrl() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "Misc" );
+
+  QString url = group.readEntry( "rulesWizardUrl" );
+  if ( url.isEmpty() ) {
+    KConfigGroup group( &config, "Account" );
+    url = QString( "http://%1/Scalix/rw/?username=%2" ).arg( group.readEntry( "host" ) )
+                                                       .arg( group.readEntry( "user" ) );
+  }
+
+  return url;
+}
+
+QString Settings::ldapHost() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "LDAP" );
+  return group.readEntry( "host" );
+}
+
+QString Settings::ldapPort() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "LDAP" );
+  return group.readEntry( "port" );
+}
+
+QString Settings::ldapBase() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "LDAP" );
+  return group.readEntry( "base" );
+}
+
+QString Settings::ldapBindDn() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "LDAP" );
+  return group.readEntry( "bindDn" );
+}
+
+QString Settings::ldapPassword() const
+{
+  KConfig config( "scalixadminrc" );
+  KConfigGroup group( &config, "LDAP" );
+  return group.readEntry( "password" );
+}
+
Index: kresources/scalix/scalixadmin/jobs.h
===================================================================
--- kresources/scalix/scalixadmin/jobs.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/jobs.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,202 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <kio/job.h>
+
+#ifndef JOBS_H
+#define JOBS_H
+
+namespace Scalix {
+
+  enum DelegateTypes
+  {
+    SendOnBehalfOf = 1,
+    SeePrivate = 2,
+    GetMeetings = 4,
+    InsteadOfMe = 8
+  };
+
+  class SetPasswordJob;
+  class SetDelegateJob;
+  class DeleteDelegateJob;
+  class GetDelegatesJob;
+  class AddOtherUserJob;
+  class DeleteOtherUserJob;
+  class GetOtherUsersJob;
+  class SetOutOfOfficeJob;
+  class GetOutOfOfficeJob;
+
+  class Delegate
+  {
+    public:
+      typedef QValueList<Delegate> List;
+
+      Delegate();
+      Delegate( const QString &email, int rights );
+
+      bool isValid() const;
+
+      QString email() const;
+      int rights() const;
+
+      static QString rightsAsString( int rights );
+
+    private:
+      QString mEmail;
+      int mRights;
+  };
+
+  /**
+   * Sets/Changes the password of the user encoded in @p url.
+   */
+  SetPasswordJob* setPassword( KIO::Slave* slave, const KURL& url, const QString& oldPassword, const QString& newPassword );
+
+  /**
+   * Adds a delegate represented by @p email with the given @p params for the user encoded in @p url.
+   */
+  SetDelegateJob* setDelegate( KIO::Slave* slave, const KURL& url, const QString& email, int params );
+
+  /**
+   * Deletes the delegate represented by @p email for the user encoded in @p url.
+   */
+  DeleteDelegateJob* deleteDelegate( KIO::Slave* slave, const KURL& url, const QString& email );
+
+  /**
+   * Retrieves the delegates for the user encoded in @p url.
+   */
+  GetDelegatesJob* getDelegates( KIO::Slave* slave, const KURL& url );
+
+  /**
+   * Adds the mailbox of another user represented by @p email to the users 'Other Users' namespace.
+   */
+  AddOtherUserJob* addOtherUser( KIO::Slave* slave, const KURL& url, const QString& email );
+
+  /**
+   * Deletes the mailbox of another user represented by @p email from the users 'Other Users' namespace.
+   */
+  DeleteOtherUserJob* deleteOtherUser( KIO::Slave* slave, const KURL& url, const QString& email );
+
+  /**
+   * Retrieves the list of all other users.
+   */
+  GetOtherUsersJob* getOtherUsers( KIO::Slave* slave, const KURL& url );
+
+  /**
+   * Sets the out-of-office data.
+   *
+   * @param enabled Whether the out-of-office functionality is enabled.
+   * @param msg The out-of-office message.
+   */
+  SetOutOfOfficeJob* setOutOfOffice( KIO::Slave* slave, const KURL& url, bool enabled, const QString& msg );
+
+  /**
+   * Retrieves the out-of-office data.
+   */
+  GetOutOfOfficeJob* getOutOfOffice( KIO::Slave* slave, const KURL& url );
+
+
+  class SetPasswordJob : public KIO::SimpleJob
+  {
+    public:
+      SetPasswordJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class SetDelegateJob : public KIO::SimpleJob
+  {
+    public:
+      SetDelegateJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class DeleteDelegateJob : public KIO::SimpleJob
+  {
+    public:
+      DeleteDelegateJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class GetDelegatesJob : public KIO::SimpleJob
+  {
+    Q_OBJECT
+
+    public:
+      GetDelegatesJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+
+      Delegate::List delegates() const;
+
+    private slots:
+      void slotInfoMessage( KIO::Job*, const QString& );
+
+    private:
+      Delegate::List mDelegates;
+  };
+
+  class AddOtherUserJob : public KIO::SimpleJob
+  {
+    public:
+      AddOtherUserJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class DeleteOtherUserJob : public KIO::SimpleJob
+  {
+    public:
+      DeleteOtherUserJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class GetOtherUsersJob : public KIO::SimpleJob
+  {
+    Q_OBJECT
+
+    public:
+      GetOtherUsersJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+
+      QStringList otherUsers() const;
+
+    private slots:
+      void slotInfoMessage( KIO::Job*, const QString& );
+
+    private:
+      QStringList mOtherUsers;
+  };
+
+  class SetOutOfOfficeJob : public KIO::SimpleJob
+  {
+    public:
+      SetOutOfOfficeJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+  };
+
+  class GetOutOfOfficeJob : public KIO::SimpleJob
+  {
+    Q_OBJECT
+
+    public:
+      GetOutOfOfficeJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo );
+
+      bool enabled() const;
+      QString message() const;
+
+    private slots:
+      void slotInfoMessage( KIO::Job*, const QString& );
+
+    private:
+      bool mEnabled;
+      QString mMessage;
+  };
+}
+
+#endif
Index: kresources/scalix/scalixadmin/passwordpage.h
===================================================================
--- kresources/scalix/scalixadmin/passwordpage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/passwordpage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,55 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef PASSWORDPAGE_H
+#define PASSWORDPAGE_H
+
+#include <qwidget.h>
+
+class QLineEdit;
+class QPushButton;
+
+namespace KIO {
+class Job;
+}
+
+class PasswordPage : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    PasswordPage( QWidget *parent = 0 );
+
+  private slots:
+    void buttonClicked();
+    void finished( KIO::Job* );
+    void textChanged();
+
+  private:
+    void updateState( bool );
+
+    QLineEdit *mPassword;
+    QLineEdit *mPasswordRetype;
+    QPushButton *mButton;
+
+    KIO::Job *mJob;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/ldapdialog.h
===================================================================
--- kresources/scalix/scalixadmin/ldapdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/ldapdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,39 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+#ifndef LDAPDIALOG_H
+#define LDAPDIALOG_H
+
+#include <kdialogbase.h>
+
+class LdapView;
+
+class LdapDialog : public KDialogBase
+{
+  public:
+    LdapDialog( QWidget *parent = 0 );
+
+    QString selectedUser() const;
+
+
+  private:
+    LdapView *mView;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/delegateview.cpp
===================================================================
--- kresources/scalix/scalixadmin/delegateview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegateview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,74 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <klocale.h>
+
+#include "delegatemanager.h"
+
+#include "delegateview.h"
+
+class DelegateItem : public QListViewItem
+{
+  public:
+    DelegateItem( QListView *parent, const Scalix::Delegate &delegate )
+      : QListViewItem( parent ), mDelegate( delegate )
+    {
+      setText( 0, mDelegate.email() );
+      setText( 1, Scalix::Delegate::rightsAsString( mDelegate.rights() ) );
+    }
+
+    Scalix::Delegate delegate() const { return mDelegate; }
+
+  private:
+    Scalix::Delegate mDelegate;
+};
+
+DelegateView::DelegateView( DelegateManager *manager, QWidget *parent )
+  : KListView( parent ), mManager( manager )
+{
+  addColumn( i18n( "Delegate" ) );
+  addColumn( i18n( "Rights" ) );
+  setFullWidth( true );
+  setAllColumnsShowFocus( true );
+
+  connect( mManager, SIGNAL( changed() ), SLOT( delegateChanged() ) );
+
+  delegateChanged();
+}
+
+Scalix::Delegate DelegateView::selectedDelegate() const
+{
+  DelegateItem *item = dynamic_cast<DelegateItem*>( selectedItem() );
+  if ( item )
+    return item->delegate();
+
+  return Scalix::Delegate();
+}
+
+void DelegateView::delegateChanged()
+{
+  clear();
+
+  const Scalix::Delegate::List delegates = mManager->delegates();
+  for ( uint i = 0; i < delegates.count(); ++i )
+    new DelegateItem( this, delegates[ i ] );
+}
+
+#include "delegateview.moc"
Index: kresources/scalix/scalixadmin/delegatemanager.cpp
===================================================================
--- kresources/scalix/scalixadmin/delegatemanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatemanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,49 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include "delegatemanager.h"
+
+DelegateManager::DelegateManager()
+{
+}
+
+DelegateManager::~DelegateManager()
+{
+}
+
+void DelegateManager::addDelegate( const Scalix::Delegate &delegate )
+{
+  mDelegates.append( delegate );
+  emit changed();
+}
+
+void DelegateManager::clear()
+{
+  mDelegates.clear();
+
+  emit changed();
+}
+
+Scalix::Delegate::List DelegateManager::delegates() const
+{
+  return mDelegates;
+}
+
+#include "delegatemanager.moc"
Index: kresources/scalix/scalixadmin/outofofficepage.cpp
===================================================================
--- kresources/scalix/scalixadmin/outofofficepage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/outofofficepage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,125 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qbuttongroup.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qpushbutton.h>
+#include <qradiobutton.h>
+#include <qtextedit.h>
+
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include "jobs.h"
+#include "settings.h"
+
+#include "outofofficepage.h"
+
+OutOfOfficePage::OutOfOfficePage( QWidget *parent )
+  : QWidget( parent )
+{
+  QGridLayout *layout = new QGridLayout( this, 4, 2, 11, 6 );
+
+  QButtonGroup *group = new QButtonGroup( 1, Qt::Vertical, this );
+
+  mDisabled = new QRadioButton( i18n( "I am in the office" ), group );
+  mDisabled->setChecked( true );
+  mEnabled = new QRadioButton( i18n( "I am out of the office" ), group );
+
+  mLabel = new QLabel( i18n( "Auto-reply once to each sender with the following text:" ), this );
+  mMessage = new QTextEdit( this );
+  mSaveButton = new QPushButton( i18n( "Save" ), this );
+
+  layout->addMultiCellWidget( group, 0, 0, 0, 1 );
+  layout->addMultiCellWidget( mLabel, 1, 1, 0, 1 );
+  layout->addMultiCellWidget( mMessage, 2, 2, 0, 1 );
+  layout->addWidget( mSaveButton, 3, 1 );
+
+  statusChanged();
+
+  connect( mEnabled, SIGNAL( toggled( bool ) ), this, SLOT( statusChanged() ) );
+  connect( mEnabled, SIGNAL( toggled( bool ) ), this, SLOT( changed() ) );
+  connect( mSaveButton, SIGNAL( clicked() ), this, SLOT( store() ) );
+  connect( mMessage, SIGNAL( textChanged() ), this, SLOT( changed() ) );
+
+  load();
+}
+
+OutOfOfficePage::~OutOfOfficePage()
+{
+}
+
+void OutOfOfficePage::load()
+{
+  Scalix::GetOutOfOfficeJob *job = Scalix::getOutOfOffice( Settings::self()->globalSlave(),
+                                                           Settings::self()->accountUrl() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( loaded( KIO::Job* ) ) );
+}
+
+void OutOfOfficePage::loaded( KIO::Job* job )
+{
+  if ( job->error() ) {
+    KMessageBox::error( this, job->errorString() );
+    return;
+  }
+
+  Scalix::GetOutOfOfficeJob *outOfOfficeJob = static_cast<Scalix::GetOutOfOfficeJob*>( job );
+
+  mEnabled->setChecked( outOfOfficeJob->enabled() );
+  mMessage->setText( outOfOfficeJob->message() );
+
+  statusChanged();
+
+  mSaveButton->setEnabled( false );
+}
+
+void OutOfOfficePage::store()
+{
+  Scalix::SetOutOfOfficeJob *job = Scalix::setOutOfOffice( Settings::self()->globalSlave(),
+                                                           Settings::self()->accountUrl(),
+                                                           mEnabled->isChecked(),
+                                                           mMessage->text() );
+
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( stored( KIO::Job* ) ) );
+
+  mSaveButton->setEnabled( false );
+}
+
+void OutOfOfficePage::stored( KIO::Job* job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+}
+
+void OutOfOfficePage::statusChanged()
+{
+  bool state = mEnabled->isChecked();
+
+  mLabel->setEnabled( state );
+  mMessage->setEnabled( state );
+}
+
+void OutOfOfficePage::changed()
+{
+  mSaveButton->setEnabled( true );
+}
+
+#include "outofofficepage.moc"
Index: kresources/scalix/scalixadmin/settings.h
===================================================================
--- kresources/scalix/scalixadmin/settings.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/settings.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,56 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef SETTINGS_H
+#define SETTINGS_H
+
+#include <kurl.h>
+#include <kio/global.h>
+#include <kio/slave.h>
+
+class Settings
+{
+  public:
+    ~Settings();
+
+    static Settings* self();
+
+    KIO::MetaData accountData() const;
+    KURL accountUrl() const;
+    QString accountPassword() const;
+
+    KIO::Slave *globalSlave() const;
+
+    QString rulesWizardUrl() const;
+
+    QString ldapHost() const;
+    QString ldapPort() const;
+    QString ldapBase() const;
+    QString ldapBindDn() const;
+    QString ldapPassword() const;
+
+  private:
+    Settings();
+    KIO::Slave *mSlave;
+
+    static Settings* mSelf;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/delegatepage.cpp
===================================================================
--- kresources/scalix/scalixadmin/delegatepage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatepage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,170 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qlayout.h>
+#include <qpushbutton.h>
+
+#include <kinputdialog.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include <unistd.h>
+
+#include "delegatedialog.h"
+#include "delegateview.h"
+#include "jobs.h"
+#include "settings.h"
+
+#include "delegatepage.h"
+
+DelegatePage::DelegatePage( QWidget *parent )
+  : QWidget( parent )
+{
+  QGridLayout *layout = new QGridLayout( this, 2, 3, 11, 6 );
+
+  mView = new DelegateView( &mManager, this );
+  layout->addMultiCellWidget( mView, 0, 0, 0, 2 );
+
+  mAddButton = new QPushButton( i18n( "Add Delegate..." ), this );
+  layout->addWidget( mAddButton, 1, 0 );
+
+  mEditButton = new QPushButton( i18n( "Edit Delegate..." ), this );
+  mEditButton->setEnabled( false );
+  layout->addWidget( mEditButton, 1, 1 );
+
+  mRemoveButton = new QPushButton( i18n( "Remove Delegate" ), this );
+  mRemoveButton->setEnabled( false );
+  layout->addWidget( mRemoveButton, 1, 2 );
+
+  connect( mView, SIGNAL( selectionChanged() ), SLOT( selectionChanged() ) );
+  connect( mAddButton, SIGNAL( clicked() ), SLOT( addDelegate() ) );
+  connect( mEditButton, SIGNAL( clicked() ), SLOT( editDelegate() ) );
+  connect( mRemoveButton, SIGNAL( clicked() ), SLOT( removeDelegate() ) );
+
+  loadAllDelegates();
+}
+
+DelegatePage::~DelegatePage()
+{
+}
+
+void DelegatePage::loadAllDelegates()
+{
+  Scalix::GetDelegatesJob *job = Scalix::getDelegates( Settings::self()->globalSlave(),
+                                                       Settings::self()->accountUrl() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( allDelegates( KIO::Job* ) ) );
+}
+
+void DelegatePage::addDelegate()
+{
+  DelegateDialog dlg( this );
+  dlg.setCaption( i18n( "Add Delegate" ) );
+
+  if ( !dlg.exec() )
+    return;
+
+  const Scalix::Delegate delegate = dlg.delegate();
+
+  if ( !delegate.isValid() )
+    return;
+
+  Scalix::SetDelegateJob *job = Scalix::setDelegate( Settings::self()->globalSlave(),
+                                                     Settings::self()->accountUrl(),
+                                                     delegate.email(), delegate.rights() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( delegateAdded( KIO::Job* ) ) );
+}
+
+void DelegatePage::editDelegate()
+{
+  const Scalix::Delegate oldDelegate = mView->selectedDelegate();
+  if ( !oldDelegate.isValid() )
+    return;
+
+  DelegateDialog dlg( this );
+  dlg.setCaption( i18n( "Edit Delegate" ) );
+
+  dlg.setDelegate( oldDelegate );
+
+  if ( !dlg.exec() )
+    return;
+
+  const Scalix::Delegate delegate = dlg.delegate();
+
+  if ( !delegate.isValid() )
+    return;
+
+  Scalix::SetDelegateJob *job = Scalix::setDelegate( Settings::self()->globalSlave(),
+                                                     Settings::self()->accountUrl(),
+                                                     delegate.email(), delegate.rights() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( delegateAdded( KIO::Job* ) ) );
+}
+
+void DelegatePage::removeDelegate()
+{
+  const Scalix::Delegate delegate = mView->selectedDelegate();
+  if ( !delegate.isValid() )
+    return;
+
+  Scalix::DeleteDelegateJob *job = Scalix::deleteDelegate( Settings::self()->globalSlave(),
+                                                           Settings::self()->accountUrl(), delegate.email() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( delegateRemoved( KIO::Job* ) ) );
+}
+
+void DelegatePage::allDelegates( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+
+  Scalix::GetDelegatesJob *delegateJob = static_cast<Scalix::GetDelegatesJob*>( job );
+
+  mManager.clear();
+
+  const Scalix::Delegate::List delegates = delegateJob->delegates();
+  for ( uint i = 0; i < delegates.count(); ++i )
+    mManager.addDelegate( delegates[ i ] );
+
+  selectionChanged();
+}
+
+void DelegatePage::delegateAdded( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+  else
+    loadAllDelegates(); // update the GUI
+}
+
+void DelegatePage::delegateRemoved( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+  else
+    loadAllDelegates(); // update the GUI
+}
+
+void DelegatePage::selectionChanged()
+{
+  bool state = ( mView->selectedItem() != 0 );
+
+  mEditButton->setEnabled( state );
+  mRemoveButton->setEnabled( state );
+}
+
+#include "delegatepage.moc"
Index: kresources/scalix/scalixadmin/delegateview.h
===================================================================
--- kresources/scalix/scalixadmin/delegateview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegateview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,48 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef DELEGATEVIEW_H
+#define DELEGATEVIEW_H
+
+#include <klistview.h>
+
+namespace Scalix {
+class Delegate;
+}
+
+class DelegateManager;
+
+class DelegateView : public KListView
+{
+  Q_OBJECT
+
+  public:
+    DelegateView( DelegateManager *manager, QWidget *parent = 0 );
+
+    Scalix::Delegate selectedDelegate() const;
+
+  private slots:
+    void delegateChanged();
+
+  private:
+    DelegateManager *mManager;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/delegatemanager.h
===================================================================
--- kresources/scalix/scalixadmin/delegatemanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatemanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,49 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef DELEGATEMANAGER_H
+#define DELEGATEMANAGER_H
+
+#include <qobject.h>
+#include <qstringlist.h>
+
+#include "jobs.h"
+
+class DelegateManager : public QObject
+{
+  Q_OBJECT
+
+  public:
+    DelegateManager();
+    ~DelegateManager();
+
+    void addDelegate( const Scalix::Delegate &delegate );
+    void clear();
+
+    Scalix::Delegate::List delegates() const;
+
+  signals:
+    void changed();
+
+  private:
+    Scalix::Delegate::List mDelegates;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/outofofficepage.h
===================================================================
--- kresources/scalix/scalixadmin/outofofficepage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/outofofficepage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,57 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef OUTOFOFFICEPAGE_H
+#define OUTOFOFFICEPAGE_H
+
+#include <qwidget.h>
+
+class QLabel;
+class QPushButton;
+class QRadioButton;
+class QTextEdit;
+
+class OutOfOfficePage : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    OutOfOfficePage( QWidget *parent = 0 );
+    ~OutOfOfficePage();
+
+  private slots:
+    void load();
+    void loaded( KIO::Job* );
+    void store();
+    void stored( KIO::Job* );
+    void statusChanged();
+    void changed();
+
+  private:
+    QRadioButton *mEnabled;
+    QRadioButton *mDisabled;
+    QLabel *mLabel;
+    QTextEdit *mMessage;
+    QPushButton *mSaveButton;
+
+    bool mChanged;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/ldapview.cpp
===================================================================
--- kresources/scalix/scalixadmin/ldapview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/ldapview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,99 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <kabc/ldapclient.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include "settings.h"
+
+#include "ldapview.h"
+
+class LdapItem : public QListViewItem
+{
+  public:
+    LdapItem( QListView *parent, const QString &text, const QString &email )
+      : QListViewItem( parent )
+    {
+      setText( 0, text );
+      setText( 1, email );
+    }
+};
+
+
+LdapView::LdapView( QWidget *parent )
+  : KListView( parent )
+{
+  addColumn( i18n( "User" ) );
+  setFullWidth( true );
+
+  mClient = new KABC::LdapClient;
+
+  mClient->setHost( Settings::self()->ldapHost() );
+  mClient->setPort( Settings::self()->ldapPort() );
+  mClient->setBase( Settings::self()->ldapBase() );
+  mClient->setBindDN( Settings::self()->ldapBindDn() );
+  mClient->setPwdBindDN( Settings::self()->ldapPassword() );
+
+  QStringList attrs;
+  attrs << "surname" << "mail";
+  mClient->setAttrs( attrs );
+
+  connect( mClient, SIGNAL( result( const KABC::LdapObject& ) ),
+           this, SLOT( entryAdded( const KABC::LdapObject& ) ) );
+  connect( mClient, SIGNAL( error( const QString& ) ),
+           this, SLOT( error( const QString& ) ) );
+}
+
+LdapView::~LdapView()
+{
+  mClient->cancelQuery();
+  delete mClient;
+}
+
+QString LdapView::selectedUser() const
+{
+  QListViewItem *item = selectedItem();
+  if ( !item )
+    return QString();
+  else
+    return item->text( 1 );
+}
+
+void LdapView::setQuery( const QString &query )
+{
+  clear();
+  mClient->startQuery( query );
+}
+
+void LdapView::entryAdded( const KABC::LdapObject &obj )
+{
+  const QString text = QString( "%1 (%2)" ).arg( obj.attrs[ "surname" ].first() )
+                                           .arg( obj.attrs[ "mail" ].first() );
+
+  new LdapItem( this, text, obj.attrs[ "mail" ].first() );
+}
+
+void LdapView::error( const QString &msg )
+{
+  KMessageBox::error( this, msg );
+}
+
+#include "ldapview.moc"
Index: kresources/scalix/scalixadmin/otherusermanager.cpp
===================================================================
--- kresources/scalix/scalixadmin/otherusermanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otherusermanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,51 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include "otherusermanager.h"
+
+OtherUserManager::OtherUserManager()
+{
+}
+
+OtherUserManager::~OtherUserManager()
+{
+}
+
+void OtherUserManager::addOtherUser( const QString &email )
+{
+  if ( !mOtherUsers.contains( email ) ) {
+    mOtherUsers.append( email );
+    emit changed();
+  }
+}
+
+void OtherUserManager::clear()
+{
+  mOtherUsers.clear();
+
+  emit changed();
+}
+
+QStringList OtherUserManager::otherUsers() const
+{
+  return mOtherUsers;
+}
+
+#include "otherusermanager.moc"
Index: kresources/scalix/scalixadmin/otheruserview.cpp
===================================================================
--- kresources/scalix/scalixadmin/otheruserview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otheruserview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,71 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <klocale.h>
+
+#include "otherusermanager.h"
+
+#include "otheruserview.h"
+
+class OtherUserItem : public QListViewItem
+{
+  public:
+    OtherUserItem( QListView *parent, const QString &user )
+      : QListViewItem( parent ), mUser( user )
+    {
+      setText( 0, mUser );
+    }
+
+    QString user() const { return mUser; }
+
+  private:
+    QString mUser;
+};
+
+OtherUserView::OtherUserView( OtherUserManager *manager, QWidget *parent )
+  : KListView( parent ), mManager( manager )
+{
+  addColumn( i18n( "Registered Accounts" ) );
+  setFullWidth( true );
+
+  connect( mManager, SIGNAL( changed() ), SLOT( userChanged() ) );
+
+  userChanged();
+}
+
+QString OtherUserView::selectedUser() const
+{
+  OtherUserItem *item = dynamic_cast<OtherUserItem*>( selectedItem() );
+  if ( item )
+    return item->user();
+
+  return QString();
+}
+
+void OtherUserView::userChanged()
+{
+  clear();
+
+  QStringList users = mManager->otherUsers();
+  for ( uint i = 0; i < users.count(); ++i )
+    new OtherUserItem( this, users[ i ] );
+}
+
+#include "otheruserview.moc"
Index: kresources/scalix/scalixadmin/delegatepage.h
===================================================================
--- kresources/scalix/scalixadmin/delegatepage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatepage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,60 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef DELEGATEPAGE_H
+#define DELEGATEPAGE_H
+
+#include <qwidget.h>
+
+#include "delegatemanager.h"
+
+class QPushButton;
+class DelegateView;
+
+class DelegatePage : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    DelegatePage( QWidget *parent = 0 );
+    ~DelegatePage();
+
+  private slots:
+    void loadAllDelegates();
+    void addDelegate();
+    void editDelegate();
+    void removeDelegate();
+
+    void delegateAdded( KIO::Job* );
+    void delegateRemoved( KIO::Job* );
+    void allDelegates( KIO::Job* );
+
+    void selectionChanged();
+
+  private:
+    QPushButton *mAddButton;
+    QPushButton *mEditButton;
+    QPushButton *mRemoveButton;
+
+    DelegateManager mManager;
+    DelegateView *mView;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/mainwindow.cpp
===================================================================
--- kresources/scalix/scalixadmin/mainwindow.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,59 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qvbox.h>
+
+#include <kglobal.h>
+#include <kiconloader.h>
+#include <kjanuswidget.h>
+#include <klocale.h>
+
+#include "delegatepage.h"
+#include "otheruserpage.h"
+#include "outofofficepage.h"
+#include "passwordpage.h"
+
+#include "mainwindow.h"
+
+MainWindow::MainWindow()
+  : KMainWindow( 0 )
+{
+  KJanusWidget *wdg = new KJanusWidget( this, "", KJanusWidget::IconList );
+
+  QPixmap icon = KGlobal::iconLoader()->loadIcon( "folder_yellow", KIcon::Desktop );
+  QVBox *page = wdg->addVBoxPage( i18n( "Other Accounts" ), i18n( "Register other accounts" ), icon );
+  new OtherUserPage( page );
+
+  icon = KGlobal::iconLoader()->loadIcon( "edu_languages", KIcon::Desktop );
+  page = wdg->addVBoxPage( i18n( "Delegates" ), i18n( "Setup delegates for my account" ), icon );
+  new DelegatePage( page );
+
+  icon = KGlobal::iconLoader()->loadIcon( "kontact_summary_green", KIcon::Desktop );
+  page = wdg->addVBoxPage( i18n( "Out of Office..." ), i18n( "Setup Out of Office Message" ), icon );
+  new OutOfOfficePage( page );
+
+  icon = KGlobal::iconLoader()->loadIcon( "password", KIcon::Desktop );
+  page = wdg->addVBoxPage( i18n( "Password" ), i18n( "Change the password" ), icon );
+  new PasswordPage( page );
+
+  setCentralWidget( wdg );
+
+  resize( 540, 450 );
+}
Index: kresources/scalix/scalixadmin/otheruserpage.cpp
===================================================================
--- kresources/scalix/scalixadmin/otheruserpage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otheruserpage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,173 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qapplication.h>
+#include <qlayout.h>
+#include <qpushbutton.h>
+
+#include <dcopref.h>
+#include <kdcopservicestarter.h>
+#include <kinputdialog.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include <unistd.h>
+
+#include "jobs.h"
+#include "ldapdialog.h"
+#include "otheruserview.h"
+#include "settings.h"
+
+#include "otheruserpage.h"
+
+OtherUserPage::OtherUserPage( QWidget *parent )
+  : QWidget( parent )
+{
+  QGridLayout *layout = new QGridLayout( this, 2, 2, 11, 6 );
+
+  mView = new OtherUserView( &mManager, this );
+  layout->addMultiCellWidget( mView, 0, 0, 0, 1 );
+
+  mAddButton = new QPushButton( i18n( "Add Account..." ), this );
+  layout->addWidget( mAddButton, 1, 0 );
+
+  mDeleteButton = new QPushButton( i18n( "Remove Account" ), this );
+  mDeleteButton->setEnabled( false );
+  layout->addWidget( mDeleteButton, 1, 1 );
+
+  connect( mView, SIGNAL( selectionChanged() ), SLOT( selectionChanged() ) );
+  connect( mAddButton, SIGNAL( clicked() ), SLOT( addUser() ) );
+  connect( mDeleteButton, SIGNAL( clicked() ), SLOT( removeUser() ) );
+
+  loadAllUsers();
+}
+
+OtherUserPage::~OtherUserPage()
+{
+}
+
+void OtherUserPage::loadAllUsers()
+{
+  Scalix::GetOtherUsersJob *job = Scalix::getOtherUsers( Settings::self()->globalSlave(),
+                                                         Settings::self()->accountUrl() );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( allUsers( KIO::Job* ) ) );
+}
+
+void OtherUserPage::addUser()
+{
+  LdapDialog dlg( this );
+  if ( !dlg.exec() )
+    return;
+
+  const QString email = dlg.selectedUser();
+  if ( email.isEmpty() )
+    return;
+
+  Scalix::AddOtherUserJob *job = Scalix::addOtherUser( Settings::self()->globalSlave(),
+                                                       Settings::self()->accountUrl(), email );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( userAdded( KIO::Job* ) ) );
+}
+
+void OtherUserPage::removeUser()
+{
+  const QString email = mView->selectedUser();
+  if ( email.isEmpty() )
+    return;
+
+  Scalix::DeleteOtherUserJob *job = Scalix::deleteOtherUser( Settings::self()->globalSlave(),
+                                                             Settings::self()->accountUrl(), email );
+  connect( job, SIGNAL( result( KIO::Job* ) ), SLOT( userRemoved( KIO::Job* ) ) );
+}
+
+void OtherUserPage::allUsers( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+
+  Scalix::GetOtherUsersJob *userJob = static_cast<Scalix::GetOtherUsersJob*>( job );
+
+  mManager.clear();
+
+  const QStringList users = userJob->otherUsers();
+  for ( uint i = 0; i < users.count(); ++i )
+    mManager.addOtherUser( users[ i ] );
+
+  selectionChanged();
+}
+
+void OtherUserPage::userAdded( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+  else
+    loadAllUsers(); // update the GUI
+
+  updateKmail();
+}
+
+void OtherUserPage::userRemoved( KIO::Job *job )
+{
+  if ( job->error() )
+    KMessageBox::error( this, job->errorString() );
+  else
+    loadAllUsers(); // update the GUI
+
+  updateKmail();
+}
+
+void OtherUserPage::selectionChanged()
+{
+  mDeleteButton->setEnabled( mView->selectedItem() != 0 );
+}
+
+void OtherUserPage::updateKmail()
+{
+  QMessageBox *msg = new QMessageBox( qApp->mainWidget() );
+  msg->setText( i18n( "Updating account..." ) );
+  msg->show();
+  qApp->processEvents();
+  sleep( 1 );
+  qApp->processEvents();
+
+  QString error;
+  QCString dcopService;
+  int result = KDCOPServiceStarter::self()->
+    findServiceFor( "DCOP/ResourceBackend/IMAP", QString::null,
+                    QString::null, &error, &dcopService );
+  if ( result != 0 ) {
+    KMessageBox::error( 0, i18n( "Unable to start KMail to trigger account update with Scalix server" ) );
+    delete msg;
+    return;
+  }
+
+  DCOPRef ref( dcopService, "KMailIface" );
+
+  // loop until dcop iface is set up correctly
+  QStringList list;
+  while ( list.isEmpty() ) {
+    ref.call( "accounts()" ).get( list );
+  }
+
+  ref.call( "checkAccount(QString)", i18n( "Scalix Server" ) );
+
+  delete msg;
+}
+
+#include "otheruserpage.moc"
Index: kresources/scalix/scalixadmin/ldapview.h
===================================================================
--- kresources/scalix/scalixadmin/ldapview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/ldapview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,51 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+#ifndef LDAPVIEW_H
+#define LDAPVIEW_H
+
+#include <klistview.h>
+
+namespace KABC {
+class LdapClient;
+class LdapObject;
+}
+
+class LdapView : public KListView
+{
+  Q_OBJECT
+
+  public:
+    LdapView( QWidget *parent = 0 );
+    ~LdapView();
+
+    QString selectedUser() const;
+
+  public slots:
+    void setQuery( const QString &query );
+
+  private slots:
+    void entryAdded( const KABC::LdapObject& );
+    void error( const QString& );
+
+  private:
+    KABC::LdapClient *mClient;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/otherusermanager.h
===================================================================
--- kresources/scalix/scalixadmin/otherusermanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otherusermanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,47 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef OTHERUSERMANAGER_H
+#define OTHERUSERMANAGER_H
+
+#include <qobject.h>
+#include <qstringlist.h>
+
+class OtherUserManager : public QObject
+{
+  Q_OBJECT
+
+  public:
+    OtherUserManager();
+    ~OtherUserManager();
+
+    void addOtherUser( const QString &email );
+    void clear();
+
+    QStringList otherUsers() const;
+
+  signals:
+    void changed();
+
+  private:
+    QStringList mOtherUsers;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/otheruserview.h
===================================================================
--- kresources/scalix/scalixadmin/otheruserview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otheruserview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,44 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef OTHERUSERVIEW_H
+#define OTHERUSERVIEW_H
+
+#include <klistview.h>
+
+class OtherUserManager;
+
+class OtherUserView : public KListView
+{
+  Q_OBJECT
+
+  public:
+    OtherUserView( OtherUserManager *manager, QWidget *parent = 0 );
+
+    QString selectedUser() const;
+
+  private slots:
+    void userChanged();
+
+  private:
+    OtherUserManager *mManager;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/mainwindow.h
===================================================================
--- kresources/scalix/scalixadmin/mainwindow.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,32 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef MAINWINDOW_H
+#define MAINWINDOW_H
+
+#include <kmainwindow.h>
+
+class MainWindow : public KMainWindow
+{
+  public:
+    MainWindow();
+};
+
+#endif
Index: kresources/scalix/scalixadmin/otheruserpage.h
===================================================================
--- kresources/scalix/scalixadmin/otheruserpage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/otheruserpage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,60 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef OTHERUSERPAGE_H
+#define OTHERUSERPAGE_H
+
+#include <qwidget.h>
+
+#include "otherusermanager.h"
+
+class QPushButton;
+class OtherUserView;
+
+class OtherUserPage : public QWidget
+{
+  Q_OBJECT
+
+  public:
+    OtherUserPage( QWidget *parent = 0 );
+    ~OtherUserPage();
+
+  private slots:
+    void loadAllUsers();
+    void addUser();
+    void removeUser();
+
+    void userAdded( KIO::Job* );
+    void userRemoved( KIO::Job* );
+    void allUsers( KIO::Job* );
+
+    void selectionChanged();
+
+  private:
+    void updateKmail();
+
+    QPushButton *mAddButton;
+    QPushButton *mDeleteButton;
+
+    OtherUserManager mManager;
+    OtherUserView *mView;
+};
+
+#endif
Index: kresources/scalix/scalixadmin/main.cpp
===================================================================
--- kresources/scalix/scalixadmin/main.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kcmdlineargs.h>
+#include <klocale.h>
+
+#include "mainwindow.h"
+
+static const char description[] = I18N_NOOP("Configuration Tool for Scalix Groupware Konnector");
+
+static KCmdLineOptions options[] =
+{
+  KCmdLineLastOption
+};
+
+int main( int argc, char **argv )
+{
+  KAboutData aboutData( "scalixadmin", I18N_NOOP("ScalixAdmin"), "1.0", description,
+                        KAboutData::License_GPL, "(c) 2007, Tobias Koenig" );
+  aboutData.addAuthor( "Tobias Koenig",0, "tokoe@kde.org" );
+  KCmdLineArgs::init( argc, argv, &aboutData );
+  KCmdLineArgs::addCmdLineOptions( options );
+
+  KApplication app;
+
+  KGlobal::locale()->insertCatalogue( "scalixadmin" );
+
+  MainWindow *window = new MainWindow;
+  window->show();
+
+  app.setMainWidget( window );
+
+  return app.exec();
+}
Index: kresources/scalix/scalixadmin/Makefile.am
===================================================================
--- kresources/scalix/scalixadmin/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,15 @@
+bin_PROGRAMS = scalixadmin
+
+INCLUDES = $(all_includes)
+
+scalixadmin_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+scalixadmin_LDADD   = $(LIB_KABC)
+scalixadmin_SOURCES = main.cpp mainwindow.cpp passwordpage.cpp settings.cpp jobs.cpp \
+                      otherusermanager.cpp otheruserview.cpp otheruserpage.cpp ldapview.cpp ldapdialog.cpp \
+                      delegatemanager.cpp delegateview.cpp delegatepage.cpp delegatedialog.cpp \
+                      outofofficepage.cpp
+
+METASOURCES = AUTO
+
+messages: rc.cpp
+	$(XGETTEXT) *.cpp -o $(podir)/scalixadmin.pot
Index: kresources/scalix/scalixadmin/delegatedialog.cpp
===================================================================
--- kresources/scalix/scalixadmin/delegatedialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/delegatedialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,105 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qcheckbox.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qlineedit.h>
+#include <qtoolbutton.h>
+
+#include <klocale.h>
+
+#include "jobs.h"
+#include "ldapdialog.h"
+
+#include "delegatedialog.h"
+
+DelegateDialog::DelegateDialog( QWidget *parent )
+  : KDialogBase( parent, "", true, "", Ok | Cancel, Ok, true )
+{
+  QWidget *page = new QWidget( this );
+  QGridLayout *layout = new QGridLayout( page, 5, 3, 11, 6 );
+
+  QLabel *label = new QLabel( i18n( "User:" ), page );
+  layout->addWidget( label, 0, 0 );
+
+  mEmail = new QLineEdit( page );
+  layout->addWidget( mEmail, 0, 1 );
+
+  QToolButton *emailSelector = new QToolButton( page );
+  emailSelector->setUsesTextLabel( true );
+  emailSelector->setTextLabel( i18n( "..." ) );
+  layout->addWidget( emailSelector, 0, 2 );
+
+  QValueList<Scalix::DelegateTypes> types;
+  types << Scalix::SendOnBehalfOf;
+  types << Scalix::SeePrivate;
+  types << Scalix::GetMeetings;
+  types << Scalix::InsteadOfMe;
+
+  int row = 1;
+  for ( uint i = 0; i < types.count(); ++i ) {
+    QCheckBox *box = new QCheckBox( Scalix::Delegate::rightsAsString( types[ i ] ), page );
+    layout->addMultiCellWidget( box, row, row, 1, 2 );
+
+    mRights.insert( types[ i ], box );
+    row++;
+  }
+
+  connect( emailSelector, SIGNAL( clicked() ), SLOT( selectEmail() ) );
+
+  setMainWidget( page );
+}
+
+void DelegateDialog::setDelegate( const Scalix::Delegate &delegate )
+{
+  mEmail->setText( delegate.email() );
+
+  QMap<int, QCheckBox*>::Iterator it;
+  for ( it = mRights.begin(); it != mRights.end(); ++it )
+    it.data()->setChecked( delegate.rights() & it.key() );
+}
+
+Scalix::Delegate DelegateDialog::delegate() const
+{
+  int rights = 0;
+
+  QMap<int, QCheckBox*>::ConstIterator it;
+  for ( it = mRights.begin(); it != mRights.end(); ++it )
+    if ( it.data()->isChecked() )
+      rights |= it.key();
+
+  return Scalix::Delegate( mEmail->text(), rights );
+}
+
+void DelegateDialog::selectEmail()
+{
+  LdapDialog dlg( this );
+  if ( !dlg.exec() )
+    return;
+
+  const QString email = dlg.selectedUser();
+  if ( email.isEmpty() )
+    return;
+
+  mEmail->setText( email );
+}
+
+#include "delegatedialog.moc"
Index: kresources/scalix/scalixadmin/jobs.cpp
===================================================================
--- kresources/scalix/scalixadmin/jobs.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/scalixadmin/jobs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,306 @@
+/*
+ *   This file is part of ScalixAdmin.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <kio/scheduler.h>
+#include <klocale.h>
+
+#include "jobs.h"
+
+using namespace Scalix;
+
+Delegate::Delegate()
+  : mRights( -1 )
+{
+}
+
+Delegate::Delegate( const QString &email, int rights )
+  : mEmail( email ), mRights( rights )
+{
+}
+
+bool Delegate::isValid() const
+{
+  return ( !mEmail.isEmpty() && mRights != -1 );
+}
+
+QString Delegate::email() const
+{
+  return mEmail;
+}
+
+int Delegate::rights() const
+{
+  return mRights;
+}
+
+QString Delegate::rightsAsString( int rights )
+{
+  QStringList rightNames;
+
+  if ( rights & SendOnBehalfOf )
+    rightNames.append( i18n( "Send on behalf of" ) );
+  if ( rights & SeePrivate )
+    rightNames.append( i18n( "See private" ) );
+  if ( rights & GetMeetings )
+    rightNames.append( i18n( "Get meetings" ) );
+  if ( rights & InsteadOfMe )
+    rightNames.append( i18n( "Instead of me" ) );
+
+  return rightNames.join( ", " );
+}
+
+
+SetPasswordJob* Scalix::setPassword( KIO::Slave* slave, const KURL& url,
+                                     const QString &oldPassword, const QString& newPassword )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-SCALIX-PASSWORD" ) << QString( "%1 %2" ).arg( oldPassword ).arg( newPassword );
+
+  SetPasswordJob* job = new SetPasswordJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+SetDelegateJob* Scalix::setDelegate( KIO::Slave* slave, const KURL& url, const QString& email, int params )
+{
+  QStringList types;
+  if ( params & SendOnBehalfOf )
+    types.append( "SOBO" );
+  if ( params & SeePrivate )
+    types.append( "SEEPRIVATE" );
+  if ( params & GetMeetings )
+    types.append( "GETMEETINGS" );
+  if ( params & InsteadOfMe )
+    types.append( "INSTEADOFME" );
+
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-SET-DELEGATE" ) << QString( "%1 %2" ).arg( email ).arg( types.join( " " ) );
+
+  SetDelegateJob* job = new SetDelegateJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+DeleteDelegateJob* Scalix::deleteDelegate( KIO::Slave* slave, const KURL& url, const QString& email )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-DELETE-DELEGATE" ) << email;
+
+  DeleteDelegateJob* job = new DeleteDelegateJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+GetDelegatesJob* Scalix::getDelegates( KIO::Slave* slave, const KURL& url )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N' << QString( "X-GET-DELEGATES" ) << QString();
+
+  GetDelegatesJob* job = new GetDelegatesJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+AddOtherUserJob* Scalix::addOtherUser( KIO::Slave* slave, const KURL& url, const QString& email )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-ADD-OTHER-USER" ) << email;
+
+  AddOtherUserJob* job = new AddOtherUserJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+DeleteOtherUserJob* Scalix::deleteOtherUser( KIO::Slave* slave, const KURL& url, const QString& email )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-DELETE-OTHER-USER" ) << email;
+
+  DeleteOtherUserJob* job = new DeleteOtherUserJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+GetOtherUsersJob* Scalix::getOtherUsers( KIO::Slave* slave, const KURL& url )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-GET-OTHER-USERS" ) << QString();
+
+  GetOtherUsersJob* job = new GetOtherUsersJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+SetOutOfOfficeJob* Scalix::setOutOfOffice( KIO::Slave* slave, const KURL& url, bool enabled, const QString& msg )
+{
+  const QString argument = msg;
+  const QString command = QString( "X-SET-OUT-OF-OFFICE %1 %2 {%3}" ).arg( enabled ? "ENABLED" : "DISABLED" )
+                                                .arg( "UTF-8" )
+                                                .arg( msg.utf8().length() );
+
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int) 'X' << (int)'E' << command << argument;
+
+  SetOutOfOfficeJob* job = new SetOutOfOfficeJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+GetOutOfOfficeJob* Scalix::getOutOfOffice( KIO::Slave* slave, const KURL& url )
+{
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+  stream << (int)'X' << (int)'N'
+         << QString( "X-GET-OUT-OF-OFFICE" ) << QString();
+
+  GetOutOfOfficeJob* job = new GetOutOfOfficeJob( url, packedArgs, false );
+  KIO::Scheduler::assignJobToSlave( slave, job );
+  return job;
+}
+
+SetPasswordJob::SetPasswordJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+SetDelegateJob::SetDelegateJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+DeleteDelegateJob::DeleteDelegateJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+GetDelegatesJob::GetDelegatesJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+  connect( this, SIGNAL( infoMessage( KIO::Job*, const QString& ) ),
+           this, SLOT( slotInfoMessage( KIO::Job*, const QString& ) ) );
+}
+
+Delegate::List GetDelegatesJob::delegates() const
+{
+  return mDelegates;
+}
+
+void GetDelegatesJob::slotInfoMessage( KIO::Job*, const QString &data )
+{
+  /**
+   * The passed data have the following form:
+   *
+   * "user1@host.com:right1,right2,right4 user2@host.com:right3,right5"
+   */
+  QStringList delegates = QStringList::split( ' ', data );
+  for ( uint i = 0; i < delegates.count(); ++i ) {
+    QStringList delegate = QStringList::split( ':', delegates[ i ] );
+
+    const QString email = delegate[ 0 ];
+    int rights = 0;
+
+    QStringList rightsList = QStringList::split( ',', delegate[ 1 ] );
+    for ( uint j = 0; j < rightsList.count(); ++j ) {
+      if ( rightsList[ j ] == "SOBO" )
+        rights |= SendOnBehalfOf;
+      else if ( rightsList[ j ] == "SEEPRIVATE" )
+        rights |= SeePrivate;
+      else if ( rightsList[ j ] == "GETMEETINGS" )
+        rights |= GetMeetings;
+      else if ( rightsList[ j ] == "INSTEADOFME" )
+        rights |= InsteadOfMe;
+    }
+
+    mDelegates.append( Delegate( email, rights ) );
+  }
+}
+
+AddOtherUserJob::AddOtherUserJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+DeleteOtherUserJob::DeleteOtherUserJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+GetOtherUsersJob::GetOtherUsersJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+  connect( this, SIGNAL( infoMessage( KIO::Job*, const QString& ) ),
+           this, SLOT( slotInfoMessage( KIO::Job*, const QString& ) ) );
+}
+
+QStringList GetOtherUsersJob::otherUsers() const
+{
+  return mOtherUsers;
+}
+
+void GetOtherUsersJob::slotInfoMessage( KIO::Job*, const QString &data )
+{
+  mOtherUsers = QStringList::split( ' ', data );
+}
+
+SetOutOfOfficeJob::SetOutOfOfficeJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+}
+
+GetOutOfOfficeJob::GetOutOfOfficeJob( const KURL& url, const QByteArray &packedArgs, bool showProgressInfo )
+  : KIO::SimpleJob( url, KIO::CMD_SPECIAL, packedArgs, showProgressInfo )
+{
+  connect( this, SIGNAL( infoMessage( KIO::Job*, const QString& ) ),
+           this, SLOT( slotInfoMessage( KIO::Job*, const QString& ) ) );
+}
+
+bool GetOutOfOfficeJob::enabled() const
+{
+  return mEnabled;
+}
+
+QString GetOutOfOfficeJob::message() const
+{
+  return mMessage;
+}
+
+void GetOutOfOfficeJob::slotInfoMessage( KIO::Job*, const QString &data )
+{
+  const QStringList fields = QStringList::split( '^', data );
+
+  mEnabled = ( fields[ 0 ] == "ENABLED" );
+  mMessage = fields[ 1 ];
+}
+
+#include "jobs.moc"

Zmiany atrybut√≥w dla: kresources/scalix/scalixadmin
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/scalix/README
===================================================================
--- kresources/scalix/README	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/README	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,9 @@
+The Scalix Resource is based on the code of the Kolab resource as both
+groupware servers use a similar storage concept (storing pim items as
+email attachments on an IMAP server).
+
+However the Scalix Resource has several modifications, e.g. the XML storage
+type was removed and freebusy handling is done via a separated KIO slave.
+
+If you have any problems, questions or suggestions contact me under
+  Tobias Koenig <tokoe@kde.org>
Index: kresources/scalix/kioslave/scalix.protocol
===================================================================
--- kresources/scalix/kioslave/scalix.protocol	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kioslave/scalix.protocol	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,8 @@
+[Protocol]
+DocPath=kioslave/scalix.html
+exec=kio_scalix
+input=none
+output=filesystem
+protocol=scalix
+reading=true
+writing=true
Index: kresources/scalix/kioslave/scalix.cpp
===================================================================
--- kresources/scalix/kioslave/scalix.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kioslave/scalix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,225 @@
+/*
+    This file is part of KDE.
+
+    Copyright (C) 2007 Trolltech ASA. All rights reserved.
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include <qapplication.h>
+#include <qeventloop.h>
+
+#include <kapplication.h>
+#include <kcmdlineargs.h>
+#include <kdebug.h>
+#include <kdeversion.h>
+#include <kio/global.h>
+#include <klocale.h>
+
+#include <kdepimmacros.h>
+
+#include <stdlib.h>
+
+#include "scalix.h"
+
+extern "C" {
+  KDE_EXPORT int kdemain( int argc, char **argv );
+}
+
+static const KCmdLineOptions options[] =
+{
+  { "+protocol", I18N_NOOP( "Protocol name" ), 0 },
+  { "+pool", I18N_NOOP( "Socket name" ), 0 },
+  { "+app", I18N_NOOP( "Socket name" ), 0 },
+  KCmdLineLastOption
+};
+
+int kdemain( int argc, char **argv )
+{
+  putenv( strdup( "SESSION_MANAGER=" ) );
+  KApplication::disableAutoDcopRegistration();
+
+  KCmdLineArgs::init( argc, argv, "kio_scalix", 0, 0, 0, 0 );
+  KCmdLineArgs::addCmdLineOptions( options );
+  KApplication app( false, false );
+
+  KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+  Scalix slave( args->arg( 0 ), args->arg( 1 ), args->arg( 2 ) );
+  slave.dispatchLoop();
+
+  return 0;
+}
+
+Scalix::Scalix( const QCString &protocol, const QCString &pool, const QCString &app )
+  : SlaveBase( protocol, pool, app )
+{
+}
+
+void Scalix::get( const KURL &url )
+{
+  mimeType( "text/plain" );
+
+  QString path = url.path();
+
+  if ( path.contains( "/freebusy/" ) ) {
+    retrieveFreeBusy( url );
+  } else {
+    error( KIO::ERR_SLAVE_DEFINED, i18n( "Unknown path. Known path is '/freebusy/'" ) );
+  }
+}
+
+void Scalix::put( const KURL& url, int, bool, bool )
+{
+  QString path = url.path();
+
+  if ( path.contains( "/freebusy/" ) ) {
+    publishFreeBusy( url );
+  } else {
+    error( KIO::ERR_SLAVE_DEFINED, i18n( "Unknown path. Known path is '/freebusy/'" ) );
+  }
+}
+
+void Scalix::retrieveFreeBusy( const KURL &url )
+{
+  /**
+   * The url is of the following form:
+   *  scalix://user:password@host/freebusy/user@domain.ifb
+   */
+
+  // Extract user@domain (e.g. everything between '/freebusy/' and '.ifb')
+  const QString requestUser = url.path().mid( 10, url.path().length() - 14 );
+
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+
+  const QString argument = QString( "BEGIN:VFREEBUSY\nATTENDEE:MAILTO:%1\nEND:VFREEBUSY" ).arg( requestUser );
+  const QString command = QString( "X-GET-ICAL-FREEBUSY {%1}" ).arg( argument.length() );
+
+  stream << (int) 'X' << 'E' << command << argument;
+
+  QString imapUrl = QString( "imap://%1@%3/" ).arg( url.pass().isEmpty() ?
+                                                   url.user() : url.user() + ":" + url.pass() )
+                                                .arg( url.host() );
+
+  mFreeBusyData = QString();
+
+  KIO::SimpleJob *job = KIO::special( imapUrl, packedArgs, false );
+  connect( job, SIGNAL( infoMessage( KIO::Job*, const QString& ) ),
+           this, SLOT( slotInfoMessage( KIO::Job*, const QString& ) ) );
+  connect( job, SIGNAL( result( KIO::Job* ) ),
+           this, SLOT( slotRetrieveResult( KIO::Job* ) ) );
+
+  qApp->eventLoop()->enterLoop();
+}
+
+void Scalix::publishFreeBusy( const KURL &url )
+{
+  /**
+   * The url is of the following form:
+   *  scalix://user:password@host/freebusy/path/to/calendar/user@domain
+   */
+  QString requestUser, calendar;
+  QString path = url.path();
+
+  // extract user name
+  int lastSlash = path.findRev( '/' );
+  if ( lastSlash != -1 )
+    requestUser = path.mid( lastSlash + 1 );
+
+  // extract calendar name
+  int secondSlash = path.find( '/', 1 );
+  if ( secondSlash != -1 )
+    calendar = path.mid( secondSlash + 1, lastSlash - secondSlash - 1 );
+
+  if ( requestUser.isEmpty() || calendar.isEmpty() ) {
+    error( KIO::ERR_SLAVE_DEFINED, i18n( "No user or calendar given!" ) );
+    return;
+  };
+
+  // read freebusy information
+  QByteArray data;
+  while ( true ) {
+    dataReq();
+
+    QByteArray buffer;
+    const int newSize = readData(buffer);
+    if ( newSize < 0 ) {
+      // read error: network in unknown state so disconnect
+      error( KIO::ERR_COULD_NOT_READ, i18n("KIO data supply error.") );
+      return;
+    }
+
+    if ( newSize == 0 )
+      break;
+
+    unsigned int oldSize = data.size();
+    data.resize( oldSize + buffer.size() );
+    memcpy( data.data() + oldSize, buffer.data(), buffer.size() );
+  }
+
+  QByteArray packedArgs;
+  QDataStream stream( packedArgs, IO_WriteOnly );
+
+  const QString argument = QString::fromUtf8( data );
+  const QString command = QString( "X-PUT-ICAL-FREEBUSY Calendar {%1}" ).arg( argument.length() );
+
+  stream << (int) 'X' << 'E' << command << argument;
+
+  QString imapUrl = QString( "imap://%1@%3/" ).arg( url.pass().isEmpty() ?
+                                                   url.user() : url.user() + ":" + url.pass() )
+                                                .arg( url.host() );
+
+  KIO::SimpleJob *job = KIO::special( imapUrl, packedArgs, false );
+  connect( job, SIGNAL( result( KIO::Job* ) ),
+           this, SLOT( slotPublishResult( KIO::Job* ) ) );
+
+  qApp->eventLoop()->enterLoop();
+}
+
+void Scalix::slotInfoMessage( KIO::Job *job, const QString &data )
+{
+  if ( job->error() ) {
+    // error is handled in slotResult
+    return;
+  }
+
+  mFreeBusyData = data;
+}
+
+
+void Scalix::slotRetrieveResult( KIO::Job *job )
+{
+  if ( job->error() ) {
+    error( KIO::ERR_SLAVE_DEFINED, job->errorString() );
+  } else {
+    data( mFreeBusyData.utf8() );
+    finished();
+  }
+
+  qApp->eventLoop()->exitLoop();
+}
+
+void Scalix::slotPublishResult( KIO::Job *job )
+{
+  if ( job->error() ) {
+    error( KIO::ERR_SLAVE_DEFINED, job->errorString() );
+  } else {
+    finished();
+  }
+
+  qApp->eventLoop()->exitLoop();
+}
+
+#include "scalix.moc"
Index: kresources/scalix/kioslave/scalixs.protocol
===================================================================
--- kresources/scalix/kioslave/scalixs.protocol	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kioslave/scalixs.protocol	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,8 @@
+[Protocol]
+DocPath=kioslave/scalix.html
+exec=kio_scalix
+input=none
+output=filesystem
+protocol=scalixs
+reading=true
+writing=true
Index: kresources/scalix/kioslave/Makefile.am
===================================================================
--- kresources/scalix/kioslave/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kioslave/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,17 @@
+INCLUDES = -I$(top_srcdir) -I$(top_builddir)/libkdepim $(all_includes)
+
+noinst_HEADERS = scalix.h
+
+METASOURCES = AUTO
+
+kdelnkdir = $(kde_servicesdir)
+kdelnk_DATA = scalix.protocol scalixs.protocol
+
+kde_module_LTLIBRARIES =  kio_scalix.la
+
+kio_scalix_la_SOURCES = scalix.cpp
+kio_scalix_la_LIBADD = $(top_builddir)/libkcal/libkcal.la $(top_builddir)/libkdepim/libkdepim.la $(LIB_KIO)
+kio_scalix_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
+
+messages: rc.cpp
+	$(XGETTEXT) *.cpp -o $(podir)/kio_scalix.pot
Index: kresources/scalix/kioslave/scalix.h
===================================================================
--- kresources/scalix/kioslave/scalix.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/scalix/kioslave/scalix.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,51 @@
+/*
+    This file is part of KDE.
+
+    Copyright (C) 2007 Trolltech ASA. All rights reserved.
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef SCALIX_H
+#define SCALIX_H
+
+#include <kio/job.h>
+#include <kio/slavebase.h>
+
+#include <qobject.h>
+
+class Scalix : public QObject, public KIO::SlaveBase
+{
+  Q_OBJECT
+
+  public:
+    Scalix( const QCString &protocol, const QCString &pool, const QCString &app );
+
+    void get( const KURL &url );
+    void put( const KURL &url, int permissions, bool overwrite, bool resume );
+
+  private slots:
+    void slotRetrieveResult( KIO::Job* );
+    void slotPublishResult( KIO::Job* );
+    void slotInfoMessage( KIO::Job*, const QString& );
+
+  private:
+    void retrieveFreeBusy( const KURL& );
+    void publishFreeBusy( const KURL& );
+
+    QString mFreeBusyData;
+};
+
+#endif

Zmiany atrybut√≥w dla: kresources/scalix/kioslave
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in



Zmiany atrybut√≥w dla: kresources/scalix
___________________________________________________________________
Nazwa: svn:ignore
   + Makefile
Makefile.in


Index: kresources/kolab/kabc/contact.h
===================================================================
--- kresources/kolab/kabc/contact.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kabc/contact.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2002 - 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
Index: kresources/kolab/kabc/resourcekolab.cpp
===================================================================
--- kresources/kolab/kabc/resourcekolab.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kabc/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2002 - 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
@@ -185,7 +185,7 @@
 {
   int count = 0;
   if ( !kmailIncidencesCount( count, QString::null, subResource ) ) {
-    kdError() << "Communication problem in KABC::ResourceKolab::loadSubResourceHelper()\n";
+    kdError() << "Communication problem in KABC::ResourceKolab::loadSubResource()\n";
     return false;
   }
   if ( !count )
@@ -654,4 +654,17 @@
   }
 }
 
+
+/*virtual*/
+bool KABC::ResourceKolab::addSubresource( const QString& label, const QString& parent )
+{
+  return kmailAddSubresource( label, parent, s_kmailContentsType );
+}
+
+/*virtual*/
+bool KABC::ResourceKolab::removeSubresource( const QString& id )
+{
+  return kmailRemoveSubresource( id );
+}
+
 #include "resourcekolab.moc"
Index: kresources/kolab/kabc/resourcekolab.h
===================================================================
--- kresources/kolab/kabc/resourcekolab.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kabc/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2002 - 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2002 - 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
@@ -126,11 +126,17 @@
 
   /// Is this subresource active?
   bool subresourceActive( const QString& ) const;
-  /// Is this subresource writabel?
-  bool subresourceWritable( const QString& ) const;
+  /// Is this subresource writable?
+  virtual bool subresourceWritable( const QString& ) const;
 
   virtual void setSubresourceActive( const QString &, bool );
 
+  virtual bool addSubresource( const QString&, const QString& );
+
+  virtual bool removeSubresource( const QString& );
+
+  virtual bool canHaveSubresources() const { return true; }
+
   /// Completion weight for a given subresource
   virtual int subresourceCompletionWeight( const QString& ) const;
 
Index: kresources/kolab/kabc/contact.cpp
===================================================================
--- kresources/kolab/kabc/contact.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kabc/contact.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
@@ -562,7 +562,9 @@
 {
   Member member;
   for ( QDomNode n = element.firstChild(); !n.isNull(); n = n.nextSibling() ) {
-   if ( n.isElement() ) {
+    if ( n.isComment() )
+      continue;
+    if ( n.isElement() ) {
       QDomElement e = n.toElement();
       QString tagName = e.tagName();
       if ( tagName == "display-name" )
@@ -1027,7 +1029,7 @@
   setNickName( addressee->nickName() );
   setSpouseName( addressee->custom( "KADDRESSBOOK", "X-SpousesName" ) );
   if ( !addressee->birthday().isNull() )
-  	setBirthday( addressee->birthday().date() );
+    setBirthday( addressee->birthday().date() );
   const QString& anniversary = addressee->custom( "KADDRESSBOOK", "X-Anniversary" );
   if ( !anniversary.isEmpty() )
     setAnniversary( stringToDate( anniversary  ) );
@@ -1150,7 +1152,11 @@
     distrList.setName( fullName() );
     QValueList<Member>::ConstIterator mit = mDistrListMembers.begin();
     for ( ; mit != mDistrListMembers.end(); ++mit ) {
-      distrList.insertEntry( (*mit).displayName, (*mit).email );
+      QString displayName = (*mit).displayName;
+      // fixup the display name DistributionList::assumes neither ',' nor ';' is present
+      displayName.replace( ',', ' ' );
+      displayName.replace( ';', ' ' );
+      distrList.insertEntry( displayName, (*mit).email );
     }
     addressee->insertCustom( "KADDRESSBOOK", "DistributionList", distrList.custom( "KADDRESSBOOK", "DistributionList" ) );
     Q_ASSERT( KPIM::DistributionList::isDistributionList( *addressee ) );
Index: kresources/kolab/knotes/resourcekolab.cpp
===================================================================
--- kresources/kolab/knotes/resourcekolab.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/knotes/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -327,7 +327,7 @@
 
 void ResourceKolab::fromKMailAddSubresource( const QString& type,
                                              const QString& subResource,
-                                             const QString& mimetype,
+                                             const QString& /*label*/,
                                              bool writable,
                                              bool /*alarmRelevant*/ )
 {
@@ -344,7 +344,7 @@
 
   bool active = config.readBoolEntry( subResource, true );
   mSubResources[ subResource ] = Kolab::SubResource( active, writable, subResource );
-  loadSubResource( subResource, mimetype );
+  loadSubResource( subResource, attachmentMimeType );
   emit signalSubresourceAdded( this, type, subResource );
 }
 
Index: kresources/kolab/knotes/note.cpp
===================================================================
--- kresources/kolab/knotes/note.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/knotes/note.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -55,7 +55,7 @@
   return note.saveXML();
 }
 
-Note::Note( KCal::Journal* journal )
+Note::Note( KCal::Journal* journal ) : mRichText( false )
 {
   if ( journal )
     setFields( journal );
@@ -95,6 +95,16 @@
   return mForegroundColor;
 }
 
+void Note::setRichText( bool richText )
+{
+  mRichText = richText;
+}
+
+bool Note::richText() const
+{
+  return mRichText;
+}
+
 bool Note::loadAttribute( QDomElement& element )
 {
   QString tagName = element.tagName();
@@ -105,6 +115,8 @@
     setForegroundColor( stringToColor( element.text() ) );
   else if ( tagName == "background-color" )
     setBackgroundColor( stringToColor( element.text() ) );
+  else if ( tagName == "knotes-richtext" )
+    mRichText = ( element.text() == "true" );
   else
     return KolabBase::loadAttribute( element );
 
@@ -126,6 +138,7 @@
   writeString( element, "summary", summary() );
   writeString( element, "foreground-color", colorToString( foregroundColor() ) );
   writeString( element, "background-color", colorToString( backgroundColor() ) );
+  writeString( element, "knotes-richtext", mRichText ? "true" : "false" );
 
   return true;
 }
@@ -172,6 +185,9 @@
 
   // TODO: background and foreground
   setSummary( journal->summary() );
+  setBackgroundColor( journal->customProperty( "KNotes", "BgColor" ) );
+  setForegroundColor( journal->customProperty( "KNotes", "FgColor" ) );
+  setRichText( journal->customProperty( "KNotes", "RichText" ) == "true" );
 }
 
 void Note::saveTo( KCal::Journal* journal )
@@ -180,6 +196,12 @@
 
   // TODO: background and foreground
   journal->setSummary( summary() );
+  journal->setCustomProperty( "KNotes", "FgColor",
+                              colorToString( foregroundColor() ) );
+  journal->setCustomProperty( "KNotes", "BgColor",
+                              colorToString( backgroundColor() ) );
+  journal->setCustomProperty( "KNotes", "RichText",
+                              richText() ? "true" : "false" );
 }
 
 QString Note::productID() const
Index: kresources/kolab/knotes/note.h
===================================================================
--- kresources/kolab/knotes/note.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/knotes/note.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -76,6 +76,9 @@
   virtual void setForegroundColor( const QColor& fgColor );
   virtual QColor foregroundColor() const;
 
+  virtual void setRichText( bool richText );
+  virtual bool richText() const;
+
   // Load the attributes of this class
   virtual bool loadAttribute( QDomElement& );
 
@@ -100,6 +103,7 @@
   QString mSummary;
   QColor mBackgroundColor;
   QColor mForegroundColor;
+  bool mRichText;
 };
 
 }
Index: kresources/kolab/kolab-resource.upd
===================================================================
--- kresources/kolab/kolab-resource.upd	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/kolab/kolab-resource.upd	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,12 @@
+# Update the name of the resource
+Id=kolab-calendar-resource-rename
+File=kresources/calendar/stdrc
+Script=upgrade-resourcetype.pl,perl
+
+Id=kolab-contact-resource-rename
+File=kresources/contact/stdrc
+Script=upgrade-resourcetype.pl,perl
+
+Id=kolab-notes-resource-rename
+File=kresources/notes/stdrc
+Script=upgrade-resourcetype.pl,perl
Index: kresources/kolab/shared/resourcekolabbase.h
===================================================================
--- kresources/kolab/shared/resourcekolabbase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/resourcekolabbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -132,6 +132,14 @@
                            Q_UINT32 sernum,
                            const QString& filename ) const;
 
+  /** Get the mimetype of the specified attachment. */
+  bool kmailAttachmentMimetype( QString &mimeType, QString &resource,
+                                Q_UINT32 sernum, const QString &filename ) const;
+
+  /// List all attachments of a mail.
+  bool kmailListAttachments( QStringList &list, const QString &resource,
+                             Q_UINT32 sernum ) const;
+
 protected:
   /// Delete an incidence.
   bool kmailDeleteIncidence( const QString& resource, Q_UINT32 sernum );
@@ -152,11 +160,16 @@
                     const QStringList& attachmentNames = QStringList(),
                     const QStringList& deletedAttachments = QStringList() );
 
+  bool kmailAddSubresource( const QString& resource, const QString& parent,
+                            const QString& contentsType );
+  bool kmailRemoveSubresource( const QString& resource );
+
   /// Get the full path of the config file.
   QString configFile( const QString& type ) const;
 
   /// If only one of these is writable, return that. Otherwise return null.
-  QString findWritableResource( const ResourceMap& resources );
+  QString findWritableResource( const ResourceMap& resources,
+                                const QString& text = QString::null );
 
   bool mSilent;
 
Index: kresources/kolab/shared/subresource.cpp
===================================================================
--- kresources/kolab/shared/subresource.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/subresource.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
Index: kresources/kolab/shared/kmailconnection.h
===================================================================
--- kresources/kolab/shared/kmailconnection.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/kmailconnection.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -59,8 +59,8 @@
   void fromKMailDelIncidence( const QString& type, const QString& resource,
                               const QString& xml );
   void fromKMailRefresh( const QString& type, const QString& resource );
-  void fromKMailAddSubresource( const QString& type, const QString& resource, 
-                                const QString& label, bool writable, 
+  void fromKMailAddSubresource( const QString& type, const QString& resource,
+                                const QString& label, bool writable,
                                 bool alarmRelevant );
   void fromKMailDelSubresource( const QString& type, const QString& resource );
   void fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map, const QString& type,
@@ -88,6 +88,10 @@
 
   bool kmailGetAttachment( KURL& url, const QString& resource, Q_UINT32 sernum,
                            const QString& filename );
+  bool kmailAttachmentMimetype( QString &mimeType, const QString &resource,
+                                Q_UINT32 sernum, const QString &filename );
+  bool kmailListAttachments( QStringList &list, const QString &resource,
+                             Q_UINT32 sernum );
   bool kmailDeleteIncidence( const QString& resource, Q_UINT32 sernum );
   bool kmailUpdate( const QString& resource,
                     Q_UINT32& sernum,
@@ -102,6 +106,10 @@
   bool kmailStorageFormat( KMailICalIface::StorageFormat& type, const QString& folder);
 
   bool kmailTriggerSync( const QString& contentsType );
+  bool kmailAddSubresource( const QString& resource,
+                            const QString& parent,
+                            const QString& contentsType );
+  bool kmailRemoveSubresource( const QString& resource );
 
 private slots:
   virtual void unregisteredFromDCOP( const QCString& );
Index: kresources/kolab/shared/kolabbase.cpp
===================================================================
--- kresources/kolab/shared/kolabbase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/kolabbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -255,7 +255,7 @@
       continue;
     if ( n.isElement() ) {
       QDomElement e = n.toElement();
-      QString tagName = e.tagName();
+      const QString tagName = e.tagName();
 
       if ( tagName == "display-name" )
         email.displayName = e.text();
@@ -282,31 +282,58 @@
 
 bool KolabBase::loadAttribute( QDomElement& element )
 {
-  QString tagName = element.tagName();
-
-  if ( tagName == "uid" )
-    setUid( element.text() );
-  else if ( tagName == "body" )
-    setBody( element.text() );
-  else if ( tagName == "categories" )
-    setCategories( element.text() );
-  else if ( tagName == "creation-date" )
-    setCreationDate( stringToDateTime( element.text() ) );
-  else if ( tagName == "last-modification-date" )
-    setLastModified( stringToDateTime( element.text() ) );
-  else if ( tagName == "sensitivity" )
-    setSensitivity( stringToSensitivity( element.text() ) );
-  else if ( tagName == "product-id" )
-    return true; // ignore this field
-  else if ( tagName == "pilot-sync-id" )
-    setPilotSyncId( element.text().toULong() );
-  else if ( tagName == "pilot-sync-status" )
-    setPilotSyncStatus( element.text().toInt() );
-  else
-    return false;
-
-  // Handled here
-  return true;
+  const QString tagName = element.tagName();
+  switch ( tagName[0].latin1() ) {
+  case 'u':
+    if ( tagName == "uid" ) {
+      setUid( element.text() );
+      return true;
+    }
+    break;
+  case 'b':
+    if ( tagName == "body" ) {
+      setBody( element.text() );
+      return true;
+    }
+    break;
+  case 'c':
+    if ( tagName == "categories" ) {
+      setCategories( element.text() );
+      return true;
+    }
+    if ( tagName == "creation-date" ) {
+      setCreationDate( stringToDateTime( element.text() ) );
+      return true;
+    }
+    break;
+  case 'l':
+    if ( tagName == "last-modification-date" ) {
+      setLastModified( stringToDateTime( element.text() ) );
+      return true;
+    }
+    break;
+  case 's':
+    if ( tagName == "sensitivity" ) {
+      setSensitivity( stringToSensitivity( element.text() ) );
+      return true;
+    }
+    break;
+  case 'p':
+    if ( tagName == "product-id" )
+      return true; // ignore this field
+    if ( tagName == "pilot-sync-id" ) {
+      setPilotSyncId( element.text().toULong() );
+      return true;
+    }
+    if ( tagName == "pilot-sync-status" ) {
+      setPilotSyncStatus( element.text().toInt() );
+      return true;
+    }
+    break;
+  default:
+    break;
+  }
+  return false;
 }
 
 bool KolabBase::saveAttributes( QDomElement& element ) const
Index: kresources/kolab/shared/subresource.h
===================================================================
--- kresources/kolab/shared/subresource.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/subresource.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 /*
     This file is part of libkabc and/or kaddressbook.
-    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+    Copyright (c) 2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
     This library is free software; you can redistribute it and/or
Index: kresources/kolab/shared/resourcekolabbase.cpp
===================================================================
--- kresources/kolab/shared/resourcekolabbase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/resourcekolabbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -97,6 +97,19 @@
   return mConnection->kmailGetAttachment( url, resource, sernum, filename );
 }
 
+bool ResourceKolabBase::kmailAttachmentMimetype( QString & mimeType, QString & resource,
+                                                 Q_UINT32 sernum, const QString & filename ) const
+{
+  return mConnection->kmailAttachmentMimetype( mimeType, resource, sernum, filename );
+}
+
+bool ResourceKolabBase::kmailListAttachments( QStringList &list,
+                                              const QString & resource,
+                                              Q_UINT32 sernum ) const
+{
+  return mConnection->kmailListAttachments( list, resource, sernum );
+}
+
 bool ResourceKolabBase::kmailDeleteIncidence( const QString& resource,
                                               Q_UINT32 sernum )
 {
@@ -183,8 +196,21 @@
   return mConnection->connectToKMail();
 }
 
-QString ResourceKolabBase::findWritableResource( const ResourceMap& resources )
+bool ResourceKolabBase::kmailAddSubresource( const QString& resource,
+                                             const QString& parent,
+                                             const QString& contentsType )
 {
+  return mConnection->kmailAddSubresource( resource, parent, contentsType );
+}
+
+bool ResourceKolabBase::kmailRemoveSubresource( const QString& resource )
+{
+  return mConnection->kmailRemoveSubresource( resource );
+}
+
+QString ResourceKolabBase::findWritableResource( const ResourceMap& resources,
+                                                 const QString& text )
+{
   // I have to use the label (shown in the dialog) as key here. But given how the
   // label is made up, it should be unique. If it's not, well the dialog would suck anyway...
   QMap<QString, QString> possible;
@@ -206,11 +232,14 @@
     // Just one found
     return possible.begin().data(); // yes this is the subresource key, i.e. location
 
+  QString t = text;
+  if ( t.isEmpty() )
+    i18n( "You have more than one writable resource folder. "
+          "Please select the one you want to write to." );
+
   // Several found, ask the user
   QString chosenLabel = KInputDialog::getItem( i18n( "Select Resource Folder" ),
-                                               i18n( "You have more than one writable resource folder. "
-                                                     "Please select the one you want to write to." ),
-                                               possible.keys() );
+                                               t, possible.keys() );
   if ( chosenLabel.isEmpty() ) // cancelled
     return QString::null;
   return possible[chosenLabel];
Index: kresources/kolab/shared/kmailconnection.cpp
===================================================================
--- kresources/kolab/shared/kmailconnection.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/shared/kmailconnection.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -150,7 +150,7 @@
 {
 //   kdDebug(5650) << "KMailConnection::fromKMailAddSubresource( " << type << ", "
 //                 << resource << " )\n";
-  mResource->fromKMailAddSubresource( type, resource, label, 
+  mResource->fromKMailAddSubresource( type, resource, label,
                                       writable, alarmRelevant );
 }
 
@@ -223,6 +223,27 @@
   return mKMailIcalIfaceStub->ok();
 }
 
+bool KMailConnection::kmailAttachmentMimetype( QString & mimeType,
+                                               const QString & resource,
+                                               Q_UINT32 sernum,
+                                               const QString & filename )
+{
+  if ( !connectToKMail() )
+    return false;
+  mimeType = mKMailIcalIfaceStub->attachmentMimetype( resource, sernum, filename );
+  return mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailListAttachments(QStringList &list,
+                                            const QString & resource, Q_UINT32 sernum)
+{
+  if ( !connectToKMail() )
+    return false;
+
+  list = mKMailIcalIfaceStub->listAttachments( resource, sernum );
+  return mKMailIcalIfaceStub->ok();
+}
+
 bool KMailConnection::kmailDeleteIncidence( const QString& resource,
                                             Q_UINT32 sernum )
 {
@@ -251,6 +272,23 @@
     return false;
 }
 
+bool KMailConnection::kmailAddSubresource( const QString& resource,
+                                           const QString& parent,
+                                           const QString& contentsType )
+{
+  return connectToKMail()
+      && mKMailIcalIfaceStub->addSubresource( resource, parent, contentsType )
+      && mKMailIcalIfaceStub->ok();
+}
+
+bool KMailConnection::kmailRemoveSubresource( const QString& resource )
+{
+  return connectToKMail()
+      && mKMailIcalIfaceStub->removeSubresource( resource )
+      && mKMailIcalIfaceStub->ok();
+}
+
+
 bool KMailConnection::kmailStorageFormat( KMailICalIface::StorageFormat& type,
                                           const QString& folder )
 {
Index: kresources/kolab/upgrade-resourcetype.pl
===================================================================
--- kresources/kolab/upgrade-resourcetype.pl	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kresources/kolab/upgrade-resourcetype.pl	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,24 @@
+#!/usr/bin/perl -w
+
+use strict;
+
+# This script updates some configuration keys
+
+# read the whole config file
+my $currentGroup = "";
+my %configFile;
+while ( <> ) {
+  chomp; # eat the trailing '\n'
+  next if ( /^$/ ); # skip empty lines
+  next if ( /^\#/ ); # skip comments
+  if ( /^\[(.+)\]$/ ) { # group begin
+    $currentGroup = $1;
+    next;
+  } elsif ( $currentGroup =~ /^Resource/ ) {
+    my ($key,$value) = split /=/;
+    if ( $key eq "ResourceType" and $value eq "kolab" ) {
+      print "# DELETE [$currentGroup]$key\n";
+      print "[$currentGroup]\nResourceType=imap\n";
+    }
+  }
+}
Index: kresources/kolab/Makefile.am
===================================================================
--- kresources/kolab/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,8 @@
 SUBDIRS = shared kabc knotes kcal
 
+updatedir = $(kde_datadir)/kconf_update
+update_DATA = kolab-resource.upd
+update_SCRIPTS = upgrade-resourcetype.pl 
+
 messages: rc.cpp
 	$(XGETTEXT) */*.cpp -o $(podir)/kres_kolab.pot
Index: kresources/kolab/kcal/resourcekolab.cpp
===================================================================
--- kresources/kolab/kcal/resourcekolab.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/resourcekolab.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,7 +46,11 @@
 #include <kabc/locknull.h>
 #include <kmainwindow.h>
 #include <klocale.h>
+#include <kinputdialog.h>
+#include <ktempfile.h>
+#include <kmdcodec.h>
 
+#include <qfile.h>
 #include <qobject.h>
 #include <qtimer.h>
 #include <qapplication.h>
@@ -107,7 +111,7 @@
   map.clear();
   QValueList<KMailICalIface::SubResource>::ConstIterator it;
   for ( it = subResources.begin(); it != subResources.end(); ++it )
-    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable, 
+    loadSubResourceConfig( config, (*it).location, (*it).label, (*it).writable,
                            (*it).alarmRelevant, map );
   return true;
 }
@@ -212,6 +216,9 @@
 
 bool ResourceKolab::doLoad()
 {
+  if (!mUidMap.isEmpty() ) {
+    return true;
+  }
   mUidMap.clear();
 
   return loadAllEvents() & loadAllTodos() & loadAllJournals();
@@ -290,18 +297,11 @@
       && kmailTriggerSync( kmailJournalContentsType );
   */
 }
-
-void ResourceKolab::incidenceUpdated( KCal::IncidenceBase* incidencebase )
+void ResourceKolab::incidenceUpdatedSilent( KCal::IncidenceBase* incidencebase)
 {
-  if ( incidencebase->isReadOnly() ) return; // Should not happen (TM)
-  incidencebase->setSyncStatus( KCal::Event::SYNCMOD );
-  incidencebase->setLastModified( QDateTime::currentDateTime() );
-  // we should probably update the revision number here,
-  // or internally in the Event itself when certain things change.
-  // need to verify with ical documentation.
+ const QString uid = incidencebase->uid();
+  //kdDebug() << k_funcinfo << uid << endl;
 
-  const QString uid = incidencebase->uid();
-
   if ( mUidsPendingUpdate.contains( uid ) || mUidsPendingAdding.contains( uid ) ) {
     /* We are currently processing this event ( removing and readding or
      * adding it ). If so, ignore this update. Keep the last of these around
@@ -318,8 +318,20 @@
     mUidsPendingUpdate.append( uid );
   }
   sendKMailUpdate( incidencebase, subResource, sernum );
+
 }
+void ResourceKolab::incidenceUpdated( KCal::IncidenceBase* incidencebase )
+{
+  if ( incidencebase->isReadOnly() ) return;
+  incidencebase->setSyncStatusSilent( KCal::Event::SYNCMOD );
+  incidencebase->setLastModified( QDateTime::currentDateTime() );
+  // we should probably update the revision number here,
+  // or internally in the Event itself when certain things change.
+  // need to verify with ical documentation.
+  incidenceUpdatedSilent( incidencebase );
 
+}
+
 void ResourceKolab::resolveConflict( KCal::Incidence* inc, const QString& subresource, Q_UINT32 sernum )
 {
     if ( ! inc )
@@ -329,45 +341,54 @@
         delete inc;
         return;
     }
-    Incidence* local = mCalendar.incidence( inc->uid() );
+    const QString origUid = inc->uid();
+    Incidence* local = mCalendar.incidence( origUid );
     Incidence* localIncidence = 0;
     Incidence* addedIncidence = 0;
+    Incidence*  result = 0;
     if ( local ) {
+      if (*local == *inc) {
+        // real duplicate, remove the second one
+        result = local;
+      } else {
         KIncidenceChooser* ch = new KIncidenceChooser();
         ch->setIncidence( local ,inc );
         if ( KIncidenceChooser::chooseMode == KIncidenceChooser::ask ) {
-            connect ( this, SIGNAL( useGlobalMode() ), ch, SLOT (  useGlobalMode() ) );
-            if ( ch->exec() )
-                if ( KIncidenceChooser::chooseMode != KIncidenceChooser::ask )
-                    emit useGlobalMode() ;
+          connect ( this, SIGNAL( useGlobalMode() ), ch, SLOT (  useGlobalMode() ) );
+          if ( ch->exec() )
+            if ( KIncidenceChooser::chooseMode != KIncidenceChooser::ask )
+              emit useGlobalMode() ;
         }
-        Incidence* result = ch->getIncidence();
-      delete ch;
-      if ( result == local ) {
-          localIncidence = local->clone();
-          delete inc;
-      } else  if ( result == inc ) {
-          addedIncidence = inc;
-      } else if ( result == 0 ) { // take both
-          localIncidence = local->clone();
-          localIncidence->recreate();
-          localIncidence->setSummary( i18n("Copy of: %1").arg(localIncidence->summary()) );
-          addedIncidence = inc;
+        result = ch->getIncidence();
+        delete ch;
       }
-      bool silent = mSilent;
-      mSilent = false;
-      deleteIncidence( local ); // remove local from kmail
-      kmailDeleteIncidence( subresource, sernum );// remove new from kmail
-      if ( localIncidence ) {
-        addIncidence( localIncidence, subresource, 0  );
-        mUidsPendingAdding.remove( localIncidence->uid() ); // we do want to inform KOrg also
-      }
-      if ( addedIncidence  ) {
-        addIncidence( addedIncidence, subresource, 0  );
-        mUidsPendingAdding.remove( addedIncidence->uid() ); // we do want to inform KOrg also
-      }
-      mSilent = silent;
-  }
+    } else {
+      // nothing there locally, just take the new one. Can't Happen (TM)
+      result = inc;
+    }
+    if ( result == local ) {
+        delete inc;
+        localIncidence = local;
+    } else  if ( result == inc ) {
+        addedIncidence = inc;
+    } else if ( result == 0 ) { // take both
+        addedIncidence = inc;
+        addedIncidence->setSummary( i18n("Copy of: %1").arg( addedIncidence->summary() ) );
+        addedIncidence->setUid( CalFormat::createUniqueId() );
+        localIncidence = local;
+    }
+    bool silent = mSilent;
+    mSilent = false;
+    if ( !localIncidence ) {
+        deleteIncidence( local ); // remove local from kmail
+    }
+    mUidsPendingDeletion.append( origUid );
+    if ( addedIncidence  ) {
+        sendKMailUpdate( addedIncidence, subresource, sernum );
+    } else {
+        kmailDeleteIncidence( subresource, sernum );// remove new from kmail
+    }
+    mSilent = silent;
 }
 void ResourceKolab::addIncidence( const char* mimetype, const QString& data,
                                   const QString& subResource, Q_UINT32 sernum )
@@ -431,6 +452,27 @@
 //  kdDebug() << k_funcinfo << "Data string:\n" << data << endl;
 
   KCal::Incidence* incidence = static_cast<KCal::Incidence *>( incidencebase );
+
+  KCal::Attachment::List atts = incidence->attachments();
+  QStringList attURLs, attMimeTypes, attNames;
+  QValueList<KTempFile*> tmpFiles;
+  for ( KCal::Attachment::List::ConstIterator it = atts.constBegin(); it != atts.constEnd(); ++it ) {
+    KTempFile* tempFile = new KTempFile;
+    QCString decoded = KCodecs::base64Decode( QCString( (*it)->data() ) );
+    tempFile->file()->writeBlock( decoded.data(), decoded.length() );
+    tempFile->close();
+    KURL url;
+    url.setPath( tempFile->name() );
+    attURLs.append( url.url() );
+    attMimeTypes.append( (*it)->mimeType() );
+    attNames.append( (*it)->label() );
+  }
+  QStringList deletedAtts;
+  if ( kmailListAttachments( deletedAtts, subresource, sernum ) ) {
+    for ( QStringList::ConstIterator it = attNames.constBegin(); it != attNames.constEnd(); ++it ) {
+      deletedAtts.remove( *it );
+    }
+  }
   CustomHeaderMap customHeaders;
   if ( incidence->schedulingID() != incidence->uid() )
     customHeaders.insert( "X-Kolab-SchedulingID", incidence->schedulingID() );
@@ -439,11 +481,17 @@
   if ( !isXMLStorageFormat ) subject.prepend( "iCal " ); // conform to the old style
 
   // behold, sernum is an in-parameter
-  const bool rc = kmailUpdate( subresource, sernum, data, mimetype, subject, customHeaders );
+  const bool rc = kmailUpdate( subresource, sernum, data, mimetype, subject, customHeaders, attURLs, attMimeTypes, attNames, deletedAtts );
   // update the serial number
   if ( mUidMap.contains( incidencebase->uid() ) ) {
     mUidMap[ incidencebase->uid() ].setSerialNumber( sernum );
   }
+
+  for( QValueList<KTempFile *>::Iterator it = tmpFiles.begin(); it != tmpFiles.end(); ++it ) {
+    (*it)->setAutoDelete( true );
+    delete (*it);
+  }
+
   return rc;
 }
 
@@ -452,7 +500,7 @@
 {
   Q_ASSERT( incidence );
   if ( !incidence ) return false;
-  const QString &uid = incidence->uid();
+  QString uid = incidence->uid();
   QString subResource = _subresource;
 
   Kolab::ResourceMap *map = &mEventSubResources; // don't use a ref here!
@@ -471,7 +519,37 @@
     // Find out if this event was previously stored in KMail
     bool newIncidence = _subresource.isEmpty();
     if ( newIncidence ) {
-      subResource = findWritableResource( *map );
+      // Add a description of the incidence
+      QString text = "<b><font size=\"+1\">";
+      if ( incidence->type() == "Event" )
+        text += i18n( "Choose the folder where you want to store this event" );
+      else if ( incidence->type() == "Todo" )
+        text += i18n( "Choose the folder where you want to store this task" );
+      else
+        text += i18n( "Choose the folder where you want to store this incidence" );
+      text += "<font></b><br>";
+      if ( !incidence->summary().isEmpty() )
+        text += i18n( "<b>Summary:</b> %1" ).arg( incidence->summary() ) + "<br>";
+      if ( !incidence->location().isEmpty() )
+        text += i18n( "<b>Location:</b> %1" ).arg( incidence->location() );
+      text += "<br>";
+      if ( !incidence->doesFloat() )
+        text += i18n( "<b>Start:</b> %1, %2" )
+                .arg( incidence->dtStartDateStr(), incidence->dtStartTimeStr() );
+      else
+        text += i18n( "<b>Start:</b> %1" ).arg( incidence->dtStartDateStr() );
+      text += "<br>";
+      if ( incidence->type() == "Event" ) {
+        Event* event = static_cast<Event*>( incidence );
+        if ( event->hasEndDate() )
+          if ( !event->doesFloat() )
+            text += i18n( "<b>End:</b> %1, %2" )
+                    .arg( event->dtEndDateStr(), event->dtEndTimeStr() );
+          else
+            text += i18n( "<b>End:</b> %1" ).arg( event->dtEndDateStr() );
+        text += "<br>";
+      }
+      subResource = findWritableResource( *map, text );
     }
 
     if ( subResource.isEmpty() )
@@ -511,15 +589,21 @@
        * unless the folder is read-only, in which case the user should not be
        * offered a means of putting mails in a folder she'll later be unable to
        * upload. Skip the incidence, in this case. */
-      if ( mUidMap.contains( uid )
-          && ( mUidMap[ uid ].resource() == subResource ) ) {
-        if ( (*map)[ subResource ].writable() ) {
-          resolveConflict( incidence, subResource, sernum );
+      if ( mUidMap.contains( uid ) ) {
+        if ( mUidMap[ uid ].resource() == subResource ) {
+          if ( (*map)[ subResource ].writable() ) {
+            resolveConflict( incidence, subResource, sernum );
+          } else {
+            kdWarning( 5650 ) << "Duplicate event in a read-only folder detected! "
+              "Please inform the owner of the folder. " << endl;
+          }
+          return true;
         } else {
-          kdWarning( 5650 ) << "Duplicate event in a read-only folder detected! "
-            "Please inform the owner of the folder. " << endl;
+          // duplicate uid in a different folder, do the internal-uid tango
+          incidence->setSchedulingID( uid );
+          incidence->setUid(CalFormat::createUniqueId( ) );
+          uid = incidence->uid();
         }
-        return true;
       }
       /* Add to the cache if the add didn't come from KOrganizer, in which case
        * we've already added it, and listen to updates from KOrganizer for it. */
@@ -564,7 +648,7 @@
 void ResourceKolab::addEvent( const QString& xml, const QString& subresource,
                               Q_UINT32 sernum )
 {
-  KCal::Event* event = Kolab::Event::xmlToEvent( xml, mCalendar.timeZoneId() );
+  KCal::Event* event = Kolab::Event::xmlToEvent( xml, mCalendar.timeZoneId(), this, subresource, sernum );
   Q_ASSERT( event );
   if( event ) {
       addIncidence( event, subresource, sernum );
@@ -636,7 +720,7 @@
 void ResourceKolab::addTodo( const QString& xml, const QString& subresource,
                              Q_UINT32 sernum )
 {
-  KCal::Todo* todo = Kolab::Task::xmlToTask( xml, mCalendar.timeZoneId() );
+  KCal::Todo* todo = Kolab::Task::xmlToTask( xml, mCalendar.timeZoneId(), this, subresource, sernum );
   Q_ASSERT( todo );
   if( todo )
       addIncidence( todo, subresource, sernum );
@@ -727,6 +811,8 @@
   return relevantAlarms;
 }
 
+
+
 KCal::Alarm::List ResourceKolab::alarms( const QDateTime& from,
                                          const QDateTime& to )
 {
@@ -789,8 +875,8 @@
   if ( !subresourceActive( subResource ) ) return;
 
   // Can't be in both, by contract
-  if ( mUidsPendingDeletion.contains( uid ) ) {
-    mUidsPendingDeletion.remove( uid );
+  if ( mUidsPendingDeletion.find( uid ) != mUidsPendingDeletion.end() ) {
+    mUidsPendingDeletion.remove( mUidsPendingDeletion.find( uid ) );
   } else if ( mUidsPendingUpdate.contains( uid ) ) {
     // It's good to know if was deleted, but we are waiting on a new one to
     // replace it, so let's just sit tight.
@@ -849,7 +935,7 @@
   config.setGroup( subResource );
 
   bool active = config.readBoolEntry( subResource, true );
-  (*map)[ subResource ] = Kolab::SubResource( active, writable, 
+  (*map)[ subResource ] = Kolab::SubResource( active, writable,
                                               alarmRelevant, label );
   loadSubResource( subResource, mimetype );
   emit signalSubresourceAdded( this, type, subResource, label );
@@ -872,26 +958,8 @@
   config.deleteGroup( subResource );
   config.sync();
 
-  // Make a list of all uids to remove
-  Kolab::UidMap::ConstIterator mapIt;
-  QStringList uids;
-  for ( mapIt = mUidMap.begin(); mapIt != mUidMap.end(); ++mapIt )
-    if ( mapIt.data().resource() == subResource )
-      // We have a match
-      uids << mapIt.key();
+  unloadSubResource( subResource );
 
-  // Finally delete all the incidences
-  if ( !uids.isEmpty() ) {
-    TemporarySilencer t( this );
-    QStringList::ConstIterator it;
-    for ( it = uids.begin(); it != uids.end(); ++it ) {
-      KCal::Incidence* incidence = mCalendar.incidence( *it );
-      if( incidence )
-        mCalendar.deleteIncidence( incidence );
-      mUidMap.remove( *it );
-    }
-  }
-
   emit signalSubresourceRemoved( this, type, subResource );
 }
 
@@ -917,18 +985,6 @@
   return subresource;
 }
 
-QString ResourceKolab::subresourceIdentifier( Incidence *incidence )
-{
-  QString uid = incidence->uid();
-  if ( mUidMap.contains( uid ) )
-    return mUidMap[ uid ].resource();
-  else
-    if ( mNewIncidencesMap.contains( uid ) )
-      return mNewIncidencesMap[ uid ];
-    else
-      return QString();
-}
-
 void ResourceKolab::fromKMailAsyncLoadResult( const QMap<Q_UINT32, QString>& map,
                                               const QString& type,
                                               const QString& folder )
@@ -960,17 +1016,27 @@
 void ResourceKolab::setSubresourceActive( const QString &subresource, bool v )
 {
   ResourceMap *map = 0;
-
-  if ( mEventSubResources.contains( subresource ) )
+  const char* mimeType = 0;
+  if ( mEventSubResources.contains( subresource ) ) {
      map = &mEventSubResources;
-  if ( mTodoSubResources.contains( subresource ) )
+     mimeType = eventAttachmentMimeType;
+  }
+  if ( mTodoSubResources.contains( subresource ) ) {
      map = &mTodoSubResources;
-  if ( mJournalSubResources.contains( subresource ) )
+     mimeType = todoAttachmentMimeType;
+  }
+  if ( mJournalSubResources.contains( subresource ) ) {
      map = &mJournalSubResources;
+     mimeType = journalAttachmentMimeType;
+  }
 
   if ( map && ( ( *map )[ subresource ].active() != v ) ) {
     ( *map )[ subresource ].setActive( v );
-    doLoad();                     // refresh the mCalendar cache
+    if ( v ) {
+        loadSubResource( subresource, mimeType );
+    } else {
+        unloadSubResource( subresource );
+    }
     mResourceChangedTimer.changeInterval( 100 );
   }
 }
@@ -1001,4 +1067,87 @@
   return 0;
 }
 
+
+/*virtual*/
+bool ResourceKolab::addSubresource( const QString& resource, const QString& parent )
+{
+   kdDebug(5650) << "KCal Kolab resource - adding subresource: " << resource << endl;
+   QString contentsType = kmailCalendarContentsType;
+   if ( !parent.isEmpty() ) {
+     if ( mEventSubResources.contains( parent ) )
+       contentsType = kmailCalendarContentsType;
+     else if ( mTodoSubResources.contains( parent ) )
+       contentsType = kmailTodoContentsType;
+     else if ( mJournalSubResources.contains( parent ) )
+       contentsType = kmailJournalContentsType;
+   } else {
+     QStringList contentTypeChoices;
+     contentTypeChoices << i18n("Calendar") << i18n("Tasks") << i18n("Journals");
+     const QString caption = i18n("Which kind of subresource should this be?");
+     const QString choice = KInputDialog::getItem( caption, QString::null, contentTypeChoices );
+     if ( choice == contentTypeChoices[0] )
+       contentsType = kmailCalendarContentsType;
+     else if ( choice == contentTypeChoices[1] )
+       contentsType = kmailTodoContentsType;
+     else if ( choice == contentTypeChoices[2] )
+       contentsType = kmailJournalContentsType;
+   }
+
+   return kmailAddSubresource( resource, parent, contentsType );
+}
+
+/*virtual*/
+bool ResourceKolab::removeSubresource( const QString& resource )
+{
+   kdDebug(5650) << "KCal Kolab resource - removing subresource: " << resource << endl;
+   return kmailRemoveSubresource( resource );
+}
+
+/*virtual*/
+QString ResourceKolab::subresourceIdentifier( Incidence *incidence )
+{
+  QString uid = incidence->uid();
+  if ( mUidMap.contains( uid ) )
+    return mUidMap[ uid ].resource();
+  else
+    if ( mNewIncidencesMap.contains( uid ) )
+      return mNewIncidencesMap[ uid ];
+    else
+      return QString();
+}
+
+
+bool ResourceKolab::unloadSubResource( const QString& subResource )
+{
+    const bool silent = mSilent;
+    mSilent = true;
+    Kolab::UidMap::Iterator mapIt = mUidMap.begin();
+    while ( mapIt != mUidMap.end() )
+    {
+        Kolab::UidMap::Iterator it = mapIt++;
+        const StorageReference ref = it.data();
+        if ( ref.resource() != subResource ) continue;
+        // FIXME incidence() is expensive
+        KCal::Incidence* incidence = mCalendar.incidence( it.key() );
+        if( incidence ) {
+            incidence->unRegisterObserver( this );
+            mCalendar.deleteIncidence( incidence );
+        }
+        mUidMap.remove( it );
+    }
+    mSilent = silent;
+    return true;
+}
+
+QString ResourceKolab::subresourceType( const QString &resource )
+{
+  if ( mEventSubResources.contains( resource ) )
+    return "event";
+  if ( mTodoSubResources.contains( resource ) )
+    return "todo";
+  if ( mJournalSubResources.contains( resource ) )
+    return "journal";
+  return QString();
+}
+
 #include "resourcekolab.moc"
Index: kresources/kolab/kcal/event.cpp
===================================================================
--- kresources/kolab/kcal/event.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/event.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,9 +39,10 @@
 using namespace Kolab;
 
 
-KCal::Event* Event::xmlToEvent( const QString& xml, const QString& tz  )
+KCal::Event* Event::xmlToEvent( const QString& xml, const QString& tz, KCal::ResourceKolab* res,
+                                const QString& subResource, Q_UINT32 sernum )
 {
-  Event event( tz );
+  Event event( res, subResource, sernum, tz );
   event.load( xml );
   KCal::Event* kcalEvent = new KCal::Event();
   event.saveTo( kcalEvent );
@@ -50,12 +51,14 @@
 
 QString Event::eventToXML( KCal::Event* kcalEvent, const QString& tz  )
 {
-  Event event( tz, kcalEvent );
+  Event event( 0, QString::null, 0, tz, kcalEvent );
   return event.saveXML();
 }
 
-Event::Event( const QString& tz, KCal::Event* event )
-  : Incidence( tz ), mShowTimeAs( KCal::Event::Opaque ), mHasEndDate( false )
+Event::Event( KCal::ResourceKolab *res, const QString &subResource, Q_UINT32 sernum,
+              const QString& tz, KCal::Event* event )
+  : Incidence( res, subResource, sernum, tz ),
+  mShowTimeAs( KCal::Event::Opaque ), mHasEndDate( false )
 {
   if ( event )
     setFields( event );
@@ -169,6 +172,7 @@
       kdDebug() << "Node is not a comment or an element???" << endl;
   }
 
+  loadAttachments();
   return true;
 }
 
Index: kresources/kolab/kcal/incidence.cpp
===================================================================
--- kresources/kolab/kcal/incidence.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,19 +32,28 @@
 */
 
 #include "incidence.h"
+#include "resourcekolab.h"
 
+#include <qfile.h>
 #include <qvaluelist.h>
 
 #include <libkcal/journal.h>
 #include <korganizer/version.h>
 #include <kdebug.h>
+#include <kmdcodec.h>
+#include <kurl.h>
+#include <kio/netaccess.h>
 
 using namespace Kolab;
 
 
-Incidence::Incidence( const QString& tz )
+Incidence::Incidence( KCal::ResourceKolab *res, const QString &subResource, Q_UINT32 sernum,
+                      const QString& tz )
   : KolabBase( tz ), mFloatingStatus( Unset ), mHasAlarm( false ),
-    mRevision( 0 )
+    mRevision( 0 ),
+    mResource( res ),
+    mSubResource( subResource ),
+    mSernum( sernum )
 {
 }
 
@@ -144,14 +153,14 @@
   return mAttendees;
 }
 
-void Incidence::setSchedulingID( const QString& sid )
+void Incidence::setInternalUID( const QString& iuid )
 {
-  mSchedulingID = sid;
+  mInternalUID = iuid;
 }
 
-QString Incidence::schedulingID() const
+QString Incidence::internalUID() const
 {
-  return mSchedulingID;
+  return mInternalUID;
 }
 
 void Incidence::setRevision( int revision )
@@ -189,6 +198,10 @@
         attendee.invitationSent = ( e.text().lower() != "true" );
       else if ( tagName == "role" )
         attendee.role = e.text();
+      else if ( tagName == "delegated-to" )
+        attendee.delegate = e.text();
+      else if ( tagName == "delegated-from" )
+        attendee.delegator = e.text();
       else
         // TODO: Unhandled tag - save for later storage
         kdDebug() << "Warning: Unhandled tag " << e.tagName() << endl;
@@ -212,6 +225,8 @@
   writeString( e, "invitation-sent",
                ( attendee.invitationSent ? "true" : "false" ) );
   writeString( e, "role", attendee.role );
+  writeString( e, "delegated-to", attendee.delegate );
+  writeString( e, "delegated-from", attendee.delegator );
 }
 
 void Incidence::saveAttendees( QDomElement& element ) const
@@ -229,7 +244,7 @@
     if ( a->isUri() ) {
       writeString( element, "link-attachment", a->uri() );
     } else if ( a->isBinary() ) {
-      // TODO
+      writeString( element, "inline-attachment", a->label() );
     }
   }
 }
@@ -320,15 +335,13 @@
       return true;
     } else
       return false;
-  } else if ( tagName == "inline-attachment" ) {
-    // TODO
   } else if ( tagName == "link-attachment" ) {
     mAttachments.push_back( new KCal::Attachment( element.text() ) );
   } else if ( tagName == "alarm" )
     // Alarms should be minutes before. Libkcal uses event time + alarm time
     setAlarm( - element.text().toInt() );
-  else if ( tagName == "scheduling-id" )
-    setSchedulingID( element.text() );
+  else if ( tagName == "x-kde-internaluid" )
+    setInternalUID( element.text() );
   else if ( tagName == "revision" ) {
     bool ok;
     int revision = element.text().toInt( &ok );
@@ -372,7 +385,7 @@
     int alarmTime = qRound( -alarm() );
     writeString( element, "alarm", QString::number( alarmTime ) );
   }
-  writeString( element, "scheduling-id", schedulingID() );
+  writeString( element, "x-kde-internaluid", internalUID() );
   writeString( element, "revision", QString::number( revision() ) );
   saveCustomAttributes( element );
   return true;
@@ -413,6 +426,8 @@
     return KCal::Attendee::Tentative;
   if ( s == "declined" )
     return KCal::Attendee::Declined;
+  if ( s == "delegated" )
+    return KCal::Attendee::Delegated;
 
   // Default:
   return KCal::Attendee::Accepted;
@@ -430,6 +445,7 @@
   case KCal::Attendee::Tentative:
     return "tentative";
   case KCal::Attendee::Delegated:
+    return "delegated";
   case KCal::Attendee::Completed:
   case KCal::Attendee::InProcess:
     // These don't have any meaning in the Kolab format, so just use:
@@ -617,6 +633,8 @@
     // attendee.invitationSent = kcalAttendee->mFlag;
     // DF: Hmm? mFlag is set to true and never used at all.... Did you mean another field?
     attendee.role = attendeeRoleToString( kcalAttendee->role() );
+    attendee.delegate = kcalAttendee->delegate();
+    attendee.delegator = kcalAttendee->delegator();
 
     addAttendee( attendee );
   }
@@ -637,12 +655,22 @@
   }
 
   // Handle the scheduling ID
-  if ( incidence->schedulingID() == incidence->uid() )
+  if ( incidence->schedulingID() == incidence->uid() ) {
     // There is no scheduling ID
-    setSchedulingID( QString::null );
-  else
-    setSchedulingID( incidence->schedulingID() );
+    setInternalUID( QString::null );
+  } else {
+    // We've internally been using a different uid, so save that as the
+    // temporary (internal) uid and restore the original uid, the one that
+    // is used in the folder and the outside world
+    setUid( incidence->schedulingID() );
+    setInternalUID( incidence->uid() );
+  }
 
+  if ( incidence->pilotId() != 0 )
+    setPilotSyncId( incidence->pilotId() );
+
+  setPilotSyncStatus( incidence->syncStatus() );
+
   // Unhandled tags and other custom properties (see libkcal/customproperties.h)
   const QMap<QCString, QString> map = incidence->customProperties();
   QMap<QCString, QString>::ConstIterator cit = map.begin();
@@ -700,10 +728,13 @@
   for ( it = mAttendees.begin(); it != mAttendees.end(); ++it ) {
     KCal::Attendee::PartStat status = attendeeStringToStatus( (*it).status );
     KCal::Attendee::Role role = attendeeStringToRole( (*it).role );
-    incidence->addAttendee( new KCal::Attendee( (*it).displayName,
-                                                (*it).smtpAddress,
-                                                (*it).requestResponse,
-                                                status, role ) );
+    KCal::Attendee* attendee = new KCal::Attendee( (*it).displayName,
+                                                   (*it).smtpAddress,
+                                                   (*it).requestResponse,
+                                                    status, role );
+    attendee->setDelegate( (*it).delegate );
+    attendee->setDelegator( (*it).delegator );
+    incidence->addAttendee( attendee );
   }
 
   incidence->clearAttachments();
@@ -757,16 +788,52 @@
     } // "none" is default since tje set*ly methods set infinite recurrence
 
     incidence->recurrence()->setExDates( mRecurrence.exclusions );
+
   }
+  /* If we've stored a uid to be used internally instead of the real one
+   * (to deal with duplicates of events in different folders) before, then
+   * restore it, so it does not change. Keep the original uid around for
+   * scheduling purposes. */
+  if ( !internalUID().isEmpty() ) {
+    incidence->setUid( internalUID() );
+    incidence->setSchedulingID( uid() );
+  }
+  if ( hasPilotSyncId() )
+    incidence->setPilotId( pilotSyncId() );
+  if ( hasPilotSyncStatus() )
+    incidence->setSyncStatus( pilotSyncStatus() );
 
-  incidence->setSchedulingID( schedulingID() );
-
   for( QValueList<Custom>::ConstIterator it = mCustomList.begin(); it != mCustomList.end(); ++it ) {
     incidence->setNonKDECustomProperty( (*it).key, (*it).value );
   }
 
 }
 
+void Incidence::loadAttachments()
+{
+  QStringList attachments;
+  if ( mResource->kmailListAttachments( attachments, mSubResource, mSernum ) ) {
+    for ( QStringList::ConstIterator it = attachments.constBegin(); it != attachments.constEnd(); ++it ) {
+      QByteArray data;
+      KURL url;
+      if ( mResource->kmailGetAttachment( url, mSubResource, mSernum, *it ) && !url.isEmpty() ) {
+        QFile f( url.path() );
+        if ( f.open( IO_ReadOnly ) ) {
+          data = f.readAll();
+          QString mimeType;
+          if ( !mResource->kmailAttachmentMimetype( mimeType, mSubResource, mSernum, *it ) )
+            mimeType = "application/octet-stream";
+          KCal::Attachment *a = new KCal::Attachment( KCodecs::base64Encode( data ).data(), mimeType );
+          a->setLabel( *it );
+          mAttachments.append( a );
+          f.close();
+        }
+        f.remove();
+      }
+    }
+  }
+}
+
 QString Incidence::productID() const
 {
   return QString( "KOrganizer " ) + korgVersion + ", Kolab resource";
@@ -775,3 +842,4 @@
 // Unhandled KCal::Incidence fields:
 // revision, status (unused), priority (done in tasks), attendee.uid,
 // mComments, mReadOnly
+
Index: kresources/kolab/kcal/task.cpp
===================================================================
--- kresources/kolab/kcal/task.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/task.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,9 +39,10 @@
 using namespace Kolab;
 
 
-KCal::Todo* Task::xmlToTask( const QString& xml, const QString& tz )
+KCal::Todo* Task::xmlToTask( const QString& xml, const QString& tz, KCal::ResourceKolab *res,
+                             const QString& subResource, Q_UINT32 sernum )
 {
-  Task task( tz );
+  Task task( res, subResource, sernum, tz );
   task.load( xml );
   KCal::Todo* todo = new KCal::Todo();
   task.saveTo( todo );
@@ -50,12 +51,14 @@
 
 QString Task::taskToXML( KCal::Todo* todo, const QString& tz )
 {
-  Task task( tz, todo );
+  Task task( 0, QString::null, 0, tz, todo );
   return task.saveXML();
 }
 
-Task::Task( const QString& tz, KCal::Todo* task )
-  : Incidence( tz ), mPriority( 5 ), mPercentCompleted( 0 ),
+Task::Task( KCal::ResourceKolab *res, const QString &subResource, Q_UINT32 sernum,
+            const QString& tz, KCal::Todo* task )
+  : Incidence( res, subResource, sernum, tz ),
+    mPriority( 5 ), mPercentCompleted( 0 ),
     mStatus( KCal::Incidence::StatusNone ),
     mHasStartDate( false ), mHasDueDate( false ),
     mHasCompletedDate( false )
@@ -265,7 +268,7 @@
       kdDebug() << "Node is not a comment or an element???" << endl;
   }
 
-
+  loadAttachments();
   return true;
 }
 
Index: kresources/kolab/kcal/resourcekolab.h
===================================================================
--- kresources/kolab/kcal/resourcekolab.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/resourcekolab.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -121,6 +121,8 @@
   /** Return the list of subresources. */
   QStringList subresources() const;
 
+  bool canHaveSubresources() const { return true; }
+
   /** Is this subresource active? */
   bool subresourceActive( const QString& ) const;
   /** (De)activate the subresource */
@@ -131,14 +133,19 @@
 
   virtual QString subresourceIdentifier( Incidence *incidence );
 
+  virtual bool addSubresource( const QString& resource, const QString& parent );
+  virtual bool removeSubresource( const QString& resource );
+
+  virtual QString subresourceType( const QString &resource );
+
   KABC::Lock* lock();
 
 signals:
   void useGlobalMode();
 protected slots:
-   void slotEmitResourceChanged();
+  void slotEmitResourceChanged();
 protected:
-  /** 
+  /**
    * Return list of alarms which are relevant for the current user. These
    * are the ones coming from folders which the user has "Administer" rights
    * for, as per ACL */
@@ -169,6 +176,7 @@
 
   /// Reimplemented from IncidenceBase::Observer to know when an incidence was changed
   void incidenceUpdated( KCal::IncidenceBase* );
+  void incidenceUpdatedSilent( KCal::IncidenceBase* incidencebase);
 
   bool openResource( KConfig& config, const char* contentType,
                      Kolab::ResourceMap& map );
@@ -176,6 +184,7 @@
                               const QString& label, bool writable,
                               bool alarmRelevant, Kolab::ResourceMap& subResource );
   bool loadSubResource( const QString& subResource, const char* mimetype );
+  bool unloadSubResource( const QString& subResource );
 
   QString configFile() const {
     return ResourceKolabBase::configFile( "kcal" );
Index: kresources/kolab/kcal/event.h
===================================================================
--- kresources/kolab/kcal/event.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/event.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,13 +53,15 @@
 public:
   /// Use this to parse an xml string to a event entry
   /// The caller is responsible for deleting the returned event
-  static KCal::Event* xmlToEvent( const QString& xml, const QString& tz );
+  static KCal::Event* xmlToEvent( const QString& xml, const QString& tz, KCal::ResourceKolab* res = 0,
+                                  const QString& subResource = QString::null, Q_UINT32 sernum = 0 );
 
   /// Use this to get an xml string describing this event entry
   static QString eventToXML( KCal::Event*, const QString& tz );
 
   /// Create a event object and
-  explicit Event( const QString& tz, KCal::Event* event = 0 );
+  explicit Event( KCal::ResourceKolab *res, const QString &subResource, Q_UINT32 sernum,
+                  const QString& tz, KCal::Event* event = 0 );
   virtual ~Event();
 
   void saveTo( KCal::Event* event );
Index: kresources/kolab/kcal/incidence.h
===================================================================
--- kresources/kolab/kcal/incidence.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/incidence.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -42,6 +42,7 @@
   class Incidence;
   class Recurrence;
   class Attachment;
+  class ResourceKolab;
 }
 
 namespace Kolab {
@@ -71,12 +72,12 @@
     bool requestResponse;
     bool invitationSent;
     QString role;
+    QString delegate;
+    QString delegator;
   };
 
-protected:
-  explicit Incidence( const QString& tz );
-
-public:
+  explicit Incidence( KCal::ResourceKolab *res, const QString &subResource, Q_UINT32 sernum,
+                      const QString& tz );
   virtual ~Incidence();
 
   void saveTo( KCal::Incidence* incidence );
@@ -105,8 +106,14 @@
   QValueList<Attendee>& attendees();
   const QValueList<Attendee>& attendees() const;
 
-  virtual void setSchedulingID( const QString& sid );
-  virtual QString schedulingID() const;
+  /**
+   * The internal uid is used as the uid inside KOrganizer whenever
+   * two or more events with the same uid appear, which KOrganizer
+   * can't handle. To avoid keep that interal uid from changing all the
+   * time, it is persisted in the XML between a save and the next load.
+   */
+  void setInternalUID( const QString& iuid );
+  QString internalUID() const;
 
   virtual void setRevision( int );
   virtual int revision() const;
@@ -134,6 +141,8 @@
   void saveCustomAttributes( QDomElement& element ) const;
   void loadCustomAttributes( QDomElement& element );
 
+  void loadAttachments();
+
   QString productID() const;
 
   QString mSummary;
@@ -146,7 +155,7 @@
   Recurrence mRecurrence;
   QValueList<Attendee> mAttendees;
   QValueList<KCal::Attachment*> mAttachments;
-  QString mSchedulingID;
+  QString mInternalUID;
   int mRevision;
 
   struct Custom {
@@ -154,6 +163,10 @@
     QString value;
   };
   QValueList<Custom> mCustomList;
+
+  KCal::ResourceKolab *mResource;
+  QString mSubResource;
+  Q_UINT32 mSernum;
 };
 
 }
Index: kresources/kolab/kcal/task.h
===================================================================
--- kresources/kolab/kcal/task.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/kolab/kcal/task.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -42,6 +42,7 @@
 
 namespace KCal {
   class Todo;
+  class ResourceKolab;
 }
 
 namespace Kolab {
@@ -56,12 +57,14 @@
 public:
   /// Use this to parse an xml string to a task entry
   /// The caller is responsible for deleting the returned task
-  static KCal::Todo* xmlToTask( const QString& xml, const QString& tz );
+  static KCal::Todo* xmlToTask( const QString& xml, const QString& tz, KCal::ResourceKolab *res = 0,
+                                const QString& subResource = QString::null, Q_UINT32 sernum = 0 );
 
   /// Use this to get an xml string describing this task entry
   static QString taskToXML( KCal::Todo*, const QString& tz );
 
-  explicit Task( const QString& tz, KCal::Todo* todo = 0 );
+  explicit Task( KCal::ResourceKolab *res, const QString& subResource, Q_UINT32 sernum,
+                 const QString& tz, KCal::Todo* todo = 0 );
   virtual ~Task();
 
   virtual QString type() const { return "Task"; }
Index: kresources/birthdays/kabc.desktop
===================================================================
--- kresources/birthdays/kabc.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/birthdays/kabc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Name[da]=F√∏dselsdage fra KAddressBook
 Name[de]=Geburtstage aus dem Adressbuch
 Name[el]=ŒìŒµŒΩŒ≠Œ∏ŒªŒπŒ± Œ±œÄœå œÑŒø KAddressBook
+Name[eo]=Naskiƒùdatoj de KAdresaro
 Name[es]=Cumplea√±os desde KAddressBook
 Name[et]=S√ºnnip√§evad KDE aadressiraamatust
 Name[eu]=Urtebetetzeak KAddressBook-etik
Index: kresources/featureplan/kcal_resourcefeatureplan.desktop
===================================================================
--- kresources/featureplan/kcal_resourcefeatureplan.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/featureplan/kcal_resourcefeatureplan.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -6,6 +6,7 @@
 Name[cs]=XML pl√°n vlastnost√≠
 Name[da]=XML Funktionsplan
 Name[el]=Œ£œáŒ≠Œ¥ŒπŒø œáŒ±œÅŒ±Œ∫œÑŒ∑œÅŒπœÉœÑŒπŒ∫œéŒΩ XML
+Name[eo]=XML-Trajtplano
 Name[es]=Plan de caracter√≠sticas XML
 Name[et]=XML v√µimaluste plaan
 Name[eu]=XML eginbide plana
Index: kresources/Makefile.am
===================================================================
--- kresources/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kresources/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,5 +2,5 @@
 EXCHANGE_SUBDIR=exchange 
 endif
 
-SUBDIRS = lib remote egroupware $(EXCHANGE_SUBDIR) kolab slox groupwise featureplan groupdav birthdays newexchange
+SUBDIRS = lib remote egroupware $(EXCHANGE_SUBDIR) kolab slox groupwise featureplan groupdav birthdays newexchange scalix
 # SUBDIRS = remote egroupware $(EXCHANGE_SUBDIR) kolab slox groupwise featureplan 
Index: certmanager/lib/cryptplugwrapper.h
===================================================================
--- certmanager/lib/cryptplugwrapper.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/cryptplugwrapper.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -805,7 +805,7 @@
 
     Kleo::ImportJob * importJob() const;
     Kleo::ExportJob * publicKeyExportJob( bool armor=false ) const;
-    Kleo::ExportJob * secretKeyExportJob( bool armor=false ) const;
+    Kleo::ExportJob * secretKeyExportJob( bool armor=false, const QString& charset = QString::null ) const;
     Kleo::DownloadJob * downloadJob( bool armor=false ) const;
     Kleo::DeleteJob * deleteJob() const;
 
Index: certmanager/lib/tests/test.data.gpg
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: certmanager/lib/tests/test.data.gpg
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: certmanager/lib/tests/test_verify.cpp
===================================================================
--- certmanager/lib/tests/test_verify.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ certmanager/lib/tests/test_verify.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,99 @@
+/*
+    This file is part of Kleopatra's test suite.
+    Copyright (c) 2007 Klar√§lvdalens Datakonsult AB
+
+    Kleopatra is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    Kleopatra is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#include <config.h>
+
+#include <kleo/cryptobackendfactory.h>
+#include <kleo/verifydetachedjob.h>
+#include <kleo/verifyopaquejob.h>
+
+#include <gpgmepp/verificationresult.h>
+#include <gpgmepp/key.h>
+
+#include <kaboutdata.h>
+#include <kapplication.h>
+#include <kcmdlineargs.h>
+
+#include <qdir.h>
+#include <qfile.h>
+
+#include <assert.h>
+
+int main( int argc, char **argv )
+{
+  setenv("GNUPGHOME", KDESRCDIR "/gnupg_home", 1 );
+  setenv("LC_ALL", "C", 1);
+  setenv("KDEHOME", QFile::encodeName( QDir::homeDirPath() + "/.kde-unit-test" ), 1);
+
+  KAboutData aboutData( "test_verify", "verify job test", "0.1" );
+  KCmdLineArgs::init( argc, argv, &aboutData );
+  KApplication app( false, false );
+
+  const QString sigFileName = KDESRCDIR "/test.data.sig";
+  const QString dataFileName = KDESRCDIR "/test.data";
+
+  QFile sigFile( sigFileName );
+  assert( sigFile.open( IO_ReadOnly ) );
+  QFile dataFile( dataFileName );
+  assert( dataFile.open( IO_ReadOnly ) );
+
+  const Kleo::CryptoBackend::Protocol * const backend = Kleo::CryptoBackendFactory::instance()->protocol( "openpgp" );
+
+  Kleo::VerifyDetachedJob *job = backend->verifyDetachedJob();
+  GpgME::VerificationResult result = job->exec( sigFile.readAll(), dataFile.readAll() );
+  assert( !result.error() );
+  assert( result.signatures().size() == 1 );
+
+  GpgME::Signature sig = result.signature( 0 );
+  assert( (sig.summary() & GpgME::Signature::KeyMissing) == 0 );
+  assert( sig.creationTime() == 1189650248L );
+  assert( sig.validity() == GpgME::Signature::Full );
+
+  const QString opaqueFileName = KDESRCDIR "/test.data.gpg";
+  QFile opaqueFile( opaqueFileName );
+  assert( opaqueFile.open( IO_ReadOnly ) );
+  QByteArray clearText;
+
+  Kleo::VerifyOpaqueJob *job2 = backend->verifyOpaqueJob();
+  result = job2->exec( opaqueFile.readAll(), clearText );
+  assert( !result.error() );
+  assert( result.signatures().size() == 1 );
+
+  sig = result.signature( 0 );
+  assert( (sig.summary() & GpgME::Signature::KeyMissing) == 0 );
+  assert( (sig.summary() & GpgME::Signature::Green ) );
+  assert( sig.creationTime() > 0 );
+  assert( sig.validity() == GpgME::Signature::Full );
+
+  dataFile.reset();
+  assert( clearText == dataFile.readAll() );
+
+  return 0;
+}
Index: certmanager/lib/tests/test.data
===================================================================
--- certmanager/lib/tests/test.data	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ certmanager/lib/tests/test.data	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,295 @@
+/* -*- mode: c++; c-basic-offset:4 -*-
+    tests/test_uiserver.cpp
+
+    This file is part of Kleopatra, the KDE keymanager
+    Copyright (c) 2007 Klar√§lvdalens Datakonsult AB
+
+    Kleopatra is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    Kleopatra is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+//
+// Usage: test_uiserver <socket> --verify-detached <signed data> <signature>
+//
+#ifndef _ASSUAN_ONLY_GPG_ERRORS
+#define _ASSUAN_ONLY_GPG_ERRORS
+#endif
+#include "../uiserver/kleo-assuan.h"
+#include <gpg-error.h>
+
+#include <QtCore>
+
+#include <unistd.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+#include <errno.h>
+#include <assert.h>
+
+#include <iostream>
+#include <map>
+#include <string>
+#include <vector>
+
+using namespace Kleo;
+
+static std::vector<int> inFDs, outFDs, msgFDs;
+static std::vector<std::string> inFiles, outFiles, msgFiles;
+static std::map<std::string,std::string> inquireData;
+
+static std::string hexencode( const std::string & in ) {
+    std::string result;
+    result.reserve( 3 * in.size() );
+
+    static const char hex[] = "0123456789ABCDEF";
+
+    for ( std::string::const_iterator it = in.begin(), end = in.end() ; it != end ; ++it )
+        switch ( const unsigned char ch = *it ) {
+        default:
+            if ( ch >= '!' && ch <= '~' || ch > 0xA0 ) {
+                result += ch;
+                break;
+            }
+            // else fall through
+        case ' ':
+            result += '+';
+            break;
+        case '"':
+        case '#':
+        case '$':
+        case '%':
+        case '\'':
+        case '+':
+        case '=':
+            result += '%';
+            result += hex[ (ch & 0xF0) >> 4 ];
+            result += hex[ (ch & 0x0F)      ];
+            break;
+        }
+    
+    return result;
+}
+
+static void usage( const std::string & msg=std::string() ) {
+    std::cerr << msg << std::endl <<
+        "\n"
+        "Usage: test_uiserver <socket> [<io>] [<options>] [<inquire>] command [<args>]\n"
+        "where:\n"
+        "      <io>: [--input[-fd] <file>] [--output[-fd] <file>] [--message[-fd] <file>]\n"
+        " <options>: *[--option name=value]\n"
+        " <inquire>: [--inquire keyword=<file>]\n";
+    exit( 1 );
+}
+
+static int data( void * void_ctx, const void * buffer, size_t len ) {
+    (void)void_ctx; (void)buffer; (void)len;
+    return 0; // ### implement me
+}
+
+static int status( void * void_ctx, const char * line ) {
+    (void)void_ctx; (void)line;
+    return 0;
+}
+
+static int inquire( void * void_ctx, const char * keyword ) {
+    assuan_context_t ctx = (assuan_context_t)void_ctx;
+    assert( ctx );
+    const std::map<std::string,std::string>::const_iterator it = inquireData.find( keyword );
+    if ( it == inquireData.end() )
+        return gpg_error( GPG_ERR_UNKNOWN_COMMAND );
+
+    if ( !it->second.empty() && it->second[0] == '@' )
+        return gpg_error( GPG_ERR_NOT_IMPLEMENTED );
+
+    if ( const gpg_error_t err = assuan_send_data( ctx, it->second.c_str(), it->second.size() ) ) {
+        qDebug( "assuan_write_data: %s", gpg_strerror( err ) );
+        return err;
+    }
+
+    return 0;
+}
+
+int main( int argc, char * argv[] ) {
+
+    assuan_set_assuan_err_source( GPG_ERR_SOURCE_DEFAULT );
+
+    if ( argc < 3 )
+        usage(); // need socket and command, at least
+
+    const char * socket = argv[1];
+
+    std::vector<const char*> options;
+
+    std::string command;
+    for ( int optind = 2 ; optind < argc ; ++optind ) {
+        const char * const arg = argv[optind];
+        if ( qstrcmp( arg, "--input-fd" ) == 0 ) {
+            int inFD;
+            if ( (inFD = open( argv[++optind], O_RDONLY )) == -1 ) {
+                perror( "--input-fd open()" );
+                return 1;
+            }
+            inFDs.push_back( inFD );
+        } else if ( qstrcmp( arg, "--output-fd" ) == 0 ) {
+            int outFD;
+            if ( (outFD = open( argv[++optind], O_WRONLY|O_CREAT )) ==  -1 ) {
+                perror( "--output-fd open()" );
+                return 1;
+            }
+            outFDs.push_back( outFD );
+        } else if ( qstrcmp( arg, "--message-fd" ) == 0 ) {
+            int msgFD;
+            if ( (msgFD = open( argv[++optind], O_RDONLY )) ==  -1 ) {
+                perror( "--message-fd open()" );
+                return 1;
+            }
+            msgFDs.push_back( msgFD );
+        } else if ( qstrcmp( arg, "--input" ) == 0 ) {
+            const std::string file = argv[++optind];
+            inFiles.push_back( file );
+        } else if ( qstrcmp( arg, "--output" ) == 0 ) {
+            const std::string file = argv[++optind];
+            outFiles.push_back( file );
+        } else if ( qstrcmp( arg, "--message" ) == 0 ) {
+            const std::string file = argv[++optind];
+            msgFiles.push_back( file );
+        } else if ( qstrcmp( arg, "--option" ) == 0 ) {
+            options.push_back( argv[++optind] );
+        } else if ( qstrcmp( arg, "--inquire" ) == 0 ) {
+            const std::string inqval = argv[++optind];
+            const size_t pos = inqval.find( '=' );
+            // ### implement indirection with "@file"...
+            inquireData[inqval.substr( 0, pos )] = inqval.substr( pos+1 );
+        } else {
+            while ( optind < argc ) {
+                if ( !command.empty() )
+                    command += ' ';
+                command += argv[optind++];
+            }
+        }
+    }
+    if ( command.empty() )
+        usage( "Command expected, but only options found" );
+
+    assuan_context_t ctx = 0;
+
+    if ( const gpg_error_t err = assuan_socket_connect_ext( &ctx, socket, -1, 1 ) ) {
+        qDebug( "%s", assuan_exception( err, "assuan_socket_connect_ext" ).what() );
+        return 1;
+    }
+
+    assuan_set_log_stream( ctx, stderr );
+
+    for ( std::vector<int>::const_iterator it = inFDs.begin(), end = inFDs.end() ; it != end ; ++it ) {
+        if ( const gpg_error_t err = assuan_sendfd( ctx, *it ) ) {
+            qDebug( "%s", assuan_exception( err, "assuan_sendfd( inFD )" ).what() );
+            return 1;
+        }
+
+        if ( const gpg_error_t err = assuan_transact( ctx, "INPUT FD", 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, "INPUT FD" ).what() );
+            return 1;
+        }
+    }
+
+    
+    for ( std::vector<std::string>::const_iterator it = inFiles.begin(), end = inFiles.end() ; it != end ; ++it ) {
+        char buffer[1024];
+        sprintf( buffer, "INPUT FILE=%s", hexencode( *it ).c_str() );
+
+        if ( const gpg_error_t err = assuan_transact( ctx, buffer, 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, buffer ).what() );
+            return 1;
+        }
+    }
+
+    
+    for ( std::vector<int>::const_iterator it = msgFDs.begin(), end = msgFDs.end() ; it != end ; ++it ) {
+        if ( const gpg_error_t err = assuan_sendfd( ctx, *it ) ) {
+            qDebug( "%s", assuan_exception( err, "assuan_sendfd( msgFD )" ).what() );
+            return 1;
+        }
+
+        if ( const gpg_error_t err = assuan_transact( ctx, "MESSAGE FD", 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, "MESSAGE FD" ).what() );
+            return 1;
+        }
+    }
+
+    
+    for ( std::vector<std::string>::const_iterator it = msgFiles.begin(), end = msgFiles.end() ; it != end ; ++it ) {
+        char buffer[1024];
+        sprintf( buffer, "MESSAGE FILE=%s", hexencode( *it ).c_str() );
+
+        if ( const gpg_error_t err = assuan_transact( ctx, buffer, 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, buffer ).what() );
+            return 1;
+        }
+    }
+
+    
+    for ( std::vector<int>::const_iterator it = outFDs.begin(), end = outFDs.end() ; it != end ; ++it ) {
+        if ( const gpg_error_t err = assuan_sendfd( ctx, *it ) ) {
+            qDebug( "%s", assuan_exception( err, "assuan_sendfd( outFD )" ).what() );
+            return 1;
+        }
+
+        if ( const gpg_error_t err = assuan_transact( ctx, "OUTPUT FD", 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, "OUTPUT FD" ).what() );
+            return 1;
+        }
+    }
+
+
+    for ( std::vector<std::string>::const_iterator it = outFiles.begin(), end = outFiles.end() ; it != end ; ++it ) {
+        char buffer[1024];
+        sprintf( buffer, "OUTPUT FILE=%s", hexencode( *it ).c_str() );
+
+        if ( const gpg_error_t err = assuan_transact( ctx, buffer, 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, buffer ).what() );
+            return 1;
+        }
+    }
+
+    
+    
+    Q_FOREACH( const char * opt, options ) {
+        std::string line = "OPTION ";
+        line += opt;
+        if ( const gpg_error_t err = assuan_transact( ctx, line.c_str(), 0, 0, 0, 0, 0, 0 ) ) {
+            qDebug( "%s", assuan_exception( err, line ).what() );
+            return 1;
+        }
+    }
+
+    if ( const gpg_error_t err = assuan_transact( ctx, command.c_str(), data, ctx, inquire, ctx, status, ctx ) ) {
+        qDebug( "%s", assuan_exception( err, command ).what() );
+        return 1;
+    }
+
+    assuan_disconnect( ctx );
+    
+    return 0;
+}
Index: certmanager/lib/tests/gnupg_home/pubring.gpg
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: certmanager/lib/tests/gnupg_home/pubring.gpg
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: certmanager/lib/tests/gnupg_home/trustdb.gpg
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: certmanager/lib/tests/gnupg_home/trustdb.gpg
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: certmanager/lib/tests/gnupg_home/secring.gpg
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: certmanager/lib/tests/gnupg_home/secring.gpg
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: certmanager/lib/tests/test.data.sig
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: certmanager/lib/tests/test.data.sig
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: certmanager/lib/tests/Makefile.am
===================================================================
--- certmanager/lib/tests/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/tests/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,9 +1,10 @@
-INCLUDES = -I$(top_srcdir)/certmanager/lib \
+AM_CPPFLAGS = -I$(top_srcdir)/certmanager/lib \
 	-I$(top_srcdir)/libkdenetwork \
-	$(GPGME_CFLAGS) $(all_includes)
+	$(GPGME_CFLAGS) $(all_includes) -DKDESRCDIR=\"$(srcdir)\"
 
 check_PROGRAMS = test_keylister test_keygen test_keyselectiondialog \
-		test_cryptoconfig test_gnupgprocessbase test_jobs
+		test_cryptoconfig test_gnupgprocessbase test_jobs test_verify
+TESTS = test_verify
 
 test_keylister_SOURCES = test_keylister.cpp
 test_keygen_SOURCES = test_keygen.cpp
@@ -11,6 +12,7 @@
 test_cryptoconfig_SOURCES = test_cryptoconfig.cpp
 test_gnupgprocessbase_SOURCES = test_gnupgprocessbase.cpp
 test_jobs_SOURCES = test_jobs.cpp
+test_verify_SOURCES = test_verify.cpp
 
 LDADD = ../libkleopatra.la
 
Index: certmanager/lib/backends/qgpgme/qgpgmedecryptjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmedecryptjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmedecryptjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -80,6 +80,7 @@
   setup( cipherText );
   const GpgME::DecryptionResult result = mCtx->decrypt( *mInData, *mOutData );
   plainText = mOutDataDataProvider->data();
+  getAuditLog();
   return result;
 }
 
Index: certmanager/lib/backends/qgpgme/qgpgmejob.h
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmejob.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmejob.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,6 +39,7 @@
 #include <gpgmepp/key.h>
 
 #include <qcstring.h>
+#include <qstring.h>
 
 #include <vector>
 #include <kdepimmacros.h>
@@ -107,6 +108,8 @@
     GpgME::Error setSigningKeys( const std::vector<GpgME::Key> & signers );
     /*! Call this to implement a slotOperationDoneEvent() */
     void doSlotOperationDoneEvent( GpgME::Context * context, const GpgME::Error & e );
+    /*! Call this to extract the audit log from mCtx */
+    void getAuditLog();
 
     //
     // only boring stuff below this line...
@@ -116,6 +119,7 @@
     virtual void doEmitProgressSignal( const QString & what, int current, int total ) = 0;
     virtual void doEmitDoneSignal() = 0;
     void doSlotCancel();
+    QString auditLogAsHtml() const { return mAuditLogAsHtml; }
 
   private:
     /*! \reimp from GpgME::ProgressProvider */
@@ -142,6 +146,7 @@
     unsigned int mNumPatterns;
     unsigned int mChunkSize;
     unsigned int mPatternStartIndex, mPatternEndIndex;
+    QString mAuditLogAsHtml;
   };
 
 }
@@ -149,6 +154,7 @@
 #define make_slot_cancel private: void slotCancel() { QGpgMEJob::doSlotCancel(); }
 #define make_progress_emitter private: void doEmitProgressSignal( const QString & what, int cur, int tot ) { emit progress( what, cur, tot ); }
 #define make_done_emitter private: void doEmitDoneSignal() { emit done(); }
-#define QGPGME_JOB make_slot_cancel make_progress_emitter make_done_emitter
+#define make_auditLogAsHtml private: QString auditLogAsHtml() const { return QGpgMEJob::auditLogAsHtml(); }
+#define QGPGME_JOB make_slot_cancel make_progress_emitter make_done_emitter make_auditLogAsHtml
 
 #endif // __KLEO_QGPGMEJOB_H__
Index: certmanager/lib/backends/qgpgme/qgpgmeverifydetachedjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmeverifydetachedjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmeverifydetachedjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -83,7 +83,9 @@
 GpgME::VerificationResult Kleo::QGpgMEVerifyDetachedJob::exec( const QByteArray & signature,
 							       const QByteArray & signedData ) {
   setup( signature, signedData );
-  return mCtx->verifyDetachedSignature( *mInData, *mOutData );
+  const GpgME::VerificationResult r = mCtx->verifyDetachedSignature( *mInData, *mOutData );
+  getAuditLog();
+  return r;
 }
 
 void Kleo::QGpgMEVerifyDetachedJob::doOperationDoneEvent( const GpgME::Error & ) {
Index: certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.h
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -57,7 +57,7 @@
   class QGpgMESecretKeyExportJob : public ExportJob {
     Q_OBJECT
   public:
-    QGpgMESecretKeyExportJob( bool armour );
+    QGpgMESecretKeyExportJob( bool armour, const QString& charset );
     ~QGpgMESecretKeyExportJob();
 
     /*! \reimp from ExportJob */
@@ -77,6 +77,7 @@
     QByteArray mKeyData;
     int mError;
     bool mArmour;
+    QString mCharset;
   };
 
 }
Index: certmanager/lib/backends/qgpgme/qgpgmesignencryptjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmesignencryptjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmesignencryptjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,8 +36,7 @@
 
 #include "qgpgmesignencryptjob.h"
 
-#include <klocale.h>
-#include <kmessagebox.h>
+#include "ui/messagebox.h"
 
 #include <qgpgme/eventloopinteractor.h>
 #include <qgpgme/dataprovider.h>
@@ -46,6 +45,8 @@
 #include <gpgmepp/data.h>
 #include <gpgmepp/key.h>
 
+#include <klocale.h>
+
 #include <assert.h>
 
 Kleo::QGpgMESignEncryptJob::QGpgMESignEncryptJob( GpgME::Context * context )
@@ -85,6 +86,8 @@
 						  
   if ( err )
     deleteLater();
+  mResult.first = GpgME::SigningResult( err );
+  mResult.second = GpgME::EncryptionResult( err );
   return err;
 }
 
@@ -97,27 +100,22 @@
     return std::make_pair( GpgME::SigningResult( 0, err ), GpgME::EncryptionResult() );
   const GpgME::Context::EncryptionFlags flags =
     alwaysTrust ? GpgME::Context::AlwaysTrust : GpgME::Context::None ;
-  const std::pair<GpgME::SigningResult,GpgME::EncryptionResult> result =
-    mCtx->signAndEncrypt( recipients, *mInData, *mOutData, flags );
+  mResult = mCtx->signAndEncrypt( recipients, *mInData, *mOutData, flags );
   cipherText = mOutDataDataProvider->data();
-  return result;
+  getAuditLog();
+  return mResult;
 }
 
 void Kleo::QGpgMESignEncryptJob::doOperationDoneEvent( const GpgME::Error & ) {
-  emit result( mCtx->signingResult(),
-	       mCtx->encryptionResult(),
-	       mOutDataDataProvider->data() );
+  mResult.first = mCtx->signingResult();
+  mResult.second = mCtx->encryptionResult();
+  emit result( mResult.first, mResult.second, mOutDataDataProvider->data() );
 }
 
 void Kleo::QGpgMESignEncryptJob::showErrorDialog( QWidget * parent, const QString & caption ) const {
-  if ( !mResult.first.error() && !mResult.second.error() )
-    return;
-  if ( mResult.first.error().isCanceled() || mResult.second.error().isCanceled() )
-    return;
-  const QString msg = mResult.first.error()
-    ? i18n("Signing failed: %1" ).arg( QString::fromLocal8Bit( mResult.first.error().asString() ) )
-    : i18n("Encryption failed: %1").arg( QString::fromLocal8Bit( mResult.second.error().asString() ) ) ;
-  KMessageBox::error( parent, msg, caption );
+    if ( mResult.first.error()  && !mResult.first.error().isCanceled() ||
+         mResult.second.error() && !mResult.second.error().isCanceled() )
+        Kleo::MessageBox::error( parent, mResult.first, mResult.second, this, caption );
 }
 
 #include "qgpgmesignencryptjob.moc"
Index: certmanager/lib/backends/qgpgme/qgpgmejob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmejob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -234,14 +234,33 @@
   assert( !mOutData->isNull() );
 }
 
+static const unsigned int GetAuditLogFlags = GpgME::Context::AuditLogWithHelp|GpgME::Context::HtmlAuditLog;
+
+static QString audit_log_as_html( GpgME::Context * ctx ) {
+    if ( !ctx )
+        return QString();
+    QGpgME::QByteArrayDataProvider dp;
+    GpgME::Data data( &dp );
+    assert( !data.isNull() );
+    if ( const GpgME::Error err = ctx->getAuditLog( data, GetAuditLogFlags ) )
+        return QString();
+    else
+        return QString::fromUtf8( dp.data().data() );
+}
+
 void Kleo::QGpgMEJob::doSlotOperationDoneEvent( GpgME::Context * context, const GpgME::Error & e ) {
   if ( context == mCtx ) {
+    getAuditLog();
     doEmitDoneSignal();
     doOperationDoneEvent( e );
     mThis->deleteLater();
   }
 }
 
+void Kleo::QGpgMEJob::getAuditLog() {
+    mAuditLogAsHtml = audit_log_as_html( mCtx );
+}
+
 void Kleo::QGpgMEJob::doSlotCancel() {
   mCtx->cancelPendingOperation();
 }
Index: certmanager/lib/backends/qgpgme/qgpgmeverifyopaquejob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmeverifyopaquejob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmeverifyopaquejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -79,6 +79,7 @@
   setup( signedData );
   const GpgME::VerificationResult res = mCtx->verifyOpaqueSignature( *mInData, *mOutData );
   plainText = mOutDataDataProvider->data();
+  getAuditLog();
   return res;
 }
 
Index: certmanager/lib/backends/qgpgme/qgpgmeencryptjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmeencryptjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmeencryptjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,8 +36,7 @@
 
 #include "qgpgmeencryptjob.h"
 
-#include <klocale.h>
-#include <kmessagebox.h>
+#include "ui/messagebox.h"
 
 #include <qgpgme/eventloopinteractor.h>
 #include <qgpgme/dataprovider.h>
@@ -46,6 +45,8 @@
 #include <gpgmepp/encryptionresult.h>
 #include <gpgmepp/data.h>
 
+#include <klocale.h>
+
 #include <assert.h>
 
 Kleo::QGpgMEEncryptJob::QGpgMEEncryptJob( GpgME::Context * context )
@@ -78,6 +79,7 @@
 						  
   if ( err )
     deleteLater();
+  mResult = GpgME::EncryptionResult( err );
   return err;
 }
 
@@ -90,19 +92,17 @@
     alwaysTrust ? GpgME::Context::AlwaysTrust : GpgME::Context::None;
   mResult = mCtx->encrypt( recipients, *mInData, *mOutData, flags );
   ciphertext = mOutDataDataProvider->data();
+  getAuditLog();
   return mResult;
 }
 
 void Kleo::QGpgMEEncryptJob::doOperationDoneEvent( const GpgME::Error & ) {
-  emit result( mResult, mOutDataDataProvider->data() );
+  emit result( mResult = mCtx->encryptionResult(), mOutDataDataProvider->data() );
 }
 
 void Kleo::QGpgMEEncryptJob::showErrorDialog( QWidget * parent, const QString & caption ) const {
-  if ( !mResult.error() || mResult.error().isCanceled() )
-    return;
-  const QString msg = i18n("Encryption failed: %1")
-    .arg( QString::fromLocal8Bit( mResult.error().asString() ) );
-  KMessageBox::error( parent, msg, caption );
+  if ( mResult.error() && !mResult.error().isCanceled() )
+      Kleo::MessageBox::error( parent, mResult, this, caption );
 }
 
 #include "qgpgmeencryptjob.moc"
Index: certmanager/lib/backends/qgpgme/qgpgmedecryptverifyjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmedecryptverifyjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmedecryptverifyjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -82,6 +82,7 @@
   const std::pair<GpgME::DecryptionResult,GpgME::VerificationResult> result =
     mCtx->decryptAndVerify( *mInData, *mOutData );
   plainText = mOutDataDataProvider->data();
+  getAuditLog();
   return result;
 }
 
Index: certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmesecretkeyexportjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,11 +53,12 @@
 #include <string.h>
 #include <assert.h>
 
-Kleo::QGpgMESecretKeyExportJob::QGpgMESecretKeyExportJob( bool armour )
+Kleo::QGpgMESecretKeyExportJob::QGpgMESecretKeyExportJob( bool armour, const QString& charset )
   : ExportJob( QGpgME::EventLoopInteractor::instance(), "Kleo::QGpgMESecretKeyExportJob" ),
     mProcess( 0 ),
     mError( 0 ),
-    mArmour( armour )
+    mArmour( armour ),
+    mCharset( charset )
 {
 
 }
@@ -77,10 +78,12 @@
   // create and start gpgsm process:
   mProcess = new GnuPGProcessBase( this, "gpgsm --export-secret-key-p12" );
 
-  // FIXME: obbtain the path to gpgsm from gpgme, so we use the same instance.
+  // FIXME: obtain the path to gpgsm from gpgme, so we use the same instance.
   *mProcess << "gpgsm" << "--export-secret-key-p12";
   if ( mArmour )
     *mProcess << "--armor";
+  if ( !mCharset.isEmpty() )
+    *mProcess << "--p12-charset" << mCharset;
   *mProcess << patterns.front().utf8();
 
   mProcess->setUseStatusFD( true );
Index: certmanager/lib/backends/qgpgme/qgpgmesignjob.cpp
===================================================================
--- certmanager/lib/backends/qgpgme/qgpgmesignjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/qgpgme/qgpgmesignjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,6 +36,8 @@
 
 #include "qgpgmesignjob.h"
 
+#include "ui/messagebox.h"
+
 #include <qgpgme/eventloopinteractor.h>
 #include <qgpgme/dataprovider.h>
 
@@ -44,7 +46,6 @@
 #include <gpgmepp/data.h>
 #include <gpgmepp/key.h>
 
-#include <kmessagebox.h>
 #include <klocale.h>
 
 #include <assert.h>
@@ -84,6 +85,7 @@
 						  
   if ( err )
     deleteLater();
+  mResult = GpgME::SigningResult( err );
   return err;
 }
 
@@ -95,19 +97,17 @@
     return mResult = GpgME::SigningResult( 0, err );
   mResult = mCtx->sign( *mInData, *mOutData, mode );
   signature = mOutDataDataProvider->data();
+  getAuditLog();
   return mResult;
 }
 
 void Kleo::QGpgMESignJob::doOperationDoneEvent( const GpgME::Error & ) {
-  emit result( mResult, mOutDataDataProvider->data() );
+  emit result( mResult = mCtx->signingResult(), mOutDataDataProvider->data() );
 }
 
 void Kleo::QGpgMESignJob::showErrorDialog( QWidget * parent, const QString & caption ) const {
-  if ( !mResult.error() || mResult.error().isCanceled() )
-    return;
-  const QString msg = i18n("Signing failed: %1")
-    .arg( QString::fromLocal8Bit( mResult.error().asString() ) );
-  KMessageBox::error( parent, msg, caption );
+  if ( mResult.error() && !mResult.error().isCanceled() )
+      Kleo::MessageBox::error( parent, mResult, this, caption );
 }
 
 #include "qgpgmesignjob.moc"
Index: certmanager/lib/backends/chiasmus/chiasmusbackend.cpp
===================================================================
--- certmanager/lib/backends/chiasmus/chiasmusbackend.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/backends/chiasmus/chiasmusbackend.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -370,7 +370,7 @@
   KeyGenerationJob * keyGenerationJob() const { return 0; }
   ImportJob * importJob() const { return 0; }
   ExportJob * publicKeyExportJob( bool ) const { return 0; }
-  ExportJob * secretKeyExportJob( bool ) const { return 0; }
+  ExportJob * secretKeyExportJob( bool, const QString& ) const { return 0; }
   DownloadJob * downloadJob( bool ) const { return 0; }
   DeleteJob * deleteJob() const { return 0; }
   SignEncryptJob * signEncryptJob( bool, bool ) const { return 0; }
Index: certmanager/lib/kleo/job.cpp
===================================================================
--- certmanager/lib/kleo/job.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/kleo/job.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -70,8 +70,11 @@
   kdDebug() << "Kleo::Job::showErrorDialog() should be reimplemented in Kleo::Job subclasses!" << endl;
 }
 
+QString Kleo::Job::auditLogAsHtml() const {
+    kdDebug() << "Kleo::Job::auditLogAsHtml() should be reimplemented in Kleo::Job subclasses!" << endl;
+    return QString();
+}
 
-
 #define make_job_subclass(x) \
   Kleo::x::x( QObject * parent, const char * name ) : Job( parent, name ) {} \
   Kleo::x::~x() {}
Index: certmanager/lib/kleo/cryptobackend.h
===================================================================
--- certmanager/lib/kleo/cryptobackend.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/kleo/cryptobackend.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -33,6 +33,8 @@
 #ifndef __KLEO_CRYPTOBACKEND_H__
 #define __KLEO_CRYPTOBACKEND_H__
 
+#include <qstring.h>
+
 namespace Kleo {
   class CryptoConfig;
   class KeyListJob;
@@ -104,7 +106,8 @@
     virtual KeyGenerationJob  * keyGenerationJob() const = 0;
     virtual ImportJob         * importJob() const = 0;
     virtual ExportJob         * publicKeyExportJob( bool armor=false ) const = 0;
-    virtual ExportJob         * secretKeyExportJob( bool armor=false ) const = 0;
+    // @param charset the encoding of the passphrase in the exported file
+    virtual ExportJob         * secretKeyExportJob( bool armor=false, const QString& charset = QString::null ) const = 0;
     virtual DownloadJob       * downloadJob( bool armor=false ) const = 0;
     virtual DeleteJob         * deleteJob() const = 0;
     virtual SignEncryptJob    * signEncryptJob( bool armor=false, bool textMode=false ) const = 0;
Index: certmanager/lib/kleo/job.h
===================================================================
--- certmanager/lib/kleo/job.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/kleo/job.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -66,6 +66,8 @@
 
     virtual void showErrorDialog( QWidget * parent=0, const QString & caption=QString::null ) const;
 
+    virtual QString auditLogAsHtml() const;
+
   public slots:
     virtual void slotCancel() = 0;
 
Index: certmanager/lib/cryptplugwrapper.cpp
===================================================================
--- certmanager/lib/cryptplugwrapper.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/cryptplugwrapper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -780,12 +780,12 @@
   return new Kleo::QGpgMEExportJob( context );
 }
 
-Kleo::ExportJob * CryptPlugWrapper::secretKeyExportJob( bool armor ) const {
+Kleo::ExportJob * CryptPlugWrapper::secretKeyExportJob( bool armor, const QString& charset ) const {
   if ( !_cp || _cp->mProtocol != GpgME::Context::CMS ) // fixme: add support for gpg, too
     return 0;
 
   // this operation is not supported by gpgme, so we have to call gpgsm ourselves:
-  return new Kleo::QGpgMESecretKeyExportJob( armor );
+  return new Kleo::QGpgMESecretKeyExportJob( armor, charset );
 }
 
 Kleo::RefreshKeysJob * CryptPlugWrapper::refreshKeysJob() const {
Index: certmanager/lib/ui/keyselectiondialog.cpp
===================================================================
--- certmanager/lib/ui/keyselectiondialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/ui/keyselectiondialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -336,15 +336,15 @@
   mStartSearchTimer = new QTimer( this );
 
   QFrame *page = makeMainWidget();
-  QVBoxLayout *topLayout = new QVBoxLayout( page, 0, spacingHint() );
+  mTopLayout = new QVBoxLayout( page, 0, spacingHint() );
 
   if ( !text.isEmpty() ) {
     QLabel* textLabel = new QLabel( text, page );
     textLabel->setAlignment( textLabel->alignment() | Qt::WordBreak );
-    topLayout->addWidget( textLabel );
+    mTopLayout->addWidget( textLabel );
   }
 
-  QHBoxLayout * hlay = new QHBoxLayout( topLayout ); // inherits spacing
+  QHBoxLayout * hlay = new QHBoxLayout( mTopLayout ); // inherits spacing
   QLineEdit * le = new QLineEdit( page );
   le->setText( initialQuery );
   QToolButton *clearButton = new QToolButton( page );
@@ -368,11 +368,11 @@
   mKeyListView->setShowToolTips( true );
   if ( extendedSelection )
     mKeyListView->setSelectionMode( QListView::Extended );
-  topLayout->addWidget( mKeyListView, 10 );
+  mTopLayout->addWidget( mKeyListView, 10 );
 
   if ( rememberChoice ) {
     mRememberCB = new QCheckBox( i18n("&Remember choice"), page );
-    topLayout->addWidget( mRememberCB );
+    mTopLayout->addWidget( mRememberCB );
     QWhatsThis::add( mRememberCB,
 		     i18n("<qt><p>If you check this box your choice will "
 			  "be stored and you will not be asked again."
@@ -395,7 +395,7 @@
            this, SLOT(slotRereadKeys()) );
 
   slotRereadKeys();
-  topLayout->activate();
+  mTopLayout->activate();
 
   if ( kapp ) {
     KWin::setIcons( winId(), kapp->icon(), kapp->miniIcon() );
Index: certmanager/lib/ui/messagebox.h
===================================================================
--- certmanager/lib/ui/messagebox.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ certmanager/lib/ui/messagebox.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,83 @@
+/*
+    messagebox.h
+
+    This file is part of libkleopatra, the KDE keymanagement library
+    Copyright (c) 2007 Klar‰lvdalens Datakonsult AB
+
+    Libkleopatra is free software; you can redistribute it and/or
+    modify it under the terms of the GNU General Public License as
+    published by the Free Software Foundation; either version 2 of the
+    License, or (at your option) any later version.
+
+    Libkleopatra is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifndef __KLEO_UI_MESSAGEBOX_H__
+#define __KLEO_UI_MESSAGEBOX_H__
+
+#include <kmessagebox.h>
+
+namespace GpgME {
+    class SigningResult;
+    class EncryptionResult;
+    class DecryptionResult;
+    class VerificationResult;
+}
+
+namespace Kleo {
+    class Job;
+}
+
+class QWidget;
+class QString;
+
+namespace Kleo {
+
+    class MessageBox {
+    public:
+        static void information( QWidget * parent, const GpgME::SigningResult & result, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void information( QWidget * parent, const GpgME::SigningResult & result, const Kleo::Job * job, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::SigningResult & result, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::SigningResult & result, const Kleo::Job * job, int options=KMessageBox::Notify );
+
+        static void information( QWidget * parent, const GpgME::EncryptionResult & result, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void information( QWidget * parent, const GpgME::EncryptionResult & result, const Kleo::Job * job, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::EncryptionResult & result, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::EncryptionResult & result, const Kleo::Job * job, int options=KMessageBox::Notify );
+
+        static void information( QWidget * parent, const GpgME::SigningResult & sresult, const GpgME::EncryptionResult & eresult, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void information( QWidget * parent, const GpgME::SigningResult & sresult, const GpgME::EncryptionResult & eresult, const Kleo::Job * job, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::SigningResult & sresult, const GpgME::EncryptionResult & eresult, const Kleo::Job * job, const QString & caption, int options=KMessageBox::Notify );
+        static void error( QWidget * parent, const GpgME::SigningResult & sresult, const GpgME::EncryptionResult & eresult, const Kleo::Job * job, int options=KMessageBox::Notify );
+
+        static void auditLog( QWidget * parent, const Kleo::Job * job, const QString & caption );
+        static void auditLog( QWidget * parent, const Kleo::Job * job );
+        static void auditLog( QWidget * parent, const QString & log, const QString & caption );
+        static void auditLog( QWidget * parent, const QString & log );
+
+    private:
+        static void make( QWidget * parent, QMessageBox::Icon icon, const QString & text, const Kleo::Job * job, const QString & caption, int options );
+    };
+
+
+}
+
+#endif /* __KLEO_UI_MESSAGEBOX_H__ */
Index: certmanager/lib/ui/keyselectiondialog.h
===================================================================
--- certmanager/lib/ui/keyselectiondialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/ui/keyselectiondialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -44,6 +44,7 @@
 #include <kdepimmacros.h>
 #include <vector>
 
+class QVBoxLayout;
 class QCheckBox;
 class QPixmap;
 class QTimer;
@@ -78,6 +79,7 @@
       OpenPGPKeys = 256,
       SMIMEKeys = 512,
       AllKeys = PublicKeys | SecretKeys | OpenPGPKeys | SMIMEKeys,
+      ValidEncryptionKeys = AllKeys | EncryptionKeys | ValidKeys,
       ValidTrustedEncryptionKeys = AllKeys | EncryptionKeys | ValidKeys | TrustedKeys
     };
 
@@ -118,6 +120,9 @@
 
     bool rememberSelection() const;
 
+    // Could be used by derived classes to insert their own widget
+    QVBoxLayout* topLayout() const { return mTopLayout; }
+
   private slots:
     void slotRereadKeys();
     void slotKeyListResult( const GpgME::KeyListResult & );
@@ -149,6 +154,7 @@
     void init( bool, bool, const QString &, const QString & );
 
   private:
+    QVBoxLayout* mTopLayout;
     Kleo::KeyListView * mKeyListView;
     const Kleo::CryptoBackend::Protocol * mOpenPGPBackend;
     const Kleo::CryptoBackend::Protocol * mSMIMEBackend;
Index: certmanager/lib/ui/Makefile.am
===================================================================
--- certmanager/lib/ui/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/lib/ui/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 
 libkleopatra_ui_la_SOURCES = \
         kdhorizontalline.cpp \
+	messagebox.cpp \
 	progressbar.cpp \
 	progressdialog.cpp \
 	keylistview.cpp \
@@ -27,6 +28,7 @@
 kleodir = $(includedir)/kleo
 kleo_HEADERS = \
         kdhorizontalline.h \
+	messagebox.h \
 	progressbar.h \
 	progressdialog.h \
 	keylistview.h \
Index: certmanager/lib/ui/messagebox.cpp
===================================================================
--- certmanager/lib/ui/messagebox.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ certmanager/lib/ui/messagebox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,265 @@
+/*
+    messagebox.cpp
+
+    This file is part of libkleopatra, the KDE keymanagement library
+    Copyright (c) 2004 Klar‰lvdalens Datakonsult AB
+
+    Libkleopatra is free software; you can redistribute it and/or
+    modify it under the terms of the GNU General Public License as
+    published by the Free Software Foundation; either version 2 of the
+    License, or (at your option) any later version.
+
+    Libkleopatra is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+
+    In addition, as a special exception, the copyright holders give
+    permission to link the code of this program with any edition of
+    the Qt library by Trolltech AS, Norway (or with modified versions
+    of Qt that use the same license as Qt), and distribute linked
+    combinations including the two.  You must obey the GNU General
+    Public License in all respects for all of the code used other than
+    Qt.  If you modify this file, you may extend this exception to
+    your version of the file, but you are not obligated to do so.  If
+    you do not wish to do so, delete this exception statement from
+    your version.
+*/
+
+#ifdef HAVE_CONFIG_H
+#include <config.h>
+#endif
+
+#include "messagebox.h"
+
+#include "kleo/job.h"
+
+#include <gpgmepp/signingresult.h>
+#include <gpgmepp/encryptionresult.h>
+
+#include <kfiledialog.h>
+#include <kdialogbase.h>
+#include <klocale.h>
+#include <ksavefile.h>
+#include <kguiitem.h>
+
+#include <qtextedit.h>
+#include <qtextstream.h>
+#include <qvbox.h>
+
+using namespace Kleo;
+using namespace GpgME;
+
+namespace {
+
+static KGuiItem KGuiItem_save() {
+    return KGuiItem( i18n("&Save to Disk..."), "filesaveas" );
+}
+
+static KGuiItem KGuiItem_copy() {
+    return KGuiItem( i18n("&Copy to Clipboard"), "editcopy", i18n("Copy Audit Log to Clipboard") );
+}
+
+static KGuiItem KGuiItem_showAuditLog() {
+    return KGuiItem( i18n("&Show Audit Log") ); // "view_log"?
+}
+
+class AuditLogViewer : public KDialogBase {
+    // Q_OBJECT
+public:
+    explicit AuditLogViewer( const QString & log, QWidget * parent=0, const char * name=0, WFlags f=0 )
+        : KDialogBase( parent, name, false, i18n("View GnuPG Audit Log"),
+                       Close|User1|User2, Close, false, KGuiItem_save(), KGuiItem_copy() ),
+          m_textEdit( new QTextEdit( this, "m_textEdit" ) )
+    {
+        setWFlags( f );
+        setMainWidget( m_textEdit );
+        m_textEdit->setTextFormat( QTextEdit::RichText );
+        m_textEdit->setReadOnly( true );
+        setAuditLog( log );
+    }
+    ~AuditLogViewer() {}
+
+    void setAuditLog( const QString & log ) {
+        m_textEdit->setText( log );
+    }
+
+private:
+    void slotUser1() {
+        const QString fileName = KFileDialog::getSaveFileName( QString(), QString(),
+                                                               this, i18n("Choose File to Save GnuPG Audit Log to") );
+        if ( fileName.isEmpty() )
+            return;
+
+        KSaveFile file( fileName );
+
+        if ( QTextStream * const s = file.textStream() ) {
+            *s << m_textEdit->text() << endl;
+            file.close();
+        }
+
+        if ( const int err = file.status() )
+            KMessageBox::error( this, i18n("Couldn't save to file \"%1\": %2")
+                                .arg( file.name(), QString::fromLocal8Bit( strerror( err ) ) ),
+                                i18n("File Save Error") );
+    }
+    void slotUser2() {
+        m_textEdit->selectAll();
+        m_textEdit->copy();
+        m_textEdit->selectAll( false );
+    }
+
+private:
+    QTextEdit * m_textEdit;
+};
+
+} // anon namespace
+
+// static
+void MessageBox::auditLog( QWidget * parent, const Job * job, const QString & caption ) {
+
+    if ( !job )
+        return;
+
+    if ( !GpgME::hasFeature( AuditLogFeature ) ) {
+        KMessageBox::information( parent, i18n("Your system does not have support for GnuPG Audit Logs"),
+                                  i18n("System Error") );
+        return;
+    }
+
+    const QString log = job->auditLogAsHtml();
+    if ( log.isEmpty() ) {
+        KMessageBox::information( parent, i18n("No GnuPG Audit Log available for this operation."),
+                                  i18n("No GnuPG Audit Log") );
+        return;
+    }
+
+    auditLog( parent, log, caption );
+}
+
+// static
+void MessageBox::auditLog( QWidget * parent, const QString & log, const QString & caption ) {
+    AuditLogViewer * const alv = new AuditLogViewer( "<qt>" + log + "</qt>", parent, "alv", Qt::WDestructiveClose );
+    alv->setCaption( caption );
+    alv->show();
+}
+
+// static
+void MessageBox::auditLog( QWidget * parent, const Job * job ) {
+    auditLog( parent, job, i18n("GnuPG Audit Log Viewer") );
+}
+
+// static
+void MessageBox::auditLog( QWidget * parent, const QString & log ) {
+    auditLog( parent, log, i18n("GnuPG Audit Log Viewer") );
+}
+
+static QString to_information_string( const SigningResult & result ) {
+    return result.error()
+        ? i18n("Signing failed: %1").arg( QString::fromLocal8Bit( result.error().asString() ) )
+        : i18n("Signing successful") ;
+}
+
+static QString to_error_string( const SigningResult & result ) {
+    return to_information_string( result );
+}
+
+static QString to_information_string( const EncryptionResult & result ) {
+    return result.error()
+        ? i18n("Encryption failed: %1").arg( QString::fromLocal8Bit( result.error().asString() ) )
+        : i18n("Encryption successful") ;
+}
+
+static QString to_error_string( const EncryptionResult & result ) {
+    return to_information_string( result );
+}
+
+static QString to_information_string( const SigningResult & sresult, const EncryptionResult & eresult ) {
+    return to_information_string( sresult ) + '\n' + to_information_string( eresult );
+}
+
+static QString to_error_string( const SigningResult & sresult, const EncryptionResult & eresult ) {
+    return to_information_string( sresult, eresult );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const SigningResult & result, const Job * job, int options ) {
+    information( parent, result, job, i18n("Signing Result"), options );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const SigningResult & result, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Information, to_information_string( result ), job, caption, options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const SigningResult & result, const Job * job, int options ) {
+    error( parent, result, job, i18n("Signing Error"), options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const SigningResult & result, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Critical, to_error_string( result ), job, caption, options );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const EncryptionResult & result, const Job * job, int options ) {
+    information( parent, result, job, i18n("Encryption Result"), options );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const EncryptionResult & result, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Information, to_information_string( result ), job, caption, options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const EncryptionResult & result, const Job * job, int options ) {
+    error( parent, result, job, i18n("Encryption Error"), options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const EncryptionResult & result, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Critical, to_error_string( result ), job, caption, options );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const SigningResult & sresult, const EncryptionResult & eresult, const Job * job, int options ) {
+    information( parent, sresult, eresult, job, i18n("Encryption Result"), options );
+}
+
+// static
+void MessageBox::information( QWidget * parent, const SigningResult & sresult, const EncryptionResult & eresult, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Information, to_information_string( sresult, eresult ), job, caption, options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const SigningResult & sresult, const EncryptionResult & eresult, const Job * job, int options ) {
+    error( parent, sresult, eresult, job, i18n("Encryption Error"), options );
+}
+
+// static
+void MessageBox::error( QWidget * parent, const SigningResult & sresult, const EncryptionResult & eresult, const Job * job, const QString & caption, int options ) {
+    make( parent, QMessageBox::Critical, to_error_string( sresult, eresult ), job, caption, options );
+}
+
+// static
+void MessageBox::make( QWidget * parent, QMessageBox::Icon icon, const QString & text, const Job * job, const QString & caption, int options ) {
+    KDialogBase * dialog = GpgME::hasFeature( GpgME::AuditLogFeature )
+        ? new KDialogBase( caption, KDialogBase::Yes | KDialogBase::No,
+                           KDialogBase::Yes, KDialogBase::Yes,
+                           parent, "error", true, true,
+                           KStdGuiItem::ok(), KGuiItem_showAuditLog() )
+        : new KDialogBase( caption, KDialogBase::Yes,
+                           KDialogBase::Yes, KDialogBase::Yes,
+                           parent, "error", true, true,
+                           KStdGuiItem::ok() ) ;
+    if ( options & KMessageBox::PlainCaption )
+        dialog->setPlainCaption( caption );
+
+    if ( KDialogBase::No == KMessageBox::createKMessageBox( dialog, icon, text, QStringList(), QString::null, 0, options ) )
+        auditLog( 0, job );
+}
Index: certmanager/certmanager.cpp
===================================================================
--- certmanager/certmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ certmanager/certmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -97,6 +97,7 @@
 #include <algorithm>
 #include <assert.h>
 #include <kdepimmacros.h>
+#include <kinputdialog.h>
 namespace {
 
   class KDE_EXPORT DisplayStrategy : public Kleo::KeyListView::DisplayStrategy{
@@ -426,7 +427,7 @@
     act->setEnabled( hier );
   if ( KAction * act = action("view_collapseall" ) )
     act->setEnabled( hier );
-  if ( KToggleAction * act = 
+  if ( KToggleAction * act =
       static_cast<KToggleAction*>( action("view_hierarchical") ) )
     act->setChecked( hier );
 
@@ -1306,7 +1307,50 @@
     return;
 
   // PENDING(marc): let user choose between binary and PEM format?
-  Kleo::ExportJob * job = Kleo::CryptoBackendFactory::instance()->smime()->secretKeyExportJob( false );
+
+  // Check if gpgsm supports --p12-charset
+  Kleo::CryptoConfig* config = Kleo::CryptoBackendFactory::instance()->config();
+  QString charset;
+  if ( config && config->entry( "gpgsm", "Configuration", "p12-charset" ) ) {
+    // This comes from gnupg's sources, agent/minip12.c
+    // In fact, any charset supported by iconv would work, but we don't link to iconv directly...
+    static const char *charsets[] = {
+      "utf8",
+      "iso-8859-1",
+      "iso-8859-15",
+      "iso-8859-2",
+      "iso-8859-3",
+      "iso-8859-4",
+      "iso-8859-5",
+      "iso-8859-6",
+      "iso-8859-7",
+      "iso-8859-8",
+      "iso-8859-9",
+      "koi8-r",
+      "ibm437",
+      "ibm850",
+      "euc-jp",
+      "big5",
+      NULL
+    };
+    QStringList charsetList;
+    for ( const char** c = charsets; *c; ++c ) {
+      charsetList.append( QString::fromLatin1( *c ) );
+    }
+
+    // TODO this selection could be done in a derived KeySelectionDialog which would add a combobox,
+    // it would be better integrated.
+    bool ok;
+    charset = KInputDialog::getItem( i18n("Exporting secret key..."),
+                                     i18n("Choose a charset for encoding the pkcs#12 passphrase (utf8 is recommended)"),
+                                     charsetList,
+                                     0, false /*editable*/,
+                                     &ok, this );
+    if ( !ok )
+      return;
+  }
+
+  Kleo::ExportJob * job = Kleo::CryptoBackendFactory::instance()->smime()->secretKeyExportJob( false, charset );
   assert( job );
 
   connect( job, SIGNAL(result(const GpgME::Error&,const QByteArray&)),
Index: karm/taskview.cpp
===================================================================
--- karm/taskview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/taskview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -389,12 +389,15 @@
     if (task != 0 && activeTasks.findRef(task) == -1) 
     {
       _idleTimeDetector->startIdleDetection();
-      task->setRunning(true, _storage, startTime);
-      activeTasks.append(task);
-      emit updateButtons();
-      if ( activeTasks.count() == 1 )
-        emit timersActive();
-      emit tasksChanged( activeTasks);
+      if (!task->isComplete())
+      {
+        task->setRunning(true, _storage, startTime);
+        activeTasks.append(task);
+        emit updateButtons();
+        if ( activeTasks.count() == 1 )
+          emit timersActive();
+        emit tasksChanged( activeTasks);
+      }
     }
   }
   else KMessageBox::error(0,i18n("Saving is impossible, so timing is useless. \nSaving problems may result from a full harddisk, a directory name instead of a file name, or stale locks. Check that your harddisk has enough space, that your calendar file exists and is a file and remove stale locks, typically from ~/.kde/share/apps/kabc/lock."));
Index: karm/task.cpp
===================================================================
--- karm/task.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/task.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -97,11 +97,11 @@
 void Task::setRunning( bool on, KarmStorage* storage, QDateTime whenStarted, QDateTime whenStopped  )
 // Sets a task running or stopped. If the task is to be stopped, whenStarted is not evaluated.
 // on=true if the task shall be started on=false if the task shall be stopped
+// This is the back-end, the front-end is StartTimerFor()
 {
   kdDebug(5970) << "Entering Task::setRunning " << "on=" << on << "whenStarted=" << whenStarted << " whenStopped=" << whenStopped << endl;
   if ( on ) 
   {
-    if (isComplete()) return; // don't start if its marked complete
     if (!_timer->isActive()) 
     {
       _timer->start(1000);
Index: karm/test/webdav.sh
===================================================================
--- karm/test/webdav.sh	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/test/webdav.sh	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -6,6 +6,13 @@
 
 source __lib.sh
 
+# check for required perl stuff
+perl -e "use Net::DAV::Server;" > /dev/null 2>&1
+if ! [ $? = 0 ]; then
+	echo "PASS"
+	exit 0
+fi
+
 # Start webdav server
 perl __webdav.pl &
 sleep 2
Index: karm/test/lifetest.php
===================================================================
--- karm/test/lifetest.php	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/test/lifetest.php	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -110,6 +110,10 @@
 }
 else
 {
+  if ( system( "which xte 2> /dev/null" ) == "" ) {
+    echo "xte not found\n";
+    exit(0);
+  }
   switch (funkeysim("Alt_L")) 
   {
     case 1: 
Index: karm/test/locking.cpp
===================================================================
--- karm/test/locking.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/test/locking.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -140,7 +140,7 @@
 
   KCmdLineArgs::init(argc,argv,"testresourcelocking", 0, 0, 0, 0);
 
-  KApplication app;
+  KApplication app( false, false );
 
   // basic libkcal locking stuff
   if ( !rval ) rval = test1();
Index: karm/test/Makefile.am
===================================================================
--- karm/test/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/test/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,4 +14,5 @@
 
 INCLUDES = -I$(srcdir) -I$(top_srcdir) -I$(top_srcdir)/libkcal $(all_includes)
 
-TESTS = runscripts locking
+#TESTS = runscripts locking
+TESTS = locking
Index: karm/support/karm.desktop
===================================================================
--- karm/support/karm.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ karm/support/karm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,6 @@
 Encoding=UTF-8
 Name=KArm
 Name[af]=Karm
-Name[eo]=Tempomezurilo
 Name[hi]=‡§ï‡•á-‡§Ü‡§∞‡•ç‡§Æ
 Name[sv]=Karm
 Name[ta]=K‡ÆÖ‡ÆÆ‡Øç
Index: kdgantt/KDGanttViewItem.cpp
===================================================================
--- kdgantt/KDGanttViewItem.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttViewItem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 Klar‰lvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -290,7 +290,7 @@
     if( !_name.isEmpty() )
         // We had a name, remove it
         sItemDict.remove( _name );
-    
+
     QString newName;
     if ( name.isEmpty() || sItemDict.find( name ) ) {
         // create unique name
@@ -1421,6 +1421,8 @@
 
 void KDGanttViewItem::initColorAndShapes(Type t)
 {
+    _isMoveable = false;
+    _isResizeable = false;
     setTextOffset(QPoint(0,0));
   //_isCalendar = false;
     _callListViewOnSetOpen = true;
@@ -2483,7 +2485,7 @@
     int my = y + myTextOffset.y();
     if (myTextOffset.x() != 0)
         mx -= 2*myItemSize; // keep old behaviour
-        
+
     textCanvas->move(mx+2*myItemSize,my-myItemSize/2);
     //qDebug("%s: moveTextCanvas(%d,%d) offset: %d,%d moved to  %d,%d",listViewText(0).latin1(),x,y,myTextOffset.x(),myTextOffset.y(),mx+2*myItemSize,my-myItemSize/2);
 }
@@ -2492,7 +2494,7 @@
   Moves this items text relative to the middle right end of the item
   Used to move text away from link.
 */
-void KDGanttViewItem::moveTextCanvas() 
+void KDGanttViewItem::moveTextCanvas()
 {
     QPoint m = myTextOffset+middleRight();
     textCanvas->move(m.x(), m.y()-myItemSize/2);
@@ -2501,7 +2503,7 @@
 /*!
   Sets with how much the item text is offset.
 */
-void KDGanttViewItem::setTextOffset(QPoint p) 
+void KDGanttViewItem::setTextOffset(QPoint p)
 {
     //qDebug("%s: setTextOffset() offset: %d,%d",listViewText(0).latin1(),p.x(),p.y());
     myTextOffset.setX(p.x());
@@ -2536,7 +2538,7 @@
 {
     myFloatStartTime = start;
 }
-    
+
 /*!
   Specifies the float end time of this item.
   If the time is invalid, the end float is not shown.
@@ -2547,3 +2549,23 @@
 {
     myFloatEndTime = end;
 }
+
+void KDGanttViewItem::setMoveable(bool m)
+{
+  _isMoveable = m;
+}
+
+bool KDGanttViewItem::isMoveable() const
+{
+  return _isMoveable;
+}
+
+bool KDGanttViewItem::isResizeable() const
+{
+  return _isResizeable;
+}
+
+void KDGanttViewItem::setResizeable(bool r)
+{
+  _isResizeable = r;
+}
Index: kdgantt/KDGanttViewItem.h
===================================================================
--- kdgantt/KDGanttViewItem.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttViewItem.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 Klar‰lvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -185,6 +185,12 @@
     static KDGanttViewItem* createFromDomElement( KDGanttViewItem* parent,
                                                   KDGanttViewItem* previous,
                                                   QDomElement& element );
+
+    void setMoveable( bool m );
+    bool isMoveable() const;
+    void setResizeable( bool r );
+    bool isResizeable() const;
+
 private:
     friend class KDGanttView;
     friend class KDTimeTableWidget;
@@ -239,6 +245,9 @@
     bool shapeDefined;
     int _priority;
     static QDict<KDGanttViewItem> sItemDict;
+
+    bool _isMoveable;
+    bool _isResizeable;
 };
 
 
Index: kdgantt/KDGanttView.cpp
===================================================================
--- kdgantt/KDGanttView.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttView.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -83,7 +83,8 @@
 KDGanttView::KDGanttView( QWidget* parent, const char* name  )
     : KDGanttMinimizeSplitter( Qt::Vertical, parent, name ),
       myCanvasView(0),
-      myTimeHeaderScroll(0)
+      myTimeHeaderScroll(0),
+      mFixedHorizon( false )
 {
 #if defined KDAB_EVAL
     EvalDialog::checkEvalLicense( "KD Gantt" );
@@ -323,7 +324,7 @@
   myTimeTable->setBlockUpdating( false );
   myTimeTable->updateMyContent();
   /* The below causes recursive calls to various size updating methods, which
-   * cause QCanvas to hide and show items like mad, which is very slow. If 
+   * cause QCanvas to hide and show items like mad, which is very slow. If
    * there is a legitimate gui updating issue here somewhere, it will need
    * to be solved differently.
    */
@@ -484,6 +485,12 @@
 }
 
 
+void KDGanttView::emptySpaceDoubleClicked( QMouseEvent * e )
+{
+    emit dateTimeDoubleClicked( getDateTimeForCoordX( e->x(), false ) );
+}
+
+
 /*
   Implements a casted pass-through of the currentChanged() signal.
 */
@@ -967,7 +974,7 @@
       //HACK: Only draw list headers if we draw timeline, else
       // there is no room for it. This will most probably be changed
       // with qt4 anyway, so I think we can live with it atm.
-      myListView->drawToPainter( p, drawTimeLine ); 
+      myListView->drawToPainter( p, drawTimeLine );
       p->translate( lvX, -temp);
     }
     if ( drawTimeLine ) {
@@ -1808,7 +1815,7 @@
   \param show true in order to show ticks, false in order to hide them.
          If show is true, setShowMinorTicks( false ) is performed automatically
          to hide the grid of the minor ticks.
-         In order to show now grid, call setShowMinorTicks( false ) and 
+         In order to show now grid, call setShowMinorTicks( false ) and
          setShowMajorTicks( false ).
   \sa showMajorTicks(), setShowMinorTicks(), showMinorTicks()
 */
@@ -1836,7 +1843,7 @@
   \param show true in order to show ticks, false in order to hide them.
          If show is true, setShowMajorTicks( false ) is performed automatically
          to hide the grid of the major ticks.
-         In order to show now grid, call setShowMinorTicks( false ) and 
+         In order to show now grid, call setShowMinorTicks( false ) and
          setShowMajorTicks( false ).
 
   \sa showMinorTicks(), setShowMajorTicks(), showMajorTicks()
@@ -1884,7 +1891,7 @@
   myTimeHeader->setColumnBackgroundColor( column, color,mini,maxi );
 }
 
-
+#if 0
 /*!
   Sets the background color for a time interval given by \a start and
   \a end.  \a start may be later than \a end.  If there is already a
@@ -1961,7 +1968,17 @@
 {
   return myTimeHeader->deleteBackgroundInterval( start, end );
 }
+#endif
 
+/*!
+  Adds a filled rectangle for a time interval given by \a start and
+  \a end, across all tasks.  \a start may be later than \a end.
+  \sa KDIntervalColorRectangle
+*/
+void KDGanttView::addIntervalBackgroundColor( KDIntervalColorRectangle* newItem )
+{
+  myTimeHeader->addIntervalBackgroundColor( newItem );
+}
 
 /*!
   Removes all background color settings set with setColumnBackgroundColor()
@@ -4027,7 +4044,7 @@
 
 void KDGanttView::addTickRight()
 {
-  if ( _enableAdding && myCanvasView->horizontalScrollBar()->value() ==  myCanvasView->horizontalScrollBar()->maxValue()) {
+  if ( !mFixedHorizon && _enableAdding && myCanvasView->horizontalScrollBar()->value() ==  myCanvasView->horizontalScrollBar()->maxValue()) {
     //myCanvasView->horizontalScrollBar()->blockSignals( true );
     myTimeHeader->addTickRight();
     //myCanvasView->horizontalScrollBar()->blockSignals( false );
@@ -4039,7 +4056,7 @@
 
 void KDGanttView::addTickLeft()
 {
-  if ( _enableAdding && myCanvasView->horizontalScrollBar()->value() == 0 ) {
+  if ( !mFixedHorizon && _enableAdding && myCanvasView->horizontalScrollBar()->value() == 0 ) {
     myCanvasView->horizontalScrollBar()->blockSignals( true );
     myTimeHeader->addTickLeft();
     myCanvasView->horizontalScrollBar()->blockSignals( false );
@@ -4619,7 +4636,7 @@
 void KDGanttView::setLinkItemsEnabled(bool on)
 {
     myCanvasView->linkItemsEnabled = on;
-    myCanvasView->autoScrollEnabled = true;    
+    myCanvasView->autoScrollEnabled = true;
 }
 
 /*!
@@ -4627,7 +4644,7 @@
 
   Returns if the linking functionallity is enabled or disabled.
 */
-bool KDGanttView::isLinkItemsEnabled() const 
+bool KDGanttView::isLinkItemsEnabled() const
 {
     return myCanvasView->linkItemsEnabled;
 }
Index: kdgantt/KDGanttViewSubwidgets.cpp
===================================================================
--- kdgantt/KDGanttViewSubwidgets.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttViewSubwidgets.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 KlarÔøΩvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -89,7 +89,7 @@
     while (it.current()) {
         delete it.current();
     }
-        
+
 }
 
 void KDTimeTableWidget::resetWidth( int wid )
@@ -856,8 +856,8 @@
          ( myMinimumWidth > mySizeHint &&
            myMinimumWidth < (width() - myGridMinorWidth  )) )
         computeTicks();
-    
-    // Update (horizontal) scrollbar, 
+
+    // Update (horizontal) scrollbar,
     // We probably come from an external resize and then we must
     // calculate on basis of myCanvasView.
     // (NOTE: we have disconnected the auto QScrollView scrollbar update)
@@ -1485,32 +1485,19 @@
 
 void KDTimeHeaderWidget::computeIntervals( int height )
 {
-
-    IntervalColorList::iterator it;
-    int left, right;
+    IntervalColorList::const_iterator it;
     for ( it = icList.begin(); it != icList.end(); ++it ) {
-        if ( (*it).minScaleView <= myRealScale && (*it).maxScaleView >= myRealScale ) {
-            left = getCoordX((*it).datetime);
-            right = getCoordX((*it).end);
-            if ( right == left )
-                ++right;
-            (*it).canvasRect->setPen( QPen::NoPen );
-            (*it).canvasRect->setBrush( QBrush( (*it).color, SolidPattern) );
-            (*it).canvasRect->setSize( right - left ,height );
-            (*it).canvasRect->move( left,0 );
-            (*it).canvasRect->show();
-        } else {
-            (*it).canvasRect->hide();
-            /*
-              (*it).canvasLine->setPen( QPen( (*it).color, right - left ) );
-              (*it).canvasLine->setPoints( mid ,0 ,mid ,height );
-              (*it).canvasLine->show();
-              } else {
-              (*it).canvasLine->hide();
-            */
-        }
+      (*it)->layout( this, height );
     }
 }
+
+void KDTimeHeaderWidget::addIntervalBackgroundColor( KDIntervalColorRectangle* newItem )
+{
+    icList.append(newItem);
+    updateTimeTable();
+}
+
+#if 0
 bool KDTimeHeaderWidget::changeBackgroundInterval( const QDateTime& oldstart,
                                                    const QDateTime& oldend,
                                                    const QDateTime& newstart,
@@ -1580,14 +1567,15 @@
     newItem.canvasRect->setZ(-19);
     icList.append(newItem);
     updateTimeTable();
+}
+#endif
 
-}
 void KDTimeHeaderWidget::clearBackgroundColor()
 {
 
     IntervalColorList::iterator itic;
     for ( itic = icList.begin(); itic != icList.end(); ++itic ) {
-        delete  (*itic).canvasRect;
+        delete  (*itic);
     }
     ccList.clear();
     icList.clear();
@@ -2377,7 +2365,7 @@
 {
      moveTimeLineTo(getCoordX( center )-(myGanttView->myCanvasView->viewport()->width() /2));
     //  qDebug("centerDateTime %s %d %d", center.toString().latin1(),getCoordX( center ),(myGanttView->myCanvasView->viewport()->width() /2) );
-   
+
 }
 
 
@@ -2850,7 +2838,7 @@
     for (; child; child = child->nextSibling()) {
         ypos = buildDrawables(drawables, level, ypos, child, cy, cy+ch);
     }
-    
+
     p->setFont( font() );
 
     QPtrListIterator<KDListView::DrawableItem> it(drawables);
@@ -2935,7 +2923,7 @@
 
         // do any children of current need to be painted?
 /* FIXME: painting branches doesn't work for some reason...
-        if ( ih != ith && 
+        if ( ih != ith &&
             rootIsDecorated() &&
             current->y + ith > cy &&
             current->y + ih < cy + ch &&
@@ -3165,7 +3153,9 @@
 
 
 KDGanttCanvasView::KDGanttCanvasView( KDGanttView* sender,QCanvas* canvas, QWidget* parent,  const
-    char* name ) : QCanvasView ( canvas, parent, name ), scrollBarTimer( 0, "scrollBarTimer" )
+    char* name ) : QCanvasView ( canvas, parent, name ),
+    movingGVItem( 0 ),
+    scrollBarTimer( 0, "scrollBarTimer" )
 {
     setHScrollBarMode (QScrollView::AlwaysOn );
     setVScrollBarMode( QScrollView::AlwaysOn );
@@ -3177,10 +3167,11 @@
     fromItem = 0;
     fromArea = 0;
     linkItemsEnabled = false;
+    mouseDown = false;
     linkLine = new QCanvasLine(canvas);
     linkLine->hide();
     linkLine->setZ(1000);
-    //set_Mouse_Tracking(true);
+    set_Mouse_Tracking(true); // mouse cursor changes over KDIntervalColorRectangle borders
     new KDCanvasWhatsThis(viewport(),this);
     onItem = new QPopupMenu( this );
     QPopupMenu * newMenu = new QPopupMenu( this );
@@ -3221,7 +3212,7 @@
     onItem->setItemEnabled( 3, false );
     myMyContentsHeight = 0;
     _showItemAddPopupMenu = false;
-    
+
     QObject *scrollViewTimer = child( "scrollview scrollbar timer", "QTimer", false );
     Q_ASSERT( scrollViewTimer );
     if ( scrollViewTimer ) {
@@ -3229,7 +3220,7 @@
     }
     // If they needed a scrollbar timer in scrollview...
     connect( &scrollBarTimer, SIGNAL(timeout()), this, SLOT(myUpdateScrollBars() ) );
-    
+
     myScrollTimer = new QTimer( this, "myScrollTimer" );
     connect( myScrollTimer, SIGNAL( timeout() ), SLOT( slotScrollTimer() ) );
     autoScrollEnabled = false;
@@ -3304,9 +3295,9 @@
 // Then the new scrollbar maxValue is in myTimeHeader.
 void KDGanttCanvasView::updateHorScrollBar() {
     //qDebug("horizontalScrollBar max=%d, myTimeHeaderScroll=%d", horizontalScrollBar()->maxValue(), mySignalSender->myTimeHeaderScroll->horizontalScrollBar()->value());
-    
+
     horizontalScrollBar()->setRange(mySignalSender->myTimeHeaderScroll->horizontalScrollBar()->minValue(), mySignalSender->myTimeHeaderScroll->horizontalScrollBar()->maxValue());
-    
+
 }
 
 void  KDGanttCanvasView::cutItem( KDGanttViewItem* item )
@@ -3496,6 +3487,19 @@
 }
 
 
+KDGanttCanvasView::MovingOperation KDGanttCanvasView::gvItemHitTest( KDGanttViewItem *item, KDTimeHeaderWidget* timeHeader, const QPoint &pos )
+{
+  const int left = timeHeader->getCoordX( item->startTime() );
+  const int right = timeHeader->getCoordX( item->endTime() );
+  const int width = right - left + 1;
+  const int x = pos.x();
+  if ( x < left + width / 10 )
+    return KDGanttCanvasView::ResizingLeft;
+  if ( x > right - width / 10 )
+    return KDGanttCanvasView::ResizingRight;
+  return KDGanttCanvasView::Moving;
+}
+
 /**
    Handles the mouseevent if a mousekey is pressed
 
@@ -3510,6 +3514,8 @@
     setFocus();
     currentLink = 0;
     currentItem = 0;
+    movingItem = 0;
+    mouseDown = true;
     if (e->button() == RightButton && mySignalSender->editable()) {
         lastClickedItem = (KDGanttViewItem*) mySignalSender->myListView->itemAt( QPoint(2,e->pos().y()));
         if ( lastClickedItem ) {
@@ -3537,7 +3543,7 @@
                 currentItem = getItem(*it);
                 if (! currentItem->enabled() ) {
                     currentItem = 0;
-                } else if (linkItemsEnabled && 
+                } else if (linkItemsEnabled &&
                            !currentItem->isMyTextCanvas(*it)) {
                     fromArea = getItemArea(currentItem, e->pos().x());
                     if (fromArea > 0) {
@@ -3546,10 +3552,40 @@
                         linkLine->show();
                     }
                 }
+                {
+                  KDCanvasRectangle *rect = dynamic_cast<KDCanvasRectangle*>( *it );
+                  if ( rect ) {
+                    movingGVItem = dynamic_cast<KDGanttViewTaskItem*>( getItem( rect ) );
+                    if ( movingGVItem ) {
+                      movingStart = e->pos();
+                      movingStartDate = movingGVItem->startTime();
+                      movingOperation = gvItemHitTest( movingGVItem, mySignalSender->myTimeHeader, e->pos() );
+                      if ( movingOperation == Moving && !movingGVItem->isMoveable() )
+                        movingGVItem = 0;
+                      else if ( movingOperation != Moving && !movingGVItem->isResizeable() )
+                        movingOperation = Moving;
+                    } else {
+                      movingGVItem = 0;
+                    }
+                  }
+                }
                 break;
             case Type_is_KDGanttTaskLink:
                 currentLink = getLink(*it);
                 break;
+            case Type_is_KDGanttGridItem:
+              if ( (*it)->rtti() == KDIntervalColorRectangle::RTTI ) {
+                // Cleaner would be isMovable()/isResizeable() in an interface
+                // implemented by all movable objects...
+                movingItem = static_cast<QCanvasRectangle *>(*it);
+                movingStart = e->pos();
+                KDIntervalColorRectangle* icr = static_cast<KDIntervalColorRectangle *>( movingItem );
+                KDIntervalColorRectangle::HitTest hitTest = icr->hitTest( mySignalSender->myTimeHeader, movingStart );
+                movingOperation = hitTest == KDIntervalColorRectangle::Start ? ResizingLeft :
+                                  hitTest == KDIntervalColorRectangle::End ? ResizingRight :
+                                  Moving;
+              }
+              break;
             default:
                 break;
             }
@@ -3598,6 +3634,7 @@
 
 void KDGanttCanvasView::contentsMouseReleaseEvent ( QMouseEvent * e )
 {
+    mouseDown = false;
     static KDGanttViewItem* lastClicked = 0;
     mySignalSender->gvMouseButtonClicked( e->button(), currentItem ,  e->globalPos() );
     //qDebug("datetime %s ",mySignalSender->getDateTimeForCoordX(e->globalPos().x(), true ).toString().latin1() );
@@ -3633,6 +3670,10 @@
                 }
             }
             fromItem = 0;
+            if ( movingGVItem ) {
+              mySignalSender->gvItemMoved( movingGVItem );
+              movingGVItem = 0;
+            }
             break;
         case RightButton:
             {
@@ -3671,6 +3712,13 @@
 void KDGanttCanvasView::contentsMouseDoubleClickEvent ( QMouseEvent * e )
 {
     QCanvasItemList il = canvas() ->collisions ( e->pos() );
+
+    if ( il.isEmpty() && e->button() == LeftButton ) {
+        //not directly sending a signal here (encapsulation and whatnot)
+        mySignalSender->emptySpaceDoubleClicked(e);
+        return;
+    }
+
     QCanvasItemList::Iterator it;
     for ( it = il.begin(); it != il.end(); ++it ) {
         switch ( e->button() ) {
@@ -3722,7 +3770,7 @@
     }
 }
 /**
-   Handles the mouseevent if a mousekey is pressed an the mouse is moved
+   Handles the mouseevent if a mouse button is pressed an the mouse is moved
 
    \param e the mouseevent
 
@@ -3730,11 +3778,93 @@
 
 void KDGanttCanvasView::contentsMouseMoveEvent ( QMouseEvent *e )
 {
-    //qDebug("mousemove! ");
+    if ( !mouseDown ) {
+      // Update cursor
+      bool found = false;
+      QCanvasItemList il = canvas() ->collisions ( e->pos() );
+      QCanvasItemList::Iterator it;
+      for ( it = il.begin(); it != il.end(); ++it ) {
+        if ( (*it)->rtti() == KDIntervalColorRectangle::RTTI ) {
+          found = true;
+          KDIntervalColorRectangle* icr = static_cast<KDIntervalColorRectangle *>( *it );
+          KDIntervalColorRectangle::HitTest hitTest = icr->hitTest( mySignalSender->myTimeHeader, e->pos() );
+          switch ( hitTest ) {
+          case KDIntervalColorRectangle::Start:
+          case KDIntervalColorRectangle::End:
+            setCursor( splitHCursor );
+            break;
+          default:
+            unsetCursor();
+          }
+        }
+        KDGanttViewItem *gvItem = getItem( *it );
+        if ( dynamic_cast<KDGanttViewTaskItem*>( gvItem ) ) {
+          found = true;
+          MovingOperation op = gvItemHitTest( gvItem, mySignalSender->myTimeHeader, e->pos() );
+          switch ( op ) {
+            case ResizingLeft:
+            case ResizingRight:
+              if ( gvItem->isResizeable() )
+                setCursor( splitHCursor );
+              break;
+            default:
+              unsetCursor();
+          }
+        }
+      }
+      if ( !found )
+        unsetCursor();
+      return;
+    }
+
+    const QPoint p = e->pos();
+    if ( movingItem ) {
+      int x = qRound( movingItem->x() );
+      int width = movingItem->width();
+      switch( movingOperation ) {
+      case Moving:
+        x += p.x() - movingStart.x();
+        break;
+      case ResizingLeft: {
+        width = qRound( movingItem->x() + movingItem->width() - p.x() );
+        x = p.x();
+        break;
+      }
+      case ResizingRight:
+        width = p.x() - x;
+        break;
+      }
+      movingStart = p;
+      if ( movingItem->rtti() == KDIntervalColorRectangle::RTTI ) {
+        KDIntervalColorRectangle* icr = static_cast<KDIntervalColorRectangle *>(movingItem);
+        const QDateTime newStart = mySignalSender->myTimeHeader->getDateTimeForIndex(x);
+        const QDateTime newEnd = mySignalSender->myTimeHeader->getDateTimeForIndex(x + width);
+        icr->setDateTimes( newStart, newEnd );
+        emit mySignalSender->intervalColorRectangleMoved( newStart, newEnd );
+        mySignalSender->myTimeHeader->computeIntervals( movingItem->height() );
+      }
+      canvas()->update();
+    }
+
+    if ( movingGVItem ) {
+      int dx = movingStart.x() - e->pos().x();
+      int x = movingGVItem->middleLeft().x() - dx;
+      QDateTime dt = mySignalSender->getDateTimeForCoordX( x, false );
+      int duration = movingGVItem->startTime().secsTo( movingGVItem->endTime() );
+      if ( movingOperation == Moving ) {
+        movingGVItem->setStartTime( dt );
+        movingGVItem->setEndTime( dt.addSecs( duration ) );
+      } else if ( movingOperation == ResizingLeft ) {
+        movingGVItem->setStartTime( dt );
+      } else if ( movingOperation == ResizingRight ) {
+        movingGVItem->setEndTime( dt.addSecs( duration ) );
+      }
+      movingStart = e->pos();
+    }
+
     static int moves = 0;
     if ( (currentLink || currentItem) && (moves < 3) ) {
         ++moves;
-
     } else {
         moves = 0;
         currentLink = 0;
@@ -3748,21 +3878,6 @@
         canvas()->update();
     }
     // no action implemented
-    //qDebug("mousemove ");
-    //QToolTip::setGloballyEnabled (false);
-    //QToolTip::remove(viewport());
-    // QToolTip::add(viewport(), "hello");
-    // QToolTip::setGloballyEnabled (true);
-    /*
-      QCanvasItemList il = canvas() ->collisions ( e->pos() );
-
-      QCanvasItemList::Iterator it;
-      KDGanttItem* mouseover = 0;
-      for ( it = il.begin(); it != il.end(); ++it ) {
-
-      }
-
-    */
 }
 void KDGanttCanvasView::viewportPaintEvent ( QPaintEvent * pe )
 {
@@ -3779,7 +3894,9 @@
     case QCanvasItem::Rtti_Ellipse: return ((KDCanvasEllipse *)it)->myParentType;
     case QCanvasItem::Rtti_Text: return ((KDCanvasText *)it)->myParentType;
     case QCanvasItem::Rtti_Polygon: return ((KDCanvasPolygon *)it)->myParentType;
-    case QCanvasItem::Rtti_Rectangle: return ((KDCanvasRectangle *)it)->myParentType;
+    case QCanvasItem::Rtti_Rectangle:
+    case KDIntervalColorRectangle::RTTI:
+      return ((KDCanvasRectangle *)it)->myParentType;
     }
     return -1;
 }
@@ -3807,7 +3924,7 @@
 }
 
 void KDGanttCanvasView::slotScrollTimer() {
-    int mx = mousePos.x(); 
+    int mx = mousePos.x();
     int my = mousePos.y();
     int dx = 0;
     int dy = 0;
@@ -3819,7 +3936,7 @@
         dy = -5;
     else if (my > visibleHeight())
         dy = QMIN(5, verticalScrollBar()->maxValue()-verticalScrollBar()->value());
-    
+
     if (dx != 0 || dy != 0)
         scrollBy(dx, dy);
 }
@@ -3863,3 +3980,69 @@
     }
     return KDGanttViewTaskLink::None;
 }
+
+/*!
+  Represents the background color for a given interval of time (across all tasks).
+  \sa KDGanttView::addIntervalBackgroundColor
+  \param view parent view
+ */
+KDIntervalColorRectangle::KDIntervalColorRectangle( KDGanttView* view )
+  : KDCanvasRectangle( view->timeTableWidget(), 0, Type_is_KDGanttGridItem ),
+  mStart(), mEnd()
+{
+  setZ( -19 );
+}
+
+/*!
+  \param start start datetime of the time interval
+  \param end end datetime of the time interval
+ */
+void KDIntervalColorRectangle::setDateTimes( const QDateTime& start,
+                                             const QDateTime& end )
+{
+  mStart = start;
+  mEnd = end;
+  if ( mEnd < mStart )
+    qSwap( mStart, mEnd );
+}
+
+/*!
+  Sets the background color
+  \param color the background color
+*/
+void KDIntervalColorRectangle::setColor( const QColor& color )
+{
+  mColor = color;
+}
+
+/*!
+  \internal
+*/
+void KDIntervalColorRectangle::layout( KDTimeHeaderWidget* timeHeader, int height )
+{
+  int left = timeHeader->getCoordX(mStart);
+  int right = timeHeader->getCoordX(mEnd);
+  if ( right == left )
+    ++right;
+  setPen( QPen::NoPen );
+  setBrush( QBrush(mColor, SolidPattern) );
+  setSize( right - left, height );
+  move( left, 0 );
+  show();
+}
+
+/*!
+  \internal
+*/
+KDIntervalColorRectangle::HitTest KDIntervalColorRectangle::hitTest( KDTimeHeaderWidget* timeHeader, const QPoint& pos ) const
+{
+  const int left = timeHeader->getCoordX(mStart);
+  const int right = timeHeader->getCoordX(mEnd);
+  const int width = right - left + 1;
+  const int x = pos.x();
+  if ( x < left + width / 10 )
+    return Start;
+  if ( x > right - width / 10 )
+    return End;
+  return Middle;
+}
Index: kdgantt/KDGanttView.h
===================================================================
--- kdgantt/KDGanttView.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttView.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 Kl√§rlvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2001-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -50,6 +50,7 @@
 #include "KDGanttMinimizeSplitter.h"
 #include "KDGanttViewItemDrag.h"
 
+class KDIntervalColorRectangle;
 class KDGanttViewTaskLink;
 class QPrinter;
 class QIODevice;
@@ -259,6 +260,8 @@
                                    const QColor& color,
 				   Scale mini =  KDGanttView::Minute ,
 				   Scale maxi =  KDGanttView::Month);
+#if 0
+   // This API has been replaced with KDIntervalColorRectangle and addIntervalBackgroundColor
     void setIntervalBackgroundColor( const QDateTime& start,
 				     const QDateTime& end,
 				     const QColor& color,
@@ -270,6 +273,8 @@
 				   const QDateTime& newend );
     bool deleteBackgroundInterval( const QDateTime& start,
 				   const QDateTime& end );
+#endif
+    void addIntervalBackgroundColor( KDIntervalColorRectangle* newItem );
     void clearBackgroundColor();
     QColor columnBackgroundColor( const QDateTime& column ) const;
     void setWeekendBackgroundColor( const QColor& color );
@@ -338,7 +343,12 @@
 
     void setLinkItemsEnabled(bool on);
     bool isLinkItemsEnabled() const;
-    
+
+    KDTimeTableWidget * timeTableWidget() { return myTimeTable; }
+    KDTimeHeaderWidget * timeHeaderWidget() { return myTimeHeader; }
+
+    void setFixedHorizon( bool f ) { mFixedHorizon = f; }
+
 public slots:
     void editItem( KDGanttViewItem* );
     void zoomToSelection( const QDateTime& start,  const QDateTime&  end);
@@ -346,7 +356,8 @@
 signals:
     void timeIntervallSelected( const QDateTime& start,  const QDateTime&  end);
     void timeIntervalSelected( const QDateTime& start,  const QDateTime&  end);
-    void rescaling( Scale );
+    void rescaling( KDGanttView::Scale );
+    void intervalColorRectangleMoved( const QDateTime& start, const QDateTime& end );
 
     // the following signals are emitted if an item is clicked in the
     // listview (inclusive) or in the ganttview
@@ -357,7 +368,7 @@
 
     // The following signal is emitted when two items shall be linked
     void linkItems( KDGanttViewItem* from, KDGanttViewItem* to, int linkType );
-    
+
     // the following signals are emitted if an item is clicked in the
     // listview (exlusive) or in the ganttview
     // gv... means item in ganttview clicked
@@ -371,6 +382,7 @@
     void gvItemDoubleClicked( KDGanttViewItem* );
     // the point is the global position!!
     void gvContextMenuRequested ( KDGanttViewItem * item, const QPoint & pos );
+    void gvItemMoved( KDGanttViewItem* );
 
     // lv... means item in listview clicked
     void lvCurrentChanged( KDGanttViewItem* );
@@ -391,6 +403,8 @@
     void taskLinkRightClicked( KDGanttViewTaskLink* );
     void taskLinkDoubleClicked( KDGanttViewTaskLink* );
 
+    void dateTimeDoubleClicked (const QDateTime& );
+
     void dropped ( QDropEvent * e, KDGanttViewItem* droppedItem, KDGanttViewItem* itemBelowMouse);
 private slots:
     void forceRepaint( int val = 0 );
@@ -414,6 +428,8 @@
     bool loadXML( const QDomDocument& doc );
     QDomDocument saveXML( bool withPI = true ) const;
 
+    void emptySpaceDoubleClicked( QMouseEvent* e );
+
     static QString scaleToString( Scale scale );
     static QString yearFormatToString( YearFormat format );
     static QString hourFormatToString( HourFormat format );
@@ -475,6 +491,7 @@
     void initDefaults();
     KDGanttViewItem* myCurrentItem;
     KDGanttMinimizeSplitter *mySplitter;
+    bool  mFixedHorizon;
 protected:
   virtual QDragObject * dragObject ();
   virtual void startDrag ();
Index: kdgantt/KDGanttViewSubwidgets.h
===================================================================
--- kdgantt/KDGanttViewSubwidgets.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kdgantt/KDGanttViewSubwidgets.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
 */
 
 /****************************************************************************
- ** Copyright (C)  2002-2004 Klar‰lvdalens Datakonsult AB.  All rights reserved.
+ ** Copyright (C)  2002-2004 Klar√§lvdalens Datakonsult AB.  All rights reserved.
  **
  ** This file is part of the KDGantt library.
  **
@@ -67,6 +67,7 @@
 #define Type_is_KDGanttViewItem 2
 #define Type_is_KDGanttTaskLink 3
 
+class KDIntervalColorRectangle;
 class KDCanvasWhatsThis;
 class KDToolTip;
 class KDCanvasRectangle;
@@ -90,7 +91,7 @@
      KDCanvasRectangle* canvasRect;
    };
    typedef QValueList<DateTimeColor> ColumnColorList;
-  typedef QValueList<DateTimeColor> IntervalColorList;
+   typedef QValueList<KDIntervalColorRectangle *> IntervalColorList;
    /*
      enum Scale { Minute, Hour, Day, Week, Month, Auto };
      enum YearFormat { FourDigit, TwoDigit, TwoDigitApostrophe };
@@ -136,6 +137,8 @@
 				  const QColor& color,
 				  Scale mini =  KDGanttView::Minute ,
 				  Scale maxi =  KDGanttView::Month);
+#if 0
+   // This API has been replaced with KDIntervalColorRectangle and addIntervalBackgroundColor
    void setIntervalBackgroundColor( const QDateTime& start,
 				    const QDateTime& end,
 				  const QColor& color,
@@ -147,6 +150,8 @@
 				  const QDateTime& newend );
    bool deleteBackgroundInterval( const QDateTime& start,
 				  const QDateTime& end );
+#endif
+   void addIntervalBackgroundColor( KDIntervalColorRectangle* newItem );
    void clearBackgroundColor();
    QColor columnBackgroundColor( const QDateTime& column ) const;
    void setWeekendBackgroundColor( const QColor& color );
@@ -186,6 +191,7 @@
     friend class KDTimeTableWidget;
     friend class KDGanttViewItem;
     friend class KDGanttView;
+    friend class KDGanttCanvasView; // calls computeIntervals
     virtual void mousePressEvent ( QMouseEvent * e );
     virtual void mouseReleaseEvent ( QMouseEvent * e );
     virtual void mouseDoubleClickEvent ( QMouseEvent * e );
@@ -268,7 +274,7 @@
     QBrush noInformationBrush() const;
 
     int getCoordX( QDateTime dt );
-    
+
 signals:
    void   heightComputed( int );
 
@@ -445,6 +451,33 @@
 };
 
 
+// Interval-color-rectangle, such as the one used in the freebusy view for the current event
+class KDIntervalColorRectangle: public KDCanvasRectangle
+{
+public:
+  KDIntervalColorRectangle( KDGanttView* view );
+
+  void setDateTimes( const QDateTime& start,
+                     const QDateTime& end );
+  QDateTime start() const { return mStart; }
+  QDateTime end() const { return mEnd; }
+
+  void setColor( const QColor& color );
+
+  enum HitTest { Start, Middle, End };
+  HitTest hitTest( KDTimeHeaderWidget* timeHeader, const QPoint& pos ) const;
+
+  void layout( KDTimeHeaderWidget* timeHeader, int height );
+
+  static const int RTTI = 0x0c58;
+  /*reimp*/ int rtti() const { return RTTI; }
+
+private:
+  QColor mColor;
+  QDateTime mStart;
+  QDateTime mEnd;
+};
+
 class KDCanvasToolTip;
 
 class KDGanttCanvasView : public QCanvasView
@@ -474,12 +507,21 @@
     virtual void viewportPaintEvent ( QPaintEvent * pe );
     void resizeEvent ( QResizeEvent * ) ;
     void set_MouseTracking(bool on);
+    int getType(QCanvasItem*);
+    KDGanttViewItem* getItem(QCanvasItem*);
+    KDGanttViewTaskLink* getLink(QCanvasItem*);
+    int getItemArea(KDGanttViewItem *item, int x);
+    int getLinkType(int from, int to);
+
     KDGanttView* mySignalSender;
     KDGanttViewItem* currentItem, *lastClickedItem, *cuttedItem;
+    QCanvasRectangle* movingItem;
+    KDGanttViewTaskItem* movingGVItem;
+    QPoint movingStart;
+    QDateTime movingStartDate;
+    enum MovingOperation { Moving, ResizingLeft, ResizingRight };
+    MovingOperation movingOperation;
     KDGanttViewTaskLink* currentLink;
-    int getType(QCanvasItem*);
-    KDGanttViewItem* getItem(QCanvasItem*);
-    KDGanttViewTaskLink* getLink(QCanvasItem*);
     KDCanvasWhatsThis* myWhatsThis;
     QPopupMenu* onItem;
     bool _showItemAddPopupMenu;
@@ -489,12 +531,12 @@
     QCanvasLine *linkLine;
     int fromArea;
     bool autoScrollEnabled;
-    int getItemArea(KDGanttViewItem *item, int x);
-    int getLinkType(int from, int to);
+    bool mouseDown;
 
 signals:
   void heightResized( int );
   void widthResized( int );
+
 public slots:
   void set_Mouse_Tracking(bool on);
   void moveMyContent( int, int );
@@ -507,8 +549,10 @@
   void newChildItem( int );
   void slotScrollTimer();
   void myUpdateScrollBars();
-  
+
 private:
+  MovingOperation gvItemHitTest( KDGanttViewItem *item, KDTimeHeaderWidget* timeHeader, const QPoint &pos );
+private:
   KDCanvasToolTip* myToolTip;
   QTimer *myScrollTimer;
   QPoint mousePos;
Index: kmail/encryptionconfigurationdialogimpl.h
===================================================================
--- kmail/encryptionconfigurationdialogimpl.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/encryptionconfigurationdialogimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,19 +0,0 @@
-#ifndef ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
-#define ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
-#include "encryptionconfigurationdialog.h"
-
-class CryptPlugWrapper;
-
-class EncryptionConfigurationDialogImpl : public EncryptionConfigurationDialog
-{
-    Q_OBJECT
-
-public:
-    EncryptionConfigurationDialogImpl( QWidget* parent = 0, 
-                                       const char* name = 0, WFlags fl = 0 );
-    ~EncryptionConfigurationDialogImpl();
-
-    void enableDisable( CryptPlugWrapper* wrapper );
-};
-
-#endif // ENCRYPTIONCONFIGURATIONDIALOGIMPL_H
Index: kmail/encryptionconfigurationdialogimpl.cpp
===================================================================
--- kmail/encryptionconfigurationdialogimpl.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/encryptionconfigurationdialogimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,83 +0,0 @@
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-
-#include "encryptionconfigurationdialogimpl.h"
-#include "cryptplugwrapper.h"
-
-#include <qbuttongroup.h>
-#include <qradiobutton.h>
-#include <qcheckbox.h>
-#include <qspinbox.h>
-
-
-
-
-#define FULLTEST false
-
-
-
-
-/*
- *  Constructs a EncryptionConfigurationDialogImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- */
-EncryptionConfigurationDialogImpl::EncryptionConfigurationDialogImpl( QWidget* parent,  const char* name, WFlags fl )
-    : EncryptionConfigurationDialog( parent, name, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-EncryptionConfigurationDialogImpl::~EncryptionConfigurationDialogImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-
-/**
-   Enables or disables the widgets in this dialog according to the
-   capabilities of the current plugin passed as a parameter.
-*/
-void EncryptionConfigurationDialogImpl::enableDisable( CryptPlugWrapper* cryptPlug )
-{
-    // disable the whole page if the plugin does not support encryption
-    setEnabled( cryptPlug->hasFeature( Feature_EncryptMessages ) );
-    
-    // enable/disable individual components depending on the plugin features
-    crlBG->setEnabled( cryptPlug->hasFeature( Feature_EncryptionCRLs ) );
-    warnReceiverCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnReceiverCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnChainCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnChainCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptCertificateExpiry ) );
-    warnReceiverNotInCertificateCB->setEnabled( cryptPlug->hasFeature( Feature_WarnEncryptEmailNotInCertificate ) );
-    storeEncryptedCB->setEnabled( cryptPlug->hasFeature( Feature_StoreMessagesEncrypted ) );
-    certificatePathCheckBG->setEnabled( cryptPlug->hasFeature( Feature_CheckCertificatePath ) );
-    
-    if( ! FULLTEST ) {
-        askEachPartRB                 ->hide(); // We won't implement that.
-        
-//        encryptionSettingsBG          ->hide(); // Will implement that later.
-        
-        certBG                         ->hide(); // Will implement that later.
-
-        warnCRLExpireCB               ->hide(); // Will implement that later.
-        warnCRLExpireSB               ->hide(); // Will implement that later.
-        
-//        warnReceiverCertificateExpiresCB->hide();//Will implement that later.
-//        warnReceiverCertificateExpiresSB->hide();//Will implement that later.
-        
-        warnChainCertificateExpiresCB ->hide(); // Will implement that later.
-        warnChainCertificateExpiresSB ->hide(); // Will implement that later.
-        warnReceiverNotInCertificateCB->hide(); // Will implement that later.
-        
-        alwaysCheckRootRB             ->hide(); // Will implement that later.
-        
-        /*enable:*/
-        pathMayEndLocallyCB           ->setEnabled( true );
-        
-    }
-}
-
-#include "encryptionconfigurationdialogimpl.moc"
Index: kmail/signatureconfigurationdialogimpl.h
===================================================================
--- kmail/signatureconfigurationdialogimpl.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/signatureconfigurationdialogimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,19 +0,0 @@
-#ifndef SIGNATURECONFIGURATIONDIALOGIMPL_H
-#define SIGNATURECONFIGURATIONDIALOGIMPL_H
-#include "signatureconfigurationdialog.h"
-
-class CryptPlugWrapper;
-
-class SignatureConfigurationDialogImpl : public SignatureConfigurationDialog
-{
-    Q_OBJECT
-
-public:
-    SignatureConfigurationDialogImpl( QWidget* parent = 0, 
-                                      const char* name = 0, WFlags fl = 0 );
-    ~SignatureConfigurationDialogImpl();
-
-    void enableDisable( CryptPlugWrapper* );
-};
-
-#endif // SIGNATURECONFIGURATIONDIALOGIMPL_H
Index: kmail/signatureconfigurationdialogimpl.cpp
===================================================================
--- kmail/signatureconfigurationdialogimpl.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/signatureconfigurationdialogimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,83 +0,0 @@
-#include <config.h>
-#include "signatureconfigurationdialogimpl.h"
-#include "cryptplugwrapper.h"
-
-#include <qbuttongroup.h>
-#include <qradiobutton.h>
-#include <qcheckbox.h>
-#include <qspinbox.h>
-
-
-
-
-#define FULLTEST false
-
-
-
-
-/*
- *  Constructs a SignatureConfigurationDialogImpl which is a child of 'parent', with the
- *  name 'name' and widget flags set to 'f'
- */
-SignatureConfigurationDialogImpl::SignatureConfigurationDialogImpl( QWidget* parent,  const char* name, WFlags fl )
-    : SignatureConfigurationDialog( parent, name, fl )
-{
-}
-
-/*
- *  Destroys the object and frees any allocated resources
- */
-SignatureConfigurationDialogImpl::~SignatureConfigurationDialogImpl()
-{
-    // no need to delete child widgets, Qt does it all for us
-}
-
-
-/**
-   Enables or disables the widgets in this dialog according to the
-   capabilities of the current plugin passed as a parameter.
-*/
-void SignatureConfigurationDialogImpl::enableDisable( CryptPlugWrapper* cryptPlug )
-{
-    // disable the whole page if the plugin does not support
-    // signatures (e.g. encryption only)
-    setEnabled( cryptPlug->hasFeature( Feature_SignMessages ) );
-
-    // enable and disable the various components depending on the
-    // availability of a feature in the crypto plugin
-    sendCertificatesBG->setEnabled( cryptPlug->hasFeature( Feature_SendCertificates ) );
-    sigCompoundModeBG->setEnabled( cryptPlug->hasFeature( Feature_SendCertificates ) );
-    warnSignatureCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnSignatureCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnCACertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnCACertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnRootCertificateExpiresCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnRootCertificateExpiresSB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignCertificateExpiry ) );
-    warnAddressNotInCertificateCB->setEnabled( cryptPlug->hasFeature( Feature_WarnSignEmailNotInCertificate ) );
-    pinEntryBG->setEnabled( cryptPlug->hasFeature( Feature_PinEntrySettings ) );
-    saveSentSigsCB->setEnabled( cryptPlug->hasFeature( Feature_StoreMessagesWithSigs ) );
-    
-    if( ! FULLTEST ){
-        askEachPartRB                ->hide(); // We won't implement that.
-        
-        sendCertificatesBG           ->hide(); // Will implement that later
-        
-        pinEntryBG                   ->hide(); // Will implement that later
-        
-        saveSentSigsCB->hide(); // We won't implement that.
-        
-        dontSendCertificatesRB       ->hide(); // Will implement that later.
-        sendChainWithoutRootRB       ->hide(); // Will implement that later.
-        sendChainWithRootRB          ->hide(); // Will implement that later.
-        
-        pinOncePerSessionRB          ->hide(); // Will implement that later.
-        pinAddCertificatesRB         ->hide(); // Will implement that later.
-        pinAlwaysWhenSigningRB       ->hide(); // Will implement that later.
-        pinIntervalRB                ->hide(); // Will implement that later.
-        pinIntervalSB                ->hide(); // Will implement that later.
-        
-        saveSentSigsCB               ->hide(); // We won't implement that.
-    }
-}
-
-#include "signatureconfigurationdialogimpl.moc"
Index: kmail/encryptionconfigurationdialog.ui
===================================================================
--- kmail/encryptionconfigurationdialog.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/encryptionconfigurationdialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,687 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>EncryptionConfigurationDialog</class>
-<widget class="QWidget">
-    <property name="name">
-        <cstring>EncryptionConfigurationDialog</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>445</width>
-            <height>481</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Encryption Configuration</string>
-    </property>
-    <vbox>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <property name="margin">
-            <number>11</number>
-        </property>
-        <property name="spacing">
-            <number>6</number>
-        </property>
-        <widget class="QButtonGroup">
-            <property name="name">
-                <cstring>encryptMessagesBG</cstring>
-            </property>
-            <property name="title">
-                <string>Encryption</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QLabel" row="0" column="0">
-                    <property name="name">
-                        <cstring>encryptionAlgorithmLA</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Encryption &amp;algorithm:</string>
-                    </property>
-                    <property name="buddy" stdset="0">
-                        <cstring>encryptionAlgorithmCO</cstring>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>storeEncryptedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Store sent messages &amp;encrypted</string>
-                    </property>
-                    <property name="checked">
-                        <bool>false</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to store messages encrypted </string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Store Messages Encrypted&lt;/h1&gt;
-When this box is checked, sent messages are stored encrypted like they were sent. This is not recommended, as you will not be able to read the messages any longer if a necessary certificate expires.
-&lt;p&gt;
-However, there may be local rules that require you to turn this option on. When in doubt, check with your local administrator.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="1" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>encryptAllPartsRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Encr&amp;ypt all message parts</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have all message parts encrypted by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Encrypt All Message Parts By Default&lt;/h1&gt;
-If this option is selected, all parts of a message (i.e. the main message body and all attachments) are encrypted by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="2" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>askEachPartRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Ask &amp;before encrypting each part</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be asked for each part whether to encrypt</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Ask Before Encrypting Each Part&lt;/h1&gt;
-When this option is selected, you will be asked for each part of the message (i.e. the main message body as well as all attachments) individually whether you want the part to be encrypted.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="3" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>dontEncryptRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Do not encrypt messages</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check for not encrypting a message by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Do Not Encrypt Messages&lt;/h1&gt;
-If this option is selected, messages are not encrypted by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual setting.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QComboBox" row="0" column="1">
-                    <item>
-                        <property name="text">
-                            <string>Triple-DES</string>
-                        </property>
-                    </item>
-                    <property name="name">
-                        <cstring>encryptionAlgorithmCO</cstring>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects the encryption algorithm</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Encryption Algorithm&lt;/h1&gt;
-An algorithm is a description for the computer on how it should perform a certain task. The encryption algorithm describes how the computer applies your recipient's key to your message so that only the intended receiver can read the message.
-&lt;p&gt;
-The selection of a certain encryption algorithm determines how easy or how difficult it is to intercept and read a message. However, all algorithms provided in the SPHINX environment are considered to be very safe. Generally, the default will work just fine here.
-&lt;p&gt;
-This setting is a default, you can override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <spacer row="0" column="2">
-                    <property name="name">
-                        <cstring>Spacer19</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-            </grid>
-        </widget>
-        <widget class="QButtonGroup">
-            <property name="name">
-                <cstring>certBG</cstring>
-            </property>
-            <property name="title">
-                <string>Certificates</string>
-            </property>
-            <vbox>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <widget class="QButtonGroup">
-                    <property name="name">
-                        <cstring>certificatePathCheckBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <spacer row="1" column="0" rowspan="2" colspan="1">
-                            <property name="name">
-                                <cstring>Spacer1_2_2</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <widget class="QRadioButton" row="2" column="1">
-                            <property name="name">
-                                <cstring>pathMayEndLocallyCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Check can end with locally sa&amp;ved certificate</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to end with locally saved certificate.</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Certificate Check Can End With Locally Saved Certificate&lt;/h1&gt;
-If this option is checked, the check of the certificate chain can end with a locally saved certificate.
-&lt;p&gt;
-Locally saved certificates are your own certificates as well as the certificates of communication partners and certification authorities (CAs).
-&lt;/h1&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="1" column="1">
-                            <property name="name">
-                                <cstring>alwaysCheckRootRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always c&amp;heck to root certificate</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check here to check up to the root certificate</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Always Check Certificate Path To Root Certificate&lt;/h1&gt;
-If this option is turned on, the certificate path belonging to the receiver's certificate will always be checked all the way to the root certificate.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                            <property name="name">
-                                <cstring>checkCertificatePathCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Check certificate &amp;path</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check here to have the whole certificate path checked</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Check Certificate Path&lt;/h1&gt;
-If this option is turned on, the whole path of the receiver's certificate up to the root will be checked.
-&lt;p&gt;
-Note that it is not possible to turn off checking the receiver's certificate itself.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                    </grid>
-                </widget>
-                <widget class="QButtonGroup">
-                    <property name="name">
-                        <cstring>crlBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                            <property name="name">
-                                <cstring>useCRLsCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>&amp;Use certificate revocation lists (CRLs)</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to use CRLs</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Use Certificate Revocation Lists (CRLs)&lt;/h1&gt;
-A certificate revocation list contains certificates that have been withdrawn and should not be used for encryption purposes any longer. A user may wish to have his or her certificate revoked because he or she suspects that the certificate's integrity has been compromised (e.g. somebody has guessed the PIN).
-&lt;p&gt;
-It is recommended to use CRLs for maximum security. In the configuration dialog for certificate and CRL management, you can select where to retrieve the CRLs from.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QCheckBox" row="1" column="1">
-                            <property name="name">
-                                <cstring>warnCRLExpireCB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Warn if CRL e&amp;xpires in less than:</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Check to be warned if a CRL expires in the near future</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CRL Expires In The Near Future&lt;/h1&gt;
-If this box is checked, you will be warned if one of the CRLs you are using is about to expire in the near future.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QSpinBox" row="1" column="2">
-                            <property name="name">
-                                <cstring>warnCRLExpireSB</cstring>
-                            </property>
-                            <property name="suffix">
-                                <string> days</string>
-                            </property>
-                            <property name="maxValue">
-                                <number>999</number>
-                            </property>
-                            <property name="value">
-                                <number>7</number>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Number of days before warning</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CRL Expires In The Near Future&lt;/h1&gt;
-In this field you can specify how soon before a CRL expires you are warned about this expiry.
-&lt;p&gt;
-The recommended setting for the SPHINX environment is 7 days.
-&lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <spacer row="1" column="0">
-                            <property name="name">
-                                <cstring>Spacer1_2</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <spacer row="1" column="3">
-                            <property name="name">
-                                <cstring>Spacer8</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Expanding</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                    </grid>
-                </widget>
-                <widget class="QCheckBox">
-                    <property name="name">
-                        <cstring>alwaysEncryptToSelfCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Always encrypt &amp;to self</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have encrypted messages also encrypted using your own key.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Always encrypt to self&lt;/h1&gt;
-If this box is checked, encrypted messages sent by you will also be encrypted using your own key.
-&lt;p&gt;
-It is recommended to leave this option turned on to enable you to read the messages you have sent.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </vbox>
-        </widget>
-        <widget class="QGroupBox">
-            <property name="name">
-                <cstring>encryptionSettingsBG</cstring>
-            </property>
-            <property name="title">
-                <string>Warnings</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>warnUnencryptedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Warn when trying to send unencrypted messages</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned when sending unencrypted messages.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn When Trying To Send Unencrypted Messages&lt;/h1&gt;
-If this box is checked, you will be warned when you try to send parts of or the whole message unencrypted.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="4" column="1" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnChainCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If A Certificate In The Chain Expires&lt;/h1&gt;
-Select the minimum number of days all certificates in the chain should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0">
-                    <property name="name">
-                        <cstring>warnChainCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if a certificate in &amp;the chain expires in less than:</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for encrypting that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="3" column="1" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnReceiverCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Encryption Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the encryption certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="3" column="0">
-                    <property name="name">
-                        <cstring>warnReceiverCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if &amp;receiver certificate expires in less than:</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for encrypting that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <spacer row="3" column="3" rowspan="2" colspan="1">
-                    <property name="name">
-                        <cstring>Spacer7</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-                <widget class="QCheckBox" row="1" column="0" rowspan="2" colspan="2">
-                    <property name="name">
-                        <cstring>warnReceiverNotInCertificateCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if receiver's email address is &amp;not in certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the address is not in the certificate</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Receiver's Email Address Is Not In Certificate&lt;/h1&gt;
-If this option is checked, a warning is issued if the email address of the receiver is not contained in the certificate used for encrypting.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum security.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </grid>
-        </widget>
-        <spacer>
-            <property name="name">
-                <cstring>Spacer17</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Vertical</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Expanding</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-    </vbox>
-</widget>
-<connections>
-    <connection>
-        <sender>warnReceiverCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnReceiverCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnChainCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnChainCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>checkCertificatePathCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>alwaysCheckRootRB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>checkCertificatePathCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>pathMayEndLocallyCB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>useCRLsCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireCB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>useCRLsCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnCRLExpireCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCRLExpireSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-</connections>
-<tabstops>
-    <tabstop>encryptAllPartsRB</tabstop>
-    <tabstop>askEachPartRB</tabstop>
-    <tabstop>dontEncryptRB</tabstop>
-    <tabstop>warnUnencryptedCB</tabstop>
-    <tabstop>useCRLsCB</tabstop>
-    <tabstop>warnCRLExpireCB</tabstop>
-    <tabstop>warnCRLExpireSB</tabstop>
-    <tabstop>encryptionAlgorithmCO</tabstop>
-    <tabstop>warnReceiverCertificateExpiresCB</tabstop>
-    <tabstop>warnReceiverCertificateExpiresSB</tabstop>
-    <tabstop>warnChainCertificateExpiresCB</tabstop>
-    <tabstop>warnChainCertificateExpiresSB</tabstop>
-    <tabstop>warnReceiverNotInCertificateCB</tabstop>
-    <tabstop>storeEncryptedCB</tabstop>
-    <tabstop>checkCertificatePathCB</tabstop>
-    <tabstop>alwaysCheckRootRB</tabstop>
-    <tabstop>pathMayEndLocallyCB</tabstop>
-</tabstops>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
Index: kmail/signatureconfigurationdialog.ui
===================================================================
--- kmail/signatureconfigurationdialog.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/signatureconfigurationdialog.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,810 +0,0 @@
-<!DOCTYPE UI><UI version="3.1" stdsetdef="1">
-<class>SignatureConfigurationDialog</class>
-<widget class="QWidget">
-    <property name="name">
-        <cstring>SignatureConfigurationDialog</cstring>
-    </property>
-    <property name="geometry">
-        <rect>
-            <x>0</x>
-            <y>0</y>
-            <width>1018</width>
-            <height>519</height>
-        </rect>
-    </property>
-    <property name="caption">
-        <string>Signature Configuration</string>
-    </property>
-    <grid>
-        <property name="name">
-            <cstring>unnamed</cstring>
-        </property>
-        <widget class="QButtonGroup" row="0" column="1">
-            <property name="name">
-                <cstring>sendCertificatesBG</cstring>
-            </property>
-            <property name="title">
-                <string>Sending Certificates</string>
-            </property>
-            <vbox>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>dontSendCertificatesRB</cstring>
-                    </property>
-                    <property name="focusPolicy">
-                        <enum>NoFocus</enum>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Do not send certificates</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendYourOwnCertificateRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send &amp;your own certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendChainWithoutRootRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send certificate chain &amp;without root</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton">
-                    <property name="name">
-                        <cstring>sendChainWithRootRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Send certificate c&amp;hain with root</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects which certificates to send</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt; &lt;h1&gt;Sending Certificates&lt;/h1&gt; Without your certificate, the receiver will not be able to determine whether it was really you who sent the message or whether the message was altered by a third party. &lt;p&gt; The receiver can obtain your certificate from a central server, but you can also opt to enclose your certificate with your message. You can select whether you do not want to include a certificate at all, only your own certificate or the whole chain of certificates that certify your own certificate, including or excluding the root certificate. &lt;p&gt; It is recommended to always include at least your own certificate with the message. &lt;p&gt; This setting is a default, you can override it for each individual message. &lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </vbox>
-        </widget>
-        <spacer row="0" column="0">
-            <property name="name">
-                <cstring>Spacer1_2_2_2</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Horizontal</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Fixed</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-        <widget class="QButtonGroup" row="0" column="0" rowspan="2" colspan="1">
-            <property name="name">
-                <cstring>pinEntryBG</cstring>
-            </property>
-            <property name="title">
-                <string>Signatures</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <spacer row="1" column="2">
-                    <property name="name">
-                        <cstring>Spacer22</cstring>
-                    </property>
-                    <property name="orientation">
-                        <enum>Horizontal</enum>
-                    </property>
-                    <property name="sizeType">
-                        <enum>Expanding</enum>
-                    </property>
-                    <property name="sizeHint">
-                        <size>
-                            <width>20</width>
-                            <height>20</height>
-                        </size>
-                    </property>
-                </spacer>
-                <widget class="QRadioButton" row="2" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>signAllPartsRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Sign all message &amp;parts</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to have all message parts signed by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Sign All Message Parts By Default&lt;/h1&gt;
-If this option is selected, all parts of a message (i.e. the main message body and all attachments) are signed by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="3" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>askEachPartRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Ask &amp;before signing each part</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be asked for each part whether to sign</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Ask Before Signing Each Part&lt;/h1&gt;
-When this option is selected, you will be asked for each part of the message (i.e. the main message body as well as all attachments) individually whether you want the part to be signed.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QRadioButton" row="4" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>dontSignRB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Do no&amp;t sign messages</string>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check for not signing a message by default</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Do Not Sign Messages&lt;/h1&gt;
-If this option is selected, messages are not signed by default.
-&lt;p&gt;
-This is a default setting, you can still override it for each individual setting.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="0" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>TextLabel1</cstring>
-                    </property>
-                    <property name="text">
-                        <string>The signature certificate is configured on the &lt;em&gt;Certificates&lt;/em&gt; page.</string>
-                    </property>
-                    <property name="alignment">
-                        <set>AlignVCenter</set>
-                    </property>
-                </widget>
-                <widget class="QComboBox" row="1" column="1">
-                    <item>
-                        <property name="text">
-                            <string>RSA + SHA-1</string>
-                        </property>
-                    </item>
-                    <property name="name">
-                        <cstring>signatureAlgorithmCO</cstring>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Selects the signature algorithm</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Signature Algorithm&lt;/h1&gt;
-An algorithm is a description for the computer on how it should perform a certain task. The signature algorithm describes how the computer applies your signature key to your message so that the receiver can determine whether the message really is from you.
-&lt;p&gt;
-The selection of a certain signature algorithm determines how easy or how difficult it is to forge a message. However, all algorithms provided in the SPHINX environment are considered to be very safe. Generally, the default will work just fine here.
-&lt;p&gt;
-This setting is a default, you can override it for each individual message.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QLabel" row="1" column="0">
-                    <property name="name">
-                        <cstring>signatureAlgorithmLA</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Signature &amp;algorithm:</string>
-                    </property>
-                    <property name="alignment">
-                        <set>AlignVCenter|AlignRight</set>
-                    </property>
-                    <property name="buddy" stdset="0">
-                        <cstring>signatureAlgorithmCO</cstring>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="5" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>saveSentSigsCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>&amp;Store messages with signatures</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to store messages with their signatures</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Store Messages With Signatures&lt;/h1&gt;
-When this box is checked, sent messages are stored together with the signatures applied to them. This is recommended, because it enables you to check later whether you signed a message or a certain part of it.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QButtonGroup" row="6" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>sigCompoundModeBG</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <widget class="QLabel">
-                        <property name="name">
-                            <cstring>TextLabel4</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>1</x>
-                                <y>1</y>
-                                <width>564</width>
-                                <height>16</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Compound mode:</string>
-                        </property>
-                    </widget>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>sendSigMultiPartRB</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>28</x>
-                                <y>23</y>
-                                <width>536</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Standa&amp;rd MIME</string>
-                        </property>
-                        <property name="toolTip" stdset="0">
-                            <string>A Multipart/Signed holding Signature and signed data.</string>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>&lt;qt&gt;
-&lt;h1&gt;Multipart detached signature&lt;/h1&gt;
-When this option is selected, the signature and the signed data will be separate parts of a Multipart/Signed message part. Signed message data will be readable even by Mail User Agents not supporting the signaturing algorithm and not supporting ASN.1 decoding.
-&lt;/qt&gt;</string>
-                        </property>
-                    </widget>
-                    <widget class="QRadioButton">
-                        <property name="name">
-                            <cstring>sendSigOpaqueRB</cstring>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>28</x>
-                                <y>49</y>
-                                <width>536</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                        <property name="text">
-                            <string>Opa&amp;que (only recommended for SPHINX)</string>
-                        </property>
-                        <property name="toolTip" stdset="0">
-                            <string>Signature and signed data encoded in one ASN.1 block.</string>
-                        </property>
-                        <property name="whatsThis" stdset="0">
-                            <string>&lt;qt&gt;
-&lt;h1&gt;Opaque signed messages&lt;/h1&gt;
-When this option is selected, both the signature and the signed data will be encoded into one ASN.1 block. Messages will be readable only by Mail User Agents supporting ASN.1 decoding.
-&lt;/qt&gt;</string>
-                        </property>
-                    </widget>
-                    <spacer>
-                        <property name="name">
-                            <cstring>Spacer1_2_2</cstring>
-                        </property>
-                        <property name="orientation">
-                            <enum>Horizontal</enum>
-                        </property>
-                        <property name="sizeType">
-                            <enum>Fixed</enum>
-                        </property>
-                        <property name="sizeHint">
-                            <size>
-                                <width>20</width>
-                                <height>20</height>
-                            </size>
-                        </property>
-                        <property name="geometry">
-                            <rect>
-                                <x>0</x>
-                                <y>20</y>
-                                <width>20</width>
-                                <height>20</height>
-                            </rect>
-                        </property>
-                    </spacer>
-                </widget>
-                <widget class="QButtonGroup" row="7" column="0" rowspan="1" colspan="3">
-                    <property name="name">
-                        <cstring>ButtonGroup15</cstring>
-                    </property>
-                    <property name="frameShape">
-                        <enum>NoFrame</enum>
-                    </property>
-                    <property name="title">
-                        <string></string>
-                    </property>
-                    <grid>
-                        <property name="name">
-                            <cstring>unnamed</cstring>
-                        </property>
-                        <property name="margin">
-                            <number>0</number>
-                        </property>
-                        <widget class="QLabel" row="0" column="0" rowspan="1" colspan="4">
-                            <property name="name">
-                                <cstring>TextLabel5</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Entering PIN is required:</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="3" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAddCertificatesRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>When adding certificates</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="1" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinOncePerSessionRB</cstring>
-                            </property>
-                            <property name="focusPolicy">
-                                <enum>NoFocus</enum>
-                            </property>
-                            <property name="text">
-                                <string>Once per session</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="4" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAlwaysWhenSigningRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always when signing</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QRadioButton" row="2" column="1" rowspan="1" colspan="3">
-                            <property name="name">
-                                <cstring>pinAlwaysRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>Always</string>
-                            </property>
-                            <property name="checked">
-                                <bool>true</bool>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <spacer row="3" column="0">
-                            <property name="name">
-                                <cstring>Spacer1_2_2_3</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Fixed</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                        <widget class="QRadioButton" row="5" column="1">
-                            <property name="name">
-                                <cstring>pinIntervalRB</cstring>
-                            </property>
-                            <property name="text">
-                                <string>After</string>
-                            </property>
-                            <property name="toolTip" stdset="0">
-                                <string>Select how often the PIN must be entered</string>
-                            </property>
-                            <property name="whatsThis" stdset="0">
-                                <string>&lt;qt&gt; &lt;h1&gt;PIN Entry&lt;/h1&gt; Here, you can select how often you need to enter the PIN in order to access your personal security environment (PSE) that contains your certificates. &lt;p&gt; The more often you need to enter your PIN, the more protected you are against email messages being forged in your name, but the more inconvenient operations will be. &lt;p&gt; If you are unsure what to select here, leave this option as it is. &lt;p&gt; Note that it is not possible to turn off PIN entry entirely for security reasons. &lt;/qt&gt;</string>
-                            </property>
-                        </widget>
-                        <widget class="QSpinBox" row="5" column="2">
-                            <property name="name">
-                                <cstring>pinIntervalSB</cstring>
-                            </property>
-                            <property name="enabled">
-                                <bool>false</bool>
-                            </property>
-                            <property name="suffix">
-                                <string> min</string>
-                            </property>
-                            <property name="value">
-                                <number>10</number>
-                            </property>
-                        </widget>
-                        <spacer row="5" column="3">
-                            <property name="name">
-                                <cstring>Spacer29</cstring>
-                            </property>
-                            <property name="orientation">
-                                <enum>Horizontal</enum>
-                            </property>
-                            <property name="sizeType">
-                                <enum>Expanding</enum>
-                            </property>
-                            <property name="sizeHint">
-                                <size>
-                                    <width>20</width>
-                                    <height>20</height>
-                                </size>
-                            </property>
-                        </spacer>
-                    </grid>
-                </widget>
-            </grid>
-        </widget>
-        <widget class="QGroupBox" row="1" column="1">
-            <property name="name">
-                <cstring>signatureSettingsBG</cstring>
-            </property>
-            <property name="title">
-                <string>Warnings</string>
-            </property>
-            <grid>
-                <property name="name">
-                    <cstring>unnamed</cstring>
-                </property>
-                <property name="margin">
-                    <number>11</number>
-                </property>
-                <property name="spacing">
-                    <number>6</number>
-                </property>
-                <widget class="QCheckBox" row="0" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnUnsignedCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn when trying to send &amp;unsigned messages</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned when sending unsigned messages.</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn When Trying To Send Unsigned Messages&lt;/h1&gt;
-If this box is checked, you will be warned when you try to send parts of or the whole message unsigned.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="3" column="0">
-                    <property name="name">
-                        <cstring>warnCACertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if CA certificate e&amp;xpires in less than:</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="2" column="1">
-                    <property name="name">
-                        <cstring>warnSignatureCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Signature Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the signature certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="2" column="0">
-                    <property name="name">
-                        <cstring>warnSignatureCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if s&amp;ignature certificate expires in less than:</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="4" column="0">
-                    <property name="name">
-                        <cstring>warnRootCertificateExpiresCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if root certificate expires in &amp;less than:</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the certificate expires soon</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Certificate Expires&lt;/h1&gt;
-If this option is checked, then you will be warned when trying to use a certificate for signing that expires within the specified amount of days.
-&lt;p&gt;
-It is recommended to keep this option turned on to avoid using certificates that expire in the near future.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="3" column="1">
-                    <property name="name">
-                        <cstring>warnCACertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If CA Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the CA certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QSpinBox" row="4" column="1">
-                    <property name="name">
-                        <cstring>warnRootCertificateExpiresSB</cstring>
-                    </property>
-                    <property name="suffix">
-                        <string> days</string>
-                    </property>
-                    <property name="maxValue">
-                        <number>999</number>
-                    </property>
-                    <property name="value">
-                        <number>14</number>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Select the number of days here</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Root Certificate Expires&lt;/h1&gt;
-Select the minimum number of days the root certificate should be valid without issuing a warning.
-&lt;p&gt;
-The recommended SPHINX setting is 14 days.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-                <widget class="QCheckBox" row="1" column="0" rowspan="1" colspan="2">
-                    <property name="name">
-                        <cstring>warnAddressNotInCertificateCB</cstring>
-                    </property>
-                    <property name="text">
-                        <string>Warn if signer's email address is &amp;not in certificate</string>
-                    </property>
-                    <property name="checked">
-                        <bool>true</bool>
-                    </property>
-                    <property name="toolTip" stdset="0">
-                        <string>Check to be warned if the address is not in the certificate</string>
-                    </property>
-                    <property name="whatsThis" stdset="0">
-                        <string>&lt;qt&gt;
-&lt;h1&gt;Warn If Signer's Email Address Is Not In Certificate&lt;/h1&gt;
-If this option is checked, a warning is issued if the email address of the signer is not contained in the certificate used for signing.
-&lt;p&gt;
-It is recommended to leave this option turned on for maximum integrity.
-&lt;/qt&gt;</string>
-                    </property>
-                </widget>
-            </grid>
-        </widget>
-        <spacer row="2" column="0">
-            <property name="name">
-                <cstring>Spacer19</cstring>
-            </property>
-            <property name="orientation">
-                <enum>Vertical</enum>
-            </property>
-            <property name="sizeType">
-                <enum>Expanding</enum>
-            </property>
-            <property name="sizeHint">
-                <size>
-                    <width>20</width>
-                    <height>20</height>
-                </size>
-            </property>
-        </spacer>
-    </grid>
-</widget>
-<connections>
-    <connection>
-        <sender>warnSignatureCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnSignatureCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnCACertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnCACertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>warnRootCertificateExpiresCB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>warnRootCertificateExpiresSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-    <connection>
-        <sender>pinIntervalRB</sender>
-        <signal>toggled(bool)</signal>
-        <receiver>pinIntervalSB</receiver>
-        <slot>setEnabled(bool)</slot>
-    </connection>
-</connections>
-<tabstops>
-    <tabstop>signAllPartsRB</tabstop>
-    <tabstop>askEachPartRB</tabstop>
-    <tabstop>dontSignRB</tabstop>
-    <tabstop>warnUnsignedCB</tabstop>
-    <tabstop>dontSendCertificatesRB</tabstop>
-    <tabstop>sendYourOwnCertificateRB</tabstop>
-    <tabstop>sendChainWithoutRootRB</tabstop>
-    <tabstop>sendChainWithRootRB</tabstop>
-    <tabstop>signatureAlgorithmCO</tabstop>
-    <tabstop>warnSignatureCertificateExpiresCB</tabstop>
-    <tabstop>warnSignatureCertificateExpiresSB</tabstop>
-    <tabstop>warnCACertificateExpiresCB</tabstop>
-    <tabstop>warnCACertificateExpiresSB</tabstop>
-    <tabstop>warnRootCertificateExpiresCB</tabstop>
-    <tabstop>warnRootCertificateExpiresSB</tabstop>
-    <tabstop>warnAddressNotInCertificateCB</tabstop>
-    <tabstop>pinOncePerSessionRB</tabstop>
-    <tabstop>pinAlwaysRB</tabstop>
-    <tabstop>pinAddCertificatesRB</tabstop>
-    <tabstop>pinAlwaysWhenSigningRB</tabstop>
-    <tabstop>pinIntervalRB</tabstop>
-    <tabstop>pinIntervalSB</tabstop>
-    <tabstop>saveSentSigsCB</tabstop>
-</tabstops>
-<layoutdefaults spacing="6" margin="11"/>
-</UI>
Index: kmail/kmfoldersearch.h
===================================================================
--- kmail/kmfoldersearch.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldersearch.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -173,7 +173,7 @@
   virtual int open(const char *owner);
   virtual int canAccess();
   virtual void sync();
-  virtual void reallyDoClose(const char *owner);
+  virtual void reallyDoClose(const char* owner);
   virtual int create();
   virtual int compact( bool );
   virtual bool isReadOnly() const;
Index: kmail/kmreadermainwin.rc
===================================================================
--- kmail/kmreadermainwin.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmreadermainwin.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui version="7" name="kmreadermainwin" >
+<kpartgui version="13" name="kmreadermainwin" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
@@ -31,16 +31,24 @@
    <Separator/>
    <Action name="reply" />
    <Action name="reply_all" />
-   <Action name="reply_author" />
-   <Action name="reply_list" />
-   <Action name="noquotereply" />
+   <Menu noMerge="1" name="reply_special" >
+     <text>Reply Special</text>
+     <Action name="reply_author" />
+     <Action name="reply_list" />
+     <Action name="noquotereply" />
+   </Menu>
    <Menu name="menubar_message_forward">
      <text>&amp;Forward</text>
-     <Action name="message_forward_as_attachment" />
-     <Action name="message_forward_inline" />
-     <Action name="message_forward_as_digest" />
-     <Action name="message_forward_redirect" />
+     <ActionList name="forward_action_list"/>
    </Menu>
+   <Action name="send_again" />
+   <Action name="edit"/>
+   <Separator/>
+   <Action name="copy_to" />
+   <Separator/>
+   <Action name="set_status" />
+   <Separator/>
+   <Action name="create_todo"/>
   </Menu>
   <Menu noMerge="1" name="settings">
    <text>&amp;Settings</text>
@@ -59,5 +67,9 @@
   <Action name="message_forward"/>
   <Separator/>
   <Action name="move_to_trash" />
+  <Action name="create_todo"/>
+  <Separator/>
+  <Action name="text_font" />
+  <Action name="text_size" />
  </ToolBar>
 </kpartgui>
Index: kmail/searchwindow.h
===================================================================
--- kmail/searchwindow.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/searchwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -99,6 +99,8 @@
    */
   KMMessage* message();
 
+  void setSearchPattern( const KMSearchPattern& pattern );
+
 protected slots:
   /** Update status line widget. */
   virtual void updStatus(void);
Index: kmail/kmfilterdlg.cpp
===================================================================
--- kmail/kmfilterdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfilterdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,8 @@
 #include "kmmainwidget.h"
 #include "accountmanager.h"
 using KMail::AccountManager;
+#include "filterimporterexporter.h"
+using KMail::FilterImporterExporter;
 
 // other KDE headers:
 #include <kmessagebox.h>
@@ -123,14 +125,20 @@
 //=============================================================================
 
 KMFilterDlg::KMFilterDlg(QWidget* parent, const char* name, bool popFilter, bool createDummyFilter )
-  : KDialogBase( parent, name, FALSE /* modality */,
+  : KDialogBase( parent, name,  false  /* modality */,
 		 (popFilter)? i18n("POP3 Filter Rules"): i18n("Filter Rules") /* caption*/,
-		 Help|Ok|Apply|Cancel /* button mask */,
-		 Ok /* default btn */, FALSE /* separator */),
+		 Help|Ok|Apply|Cancel|User1|User2 /* button mask */,
+		 Ok /* default btn */,  false  /* separator */),
   bPopFilter(popFilter)
 {
   KWin::setIcons( winId(), kapp->icon(), kapp->miniIcon() );
   setHelp( (bPopFilter)? KMPopFilterDlgHelpAnchor: KMFilterDlgHelpAnchor );
+  setButtonText( User1, i18n("Import") );
+  setButtonText( User2, i18n("Export") );
+  connect( this, SIGNAL(user1Clicked()),
+           this, SLOT( slotImportFilters()) );
+  connect( this, SIGNAL(user2Clicked()),
+           this, SLOT( slotExportFilters()) );
 
   QWidget *w = new QWidget( this );
   setMainWidget( w );
@@ -360,7 +368,7 @@
 
   if (bPopFilter){
     mActionGroup->setAction( aFilter->action() );
-    mGlobalsBox->setEnabled(true);
+    mGlobalsBox->setEnabled( true );
     mShowLaterBtn->setChecked(mFilterList->showLaterMsgs());
   } else {
     mActionLister->setActionList( aFilter->actions() );
@@ -569,7 +577,7 @@
   : QGroupBox( 1, Horizontal, title, parent, name ),
     bPopFilter(popFilter)
 {
-  mFilterList.setAutoDelete(TRUE);
+  mFilterList.setAutoDelete( true );
   mIdxSelItem = -1;
 
   //----------- the list box
@@ -612,10 +620,10 @@
   mBtnNew->setPixmap( BarIcon( "filenew", KIcon::SizeSmall ) );
   mBtnNew->setMinimumSize( mBtnNew->sizeHint() * 1.2 );
   mBtnCopy = new QPushButton( QString::null, hb );
-  mBtnCopy->setPixmap( BarIcon( "editcopy", KIcon::SizeSmall ) );
+  mBtnCopy->setIconSet( BarIconSet( "editcopy", KIcon::SizeSmall ) );
   mBtnCopy->setMinimumSize( mBtnCopy->sizeHint() * 1.2 );
   mBtnDelete = new QPushButton( QString::null, hb );
-  mBtnDelete->setPixmap( BarIcon( "editdelete", KIcon::SizeSmall ) );
+  mBtnDelete->setIconSet( BarIconSet( "editdelete", KIcon::SizeSmall ) );
   mBtnDelete->setMinimumSize( mBtnDelete->sizeHint() * 1.2 );
   mBtnRename = new QPushButton( i18n("Rename..."), hb );
   QToolTip::add( mBtnNew, i18n("New") );
@@ -700,9 +708,9 @@
 
   if ( displayedName == shouldBeName ) return;
 
-  mListBox->blockSignals(TRUE);
+  mListBox->blockSignals( true );
   mListBox->changeItem( shouldBeName, mIdxSelItem );
-  mListBox->blockSignals(FALSE);
+  mListBox->blockSignals( false );
 }
 
 void KMFilterListBox::slotShowLaterToggled(bool aOn)
@@ -712,8 +720,10 @@
 
 void KMFilterListBox::slotApplyFilterChanges()
 {
-  if ( mIdxSelItem >= 0 )
+  if ( mIdxSelItem >= 0 ) {
+    emit applyWidgets();
     slotSelected( mListBox->currentItem() );
+  }
 
   // by now all edit widgets should have written back
   // their widget's data into our filter list.
@@ -724,26 +734,11 @@
   else
     fm = kmkernel->filterMgr();
 
-  QValueList<KMFilter*> newFilters;
-  QStringList emptyFilters;
-  QPtrListIterator<KMFilter> it( mFilterList );
-  for ( it.toFirst() ; it.current() ; ++it ) {
-    KMFilter *f = new KMFilter( **it ); // deep copy
-    f->purify();
-    if ( !f->isEmpty() )
-      // the filter is valid:
-      newFilters.append( f );
-    else {
-      // the filter is invalid:
-      emptyFilters << f->name();
-      delete f;
-    }
-  }
+  QValueList<KMFilter*> newFilters = filtersForSaving();
+
   if (bPopFilter)
     fm->setShowLaterMsgs(mShowLater);
 
-  // block attemts to use filters (currently a no-op)
-  fm->beginUpdate();
   fm->setFilters( newFilters );
   if (fm->atLeastOneOnlineImapFolderTarget()) {
     QString str = i18n("At least one filter targets a folder on an online "
@@ -753,18 +748,36 @@
     KMessageBox::information( this, str, QString::null,
 			      "filterDlgOnlineImapCheck" );
   }
-  // allow usage of the filters again.
-  fm->endUpdate();
-  fm->writeConfig();
+}
 
-  // report on invalid filters:
-  if ( !emptyFilters.empty() ) {
-    QString msg = i18n("The following filters have not been saved because they "
-		       "were invalid (e.g. containing no actions or no search "
-		       "rules).");
-    KMessageBox::informationList( 0, msg, emptyFilters, QString::null,
-				  "ShowInvalidFilterWarning" );
-  }
+QValueList<KMFilter*> KMFilterListBox::filtersForSaving() const
+{
+      const_cast<KMFilterListBox*>( this )->applyWidgets(); // signals aren't const
+      QValueList<KMFilter*> filters;
+      QStringList emptyFilters;
+      QPtrListIterator<KMFilter> it( mFilterList );
+      for ( it.toFirst() ; it.current() ; ++it ) {
+        KMFilter *f = new KMFilter( **it ); // deep copy
+        f->purify();
+        if ( !f->isEmpty() )
+          // the filter is valid:
+          filters.append( f );
+        else {
+          // the filter is invalid:
+          emptyFilters << f->name();
+          delete f;
+        }
+      }
+
+      // report on invalid filters:
+      if ( !emptyFilters.empty() ) {
+        QString msg = i18n("The following filters have not been saved because they "
+                   "were invalid (e.g. containing no actions or no search "
+                   "rules).");
+        KMessageBox::informationList( 0, msg, emptyFilters, QString::null,
+                      "ShowInvalidFilterWarning" );
+      }
+      return filters;
 }
 
 void KMFilterListBox::slotSelected( int aIdx )
@@ -817,7 +830,7 @@
   int oIdxSelItem = mIdxSelItem;
   mIdxSelItem = -1;
   // unselect all
-  mListBox->selectAll(FALSE);
+  mListBox->selectAll( false );
   // broadcast that all widgets let go
   // of the filter
   emit resetWidgets();
@@ -831,11 +844,11 @@
   // and set the new current item.
   if ( count > oIdxSelItem )
     // oIdxItem is still a valid index
-    mListBox->setSelected( oIdxSelItem, TRUE );
+    mListBox->setSelected( oIdxSelItem, true );
   else if ( count )
     // oIdxSelIdx is no longer valid, but the
     // list box isn't empty
-    mListBox->setSelected( count - 1, TRUE );
+    mListBox->setSelected( count - 1, true );
   // the list is empty - keep index -1
 
   enableControls();
@@ -908,7 +921,7 @@
     return;
   }
 
-  bool okPressed = FALSE;
+  bool okPressed =  false ;
   KMFilter *filter = mFilterList.at( mIdxSelItem );
 
   // enableControls should make sure this method is
@@ -963,10 +976,11 @@
 void KMFilterListBox::loadFilterList( bool createDummyFilter )
 {
   assert(mListBox);
-  setEnabled(FALSE);
+  setEnabled( false );
+  emit resetWidgets();
   // we don't want the insertion to
   // cause flicker in the edit widgets.
-  blockSignals(TRUE);
+  blockSignals( true );
 
   // clear both lists
   mFilterList.clear();
@@ -990,8 +1004,8 @@
     mListBox->insertItem( (*it)->pattern()->name() );
   }
 
-  blockSignals(FALSE);
-  setEnabled(TRUE);
+  blockSignals( false );
+  setEnabled( true );
 
   // create an empty filter when there's none, to avoid a completely
   // disabled dialog (usability tests indicated that the new-filter
@@ -1015,17 +1029,23 @@
   if ( mIdxSelItem < 0 ) {
     // none selected -> append
     mFilterList.append( aFilter );
-    mListBox->setSelected( mListBox->count() - 1, TRUE );
+    mListBox->setSelected( mListBox->count() - 1, true );
     //    slotSelected( mListBox->count() - 1 );
   } else {
     // insert just before selected
     mFilterList.insert( mIdxSelItem, aFilter );
-    mListBox->setSelected( mIdxSelItem, TRUE );
+    mListBox->setSelected( mIdxSelItem, true );
     //    slotSelected( mIdxSelItem );
   }
 
 }
 
+void KMFilterListBox::appendFilter( KMFilter* aFilter )
+{
+    mFilterList.append( aFilter );
+    mListBox->insertItem( aFilter->pattern()->name(), -1 );
+}
+
 void KMFilterListBox::swapNeighbouringFilters( int untouchedOne, int movedOne )
 {
   // must be neighbours...
@@ -1069,9 +1089,9 @@
   : QHBox( parent, name )
 {
   int i;
-  mActionList.setAutoDelete(TRUE);
+  mActionList.setAutoDelete( true );
 
-  mComboBox = new QComboBox( FALSE, this );
+  mComboBox = new QComboBox(  false , this );
   assert( mComboBox );
   mWidgetStack = new QWidgetStack(this);
   assert( mWidgetStack );
@@ -1117,7 +1137,7 @@
 void KMFilterActionWidget::setAction( const KMFilterAction* aAction )
 {
   int i=0;
-  bool found = FALSE;
+  bool found =  false ;
   int count = mComboBox->count() - 1 ; // last entry is the empty one
   QString label = ( aAction ) ? aAction->label() : QString::null ;
 
@@ -1132,7 +1152,7 @@
       // the combo box
       mComboBox->setCurrentItem(i); // (mm) also raise the widget, but doesn't
       mWidgetStack->raiseWidget(i);
-      found = TRUE;
+      found = true;
     } else // clear the parameter widget
       mActionList.at(i)->clearParamWidget( mWidgetStack->widget(i) );
   if ( found ) return;
@@ -1185,7 +1205,7 @@
 
   mActionList = aList;
 
-  ((QWidget*)parent())->setEnabled( TRUE );
+  ((QWidget*)parent())->setEnabled( true );
 
   if ( aList->count() == 0 ) {
     slotClear();
@@ -1219,7 +1239,7 @@
 
   mActionList = 0;
   slotClear();
-  ((QWidget*)parent())->setEnabled( FALSE );
+  ((QWidget*)parent())->setEnabled(  false  );
 }
 
 QWidget* KMFilterActionWidgetLister::createWidget( QWidget *parent )
@@ -1280,11 +1300,11 @@
   blockSignals( true );
   if(!mActionMap[aAction]->isChecked())
   {
-    mActionMap[aAction]->setChecked(true);
+    mActionMap[aAction]->setChecked( true );
   }
   blockSignals( false );
 
-  setEnabled(true);
+  setEnabled( true );
 }
 
 KMPopFilterAction  KMPopFilterActionWidget::action()
@@ -1300,11 +1320,35 @@
 
 void KMPopFilterActionWidget::reset()
 {
-  blockSignals(TRUE);
-  mActionMap[Down]->setChecked( TRUE );
-  blockSignals(FALSE);
+  blockSignals( true );
+  mActionMap[Down]->setChecked( true );
+  blockSignals( false );
 
-  setEnabled( FALSE );
+  setEnabled(  false  );
 }
 
+void KMFilterDlg::slotImportFilters()
+{
+    FilterImporterExporter importer( this, bPopFilter );
+    QValueList<KMFilter*> filters = importer.importFilters();
+    // FIXME message box how many were imported?
+    if (filters.isEmpty()) return;
+
+    QValueListConstIterator<KMFilter*> it;
+
+    for ( it = filters.constBegin() ; it != filters.constEnd() ; ++it ) {
+        mFilterList->appendFilter( *it ); // no need to deep copy, ownership passes to the list
+    }
+}
+
+void KMFilterDlg::slotExportFilters()
+{
+    FilterImporterExporter exporter( this, bPopFilter );
+    QValueList<KMFilter*> filters = mFilterList->filtersForSaving();
+    exporter.exportFilters( filters );
+    QValueList<KMFilter*>::iterator it;
+    for ( it = filters.begin(); it != filters.end(); ++it )
+        delete *it;
+}
+
 #include "kmfilterdlg.moc"
Index: kmail/folderstorage.h
===================================================================
--- kmail/folderstorage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/folderstorage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -51,6 +51,7 @@
 #include <stdio.h>
 
 class KMMessage;
+class KMAccount;
 class KMFolderDir;
 class KMMsgDict; // for the rDict manipulations
 class KMMsgDictREntry;
@@ -212,9 +213,9 @@
   virtual bool canAddMsgNow(KMMessage* aMsg, int* aIndex_ret);
 
   /** Remove (first occurrence of) given message from the folder. */
-  virtual void removeMsg(int i, bool imapQuiet = FALSE);
-  virtual void removeMsg(const QPtrList<KMMsgBase>& msgList, bool imapQuiet = FALSE);
-  virtual void removeMsg(const QPtrList<KMMessage>& msgList, bool imapQuiet = FALSE);
+  virtual void removeMsg(int i, bool imapQuiet = false);
+  virtual void removeMsg(const QPtrList<KMMsgBase>& msgList, bool imapQuiet = false);
+  virtual void removeMsg(const QPtrList<KMMessage>& msgList, bool imapQuiet = false);
 
   /** Delete messages in the folder that are older than days. Return the
    * number of deleted messages. */
@@ -237,6 +238,13 @@
   /** Number of new or unread messages in this folder. */
   virtual int countUnread();
 
+  /** Total size of the contents of this folder. */
+  Q_INT64 folderSize() const;
+
+  /** Return whether the folder is close to its quota limit, which can
+   * be reflected in the UI.  */
+  virtual bool isCloseToQuota() const;
+
   /** Called by KMMsgBase::setStatus when status of a message has changed
       required to keep the number unread messages variable current. */
   virtual void msgStatusChanged( const KMMsgStatus oldStatus,
@@ -244,20 +252,21 @@
 				 int idx);
 
   /** Open folder for access.
-    Does nothing if the folder is already opened. To reopen a folder
-    call close() first.
+    open() and close() use reference counting.
     Returns zero on success and an error code equal to the c-library
-    fopen call otherwise (errno). */
-  virtual int open(const char *owner) = 0;
+    fopen call otherwise (errno).
+    @see KMFolderOpener */
+  virtual int open(const char* owner) = 0;
 
   /** Check folder for permissions
     Returns zero if readable and writable. */
   virtual int canAccess() = 0;
 
-  /** Close folder. If force is TRUE the files are closed even if
-    others still use it (e.g. other mail reader windows). */
-  void close(const char * owner, bool force=FALSE);
-  virtual void reallyDoClose(const char * owner) = 0;
+  /** Close folder. open() and close() use reference counting.
+    If @p force is true the files are closed regardless of reference count,
+    and the reference count will be set to zero. */
+  void close(const char* owner, bool force=false);
+  virtual void reallyDoClose(const char* owner) = 0;
 
   /** Try releasing @p folder if possible, something is attempting an exclusive access to it.
       Currently used for KMFolderSearch and the background tasks like expiry. */
@@ -266,7 +275,7 @@
   /** fsync buffers to disk */
   virtual void sync() = 0;
 
-  /** Test if folder is opened. */
+  /** Test if folder is opened, i.e. its reference count is greater than zero. */
   bool isOpened() const { return (mOpenCount>0); }
 
   /** Mark all new messages as unread. */
@@ -406,6 +415,8 @@
   /** Returns true if this folder can be moved */
   virtual bool isMoveable() const;
 
+  virtual KMAccount* account() const;
+
 signals:
   /** Emitted when the status, name, or associated accounts of this
     folder changed. */
@@ -480,7 +491,10 @@
    */
   void searchDone( KMFolder*, Q_UINT32, const KMSearchPattern*, bool );
 
+  /** Emitted when the folder's size changes. */
+  void folderSizeChanged();
 
+
 public slots:
   /** Incrementally update the index if possible else call writeIndex */
   virtual int updateIndex() = 0;
@@ -579,6 +593,8 @@
   virtual void clearIndex(bool autoDelete=true, bool syncDict = false) = 0;
   virtual void truncateIndex() = 0;
 
+  virtual Q_INT64 doFolderSize() const { return 0; };
+
   int mOpenCount;
   int mQuiet;
   bool mChanged :1;
@@ -595,6 +611,7 @@
   /** number of unread messages, -1 if not yet set */
   int mUnreadMsgs, mGuessedUnreadMsgs;
   int mTotalMsgs;
+  Q_INT64 mSize;
   bool mWriteConfigEnabled :1;
   /** sven: true if on destruct folder needs to be compacted. */
   bool needsCompact :1;
Index: kmail/sievejob.cpp
===================================================================
--- kmail/sievejob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/sievejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -261,7 +261,6 @@
   SieveJob * SieveJob::activate( const KURL & url ) {
     QValueStack<Command> commands;
     commands.push( Activate );
-    commands.push( Deactivate );
     return new SieveJob( url, QString::null, commands );
   }
 
Index: kmail/kmfolderdir.h
===================================================================
--- kmail/kmfolderdir.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderdir.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,7 +22,7 @@
 	       KMFolderDirType = KMStandardDir );
   virtual ~KMFolderDir();
 
-  virtual bool isDir() const { return TRUE; }
+  virtual bool isDir() const { return true; }
 
   /** Read contents of directory. */
   virtual bool reload();
@@ -40,7 +40,7 @@
    the folder is marked as a (KMail) system folder.
    Returns Folder on success. */
   virtual KMFolder* createFolder(const QString& folderName,
-				 bool sysFldr=FALSE,
+				 bool sysFldr=false,
                                  KMFolderType folderType=KMFolderTypeMbox);
 
   /** Returns folder with given name or zero if it does not exist */
Index: kmail/kmheaders.h
===================================================================
--- kmail/kmheaders.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmheaders.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -110,6 +110,14 @@
   /** Returns the index values of currently selected items */
   QValueList<int> selectedItems();
 
+  /** Returns the sernums of all selected items. */
+  QValueList<Q_UINT32> selectedSernums();
+
+  /** Returns the sernums of all visible (ie. items with expanded parent, not hidden by
+      eg. the quick search) selected items.
+  */
+  QValueList<Q_UINT32> selectedVisibleSernums();
+
   /** Returns index of message returned by last getMsg() call */
   int indexOfGetMsg (void) const { return getMsgIndex; }
 
Index: kmail/accountdialog.cpp
===================================================================
--- kmail/accountdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/accountdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -64,6 +64,9 @@
 #include "folderrequester.h"
 #include "kmmainwidget.h"
 #include "kmfolder.h"
+#include <libkpimidentities/identitymanager.h>
+#include <libkpimidentities/identitycombo.h>
+#include <libkpimidentities/identity.h>
 #include "globalsettings.h"
 
 #include <cassert>
@@ -431,7 +434,7 @@
   topLayout->addWidget( mLocal.intervalLabel, 7, 0 );
   mLocal.intervalSpin = new KIntNumInput( page );
   mLocal.intervalLabel->setBuddy( mLocal.intervalSpin );
-  mLocal.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, FALSE );
+  mLocal.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, false );
   mLocal.intervalSpin->setSuffix( i18n(" min") );
   mLocal.intervalSpin->setValue( defaultmailcheckintervalmin );
   topLayout->addWidget( mLocal.intervalSpin, 7, 1 );
@@ -448,6 +451,12 @@
   label->setBuddy( mLocal.precommand );
   topLayout->addWidget( mLocal.precommand, 9, 1 );
 
+  mLocal.identityLabel = new QLabel( i18n("Identity:"), page );
+  topLayout->addWidget( mLocal.identityLabel, 10, 0 );
+  mLocal.identityCombo = new KPIM::IdentityCombo(kmkernel->identityManager(), page );
+  mLocal.identityLabel->setBuddy( mLocal.identityCombo );
+  topLayout->addWidget( mLocal.identityCombo, 10, 1 );
+
   connect(kapp,SIGNAL(kdisplayFontChanged()),SLOT(slotFontChanged()));
 }
 
@@ -524,7 +533,7 @@
   mMaildir.intervalLabel = new QLabel( i18n("Check inter&val:"), page );
   topLayout->addWidget( mMaildir.intervalLabel, 6, 0 );
   mMaildir.intervalSpin = new KIntNumInput( page );
-  mMaildir.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, FALSE );
+  mMaildir.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, false );
   mMaildir.intervalSpin->setSuffix( i18n(" min") );
   mMaildir.intervalSpin->setValue( defaultmailcheckintervalmin );
   mMaildir.intervalLabel->setBuddy( mMaildir.intervalSpin );
@@ -541,6 +550,13 @@
   label = new QLabel( mMaildir.precommand, i18n("&Pre-command:"), page );
   topLayout->addWidget( label, 8, 0 );
 
+
+  mMaildir.identityLabel = new QLabel( i18n("Identity:"), page );
+  topLayout->addWidget( mMaildir.identityLabel, 9, 0 );
+  mMaildir.identityCombo = new KPIM::IdentityCombo(kmkernel->identityManager(), page );
+  mMaildir.identityLabel->setBuddy( mMaildir.identityCombo );
+  topLayout->addWidget( mMaildir.identityCombo, 9, 1 );
+
   connect(kapp,SIGNAL(kdisplayFontChanged()),SLOT(slotFontChanged()));
 }
 
@@ -698,7 +714,7 @@
   mPop.filterOnServerSizeSpin = new KIntNumInput ( hbox );
   mPop.filterOnServerSizeSpin->setEnabled( false );
   hbox->setStretchFactor( mPop.filterOnServerSizeSpin, 1 );
-  mPop.filterOnServerSizeSpin->setRange( 1, 10000000, 100, FALSE );
+  mPop.filterOnServerSizeSpin->setRange( 1, 10000000, 100, false );
   connect(mPop.filterOnServerSizeSpin, SIGNAL(valueChanged(int)),
           SLOT(slotFilterOnServerSizeChanged(int)));
   mPop.filterOnServerSizeSpin->setValue( 50000 );
@@ -721,7 +737,7 @@
   mPop.intervalLabel = new QLabel( i18n("Chec&k interval:"), page1 );
   grid->addWidget( mPop.intervalLabel, 13, 0 );
   mPop.intervalSpin = new KIntNumInput( page1 );
-  mPop.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, FALSE );
+  mPop.intervalSpin->setRange( GlobalSettings::self()->minimumCheckInterval(), 10000, 1, false );
   mPop.intervalSpin->setSuffix( i18n(" min") );
   mPop.intervalSpin->setValue( defaultmailcheckintervalmin );
   mPop.intervalLabel->setBuddy( mPop.intervalSpin );
@@ -739,6 +755,12 @@
   label->setBuddy(mPop.precommand);
   grid->addWidget( mPop.precommand, 15, 1 );
 
+  mPop.identityLabel = new QLabel( i18n("Identity:"), page1 );
+  grid->addWidget( mPop.identityLabel, 16, 0 );
+  mPop.identityCombo = new KPIM::IdentityCombo(kmkernel->identityManager(), page1 );
+  mPop.identityLabel->setBuddy( mPop.identityCombo );
+  grid->addWidget( mPop.identityCombo, 16, 1 );
+
   QWidget *page2 = new QWidget( tabWidget );
   tabWidget->addTab( page2, i18n("&Extras") );
   QVBoxLayout *vlay = new QVBoxLayout( page2, marginHint(), spacingHint() );
@@ -1032,7 +1054,7 @@
   mImap.intervalLabel = new QLabel( i18n("Check inter&val:"), page1 );
   grid->addWidget( mImap.intervalLabel, row, 0 );
   mImap.intervalSpin = new KIntNumInput( page1 );
-  mImap.intervalSpin->setRange( GlobalSettings::minimumCheckInterval(), 60, 1, FALSE );
+  mImap.intervalSpin->setRange( GlobalSettings::minimumCheckInterval(), 60, 1, false );
   mImap.intervalSpin->setValue( defaultmailcheckintervalmin );
   mImap.intervalSpin->setSuffix( i18n( " min" ) );
   mImap.intervalLabel->setBuddy( mImap.intervalSpin );
@@ -1047,6 +1069,13 @@
   label->setBuddy( mImap.trashCombo );
   grid->addWidget( mImap.trashCombo, row, 1 );
 
+  ++row;
+  mImap.identityLabel = new QLabel( i18n("Identity:"), page1 );
+  grid->addWidget( mImap.identityLabel, row, 0 );
+  mImap.identityCombo = new KPIM::IdentityCombo(kmkernel->identityManager(), page1 );
+  mImap.identityLabel->setBuddy( mImap.identityCombo );
+  grid->addWidget( mImap.identityCombo, row, 1 );
+
   QWidget *page2 = new QWidget( tabWidget );
   tabWidget->addTab( page2, i18n("S&ecurity") );
   QVBoxLayout *vlay = new QVBoxLayout( page2, marginHint(), spacingHint() );
@@ -1152,6 +1181,7 @@
 
     slotEnableLocalInterval( interval >= 1 );
     folderCombo = mLocal.folderCombo;
+    mLocal.identityCombo-> setCurrentIdentity( mAccount->identityId() );
   }
   else if( accountType == "pop" )
   {
@@ -1187,26 +1217,27 @@
 #endif
     mPop.includeInCheck->setChecked( !mAccount->checkExclude() );
     mPop.precommand->setText( ap.precommand() );
+    mPop.identityCombo-> setCurrentIdentity( mAccount->identityId() );
     if (ap.useSSL())
-      mPop.encryptionSSL->setChecked( TRUE );
+      mPop.encryptionSSL->setChecked( true );
     else if (ap.useTLS())
-      mPop.encryptionTLS->setChecked( TRUE );
-    else mPop.encryptionNone->setChecked( TRUE );
+      mPop.encryptionTLS->setChecked( true );
+    else mPop.encryptionNone->setChecked( true );
     if (ap.auth() == "LOGIN")
-      mPop.authLogin->setChecked( TRUE );
+      mPop.authLogin->setChecked( true );
     else if (ap.auth() == "PLAIN")
-      mPop.authPlain->setChecked( TRUE );
+      mPop.authPlain->setChecked( true );
     else if (ap.auth() == "CRAM-MD5")
-      mPop.authCRAM_MD5->setChecked( TRUE );
+      mPop.authCRAM_MD5->setChecked( true );
     else if (ap.auth() == "DIGEST-MD5")
-      mPop.authDigestMd5->setChecked( TRUE );
+      mPop.authDigestMd5->setChecked( true );
     else if (ap.auth() == "NTLM")
-      mPop.authNTLM->setChecked( TRUE );
+      mPop.authNTLM->setChecked( true );
     else if (ap.auth() == "GSSAPI")
-      mPop.authGSSAPI->setChecked( TRUE );
+      mPop.authGSSAPI->setChecked( true );
     else if (ap.auth() == "APOP")
-      mPop.authAPOP->setChecked( TRUE );
-    else mPop.authUser->setChecked( TRUE );
+      mPop.authAPOP->setChecked( true );
+    else mPop.authUser->setChecked( true );
 
     slotEnableLeaveOnServerDays( mPop.leaveOnServerDaysCheck->isEnabled() ?
                                    ap.leaveOnServerDays() >= 1 : 0);
@@ -1245,26 +1276,28 @@
       trashfolder = kmkernel->trashFolder()->idString();
     mImap.trashCombo->setFolder( trashfolder );
     slotEnableImapInterval( interval >= 1 );
+    mImap.identityCombo-> setCurrentIdentity( mAccount->identityId() );
+    //mImap.identityCombo->insertStringList( kmkernel->identityManager()->shadowIdentities() );
     if (ai.useSSL())
-      mImap.encryptionSSL->setChecked( TRUE );
+      mImap.encryptionSSL->setChecked( true );
     else if (ai.useTLS())
-      mImap.encryptionTLS->setChecked( TRUE );
-    else mImap.encryptionNone->setChecked( TRUE );
+      mImap.encryptionTLS->setChecked( true );
+    else mImap.encryptionNone->setChecked( true );
     if (ai.auth() == "CRAM-MD5")
-      mImap.authCramMd5->setChecked( TRUE );
+      mImap.authCramMd5->setChecked( true );
     else if (ai.auth() == "DIGEST-MD5")
-      mImap.authDigestMd5->setChecked( TRUE );
+      mImap.authDigestMd5->setChecked( true );
     else if (ai.auth() == "NTLM")
-      mImap.authNTLM->setChecked( TRUE );
+      mImap.authNTLM->setChecked( true );
     else if (ai.auth() == "GSSAPI")
-      mImap.authGSSAPI->setChecked( TRUE );
+      mImap.authGSSAPI->setChecked( true );
     else if (ai.auth() == "ANONYMOUS")
-      mImap.authAnonymous->setChecked( TRUE );
+      mImap.authAnonymous->setChecked( true );
     else if (ai.auth() == "PLAIN")
-      mImap.authPlain->setChecked( TRUE );
+      mImap.authPlain->setChecked( true );
     else if (ai.auth() == "LOGIN")
-      mImap.authLogin->setChecked( TRUE );
-    else mImap.authUser->setChecked( TRUE );
+      mImap.authLogin->setChecked( true );
+    else mImap.authUser->setChecked( true );
     if ( mSieveConfigEditor )
       mSieveConfigEditor->setConfig( ai.sieveConfig() );
   }
@@ -1293,26 +1326,28 @@
       trashfolder = kmkernel->trashFolder()->idString();
     mImap.trashCombo->setFolder( trashfolder );
     slotEnableImapInterval( interval >= 1 );
+    mImap.identityCombo-> setCurrentIdentity( mAccount->identityId() );
+    //mImap.identityCombo->insertStringList( kmkernel->identityManager()->shadowIdentities() );
     if (ai.useSSL())
-      mImap.encryptionSSL->setChecked( TRUE );
+      mImap.encryptionSSL->setChecked( true );
     else if (ai.useTLS())
-      mImap.encryptionTLS->setChecked( TRUE );
-    else mImap.encryptionNone->setChecked( TRUE );
+      mImap.encryptionTLS->setChecked( true );
+    else mImap.encryptionNone->setChecked( true );
     if (ai.auth() == "CRAM-MD5")
-      mImap.authCramMd5->setChecked( TRUE );
+      mImap.authCramMd5->setChecked( true );
     else if (ai.auth() == "DIGEST-MD5")
-      mImap.authDigestMd5->setChecked( TRUE );
+      mImap.authDigestMd5->setChecked( true );
     else if (ai.auth() == "GSSAPI")
-      mImap.authGSSAPI->setChecked( TRUE );
+      mImap.authGSSAPI->setChecked( true );
     else if (ai.auth() == "NTLM")
-      mImap.authNTLM->setChecked( TRUE );
+      mImap.authNTLM->setChecked( true );
     else if (ai.auth() == "ANONYMOUS")
-      mImap.authAnonymous->setChecked( TRUE );
+      mImap.authAnonymous->setChecked( true );
     else if (ai.auth() == "PLAIN")
-      mImap.authPlain->setChecked( TRUE );
+      mImap.authPlain->setChecked( true );
     else if (ai.auth() == "LOGIN")
-      mImap.authLogin->setChecked( TRUE );
-    else mImap.authUser->setChecked( TRUE );
+      mImap.authLogin->setChecked( true );
+    else mImap.authUser->setChecked( true );
     if ( mSieveConfigEditor )
       mSieveConfigEditor->setConfig( ai.sieveConfig() );
   }
@@ -1332,7 +1367,7 @@
 #endif
     mMaildir.includeInCheck->setChecked( !mAccount->checkExclude() );
     mMaildir.precommand->setText( mAccount->precommand() );
-
+    mMaildir.identityCombo-> setCurrentIdentity( mAccount->identityId() );
     slotEnableMaildirInterval( interval >= 1 );
     folderCombo = mMaildir.folderCombo;
   }
@@ -1511,7 +1546,7 @@
                                               const QStringList & ) ),
            this, SLOT( slotPopCapabilities( const QStringList &,
                                             const QStringList & ) ) );
-  mPop.checkCapabilities->setEnabled(FALSE);
+  mPop.checkCapabilities->setEnabled(false);
 }
 
 
@@ -1530,7 +1565,7 @@
                                               const QStringList & ) ),
            this, SLOT( slotImapCapabilities( const QStringList &,
                                              const QStringList & ) ) );
-  mImap.checkCapabilities->setEnabled(FALSE);
+  mImap.checkCapabilities->setEnabled(false);
 }
 
 
@@ -1779,6 +1814,8 @@
 
     mAccount->setFolder( *mFolderList.at(mLocal.folderCombo->currentItem()) );
 
+    mAccount->setIdentityId( mLocal.identityCombo->currentIdentity() );
+
   }
   else if( accountType == "pop" )
   {
@@ -1792,6 +1829,8 @@
 
     mAccount->setFolder( *mFolderList.at(mPop.folderCombo->currentItem()) );
 
+    mAccount->setIdentityId( mPop.identityCombo->currentIdentity() );
+
     initAccountForConnect();
     PopAccount &epa = *(PopAccount*)mAccount;
     epa.setUsePipelining( mPop.usePipeliningCheck->isChecked() );
@@ -1808,12 +1847,15 @@
     epa.setFilterOnServer( mPop.filterOnServerCheck->isChecked() );
     epa.setFilterOnServerCheckSize (mPop.filterOnServerSizeSpin->value() );
     epa.setPrecommand( mPop.precommand->text() );
+
   }
   else if( accountType == "imap" )
   {
     mAccount->setName( mImap.nameEdit->text() );
     mAccount->setCheckInterval( mImap.intervalCheck->isChecked() ?
                                 mImap.intervalSpin->value() : 0 );
+    mAccount->setIdentityId( mImap.identityCombo->currentIdentity() );
+
 #if 0
     mAccount->setResource( mImap.resourceCheck->isChecked() );
 #endif
@@ -1845,6 +1887,8 @@
     mAccount->setName( mImap.nameEdit->text() );
     mAccount->setCheckInterval( mImap.intervalCheck->isChecked() ?
                                 mImap.intervalSpin->value() : 0 );
+    mAccount->setIdentityId( mImap.identityCombo->currentIdentity() );
+
 #if 0
     mAccount->setResource( mImap.resourceCheck->isChecked() );
 #endif
@@ -1899,6 +1943,8 @@
     mAccount->setCheckExclude( !mMaildir.includeInCheck->isChecked() );
 
     mAccount->setPrecommand( mMaildir.precommand->text() );
+
+    mAccount->setIdentityId( mMaildir.identityCombo->currentIdentity() );
   }
 
   if ( accountType == "imap" || accountType == "cachedimap" )
@@ -1922,8 +1968,7 @@
     ai.setNamespaceToDelimiter( delimMap );
   }
 
-  kmkernel->acctMgr()->writeConfig(TRUE);
-
+  kmkernel->acctMgr()->writeConfig( true );
   // get the new account and register the new destination folder
   // this is the target folder for local or pop accounts and the root folder
   // of the account for (d)imap
@@ -2053,8 +2098,6 @@
   }
 }
 
-
-
 #if 0
 void AccountDialog::slotClearResourceAllocations()
 {
Index: kmail/kmmainwin.rc
===================================================================
--- kmail/kmmainwin.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmainwin.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
      the same menu entries at the same place in KMail and Kontact  -->
 
 <!DOCTYPE kpartgui>
-<kpartgui version="94" name="kmmainwin" >
+<kpartgui version="100" name="kmmainwin" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
@@ -30,6 +30,7 @@
    <Separator/>
    <Action name="online_status" />
    <Action name="check_mail" />
+   <Action name="favorite_check_mail"/>
    <Action name="check_mail_in" />
    <Action name="send_queued" />
    <Action name="send_queued_via" />
@@ -127,12 +128,10 @@
    </Menu>
    <Menu name="menubar_message_forward">
      <text>&amp;Forward</text>
-     <Action name="message_forward_as_attachment" />
-     <Action name="message_forward_inline" />
-     <Action name="message_forward_as_digest" />
-     <Action name="message_forward_redirect" />
+     <ActionList name="forward_action_list"/>
    </Menu>
    <Action name="send_again" />
+   <Action name="edit"/>
    <Separator/>
    <Action name="copy_to" />
    <Action name="move_to" />
@@ -146,6 +145,8 @@
      <Action name="apply_filters" />
      <ActionList name="menu_filter_actions" />
    </Menu>
+   <Separator/>
+   <Action name="create_todo"/>
   </Menu>
   <Menu noMerge="1" name="tools">
    <text>&amp;Tools</text>
@@ -199,5 +200,6 @@
   <Separator/>
   <Action name="search_messages" />
   <ActionList name="toolbar_filter_actions" />
+  <Action name="create_todo"/>
  </ToolBar>
 </kpartgui>
Index: kmail/kmacctimap.h
===================================================================
--- kmail/kmacctimap.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmacctimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -141,9 +141,9 @@
   int slotFilterMsg( KMMessage* );
 
 private:
+  int mCountRemainChecks;
   /** used to reset connection errors */
   QTimer mErrorTimer;
-  int mCountRemainChecks;
   QValueList<Q_UINT32> mFilterSerNums;
   QDict<int> mFilterSerNumsToSave;
   KMail::ActionScheduler *mScheduler;
Index: kmail/kmail_part.cpp
===================================================================
--- kmail/kmail_part.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_part.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,6 +50,7 @@
 #include <dcopclient.h>
 #include <kiconloader.h>
 #include <kdebug.h>
+#include <kstatusbar.h>
 #include <ksettings/dispatcher.h>
 
 
@@ -126,6 +127,8 @@
   topLayout->addWidget(mainWidget);
   mainWidget->setFocusPolicy(QWidget::ClickFocus);
   mStatusBar  = new KMailStatusBarExtension(this);
+  mStatusBar->addStatusBarItem( mainWidget->vacationScriptIndicator(), 2, false );
+
   new KParts::SideBarExtension( mainWidget->folderTree(),
                                 this,
                                 "KMailSidebar" );
@@ -219,6 +222,8 @@
   KParts::ReadOnlyPart::guiActivateEvent(e);
   mainWidget->initializeFilterActions();
   mainWidget->initializeFolderShortcutActions();
+  mainWidget->setupForwardingActionsList();
+  mainWidget->updateVactionScriptStatus();
 }
 
 void KMailPart::exit()
Index: kmail/klistboxdialog.h
===================================================================
--- kmail/klistboxdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/klistboxdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -16,12 +16,12 @@
                     const QString& labelText,
                     QWidget*    parent = 0,
                     const char* name   = 0,
-                    bool        modal  = TRUE );
+                    bool        modal  = true );
     ~KListBoxDialog();
-    
+
     void setLabelAbove(  const QString& label  );
     void setCommentBelow(const QString& comment);
-    
+
     QListBox* entriesLB;
 
 private slots:
Index: kmail/foldertreebase.cpp
===================================================================
--- kmail/foldertreebase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/foldertreebase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,227 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "foldertreebase.h"
+
+#include "globalsettings.h"
+#include "kmfolder.h"
+#include "kmfolderdir.h"
+#include "kmfoldertree.h"
+#include "kmheaders.h"
+#include "kmmainwidget.h"
+#include "messagecopyhelper.h"
+#include "folderstorage.h"
+
+#include <libkdepim/maillistdrag.h>
+using KPIM::MailList;
+using KPIM::MailListDrag;
+
+#include <kconfig.h>
+#include <kiconloader.h>
+#include <kpopupmenu.h>
+
+#include <qcursor.h>
+
+using namespace KMail;
+
+FolderTreeBase::FolderTreeBase(KMMainWidget *mainWidget, QWidget * parent, const char * name) :
+    KFolderTree( parent, name ),
+    mMainWidget( mainWidget )
+{
+  addAcceptableDropMimetype(MailListDrag::format(), false);
+}
+
+void FolderTreeBase::contentsDropEvent(QDropEvent * e)
+{
+  QListViewItem *item = itemAt( contentsToViewport(e->pos()) );
+  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>(item);
+  if ( fti && fti->folder() && e->provides( MailListDrag::format() ) ) {
+    int action = dndMode();
+    if ( e->source() == mMainWidget->headers()->viewport() ) {
+      // KMHeaders does copy/move itself
+      if ( action == DRAG_MOVE && fti->folder() )
+        emit folderDrop( fti->folder() );
+      else if ( action == DRAG_COPY && fti->folder() )
+        emit folderDropCopy( fti->folder() );
+    } else if ( action == DRAG_COPY || action == DRAG_MOVE ) {
+      MailList list;
+      if ( !MailListDrag::decode( e, list ) ) {
+        kdWarning() << k_funcinfo << "Could not decode drag data!" << endl;
+      } else {
+        QValueList<Q_UINT32> serNums = MessageCopyHelper::serNumListFromMailList( list );
+        new MessageCopyHelper( serNums, fti->folder(), action == DRAG_MOVE, this );
+      }
+    }
+    e->accept( true );
+  } else {
+    KFolderTree::contentsDropEvent( e );
+  }
+}
+
+int FolderTreeBase::dndMode(bool alwaysAsk)
+{
+  int action = -1;
+  int keybstate = kapp->keyboardModifiers();
+  if ( keybstate & KApplication::ControlModifier ) {
+    action = DRAG_COPY;
+  } else if ( keybstate & KApplication::ShiftModifier ) {
+    action = DRAG_MOVE;
+  } else {
+    if ( GlobalSettings::self()->showPopupAfterDnD() || alwaysAsk ) {
+      KPopupMenu *menu = new KPopupMenu( this );
+      menu->insertItem( i18n("&Move Here"), DRAG_MOVE, 0 );
+      menu->insertItem( SmallIcon("editcopy"), i18n("&Copy Here"), DRAG_COPY, 1 );
+      menu->insertSeparator();
+      menu->insertItem( SmallIcon("cancel"), i18n("C&ancel"), DRAG_CANCEL, 3 );
+      action = menu->exec( QCursor::pos(), 0 );
+    }
+    else
+      action = DRAG_MOVE;
+  }
+  return action;
+}
+
+bool FolderTreeBase::event(QEvent * e)
+{
+  if (e->type() == QEvent::ApplicationPaletteChange) {
+     readColorConfig();
+     return true;
+  }
+  return KFolderTree::event(e);
+}
+
+void FolderTreeBase::readColorConfig()
+{
+  KConfig* conf = KMKernel::config();
+  // Custom/System color support
+  KConfigGroupSaver saver(conf, "Reader");
+  QColor c1=QColor(kapp->palette().active().text());
+  QColor c2=QColor("blue");
+  QColor c4=QColor(kapp->palette().active().base());
+  QColor c5=QColor("red");
+
+  if (!conf->readBoolEntry("defaultColors",true)) {
+    mPaintInfo.colFore = conf->readColorEntry("ForegroundColor",&c1);
+    mPaintInfo.colUnread = conf->readColorEntry("UnreadMessage",&c2);
+    mPaintInfo.colBack = conf->readColorEntry("BackgroundColor",&c4);
+    mPaintInfo.colCloseToQuota = conf->readColorEntry("CloseToQuotaColor",&c5);
+  }
+  else {
+    mPaintInfo.colFore = c1;
+    mPaintInfo.colUnread = c2;
+    mPaintInfo.colBack = c4;
+    mPaintInfo.colCloseToQuota = c5;
+  }
+  QPalette newPal = kapp->palette();
+  newPal.setColor( QColorGroup::Base, mPaintInfo.colBack );
+  newPal.setColor( QColorGroup::Text, mPaintInfo.colFore );
+  setPalette( newPal );
+}
+
+bool FolderTreeBase::hideLocalInbox() const
+{
+  if ( !GlobalSettings::self()->hideLocalInbox() )
+    return false;
+  KMFolder *localInbox = kmkernel->inboxFolder();
+  assert( localInbox );
+  // check if it is empty
+  localInbox->open( "foldertreebase" );
+  if ( localInbox->count() > 0 ) {
+    localInbox->close( "foldertreebase" );
+    return false;
+  }
+  localInbox->close( "foldertreebase" );
+  // check if it has subfolders
+  if ( localInbox->child() && !localInbox->child()->isEmpty() )
+    return false;
+  // check if it is an account target
+  if ( localInbox->hasAccounts() )
+    return false;
+  return true;
+}
+
+
+void FolderTreeBase::slotUpdateCounts(KMFolder * folder, bool force /* = false*/)
+{
+ // kdDebug(5006) << "KMFolderTree::slotUpdateCounts()" << endl;
+  QListViewItem * current;
+  if (folder)
+    current = indexOfFolder(folder);
+  else
+    current = currentItem();
+  
+  KMFolderTreeItem* fti = static_cast<KMFolderTreeItem*>(current);
+
+  // sanity check
+  if (!fti) return;
+  if (!fti->folder()) fti->setTotalCount(-1);
+
+  // get the unread count
+  int count = 0;
+  if (folder && folder->noContent()) // always empty
+    count = -1;
+  else {
+    if ( fti->folder() )
+      count = fti->folder()->countUnread();
+  }
+
+  // set it
+  bool repaint = false;
+  if (fti->unreadCount() != count) {
+     fti->adjustUnreadCount( count );
+     repaint = true;
+  }
+  if (isTotalActive() || force)
+  {
+    // get the total-count
+    if (fti->folder()->noContent())
+      count = -1;
+    else {
+      // get the cached count if the folder is not open
+      count = fti->folder()->count( !fti->folder()->isOpened() );
+    }
+    // set it
+    if ( count != fti->totalCount() ) {
+      fti->setTotalCount(count);
+      repaint = true;
+    }
+  }
+  if ( isSizeActive() || force ) {
+    if ( !fti->folder()->noContent()) {
+      Q_INT64 size = folder->storage()->folderSize();
+      if ( size != fti->folderSize() ) {
+        fti->setFolderSize( size );
+        repaint = true;
+      }
+    }
+  }
+  if ( fti->folderIsCloseToQuota() != folder->storage()->isCloseToQuota() ) {
+      fti->setFolderIsCloseToQuota( folder->storage()->isCloseToQuota() );
+  }
+
+  if (fti->parent() && !fti->parent()->isOpen())
+    repaint = false; // we're not visible
+  if (repaint) {
+    fti->setNeedsRepaint( true );
+    emit triggerRefresh();
+  }
+  // tell the kernel that one of the counts has changed
+  kmkernel->messageCountChanged();
+}
+
+#include "foldertreebase.moc"
Index: kmail/expirejob.cpp
===================================================================
--- kmail/expirejob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/expirejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -73,7 +73,7 @@
   Q_ASSERT( mCancellable );
   // We must close the folder if we opened it and got interrupted
   if ( mFolderOpen && mSrcFolder && mSrcFolder->storage() )
-    mSrcFolder->storage()->close("expirejob");
+    mSrcFolder->storage()->close( "expirejob" );
   FolderJob::kill();
 }
 
@@ -102,7 +102,7 @@
 
   FolderStorage* storage = mSrcFolder->storage();
   mOpeningFolder = true; // Ignore open-notifications while opening the folder
-  storage->open("expirejob");
+  storage->open( "expirejob" );
   mOpeningFolder = false;
   mFolderOpen = true;
   mCurrentIndex = storage->count()-1;
@@ -196,7 +196,7 @@
   group.writeEntry( "Current", -1 ); // i.e. make it invalid, the serial number will be used
 
   if ( !moving ) {
-    mSrcFolder->storage()->close("expirejob");
+    mSrcFolder->storage()->close( "expirejob" );
     mFolderOpen = false;
     delete this;
   }
@@ -204,7 +204,7 @@
 
 void ExpireJob::slotMessagesMoved( KMCommand *command )
 {
-  mSrcFolder->storage()->close("expirejob");
+  mSrcFolder->storage()->close( "expirejob" );
   mFolderOpen = false;
   QString msg;
   switch ( command->result() ) {
Index: kmail/kmmainwin.cpp
===================================================================
--- kmail/kmmainwin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmainwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -62,6 +62,8 @@
   // Don't use conserveMemory() because this renders dynamic plugging
   // of actions unusable!
 
+  mKMMainWidget->setupForwardingActionsList();
+
   applyMainWindowSettings(KMKernel::config(), "Main Window");
 
   connect( KPIM::BroadcastStatus::instance(), SIGNAL( statusMsg( const QString& ) ),
@@ -173,8 +175,9 @@
   mLittleProgress->show();
 
   statusBar()->addWidget( mLittleProgress, 0 , true );
-  statusBar()->insertItem(i18n(" Initializing..."), 1, 1 );
+  statusBar()->insertItem(i18n(" Initializing..."), 1, 4 );
   statusBar()->setItemAlignment( 1, AlignLeft | AlignVCenter );
+  statusBar()->addWidget( mKMMainWidget->vacationScriptIndicator(), 1 );
   mLittleProgress->show();
 }
 
Index: kmail/imapaccountbase.cpp
===================================================================
--- kmail/imapaccountbase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/imapaccountbase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -213,7 +213,7 @@
     // read namespace - delimiter
     namespaceDelim entries = config.entryMap( config.group() );
     namespaceDelim namespaceToDelimiter;
-    for ( namespaceDelim::ConstIterator it = entries.begin(); 
+    for ( namespaceDelim::ConstIterator it = entries.begin();
           it != entries.end(); ++it ) {
       if ( it.key().startsWith( "Namespace:" ) ) {
         QString key = it.key().right( it.key().length() - 10 );
@@ -245,7 +245,7 @@
       }
     }
     QString key;
-    for ( namespaceDelim::ConstIterator it = mNamespaceToDelimiter.begin(); 
+    for ( namespaceDelim::ConstIterator it = mNamespaceToDelimiter.begin();
           it != mNamespaceToDelimiter.end(); ++it ) {
       key = "Namespace:" + it.key();
       config.writeEntry( key, it.data() );
@@ -269,7 +269,7 @@
     return m;
   }
 
-  ImapAccountBase::ConnectionState ImapAccountBase::makeConnection() 
+  ImapAccountBase::ConnectionState ImapAccountBase::makeConnection()
   {
     if ( mSlave && mSlaveConnected ) {
       return Connected;
@@ -291,7 +291,7 @@
       QString msg = i18n("You need to supply a username and a password to "
 			 "access this mailbox.");
       mPasswordDialogIsActive = true;
-      
+
       PasswordDialog dlg( msg, log, true /* store pw */, true, KMKernel::self()->mainWin() );
       dlg.setPlainCaption( i18n("Authorization Dialog") );
       dlg.addCommentLine( i18n("Account:"), name() );
@@ -372,9 +372,9 @@
       stream << (int) 'U' << url;
 
     // create the KIO-job
-    if ( makeConnection() != Connected ) 
+    if ( makeConnection() != Connected )
       return;// ## doesn't handle Connecting
-    KIO::SimpleJob *job = KIO::special(url, packedArgs, FALSE);
+    KIO::SimpleJob *job = KIO::special(url, packedArgs, false);
     KIO::Scheduler::assignJobToSlave(mSlave, job);
     jobData jd( url.url(), NULL );
     // a bit of a hack to save one slot
@@ -626,13 +626,13 @@
       }
       return;
     }
-    
+
     QByteArray packedArgs;
     QDataStream stream( packedArgs, IO_WriteOnly);
     stream << (int) 'n';
     jobData jd;
     jd.total = 1; jd.done = 0; jd.cancellable = true;
-    jd.progressItem = ProgressManager::createProgressItem( 
+    jd.progressItem = ProgressManager::createProgressItem(
         ProgressManager::getUniqueID(),
         i18n("Retrieving Namespaces"),
         QString::null, true, useSSL() || useTLS() );
@@ -675,7 +675,7 @@
     kdDebug(5006) << "namespaces fetched" << endl;
     emit namespacesFetched( map );
   }
-    
+
   //-----------------------------------------------------------------------------
   void ImapAccountBase::slotSaveNamespaces( const ImapAccountBase::nsDelimMap& map )
   {
@@ -762,7 +762,7 @@
         }
         KMessageBox::information( kmkernel->getKMMainWidget(), msg );
       }
-    } else 
+    } else
     {
       kdDebug(5006) << "migratePrefix - no migration needed" << endl;
     }
@@ -797,7 +797,7 @@
       }
     }
     return QString::null;
-  }  
+  }
 
   //-----------------------------------------------------------------------------
   QString ImapAccountBase::delimiterForNamespace( const QString& prefix )
@@ -810,12 +810,12 @@
 
     // then try if the prefix is part of a namespace
     // exclude empty namespace
-    for ( namespaceDelim::ConstIterator it = mNamespaceToDelimiter.begin(); 
+    for ( namespaceDelim::ConstIterator it = mNamespaceToDelimiter.begin();
           it != mNamespaceToDelimiter.end(); ++it ) {
       // the namespace definition sometimes contains the delimiter
       // make sure we also match this version
       QString stripped = it.key().left( it.key().length() - 1 );
-      if ( !it.key().isEmpty() && 
+      if ( !it.key().isEmpty() &&
           ( prefix.contains( it.key() ) || prefix.contains( stripped ) ) ) {
         return it.data();
       }
@@ -875,14 +875,39 @@
     const QString from = msg->from().isEmpty() ? i18n( "<unknown>" ) : msg->from();
     QString myError = "<p><b>" + i18n("Error while uploading message")
       + "</b></p><p>"
-      + i18n("Could not upload the message dated %1 from %2 with subject %3 on the server.").arg( msg->dateStr(), QStyleSheet::escape( from ), QStyleSheet::escape( subject ) )
+      + i18n("Could not upload the message dated %1 from <i>%2</i> with subject <i>%3</i> to the server.").arg( msg->dateStr(), QStyleSheet::escape( from ), QStyleSheet::escape( subject ) )
       + "</p><p>"
-      + i18n("The destination folder was %1, which has the URL %2.").arg( QStyleSheet::escape( folder->label() ), QStyleSheet::escape( jd.htmlURL() ) )
+      + i18n("The destination folder was: <b>%1</b>.").arg( QStyleSheet::escape( folder->prettyURL() ) )
       + "</p><p>"
-      + i18n("The error message from the server communication is here:") + "</p>";
+      + i18n("The server reported:") + "</p>";
     return handleJobError( job, myError );
   }
 
+  QString ImapAccountBase::prettifyQuotaError( const QString& _error, KIO::Job * job )
+  {
+      QString error = _error;
+      if ( error.find( "quota", 0, false ) == -1 ) return error;
+      // this is a quota error, prettify it a bit
+      JobIterator it = findJob( job );
+      QString quotaAsString( i18n("No detailed quota information available.") );
+      bool readOnly = false;
+      if (it != mapJobData.end()) {
+          const KMFolder * const folder = (*it).parent;
+          assert(folder);
+          const KMFolderCachedImap * const imap = dynamic_cast<const KMFolderCachedImap*>( folder->storage() );
+          if ( imap ) {
+              quotaAsString = imap->quotaInfo().toString();
+          }
+          readOnly = folder->isReadOnly();
+      }
+      error = i18n("The folder is too close to its quota limit. (%1)").arg( quotaAsString );
+      if ( readOnly ) {
+          error += i18n("\nSince you do not have write privileges on this folder, "
+                  "please ask the owner of the folder to free up some space in it.");
+      }
+      return error;
+  }
+
   //-----------------------------------------------------------------------------
   bool ImapAccountBase::handleError( int errorCode, const QString &errorMsg, KIO::Job* job, const QString& context, bool abortSync )
   {
@@ -918,9 +943,9 @@
     // check if we still display an error
     if ( !mErrorDialogIsActive && errorCode != KIO::ERR_USER_CANCELED ) {
       mErrorDialogIsActive = true;
-      QString msg = context + '\n' + KIO::buildErrorString( errorCode, errorMsg );
+      QString msg = context + '\n' + prettifyQuotaError( KIO::buildErrorString( errorCode, errorMsg ), job );
       QString caption = i18n("Error");
-      
+
       if ( jobsKilled || errorCode == KIO::ERR_COULD_NOT_LOGIN ) {
         if ( errorCode == KIO::ERR_SERVER_TIMEOUT || errorCode == KIO::ERR_CONNECTION_BROKEN ) {
           msg = i18n("The connection to the server %1 was unexpectedly closed or timed out. It will be re-established automatically if possible.").
@@ -939,10 +964,10 @@
           else
               KMessageBox::error( kapp->activeWindow(), msg, caption );
           }
-      }
-      else { // i.e. we have a chance to continue, ask the user about it
+      } else { // i.e. we have a chance to continue, ask the user about it
         if ( errors.count() >= 3 ) { // there is no detailedWarningContinueCancel... (#86517)
-          msg = QString( "<qt>") + context + errors[1] + '\n' + errors[2];
+          QString error = prettifyQuotaError( errors[1], job );
+          msg = QString( "<qt>") + context + error + '\n' + errors[2];
           caption = errors[0];
         }
         int ret = KMessageBox::warningContinueCancel( kapp->activeWindow(), msg, caption );
@@ -989,17 +1014,11 @@
     }
   }
 
-
   //-----------------------------------------------------------------------------
-  QString ImapAccountBase::jobData::htmlURL() const
-  {
-    KURL u(  url );
-    return u.htmlURL();
-  }
-
-  //-----------------------------------------------------------------------------
   void ImapAccountBase::processNewMailSingleFolder(KMFolder* folder)
   {
+    if ( mFoldersQueuedForChecking.contains( folder ) )
+      return;
     mFoldersQueuedForChecking.append(folder);
     mCheckingSingleFolder = true;
     if ( checkingMail() )
@@ -1179,10 +1198,10 @@
 
      stream << (int) 'S' << url << flags;
 
-     if ( makeConnection() != Connected ) 
+     if ( makeConnection() != Connected )
        return; // can't happen with dimap
 
-     KIO::SimpleJob *job = KIO::special(url, packedArgs, FALSE);
+     KIO::SimpleJob *job = KIO::special(url, packedArgs, false);
      KIO::Scheduler::assignJobToSlave(slave(), job);
      ImapAccountBase::jobData jd( url.url(), folder );
      jd.path = path;
@@ -1343,10 +1362,10 @@
   }
 
   //------------------------------------------------------------------------------
-  QString ImapAccountBase::createImapPath( const QString& parent, 
+  QString ImapAccountBase::createImapPath( const QString& parent,
                                            const QString& folderName )
   {
-    kdDebug(5006) << "createImapPath parent="<<parent<<", folderName="<<folderName<<endl;  
+    kdDebug(5006) << "createImapPath parent="<<parent<<", folderName="<<folderName<<endl;
     QString newName = parent;
     // strip / at the end
     if ( newName.endsWith("/") ) {
@@ -1358,7 +1377,7 @@
     if ( delim.isEmpty() ) {
       delim = "/";
     }
-    if ( !newName.isEmpty() && 
+    if ( !newName.isEmpty() &&
          !newName.endsWith( delim ) && !folderName.startsWith( delim ) ) {
       newName = newName + delim;
     }
@@ -1372,7 +1391,7 @@
   }
 
   //------------------------------------------------------------------------------
-  QString ImapAccountBase::createImapPath( FolderStorage* parent, 
+  QString ImapAccountBase::createImapPath( FolderStorage* parent,
                                            const QString& folderName )
   {
     QString path;
@@ -1384,7 +1403,7 @@
       // error
       return path;
     }
-    
+
     return createImapPath( path, folderName );
   }
 
Index: kmail/kmcomposerui.rc
===================================================================
--- kmail/kmcomposerui.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmcomposerui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-<!DOCTYPE kpartgui ><kpartgui version="30" name="kmcomposer" >
+<!DOCTYPE kpartgui ><kpartgui version="32" name="kmcomposer" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;Message</text>
@@ -23,6 +23,9 @@
    <Action name="paste_quoted" append="edit_paste_merge"/>
    <Action name="paste_att" append="edit_paste_merge"/>
    <Action name="clean_spaces" />
+   <Action name="append_signature" />
+   <Action name="prepend_signature" />
+   <Action name="insert_signature_at_cursor_position" />
    <Separator/>
    <Action name="tools_quote"/>
    <Action name="tools_unquote"/>
@@ -59,10 +62,10 @@
    <Action name="show_subject" />
    <Separator/>
    <Action name="toggle_fixedfont" />
+   <Action name="snippets" />
   </Menu>
   <Menu name="attach" >
    <text>&amp;Attach</text>
-   <Action name="append_signature" />
    <Action name="attach_public_key" />
    <Action name="attach_my_public_key" />
    <Separator/>
@@ -94,6 +97,7 @@
   <Separator/>
   <Action name="sign_message" />
   <Action name="encrypt_message" />
+  <Action name="options_select_crypto" />
  </ToolBar>
  <ToolBar noMerge="1" enable="0" name="htmlToolBar" ><text>HTML Toolbar</text>
   <Action name="text_list" />
Index: kmail/kmailicalifaceimpl.cpp
===================================================================
--- kmail/kmailicalifaceimpl.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmailicalifaceimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -54,6 +54,8 @@
 #include "kmacctcachedimap.h"
 #include "acljobs.h"
 
+#include "scalix.h"
+
 #include <mimelib/enum.h>
 #include <mimelib/utility.h>
 #include <mimelib/body.h>
@@ -126,6 +128,19 @@
   return s_folderContentsType[type].annotation;
 }
 
+ExtraFolder::ExtraFolder( KMFolder* f )
+    : folder( f )
+{
+    folder->open("kmailicaliface::extrafolder");
+}
+
+ExtraFolder::~ExtraFolder()
+{
+    if ( folder )
+        folder->close("kmailicaliface::extrafolder");
+}
+
+
 /*
   This interface has three parts to it - libkcal interface;
   kmail interface; and helper functions.
@@ -192,6 +207,8 @@
     if ( part->hasHeaders()
          && attachmentName == part->Headers().ContentDisposition().Filename().c_str() )
       return part;
+    if ( part->hasHeaders() && attachmentName == part->Headers().ContentType().Name().c_str() )
+      return part;
   }
   return 0;
 }
@@ -333,17 +350,32 @@
   return bOK;
 }
 
-static void setIcalVcardContentTypeHeader( KMMessage *msg, KMail::FolderContentsType t )
+static void setIcalVcardContentTypeHeader( KMMessage *msg, KMail::FolderContentsType t, KMFolder *folder )
 {
+  KMAcctCachedImap::GroupwareType groupwareType = KMAcctCachedImap::GroupwareKolab;
+
+  KMFolderCachedImap *imapFolder = dynamic_cast<KMFolderCachedImap*>( folder->storage() );
+  if ( imapFolder )
+    groupwareType = imapFolder->account()->groupwareType();
+
   msg->setType( DwMime::kTypeText );
   if ( t == KMail::ContentsTypeCalendar || t == KMail::ContentsTypeTask
       || t == KMail::ContentsTypeJournal ) {
     msg->setSubtype( DwMime::kSubtypeVCal );
-    msg->setHeaderField("Content-Type",
-        "text/calendar; method=REQUEST; charset=\"utf-8\"");
+
+    if ( groupwareType == KMAcctCachedImap::GroupwareKolab )
+      msg->setHeaderField("Content-Type",
+          "text/calendar; method=REQUEST; charset=\"utf-8\"");
+    else if ( groupwareType == KMAcctCachedImap::GroupwareScalix )
+      msg->setHeaderField("Content-Type",
+          "text/calendar; method=PUBLISH; charset=\"UTF-8\"");
+
   } else if ( t == KMail::ContentsTypeContact ) {
     msg->setSubtype( DwMime::kSubtypeXVCard );
-    msg->setHeaderField( "Content-Type", "Text/X-VCard; charset=\"utf-8\"" );
+    if ( groupwareType == KMAcctCachedImap::GroupwareKolab )
+      msg->setHeaderField( "Content-Type", "Text/X-VCard; charset=\"utf-8\"" );
+    else if ( groupwareType == KMAcctCachedImap::GroupwareScalix )
+      msg->setHeaderField( "Content-Type", "application/scalix-properties; charset=\"UTF-8\"" );
   } else {
     kdWarning(5006) << k_funcinfo << "Attempt to write non-groupware contents to folder" << endl;
   }
@@ -397,7 +429,7 @@
     setXMLContentTypeHeader( msg, plainTextBody );
   } else if ( storageFormat( &folder ) == StorageIcalVcard ) {
     const KMail::FolderContentsType t = folder.storage()->contentsType();
-    setIcalVcardContentTypeHeader( msg, t );
+    setIcalVcardContentTypeHeader( msg, t, &folder );
     msg->setBodyEncoded( plainTextBody.utf8() );
   } else {
     kdWarning(5006) << k_funcinfo << "Attempt to write to folder with unknown storage type" << endl;
@@ -434,6 +466,7 @@
 
     //debugBodyParts( "after addMsg", *msg );
     addFolderChange( &folder, Contents );
+    syncFolder( &folder );
   } else
     kdError(5006) << "addIncidenceKolab(): Message *NOT* saved!\n";
 
@@ -463,6 +496,7 @@
   if( msg ) {
     // Message found - delete it and return happy
     deleteMsg( msg );
+    syncFolder( f );
     rc = true;
   } else {
     kdDebug(5006) << "Message not found, cannot remove serNum " << sernum << endl;
@@ -512,7 +546,7 @@
     return aMap;
   }
 
-  f->open("incidences");
+  f->open( "incidences" );
 
   int stopIndex = nbMessages == -1 ? f->count() :
                   QMIN( f->count(), startIndex + nbMessages );
@@ -605,6 +639,39 @@
   }
 }
 
+static QString subresourceLabelForPresentation( const KMFolder * folder )
+{
+    QString label = folder->prettyURL();
+    QStringList parts = QStringList::split( QString::fromLatin1("/"), label );
+    // In the common special case of some other user's folder shared with us
+    // the url looks like "Server Name/user/$USERNAME/Folder/Name". Make
+    // those a bit nicer.
+    if ( parts[1] == QString::fromLatin1("user") ) {
+        QStringList remainder(parts);
+        remainder.pop_front();
+        remainder.pop_front();
+        remainder.pop_front();
+        label = i18n("%1's %2")
+            .arg( parts[2] )
+            .arg( remainder.join( QString::fromLatin1("/") ) );
+    }
+    // Another special case is our own folders, under the imap INBOX, make
+    // those prettier too
+    const KMFolder *parent = folder;
+    while ( parent->parent() && parent->parent()->owner() ) {
+      parent = parent->parent()->owner();
+      if ( parent->isSystemFolder() ) {
+        QStringList remainder(parts);
+        remainder.pop_front();
+        remainder.pop_front();
+        label = i18n("My %1")
+            .arg( remainder.join( QString::fromLatin1("/") ) );
+        break;
+      }
+    }
+    return label;
+}
+
 /* list all available subresources */
 QValueList<KMailICalIfaceImpl::SubResource> KMailICalIfaceImpl::subresourcesKolab( const QString& contentsType )
 {
@@ -613,7 +680,7 @@
   // Add the default one
   KMFolder* f = folderFromType( contentsType, QString::null );
   if ( f ) {
-    subResources.append( SubResource( f->location(),  f->prettyURL(),
+    subResources.append( SubResource( f->location(), subresourceLabelForPresentation( f ),
                                       !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
     kdDebug(5006) << "Adding(1) folder " << f->location() << "    " <<
       ( f->isReadOnly() ? "readonly" : "" ) << endl;
@@ -625,7 +692,7 @@
   for ( ; it.current(); ++it ){
     f = it.current()->folder;
     if ( f && f->storage()->contentsType() == t ) {
-      subResources.append( SubResource( f->location(), f->prettyURL(),
+      subResources.append( SubResource( f->location(), subresourceLabelForPresentation( f ),
                                         !f->isReadOnly(), folderIsAlarmRelevant( f ) ) );
       kdDebug(5006) << "Adding(2) folder " << f->location() << "     " <<
               ( f->isReadOnly() ? "readonly" : "" ) << endl;
@@ -731,7 +798,7 @@
     return rc;
   }
 
-  f->open("ifaceupdate");
+  f->open( "ifaceupdate" );
 
   KMMessage* msg = 0;
   if ( sernum != 0 ) {
@@ -765,7 +832,7 @@
     if ( storageFormat( f ) == StorageIcalVcard ) {
       //kdDebug(5006) << k_funcinfo << " StorageFormatIcalVcard " << endl;
       if ( !messageWasIcalVcardFormat ) {
-        setIcalVcardContentTypeHeader( newMsg, t );
+        setIcalVcardContentTypeHeader( newMsg, t, f );
       }
       newMsg->setBodyEncoded( plainTextBody.utf8() );
     } else if ( storageFormat( f ) == StorageXML ) {
@@ -806,6 +873,7 @@
       kdDebug(5006) << "forget about " << sernum << ", it's " << rc << " now" << endl;
     }
     addFolderChange( f, Contents );
+    syncFolder( f );
   } else {
     // Message not found - store it newly
     rc = addIncidenceKolab( *f, subject, plainTextBody, customHeaders,
@@ -878,6 +946,78 @@
   return url;
 }
 
+QString KMailICalIfaceImpl::attachmentMimetype( const QString & resource,
+                                                Q_UINT32 sernum,
+                                                const QString & filename )
+{
+  if( !mUseResourceIMAP )
+    return QString();
+  KMFolder* f = findResourceFolder( resource );
+  if( !f || storageFormat( f ) != StorageXML ) {
+    kdError(5006) << "attachmentMimetype(" << resource << ") : Wrong folder" << endl;
+    return QString();
+  }
+
+  KMMessage* msg = findMessageBySerNum( sernum, f );
+  if( msg ) {
+    // Message found - look for the attachment:
+    DwBodyPart* part = findBodyPart( *msg, filename );
+    if ( part ) {
+      KMMessagePart kmPart;
+      msg->bodyPart( part, &kmPart );
+      return QString( kmPart.typeStr() ) + "/" + QString( kmPart.subtypeStr() );
+    } else {
+      kdDebug(5006) << "Attachment " << filename << " not found." << endl;
+    }
+  } else {
+    kdDebug(5006) << "Message not found." << endl;
+  }
+
+  return QString();
+}
+
+QStringList KMailICalIfaceImpl::listAttachments(const QString & resource, Q_UINT32 sernum)
+{
+  QStringList rv;
+  if( !mUseResourceIMAP )
+    return rv;
+
+  // Find the folder
+  KMFolder* f = findResourceFolder( resource );
+  if( !f ) {
+    kdError(5006) << "listAttachments(" << resource << ") : Not an IMAP resource folder" << endl;
+    return rv;
+  }
+  if ( storageFormat( f ) != StorageXML ) {
+    kdError(5006) << "listAttachment(" << resource << ") : Folder has wrong storage format " << storageFormat( f ) << endl;
+    return rv;
+  }
+
+  KMMessage* msg = findMessageBySerNum( sernum, f );
+  if( msg ) {
+    for ( DwBodyPart* part = msg->getFirstDwBodyPart(); part; part = part->Next() ) {
+      if ( part->hasHeaders() ) {
+        QString name;
+        DwMediaType& contentType = part->Headers().ContentType();
+        if ( QString( contentType.SubtypeStr().c_str() ).startsWith( "x-vnd.kolab." )
+           || QString( contentType.SubtypeStr().c_str() ).contains( "tnef" ) )
+          continue;
+        if ( !part->Headers().ContentDisposition().Filename().empty() )
+          name = part->Headers().ContentDisposition().Filename().c_str();
+        else if ( !contentType.Name().empty() )
+          name = contentType.Name().c_str();
+        if ( !name.isEmpty() )
+          rv.append( name );
+      }
+    }
+  } else {
+    kdDebug(5006) << "Message not found." << endl;
+  }
+
+  return rv;
+}
+
+
 // ============================================================================
 
 /* KMail part of the interface. These slots are connected to the resource
@@ -1090,7 +1230,7 @@
 bool KMailICalIfaceImpl::hideResourceAccountRoot( KMFolder* folder ) const
 {
   KMFolderCachedImap *dimapFolder = dynamic_cast<KMFolderCachedImap*>( folder->storage() );
-  bool hide = dimapFolder && mHideFolders 
+  bool hide = dimapFolder && mHideFolders
        && (int)dimapFolder->account()->id() == GlobalSettings::self()->theIMAPResourceAccount()
        && GlobalSettings::self()->showOnlyGroupwareFoldersForGroupwareAccount();
   return hide;
@@ -1184,6 +1324,7 @@
   KMFolder* aFolder = 0;
   int index;
   KMMsgDict::instance()->getLocation( serNum, &aFolder, &index );
+
   if( aFolder && aFolder != folder ) {
     kdWarning(5006) << "findMessageBySerNum( " << serNum << " ) found it in folder " << aFolder->location() << ", expected " << folder->location() << endl;
   } else {
@@ -1203,8 +1344,15 @@
   KMFolder *srcFolder = msg->parent();
   int idx = srcFolder->find(msg);
   assert(idx != -1);
-  srcFolder->removeMsg(idx);
-  delete msg;
+  // kill existing jobs since we are about to delete the message
+  srcFolder->ignoreJobsForMessage( msg );
+  if ( !msg->transferInProgress() ) {
+    srcFolder->removeMsg(idx);
+    delete msg;
+  } else {
+    kdDebug(5006) << k_funcinfo << "Message cannot be deleted now because it is currently in use " << msg << endl;
+    msg->deleteWhenUnused();
+  }
   addFolderChange( srcFolder, Contents );
 }
 
@@ -1263,7 +1411,7 @@
     connectFolder( folder );
   }
   // Tell about the new resource
-  subresourceAdded( folderContentsType( contentsType ), location, folder->prettyURL(),
+  subresourceAdded( folderContentsType( contentsType ), location, subresourceLabelForPresentation(folder),
                     !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 }
 
@@ -1408,7 +1556,7 @@
     const QString contentsTypeStr = folderContentsType( folder->storage()->contentsType() );
     subresourceDeleted( contentsTypeStr, location );
 
-    subresourceAdded( contentsTypeStr, location, folder->prettyURL(),
+    subresourceAdded( contentsTypeStr, location, subresourceLabelForPresentation( folder ),
                       !folder->isReadOnly(), folderIsAlarmRelevant( folder ) );
 
   }
@@ -1516,144 +1664,222 @@
     folderType = folderParent->folderType();
   }
 
-  // Make sure the folder parent has the subdirs
-  // Globally there are 3 cases: nothing found, some stuff found by type/name heuristics, or everything found OK
-  bool noneFound = true;
-  bool mustFix = false; // true when at least one was found by heuristics
-  QValueVector<StandardFolderSearchResult> results( KMail::ContentsTypeLast + 1 );
-  for ( int i = 0; i < KMail::ContentsTypeLast+1; ++i ) {
-    if ( i != KMail::ContentsTypeMail ) {
-      results[i] = findStandardResourceFolder( folderParentDir, static_cast<KMail::FolderContentsType>(i) );
-      if ( results[i].found == StandardFolderSearchResult::FoundAndStandard )
-        noneFound = false;
-      else if ( results[i].found == StandardFolderSearchResult::FoundByType ||
-                results[i].found == StandardFolderSearchResult::FoundByName ) {
-        mustFix = true;
-        noneFound = false;
-      } else // NotFound
-        mustFix = true;
+  KMAcctCachedImap::GroupwareType groupwareType = dynamic_cast<KMFolderCachedImap *>( folderParent->storage() )->account()->groupwareType();
+
+  if ( groupwareType == KMAcctCachedImap::GroupwareKolab ) {
+    // Make sure the folder parent has the subdirs
+    // Globally there are 3 cases: nothing found, some stuff found by type/name heuristics, or everything found OK
+    bool noneFound = true;
+    bool mustFix = false; // true when at least one was found by heuristics
+    QValueVector<StandardFolderSearchResult> results( KMail::ContentsTypeLast + 1 );
+    for ( int i = 0; i < KMail::ContentsTypeLast+1; ++i ) {
+      if ( i != KMail::ContentsTypeMail ) {
+        results[i] = findStandardResourceFolder( folderParentDir, static_cast<KMail::FolderContentsType>(i) );
+        if ( results[i].found == StandardFolderSearchResult::FoundAndStandard )
+          noneFound = false;
+        else if ( results[i].found == StandardFolderSearchResult::FoundByType ||
+                  results[i].found == StandardFolderSearchResult::FoundByName ) {
+          mustFix = true;
+          noneFound = false;
+        } else // NotFound
+          mustFix = true;
+      }
     }
-  }
 
-  // Check if something changed
-  if( mUseResourceIMAP && !noneFound && !mustFix && mFolderParentDir == folderParentDir
-      && mFolderType == folderType ) {
-    // Nothing changed
-    if ( hideFolders != mHideFolders ) {
-      // Well, the folder hiding has changed
-      mHideFolders = hideFolders;
-      reloadFolderTree();
+    // Check if something changed
+    if( mUseResourceIMAP && !noneFound && !mustFix && mFolderParentDir == folderParentDir
+        && mFolderType == folderType ) {
+      // Nothing changed
+      if ( hideFolders != mHideFolders ) {
+        // Well, the folder hiding has changed
+        mHideFolders = hideFolders;
+        reloadFolderTree();
+      }
+      return;
     }
-    return;
-  }
 
-  if( noneFound || mustFix ) {
-    QString msg;
-    QString parentFolderName = folderParent != 0 ? folderParent->name() : folderParentDir->name();
-    if ( noneFound ) {
-      // No subfolder was found, so ask if we can make them
-      msg = i18n("KMail will now create the required groupware folders"
-                 " as subfolders of %1; if you do not want this, cancel"
-                 " and the IMAP resource will be disabled").arg(parentFolderName);
-    } else {
-      // Some subfolders were found, be more precise
-      QString operations = "<ul>";
-      for ( int i = 0; i < KMail::ContentsTypeLast+1; ++i ) {
-        if ( i != KMail::ContentsTypeMail ) {
-          QString typeName = localizedDefaultFolderName( static_cast<KMail::FolderContentsType>( i ) );
-          if ( results[i].found == StandardFolderSearchResult::NotFound )
-            operations += "<li>" + i18n( "%1: no folder found. It will be created." ).arg( typeName ) + "</li>";
-          else if ( results[i].found == StandardFolderSearchResult::FoundByType || results[i].found == StandardFolderSearchResult::FoundByName )
-            operations += "<li>" + i18n( "%1: found folder %2. It will be set as the main groupware folder." ).
-                          arg( typeName ).arg( results[i].folder->label() ) + "</li>";
+    if( noneFound || mustFix ) {
+      QString msg;
+      QString parentFolderName = folderParent != 0 ? folderParent->name() : folderParentDir->name();
+      if ( noneFound ) {
+        // No subfolder was found, so ask if we can make them
+        msg = i18n("KMail will now create the required groupware folders"
+                   " as subfolders of %1; if you do not want this, cancel"
+                   " and the IMAP resource will be disabled").arg(parentFolderName);
+      } else {
+        // Some subfolders were found, be more precise
+        QString operations = "<ul>";
+        for ( int i = 0; i < KMail::ContentsTypeLast+1; ++i ) {
+          if ( i != KMail::ContentsTypeMail ) {
+            QString typeName = localizedDefaultFolderName( static_cast<KMail::FolderContentsType>( i ) );
+            if ( results[i].found == StandardFolderSearchResult::NotFound )
+              operations += "<li>" + i18n( "%1: no folder found. It will be created." ).arg( typeName ) + "</li>";
+            else if ( results[i].found == StandardFolderSearchResult::FoundByType || results[i].found == StandardFolderSearchResult::FoundByName )
+              operations += "<li>" + i18n( "%1: found folder %2. It will be set as the main groupware folder." ).
+                            arg( typeName ).arg( results[i].folder->label() ) + "</li>";
+          }
         }
+        operations += "</ul>";
+
+        msg = i18n("<qt>KMail found the following groupware folders in %1 and needs to perform the following operations: %2"
+                   "<br>If you do not want this, cancel"
+                   " and the IMAP resource will be disabled").arg(parentFolderName, operations);
+
       }
-      operations += "</ul>";
 
-      msg = i18n("<qt>KMail found the following groupware folders in %1 and needs to perform the following operations: %2"
-                 "<br>If you do not want this, cancel"
-                 " and the IMAP resource will be disabled").arg(parentFolderName, operations);
+      if( KMessageBox::questionYesNo( 0, msg,
+                                      i18n("Standard Groupware Folders"), KStdGuiItem::cont(), KStdGuiItem::cancel() ) == KMessageBox::No ) {
 
+        GlobalSettings::self()->setTheIMAPResourceEnabled( false );
+        mUseResourceIMAP = false;
+        mFolderParentDir = 0;
+        mFolderParent = 0;
+        reloadFolderTree();
+        return;
+      }
     }
 
-    if( KMessageBox::questionYesNo( 0, msg,
-                                    i18n("Standard Groupware Folders"), KStdGuiItem::cont(), KStdGuiItem::cancel() ) == KMessageBox::No ) {
+    // Make the new settings work
+    mUseResourceIMAP = true;
+    mFolderLanguage = GlobalSettings::self()->theIMAPResourceFolderLanguage();
+    if( mFolderLanguage > 3 ) mFolderLanguage = 0;
+    mFolderParentDir = folderParentDir;
+    mFolderParent = folderParent;
+    mFolderType = folderType;
+    mHideFolders = hideFolders;
 
-      GlobalSettings::self()->setTheIMAPResourceEnabled( false );
-      mUseResourceIMAP = false;
-      mFolderParentDir = 0;
-      mFolderParent = 0;
-      reloadFolderTree();
-      return;
+    // Close the previous folders
+    cleanup();
+
+    // Set the new folders
+    mCalendar = initFolder( KMail::ContentsTypeCalendar );
+    mTasks    = initFolder( KMail::ContentsTypeTask );
+    mJournals = initFolder( KMail::ContentsTypeJournal );
+    mContacts = initFolder( KMail::ContentsTypeContact );
+    mNotes    = initFolder( KMail::ContentsTypeNote );
+
+    // Store final annotation (with .default) so that we won't ask again on next startup
+    if ( mCalendar->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mCalendar->storage() )->updateAnnotationFolderType();
+    if ( mTasks->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mTasks->storage() )->updateAnnotationFolderType();
+    if ( mJournals->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mJournals->storage() )->updateAnnotationFolderType();
+    if ( mContacts->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mContacts->storage() )->updateAnnotationFolderType();
+    if ( mNotes->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mNotes->storage() )->updateAnnotationFolderType();
+
+    // BEGIN TILL TODO The below only uses the dimap folder manager, which
+    // will fail for all other folder types. Adjust.
+
+    kdDebug(5006) << k_funcinfo << "mCalendar=" << mCalendar << " " << mCalendar->location() << endl;
+    kdDebug(5006) << k_funcinfo << "mContacts=" << mContacts << " " << mContacts->location() << endl;
+    kdDebug(5006) << k_funcinfo << "mNotes=" << mNotes << " " << mNotes->location() << endl;
+
+    // Find all extra folders
+    QStringList folderNames;
+    QValueList<QGuardedPtr<KMFolder> > folderList;
+    kmkernel->dimapFolderMgr()->createFolderList(&folderNames, &folderList);
+    for(QValueList<QGuardedPtr<KMFolder> >::iterator it = folderList.begin();
+        it != folderList.end(); ++it)
+    {
+      FolderStorage* storage = (*it)->storage();
+      if ( storage->contentsType() != 0 ) {
+        folderContentsTypeChanged( *it, storage->contentsType() );
+      }
     }
-  }
 
-  // Make the new settings work
-  mUseResourceIMAP = true;
-  mFolderLanguage = GlobalSettings::self()->theIMAPResourceFolderLanguage();
-  if( mFolderLanguage > 3 ) mFolderLanguage = 0;
-  mFolderParentDir = folderParentDir;
-  mFolderParent = folderParent;
-  mFolderType = folderType;
-  mHideFolders = hideFolders;
+    // If we just created them, they might have been registered as extra folders temporarily.
+    // -> undo that.
+    mExtraFolders.remove( mCalendar->location() );
+    mExtraFolders.remove( mTasks->location() );
+    mExtraFolders.remove( mJournals->location() );
+    mExtraFolders.remove( mContacts->location() );
+    mExtraFolders.remove( mNotes->location() );
 
-  // Close the previous folders
-  cleanup();
+    // END TILL TODO
 
-  // Set the new folders
-  mCalendar = initFolder( KMail::ContentsTypeCalendar );
-  mTasks    = initFolder( KMail::ContentsTypeTask );
-  mJournals = initFolder( KMail::ContentsTypeJournal );
-  mContacts = initFolder( KMail::ContentsTypeContact );
-  mNotes    = initFolder( KMail::ContentsTypeNote );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label(), true, true );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label(), true, true );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label(), true, false );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label(), true, false );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label(), true, false );
+  } else if ( groupwareType == KMAcctCachedImap::GroupwareScalix ) {
+    // Make the new settings work
+    mUseResourceIMAP = true;
+    mFolderParentDir = folderParentDir;
+    mFolderParent = folderParent;
+    mFolderType = folderType;
+    mHideFolders = false;
 
-  // Store final annotation (with .default) so that we won't ask again on next startup
-  if ( mCalendar->folderType() == KMFolderTypeCachedImap )
-    static_cast<KMFolderCachedImap *>( mCalendar->storage() )->updateAnnotationFolderType();
-  if ( mTasks->folderType() == KMFolderTypeCachedImap )
-    static_cast<KMFolderCachedImap *>( mTasks->storage() )->updateAnnotationFolderType();
-  if ( mJournals->folderType() == KMFolderTypeCachedImap )
-    static_cast<KMFolderCachedImap *>( mJournals->storage() )->updateAnnotationFolderType();
-  if ( mContacts->folderType() == KMFolderTypeCachedImap )
-    static_cast<KMFolderCachedImap *>( mContacts->storage() )->updateAnnotationFolderType();
-  if ( mNotes->folderType() == KMFolderTypeCachedImap )
-    static_cast<KMFolderCachedImap *>( mNotes->storage() )->updateAnnotationFolderType();
+    // Close the previous folders
+    cleanup();
 
-  // BEGIN TILL TODO The below only uses the dimap folder manager, which
-  // will fail for all other folder types. Adjust.
+    // Set the new folders
+    mCalendar = initScalixFolder( KMail::ContentsTypeCalendar );
+    mTasks    = initScalixFolder( KMail::ContentsTypeTask );
+    mJournals = 0;
+    mContacts = initScalixFolder( KMail::ContentsTypeContact );
+    mNotes    = initScalixFolder( KMail::ContentsTypeNote );
 
-  kdDebug(5006) << k_funcinfo << "mCalendar=" << mCalendar << " " << mCalendar->location() << endl;
-  kdDebug(5006) << k_funcinfo << "mContacts=" << mContacts << " " << mContacts->location() << endl;
-  kdDebug(5006) << k_funcinfo << "mNotes=" << mNotes << " " << mNotes->location() << endl;
+    // Store final annotation (with .default) so that we won't ask again on next startup
+    if ( mCalendar->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mCalendar->storage() )->updateAnnotationFolderType();
+    if ( mTasks->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mTasks->storage() )->updateAnnotationFolderType();
+    if ( mContacts->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mContacts->storage() )->updateAnnotationFolderType();
+    if ( mNotes->folderType() == KMFolderTypeCachedImap )
+      static_cast<KMFolderCachedImap *>( mNotes->storage() )->updateAnnotationFolderType();
 
-  // Find all extra folders
-  QStringList folderNames;
-  QValueList<QGuardedPtr<KMFolder> > folderList;
-  kmkernel->dimapFolderMgr()->createFolderList(&folderNames, &folderList);
-  for(QValueList<QGuardedPtr<KMFolder> >::iterator it = folderList.begin();
-      it != folderList.end(); ++it)
-  {
-    FolderStorage* storage = (*it)->storage();
-    if ( storage->contentsType() != 0 ) {
-      folderContentsTypeChanged( *it, storage->contentsType() );
+    // BEGIN TILL TODO The below only uses the dimap folder manager, which
+    // will fail for all other folder types. Adjust.
+
+    kdDebug(5006) << k_funcinfo << "mCalendar=" << mCalendar << " " << mCalendar->location() << endl;
+    kdDebug(5006) << k_funcinfo << "mContacts=" << mContacts << " " << mContacts->location() << endl;
+    kdDebug(5006) << k_funcinfo << "mNotes=" << mNotes << " " << mNotes->location() << endl;
+
+    // Find all extra folders
+    QStringList folderNames;
+    QValueList<QGuardedPtr<KMFolder> > folderList;
+    kmkernel->dimapFolderMgr()->createFolderList(&folderNames, &folderList);
+    QValueList<QGuardedPtr<KMFolder> >::iterator it;
+    for(it = folderList.begin(); it != folderList.end(); ++it)
+    {
+      FolderStorage *storage = (*it)->storage();
+
+      if ( (*it)->folderType() == KMFolderTypeCachedImap ) {
+        KMFolderCachedImap *imapFolder = static_cast<KMFolderCachedImap*>( storage );
+
+        const QString attributes = imapFolder->folderAttributes();
+        if ( attributes.contains( "X-FolderClass" ) ) {
+          if ( !attributes.contains( "X-SpecialFolder" ) || (*it)->location().contains( "@" ) ) {
+            const Scalix::FolderAttributeParser parser( attributes );
+            if ( !parser.folderClass().isEmpty() ) {
+              FolderContentsType type = Scalix::Utils::scalixIdToContentsType( parser.folderClass() );
+              imapFolder->setContentsType( type );
+              folderContentsTypeChanged( *it, type );
+            }
+          }
+        }
+      }
     }
-  }
 
-  // If we just created them, they might have been registered as extra folders temporarily.
-  // -> undo that.
-  mExtraFolders.remove( mCalendar->location() );
-  mExtraFolders.remove( mTasks->location() );
-  mExtraFolders.remove( mJournals->location() );
-  mExtraFolders.remove( mContacts->location() );
-  mExtraFolders.remove( mNotes->location() );
+    // If we just created them, they might have been registered as extra folders temporarily.
+    // -> undo that.
+    mExtraFolders.remove( mCalendar->location() );
+    mExtraFolders.remove( mTasks->location() );
+    mExtraFolders.remove( mContacts->location() );
+    mExtraFolders.remove( mNotes->location() );
 
-  // END TILL TODO
+    // END TILL TODO
 
-  subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label(), true, true );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label(), true, true );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeJournal ), mJournals->location(), mJournals->label(), true, false );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label(), true, false );
-  subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label(), true, false );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeCalendar ), mCalendar->location(), mCalendar->label(), true, true );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeTask ), mTasks->location(), mTasks->label(), true, true );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeContact ), mContacts->location(), mContacts->label(), true, false );
+    subresourceAdded( folderContentsType( KMail::ContentsTypeNote ), mNotes->location(), mNotes->label(), true, false );
+  }
 
   reloadFolderTree();
 }
@@ -1716,6 +1942,59 @@
   return folder;
 }
 
+KMFolder* KMailICalIfaceImpl::initScalixFolder( KMail::FolderContentsType contentsType )
+{
+  // Figure out what type of folder this is supposed to be
+  KMFolderType type = mFolderType;
+  if( type == KMFolderTypeUnknown ) type = KMFolderTypeMaildir;
+
+  KMFolder* folder = 0;
+
+  // Find all extra folders
+  QStringList folderNames;
+  QValueList<QGuardedPtr<KMFolder> > folderList;
+  Q_ASSERT( kmkernel );
+  Q_ASSERT( kmkernel->dimapFolderMgr() );
+  kmkernel->dimapFolderMgr()->createFolderList(&folderNames, &folderList);
+  QValueList<QGuardedPtr<KMFolder> >::iterator it = folderList.begin();
+  for(; it != folderList.end(); ++it)
+  {
+    FolderStorage *storage = (*it)->storage();
+
+    if ( (*it)->folderType() == KMFolderTypeCachedImap ) {
+      KMFolderCachedImap *imapFolder = static_cast<KMFolderCachedImap*>( storage );
+
+      const QString attributes = imapFolder->folderAttributes();
+      if ( attributes.contains( "X-SpecialFolder" ) ) {
+        const Scalix::FolderAttributeParser parser( attributes );
+        if ( contentsType == Scalix::Utils::scalixIdToContentsType( parser.folderClass() ) ) {
+          folder = *it;
+          break;
+        }
+      }
+    }
+  }
+
+  if ( !folder ) {
+    return 0;
+  } else {
+    FolderInfo info = readFolderInfo( folder );
+    mFolderInfoMap.insert( folder, info );
+    //kdDebug(5006) << "Found existing folder type " << itemType << " : " << folder->location()  << endl;
+  }
+
+  if( folder->canAccess() != 0 ) {
+    KMessageBox::sorry(0, i18n("You do not have read/write permission to your folder.") );
+    return 0;
+  }
+  folder->storage()->setContentsType( contentsType );
+  folder->setSystemFolder( true );
+  folder->storage()->writeConfig();
+  folder->open( "scalixfolder" );
+  connectFolder( folder );
+  return folder;
+}
+
 void KMailICalIfaceImpl::connectFolder( KMFolder* folder )
 {
   // avoid multiple connections
@@ -1895,8 +2174,8 @@
     const KMFolderCachedImap *dimapFolder = static_cast<const KMFolderCachedImap*>( folder->storage() );
     administerRights =
       dimapFolder->userRights() <= 0 || dimapFolder->userRights() & KMail::ACLJobs::Administer;
-    relevantForOwner = dimapFolder->incidencesFor () == KMFolderCachedImap::IncForAdmins;
-    relevantForEveryone = ( dimapFolder->incidencesFor() == KMFolderCachedImap::IncForReaders );
+    relevantForOwner = !dimapFolder->alarmsBlocked() && ( dimapFolder->incidencesFor () == KMFolderCachedImap::IncForAdmins );
+    relevantForEveryone = !dimapFolder->alarmsBlocked() && ( dimapFolder->incidencesFor() == KMFolderCachedImap::IncForReaders );
   }
 #if 0
   kdDebug(5006) << k_funcinfo << endl;
@@ -1917,4 +2196,82 @@
   return mResourceQuiet;
 }
 
+
+bool KMailICalIfaceImpl::addSubresource( const QString& resource,
+                                         const QString& parent,
+                                         const QString& contentsType )
+{
+  kdDebug(5006) << "Adding subresource to parent: " << parent << " with name: " << resource << endl;
+  kdDebug(5006) << "contents type: " << contentsType << endl;
+  KMFolder *folder = findResourceFolder( parent );
+  KMFolderDir *parentFolderDir = !parent.isEmpty() && folder ? folder->createChildFolder(): mFolderParentDir;
+  if ( !parentFolderDir || parentFolderDir->hasNamedFolder( resource ) ) return false;
+
+  KMFolderType type = mFolderType;
+  if( type == KMFolderTypeUnknown ) type = KMFolderTypeMaildir;
+
+  KMFolder* newFolder = parentFolderDir->createFolder( resource, false, type );
+  if ( !newFolder ) return false;
+  if( mFolderType == KMFolderTypeImap )
+    static_cast<KMFolderImap*>( folder->storage() )->createFolder( resource );
+
+  StorageFormat defaultFormat = GlobalSettings::self()->theIMAPResourceStorageFormat() == GlobalSettings::EnumTheIMAPResourceStorageFormat::XML ? StorageXML : StorageIcalVcard;
+  setStorageFormat( newFolder, folder ? storageFormat( folder ) : defaultFormat );
+  newFolder->storage()->setContentsType( folderContentsType( contentsType ) );
+  newFolder->storage()->writeConfig();
+  newFolder->open( "ical_subresource" );
+  connectFolder( newFolder );
+  reloadFolderTree();
+
+  return true;
+}
+
+bool KMailICalIfaceImpl::removeSubresource( const QString& location )
+{
+  kdDebug(5006) << k_funcinfo << endl;
+
+  KMFolder *folder = findResourceFolder( location );
+
+  // We don't allow the default folders to be deleted, so check for
+  // those first. It would be nicer to produce a more meaningful error,
+  // or prevent deletion of the builtin folders from the gui already.
+  if ( !folder || isStandardResourceFolder( folder ) )
+      return false;
+
+  // the folder will be removed, which implies closed, so make sure
+  // nothing is using it anymore first
+  subresourceDeleted( folderContentsType( folder->storage()->contentsType() ), location );
+  mExtraFolders.remove( location );
+  folder->disconnect( this );
+
+  if ( folder->folderType() == KMFolderTypeImap )
+    kmkernel->imapFolderMgr()->remove( folder );
+  else if ( folder->folderType() == KMFolderTypeCachedImap ) {
+    // Deleted by user -> tell the account (see KMFolderCachedImap::listDirectory2)
+    KMFolderCachedImap* storage = static_cast<KMFolderCachedImap*>( folder->storage() );
+    KMAcctCachedImap* acct = storage->account();
+    if ( acct )
+      acct->addDeletedFolder( folder );
+    kmkernel->dimapFolderMgr()->remove( folder );
+  }
+  return true;
+}
+
+void KMailICalIfaceImpl::syncFolder(KMFolder * folder) const
+{
+  if ( kmkernel->isOffline() || !GlobalSettings::immediatlySyncDIMAPOnGroupwareChanges() )
+    return;
+  KMFolderCachedImap *dimapFolder = dynamic_cast<KMFolderCachedImap*>( folder->storage() );
+  if ( !dimapFolder )
+    return;
+  // check if the folder exists already, otherwise sync its parent as well to create it
+  if ( dimapFolder->imapPath().isEmpty() ) {
+    if ( folder->parent() && folder->parent()->owner() )
+      syncFolder( folder->parent()->owner() );
+    else
+      return;
+  }
+  dimapFolder->account()->processNewMailSingleFolder( folder );
+}
+
 #include "kmailicalifaceimpl.moc"
Index: kmail/sieveconfig.cpp
===================================================================
--- kmail/sieveconfig.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/sieveconfig.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,6 +41,8 @@
 
     mAlternateURL = config.readEntry( "sieve-alternate-url" );
     mVacationFileName = config.readEntry( "sieve-vacation-filename", "kmail-vacation.siv" );
+    if ( mVacationFileName.isEmpty() )
+      mVacationFileName = "kmail-vacation.siv";
   }
 
   void SieveConfig::writeConfig( KConfigBase & config ) const {
Index: kmail/korghelper.cpp
===================================================================
--- kmail/korghelper.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/korghelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#include "korghelper.h"
+
+#include <dcopclient.h>
+#include <dcopref.h>
+#include <kapplication.h>
+#include <kdebug.h>
+#include <kdcopservicestarter.h>
+
+void KMail::KorgHelper::ensureRunning()
+{
+  QString error;
+  QCString dcopService;
+  int result = KDCOPServiceStarter::self()->findServiceFor( "DCOP/Organizer", QString::null, QString::null, &error, &dcopService );
+  if ( result == 0 ) {
+    // OK, so korganizer (or kontact) is running. Now ensure the object we want is available
+    // [that's not the case when kontact was already running, but korganizer not loaded into it...]
+    static const char* const dcopObjectId = "KOrganizerIface";
+    QCString dummy;
+    if ( !kapp->dcopClient()->findObject( dcopService, dcopObjectId, "", QByteArray(), dummy, dummy ) ) {
+      DCOPRef ref( dcopService, dcopService ); // talk to the KUniqueApplication or its kontact wrapper
+      DCOPReply reply = ref.call( "load()" );
+      if ( reply.isValid() && (bool)reply ) {
+        kdDebug() << "Loaded " << dcopService << " successfully" << endl;
+        Q_ASSERT( kapp->dcopClient()->findObject( dcopService, dcopObjectId, "", QByteArray(), dummy, dummy ) );
+      } else
+        kdWarning() << "Error loading " << dcopService << endl;
+    }
+
+    // We don't do anything with it, we just need it to be running so that it handles
+    // the incoming directory.
+  }
+  else
+    kdWarning() << "Couldn't start DCOP/Organizer: " << dcopService << " " << error << endl;
+}
Index: kmail/kmheaders.cpp
===================================================================
--- kmail/kmheaders.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmheaders.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,7 +15,6 @@
 #include "kmmsgdict.h"
 #include "kmdebug.h"
 #include "kmfoldertree.h"
-#include "kmfolderimap.h"
 #include "folderjob.h"
 using KMail::FolderJob;
 #include "actionscheduler.h"
@@ -30,6 +29,7 @@
 #include <maillistdrag.h>
 #include "globalsettings.h"
 using namespace KPIM;
+#include "messageactions.h"
 
 #include <kapplication.h>
 #include <kaccelmanager.h>
@@ -129,7 +129,7 @@
   mPopup->setCheckable(true);
   mPopup->insertItem(i18n("Status"),          KPaintInfo::COL_STATUS);
   mPopup->insertItem(i18n("Important"),       KPaintInfo::COL_IMPORTANT);
-  mPopup->insertItem(i18n("Todo"),            KPaintInfo::COL_TODO);
+  mPopup->insertItem(i18n("Action Item"),     KPaintInfo::COL_TODO);
   mPopup->insertItem(i18n("Attachment"),      KPaintInfo::COL_ATTACHMENT);
   mPopup->insertItem(i18n("Spam/Ham"),        KPaintInfo::COL_SPAM_HAM);
   mPopup->insertItem(i18n("Watched/Ignored"), KPaintInfo::COL_WATCHED_IGNORED);
@@ -221,11 +221,6 @@
   {
     writeFolderConfig();
     writeSortOrder();
-    if (mFolder->folderType() == KMFolderTypeImap)
-    {
-      KMFolderImap *imap = static_cast<KMFolderImap*>(mFolder->storage());
-      imap->setSelected( false );
-    }
     mFolder->close("kmheaders");
   }
   writeConfig();
@@ -262,6 +257,7 @@
   bool *show = 0;
   int  *col  = 0;
   int  width = 0;
+  int moveToCol = -1;
 
   switch ( static_cast<KPaintInfo::ColumnIds>(id) )
   {
@@ -276,56 +272,72 @@
     {
       show  = &mPaintInfo.showAttachment;
       col   = &mPaintInfo.attachmentCol;
-      width = pixAttachment->width();
+      width = pixAttachment->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_IMPORTANT:
     {
       show  = &mPaintInfo.showImportant;
       col   = &mPaintInfo.importantCol;
-      width = pixFlag->width();
+      width = pixFlag->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_TODO:
     {
       show  = &mPaintInfo.showTodo;
       col   = &mPaintInfo.todoCol;
-      width = pixTodo->width();
+      width = pixTodo->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_SPAM_HAM:
     {
       show  = &mPaintInfo.showSpamHam;
       col   = &mPaintInfo.spamHamCol;
-      width = pixSpam->width();
+      width = pixSpam->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_WATCHED_IGNORED:
     {
       show  = &mPaintInfo.showWatchedIgnored;
       col   = &mPaintInfo.watchedIgnoredCol;
-      width = pixWatched->width();
+      width = pixWatched->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_STATUS:
     {
       show  = &mPaintInfo.showStatus;
       col   = &mPaintInfo.statusCol;
-      width = pixNew->width();
+      width = pixNew->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_SIGNED:
     {
       show  = &mPaintInfo.showSigned;
       col   = &mPaintInfo.signedCol;
-      width = pixFullySigned->width();
+      width = pixFullySigned->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_CRYPTO:
     {
       show  = &mPaintInfo.showCrypto;
       col   = &mPaintInfo.cryptoCol;
-      width = pixFullyEncrypted->width();
+      width = pixFullyEncrypted->width() + 8;
+      if ( *col == header()->mapToIndex( *col ) )
+        moveToCol = 0;
       break;
     }
     case KPaintInfo::COL_RECEIVER:
@@ -351,6 +363,8 @@
   if (*show) {
     header()->setResizeEnabled(true, *col);
     setColumnWidth(*col, width);
+    if ( moveToCol >= 0 )
+      header()->moveSection( *col, moveToCol );
   }
   else {
     header()->setResizeEnabled(false, *col);
@@ -688,12 +702,10 @@
     mSortInfo.removed = 0;
     mFolder = aFolder;
     mSortInfo.dirty = true;
-    mOwner->editAction()->setEnabled( mFolder ?
-                         ( kmkernel->folderIsDraftOrOutbox( mFolder ) ||
-                           kmkernel->folderIsTemplates( mFolder ) ) : false );
+
     mOwner->useAction()->setEnabled( mFolder ?
                          ( kmkernel->folderIsTemplates( mFolder ) ) : false );
-    mOwner->replyListAction()->setEnabled( mFolder ?
+    mOwner->messageActions()->replyListAction()->setEnabled( mFolder ?
                          mFolder->isMailingListEnabled() : false );
     if ( mFolder ) {
       connect(mFolder, SIGNAL(msgHeaderChanged(KMFolder*,int)),
@@ -757,7 +769,7 @@
 
     colText = i18n( "Date" );
     if (mPaintInfo.orderOfArrival)
-      colText = i18n( "Date (Order of Arrival)" );
+      colText = i18n( "Order of Arrival" );
     setColumnText( mPaintInfo.dateCol, colText);
 
     colText = i18n( "Subject" );
@@ -1173,27 +1185,7 @@
 void KMHeaders::setMsgStatus (KMMsgStatus status, bool toggle)
 {
   //  kdDebug() << k_funcinfo << endl;
-  SerNumList serNums;
-  QListViewItemIterator it(this, QListViewItemIterator::Selected|QListViewItemIterator::Visible);
-  while( it.current() ) {
-    if ( it.current()->isSelected() && it.current()->isVisible() ) {
-      if ( it.current()->parent() && ( !it.current()->parent()->isOpen() ) ) {
-        // the item's parent is closed, don't traverse any more of this subtree
-        QListViewItem * lastAncestorWithSiblings = it.current()->parent();
-        // travel towards the root until we find an ancestor with siblings
-        while ( ( lastAncestorWithSiblings->depth() > 0 ) && !lastAncestorWithSiblings->nextSibling() )
-          lastAncestorWithSiblings = lastAncestorWithSiblings->parent();
-        // move the iterator to that ancestor's next sibling
-        it = QListViewItemIterator( lastAncestorWithSiblings->nextSibling() );
-        continue;
-      }
-
-      HeaderItem *item = static_cast<HeaderItem*>(it.current());
-      KMMsgBase *msgBase = mFolder->getMsgBase(item->msgId());
-      serNums.append( msgBase->getMsgSerNum() );
-    }
-    ++it;
-  }
+  SerNumList serNums = selectedVisibleSernums();
   if (serNums.empty())
     return;
 
@@ -1369,43 +1361,56 @@
     int contentX, contentY;
     HeaderItem *nextItem = prepareMove( &contentX, &contentY );
 
-    KMMessageList* msgList = selectedMsgs();
-    if (msgList->isEmpty())
+    //prevent issues with stale message pointers by using serial numbers instead
+    QValueList<unsigned long> serNums = KMMsgDict::serNumList( *selectedMsgs() );
+    if ( serNums.isEmpty() )
       return;
+
     finalizeMove( nextItem, contentX, contentY );
-
     CREATE_TIMER(filter);
     START_TIMER(filter);
 
     KCursorSaver busy( KBusyPtr::busy() );
     int msgCount = 0;
-    int msgCountToFilter = msgList->count();
+    int msgCountToFilter = serNums.count();
     ProgressItem* progressItem =
       ProgressManager::createProgressItem( "filter"+ProgressManager::getUniqueID(),
                                            i18n( "Filtering messages" ) );
     progressItem->setTotalItems( msgCountToFilter );
-    for (KMMsgBase* msgBase=msgList->first(); msgBase; msgBase=msgList->next()) {
-      int diff = msgCountToFilter - ++msgCount;
-      if ( diff < 10 || !( msgCount % 20 ) || msgCount <= 10 ) {
+
+    for ( QValueList<unsigned long>::ConstIterator it = serNums.constBegin();
+          it != serNums.constEnd(); ++it ) {
+      msgCount++;
+      if ( msgCountToFilter - msgCount < 10 || !( msgCount % 20 ) || msgCount <= 10 ) {
         progressItem->updateProgress();
         QString statusMsg = i18n("Filtering message %1 of %2");
         statusMsg = statusMsg.arg( msgCount ).arg( msgCountToFilter );
         KPIM::BroadcastStatus::instance()->setStatusMsg( statusMsg );
         KApplication::kApplication()->eventLoop()->processEvents( QEventLoop::ExcludeUserInput, 50 );
       }
-      int idx = msgBase->parent()->find(msgBase);
-      assert(idx != -1);
-      KMMessage * msg = msgBase->parent()->getMsg(idx);
-      if (msg->transferInProgress()) continue;
-      msg->setTransferInProgress(true);
-      if ( !msg->isComplete() )
-      {
-        FolderJob *job = mFolder->createJob(msg);
-        connect(job, SIGNAL(messageRetrieved(KMMessage*)),
-                     SLOT(slotFilterMsg(KMMessage*)));
-        job->start();
+
+      KMFolder *folder = 0;
+      int idx;
+      KMMsgDict::instance()->getLocation( *it, &folder, &idx );
+      KMMessage *msg = 0;
+      if (folder)
+        msg = folder->getMsg(idx);
+      if (msg) {
+        if (msg->transferInProgress())
+          continue;
+        msg->setTransferInProgress(true);
+        if (!msg->isComplete()) {
+          FolderJob *job = mFolder->createJob(msg);
+          connect(job, SIGNAL(messageRetrieved(KMMessage*)),
+                  this, SLOT(slotFilterMsg(KMMessage*)));
+          job->start();
+        } else {
+          if (slotFilterMsg(msg) == 2)
+            break;
+        }
       } else {
-        if (slotFilterMsg(msg) == 2) break;
+        kdDebug (5006) << "####### KMHeaders::applyFiltersOnMsg -"
+                          " A message went missing during filtering " << endl;
       }
       progressItem->incCompletedItems();
     }
@@ -2010,7 +2015,12 @@
 //-----------------------------------------------------------------------------
 void KMHeaders::slotNoDrag()
 {
-  mMousePressed = false;
+  // This causes Kolab issue 1569 (encrypted mails sometimes not dragable)
+  // This was introduced in r73594 to fix interference between dnd and
+  // pinentry, which is no longer reproducable now. However, since the
+  // original problem was probably a race and might reappear, let's keep
+  // this workaround in for now and just disable it.
+//   mMousePressed = false;
 }
 
 
@@ -2078,7 +2088,7 @@
 {
     mDate.reset();
     // only reset exactly during minute switch
-    QTimer::singleShot( ( 60-QTime::currentTime().second() ) * 1000, 
+    QTimer::singleShot( ( 60-QTime::currentTime().second() ) * 1000,
         this, SLOT( resetCurrentTime() ) );
 }
 
@@ -2255,6 +2265,31 @@
     if ((e->button() == LeftButton) )
       mMousePressed = true;
   }
+
+  // check if we are on a status column and toggle it
+  if ( lvi && e->button() == LeftButton  && !( e->state() & (ShiftButton | ControlButton | AltButton | MetaButton) ) ) {
+    bool flagsToggleable = GlobalSettings::self()->allowLocalFlags() || !(mFolder ? mFolder->isReadOnly() : true);
+    int section = header()->sectionAt( e->pos().x() );
+    HeaderItem *item = static_cast<HeaderItem*>( lvi );
+    KMMsgBase *msg = mFolder->getMsgBase(item->msgId());
+    if ( section == mPaintInfo.flagCol && flagsToggleable ) {
+      setMsgStatus( KMMsgStatusFlag, true );
+    } else if ( section == mPaintInfo.importantCol && flagsToggleable ) {
+      setMsgStatus( KMMsgStatusFlag, true );
+    } else if ( section == mPaintInfo.todoCol && flagsToggleable ) {
+      setMsgStatus( KMMsgStatusTodo, true );
+    } else if ( section == mPaintInfo.watchedIgnoredCol && flagsToggleable ) {
+      if ( msg->isWatched() || msg->isIgnored() )
+        setMsgStatus( KMMsgStatusIgnored, true );
+      else
+        setMsgStatus( KMMsgStatusWatched, true );
+    } else if ( section == mPaintInfo.statusCol ) {
+      if ( msg->isUnread() || msg->isNew() )
+        setMsgStatus( KMMsgStatusRead );
+      else
+        setMsgStatus( KMMsgStatusUnread );
+    }
+  }
 }
 
 //-----------------------------------------------------------------------------
@@ -2316,7 +2351,23 @@
 void KMHeaders::slotRMB()
 {
   if (!topLevelWidget()) return; // safe bet
+  mOwner->updateMessageActions();
 
+  // check if the user clicked into a status column and only show the respective menues
+  QListViewItem *item = itemAt( viewport()->mapFromGlobal( QCursor::pos() ) );
+  if ( item ) {
+    int section = header()->sectionAt( viewportToContents( viewport()->mapFromGlobal( QCursor::pos() ) ).x() );
+    if ( section == mPaintInfo.flagCol || section == mPaintInfo.importantCol
+         || section == mPaintInfo.todoCol || section == mPaintInfo.statusCol ) {
+      mOwner->statusMenu()->popup( QCursor::pos() );
+      return;
+    }
+    if ( section == mPaintInfo.watchedIgnoredCol ) {
+      mOwner->threadStatusMenu()->popup( QCursor::pos() );
+      return;
+    }
+  }
+
   QPopupMenu *menu = new QPopupMenu(this);
 
   mMenuToFolder.clear();
@@ -2325,19 +2376,18 @@
 
   bool out_folder = kmkernel->folderIsDraftOrOutbox( mFolder );
   bool tem_folder = kmkernel->folderIsTemplates( mFolder );
-  if ( out_folder ) {
-    mOwner->editAction()->plug(menu);
-  } else if ( tem_folder ) {
+  if ( tem_folder ) {
      mOwner->useAction()->plug( menu );
-     mOwner->editAction()->plug( menu );
   } else {
     // show most used actions
     if( !mFolder->isSent() ) {
-      mOwner->replyMenu()->plug( menu );
+      mOwner->messageActions()->replyMenu()->plug( menu );
     }
     mOwner->forwardMenu()->plug( menu );
     if( mOwner->sendAgainAction()->isEnabled() ) {
       mOwner->sendAgainAction()->plug( menu );
+    } else {
+      mOwner->editAction()->plug( menu );
     }
   }
   menu->insertSeparator();
@@ -2382,6 +2432,9 @@
     if ( mOwner->trashThreadAction()->isEnabled() )
       mOwner->trashThreadAction()->plug(menu);
   }
+  menu->insertSeparator();
+  mOwner->messageActions()->createTodoAction()->plug( menu );
+
   KAcceleratorManager::manage(menu);
   kmkernel->setContextMenuShown( true );
   menu->exec(QCursor::pos(), 0);
@@ -2418,6 +2471,8 @@
 //-----------------------------------------------------------------------------
 void KMHeaders::setCurrentItemByIndex(int msgIdx)
 {
+  if (!mFolder->isOpened()) setFolder(mFolder);
+
   if ((msgIdx >= 0) && (msgIdx < (int)mItems.size())) {
     clearSelection();
     bool unchanged = (currentItem() == mItems[msgIdx]);
@@ -2426,6 +2481,7 @@
     setSelectionAnchor( currentItem() );
     if (unchanged)
        highlightMessage( mItems[msgIdx], false);
+    makeHeaderVisible();
   }
 }
 
@@ -2509,7 +2565,7 @@
 
     QString colText = i18n( "Date" );
     if (mPaintInfo.orderOfArrival)
-      colText = i18n( "Date (Order of Arrival)" );
+      colText = i18n( "Order of Arrival" );
     setColumnText( mPaintInfo.dateCol, colText);
 
     colText = i18n( "Subject" );
@@ -2929,6 +2985,8 @@
 
 bool KMHeaders::readSortOrder( bool set_selection, bool forceJumpToUnread )
 {
+    if (!mFolder->isOpened()) mFolder->open("kmheaders");
+
     //all cases
     Q_INT32 column, ascending, threaded, discovered_count, sorted_count, appended;
     Q_INT32 deleted_count = 0;
@@ -3436,4 +3494,41 @@
   return mMoveMessages && mCopiedMessages.contains( serNum );
 }
 
+QValueList< Q_UINT32 > KMHeaders::selectedSernums()
+{
+  QValueList<Q_UINT32> list;
+  for ( QListViewItemIterator it(this); it.current(); it++ ) {
+    if ( it.current()->isSelected() && it.current()->isVisible() ) {
+      HeaderItem* item = static_cast<HeaderItem*>( it.current() );
+      list.append( item->msgSerNum() );
+    }
+  }
+  return list;
+}
+
+QValueList< Q_UINT32 > KMHeaders::selectedVisibleSernums()
+{
+  QValueList<Q_UINT32> list;
+  QListViewItemIterator it(this, QListViewItemIterator::Selected|QListViewItemIterator::Visible);
+  while( it.current() ) {
+    if ( it.current()->isSelected() && it.current()->isVisible() ) {
+      if ( it.current()->parent() && ( !it.current()->parent()->isOpen() ) ) {
+        // the item's parent is closed, don't traverse any more of this subtree
+        QListViewItem * lastAncestorWithSiblings = it.current()->parent();
+        // travel towards the root until we find an ancestor with siblings
+        while ( ( lastAncestorWithSiblings->depth() > 0 ) && !lastAncestorWithSiblings->nextSibling() )
+          lastAncestorWithSiblings = lastAncestorWithSiblings->parent();
+        // move the iterator to that ancestor's next sibling
+        it = QListViewItemIterator( lastAncestorWithSiblings->nextSibling() );
+        continue;
+      }
+      HeaderItem *item = static_cast<HeaderItem*>(it.current());
+      list.append( item->msgSerNum() );
+    }
+    ++it;
+  }
+
+  return list;
+}
+
 #include "kmheaders.moc"
Index: kmail/filterimporterexporter.h
===================================================================
--- kmail/filterimporterexporter.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/filterimporterexporter.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,41 @@
+#ifndef __FILTERIMPORTEREXPORTER_H__
+#define __FILTERIMPORTEREXPORTER_H__
+
+#include <qvaluelist.h>
+
+class KMFilter;
+class KConfig;
+class QWidget;
+
+namespace KMail
+{
+
+/**
+    @short Utility class that provides persisting of filters to/from KConfig.
+    @author Till Adam <till@kdab.net>
+ */
+class FilterImporterExporter
+{
+public:
+      FilterImporterExporter( QWidget* parent, bool popFilter = false );
+      virtual ~FilterImporterExporter();
+      
+      /** Export the given filter rules to a file which 
+       * is asked from the user. The list to export is also
+       * presented for confirmation/selection. */
+      void exportFilters( const QValueList<KMFilter*> & );
+      
+      /** Import filters. Ask the user where to import them from
+       * and which filters to import. */
+      QValueList<KMFilter*> importFilters();
+      
+      static void writeFiltersToConfig( const QValueList<KMFilter*>& filters, KConfig* config, bool bPopFilter );
+      static QValueList<KMFilter*> readFiltersFromConfig( KConfig* config, bool bPopFilter );
+private:
+      QWidget* mParent;
+      bool mPopFilter;
+};
+
+}
+
+#endif /* __FILTERIMPORTEREXPORTER_H__ */
Index: kmail/snippetitem.h
===================================================================
--- kmail/snippetitem.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetitem.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,80 @@
+/*
+ *  File : snippetitem.h
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#ifndef SNIPPETITEM_H
+#define SNIPPETITEM_H
+
+#include <klistview.h>
+#include <klocale.h>
+
+#include <qobject.h>
+
+class QString;
+class KAction;
+class SnippetGroup;
+
+
+/**
+This class represents one CodeSnippet-Item in the listview.
+It also holds the needed data for one snippet.
+@author Robert Gruber
+*/
+class SnippetItem : public QObject, public QListViewItem {
+friend class SnippetGroup;
+
+    Q_OBJECT
+public:
+    SnippetItem(QListViewItem * parent, QString name, QString text);
+
+    ~SnippetItem();
+    QString getName();
+    QString getText();
+    using QListViewItem::parent;
+    int getParent() { return iParent; }
+    void resetParent();
+    void setText(QString text);
+    void setName(QString name);
+    void setAction( KAction* );
+    KAction* getAction();
+    static SnippetItem * findItemByName(QString name, QPtrList<SnippetItem> &list);
+    static SnippetGroup * findGroupById(int id, QPtrList<SnippetItem> &list);
+signals:
+    void execute( QListViewItem * );
+public slots:
+    void slotExecute();
+    
+private:
+  SnippetItem(QListView * parent, QString name, QString text);
+  QString strName;
+  QString strText;
+  int iParent;
+  KAction *action;
+};
+
+/**
+This class represents one group in the listview.
+It is derived from SnippetItem in order to allow storing 
+it in the main QPtrList<SnippetItem>.
+@author Robert Gruber
+*/
+class SnippetGroup : public SnippetItem {
+public:
+    SnippetGroup(QListView * parent, QString name, int id);
+    ~SnippetGroup();
+
+    int getId() { return iId; }
+    static int getMaxId() { return iMaxId; }
+    
+    void setId(int id);
+
+private:
+    static int iMaxId;
+    int iId;
+};
+
+#endif
Index: kmail/editorwatcher.h
===================================================================
--- kmail/editorwatcher.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/editorwatcher.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,77 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KMAIL_EDITORWATCHER_H
+#define KMAIL_EDITORWATCHER_H
+
+#include <kurl.h>
+
+#include <qdatetime.h>
+#include <qobject.h>
+#include <qtimer.h>
+
+class KProcess;
+
+namespace KMail {
+
+/**
+  Starts an editor for the given URL and emits an signal when
+  editing has been finished. Both, the editor process as well
+  as the edited file are watched to work with as many as possible
+  editors.
+*/
+class EditorWatcher : public QObject
+{
+  Q_OBJECT
+  public:
+    EditorWatcher( const KURL &url, const QString &mimeType, bool openWith, QObject *parent = 0 );
+    bool start();
+    bool fileChanged() const { return mFileModified; }
+  signals:
+    void editDone( KMail::EditorWatcher* watcher );
+
+  private slots:
+    void editorExited();
+    void inotifyEvent();
+    void checkEditDone();
+
+  private:
+    KURL mUrl;
+    QString mMimeType;
+    bool mOpenWith;
+    KProcess *mEditor;
+
+    int mInotifyFd;
+    int mInotifyWatch;
+    bool mHaveInotify;
+
+    bool mFileOpen;
+    bool mEditorRunning;
+
+    bool mFileModified;
+
+    QTimer mTimer;
+    QTime mEditTime;
+
+    bool mError;
+    bool mDone;
+};
+
+}
+
+#endif
Index: kmail/messageactions.h
===================================================================
--- kmail/messageactions.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/messageactions.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,106 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KMAIL_MESSAGEACTIONS_H
+#define KMAIL_MESSAGEACTIONS_H
+
+#include "kmcommands.h"
+#include "kmreaderwin.h"
+
+#include <qobject.h>
+#include <qvaluelist.h>
+
+class QWidget;
+class KAction;
+class KActionMenu;
+class KActionCollection;
+class KMMessage;
+
+namespace KMail {
+
+/**
+  Manages common actions that can be performed on one or more messages.
+*/
+class MessageActions : public QObject
+{
+  Q_OBJECT
+  public:
+    MessageActions( KActionCollection* ac, QWidget *parent );
+    void setMessageView( KMReaderWin *msgView );
+
+    void setCurrentMessage( KMMessage *msg );
+    void setSelectedSernums( const QValueList<Q_UINT32> &sernums );
+    void setSelectedVisibleSernums( const QValueList<Q_UINT32> &sernums );
+
+    KActionMenu* replyMenu() const { return mReplyActionMenu; }
+    KAction* replyListAction() const { return mReplyListAction; }
+    KAction* createTodoAction() const { return mCreateTodoAction; }
+
+    KActionMenu* messageStatusMenu() const { return mStatusMenu; }
+
+    KAction* editAction() const { return mEditAction; }
+
+  public slots:
+    void editCurrentMessage();
+
+  private:
+    void updateActions();
+    template<typename T> void replyCommand()
+    {
+      if ( !mCurrentMessage )
+        return;
+      const QString text = mMessageView ? mMessageView->copyText() : "";
+      KMCommand *command = new T( mParent, mCurrentMessage, text );
+      command->start();
+    }
+    void setMessageStatus( KMMsgStatus status, bool toggle = false );
+
+  private slots:
+    void slotReplyToMsg();
+    void slotReplyAuthorToMsg();
+    void slotReplyListToMsg();
+    void slotReplyAllToMsg();
+    void slotNoQuoteReplyToMsg();
+    void slotCreateTodo();
+    void slotSetMsgStatusNew();
+    void slotSetMsgStatusUnread();
+    void slotSetMsgStatusRead();
+    void slotSetMsgStatusTodo();
+    void slotSetMsgStatusFlag();
+
+  private:
+    QWidget *mParent;
+    KActionCollection *mActionCollection;
+    KMMessage* mCurrentMessage;
+    QValueList<Q_UINT32> mSelectedSernums;
+    QValueList<Q_UINT32> mVisibleSernums;
+    KMReaderWin *mMessageView;
+
+    KActionMenu *mReplyActionMenu;
+    KAction *mReplyAction, *mReplyAllAction, *mReplyAuthorAction,
+            *mReplyListAction, *mNoQuoteReplyAction;
+    KAction *mCreateTodoAction;
+    KActionMenu *mStatusMenu;
+    KToggleAction *mToggleFlagAction, *mToggleTodoAction;
+    KAction *mEditAction;
+};
+
+}
+
+#endif
+
Index: kmail/kmacctlocal.cpp
===================================================================
--- kmail/kmacctlocal.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmacctlocal.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -125,7 +125,7 @@
 
   //BroadcastStatus::instance()->reset();
   BroadcastStatus::instance()->setStatusMsg(
-	i18n("Preparing transmission from \"%1\"...").arg(mName));
+        i18n("Preparing transmission from \"%1\"...").arg(mName));
 
 
   Q_ASSERT( !mMailCheckProgressItem );
@@ -145,7 +145,7 @@
     BroadcastStatus::instance()->setStatusMsg( i18n( "Running precommand failed." ));
     return false;
   }
-  
+
   const int rc = mMailFolder->open("acctlocalMail");
   if ( rc != 0 ) {
     QString aStr;
Index: kmail/util.cpp
===================================================================
--- kmail/util.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/util.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -77,7 +77,7 @@
 
     QCString::ConstIterator s = src.begin();
     QCString::Iterator d = result.begin();
-  // we use cPrev to make sure we insert '\r' only there where it is missing
+    // we use cPrev to make sure we insert '\r' only there where it is missing
     char cPrev = '?';
     while ( *s ) {
         if ( ('\n' == *s) && ('\r' != cPrev) )
Index: kmail/dcopimap.desktop
===================================================================
--- kmail/dcopimap.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/dcopimap.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Comment[da]=E-mail-program med en DCOP-gr√¶nseflade
 Comment[de]=Mail-Programm mit DCOP-Schnittstelle
 Comment[el]=Œ†œÅœåŒ≥œÅŒ±ŒºŒºŒ± mail ŒºŒµ Œ≠ŒΩŒ± œÄŒµœÅŒπŒ≤Œ¨ŒªŒªŒøŒΩ œáœÅŒÆœÉŒ∑œÇ DCOP
+Comment[eo]=Retposhtprogramo kun DCOP-interfaco
 Comment[es]=Programa de correo con un interfaz DCOP
 Comment[et]=E-posti rakendus DCOP-liidesega
 Comment[eu]=DCOP interfazedun posta programa
Index: kmail/profiles/profile-high-contrast-rc.desktop
===================================================================
--- kmail/profiles/profile-high-contrast-rc.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/profiles/profile-high-contrast-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,6 +10,7 @@
 Name[da]=H√∏j kontrast
 Name[de]=Starker Kontrast
 Name[el]=ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ±ŒΩœÑŒØŒ∏ŒµœÉŒ∑
+Name[eo]=Forta kontrasto
 Name[es]=Alto contraste
 Name[et]=Suur kontrast
 Name[eu]=Kontraste altua
Index: kmail/profiles/profile-secure-rc.desktop
===================================================================
--- kmail/profiles/profile-secure-rc.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/profiles/profile-secure-rc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,6 +10,7 @@
 Name[da]=Mest sikker
 Name[de]=Sicherste Variante
 Name[el]=Œ†ŒπŒø Œ±œÉœÜŒ±ŒªŒ≠œÇ
+Name[eo]=Plej sekura
 Name[es]=M√°s seguro
 Name[et]=K√µige turvalisem
 Name[eu]=Seguruena
@@ -63,6 +64,7 @@
 Comment[da]=S√¶tter alle n√∏dvendige tilvalg til maksimal sikkerhed
 Comment[de]=Aktivierung aller n√∂tigen Einstellungen f√ºr die h√∂chste Sicherheitsstufe
 Comment[el]=ŒïŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒµŒØ œåŒªŒµœÇ œÑŒπœÇ Œ±œÄŒ±œÅŒ±ŒØœÑŒ∑œÑŒµœÇ ŒµœÄŒπŒªŒøŒ≥Œ≠œÇ Œ≥ŒπŒ± œÑŒ∑ŒΩ ŒµœÄŒØœÑŒµœÖŒæŒ∑ œÑŒ∑œÇ ŒºŒ≠Œ≥ŒπœÉœÑŒ∑œÇ Œ±œÉœÜŒ¨ŒªŒµŒπŒ±œÇ
+Comment[eo]=Agordas la necesajn opciojn por atingi maksimuman sekurecon
 Comment[es]=Pone todas las opciones necesarias para lograr la m√°xima seguridad
 Comment[et]=K√µik v√µimalused maksimaalse turvalisuse tagamiseks
 Comment[eu]=Sekuritate maximoa lortzeko aukera guztiak ezartzen ditu
Index: kmail/application_octetstream.desktop
===================================================================
--- kmail/application_octetstream.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/application_octetstream.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,6 +5,7 @@
 Name[ca]=Aplicaci√≥ Octetstream
 Name[cs]=Aplikace octetstream
 Name[da]=Program oktetstr√∏m
+Name[eo]=Aplikaƒµa Bitokfluo
 Name[es]=Aplicaci√≥n en flujo de octetos
 Name[eu]=Aplikazioa/zortzikote-jarioa
 Name[fa]=Octetstream ⁄©ÿßÿ±ÿ®ÿ±ÿØ
Index: kmail/kmmsgpart.cpp
===================================================================
--- kmail/kmmsgpart.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmsgpart.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -300,7 +300,6 @@
   }
 }
 
-//-----------------------------------------------------------------------------
 void KMMessagePart::setMessageBody( const QByteArray& aBuf )
 {
   CharFreq cf( aBuf ); // it's safe to pass null arrays
@@ -430,7 +429,7 @@
 
 
 //-----------------------------------------------------------------------------
-QString KMMessagePart::iconName() const
+QString KMMessagePart::iconName( int size ) const
 {
   QCString mimeType( mType + "/" + mSubtype );
   KPIM::kAsciiToLower( mimeType.data() );
@@ -448,7 +447,7 @@
   }
 
   fileName =
-    KGlobal::instance()->iconLoader()->iconPath( fileName, KIcon::Desktop );
+    KGlobal::instance()->iconLoader()->iconPath( fileName, size );
   return fileName;
 }
 
@@ -556,7 +555,7 @@
 
   // Allow for multiple filname*0, filename*1, ... params (defined by RFC 2231)
   // in the Content-Disposision
-  if ( mContentDisposition.contains( "filename*", FALSE ) ) {
+  if ( mContentDisposition.contains( "filename*", false ) ) {
 
     // It's RFC 2231 encoded, so extract the file name with the 2231 method
     str = KMMsgBase::extractRFC2231HeaderField( mContentDisposition, "filename" );
@@ -566,7 +565,7 @@
 
     // Standard RFC 2047-encoded
     // search the start of the filename
-    int startOfFilename = mContentDisposition.find("filename=", 0, FALSE);
+    int startOfFilename = mContentDisposition.find("filename=", 0, false);
     if (startOfFilename < 0)
       return QString::null;
     startOfFilename += 9;
Index: kmail/korghelper.h
===================================================================
--- kmail/korghelper.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/korghelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,32 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#ifndef KMAIL_KORGHELPER_H
+#define KMAIL_KORGHELPER_H
+
+namespace KMail {
+
+namespace KorgHelper
+{
+  /** ensure that korganizer is running standalone or in Kontact */
+  void ensureRunning();
+}
+}
+
+#endif
Index: kmail/kmedit.cpp
===================================================================
--- kmail/kmedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -200,7 +200,10 @@
         }
         else
           kdDebug(5006) << "KMEdit::contentsDropEvent, unable to add dropped object" << endl;
-    }
+    } 
+    else if( e->provides("text/x-textsnippet") ) {
+	emit insertSnippet();
+    } 
     else {
         KEdit::contentsDropEvent(e);
     }
@@ -220,7 +223,8 @@
     mUseExtEditor( false ),
     mWasModifiedBeforeSpellCheck( false ),
     mSpellChecker( 0 ),
-    mSpellLineEdit( false )
+    mSpellLineEdit( false ),
+    mPasteMode( QClipboard::Clipboard )
 {
   installEventFilter(this);
   KCursor::setAutoHideCursor( this, true, true );
@@ -353,14 +357,14 @@
       if (k->key() == Key_Up)
       {
         emit focusUp();
-        return TRUE;
+        return true;
       }
 
       // ignore modifier keys (cf. bug 48841)
       if ( (k->key() == Key_Shift) || (k->key() == Key_Control) ||
            (k->key() == Key_Meta) || (k->key() == Key_Alt) )
         return true;
-      if (mExtEditorTempFile) return TRUE;
+      if (mExtEditorTempFile) return true;
       QString sysLine = mExtEditor;
       mExtEditorTempFile = new KTempFile();
 
@@ -392,7 +396,7 @@
                  SLOT(slotExternalEditorTempFileChanged(const QString&)) );
         mExtEditorTempFileWatcher->addFile( mExtEditorTempFile->name() );
       }
-      return TRUE;
+      return true;
     } else {
     // ---sven's Arrow key navigation start ---
     // Key Up in first line takes you to Subject line.
@@ -401,7 +405,7 @@
     {
       deselect();
       emit focusUp();
-      return TRUE;
+      return true;
     }
     // ---sven's Arrow key navigation end ---
 
@@ -409,7 +413,7 @@
     {
       deselect();
       emit focusUp();
-      return TRUE;
+      return true;
     }
 
     }
@@ -599,13 +603,23 @@
 
 void KMEdit::paste()
 {
-  if ( ! QApplication::clipboard()->image().isNull() )  {
-    emit pasteImage();
-  }
-  else
-    KEdit::paste();
+  mComposer->paste( mPasteMode );
 }
 
+// KMEdit indirectly inherits from QTextEdit, which has virtual paste() method,
+// but it controls whether it pastes clipboard or selection by an internal
+// flag that is not accessible in any way, so paste() being virtual is actually
+// useless, because reimplementations can't known where to paste from anyway.
+// Roll our own internal flag.
+void KMEdit::contentsMouseReleaseEvent( QMouseEvent * e )
+{
+  if( e->button() != Qt::MidButton )
+    return KEdit::contentsMouseReleaseEvent( e );
+  mPasteMode = QClipboard::Selection;
+  KEdit::contentsMouseReleaseEvent( e );
+  mPasteMode = QClipboard::Clipboard;
+}
+
 void KMEdit::slotMisspelling(const QString &text, const QStringList &lst, unsigned int pos)
 {
     kdDebug(5006)<<"void KMEdit::slotMisspelling(const QString &text, const QStringList &lst, unsigned int pos) : "<<text <<endl;
Index: kmail/bodyvisitor.cpp
===================================================================
--- kmail/bodyvisitor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/bodyvisitor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,6 +46,7 @@
     // groupware
     mBasicList += "APPLICATION/MS-TNEF";
     mBasicList += "TEXT/CALENDAR";
+    mBasicList += "TEXT/X-VCARD";
   }
 
   //-----------------------------------------------------------------------------
Index: kmail/pics/enterprise_s_left.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_s_left.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_top_left.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_top_left.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_bottom_left.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_bottom_left.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_sbar.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_sbar.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_icon.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_icon.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_left.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_left.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_s_right.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_s_right.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_top_right.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_top_right.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_bottom_right.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_bottom_right.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_top.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_top.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_bottom.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_bottom.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_w.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_w.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_right.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_right.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/enterprise_sp_right.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_sp_right.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/pics/Makefile.am
===================================================================
--- kmail/pics/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/pics/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,7 +11,22 @@
 	kmmsgundefinedsigned.png \
 	kmmsgspam.png kmmsgham.png kmmsgattachment.png \
 	kmwizard.png \
-	quotecollapse.png quoteexpand.png
+	quotecollapse.png quoteexpand.png \
+	enterprise_bottom_left.png \
+	enterprise_bottom.png \
+	enterprise_bottom_right.png \
+	enterprise_icon.png \
+	enterprise_left.png \
+	enterprise_right.png \
+	enterprise_s_left.png \
+	enterprise_sbar.png \
+	enterprise_s_right.png \
+	enterprise_sp_right.png \
+	enterprise_top_left.png \
+	enterprise_top.png \
+	enterprise_top_right.png \
+	enterprise_sw.png \
+	enterprise_w.png
 
 
 picsdir = $(kde_datadir)/kmail/pics
Index: kmail/pics/enterprise_sw.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: kmail/pics/enterprise_sw.png
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: kmail/kmmessage.h
===================================================================
--- kmail/kmmessage.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmessage.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -125,8 +125,8 @@
   /** Specifies an unencrypted copy of this message to be stored
       in a separate member variable to allow saving messages in
       unencrypted form that were sent in encrypted form.
-      NOTE: Target of this pointer becomes property of KMMessage,
-            and will be deleted in the d'tor.
+      NOTE: Ownership of @p unencrypted transfers to this KMMessage,
+            and it will be deleted in the d'tor.
   */
   void setUnencryptedMsg( KMMessage* unencrypted );
 
@@ -161,8 +161,8 @@
       required header fields with the proper values. The returned message
       is not stored in any folder. Marks this message as replied. */
   KMMessage* createReply( KMail::ReplyStrategy replyStrategy = KMail::ReplySmart,
-                          QString selection=QString::null, bool noQuote=FALSE,
-                          bool allowDecryption=TRUE, bool selectionIsBody=FALSE,
+                          QString selection=QString::null, bool noQuote=false,
+                          bool allowDecryption=true, bool selectionIsBody=false,
                           const QString &tmpl = QString::null );
 
   /** Create a new message that is a redirect to this message, filling all
@@ -205,9 +205,12 @@
           bool allowGUI=false,
           QValueList<KMime::MDN::DispositionModifier> m=QValueList<KMime::MDN::DispositionModifier>() );
 
+  /** Remove all headers but the content description ones, and those in the white list. */
+  void sanitizeHeaders( const QStringList& whiteList = QStringList() );
+
   /** Parse the string and create this message from it. */
-  void fromDwString(const DwString& str, bool setStatus=FALSE);
-  void fromString(const QCString& str, bool setStatus=FALSE);
+  void fromDwString(const DwString& str, bool setStatus=false);
+  void fromString(const QCString& str, bool setStatus=false);
   void fromByteArray(const QByteArray & ba, bool setStatus=false);
 
   /** Return the entire message contents in the DwString. This function
@@ -265,7 +268,7 @@
 
   /** Initialize headers fields according to the identity and the transport
     header of the given original message */
-  void initFromMessage(const KMMessage *msg, bool idHeaders = TRUE);
+  void initFromMessage(const KMMessage *msg, bool idHeaders = true);
 
   /** @return the UOID of the identity for this message.
       Searches the "x-kmail-identity" header and if that fails,
@@ -287,7 +290,7 @@
     Call this method before sending *after* all changes to the message
     are done because this method does things different if there are
     attachments / multiple body parts. */
-  void setAutomaticFields(bool isMultipart=FALSE);
+  void setAutomaticFields(bool isMultipart=false);
 
   /** Get or set the 'Date' header field */
   QString dateStr() const;
@@ -467,6 +470,9 @@
   /** Remove header field with given name */
   void removeHeaderField(const QCString& name);
 
+  /** Remove all header fields with given name */
+  void removeHeaderFields(const QCString& name);
+
   /** Get or set the 'Content-Type' header field
       The member functions that involve enumerated types (ints)
       will work only for well-known types or subtypes. */
@@ -577,6 +583,10 @@
       or zero, if no found. */
   DwBodyPart * findDwBodyPart( int type, int subtype ) const;
 
+  /** Return the first DwBodyPart matching a given Content-Type
+      or zero, if no found. */
+  DwBodyPart * findDwBodyPart( const QCString& type, const QCString&  subtype ) const;
+
   /** Return the first DwBodyPart matching a given partSpecifier
       or zero, if no found. */
   DwBodyPart* findDwBodyPart( DwBodyPart* part, const QString & partSpecifier );
@@ -617,6 +627,9 @@
   /** Delete all body parts. */
   void deleteBodyParts();
 
+  /** Removes the given body part. */
+  void removeBodyPart( DwBodyPart * dwPart );
+
   /** Set "Status" and "X-Status" fields of the message from the
    * internal message status. */
   void setStatusFields();
@@ -667,7 +680,7 @@
    * only the name part and not the given emailAddr.
    */
   static QString emailAddrAsAnchor(const QString& emailAddr,
-          bool stripped=TRUE);
+          bool stripped=true, const QString& cssStyle = QString::null, bool link = true);
 
   /** Strips an address from an address list. This is for example used
       when replying to all.
@@ -739,17 +752,17 @@
 
   /** Get/set offset in mail folder. */
   off_t folderOffset() const { return mFolderOffset; }
-  void setFolderOffset(off_t offs) { if(mFolderOffset != offs) { mFolderOffset=offs; setDirty(TRUE); } }
+  void setFolderOffset(off_t offs) { if(mFolderOffset != offs) { mFolderOffset=offs; setDirty(true); } }
 
   /** Get/set filename in mail folder. */
   QString fileName() const { return mFileName; }
-  void setFileName(const QString& file) { if(mFileName != file) { mFileName=file; setDirty(TRUE); } }
+  void setFileName(const QString& file) { if(mFileName != file) { mFileName=file; setDirty(true); } }
 
   /** Get/set size of message in the folder including the whole header in
       bytes. Can be 0, if the message is not in a folder.
       The setting of mMsgSize = mMsgLength = sz is needed for popFilter*/
   size_t msgSize() const { return mMsgSize; }
-  void setMsgSize(size_t sz) { if(mMsgSize != sz) { mMsgSize = sz; setDirty(TRUE); } }
+  void setMsgSize(size_t sz) { if(mMsgSize != sz) { mMsgSize = sz; setDirty(true); } }
 
   /** Unlike the above function this works also, if the message is not in a
       folder */
@@ -855,12 +868,20 @@
   /** Set cursor position as offset from message start */
   void setCursorPos(int pos) { mCursorPos = pos; };
 
+  /** Get the KMMsgInfo object that was set with setMsgInfo(). */
+  KMMsgInfo* msgInfo() { return mMsgInfo; }
+  /** Set the KMMsgInfo object corresponding to this message. */
+  void setMsgInfo( KMMsgInfo* msgInfo ) { mMsgInfo = msgInfo; }
+
   /* This is set in kmreaderwin if a message is being parsed to avoid
-     other parts of kmail (e.g. kmheaders) destroying the message. 
+     other parts of kmail (e.g. kmheaders) destroying the message.
      Parsing can take longer and can be async (in case of gpg mails) */
   bool isBeingParsed() const { return mIsParsed; }
   void setIsBeingParsed( bool t ) { mIsParsed = t; }
 
+  /** Delete this message as soon as it no longer in use. */
+  void deleteWhenUnused();
+
 private:
 
   /** Initialization shared by the ctors. */
@@ -890,6 +911,8 @@
   KMMessage* mUnencryptedMsg;
   DwBodyPart* mLastUpdated;
   int mCursorPos;
+  KMMsgInfo* mMsgInfo; // used to remember the KMMsgInfo object this KMMessage replaced in the KMMsgList
+  static QValueList<KMMessage*> sPendingDeletes;
 };
 
 
Index: kmail/partNode.h
===================================================================
--- kmail/partNode.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/partNode.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -151,7 +151,7 @@
         return mSignatureState;
     }
 
-    int nodeId();  // node ids start at 1 (this is the top level root node)
+    int nodeId() const;  // node ids start at 1 (this is the top level root node)
 
     partNode* findId( int id );  // returns the node which has the given id (or 0, resp.)
 
Index: kmail/kmmsgdict.cpp
===================================================================
--- kmail/kmmsgdict.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmsgdict.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -355,6 +355,20 @@
 
 //-----------------------------------------------------------------------------
 
+//static
+QValueList<unsigned long> KMMsgDict::serNumList(QPtrList<KMMsgBase> msgList)
+{
+  QValueList<unsigned long> ret;
+  for ( unsigned int i = 0; i < msgList.count(); i++ ) {
+    unsigned long serNum = msgList.at(i)->getMsgSerNum();
+    assert( serNum );
+    ret.append( serNum );
+  }
+  return ret;
+}
+
+//-----------------------------------------------------------------------------
+
 QString KMMsgDict::getFolderIdsLocation( const FolderStorage &storage )
 {
   return storage.indexLocation() + ".ids";
Index: kmail/kmailicalIface.h
===================================================================
--- kmail/kmailicalIface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmailicalIface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -73,11 +73,16 @@
                                  const QString& resource ) = 0;
 
   virtual KMailICalIface::StorageFormat storageFormat( const QString& resource ) = 0;
-  
+
   virtual KURL getAttachment( const QString& resource,
                               Q_UINT32 sernum,
                               const QString& filename ) = 0;
+  virtual QString attachmentMimetype( const QString &resource,
+                                      Q_UINT32 sernum,
+                                      const QString &filename ) = 0;
 
+  virtual QStringList listAttachments( const QString &resource, Q_UINT32 sernum ) = 0;
+
   /// Update a kolab storage entry. Returns the new mail serial number,
   /// or 0 if something went wrong. Can be used for adding as well.
   virtual Q_UINT32 update( const QString& resource,
@@ -108,7 +113,21 @@
    */
   virtual QValueList<KMailICalIface::SubResource> subresourcesKolab( const QString& contentsType ) = 0;
 
+   /**
+   * Trigger the creation of a new resource folder with name @param resource
+   * under parent @param.
+   * @return success or failure
+   */
+  virtual bool addSubresource( const QString& resource,
+                               const QString& parent,
+                               const QString& contentsType ) = 0;
   /**
+   * Trigger the deletion of a new resource folder with id @param resource.
+   * @return success or failure
+   */
+  virtual bool removeSubresource( const QString& resource ) = 0;
+
+  /**
    * Causes all resource folders of the given type to be synced with the server.
    */
   virtual bool triggerSync( const QString & ) = 0;
@@ -140,14 +159,14 @@
 inline QDataStream& operator<<( QDataStream& str, const KMailICalIface::StorageFormat& format  )
 {
   Q_UINT32 foo = format;
-  str << foo; 
+  str << foo;
   return str;
 }
 
 inline QDataStream& operator>>( QDataStream& str, KMailICalIface::StorageFormat& format  )
 {
   Q_UINT32 foo;
-  str >> foo; 
+  str >> foo;
   format = ( KMailICalIface::StorageFormat )foo;
   return str;
 }
Index: kmail/kmail_config_misc.desktop
===================================================================
--- kmail/kmail_config_misc.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_config_misc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -74,6 +74,7 @@
 Comment[da]=Indstillinger der ikke passer ind andre steder
 Comment[de]=Verschiedene Einstellungen
 Comment[el]=Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ œÄŒøœÖ Œ¥ŒµŒΩ œÑŒ±ŒπœÅŒπŒ¨Œ∂ŒøœÖŒΩ Œ∫Œ¨œÄŒøœÖ Œ±ŒªŒªŒøœç
+Comment[eo]=Agordoj kiuj apartenas nenie alie
 Comment[es]=Opciones que no encajan en ning√∫n otro sitio
 Comment[et]=Seadistused, mis kuhugi mujale ei sobi
 Comment[eu]=Beste inon egokitzen ez diren ezarpenak
Index: kmail/attachmentlistview.h
===================================================================
--- kmail/attachmentlistview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/attachmentlistview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -42,12 +42,14 @@
 
 protected:
   virtual void keyPressEvent( QKeyEvent * e );
+  virtual void startDrag();
 
 private:
   KMail::Composer * mComposer;
 
 signals:
   void attachmentDeleted();
+  void dragStarted();
 
 };
 
Index: kmail/urlhandlermanager.cpp
===================================================================
--- kmail/urlhandlermanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/urlhandlermanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,14 +56,14 @@
 KMail::URLHandlerManager * KMail::URLHandlerManager::self = 0;
 
 namespace {
-  class ShowHtmlSwitchURLHandler : public KMail::URLHandler {
+  class KMailProtocolURLHandler : public KMail::URLHandler {
   public:
-    ShowHtmlSwitchURLHandler() : KMail::URLHandler() {}
-    ~ShowHtmlSwitchURLHandler() {}
+    KMailProtocolURLHandler() : KMail::URLHandler() {}
+    ~KMailProtocolURLHandler() {}
 
     bool handleClick( const KURL &, KMReaderWin * ) const;
-    bool handleContextMenuRequest( const KURL &, const QPoint &, KMReaderWin * ) const {
-      return false;
+    bool handleContextMenuRequest( const KURL & url, const QPoint &, KMReaderWin * ) const {
+      return url.protocol() == "kmail";
     }
     QString statusBarMessage( const KURL &, KMReaderWin * ) const;
   };
@@ -127,6 +127,16 @@
     QString statusBarMessage( const KURL &, KMReaderWin * ) const;
   };
 
+  class ShowAuditLogURLHandler : public KMail::URLHandler {
+  public:
+      ShowAuditLogURLHandler() : KMail::URLHandler() {}
+      ~ShowAuditLogURLHandler() {}
+
+      bool handleClick( const KURL &, KMReaderWin * ) const;
+      bool handleContextMenuRequest( const KURL &, const QPoint &, KMReaderWin * ) const;
+      QString statusBarMessage( const KURL &, KMReaderWin * ) const;
+  };
+
   class FallBackURLHandler : public KMail::URLHandler {
   public:
     FallBackURLHandler() : KMail::URLHandler() {}
@@ -256,13 +266,14 @@
 //
 
 KMail::URLHandlerManager::URLHandlerManager() {
-  registerHandler( new ShowHtmlSwitchURLHandler() );
+  registerHandler( new KMailProtocolURLHandler() );
   registerHandler( new ExpandCollapseQuoteURLManager() );
   registerHandler( new SMimeURLHandler() );
   registerHandler( new MailToURLHandler() );
   registerHandler( new HtmlAnchorHandler() );
   registerHandler( new AttachmentURLHandler() );
   registerHandler( mBodyPartURLHandlerManager = new BodyPartURLHandlerManager() );
+  registerHandler( new ShowAuditLogURLHandler() );
   registerHandler( new FallBackURLHandler() );
 }
 
@@ -330,6 +341,8 @@
 #include "partNode.h"
 #include "kmmsgpart.h"
 
+#include <ui/messagebox.h>
+
 #include <klocale.h>
 #include <kprocess.h>
 #include <kmessagebox.h>
@@ -338,7 +351,7 @@
 #include <qstring.h>
 
 namespace {
-  bool ShowHtmlSwitchURLHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
+  bool KMailProtocolURLHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
     if ( url.protocol() == "kmail" ) {
       if ( !w )
         return false;
@@ -360,6 +373,24 @@
         return true;
       }
 
+      if ( url.path() == "decryptMessage" ) {
+        w->setDecryptMessageOverwrite( true );
+        w->update( true );
+        return true;
+      }
+
+      if ( url.path() == "showSignatureDetails" ) {
+        w->setShowSignatureDetails( true );
+        w->update( true );
+        return true;
+      }
+
+      if ( url.path() == "hideSignatureDetails" ) {
+        w->setShowSignatureDetails( false );
+        w->update( true );
+        return true;
+      }
+
 //       if ( url.path() == "startIMApp" )
 //       {
 //         kmkernel->imProxy()->startPreferredApp();
@@ -370,7 +401,7 @@
     return false;
   }
 
-  QString ShowHtmlSwitchURLHandler::statusBarMessage( const KURL & url, KMReaderWin * ) const {
+  QString KMailProtocolURLHandler::statusBarMessage( const KURL & url, KMReaderWin * ) const {
     if ( url.protocol() == "kmail" )
     {
       if ( url.path() == "showHTML" )
@@ -378,7 +409,13 @@
       if ( url.path() == "loadExternal" )
         return i18n("Load external references from the Internet for this message.");
       if ( url.path() == "goOnline" )
-        return i18n("Work online");
+        return i18n("Work online.");
+      if ( url.path() == "decryptMessage" )
+        return i18n("Decrypt message.");
+      if ( url.path() == "showSignatureDetails" )
+        return i18n("Show signature details.");
+      if ( url.path() == "hideSignatureDetails" )
+        return i18n("Hide signature details.");
     }
     return QString::null ;
   }
@@ -386,12 +423,12 @@
 
 namespace {
 
-  bool ExpandCollapseQuoteURLManager::handleClick( 
-      const KURL & url, KMReaderWin * w ) const 
+  bool ExpandCollapseQuoteURLManager::handleClick(
+      const KURL & url, KMReaderWin * w ) const
   {
     //  kmail:levelquote/?num      -> the level quote to collapse.
     //  kmail:levelquote/?-num      -> expand all levels quote.
-    if ( url.protocol() == "kmail" && url.path()=="levelquote" ) 
+    if ( url.protocol() == "kmail" && url.path()=="levelquote" )
     {
       QString levelStr= url.query().mid( 1,url.query().length() );
       bool isNumber;
@@ -402,8 +439,8 @@
     }
     return false;
   }
-  QString ExpandCollapseQuoteURLManager::statusBarMessage( 
-      const KURL & url, KMReaderWin * ) const 
+  QString ExpandCollapseQuoteURLManager::statusBarMessage(
+      const KURL & url, KMReaderWin * ) const
   {
       if ( url.protocol() == "kmail" && url.path() == "levelquote" )
       {
@@ -503,6 +540,35 @@
 }
 
 namespace {
+  static QString extractAuditLog( const KURL & url ) {
+    if ( url.protocol() != "kmail" || url.path() != "showAuditLog" )
+      return QString();
+    assert( !url.queryItem( "log" ).isEmpty() );
+    return url.queryItem( "log" );
+  }
+
+  bool ShowAuditLogURLHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
+    const QString auditLog = extractAuditLog( url );
+    if ( auditLog.isEmpty() )
+        return false;
+    Kleo::MessageBox::auditLog( w, auditLog );
+    return true;
+  }
+
+  bool ShowAuditLogURLHandler::handleContextMenuRequest( const KURL & url, const QPoint &, KMReaderWin * w ) const {
+    // disable RMB for my own links:
+    return !extractAuditLog( url ).isEmpty();
+  }
+
+  QString ShowAuditLogURLHandler::statusBarMessage( const KURL & url, KMReaderWin * ) const {
+    if ( extractAuditLog( url ).isEmpty() )
+      return QString();
+    else
+      return i18n("Show GnuPG Audit Log for this operation");
+  }
+}
+
+namespace {
   bool FallBackURLHandler::handleClick( const KURL & url, KMReaderWin * w ) const {
     if ( w )
       w->emitUrlClicked( url, Qt::LeftButton );
Index: kmail/kmacctcachedimap.cpp
===================================================================
--- kmail/kmacctcachedimap.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmacctcachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,7 +48,6 @@
 #include <kio/passdlg.h>
 #include <kio/scheduler.h>
 #include <kio/slave.h>
-#include <kmessagebox.h>
 #include <kdebug.h>
 #include <kstandarddirs.h>
 #include <kapplication.h>
@@ -59,7 +58,9 @@
 KMAcctCachedImap::KMAcctCachedImap( AccountManager* aOwner,
 				    const QString& aAccountName, uint id )
   : KMail::ImapAccountBase( aOwner, aAccountName, id ), mFolder( 0 ),
-    mAnnotationCheckPassed(false)
+    mAnnotationCheckPassed(false),
+    mGroupwareType( GroupwareKolab ),
+    mSentCustomLoginCommand(false)
 {
   // Never EVER set this for the cached IMAP account
   mAutoExpunge = false;
@@ -120,7 +121,7 @@
     fld->resetSyncState();
     fld->setContentState(KMFolderCachedImap::imapNoInformation);
     fld->setSubfolderState(KMFolderCachedImap::imapNoInformation);
-    fld->sendFolderComplete(FALSE);
+    fld->sendFolderComplete(false);
   }
 }
 
@@ -174,7 +175,7 @@
     fld->resetSyncState();
     fld->setContentState(KMFolderCachedImap::imapNoInformation);
     fld->setSubfolderState(KMFolderCachedImap::imapNoInformation);
-    fld->sendFolderComplete(FALSE);
+    fld->sendFolderComplete(false);
   }
 }
 
@@ -329,6 +330,7 @@
   for( ; it != oldPaths.end() && nameit != newNames.end(); ++it, ++nameit ) {
     addRenamedFolder( *it, QString::null, *nameit );
   }
+  mGroupwareType = (GroupwareType)config.readNumEntry( "groupwareType", GroupwareKolab );
 }
 
 void KMAcctCachedImap::writeConfig( KConfig/*Base*/ & config ) /*const*/ {
@@ -341,6 +343,7 @@
   for ( ; it != values.end() ; ++it )
     lstNames.append( (*it).mNewName );
   config.writeEntry( "renamed-folders-names", lstNames );
+  config.writeEntry( "groupwareType", mGroupwareType );
 }
 
 void KMAcctCachedImap::invalidateIMAPFolders()
Index: kmail/kmfoldermaildir.cpp
===================================================================
--- kmail/kmfoldermaildir.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermaildir.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,6 +27,7 @@
 #include <klocale.h>
 #include <kstaticdeleter.h>
 #include <kmessagebox.h>
+#include <kdirsize.h>
 
 #include <dirent.h>
 #include <errno.h>
@@ -46,10 +47,12 @@
 #define INIT_MSGS 8
 #endif
 
+// define the static member
+QValueList<KMFolderMaildir::DirSizeJobQueueEntry> KMFolderMaildir::s_DirSizeJobQueue;
 
 //-----------------------------------------------------------------------------
 KMFolderMaildir::KMFolderMaildir(KMFolder* folder, const char* name)
-  : KMFolderIndex(folder, name)
+  : KMFolderIndex(folder, name), mCurrentlyCheckingFolderSize(false)
 {
 
 }
@@ -219,7 +222,7 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMaildir::reallyDoClose(const char *)
+void KMFolderMaildir::reallyDoClose(const char* owner)
 {
   if (mAutoCreateIndex)
   {
@@ -229,10 +232,10 @@
 
   mMsgList.clear(true);
 
-    if (mIndexStream) {
-	fclose(mIndexStream);
-	updateIndexStreamPtr(true);
-    }
+  if (mIndexStream) {
+    fclose(mIndexStream);
+    updateIndexStreamPtr(true);
+  }
 
   mOpenCount   = 0;
   mIndexStream = 0;
@@ -365,7 +368,6 @@
 */
   long len;
   unsigned long size;
-  bool opened = false;
   KMFolder* msgParent;
   QCString msgText;
   int idx(-1);
@@ -417,12 +419,12 @@
   QFile file(tmp_file);
   size = msgText.length();
 
-  if (!isOpened())
+  KMFolderOpener openThis(folder(), "maildir");
+  rc = openThis.openResult();
+  if (rc)
   {
-    opened = true;
-    rc = open("maildir");
     kdDebug(5006) << "KMFolderMaildir::addMsg-open: " << rc << " of folder: " << label() << endl;
-    if (rc) return rc;
+    return rc;
   }
 
   // now move the file to the correct location
@@ -431,12 +433,11 @@
   if (moveInternal(tmp_file, new_loc, filename, aMsg->status()).isNull())
   {
     file.remove();
-    if (opened) close("maildir");
     return -1;
   }
 
-  if (msgParent)
-    if (idx >= 0) msgParent->take(idx);
+  if (msgParent && idx >= 0)
+    msgParent->take(idx);
 
   // just to be sure it does not end up in the index
   if ( stripUid ) aMsg->setUID( 0 );
@@ -462,6 +463,7 @@
     }
   }
   ++mTotalMsgs;
+  mSize = -1;
 
   if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
@@ -491,7 +493,7 @@
     mb->setIndexOffset( ftell(mIndexStream) );
     mb->setIndexLength( len );
     if(fwrite(buffer, len, 1, mIndexStream) != 1)
-    kdDebug(5006) << "Whoa! " << __FILE__ << ":" << __LINE__ << endl;
+      kdDebug(5006) << "Whoa! " << __FILE__ << ":" << __LINE__ << endl;
 
     fflush(mIndexStream);
     int error = ferror(mIndexStream);
@@ -516,20 +518,17 @@
 	     "(No space left on device or insufficient quota?)\n"
 	     "Free space and sufficient quota are required to continue safely."));
       if (busy) kmkernel->kbp()->busy();
-      if (opened) close();
       */
       return error;
     }
   }
 
-  // some "paper work"
   if (index_return)
     *index_return = idx;
 
   emitMsgAddedSignals(idx);
   needsCompact = true;
 
-  if (opened) close("maildir" );
 /*
 QFile fileD1( "testdat_xx-kmfoldermaildir-1" );
 if( fileD1.open( IO_WriteOnly ) ) {
@@ -544,7 +543,8 @@
 KMMessage* KMFolderMaildir::readMsg(int idx)
 {
   KMMsgInfo* mi = (KMMsgInfo*)mMsgList[idx];
-  KMMessage *msg = new KMMessage(*mi); // note that mi is deleted by the line below
+  KMMessage *msg = new KMMessage(*mi);
+  msg->setMsgInfo( mi ); // remember the KMMsgInfo object to that we can restore it when the KMMessage object is no longer needed
   mMsgList.set(idx,&msg->toMsgBase()); // done now so that the serial number can be computed
   msg->setComplete( true );
   msg->fromDwString(getDwString(idx));
@@ -1098,4 +1098,75 @@
   KMFolderIndex::msgStatusChanged(oldStatus, newStatus, idx);
 }
 
+/*virtual*/
+Q_INT64 KMFolderMaildir::doFolderSize() const
+{
+  if ( mCurrentlyCheckingFolderSize )
+  {
+    return -1;
+  }
+  mCurrentlyCheckingFolderSize = true;
+
+  KFileItemList list;
+  KFileItem *item = 0;
+  item = new KFileItem( S_IFDIR, -1, location() + "/cur" );
+  list.append( item );
+  item = new KFileItem( S_IFDIR, -1, location() + "/new" );
+  list.append( item );
+  item = new KFileItem( S_IFDIR, -1, location() + "/tmp" );
+  list.append( item );
+  s_DirSizeJobQueue.append(
+    qMakePair( QGuardedPtr<const KMFolderMaildir>( this ), list ) );
+
+  // if there's only one entry in the queue then we can start
+  // a dirSizeJob right away
+  if ( s_DirSizeJobQueue.size() == 1 )
+  {
+    //kdDebug(5006) << k_funcinfo << "Starting dirSizeJob for folder "
+    //  << location() << endl;
+    KDirSize* job = KDirSize::dirSizeJob( list );
+    connect( job, SIGNAL( result( KIO::Job* ) ),
+             this, SLOT( slotDirSizeJobResult( KIO::Job* ) ) );
+  }
+
+  return -1;
+}
+
+void KMFolderMaildir::slotDirSizeJobResult( KIO::Job* job )
+{
+    mCurrentlyCheckingFolderSize = false;
+    KDirSize * dirsize = dynamic_cast<KDirSize*>( job );
+    if ( dirsize && ! dirsize->error() )
+    {
+      mSize = dirsize->totalSize();
+      //kdDebug(5006) << k_funcinfo << "dirSizeJob completed. Folder "
+      //  << location() << " has size " << mSize << endl;
+      emit folderSizeChanged();
+    }
+    // remove the completed job from the queue
+    s_DirSizeJobQueue.pop_front();
+
+    // process the next entry in the queue
+    while ( s_DirSizeJobQueue.size() > 0 )
+    {
+      DirSizeJobQueueEntry entry = s_DirSizeJobQueue.first();
+      // check whether the entry is valid, i.e. whether the folder still exists
+      if ( entry.first )
+      {
+        // start the next dirSizeJob
+        //kdDebug(5006) << k_funcinfo << "Starting dirSizeJob for folder "
+        //  << entry.first->location() << endl;
+        KDirSize* job = KDirSize::dirSizeJob( entry.second );
+        connect( job, SIGNAL( result( KIO::Job* ) ),
+                 entry.first, SLOT( slotDirSizeJobResult( KIO::Job* ) ) );
+        break;
+      }
+      else
+      {
+        // remove the invalid entry from the queue
+        s_DirSizeJobQueue.pop_front();
+      }
+    }
+}
+
 #include "kmfoldermaildir.moc"
Index: kmail/newfolderdialog.cpp
===================================================================
--- kmail/newfolderdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/newfolderdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -92,7 +92,7 @@
     mMailboxFormatLabel->setText( i18n( "Mailbox &format:" ) );
     mFormatHBox->addWidget( mMailboxFormatLabel );
 
-    mFormatComboBox = new QComboBox( FALSE, privateLayoutWidget, "mFormatComboBox" );
+    mFormatComboBox = new QComboBox( false, privateLayoutWidget, "mFormatComboBox" );
     mMailboxFormatLabel->setBuddy( mFormatComboBox );
     QWhatsThis::add( mFormatComboBox, i18n( "Select whether you want to store the messages in this folder as one file per  message (maildir) or as one big file (mbox). KMail uses maildir by default and this only needs to be changed in rare circumstances. If you are unsure, leave this option as-is." ) );
 
@@ -119,7 +119,7 @@
     mContentsLabel->setText( i18n( "Folder &contains:" ) );
     mContentsHBox->addWidget( mContentsLabel );
 
-    mContentsComboBox = new QComboBox( FALSE, privateLayoutWidget, "mContentsComboBox" );
+    mContentsComboBox = new QComboBox( false, privateLayoutWidget, "mContentsComboBox" );
     mContentsLabel->setBuddy( mContentsComboBox );
     QWhatsThis::add( mContentsComboBox, i18n( "Select whether you want the new folder to be used for mail storage of for storage of groupware items such as tasks or notes. The default is mail. If you are unsure, leave this option as-is." ) );
     mContentsComboBox->insertItem( i18n( "Mail" ) );
@@ -160,7 +160,7 @@
       mNamespacesLabel->setText( i18n( "Namespace for &folder:" ) );
       mNamespacesHBox->addWidget( mNamespacesLabel );
 
-      mNamespacesComboBox = new QComboBox( FALSE, privateLayoutWidget, "mNamespacesComboBox" );
+      mNamespacesComboBox = new QComboBox( false, privateLayoutWidget, "mNamespacesComboBox" );
       mNamespacesLabel->setBuddy( mNamespacesComboBox );
       QWhatsThis::add( mNamespacesComboBox, i18n( "Select the personal namespace the folder should be created in." ) );
       mNamespacesComboBox->insertStringList( namespaces );
@@ -251,7 +251,7 @@
     KMAcctImap *anAccount = selectedStorage->account();
     // check if a connection is available BEFORE creating the folder
     if (anAccount->makeConnection() == ImapAccountBase::Connected) {
-      newFolder = kmkernel->imapFolderMgr()->createFolder( fldName, FALSE, KMFolderTypeImap, selectedFolderDir );
+      newFolder = kmkernel->imapFolderMgr()->createFolder( fldName, false, KMFolderTypeImap, selectedFolderDir );
       if ( newFolder ) {
         QString imapPath, parent;
         if ( mNamespacesComboBox ) {
@@ -259,7 +259,7 @@
           parent = anAccount->addPathToNamespace( mNamespacesComboBox->currentText() );
           imapPath = anAccount->createImapPath( parent, fldName );
         } else {
-          imapPath = anAccount->createImapPath( selectedStorage->imapPath(), fldName );  
+          imapPath = anAccount->createImapPath( selectedStorage->imapPath(), fldName );
         }
         KMFolderImap* newStorage = static_cast<KMFolderImap*>( newFolder->storage() );
         selectedStorage->createFolder(fldName, parent); // create it on the server
@@ -269,14 +269,14 @@
       }
     }
   } else if ( mFolder && mFolder->folderType() == KMFolderTypeCachedImap ) {
-    newFolder = kmkernel->dimapFolderMgr()->createFolder( fldName, FALSE, KMFolderTypeCachedImap, selectedFolderDir );
+    newFolder = kmkernel->dimapFolderMgr()->createFolder( fldName, false, KMFolderTypeCachedImap, selectedFolderDir );
     if ( newFolder ) {
       KMFolderCachedImap* selectedStorage = static_cast<KMFolderCachedImap*>( mFolder->storage() );
       KMFolderCachedImap* newStorage = static_cast<KMFolderCachedImap*>( newFolder->storage() );
       newStorage->initializeFrom( selectedStorage );
       if ( mNamespacesComboBox ) {
         // create folder with namespace
-        QString path = selectedStorage->account()->createImapPath( 
+        QString path = selectedStorage->account()->createImapPath(
             mNamespacesComboBox->currentText(), fldName );
         newStorage->setImapPathForCreation( path );
       }
@@ -285,9 +285,9 @@
   } else {
     // local folder
     if (mFormatComboBox->currentItem() == 1)
-      newFolder = kmkernel->folderMgr()->createFolder(fldName, FALSE, KMFolderTypeMaildir, selectedFolderDir );
+      newFolder = kmkernel->folderMgr()->createFolder(fldName, false, KMFolderTypeMaildir, selectedFolderDir );
     else
-      newFolder = kmkernel->folderMgr()->createFolder(fldName, FALSE, KMFolderTypeMbox, selectedFolderDir );
+      newFolder = kmkernel->folderMgr()->createFolder(fldName, false, KMFolderTypeMbox, selectedFolderDir );
     if ( newFolder )
       success = true;
   }
Index: kmail/folderdiaquotatab_p.cpp
===================================================================
--- kmail/folderdiaquotatab_p.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/folderdiaquotatab_p.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -71,8 +71,6 @@
       layout->addWidget( mProgressBar, 2, 1 );
       box->addWidget( stuff );
       box->addStretch( 2 );
-
-      readConfig();
 }
 
 void QuotaWidget::setQuotaInfo( const QuotaInfo& info )
@@ -81,31 +79,10 @@
       // casting to int is safe
       int current = info.current().toInt();
       int max = info.max().toInt();
-      int factor = static_cast<int> ( pow( 1000, mFactor ) );
       mProgressBar->setProgress( current, max );
-      mInfoLabel->setText( i18n("%1 of %2 %3 used").arg( current/factor )
-                                .arg( max/factor ).arg( mUnits ) );
+      mInfoLabel->setText( info.toString() );
       mRootLabel->setText( info.root() );
 }
 
-void QuotaWidget::readConfig()
-{
-      if( GlobalSettings::self()->quotaUnit() == GlobalSettings::EnumQuotaUnit::KB )
-      {
-            mUnits = QString( i18n("KB") );
-            mFactor = 0;
-      }
-      else if( GlobalSettings::self()->quotaUnit() == GlobalSettings::EnumQuotaUnit::MB )
-           {
-                mUnits = QString( i18n("MB") );
-                mFactor = 1;
-           }
-      else if( GlobalSettings::self()->quotaUnit() == GlobalSettings::EnumQuotaUnit::GB )
-           {
-               mUnits = QString( i18n("GB") );
-               mFactor = 2;
-           }
-}
 
-
 #include "folderdiaquotatab_p.moc"
Index: kmail/snippetdlg.cpp
===================================================================
--- kmail/snippetdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,96 @@
+
+#include "snippetdlg.h"
+
+#include <kdialog.h>
+#include <klocale.h>
+
+#include <qlabel.h>
+#include <qlayout.h>
+#include <kpushbutton.h>
+#include <ktextedit.h>
+#include "kkeybutton.h"
+#include "kactioncollection.h"
+#include "kmessagebox.h"
+
+/*
+ *  Constructs a SnippetDlg as a child of 'parent', with the
+ *  name 'name' and widget flags set to 'f'.
+ *
+ *  The dialog will by default be modeless, unless you set 'modal' to
+ *  TRUE to construct a modal dialog.
+ */
+SnippetDlg::SnippetDlg( KActionCollection* ac, QWidget* parent, const char* name, bool modal, WFlags fl )
+    : SnippetDlgBase( parent, name, modal, fl ), actionCollection( ac )
+{
+    if ( !name )
+	setName( "SnippetDlg" );
+
+    textLabel3 = new QLabel( this, "textLabel3" );
+    keyButton = new KKeyButton( this );
+    connect( keyButton, SIGNAL( capturedShortcut( const KShortcut& ) ),
+             this, SLOT( slotCapturedShortcut( const KShortcut& ) ) );
+
+    layout3->addWidget( textLabel3, 7, 0 );
+    layout3->addWidget( keyButton, 7, 1 );
+
+    // tab order
+    setTabOrder( snippetText, keyButton );
+    setTabOrder( keyButton, btnAdd );
+    setTabOrder( btnAdd, btnCancel );
+
+    textLabel3->setBuddy( keyButton );
+    languageChange();
+}
+
+/*
+ *  Destroys the object and frees any allocated resources
+ */
+SnippetDlg::~SnippetDlg()
+{
+    // no need to delete child widgets, Qt does it all for us
+}
+
+/*
+ *  Sets the strings of the subwidgets using the current
+ *  language.
+ */
+void SnippetDlg::languageChange()
+{
+    textLabel3->setText( tr2i18n( "Sh&ortcut:" ) );
+}
+
+static bool shortcutIsValid( const KActionCollection* actionCollection, const KShortcut &sc )
+{
+  KActionPtrList actions = actionCollection->actions();
+  KActionPtrList::Iterator it( actions.begin() );
+  for ( ; it != actions.end(); it++ ) {
+    if ( (*it)->shortcut() == sc ) return false;
+  }
+  return true;
+}
+
+void SnippetDlg::slotCapturedShortcut( const KShortcut& sc )
+{
+
+    if ( sc == keyButton->shortcut() ) return;
+    if ( sc.toString().isNull() ) {
+      // null is fine, that's reset, but sc.—ñsNull() will be false :/
+      keyButton->setShortcut( KShortcut::null(), false );
+    } else {
+      if( !shortcutIsValid( actionCollection, sc ) ) {
+        QString msg( i18n( "The selected shortcut is already used, "
+              "please select a different one." ) );
+        KMessageBox::sorry( this, msg );
+      } else {
+        keyButton->setShortcut( sc, false );
+      }
+    }
+}
+
+void SnippetDlg::setShowShortcut( bool show )
+{
+    textLabel3->setShown( show );
+    keyButton->setShown( show );
+}
+
+#include "snippetdlg.moc"
Index: kmail/kmreadermainwin.cpp
===================================================================
--- kmail/kmreadermainwin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmreadermainwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,6 +28,7 @@
 
 #include <qaccel.h>
 #include <kapplication.h>
+#include <kedittoolbar.h>
 #include <klocale.h>
 #include <kstdaccel.h>
 #include <kwin.h>
@@ -42,7 +43,11 @@
 #include "kmmainwidget.h"
 #include "kmfoldertree.h"
 #include "kmmsgdict.h"
+#include "csshelper.h"
+#include "messageactions.h"
 
+#include "globalsettings.h"
+
 #include "kmreadermainwin.h"
 
 KMReaderMainWin::KMReaderMainWin( bool htmlOverride, bool htmlLoadExtOverride,
@@ -55,6 +60,8 @@
   mReaderWin->setAutoDelete( true );
   mReaderWin->setHtmlOverride( htmlOverride );
   mReaderWin->setHtmlLoadExtOverride( htmlLoadExtOverride );
+  mReaderWin->setDecryptMessageOverwrite( true );
+  mReaderWin->setShowSignatureDetails( false );
   initKMReaderMainWin();
 }
 
@@ -88,7 +95,8 @@
 void KMReaderMainWin::initKMReaderMainWin() {
   setCentralWidget( mReaderWin );
   setupAccel();
-  setupGUI( ToolBar | Keys | StatusBar | Create, "kmreadermainwin.rc" );
+  setupGUI( Keys | StatusBar | Create, "kmreadermainwin.rc" );
+  setupForwardingActionsList();
   applyMainWindowSettings( KMKernel::config(), "Separate Reader Window" );
   if ( ! mReaderWin->message() ) {
     menuBar()->hide();
@@ -99,6 +107,26 @@
            this, SLOT( slotConfigChanged() ) );
 }
 
+void KMReaderMainWin::setupForwardingActionsList()
+{
+  QPtrList<KAction> mForwardActionList;
+  if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
+      unplugActionList( "forward_action_list" );
+      mForwardActionList.append( mForwardInlineAction );
+      mForwardActionList.append( mForwardAttachedAction );
+      mForwardActionList.append( mForwardDigestAction );
+      mForwardActionList.append( mRedirectAction );
+      plugActionList( "forward_action_list", mForwardActionList );
+  } else {
+      unplugActionList( "forward_action_list" );
+      mForwardActionList.append( mForwardAttachedAction );
+      mForwardActionList.append( mForwardInlineAction );
+      mForwardActionList.append( mForwardDigestAction );
+      mForwardActionList.append( mRedirectAction );
+      plugActionList( "forward_action_list", mForwardActionList );
+  }
+}
+
 //-----------------------------------------------------------------------------
 KMReaderMainWin::~KMReaderMainWin()
 {
@@ -119,6 +147,7 @@
   mReaderWin->slotTouchMessage();
   setCaption( msg->subject() );
   mMsg = msg;
+  mMsgActions->setCurrentMessage( msg );
   menuBar()->show();
   toolBar( "mainToolBar" )->show();
 
@@ -137,6 +166,8 @@
 //-----------------------------------------------------------------------------
 void KMReaderMainWin::slotTrashMsg()
 {
+  if ( !mMsg )
+    return;
   // find the real msg by its sernum
   KMFolder* parent;
   int index;
@@ -180,46 +211,14 @@
 //-----------------------------------------------------------------------------
 void KMReaderMainWin::slotPrintMsg()
 {
-  KMCommand *command = new KMPrintCommand( this, mReaderWin->message(),
+  KMPrintCommand *command = new KMPrintCommand( this, mReaderWin->message(),
       mReaderWin->htmlOverride(), mReaderWin->htmlLoadExtOverride(),
       mReaderWin->isFixedFont(), mReaderWin->overrideEncoding() );
+  command->setOverrideFont( mReaderWin->cssHelper()->bodyFont( mReaderWin->isFixedFont(), true /*printing*/ ) );
   command->start();
 }
 
 //-----------------------------------------------------------------------------
-void KMReaderMainWin::slotReplyToMsg()
-{
-  KMCommand *command = new KMReplyToCommand( this, mReaderWin->message(),
-      mReaderWin->copyText() );
-  command->start();
-}
-
-
-//-----------------------------------------------------------------------------
-void KMReaderMainWin::slotReplyAuthorToMsg()
-{
-  KMCommand *command = new KMReplyAuthorCommand( this, mReaderWin->message(),
-      mReaderWin->copyText() );
-  command->start();
-}
-
-//-----------------------------------------------------------------------------
-void KMReaderMainWin::slotReplyAllToMsg()
-{
-  KMCommand *command = new KMReplyToAllCommand( this, mReaderWin->message(),
-      mReaderWin->copyText() );
-  command->start();
-}
-
-//-----------------------------------------------------------------------------
-void KMReaderMainWin::slotReplyListToMsg()
-{
-  KMCommand *command = new KMReplyListCommand( this, mReaderWin->message(),
-      mReaderWin->copyText() );
-  command->start();
-}
-
-//-----------------------------------------------------------------------------
 void KMReaderMainWin::slotForwardInlineMsg()
 {
    KMCommand *command = 0;
@@ -287,6 +286,8 @@
   if ( kmkernel->xmlGuiInstance() )
     setInstance( kmkernel->xmlGuiInstance() );
 
+  mMsgActions = new KMail::MessageActions( actionCollection(), this );
+  mMsgActions->setMessageView( mReaderWin );
   //----- File Menu
   //mOpenAction = KStdAction::open( this, SLOT( slotOpenMsg() ),
   //                                actionCollection() );
@@ -326,66 +327,60 @@
   mForwardActionMenu = new KActionMenu( i18n("Message->","&Forward"),
 					"mail_forward", actionCollection(),
 					"message_forward" );
-  connect( mForwardActionMenu, SIGNAL( activated() ), this,
-           SLOT( slotForwardInlineMsg() ) );
-
-  mForwardAttachedAction = new KAction( i18n("Message->Forward->","As &Attachment..."),
-                                        "mail_forward", Key_F, this,
-					SLOT(slotForwardAttachedMsg()),
-                                        actionCollection(),
-					"message_forward_as_attachment" );
-  mForwardActionMenu->insert( mForwardAttachedAction );
-
-  mForwardInlineAction = new KAction( i18n("&Inline..."),
+      mForwardInlineAction = new KAction( i18n("&Inline..."),
                                       "mail_forward", SHIFT+Key_F, this,
                                       SLOT(slotForwardInlineMsg()),
                                       actionCollection(),
                                       "message_forward_inline" );
-  mForwardActionMenu->insert( mForwardInlineAction );
 
-  mForwardDigestAction = new KAction( i18n("Message->Forward->","As Di&gest..."),
+      mForwardAttachedAction = new KAction( i18n("Message->Forward->","As &Attachment..."),
+                                        "mail_forward", Key_F, this,
+                                        SLOT(slotForwardAttachedMsg()),
+                                        actionCollection(),
+                                        "message_forward_as_attachment" );
+
+      mForwardDigestAction = new KAction( i18n("Message->Forward->","As Di&gest..."),
                                       "mail_forward", 0, this,
                                       SLOT(slotForwardDigestMsg()),
                                       actionCollection(),
                                       "message_forward_as_digest" );
-  mForwardActionMenu->insert( mForwardDigestAction );
 
-  mRedirectAction = new KAction( i18n("Message->Forward->","&Redirect..."),
-				 "mail_forward", Key_E, this,
+      mRedirectAction = new KAction( i18n("Message->Forward->","&Redirect..."),
+                                 "mail_forward", Key_E, this,
                                  SLOT(slotRedirectMsg()),
-				 actionCollection(),
+                                 actionCollection(),
                                  "message_forward_redirect" );
-  mForwardActionMenu->insert( mRedirectAction );
 
-  mReplyActionMenu = new KActionMenu( i18n("Message->","&Reply"),
-                                      "mail_reply", actionCollection(),
-                                      "message_reply_menu" );
-  connect( mReplyActionMenu, SIGNAL(activated()), this,
-	   SLOT(slotReplyToMsg()) );
+  if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
+      mForwardActionMenu->insert( mForwardInlineAction );
+      mForwardActionMenu->insert( mForwardAttachedAction );
+      mForwardInlineAction->setShortcut( Key_F );
+      mForwardAttachedAction->setShortcut( SHIFT+Key_F );
+      connect( mForwardActionMenu, SIGNAL(activated()), this,
+               SLOT(slotForwardInlineMsg()) );
+  } else {
+      mForwardActionMenu->insert( mForwardAttachedAction );
+      mForwardActionMenu->insert( mForwardInlineAction );
+      mForwardInlineAction->setShortcut( SHIFT+Key_F );
+      mForwardAttachedAction->setShortcut( Key_F );
+      connect( mForwardActionMenu, SIGNAL(activated()), this,
+               SLOT(slotForwardAttachedMsg()) );
+  }
 
-  mReplyAction = new KAction( i18n("&Reply..."), "mail_reply", Key_R, this,
-			      SLOT(slotReplyToMsg()), actionCollection(), "reply" );
-  mReplyActionMenu->insert( mReplyAction );
+  mForwardActionMenu->insert( mForwardDigestAction );
+  mForwardActionMenu->insert( mRedirectAction );
 
-  mReplyAuthorAction = new KAction( i18n("Reply to A&uthor..."), "mail_reply",
-                                    SHIFT+Key_A, this,
-                                    SLOT(slotReplyAuthorToMsg()),
-                                    actionCollection(), "reply_author" );
-  mReplyActionMenu->insert( mReplyAuthorAction );
+  fontAction = new KFontAction( "Select Font", 0, actionCollection(),
+                               "text_font" );
+  fontAction->setFont( mReaderWin->cssHelper()->bodyFont().family() );
+  connect( fontAction, SIGNAL( activated( const QString& ) ),
+           SLOT( slotFontAction( const QString& ) ) );
+  fontSizeAction = new KFontSizeAction( "Select Size", 0, actionCollection(),
+                                       "text_size" );
+  fontSizeAction->setFontSize( mReaderWin->cssHelper()->bodyFont().pointSize() );
+  connect( fontSizeAction, SIGNAL( fontSizeChanged( int ) ),
+           SLOT( slotSizeAction( int ) ) );
 
-  mReplyAllAction = new KAction( i18n("Reply to &All..."), "mail_replyall",
-				 Key_A, this, SLOT(slotReplyAllToMsg()),
-				 actionCollection(), "reply_all" );
-  mReplyActionMenu->insert( mReplyAllAction );
-
-  mReplyListAction = new KAction( i18n("Reply to Mailing-&List..."),
-				  "mail_replylist", Key_L, this,
-				  SLOT(slotReplyListToMsg()), actionCollection(),
-				  "reply_list" );
-  mReplyActionMenu->insert( mReplyListAction );
-
-
-
   QAccel *accel = new QAccel(mReaderWin, "showMsg()");
   accel->connectItem(accel->insertItem(Key_Up),
                      mReaderWin, SLOT(slotScrollUp()));
@@ -402,6 +397,8 @@
   connect(mReaderWin, SIGNAL(urlClicked(const KURL&,int)),
 	  mReaderWin, SLOT(slotUrlClicked()));
 
+  setStandardToolBarMenuEnabled(true);
+  KStdAction::configureToolbars(this, SLOT(slotEditToolbars()), actionCollection());
 }
 
 
@@ -437,7 +434,7 @@
   if(mReaderWin && !mReaderWin->copyText().isEmpty()) {
     if ( urlMenuAdded )
       menu->insertSeparator();
-    mReplyActionMenu->plug( menu );
+    mMsgActions->replyMenu()->plug( menu );
     menu->insertSeparator();
 
     mReaderWin->copyAction()->plug( menu );
@@ -460,7 +457,7 @@
       //
       // FIXME: needs custom templates added to menu
       // (see KMMainWidget::updateCustomTemplateMenus)
-      mReplyActionMenu->plug( menu );
+      mMsgActions->replyMenu()->plug( menu );
       mForwardActionMenu->plug( menu );
       menu->insertSeparator();
     }
@@ -478,6 +475,7 @@
     mPrintAction->plug( menu );
     mSaveAsAction->plug( menu );
     menu->insertItem( i18n("Save Attachments..."), mReaderWin, SLOT(slotSaveAttachments()) );
+    mMsgActions->createTodoAction()->plug( menu );
   }
   menu->exec(aPoint, 0);
   delete menu;
@@ -492,4 +490,44 @@
   command->start();
 }
 
+void KMReaderMainWin::slotFontAction( const QString& font)
+{
+  QFont f( mReaderWin->cssHelper()->bodyFont() );
+  f.setFamily( font );
+  mReaderWin->cssHelper()->setBodyFont( f );
+  mReaderWin->cssHelper()->setPrintFont( f );
+  mReaderWin->update();
+}
+
+void KMReaderMainWin::slotSizeAction( int size )
+{
+  QFont f( mReaderWin->cssHelper()->bodyFont() );
+  f.setPointSize( size );
+  mReaderWin->cssHelper()->setBodyFont( f );
+  mReaderWin->cssHelper()->setPrintFont( f );
+  mReaderWin->update();
+}
+
+void KMReaderMainWin::slotCreateTodo()
+{
+  if ( !mMsg )
+    return;
+  KMCommand *command = new CreateTodoCommand( this, mMsg );
+  command->start();
+}
+
+void KMReaderMainWin::slotEditToolbars()
+{
+  saveMainWindowSettings( KMKernel::config(), "ReaderWindow" );
+  KEditToolbar dlg( guiFactory(), this );
+  connect( &dlg, SIGNAL(newToolbarConfig()), SLOT(slotUpdateToolbars()) );
+  dlg.exec();
+}
+
+void KMReaderMainWin::slotUpdateToolbars()
+{
+  createGUI("kmreadermainwin.rc");
+  applyMainWindowSettings(KMKernel::config(), "ReaderWindow");
+}
+
 #include "kmreadermainwin.moc"
Index: kmail/kmmsgdict.h
===================================================================
--- kmail/kmmsgdict.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmsgdict.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -20,6 +20,9 @@
 #ifndef __KMMSGDICT
 #define __KMMSGDICT
 
+#include <qvaluelist.h>
+#include <qptrlist.h>
+
 class KMFolder;
 class KMMsgBase;
 class KMMessage;
@@ -68,6 +71,9 @@
    * @return the message serial number or zero is no such message can be found */
     unsigned long getMsgSerNum( KMFolder *folder, int index ) const;
 
+  /** Convert a list of KMMsgBase pointers to a list of serial numbers */
+    static QValueList<unsigned long> serNumList(QPtrList<KMMsgBase> msgList);
+
 private:
  /* FIXME It would be better to do without these, they are the classes
   * involved in filling and maintaining the dict. The MsgList needs access
Index: kmail/Makefile.am
===================================================================
--- kmail/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,6 +15,7 @@
         -I$(top_srcdir)/certmanager/lib/ui \
         -I$(top_srcdir)/indexlib \
         -I$(top_srcdir)/ktnef \
+        -I$(top_srcdir)/korganizer \
         -I$(top_srcdir) \
         $(GPGME_CFLAGS) \
         $(all_includes)
@@ -62,14 +63,13 @@
                 kmreaderwin.cpp htmlstatusbar.cpp kmmsgdict.cpp \
                 kmgroupware.cpp folderstorage.cpp \
                 csshelper.cpp klistboxdialog.cpp \
-                signatureconfigurationdialog.ui \
-                encryptionconfigurationdialog.ui \
                 actionscheduler.cpp messageproperty.cpp \
                 kmmsgpart.cpp kmmsginfo.cpp \
                 accountmanager.cpp kmacctfolder.cpp kmdict.cpp \
                 kmsystemtray.cpp kmacctlocal.cpp kmfolderdir.cpp \
                 kmfoldermgr.cpp kmfoldernode.cpp kmsender.cpp \
                 kmacctseldlg.cpp kmfiltermgr.cpp kmsearchpatternedit.cpp \
+		filterimporterexporter.cpp \
                 kmfilteraction.cpp kmsearchpattern.cpp \
                 kmfolderseldlg.cpp kmfilter.cpp kmfilterdlg.cpp \
                 kmmsgbase.cpp kmmsglist.cpp kmaddrbook.cpp  \
@@ -92,8 +92,8 @@
                 mailcomposerIface.skel objecttreeparser.cpp \
                 attachmentcollector.cpp \
                 bodypartformatter.cpp bodypartformatterfactory.cpp \
-                partNode.cpp signatureconfigurationdialogimpl.cpp \
-                encryptionconfigurationdialogimpl.cpp mailsourceviewer.cpp \
+                partNode.cpp \
+                mailsourceviewer.cpp \
                 kmcommands.cpp kmreadermainwin.cpp \
                 kmstartup.cpp kmmainwidget.cpp \
                 folderpropertiesdialog.ui kmfolderindex.cpp \
@@ -135,7 +135,21 @@
                 templateparser.cpp \
                 copyfolderjob.cpp \
                 messagecopyhelper.cpp \
-                localsubscriptiondialog.cpp
+                localsubscriptiondialog.cpp \
+                editorwatcher.cpp \
+                kcalendariface.stub \
+                favoritefolderview.cpp \
+                foldertreebase.cpp \
+                snippetdlgbase.ui \
+                snippet_widget.cpp \
+                snippetconfig.cpp \
+                snippetdlg.cpp \
+                snippetitem.cpp \
+                snippetsettings.cpp \
+                snippetsettingsbase.ui \
+                scalix.cpp \
+                messageactions.cpp \
+                korghelper.cpp
 
 libkmailprivate_la_COMPILE_FIRST = globalsettings_base.h customtemplates_base.h templatesconfiguration_base.h
 
@@ -145,6 +159,8 @@
 
 libkmailpart_la_SOURCES =  kmailpartIface.skel  kmail_part.cpp
 
+libkmailpart_la_COMPILE_FIRST = globalsettings_base.h customtemplates_base.h templatesconfiguration_base.h
+
 check_PROGRAMS = dcoptest recipienteditortest
 
 METASOURCES = AUTO
@@ -161,6 +177,7 @@
 kmailicalIface_DCOPIDLNG = true
 
 korganizeriface_DIR = $(top_srcdir)/korganizer
+kcalendariface_DIR = $(top_srcdir)/korganizer
 
 include_HEADERS = kmailIface.h kmailpartIface.h kmailicalIface.h
 
Index: kmail/kmaccount.h
===================================================================
--- kmail/kmaccount.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmaccount.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -216,7 +216,7 @@
    * @return whether mail checks can proceed
    */
   virtual bool mailCheckCanProceed() const { return true; }
-  
+
   /**
    * Set/Get if this account is currently checking mail
    */
@@ -245,6 +245,12 @@
     return mMailCheckProgressItem;
   }
 
+  /**
+   * Set/get identity for checking account.
+   */
+  void setIdentityId(uint identityId ) { mIdentityId = identityId; }
+  uint identityId() const{ return mIdentityId; }
+
 signals:
   /**
    * Emitted after the mail check is finished.
@@ -303,9 +309,9 @@
   QGuardedPtr<KMAcctFolder> mFolder;
   QTimer *mTimer;
   int mInterval; // this is a switch and a scalar at the same time. If it is 0,
-  // interval mail checking is turned off and the interval spinbox proposes a 
+  // interval mail checking is turned off and the interval spinbox proposes a
   // default value. If it is non-null, it is the count of minutes between two
-  // automated mail checks. This means that as soon as you disable interval 
+  // automated mail checks. This means that as soon as you disable interval
   // mail checking, the value in the spin box returns to a default value.
   bool mExclude;
   bool mCheckingMail : 1;
@@ -314,7 +320,7 @@
   QPtrList<FolderJob>  mJobList;
   bool mHasInbox : 1;
   QGuardedPtr<ProgressItem> mMailCheckProgressItem;
-
+  uint mIdentityId;
 private:
     /**
      * avoid compiler warning about hidden virtual
Index: kmail/snippet_widget.h
===================================================================
--- kmail/snippet_widget.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippet_widget.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,91 @@
+/*
+ *  File : snippet_widget.h
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#ifndef __SNIPPET_WIDGET_H__
+#define __SNIPPET_WIDGET_H__
+
+#include <qwidget.h>
+#include <qstring.h>
+#include <klistview.h>
+#include <qtooltip.h>
+#include <qrect.h>
+
+#include <ktexteditor/editinterface.h>
+#include <ktexteditor/view.h>
+#include "snippetconfig.h"
+
+class KDevProject;
+class SnippetPart;
+class QPushButton;
+class KListView;
+class QListViewItem;
+class QPoint;
+class SnippetDlg;
+class SnippetItem;
+class KTextEdit;
+class KConfig;
+class KMEdit;
+class KActionCollection;
+
+/**
+This is the widget which gets added to the right TreeToolView.
+It inherits KListView and QToolTip which is needed for showing the
+tooltips which contains the text of the snippet
+@author Robert Gruber
+*/
+class SnippetWidget : public KListView, public QToolTip
+{
+  Q_OBJECT
+
+public:
+    SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent = 0);
+    ~SnippetWidget();
+    QPtrList<SnippetItem> * getList() { return (&_list); }
+    void writeConfig();
+    SnippetConfig *  getSnippetConfig() { return (&_SnippetConfig); }
+
+
+private slots:
+    void initConfig();
+
+protected:
+    void maybeTip( const QPoint & );
+    bool acceptDrag (QDropEvent *event) const;
+
+private:
+    void insertIntoActiveView( const QString &text );
+    QString parseText(QString text, QString del="$");
+    bool showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
+                            int & iWidth, int & iBasicHeight, int & iOneHeight);
+    QString showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize);
+    SnippetItem* makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut );
+
+    QPtrList<SnippetItem> _list;
+    QMap<QString, QString> _mapSaved;
+    KConfig * _cfg;
+    SnippetConfig _SnippetConfig;
+    KMEdit* mEditor;
+    KActionCollection* mActionCollection;
+
+public slots:
+    void slotRemove();
+    void slotEdit( QListViewItem* item_ = 0 );
+    void slotEditGroup();
+    void slotAdd();
+    void slotAddGroup();
+    void slotExecute();
+
+protected slots:
+    void showPopupMenu( QListViewItem * item, const QPoint & p, int );
+    void slotExecuted(QListViewItem * item =  0);
+    void slotDropped(QDropEvent *e, QListViewItem *after);
+    void startDrag();
+};
+
+
+#endif
Index: kmail/undostack.cpp
===================================================================
--- kmail/undostack.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/undostack.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -88,7 +88,7 @@
     UndoInfo *info = mStack.take(0);
     emit undoStackChanged();
     QValueList<ulong>::iterator itr;
-    info->destFolder->open("undodest");
+    KMFolderOpener openDestFolder(info->destFolder, "undodest");
     for( itr = info->serNums.begin(); itr != info->serNums.end(); ++itr ) {
       serNum = *itr;
       KMMsgDict::instance()->getLocation(serNum, &curFolder, &idx);
@@ -102,7 +102,6 @@
       if ( info->srcFolder->count() > 1 )
         info->srcFolder->unGetMsg( info->srcFolder->count() - 1 );
     }
-    info->destFolder->close("undodest");
     delete info;
   }
   else
Index: kmail/kmsearchpattern.h
===================================================================
--- kmail/kmsearchpattern.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmsearchpattern.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -270,6 +270,8 @@
 public:
    KMSearchRuleStatus( const QCString & field=0, Function function=FuncContains,
 		       const QString & contents=QString::null );
+   KMSearchRuleStatus( int status, Function function=FuncContains );
+
   virtual bool isEmpty() const ;
   virtual bool matches( const KMMessage * msg ) const;
   //Not possible to implement this form for status searching
Index: kmail/messagecomposer.h
===================================================================
--- kmail/messagecomposer.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/messagecomposer.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -45,7 +45,6 @@
 
 class KMMessage;
 class KMComposeWin;
-class CryptPlugWrapper;
 
 class MessageComposerJob;
 class EncryptMessageJob;
Index: kmail/editorwatcher.cpp
===================================================================
--- kmail/editorwatcher.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/editorwatcher.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,177 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "editorwatcher.h"
+
+#include <config.h>
+
+#include <kdebug.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+#include <kopenwith.h>
+#include <kprocess.h>
+#include <kuserprofile.h>
+
+#include <qsocketnotifier.h>
+
+#include <cassert>
+
+// inotify stuff taken from kdelibs/kio/kio/kdirwatch.cpp
+#ifdef HAVE_INOTIFY
+#include <sys/ioctl.h>
+#include <unistd.h>
+#include <fcntl.h>
+#include <sys/syscall.h>
+#include <linux/types.h>
+// Linux kernel headers are documented to not compile
+#define _S390_BITOPS_H
+#include <linux/inotify.h>
+
+static inline int inotify_init (void)
+{
+  return syscall (__NR_inotify_init);
+}
+
+static inline int inotify_add_watch (int fd, const char *name, __u32 mask)
+{
+  return syscall (__NR_inotify_add_watch, fd, name, mask);
+}
+
+static inline int inotify_rm_watch (int fd, __u32 wd)
+{
+  return syscall (__NR_inotify_rm_watch, fd, wd);
+}
+#endif
+
+using namespace KMail;
+
+EditorWatcher::EditorWatcher(const KURL & url, const QString &mimeType, bool openWith, QObject * parent) :
+    QObject( parent ),
+    mUrl( url ),
+    mMimeType( mimeType ),
+    mOpenWith( openWith ),
+    mEditor( 0 ),
+    mHaveInotify( false ),
+    mFileOpen( false ),
+    mEditorRunning( false ),
+    mFileModified( true ), // assume the worst unless we know better
+    mDone( false )
+{
+  assert( mUrl.isLocalFile() );
+  connect( &mTimer, SIGNAL(timeout()), SLOT(checkEditDone()) );
+}
+
+bool EditorWatcher::start()
+{
+  // find an editor
+  KURL::List list;
+  list.append( mUrl );
+  KService::Ptr offer = KServiceTypeProfile::preferredService( mMimeType, "Application" );
+  if ( mOpenWith || !offer ) {
+    KOpenWithDlg dlg( list, i18n("Edit with:"), QString::null, 0 );
+    if ( !dlg.exec() )
+      return false;
+    offer = dlg.service();
+    if ( !offer )
+      return false;
+  }
+
+#ifdef HAVE_INOTIFY
+  // monitor file
+  mInotifyFd = inotify_init();
+  if ( mInotifyFd > 0 ) {
+    mInotifyWatch = inotify_add_watch( mInotifyFd, mUrl.path().latin1(), IN_CLOSE | IN_OPEN | IN_MODIFY );
+    if ( mInotifyWatch >= 0 ) {
+      QSocketNotifier *sn = new QSocketNotifier( mInotifyFd, QSocketNotifier::Read, this );
+      connect( sn, SIGNAL(activated(int)), SLOT(inotifyEvent()) );
+      mHaveInotify = true;
+      mFileModified = false;
+    }
+  } else {
+    kdWarning(5006) << k_funcinfo << "Failed to activate INOTIFY!" << endl;
+  }
+#endif
+
+  // start the editor
+  QStringList params = KRun::processDesktopExec( *offer, list, false );
+  mEditor = new KProcess( this );
+  *mEditor << params;
+  connect( mEditor, SIGNAL(processExited(KProcess*)), SLOT(editorExited()) );
+  if ( !mEditor->start() )
+    return false;
+  mEditorRunning = true;
+
+  mEditTime.start();
+  return true;
+}
+
+void EditorWatcher::inotifyEvent()
+{
+  assert( mHaveInotify );
+#ifdef HAVE_INOTIFY
+  int pending = -1;
+  char buffer[4096];
+  ioctl( mInotifyFd, FIONREAD, &pending );
+  while ( pending > 0 ) {
+    int size = read( mInotifyFd, buffer, QMIN( pending, (int)sizeof(buffer) ) );
+    pending -= size;
+    if ( size < 0 )
+      break; // error
+    int offset = 0;
+    while ( size > 0 ) {
+      struct inotify_event *event = (struct inotify_event *) &buffer[offset];
+      size -= sizeof( struct inotify_event ) + event->len;
+      offset += sizeof( struct inotify_event ) + event->len;
+      if ( event->mask & IN_OPEN )
+        mFileOpen = true;
+      if ( event->mask & IN_CLOSE )
+        mFileOpen = false;
+      if ( event->mask & IN_MODIFY )
+        mFileModified = true;
+    }
+  }
+#endif
+  mTimer.start( 500, true );
+
+}
+
+void EditorWatcher::editorExited()
+{
+  mEditorRunning = false;
+  mTimer.start( 500, true );
+}
+
+void EditorWatcher::checkEditDone()
+{
+  if ( mEditorRunning || (mFileOpen && mHaveInotify) || mDone )
+    return;
+  // protect us against double-deletion by calling this method again while
+  // the subeventloop of the message box is running
+  mDone = true;
+  // nobody can edit that fast, we seem to be unable to detect
+  // when the editor will be closed
+  if ( mEditTime.elapsed() <= 3000 ) {
+    KMessageBox::error( 0, i18n("KMail is unable to detect when the choosen editor is closed. "
+         "To avoid data loss, editing the attachment will be aborted."), i18n("Unable to edit attachment") );
+  }
+
+  emit editDone( this );
+  deleteLater();
+}
+
+#include "editorwatcher.moc"
Index: kmail/headeritem.cpp
===================================================================
--- kmail/headeritem.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/headeritem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -395,6 +395,7 @@
 
   QColor cdisabled = KGlobalSettings::inactiveTextColor();
   if ( headers->isMessageCut( msgSerNum() ) ) {
+    font.setItalic( true );
     color = &cdisabled;
   }
 
Index: kmail/headerlistquicksearch.cpp
===================================================================
--- kmail/headerlistquicksearch.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/headerlistquicksearch.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,6 +39,7 @@
 #include <kiconloader.h>
 #include <klistview.h>
 #include <klocale.h>
+#include <ktoolbarbutton.h>
 
 #include "kmheaders.h"
 #include "kmsearchpattern.h"
@@ -86,6 +87,10 @@
 
   label->setBuddy( mStatusCombo );
 
+  KToolBarButton * btn = new KToolBarButton( "mail_find", 0, parent,
+                                            0, i18n( "Open Full Search" ) );
+  connect( btn, SIGNAL( clicked() ), SIGNAL( requestFullSearch() ) );
+
   /* Disable the signal connected by KListViewSearchLine since it will call 
    * itemAdded during KMHeaders::readSortOrder() which will in turn result
    * in getMsgBaseForItem( item ) wanting to access items which are no longer
@@ -137,6 +142,7 @@
 
 bool HeaderListQuickSearch::itemMatches(const QListViewItem *item, const QString &s) const
 {
+  mCurrentSearchTerm = s; // bit of a hack, but works
   if ( mStatus != 0 ) {
     KMHeaders *headers = static_cast<KMHeaders*>( item->listView() );
     const KMMsgBase *msg = headers->getMsgBaseForItem( item );
@@ -170,6 +176,18 @@
   statusList.append( KMail::StatusValues[ which ].text );
 }
 
+
+QString HeaderListQuickSearch::currentSearchTerm() const
+{
+    return mCurrentSearchTerm;
+}
+
+
+int HeaderListQuickSearch::currentStatus() const
+{
+    return mStatus;
+}
+
 } // namespace KMail
 
 #include "headerlistquicksearch.moc"
Index: kmail/cachedimapjob.cpp
===================================================================
--- kmail/cachedimapjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/cachedimapjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -44,6 +44,7 @@
 #include "kmacctcachedimap.h"
 #include "kmmsgdict.h"
 #include "maildirjob.h"
+#include "scalix.h"
 #include "util.h"
 
 #include <kio/scheduler.h>
@@ -146,6 +147,34 @@
   // All necessary conditions have been met. Register this job
   mAccount->mJobList.append(this);
 
+  /**
+   * The Scalix server requires to send him a custom X-SCALIX-ID command
+   * to switch it into a special mode.
+   *
+   * This should be done once after the login and before the first command.
+   */
+  if ( mAccount->groupwareType() == KMAcctCachedImap::GroupwareScalix ) {
+    if ( !mAccount->sentCustomLoginCommand() ) {
+      QByteArray packedArgs;
+      QDataStream stream( packedArgs, IO_WriteOnly );
+
+      const QString command = QString( "X-SCALIX-ID " );
+      const QString argument = QString( "(\"name\" \"Evolution\" \"version\" \"2.10.0\")" );
+
+      stream << (int) 'X' << 'N' << command << argument;
+
+      const KURL url = mAccount->getUrl();
+
+      ImapAccountBase::jobData jd( url.url(), mFolder->folder() );
+      jd.items << mFolder->label(); // for the err msg
+      KIO::SimpleJob *simpleJob = KIO::special( url.url(), packedArgs, false );
+      KIO::Scheduler::assignJobToSlave(mAccount->slave(), simpleJob);
+      mAccount->insertJob(simpleJob, jd);
+
+      mAccount->setSentCustomLoginCommand( true );
+    }
+  }
+
   switch( mType ) {
   case tGetMessage:       slotGetNextMessage();     break;
   case tPutMessage:       slotPutNextMessage();     break;
@@ -310,7 +339,7 @@
   mMsg->setUID(mfd.uid);
   mMsg->setMsgSizeServer(mfd.size);
   if( mfd.flags > 0 )
-    KMFolderImap::flagsToStatus(mMsg, mfd.flags);
+    KMFolderImap::flagsToStatus(mMsg, mfd.flags, true, GlobalSettings::allowLocalFlags() ? mFolder->permanentFlags() : INT_MAX);
   KURL url = mAccount->getUrl();
   url.setPath(mFolder->imapPath() + QString(";UID=%1;SECTION=BODY.PEEK[]").arg(mfd.uid));
 
@@ -365,7 +394,7 @@
   }
 
   KURL url = mAccount->getUrl();
-  QString flags = KMFolderImap::statusToFlags( mMsg->status() );
+  QString flags = KMFolderImap::statusToFlags( mMsg->status(), mFolder->permanentFlags() );
   url.setPath( mFolder->imapPath() + ";SECTION=" + flags );
 
   ImapAccountBase::jobData jd( url.url(), mFolder->folder() );
@@ -515,6 +544,18 @@
     if( job->error() ) {
       delete this;
       return;
+    } else {
+      KMFolderCachedImap* storage = static_cast<KMFolderCachedImap*>( (*it).current->storage() );
+      KMFolderCachedImap* parentStorage = static_cast<KMFolderCachedImap*>( (*it).parent->storage() );
+      Q_ASSERT( storage );
+      Q_ASSERT( parentStorage );
+      if ( storage->imapPath().isEmpty() ) {
+        QString path = mAccount->createImapPath( parentStorage->imapPath(), storage->folder()->name() );
+        if ( !storage->imapPathForCreation().isEmpty() )
+          path = storage->imapPathForCreation();
+        storage->setImapPath( path );
+        storage->writeConfig();
+      }
     }
     mAccount->removeJob( it );
   }
@@ -528,7 +569,7 @@
   KMFolderCachedImap *folder = mFolderList.front();
   mFolderList.pop_front();
   KURL url = mAccount->getUrl();
-  QString path = mAccount->createImapPath( mFolder->imapPath(), 
+  QString path = mAccount->createImapPath( mFolder->imapPath(),
       folder->folder()->name() );
   if ( !folder->imapPathForCreation().isEmpty() ) {
     // the folder knows it's namespace
@@ -536,16 +577,37 @@
   }
   url.setPath( path );
 
-  // Associate the jobData with the parent folder, not with the child
-  // This is necessary in case of an error while creating the subfolder,
-  // so that folderComplete is called on the parent (and the sync resetted).
-  ImapAccountBase::jobData jd( url.url(), mFolder->folder() );
-  jd.items << folder->label(); // for the err msg
-  KIO::SimpleJob *simpleJob = KIO::mkdir(url);
-  KIO::Scheduler::assignJobToSlave(mAccount->slave(), simpleJob);
-  mAccount->insertJob(simpleJob, jd);
-  connect( simpleJob, SIGNAL(result(KIO::Job *)),
-           this, SLOT(slotAddNextSubfolder(KIO::Job *)) );
+  if ( mAccount->groupwareType() != KMAcctCachedImap::GroupwareScalix ) {
+    // Associate the jobData with the parent folder, not with the child
+    // This is necessary in case of an error while creating the subfolder,
+    // so that folderComplete is called on the parent (and the sync resetted).
+    ImapAccountBase::jobData jd( url.url(), mFolder->folder() );
+    jd.items << folder->label(); // for the err msg
+    jd.current = folder->folder();
+    KIO::SimpleJob *simpleJob = KIO::mkdir(url);
+    KIO::Scheduler::assignJobToSlave(mAccount->slave(), simpleJob);
+    mAccount->insertJob(simpleJob, jd);
+    connect( simpleJob, SIGNAL(result(KIO::Job *)),
+             this, SLOT(slotAddNextSubfolder(KIO::Job *)) );
+  } else {
+    QByteArray packedArgs;
+    QDataStream stream( packedArgs, IO_WriteOnly );
+
+    const QString command = QString( "X-CREATE-SPECIAL" );
+    const QString argument = QString( "%1 %2" ).arg( Scalix::Utils::contentsTypeToScalixId( folder->contentsType() ) )
+                                               .arg( path );
+
+    stream << (int) 'X' << 'N' << command << argument;
+
+    ImapAccountBase::jobData jd( url.url(), mFolder->folder() );
+    jd.items << folder->label(); // for the err msg
+    jd.current = folder->folder();
+    KIO::SimpleJob *simpleJob = KIO::special( url.url(), packedArgs, false );
+    KIO::Scheduler::assignJobToSlave(mAccount->slave(), simpleJob);
+    mAccount->insertJob(simpleJob, jd);
+    connect( simpleJob, SIGNAL(result(KIO::Job *)),
+             this, SLOT(slotAddNextSubfolder(KIO::Job *)) );
+  }
 }
 
 
@@ -646,6 +708,19 @@
                     << mFolder->name() << endl;
   }
 
+  a = cstr.find( "X-PermanentFlags: " );
+  if ( a < 0 ) {
+    kdDebug(5006) << "no PERMANENTFLAGS response? assumming custom flags are not available" << endl;
+  } else {
+    int b = cstr.find( "\r\n", a );
+    if ( (b - a - 18) >= 0 ) {
+      int flags = cstr.mid( a + 18, b - a - 18 ).toInt();
+      emit permanentFlags( flags );
+    } else {
+      kdDebug(5006) << "PERMANENTFLAGS response broken, assumming custom flags are not available" << endl;
+    }
+  }
+
   mAccount->removeJob(it);
   delete this;
 }
Index: kmail/kmpopfiltercnfrmdlg.cpp
===================================================================
--- kmail/kmpopfiltercnfrmdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmpopfiltercnfrmdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -278,7 +278,7 @@
 /////////////////////////////////////////
 /////////////////////////////////////////
 KMPopFilterCnfrmDlg::KMPopFilterCnfrmDlg(QPtrList<KMPopHeaders> *aHeaders, const QString &aAccount, bool aShowLaterMsgs, QWidget *aParent, const char *aName)
-      : KDialogBase(aParent, aName, TRUE, i18n("POP Filter"), Ok | Help, Ok, FALSE)
+      : KDialogBase(aParent, aName, true, i18n("POP Filter"), Ok | Help, Ok, false)
 {
   unsigned int rulesetCount = 0;
   //mHeaders = aHeaders;
Index: kmail/kmsender.h
===================================================================
--- kmail/kmsender.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmsender.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -100,7 +100,7 @@
   void readConfig();
 
   /** Write configuration to global config with optional sync() */
-  void writeConfig(bool withSync=TRUE);
+  void writeConfig(bool withSync=true);
 
 private:
   /** sets a status msg and emits statusMsg() */
Index: kmail/kmail_config_composer.desktop
===================================================================
--- kmail/kmail_config_composer.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_config_composer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -71,6 +71,7 @@
 Comment[da]=Skabeloner & Generel opf√∏rsel
 Comment[de]=Vorlagen und allgemeines Verhalten
 Comment[el]=Œ†œÅœåœÑœÖœÄŒ± & Œ≥ŒµŒΩŒπŒ∫ŒÆ Œ£œÖŒºœÄŒµœÅŒπœÜŒøœÅŒ¨
+Comment[eo]=≈úablonoj kaj ƒúenerala Konduto
 Comment[es]=Plantilla y comportamiento general
 Comment[et]=Mallid ja √ºldine k√§itumine
 Comment[fa]=ÿπÿ®ÿßÿ±ÿ™Ÿáÿß Ÿà ÿ±ŸÅÿ™ÿßÿ± ÿπŸÖŸàŸÖ€å
Index: kmail/kmlineeditspell.cpp
===================================================================
--- kmail/kmlineeditspell.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmlineeditspell.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,6 +32,7 @@
                        QWidget *parent, const char *name)
     : KPIM::AddresseeLineEdit(parent,useCompletion,name)
 {
+   allowSemiColonAsSeparator( GlobalSettings::allowSemicolonAsAddressSeparator() );
 }
 
 
Index: kmail/kmsearchpattern.cpp
===================================================================
--- kmail/kmsearchpattern.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmsearchpattern.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -99,7 +99,7 @@
                                              Function func,
                                              const QString & contents )
 {
-  KMSearchRule *ret;
+  KMSearchRule *ret = 0;
   if (field == "<status>")
     ret = new KMSearchRuleStatus( field, func, contents );
   else if ( field == "<age in days>" || field == "<size>" )
@@ -610,8 +610,16 @@
 // class KMSearchRuleStatus
 //
 //==================================================
+QString englishNameForStatus( const KMMsgStatus& status )
+{
+  for ( int i=0; i< numStatusNames; i++ ) {
+    if ( statusNames[i].status == status ) {
+      return statusNames[i].name;
+    }
+  }
+  return QString::null;
+}
 
-
 KMSearchRuleStatus::KMSearchRuleStatus( const QCString & field,
                                         Function func, const QString & aContents )
           : KMSearchRule(field, func, aContents)
@@ -621,9 +629,14 @@
   mStatus = statusFromEnglishName( aContents );
 }
 
-KMMsgStatus KMSearchRuleStatus::statusFromEnglishName(
-      const QString & aStatusString )
+KMSearchRuleStatus::KMSearchRuleStatus( int status, Function func )
+: KMSearchRule( "<status>", func, englishNameForStatus( status ) )
 {
+    mStatus = status;
+}
+
+KMMsgStatus KMSearchRuleStatus::statusFromEnglishName( const QString & aStatusString )
+{
   for ( int i=0; i< numStatusNames; i++ ) {
     if ( !aStatusString.compare( statusNames[i].name ) ) {
       return statusNames[i].status;
@@ -760,9 +773,7 @@
     return false;
   }
 
-  bool opened = folder->isOpened();
-  if ( !opened )
-    folder->open("searchptr");
+  KMFolderOpener openFolder(folder, "searchptr");
   KMMsgBase *msgBase = folder->getMsgBase(idx);
   if (requiresBody() && !ignoreBody) {
     bool unGet = !msgBase->isMessage();
@@ -776,8 +787,6 @@
   } else {
     res = matches( folder->getDwString(idx), ignoreBody );
   }
-  if ( !opened )
-    folder->close("searchptr");
   return res;
 }
 
@@ -910,8 +919,11 @@
   setName( other.name() );
 
   clear(); // ###
-  for ( QPtrListIterator<KMSearchRule> it( other ) ; it.current() ; ++it )
-    append( KMSearchRule::createInstance( **it ) ); // deep copy
 
+  for ( QPtrListIterator<KMSearchRule> it( other ) ; it.current() ; ++it ) {
+    KMSearchRule * rule = KMSearchRule::createInstance( **it ); // deep copy
+    append( rule );
+  }
+
   return *this;
 }
Index: kmail/searchwindow.cpp
===================================================================
--- kmail/searchwindow.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/searchwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -322,12 +322,18 @@
                                         "mail_forward", 0, this,
                                         SLOT(slotForwardAttachedMsg()), ac,
                                         "search_message_forward_as_attachment" );
-  mForwardActionMenu->insert( mForwardAttachedAction );
   mForwardInlineAction = new KAction( i18n("&Inline..."),
                                       "mail_forward", 0, this,
                                       SLOT(slotForwardInlineMsg()), ac,
                                       "search_message_forward_inline" );
-  mForwardActionMenu->insert( mForwardInlineAction );
+  if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
+    mForwardActionMenu->insert( mForwardInlineAction );
+    mForwardActionMenu->insert( mForwardAttachedAction );
+  } else {
+    mForwardActionMenu->insert( mForwardAttachedAction );
+    mForwardActionMenu->insert( mForwardInlineAction );
+  }
+
   mForwardDigestAction = new KAction( i18n("Message->Forward->","As Di&gest..."),
                                       "mail_forward", 0, this,
                                       SLOT(slotForwardDigestMsg()), ac,
@@ -401,7 +407,7 @@
         folderName = search->currentFolder();
     }
 
-    if (mFolder && mFolder->search() && !mFolder->search()->running()) {
+    if (search && !search->running()) {
         procMsg = i18n("%n message searched", "%n messages searched",
                        numProcessed);
         if(!mStopped) {
@@ -489,7 +495,7 @@
       }
 
       if (!folder)
-        folder = mgr->createFolder(fullName, FALSE, KMFolderTypeSearch,
+        folder = mgr->createFolder(fullName, false, KMFolderTypeSearch,
             &mgr->dir());
 
       mFolder = dynamic_cast<KMFolderSearch*>( folder->storage() );
@@ -778,7 +784,7 @@
 {
     if (!lvi)
         return;
-    mLbxMatches->setSelected( lvi, TRUE );
+    mLbxMatches->setSelected( lvi, true );
     mLbxMatches->setCurrentItem( lvi );
     // FIXME is this ever unGetMsg()'d?
     if (!message())
@@ -907,5 +913,12 @@
   mKMMainWidget->headers()->setCopiedMessages( list, true );
 }
 
+
+void SearchWindow::setSearchPattern( const KMSearchPattern& pattern )
+{
+    *mSearchPattern = pattern;
+    mPatternEdit->setSearchPattern( mSearchPattern );
+}
+
 } // namespace KMail
 #include "searchwindow.moc"
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -65,6 +65,7 @@
 #endif
 
 #include <kasciistringtools.h>
+#include <kstringhandler.h>
 
 #include <mimelib/mimepp.h>
 #include <mimelib/body.h>
@@ -107,6 +108,7 @@
 #include <kiconloader.h>
 #include <kmdcodec.h>
 #include <kasciistricmp.h>
+#include <kurldrag.h>
 
 #include <qclipboard.h>
 #include <qhbox.h>
@@ -489,6 +491,9 @@
     mAttachmentStrategy( 0 ),
     mHeaderStrategy( 0 ),
     mHeaderStyle( 0 ),
+    mUpdateReaderWinTimer( 0, "mUpdateReaderWinTimer" ),
+    mResizeTimer( 0, "mResizeTimer" ),
+    mDelayedMarkTimer( 0, "mDelayedMarkTimer" ),
     mOldGlobalOverrideEncoding( "---" ), // init with dummy value
     mCSSHelper( 0 ),
     mRootNode( 0 ),
@@ -510,9 +515,8 @@
     mToggleFixFontAction( 0 ),
     mHtmlWriter( 0 ),
     mSavedRelativePosition( 0 ),
-    updateReaderWinTimer( 0, "updateReaderWinTimer" ),
-    mResizeTimer( 0, "mResizeTimer" ),
-    mDelayedMarkTimer( 0, "mDelayedMarkTimer" )
+    mDecrytMessageOverwrite( false ),
+    mShowSignatureDetails( false )
 {
   mSplitterSizes << 180 << 100;
   mMimeTreeMode = 1;
@@ -537,7 +541,7 @@
 
   mLevelQuote = GlobalSettings::self()->collapseQuoteLevelSpin() - 1;
 
-  connect( &updateReaderWinTimer, SIGNAL(timeout()),
+  connect( &mUpdateReaderWinTimer, SIGNAL(timeout()),
   	   this, SLOT(updateReaderWin()) );
   connect( &mResizeTimer, SIGNAL(timeout()),
   	   this, SLOT(slotDelayedResize()) );
@@ -560,6 +564,13 @@
   connect( headerMenu, SIGNAL(activated()),
            this, SLOT(slotCycleHeaderStyles()) );
 
+  raction = new KRadioAction( i18n("View->headers->", "&Enterprise Headers"), 0,
+                              this, SLOT(slotEnterpriseHeaders()),
+                              ac, "view_headers_enterprise" );
+  raction->setToolTip( i18n("Show the list of headers in Enterprise style") );
+  raction->setExclusiveGroup( "view_headers_group" );
+  headerMenu->insert(raction);
+
   raction = new KRadioAction( i18n("View->headers->", "&Fancy Headers"), 0,
                               this, SLOT(slotFancyHeaders()),
                               ac, "view_headers_fancy" );
@@ -681,6 +692,8 @@
   if ( !mActionCollection )
     return 0;
   const char * actionName = 0;
+  if ( style == HeaderStyle::enterprise() )
+    actionName = "view_headers_enterprise";
   if ( style == HeaderStyle::fancy() )
     actionName = "view_headers_fancy";
   else if ( style == HeaderStyle::brief() )
@@ -718,6 +731,11 @@
     return 0;
 }
 
+void KMReaderWin::slotEnterpriseHeaders() {
+  setHeaderStyleAndStrategy( HeaderStyle::enterprise(),
+                             HeaderStrategy::rich() );
+}
+
 void KMReaderWin::slotFancyHeaders() {
   setHeaderStyleAndStrategy( HeaderStyle::fancy(),
                              HeaderStrategy::rich() );
@@ -758,6 +776,10 @@
   const HeaderStyle * style = headerStyle();
 
   const char * actionName = 0;
+  if ( style == HeaderStyle::enterprise() ) {
+    slotFancyHeaders();
+    actionName = "view_headers_fancy";
+  }
   if ( style == HeaderStyle::fancy() ) {
     slotBriefHeaders();
     actionName = "view_headers_brief";
@@ -772,8 +794,8 @@
       slotAllHeaders();
       actionName = "view_headers_all";
     } else if ( strategy == HeaderStrategy::all() ) {
-      slotFancyHeaders();
-      actionName = "view_headers_fancy";
+      slotEnterpriseHeaders();
+      actionName = "view_headers_enterprise";
     }
   }
 
@@ -1118,6 +1140,13 @@
   update( true );
 }
 
+
+void KMReaderWin::setPrintFont( const QFont& font )
+{
+
+  mCSSHelper->setPrintFont( font );
+}
+
 //-----------------------------------------------------------------------------
 const QTextCodec * KMReaderWin::overrideCodec() const
 {
@@ -1222,18 +1251,18 @@
     // Avoid flicker, somewhat of a cludge
     if (force) {
       // stop the timer to avoid calling updateReaderWin twice
-      updateReaderWinTimer.stop();
+      mUpdateReaderWinTimer.stop();
       updateReaderWin();
     }
-    else if (updateReaderWinTimer.isActive())
-      updateReaderWinTimer.changeInterval( delay );
+    else if (mUpdateReaderWinTimer.isActive())
+      mUpdateReaderWinTimer.changeInterval( delay );
     else
-      updateReaderWinTimer.start( 0, TRUE );
+      mUpdateReaderWinTimer.start( 0, true );
   }
 
   if ( aMsg && (aMsg->isUnread() || aMsg->isNew()) && GlobalSettings::self()->delayedMarkAsRead() ) {
     if ( GlobalSettings::self()->delayedMarkTime() != 0 )
-      mDelayedMarkTimer.start( GlobalSettings::self()->delayedMarkTime() * 1000, TRUE );
+      mDelayedMarkTimer.start( GlobalSettings::self()->delayedMarkTime() * 1000, true );
     else
       slotTouchMessage();
   }
@@ -1242,7 +1271,7 @@
 //-----------------------------------------------------------------------------
 void KMReaderWin::clearCache()
 {
-  updateReaderWinTimer.stop();
+  mUpdateReaderWinTimer.stop();
   clear();
   mDelayedMarkTimer.stop();
   mLastSerNum = 0;
@@ -1488,6 +1517,8 @@
 
   htmlWriter()->queue("</body></html>");
   htmlWriter()->flush();
+
+  QTimer::singleShot( 1, this, SLOT(injectAttachments()) );
 }
 
 
@@ -1549,7 +1580,7 @@
       writeMessagePartToTempFile( &vCardNode->msgPart(), vCardNode->nodeId() );
     }
   }
-  htmlWriter()->queue( writeMsgHeader(aMsg, hasVCard) );
+  htmlWriter()->queue( writeMsgHeader(aMsg, hasVCard, true ) );
 
   // show message content
   ObjectTreeParser otp( this );
@@ -1658,7 +1689,7 @@
 
 
 //-----------------------------------------------------------------------------
-QString KMReaderWin::writeMsgHeader(KMMessage* aMsg, bool hasVCard)
+QString KMReaderWin::writeMsgHeader(KMMessage* aMsg, bool hasVCard, bool topLevel)
 {
   kdFatal( !headerStyle(), 5006 )
     << "trying to writeMsgHeader() without a header style set!" << endl;
@@ -1668,7 +1699,7 @@
   if (hasVCard)
     href = QString("file:") + KURL::encode_string( mTempFiles.last() );
 
-  return headerStyle()->format( aMsg, headerStrategy(), href, mPrinting );
+  return headerStyle()->format( aMsg, headerStrategy(), href, mPrinting, topLevel );
 }
 
 
@@ -1751,13 +1782,18 @@
 {
   if (aUrl.isEmpty()) return -1;
 
+  bool ok;
+  if ( aUrl.url().startsWith( "#att" ) ) {
+    int res = aUrl.url().mid( 4 ).toInt( &ok );
+    if ( ok ) return res;
+  }
+
   if (!aUrl.isLocalFile()) return -1;
 
   QString path = aUrl.path();
   uint right = path.findRev('/');
   uint left = path.findRev('.', right);
 
-  bool ok;
   int res = path.mid(left + 1, right - left - 1).toInt(&ok);
   return (ok) ? res : -1;
 }
@@ -1797,10 +1833,19 @@
   serNums.append( message()->getMsgSerNum() );
   KMCommand *command = new KMSetStatusCommand( KMMsgStatusRead, serNums );
   command->start();
+
+  // should we send an MDN?
   if ( mNoMDNsWhenEncrypted &&
        message()->encryptionState() != KMMsgNotEncrypted &&
        message()->encryptionState() != KMMsgEncryptionStateUnknown )
     return;
+
+  KMFolder *folder = message()->parent();
+  if (folder &&
+     (folder->isOutbox() || folder->isSent() || folder->isTrash() ||
+      folder->isDrafts() || folder->isTemplates() ) )
+    return;
+
   if ( KMMessage * receipt = message()->createMDN( MDN::ManualAction,
 						   MDN::Displayed,
 						   true /* allow GUI */ ) )
@@ -1863,12 +1908,19 @@
 //-----------------------------------------------------------------------------
 void KMReaderWin::slotUrlOn(const QString &aUrl)
 {
+  const KURL url(aUrl);
+  if ( url.protocol() == "kmail" || url.protocol() == "x-kmail"
+       || (url.protocol().isEmpty() && url.path().isEmpty()) ) {
+    mViewer->setDNDEnabled( false );
+  } else {
+    mViewer->setDNDEnabled( true );
+  }
+
   if ( aUrl.stripWhiteSpace().isEmpty() ) {
     KPIM::BroadcastStatus::instance()->reset();
     return;
   }
 
-  const KURL url(aUrl);
   mUrlClicked = url;
 
   const QString msg = URLHandlerManager::instance()->statusBarMessage( url, this );
@@ -1915,6 +1967,11 @@
   menu->insertItem(i18n("Open With..."), 2);
   menu->insertItem(i18n("to view something", "View"), 3);
   menu->insertItem(SmallIcon("filesaveas"),i18n("Save As..."), 4);
+  menu->insertItem(SmallIcon("editcopy"), i18n("Copy"), 9 );
+  if ( GlobalSettings::self()->allowAttachmentEditing() )
+    menu->insertItem(SmallIcon("edit"), i18n("Edit Attachment"), 8 );
+  if ( GlobalSettings::self()->allowAttachmentDeletion() )
+    menu->insertItem(SmallIcon("editdelete"), i18n("Delete Attachment"), 7 );
   if ( name.endsWith( ".xia", false ) &&
        Kleo::CryptoBackendFactory::instance()->protocol( "Chiasmus" ) )
     menu->insertItem( i18n( "Decrypt With Chiasmus..." ), 6 );
@@ -1953,12 +2010,28 @@
 {
   mAtmUpdate = true;
   partNode* node = mRootNode ? mRootNode->findId( mAtmCurrent ) : 0;
+  if ( mAtmCurrentName.isEmpty() && node )
+    mAtmCurrentName = tempFileUrlFromPartNode( node ).path();
+  if ( choice < 7 ) {
   KMHandleAttachmentCommand* command = new KMHandleAttachmentCommand(
       node, message(), mAtmCurrent, mAtmCurrentName,
       KMHandleAttachmentCommand::AttachmentAction( choice ), 0, this );
   connect( command, SIGNAL( showAttachment( int, const QString& ) ),
       this, SLOT( slotAtmView( int, const QString& ) ) );
   command->start();
+  } else if ( choice == 7 ) {
+    slotDeleteAttachment( node );
+  } else if ( choice == 8 ) {
+    slotEditAttachment( node );
+  } else if ( choice == 9 ) {
+    if ( !node ) return;
+    KURL::List urls;
+    KURL url = tempFileUrlFromPartNode( node );
+    if (!url.isValid() ) return;
+    urls.append( url );
+    KURLDrag* drag = new KURLDrag( urls, this );
+    QApplication::clipboard()->setData( drag, QClipboard::Clipboard );
+  }
 }
 
 //-----------------------------------------------------------------------------
@@ -2126,6 +2199,8 @@
   if( node ) {
     mAtmCurrent = id;
     mAtmCurrentName = name;
+    if ( mAtmCurrentName.isEmpty() )
+      mAtmCurrentName = tempFileUrlFromPartNode( node ).path();
 
     KMMessagePart& msgPart = node->msgPart();
     QString pname = msgPart.fileName();
@@ -2159,6 +2234,8 @@
     kdWarning(5006) << "KMReaderWin::openAttachment - could not find node " << id << endl;
     return;
   }
+  if ( mAtmCurrentName.isEmpty() )
+    mAtmCurrentName = tempFileUrlFromPartNode( node ).path();
 
   KMMessagePart& msgPart = node->msgPart();
   if (kasciistricmp(msgPart.typeStr(), "message")==0)
@@ -2469,6 +2546,27 @@
   return mRootNode ? mRootNode->findId( id ) : 0 ;
 }
 
+
+KURL KMReaderWin::tempFileUrlFromPartNode( const partNode * node )
+{
+  if (!node) return KURL();
+  QStringList::const_iterator it = mTempFiles.begin();
+  QStringList::const_iterator end = mTempFiles.end();
+
+  while ( it != end ) {
+      QString path = *it;
+      it++;
+      uint right = path.findRev('/');
+      uint left = path.findRev('.', right);
+
+      bool ok;
+      int res = path.mid(left + 1, right - left - 1).toInt(&ok);
+      if ( res == node->nodeId() )
+          return KURL( path );
+  }
+  return KURL();
+}
+
 //-----------------------------------------------------------------------------
 void KMReaderWin::slotSaveAttachments()
 {
@@ -2496,25 +2594,6 @@
 }
 
 //-----------------------------------------------------------------------------
-QString KMReaderWin::createAtmFileLink() const
-{
-  QFileInfo atmFileInfo(mAtmCurrentName);
-
-  KTempFile *linkFile = new KTempFile( locateLocal("tmp", atmFileInfo.fileName() +"_["),
-                          "]."+ atmFileInfo.extension() );
-
-  linkFile->setAutoDelete(true);
-  QString linkName = linkFile->name();
-  delete linkFile;
-
-  if ( link(QFile::encodeName(mAtmCurrentName), QFile::encodeName(linkName)) == 0 ) {
-    return linkName; // success
-  }
-  kdWarning(5006) << "Couldn't link to " << mAtmCurrentName << endl;
-  return QString::null;
-}
-
-//-----------------------------------------------------------------------------
 bool KMReaderWin::eventFilter( QObject *, QEvent *e )
 {
   if ( e->type() == QEvent::MouseButtonPress ) {
@@ -2532,6 +2611,121 @@
   return false;
 }
 
+void KMReaderWin::slotDeleteAttachment(partNode * node)
+{
+  if ( KMessageBox::warningContinueCancel( this,
+       i18n("Deleting an attachment might invalidate any digital signature on this message."),
+       i18n("Delete Attachment"), KStdGuiItem::del(), "DeleteAttachmentSignatureWarning" )
+     != KMessageBox::Continue ) {
+    return;
+  }
+  KMDeleteAttachmentCommand* command = new KMDeleteAttachmentCommand( node, message(), this );
+  command->start();
+}
+
+void KMReaderWin::slotEditAttachment(partNode * node)
+{
+  if ( KMessageBox::warningContinueCancel( this,
+        i18n("Modifying an attachment might invalidate any digital signature on this message."),
+        i18n("Edit Attachment"), KGuiItem( i18n("Edit"), "edit" ), "EditAttachmentSignatureWarning" )
+        != KMessageBox::Continue ) {
+    return;
+  }
+  KMEditAttachmentCommand* command = new KMEditAttachmentCommand( node, message(), this );
+  command->start();
+}
+
+KMail::CSSHelper* KMReaderWin::cssHelper()
+{
+  return mCSSHelper;
+}
+
+bool KMReaderWin::decryptMessage() const
+{
+  if ( !GlobalSettings::self()->alwaysDecrypt() )
+    return mDecrytMessageOverwrite;
+  return true;
+}
+
+void KMReaderWin::injectAttachments()
+{
+  // inject attachments in header view
+  // we have to do that after the otp has run so we also see encrypted parts
+  DOM::Document doc = mViewer->htmlDocument();
+  DOM::Element injectionPoint = doc.getElementById( "attachmentInjectionPoint" );
+  if ( injectionPoint.isNull() )
+    return;
+
+  QString html = renderAttachments( mRootNode, QApplication::palette().active().background() );
+  if ( html.isEmpty() )
+    return;
+  if ( headerStyle() == HeaderStyle::fancy() )
+    html.prepend( QString::fromLatin1("<div style=\"float:left;\">%1&nbsp;</div>" ).arg(i18n("Attachments:")) );
+  assert( injectionPoint.tagName() == "div" );
+  static_cast<DOM::HTMLElement>( injectionPoint ).setInnerHTML( html );
+}
+
+static QColor nextColor( const QColor & c )
+{
+  int h, s, v;
+  c.hsv( &h, &s, &v );
+  return QColor( (h + 50) % 360, QMAX(s, 64), v, QColor::Hsv );
+}
+
+QString KMReaderWin::renderAttachments(partNode * node, const QColor &bgColor )
+{
+  if ( !node )
+    return QString();
+
+  QString html;
+  if ( node->firstChild() ) {
+    QString subHtml = renderAttachments( node->firstChild(), nextColor( bgColor ) );
+    if ( !subHtml.isEmpty() ) {
+      QString margin;
+      if ( node != mRootNode || headerStyle() != HeaderStyle::enterprise() )
+        margin = "padding:2px; margin:2px; ";
+      if ( node->msgPart().typeStr() == "message" || node == mRootNode )
+        html += QString::fromLatin1("<div style=\"background:%1; %2"
+            "vertical-align:middle; float:left;\">").arg( bgColor.name() ).arg( margin );
+      html += subHtml;
+      if ( node->msgPart().typeStr() == "message" || node == mRootNode )
+        html += "</div>";
+    }
+  } else {
+    QString label, icon;
+    icon = node->msgPart().iconName( KIcon::Small );
+    label = node->msgPart().contentDescription();
+    if( label.isEmpty() )
+      label = node->msgPart().name().stripWhiteSpace();
+    if( label.isEmpty() )
+      label = node->msgPart().fileName();
+    bool typeBlacklisted = node->msgPart().typeStr() == "multipart";
+    if ( !typeBlacklisted && node->msgPart().typeStr() == "application" ) {
+      typeBlacklisted = node->msgPart().subtypeStr() == "pgp-encrypted"
+          || node->msgPart().subtypeStr() == "pgp-signature"
+          || node->msgPart().subtypeStr() == "pkcs7-mime"
+          || node->msgPart().subtypeStr() == "pkcs7-signature";
+    }
+    typeBlacklisted = typeBlacklisted || node == mRootNode;
+    if ( !label.isEmpty() && !icon.isEmpty() && !typeBlacklisted ) {
+      html += "<div style=\"float:left;\">";
+      html += "<span style=\"white-space:nowrap;\">";
+      html += QString::fromLatin1( "<a href=\"#att%1\">" ).arg( node->nodeId() );
+      html += "<img style=\"vertical-align:middle;\" src=\"" + icon + "\"/>&nbsp;";
+      if ( headerStyle() == HeaderStyle::enterprise() ) {
+        QFont bodyFont = mCSSHelper->bodyFont( isFixedFont() );
+        QFontMetrics fm( bodyFont );
+        html += KStringHandler::rPixelSqueeze( label, fm, 140 );
+      } else
+        html += label;
+      html += "</a></span></div> ";
+    }
+  }
+
+  html += renderAttachments( node->nextSibling(), bgColor );
+  return html;
+}
+
 #include "kmreaderwin.moc"
 
 
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmessage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,7 +31,6 @@
 
 #include <kasciistringtools.h>
 
-#include <cryptplugwrapperlist.h>
 #include <kpgpblock.h>
 #include <kaddrbook.h>
 
@@ -86,6 +85,8 @@
 //helper
 static void applyHeadersToMessagePart( DwHeaders& headers, KMMessagePart* aPart );
 
+QValueList<KMMessage*> KMMessage::sPendingDeletes;
+
 //-----------------------------------------------------------------------------
 KMMessage::KMMessage(DwMessage* aMsg)
   : KMMsgBase()
@@ -135,7 +136,7 @@
   if ( aMsg ) {
     mMsg = aMsg;
   } else {
-  mMsg = new DwMessage;
+    mMsg = new DwMessage;
   }
   mOverrideCodec = 0;
   mDecodeHTML = false;
@@ -152,6 +153,7 @@
   mUnencryptedMsg = 0;
   mLastUpdated = 0;
   mCursorPos = 0;
+  mMsgInfo = 0;
   mIsParsed = false;
 }
 
@@ -190,6 +192,7 @@
 //-----------------------------------------------------------------------------
 KMMessage::~KMMessage()
 {
+  delete mMsgInfo;
   delete mMsg;
   kmkernel->undoStack()->msgDestroyed( this );
 }
@@ -200,7 +203,7 @@
 {
   if (!aStr) return;
   mMsg->Headers().References().FromString(aStr);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -229,7 +232,7 @@
 //-----------------------------------------------------------------------------
 bool KMMessage::isMessage() const
 {
-  return TRUE;
+  return true;
 }
 
 //-----------------------------------------------------------------------------
@@ -243,6 +246,15 @@
 void KMMessage::setTransferInProgress(bool value, bool force)
 {
   MessageProperty::setTransferInProgress( getMsgSerNum(), value, force );
+  if ( !transferInProgress() && sPendingDeletes.contains( this ) ) {
+    sPendingDeletes.remove( this );
+    if ( parent() ) {
+      int idx = parent()->find( this );
+      if ( idx > 0 ) {
+        parent()->removeMsg( idx );
+      }
+    }
+  }
 }
 
 
@@ -284,7 +296,7 @@
 {
   if (mNeedsAssembly)
   {
-    mNeedsAssembly = FALSE;
+    mNeedsAssembly = false;
     mMsg->Assemble();
   }
   return mMsg->AsString();
@@ -295,7 +307,7 @@
 {
   if (mNeedsAssembly)
   {
-    mNeedsAssembly = FALSE;
+    mNeedsAssembly = false;
     mMsg->Assemble();
   }
   return mMsg;
@@ -406,7 +418,7 @@
   if (attachmentState() == KMMsgAttachmentUnknown && readyToShow())
     updateAttachmentState();
 
-  mNeedsAssembly = FALSE;
+  mNeedsAssembly = false;
   mDate = date();
 }
 
@@ -1177,6 +1189,24 @@
   return str;
 }
 
+void KMMessage::sanitizeHeaders( const QStringList& whiteList )
+{
+   // Strip out all headers apart from the content description and other
+   // whitelisted ones, because we don't want to inherit them.
+   DwHeaders& header = mMsg->Headers();
+   DwField* field = header.FirstField();
+   DwField* nextField;
+   while (field)
+   {
+     nextField = field->Next();
+     if ( field->FieldNameStr().find( "ontent" ) == DwString::npos
+             && !whiteList.contains( QString::fromLatin1( field->FieldNameStr().c_str() ) ) )
+       header.RemoveField(field);
+     field = nextField;
+   }
+   mMsg->Assemble();
+}
+
 //-----------------------------------------------------------------------------
 KMMessage* KMMessage::createForward( const QString &tmpl /* = QString::null */ )
 {
@@ -1195,17 +1225,19 @@
     const int type = msg->type();
     const int subtype = msg->subtype();
 
-    // Strip out all headers apart from the content description ones, because we
-    // don't want to inherit them.
-    DwHeaders& header = msg->mMsg->Headers();
-    DwField* field = header.FirstField();
-    DwField* nextField;
-    while (field)
-    {
-      nextField = field->Next();
-      if ( field->FieldNameStr().find( "ontent" ) == DwString::npos )
-        header.RemoveField(field);
-      field = nextField;
+    msg->sanitizeHeaders();
+
+    // strip blacklisted parts
+    QStringList blacklist = GlobalSettings::self()->mimetypesToStripWhenInlineForwarding();
+    for ( QStringList::Iterator it = blacklist.begin(); it != blacklist.end(); ++it ) {
+      QString entry = (*it);
+      int sep = entry.find( '/' );
+      QCString type = entry.left( sep ).latin1();
+      QCString subtype = entry.mid( sep+1 ).latin1();
+      kdDebug( 5006 ) << "Looking for blacklisted type: " << type << "/" << subtype << endl;
+      while ( DwBodyPart * part = msg->findDwBodyPart( type, subtype ) ) {
+        msg->mMsg->Body().RemoveBodyPart( part );
+      }
     }
     msg->mMsg->Assemble();
 
@@ -1435,8 +1467,8 @@
     s = MDN::SentManually;
   }
 
-  if ( a != KMime::MDN::AutomaticAction ) { 
-    //TODO: only ingore user settings for AutomaticAction if requested 
+  if ( a != KMime::MDN::AutomaticAction ) {
+    //TODO: only ingore user settings for AutomaticAction if requested
     if ( mode == 1 ) { // ask
       if ( !allowGUI ) return 0; // don't setMDNSentState here!
       mode = requestAdviceOnMDN( "mdnNormalAsk" );
@@ -1560,7 +1592,19 @@
   QString result = s;
   QRegExp rx( "\\$\\{([a-z0-9-]+)\\}", false );
   Q_ASSERT( rx.isValid() );
+
+  QRegExp rxDate( "\\$\\{date\\}" );
+  Q_ASSERT( rxDate.isValid() );
+
+  QString sDate = KMime::DateFormatter::formatDate(
+                      KMime::DateFormatter::Localized, date() );
+
   int idx = 0;
+  if( ( idx = rxDate.search( result, idx ) ) != -1  ) {
+    result.replace( idx, rxDate.matchedLength(), sDate );
+  }
+
+  idx = 0;
   while ( ( idx = rx.search( result, idx ) ) != -1 ) {
     QString replacement = headerField( rx.cap(1).latin1() );
     result.replace( idx, rx.matchedLength(), replacement );
@@ -1695,7 +1739,7 @@
   DwField* nextField;
 
   if (mNeedsAssembly) mMsg->Assemble();
-  mNeedsAssembly = FALSE;
+  mNeedsAssembly = false;
 
   while (field)
   {
@@ -1703,7 +1747,7 @@
     if (field->FieldBody()->AsString().empty())
     {
       header.RemoveField(field);
-      mNeedsAssembly = TRUE;
+      mNeedsAssembly = true;
     }
     field = nextField;
   }
@@ -1726,7 +1770,7 @@
     // Create a random printable string and set it as the boundary parameter
     contentType.CreateBoundary(0);
   }
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -1807,8 +1851,8 @@
   mDate = aDate;
   mMsg->Headers().Date().FromCalendarTime(aDate);
   mMsg->Headers().Date().Assemble();
-  mNeedsAssembly = TRUE;
-  mDirty = TRUE;
+  mNeedsAssembly = true;
+  mDirty = true;
 }
 
 
@@ -1819,8 +1863,8 @@
 
   header.Date().FromString(aStr);
   header.Date().Parse();
-  mNeedsAssembly = TRUE;
-  mDirty = TRUE;
+  mNeedsAssembly = true;
+  mDirty = true;
 
   if (header.HasDate())
     mDate = header.Date().AsUnixTime();
@@ -1952,7 +1996,7 @@
   if (aStr.isNull())
     aStr = "";
   setHeaderField( "From", aStr, Address );
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 
@@ -1983,7 +2027,7 @@
 void KMMessage::setSubject(const QString& aStr)
 {
   setHeaderField("Subject",aStr);
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 
@@ -1998,7 +2042,7 @@
 void KMMessage::setXMark(const QString& aStr)
 {
   setHeaderField("X-KMail-Mark", aStr);
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 
@@ -2101,7 +2145,7 @@
 void KMMessage::setReplyToId(const QString& aStr)
 {
   setHeaderField("In-Reply-To", aStr);
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 
@@ -2132,7 +2176,7 @@
 void KMMessage::setMsgId(const QString& aStr)
 {
   setHeaderField("Message-Id", aStr);
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 //-----------------------------------------------------------------------------
@@ -2145,7 +2189,7 @@
 void KMMessage::setMsgSizeServer(size_t size)
 {
   setHeaderField("X-Length", QCString().setNum(size));
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 //-----------------------------------------------------------------------------
@@ -2158,7 +2202,7 @@
 void KMMessage::setUID(ulong uid)
 {
   setHeaderField("X-UID", QCString().setNum(uid));
-  mDirty = TRUE;
+  mDirty = true;
 }
 
 //-----------------------------------------------------------------------------
@@ -2248,10 +2292,20 @@
   if (!field) return;
 
   header.RemoveField(field);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
+//-----------------------------------------------------------------------------
+void KMMessage::removeHeaderFields(const QCString& aName)
+{
+  DwHeaders & header = mMsg->Headers();
+  while ( DwField * field = header.FindField(aName) ) {
+    header.RemoveField(field);
+    mNeedsAssembly = true;
+  }
+}
 
+
 //-----------------------------------------------------------------------------
 void KMMessage::setHeaderField( const QCString& aName, const QString& bValue,
                                 HeaderFieldType type, bool prepend )
@@ -2300,7 +2354,7 @@
     header.AddFieldAt( 1, field );
   else
     header.AddOrReplaceField( field );
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2327,7 +2381,7 @@
 {
   dwContentType().SetTypeStr(DwString(aStr));
   dwContentType().Parse();
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2336,7 +2390,7 @@
 {
   dwContentType().SetType(aType);
   dwContentType().Assemble();
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2364,7 +2418,7 @@
 {
   dwContentType().SetSubtypeStr(DwString(aStr));
   dwContentType().Parse();
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2373,7 +2427,7 @@
 {
   dwContentType().SetSubtype(aSubtype);
   dwContentType().Assemble();
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2406,9 +2460,9 @@
 void KMMessage::setContentTypeParam(const QCString& attr, const QCString& val)
 {
   if (mNeedsAssembly) mMsg->Assemble();
-  mNeedsAssembly = FALSE;
+  mNeedsAssembly = false;
   setDwMediaTypeParam( dwContentType(), attr, val );
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2437,7 +2491,7 @@
 {
   mMsg->Headers().ContentTransferEncoding().FromString(aStr);
   mMsg->Headers().ContentTransferEncoding().Parse();
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2445,7 +2499,7 @@
 void KMMessage::setContentTransferEncoding(int aCte)
 {
   mMsg->Headers().ContentTransferEncoding().FromEnum(aCte);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2644,7 +2698,7 @@
   }
 
   mMsg->Body().FromString(dwResult);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 //-----------------------------------------------------------------------------
@@ -2667,7 +2721,7 @@
   }
 
   mMsg->Body().FromString(dwResult);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -2675,17 +2729,17 @@
 void KMMessage::setBody(const QCString& aStr)
 {
   mMsg->Body().FromString(KMail::Util::dwString(aStr));
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 void KMMessage::setBody(const DwString& aStr)
 {
   mMsg->Body().FromString(aStr);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 void KMMessage::setBody(const char* aStr)
 {
   mMsg->Body().FromString(aStr);
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 void KMMessage::setMultiPartBody( const QCString & aStr ) {
@@ -2880,6 +2934,56 @@
   return part;
 }
 
+//-----------------------------------------------------------------------------
+DwBodyPart * KMMessage::findDwBodyPart( const QCString& type, const QCString&  subtype ) const
+{
+  DwBodyPart *part, *curpart;
+  QPtrList< DwBodyPart > parts;
+  // Get the DwBodyPart for this index
+
+  curpart = getFirstDwBodyPart();
+  part = 0;
+
+  while (curpart && !part) {
+    //dive into multipart messages
+    while(curpart
+	  && curpart->hasHeaders()
+	  && curpart->Headers().HasContentType()
+      && curpart->Body().FirstBodyPart()
+	  && (DwMime::kTypeMultipart == curpart->Headers().ContentType().Type()) ) {
+	parts.append( curpart );
+	curpart = curpart->Body().FirstBodyPart();
+    }
+    // this is where curPart->msgPart contains a leaf message part
+
+    // pending(khz): Find out WHY this look does not travel down *into* an
+    //               embedded "Message/RfF822" message containing a "Multipart/Mixed"
+    if (curpart && curpart->hasHeaders() && curpart->Headers().HasContentType() ) {
+      kdDebug(5006) << curpart->Headers().ContentType().TypeStr().c_str()
+            << "  " << curpart->Headers().ContentType().SubtypeStr().c_str() << endl;
+    }
+
+    if (curpart &&
+	curpart->hasHeaders() &&
+        curpart->Headers().HasContentType() &&
+	curpart->Headers().ContentType().TypeStr().c_str() == type &&
+	curpart->Headers().ContentType().SubtypeStr().c_str() == subtype) {
+	part = curpart;
+    } else {
+      // go up in the tree until reaching a node with next
+      // (or the last top-level node)
+      while (curpart && !(curpart->Next()) && !(parts.isEmpty())) {
+	curpart = parts.getLast();
+	parts.removeLast();
+      } ;
+      if (curpart)
+	curpart = curpart->Next();
+    }
+  }
+  return part;
+}
+
+
 void applyHeadersToMessagePart( DwHeaders& headers, KMMessagePart* aPart )
 {
   // TODO: Instead of manually implementing RFC2231 header encoding (i.e.
@@ -3022,6 +3126,11 @@
   mMsg->Body().DeleteBodyParts();
 }
 
+void KMMessage::removeBodyPart(DwBodyPart * dwPart)
+{
+  mMsg->Body().RemoveBodyPart( dwPart );
+  mNeedsAssembly = true;
+}
 
 //-----------------------------------------------------------------------------
 DwBodyPart* KMMessage::createDWBodyPart(const KMMessagePart* aPart)
@@ -3163,7 +3272,7 @@
 void KMMessage::addDwBodyPart(DwBodyPart * aDwPart)
 {
   mMsg->Body().AddBodyPart( aDwPart );
-  mNeedsAssembly = TRUE;
+  mNeedsAssembly = true;
 }
 
 
@@ -3652,7 +3761,7 @@
 }
 
 //-----------------------------------------------------------------------------
-QString KMMessage::emailAddrAsAnchor(const QString& aEmail, bool stripped)
+QString KMMessage::emailAddrAsAnchor(const QString& aEmail, bool stripped, const QString& cssStyle, bool aLink)
 {
   if( aEmail.isEmpty() )
     return aEmail;
@@ -3666,17 +3775,21 @@
        ++it ) {
     if( !(*it).isEmpty() ) {
       QString address = *it;
-      result += "<a href=\"mailto:"
+      if(aLink) {
+	result += "<a href=\"mailto:"
               + KMMessage::encodeMailtoUrl( address )
-              + "\">";
+	  + "\" "+cssStyle+">";
+      }
       if( stripped )
         address = KMMessage::stripEmailAddr( address );
       result += KMMessage::quoteHtmlChars( address, true );
-      result += "</a>, ";
+      if(aLink)
+	result += "</a>, ";
     }
   }
   // cut of the trailing ", "
-  result.truncate( result.length() - 2 );
+  if(aLink)
+    result.truncate( result.length() - 2 );
 
   //kdDebug(5006) << "KMMessage::emailAddrAsAnchor('" << aEmail
   //              << "') returns:\n-->" << result << "<--" << endl;
@@ -4249,3 +4362,8 @@
   }
   return "From " + str + " " + dateStr + "\n";
 }
+
+void KMMessage::deleteWhenUnused()
+{
+  sPendingDeletes << this;
+}
Index: kmail/partNode.cpp
===================================================================
--- kmail/partNode.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/partNode.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -341,10 +341,10 @@
 }
 
 
-int partNode::nodeId()
+int partNode::nodeId() const
 {
     int curId = 0;
-    partNode* rootNode = this;
+    partNode* rootNode = const_cast<partNode*>( this );
     while( rootNode->mRoot )
         rootNode = rootNode->mRoot;
     return rootNode->calcNodeIdOrFindNode( curId, this, 0, 0 );
Index: kmail/configuredialog_p.h
===================================================================
--- kmail/configuredialog_p.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/configuredialog_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -57,6 +57,7 @@
 class KFontRequester;
 class KIconButton;
 class KKeyButton;
+class QSpinBox;
 
 namespace Kpgp {
   class Config;
@@ -461,6 +462,7 @@
   QCheckBox    *mCustomColorCheck;
   ColorListBox *mColorList;
   QCheckBox    *mRecycleColorCheck;
+  QSpinBox     *mCloseToQuotaThreshold;
 };
 
 class AppearancePageLayoutTab : public ConfigModuleTab {
@@ -482,6 +484,7 @@
   QButtonGroup *mMIMETreeLocationGroup;
   QButtonGroup *mMIMETreeModeGroup;
   QButtonGroup *mReaderWindowModeGroup;
+  QCheckBox *mFavoriteFolderViewCB;
 };
 
 class AppearancePageHeadersTab : public ConfigModuleTab {
@@ -604,6 +607,7 @@
 
 private:
   QCheckBox     *mAutoAppSignFileCheck;
+  QCheckBox     *mTopQuoteCheck;
   QCheckBox     *mSmartQuoteCheck;
   QCheckBox     *mAutoRequestMDNCheck;
   QCheckBox	*mShowRecentAddressesInComposer;
@@ -826,6 +830,7 @@
   QButtonGroup *mMDNGroup;
   QButtonGroup *mOrigQuoteGroup;
   QCheckBox    *mAutomaticallyImportAttachedKeysCheck;
+  QCheckBox    *mAlwaysDecrypt;
 };
 
 
@@ -1007,9 +1012,8 @@
 
   QCheckBox* mHideGroupwareFolders;
   QCheckBox* mOnlyShowGroupwareFolders;
-  QCheckBox* mAutoResCB;
-  QCheckBox* mAutoDeclConflCB;
-  QCheckBox* mAutoDeclRecurCB;
+  QCheckBox* mSyncImmediately;
+  QCheckBox* mDeleteInvitations;
 
   QCheckBox* mLegacyMangleFromTo;
   QCheckBox* mLegacyBodyInvites;
Index: kmail/kmmimeparttree.h
===================================================================
--- kmail/kmmimeparttree.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmimeparttree.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -63,6 +63,13 @@
   void slotSaveAs();
   void slotSaveAsEncoded();
   void slotSaveAll();
+  void slotDelete();
+  void slotEdit();
+  void slotOpen();
+  void slotOpenWith();
+  void slotView();
+  void slotProperties();
+  void slotCopy();
 
 protected:
   /** reimplemented in order to update the frame width in case of a changed
@@ -76,6 +83,11 @@
   void saveSelectedBodyParts( bool encoded );
   void restoreLayoutIfPresent();
 
+  /* reimpl */
+  void startDrag();
+
+  void startHandleAttachmentCommand( int type );
+
 protected:
   KMReaderWin* mReaderWin;
   KMMimePartTreeItem* mCurrentContextMenuItem;
Index: kmail/composer.h
===================================================================
--- kmail/composer.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/composer.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -139,6 +139,8 @@
   public: // kmkernel, attachmentlistview
     virtual bool addAttach( const KURL url ) = 0;
 
+    virtual void disableWordWrap() = 0;
+
   public: // kmcommand
     /**
      * Add an attachment to the list.
Index: kmail/kmail.upd
===================================================================
--- kmail/kmail.upd	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail.upd	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -164,7 +164,8 @@
 Group=FolderSelectionDialog
 RemoveKey=Size
 # Trigger migration of all local imap flags to the server
-Id=3.5.7-imap-flag-migration
+# increment suffix every time you need to trigger that
+Id=3.5.7-imap-flag-migration-2
 Options=overwrite
 File=kmailrc
 Script=kmail-3.5-trigger-flag-migration.pl,perl
Index: kmail/kmailicalifaceimpl.h
===================================================================
--- kmail/kmailicalifaceimpl.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmailicalifaceimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,7 +56,8 @@
   // Local helper class
 class ExtraFolder {
 public:
-  ExtraFolder( KMFolder* f ) : folder( f ) {}
+  ExtraFolder( KMFolder* f );
+  ~ExtraFolder();
   QGuardedPtr<KMFolder> folder;
 };
 
@@ -123,7 +124,19 @@
                       Q_UINT32 sernum,
                       const QString& filename );
 
+  QString attachmentMimetype( const QString &resource,
+                              Q_UINT32 sernum,
+                              const QString &filename );
 
+  QStringList listAttachments( const QString &resource, Q_UINT32 sernum );
+
+
+  bool removeSubresource( const QString& );
+
+  bool addSubresource( const QString& resource,
+                       const QString& parent,
+                       const QString& contentsType );
+
   // tell KOrganizer about messages to be deleted
   void msgRemoved( KMFolder*, KMMessage* );
 
@@ -233,11 +246,14 @@
 private:
   /** Helper function for initFolders. Initializes a single folder. */
   KMFolder* initFolder( KMail::FolderContentsType contentsType );
+  KMFolder* initScalixFolder( KMail::FolderContentsType contentsType );
 
   void connectFolder( KMFolder* folder );
 
   KMFolder* extraFolder( const QString& type, const QString& folder );
 
+  void syncFolder( KMFolder* folder ) const;
+
   struct StandardFolderSearchResult
   {
     enum FoundEnum { FoundAndStandard, NotFound, FoundByType, FoundByName };
Index: kmail/messageactions.cpp
===================================================================
--- kmail/messageactions.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/messageactions.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,260 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "messageactions.h"
+
+#include "globalsettings.h"
+#include "kmfolder.h"
+#include "kmmessage.h"
+#include "kmreaderwin.h"
+
+#include <kaction.h>
+#include <kactioncollection.h>
+#include <kdebug.h>
+#include <klocale.h>
+
+#include <qwidget.h>
+
+using namespace KMail;
+
+MessageActions::MessageActions( KActionCollection *ac, QWidget * parent ) :
+    QObject( parent ),
+    mParent( parent ),
+    mActionCollection( ac ),
+    mCurrentMessage( 0 ),
+    mMessageView( 0 )
+{
+    mReplyActionMenu = new KActionMenu( i18n("Message->","&Reply"),
+                                      "mail_reply", mActionCollection,
+                                      "message_reply_menu" );
+  connect( mReplyActionMenu, SIGNAL(activated()), this,
+           SLOT(slotReplyToMsg()) );
+
+  mReplyAction = new KAction( i18n("&Reply..."), "mail_reply", Key_R, this,
+                              SLOT(slotReplyToMsg()), mActionCollection, "reply" );
+  mReplyActionMenu->insert( mReplyAction );
+
+  mReplyAuthorAction = new KAction( i18n("Reply to A&uthor..."), "mail_reply",
+                                    SHIFT+Key_A, this,
+                                    SLOT(slotReplyAuthorToMsg()),
+                                    mActionCollection, "reply_author" );
+  mReplyActionMenu->insert( mReplyAuthorAction );
+
+  mReplyAllAction = new KAction( i18n("Reply to &All..."), "mail_replyall",
+                                 Key_A, this, SLOT(slotReplyAllToMsg()),
+                                 mActionCollection, "reply_all" );
+  mReplyActionMenu->insert( mReplyAllAction );
+
+  mReplyListAction = new KAction( i18n("Reply to Mailing-&List..."),
+                                  "mail_replylist", Key_L, this,
+                                  SLOT(slotReplyListToMsg()), mActionCollection,
+                                  "reply_list" );
+  mReplyActionMenu->insert( mReplyListAction );
+
+  mNoQuoteReplyAction = new KAction( i18n("Reply Without &Quote..."), SHIFT+Key_R,
+    this, SLOT(slotNoQuoteReplyToMsg()), mActionCollection, "noquotereply" );
+
+
+  mCreateTodoAction = new KAction( i18n("Create Task..."), "mail_todo",
+                                   0, this, SLOT(slotCreateTodo()), mActionCollection,
+                                   "create_todo" );
+
+
+  mStatusMenu = new KActionMenu ( i18n( "Mar&k Message" ),
+                                  mActionCollection, "set_status" );
+
+  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &Read"), "kmmsgread",
+                                          i18n("Mark selected messages as read")),
+                                 0, this, SLOT(slotSetMsgStatusRead()),
+                                 mActionCollection, "status_read"));
+
+  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &New"), "kmmsgnew",
+                                          i18n("Mark selected messages as new")),
+                                 0, this, SLOT(slotSetMsgStatusNew()),
+                                 mActionCollection, "status_new" ));
+
+  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &Unread"), "kmmsgunseen",
+                                          i18n("Mark selected messages as unread")),
+                                 0, this, SLOT(slotSetMsgStatusUnread()),
+                                 mActionCollection, "status_unread"));
+
+  mStatusMenu->insert( new KActionSeparator( this ) );
+
+  mToggleFlagAction = new KToggleAction(i18n("Mark Message as &Important"), "mail_flag",
+                                 0, this, SLOT(slotSetMsgStatusFlag()),
+                                 mActionCollection, "status_flag");
+  mToggleFlagAction->setCheckedState( i18n("Remove &Important Message Mark") );
+  mStatusMenu->insert( mToggleFlagAction );
+
+  mToggleTodoAction = new KToggleAction(i18n("Mark Message as &Action Item"), "mail_todo",
+                                 0, this, SLOT(slotSetMsgStatusTodo()),
+                                 mActionCollection, "status_todo");
+  mToggleTodoAction->setCheckedState( i18n("Remove &Action Item Message Mark") );
+  mStatusMenu->insert( mToggleTodoAction );
+
+  mEditAction = new KAction( i18n("&Edit Message"), "edit", Key_T, this,
+                            SLOT(editCurrentMessage()), mActionCollection, "edit" );
+  mEditAction->plugAccel( mActionCollection->kaccel() );
+
+  updateActions();
+}
+
+void MessageActions::setCurrentMessage(KMMessage * msg)
+{
+  mCurrentMessage = msg;
+  if ( !msg ) {
+    mSelectedSernums.clear();
+    mVisibleSernums.clear();
+  }
+  updateActions();
+}
+
+void MessageActions::setSelectedSernums(const QValueList< Q_UINT32 > & sernums)
+{
+  mSelectedSernums = sernums;
+  updateActions();
+}
+
+void MessageActions::setSelectedVisibleSernums(const QValueList< Q_UINT32 > & sernums)
+{
+  mVisibleSernums = sernums;
+  updateActions();
+}
+
+void MessageActions::updateActions()
+{
+  const bool singleMsg = (mCurrentMessage != 0 && mSelectedSernums.count() <= 1);
+  const bool multiVisible = mVisibleSernums.count() > 0 || mCurrentMessage;
+  const bool flagsAvailable = GlobalSettings::self()->allowLocalFlags() ||
+      !((mCurrentMessage && mCurrentMessage->parent()) ? mCurrentMessage->parent()->isReadOnly() : true);
+
+  mCreateTodoAction->setEnabled( singleMsg );
+  mReplyActionMenu->setEnabled( singleMsg );
+  mReplyAction->setEnabled( singleMsg );
+  mNoQuoteReplyAction->setEnabled( singleMsg );
+  mReplyAuthorAction->setEnabled( singleMsg );
+  mReplyAllAction->setEnabled( singleMsg );
+  mReplyListAction->setEnabled( singleMsg );
+  mNoQuoteReplyAction->setEnabled( singleMsg );
+
+  mStatusMenu->setEnabled( multiVisible );
+  mToggleFlagAction->setEnabled( flagsAvailable );
+  mToggleTodoAction->setEnabled( flagsAvailable );
+
+  if ( mCurrentMessage ) {
+    mToggleTodoAction->setChecked( mCurrentMessage->isTodo() );
+    mToggleFlagAction->setChecked( mCurrentMessage->isImportant() );
+  }
+
+  mEditAction->setEnabled( singleMsg );
+}
+
+void MessageActions::slotCreateTodo()
+{
+  if ( !mCurrentMessage )
+    return;
+  KMCommand *command = new CreateTodoCommand( mParent, mCurrentMessage );
+  command->start();
+}
+
+void MessageActions::setMessageView(KMReaderWin * msgView)
+{
+  mMessageView = msgView;
+}
+
+void MessageActions::slotReplyToMsg()
+{
+  replyCommand<KMReplyToCommand>();
+}
+
+void MessageActions::slotReplyAuthorToMsg()
+{
+  replyCommand<KMReplyAuthorCommand>();
+}
+
+void MessageActions::slotReplyListToMsg()
+{
+  replyCommand<KMReplyListCommand>();
+}
+
+void MessageActions::slotReplyAllToMsg()
+{
+  replyCommand<KMReplyToAllCommand>();
+}
+
+void MessageActions::slotNoQuoteReplyToMsg()
+{
+  if ( !mCurrentMessage )
+    return;
+  KMCommand *command = new KMNoQuoteReplyToCommand( mParent, mCurrentMessage );
+  command->start();
+}
+
+void MessageActions::slotSetMsgStatusNew()
+{
+  setMessageStatus( KMMsgStatusNew );
+}
+
+void MessageActions::slotSetMsgStatusUnread()
+{
+  setMessageStatus( KMMsgStatusUnread );
+}
+
+void MessageActions::slotSetMsgStatusRead()
+{
+  setMessageStatus( KMMsgStatusRead );
+}
+
+void MessageActions::slotSetMsgStatusFlag()
+{
+  setMessageStatus( KMMsgStatusFlag, true );
+}
+
+void MessageActions::slotSetMsgStatusTodo()
+{
+  setMessageStatus( KMMsgStatusTodo, true );
+}
+
+void MessageActions::setMessageStatus( KMMsgStatus status, bool toggle )
+{
+  QValueList<Q_UINT32> serNums = mVisibleSernums;
+  if ( serNums.isEmpty() && mCurrentMessage )
+    serNums.append( mCurrentMessage->getMsgSerNum() );
+  if ( serNums.empty() )
+    return;
+  KMCommand *command = new KMSetStatusCommand( status, serNums, toggle );
+  command->start();
+}
+
+void MessageActions::editCurrentMessage()
+{
+  if ( !mCurrentMessage )
+    return;
+  KMCommand *command = 0;
+  KMFolder *folder = mCurrentMessage->parent();
+  // edit, unlike send again, removes the message from the folder
+  // we only want that for templates and drafts folders
+  if ( folder && ( kmkernel->folderIsDraftOrOutbox( folder ) ||
+       kmkernel->folderIsTemplates( folder ) ) )
+    command = new KMEditMsgCommand( mParent, mCurrentMessage );
+  else
+    command = new KMResendMessageCommand( mParent, mCurrentMessage );
+  command->start();
+}
+
+#include "messageactions.moc"
Index: kmail/kmacctcachedimap.h
===================================================================
--- kmail/kmacctcachedimap.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmacctcachedimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -185,6 +185,20 @@
   bool annotationCheckPassed(){ return mAnnotationCheckPassed;};
   void setAnnotationCheckPassed( bool a ){ mAnnotationCheckPassed = a; };
 
+  /** Describes whether the account is a groupware account. */
+  enum GroupwareType
+  {
+    GroupwareNone,     ///< Normal IMAP account
+    GroupwareKolab,    ///< A Kolab groupware account
+    GroupwareScalix    ///< A Scalix groupware account
+  };
+
+  void setGroupwareType( GroupwareType type ){ mGroupwareType = type; }
+  GroupwareType groupwareType() const { return mGroupwareType; }
+
+  void setSentCustomLoginCommand( bool value ){ mSentCustomLoginCommand = value; }
+  bool sentCustomLoginCommand() const { return mSentCustomLoginCommand; }
+
 protected:
   friend class ::AccountManager;
   KMAcctCachedImap(AccountManager* owner, const QString& accountName, uint id);
@@ -208,6 +222,9 @@
   QStringList mPreviouslyDeletedFolders; // folders deleted in a previous session
   QMap<QString, RenamedFolder> mRenamedFolders;
   bool mAnnotationCheckPassed;
+
+  GroupwareType mGroupwareType;
+  bool mSentCustomLoginCommand;
 };
 
 #endif /*KMAcctCachedImap_h*/
Index: kmail/folderdiaquotatab_p.h
===================================================================
--- kmail/folderdiaquotatab_p.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/folderdiaquotatab_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -51,9 +51,6 @@
     void setQuotaInfo( const KMail::QuotaInfo& info );
 
 private:
-    void readConfig();
-
-private:
     QLabel* mInfoLabel;
     QLabel* mRootLabel;
     QProgressBar* mProgressBar;
Index: kmail/snippetdlg.h
===================================================================
--- kmail/snippetdlg.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,42 @@
+/****************************************************************************
+** Form interface generated from reading ui file '/Users/till/Documents/Code/kde/enterprise/kdepim/kmail/snippetdlg.ui'
+**
+** Created: Tue Sep 25 16:03:02 2007
+**      by: The User Interface Compiler ($Id$)
+**
+** WARNING! All changes made in this file will be lost!
+****************************************************************************/
+
+#ifndef SNIPPETDLG_H
+#define SNIPPETDLG_H
+
+#include "snippetdlgbase.h"
+
+class KKeyButton;
+class KActionCollection;
+class KShortcut;
+
+class SnippetDlg : public SnippetDlgBase
+{
+    Q_OBJECT
+
+public:
+    SnippetDlg( KActionCollection* ac, QWidget* parent = 0, const char* name = 0, bool modal = FALSE, WFlags fl = 0 );
+    ~SnippetDlg();
+
+    void setShowShortcut( bool show );
+
+    QLabel* textLabel3;
+    QLabel* textLabelGroup;
+    KKeyButton* keyButton;
+    KActionCollection* actionCollection;
+
+private slots:
+    void slotCapturedShortcut( const KShortcut& );
+
+protected slots:
+    virtual void languageChange();
+
+};
+
+#endif // SNIPPETDLG_H
Index: kmail/kmail_config_identity.desktop
===================================================================
--- kmail/kmail_config_identity.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,6 +23,7 @@
 Name[da]=Identiteter
 Name[de]=Identit√§ten
 Name[el]=Œ§Œ±œÖœÑœåœÑŒ∑œÑŒµœÇ
+Name[eo]=Identoj
 Name[es]=Identidades
 Name[et]=Identiteedid
 Name[eu]=Identitateak
@@ -76,6 +77,7 @@
 Comment[da]=H√•ndtering af identiteter
 Comment[de]=Identit√§ten verwalten
 Comment[el]=ŒîŒπŒ±œáŒµŒØœÅŒπœÉŒ∑ œÑŒ±œÖœÑŒøœÑŒÆœÑœâŒΩ
+Comment[eo]=Mastrumi identojn
 Comment[es]=Gestionar identidades
 Comment[et]=Identiteetide haldus
 Comment[eu]=Identitateak kudeatu
Index: kmail/kmaccount.cpp
===================================================================
--- kmail/kmaccount.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -19,6 +19,9 @@
 using KPIM::ProgressItem;
 using KPIM::ProgressManager;
 
+#include <libkpimidentities/identitymanager.h>
+#include <libkpimidentities/identity.h>
+
 using KMail::FolderJob;
 
 #include <kapplication.h>
@@ -91,7 +94,8 @@
     mCheckingMail(false),
     mPrecommandSuccess(true),
     mHasInbox(false),
-    mMailCheckProgressItem(0)
+    mMailCheckProgressItem(0),
+    mIdentityId(0)
 {
   assert(aOwner != 0);
 }
@@ -99,7 +103,6 @@
 void KMAccount::init() {
   mTrash = kmkernel->trashFolder()->idString();
   mExclude = false;
-  // when creating a new account, mail checking interval shall be default
   mInterval = 0;
   mNewInFolder.clear();
 }
@@ -107,7 +110,7 @@
 //-----------------------------------------------------------------------------
 KMAccount::~KMAccount()
 {
-  if (!kmkernel->shuttingDown() && mFolder) mFolder->removeAccount(this);
+  if ( (kmkernel && !kmkernel->shuttingDown()) && mFolder ) mFolder->removeAccount(this);
   if (mTimer) deinstallTimer();
 }
 
@@ -144,12 +147,11 @@
   QString folderName;
   mFolder = 0;
   folderName = config.readEntry("Folder");
-  // if check-interval has been deleted from kmailrc, it shall be default
   setCheckInterval(config.readNumEntry("check-interval", 0));
   setTrash(config.readEntry("trash", kmkernel->trashFolder()->idString()));
   setCheckExclude(config.readBoolEntry("check-exclude", false));
   setPrecommand(config.readPathEntry("precommand"));
-
+  setIdentityId(config.readNumEntry("identity-id", 0));
   if (!folderName.isEmpty())
   {
     setFolder(kmkernel->folderMgr()->findIdString(folderName), true);
@@ -174,6 +176,10 @@
   config.writeEntry("check-exclude", mExclude);
   config.writePathEntry("precommand", mPrecommand);
   config.writeEntry("trash", mTrash);
+  if ( mIdentityId && mIdentityId != kmkernel->identityManager()->defaultIdentity().uoid() )
+    config.writeEntry("identity-id", mIdentityId);
+  else
+    config.deleteEntry("identity-id");
 }
 
 
@@ -450,6 +456,7 @@
   setFolder( a->folder() );
   setPrecommand( a->precommand() );
   setTrash( a->trash() );
+  setIdentityId( a->identityId() );
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -59,6 +59,7 @@
 #include <qeventloop.h>
 
 #include <libemailfunctions/email.h>
+#include <kdcopservicestarter.h>
 #include <kdebug.h>
 #include <kfiledialog.h>
 #include <kabc/stdaddressbook.h>
@@ -78,6 +79,8 @@
 #include <kio/job.h>
 #include <kio/netaccess.h>
 
+#include <libkpimidentities/identitymanager.h>
+
 #include "actionscheduler.h"
 using KMail::ActionScheduler;
 #include "mailinglist-magic.h"
@@ -110,11 +113,14 @@
 using KMail::RedirectDialog;
 #include "util.h"
 #include "templateparser.h"
+#include "editorwatcher.h"
+#include "korghelper.h"
 
 #include "broadcaststatus.h"
 #include "globalsettings.h"
 
 #include <libkdepim/kfileio.h>
+#include "kcalendariface_stub.h"
 
 #include "progressmanager.h"
 using KPIM::ProgressManager;
@@ -463,7 +469,7 @@
   msg->setTo( KMMessage::decodeMailtoUrl( mUrl.path() ) );
 
   KMail::Composer * win = KMail::makeComposer( msg, id );
-  win->setCharset("", TRUE);
+  win->setCharset("", true);
   win->setFocusToSubject();
   win->show();
 
@@ -488,7 +494,7 @@
   rmsg->setTo( KMMessage::decodeMailtoUrl( mUrl.path() ) );
 
   KMail::Composer * win = KMail::makeComposer( rmsg, 0 );
-  win->setCharset(msg->codec()->mimeName(), TRUE);
+  win->setCharset(msg->codec()->mimeName(), true);
   win->setReplyFocus();
   win->show();
 
@@ -513,7 +519,7 @@
   fmsg->setTo( KMMessage::decodeMailtoUrl( mUrl.path() ) );
 
   KMail::Composer * win = KMail::makeComposer( fmsg );
-  win->setCharset(msg->codec()->mimeName(), TRUE);
+  win->setCharset(msg->codec()->mimeName(), true);
   win->show();
 
   return OK;
@@ -676,7 +682,7 @@
 
   KMail::Composer * win = KMail::makeComposer();
   msg->setTransferInProgress(false); // From here on on, the composer owns the message.
-  win->setMsg(msg, FALSE, TRUE);
+  win->setMsg(msg, false, true);
   win->setFolder( parent );
   win->show();
 
@@ -705,7 +711,7 @@
 
   KMail::Composer *win = KMail::makeComposer();
   newMsg->setTransferInProgress( false ); // From here on on, the composer owns the message.
-  win->setMsg( newMsg, FALSE, TRUE );
+  win->setMsg( newMsg, false, true );
   win->show();
 
   return OK;
@@ -772,6 +778,9 @@
   // from an .eml file.
   if ( msg->getMsgSerNum() != 0 ) {
     mMsgList.append( msg->getMsgSerNum() );
+    if ( msg->parent() ) {
+      msg->parent()->open( "kmsavemsgcommand" );
+    }
   } else {
     mStandAloneMessage = msg;
   }
@@ -847,6 +856,7 @@
     KMMsgDict::instance()->getLocation( mMsgList[mMsgListIndex], &p, &idx );
     assert( p );
     assert( idx >= 0 );
+    //kdDebug() << "SERNUM: " << mMsgList[mMsgListIndex] << " idx: " << idx << " folder: " << p->prettyURL() << endl;
     msg = p->getMsg(idx);
 
     if ( msg ) {
@@ -1080,7 +1090,7 @@
   }
   KMMessage *reply = msg->createReply( KMail::ReplySmart, mSelection );
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setCharset( msg->codec()->mimeName(), true );
   win->setReplyFocus();
   win->show();
 
@@ -1101,9 +1111,9 @@
   if ( !msg || !msg->codec() ) {
     return Failed;
   }
-  KMMessage *reply = msg->createReply( KMail::ReplySmart, "", TRUE);
+  KMMessage *reply = msg->createReply( KMail::ReplySmart, "", true);
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset(msg->codec()->mimeName(), TRUE);
+  win->setCharset(msg->codec()->mimeName(), true);
   win->setReplyFocus(false);
   win->show();
 
@@ -1126,7 +1136,7 @@
   }
   KMMessage *reply = msg->createReply( KMail::ReplyList, mSelection);
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset(msg->codec()->mimeName(), TRUE);
+  win->setCharset(msg->codec()->mimeName(), true);
   win->setReplyFocus(false);
   win->show();
 
@@ -1149,7 +1159,7 @@
   }
   KMMessage *reply = msg->createReply( KMail::ReplyAll, mSelection );
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setCharset( msg->codec()->mimeName(), true );
   win->setReplyFocus();
   win->show();
 
@@ -1172,7 +1182,7 @@
   }
   KMMessage *reply = msg->createReply( KMail::ReplyAuthor, mSelection );
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setCharset( msg->codec()->mimeName(), true );
   win->setReplyFocus();
   win->show();
 
@@ -1451,7 +1461,7 @@
   KMMessage *reply = msg->createReply( KMail::ReplySmart, mSelection,
                                        false, true, false, mTemplate );
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setCharset( msg->codec()->mimeName(), true );
   win->setReplyFocus();
   win->show();
 
@@ -1476,7 +1486,7 @@
   KMMessage *reply = msg->createReply( KMail::ReplyAll, mSelection,
                                        false, true, false, mTemplate );
   KMail::Composer * win = KMail::makeComposer( reply );
-  win->setCharset( msg->codec()->mimeName(), TRUE );
+  win->setCharset( msg->codec()->mimeName(), true );
   win->setReplyFocus();
   win->show();
 
@@ -1564,8 +1574,15 @@
     mHtmlLoadExtOverride( htmlLoadExtOverride ),
     mUseFixedFont( useFixedFont ), mEncoding( encoding )
 {
+  mOverrideFont = KGlobalSettings::generalFont();
 }
 
+
+void KMPrintCommand::setOverrideFont( const QFont& font )
+{
+  mOverrideFont = font;
+}
+
 KMCommand::Result KMPrintCommand::execute()
 {
   KMReaderWin printWin( 0, 0, 0 );
@@ -1575,6 +1592,8 @@
   printWin.setHtmlLoadExtOverride( mHtmlLoadExtOverride );
   printWin.setUseFixedFont( mUseFixedFont );
   printWin.setOverrideEncoding( mEncoding );
+  printWin.setPrintFont( mOverrideFont );
+  printWin.setDecryptMessageOverwrite( true );
   printWin.setMsg( retrievedMessage(), true );
   printWin.printMsg();
 
@@ -2059,7 +2078,7 @@
   kdDebug(5006) << k_funcinfo << success << endl;
   if ( !success )
     setResult( Failed );
-  mDestFolder->close("kmcommand");
+  mDestFolder->close( "kmcommand" );
   emit completed( this );
   deleteLater();
 }
@@ -2136,10 +2155,8 @@
     if (srcFolder == mDestFolder)
       continue;
     assert(idx != -1);
-    if ( !srcFolder->isOpened() ) {
-      srcFolder->open( "kmcommand" );
-      mOpenedFolders.append( srcFolder );
-    }
+    srcFolder->open( "kmmovecommand" );
+    mOpenedFolders.append( srcFolder );
     msg = srcFolder->getMsg(idx);
     if ( !msg ) {
       kdDebug(5006) << k_funcinfo << "No message found for serial number " << *it << endl;
@@ -2372,7 +2389,7 @@
     }
 
     KMail::Composer * win = KMail::makeComposer( msg, mIdentity );
-    win->setCharset("", TRUE);
+    win->setCharset("", true);
     win->show();
   }
   else if ( mUrl.protocol() == "im" )
@@ -2633,20 +2650,20 @@
           // carefully look for the part that is *not* the signature part:
           if( node->findType( DwMime::kTypeApplication,
                 DwMime::kSubtypePgpSignature,
-                TRUE, false ) ){
+                true, false ) ){
             dataNode = node->findTypeNot( DwMime::kTypeApplication,
                 DwMime::kSubtypePgpSignature,
-                TRUE, false );
+                true, false );
           }else if( node->findType( DwMime::kTypeApplication,
                 DwMime::kSubtypePkcs7Mime,
-                TRUE, false ) ){
+                true, false ) ){
             dataNode = node->findTypeNot( DwMime::kTypeApplication,
                 DwMime::kSubtypePkcs7Mime,
-                TRUE, false );
+                true, false );
           }else{
             dataNode = node->findTypeNot( DwMime::kTypeMultipart,
                 DwMime::kSubtypeUnknown,
-                TRUE, false );
+                true, false );
           }
 	}else{
 	  ObjectTreeParser otp( 0, 0, false, false, false );
@@ -2800,24 +2817,27 @@
 
 KMCommand::Result KMResendMessageCommand::execute()
 {
-  KMMessage *msg = retrievedMessage();
-  if ( !msg || !msg->codec() ) {
-    return Failed;
-  }
-  KMMessage *newMsg = new KMMessage(*msg);
-  newMsg->setCharset(msg->codec()->mimeName());
-  // the message needs a new Message-Id
-  newMsg->removeHeaderField( "Message-Id" );
-  newMsg->setParent( 0 );
+   KMMessage *msg = retrievedMessage();
+   if ( !msg || !msg->codec() ) {
+     return Failed;
+   }
+   KMMessage *newMsg = new KMMessage(*msg);
 
-  // adds the new date to the message
-  newMsg->removeHeaderField( "Date" );
+   QStringList whiteList;
+   whiteList << "To" << "Cc" << "Bcc" << "Subject";
+   newMsg->sanitizeHeaders( whiteList );
 
-  KMail::Composer * win = KMail::makeComposer();
-  win->setMsg(newMsg, false, true);
-  win->show();
+   newMsg->setCharset(msg->codec()->mimeName());
+   newMsg->setParent( 0 );
 
-  return OK;
+   // make sure we have an identity set, default, if necessary
+   newMsg->setHeaderField("X-KMail-Identity", QString::number( newMsg->identityUoid() ));
+
+   KMail::Composer * win = KMail::makeComposer();
+   win->setMsg(newMsg, false, true);
+   win->show();
+
+   return OK;
 }
 
 KMMailingListCommand::KMMailingListCommand( QWidget *parent, KMFolder *folder )
@@ -3224,23 +3244,6 @@
            this, SLOT(slotAtmDecryptWithChiasmusResult(const GpgME::Error&,const QVariant&)) );
 }
 
-// return true if we should proceed, false if we should abort
-static bool checkOverwrite( const KURL& url, bool& overwrite, QWidget* w )
-{
-  if ( KIO::NetAccess::exists( url, false /*dest*/, w ) ) {
-    if ( KMessageBox::Cancel ==
-         KMessageBox::warningContinueCancel(
-                                            w,
-                                            i18n( "A file named \"%1\" already exists. "
-                                                  "Are you sure you want to overwrite it?" ).arg( url.prettyURL() ),
-                                            i18n( "Overwrite File?" ),
-                                            i18n( "&Overwrite" ) ) )
-      return false;
-    overwrite = true;
-  }
-  return true;
-}
-
 static const QString chomp( const QString & base, const QString & suffix, bool cs ) {
   return base.endsWith( suffix, cs ) ? base.left( base.length() - suffix.length() ) : base ;
 }
@@ -3274,8 +3277,8 @@
   if ( url.isEmpty() )
     return;
 
-  bool overwrite = false;
-  if ( !checkOverwrite( url, overwrite, parentWidget() ) )
+  bool overwrite = KMail::Util::checkOverwrite( url, parentWidget() );
+  if ( !overwrite )
     return;
 
   d.setDisabled( true ); // we got this far, don't delete yet
@@ -3293,4 +3296,228 @@
   d.setResult( OK );
 }
 
+
+AttachmentModifyCommand::AttachmentModifyCommand(partNode * node, KMMessage * msg, QWidget * parent) :
+    KMCommand( parent, msg ),
+    mPartIndex( node->nodeId() ),
+    mSernum( 0 )
+{
+}
+
+AttachmentModifyCommand::~ AttachmentModifyCommand()
+{
+}
+
+KMCommand::Result AttachmentModifyCommand::execute()
+{
+  KMMessage *msg = retrievedMessage();
+  if ( !msg )
+    return Failed;
+  mSernum = msg->getMsgSerNum();
+
+  mFolder = msg->parent();
+  if ( !mFolder || !mFolder->storage() )
+    return Failed;
+
+  Result res = doAttachmentModify();
+  if ( res != OK )
+    return res;
+
+  setEmitsCompletedItself( true );
+  setDeletesItself( true );
+  return OK;
+}
+
+void AttachmentModifyCommand::storeChangedMessage(KMMessage * msg)
+{
+  if ( !mFolder || !mFolder->storage() ) {
+    kdWarning(5006) << k_funcinfo << "We lost the folder!" << endl;
+    setResult( Failed );
+    emit completed( this );
+    deleteLater();
+  }
+  int res = mFolder->addMsg( msg ) != 0;
+  if ( mFolder->folderType() == KMFolderTypeImap ) {
+    KMFolderImap *f = static_cast<KMFolderImap*>( mFolder->storage() );
+    connect( f, SIGNAL(folderComplete(KMFolderImap*,bool)),
+             SLOT(messageStoreResult(KMFolderImap*,bool)) );
+  } else {
+    messageStoreResult( 0, res == 0 );
+  }
+}
+
+void AttachmentModifyCommand::messageStoreResult(KMFolderImap* folder, bool success )
+{
+  Q_UNUSED( folder );
+  if ( success ) {
+    KMCommand *delCmd = new KMDeleteMsgCommand( mSernum );
+    connect( delCmd, SIGNAL(completed(KMCommand*)), SLOT(messageDeleteResult(KMCommand*)) );
+    delCmd->start();
+    return;
+  }
+  kdWarning(5006) << k_funcinfo << "Adding modified message failed." << endl;
+  setResult( Failed );
+  emit completed( this );
+  deleteLater();
+}
+
+void AttachmentModifyCommand::messageDeleteResult(KMCommand * cmd)
+{
+  setResult( cmd->result() );
+  emit completed( this );
+  deleteLater();
+}
+
+
+KMDeleteAttachmentCommand::KMDeleteAttachmentCommand(partNode * node, KMMessage * msg, QWidget * parent) :
+    AttachmentModifyCommand( node, msg, parent )
+{
+  kdDebug(5006) << k_funcinfo << endl;
+}
+
+KMDeleteAttachmentCommand::~KMDeleteAttachmentCommand()
+{
+  kdDebug(5006) << k_funcinfo << endl;
+}
+
+KMCommand::Result KMDeleteAttachmentCommand::doAttachmentModify()
+{
+  KMMessage *msg = retrievedMessage();
+  KMMessagePart part;
+  // -2 because partNode counts root and body of the message as well
+  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  if ( !dwpart )
+    return Failed;
+  KMMessage::bodyPart( dwpart, &part, true );
+  if ( !part.isComplete() )
+     return Failed;
+  msg->removeBodyPart( dwpart );
+
+  // add dummy part to show that a attachment has been deleted
+  KMMessagePart dummyPart;
+  dummyPart.duplicate( part );
+  QString comment = i18n("This attachment has been deleted.");
+  if ( !part.fileName().isEmpty() )
+    comment = i18n( "The attachment '%1' has been deleted." ).arg( part.fileName() );
+  dummyPart.setContentDescription( comment );
+  dummyPart.setBodyEncodedBinary( QByteArray() );
+  QCString cd = dummyPart.contentDisposition();
+  if ( cd.find( "inline", 0, false ) == 0 ) {
+    cd.replace( 0, 10, "attachment" );
+    dummyPart.setContentDisposition( cd );
+  } else if ( cd.isEmpty() ) {
+    dummyPart.setContentDisposition( "attachment" );
+  }
+  msg->addBodyPart( &dummyPart );
+
+  KMMessage *newMsg = new KMMessage();
+  newMsg->fromDwString( msg->asDwString() );
+  newMsg->setStatus( msg->status() );
+
+  storeChangedMessage( newMsg );
+  return OK;
+}
+
+
+KMEditAttachmentCommand::KMEditAttachmentCommand(partNode * node, KMMessage * msg, QWidget * parent) :
+    AttachmentModifyCommand( node, msg, parent )
+{
+  kdDebug(5006) << k_funcinfo << endl;
+  mTempFile.setAutoDelete( true );
+}
+
+KMEditAttachmentCommand::~ KMEditAttachmentCommand()
+{
+}
+
+KMCommand::Result KMEditAttachmentCommand::doAttachmentModify()
+{
+  KMMessage *msg = retrievedMessage();
+  KMMessagePart part;
+  // -2 because partNode counts root and body of the message as well
+  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  if ( !dwpart )
+    return Failed;
+  KMMessage::bodyPart( dwpart, &part, true );
+  if ( !part.isComplete() )
+     return Failed;
+
+  mTempFile.file()->writeBlock( part.bodyDecodedBinary() );
+  mTempFile.file()->flush();
+
+  KMail::EditorWatcher *watcher = new KMail::EditorWatcher( KURL(mTempFile.file()->name()), part.typeStr() + "/" + part.subtypeStr(), false, this );
+  connect( watcher, SIGNAL(editDone(KMail::EditorWatcher*)), SLOT(editDone(KMail::EditorWatcher*)) );
+  if ( !watcher->start() )
+    return Failed;
+  setEmitsCompletedItself( true );
+  setDeletesItself( true );
+  return OK;
+}
+
+void KMEditAttachmentCommand::editDone(KMail::EditorWatcher * watcher)
+{
+  kdDebug(5006) << k_funcinfo << endl;
+  // anything changed?
+  if ( !watcher->fileChanged() ) {
+    kdDebug(5006) << k_funcinfo << "File has not been changed" << endl;
+    setResult( Canceled );
+    emit completed( this );
+    deleteLater();
+  }
+
+  mTempFile.file()->reset();
+  QByteArray data = mTempFile.file()->readAll();
+
+  // build the new message
+  KMMessage *msg = retrievedMessage();
+  KMMessagePart part;
+  // -2 because partNode counts root and body of the message as well
+  DwBodyPart *dwpart = msg->dwBodyPart( mPartIndex - 2 );
+  KMMessage::bodyPart( dwpart, &part, true );
+  msg->removeBodyPart( dwpart );
+
+  KMMessagePart att;
+  att.duplicate( part );
+  att.setBodyEncodedBinary( data );
+  msg->addBodyPart( &att );
+
+  KMMessage *newMsg = new KMMessage();
+  newMsg->fromDwString( msg->asDwString() );
+  newMsg->setStatus( msg->status() );
+
+  storeChangedMessage( newMsg );
+}
+
+
+CreateTodoCommand::CreateTodoCommand(QWidget * parent, KMMessage * msg)
+  : KMCommand( parent, msg )
+{
+}
+
+KMCommand::Result CreateTodoCommand::execute()
+{
+  KMMessage *msg = retrievedMessage();
+  if ( !msg || !msg->codec() ) {
+    return Failed;
+  }
+
+  KMail::KorgHelper::ensureRunning();
+
+  QString txt = i18n("From: %1\nTo: %2\nSubject: %3").arg( msg->from() )
+                .arg( msg->to() ).arg( msg->subject() );
+
+  KTempFile tf;
+  tf.setAutoDelete( true );
+  QString uri = "kmail:" + QString::number( msg->getMsgSerNum() ) + "/" + msg->msgId();
+  tf.file()->writeBlock( msg->asDwString().c_str(), msg->asDwString().length() );
+  tf.close();
+
+  KCalendarIface_stub *iface = new KCalendarIface_stub( kapp->dcopClient(), "korganizer", "CalendarIface" );
+  iface->openTodoEditor( i18n("Mail: %1").arg( msg->subject() ), txt,
+                         uri, tf.name(), QStringList(), "message/rfc822" );
+  delete iface;
+
+  return OK;
+}
+
 #include "kmcommands.moc"
Index: kmail/messagecomposer.cpp
===================================================================
--- kmail/messagecomposer.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/messagecomposer.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -55,6 +55,7 @@
 
 #include <ui/keyselectiondialog.h>
 #include <ui/keyapprovaldialog.h>
+#include <ui/messagebox.h>
 #include <kleo/cryptobackendfactory.h>
 #include <kleo/keylistjob.h>
 #include <kleo/encryptjob.h>
@@ -528,6 +529,7 @@
   // according to the line breaks of the richtext version.
   mLineBreakColumn = mComposeWin->mEditor->lineBreakColumn();
 }
+
 static QCString escape_quoted_string( const QCString & str ) {
   QCString result;
   const unsigned int str_len = str.length();
@@ -1371,7 +1373,7 @@
   theMessage.deleteBodyParts();
   theMessage.removeHeaderField("Content-Type");
   theMessage.removeHeaderField("Content-Transfer-Encoding");
-  theMessage.setAutomaticFields(TRUE); // == multipart/mixed
+  theMessage.setAutomaticFields(true); // == multipart/mixed
 
   // this is our *final* body part
   mNewBodyPart = new KMMessagePart;
@@ -1560,7 +1562,7 @@
     QValueList<int> allowedCTEs;
     // the signed body must not be 8bit encoded
     mOldBodyPart.setBodyAndGuessCte(bodyData, allowedCTEs, !kmkernel->msgSender()->sendQuotedPrintable() && !doSign,
-                                   doSign);
+                                    doSign);
     if ( !mIsRichText )
       mOldBodyPart.setCharset(mCharset);
   }
@@ -2081,7 +2083,7 @@
   QString text;
   QCString cText;
 
-  if( mDisableBreaking || mIsRichText )
+  if( mDisableBreaking || mIsRichText || !GlobalSettings::self()->wordWrap() )
     text = mComposeWin->mEditor->text();
   else
     text = mComposeWin->mEditor->brokenText();
@@ -2179,6 +2181,9 @@
     return;
   }
 
+  if ( GlobalSettings::showGnuPGAuditLogAfterSuccessfulSignEncrypt() )
+      Kleo::MessageBox::auditLog( 0, job.get(), i18n("GnuPG Audit Log for Signing Operation") );
+
   mSignature = signature;
   if ( mSignature.isEmpty() ) {
     KMessageBox::sorry( mComposeWin,
@@ -2202,18 +2207,18 @@
   assert( proto ); // hmmmm....?
 
   std::auto_ptr<Kleo::EncryptJob> job( proto->encryptJob( armor( format ),
-							  textMode( format ) ) );
+                                                          textMode( format ) ) );
   if ( !job.get() ) {
     KMessageBox::sorry( mComposeWin,
-			i18n("This message could not be encrypted, "
-			     "since the chosen backend does not seem to support "
-			     "encryption; this should actually never happen, "
-			     "please report this bug.") );
+                        i18n("This message could not be encrypted, "
+                             "since the chosen backend does not seem to support "
+                             "encryption; this should actually never happen, "
+                             "please report this bug.") );
     return Kpgp::Failure;
   }
 
   const GpgME::EncryptionResult res =
-    job->exec( encryptionKeys, cText, false, encryptedBody );
+    job->exec( encryptionKeys, cText, true /* we do ownertrust ourselves */, encryptedBody );
   if ( res.error().isCanceled() ) {
     kdDebug() << "encryption was canceled by user" << endl;
     return Kpgp::Canceled;
@@ -2223,6 +2228,10 @@
     job->showErrorDialog( mComposeWin );
     return Kpgp::Failure;
   }
+
+  if ( GlobalSettings::showGnuPGAuditLogAfterSuccessfulSignEncrypt() )
+      Kleo::MessageBox::auditLog( 0, job.get(), i18n("GnuPG Audit Log for Encryption Operation") );
+
   return Kpgp::Ok;
 }
 
@@ -2264,6 +2273,10 @@
     job->showErrorDialog( mComposeWin );
     return Kpgp::Failure;
   }
+
+  if ( GlobalSettings::showGnuPGAuditLogAfterSuccessfulSignEncrypt() )
+      Kleo::MessageBox::auditLog( 0, job.get(), i18n("GnuPG Audit Log for Encryption Operation") );
+
   return Kpgp::Ok;
 }
 
Index: kmail/antispamwizard.cpp
===================================================================
--- kmail/antispamwizard.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/antispamwizard.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -173,11 +173,11 @@
         pipeFilterPattern->setName( uniqueNameFor( (*it).getFilterName() ) );
         pipeFilterPattern->append( KMSearchRule::createInstance( "<size>",
                                    KMSearchRule::FuncIsGreaterOrEqual, "0" ) );
-        pipeFilter->setApplyOnOutbound( FALSE);
+        pipeFilter->setApplyOnOutbound( false);
         pipeFilter->setApplyOnInbound();
         pipeFilter->setApplyOnExplicit();
-        pipeFilter->setStopProcessingHere( FALSE );
-        pipeFilter->setConfigureShortcut( FALSE );
+        pipeFilter->setStopProcessingHere( false );
+        pipeFilter->setConfigureShortcut( false );
 
         filterList.append( pipeFilter );
       }
@@ -218,11 +218,11 @@
           }
         }
       }
-      virusFilter->setApplyOnOutbound( FALSE);
+      virusFilter->setApplyOnOutbound( false);
       virusFilter->setApplyOnInbound();
       virusFilter->setApplyOnExplicit();
-      virusFilter->setStopProcessingHere( TRUE );
-      virusFilter->setConfigureShortcut( FALSE );
+      virusFilter->setStopProcessingHere( true );
+      virusFilter->setConfigureShortcut( false );
 
       filterList.append( virusFilter );
     }
@@ -252,11 +252,11 @@
           pipeFilterPattern->setName( uniqueNameFor( (*it).getFilterName() ) );
         pipeFilterPattern->append( KMSearchRule::createInstance( "<size>",
                                    KMSearchRule::FuncIsLessOrEqual, "256000" ) );
-        pipeFilter->setApplyOnOutbound( FALSE);
+        pipeFilter->setApplyOnOutbound( false);
         pipeFilter->setApplyOnInbound();
         pipeFilter->setApplyOnExplicit();
-        pipeFilter->setStopProcessingHere( FALSE );
-        pipeFilter->setConfigureShortcut( FALSE );
+        pipeFilter->setStopProcessingHere( false );
+        pipeFilter->setConfigureShortcut( false );
 
         filterList.append( pipeFilter );
       }
@@ -304,11 +304,11 @@
           }
       }
     }
-    spamFilter->setApplyOnOutbound( FALSE);
+    spamFilter->setApplyOnOutbound( false);
     spamFilter->setApplyOnInbound();
     spamFilter->setApplyOnExplicit();
-    spamFilter->setStopProcessingHere( TRUE );
-    spamFilter->setConfigureShortcut( FALSE );
+    spamFilter->setStopProcessingHere( true );
+    spamFilter->setConfigureShortcut( false );
     filterList.append( spamFilter );
 
     if ( mSpamRulesPage->moveUnsureSelected() )
@@ -346,11 +346,11 @@
             }
         }
       }
-      unsureFilter->setApplyOnOutbound( FALSE);
+      unsureFilter->setApplyOnOutbound( false);
       unsureFilter->setApplyOnInbound();
       unsureFilter->setApplyOnExplicit();
-      unsureFilter->setStopProcessingHere( TRUE );
-      unsureFilter->setConfigureShortcut( FALSE );
+      unsureFilter->setStopProcessingHere( true );
+      unsureFilter->setConfigureShortcut( false );
 
       if ( atLeastOneUnsurePattern )
         filterList.append( unsureFilter );
@@ -389,12 +389,12 @@
       classSpamFilterPattern->setName( uniqueNameFor( i18n( "Classify as spam" ) ) );
     classSpamFilterPattern->append( KMSearchRule::createInstance( "<size>",
                                     KMSearchRule::FuncIsGreaterOrEqual, "0" ) );
-    classSpamFilter->setApplyOnOutbound( FALSE);
-    classSpamFilter->setApplyOnInbound( FALSE );
-    classSpamFilter->setApplyOnExplicit( FALSE );
-    classSpamFilter->setStopProcessingHere( TRUE );
-    classSpamFilter->setConfigureShortcut( TRUE );
-    classSpamFilter->setConfigureToolbar( TRUE );
+    classSpamFilter->setApplyOnOutbound( false);
+    classSpamFilter->setApplyOnInbound( false );
+    classSpamFilter->setApplyOnExplicit( false );
+    classSpamFilter->setStopProcessingHere( true );
+    classSpamFilter->setConfigureShortcut( true );
+    classSpamFilter->setConfigureToolbar( true );
     filterList.append( classSpamFilter );
 
     // Classify messages manually as not Spam / as Ham
@@ -421,12 +421,12 @@
       classHamFilterPattern->setName( uniqueNameFor( i18n( "Classify as NOT spam" ) ) );
     classHamFilterPattern->append( KMSearchRule::createInstance( "<size>",
                                     KMSearchRule::FuncIsGreaterOrEqual, "0" ) );
-    classHamFilter->setApplyOnOutbound( FALSE);
-    classHamFilter->setApplyOnInbound( FALSE );
-    classHamFilter->setApplyOnExplicit( FALSE );
-    classHamFilter->setStopProcessingHere( TRUE );
-    classHamFilter->setConfigureShortcut( TRUE );
-    classHamFilter->setConfigureToolbar( TRUE );
+    classHamFilter->setApplyOnOutbound( false);
+    classHamFilter->setApplyOnInbound( false );
+    classHamFilter->setApplyOnExplicit( false );
+    classHamFilter->setStopProcessingHere( true );
+    classHamFilter->setConfigureShortcut( true );
+    classHamFilter->setConfigureToolbar( true );
     filterList.append( classHamFilter );
   }
 
@@ -435,7 +435,7 @@
    * which will result in the filter list in kmmainwidget being
    * initialized. This should happend only once. */
   if ( !filterList.isEmpty() )
-    KMKernel::self()->filterMgr()->appendFilters( 
+    KMKernel::self()->filterMgr()->appendFilters(
           filterList, replaceExistingFilters );
 
   QDialog::accept();
@@ -632,8 +632,8 @@
 }
 
 
-void AntiSpamWizard::sortFilterOnExistance( 
-        const QString & intendedFilterName, 
+void AntiSpamWizard::sortFilterOnExistance(
+        const QString & intendedFilterName,
         QString & newFilters, QString & replaceFilters )
 {
   if ( uniqueNameFor( intendedFilterName ) == intendedFilterName )
@@ -825,7 +825,7 @@
 
 
 //---------------------------------------------------------------------------
-ASWizPage::ASWizPage( QWidget * parent, const char * name, 
+ASWizPage::ASWizPage( QWidget * parent, const char * name,
                       const QString *bannerName )
   : QWidget( parent, name )
 {
@@ -908,12 +908,12 @@
 {
   QString listName = visibleName;
   mToolsList->insertItem( listName );
-  if ( !mToolsList->isVisible() ) 
+  if ( !mToolsList->isVisible() )
   {
     mToolsList->show();
     mToolsList->setSelected( 0, true );
     mSelectionHint->setText( i18n("<p>Please select the tools to be used "
-                                  "for the spam detection and go "
+                                  "for the detection and go "
                                   "to the next page.</p>") );
   }
 }
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,6 +60,7 @@
 
 #include "kmfolderseldlg.h"
 #include "kmcommands.h"
+#include "kmmainwidget.h"
 
 #include <kapplication.h>
 #include <kmessagebox.h>
@@ -175,7 +176,6 @@
   done( Ok );
 }
 
-
 KMFolderCachedImap::KMFolderCachedImap( KMFolder* folder, const char* aName )
   : KMFolderMaildir( folder, aName ),
     mSyncState( SYNC_STATE_INITIAL ), mContentState( imapNoInformation ),
@@ -191,7 +191,9 @@
     mRecurse( true ),
     mStatusChangedLocally( false ), mAnnotationFolderTypeChanged( false ),
     mIncidencesForChanged( false ), mPersonalNamespacesCheckDone( true ),
-    mQuotaInfo()
+    mQuotaInfo(), mAlarmsBlocked( false ),
+    mRescueCommandCount( 0 ),
+    mPermanentFlags( 31 ) // assume standard flags by default (see imap4/imapinfo.h for bit fields values)
 {
   setUidValidity("");
   // if we fail to read a uid file but there is one, nuke it
@@ -215,7 +217,7 @@
   if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
 }
 
-void KMFolderCachedImap::reallyDoClose( const char * owner )
+void KMFolderCachedImap::reallyDoClose( const char* owner )
 {
   if( !mFolderRemoved ) {
     writeUidCache();
@@ -245,6 +247,8 @@
   }
   mNoContent = config->readBoolEntry( "NoContent", false );
   mReadOnly = config->readBoolEntry( "ReadOnly", false );
+  if ( !config->readEntry( "FolderAttributes" ).isEmpty() )
+    mFolderAttributes = config->readEntry( "FolderAttributes" );
 
   if ( mAnnotationFolderType != "FROMSERVER" ) {
     mAnnotationFolderType = config->readEntry( "Annotation-FolderType" );
@@ -255,6 +259,7 @@
 //                  << " readConfig: mAnnotationFolderType=" << mAnnotationFolderType << endl;
   }
   mIncidencesFor = incidencesForFromString( config->readEntry( "IncidencesFor" ) );
+  mAlarmsBlocked = config->readBoolEntry( "AlarmsBlocked", false );
 //  kdDebug(5006) << ( mImapPath.isEmpty() ? label() : mImapPath )
 //                << " readConfig: mIncidencesFor=" << mIncidencesFor << endl;
 
@@ -286,7 +291,9 @@
   }
 
   QStringList uids = config->readListEntry( "UIDSDeletedSinceLastSync" );
-//  kdDebug( 5006 ) << "READING IN UIDSDeletedSinceLastSync: " << folder()->prettyURL() << endl << uids << endl;
+#if MAIL_LOSS_DEBUGGING
+  kdDebug( 5006 ) << "READING IN UIDSDeletedSinceLastSync: " << folder()->prettyURL() << endl << uids << endl;
+#endif
   for ( QStringList::iterator it = uids.begin(); it != uids.end(); it++ ) {
       mDeletedUIDsSinceLastSync.insert( (*it).toULong(), 0);
   }
@@ -298,6 +305,7 @@
   configGroup.writeEntry( "ImapPath", mImapPath );
   configGroup.writeEntry( "NoContent", mNoContent );
   configGroup.writeEntry( "ReadOnly", mReadOnly );
+  configGroup.writeEntry( "FolderAttributes", mFolderAttributes );
   configGroup.writeEntry( "StatusChangedLocally", mStatusChangedLocally );
   if ( !mImapPathCreation.isEmpty() ) {
     if ( mImapPath.isEmpty() ) {
@@ -305,16 +313,20 @@
     } else {
       configGroup.deleteEntry( "ImapPathCreation" );
     }
-    if ( !mDeletedUIDsSinceLastSync.isEmpty() ) {
-        QValueList<ulong> uids = mDeletedUIDsSinceLastSync.keys();
-        QStringList uidstrings;
-        for( QValueList<ulong>::iterator it = uids.begin(); it != uids.end(); it++ ) {
-            uidstrings.append(  QString::number( (*it) ) );
-        }
-        configGroup.writeEntry( "UIDSDeletedSinceLastSync", uidstrings );
-//        kdDebug( 5006 ) << "WRITING OUT UIDSDeletedSinceLastSync in: " << folder( )->prettyURL( ) << endl << uidstrings << endl;
-    }
   }
+  if ( !mDeletedUIDsSinceLastSync.isEmpty() ) {
+      QValueList<ulong> uids = mDeletedUIDsSinceLastSync.keys();
+      QStringList uidstrings;
+      for( QValueList<ulong>::iterator it = uids.begin(); it != uids.end(); it++ ) {
+          uidstrings.append(  QString::number( (*it) ) );
+      }
+      configGroup.writeEntry( "UIDSDeletedSinceLastSync", uidstrings );
+#if MAIL_LOSS_DEBUGGING
+      kdDebug( 5006 ) << "WRITING OUT UIDSDeletedSinceLastSync in: " << folder( )->prettyURL( ) << endl << uidstrings << endl;
+#endif
+  } else {
+    configGroup.deleteEntry( "UIDSDeletedSinceLastSync" );
+  }
   writeConfigKeysWhichShouldNotGetOverwrittenByReadConfig();
   KMFolderMaildir::writeConfig();
 }
@@ -328,8 +340,13 @@
     configGroup.writeEntry( "Annotation-FolderType", mAnnotationFolderType );
     configGroup.writeEntry( "IncidencesForChanged", mIncidencesForChanged );
     configGroup.writeEntry( "IncidencesFor", incidencesForToString( mIncidencesFor ) );
+    configGroup.writeEntry( "AlarmsBlocked", mAlarmsBlocked );
     configGroup.writeEntry( "UserRights", mUserRights );
 
+    configGroup.deleteEntry( "StorageQuotaUsage");
+    configGroup.deleteEntry( "StorageQuotaRoot");
+    configGroup.deleteEntry( "StorageQuotaLimit");
+
     if ( mQuotaInfo.isValid() ) {
       if ( mQuotaInfo.current().isValid() ) {
         configGroup.writeEntry( "StorageQuotaUsage", mQuotaInfo.current().toInt() );
@@ -338,10 +355,6 @@
         configGroup.writeEntry( "StorageQuotaLimit", mQuotaInfo.max().toInt() );
       }
       configGroup.writeEntry( "StorageQuotaRoot", mQuotaInfo.root() );
-    } else {
-      configGroup.deleteEntry( "StorageQuotaUsage");
-      configGroup.deleteEntry( "StorageQuotaRoot");
-      configGroup.deleteEntry( "StorageQuotaLimit");
     }
   }
 }
@@ -391,7 +404,9 @@
           setUidValidity( QString::fromLocal8Bit(buf).stripWhiteSpace() );
           len = uidcache.readLine( buf, sizeof(buf) );
           if( len > 0 ) {
-//            kdDebug(5006) << "Reading in last uid from cache: " << QString::fromLocal8Bit(buf).stripWhiteSpace() << " in " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+            kdDebug(5006) << "Reading in last uid from cache: " << QString::fromLocal8Bit(buf).stripWhiteSpace() << " in " << folder()->prettyURL() << endl;
+#endif
             // load the last known highest uid from the on disk cache
             setLastUid( QString::fromLocal8Bit(buf).stripWhiteSpace().toULong() );
             return 0;
@@ -411,8 +426,9 @@
       return unlink( QFile::encodeName( uidCacheLocation() ) );
     return 0;
   }
-
-//  kdDebug(5006) << "Writing out UID cache lastuid: " << lastUid()  << " in: " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+  kdDebug(5006) << "Writing out UID cache lastuid: " << lastUid()  << " in: " << folder()->prettyURL() << endl;
+#endif
   QFile uidcache( uidCacheLocation() );
   if( uidcache.open( IO_WriteOnly ) ) {
     QTextStream str( &uidcache );
@@ -471,7 +487,9 @@
   // Add the message
   int rc = KMFolderMaildir::addMsg(msg, index_return);
 
-  if( newMail && imapPath() == "/INBOX/" )
+  if( newMail && ( imapPath() == "/INBOX/" || ( !GlobalSettings::self()->filterOnlyDIMAPInbox()
+      && (userRights() <= 0 || userRights() & ACLJobs::Administer )
+      && (contentsType() == ContentsTypeMail || GlobalSettings::self()->filterGroupwareFolders()) ) ) )
     // This is a new message. Filter it
     mAccount->processNewMsg( msg );
 
@@ -491,10 +509,10 @@
 {
   KMMsgBase *msg = getMsgBase( idx );
   assert(msg);
-  ulong uid = msg->UID();
+  long uid = msg->UID();
   assert(uid>=0);
   mDeletedUIDsSinceLastSync.insert(uid, 0);
-//  kdDebug(5006) << "Explicit delete of UID " << uid << " at index: " << idx << " in " << folder()->prettyURL();
+  kdDebug(5006) << "Explicit delete of UID " << uid << " at index: " << idx << " in " << folder()->prettyURL() << endl;
 }
 
 /* Reimplemented from KMFolderMaildir */
@@ -558,7 +576,9 @@
 
 void KMFolderCachedImap::setLastUid( ulong uid )
 {
-//  kdDebug(5006) << "Setting mLastUid to: " << uid  <<  " in " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+  kdDebug(5006) << "Setting mLastUid to: " << uid  <<  " in " << folder()->prettyURL() << endl;
+#endif
   mLastUid = uid;
   if( uidWriteTimer == -1 )
     // Write in one minute
@@ -629,7 +649,7 @@
 // not been done
 KMAcctCachedImap *KMFolderCachedImap::account() const
 {
-  if( (KMAcctCachedImap *)mAccount == 0 ) {
+  if( (KMAcctCachedImap *)mAccount == 0 && kmkernel && kmkernel->acctMgr() ) {
     // Find the account
     mAccount = static_cast<KMAcctCachedImap *>( kmkernel->acctMgr()->findByName( name() ) );
   }
@@ -678,6 +698,8 @@
     }
     KMessageBox::information( 0, i18n( "The index of this folder has been "
                                        "recreated." ) );
+    writeIndex();
+    kmkernel->getKMMainWidget()->folderSelected();
   }
 }
 
@@ -1266,7 +1288,7 @@
   } else {
     // Error (error message already shown by the account)
     newState( mProgress, KIO::buildErrorString( errorCode, errorMsg ));
-    emit folderComplete(this, FALSE);
+    emit folderComplete(this, false);
   }
 }
 
@@ -1297,100 +1319,9 @@
       job->start();
       return;
     } else {
-      KMFolder *dest = 0;
-      bool manualMove = true;
-      while ( GlobalSettings::autoLostFoundMove() ) {
-        // find the inbox of this account
-        KMFolder *inboxFolder = kmkernel->findFolderById( QString(".%1.directory/INBOX").arg( account()->id() ) );
-        if ( !inboxFolder ) {
-          kdWarning(5006) << k_funcinfo << "inbox not found!" << endl;
-          break;
-        }
-        KMFolderDir *inboxDir = inboxFolder->child();
-        if ( !inboxDir && !inboxFolder->storage() )
-          break;
-        assert( inboxFolder->storage()->folderType() == KMFolderTypeCachedImap );
-
-        // create lost+found folder if needed
-        KMFolderNode *node;
-        KMFolder *lfFolder = 0;
-        if ( !(node = inboxDir->hasNamedFolder( i18n("lost+found") )) ) {
-          kdDebug(5006) << k_funcinfo << "creating lost+found folder" << endl;
-          KMFolder* folder = kmkernel->dimapFolderMgr()->createFolder(
-              i18n("lost+found"), false, KMFolderTypeCachedImap, inboxDir );
-          if ( !folder || !folder->storage() )
-            break;
-          static_cast<KMFolderCachedImap*>( folder->storage() )->initializeFrom(
-            static_cast<KMFolderCachedImap*>( inboxFolder->storage() ) );
-          folder->storage()->setContentsType( KMail::ContentsTypeMail );
-          folder->storage()->writeConfig();
-          lfFolder = folder;
-        } else {
-          kdDebug(5006) << k_funcinfo << "found lost+found folder" << endl;
-          lfFolder = dynamic_cast<KMFolder*>( node );
-        }
-        if ( !lfFolder || !lfFolder->createChildFolder() || !lfFolder->storage() )
-          break;
-
-        // create subfolder for this incident
-        QDate today = QDate::currentDate();
-        QString baseName = folder()->label() + "-" + QString::number( today.year() )
-            + (today.month() < 10 ? "0" : "" ) + QString::number( today.month() )
-            + (today.day() < 10 ? "0" : "" ) + QString::number( today.day() );
-        QString name = baseName;
-        int suffix = 0;
-        while ( (node = lfFolder->child()->hasNamedFolder( name )) ) {
-          ++suffix;
-          name = baseName + '-' + QString::number( suffix );
-        }
-        kdDebug(5006) << k_funcinfo << "creating lost+found folder " << name << endl;
-        dest = kmkernel->dimapFolderMgr()->createFolder( name, false, KMFolderTypeCachedImap, lfFolder->child() );
-        if ( !dest || !dest->storage() )
-            break;
-        static_cast<KMFolderCachedImap*>( dest->storage() )->initializeFrom(
-          static_cast<KMFolderCachedImap*>( lfFolder->storage() ) );
-        dest->storage()->setContentsType( contentsType() );
-        dest->storage()->writeConfig();
-
-        KMessageBox::sorry( 0, i18n("<p>There are new messages in folder <b>%1</b>, which "
-              "have not been uploaded to the server yet, but you do not seem to "
-              "have sufficient access rights on the folder now to upload them.</p>"
-              "<p>All affected messages will therefore be moved to <b>%2</b>"
-              "to avoid data loss.</p>").arg( folder()->prettyURL() ).arg( dest->prettyURL() ),
-              i18n("Insufficient access rights") );
-        manualMove = false;
-        break;
-      }
-
-      if ( manualMove ) {
-        const QString msg ( i18n( "<p>There are new messages in this folder (%1), which "
-              "have not been uploaded to the server yet, but you do not seem to "
-              "have sufficient access rights on the folder now to upload them. "
-              "Please contact your administrator to allow upload of new messages "
-              "to you, or move them out of this folder.</p> "
-              "<p>Do you want to move these messages to another folder now?</p>").arg( folder()->prettyURL() ) );
-        if ( KMessageBox::warningYesNo( 0, msg, QString::null, i18n("Move"), i18n("Do Not Move") ) == KMessageBox::Yes ) {
-          KMail::KMFolderSelDlg dlg( kmkernel->getKMMainWidget(),
-              i18n("Move Messages to Folder"), true );
-          if ( dlg.exec() ) {
-            dest = dlg.folder();
-          }
-        }
-      }
-      if ( dest ) {
-        QPtrList<KMMsgBase> msgs;
-        for( int i = 0; i < count(); ++i ) {
-          KMMsgBase *msg = getMsgBase( i );
-          if( !msg ) continue; /* what goes on if getMsg() returns 0? */
-          if ( msg->UID() == 0 )
-            msgs.append( msg );
-        }
-        KMCommand *command = new KMMoveCommand( dest, msgs );
-        connect( command, SIGNAL( completed( KMCommand * ) ),
-                  this, SLOT( serverSyncInternal() ) );
-        command->start();
-        return;
-      }
+      KMCommand *command = rescueUnsyncedMessages();
+      connect( command, SIGNAL( completed( KMCommand * ) ),
+               this, SLOT( serverSyncInternal() ) );
     }
   } else { // nothing to upload
     if ( mUserRights != mOldUserRights && (mOldUserRights & KMail::ACLJobs::Insert)
@@ -1431,7 +1362,7 @@
         // Either not a valid message or not one that is on the server yet
         continue;
 
-      QString flags = KMFolderImap::statusToFlags(msg->status());
+      QString flags = KMFolderImap::statusToFlags(msg->status(), mPermanentFlags);
       // Collect uids for each typem of flags.
       QString uid;
       uid.setNum( msg->UID() );
@@ -1647,6 +1578,7 @@
   else {
     newState( mProgress, i18n("Checking folder validity"));
     CachedImapJob *job = new CachedImapJob( FolderJob::tCheckUidValidity, this );
+    connect( job, SIGNAL(permanentFlags(int)), SLOT(slotPermanentFlags(int)) );
     connect( job, SIGNAL( result( KMail::FolderJob* ) ),
              this, SLOT( slotCheckUidValidityResult( KMail::FolderJob* ) ) );
     job->start();
@@ -1664,6 +1596,11 @@
   serverSyncInternal();
 }
 
+void KMFolderCachedImap::slotPermanentFlags(int flags)
+{
+  mPermanentFlags = flags;
+}
+
 /* This will only list the messages in a folder.
    No directory listing done*/
 void KMFolderCachedImap::listMessages() {
@@ -1741,14 +1678,30 @@
   // Start with something largish when rebuilding the cache
   if ( uidsOnServer.size() == 0 )
     uidsOnServer.resize( KMail::nextPrime( 2000 ) );
-  int flags;
   const int v = 42;
   while (pos >= 0) {
+      /*
     KMMessage msg;
     msg.fromString((*it).cdata.mid(16, pos - 16));
-    flags = msg.headerField("X-Flags").toInt();
-    bool deleted = ( flags & 8 );
-    ulong uid = msg.UID();
+    const int flags = msg.headerField("X-Flags").toInt();
+    const ulong size = msg.headerField("X-Length").toULong();
+    const ulong uid = msg.UID();
+       */
+    // The below is optimized for speed, not prettiness. The commented out chunk
+    // above was the solution copied from kmfolderimap, and it's 15-20% slower.
+    const QCString& entry( (*it).cdata );
+    const int indexOfUID = entry.find("X-UID", 16);
+    const int startOfUIDValue = indexOfUID  + 7;
+    const int indexOfLength = entry.find("X-Length", startOfUIDValue ); // we know length comes after UID
+    const int startOfLengthValue = indexOfLength + 10;
+    const int indexOfFlags = entry.find("X-Flags", startOfLengthValue ); // we know flags comes last
+    const int startOfFlagsValue = indexOfFlags + 9;
+
+    const int flags = entry.mid( startOfFlagsValue, entry.find( '\r', startOfFlagsValue ) - startOfFlagsValue ).toInt();
+    const ulong size = entry.mid( startOfLengthValue, entry.find( '\r', startOfLengthValue ) - startOfLengthValue ).toULong();
+    const ulong uid = entry.mid( startOfUIDValue, entry.find( '\r', startOfUIDValue ) - startOfUIDValue ).toULong();
+
+    const bool deleted = ( flags & 8 );
     if ( !deleted ) {
       if( uid != 0 ) {
         if ( uidsOnServer.count() == uidsOnServer.size() ) {
@@ -1771,7 +1724,9 @@
         // kdDebug(5006) << "KMFolderCachedImap::slotGetMessagesData() : folder "<<label()<<" already has msg="<<msg->headerField("Subject") << ", UID="<<uid << ", lastUid = " << mLastUid << endl;
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
-//           kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should delete it" << endl;
+#if MAIL_LOSS_DEBUGGING
+           kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should delete it" << endl;
+#endif
           // double check we deleted it since the last sync
            if ( mDeletedUIDsSinceLastSync.contains(uid) ) {
                if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
@@ -1783,9 +1738,9 @@
                    redownload = true;
                }
            } else {
-//               kdDebug(5006) << "WARNING: ####### " << endl;
-//               kdDebug(5006) << "Message locally missing but not deleted in folder: " << folder()->prettyURL() << endl;
-//               kdDebug(5006) << "The missing UID: " << uid << ". It will be redownloaded " << endl;
+               kdDebug(5006) << "WARNING: ####### " << endl;
+               kdDebug(5006) << "Message locally missing but not deleted in folder: " << folder()->prettyURL() << endl;
+               kdDebug(5006) << "The missing UID: " << uid << ". It will be redownloaded " << endl;
                redownload = true;
            }
 
@@ -1793,9 +1748,9 @@
           // if this is a read only folder, ignore status updates from the server
           // since we can't write our status back our local version is what has to
           // be considered correct.
-          if (!mReadOnly) {
+          if ( !mReadOnly || !GlobalSettings::allowLocalFlags() ) {
             /* The message is OK, update flags */
-            KMFolderImap::flagsToStatus( existingMessage, flags, false );
+            KMFolderImap::flagsToStatus( existingMessage, flags,  false, mReadOnly ? INT_MAX : mPermanentFlags );
           } else if ( mUserRights & KMail::ACLJobs::WriteSeenFlag ) {
             KMFolderImap::seenFlagToStatus( existingMessage, flags );
           }
@@ -1803,18 +1758,21 @@
         // kdDebug(5006) << "message with uid " << uid << " found in the local cache. " << endl;
       }
       if ( uid > lastUid() || redownload ) {
-//      kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should download it" << endl;
+#if MAIL_LOSS_DEBUGGING
+        kdDebug(5006) << "Looking at uid " << uid << " high water is: " << lastUid() << " we should download it" << endl;
+#endif
         // The message is new since the last sync, but we might have just uploaded it, in which case
         // the uid map already contains it.
         if ( !uidMap.contains( uid ) ) {
-          ulong size = msg.headerField("X-Length").toULong();
           mMsgsForDownload << KMail::CachedImapJob::MsgForDownload(uid, flags, size);
           if( imapPath() == "/INBOX/" )
             mUidsForDownload << uid;
         }
         // Remember the highest uid and once the download is completed, update mLastUid
         if ( uid > mTentativeHighestUid ) {
-//          kdDebug(5006) << "Setting the tentative highest UID to: " << uid << endl;
+#if MAIL_LOSS_DEBUGGING
+          kdDebug(5006) << "Setting the tentative highest UID to: " << uid << endl;
+#endif
           mTentativeHighestUid = uid;
         }
       }
@@ -1856,7 +1814,6 @@
   newState( mProgress + (progressSpan * done) / total, QString::null );
 }
 
-
 void KMFolderCachedImap::setAccount(KMAcctCachedImap *aAccount)
 {
   assert( aAccount->isA("KMAcctCachedImap") );
@@ -2027,10 +1984,10 @@
   mSubfolderNames = folderNames;
   mSubfolderPaths = folderPaths;
   mSubfolderMimeTypes = folderMimeTypes;
+  mSubfolderState = imapFinished;
   mSubfolderAttributes = folderAttributes;
+  kdDebug(5006) << "##### setting subfolder attributes: " << mSubfolderAttributes << endl;
 
-  mSubfolderState = imapFinished;
-
   folder()->createChildFolder();
   KMFolderNode *node = folder()->child()->first();
   bool root = ( this == mAccount->rootFolder() );
@@ -2061,6 +2018,12 @@
           }
         } else { // folder both local and on server
           //kdDebug(5006) << node->name() << " is on the server." << endl;
+
+          /**
+           * Store the folder attributes for every subfolder.
+           */
+          int index = mSubfolderNames.findIndex( node->name() );
+          f->mFolderAttributes = folderAttributes[ index ];
         }
       } else {
         //kdDebug(5006) << "skipping dir node:" << node->name() << endl;
@@ -2070,11 +2033,13 @@
   }
 
   for ( KMFolder* doomed=toRemove.first(); doomed; doomed = toRemove.next() ) {
-    kmkernel->dimapFolderMgr()->remove( doomed );
+    rescueUnsyncedMessagesAndDeleteFolder( doomed );
   }
 
   mProgress += 5;
-  serverSyncInternal();
+
+  // just in case there is nothing to rescue
+  slotRescueDone( 0 );
 }
 
 // This synchronizes the local folders as needed (creation/deletion). No network communication here.
@@ -2219,6 +2184,8 @@
       f->setNoContent(mSubfolderMimeTypes[idx] == "inode/directory");
       f->setNoChildren(mSubfolderMimeTypes[idx] == "message/digest");
       f->setImapPath(mSubfolderPaths[idx]);
+      f->mFolderAttributes = mSubfolderAttributes[idx];
+      kdDebug(5006) << " ####### Attributes: " << f->mFolderAttributes <<endl;
       //kdDebug(5006) << subfolderPath << ": mAnnotationFolderType set to FROMSERVER" << endl;
       kmkernel->dimapFolderMgr()->contentsChanged();
     } else {
@@ -2298,7 +2265,6 @@
   buff.close();
 }
 
-
 FolderJob*
 KMFolderCachedImap::doCreateJob( KMMessage *msg, FolderJob::JobType jt, KMFolder *folder,
                                  QString, const AttachmentStrategy* ) const
@@ -2366,10 +2332,18 @@
 void
 KMFolderCachedImap::slotStorageQuotaResult( const QuotaInfo& info )
 {
-    mQuotaInfo = info;
-    writeConfigKeysWhichShouldNotGetOverwrittenByReadConfig();
+  setQuotaInfo( info );
 }
 
+void KMFolderCachedImap::setQuotaInfo( const QuotaInfo & info )
+{
+    if ( info != mQuotaInfo ) {
+      mQuotaInfo = info;
+      writeConfigKeysWhichShouldNotGetOverwrittenByReadConfig();
+      emit folderSizeChanged();
+    }
+}
+
 void
 KMFolderCachedImap::setACLList( const ACLList& arr )
 {
@@ -2664,7 +2638,6 @@
   createFoldersNewOnServerAndFinishListing( folders );
 }
 
-
 void KMFolderCachedImap::slotQuotaResult( KIO::Job* job )
 {
   KMAcctCachedImap::JobIterator it = mAccount->findJob(job);
@@ -2679,7 +2652,7 @@
     if ( job->error() == KIO::ERR_UNSUPPORTED_ACTION ) {
       // that's when the imap server doesn't support quota
       mAccount->setHasNoQuotaSupport();
-      mQuotaInfo = empty;
+      setQuotaInfo( empty );
     }
     else
       kdWarning(5006) << "slotGetQuotaResult: " << job->errorString() << endl;
@@ -2690,8 +2663,6 @@
   serverSyncInternal();
 }
 
-
-
 void
 KMFolderCachedImap::slotAnnotationChanged( const QString& entry, const QString& attribute, const QString& value )
 {
@@ -2751,7 +2722,7 @@
 void KMFolderCachedImap::slotUpdateLastUid()
 {
   if( mTentativeHighestUid != 0 ) {
-    
+
       // Sanity checking:
       // By now all new mails should be downloaded, which means
       // that iteration over the folder should yield only UIDs
@@ -2777,7 +2748,9 @@
           }
       }
       if (sane) {
-//          kdDebug(5006) << "Tentative highest UID test was sane, writing out: " << mTentativeHighestUid << endl;
+#if MAIL_LOSS_DEBUGGING
+          kdDebug(5006) << "Tentative highest UID test was sane, writing out: " << mTentativeHighestUid << endl;
+#endif
           setLastUid( mTentativeHighestUid );
       }
   }
@@ -2820,4 +2793,175 @@
   return createIndexFromContents();
 }
 
+void KMFolderCachedImap::setAlarmsBlocked( bool blocked )
+{
+  mAlarmsBlocked = blocked;
+}
+
+bool KMFolderCachedImap::alarmsBlocked() const
+{
+  return mAlarmsBlocked;
+}
+
+bool KMFolderCachedImap::isCloseToQuota() const
+{
+  bool closeToQuota = false;
+  if ( mQuotaInfo.isValid() && mQuotaInfo.max().toInt() > 0 ) {
+    const int ratio = mQuotaInfo.current().toInt() * 100  / mQuotaInfo.max().toInt();
+    //kdDebug(5006) << "Quota ratio: " << ratio << "% " << mQuotaInfo.toString() << endl;
+    closeToQuota = ( ratio > 0 && ratio >= GlobalSettings::closeToQuotaThreshold() );
+  }
+  //kdDebug(5006) << "Folder: " << folder()->prettyURL() << " is over quota: " << closeToQuota << endl;
+  return closeToQuota;
+}
+
+KMCommand* KMFolderCachedImap::rescueUnsyncedMessages()
+{
+  QValueList<unsigned long> newMsgs = findNewMessages();
+  kdDebug() << k_funcinfo << newMsgs << " of " << count() << endl;
+  if ( newMsgs.isEmpty() )
+    return 0;
+  KMFolder *dest = 0;
+  bool manualMove = true;
+  while ( GlobalSettings::autoLostFoundMove() ) {
+    // find the inbox of this account
+    KMFolder *inboxFolder = kmkernel->findFolderById( QString(".%1.directory/INBOX").arg( account()->id() ) );
+    if ( !inboxFolder ) {
+      kdWarning(5006) << k_funcinfo << "inbox not found!" << endl;
+      break;
+    }
+    KMFolderDir *inboxDir = inboxFolder->child();
+    if ( !inboxDir && !inboxFolder->storage() )
+      break;
+    assert( inboxFolder->storage()->folderType() == KMFolderTypeCachedImap );
+
+    // create lost+found folder if needed
+    KMFolderNode *node;
+    KMFolder *lfFolder = 0;
+    if ( !(node = inboxDir->hasNamedFolder( i18n("lost+found") )) ) {
+      kdDebug(5006) << k_funcinfo << "creating lost+found folder" << endl;
+      KMFolder* folder = kmkernel->dimapFolderMgr()->createFolder(
+          i18n("lost+found"), false, KMFolderTypeCachedImap, inboxDir );
+      if ( !folder || !folder->storage() )
+        break;
+      static_cast<KMFolderCachedImap*>( folder->storage() )->initializeFrom(
+        static_cast<KMFolderCachedImap*>( inboxFolder->storage() ) );
+      folder->storage()->setContentsType( KMail::ContentsTypeMail );
+      folder->storage()->writeConfig();
+      lfFolder = folder;
+    } else {
+      kdDebug(5006) << k_funcinfo << "found lost+found folder" << endl;
+      lfFolder = dynamic_cast<KMFolder*>( node );
+    }
+    if ( !lfFolder || !lfFolder->createChildFolder() || !lfFolder->storage() )
+      break;
+
+    // create subfolder for this incident
+    QDate today = QDate::currentDate();
+    QString baseName = folder()->label() + "-" + QString::number( today.year() )
+        + (today.month() < 10 ? "0" : "" ) + QString::number( today.month() )
+        + (today.day() < 10 ? "0" : "" ) + QString::number( today.day() );
+    QString name = baseName;
+    int suffix = 0;
+    while ( (node = lfFolder->child()->hasNamedFolder( name )) ) {
+      ++suffix;
+      name = baseName + '-' + QString::number( suffix );
+    }
+    kdDebug(5006) << k_funcinfo << "creating lost+found folder " << name << endl;
+    dest = kmkernel->dimapFolderMgr()->createFolder( name, false, KMFolderTypeCachedImap, lfFolder->child() );
+    if ( !dest || !dest->storage() )
+        break;
+    static_cast<KMFolderCachedImap*>( dest->storage() )->initializeFrom(
+      static_cast<KMFolderCachedImap*>( lfFolder->storage() ) );
+    dest->storage()->setContentsType( contentsType() );
+    dest->storage()->writeConfig();
+
+    KMessageBox::sorry( 0, i18n("<p>There are new messages in folder <b>%1</b>, which "
+          "have not been uploaded to the server yet, but the folder has been deleted "
+          "on the server or you do not "
+          "have sufficient access rights on the folder to upload them.</p>"
+          "<p>All affected messages will therefore be moved to <b>%2</b> "
+          "to avoid data loss.</p>").arg( folder()->prettyURL() ).arg( dest->prettyURL() ),
+          i18n("Insufficient access rights") );
+    manualMove = false;
+    break;
+  }
+
+  if ( manualMove ) {
+    const QString msg ( i18n( "<p>There are new messages in this folder (%1), which "
+          "have not been uploaded to the server yet, but the folder has been deleted "
+          "on the server or you do not "
+          "have sufficient access rights on the folder now to upload them. "
+          "Please contact your administrator to allow upload of new messages "
+          "to you, or move them out of this folder.</p> "
+          "<p>Do you want to move these messages to another folder now?</p>").arg( folder()->prettyURL() ) );
+    if ( KMessageBox::warningYesNo( 0, msg, QString::null, i18n("Move"), i18n("Do Not Move") ) == KMessageBox::Yes ) {
+      KMail::KMFolderSelDlg dlg( kmkernel->getKMMainWidget(),
+          i18n("Move Messages to Folder"), true );
+      if ( dlg.exec() ) {
+        dest = dlg.folder();
+      }
+    }
+  }
+  if ( dest ) {
+    QPtrList<KMMsgBase> msgs;
+    for( int i = 0; i < count(); ++i ) {
+      KMMsgBase *msg = getMsgBase( i );
+      if( !msg ) continue; /* what goes on if getMsg() returns 0? */
+      if ( msg->UID() == 0 )
+        msgs.append( msg );
+    }
+    KMCommand *command = new KMMoveCommand( dest, msgs );
+    command->start();
+    return command;
+  }
+  return 0;
+}
+
+void KMFolderCachedImap::rescueUnsyncedMessagesAndDeleteFolder( KMFolder *folder, bool root )
+{
+  kdDebug() << k_funcinfo << folder << " " << root << endl;
+  if ( root )
+    mToBeDeletedAfterRescue.append( folder );
+  folder->open("cachedimap");
+  KMFolderCachedImap* storage = dynamic_cast<KMFolderCachedImap*>( folder->storage() );
+  if ( storage ) {
+    KMCommand *command = storage->rescueUnsyncedMessages();
+    if ( command ) {
+      connect( command, SIGNAL(completed(KMCommand*)),
+               SLOT(slotRescueDone(KMCommand*)) );
+      ++mRescueCommandCount;
+    } else {
+      // nothing to rescue, close folder
+      // (we don't need to close it in the other case, it will be deleted anyway)
+      folder->close("cachedimap");
+    }
+  }
+  if ( folder->child() ) {
+    KMFolderNode *node = folder->child()->first();
+    while (node) {
+      if (!node->isDir() ) {
+        KMFolder *subFolder = static_cast<KMFolder*>( node );
+        rescueUnsyncedMessagesAndDeleteFolder( subFolder, false );
+      }
+      node = folder->child()->next();
+    }
+  }
+}
+
+void KMFolderCachedImap::slotRescueDone(KMCommand * command)
+{
+  // FIXME: check command result
+  if ( command )
+    --mRescueCommandCount;
+  if ( mRescueCommandCount > 0 )
+    return;
+  for ( QValueList<KMFolder*>::ConstIterator it = mToBeDeletedAfterRescue.constBegin();
+        it != mToBeDeletedAfterRescue.constEnd(); ++it ) {
+    kmkernel->dimapFolderMgr()->remove( *it );
+  }
+  mToBeDeletedAfterRescue.clear();
+  serverSyncInternal();
+}
+
 #include "kmfoldercachedimap.moc"
Index: kmail/renamejob.cpp
===================================================================
--- kmail/renamejob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/renamejob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -200,7 +200,7 @@
   mCopyFolderJob = 0;
 
   if ( mStorageTempOpened ) {
-    mStorageTempOpened->close("renamejob");
+    mStorageTempOpened->close( "renamejob" );
     mStorageTempOpened = 0;
   }
 
Index: kmail/kmail_part.rc
===================================================================
--- kmail/kmail_part.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
      the same menu entries at the same place in KMail and Kontact  -->
 
 <!DOCTYPE kpartgui>
-<kpartgui version="13" name="kmail_part" >
+<kpartgui version="18" name="kmail_part" >
  <MenuBar>
   <Menu noMerge="1" name="file" >
    <text>&amp;File</text>
@@ -27,6 +27,7 @@
    <Separator/>
    <Action name="online_status" />
    <Action name="check_mail" />
+   <Action name="favorite_check_mail"/>
    <Action name="check_mail_in" />
    <Action name="send_queued" />
    <Action name="send_queued_via" />
@@ -124,12 +125,10 @@
    </Menu>
    <Menu name="menubar_message_forward">
      <text>&amp;Forward</text>
-     <Action name="message_forward_as_attachment" />
-     <Action name="message_forward_inline" />
-     <Action name="message_forward_as_digest" />
-     <Action name="message_forward_redirect" />
+     <ActionList name="forward_action_list"/>
    </Menu>
    <Action name="send_again" />
+   <Action name="edit"/>
    <Separator/>
    <Action name="copy_to" />
    <Action name="move_to" />
@@ -143,6 +142,8 @@
      <Action name="apply_filters" />
      <ActionList name="menu_filter_actions" />
    </Menu>
+   <Separator/>
+   <Action name="create_todo"/>
   </Menu>
   <Menu noMerge="1" name="tools">
    <text>&amp;Tools</text>
@@ -193,5 +194,6 @@
   <Separator/>
   <Action name="search_messages" />
   <ActionList name="toolbar_filter_actions" />
+  <Action name="create_todo"/>
  </ToolBar>
 </kpartgui>
Index: kmail/index.cpp
===================================================================
--- kmail/index.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/index.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 /* This file is part of KMail
- * Copyright (C) 2005 LuÌs Pedro Coelho <luis@luispedro.org>
+ * Copyright (C) 2005 Lu√≠s Pedro Coelho <luis@luispedro.org>
  *
  * KMail is free software; you can redistribute it and/or modify it
  * under the terms of the GNU General Public License, version 2, as
Index: kmail/eventsrc
===================================================================
--- kmail/eventsrc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/eventsrc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -20,6 +20,7 @@
 Name[da]=Ny post ankommet
 Name[de]=Neue Nachrichten sind angekommen
 Name[el]=ŒàœÜœÑŒ±œÉŒµ ŒΩŒ≠Œ± Œ±ŒªŒªŒ∑ŒªŒøŒ≥œÅŒ±œÜŒØŒ±
+Name[eo]=Nova Po≈ùto Alvenis
 Name[es]=Hay correo nuevo
 Name[et]=Saabus uus kiri
 Name[eu]=Posta berri bat iritsi da
@@ -73,6 +74,7 @@
 Comment[da]=Ny post ankommet
 Comment[de]=Neue Nachrichten sind angekommen
 Comment[el]=ŒàœÜœÑŒ±œÉŒµ ŒΩŒ≠Œ± Œ±ŒªŒªŒ∑ŒªŒøŒ≥œÅŒ±œÜŒØŒ±
+Comment[eo]=Nova po≈ùto alvenis
 Comment[es]=Hay correo nuevo
 Comment[et]=Saabus uus kiri
 Comment[eu]=Posta berri bat iritsi da
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -333,6 +333,14 @@
     kmkernel->acctMgr()->singleCheckMail(acct, false);
 }
 
+void KMKernel::loadProfile( const QString& )
+{
+}
+
+void KMKernel::saveToProfile( const QString& ) const
+{
+}
+
 void KMKernel::openReader( bool onlyCheck )
 {
   mWin = 0;
@@ -425,7 +433,7 @@
   }
 
   KMail::Composer * cWin = KMail::makeComposer( msg );
-  cWin->setCharset("", TRUE);
+  cWin->setCharset("", true);
   for ( KURL::List::ConstIterator it = attachURLs.begin() ; it != attachURLs.end() ; ++it )
     cWin->addAttach((*it));
   if (hidden == 0) {
@@ -543,7 +551,7 @@
       && GlobalSettings::self()->legacyBodyInvites() );
   cWin->setAutoDelete( true );
   if( noWordWrap )
-    cWin->slotWordWrapToggled( false );
+    cWin->disableWordWrap();
   else
     cWin->setCharset( "", true );
   if ( msgPart )
@@ -595,7 +603,7 @@
   }
 
   KMail::Composer * cWin = KMail::makeComposer( msg );
-  cWin->setCharset("", TRUE);
+  cWin->setCharset("", true);
   if (!hidden) {
     cWin->show();
     // Activate window - doing this instead of KWin::activateWindow(cWin->winId());
@@ -679,7 +687,7 @@
   msg->setBody( i18n( "Please create a certificate from attachment and return to sender." ).utf8() );
 
   KMail::Composer * cWin = KMail::makeComposer( msg );
-  cWin->setCharset("", TRUE);
+  cWin->setCharset("", true);
   cWin->slotSetAlwaysSend( true );
   if (!certData.isEmpty()) {
     KMMessagePart *msgPart = new KMMessagePart;
@@ -810,7 +818,7 @@
         KMFolderDir *subfolder;
         bool root = true;
 
-        QStringList subFList = QStringList::split("/",_foldername,FALSE);
+        QStringList subFList = QStringList::split("/",_foldername,false);
 
         for ( QStringList::Iterator it = subFList.begin(); it != subFList.end(); ++it ) {
           QString _newFolder = *it;
@@ -827,7 +835,7 @@
             subfolder = folder->createChildFolder();
             tmp_fname += "/" + *it;
             if(!the_folderMgr->getFolderByURL( tmp_fname )) {
-             folder = the_folderMgr->createFolder(*it, FALSE, folder->folderType(), subfolder);
+             folder = the_folderMgr->createFolder(*it, false, folder->folderType(), subfolder);
             }
 
             if(!(folder = the_folderMgr->getFolderByURL( tmp_fname ))) return -1;
@@ -988,7 +996,7 @@
         KMFolderDir *subfolder;
         bool root = true;
 
-        QStringList subFList = QStringList::split("/",_foldername,FALSE);
+        QStringList subFList = QStringList::split("/",_foldername,false);
 
         for ( QStringList::Iterator it = subFList.begin(); it != subFList.end(); ++it ) {
           QString _newFolder = *it;
@@ -1005,7 +1013,7 @@
             subfolder = folder->createChildFolder();
             tmp_fname += "/" + *it;
             if(!the_folderMgr->getFolderByURL( tmp_fname )) {
-              folder = the_folderMgr->createFolder(*it, FALSE, folder->folderType(), subfolder);
+              folder = the_folderMgr->createFolder(*it, false, folder->folderType(), subfolder);
             }
             if(!(folder = the_folderMgr->getFolderByURL( tmp_fname ))) return -1;
           }
@@ -1103,7 +1111,7 @@
     KMMsgDict::instance()->getLocation(serialNumber, &folder, &idx);
     if (!folder || (idx == -1))
       return false;
-    folder->open("showmail");
+    KMFolderOpener openFolder(folder, "showmail");
     KMMsgBase *msgBase = folder->getMsgBase(idx);
     if (!msgBase)
       return false;
@@ -1120,7 +1128,6 @@
 
     if (unGet)
       folder->unGetMsg(idx);
-    folder->close("showmail");
     return true;
   }
 
@@ -1134,7 +1141,7 @@
   KMMsgDict::instance()->getLocation(serialNumber, &folder, &idx);
   if (!folder || (idx == -1))
     return QString::null;
-  folder->open("getFrom");
+  KMFolderOpener openFolder(folder, "getFrom");
   KMMsgBase *msgBase = folder->getMsgBase(idx);
   if (!msgBase)
     return QString::null;
@@ -1143,7 +1150,6 @@
   QString result = msg->from();
   if (unGet)
     folder->unGetMsg(idx);
-  folder->close("getFrom");
   return result;
 }
 
@@ -1165,17 +1171,16 @@
     // different folder
     if (folder && (idx != -1)) {
       // everything is ok
-      folder->open("debugser");
+      KMFolderOpener openFolder(folder, "debugser");
       msg = folder->getMsgBase( idx );
       if (msg) {
-	res.append( QString( " subject %s,\n sender %s,\n date %s.\n" )
-		    .arg( msg->subject() )
-		    .arg( msg->fromStrip() )
-		    .arg( msg->dateStr() ) );
+        res.append( QString( " subject %s,\n sender %s,\n date %s.\n" )
+                             .arg( msg->subject() )
+                             .arg( msg->fromStrip() )
+                             .arg( msg->dateStr() ) );
       } else {
-	res.append( QString( "Invalid serial number." ) );
+        res.append( QString( "Invalid serial number." ) );
       }
-      folder->close("debugser");
     } else {
       res.append( QString( "Invalid serial number." ) );
     }
@@ -1337,8 +1342,8 @@
     return;
 
   KMFolder folder( 0, pathName + "autosave", KMFolderTypeMaildir, false /* no index */ );
-  const int rc = folder.open("recover");
-  if ( rc ) {
+  KMFolderOpener openFolder( &folder, "recover" );
+  if ( !folder.isOpened() ) {
     perror( "cannot open autosave folder" );
     return;
   }
@@ -1353,7 +1358,6 @@
       win->show();
     }
   }
-  folder.close("recover");
 }
 
 //-----------------------------------------------------------------------------
@@ -1375,7 +1379,7 @@
     emergencyExit( i18n("You do not have read/write permission to your inbox folder.") );
   }
 
-  the_inboxFolder->setSystemFolder(TRUE);
+  the_inboxFolder->setSystemFolder(true);
   if ( the_inboxFolder->userWhoField().isEmpty() )
     the_inboxFolder->setUserWhoField( QString::null );
   // inboxFolder->open();
@@ -1386,7 +1390,7 @@
   }
   the_outboxFolder->setNoChildren(true);
 
-  the_outboxFolder->setSystemFolder(TRUE);
+  the_outboxFolder->setSystemFolder(true);
   if ( the_outboxFolder->userWhoField().isEmpty() )
     the_outboxFolder->setUserWhoField( QString::null );
   /* Nuke the oubox's index file, to make sure that no ghost messages are in
@@ -1403,7 +1407,7 @@
   if (the_sentFolder->canAccess() != 0) {
     emergencyExit( i18n("You do not have read/write permission to your sent-mail folder.") );
   }
-  the_sentFolder->setSystemFolder(TRUE);
+  the_sentFolder->setSystemFolder(true);
   if ( the_sentFolder->userWhoField().isEmpty() )
     the_sentFolder->setUserWhoField( QString::null );
   // the_sentFolder->open();
@@ -1412,7 +1416,7 @@
   if (the_trashFolder->canAccess() != 0) {
     emergencyExit( i18n("You do not have read/write permission to your trash folder.") );
   }
-  the_trashFolder->setSystemFolder( TRUE );
+  the_trashFolder->setSystemFolder( true );
   if ( the_trashFolder->userWhoField().isEmpty() )
     the_trashFolder->setUserWhoField( QString::null );
   // the_trashFolder->open();
@@ -1421,7 +1425,7 @@
   if (the_draftsFolder->canAccess() != 0) {
     emergencyExit( i18n("You do not have read/write permission to your drafts folder.") );
   }
-  the_draftsFolder->setSystemFolder( TRUE );
+  the_draftsFolder->setSystemFolder( true );
   if ( the_draftsFolder->userWhoField().isEmpty() )
     the_draftsFolder->setUserWhoField( QString::null );
   the_draftsFolder->open("kmkernel");
@@ -1432,7 +1436,7 @@
   if ( the_templatesFolder->canAccess() != 0 ) {
     emergencyExit( i18n("You do not have read/write permission to your templates folder.") );
   }
-  the_templatesFolder->setSystemFolder( TRUE );
+  the_templatesFolder->setSystemFolder( true );
   if ( the_templatesFolder->userWhoField().isEmpty() )
     the_templatesFolder->setUserWhoField( QString::null );
   the_templatesFolder->open("kmkernel");
@@ -1679,7 +1683,7 @@
 
   if (the_trashFolder) {
 
-    the_trashFolder->close("kmkernel", TRUE);
+    the_trashFolder->close("kmkernel", true);
 
     if (config->readBoolEntry("empty-trash-on-exit", true))
     {
@@ -1698,7 +1702,7 @@
   {
     folder = *folders.at(i);
     if (!folder || folder->isDir()) continue;
-    folder->close("kmkernel", TRUE);
+    folder->close("kmkernel", true);
   }
   strList.clear();
   folders.clear();
@@ -1707,7 +1711,7 @@
   {
     folder = *folders.at(i);
     if (!folder || folder->isDir()) continue;
-    folder->close("kmkernel", TRUE);
+    folder->close("kmkernel", true);
   }
 
   delete the_msgIndex;
@@ -1889,7 +1893,7 @@
   bool overwrite)
 {
   // ## when KDE 3.3 is out: use KIO::storedPut to remove slotDataReq altogether
-  KIO::Job *job = KIO::put(aURL, -1, overwrite, FALSE);
+  KIO::Job *job = KIO::put(aURL, -1, overwrite, false);
   putData pd; pd.url = aURL; pd.data = aData; pd.offset = 0;
   mPutJobs.insert(job, pd);
   connect(job, SIGNAL(dataReq(KIO::Job*,QByteArray&)),
@@ -1935,7 +1939,7 @@
         i18n("File %1 exists.\nDo you want to replace it?")
         .arg((*it).url.prettyURL()), i18n("Save to File"), i18n("&Replace"))
         == KMessageBox::Continue)
-        byteArrayToRemoteFile((*it).data, (*it).url, TRUE);
+        byteArrayToRemoteFile((*it).data, (*it).url, true);
     }
     else job->showErrorDialog();
   }
@@ -2317,10 +2321,12 @@
   if ( !widget )
     return true;
   KMSystemTray* systray = widget->systray();
-  if ( systray && systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowAlways ) {
+  if ( !systray || GlobalSettings::closeDespiteSystemTray() )
+      return true;
+  if ( systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowAlways ) {
     systray->hideKMail();
     return false;
-  } else if ( systray && systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowOnUnread ) {
+  } else if ( systray->mode() == GlobalSettings::EnumSystemTrayPolicy::ShowOnUnread ) {
     systray->show();
     systray->hideKMail();
     return false;
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/headerstyle.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -64,6 +64,8 @@
 #include <qapplication.h>
 #include <qregexp.h>
 
+#include <kstandarddirs.h>
+
 namespace KMail {
 
   //
@@ -110,12 +112,12 @@
     const HeaderStyle * prev() const { return fancy(); }
 
     QString format( const KMMessage * message, const HeaderStrategy * strategy,
-                    const QString & vCardName, bool printing ) const;
+                    const QString & vCardName, bool printing, bool topLevel ) const;
   };
 
   QString BriefHeaderStyle::format( const KMMessage * message,
                                     const HeaderStrategy * strategy,
-                                    const QString & vCardName, bool printing ) const {
+                                    const QString & vCardName, bool printing, bool topLevel ) const {
     if ( !message ) return QString::null;
     if ( !strategy )
       strategy = HeaderStrategy::brief();
@@ -205,7 +207,7 @@
     const HeaderStyle * prev() const { return brief(); }
 
     QString format( const KMMessage * message, const HeaderStrategy * strategy,
-                    const QString & vCardName, bool printing ) const;
+                    const QString & vCardName, bool printing, bool topLevel ) const;
 
   private:
     QString formatAllMessageHeaders( const KMMessage * message ) const;
@@ -213,7 +215,7 @@
 
   QString PlainHeaderStyle::format( const KMMessage * message,
                                     const HeaderStrategy * strategy,
-                                    const QString & vCardName, bool printing ) const {
+                                    const QString & vCardName, bool printing, bool topLevel ) const {
     if ( !message ) return QString::null;
     if ( !strategy )
       strategy = HeaderStrategy::rich();
@@ -288,7 +290,7 @@
       if ( fromStr.isEmpty() ) // no valid email in from, maybe just a name
         fromStr = message->fromStrip(); // let's use that
       headerStr.append(i18n("From: ") +
-          KMMessage::emailAddrAsAnchor( fromStr, false) );
+          KMMessage::emailAddrAsAnchor( fromStr, "", false) );
       if ( !vCardName.isEmpty() )
         headerStr.append("&nbsp;&nbsp;<a href=\"" + vCardName +
               "\">" + i18n("[vCard]") + "</a>" );
@@ -306,19 +308,19 @@
 
     if ( strategy->showHeader( "to" ) )
       headerStr.append(i18n("To: ")+
-                       KMMessage::emailAddrAsAnchor(message->to(),FALSE) + "<br>\n");
+                       KMMessage::emailAddrAsAnchor(message->to(),false) + "<br>\n");
 
     if ( strategy->showHeader( "cc" ) && !message->cc().isEmpty() )
       headerStr.append(i18n("CC: ")+
-                       KMMessage::emailAddrAsAnchor(message->cc(),FALSE) + "<br>\n");
+                       KMMessage::emailAddrAsAnchor(message->cc(),false) + "<br>\n");
 
     if ( strategy->showHeader( "bcc" ) && !message->bcc().isEmpty() )
       headerStr.append(i18n("BCC: ")+
-                       KMMessage::emailAddrAsAnchor(message->bcc(),FALSE) + "<br>\n");
+                       KMMessage::emailAddrAsAnchor(message->bcc(),false) + "<br>\n");
 
     if ( strategy->showHeader( "reply-to" ) && !message->replyTo().isEmpty())
       headerStr.append(i18n("Reply to: ")+
-                     KMMessage::emailAddrAsAnchor(message->replyTo(),FALSE) + "<br>\n");
+                     KMMessage::emailAddrAsAnchor(message->replyTo(),false) + "<br>\n");
 
     headerStr += "</div>\n";
 
@@ -351,11 +353,11 @@
 
   public:
     const char * name() const { return "fancy"; }
-    const HeaderStyle * next() const { return brief(); }
+    const HeaderStyle * next() const { return enterprise(); }
     const HeaderStyle * prev() const { return plain(); }
 
     QString format( const KMMessage * message, const HeaderStrategy * strategy,
-                    const QString & vCardName, bool printing ) const;
+                    const QString & vCardName, bool printing, bool topLevel ) const;
     static QString imgToDataUrl( const QImage & image,
                                  const char *fmt = "PNG" );
 
@@ -413,7 +415,7 @@
 
   QString FancyHeaderStyle::format( const KMMessage * message,
                                     const HeaderStrategy * strategy,
-                                    const QString & vCardName, bool printing ) const {
+                                    const QString & vCardName, bool printing, bool topLevel ) const {
     if ( !message ) return QString::null;
     if ( !strategy )
       strategy = HeaderStrategy::rich();
@@ -639,7 +641,7 @@
                  + ( !message->headerField( "Resent-From" ).isEmpty() ? "&nbsp;"
                                 + i18n("(resent from %1)")
                                   .arg( KMMessage::emailAddrAsAnchor(
-                                    message->headerField( "Resent-From" ),FALSE) )
+                                    message->headerField( "Resent-From" ),false) )
                               : QString("") )
                  + ( !vCardName.isEmpty() ? "&nbsp;&nbsp;<a href=\"" + vCardName + "\">"
                                 + i18n("[vCard]") + "</a>"
@@ -661,21 +663,21 @@
       headerStr.append(QString("<tr><th>%1</th>\n"
                                "<td>%2</td></tr>\n")
                        .arg(i18n("To: "))
-                       .arg(KMMessage::emailAddrAsAnchor(message->to(),FALSE)));
+                       .arg(KMMessage::emailAddrAsAnchor(message->to(),false)));
 
     // cc line, if any
     if ( strategy->showHeader( "cc" ) && !message->cc().isEmpty())
       headerStr.append(QString("<tr><th>%1</th>\n"
                                "<td>%2</td></tr>\n")
                        .arg(i18n("CC: "))
-                       .arg(KMMessage::emailAddrAsAnchor(message->cc(),FALSE)));
+                       .arg(KMMessage::emailAddrAsAnchor(message->cc(),false)));
 
     // Bcc line, if any
     if ( strategy->showHeader( "bcc" ) && !message->bcc().isEmpty())
       headerStr.append(QString("<tr><th>%1</th>\n"
                                "<td>%2</td></tr>\n")
                        .arg(i18n("BCC: "))
-                       .arg(KMMessage::emailAddrAsAnchor(message->bcc(),FALSE)));
+                       .arg(KMMessage::emailAddrAsAnchor(message->bcc(),false)));
 
     if ( strategy->showHeader( "date" ) )
       headerStr.append(QString("<tr><th>%1</th>\n"
@@ -712,6 +714,7 @@
                                     .arg( directionOf( onlineStatus ) )
                                     .arg(onlineStatus));
     */
+    headerStr.append( QString("<tr><td colspan=\"2\"><div id=\"attachmentInjectionPoint\"></div></td></tr>" ) );
     headerStr.append(
           QString( "</table></td><td align=\"center\">%1</td></tr></table>\n" ).arg(userHTML) );
 
@@ -733,6 +736,186 @@
            .arg( fmt, KCodecs::base64Encode( ba ) );
   }
 
+// #####################
+
+  class EnterpriseHeaderStyle : public HeaderStyle {
+    friend class ::KMail::HeaderStyle;
+  protected:
+    EnterpriseHeaderStyle() : HeaderStyle() {}
+    virtual ~EnterpriseHeaderStyle() {}
+
+  public:
+    const char * name() const { return "enterprise"; }
+    const HeaderStyle * next() const { return brief(); }
+    const HeaderStyle * prev() const { return fancy(); }
+
+    QString format( const KMMessage * message, const HeaderStrategy * strategy,
+                    const QString & vCardName, bool printing, bool topLevel ) const;
+  };
+
+    QString EnterpriseHeaderStyle::format( const KMMessage * message,
+                                    const HeaderStrategy * strategy,
+                                    const QString & vCardName, bool printing, bool topLevel ) const {
+	if ( !message ) return QString::null;
+	if ( !strategy )
+	    strategy = HeaderStrategy::brief();
+
+	// The direction of the header is determined according to the direction
+	// of the application layout.
+
+	QString dir = QApplication::reverseLayout() ? "rtl" : "ltr" ;
+
+	// However, the direction of the message subject within the header is
+	// determined according to the contents of the subject itself. Since
+	// the "Re:" and "Fwd:" prefixes would always cause the subject to be
+	// considered left-to-right, they are ignored when determining its
+	// direction.
+
+	QString subjectDir;
+	if (!message->subject().isEmpty())
+	    subjectDir = directionOf( message->cleanSubject() );
+	else
+	    subjectDir = directionOf( i18n("No Subject") );
+
+	// colors depend on if its encapsulated or not
+        QColor fontColor(Qt::white);
+	QString linkColor = "class =\"white\"";
+	const QColor activeColor = qApp->palette().active().highlight();
+	QColor activeColorDark = activeColor.dark(130);
+        // reverse colors for encapsulated
+        if( !topLevel ){
+            activeColorDark = activeColor.dark(50);
+            fontColor = qApp->palette().active().text();
+	    linkColor = "";
+        }
+
+	QStringList headerParts;
+	if( strategy->showHeader( "to" ) )
+	    headerParts << KMMessage::emailAddrAsAnchor( message->to(), false, linkColor );
+
+	if ( strategy->showHeader( "cc" ) && !message->cc().isEmpty() )
+	    headerParts << i18n("CC: ") + KMMessage::emailAddrAsAnchor( message->cc(), true, linkColor );
+
+	if ( strategy->showHeader( "bcc" ) && !message->bcc().isEmpty() )
+	    headerParts << i18n("BCC: ") + KMMessage::emailAddrAsAnchor( message->bcc(), true, linkColor );
+
+	// remove all empty (modulo whitespace) entries and joins them via ", \n"
+	QString headerPart = " " + headerParts.grep( QRegExp( "\\S" ) ).join( ", " );
+
+	// Prepare the date string (when printing always use the localized date)
+	QString dateString;
+	if( printing ) {
+	    QDateTime dateTime;
+	    KLocale * locale = KGlobal::locale();
+	    dateTime.setTime_t( message->date() );
+	    dateString = locale->formatDateTime( dateTime );
+	} else {
+	    dateString = message->dateStr();
+	}
+
+	QString imgpath(locate("data","kmail/pics/"));
+	imgpath.append("enterprise_");
+	const QString borderSettings(" padding-top: 0px; padding-bottom: 0px; border-width: 0px ");
+	QString headerStr ("");
+
+	// 3D borders
+	if(topLevel)
+	    headerStr +=
+		"<div style=\"position: fixed; top: 0px; left: 0px; background-color: #606060; "
+		"background-image: url("+imgpath+"shadow_left.png); width: 10px; min-height: 100%;\">&nbsp;</div>"
+		"<div style=\"position: fixed; top: 0px; right: 0px;  background-color: #606060; "
+		"background-image: url("+imgpath+"shadow_right.png); width: 10px; min-height: 100%;\">&nbsp;</div>";
+
+	headerStr += ""
+	    "<div style=\"margin-left: 8px; top: 0px;\"><span style=\"font-size: 10px; font-weight: bold;\">"+dateString+"</span></div>"
+	    // #0057ae
+	    "<table style=\"background: "+activeColorDark.name()+"; border-collapse:collapse; top: 14px; min-width: 200px; \" cellpadding=0> \n"
+	    "  <tr> \n"
+	    "   <td style=\"min-width: 6px; background-image: url("+imgpath+"top_left.png); \"></td> \n"
+	    "   <td style=\"height: 6px; width: 100%; background: url("+imgpath+"top.png); \"></td> \n"
+	    "   <td style=\"min-width: 6px; background: url("+imgpath+"top_right.png); \"></td> </tr> \n"
+	    "   <tr> \n"
+	    "   <td style=\"min-width: 6px; max-width: 6px; background: url("+imgpath+"left.png); \"></td> \n"
+	    "   <td style=\"\"> \n"
+	    "    <table style=\"color: "+fontColor.name()+" ! important; margin: 1px; border-spacing: 0px;\" cellpadding=0> \n";
+
+	// subject
+	//strToHtml( message->subject() )
+	if ( strategy->showHeader( "subject" ) ){
+	    headerStr +=
+		"     <tr> \n"
+		"      <td style=\"font-size: 6px; text-align: right; padding-left: 5px; padding-right: 24px; "+borderSettings+"\"></td> \n"
+		"      <td style=\"font-weight: bolder; font-size: 120%;"+borderSettings+"\">"+message->subject()+"</td> \n"
+		"     </tr> \n";
+	}
+
+	// from
+	if ( strategy->showHeader( "from" ) ){
+	    QString fromStr = message->from();
+	    if ( fromStr.isEmpty() ) // no valid email in from, maybe just a name
+		fromStr = message->fromStrip(); // let's use that
+            // TODO vcard
+	    QString fromPart = KMMessage::emailAddrAsAnchor( fromStr, true, linkColor );
+	    if ( !vCardName.isEmpty() )
+		fromPart += "&nbsp;&nbsp;<a href=\"" + vCardName + "\" "+linkColor+">" + i18n("[vCard]") + "</a>";
+	    //TDDO strategy date
+	    //if ( strategy->showHeader( "date" ) )
+	    headerStr +=
+		"     <tr> \n"
+		"      <td style=\"font-size: 6px; padding-left: 5px; padding-right: 24px; text-align: right; "+borderSettings+"\">"+i18n("From: ")+"</td> \n"
+		"      <td style=\""+borderSettings+"\">"+ fromPart +"</td> "
+		"     </tr> ";
+	}
+
+	// to, cc, bcc
+	headerStr +=
+	    "     <tr> "
+	    "      <td style=\"font-size: 6px; text-align: right; padding-left: 5px; padding-right: 24px; "+borderSettings+"\">"+i18n("To: ")+"</td> "
+	    "      <td style=\""+borderSettings+"\">"
+	    +headerPart+
+	    "      </td> "
+	    "     </tr> ";
+
+	// header-bottom
+	headerStr +=
+	    "    </table> \n"
+	    "   </td> \n"
+	    "   <td style=\"min-width: 6px; max-height: 15px; background: url("+imgpath+"right.png); \"></td> \n"
+	    "  </tr> \n"
+	    "  <tr> \n"
+	    "   <td style=\"min-width: 6px; background: url("+imgpath+"s_left.png); \"></td> \n"
+	    "   <td style=\"height: 35px; width: 80%; background: url("+imgpath+"sbar.png);\"> \n"
+	    "    <img src=\""+imgpath+"sw.png\" style=\"margin: 0px; height: 30px; overflow:hidden; \"> \n"
+	    "    <img src=\""+imgpath+"sp_right.png\" style=\"float: right; \"> </td> \n"
+	    "   <td style=\"min-width: 6px; background: url("+imgpath+"s_right.png); \"></td> \n"
+	    "  </tr> \n"
+	    " </table> \n";
+
+    // kmail icon
+    if(topLevel) {
+        headerStr +=
+        "<div class=\"noprint\" style=\"position: absolute; top: -14px; left: 0px; width: 95%; height: 200px;\">\n"
+        "<img style=\"float: right;\" src=\""+imgpath+"icon.png\">\n"
+        "</div>\n";
+
+        // attachments
+        headerStr +=
+        "<div class=\"noprint\" style=\"position: fixed; top: 60px; right: 20px; width: 91px; height: 200px;\">"
+        "<div id=\"attachmentInjectionPoint\"></div>"
+        "</div>\n";
+    }
+
+	headerStr += "<div style=\"padding: 6px;\">";
+
+	// TODO
+	// spam status
+	// ### iterate over the rest of strategy->headerToDisplay() (or
+	// ### all headers if DefaultPolicy == Display) (elsewhere, too)
+	return headerStr;
+  }
+
+// #####################
+
   //
   // HeaderStyle abstract base:
   //
@@ -750,6 +933,7 @@
     case Brief:  return brief();
     case Plain:  return plain();
     case Fancy:   return fancy();
+    case Enterprise: return enterprise();
     }
     kdFatal( 5006 ) << "HeaderStyle::create(): Unknown header style ( type == "
                     << (int)type << " ) requested!" << endl;
@@ -760,6 +944,7 @@
     QString lowerType = type.lower();
     if ( lowerType == "brief" ) return brief();
     if ( lowerType == "plain" )  return plain();
+    if ( lowerType == "enterprise" )  return enterprise();
     //if ( lowerType == "fancy" ) return fancy(); // not needed, see below
     // don't kdFatal here, b/c the strings are user-provided
     // (KConfig), so fail gracefully to the default:
@@ -769,6 +954,7 @@
   static const HeaderStyle * briefStyle = 0;
   static const HeaderStyle * plainStyle = 0;
   static const HeaderStyle * fancyStyle = 0;
+  static const HeaderStyle * enterpriseStyle = 0;
 
   const HeaderStyle * HeaderStyle::brief() {
     if ( !briefStyle )
@@ -788,4 +974,10 @@
     return fancyStyle;
   }
 
+  const HeaderStyle * HeaderStyle::enterprise() {
+    if ( !enterpriseStyle )
+      enterpriseStyle = new EnterpriseHeaderStyle();
+    return enterpriseStyle;
+  }
+
 } // namespace KMail
Index: kmail/vacation.h
===================================================================
--- kmail/vacation.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/vacation.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -38,7 +38,7 @@
   class Vacation : public QObject {
     Q_OBJECT
   public:
-    Vacation( QObject * parent=0, const char * name=0 );
+    Vacation( QObject * parent=0, bool checkOnly = false, const char * name=0 );
     virtual ~Vacation();
 
     bool isUsable() const { return !mUrl.isEmpty(); }
@@ -46,19 +46,25 @@
     static QString defaultMessageText();
     static int defaultNotificationInterval();
     static QStringList defaultMailAliases();
+    static bool defaultSendForSpam();
+    static QString defaultDomainName();
 
   protected:
     static QString composeScript( const QString & messageText,
 				  int notificationInterval,
-				  const KMime::Types::AddrSpecList & aliases);
+				  const KMime::Types::AddrSpecList & aliases,
+                                  bool sendForSpam, const QString & excludeDomain );
     static bool parseScript( const QString & script, QString & messageText,
-			     int & notificationInterval, QStringList & aliases );
+			     int & notificationInterval, QStringList & aliases,
+                             bool & sendForSpam, QString & domainName );
     KURL findURL() const;
     void handlePutResult( KMail::SieveJob * job, bool success, bool );
 
 
   signals:
     void result( bool success );
+    // indicates if the vaction script is active or not
+    void scriptActive( bool active );
 
   protected slots:
     void slotDialogDefaults();
@@ -75,6 +81,7 @@
     // GUI:
     KMail::VacationDialog * mDialog;
     bool mWasActive;
+    bool mCheckOnly;
   };
 
 } // namespace KMail
Index: kmail/favoritefolderview.h
===================================================================
--- kmail/favoritefolderview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/favoritefolderview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,94 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KMAIL_FAVORITEFOLDERVIEW_H
+#define KMAIL_FAVORITEFOLDERVIEW_H
+
+#include "kmfoldertree.h"
+
+namespace KMail {
+
+class FavoriteFolderView;
+
+class FavoriteFolderViewItem : public KMFolderTreeItem
+{
+  Q_OBJECT
+  public:
+    FavoriteFolderViewItem( FavoriteFolderView *parent, const QString & name, KMFolder* folder );
+
+  protected:
+    bool useTopLevelIcon() const { return false; }
+    int iconSize() const { return 22; }
+
+  private slots:
+    void nameChanged();
+
+  private:
+    QString mOldName;
+};
+
+class FavoriteFolderView : public FolderTreeBase
+{
+  Q_OBJECT
+
+  public:
+    FavoriteFolderView( KMMainWidget *mainWidget, QWidget *parent = 0 );
+    ~FavoriteFolderView();
+
+    void readConfig();
+    void writeConfig();
+
+    KMFolderTreeItem* addFolder( KMFolder *folder, const QString &name = QString::null,
+                                 QListViewItem *after = 0 );
+
+  public slots:
+    void folderTreeSelectionChanged( KMFolder *folder );
+    void checkMail();
+
+  protected:
+    bool acceptDrag(QDropEvent* e) const;
+    void contentsDragEnterEvent( QDragEnterEvent *e );
+    void readColorConfig();
+
+  private:
+    static QString prettyName( KMFolderTreeItem* fti );
+    KMFolderTreeItem* findFolderTreeItem( KMFolder* folder ) const;
+    void handleGroupwareFolder( KMFolderTreeItem *fti );
+
+  private slots:
+    void selectionChanged();
+    void itemClicked( QListViewItem *item );
+    void folderRemoved( KMFolder *folder );
+    void dropped( QDropEvent *e, QListViewItem *after );
+    void contextMenu( QListViewItem *item, const QPoint &point );
+    void removeFolder();
+    void initializeFavorites();
+    void renameFolder();
+    void addFolder();
+    void notifyInstancesOnChange();
+    void refresh();
+
+  private:
+    KMFolderTreeItem* mContextMenuItem;
+    static QValueList<FavoriteFolderView*> mInstances;
+    bool mReadingConfig;
+};
+
+}
+
+#endif
Index: kmail/cachedimapjob.h
===================================================================
--- kmail/cachedimapjob.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/cachedimapjob.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -96,6 +96,10 @@
 
   void setParentFolder( const KMFolderCachedImap* parent );
 
+signals:
+  // only emitted for uid validity checking jobs with PERMANENTFLAGS responses
+  void permanentFlags( int flags );
+
 protected:
   virtual void execute();
   void expungeFolder();
Index: kmail/kmfilter.h
===================================================================
--- kmail/kmfilter.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfilter.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,9 +56,9 @@
   /** Account type codes used by setApplicability. They mean:
 
       @param All Apply to all accounts
-      
+
       @param ButImap Apply to all but online-IMAP accounts
-      
+
       @param Checked apply to all accounts specified by setApplyOnAccount
 
   */
@@ -88,7 +88,7 @@
       @li 0 if processed successfully.
       @param msg The message to which the actions should be applied.
       @param stopIt Contains
-      TRUE if the caller may apply other filters and FALSE if he shall
+      true if the caller may apply other filters and false if he shall
       stop the filtering of this message.
   */
   ReturnCode execActions( KMMessage* msg, bool& stopIt ) const ;
@@ -140,37 +140,37 @@
   const KMSearchPattern* pattern() const { return &mPattern; }
 
   /** Set whether this filter should be applied on
-      outbound messages (@p aApply == TRUE) or not.
+      outbound messages (@p aApply == true) or not.
       See applyOnOutbound applyOnInbound setApplyOnInbound
   */
-  void setApplyOnOutbound( bool aApply=TRUE ) { bApplyOnOutbound = aApply; }
+  void setApplyOnOutbound( bool aApply=true ) { bApplyOnOutbound = aApply; }
 
-  /** @return TRUE if this filter should be applied on
-      outbound messages, FALSE otherwise.
+  /** @return true if this filter should be applied on
+      outbound messages, false otherwise.
       @see setApplyOnOutbound applyOnInbound setApplyOnInbound
   */
   bool applyOnOutbound() const { return bApplyOnOutbound; }
 
   /** Set whether this filter should be applied on
-      inbound messages (@p aApply == TRUE) or not.
+      inbound messages (@p aApply == true) or not.
       @see setApplyOnOutbound applyOnInbound applyOnOutbound
   */
-  void setApplyOnInbound( bool aApply=TRUE ) { bApplyOnInbound = aApply; }
+  void setApplyOnInbound( bool aApply=true ) { bApplyOnInbound = aApply; }
 
-  /** @return TRUE if this filter should be applied on
-      inbound messages, FALSE otherwise.
+  /** @return true if this filter should be applied on
+      inbound messages, false otherwise.
       @see setApplyOnOutbound applyOnOutbound setApplyOnInbound
   */
   bool applyOnInbound() const { return bApplyOnInbound; }
 
   /** Set whether this filter should be applied on
-      explicit (CTRL-J) filtering (@p aApply == TRUE) or not.
+      explicit (CTRL-J) filtering (@p aApply == true) or not.
       @see setApplyOnOutbound applyOnInbound applyOnOutbound
   */
-  void setApplyOnExplicit( bool aApply=TRUE ) { bApplyOnExplicit = aApply; }
+  void setApplyOnExplicit( bool aApply=true ) { bApplyOnExplicit = aApply; }
 
-  /** @return TRUE if this filter should be applied on
-      explicit (CTRL-J) filtering, FALSE otherwise.
+  /** @return true if this filter should be applied on
+      explicit (CTRL-J) filtering, false otherwise.
       @see setApplyOnOutbound applyOnOutbound setApplyOnInbound
   */
   bool applyOnExplicit() const { return bApplyOnExplicit; }
@@ -184,8 +184,8 @@
   */
   void setApplicability( AccountType aApply=All ) { mApplicability = aApply; }
 
-  /** @return TRUE if this filter should be applied on
-      inbound messages for all accounts, or FALSE if this filter
+  /** @return true if this filter should be applied on
+      inbound messages for all accounts, or false if this filter
       is to be applied on a specified set of accounts only.
       Only applicable to filters that are applied on inbound messages.
       @see setApplicability
@@ -198,10 +198,10 @@
       set of accounts.
       @see setApplicability applyOnAccount
   */
-  void setApplyOnAccount( uint id, bool aApply=TRUE );
+  void setApplyOnAccount( uint id, bool aApply=true );
 
-  /** @return TRUE if this filter should be applied on
-      inbound messages from the account with id (@p id), FALSE otherwise.
+  /** @return true if this filter should be applied on
+      inbound messages from the account with id (@p id), false otherwise.
       @see setApplicability
   */
   bool applyOnAccount( uint id ) const;
@@ -216,8 +216,8 @@
     bConfigureToolbar = bConfigureToolbar && bConfigureShortcut;
   }
 
-  /** @return TRUE if this filter should be plugged into the filter menu,
-      FALSE otherwise.
+  /** @return true if this filter should be plugged into the filter menu,
+      false otherwise.
       @see setConfigureShortcut
   */
   bool configureShortcut() const { return bConfigureShortcut; }
@@ -230,8 +230,8 @@
     bConfigureToolbar = aTool && bConfigureShortcut;
   }
 
-  /** @return TRUE if this filter should be plugged into the toolbar,
-      FALSE otherwise.
+  /** @return true if this filter should be plugged into the toolbar,
+      false otherwise.
       @see setConfigureToolbar
   */
   bool configureToolbar() const { return bConfigureToolbar; }
@@ -262,8 +262,8 @@
    * Called from the filter manager when a folder is moved.
    * Tests if the folder aFolder is used in any action. Changes it
    * to aNewFolder folder in this case.
-   * @return TRUE if a change in some action occurred,
-   * FALSE if no action was affected.
+   * @return true if a change in some action occurred,
+   * false if no action was affected.
    */
   bool folderRemoved( KMFolder* aFolder, KMFolder* aNewFolder );
 
Index: kmail/kmail.kcfg
===================================================================
--- kmail/kmail.kcfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,7 +25,7 @@
           <choice name="SelectFirstUnreadNew"/>
           <choice name="SelectLastSelected"/>
         </choices>
-        <default>SelectFirstNew</default>
+        <default>SelectLastSelected</default>
       </entry>
       <entry name="NetworkState"  type="Enum">
         <choices>
@@ -69,6 +69,11 @@
       <entry name="AutoLostFoundMove" type="Bool">
         <label>Automatically move non-synced mails from folders with insufficient access rights</label>
         <whatsthis>If there are new messages in a folder, which have not been uploaded to the server yet, but you do not have sufficient access rights on the folder now to upload them, these messages will automatically be moved into a lost and found folder.</whatsthis>
+        <default>true</default>
+      </entry>
+
+      <entry name="AllowLocalFlags" type="Bool">
+        <label>Allow local flags in read-only folders</label>
         <default>false</default>
       </entry>
     </group>
@@ -87,16 +92,6 @@
         <default>inbox</default>
       </entry>
 
-      <entry name="QuotaUnit"  type="Enum">
-        <label></label>
-        <whatsthis></whatsthis>
-        <choices>
-          <choice name="KB"/>
-          <choice name="MB"/>
-          <choice name="GB"/>
-        </choices>
-        <default>MB</default>
-      </entry>
     </group>
 
     <group name="General">
@@ -116,6 +111,10 @@
         </choices>
         <default>ShowOnUnread</default>
       </entry>
+      <entry name="CloseDespiteSystemTray" type="Bool">
+          <label>Close the application when the mainwindow is closed, even if there is a system tray icon active.</label>
+        <default>false</default>
+      </entry>
       <entry name="VerboseNewMailNotification" type="Bool">
         <label>Verbose new mail notification</label>
         <whatsthis>If this option is enabled then for each folder the number of newly arrived messages is shown in the new mail notification; otherwise, you will only get a simple 'New mail arrived' message.</whatsthis>
@@ -140,6 +139,23 @@
       <entry name="FolderLoadingTimeout" type="Int" hidden="true">
          <default>1000</default>
       </entry>
+
+      <entry name="QuotaUnit"  type="Enum">
+        <label></label>
+        <whatsthis></whatsthis>
+        <choices>
+          <choice name="KB"/>
+          <choice name="MB"/>
+          <choice name="GB"/>
+        </choices>
+        <default>MB</default>
+      </entry>
+
+      <entry name="CloseToQuotaThreshold" type="Int">
+        <label>The threshold for when to warn the user that a folder is nearing its quota limit.</label>
+         <default>85</default>
+      </entry>
+
     </group>
 <!-- General -->
 
@@ -173,8 +189,27 @@
         <whatsthis>When this is checked, you will not see the mail composer window. Instead, all invitation mails are sent automatically. If you want to see the mail before sending it, you can uncheck this option. However, be aware that the text in the composer window is in iCalendar syntax, and you should not try modifying it by hand.</whatsthis>
         <default>true</default>
       </entry>
-    </group>
 
+      <entry name="AskForCommentWhenReactingToInvitation"  type="Enum">
+        <label></label>
+        <whatsthis></whatsthis>
+        <choices>
+          <choice name="NeverAsk"/>
+          <choice name="AskForAllButAcceptance"/>
+          <choice name="AlwaysAsk"/>
+        </choices>
+        <default>AskForAllButAcceptance</default>
+      </entry>
+      
+      <entry name="DeleteInvitationEmailsAfterSendingReply" type="Bool">
+        <label>Delete invitation emails after the reply to them has been sent</label>
+        <whatsthis>When this is checked, received invitation emails that have been replied to will be moved to the Trash folder, once the reply has been successfully sent.</whatsthis>
+        <default>true</default>
+      </entry>
+      
+
+    </group> 
+
     <group name="IMAP Resource">
       <entry name="TheIMAPResourceEnabled" type="Bool">
         <whatsthis>&lt;p&gt;Enabling this makes it possible to store the entries from the Kontact applications (KOrganizer, KAddressBook, and KNotes.)&lt;/p&gt;&lt;p&gt;If you want to set this option you must also set the applications to use the IMAP resource; this is done in the KDE Control Center.&lt;/p&gt;</whatsthis>
@@ -217,6 +252,20 @@
         <whatsthis>&lt;p&gt;If you want to set the folder names of the IMAP storage to your local language, you can choose between these available languages.&lt;/p&gt;&lt;p&gt; Please note, that the only reason to do so is for compatibility with Microsoft Outlook. It is considered a bad idea to set this, since it makes changing languages impossible. &lt;/p&gt;&lt;p&gt;So do not set this unless you have to.&lt;/p&gt;</whatsthis>
         <default>0</default>
       </entry>
+
+      <entry name="FilterOnlyDIMAPInbox" type="Bool">
+        <default>true</default>
+        <label>Only filter mails received in disconnected IMAP inbox.</label>
+      </entry>
+      <entry name="FilterGroupwareFolders" type="Bool">
+        <default>false</default>
+        <label>Also filter new mails received in groupware folders.</label>
+      </entry>
+
+      <entry name="ImmediatlySyncDIMAPOnGroupwareChanges" type="Bool">
+        <default>true</default>
+        <label>Synchronize groupware changes in DIMAP folders immediately when being online.</label>
+      </entry>
     </group>
 
     <group name="Internal">
@@ -244,16 +293,27 @@
         <whatsthis>This option enables or disables the search line edit above the message list which can be used to quickly search the information shown in the message list.</whatsthis>
         <default>true</default>
       </entry>
-
+      <entry name="HideLocalInbox" type="Bool">
+        <label>Hide local inbox if unused</label>
+        <default>true</default>
+      </entry>
     </group>
 
     <group name="Composer">
+      <entry name="ForwardingInlineByDefault" type="Bool">
+        <default>false</default>
+        <label>Forward Inline As Default.</label>
+      </entry>
+      <entry name="AllowSemicolonAsAddressSeparator" type="Bool">
+          <default>true</default>
+          <label>Allow the semicolon charactor (';') to be used as separator in the message composer.</label>
+      </entry>
       <entry name="ForceReplyCharset" type="Bool" key="force-reply-charset">
         <label>Keep original charset when replying or forwarding if possible</label>
         <default>false</default>
       </entry>
       <entry name="AutoTextSignature" type="String" key="signature">
-        <label>A&amp;utomatically append signature</label>
+        <label>A&amp;utomatically insert signature</label>
         <default>auto</default>
       </entry>
       <entry name="StickyIdentity" type="Bool" key="sticky-identity">
@@ -281,7 +341,7 @@
         <label></label>
         <default>78</default>
         <min>30</min>
-        <max>78</max>
+        <max>255</max>
       </entry>
       <entry name="PreviousIdentity" type="UInt" key="previous-identity" />
       <entry name="PreviousFcc" type="String" key="previous-fcc" />
@@ -350,6 +410,10 @@
         <whatsthis>A backup copy of the text in the composer window can be created regularly. The interval used to create the backups is set here. You can disable autosaving by setting it to the value 0.</whatsthis>
         <default>2</default>
       </entry>
+      <entry name="PrependSignature" type="Bool" key="prepend-signature">
+        <label>Insert signatures above quoted text</label>
+        <default>false</default>
+      </entry>
       <entry name="ReplyPrefixes" type="StringList" key="reply-prefixes">
         <default>Re\\s*:,Re\\[\\d+\\]:,Re\\d+:</default>
       </entry>
@@ -401,6 +465,28 @@
         <default>200</default>
       </entry>
       <entry name="CustomTemplates" type="StringList" key="CustomTemplates" />
+
+      <entry name="MimetypesToStripWhenInlineForwarding" type="StringList">
+          <label>List of message part types to strip off mails that are being forwarded inline.</label>
+      </entry>
+
+      <entry name="MaximumAttachmentSize" type="Int">
+          <label>The maximum size in MB that email attachments are allowed to have.</label>
+          <default>50</default>
+      </entry>
+
+      <entry name="ShowSnippetManager" type="Bool">
+          <label>Show the Text Snippet Management and Insertion Panel in the composer.</label>
+          <default>false</default>
+      </entry>
+
+      <entry name="SnippetSplitterPosition" type="IntList"/>
+
+      <entry name="ShowGnuPGAuditLogAfterSuccessfulSignEncrypt" type="Bool">
+          <label>Show the GnuPG Audit Log even after crypto operations that completed successfully.</label>
+          <default>false</default>
+      </entry>
+
     </group>
 <!-- Composer -->
 
@@ -481,6 +567,19 @@
        <whatsthis>Enable this option to get the User-Agent and X-Mailer header lines displayed when using fancy headers.</whatsthis>
      </entry>
 
+     <entry name="AllowAttachmentDeletion" type="Bool">
+       <default>true</default>
+       <label>Allow to delete attachments of existing mails.</label>
+     </entry>
+     <entry name="AllowAttachmentEditing" type="Bool">
+       <default>false</default>
+       <label>Allow to edit attachments of existing mails.</label>
+     </entry>
+
+     <entry name="AlwaysDecrypt" type="Bool">
+      <default>false</default>
+      <label>Always decrypt messages when viewing or ask befor decrypting</label>
+     </entry>
     </group>
 
     <group name="TextIndex">
@@ -531,4 +630,37 @@
     </entry>
   </group>
 
+    <group name="OutOfOffice">
+        <entry name="AllowOutOfOfficeSettings" type="Bool">
+            <default>true</default>
+            <label>Allow out-of-office settings to to be changeable by the user.</label>
+        </entry>
+        <entry name="AllowOutOfOfficeUploadButNoSettings" type="Bool">
+            <default>false</default>
+            <label>Allow users to upload out-of-office sieve scripts, but disallow them changin any settings, such as the domain to react to and the spam reaction switch.</label>
+        </entry>
+        <entry name="OutOfOfficeDomain" type="String">
+            <default></default>
+            <label>Send out-of-office replies to mails coming from this domain only.</label>
+        </entry>
+        <entry name="OutOfOfficeReactToSpam" type="Bool">
+            <default>false</default>
+            <label>Allow out-of-office replies to be sent to messages marked as SPAM.</label>
+        </entry>
+        <entry name="CheckOutOfOfficeOnStartup" type="Bool">
+              <default>true</default>
+              <label>Check if there is still an active out-of-office reply configured when starting KMail.</label>
+        </entry>
+    </group>
+
+  <group name="FavoriteFolderView">
+    <entry name="EnableFavoriteFolderView" type="Bool">
+      <default>true</default>
+    </entry>
+    <entry name="FolderViewSplitterPosition" type="IntList"/>
+    <entry name="FavoriteFolderIds" type="IntList"/>
+    <entry name="FavoriteFolderNames" type="StringList"/>
+    <entry name="FavoriteFolderViewSeenInboxes" type="IntList"/>
+  </group>
+
 </kcfg>
Index: kmail/snippetdlgbase.ui
===================================================================
--- kmail/snippetdlgbase.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetdlgbase.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,183 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>SnippetDlgBase</class>
+<widget class="QDialog">
+    <property name="name">
+        <cstring>SnippetDlgBase</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>344</width>
+            <height>289</height>
+        </rect>
+    </property>
+    <property name="caption">
+        <string>Add Snippet</string>
+    </property>
+    <grid>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="QLayoutWidget" row="1" column="0">
+            <property name="name">
+                <cstring>layout5</cstring>
+            </property>
+            <hbox>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <spacer>
+                    <property name="name">
+                        <cstring>spacer1</cstring>
+                    </property>
+                    <property name="orientation">
+                        <enum>Horizontal</enum>
+                    </property>
+                    <property name="sizeType">
+                        <enum>Expanding</enum>
+                    </property>
+                    <property name="sizeHint">
+                        <size>
+                            <width>40</width>
+                            <height>20</height>
+                        </size>
+                    </property>
+                </spacer>
+                <widget class="KPushButton">
+                    <property name="name">
+                        <cstring>btnAdd</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Add</string>
+                    </property>
+                    <property name="accel">
+                        <string>Alt+A</string>
+                    </property>
+                </widget>
+                <widget class="KPushButton">
+                    <property name="name">
+                        <cstring>btnCancel</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Cancel</string>
+                    </property>
+                    <property name="accel">
+                        <string>Alt+C</string>
+                    </property>
+                </widget>
+            </hbox>
+        </widget>
+        <widget class="QLayoutWidget" row="0" column="0">
+            <property name="name">
+                <cstring>layout3</cstring>
+            </property>
+            <grid>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="KLineEdit" row="0" column="1">
+                    <property name="name">
+                        <cstring>snippetName</cstring>
+                    </property>
+                </widget>
+                <spacer row="4" column="0">
+                    <property name="name">
+                        <cstring>spacer2</cstring>
+                    </property>
+                    <property name="orientation">
+                        <enum>Vertical</enum>
+                    </property>
+                    <property name="sizeType">
+                        <enum>Expanding</enum>
+                    </property>
+                    <property name="sizeHint">
+                        <size>
+                            <width>20</width>
+                            <height>80</height>
+                        </size>
+                    </property>
+                </spacer>
+                <widget class="QLabel" row="0" column="0">
+                    <property name="name">
+                        <cstring>textLabel1</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Name:</string>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>snippetName</cstring>
+                    </property>
+                </widget>
+                <widget class="QLabel" row="2" column="0">
+                    <property name="name">
+                        <cstring>textLabel2</cstring>
+                    </property>
+                    <property name="text">
+                        <string>&amp;Snippet:</string>
+                    </property>
+                    <property name="alignment">
+                        <set>AlignTop</set>
+                    </property>
+                    <property name="buddy" stdset="0">
+                        <cstring>snippetText</cstring>
+                    </property>
+                </widget>
+                <widget class="QLabel" row="1" column="0">
+                    <property name="name">
+                        <cstring>textLabelGroup</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Group:</string>
+                    </property>
+                </widget>
+                <widget class="KComboBox" row="1" column="1">
+                    <property name="name">
+                        <cstring>cbGroup</cstring>
+                    </property>
+                </widget>
+                <widget class="KTextEdit" row="2" column="1" rowspan="3" colspan="1">
+                    <property name="name">
+                        <cstring>snippetText</cstring>
+                    </property>
+                    <property name="font">
+                        <font>
+                            <family>Courier</family>
+                            <pointsize>11</pointsize>
+                        </font>
+                    </property>
+                </widget>
+            </grid>
+        </widget>
+    </grid>
+</widget>
+<connections>
+    <connection>
+        <sender>btnAdd</sender>
+        <signal>clicked()</signal>
+        <receiver>SnippetDlgBase</receiver>
+        <slot>accept()</slot>
+    </connection>
+    <connection>
+        <sender>btnCancel</sender>
+        <signal>clicked()</signal>
+        <receiver>SnippetDlgBase</receiver>
+        <slot>reject()</slot>
+    </connection>
+</connections>
+<tabstops>
+    <tabstop>snippetName</tabstop>
+    <tabstop>cbGroup</tabstop>
+    <tabstop>snippetText</tabstop>
+    <tabstop>btnAdd</tabstop>
+    <tabstop>btnCancel</tabstop>
+</tabstops>
+<layoutdefaults spacing="6" margin="11"/>
+<includehints>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>klineedit.h</includehint>
+    <includehint>kcombobox.h</includehint>
+    <includehint>ktextedit.h</includehint>
+</includehints>
+</UI>
Index: kmail/callback.h
===================================================================
--- kmail/callback.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/callback.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -40,6 +40,10 @@
 
 #include <kdepimmacros.h>
 
+
+#include <libkcal/attendee.h> // only for an enum, we are not linking
+
+
 namespace KMail {
 
 /** This class is used for callback hooks needed by bodypart
@@ -56,10 +60,11 @@
   KMMessage* getMsg() const { return mMsg; }
 
   /** Mail a message
-   * @ param status can be accepted/cancel/tentative
+   * @ param status can be accepted/cancel/tentative/delegated
    */
-  bool mailICal( const QString& to, const QString iCal,
-                 const QString& subject, const QString &status ) const;
+  bool mailICal( const QString &to, const QString &iCal,
+                 const QString &subject, const QString &status,
+                 bool delMessage = true ) const;
 
   /** Get the receiver of the mail */
   QString receiver() const;
@@ -67,6 +72,9 @@
   /** Close the main window showing this message, if it's a secondary window. */
   void closeIfSecondaryWindow() const;
 
+  bool askForComment( KCal::Attendee::PartStat status ) const;
+  bool deleteInvitationAfterReply() const;
+
 private:
   KMMessage* mMsg;
   KMReaderWin* mReaderWin;
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,7 +41,7 @@
 
 #include "kmfoldermaildir.h"
 #include "kmfolderimap.h"
-#include "kmacctimap.h"
+#include "kmacctcachedimap.h"
 #include "kmfoldertype.h"
 #include "folderjob.h"
 #include "cachedimapjob.h"
@@ -49,7 +49,7 @@
 
 using KMail::FolderJob;
 using KMail::QuotaInfo;
-class KMAcctCachedImap;
+class KMCommand;
 
 class QComboBox;
 class QRadioButton;
@@ -102,7 +102,7 @@
   virtual ~KMFolderCachedImap();
 
   /**  @reimpl */
-  void reallyDoClose( const char * owner );
+  void reallyDoClose(const char* owner);
 
   /** Initialize this storage from another one. Used when creating a child folder */
   void initializeFrom( KMFolderCachedImap* parent );
@@ -117,16 +117,23 @@
 
   /** @reimpl */
   virtual int create();
-  
+
   /** Remove this folder */
   virtual void remove();
 
   /** Synchronize this folder and it's subfolders with the server */
   virtual void serverSync( bool recurse );
 
-  /** Force the sync state to be done. */
-  void resetSyncState();
+  /**  Force the sync state to be done. */
+  void resetSyncState( );
 
+  /** Block this folder from generating alarms, even if the annotations
+   * on it say otherwise. Used to override alarms for read-only folders.
+   * (Only useful for resource folders) */
+  void setAlarmsBlocked( bool blocked );
+  /** Should alarms for this folder be blocked?  (Only useful for resource folders) */
+  bool alarmsBlocked() const;
+
   void checkUidValidity();
 
   enum imapState { imapNoInformation=0, imapInProgress=1, imapFinished=2 };
@@ -186,13 +193,14 @@
   }
 
   /* Reimplemented from KMFolderMaildir */
-  virtual void removeMsg(int i, bool imapQuiet = FALSE);
-  virtual void removeMsg(QPtrList<KMMessage> msgList, bool imapQuiet = FALSE)
+  virtual void removeMsg(int i, bool imapQuiet = false);
+  virtual void removeMsg(QPtrList<KMMessage> msgList, bool imapQuiet = false)
     { FolderStorage::removeMsg(msgList, imapQuiet); }
 
   /// Is the folder readonly?
   bool isReadOnly() const { return KMFolderMaildir::isReadOnly() || mReadOnly; }
 
+
   /**
    * Emit the folderComplete signal
    */
@@ -243,6 +251,7 @@
    * @see QuotaInfo::isEmpty(), QuotaInfo::isValid()
    */
   const QuotaInfo quotaInfo() const { return mQuotaInfo; }
+  void setQuotaInfo( const QuotaInfo & );
 
   /// Return the list of ACL for this folder
   typedef QValueVector<KMail::ACLListEntry> ACLList;
@@ -277,7 +286,7 @@
   /** Returns true if this folder can be moved */
   virtual bool isMoveable() const;
 
-  /** 
+  /**
    * List of namespaces that need to be queried
    * Is set by the account for the root folder when the listing starts
    */
@@ -291,6 +300,15 @@
   const QString& imapPathForCreation() { return mImapPathCreation; }
   void setImapPathForCreation( const QString& path ) { mImapPathCreation = path; }
 
+  /**  \reimp */
+  bool isCloseToQuota() const;
+
+  /** Flags that can be permanently stored on the server. */
+  int permanentFlags() const { return mPermanentFlags; }
+
+
+  QString folderAttributes() const { return mFolderAttributes; }
+
 protected slots:
   void slotGetMessagesData(KIO::Job * job, const QByteArray & data);
   void getMessagesResult(KMail::FolderJob *, bool lastSet);
@@ -305,6 +323,7 @@
   void slotConnectionResult( int errorCode, const QString& errorMsg );
 
   void slotCheckUidValidityResult( KMail::FolderJob* job );
+  void slotPermanentFlags( int flags );
   void slotTestAnnotationResult(KIO::Job *job);
   void slotGetAnnotationResult( KIO::Job* );
   void slotMultiUrlGetAnnotationResult( KIO::Job* );
@@ -357,8 +376,10 @@
   void newState( int progress, const QString& syncStatus );
 
   /** See if there is a better parent then this folder */
-  KMFolderCachedImap* findParent( const QString& path, const QString& name );  
+  KMFolderCachedImap* findParent( const QString& path, const QString& name );
 
+
+
 public slots:
   /**
    * Add the data a KIO::Job retrieves to the buffer
@@ -389,6 +410,7 @@
   void slotIncreaseProgress();
   void slotUpdateLastUid();
   void slotFolderDeletionOnServerFinished();
+  void slotRescueDone( KMCommand* command );
 
 signals:
   void folderComplete(KMFolderCachedImap *folder, bool success);
@@ -403,6 +425,13 @@
   void setReadOnly( bool readOnly );
   QString state2String( int state ) const;
   void rememberDeletion( int );
+  /** Rescue not yet synced messages to a lost+found folder in case
+    syncing is not possible because the folder has been deleted on the
+    server or write access to this folder has been revoked.
+  */
+  KMCommand* rescueUnsyncedMessages();
+  /** Recursive helper function calling the above method. */
+  void rescueUnsyncedMessagesAndDeleteFolder( KMFolder *folder, bool root = true );
 
   /** State variable for the synchronization mechanism */
   enum {
@@ -440,6 +469,7 @@
   imapState   mContentState, mSubfolderState;
   QStringList mSubfolderNames, mSubfolderPaths,
               mSubfolderMimeTypes, mSubfolderAttributes;
+  QString     mFolderAttributes;
   QString     mAnnotationFolderType;
   IncidencesFor mIncidencesFor;
 
@@ -508,9 +538,15 @@
   int mNamespacesToCheck;
   bool mPersonalNamespacesCheckDone;
   QString mImapPathCreation;
+
+  QuotaInfo mQuotaInfo;
   QMap<ulong,void*> mDeletedUIDsSinceLastSync;
+  bool mAlarmsBlocked;
 
-  QuotaInfo mQuotaInfo;
+  QValueList<KMFolder*> mToBeDeletedAfterRescue;
+  int mRescueCommandCount;
+
+  int mPermanentFlags;
 };
 
 #endif /*kmfoldercachedimap_h*/
Index: kmail/snippetconfig.cpp
===================================================================
--- kmail/snippetconfig.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetconfig.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,20 @@
+/*
+ *  File : snippetconfig.cpp
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#include "snippetconfig.h"
+
+SnippetConfig::SnippetConfig()
+{
+}
+
+
+SnippetConfig::~SnippetConfig()
+{
+}
+
+
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -18,6 +18,7 @@
 #include <qhbox.h>
 #include <qvbox.h>
 #include <qpopupmenu.h>
+#include <qptrlist.h>
 
 #include <kopenwith.h>
 
@@ -75,6 +76,7 @@
 using KMail::ImapAccountBase;
 #include "vacation.h"
 using KMail::Vacation;
+#include "favoritefolderview.h"
 
 #include <qsignalmapper.h>
 
@@ -139,14 +141,20 @@
                            KXMLGUIClient *aGUIClient,
                            KActionCollection *actionCollection, KConfig* config ) :
     QWidget(parent, name),
+    mFavoritesCheckMailAction( 0 ),
+    mFavoriteFolderView( 0 ),
+    mFolderView( 0 ),
+    mFolderViewParent( 0 ),
+    mFolderViewSplitter( 0 ),
     mQuickSearchLine( 0 ),
     mShowBusySplashTimer( 0 ),
-    mShowingOfflineScreen( false )
+    mShowingOfflineScreen( false ),
+    mVacationIndicatorActive( false )
 {
   // must be the first line of the constructor:
-  mStartupDone = FALSE;
+  mStartupDone = false;
   mSearchWin = 0;
-  mIntegrated  = TRUE;
+  mIntegrated  = true;
   mFolder = 0;
   mTemplateFolder = 0;
   mFolderThreadPref = false;
@@ -166,7 +174,6 @@
   mJob = 0;
   mConfig = config;
   mGUIClient = aGUIClient;
-  mOpenedImapFolder = false;
 
   mCustomReplyActionMenu = 0;
   mCustomReplyAllActionMenu = 0;
@@ -234,7 +241,16 @@
   toggleSystemTray();
 
   // must be the last line of the constructor:
-  mStartupDone = TRUE;
+  mStartupDone = true;
+
+
+  KMainWindow *mainWin = dynamic_cast<KMainWindow*>(topLevelWidget());
+  KStatusBar *sb =  mainWin ? mainWin->statusBar() : 0;
+  mVacationScriptIndicator = new KStatusBarLabel( QString(), 0, sb );
+  mVacationScriptIndicator->hide();
+  connect( mVacationScriptIndicator, SIGNAL(itemReleased(int)), SLOT(slotEditVacation()) );
+  if ( GlobalSettings::checkOutOfOfficeOnStartup() )
+    QTimer::singleShot( 0, this, SLOT(slotCheckVacation()) );
 }
 
 
@@ -279,6 +295,7 @@
 
   mHtmlPref = reader.readBoolEntry( "htmlMail", false );
   mHtmlLoadExtPref = reader.readBoolEntry( "htmlLoadExternal", false );
+  mEnableFavoriteFolderView = GlobalSettings::self()->enableFavoriteFolderView();
 }
 
 
@@ -320,6 +337,7 @@
   bool oldLongFolderList =  mLongFolderList;
   bool oldReaderWindowActive = mReaderWindowActive;
   bool oldReaderWindowBelow = mReaderWindowBelow;
+  bool oldFavoriteFolderView = mEnableFavoriteFolderView;
 
   QString str;
   QSize siz;
@@ -333,7 +351,8 @@
 
     bool layoutChanged = ( oldLongFolderList != mLongFolderList )
                     || ( oldReaderWindowActive != mReaderWindowActive )
-                    || ( oldReaderWindowBelow != mReaderWindowBelow );
+                    || ( oldReaderWindowBelow != mReaderWindowBelow )
+                    || ( oldFavoriteFolderView != mEnableFavoriteFolderView );
 
 
     if( layoutChanged ) {
@@ -381,20 +400,37 @@
 
       const int unreadColumn = config->readNumEntry("UnreadColumn", 1);
       const int totalColumn = config->readNumEntry("TotalColumn", 2);
+      const int sizeColumn = config->readNumEntry("SizeColumn", 3);
 
       /* we need to _activate_ them in the correct order
       * this is ugly because we can't use header()->moveSection
       * but otherwise the restoreLayout from KMFolderTree
       * doesn't know that to do */
-      if (unreadColumn != -1 && unreadColumn < totalColumn)
+      if (unreadColumn == 1)
         mFolderTree->addUnreadColumn( i18n("Unread"), 70 );
-      if (totalColumn != -1)
+      else if (totalColumn == 1)
         mFolderTree->addTotalColumn( i18n("Total"), 70 );
-      if (unreadColumn != -1 && unreadColumn > totalColumn)
+      else if (sizeColumn == 1)
+        mFolderTree->addSizeColumn( i18n("Size"), 70 );
+
+      if (unreadColumn == 2)
         mFolderTree->addUnreadColumn( i18n("Unread"), 70 );
+      else if (totalColumn == 2)
+        mFolderTree->addTotalColumn( i18n("Total"), 70 );
+      else if (sizeColumn == 2)
+        mFolderTree->addSizeColumn( i18n("Size"), 70 );
+
+      if (unreadColumn == 3)
+        mFolderTree->addUnreadColumn( i18n("Unread"), 70 );
+      else if (totalColumn == 3)
+        mFolderTree->addTotalColumn( i18n("Total"), 70 );
+      else if (sizeColumn == 3)
+        mFolderTree->addSizeColumn( i18n("Size"), 70 );
+
       mUnreadColumnToggle->setChecked( mFolderTree->isUnreadActive() );
       mUnreadTextToggle->setChecked( !mFolderTree->isUnreadActive() );
       mTotalColumnToggle->setChecked( mFolderTree->isTotalActive() );
+      mSizeColumnToggle->setChecked( mFolderTree->isSizeActive() );
 
       mFolderTree->updatePopup();
     }
@@ -406,7 +442,18 @@
   mHeaders->readConfig();
   mHeaders->restoreLayout(KMKernel::config(), "Header-Geometry");
 
+  if ( mFolderViewSplitter && !GlobalSettings::self()->folderViewSplitterPosition().isEmpty() ) {
+    mFolderViewSplitter->setSizes( GlobalSettings::self()->folderViewSplitterPosition() );
+  } else {
+    QValueList<int> defaults;
+    defaults << (int)(height() * 0.2) << (int)(height() * 0.8);
+    mFolderViewSplitter->setSizes( defaults );
+  }
+
   mFolderTree->readConfig();
+  if ( mFavoriteFolderView )
+    mFavoriteFolderView->readConfig();
+  mFavoritesCheckMailAction->setEnabled( GlobalSettings::self()->enableFavoriteFolderView() );
 
   { // area for config group "General"
     KConfigGroupSaver saver(config, "General");
@@ -435,7 +482,8 @@
 
     bool layoutChanged = ( oldLongFolderList != mLongFolderList )
                     || ( oldReaderWindowActive != mReaderWindowActive )
-                    || ( oldReaderWindowBelow != mReaderWindowBelow );
+                    || ( oldReaderWindowBelow != mReaderWindowBelow )
+                    || ( oldFavoriteFolderView != mEnableFavoriteFolderView );
     if ( layoutChanged ) {
       activatePanners();
     }
@@ -471,7 +519,11 @@
   if (mMsgView)
     mMsgView->writeConfig();
 
+  if ( mFolderViewSplitter )
+    GlobalSettings::setFolderViewSplitterPosition( mFolderViewSplitter->sizes() );
   mFolderTree->writeConfig();
+  if ( mFavoriteFolderView )
+    mFavoriteFolderView->writeConfig();
 
   geometry.writeEntry( "MainWin", this->geometry().size() );
 
@@ -490,6 +542,7 @@
   // save the state of the unread/total-columns
   geometry.writeEntry( "UnreadColumn", mFolderTree->unreadIndex() );
   geometry.writeEntry( "TotalColumn", mFolderTree->totalIndex() );
+  geometry.writeEntry( "SizeColumn", mFolderTree->sizeIndex() );
 }
 
 
@@ -497,7 +550,7 @@
 void KMMainWidget::createWidgets(void)
 {
   // Create the splitters according to the layout settings
-  QWidget *headerParent = 0, *folderParent = 0,
+  QWidget *headerParent = 0,
             *mimeParent = 0, *messageParent = 0;
 
   const bool opaqueResize = KGlobalSettings::opaqueResize();
@@ -509,16 +562,18 @@
     Qt::Orientation orientation = mReaderWindowBelow ? Qt::Vertical : Qt::Horizontal;
     mPanner2 = new QSplitter( orientation, mPanner1, "panner 2" );
     mPanner2->setOpaqueResize( opaqueResize );
-    folderParent = mPanner1;
+    mPanner2->setChildrenCollapsible( false );
+    mFolderViewParent = mPanner1;
     headerParent = mimeParent = messageParent = mPanner2;
   } else /* !mLongFolderList */ {
     // superior splitter: ( folder tree + headers ) vs. message vs. mime
     // inferior splitter: folder tree vs. headers
     mPanner1 = new QSplitter( Qt::Vertical, this, "panner 1" );
     mPanner1->setOpaqueResize( opaqueResize );
+    mPanner1->setChildrenCollapsible( false );
     mPanner2 = new QSplitter( Qt::Horizontal, mPanner1, "panner 2" );
     mPanner2->setOpaqueResize( opaqueResize );
-    headerParent = folderParent = mPanner2;
+    headerParent = mFolderViewParent = mPanner2;
     mimeParent = messageParent = mPanner1;
   }
 
@@ -553,6 +608,8 @@
 						actionCollection(), "headers quick search line" );
 #endif
   label->setBuddy( mQuickSearchLine );
+  connect( mQuickSearchLine, SIGNAL( requestFullSearch() ),
+           this, SLOT( slotRequestFullSearchFromQuickSearch() ) );
   mSearchToolBar->setStretchableWidget( mQuickSearchLine );
     connect( mHeaders, SIGNAL( messageListUpdated() ),
            mQuickSearchLine, SLOT( updateSearch() ) );
@@ -615,7 +672,22 @@
   action->plugAccel( actionCollection()->kaccel() );
 
   // create list of folders
-  mFolderTree = new KMFolderTree(this, folderParent, "folderTree");
+  mFolderViewSplitter = new QSplitter( Qt::Vertical, mFolderViewParent );
+  mFolderViewSplitter->setOpaqueResize( KGlobalSettings::opaqueResize() );
+  mFavoriteFolderView = new KMail::FavoriteFolderView( this, mFolderViewSplitter );
+  if ( mFavoritesCheckMailAction )
+  connect( mFavoritesCheckMailAction, SIGNAL(activated()), mFavoriteFolderView, SLOT(checkMail()) );
+  QWidget *folderTreeParent = mFolderViewParent;
+  if ( GlobalSettings::enableFavoriteFolderView() ) {
+    folderTreeParent = mFolderViewSplitter;
+    mFolderView = mFolderViewSplitter;
+  }
+  mFolderTree = new KMFolderTree(this, folderTreeParent, "folderTree");
+  if ( !GlobalSettings::enableFavoriteFolderView() ) {
+     mFolderView = mFolderTree;
+  }
+  connect( mFolderTree, SIGNAL(folderSelected(KMFolder*)),
+            mFavoriteFolderView, SLOT(folderTreeSelectionChanged(KMFolder*)) );
 
   connect(mFolderTree, SIGNAL(folderSelected(KMFolder*)),
 	  this, SLOT(folderSelected(KMFolder*)));
@@ -630,6 +702,11 @@
   connect(mFolderTree, SIGNAL(columnsChanged()),
           this, SLOT(slotFolderTreeColumnsChanged()));
 
+  if ( mFavoriteFolderView ) {
+    connect( mFavoriteFolderView, SIGNAL(folderDrop(KMFolder*)), SLOT(slotMoveMsgToFolder(KMFolder*)) );
+    connect( mFavoriteFolderView, SIGNAL(folderDropCopy(KMFolder*)), SLOT(slotCopyMsgToFolder(KMFolder*)) );
+  }
+
   //Commands not worthy of menu items, but that deserve configurable keybindings
   mRemoveDuplicatesAction = new KAction(
     i18n("Remove Duplicate Messages"), CTRL+Key_Asterisk, this,
@@ -686,20 +763,24 @@
         SIGNAL( activated() ),
         mMsgView, SLOT( slotCopySelectedText() ));
   }
+
+  setupFolderView();
   if ( mLongFolderList ) {
     mSearchAndHeaders->reparent( mPanner2, 0, QPoint( 0, 0 ) );
     if (mMsgView) {
       mMsgView->reparent( mPanner2, 0, QPoint( 0, 0 ) );
       mPanner2->moveToLast( mMsgView );
     }
-    mFolderTree->reparent( mPanner1, 0, QPoint( 0, 0 ) );
+    mFolderViewParent = mPanner1;
+    mFolderView->reparent( mFolderViewParent, 0, QPoint( 0, 0 ) );
     mPanner1->moveToLast( mPanner2 );
     mPanner1->setSizes( mPanner1Sep );
-    mPanner1->setResizeMode( mFolderTree, QSplitter::KeepSize );
+    mPanner1->setResizeMode( mFolderView, QSplitter::KeepSize );
     mPanner2->setSizes( mPanner2Sep );
     mPanner2->setResizeMode( mSearchAndHeaders, QSplitter::KeepSize );
   } else /* !mLongFolderList */ {
-    mFolderTree->reparent( mPanner2, 0, QPoint( 0, 0 ) );
+    mFolderViewParent = mPanner2;
+    mFolderView->reparent( mFolderViewParent, 0, QPoint( 0, 0 ) );
     mSearchAndHeaders->reparent( mPanner2, 0, QPoint( 0, 0 ) );
     mPanner2->moveToLast( mSearchAndHeaders );
     mPanner1->moveToFirst( mPanner2 );
@@ -710,7 +791,7 @@
     mPanner1->setSizes( mPanner1Sep );
     mPanner2->setSizes( mPanner2Sep );
     mPanner1->setResizeMode( mPanner2, QSplitter::KeepSize );
-    mPanner2->setResizeMode( mFolderTree, QSplitter::KeepSize );
+    mPanner2->setResizeMode( mFolderView, QSplitter::KeepSize );
   }
 
   if (mMsgView) {
@@ -1399,13 +1480,6 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMMainWidget::slotEditMsg()
-{
-  KMCommand *command = new KMEditMsgCommand( this, mHeaders->currentMsg() );
-  command->start();
-}
-
-//-----------------------------------------------------------------------------
 void KMMainWidget::slotUseTemplate()
 {
   newFromTemplate( mHeaders->currentMsg() );
@@ -1446,50 +1520,13 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMMainWidget::slotReplyToMsg()
-{
-  QString text = mMsgView? mMsgView->copyText() : "";
-  KMCommand *command = new KMReplyToCommand( this, mHeaders->currentMsg(), text );
-  command->start();
-}
-
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotReplyAuthorToMsg()
-{
-  QString text = mMsgView? mMsgView->copyText() : "";
-  KMCommand *command = new KMReplyAuthorCommand( this, mHeaders->currentMsg(), text );
-  command->start();
-}
-
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotReplyAllToMsg()
-{
-  QString text = mMsgView? mMsgView->copyText() : "";
-  KMCommand *command = new KMReplyToAllCommand( this, mHeaders->currentMsg(), text );
-  command->start();
-}
-
-
-//-----------------------------------------------------------------------------
 void KMMainWidget::slotRedirectMsg()
 {
   KMCommand *command = new KMRedirectCommand( this, mHeaders->currentMsg() );
   command->start();
 }
 
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotReplyListToMsg()
-{
 
-  QString text = mMsgView? mMsgView->copyText() : "";
-  KMCommand *command = new KMReplyListCommand( this, mHeaders->currentMsg(),
-					       text );
-  command->start();
-}
-
-
 //-----------------------------------------------------------------------------
 void KMMainWidget::slotCustomReplyToMsg( int tid )
 {
@@ -1629,6 +1666,13 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMMainWidget::slotToggleSizeColumn()
+{
+  mFolderTree->toggleColumn(KMFolderTree::foldersize);
+}
+
+
+//-----------------------------------------------------------------------------
 void KMMainWidget::slotJumpToFolder()
 {
   KMail::KMFolderSelDlg dlg( this, i18n("Jump to Folder"), true );
@@ -1671,6 +1715,16 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMMainWidget::slotCheckVacation()
+{
+  updateVactionScriptStatus( false );
+  if ( !kmkernel->askToGoOnline() )
+    return;
+
+  Vacation *vac = new Vacation( this, true /* check only */ );
+  connect( vac, SIGNAL(scriptActive(bool)), SLOT(updateVactionScriptStatus(bool)) );
+}
+
 void KMMainWidget::slotEditVacation()
 {
   if ( !kmkernel->askToGoOnline() ) {
@@ -1681,6 +1735,7 @@
     return;
 
   mVacation = new Vacation( this );
+  connect( mVacation, SIGNAL(scriptActive(bool)), SLOT(updateVactionScriptStatus(bool)) );
   if ( mVacation->isUsable() ) {
     connect( mVacation, SIGNAL(result(bool)), mVacation, SLOT(deleteLater()) );
   } else {
@@ -1854,13 +1909,13 @@
 {
   if(mBodyPartsMenu->isItemChecked(mBodyPartsMenu->idAt(0)))
   {
-    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(0),FALSE);
-    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(1),TRUE);
+    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(0),false);
+    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(1),true);
   }
   else if(mBodyPartsMenu->isItemChecked(mBodyPartsMenu->idAt(1)))
   {
-    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(1),FALSE);
-    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(0),TRUE);
+    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(1),false);
+    mBodyPartsMenu->setItemChecked(mBodyPartsMenu->idAt(0),true);
   }
 
   //mMsgView->setInline(!mMsgView->isInline());
@@ -1874,34 +1929,14 @@
   slotChangeCaption( mFolderTree->currentItem() );
 }
 
-void KMMainWidget::openFolder()
-{
-  if ( !mFolder || mFolder->folderType() != KMFolderTypeImap )
-    return;
-  KMFolderImap *imap = static_cast<KMFolderImap*>(mFolder->storage());
-  assert( !mOpenedImapFolder );
-  imap->open("mainwidget"); // will be closed in the folderSelected slot
-  mOpenedImapFolder = true;
-  // first get new headers before we select the folder
-  imap->setSelected( true );
-}
-
-void KMMainWidget::closeFolder()
-{
-  if ( !mFolder || mFolder->folderType() != KMFolderTypeImap )
-    return;
-  assert( mOpenedImapFolder );
-  KMFolderImap *imap = static_cast<KMFolderImap*>(mFolder->storage());
-  imap->setSelected( false );
-  mFolder->close( "mainwidget" );
-  mOpenedImapFolder = false;
-}
-
 //-----------------------------------------------------------------------------
 void KMMainWidget::folderSelected()
 {
   folderSelected( mFolder );
   updateFolderMenu();
+  // opened() before the getAndCheckFolder() in folderSelected
+  if ( mFolder && mFolder->folderType() == KMFolderTypeImap )
+    mFolder->close("mainwidget");
 }
 
 //-----------------------------------------------------------------------------
@@ -1916,7 +1951,7 @@
   {
     KMFolderImap *imap = static_cast<KMFolderImap*>(mFolder->storage());
     if ( mFolder->needsCompacting() && imap->autoExpunge() )
-      imap->expungeFolder(imap, TRUE);
+      imap->expungeFolder(imap, true);
   }
 
   // Re-enable the msg list and quicksearch if we're showing a splash
@@ -1957,14 +1992,8 @@
            this, SLOT( updateMarkAsReadAction() ) );
   }
 
-  if ( newFolder )
-      closeFolder();
-
   mFolder = aFolder;
 
-  if ( newFolder )
-    openFolder();
-
   if ( aFolder && aFolder->folderType() == KMFolderTypeImap )
   {
     if ( kmkernel->isOffline() ) {
@@ -1974,6 +2003,9 @@
     KMFolderImap *imap = static_cast<KMFolderImap*>(aFolder->storage());
     if ( newFolder && !mFolder->noContent() )
     {
+      imap->open("mainwidget"); // will be closed in the folderSelected slot
+      // first get new headers before we select the folder
+      imap->setSelected( true );
       connect( imap, SIGNAL( folderComplete( KMFolderImap*, bool ) ),
           this, SLOT( folderSelected() ) );
       imap->getAndCheckFolder();
@@ -2066,6 +2098,8 @@
   // reset HTML override to the folder setting
   mMsgView->setHtmlOverride(mFolderHtmlPref);
   mMsgView->setHtmlLoadExtOverride(mFolderHtmlLoadExtPref);
+  mMsgView->setDecryptMessageOverwrite( false );
+  mMsgView->setShowSignatureDetails( false );
 }
 
 //-----------------------------------------------------------------------------
@@ -2092,6 +2126,8 @@
     mHeaders->setCurrentMsg(idx);
     if (mMsgView)
       mMsgView->setMsg(msg);
+    else
+      slotMsgActivated(msg);
   }
 }
 
@@ -2157,42 +2193,6 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusNew()
-{
-  mHeaders->setMsgStatus(KMMsgStatusNew);
-}
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusUnread()
-{
-  mHeaders->setMsgStatus(KMMsgStatusUnread);
-}
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusRead()
-{
-  mHeaders->setMsgStatus(KMMsgStatusRead);
-}
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusFlag()
-{
-  mHeaders->setMsgStatus(KMMsgStatusFlag, true);
-}
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusTodo()
-{
-  mHeaders->setMsgStatus(KMMsgStatusTodo, true);
-}
-
-//-----------------------------------------------------------------------------
-void KMMainWidget::slotSetMsgStatusSent()
-{
-  mHeaders->setMsgStatus(KMMsgStatusSent, true);
-}
-
-//-----------------------------------------------------------------------------
 void KMMainWidget::slotSetThreadStatusNew()
 {
   mHeaders->setThreadStatus(KMMsgStatusNew);
@@ -2269,7 +2269,6 @@
 }
 
 //-----------------------------------------------------------------------------
-//called from headers. Message must not be deleted on close
 void KMMainWidget::slotMsgActivated(KMMessage *msg)
 {
   if ( !msg ) return;
@@ -2282,7 +2281,7 @@
   }
 
   if (kmkernel->folderIsDraftOrOutbox( mFolder ) ) {
-    slotEditMsg();
+    mMsgActions->editCurrentMessage();
     return;
   }
   if ( kmkernel->folderIsTemplates( mFolder ) ) {
@@ -2307,7 +2306,7 @@
 //-----------------------------------------------------------------------------
 void KMMainWidget::slotMarkAll()
 {
-  mHeaders->selectAll( TRUE );
+  mHeaders->selectAll( true );
 }
 
 //-----------------------------------------------------------------------------
@@ -2359,7 +2358,7 @@
   if(mMsgView && !mMsgView->copyText().isEmpty()) {
     if ( urlMenuAdded )
       menu->insertSeparator();
-    mReplyActionMenu->plug(menu);
+    mMsgActions->replyMenu()->plug(menu);
     menu->insertSeparator();
 
     mMsgView->copyAction()->plug( menu );
@@ -2374,16 +2373,16 @@
       return;
     }
 
-    if ( mFolder->isDrafts() || mFolder->isOutbox() ) {
-      mEditAction->plug(menu);
-    } else if ( mFolder->isTemplates() ) {
+
+    if ( mFolder->isTemplates() ) {
       mUseAction->plug( menu );
-      mEditAction->plug( menu );
     } else {
+
       if ( !mFolder->isSent() )
-        mReplyActionMenu->plug( menu );
+        mMsgActions->replyMenu()->plug( menu );
       mForwardActionMenu->plug( menu );
     }
+    editAction()->plug(menu);
     menu->insertSeparator();
 
     mCopyActionMenu->plug( menu );
@@ -2391,7 +2390,7 @@
 
     menu->insertSeparator();
 
-    mStatusMenu->plug( menu );
+    mMsgActions->messageStatusMenu()->plug( menu );
     menu->insertSeparator();
 
     viewSourceAction()->plug(menu);
@@ -2408,6 +2407,9 @@
       mDeleteAction->plug( menu );
     else
       mTrashAction->plug( menu );
+
+    menu->insertSeparator();
+    mMsgActions->createTodoAction()->plug( menu );
   }
   KAcceleratorManager::manage(menu);
   menu->exec(aPoint, 0);
@@ -2475,7 +2477,7 @@
   QSignalMapper *mCustomReplyMapper = new QSignalMapper( this );
   connect( mCustomReplyMapper, SIGNAL( mapped( int ) ),
            this, SLOT( slotCustomReplyToMsg( int ) ) );
-  mReplyActionMenu->insert( mCustomReplyActionMenu );
+  mMsgActions->replyMenu()->insert( mCustomReplyActionMenu );
 
   mCustomReplyAllActionMenu =
     new KActionMenu( i18n("Reply to All With Custom Template"),
@@ -2484,7 +2486,7 @@
   QSignalMapper *mCustomReplyAllMapper = new QSignalMapper( this );
   connect( mCustomReplyAllMapper, SIGNAL( mapped( int ) ),
            this, SLOT( slotCustomReplyAllToMsg( int ) ) );
-  mReplyActionMenu->insert( mCustomReplyAllActionMenu );
+  mMsgActions->replyMenu()->insert( mCustomReplyAllActionMenu );
 
   mCustomTemplates.clear();
 
@@ -2594,6 +2596,9 @@
 //-----------------------------------------------------------------------------
 void KMMainWidget::setupActions()
 {
+  mMsgActions = new KMail::MessageActions( actionCollection(), this );
+  mMsgActions->setMessageView( mMsgView );
+
   //----- File Menu
   mSaveAsAction = new KAction( i18n("Save &As..."), "filesave",
     KStdAccel::shortcut(KStdAccel::Save),
@@ -2622,6 +2627,12 @@
 		      this, SLOT(slotCheckMail()),
 		      actionCollection(), "check_mail" );
 
+  mFavoritesCheckMailAction = new KAction( i18n("Check Mail in Favorite Folders"),
+              "mail_get", CTRL+SHIFT+Key_L, 0, 0,
+              actionCollection(), "favorite_check_mail" );
+  if ( mFavoriteFolderView )
+    connect( mFavoritesCheckMailAction, SIGNAL(activated()), mFavoriteFolderView, SLOT(checkMail()) );
+
   KActionMenu *actActionMenu = new
     KActionMenu( i18n("Check Mail &In"), "mail_get", actionCollection(),
 				   	"check_mail_in" );
@@ -2676,11 +2687,13 @@
 		      actionCollection(), "tools_debug_sieve" );
 #endif
 
-  // @TODO (marc/bo): Test
-  (void) new KAction( i18n("Edit \"Out of Office\" Replies..."),
-		      "configure", 0, this, SLOT(slotEditVacation()),
-		      actionCollection(), "tools_edit_vacation" );
+  if ( GlobalSettings::allowOutOfOfficeSettings() ) {
+      (void) new KAction( i18n("Edit \"Out of Office\" Replies..."),
+              "configure", 0, this, SLOT(slotEditVacation()),
+              actionCollection(), "tools_edit_vacation" );
 
+  }
+
   (void) new KAction( i18n("Filter &Log Viewer..."), 0, this,
  		      SLOT(slotFilterLogViewer()), actionCollection(), "filter_log_viewer" );
 
@@ -2713,7 +2726,7 @@
 
 
   (void) new KAction( i18n("&Find Messages..."), "mail_find", Key_S, this,
-		      SLOT(slotSearch()), actionCollection(), "search_messages" );
+		      SLOT(slotRequestFullSearchFromQuickSearch()), actionCollection(), "search_messages" );
 
   mFindInMessageAction = new KAction( i18n("&Find in Message..."), "find", KStdAccel::shortcut(KStdAccel::Find), this,
 		      SLOT(slotFind()), actionCollection(), "find_in_messages" );
@@ -2796,75 +2809,64 @@
   connect( mTemplateMenu->popupMenu(), SIGNAL( activated(int) ), this,
            SLOT( slotNewFromTemplate(int) ) );
 
-  (void) new KAction( i18n("New Message t&o Mailing-List..."), "mail_post_to",
+  KAction* newToML = new KAction( i18n("New Message t&o Mailing-List..."), "mail_post_to",
                       CTRL+SHIFT+Key_N, this,
 		      SLOT(slotPostToML()), actionCollection(), "post_message" );
+  newToML->plugAccel( actionCollection()->kaccel() );
 
   mForwardActionMenu = new KActionMenu( i18n("Message->","&Forward"),
 					"mail_forward", actionCollection(),
 					"message_forward" );
-  connect( mForwardActionMenu, SIGNAL(activated()), this,
-	   SLOT(slotForwardInlineMsg()) );
 
-  mForwardAttachedAction = new KAction( i18n("Message->Forward->","As &Attachment..."),
-				       "mail_forward", Key_F, this,
-					SLOT(slotForwardAttachedMsg()),
-                                        actionCollection(),
-					"message_forward_as_attachment" );
-  mForwardActionMenu->insert( forwardAttachedAction() );
-  mForwardInlineAction = new KAction( i18n("&Inline..."), "mail_forward",
-                                      SHIFT+Key_F, this,
+      mForwardInlineAction = new KAction( i18n("&Inline..."),
+                                      "mail_forward", 0, this,
                                       SLOT(slotForwardInlineMsg()),
                                       actionCollection(),
                                       "message_forward_inline" );
 
-  mForwardActionMenu->insert( forwardInlineAction() );
-  mForwardDigestAction = new KAction( i18n("Message->Forward->","As Di&gest..."),
+      mForwardAttachedAction = new KAction( i18n("Message->Forward->","As &Attachment..."),
+                                        "mail_forward", 0, this,
+                                        SLOT(slotForwardAttachedMsg()),
+                                        actionCollection(),
+                                        "message_forward_as_attachment" );
+
+      mForwardDigestAction = new KAction( i18n("Message->Forward->","As Di&gest..."),
                                       "mail_forward", 0, this,
                                       SLOT(slotForwardDigestMsg()),
                                       actionCollection(),
                                       "message_forward_as_digest" );
-  mForwardActionMenu->insert( forwardDigestAction() );
-  mRedirectAction = new KAction( i18n("Message->Forward->","&Redirect..."),
+
+      mRedirectAction = new KAction( i18n("Message->Forward->","&Redirect..."),
                                  "mail_forward", Key_E, this,
                                  SLOT(slotRedirectMsg()),
-				 actionCollection(),
+                                 actionCollection(),
                                  "message_forward_redirect" );
-  mForwardActionMenu->insert( redirectAction() );
 
-  mSendAgainAction = new KAction( i18n("Send A&gain..."), 0, this,
-		      SLOT(slotResendMsg()), actionCollection(), "send_again" );
 
-  mReplyActionMenu = new KActionMenu( i18n("Message->","&Reply"),
-                                      "mail_reply", actionCollection(),
-                                      "message_reply_menu" );
-  connect( mReplyActionMenu, SIGNAL(activated()), this,
-	   SLOT(slotReplyToMsg()) );
+      if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
+          mForwardActionMenu->insert( mForwardInlineAction );
+          mForwardActionMenu->insert( mForwardAttachedAction );
+          mForwardInlineAction->setShortcut( Key_F );
+          mForwardAttachedAction->setShortcut( SHIFT+Key_F );
+          connect( mForwardActionMenu, SIGNAL(activated()), this,
+                   SLOT(slotForwardInlineMsg()) );
 
-  mReplyAction = new KAction( i18n("&Reply..."), "mail_reply", Key_R, this,
-			      SLOT(slotReplyToMsg()), actionCollection(), "reply" );
-  mReplyActionMenu->insert( mReplyAction );
+      } else {
+          mForwardActionMenu->insert( mForwardAttachedAction );
+          mForwardActionMenu->insert( mForwardInlineAction );
+          mForwardInlineAction->setShortcut( SHIFT+Key_F );
+          mForwardAttachedAction->setShortcut( Key_F );
+          connect( mForwardActionMenu, SIGNAL(activated()), this,
+                   SLOT(slotForwardAttachedMsg()) );
+      }
 
-  mReplyAuthorAction = new KAction( i18n("Reply to A&uthor..."), "mail_reply",
-                                    SHIFT+Key_A, this,
-                                    SLOT(slotReplyAuthorToMsg()),
-                                    actionCollection(), "reply_author" );
-  mReplyActionMenu->insert( mReplyAuthorAction );
+      mForwardActionMenu->insert( mForwardDigestAction );
+      mForwardActionMenu->insert( mRedirectAction );
 
-  mReplyAllAction = new KAction( i18n("Reply to &All..."), "mail_replyall",
-				 Key_A, this, SLOT(slotReplyAllToMsg()),
-				 actionCollection(), "reply_all" );
-  mReplyActionMenu->insert( mReplyAllAction );
+  mSendAgainAction = new KAction( i18n("Send A&gain..."), 0, this,
+		      SLOT(slotResendMsg()), actionCollection(), "send_again" );
 
-  mReplyListAction = new KAction( i18n("Reply to Mailing-&List..."),
-				  "mail_replylist", Key_L, this,
-				  SLOT(slotReplyListToMsg()), actionCollection(),
-				  "reply_list" );
-  mReplyActionMenu->insert( mReplyListAction );
 
-  mNoQuoteReplyAction = new KAction( i18n("Reply Without &Quote..."), SHIFT+Key_R,
-    this, SLOT(slotNoQuoteReplyToMsg()), actionCollection(), "noquotereply" );
-
   //----- Create filter actions
   mFilterMenu = new KActionMenu( i18n("&Create Filter"), "filter", actionCollection(), "create_filter" );
   connect( mFilterMenu, SIGNAL(activated()), this,
@@ -2891,48 +2893,11 @@
 
   mPrintAction = KStdAction::print (this, SLOT(slotPrintMsg()), actionCollection());
 
-  mEditAction = new KAction( i18n("&Edit Message"), "edit", Key_T, this,
-                            SLOT(slotEditMsg()), actionCollection(), "edit" );
-  mEditAction->plugAccel( actionCollection()->kaccel() );
   mUseAction = new KAction( i18n("New Message From &Template"), "filenew",
                             Key_N, this, SLOT( slotUseTemplate() ),
                             actionCollection(), "use_template" );
   mUseAction->plugAccel( actionCollection()->kaccel() );
 
-  //----- "Mark Message" submenu
-  mStatusMenu = new KActionMenu ( i18n( "Mar&k Message" ),
-                                 actionCollection(), "set_status" );
-
-  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &Read"), "kmmsgread",
-                                          i18n("Mark selected messages as read")),
-                                 0, this, SLOT(slotSetMsgStatusRead()),
-                                 actionCollection(), "status_read"));
-
-  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &New"), "kmmsgnew",
-                                          i18n("Mark selected messages as new")),
-                                 0, this, SLOT(slotSetMsgStatusNew()),
-                                 actionCollection(), "status_new" ));
-
-  mStatusMenu->insert(new KAction(KGuiItem(i18n("Mark Message as &Unread"), "kmmsgunseen",
-                                          i18n("Mark selected messages as unread")),
-                                 0, this, SLOT(slotSetMsgStatusUnread()),
-                                 actionCollection(), "status_unread"));
-
-  mStatusMenu->insert( new KActionSeparator( this ) );
-
-  // -------- Toggle Actions
-  mToggleFlagAction = new KToggleAction(i18n("Mark Message as &Important"), "mail_flag",
-                                 0, this, SLOT(slotSetMsgStatusFlag()),
-                                 actionCollection(), "status_flag");
-  mToggleFlagAction->setCheckedState( i18n("Remove &Important Message Mark") );
-  mStatusMenu->insert( mToggleFlagAction );
-
-  mToggleTodoAction = new KToggleAction(i18n("Mark Message as &To-do"), "mail_todo",
-                                 0, this, SLOT(slotSetMsgStatusTodo()),
-                                 actionCollection(), "status_todo");
-  mToggleTodoAction->setCheckedState( i18n("Remove &To-do Message Mark") );
-  mStatusMenu->insert( mToggleTodoAction );
-
   //----- "Mark Thread" submenu
   mThreadStatusMenu = new KActionMenu ( i18n( "Mark &Thread" ),
                                        actionCollection(), "thread_status" );
@@ -2964,10 +2929,10 @@
   mToggleThreadFlagAction->setCheckedState( i18n("Remove &Important Thread Mark") );
   mThreadStatusMenu->insert( mToggleThreadFlagAction );
 
-  mToggleThreadTodoAction = new KToggleAction(i18n("Mark Thread as &To-do"), "mail_todo",
+  mToggleThreadTodoAction = new KToggleAction(i18n("Mark Thread as &Action Item"), "mail_todo",
                                        0, this, SLOT(slotSetThreadStatusTodo()),
                                        actionCollection(), "thread_todo");
-  mToggleThreadTodoAction->setCheckedState( i18n("Remove &To-do Thread Mark") );
+  mToggleThreadTodoAction->setCheckedState( i18n("Remove &Action Item Thread Mark") );
   mThreadStatusMenu->insert( mToggleThreadTodoAction );
 
   //------- "Watch and ignore thread" actions
@@ -3027,6 +2992,11 @@
 			       actionCollection(), "view_columns_total" );
   mTotalColumnToggle->setToolTip( i18n("Toggle display of column showing the "
                                       "total number of messages in folders.") );
+  mSizeColumnToggle = new KToggleAction( i18n("View->", "&Size Column"), 0, this,
+			       SLOT(slotToggleSizeColumn()),
+			       actionCollection(), "view_columns_size" );
+  mSizeColumnToggle->setToolTip( i18n("Toggle display of column showing the "
+                                      "total size of messages in folders.") );
 
   (void)new KAction( KGuiItem( i18n("View->","&Expand Thread"), QString::null,
 			       i18n("Expand the current thread") ),
@@ -3171,6 +3141,26 @@
   updateFolderMenu();
 }
 
+void KMMainWidget::setupForwardingActionsList()
+{
+  QPtrList<KAction> mForwardActionList;
+  if ( GlobalSettings::self()->forwardingInlineByDefault() ) {
+      mGUIClient->unplugActionList( "forward_action_list" );
+      mForwardActionList.append( mForwardInlineAction );
+      mForwardActionList.append( mForwardAttachedAction );
+      mForwardActionList.append( mForwardDigestAction );
+      mForwardActionList.append( mRedirectAction );
+      mGUIClient->plugActionList( "forward_action_list", mForwardActionList );
+  } else {
+      mGUIClient->unplugActionList( "forward_action_list" );
+      mForwardActionList.append( mForwardAttachedAction );
+      mForwardActionList.append( mForwardInlineAction );
+      mForwardActionList.append( mForwardDigestAction );
+      mForwardActionList.append( mRedirectAction );
+      mGUIClient->plugActionList( "forward_action_list", mForwardActionList );
+  }
+}
+
 //-----------------------------------------------------------------------------
 void KMMainWidget::slotEditNotifications()
 {
@@ -3292,6 +3282,11 @@
         count = 1;
       else
         count = selectedItems.count();
+      mMsgActions->setCurrentMessage( mHeaders->currentMsg() );
+      mMsgActions->setSelectedSernums( mHeaders->selectedSernums() );
+      mMsgActions->setSelectedVisibleSernums( mHeaders->selectedVisibleSernums() );
+    } else {
+      mMsgActions->setCurrentMessage( 0 );
     }
 
     updateListFilterAction();
@@ -3324,23 +3319,21 @@
     bool mass_actions = count >= 1;
     bool thread_actions = mass_actions && allSelectedInCommonThread &&
                           mHeaders->isThreaded();
-    mStatusMenu->setEnabled( mass_actions );
+    bool flags_available = GlobalSettings::self()->allowLocalFlags() || !(mFolder ? mFolder->isReadOnly() : true);
     mThreadStatusMenu->setEnabled( thread_actions );
     // these need to be handled individually, the user might have them
     // in the toolbar
-    mWatchThreadAction->setEnabled( thread_actions );
-    mIgnoreThreadAction->setEnabled( thread_actions );
+    mWatchThreadAction->setEnabled( thread_actions && flags_available );
+    mIgnoreThreadAction->setEnabled( thread_actions && flags_available );
     mMarkThreadAsNewAction->setEnabled( thread_actions );
     mMarkThreadAsReadAction->setEnabled( thread_actions );
     mMarkThreadAsUnreadAction->setEnabled( thread_actions );
-    mToggleThreadTodoAction->setEnabled( thread_actions );
-    mToggleThreadFlagAction->setEnabled( thread_actions );
+    mToggleThreadTodoAction->setEnabled( thread_actions && flags_available );
+    mToggleThreadFlagAction->setEnabled( thread_actions && flags_available );
     mTrashThreadAction->setEnabled( thread_actions && !mFolder->isReadOnly() );
     mDeleteThreadAction->setEnabled( thread_actions && !mFolder->isReadOnly() );
 
     if (mFolder && mHeaders && mHeaders->currentMsg()) {
-      mToggleTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
-      mToggleFlagAction->setChecked(mHeaders->currentMsg()->isImportant());
       if (thread_actions) {
         mToggleThreadTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
         mToggleThreadFlagAction->setChecked(mHeaders->currentMsg()->isImportant());
@@ -3361,27 +3354,17 @@
     forwardMenu()->setEnabled( mass_actions );
 
     bool single_actions = count == 1;
-    mEditAction->setEnabled( single_actions &&
-                             ( kmkernel->folderIsDraftOrOutbox( mFolder ) ||
-                               kmkernel->folderIsTemplates( mFolder ) ) );
     mUseAction->setEnabled( single_actions &&
                             kmkernel->folderIsTemplates( mFolder ) );
-    replyMenu()->setEnabled( single_actions );
     filterMenu()->setEnabled( single_actions );
-    replyAction()->setEnabled( single_actions );
-    noQuoteReplyAction()->setEnabled( single_actions );
-    replyAuthorAction()->setEnabled( single_actions );
-    replyAllAction()->setEnabled( single_actions );
-    replyListAction()->setEnabled( single_actions );
     redirectAction()->setEnabled( single_actions );
     printAction()->setEnabled( single_actions );
     viewSourceAction()->setEnabled( single_actions );
 
-    mSendAgainAction->setEnabled( single_actions &&
-             ( mHeaders->currentMsg() && mHeaders->currentMsg()->isSent() )
+    mSendAgainAction->setEnabled( single_actions
+          && ( mHeaders->currentMsg() && mHeaders->currentMsg()->isSent() )
           || ( mFolder && mHeaders->currentMsg() &&
-              ( kmkernel->folderIsDraftOrOutbox( mFolder )
-             || kmkernel->folderIsSentMailFolder( mFolder ) ) ) );
+               kmkernel->folderIsSentMailFolder( mFolder ) ) );
     mSaveAsAction->setEnabled( mass_actions );
     bool mails = mFolder && mFolder->count();
     bool enable_goto_unread = mails
@@ -3405,7 +3388,7 @@
         return;
 
       if ((KMFolder*)mFolder == kmkernel->outboxFolder())
-        mEditAction->setEnabled( !msg->transferInProgress() );
+        editAction()->setEnabled( !msg->transferInProgress() );
     }
 
     mApplyAllFiltersAction->setEnabled(count);
@@ -3510,7 +3493,6 @@
 
   mMsgView->displayAboutPage();
 
-  closeFolder();
   mFolder = 0;
 }
 
@@ -3705,7 +3687,7 @@
       if(!addedSeparator) {
         mApplyFilterActionsMenu->popupMenu()->insertSeparator();
         addedSeparator = !addedSeparator;
-	mFilterMenuActions.append( new KActionSeparator());
+        mFilterMenuActions.append( new KActionSeparator());
       }
       filterAction->plug( mApplyFilterActionsMenu->popupMenu() );
       mFilterMenuActions.append(filterAction);
@@ -3859,6 +3841,7 @@
 {
   mTotalColumnToggle->setChecked( mFolderTree->isTotalActive() );
   mUnreadColumnToggle->setChecked( mFolderTree->isUnreadActive() );
+  mSizeColumnToggle->setChecked( mFolderTree->isSizeActive() );
 }
 
 void KMMainWidget::toggleSystemTray()
@@ -3930,3 +3913,60 @@
   else
     return GlobalSettings::self()->overrideCharacterEncoding();
 }
+
+void KMMainWidget::slotCreateTodo()
+{
+  KMMessage *msg = mHeaders->currentMsg();
+  if ( !msg )
+    return;
+  KMCommand *command = new CreateTodoCommand( this, msg );
+  command->start();
+}
+
+void KMMainWidget::setupFolderView()
+{
+  if ( GlobalSettings::self()->enableFavoriteFolderView() ) {
+    mFolderView = mFolderViewSplitter;
+    mFolderTree->reparent( mFolderViewSplitter, 0, QPoint( 0, 0 ) );
+    mFolderViewSplitter->show();
+    mFavoriteFolderView->show();
+  } else {
+    mFolderView = mFolderTree;
+    mFolderViewSplitter->hide();
+    mFavoriteFolderView->hide();
+  }
+  mFolderView->reparent( mFolderViewParent, 0, QPoint( 0, 0 ) );
+  mFolderViewParent->moveToFirst( mFolderView );
+  mFolderTree->show();
+}
+
+
+void KMMainWidget::slotRequestFullSearchFromQuickSearch()
+{
+    slotSearch();
+#ifdef HAVE_INDEXLIB
+    return;
+#endif
+    assert( mSearchWin );
+    KMSearchPattern pattern;
+    pattern.append( KMSearchRule::createInstance( "<message>", KMSearchRule::FuncContains, mQuickSearchLine->currentSearchTerm() ) );
+    int status = mQuickSearchLine->currentStatus();
+    if ( status != 0 ) {
+        pattern.append( new KMSearchRuleStatus( status ) );
+    }
+    mSearchWin->setSearchPattern( pattern );
+}
+
+void KMMainWidget::updateVactionScriptStatus(bool active)
+{
+  mVacationIndicatorActive = active;
+  if ( active ) {
+    mVacationScriptIndicator->setText( i18n("Out of office reply active") );
+    mVacationScriptIndicator->setPaletteBackgroundColor( Qt::yellow );
+    mVacationScriptIndicator->setCursor( QCursor( Qt::PointingHandCursor ) );
+    mVacationScriptIndicator->show();
+  } else {
+    mVacationScriptIndicator->hide();
+  }
+}
+
Index: kmail/imapjob.cpp
===================================================================
--- kmail/imapjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/imapjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -122,7 +122,7 @@
         curMsg = mSrcFolder->getMsg( idx );
       }
       KURL url = account->getUrl();
-      QString flags = KMFolderImap::statusToFlags( curMsg->status() );
+      QString flags = KMFolderImap::statusToFlags( curMsg->status(), folder->permanentFlags() );
       url.setPath( folder->imapPath() + ";SECTION=" + flags );
       ImapAccountBase::jobData jd;
       jd.parent = 0; jd.offset = 0; jd.done = 0;
@@ -157,7 +157,7 @@
       jd.progressItem->setTotalItems( jd.total );
       connect ( jd.progressItem, SIGNAL( progressItemCanceled( KPIM::ProgressItem*)),
           account, SLOT( slotAbortRequested( KPIM::ProgressItem* ) ) );
-      KIO::SimpleJob *job = KIO::put( url, 0, FALSE, FALSE, FALSE );
+      KIO::SimpleJob *job = KIO::put( url, 0, false, false, false );
       KIO::Scheduler::assignJobToSlave( account->slave(), job );
       account->insertJob( job, jd );
       connect( job, SIGNAL(result(KIO::Job *)),
@@ -198,7 +198,7 @@
     jd.progressItem->setTotalItems( jd.total );
     connect ( jd.progressItem, SIGNAL(progressItemCanceled(KPIM::ProgressItem*)),
               account, SLOT( slotAbortRequested(KPIM::ProgressItem* ) ) );
-    KIO::SimpleJob *simpleJob = KIO::special( url, packedArgs, FALSE );
+    KIO::SimpleJob *simpleJob = KIO::special( url, packedArgs, false );
     KIO::Scheduler::assignJobToSlave( account->slave(), simpleJob );
     mJob = simpleJob;
     account->insertJob( mJob, jd );
@@ -321,7 +321,7 @@
             account, SLOT( slotAbortRequested( KPIM::ProgressItem* ) ) );
   jd.progressItem->setTotalItems( jd.total );
 
-  KIO::SimpleJob *simpleJob = KIO::get( url, FALSE, FALSE );
+  KIO::SimpleJob *simpleJob = KIO::get( url, false, false );
   KIO::Scheduler::assignJobToSlave( account->slave(), simpleJob );
   mJob = simpleJob;
   account->insertJob( mJob, jd );
Index: kmail/snippet_widget.cpp
===================================================================
--- kmail/snippet_widget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippet_widget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,952 @@
+/*
+ *  File : snippet_widget.cpp
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#include <kurl.h>
+#include <kdebug.h>
+#include <klocale.h>
+#include <qlayout.h>
+#include <kpushbutton.h>
+#include <klistview.h>
+#include <qheader.h>
+#include <klineedit.h>
+#include <ktextedit.h>
+#include <kmessagebox.h>
+#include <kconfig.h>
+#include <qtooltip.h>
+#include <kpopupmenu.h>
+#include <qregexp.h>
+#include <qinputdialog.h>
+#include <qlabel.h>
+#include <qcheckbox.h>
+#include <qwhatsthis.h>
+#include <qdragobject.h>
+#include <qtimer.h>
+#include <kcombobox.h>
+#include <kmedit.h>
+#include <kiconloader.h>
+#include <kshortcut.h>
+#include <kaction.h>
+#include <kkeybutton.h>
+
+#include "snippetdlg.h"
+#include "snippetitem.h"
+#include "snippet_widget.h"
+
+#include <cassert>
+
+SnippetWidget::SnippetWidget(KMEdit* editor, KActionCollection* actionCollection, QWidget* parent)
+		: KListView(parent, "snippet widget"), QToolTip( viewport() ),
+		mEditor( editor ), mActionCollection( actionCollection )
+{
+    // init the QPtrList
+    _list.setAutoDelete(TRUE);
+
+    // init the KListView
+    setSorting( -1 );
+    addColumn( "" );
+    setFullWidth(true);
+    header()->hide();
+    setAcceptDrops(true);
+    setDragEnabled(true);
+    setDropVisualizer(false);
+    setRootIsDecorated(true);
+
+    //connect the signals
+    connect( this, SIGNAL( contextMenuRequested ( QListViewItem *, const QPoint & , int ) ),
+             this, SLOT( showPopupMenu(QListViewItem *, const QPoint & , int ) ) );
+
+    connect( this, SIGNAL( doubleClicked (QListViewItem *) ),
+             this, SLOT( slotEdit( QListViewItem *) ) );
+    connect( this, SIGNAL( returnPressed (QListViewItem *) ),
+             this, SLOT( slotExecuted( QListViewItem *) ) );
+
+    connect( this, SIGNAL( dropped(QDropEvent *, QListViewItem *) ),
+             this, SLOT( slotDropped(QDropEvent *, QListViewItem *) ) );
+
+    connect( editor, SIGNAL( insertSnippet() ), this, SLOT( slotExecute() ));
+
+    _cfg = 0;
+
+    QTimer::singleShot(0, this, SLOT(initConfig()));
+}
+
+SnippetWidget::~SnippetWidget()
+{
+  writeConfig();
+  delete _cfg;
+
+  /* We need to delete the child items before the parent items
+     otherwise KDevelop would crash on exiting */
+  SnippetItem * item;
+  while (_list.count() > 0) {
+    for (item=_list.first(); item; item=_list.next()) {
+      if (item->childCount() == 0)
+          _list.remove(item);
+    }
+  }
+}
+
+
+/*!
+    \fn SnippetWidget::slotAdd()
+    Opens the dialog to add a snippet
+ */
+void SnippetWidget::slotAdd()
+{
+  //kdDebug(5006) << "Ender slotAdd()" << endl;
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+
+  /*check if the user clicked a SnippetGroup
+    If not, we set the group variable to the SnippetGroup
+    which the selected item is a child of*/
+  SnippetGroup * group = dynamic_cast<SnippetGroup*>(selectedItem());
+  if ( !group && selectedItem() )
+    group = dynamic_cast<SnippetGroup*>(selectedItem()->parent());
+
+  /* still no group, let's make a default one */
+  if (!group ) {
+    if ( _list.isEmpty() ) {
+      group = new SnippetGroup(this, i18n("General"), SnippetGroup::getMaxId() );
+      _list.append( group );
+    } else {
+      group = dynamic_cast<SnippetGroup*>( _list.first() );
+    }
+  }
+  assert( group );
+
+  /*fill the combobox with the names of all SnippetGroup entries*/
+  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+    if (dynamic_cast<SnippetGroup*>(it)) {
+      dlg.cbGroup->insertItem(it->getName());
+    }
+  }
+  dlg.cbGroup->setCurrentText(group->getName());
+
+  if (dlg.exec() == QDialog::Accepted) {
+      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      _list.append( makeItem( group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
+  }
+}
+
+/*!
+    \fn SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text )
+    Helper factory method.
+ */
+SnippetItem* SnippetWidget::makeItem( SnippetItem* parent, const QString& name, const QString& text, const KShortcut& shortcut )
+{
+    SnippetItem * item = new SnippetItem(parent, name, text);
+    const QString actionName = i18n("Snippet %1").arg(name);
+    const QString normalizedName = QString(actionName).replace(" ", "_");
+    if ( !mActionCollection->action(normalizedName.utf8() ) ) {
+        KAction * action = new KAction( actionName, shortcut, item,
+                                        SLOT( slotExecute() ), mActionCollection,
+                                        normalizedName.utf8() );
+        item->setAction(action);
+        connect( item, SIGNAL( execute( QListViewItem* ) ),
+                 this, SLOT( slotExecuted( QListViewItem* ) ) );
+    }
+    return item;
+}
+
+/*!
+    \fn SnippetWidget::slotAddGroup()
+    Opens the didalog to add a snippet
+ */
+void SnippetWidget::slotAddGroup()
+{
+  //kdDebug(5006) << "Ender slotAddGroup()" << endl;
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+  dlg.setShowShortcut( false );
+  dlg.snippetText->setEnabled(false);
+  dlg.snippetText->setText("GROUP");
+  dlg.setCaption(i18n("Add Group"));
+  dlg.cbGroup->insertItem(i18n("All"));
+  dlg.cbGroup->setCurrentText(i18n("All"));
+
+  if (dlg.exec() == QDialog::Accepted) {
+    _list.append( new SnippetGroup(this, dlg.snippetName->text(), SnippetGroup::getMaxId() ) );
+  }
+}
+
+
+/*!
+    \fn SnippetWidget::slotRemove()
+    Removes the selected snippet
+ */
+void SnippetWidget::slotRemove()
+{
+  //get current data
+  QListViewItem * item = currentItem();
+  SnippetItem *snip = dynamic_cast<SnippetItem*>( item );
+  SnippetGroup *group = dynamic_cast<SnippetGroup*>( item );
+  if (!snip)
+    return;
+
+  if (group) {
+    if (group->childCount() > 0 &&
+        KMessageBox::warningContinueCancel(this, i18n("Do you really want to remove this group and all its snippets?"),QString::null,KStdGuiItem::del())
+        == KMessageBox::Cancel)
+      return;
+
+    SnippetItem *it=_list.first();
+    while ( it ) {
+      if (it->getParent() == group->getId()) {
+        SnippetItem *doomed = it;
+        it = _list.next();
+        //kdDebug(5006) << "remove " << doomed->getName() << endl;
+        _list.remove(doomed);
+      } else {
+        it = _list.next();
+      }
+    }
+  }
+
+  //kdDebug(5006) << "remove " << snip->getName() << endl;
+  _list.remove(snip);
+}
+
+
+
+/*!
+    \fn SnippetWidget::slotEdit()
+    Opens the dialog of editing the selected snippet
+ */
+void SnippetWidget::slotEdit( QListViewItem* item )
+{
+    if( item == 0 ) {
+	item = currentItem();
+    }
+
+  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>(item);
+  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
+  if (!pSnippet || pGroup) /*selected item must be a SnippetItem but MUST not be a SnippetGroup*/
+    return;
+
+  //init the dialog
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg");
+  dlg.snippetName->setText(pSnippet->getName());
+  dlg.snippetText->setText(pSnippet->getText());
+  dlg.keyButton->setShortcut( pSnippet->getAction()->shortcut(), false );
+  dlg.btnAdd->setText(i18n("&Apply"));
+
+  dlg.setCaption(i18n("Edit Snippet"));
+  /*fill the combobox with the names of all SnippetGroup entries*/
+  for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+    if (dynamic_cast<SnippetGroup*>(it)) {
+      dlg.cbGroup->insertItem(it->getName());
+    }
+  }
+  dlg.cbGroup->setCurrentText(SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName());
+
+  if (dlg.exec() == QDialog::Accepted) {
+    //update the KListView and the SnippetItem
+    item->setText( 0, dlg.snippetName->text() );
+    pSnippet->setName( dlg.snippetName->text() );
+    pSnippet->setText( dlg.snippetText->text() );
+    pSnippet->getAction()->setShortcut( dlg.keyButton->shortcut());
+
+    /* if the user changed the parent we need to move the snippet */
+    if ( SnippetItem::findGroupById(pSnippet->getParent(), _list)->getName() != dlg.cbGroup->currentText() ) {
+      SnippetGroup * newGroup = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      pSnippet->parent()->takeItem(pSnippet);
+      newGroup->insertItem(pSnippet);
+      pSnippet->resetParent();
+    }
+
+    setSelected(item, TRUE);
+  }
+}
+
+/*!
+    \fn SnippetWidget::slotEditGroup()
+    Opens the dialog of editing the selected snippet-group
+ */
+void SnippetWidget::slotEditGroup()
+{
+  //get current data
+  QListViewItem * item = currentItem();
+
+  SnippetGroup *pGroup = dynamic_cast<SnippetGroup*>( item );
+  if (!pGroup) /*selected item MUST be a SnippetGroup*/
+    return;
+
+  //init the dialog
+  SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
+  dlg.setShowShortcut( false );
+  dlg.snippetName->setText(pGroup->getName());
+  dlg.snippetText->setText(pGroup->getText());
+  dlg.btnAdd->setText(i18n("&Apply"));
+  dlg.snippetText->setEnabled(FALSE);
+  dlg.setCaption(i18n("Edit Group"));
+  dlg.cbGroup->insertItem(i18n("All"));
+
+  if (dlg.exec() == QDialog::Accepted) {
+    //update the KListView and the SnippetGroup
+    item->setText( 0, dlg.snippetName->text() );
+    pGroup->setName( dlg.snippetName->text() );
+
+    setSelected(item, TRUE);
+  }
+}
+
+void SnippetWidget::slotExecuted(QListViewItem * item)
+{
+    if( item == 0 )
+    {
+	item = currentItem();
+    }
+
+  SnippetItem *pSnippet = dynamic_cast<SnippetItem*>( item );
+  if (!pSnippet || dynamic_cast<SnippetGroup*>(item))
+      return;
+
+  //process variables if any, then insert into the active view
+  insertIntoActiveView( parseText(pSnippet->getText(), _SnippetConfig.getDelimiter()) );
+}
+
+
+/*!
+    \fn SnippetWidget::insertIntoActiveView(QString text)
+    Inserts the parameter text into the activ view
+ */
+void SnippetWidget::insertIntoActiveView( const QString &text )
+{
+    mEditor->insert( text );
+}
+
+
+/*!
+    \fn SnippetWidget::writeConfig()
+    Write the cofig file
+ */
+void SnippetWidget::writeConfig()
+{
+  if( !_cfg )
+    return;
+  _cfg->deleteGroup("SnippetPart");  //this is neccessary otherwise delete entries will stay in list until
+                                     //they get overwritten by a more recent entry
+  _cfg->setGroup("SnippetPart");
+
+  QString strKeyName="";
+  QString strKeyText="";
+  QString strKeyId="";
+
+  int iSnipCount = 0;
+  int iGroupCount = 0;
+
+  SnippetItem* item=_list.first();
+  while ( item != 0) {
+
+    //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
+    //kdDebug(5006) << "SnippetWidget::writeConfig() " << item->getName() << endl;
+    SnippetGroup * group = dynamic_cast<SnippetGroup*>(item);
+    if (group) {
+      //kdDebug(5006) << "-->GROUP " << item->getName() << group->getId() << " " << iGroupCount<< endl;
+      strKeyName=QString("snippetGroupName_%1").arg(iGroupCount);
+      strKeyId=QString("snippetGroupId_%1").arg(iGroupCount);
+
+      _cfg->writeEntry(strKeyName, group->getName());
+      _cfg->writeEntry(strKeyId, group->getId());
+
+      iGroupCount++;
+    } else if (dynamic_cast<SnippetItem*>(item)) {
+      //kdDebug(5006) << "-->ITEM " << item->getName() << item->getParent() << " " << iSnipCount << endl;
+      strKeyName=QString("snippetName_%1").arg(iSnipCount);
+      strKeyText=QString("snippetText_%1").arg(iSnipCount);
+      strKeyId=QString("snippetParent_%1").arg(iSnipCount);
+
+      _cfg->writeEntry(strKeyName, item->getName());
+      _cfg->writeEntry(strKeyText, item->getText());
+      _cfg->writeEntry(strKeyId, item->getParent());
+
+      KAction * action = item->getAction();
+      assert( action );
+      const KShortcut& sc = action->shortcut();
+      if (!sc.isNull() ) {
+          _cfg->writeEntry( QString("snippetShortcut_%1").arg(iSnipCount), sc.toString() );
+      }
+      iSnipCount++;
+    } else {
+      //kdDebug(5006) << "-->ERROR " << item->getName() << endl;
+    }
+    item = _list.next();
+  }
+  _cfg->writeEntry("snippetCount", iSnipCount);
+  _cfg->writeEntry("snippetGroupCount", iGroupCount);
+
+  int iCount = 1;
+  QMap<QString, QString>::Iterator it;
+  for ( it = _mapSaved.begin(); it != _mapSaved.end(); ++it ) {  //write the saved variable values
+    if (it.data().length()<=0) continue;  //is the saved value has no length -> no need to save it
+
+    strKeyName=QString("snippetSavedName_%1").arg(iCount);
+    strKeyText=QString("snippetSavedVal_%1").arg(iCount);
+
+    _cfg->writeEntry(strKeyName, it.key());
+    _cfg->writeEntry(strKeyText, it.data());
+
+    iCount++;
+  }
+  _cfg->writeEntry("snippetSavedCount", iCount-1);
+
+
+  _cfg->writeEntry( "snippetDelimiter", _SnippetConfig.getDelimiter() );
+  _cfg->writeEntry( "snippetVarInput", _SnippetConfig.getInputMethod() );
+  _cfg->writeEntry( "snippetToolTips", _SnippetConfig.useToolTips() );
+  _cfg->writeEntry( "snippetGroupAutoOpen", _SnippetConfig.getAutoOpenGroups() );
+
+  _cfg->writeEntry("snippetSingleRect", _SnippetConfig.getSingleRect() );
+  _cfg->writeEntry("snippetMultiRect", _SnippetConfig.getMultiRect() );
+
+  _cfg->sync();
+}
+
+/*!
+    \fn SnippetWidget::initConfig()
+    Initial read the cofig file
+ */
+void SnippetWidget::initConfig()
+{
+  if (_cfg == NULL)
+    _cfg = new KConfig("kmailsnippetrc", false, false);
+
+  _cfg->setGroup("SnippetPart");
+
+  QString strKeyName="";
+  QString strKeyText="";
+  QString strKeyId="";
+  SnippetItem *item;
+  SnippetGroup *group;
+
+  //kdDebug(5006) << "SnippetWidget::initConfig() " << endl;
+
+  //if entry doesn't get found, this will return -1 which we will need a bit later
+  int iCount = _cfg->readNumEntry("snippetGroupCount", -1);
+
+  for ( int i=0; i<iCount; i++) {  //read the group-list
+    strKeyName=QString("snippetGroupName_%1").arg(i);
+    strKeyId=QString("snippetGroupId_%1").arg(i);
+
+    QString strNameVal="";
+    int iIdVal=-1;
+
+    strNameVal = _cfg->readEntry(strKeyName, "");
+    iIdVal = _cfg->readNumEntry(strKeyId, -1);
+    //kdDebug(5006) << "Read group "  << " " << iIdVal << endl;
+
+    if (strNameVal != "" && iIdVal != -1) {
+      group = new SnippetGroup(this, strNameVal, iIdVal);
+      //kdDebug(5006) << "Created group " << group->getName() << " " << group->getId() << endl;
+      _list.append(group);
+    }
+  }
+
+  /* Check if the snippetGroupCount property has been found
+     if iCount is -1 this means, that the user has his snippets
+     stored without groups. Therefore we will call the
+     initConfigOldVersion() function below */
+  // should not happen since this function has been removed
+
+  if (iCount != -1) {
+    iCount = _cfg->readNumEntry("snippetCount", 0);
+    for ( int i=0; i<iCount; i++) {  //read the snippet-list
+        strKeyName=QString("snippetName_%1").arg(i);
+        strKeyText=QString("snippetText_%1").arg(i);
+        strKeyId=QString("snippetParent_%1").arg(i);
+
+        QString strNameVal="";
+        QString strTextVal="";
+        int iParentVal = -1;
+
+        strNameVal = _cfg->readEntry(strKeyName, "");
+        strTextVal = _cfg->readEntry(strKeyText, "");
+        iParentVal = _cfg->readNumEntry(strKeyId, -1);
+        //kdDebug(5006) << "Read item " << strNameVal << " " << iParentVal << endl;
+
+        if (strNameVal != "" && strTextVal != "" && iParentVal != -1) {
+            KShortcut shortcut( _cfg->readEntry( QString("snippetShortcut_%1").arg(i), QString() ) );
+            item = makeItem( SnippetItem::findGroupById(iParentVal, _list), strNameVal, strTextVal, shortcut );
+            //kdDebug(5006) << "Created item " << item->getName() << " " << item->getParent() << endl;
+            _list.append(item);
+        }
+    }
+  } else {
+      //kdDebug() << "iCount is not -1";
+  }
+
+  iCount = _cfg->readNumEntry("snippetSavedCount", 0);
+
+  for ( int i=1; i<=iCount; i++) {  //read the saved-values and store in QMap
+    strKeyName=QString("snippetSavedName_%1").arg(i);
+    strKeyText=QString("snippetSavedVal_%1").arg(i);
+
+    QString strNameVal="";
+    QString strTextVal="";
+
+    strNameVal = _cfg->readEntry(strKeyName, "");
+    strTextVal = _cfg->readEntry(strKeyText, "");
+
+    if (strNameVal != "" && strTextVal != "") {
+      _mapSaved[strNameVal] = strTextVal;
+    }
+  }
+
+
+  _SnippetConfig.setDelimiter( _cfg->readEntry("snippetDelimiter", "$") );
+  _SnippetConfig.setInputMethod( _cfg->readNumEntry("snippetVarInput", 0) );
+  _SnippetConfig.setToolTips( _cfg->readBoolEntry("snippetToolTips", true) );
+  _SnippetConfig.setAutoOpenGroups( _cfg->readNumEntry("snippetGroupAutoOpen", 1) );
+
+  _SnippetConfig.setSingleRect( _cfg->readRectEntry("snippetSingleRect", 0L) );
+  _SnippetConfig.setMultiRect( _cfg->readRectEntry("snippetMultiRect", 0L) );
+}
+
+/*!
+    \fn SnippetWidget::maybeTip( const QPoint & p )
+    Shows the Snippet-Text as ToolTip
+ */
+void SnippetWidget::maybeTip( const QPoint & p )
+{
+	SnippetItem * item = dynamic_cast<SnippetItem*>( itemAt( p ) );
+	if (!item)
+	  return;
+
+	QRect r = itemRect( item );
+
+	if (r.isValid() &&
+        _SnippetConfig.useToolTips() )
+	{
+	    tip( r, item->getText() );  //show the snippet's text
+	}
+}
+
+/*!
+    \fn SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
+    Shows the Popup-Menu depending item is a valid pointer
+*/
+void SnippetWidget::showPopupMenu( QListViewItem * item, const QPoint & p, int )
+{
+    KPopupMenu popup;
+
+    SnippetItem * selectedItem = static_cast<SnippetItem *>(item);
+    if ( item ) {
+        popup.insertTitle( selectedItem->getName() );
+        if (dynamic_cast<SnippetGroup*>(item)) {
+            popup.insertItem( i18n("Edit &group..."), this, SLOT( slotEditGroup() ) );
+        } else {
+            popup.insertItem( SmallIconSet("editpaste"), i18n("&Paste"), this, SLOT( slotExecuted() ) );
+            popup.insertItem( SmallIconSet("edit"), i18n("&Edit..."), this, SLOT( slotEdit() ) );
+        }
+        popup.insertItem( SmallIconSet("editdelete"), i18n("&Remove"), this, SLOT( slotRemove() ) );
+        popup.insertSeparator();
+    } else {
+        popup.insertTitle(i18n("Text Snippets"));
+    }
+    popup.insertItem( i18n("&Add Snippet..."), this, SLOT( slotAdd() ) );
+    popup.insertItem( i18n("Add G&roup..."), this, SLOT( slotAddGroup() ) );
+
+    popup.exec(p);
+}
+
+
+//  fn SnippetWidget::parseText(QString text, QString del)
+/*!
+    This function is used to parse the given QString for variables. If found the user will be prompted
+    for a replacement value. It returns the string text with all replacements made
+ */
+QString SnippetWidget::parseText(QString text, QString del)
+{
+  QString str = text;
+  QString strName = "";
+  QString strNew = "";
+  QString strMsg="";
+  int iFound = -1;
+  int iEnd = -1;
+  QMap<QString, QString> mapVar;
+  int iInMeth = _SnippetConfig.getInputMethod();
+  QRect rSingle = _SnippetConfig.getSingleRect();
+  QRect rMulti = _SnippetConfig.getMultiRect();
+
+  do {
+    iFound = text.find(QRegExp("\\"+del+"[A-Za-z-_0-9\\s]*\\"+del), iEnd+1);  //find the next variable by this QRegExp
+    if (iFound >= 0) {
+      iEnd = text.find(del, iFound+1)+1;
+      strName = text.mid(iFound, iEnd-iFound);
+
+      if ( strName != del+del  ) {  //if not doubel-delimiter
+        if (iInMeth == 0) { //if input-method "single" is selected
+          if ( mapVar[strName].length() <= 0 ) {  // and not already in map
+            strMsg=i18n("Please enter the value for <b>%1</b>:").arg(strName);
+            strNew = showSingleVarDialog( strName, &_mapSaved, rSingle );
+            if (strNew=="")
+              return ""; //user clicked Cancle
+          } else {
+            continue; //we have already handled this variable
+          }
+        } else {
+          strNew = ""; //for inputmode "multi" just reset new valaue
+        }
+      } else {
+        strNew = del; //if double-delimiter -> replace by single character
+      }
+
+      if (iInMeth == 0) {  //if input-method "single" is selected
+        str.replace(strName, strNew);
+      }
+
+      mapVar[strName] = strNew;
+    }
+  } while (iFound != -1);
+
+  if (iInMeth == 1) {  //check config, if input-method "multi" is selected
+    int w, bh, oh;
+    w = rMulti.width();
+    bh = rMulti.height();
+    oh = rMulti.top();
+    if (showMultiVarDialog( &mapVar, &_mapSaved, w, bh, oh )) {  //generate and show the dialog
+      QMap<QString, QString>::Iterator it;
+      for ( it = mapVar.begin(); it != mapVar.end(); ++it ) {  //walk through the map and do the replacement
+        str.replace(it.key(), it.data());
+      }
+    } else {
+      return "";
+    }
+
+    rMulti.setWidth(w);   //this is a hack to save the dialog's dimensions in only one QRect
+    rMulti.setHeight(bh);
+    rMulti.setTop(oh);
+    rMulti.setLeft(0);
+     _SnippetConfig.setMultiRect(rMulti);
+  }
+
+  _SnippetConfig.setSingleRect(rSingle);
+
+  return str;
+}
+
+
+//  fn SnippetWidget::showMultiVarDialog()
+/*!
+    This function constructs a dialog which contains a label and a linedit for every
+    variable that is stored in the given map except the double-delimiter entry
+    It return true if everything was ok and false if the user hit cancel
+ */
+bool SnippetWidget::showMultiVarDialog(QMap<QString, QString> * map, QMap<QString, QString> * mapSave,
+                                       int & iWidth, int & iBasicHeight, int & iOneHeight)
+{
+  //if no var -> no need to show
+  if (map->count() == 0)
+    return true;
+
+  //if only var is the double-delimiter -> no need to show
+  QMap<QString, QString>::Iterator it = map->begin();
+  if ( map->count() == 1 && it.data()==_SnippetConfig.getDelimiter()+_SnippetConfig.getDelimiter() )
+    return true;
+
+  QMap<QString, KTextEdit *> mapVar2Te;  //this map will help keeping track which TEXTEDIT goes with which variable
+  QMap<QString, QCheckBox *> mapVar2Cb;  //this map will help keeping track which CHECKBOX goes with which variable
+
+  // --BEGIN-- building a dynamic dialog
+  QDialog dlg(this);
+  dlg.setCaption(i18n("Enter Values for Variables"));
+
+  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
+  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
+  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
+  QGridLayout * layoutBtn = new QGridLayout( 0, 1, 1, 0, 6, "layoutBtn");
+
+  KTextEdit *te = NULL;
+  QLabel * labTop = NULL;
+  QCheckBox * cb = NULL;
+
+  labTop = new QLabel( &dlg, "label" );
+  labTop->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         labTop->sizePolicy().hasHeightForWidth() ) );
+  labTop->setText(i18n("Enter the replacement values for these variables:"));
+  layoutTop->addWidget(labTop, 0, 0);
+  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
+
+
+  int i = 0;                                           //walk through the variable map and add
+  for ( it = map->begin(); it != map->end(); ++it ) {  //a checkbox, a lable and a lineedit to the main layout
+    if (it.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
+      continue;
+
+    cb = new QCheckBox( &dlg, "cbVar" );
+    cb->setChecked( FALSE );
+    cb->setText(it.key());
+    layoutVar->addWidget( cb, i ,0, Qt::AlignTop );
+
+    te = new KTextEdit( &dlg, "teVar" );
+    layoutVar->addWidget( te, i, 1, Qt::AlignTop );
+
+    if ((*mapSave)[it.key()].length() > 0) {
+      cb->setChecked( TRUE );
+      te->setText((*mapSave)[it.key()]);
+    }
+
+    mapVar2Te[it.key()] = te;
+    mapVar2Cb[it.key()] = cb;
+
+    QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
+    QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
+                              "If you use the same variable later, even in another snippet, the value entered to the right "
+			      "will be the default value for that variable.") );
+
+    i++;
+  }
+  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
+
+  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
+  btn1->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         btn1->sizePolicy().hasHeightForWidth() ) );
+  layoutBtn->addWidget( btn1, 0, 0 );
+
+  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
+  btn2->setDefault( TRUE );
+  btn2->setSizePolicy( QSizePolicy( (QSizePolicy::SizeType)1, (QSizePolicy::SizeType)0, 0, 0,
+                         btn2->sizePolicy().hasHeightForWidth() ) );
+  layoutBtn->addWidget( btn2, 0, 1 );
+
+  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
+  // --END-- building a dynamic dialog
+
+  //connect the buttons to the QDialog default slots
+  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
+  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
+
+  //prepare to execute the dialog
+  bool bReturn = false;
+  //resize the textedits
+  if (iWidth > 1) {
+    QRect r = dlg.geometry();
+    r.setHeight(iBasicHeight + iOneHeight*mapVar2Te.count());
+    r.setWidth(iWidth);
+    dlg.setGeometry(r);
+  }
+  if ( i > 0 && // only if there are any variables
+    dlg.exec() == QDialog::Accepted ) {
+
+    QMap<QString, KTextEdit *>::Iterator it2;
+    for ( it2 = mapVar2Te.begin(); it2 != mapVar2Te.end(); ++it2 ) {
+      if (it2.key() == _SnippetConfig.getDelimiter() + _SnippetConfig.getDelimiter())
+        continue;
+      (*map)[it2.key()] = it2.data()->text();    //copy the entered values back to the given map
+
+      if (mapVar2Cb[it2.key()]->isChecked())     //if the checkbox is on; save the values for later
+        (*mapSave)[it2.key()] = it2.data()->text();
+      else
+        (*mapSave).erase(it2.key());
+    }
+    bReturn = true;
+
+    iBasicHeight = dlg.geometry().height() - layoutVar->geometry().height();
+    iOneHeight = layoutVar->geometry().height() / mapVar2Te.count();
+    iWidth = dlg.geometry().width();
+  }
+
+  //do some cleanup
+  QMap<QString, KTextEdit *>::Iterator it1;
+  for (it1 = mapVar2Te.begin(); it1 != mapVar2Te.end(); ++it1)
+    delete it1.data();
+  mapVar2Te.clear();
+  QMap<QString, QCheckBox *>::Iterator it2;
+  for (it2 = mapVar2Cb.begin(); it2 != mapVar2Cb.end(); ++it2)
+    delete it2.data();
+  mapVar2Cb.clear();
+  delete layoutTop;
+  delete layoutVar;
+  delete layoutBtn;
+  delete layout;
+
+  if (i==0) //if nothing happened this means, that there are no variables to translate
+    return true; //.. so just return OK
+
+  return bReturn;
+//  return true;
+}
+
+
+//  fn SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave)
+/*!
+    This function constructs a dialog which contains a label and a linedit for the given variable
+    It return either the entered value or an empty string if the user hit cancel
+ */
+QString SnippetWidget::showSingleVarDialog(QString var, QMap<QString, QString> * mapSave, QRect & dlgSize)
+{
+  // --BEGIN-- building a dynamic dialog
+  QDialog dlg(this);
+  dlg.setCaption(i18n("Enter Values for Variables"));
+
+  QGridLayout * layout = new QGridLayout( &dlg, 1, 1, 11, 6, "layout");
+  QGridLayout * layoutTop = new QGridLayout( 0, 1, 1, 0, 6, "layoutTop");
+  QGridLayout * layoutVar = new QGridLayout( 0, 1, 1, 0, 6, "layoutVar");
+  QGridLayout * layoutBtn = new QGridLayout( 0, 2, 1, 0, 6, "layoutBtn");
+
+  KTextEdit *te = NULL;
+  QLabel * labTop = NULL;
+  QCheckBox * cb = NULL;
+
+  labTop = new QLabel( &dlg, "label" );
+  layoutTop->addWidget(labTop, 0, 0);
+  labTop->setText(i18n("Enter the replacement values for %1:").arg( var ));
+  layout->addMultiCellLayout( layoutTop, 0, 0, 0, 1 );
+
+
+  cb = new QCheckBox( &dlg, "cbVar" );
+  cb->setChecked( FALSE );
+  cb->setText(i18n( "Make value &default" ));
+
+  te = new KTextEdit( &dlg, "teVar" );
+  layoutVar->addWidget( te, 0, 1, Qt::AlignTop);
+  layoutVar->addWidget( cb, 1, 1, Qt::AlignTop);
+  if ((*mapSave)[var].length() > 0) {
+    cb->setChecked( TRUE );
+    te->setText((*mapSave)[var]);
+  }
+
+  QToolTip::add( cb, i18n("Enable this to save the value entered to the right as the default value for this variable") );
+  QWhatsThis::add( cb, i18n("If you enable this option, the value entered to the right will be saved. "
+                            "If you use the same variable later, even in another snippet, the value entered to the right "
+                            "will be the default value for that variable.") );
+
+  layout->addMultiCellLayout( layoutVar, 1, 1, 0, 1 );
+
+  KPushButton * btn1 = new KPushButton( KStdGuiItem::cancel(), &dlg, "pushButton1" );
+  layoutBtn->addWidget( btn1, 0, 0 );
+
+  KPushButton * btn2 = new KPushButton( KStdGuiItem::apply(), &dlg, "pushButton2" );
+  btn2->setDefault( TRUE );
+  layoutBtn->addWidget( btn2, 0, 1 );
+
+  layout->addMultiCellLayout( layoutBtn, 2, 2, 0, 1 );
+  te->setFocus();
+  // --END-- building a dynamic dialog
+
+  //connect the buttons to the QDialog default slots
+  connect(btn1, SIGNAL(clicked()), &dlg, SLOT(reject()) );
+  connect(btn2, SIGNAL(clicked()), &dlg, SLOT(accept()) );
+
+  //execute the dialog
+  QString strReturn = "";
+  if (dlgSize.isValid())
+    dlg.setGeometry(dlgSize);
+  if ( dlg.exec() == QDialog::Accepted ) {
+    if (cb->isChecked())     //if the checkbox is on; save the values for later
+      (*mapSave)[var] = te->text();
+    else
+      (*mapSave).erase(var);
+
+    strReturn = te->text();    //copy the entered values back the the given map
+
+    dlgSize = dlg.geometry();
+  }
+
+  //do some cleanup
+  delete cb;
+  delete te;
+  delete labTop;
+  delete btn1;
+  delete btn2;
+  delete layoutTop;
+  delete layoutVar;
+  delete layoutBtn;
+  delete layout;
+
+  return strReturn;
+}
+
+//  fn SnippetWidget::acceptDrag (QDropEvent *event) const
+/*!
+    Reimplementation from KListView.
+    Check here if the data the user is about to drop fits our restrictions.
+    We only accept dropps of plaintext, because from the dropped text
+    we will create a snippet.
+ */
+bool SnippetWidget::acceptDrag (QDropEvent *event) const
+{
+  //kdDebug(5006) << "Format: " << event->format() << "" << event->pos() << endl;
+
+  QListViewItem * item = itemAt(event->pos());
+
+  if (item &&
+      QString(event->format()).startsWith("text/plain") &&
+      static_cast<SnippetWidget *>(event->source()) != this) {
+    ///kdDebug(5006) << "returning TRUE " << endl;
+    return TRUE;
+  } else if(item &&
+      QString(event->format()).startsWith("x-kmailsnippet") &&
+      static_cast<SnippetWidget *>(event->source()) != this)
+  {
+    //kdDebug(5006) << "returning TRUE " << endl;
+    return TRUE;
+  } else {
+    //kdDebug(5006) << "returning FALSE" << endl;
+    event->acceptAction(FALSE);
+    return FALSE;
+  }
+}
+
+//  fn SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *after)
+/*!
+    This slot is connected to the dropped signal.
+    If it is emitted, we need to construct a new snippet entry with
+    the data given
+ */
+void SnippetWidget::slotDropped(QDropEvent *e, QListViewItem *)
+{
+  QListViewItem * item2 = itemAt(e->pos());
+
+  SnippetGroup *group = dynamic_cast<SnippetGroup *>(item2);
+  if (!group)
+    group = dynamic_cast<SnippetGroup *>(item2->parent());
+
+  QCString dropped;
+  QByteArray data = e->encodedData("text/plain");
+  if ( e->provides("text/plain") && data.size()>0 ) {
+    //get the data from the event...
+    QString encData(data.data());
+    //kdDebug(5006) << "encData: " << encData << endl;
+
+    //... then fill the dialog with the given data
+    SnippetDlg dlg( mActionCollection, this, "SnippetDlg" );
+    dlg.snippetName->clear();
+    dlg.snippetText->setText(encData);
+
+    /*fill the combobox with the names of all SnippetGroup entries*/
+    for (SnippetItem *it=_list.first(); it; it=_list.next()) {
+      if (dynamic_cast<SnippetGroup*>(it)) {
+        dlg.cbGroup->insertItem(it->getName());
+      }
+    }
+    dlg.cbGroup->setCurrentText(group->getName());
+
+    if (dlg.exec() == QDialog::Accepted) {
+      /* get the group that the user selected with the combobox */
+      group = dynamic_cast<SnippetGroup*>(SnippetItem::findItemByName(dlg.cbGroup->currentText(), _list));
+      _list.append( makeItem(group, dlg.snippetName->text(), dlg.snippetText->text(), dlg.keyButton->shortcut() ) );
+    }
+  }
+}
+
+void SnippetWidget::startDrag()
+{
+    QString text = dynamic_cast<SnippetItem*>( currentItem() )->getText();
+    QTextDrag *drag = new QTextDrag(text, this);
+    drag->setSubtype("x-textsnippet");
+    drag->drag();
+}
+
+void SnippetWidget::slotExecute()
+{
+    slotExecuted(currentItem());
+}
+
+
+#include "snippet_widget.moc"
+
Index: kmail/kmfiltermgr.h
===================================================================
--- kmail/kmfiltermgr.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfiltermgr.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,7 +50,7 @@
 
   /** Store filter rules in config file. */
   void writeConfig(bool withSync=TRUE);
-
+  
   /** Open an edit dialog. If checkForEmptyFilterList is true, an empty filter
       is created to improve the visibility of the dialog in case no filter
       has been defined so far. */
Index: kmail/partmetadata.h
===================================================================
--- kmail/partmetadata.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/partmetadata.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -17,33 +17,28 @@
 #ifndef _KMAIL_PARTMETADATA_H_
 #define _KMAIL_PARTMETADATA_H_
 
-#include <cryptplugwrapper.h>
+#include <gpgmepp/verificationresult.h>
 
 #include <kpgp.h>
 #include <qstring.h>
 #include <qcstring.h>
-#include <time.h>
+#include <qdatetime.h>
 
 namespace KMail {
 
   class PartMetaData {
   public:
     PartMetaData()
-      : isSigned( false ),
+      : sigSummary( GpgME::Signature::None ),
+        isSigned( false ),
         isGoodSignature( false ),
-        sigStatusFlags( CryptPlugWrapper::SigStatus_UNKNOWN ),
         isEncrypted( false ),
         isDecryptable( false ),
         technicalProblem( false ),
         isEncapsulatedRfc822Message( false )
     {
-      creationTime.tm_year = 0;
-      creationTime.tm_mon  = 1;
-      creationTime.tm_mday = 1;
     }
-    bool isSigned;
-    bool isGoodSignature;
-    CryptPlugWrapper::SigStatusFlags sigStatusFlags;
+    GpgME::Signature::Summary sigSummary;
     QString signClass;
     QString signer;
     QStringList signerMailAddresses;
@@ -52,12 +47,15 @@
     QString status;  // to be used for unknown plug-ins
     int status_code; // to be used for i18n of OpenPGP and S/MIME CryptPlugs
     QString errorText;
-    tm creationTime;
-    bool isEncrypted;
-    bool isDecryptable;
+    QDateTime creationTime;
     QString decryptionError;
-    bool technicalProblem;
-    bool isEncapsulatedRfc822Message;
+    QString auditLog;
+    bool isSigned : 1;
+    bool isGoodSignature : 1;
+    bool isEncrypted : 1;
+    bool isDecryptable : 1;
+    bool technicalProblem : 1;
+    bool isEncapsulatedRfc822Message : 1;
   };
 
 } // namespace KMail
Index: kmail/messagecopyhelper.cpp
===================================================================
--- kmail/messagecopyhelper.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/messagecopyhelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -44,7 +44,7 @@
     if ( f == dest )
       continue; // already there
     if ( !mOpenFolders.contains( f ) ) {// not yet opened
-      f->open("messagecopyhelper");
+      f->open( "messagecopyhelper" );
       mOpenFolders.insert( f, 0 );
     }
     KMMsgBase *msgBase = f->getMsgBase( index );
@@ -73,7 +73,7 @@
   // close all folders we opened
   for ( QMap<QGuardedPtr<KMFolder>, int>::ConstIterator it = mOpenFolders.constBegin();
         it != mOpenFolders.constEnd(); ++it ) {
-    it.key()->close("messagecopyhelper");
+    it.key()->close( "messagecopyhelper" );
   }
   mOpenFolders.clear();
   deleteLater();
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,6 +14,8 @@
 #include "composer.h"
 #include "messagesender.h"
 
+#include <set>
+
 #include <qlabel.h>
 #include <qlistview.h>
 
@@ -75,6 +77,7 @@
 class KMLineEdit;
 class KMLineEditSpell;
 class KMAtmListViewItem;
+class SnippetWidget;
 
 namespace KPIM {
   class IdentityCombo;
@@ -84,6 +87,7 @@
 namespace KMail {
   class AttachmentListView;
   class DictionaryComboBox;
+  class EditorWatcher;
 }
 
 namespace GpgME {
@@ -154,6 +158,8 @@
    void setMsg(KMMessage* newMsg, bool mayAutoSign=TRUE,
 	       bool allowDecryption=FALSE, bool isModified=FALSE);
 
+   void disableWordWrap();
+
 private: // kmedit
   /**
    * Returns message of the composer. To apply the user changes to the
@@ -238,6 +244,7 @@
   }
   bool subjectTextWasSpellChecked() const { return mSubjectTextWasSpellChecked; }
 
+  void paste( QClipboard::Mode mode );
 
 public: // callback
   /** Disabled signing and encryption completely for this composer window. */
@@ -281,9 +288,9 @@
   void slotRedo();
   void slotCut();
   void slotCopy();
-  void slotPaste();
-  void slotPasteAsQuotation();
-  void slotPasteAsAttachment();
+  void slotPasteClipboard();
+  void slotPasteClipboardAsQuotation();
+  void slotPasteClipboardAsAttachment();
   void slotAddQuotes();
   void slotRemoveQuotes();
   void slotAttachPNGImageData(const QByteArray &image);
@@ -292,6 +299,8 @@
 
   void slotFolderRemoved(KMFolder*);
 
+  void slotEditDone( KMail::EditorWatcher* watcher );
+
 public slots: // kmkernel
   /**
      Tell the composer to always send the message, even if the user
@@ -369,6 +378,16 @@
   void slotAppendSignature();
 
   /**
+   * Prepend signature file at the beginning of the text in the editor.
+   */
+  void slotPrependSignature();
+
+  /**
+   * Insert signature file at the cursor position of the text in the editor.
+   */
+  void slotInsertSignatureAtCursor();
+
+  /**
    * Attach sender's public key.
    */
   void slotInsertMyPublicKey();
@@ -403,6 +422,9 @@
   void slotAttachSave();
   void slotAttachProperties();
   void slotAttachOpenWith();
+  void slotAttachEdit();
+  void slotAttachEditWith();
+  void slotAttachmentDragStarted();
 
   /**
    * Select an email from the addressbook and add it to the line
@@ -555,6 +577,11 @@
   void viewAttach( int index );
 
   /**
+    Edit the attachment with the given index.
+  */
+  void editAttach( int index, bool openWith );
+
+  /**
    * Remove an attachment from the list.
    */
    void removeAttach(const QString &url);
@@ -663,6 +690,11 @@
    */
   void setTransport( const QString & transport );
 
+  /**
+   * Helper to insert the signature of the current identy at the
+   * beginning or end of the editor.
+   */
+  void insertSignature( bool append = true, int pos = 0 );
 private slots:
    /**
     * Compress an attachemnt with the given index
@@ -670,6 +702,8 @@
     void compressAttach(int idx);
     void uncompressAttach(int idx);
     void editorFocusChanged(bool gained);
+    void recipientEditorSizeHintChanged();
+    void setMaximumHeaderSize();
 
 private:
   QWidget   *mMainWidget;
@@ -702,7 +736,7 @@
   QPtrList<QListViewItem> mAtmItemList;
   QPtrList<KMMessagePart> mAtmList;
   QPopupMenu *mAttachMenu;
-  int mOpenId, mOpenWithId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
+  int mOpenId, mOpenWithId, mViewId, mRemoveId, mSaveAsId, mPropertiesId, mEditId, mEditWithId;
   bool mAutoDeleteMsg;
   bool mSigningAndEncryptionExplicitlyDisabled;
   bool mLastSignActionState, mLastEncryptActionState;
@@ -725,13 +759,15 @@
           *mPasteQuotation, *mAddQuoteChars, *mRemQuoteChars;
   KRecentFilesAction *mRecentAction;
 
+  KAction *mAppendSignatureAction, *mPrependSignatureAction, *mInsertSignatureAction;
+
   KToggleAction *mSignAction, *mEncryptAction, *mRequestMDNAction;
   KToggleAction *mUrgentAction, *mAllFieldsAction, *mFromAction;
   KToggleAction *mReplyToAction, *mToAction, *mCcAction, *mBccAction;
   KToggleAction *mSubjectAction;
   KToggleAction *mIdentityAction, *mTransportAction, *mFccAction;
   KToggleAction *mWordWrapAction, *mFixedFontAction, *mAutoSpellCheckingAction;
-  KToggleAction *mDictionaryAction;
+  KToggleAction *mDictionaryAction, *mSnippetAction;
 
   KSelectAction *listAction;
   KFontAction *fontAction;
@@ -795,10 +831,22 @@
    */
   void slotAutoSpellCheckingToggled(bool);
 
+  /**
+   *  Updates signature actions when identity changes.
+   */
+  void slotUpdateSignatureActions();
+
+  /**
+   * Updates the visibility and text of the signature and encryption state indicators.
+   */
+  void slotUpdateSignatureAndEncrypionStateIndicators();
 private:
   QColor mForeColor,mBackColor;
   QFont mSaveFont;
+  QSplitter *mHeadersToEditorSplitter;
+  QWidget* mHeadersArea;
   QSplitter *mSplitter;
+  QSplitter *mSnippetSplitter;
   struct atmLoadData
   {
     KURL url;
@@ -840,6 +888,15 @@
   QPopupMenu *mActNowMenu;
   QPopupMenu *mActLaterMenu;
 
+  QMap<KMail::EditorWatcher*, KMMessagePart*> mEditorMap;
+  QMap<KMail::EditorWatcher*, KTempFile*> mEditorTempFiles;
+
+  QLabel *mSignatureStateIndicator;
+  QLabel *mEncryptionStateIndicator;
+
+  SnippetWidget *mSnippetWidget;
+  std::set<KTempDir*> mTempDirs;
+
   /** If the message in this composer has a cursor position set (for
    *   instance because it comes from a template containing %CURSOR)
    *   then we need to preserve that cursor position even when auto-
Index: kmail/recipientseditor.h
===================================================================
--- kmail/recipientseditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/recipientseditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -148,6 +148,7 @@
 
   protected:
     void keyPressEvent( QKeyEvent * );
+    RecipientLineEdit* lineEdit() const { return mEdit; }
 
   protected slots:
     void slotReturnPressed();
@@ -220,6 +221,7 @@
     void focusDown();
     void focusRight();
     void completionModeChanged( KGlobalSettings::Completion );
+    void sizeHintChanged();
 
   protected:
     void viewportResizeEvent( QResizeEvent * );
@@ -233,6 +235,7 @@
     void slotDeleteLine();
     void calculateTotal();
     void slotTypeModified( RecipientLine * );
+    void moveCompletionPopup();
 
   private:
     QPtrList<RecipientLine> mLines;
@@ -349,6 +352,7 @@
     void focusUp();
     void focusDown();
     void completionModeChanged( KGlobalSettings::Completion );
+    void sizeHintChanged();
 
   protected slots:
     void slotPickedRecipient( const Recipient & );
Index: kmail/kmfiltermgr.cpp
===================================================================
--- kmail/kmfiltermgr.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfiltermgr.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,8 @@
 using KMail::FilterLog;
 #include "kmfilterdlg.h"
 #include "kmfolderindex.h"
+#include "filterimporterexporter.h"
+using KMail::FilterImporterExporter;
 #include "kmfoldermgr.h"
 #include "kmmsgdict.h"
 #include "messageproperty.h"
@@ -68,76 +70,29 @@
 void KMFilterMgr::readConfig(void)
 {
   KConfig* config = KMKernel::config();
-  int numFilters;
-  QString grpName;
-
   clear();
-
-  KConfigGroupSaver saver(config, "General");
-
+  
   if (bPopFilter) {
-    numFilters = config->readNumEntry("popfilters",0);
+    KConfigGroupSaver saver(config, "General");
     mShowLater = config->readNumEntry("popshowDLmsgs",0);
-  } else {
-    numFilters = config->readNumEntry("filters",0);
-  }
-
-  for ( int i=0 ; i < numFilters ; ++i ) {
-    grpName.sprintf("%s #%d", (bPopFilter ? "PopFilter" : "Filter") , i);
-    KConfigGroupSaver saver(config, grpName);
-    KMFilter * filter = new KMFilter(config, bPopFilter);
-    filter->purify();
-    if ( filter->isEmpty() ) {
-#ifndef NDEBUG
-      kdDebug(5006) << "KMFilter::readConfig: filter\n" << filter->asString()
-		<< "is empty!" << endl;
-#endif
-      delete filter;
-    } else
-      mFilters.append(filter);
-  }
+  } 
+  mFilters = FilterImporterExporter::readFiltersFromConfig( config, bPopFilter );
 }
 
-
 //-----------------------------------------------------------------------------
 void KMFilterMgr::writeConfig(bool withSync)
 {
   KConfig* config = KMKernel::config();
 
-  // first, delete all groups:
-  QStringList filterGroups =
-    config->groupList().grep( QRegExp( bPopFilter ? "PopFilter #\\d+" : "Filter #\\d+" ) );
-  for ( QStringList::Iterator it = filterGroups.begin() ;
-        it != filterGroups.end() ; ++it )
-    config->deleteGroup( *it );
-
-  // Now, write out the new stuff:
-  int i = 0;
-  QString grpName;
-  for ( QValueListConstIterator<KMFilter*> it = mFilters.constBegin() ;
-        it != mFilters.constEnd() ; ++it ) {
-    if ( !(*it)->isEmpty() ) {
-      if ( bPopFilter )
-        grpName.sprintf("PopFilter #%d", i);
-      else
-        grpName.sprintf("Filter #%d", i);
-      KConfigGroupSaver saver(config, grpName);
-      (*it)->writeConfig(config);
-      ++i;
-    }
-  }
-
+  // Now, write out the new stuff:  
+  FilterImporterExporter::writeFiltersToConfig( mFilters, config, bPopFilter );
   KConfigGroupSaver saver(config, "General");
-  if (bPopFilter) {
-    config->writeEntry("popfilters", i);
-    config->writeEntry("popshowDLmsgs", mShowLater);
-  } else
-    config->writeEntry("filters", i);
+  if (bPopFilter)
+      config->writeEntry("popshowDLmsgs", mShowLater);
 
   if (withSync) config->sync();
 }
 
-
 int KMFilterMgr::processPop( KMMessage * msg ) const {
   for ( QValueListConstIterator<KMFilter*> it = mFilters.constBegin();
         it != mFilters.constEnd() ; ++it )
@@ -237,9 +192,7 @@
     if ( !folder || ( idx == -1 ) || ( idx >= folder->count() ) ) {
       return 1;
     }
-    bool opened = folder->isOpened();
-    if ( !opened )
-      folder->open("filtermgr");
+    KMFolderOpener openFolder(folder, "filtermgr");
     KMMsgBase *msgBase = folder->getMsgBase( idx );
     bool unGet = !msgBase->isMessage();
     KMMessage *msg = folder->getMsg( idx );
@@ -247,15 +200,11 @@
     if ( !msg || !beginFiltering( msg ) ) {
       if ( unGet )
         folder->unGetMsg( idx );
-      if ( !opened )
-        folder->close("filtermgr");
       return 1;
     }
     if ( filter->execActions( msg, stopIt ) == KMFilter::CriticalError ) {
       if ( unGet )
         folder->unGetMsg( idx );
-      if ( !opened )
-        folder->close("filtermgr");
       return 2;
     }
 
@@ -270,8 +219,6 @@
     }
     if ( unGet )
       folder->unGetMsg( idx );
-    if ( !opened )
-      folder->close("filtermgr");
   } else {
     result = 1;
   }
@@ -515,8 +462,11 @@
 
 void KMFilterMgr::setFilters( const QValueList<KMFilter*> &filters )
 {
+  beginUpdate();
   clear();
   mFilters = filters;
+  writeConfig( true );
+  endUpdate();
 }
 
 void KMFilterMgr::slotFolderRemoved( KMFolder * aFolder )
Index: kmail/folderviewtooltip.h
===================================================================
--- kmail/folderviewtooltip.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/folderviewtooltip.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,55 @@
+#ifndef __FOLDERVIEWTOOLTIP_H__
+#define __FOLDERVIEWTOOLTIP_H__
+
+#include <kmfoldercachedimap.h>
+
+#include <qtooltip.h>
+
+namespace KMail {
+
+class FolderViewToolTip : public QToolTip
+{
+  public:
+    FolderViewToolTip( QListView* parent ) :
+      QToolTip( parent->viewport() ),
+      mListView( parent ) {}
+
+  protected:
+    void maybeTip( const QPoint &point )
+    {
+      KMFolderTreeItem *item = dynamic_cast<KMFolderTreeItem*>( mListView->itemAt( point ) );
+      if  ( !item )
+        return;
+      const QRect itemRect = mListView->itemRect( item );
+      if ( !itemRect.isValid() )
+        return;
+      const QRect headerRect = mListView->header()->sectionRect( 0 );
+      if ( !headerRect.isValid() )
+        return;
+      
+      if ( !item->folder() || item->folder()->noContent() )
+        return;
+      
+      item->updateCount();
+      QString tipText = i18n("<qt><b>%1</b><br>Total: %2<br>Unread: %3<br>Size: %4" )
+          .arg( item->folder()->prettyURL().replace( " ", "&nbsp;" ) )
+          .arg( item->totalCount() < 0 ? "-" : QString::number( item->totalCount() ) )
+          .arg( item->unreadCount() < 0 ? "-" : QString::number( item->unreadCount() ) )
+          .arg( KIO::convertSize( item->folderSize() ) );
+      
+      if ( KMFolderCachedImap* imap = dynamic_cast<KMFolderCachedImap*>( item->folder()->storage() ) ) {
+          QuotaInfo info = imap->quotaInfo();
+          if ( info.isValid() && !info.isEmpty() )
+              tipText += i18n("<br>Quota: %1").arg( info.toString() );
+      }
+      
+      tip( QRect( headerRect.left(), itemRect.top(), headerRect.width(), itemRect.height() ), tipText );
+    }
+
+  private:
+    QListView *mListView;
+};
+
+}
+
+#endif /* __FOLDERVIEWTOOLTIP_H__ */
Index: kmail/foldertreebase.h
===================================================================
--- kmail/foldertreebase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/foldertreebase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,95 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KMAIL_FOLDERTREEBASE_H
+#define KMAIL_FOLDERTREEBASE_H
+
+#include <libkdepim/kfoldertree.h>
+
+class KMFolder;
+class KMMainWidget;
+
+namespace KMail {
+
+class FolderTreeBase : public KFolderTree
+{
+  Q_OBJECT
+  public:
+    FolderTreeBase( KMMainWidget *mainWidget, QWidget *parent = 0, const char *name = 0 );
+
+    /** Returns the main widget that this widget is a child of. */
+    KMMainWidget* mainWidget() const { return mMainWidget; }
+
+    /** Find index of given folder. Returns 0 if not found */
+    virtual QListViewItem* indexOfFolder( const KMFolder* folder ) const
+    {
+       if ( mFolderToItem.contains( folder ) )
+         return mFolderToItem[ folder ];
+       else
+         return 0;
+    }
+    
+    void insertIntoFolderToItemMap( const KMFolder *folder, QListViewItem* item )
+    {
+      mFolderToItem.insert( folder, item );
+    }
+
+    void removeFromFolderToItemMap( const KMFolder *folder )
+    {
+      mFolderToItem.remove( folder );
+    }
+        
+  signals:
+    /** Messages have been dropped onto a folder */
+    void folderDrop(KMFolder*);
+
+    /** Messages have been dropped onto a folder with Ctrl */
+    void folderDropCopy(KMFolder*);
+    
+    void triggerRefresh();
+    
+  public slots:
+    /** Update the total and unread columns (if available, or if forced) */
+    void slotUpdateCounts(KMFolder * folder, bool force = false );
+
+  protected:
+    enum {
+      DRAG_COPY = 0,
+      DRAG_MOVE = 1,
+      DRAG_CANCEL = 2
+    };
+    int dndMode( bool alwaysAsk = false );
+    void contentsDropEvent( QDropEvent *e );
+
+    /** Catch palette changes */
+    virtual bool event(QEvent *e);
+
+    /** Read color options and set palette. */
+    virtual void readColorConfig();
+
+    /** Checks if the local inbox should be hidden. */
+    bool hideLocalInbox() const;
+    
+  protected:
+    KMMainWidget *mMainWidget;
+    QMap<const KMFolder*, QListViewItem*> mFolderToItem;
+};
+
+}
+
+#endif
Index: kmail/kmcommands.h
===================================================================
--- kmail/kmcommands.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmcommands.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -3,20 +3,25 @@
 #ifndef KMCommands_h
 #define KMCommands_h
 
+#include <qdatetime.h>
 #include <qguardedptr.h>
 #include <qptrlist.h>
 #include <qvaluelist.h>
 #include <qvaluevector.h>
+#include <qtimer.h>
+#include <qfont.h>
 #include <kio/job.h>
 #include "kmmsgbase.h" // for KMMsgStatus
 #include <mimelib/string.h>
 #include <kdepimmacros.h>
 #include <kservice.h>
+#include <ktempfile.h>
 
 class QPopupMenu;
 class KMainWindow;
 class KAction;
 class KProgressDialog;
+class KProcess;
 class KMFilter;
 class KMFolder;
 class KMFolderImap;
@@ -31,6 +36,7 @@
 namespace KMail {
   class Composer;
   class FolderJob;
+  class EditorWatcher;
 }
 namespace GpgME { class Error; }
 namespace Kleo { class SpecialJob; }
@@ -598,12 +604,15 @@
                   bool useFixedFont = false,
                   const QString & encoding = QString() );
 
+  void setOverrideFont( const QFont& );
+
 private:
   virtual Result execute();
 
   bool mHtmlOverride;
   bool mHtmlLoadExtOverride;
   bool mUseFixedFont;
+  QFont mOverrideFont;
   QString mEncoding;
 };
 
@@ -1011,11 +1020,78 @@
   partNode* mNode;
   KMMessage* mMsg;
   int mAtmId;
-  const QString& mAtmName;
+  QString mAtmName;
   AttachmentAction mAction;
   KService::Ptr mOffer;
   Kleo::SpecialJob *mJob;
 
 };
 
+
+/** Base class for commands modifying attachements of existing messages. */
+class KDE_EXPORT AttachmentModifyCommand : public KMCommand
+{
+  Q_OBJECT
+  public:
+    AttachmentModifyCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    ~AttachmentModifyCommand();
+
+  protected:
+    void storeChangedMessage( KMMessage* msg );
+    virtual Result doAttachmentModify() = 0;
+
+  protected:
+    int mPartIndex;
+    Q_UINT32 mSernum;
+
+  private:
+    Result execute();
+
+  private slots:
+    void messageStoreResult( KMFolderImap* folder, bool success );
+    void messageDeleteResult( KMCommand *cmd );
+
+  private:
+    QGuardedPtr<KMFolder> mFolder;
+};
+
+class KDE_EXPORT KMDeleteAttachmentCommand : public AttachmentModifyCommand
+{
+  Q_OBJECT
+  public:
+    KMDeleteAttachmentCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    ~KMDeleteAttachmentCommand();
+
+  protected:
+    Result doAttachmentModify();
+};
+
+
+class KDE_EXPORT KMEditAttachmentCommand : public AttachmentModifyCommand
+{
+  Q_OBJECT
+  public:
+    KMEditAttachmentCommand( partNode *node, KMMessage *msg, QWidget *parent );
+    ~KMEditAttachmentCommand();
+
+  protected:
+    Result doAttachmentModify();
+
+  private slots:
+    void editDone( KMail::EditorWatcher *watcher );
+
+  private:
+    KTempFile mTempFile;
+};
+
+class KDE_EXPORT CreateTodoCommand : public KMCommand
+{
+  Q_OBJECT
+  public:
+    CreateTodoCommand( QWidget *parent, KMMessage *msg );
+
+  private:
+    Result execute();
+};
+
 #endif /*KMCommands_h*/
Index: kmail/kmsearchpatternedit.cpp
===================================================================
--- kmail/kmsearchpatternedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmsearchpatternedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,13 +31,13 @@
   const char *internalName;
   const char *displayName;
 } SpecialRuleFields[] = {
-  { "<message>",     I18N_NOOP( "<message>" )       },
-  { "<body>",        I18N_NOOP( "<body>" )          },
-  { "<any header>",  I18N_NOOP( "<any header>" )    },
-  { "<recipients>",  I18N_NOOP( "<recipients>" )    },
-  { "<size>",        I18N_NOOP( "<size in bytes>" ) },
-  { "<age in days>", I18N_NOOP( "<age in days>" )   },
-  { "<status>",      I18N_NOOP( "<status>" )        }
+  { "<message>",     I18N_NOOP( "Complete Message" )       },
+  { "<body>",        I18N_NOOP( "Body of Message" )          },
+  { "<any header>",  I18N_NOOP( "Anywhere in Headers" )    },
+  { "<recipients>",  I18N_NOOP( "All Recipients" )    },
+  { "<size>",        I18N_NOOP( "Size in Bytes" ) },
+  { "<age in days>", I18N_NOOP( "Age in Days" )   },
+  { "<status>",      I18N_NOOP( "Message Status" )        }
 };
 static const int SpecialRuleFieldsCount =
   sizeof( SpecialRuleFields ) / sizeof( *SpecialRuleFields );
@@ -72,14 +72,14 @@
   QCString currentText = srule->field();
   delete srule;
   initFieldList( headersOnly, mAbsoluteDates );
-  
+
   mRuleField->clear();
   mRuleField->insertStringList( mFilterFieldList );
   mRuleField->setSizeLimit( mRuleField->count() );
   mRuleField->adjustSize();
 
-  if ((currentText != "<message>") &&
-      (currentText != "<body>"))
+  if (( currentText != "<message>") &&
+      ( currentText != "<body>"))
     mRuleField->changeItem( QString::fromAscii( currentText ), 0 );
   else
     mRuleField->changeItem( QString::null, 0 );
@@ -128,8 +128,8 @@
 {
   assert ( aRule );
 
-  //kdDebug(5006) << "KMSearchRuleWidget::setRule( "
-  //              << aRule->asString() << " )" << endl;
+//  kdDebug(5006) << "KMSearchRuleWidget::setRule( "
+//                << aRule->asString() << " )" << endl;
 
   //--------------set the field
   int i = indexOfRuleField( aRule->field() );
@@ -208,12 +208,23 @@
   return -1; // no pseudo header
 }
 
+static QString displayNameFromInternalName( const QString & internal )
+{
+  for ( int i = 0; i < SpecialRuleFieldsCount; ++i ) {
+    if ( internal == SpecialRuleFields[i].internalName )
+      return i18n(SpecialRuleFields[i].displayName);
+  }
+  return internal.latin1();
+}
+
+
+
 int KMSearchRuleWidget::indexOfRuleField( const QCString & aName ) const
 {
   if ( aName.isEmpty() )
     return -1;
 
-  QString i18n_aName = i18n( aName );
+  QString i18n_aName = displayNameFromInternalName( aName );
 
   for ( int i = 1; i < mRuleField->count(); ++i ) {
     if ( mRuleField->text( i ) == i18n_aName )
@@ -281,17 +292,17 @@
 {
   assert ( aList );
 
-  if ( mRuleList )
+  if ( mRuleList && mRuleList != aList )
     regenerateRuleListFromWidgets();
 
   mRuleList = aList;
 
   if ( mWidgetList.first() ) // move this below next 'if'?
-    mWidgetList.first()->blockSignals(TRUE);
+    mWidgetList.first()->blockSignals(true);
 
   if ( aList->count() == 0 ) {
     slotClear();
-    mWidgetList.first()->blockSignals(FALSE);
+    mWidgetList.first()->blockSignals(false);
     return;
   }
 
@@ -314,13 +325,13 @@
   QPtrListIterator<QWidget> wIt( mWidgetList );
   for ( rIt.toFirst(), wIt.toFirst() ;
 	rIt.current() && wIt.current() ; ++rIt, ++wIt ) {
-    (static_cast<KMSearchRuleWidget*>(*wIt))->setRule( (*rIt) );
+    static_cast<KMSearchRuleWidget*>(*wIt)->setRule( (*rIt) );
   }
   for ( ; wIt.current() ; ++wIt )
     ((KMSearchRuleWidget*)(*wIt))->reset();
 
   assert( mWidgetList.first() );
-  mWidgetList.first()->blockSignals(FALSE);
+  mWidgetList.first()->blockSignals(false);
 }
 
 void KMSearchRuleWidgetLister::setHeadersOnly( bool headersOnly )
@@ -397,8 +408,8 @@
   mAllRBtn = new QRadioButton( i18n("Match a&ll of the following"), this, "mAllRBtn" );
   mAnyRBtn = new QRadioButton( i18n("Match an&y of the following"), this, "mAnyRBtn" );
 
-  mAllRBtn->setChecked(TRUE);
-  mAnyRBtn->setChecked(FALSE);
+  mAllRBtn->setChecked(true);
+  mAnyRBtn->setChecked(false);
 
   QButtonGroup *bg = new QButtonGroup( this );
   bg->hide();
@@ -431,14 +442,14 @@
 
   mPattern = aPattern;
 
-  blockSignals(TRUE);
+  blockSignals(true);
   if ( mPattern->op() == KMSearchPattern::OpOr )
-    mAnyRBtn->setChecked(TRUE);
+    mAnyRBtn->setChecked(true);
   else
-    mAllRBtn->setChecked(TRUE);
-  blockSignals(FALSE);
+    mAllRBtn->setChecked(true);
+  blockSignals(false);
 
-  setEnabled( TRUE );
+  setEnabled( true );
 }
 
 void KMSearchPatternEdit::setHeadersOnly( bool headersOnly )
@@ -450,11 +461,11 @@
 {
   mRuleLister->reset();
 
-  blockSignals(TRUE);
-  mAllRBtn->setChecked( TRUE );
-  blockSignals(FALSE);
+  blockSignals(true);
+  mAllRBtn->setChecked( true );
+  blockSignals(false);
 
-  setEnabled( FALSE );
+  setEnabled( false );
 }
 
 void KMSearchPatternEdit::slotRadioClicked(int aIdx)
Index: kmail/imapaccountbase.h
===================================================================
--- kmail/imapaccountbase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/imapaccountbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -101,16 +101,16 @@
     virtual void readConfig( KConfig& config );
     virtual void writeConfig( KConfig& config );
 
-    /** 
+    /**
      * The state of the kioslave connection
      */
     enum ConnectionState { Error = 0, Connected, Connecting };
 
     // possible list types
-    enum ListType { 
-      List, 
-      ListSubscribed, 
-      ListSubscribedNoCheck, 
+    enum ListType {
+      List,
+      ListSubscribed,
+      ListSubscribedNoCheck,
       ListFolderOnly,
       ListFolderOnlySubscribed
     };
@@ -141,25 +141,22 @@
     struct jobData
     {
       // Needed by QMap, don't use
-      jobData() : url(QString::null), parent(0), total(1), done(0), offset(0), progressItem(0),
+      jobData() : url(QString::null), parent(0), current(0), total(1), done(0), offset(0), progressItem(0),
                   onlySubscribed(false), quiet(false), cancellable(false) {}
       // Real constructor
       jobData( const QString& _url, KMFolder *_parent = 0,
           int _total = 1, int _done = 0, bool _quiet = false,
           bool _cancelable = false )
-        : url(_url), parent(_parent), total(_total), done(_done), offset(0),
+        : url(_url), parent(_parent), current(0), total(_total), done(_done), offset(0),
           progressItem(0), quiet(_quiet), cancellable(_cancelable) {}
 
-      // Return "url" in a form that can be displayed in HTML (w/o password)
-      QString htmlURL() const;
-
       QString path;
       QString url;
       QString curNamespace;
       QByteArray data;
       QCString cdata;
       QStringList items;
-      KMFolder *parent;
+      KMFolder *parent, *current;
       QPtrList<KMMessage> msgList;
       int total, done, offset;
       KPIM::ProgressItem *progressItem;
@@ -339,21 +336,21 @@
      */
     virtual unsigned int folderCount() const;
 
-    /** 
-     * @return defined namespaces 
+    /**
+     * @return defined namespaces
      */
     nsMap namespaces() const { return mNamespaces; }
 
     /**
      * Set defined namespaces
-     */ 
-    virtual void setNamespaces( nsMap map ) 
+     */
+    virtual void setNamespaces( nsMap map )
     { mNamespaces = map; }
 
     /**
      * Full blown section - namespace - delimiter map
      * Do not call this very often as the map is constructed on the fly
-     */ 
+     */
     nsDelimMap namespacesWithDelimiter();
 
     /**
@@ -386,11 +383,11 @@
       * Set the namespace - delimiter map
       */
      void setNamespaceToDelimiter( namespaceDelim map )
-     { mNamespaceToDelimiter = map; } 
+     { mNamespaceToDelimiter = map; }
 
      /**
       * Returns true if the given string is a namespace
-      */ 
+      */
      bool isNamespaceFolder( QString& name );
 
      /**
@@ -402,7 +399,7 @@
      /**
       * Create an IMAP path for a parent folder and a foldername
       * Parent and folder are separated with the delimiter of the account
-      * The path starts and ends with '/' 
+      * The path starts and ends with '/'
       */
      QString createImapPath( FolderStorage* parent, const QString& folderName );
 
@@ -416,7 +413,7 @@
     /**
      * Call this to get the namespaces
      * You are notified by the signal namespacesFetched
-     */ 
+     */
     void getNamespaces();
 
   private slots:
@@ -472,11 +469,11 @@
 
     /**
      * Saves the fetched namespaces
-     */ 
+     */
     void slotSaveNamespaces( const ImapAccountBase::nsDelimMap& map );
 
-    /** 
-     * Saves the capabilities list 
+    /**
+     * Saves the capabilities list
      */
     void slotCapabilitiesResult( KIO::Job*, const QString& result );
 
@@ -518,6 +515,7 @@
     // used for writing the blacklist out to the config file
     QStringList locallyBlacklistedFolders() const;
     void localBlacklistFromStringList( const QStringList & );
+    QString prettifyQuotaError( const QString& _error, KIO::Job * job );
 
   protected:
     QPtrList<QGuardedPtr<KMFolder> > mOpenFolders;
Index: kmail/vacation.cpp
===================================================================
--- kmail/vacation.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/vacation.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,9 +23,12 @@
 #include "sievejob.h"
 using KMail::SieveJob;
 #include "kmkernel.h"
+#include "kmmainwidget.h"
 #include "accountmanager.h"
 using KMail::AccountManager;
 #include "kmacctimap.h"
+#include "kmmessage.h"
+#include "globalsettings.h"
 #include <libkpimidentities/identitymanager.h>
 #include <libkpimidentities/identity.h>
 
@@ -43,9 +46,272 @@
 #include <qdatetime.h>
 
 #include <cassert>
+#include <vector>
+#include <map>
+#include <set>
 
+namespace KSieveExt {
+
+  class MultiScriptBuilder : public KSieve::ScriptBuilder {
+    std::vector<KSieve::ScriptBuilder*> mBuilders;
+  public:
+    MultiScriptBuilder() : KSieve::ScriptBuilder() {}
+    MultiScriptBuilder( KSieve::ScriptBuilder * sb1 )
+      : KSieve::ScriptBuilder(), mBuilders( 1 )
+    {
+      mBuilders[0] = sb1;
+      assert( sb1 );
+    }
+    MultiScriptBuilder( KSieve::ScriptBuilder * sb1,
+                        KSieve::ScriptBuilder * sb2 )
+      : KSieve::ScriptBuilder(), mBuilders( 2 )
+    {
+      mBuilders[0] = sb1;
+      mBuilders[1] = sb2;
+      assert( sb1 ); assert( sb2 );
+    }
+    MultiScriptBuilder( KSieve::ScriptBuilder * sb1,
+                        KSieve::ScriptBuilder * sb2,
+                        KSieve::ScriptBuilder * sb3 )
+      : KSieve::ScriptBuilder(), mBuilders( 3 )
+    {
+      mBuilders[0] = sb1;
+      mBuilders[1] = sb2;
+      mBuilders[2] = sb3;
+      assert( sb1 ); assert( sb2 ); assert( sb3 );
+    }
+    ~MultiScriptBuilder() {}
+  private:
+#ifdef FOREACH
+#undef FOREACH
+#endif
+#define FOREACH for ( std::vector<KSieve::ScriptBuilder*>::const_iterator it = mBuilders.begin(), end = mBuilders.end() ; it != end ; ++it ) (*it)->
+    void commandStart( const QString & identifier ) { FOREACH commandStart( identifier ); }
+    void commandEnd() { FOREACH commandEnd(); }
+    void testStart( const QString & identifier ) { FOREACH testStart( identifier ); }
+    void testEnd() { FOREACH testEnd(); }
+    void testListStart() { FOREACH testListStart(); }
+    void testListEnd() { FOREACH testListEnd(); }
+    void blockStart() { FOREACH blockStart(); }
+    void blockEnd() { FOREACH blockEnd(); }
+    void hashComment( const QString & comment ) { FOREACH hashComment( comment ); }
+    void bracketComment( const QString & comment ) { FOREACH bracketComment( comment ); }
+    void lineFeed() { FOREACH lineFeed(); }
+    void error( const KSieve::Error & e ) { FOREACH error( e ); }
+    void finished() { FOREACH finished(); }
+    void taggedArgument( const QString & tag ) { FOREACH taggedArgument( tag ); }
+    void stringArgument( const QString & string, bool multiline, const QString & fixme ) { FOREACH stringArgument( string, multiline, fixme ); }
+    void numberArgument( unsigned long number, char quantifier ) { FOREACH numberArgument( number, quantifier ); }
+    void stringListArgumentStart() { FOREACH stringListArgumentStart(); }
+    void stringListEntry( const QString & string, bool multiline, const QString & fixme) { FOREACH stringListEntry( string, multiline, fixme ); }
+    void stringListArgumentEnd() { FOREACH stringListArgumentEnd(); }
+#undef FOREACH
+  };
+
+}
+
 namespace {
 
+  class GenericInformationExtractor : public KSieve::ScriptBuilder {
+  public:
+    enum BuilderMethod {
+      Any,
+      TaggedArgument,
+      StringArgument,
+      NumberArgument,
+      CommandStart,
+      CommandEnd,
+      TestStart,
+      TestEnd,
+      TestListStart,
+      TestListEnd,
+      BlockStart,
+      BlockEnd,
+      StringListArgumentStart,
+      StringListEntry,
+      StringListArgumentEnd
+    };
+
+    struct StateNode {
+      // expectation:
+      int depth;
+      BuilderMethod method;
+      const char * string;
+      // actions:
+      int if_found;
+      int if_not_found;
+      const char * save_tag;
+    };
+
+    const std::vector<StateNode> mNodes;
+    std::map<QString,QString> mResults;
+    std::set<unsigned int> mRecursionGuard;
+    unsigned int mState;
+    int mNestingDepth;
+
+  public:
+    GenericInformationExtractor( const std::vector<StateNode> & nodes )
+      : KSieve::ScriptBuilder(), mNodes( nodes ), mState( 0 ), mNestingDepth( 0 ) {}
+
+    const std::map<QString,QString> & results() const { return mResults; }
+
+  private:
+    void process( BuilderMethod method, const QString & string=QString::null ) {
+      doProcess( method, string );
+      mRecursionGuard.clear();
+    }
+    void doProcess( BuilderMethod method, const QString & string ) {
+      mRecursionGuard.insert( mState );
+      bool found = true;
+      const StateNode & expected = mNodes[mState];
+      if ( expected.depth != -1 && mNestingDepth != expected.depth )
+        found = false;
+      if ( expected.method != Any && method != expected.method )
+        found = false;
+      if ( const char * str = expected.string )
+        if ( string.lower() != QString::fromUtf8( str ).lower() )
+          found = false;
+      kdDebug(5006) << ( found ? "found:     " : "not found: " )
+                    << mState << " -> "
+                    << ( found ? expected.if_found : expected.if_not_found ) << endl;
+      mState = found ? expected.if_found : expected.if_not_found ;
+      assert( mState < mNodes.size() );
+      if ( found )
+        if ( const char * save_tag = expected.save_tag )
+          mResults[save_tag] = string;
+      if ( !found && !mRecursionGuard.count( mState ) ) {
+        doProcess( method, string );
+      }
+    }
+    void commandStart( const QString & identifier ) { kdDebug(5006) << k_funcinfo << endl; process( CommandStart, identifier ); }
+    void commandEnd() { kdDebug(5006) << k_funcinfo << endl; process( CommandEnd ); }
+    void testStart( const QString & identifier ) { kdDebug(5006) << k_funcinfo << endl; process( TestStart, identifier ); }
+    void testEnd() { kdDebug(5006) << k_funcinfo << endl; process( TestEnd ); }
+    void testListStart() { kdDebug(5006) << k_funcinfo << endl; process( TestListStart ); }
+    void testListEnd() { kdDebug(5006) << k_funcinfo << endl; process( TestListEnd ); }
+    void blockStart() { kdDebug(5006) << k_funcinfo << endl; process( BlockStart ); ++mNestingDepth; }
+    void blockEnd() { kdDebug(5006) << k_funcinfo << endl; --mNestingDepth; process( BlockEnd ); }
+    void hashComment( const QString & ) { kdDebug(5006) << k_funcinfo << endl; }
+    void bracketComment( const QString & ) { kdDebug(5006) << k_funcinfo << endl; }
+    void lineFeed() { kdDebug(5006) << k_funcinfo << endl; }
+    void error( const KSieve::Error & ) {
+      kdDebug(5006) << k_funcinfo << endl;
+      mState = 0;
+    }
+    void finished() { kdDebug(5006) << k_funcinfo << endl; }
+
+    void taggedArgument( const QString & tag ) { kdDebug(5006) << k_funcinfo << endl; process( TaggedArgument, tag ); }
+    void stringArgument( const QString & string, bool, const QString & ) { kdDebug(5006) << k_funcinfo << endl; process( StringArgument, string ); }
+    void numberArgument( unsigned long number, char ) { kdDebug(5006) << k_funcinfo << endl; process( NumberArgument, QString::number( number ) ); }
+    void stringListArgumentStart() { kdDebug(5006) << k_funcinfo << endl; process( StringListArgumentStart ); }
+    void stringListEntry( const QString & string, bool, const QString & ) { kdDebug(5006) << k_funcinfo << endl; process( StringListEntry, string ); }
+    void stringListArgumentEnd() { kdDebug(5006) << k_funcinfo << endl; process( StringListArgumentEnd ); }
+  };
+
+  typedef GenericInformationExtractor GIE;
+  static const GenericInformationExtractor::StateNode spamNodes[] = {
+    { 0, GIE::CommandStart, "if",  1, 0, 0 },              // 0
+    { 0,   GIE::TestStart, "header", 2, 0, 0 },            // 1
+    { 0,     GIE::TaggedArgument, "contains", 3, 0, 0 },   // 2
+
+    // accept both string and string-list:
+    { 0,     GIE::StringArgument, "x-spam-flag", 9, 4, "x-spam-flag" },    // 3
+    { 0,     GIE::StringListArgumentStart, 0, 5, 0, 0 },                   // 4
+    { 0,       GIE::StringListEntry, "x-spam-flag", 6, 7, "x-spam-flag" }, // 5
+    { 0,       GIE::StringListEntry, 0, 6, 8, 0 },                         // 6
+    { 0,     GIE::StringListArgumentEnd, 0, 0, 5, 0 },                     // 7
+    { 0,     GIE::StringListArgumentEnd, 0, 9, 0, 0 },                     // 8
+
+    // accept both string and string-list:
+    { 0,     GIE::StringArgument, "yes", 15, 10, "spam-flag-yes" },    // 9
+    { 0,     GIE::StringListArgumentStart, 0, 11, 0, 0 },              // 10
+    { 0,       GIE::StringListEntry, "yes", 12, 13, "spam-flag-yes" }, // 11
+    { 0,       GIE::StringListEntry, 0, 12, 14, 0 },                   // 12
+    { 0,     GIE::StringListArgumentEnd, 0, 0, 11, 0 },                // 13
+    { 0,     GIE::StringListArgumentEnd, 0, 15, 0, 0 },                // 14
+
+    { 0,   GIE::TestEnd, 0, 16, 0, 0 }, // 15
+
+    // block of command, find "stop", take nested if's into account:
+    { 0,   GIE::BlockStart, 0, 17, 0, 0 },                // 16
+    { 1,     GIE::CommandStart, "stop", 20, 19, "stop" }, // 17
+    { -1,    GIE::Any, 0, 17, 0, 0 },                     // 18
+    { 0,   GIE::BlockEnd, 0, 0, 18, 0 },                  // 19
+
+    { -1, GIE::Any, 0, 20, 20, 0 }, // 20 end state
+  };
+  static const unsigned int numSpamNodes = sizeof spamNodes / sizeof *spamNodes ;
+
+  class SpamDataExtractor : public GenericInformationExtractor {
+  public:
+    SpamDataExtractor()
+      : GenericInformationExtractor( std::vector<StateNode>( spamNodes, spamNodes + numSpamNodes ) )
+    {
+
+    }
+
+    bool found() const {
+      return mResults.count( "x-spam-flag" ) &&
+        mResults.count( "spam-flag-yes" ) &&
+        mResults.count( "stop" ) ;
+    }
+  };
+
+  // to understand this table, study the output of
+  // libksieve/tests/parsertest
+  //   'if not address :domain :contains ["from"] ["mydomain.org"] { keep; stop; }'
+  static const GenericInformationExtractor::StateNode domainNodes[] = {
+    { 0, GIE::CommandStart, "if", 1, 0, 0 },       // 0
+    { 0,   GIE::TestStart, "not", 2, 0, 0, },      // 1
+    { 0,     GIE::TestStart, "address", 3, 0, 0 }, // 2
+
+    // :domain and :contains in arbitrary order:
+    { 0,       GIE::TaggedArgument, "domain", 4, 5, 0 },     // 3
+    { 0,       GIE::TaggedArgument, "contains", 7, 0, 0 },   // 4
+    { 0,       GIE::TaggedArgument, "contains", 6, 0, 0 },   // 5
+    { 0,       GIE::TaggedArgument, "domain", 7, 0, 0 },     // 6
+
+    // accept both string and string-list:
+    { 0,       GIE::StringArgument, "from", 13, 8, "from" },     // 7
+    { 0,       GIE::StringListArgumentStart, 0, 9, 0, 0 },       // 8
+    { 0,         GIE::StringListEntry, "from", 10, 11, "from" }, // 9
+    { 0,         GIE::StringListEntry, 0, 10, 12, 0 },           // 10
+    { 0,       GIE::StringListArgumentEnd, 0, 0, 9, 0 },         // 11
+    { 0,       GIE::StringListArgumentEnd, 0, 13, 0, 0 },        // 12
+
+    // string: save, string-list: save last
+    { 0,       GIE::StringArgument, 0, 17, 14, "domainName" },    // 13
+    { 0,       GIE::StringListArgumentStart, 0, 15, 0, 0 },       // 14
+    { 0,         GIE::StringListEntry, 0, 15, 16, "domainName" }, // 15
+    { 0,       GIE::StringListArgumentEnd, 0, 17, 0, 0 },         // 16
+
+    { 0,     GIE::TestEnd, 0, 18, 0, 0 },  // 17
+    { 0,   GIE::TestEnd, 0, 19, 0, 0 },    // 18
+
+    // block of commands, find "stop", take nested if's into account:
+    { 0,   GIE::BlockStart, 0, 20, 0, 0 },                 // 19
+    { 1,     GIE::CommandStart, "stop", 23, 22, "stop" },  // 20
+    { -1,    GIE::Any, 0, 20, 0, 0 },                      // 21
+    { 0,   GIE::BlockEnd, 0, 0, 21, 0 },                   // 22
+
+    { -1, GIE::Any, 0, 23, 23, 0 }  // 23 end state
+  };
+  static const unsigned int numDomainNodes = sizeof domainNodes / sizeof *domainNodes ;
+
+  class DomainRestrictionDataExtractor : public GenericInformationExtractor {
+  public:
+    DomainRestrictionDataExtractor()
+      : GenericInformationExtractor( std::vector<StateNode>( domainNodes, domainNodes+numDomainNodes ) )
+    {
+
+    }
+
+    QString domainName() /*not const, since map::op[] isn't const*/ {
+      return mResults.count( "stop" ) && mResults.count( "from" )
+        ? mResults["domainName"] : QString::null ;
+    }
+  };
+
   class VacationDataExtractor : public KSieve::ScriptBuilder {
     enum Context {
       None = 0,
@@ -162,8 +428,8 @@
 
 namespace KMail {
 
-  Vacation::Vacation( QObject * parent, const char * name )
-    : QObject( parent, name ), mSieveJob( 0 ), mDialog( 0 ), mWasActive( false )
+  Vacation::Vacation( QObject * parent, bool checkOnly, const char * name )
+    : QObject( parent, name ), mSieveJob( 0 ), mDialog( 0 ), mWasActive( false ), mCheckOnly( checkOnly )
   {
     mUrl = findURL();
     kdDebug(5006) << "Vacation: found url \"" << mUrl.prettyURL() << "\"" << endl;
@@ -189,7 +455,8 @@
 
   QString Vacation::composeScript( const QString & messageText,
 				   int notificationInterval,
-				   const AddrSpecList & addrSpecs )
+				   const AddrSpecList & addrSpecs,
+                                   bool sendForSpam, const QString & domain )
   {
     QString addressesArgument;
     QStringList aliases;
@@ -202,9 +469,15 @@
       }
       addressesArgument += sl.join( ", " ) + " ] ";
     }
-    QString script = QString::fromLatin1("require \"vacation\";\n"
-					 "\n"
-					 "vacation ");
+    QString script = QString::fromLatin1("require \"vacation\";\n\n" );
+    if ( !sendForSpam )
+      script += QString::fromLatin1( "if header :contains \"X-Spam-Flag\" \"YES\""
+                                     " { keep; stop; }\n" ); // FIXME?
+
+    if ( !domain.isEmpty() ) // FIXME
+      script += QString::fromLatin1( "if not address :domain :contains \"from\" \"%1\" { keep; stop; }\n" ).arg( domain );
+
+    script += "vacation ";
     script += addressesArgument;
     if ( notificationInterval > 0 )
       script += QString::fromLatin1(":days %1 ").arg( notificationInterval );
@@ -216,7 +489,7 @@
 
   static KURL findUrlForAccount( const KMail::ImapAccountBase * a ) {
     assert( a );
-    SieveConfig sieve = a->sieveConfig();
+    const SieveConfig sieve = a->sieveConfig();
     if ( !sieve.managesieveSupported() )
       return KURL();
     if ( sieve.reuseConfig() ) {
@@ -250,11 +523,14 @@
   }
 
   bool Vacation::parseScript( const QString & script, QString & messageText,
-			      int & notificationInterval, QStringList & aliases ) {
+			      int & notificationInterval, QStringList & aliases,
+                              bool & sendForSpam, QString & domainName ) {
     if ( script.stripWhiteSpace().isEmpty() ) {
       messageText = defaultMessageText();
       notificationInterval = defaultNotificationInterval();
       aliases = defaultMailAliases();
+      sendForSpam = defaultSendForSpam();
+      domainName = defaultDomainName();
       return true;
     }
 
@@ -266,12 +542,19 @@
     KSieve::Parser parser( scriptUTF8.begin(),
 			   scriptUTF8.begin() + scriptUTF8.length() );
     VacationDataExtractor vdx;
-    parser.setScriptBuilder( &vdx );
+    SpamDataExtractor sdx;
+    DomainRestrictionDataExtractor drdx;
+    KSieveExt::MultiScriptBuilder tsb( &vdx, &sdx, &drdx );
+    parser.setScriptBuilder( &tsb );
     if ( !parser.parse() )
       return false;
     messageText = vdx.messageText().stripWhiteSpace();
     notificationInterval = vdx.notificationInterval();
     aliases = vdx.aliases();
+    if ( !GlobalSettings::allowOutOfOfficeUploadButNoSettings() ) {
+      sendForSpam = !sdx.found();
+      domainName = drdx.domainName();
+    }
     return true;
   }
 
@@ -302,7 +585,14 @@
     return sl;
   }
 
+  bool Vacation::defaultSendForSpam() {
+    return GlobalSettings::outOfOfficeReactToSpam();
+  }
 
+  QString Vacation::defaultDomainName() {
+    return GlobalSettings::outOfOfficeDomain();
+  }
+
   void Vacation::slotGetResult( SieveJob * job, bool success,
 				const QString & script, bool active ) {
     kdDebug(5006) << "Vacation::slotGetResult( ??, " << success
@@ -311,7 +601,7 @@
 	      << script << endl;
     mSieveJob = 0; // job deletes itself after returning from this slot!
 
-    if ( mUrl.protocol() == "sieve" && !job->sieveCapabilities().isEmpty() &&
+    if ( !mCheckOnly && mUrl.protocol() == "sieve" && !job->sieveCapabilities().isEmpty() &&
 	 !job->sieveCapabilities().contains("vacation") ) {
       KMessageBox::sorry( 0, i18n("Your server did not list \"vacation\" in "
 				  "its list of supported Sieve extensions;\n"
@@ -322,15 +612,17 @@
       return;
     }
 
-    if ( !mDialog )
+    if ( !mDialog && !mCheckOnly )
       mDialog = new VacationDialog( i18n("Configure \"Out of Office\" Replies"), 0, 0, false );
 
     QString messageText = defaultMessageText();
     int notificationInterval = defaultNotificationInterval();
     QStringList aliases = defaultMailAliases();
+    bool sendForSpam = defaultSendForSpam();
+    QString domainName = defaultDomainName();
     if ( !success ) active = false; // default to inactive
 
-    if ( !success || !parseScript( script, messageText, notificationInterval, aliases ) )
+    if ( !mCheckOnly && ( !success || !parseScript( script, messageText, notificationInterval, aliases, sendForSpam, domainName ) ) )
       KMessageBox::information( 0, i18n("Someone (probably you) changed the "
 					"vacation script on the server.\n"
 					"KMail is no longer able to determine "
@@ -338,16 +630,31 @@
 					"Default values will be used." ) );
 
     mWasActive = active;
-    mDialog->setActivateVacation( active );
-    mDialog->setMessageText( messageText );
-    mDialog->setNotificationInterval( notificationInterval );
-    mDialog->setMailAliases( aliases.join(", ") );
+    if ( mDialog ) {
+      mDialog->setActivateVacation( active );
+      mDialog->setMessageText( messageText );
+      mDialog->setNotificationInterval( notificationInterval );
+      mDialog->setMailAliases( aliases.join(", ") );
+      mDialog->setSendForSpam( sendForSpam );
+      mDialog->setDomainName( domainName );
+      mDialog->enableDomainAndSendForSpam( !GlobalSettings::allowOutOfOfficeUploadButNoSettings() );
 
-    connect( mDialog, SIGNAL(okClicked()), SLOT(slotDialogOk()) );
-    connect( mDialog, SIGNAL(cancelClicked()), SLOT(slotDialogCancel()) );
-    connect( mDialog, SIGNAL(defaultClicked()), SLOT(slotDialogDefaults()) );
+      connect( mDialog, SIGNAL(okClicked()), SLOT(slotDialogOk()) );
+      connect( mDialog, SIGNAL(cancelClicked()), SLOT(slotDialogCancel()) );
+      connect( mDialog, SIGNAL(defaultClicked()), SLOT(slotDialogDefaults()) );
 
-    mDialog->show();
+      mDialog->show();
+    }
+
+    emit scriptActive( mWasActive );
+    if ( mCheckOnly && mWasActive ) {
+      if ( KMessageBox::questionYesNo( 0, i18n( "There is still an active out-of-office reply configured.\n"
+                                        "Do you want to edit it?"), i18n("Out-of-office reply still active"),
+                                        KGuiItem( i18n( "Edit"), "edit" ), KGuiItem( i18n("Ignore"), "button_cancel" ) )
+           == KMessageBox::Yes ) {
+        kmkernel->getKMMainWidget()->slotEditVacation();
+      }
+    }
   }
 
   void Vacation::slotDialogDefaults() {
@@ -357,6 +664,8 @@
     mDialog->setMessageText( defaultMessageText() );
     mDialog->setNotificationInterval( defaultNotificationInterval() );
     mDialog->setMailAliases( defaultMailAliases().join(", ") );
+    mDialog->setSendForSpam( defaultSendForSpam() );
+    mDialog->setDomainName( defaultDomainName() );
   }
 
   void Vacation::slotDialogOk() {
@@ -364,8 +673,11 @@
     // compose a new script:
     const QString script = composeScript( mDialog->messageText(),
 				    mDialog->notificationInterval(),
-				    mDialog->mailAliases() );
+				    mDialog->mailAliases(),
+                                    mDialog->sendForSpam(),
+                                    mDialog->domainName() );
     const bool active = mDialog->activateVacation();
+    emit scriptActive( active );
 
     kdDebug(5006) << "script:" << endl << script << endl;
 
@@ -408,6 +720,7 @@
 		  << endl;
     mSieveJob = 0; // job deletes itself after returning from this slot!
     emit result( success );
+    emit scriptActive( activated );
   }
 
 
Index: kmail/kmfilteraction.cpp
===================================================================
--- kmail/kmfilteraction.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfilteraction.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -104,7 +104,7 @@
 
 bool KMFilterAction::folderRemoved(KMFolder*, KMFolder*)
 {
-  return FALSE;
+  return false;
 }
 
 int KMFilterAction::tempOpenFolder(KMFolder* aFolder)
@@ -250,7 +250,7 @@
 
 QWidget* KMFilterActionWithStringList::createParamWidget( QWidget* parent ) const
 {
-  QComboBox *cb = new QComboBox( FALSE, parent );
+  QComboBox *cb = new QComboBox( false, parent );
   cb->insertStringList( mParameterList );
   setParamWidgetValue( cb );
   return cb;
@@ -361,9 +361,9 @@
     mFolder = aNewFolder;
     if ( aNewFolder )
       mFolderName = mFolder->idString();
-    return TRUE;
+    return true;
   } else
-    return FALSE;
+    return false;
 }
 
 //=============================================================================
@@ -463,7 +463,7 @@
         kdDebug(5006) << "KMFilterActionWithCommand: Could not create temp file!" << endl;
         return QString::null;
       }
-      tf->setAutoDelete(TRUE);
+      tf->setAutoDelete(true);
       aTempFileList.append( tf );
       tempFileName = tf->name();
       if ((*it) == -1)
@@ -511,10 +511,10 @@
   // KProcess doesn't support a QProcess::launch() equivalent, so
   // we must use a temp file :-(
   KTempFile * inFile = new KTempFile;
-  inFile->setAutoDelete(TRUE);
+  inFile->setAutoDelete(true);
 
   QPtrList<KTempFile> atmList;
-  atmList.setAutoDelete(TRUE);
+  atmList.setAutoDelete(true);
   atmList.append( inFile );
 
   QString commandLine = substituteCommandLineArgsFor( aMsg , atmList );
@@ -973,7 +973,7 @@
 
 QWidget* KMFilterActionRemoveHeader::createParamWidget( QWidget* parent ) const
 {
-  QComboBox *cb = new QComboBox( TRUE/*editable*/, parent );
+  QComboBox *cb = new QComboBox( true/*editable*/, parent );
   cb->setInsertionPolicy( QComboBox::AtBottom );
   setParamWidgetValue( cb );
   return cb;
@@ -1057,7 +1057,7 @@
   QWidget *w = new QWidget( parent );
   QHBoxLayout *hbl = new QHBoxLayout( w );
   hbl->setSpacing( 4 );
-  QComboBox *cb = new QComboBox( TRUE, w, "combo" );
+  QComboBox *cb = new QComboBox( true, w, "combo" );
   cb->setInsertionPolicy( QComboBox::AtBottom );
   hbl->addWidget( cb, 0 /* stretch */ );
   QLabel *l = new QLabel( i18n("With value:"), w );
@@ -1126,7 +1126,7 @@
 
 void KMFilterActionAddHeader::argsFromString( const QString argsStr )
 {
-  QStringList l = QStringList::split( '\t', argsStr, TRUE /*allow empty entries*/ );
+  QStringList l = QStringList::split( '\t', argsStr, true /*allow empty entries*/ );
   QString s;
   if ( l.count() < 2 ) {
     s = l[0];
@@ -1206,7 +1206,7 @@
   QHBoxLayout *hbl = new QHBoxLayout( w );
   hbl->setSpacing( 4 );
 
-  QComboBox *cb = new QComboBox( TRUE, w, "combo" );
+  QComboBox *cb = new QComboBox( true, w, "combo" );
   cb->setInsertionPolicy( QComboBox::AtBottom );
   hbl->addWidget( cb, 0 /* stretch */ );
 
@@ -1302,7 +1302,7 @@
 
 void KMFilterActionRewriteHeader::argsFromString( const QString argsStr )
 {
-  QStringList l = QStringList::split( '\t', argsStr, TRUE /*allow empty entries*/ );
+  QStringList l = QStringList::split( '\t', argsStr, true /*allow empty entries*/ );
   QString s;
 
   s = l[0];
@@ -1396,9 +1396,10 @@
   // TODO opening and closing the folder is a trade off.
   // Perhaps Copy is a seldomly used action for now,
   // but I gonna look at improvements ASAP.
-  if ( !mFolder || mFolder->open( "filtercopy" ) != 0 ) {
+  if ( !mFolder )
     return ErrorButGoOn;
-  }
+  if ( mFolder && mFolder->open( "filtercopy" ) != 0 )
+    return ErrorButGoOn;
 
   // copy the message 1:1
   KMMessage* msgCopy = new KMMessage( new DwMessage( *msg->asDwMessage() ) );
@@ -1711,10 +1712,10 @@
 
   ActionScheduler *handler = MessageProperty::filterHandler( aMsg->getMsgSerNum() );
   KTempFile * inFile = new KTempFile;
-  inFile->setAutoDelete(FALSE);
+  inFile->setAutoDelete(false);
 
   QPtrList<KTempFile> atmList;
-  atmList.setAutoDelete(TRUE);
+  atmList.setAutoDelete(true);
   atmList.append( inFile );
 
   QString commandLine = substituteCommandLineArgsFor( aMsg , atmList );
@@ -1911,7 +1912,7 @@
 KMFilterActionDict::KMFilterActionDict()
   : QDict<KMFilterActionDesc>(41)
 {
-  mList.setAutoDelete(TRUE);
+  mList.setAutoDelete(true);
   init();
 }
 
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -47,6 +47,7 @@
 #include "kleo_util.h"
 #include "stl_util.h"
 #include "recipientseditor.h"
+#include "editorwatcher.h"
 
 #include "attachmentcollector.h"
 #include "objecttreeparser.h"
@@ -71,7 +72,6 @@
 #include <libkdepim/kvcarddrag.h>
 #include <kio/netaccess.h>
 
-
 #include "klistboxdialog.h"
 
 #include "messagecomposer.h"
@@ -105,6 +105,7 @@
 #include <kuserprofile.h>
 #include <krun.h>
 #include <ktempdir.h>
+#include <kstandarddirs.h>
 //#include <keditlistbox.h>
 #include "globalsettings.h"
 #include "replyphrases.h"
@@ -141,6 +142,8 @@
 
 #include "kmcomposewin.moc"
 
+#include "snippet_widget.h"
+
 KMail::Composer * KMail::makeComposer( KMMessage * msg, uint identitiy ) {
   return KMComposeWin::create( msg, identitiy );
 }
@@ -163,13 +166,14 @@
     mId( id ),
     mAttachPK( 0 ), mAttachMPK( 0 ),
     mAttachRemoveAction( 0 ), mAttachSaveAction( 0 ), mAttachPropertiesAction( 0 ),
+    mAppendSignatureAction( 0 ), mPrependSignatureAction( 0 ), mInsertSignatureAction( 0 ),
     mSignAction( 0 ), mEncryptAction( 0 ), mRequestMDNAction( 0 ),
     mUrgentAction( 0 ), mAllFieldsAction( 0 ), mFromAction( 0 ),
     mReplyToAction( 0 ), mToAction( 0 ), mCcAction( 0 ), mBccAction( 0 ),
     mSubjectAction( 0 ),
     mIdentityAction( 0 ), mTransportAction( 0 ), mFccAction( 0 ),
     mWordWrapAction( 0 ), mFixedFontAction( 0 ), mAutoSpellCheckingAction( 0 ),
-    mDictionaryAction( 0 ),
+    mDictionaryAction( 0 ), mSnippetAction( 0 ),
     mEncodingAction( 0 ),
     mCryptoModuleAction( 0 ),
     mEncryptChiasmusAction( 0 ),
@@ -177,6 +181,7 @@
     mComposer( 0 ),
     mLabelWidth( 0 ),
     mAutoSaveTimer( 0 ), mLastAutoSaveErrno( 0 ),
+    mSignatureStateIndicator( 0 ), mEncryptionStateIndicator( 0 ),
     mPreserveUserCursorPosition( false )
 {
   mClassicalRecipients = GlobalSettings::self()->recipientsEditorType() ==
@@ -186,16 +191,23 @@
   if (kmkernel->xmlGuiInstance())
     setInstance( kmkernel->xmlGuiInstance() );
   mMainWidget = new QWidget(this);
-  mIdentity = new KPIM::IdentityCombo(kmkernel->identityManager(), mMainWidget);
-  mDictionaryCombo = new DictionaryComboBox( mMainWidget );
-  mFcc = new KMFolderComboBox(mMainWidget);
-  mFcc->showOutboxFolder( FALSE );
-  mTransport = new QComboBox(true, mMainWidget);
-  mEdtFrom = new KMLineEdit(false,mMainWidget, "fromLine");
+  // splitter between the headers area and the actual editor
+  mHeadersToEditorSplitter = new QSplitter( Qt::Vertical, mMainWidget, "mHeadersToEditorSplitter" );
+  mHeadersToEditorSplitter->setChildrenCollapsible( false );
+  mHeadersArea = new QWidget( mHeadersToEditorSplitter );
+  mHeadersArea->setSizePolicy( mHeadersToEditorSplitter->sizePolicy().horData(), QSizePolicy::Maximum );
+  QVBoxLayout *v = new QVBoxLayout( mMainWidget );
+  v->addWidget( mHeadersToEditorSplitter );
+  mIdentity = new KPIM::IdentityCombo(kmkernel->identityManager(), mHeadersArea);
+  mDictionaryCombo = new DictionaryComboBox( mHeadersArea );
+  mFcc = new KMFolderComboBox(mHeadersArea);
+  mFcc->showOutboxFolder( false );
+  mTransport = new QComboBox(true, mHeadersArea);
+  mEdtFrom = new KMLineEdit(false,mHeadersArea, "fromLine");
 
-  mEdtReplyTo = new KMLineEdit(true,mMainWidget, "replyToLine");
-  mLblReplyTo = new QLabel(mMainWidget);
-  mBtnReplyTo = new QPushButton("...",mMainWidget);
+  mEdtReplyTo = new KMLineEdit(true,mHeadersArea, "replyToLine");
+  mLblReplyTo = new QLabel(mHeadersArea);
+  mBtnReplyTo = new QPushButton("...",mHeadersArea);
   mBtnReplyTo->setFocusPolicy(QWidget::NoFocus);
   connect(mBtnReplyTo,SIGNAL(clicked()),SLOT(slotAddrBookReplyTo()));
   connect(mEdtReplyTo,SIGNAL(completionModeChanged(KGlobalSettings::Completion)),
@@ -204,18 +216,18 @@
   if ( mClassicalRecipients ) {
     mRecipientsEditor = 0;
 
-    mEdtTo = new KMLineEdit(true,mMainWidget, "toLine");
-    mEdtCc = new KMLineEdit(true,mMainWidget, "ccLine");
-    mEdtBcc = new KMLineEdit(true,mMainWidget, "bccLine");
+    mEdtTo = new KMLineEdit(true,mHeadersArea, "toLine");
+    mEdtCc = new KMLineEdit(true,mHeadersArea, "ccLine");
+    mEdtBcc = new KMLineEdit(true,mHeadersArea, "bccLine");
 
-    mLblTo = new QLabel(mMainWidget);
-    mLblCc = new QLabel(mMainWidget);
-    mLblBcc = new QLabel(mMainWidget);
+    mLblTo = new QLabel(mHeadersArea);
+    mLblCc = new QLabel(mHeadersArea);
+    mLblBcc = new QLabel(mHeadersArea);
 
-    mBtnTo = new QPushButton("...",mMainWidget);
-    mBtnCc = new QPushButton("...",mMainWidget);
-    mBtnBcc = new QPushButton("...",mMainWidget);
-    //mBtnFrom = new QPushButton("...",mMainWidget);
+    mBtnTo = new QPushButton("...",mHeadersArea);
+    mBtnCc = new QPushButton("...",mHeadersArea);
+    mBtnBcc = new QPushButton("...",mHeadersArea);
+    //mBtnFrom = new QPushButton("...",mHeadersArea);
 
     QString tip = i18n("Select email address(es)");
     QToolTip::add( mBtnTo, tip );
@@ -255,24 +267,25 @@
     mBtnBcc = 0;
     //mBtnFrom = 0;
 
-    mRecipientsEditor = new RecipientsEditor( mMainWidget );
+    mRecipientsEditor = new RecipientsEditor( mHeadersArea );
     connect( mRecipientsEditor,
              SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
              SLOT( slotCompletionModeChanged( KGlobalSettings::Completion ) ) );
+    connect( mRecipientsEditor, SIGNAL(sizeHintChanged()), SLOT(recipientEditorSizeHintChanged()) );
 
     mRecipientsEditor->setFocus();
   }
-  mEdtSubject = new KMLineEditSpell(false,mMainWidget, "subjectLine");
-  mLblIdentity = new QLabel(mMainWidget);
-  mDictionaryLabel = new QLabel( mMainWidget );
-  mLblFcc = new QLabel(mMainWidget);
-  mLblTransport = new QLabel(mMainWidget);
-  mLblFrom = new QLabel(mMainWidget);
-  mLblSubject = new QLabel(mMainWidget);
+  mEdtSubject = new KMLineEditSpell(false,mHeadersArea, "subjectLine");
+  mLblIdentity = new QLabel(mHeadersArea);
+  mDictionaryLabel = new QLabel( mHeadersArea );
+  mLblFcc = new QLabel(mHeadersArea);
+  mLblTransport = new QLabel(mHeadersArea);
+  mLblFrom = new QLabel(mHeadersArea);
+  mLblSubject = new QLabel(mHeadersArea);
   QString sticky = i18n("Sticky");
-  mBtnIdentity = new QCheckBox(sticky,mMainWidget);
-  mBtnFcc = new QCheckBox(sticky,mMainWidget);
-  mBtnTransport = new QCheckBox(sticky,mMainWidget);
+  mBtnIdentity = new QCheckBox(sticky,mHeadersArea);
+  mBtnFcc = new QCheckBox(sticky,mHeadersArea);
+  mBtnTransport = new QCheckBox(sticky,mHeadersArea);
 
   //setWFlags( WType_TopLevel | WStyle_Dialog );
   mHtmlMarkup = GlobalSettings::self()->useHtmlMarkup();
@@ -280,17 +293,50 @@
   mDone = false;
   mGrid = 0;
   mAtmListView = 0;
-  mAtmList.setAutoDelete(TRUE);
-  mAtmTempList.setAutoDelete(TRUE);
-  mAtmModified = FALSE;
-  mAutoDeleteMsg = FALSE;
+  mAtmList.setAutoDelete(true);
+  mAtmTempList.setAutoDelete(true);
+  mAtmModified = false;
+  mAutoDeleteMsg = false;
   mFolder = 0;
-  mAutoCharset = TRUE;
+  mAutoCharset = true;
   mFixedFontAction = 0;
   mTempDir = 0;
-  mSplitter = new QSplitter( Qt::Vertical, mMainWidget, "mSplitter" );
-  mEditor = new KMEdit( mSplitter, this, mDictionaryCombo->spellConfig() );
-  mSplitter->moveToFirst( mEditor );
+  // the attachment view is separated from the editor by a splitter
+  mSplitter = new QSplitter( Qt::Vertical, mHeadersToEditorSplitter, "mSplitter" );
+  mSplitter->setChildrenCollapsible( false );
+  mSnippetSplitter = new QSplitter( Qt::Horizontal, mSplitter, "mSnippetSplitter");
+  mSnippetSplitter->setChildrenCollapsible( false );
+
+  QWidget *editorAndCryptoStateIndicators = new QWidget( mSnippetSplitter );
+  QVBoxLayout *vbox = new QVBoxLayout( editorAndCryptoStateIndicators );
+  QHBoxLayout *hbox = new QHBoxLayout( vbox );
+  {
+      mSignatureStateIndicator = new QLabel( editorAndCryptoStateIndicators );
+      mSignatureStateIndicator->setAlignment( Qt::AlignHCenter );
+      hbox->addWidget( mSignatureStateIndicator );
+
+      KConfigGroup reader( KMKernel::config(), "Reader" );
+      QPalette p( mSignatureStateIndicator->palette() );
+
+      QColor defaultSignedColor( 0x40, 0xFF, 0x40 ); // light green // pgp ok, trusted key
+      QColor defaultEncryptedColor( 0x00, 0x80, 0xFF ); // light blue // pgp encrypted
+      p.setColor( QColorGroup::Background, reader.readColorEntry( "PGPMessageOkKeyOk", &defaultSignedColor ) );
+      mSignatureStateIndicator->setPalette( p );
+
+      mEncryptionStateIndicator = new QLabel( editorAndCryptoStateIndicators );
+      mEncryptionStateIndicator->setAlignment( Qt::AlignHCenter );
+      hbox->addWidget( mEncryptionStateIndicator );
+      p.setColor( QColorGroup::Background, reader.readColorEntry( "PGPMessageEncr" , &defaultEncryptedColor ) );
+      mEncryptionStateIndicator->setPalette( p );
+  }
+
+  mEditor = new KMEdit( editorAndCryptoStateIndicators, this, mDictionaryCombo->spellConfig() );
+  vbox->addWidget( mEditor );
+
+  mSnippetWidget = new SnippetWidget( mEditor, actionCollection(), mSnippetSplitter );
+  mSnippetWidget->setShown( GlobalSettings::self()->showSnippetManager() );
+
+  //  mSplitter->moveToFirst( editorAndCryptoStateIndicators );
   mSplitter->setOpaqueResize( true );
 
   mEditor->initializeAutoSpellChecking();
@@ -304,7 +350,7 @@
   QWhatsThis::add( mBtnTransport,
     GlobalSettings::self()->stickyTransportItem()->whatsThis() );
 
-  mSpellCheckInProgress=FALSE;
+  mSpellCheckInProgress=false;
 
   setCaption( i18n("Composer") );
   setMinimumSize(200,200);
@@ -337,7 +383,7 @@
 
   connect( mAtmListView,
            SIGNAL( doubleClicked( QListViewItem* ) ),
-           SLOT( slotAttachOpen() ) );
+           SLOT( slotAttachEdit() ) );
   connect( mAtmListView,
            SIGNAL( rightButtonPressed( QListViewItem*, const QPoint&, int ) ),
            SLOT( slotAttachPopupMenu( QListViewItem*, const QPoint&, int ) ) );
@@ -347,12 +393,16 @@
   connect( mAtmListView,
            SIGNAL( attachmentDeleted() ),
            SLOT( slotAttachRemove() ) );
+  connect( mAtmListView,
+           SIGNAL( dragStarted() ),
+           SLOT( slotAttachmentDragStarted() ) );
   mAttachMenu = 0;
 
   readConfig();
   setupStatusBar();
   setupActions();
   setupEditor();
+  slotUpdateSignatureAndEncrypionStateIndicators();
 
   applyMainWindowSettings(KMKernel::config(), "Composer");
 
@@ -378,8 +428,6 @@
 
   connect (mEditor, SIGNAL (spellcheck_done(int)),
     this, SLOT (slotSpellcheckDone (int)));
-  connect (mEditor, SIGNAL( pasteImage() ),
-    this, SLOT (slotPaste() ) );
   connect (mEditor, SIGNAL( attachPNGImageData(const QByteArray &) ),
     this, SLOT ( slotAttachPNGImageData(const QByteArray &) ) );
   connect (mEditor, SIGNAL( focusChanged(bool) ),
@@ -401,7 +449,7 @@
   }
 
   initAutoSave();
-
+  slotUpdateSignatureActions();
   mMsg = 0;
   if (aMsg)
     setMsg(aMsg);
@@ -416,7 +464,7 @@
   writeConfig();
   if (mFolder && mMsg)
   {
-    mAutoDeleteMsg = FALSE;
+    mAutoDeleteMsg = false;
     mFolder->addMsg(mMsg);
     // Ensure that the message is correctly and fully parsed
     mFolder->unGetMsg( mFolder->count() - 1 );
@@ -434,6 +482,10 @@
     it = mMapAtmLoadData.begin();
   }
   deleteAll( mComposedMessages );
+
+  for ( std::set<KTempDir*>::iterator it = mTempDirs.begin() ; it != mTempDirs.end() ; ++it ) {
+      delete *it;
+  }
 }
 
 void KMComposeWin::setAutoDeleteWindow( bool f )
@@ -642,6 +694,15 @@
   if (siz.height() < 200) siz.setHeight(200);
   resize(siz);
 
+  if ( !GlobalSettings::self()->snippetSplitterPosition().isEmpty() ) {
+    mSnippetSplitter->setSizes( GlobalSettings::self()->snippetSplitterPosition() );
+  } else {
+    QValueList<int> defaults;
+    defaults << (int)(width() * 0.8) << (int)(width() * 0.2);
+    mSnippetSplitter->setSizes( defaults );
+  }
+
+
   mIdentity->setCurrentIdentity( mId );
 
   kdDebug(5006) << "KMComposeWin::readConfig. " << mIdentity->currentIdentityName() << endl;
@@ -692,9 +753,12 @@
   GlobalSettings::self()->setUseFixedFont( mFixedFontAction->isChecked() );
   GlobalSettings::self()->setUseHtmlMarkup( mHtmlMarkup );
   GlobalSettings::self()->setComposerSize( size() );
+  GlobalSettings::self()->setShowSnippetManager( mSnippetAction->isChecked() );
 
   KConfigGroupSaver saver( KMKernel::config(), "Geometry" );
   saveMainWindowSettings( KMKernel::config(), "Composer" );
+  GlobalSettings::setSnippetSplitterPosition( mSnippetSplitter->sizes() );
+
   // make sure config changes are written to disk, cf. bug 127538
   GlobalSettings::self()->writeConfig();
 }
@@ -731,6 +795,8 @@
     return;
   }
   KMMessage *msg = mComposedMessages.first();
+  if ( !msg ) // a bit of extra defensiveness
+    return;
 
   kdDebug(5006) << k_funcinfo << "opening autoSaveFile " << mAutoSaveFilename
                 << endl;
@@ -877,7 +943,8 @@
   numRows = mNumHeaders + 1;
 
   delete mGrid;
-  mGrid = new QGridLayout(mMainWidget, numRows, 3, KDialogBase::marginHint()/2, KDialogBase::spacingHint());
+
+  mGrid = new QGridLayout( mHeadersArea, numRows, 3, KDialogBase::marginHint()/2, KDialogBase::spacingHint());
   mGrid->setColStretch(0, 1);
   mGrid->setColStretch(1, 100);
   mGrid->setColStretch(2, 1);
@@ -994,7 +1061,6 @@
 
   assert(row<=mNumHeaders);
 
-  mGrid->addMultiCellWidget(mSplitter, row, mNumHeaders, 0, 2);
 
   if( !mAtmList.isEmpty() )
     mAtmListView->show();
@@ -1003,7 +1069,9 @@
   resize(this->size());
   repaint();
 
+  mHeadersArea->setMaximumHeight( mHeadersArea->sizeHint().height() );
   mGrid->activate();
+  mHeadersArea->show();
 
   slotUpdateAttachActions();
   mIdentityAction->setEnabled(!mAllFieldsAction->isChecked());
@@ -1225,7 +1293,7 @@
   KStdAction::redo (this, SLOT(slotRedo()), actionCollection());
   KStdAction::cut (this, SLOT(slotCut()), actionCollection());
   KStdAction::copy (this, SLOT(slotCopy()), actionCollection());
-  KStdAction::pasteText (this, SLOT(slotPaste()), actionCollection());
+  KStdAction::pasteText (this, SLOT(slotPasteClipboard()), actionCollection());
   KStdAction::selectAll (this, SLOT(slotMarkAll()), actionCollection());
 
   KStdAction::find (this, SLOT(slotFind()), actionCollection());
@@ -1234,10 +1302,10 @@
   KStdAction::replace (this, SLOT(slotReplace()), actionCollection());
   KStdAction::spelling (this, SLOT(slotSpellcheck()), actionCollection(), "spellcheck");
 
-  mPasteQuotation = new KAction (i18n("Pa&ste as Quotation"),0,this,SLOT( slotPasteAsQuotation()),
+  mPasteQuotation = new KAction (i18n("Pa&ste as Quotation"),0,this,SLOT( slotPasteClipboardAsQuotation()),
                       actionCollection(), "paste_quoted");
 
-  (void) new KAction (i18n("Paste as Attac&hment"),0,this,SLOT( slotPasteAsAttachment()),
+  (void) new KAction (i18n("Paste as Attac&hment"),0,this,SLOT( slotPasteClipboardAsAttachment()),
                       actionCollection(), "paste_att");
 
   mAddQuoteChars = new KAction(i18n("Add &Quote Characters"), 0, this,
@@ -1271,6 +1339,11 @@
   mWordWrapAction->setChecked(GlobalSettings::self()->wordWrap());
   connect(mWordWrapAction, SIGNAL(toggled(bool)), SLOT(slotWordWrapToggled(bool)));
 
+  mSnippetAction = new KToggleAction ( i18n("&Snippets"), 0,
+                                       actionCollection(), "snippets");
+  connect(mSnippetAction, SIGNAL(toggled(bool)), mSnippetWidget, SLOT(setShown(bool)) );
+  mSnippetAction->setChecked( GlobalSettings::self()->showSnippetManager() );
+
   mAutoSpellCheckingAction =
     new KToggleAction( i18n( "&Automatic Spellchecking" ), "spellcheck", 0,
                        actionCollection(), "options_auto_spellchecking" );
@@ -1281,7 +1354,7 @@
   connect( mAutoSpellCheckingAction, SIGNAL( toggled( bool ) ),
            this, SLOT( slotAutoSpellCheckingToggled( bool ) ) );
 
-  QStringList encodings = KMMsgBase::supportedEncodings(TRUE);
+  QStringList encodings = KMMsgBase::supportedEncodings(true);
   encodings.prepend( i18n("Auto-Detect"));
   mEncodingAction->setItems( encodings );
   mEncodingAction->setCurrentItem( -1 );
@@ -1328,9 +1401,17 @@
                                      actionCollection(), "show_subject");
   //end of checkable
 
-  (void) new KAction (i18n("Append S&ignature"), 0, this,
+  mAppendSignatureAction = new KAction (i18n("Append S&ignature"), 0, this,
                       SLOT(slotAppendSignature()),
                       actionCollection(), "append_signature");
+  mPrependSignatureAction =  new KAction (i18n("Prepend S&ignature"), 0, this,
+                      SLOT(slotPrependSignature()),
+                      actionCollection(), "prepend_signature");
+
+  mInsertSignatureAction =  new KAction (i18n("Insert Signature At C&ursor Position"), "edit", 0, this,
+                      SLOT(slotInsertSignatureAtCursor()),
+                      actionCollection(), "insert_signature_at_cursor_position");
+
   mAttachPK  = new KAction (i18n("Attach &Public Key..."), 0, this,
                            SLOT(slotInsertPublicKey()),
                            actionCollection(), "attach_public_key");
@@ -1454,7 +1535,7 @@
   alignLeftAction = new KToggleAction (i18n("Align Left"), "text_left", 0,
                       this, SLOT(slotAlignLeft()), actionCollection(),
                       "align_left");
-  alignLeftAction->setChecked( TRUE );
+  alignLeftAction->setChecked( true );
   alignRightAction = new KToggleAction (i18n("Align Right"), "text_right", 0,
                       this, SLOT(slotAlignRight()), actionCollection(),
                       "align_right");
@@ -1520,20 +1601,12 @@
 void KMComposeWin::setupEditor(void)
 {
   //QPopupMenu* menu;
-  mEditor->setModified(FALSE);
+  mEditor->setModified(false);
   QFontMetrics fm(mBodyFont);
   mEditor->setTabStopWidth(fm.width(QChar(' ')) * 8);
   //mEditor->setFocusPolicy(QWidget::ClickFocus);
 
-  if (GlobalSettings::self()->wordWrap())
-  {
-    mEditor->setWordWrap( QTextEdit::FixedColumnWidth );
-    mEditor->setWrapColumnOrWidth( GlobalSettings::self()->lineWrapWidth() );
-  }
-  else
-  {
-    mEditor->setWordWrap( QTextEdit::NoWrap );
-  }
+  slotWordWrapToggled( GlobalSettings::self()->wordWrap() );
 
   // Font setup
   slotUpdateFont();
@@ -1550,7 +1623,7 @@
   //#endif //BROKEN
   menu->insertItem(i18n("Cut"), this, SLOT(slotCut()));
   menu->insertItem(i18n("Copy"), this, SLOT(slotCopy()));
-  menu->insertItem(i18n("Paste"), this, SLOT(slotPaste()));
+  menu->insertItem(i18n("Paste"), this, SLOT(slotPasteClipboard()));
   menu->insertItem(i18n("Mark All"),this, SLOT(slotMarkAll()));
   menu->insertSeparator();
   menu->insertItem(i18n("Find..."), this, SLOT(slotFind()));
@@ -1746,33 +1819,37 @@
   }
   mEdtSubject->setText(mMsg->subject());
 
-  if (!mBtnIdentity->isChecked() && !newMsg->headerField("X-KMail-Identity").isEmpty())
+  const bool stickyIdentity = mBtnIdentity->isChecked();
+  const bool messageHasIdentity = !newMsg->headerField("X-KMail-Identity").isEmpty();
+  if (!stickyIdentity && messageHasIdentity)
     mId = newMsg->headerField("X-KMail-Identity").stripWhiteSpace().toUInt();
 
   // don't overwrite the header values with identity specific values
   // unless the identity is sticky
-  if ( !mBtnIdentity->isChecked() ) {
+  if ( !stickyIdentity ) {
     disconnect(mIdentity,SIGNAL(identityChanged(uint)),
                this, SLOT(slotIdentityChanged(uint)));
   }
-   mIdentity->setCurrentIdentity( mId );
-  if ( !mBtnIdentity->isChecked() ) {
+  // load the mId into the gui, sticky or not, without emitting
+  mIdentity->setCurrentIdentity( mId );
+  const uint idToApply = mId;
+  if ( !stickyIdentity ) {
     connect(mIdentity,SIGNAL(identityChanged(uint)),
             this, SLOT(slotIdentityChanged(uint)));
-  }
-  else {
-    // make sure the header values are overwritten with the values of the
-    // sticky identity (the slot isn't called by the signal for new messages
-    // since the identity has already been set before the signal was connected)
-    uint savedId = mId;
-    if ( !newMsg->headerField("X-KMail-Identity").isEmpty() )
+  }  else {
+    // load the message's state into the mId, without applying it to the gui
+    // that's so we can detect that the id changed (because a sticky was set)
+    // on apply()
+    if ( messageHasIdentity )
       mId = newMsg->headerField("X-KMail-Identity").stripWhiteSpace().toUInt();
     else
       mId = im->defaultIdentity().uoid();
-    slotIdentityChanged( savedId );
   }
+  // manually load the identity's value into the fields; either the one from the
+  // messge, where appropriate, or the one from the sticky identity. What's in
+  // mId might have changed meanwhile, thus the save value
+  slotIdentityChanged( idToApply );
 
-
   const KPIM::Identity & ident = im->identityForUoid( mIdentity->currentIdentity() );
 
   // check for the presence of a DNT header, indicating that MDN's were
@@ -1830,6 +1907,9 @@
     mLastSignActionState = (mMsg->headerField( "X-KMail-SignatureActionEnabled" ) == "true");
   if ( mMsg->headers().FindField( "X-KMail-EncryptActionEnabled" ) )
     mLastEncryptActionState = (mMsg->headerField( "X-KMail-EncryptActionEnabled" ) == "true");
+  if ( mMsg->headers().FindField( "X-KMail-CryptoMessageFormat" ) )
+    mCryptoModuleAction->setCurrentItem( format2cb( static_cast<Kleo::CryptoMessageFormat>(
+                    mMsg->headerField( "X-KMail-CryptoMessageFormat" ).toInt() ) ) );
 
   mLastIdentityHasSigningKey = !ident.pgpSigningKey().isEmpty() || !ident.smimeSigningKey().isEmpty();
   mLastIdentityHasEncryptionKey = !ident.pgpEncryptionKey().isEmpty() || !ident.smimeEncryptionKey().isEmpty();
@@ -1843,6 +1923,7 @@
     setEncryption( mLastEncryptActionState );
     setSigning( ( canOpenPGPSign || canSMIMESign ) && mLastSignActionState );
   }
+  slotUpdateSignatureAndEncrypionStateIndicators();
 
   // "Attach my public key" is only possible if the user uses OpenPGP
   // support and he specified his key:
@@ -2022,7 +2103,12 @@
     // Not user friendy if this modal fileseletor opens before the
     // composer.
     //
-    QTimer::singleShot( 200, this, SLOT(slotAppendSignature()) );
+    //QTimer::singleShot( 200, this, SLOT(slotAppendSignature()) );
+      if ( GlobalSettings::self()->prependSignature() ) {
+        QTimer::singleShot( 0, this, SLOT(slotPrependSignature()) );
+      } else {
+        QTimer::singleShot( 0, this, SLOT(slotAppendSignature()) );
+      }
   }
 
   if ( mMsg->getCursorPos() > 0 ) {
@@ -2264,6 +2350,14 @@
                         .arg( aUrl.prettyURL() ) );
     return false;
   }
+
+  const int maxAttachmentSize = GlobalSettings::maximumAttachmentSize();
+  const uint maximumAttachmentSizeInByte = maxAttachmentSize*1024*1024;
+  if ( aUrl.isLocalFile() && QFileInfo( aUrl.pathOrURL() ).size() > maximumAttachmentSizeInByte ) {
+    KMessageBox::sorry( this, i18n( "<qt><p>Your administrator has disallowed attaching files bigger than %1 MB.</p>" ).arg( maxAttachmentSize ) );
+    return false;
+  }
+
   KIO::TransferJob *job = KIO::get(aUrl);
   KIO::Scheduler::scheduleJob( job );
   atmLoadData ld;
@@ -2385,7 +2479,7 @@
 //-----------------------------------------------------------------------------
 void KMComposeWin::removeAttach(int idx)
 {
-  mAtmModified = TRUE;
+  mAtmModified = true;
   mAtmList.remove(idx);
   delete mAtmItemList.take(idx);
 
@@ -2543,7 +2637,7 @@
 
   QStringList encodings = mEncodingAction->items();
   int i = 0;
-  bool charsetFound = FALSE;
+  bool charsetFound = false;
   for ( QStringList::Iterator it = encodings.begin(); it != encodings.end();
      ++it, i++ )
   {
@@ -2554,11 +2648,11 @@
     {
       mEncodingAction->setCurrentItem( i );
       slotSetCharset();
-      charsetFound = TRUE;
+      charsetFound = true;
       break;
     }
   }
-  if (!aCharset.isEmpty() && !charsetFound) setCharset("", TRUE);
+  if (!aCharset.isEmpty() && !charsetFound) setCharset("", true);
 }
 
 
@@ -2596,7 +2690,7 @@
   // We will not care about any permissions, existence or whatsoever in
   // this function.
 
-  KFileDialog fdlg(QString::null, QString::null, this, 0, TRUE);
+  KFileDialog fdlg(QString::null, QString::null, this, 0, true);
   fdlg.setOperationMode( KFileDialog::Other );
   fdlg.setCaption(i18n("Attach File"));
   fdlg.okButton()->setGuiItem(KGuiItem(i18n("&Attach"),"fileopen"));
@@ -2752,7 +2846,7 @@
       return;
     }
   }
-  mAtmModified = TRUE;
+  mAtmModified = true;
   if (msgPart->typeStr().lower() != "text") msgPart->setCharset(QCString());
 
   // add the new attachment to the list
@@ -2766,11 +2860,11 @@
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotInsertFile()
 {
-  KFileDialog fdlg(QString::null, QString::null, this, 0, TRUE);
+  KFileDialog fdlg(QString::null, QString::null, this, 0, true);
   fdlg.setOperationMode( KFileDialog::Opening );
   fdlg.okButton()->setText(i18n("&Insert"));
   fdlg.setCaption(i18n("Insert File"));
-  fdlg.toolBar()->insertCombo(KMMsgBase::supportedEncodings(FALSE), 4711,
+  fdlg.toolBar()->insertCombo(KMMsgBase::supportedEncodings(false), 4711,
     false, 0, 0, 0);
   KComboBox *combo = fdlg.toolBar()->getCombo(4711);
   for (int i = 0; i < combo->count(); i++)
@@ -3025,6 +3119,9 @@
                              SLOT(slotAttachOpenWith()));
      mViewId = mAttachMenu->insertItem(i18n("to view", "View"), this,
                              SLOT(slotAttachView()));
+     mEditId = mAttachMenu->insertItem( i18n("Edit"), this, SLOT(slotAttachEdit()) );
+     mEditWithId = mAttachMenu->insertItem( i18n("Edit With..."), this,
+                                            SLOT(slotAttachEditWith()) );
      mRemoveId = mAttachMenu->insertItem(i18n("Remove"), this, SLOT(slotAttachRemove()));
      mSaveAsId = mAttachMenu->insertItem( SmallIconSet("filesaveas"), i18n("Save As..."), this,
                                           SLOT( slotAttachSave() ) );
@@ -3044,6 +3141,8 @@
   mAttachMenu->setItemEnabled( mOpenId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mOpenWithId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mViewId, selectedCount > 0 );
+  mAttachMenu->setItemEnabled( mEditId, selectedCount == 1 );
+  mAttachMenu->setItemEnabled( mEditWithId, selectedCount == 1 );
   mAttachMenu->setItemEnabled( mRemoveId, selectedCount > 0 );
   mAttachMenu->setItemEnabled( mSaveAsId, selectedCount == 1 );
   mAttachMenu->setItemEnabled( mPropertiesId, selectedCount == 1 );
@@ -3085,7 +3184,7 @@
   }
   if (dlg.exec())
   {
-    mAtmModified = TRUE;
+    mAtmModified = true;
     // values may have changed, so recreate the listbox line
     if( listItem ) {
       msgPartToItem(msgPart, listItem);
@@ -3284,6 +3383,26 @@
   }
 }
 
+void KMComposeWin::slotAttachEdit()
+{
+  int i = 0;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
+    if ( (*it)->isSelected() ) {
+      editAttach( i, false );
+    }
+  }
+}
+
+void KMComposeWin::slotAttachEditWith()
+{
+  int i = 0;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
+    if ( (*it)->isSelected() ) {
+      editAttach( i, true );
+    }
+  }
+}
+
 //-----------------------------------------------------------------------------
 bool KMComposeWin::inlineSigningEncryptionSelected() {
   if ( !mSignAction->isChecked() && !mEncryptAction->isChecked() )
@@ -3351,6 +3470,27 @@
   }
 }
 
+void KMComposeWin::editAttach(int index, bool openWith)
+{
+  KMMessagePart* msgPart = mAtmList.at(index);
+  const QString contentTypeStr =
+    ( msgPart->typeStr() + '/' + msgPart->subtypeStr() ).lower();
+
+  KTempFile* atmTempFile = new KTempFile();
+  mAtmTempList.append( atmTempFile );
+  atmTempFile->setAutoDelete( true );
+  atmTempFile->file()->writeBlock( msgPart->bodyDecodedBinary() );
+  atmTempFile->file()->flush();
+
+
+  KMail::EditorWatcher *watcher = new KMail::EditorWatcher( KURL( atmTempFile->name() ), contentTypeStr, openWith, this );
+  connect( watcher, SIGNAL(editDone(KMail::EditorWatcher*)), SLOT(slotEditDone(KMail::EditorWatcher*)) );
+  if ( watcher->start() ) {
+    mEditorMap.insert( watcher, msgPart );
+    mEditorTempFiles.insert( watcher, atmTempFile );
+  }
+}
+
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotAttachSave()
 {
@@ -3437,7 +3577,7 @@
     return quotePrefix;
 }
 
-void KMComposeWin::slotPasteAsQuotation()
+void KMComposeWin::slotPasteClipboardAsQuotation()
 {
     if( mEditor->hasFocus() && msg() )
     {
@@ -3447,7 +3587,7 @@
     }
 }
 
-void KMComposeWin::slotPasteAsAttachment()
+void KMComposeWin::slotPasteClipboardAsAttachment()
 {
   KURL url( QApplication::clipboard()->text( QClipboard::Clipboard ) );
   if ( url.isValid() ) {
@@ -3598,25 +3738,50 @@
 
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::slotPaste()
+void KMComposeWin::slotPasteClipboard()
 {
+  paste( QClipboard::Clipboard );
+}
+
+void KMComposeWin::paste( QClipboard::Mode mode )
+{
   QWidget* fw = focusWidget();
   if (!fw) return;
 
-  QMimeSource *mimeSource = QApplication::clipboard()->data();
+  QMimeSource *mimeSource = QApplication::clipboard()->data( mode );
   if ( mimeSource->provides("image/png") )  {
     slotAttachPNGImageData(mimeSource->encodedData("image/png"));
-  }
-  else {
+  } else if ( KURLDrag::canDecode( mimeSource ) ) {
+        KURL::List urlList;
+        if( KURLDrag::decode( mimeSource, urlList ) ) {
+            const QString asText = i18n("Add as Text");
+            const QString asAttachment = i18n("Add as Attachment");
+            const QString text = i18n("Please select whether you want to insert the content as text into the editor, "
+                    "or append the referenced file as an attachment.");
+            const QString caption = i18n("Paste as text or attachment?");
 
-#ifdef KeyPress
-#undef KeyPress
-#endif
-
-    QKeyEvent k(QEvent::KeyPress, Key_V, 0, ControlButton);
-    kapp->notify(fw, &k);
+            int id = KMessageBox::questionYesNoCancel( this, text, caption,
+                    KGuiItem( asText ), KGuiItem( asAttachment) );
+            switch ( id) {
+              case KMessageBox::Yes:
+                for ( KURL::List::Iterator it = urlList.begin();
+                     it != urlList.end(); ++it ) {
+                  mEditor->insert( (*it).url() );
+                }
+                break;
+              case KMessageBox::No:
+                for ( KURL::List::Iterator it = urlList.begin();
+                     it != urlList.end(); ++it ) {
+                  addAttach( *it );
+                }
+                break;
+            }
+        }
+  } else if ( QTextDrag::canDecode( mimeSource ) ) {
+      QString s;
+      if ( QTextDrag::decode( mimeSource, s ) )
+          mEditor->insert( s );
   }
-
 }
 
 
@@ -3636,7 +3801,7 @@
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotClose()
 {
-  close(FALSE);
+  close(false);
 }
 
 
@@ -3677,6 +3842,7 @@
 void KMComposeWin::slotEncryptToggled(bool on)
 {
   setEncryption( on, true /* set by the user */ );
+  slotUpdateSignatureAndEncrypionStateIndicators();
 }
 
 
@@ -3727,6 +3893,7 @@
 void KMComposeWin::slotSignToggled(bool on)
 {
   setSigning( on, true /* set by the user */ );
+  slotUpdateSignatureAndEncrypionStateIndicators();
 }
 
 
@@ -3777,11 +3944,17 @@
   }
   else
   {
-    mEditor->setWordWrap( QTextEdit::NoWrap );
+    mEditor->setWordWrap( QTextEdit::WidgetWidth );
   }
 }
 
 
+void KMComposeWin::disableWordWrap()
+{
+    mEditor->setWordWrap( QTextEdit::NoWrap );
+}
+
+
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotPrint()
 {
@@ -3851,23 +4024,26 @@
                                "not have to enter it for each message.") );
       return;
     }
-    if ( to().isEmpty() ) {
-      if (  cc().isEmpty() && bcc().isEmpty()) {
-        if ( mEdtTo ) mEdtTo->setFocus();
-        KMessageBox::information( this,
-                                  i18n("You must specify at least one receiver,"
-                                       "either in the To: field or as CC or as BCC.") );
-        return;
-      } else {
-        if ( mEdtTo )mEdtTo->setFocus();
-        int rc = KMessageBox::questionYesNo( this,
-                                             i18n("To: field is empty. "
-                                                  "Send message anyway?"),
-                                             i18n("No To: specified") );
-        if ( rc == KMessageBox::No ) {
+    if ( to().isEmpty() )
+    {
+        if (  cc().isEmpty() && bcc().isEmpty()) {
+          if ( mEdtTo ) mEdtTo->setFocus();
+          KMessageBox::information( this,
+                                i18n("You must specify at least one receiver,"
+                                     "either in the To: field or as CC or as BCC.") );
           return;
         }
-      }
+        else {
+                if ( mEdtTo ) mEdtTo->setFocus();
+                int rc =
+                            KMessageBox::questionYesNo( this,
+                                                        i18n("To field is missing."
+                                                              "Send message anyway?"),
+                                                        i18n("No To: specified") );
+                if ( rc == KMessageBox::No ){
+                   return;
+                }
+        }
     }
 
     // Validate the To:, CC: and BCC fields
@@ -3955,13 +4131,15 @@
   }
 
   if (neverEncrypt && saveIn != KMComposeWin::None ) {
-      // we can't use the state of the mail itself, to remember the 
+      // we can't use the state of the mail itself, to remember the
       // signing and encryption state, so let's add a header instead
     mMsg->setHeaderField( "X-KMail-SignatureActionEnabled", mSignAction->isChecked()? "true":"false" );
     mMsg->setHeaderField( "X-KMail-EncryptActionEnabled", mEncryptAction->isChecked()? "true":"false"  );
+    mMsg->setHeaderField( "X-KMail-CryptoMessageFormat", QString::number( cryptoMessageFormat() ) );
   } else {
     mMsg->removeHeaderField( "X-KMail-SignatureActionEnabled" );
     mMsg->removeHeaderField( "X-KMail-EncryptActionEnabled" );
+    mMsg->removeHeaderField( "X-KMail-CryptoMessageFormat" );
   }
 
 
@@ -3997,12 +4175,15 @@
   if ( imapTheFolder && imapTheFolder->noContent() )
     imapTheFolder = 0;
 
-  if ( theFolder == 0 )
+  bool didOpen = false;
+  if ( theFolder == 0 ) {
     theFolder = ( mSaveIn==KMComposeWin::Drafts ?
                   kmkernel->draftsFolder() : kmkernel->templatesFolder() );
-
-  theFolder->open("composer");
-
+  } else {
+    //XXX this looks really, really fishy
+    theFolder->open( "composer" );
+    didOpen = true;
+  }
   kdDebug(5006) << k_funcinfo << "theFolder=" << theFolder->name() << endl;
   if ( imapTheFolder )
     kdDebug(5006) << k_funcinfo << "imapTheFolder=" << imapTheFolder->name() << endl;
@@ -4020,7 +4201,8 @@
     (static_cast<KMFolderImap*>( imapTheFolder->storage() ))->getFolder();
   }
 
-  theFolder->close( "composer" );
+  if ( didOpen )
+    theFolder->close( "composer" );
   return sentOk;
 }
 
@@ -4072,7 +4254,7 @@
   RecentAddresses::self( KMKernel::config() )->add( to() );
 
   setModified( false );
-  mAutoDeleteMsg = FALSE;
+  mAutoDeleteMsg = false;
   mFolder = 0;
   cleanupAutoSave();
   close();
@@ -4146,16 +4328,43 @@
 //----------------------------------------------------------------------------
 void KMComposeWin::slotAppendSignature()
 {
-  bool mod = mEditor->isModified();
+    insertSignature();
+}
 
-  const KPIM::Identity & ident =
-    kmkernel->identityManager()->identityForUoidOrDefault( mIdentity->currentIdentity() );
-  mOldSigText = ident.signatureText();
-  if( !mOldSigText.isEmpty() )
-  {
-    mEditor->append(mOldSigText);
+//----------------------------------------------------------------------------
+void KMComposeWin::slotPrependSignature()
+{
+    insertSignature( false );
+}
+
+//----------------------------------------------------------------------------
+void KMComposeWin::slotInsertSignatureAtCursor()
+{
+    insertSignature( false, mEditor->currentLine() );
+}
+
+//----------------------------------------------------------------------------
+void KMComposeWin::insertSignature( bool append, int pos )
+{
+   bool mod = mEditor->isModified();
+
+   const KPIM::Identity &ident =
+     kmkernel->identityManager()->
+     identityForUoidOrDefault( mIdentity->currentIdentity() );
+
+   mOldSigText = GlobalSettings::self()->prependSignature()? ident.signature().rawText() : ident.signatureText();
+
+   if( !mOldSigText.isEmpty() )
+   {
+      mEditor->sync();
+      if ( append ) {
+       mEditor->append(mOldSigText);
+    } else {
+       mEditor->insertAt(mOldSigText, pos, 0);
+    }
+    mEditor->update();
     mEditor->setModified(mod);
-    // mEditor->setContentsPos( 0, 0 );
+
     if (  mPreserveUserCursorPosition ) {
       mEditor->setCursorPositionFromStart( (unsigned int) mMsg->getCursorPos() );
       // Only keep the cursor from the mMsg *once* based on the
@@ -4163,12 +4372,17 @@
       // the message comes from a template with a specific cursor
       // position set and the signature is appended automatically.
       mPreserveUserCursorPosition = false;
+    } else {
+      // for append and prepend, move the cursor to 0,0, for insertAt,
+      // keep it in the same row, but move to first column
+      mEditor->setCursorPosition( pos, 0 );
+      if ( !append && pos == 0 )
+        mEditor->setContentsPos( 0, 0 );
     }
     mEditor->sync();
   }
 }
 
-
 //-----------------------------------------------------------------------------
 void KMComposeWin::slotHelp()
 {
@@ -4329,7 +4543,7 @@
 {
   if (mSpellCheckInProgress) return;
   mSubjectTextWasSpellChecked = false;
-  mSpellCheckInProgress=TRUE;
+  mSpellCheckInProgress=true;
   /*
     connect (mEditor, SIGNAL (spellcheck_progress (unsigned)),
     this, SLOT (spell_progress (unsigned)));
@@ -4337,7 +4551,27 @@
 
   mEditor->spellcheck();
 }
+//-----------------------------------------------------------------------------
+void KMComposeWin::slotUpdateSignatureActions()
+{
+  //Check if an identity has signature or not and turn on/off actions in the
+  //edit menu accordingly.
+  const KPIM::Identity & ident =
+    kmkernel->identityManager()->identityForUoidOrDefault( mIdentity->currentIdentity() );
+  QString sig = ident.signatureText();
 
+  if ( sig.isEmpty() ) {
+     mAppendSignatureAction->setEnabled( false );
+     mPrependSignatureAction->setEnabled( false );
+     mInsertSignatureAction->setEnabled( false );
+  }
+  else {
+      mAppendSignatureAction->setEnabled( true );
+      mPrependSignatureAction->setEnabled( true );
+      mInsertSignatureAction->setEnabled( true );
+  }
+}
+
 void KMComposeWin::polish()
 {
   // Ensure the html toolbar is appropriately shown/hidden
@@ -4353,7 +4587,7 @@
 void KMComposeWin::slotSpellcheckDone(int result)
 {
   kdDebug(5006) << "spell check complete: result = " << result << endl;
-  mSpellCheckInProgress=FALSE;
+  mSpellCheckInProgress=false;
 
   switch( result )
   {
@@ -4383,6 +4617,9 @@
     kmkernel->identityManager()->identityForUoid( uoid );
   if( ident.isNull() ) return;
 
+  //Turn on/off signature actions if identity has no signature.
+  slotUpdateSignatureActions();
+
   if( !ident.fullEmailAddr().isNull() )
     mEdtFrom->setText(ident.fullEmailAddr());
   // make sure the From field is shown if it does not contain a valid email address
@@ -4916,5 +5153,67 @@
   resetter.disable();
 }
 
+void KMComposeWin::slotEditDone(KMail::EditorWatcher * watcher)
+{
+  kdDebug(5006) << k_funcinfo << endl;
+  KMMessagePart *part = mEditorMap[ watcher ];
+  KTempFile *tf = mEditorTempFiles[ watcher ];
+  mEditorMap.remove( watcher );
+  mEditorTempFiles.remove( watcher );
+  if ( !watcher->fileChanged() )
+    return;
 
+  tf->file()->reset();
+  QByteArray data = tf->file()->readAll();
+  part->setBodyEncodedBinary( data );
+}
 
+
+void KMComposeWin::slotUpdateSignatureAndEncrypionStateIndicators()
+{
+    const bool showIndicatorsAlways = false; // FIXME config option?
+    mSignatureStateIndicator->setText( mSignAction->isChecked()? i18n("Message will be signed") : i18n("Message will not be signed") );
+    mEncryptionStateIndicator->setText( mEncryptAction->isChecked()? i18n("Message will be encrypted") : i18n("Message will not be encrypted") );
+    if ( !showIndicatorsAlways ) {
+      mSignatureStateIndicator->setShown( mSignAction->isChecked() );
+      mEncryptionStateIndicator->setShown( mEncryptAction->isChecked() );
+    }
+}
+
+void KMComposeWin::slotAttachmentDragStarted()
+{
+  kdDebug(5006) << k_funcinfo << endl;
+  int idx = 0;
+  QStringList filenames;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++idx ) {
+    if ( (*it)->isSelected() ) {
+      KMMessagePart* msgPart = mAtmList.at(idx);
+      KTempDir * tempDir = new KTempDir(); // will be deleted on composer close
+      tempDir->setAutoDelete( true );
+      mTempDirs.insert( tempDir );
+      const QString fileName = tempDir->name() + "/" + msgPart->name();
+      KPIM::kByteArrayToFile(msgPart->bodyDecodedBinary(),
+                             fileName,
+                             false, false, false);
+      KURL url;
+      url.setPath( fileName );
+      filenames << url.path();
+    }
+  }
+  if ( filenames.isEmpty() ) return;
+
+  QUriDrag *drag  = new QUriDrag( mAtmListView );
+  drag->setFileNames( filenames );
+  drag->dragCopy();
+}
+
+void KMComposeWin::recipientEditorSizeHintChanged()
+{
+  QTimer::singleShot( 1, this, SLOT(setMaximumHeaderSize()) );
+}
+
+void KMComposeWin::setMaximumHeaderSize()
+{
+  mHeadersArea->setMaximumHeight( mHeadersArea->sizeHint().height() );
+}
+
Index: kmail/kmreaderwin.h
===================================================================
--- kmail/kmreaderwin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmreaderwin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -76,6 +76,7 @@
   friend void KMMimePartTree::itemClicked( QListViewItem* item );
   friend void KMMimePartTree::itemRightClicked( QListViewItem* item, const QPoint & );
   friend void KMMimePartTree::slotSaveAs();
+  friend void KMMimePartTree::startDrag();
 
   friend class KMail::ObjectTreeParser;
   friend class KMail::KHtmlPartHtmlWriter;
@@ -127,6 +128,8 @@
   /** Set the override character encoding. */
   void setOverrideEncoding( const QString & encoding );
 
+  void setPrintFont( const QFont& font );
+
   /** Get codec corresponding to the currently selected override character encoding.
       @return The override codec or 0 if auto-detection is selected. */
   const QTextCodec * overrideCodec() const;
@@ -244,6 +247,8 @@
 
   partNode * partNodeForId( int id );
 
+  KURL tempFileUrlFromPartNode( const partNode * node );
+
   /** Returns id of message part from given URL or -1 if invalid. */
   static int msgPartFromUrl(const KURL &url);
 
@@ -275,6 +280,18 @@
 
   QWidget* mainWindow() { return mMainWindow; }
 
+  /** Returns wether the message should be decryted. */
+  bool decryptMessage() const;
+
+  /** Enforce message decryption. */
+  void setDecryptMessageOverwrite( bool overwrite = true ) { mDecrytMessageOverwrite = overwrite; }
+
+  /** Show signature details. */
+  bool showSignatureDetails() const { return mShowSignatureDetails; }
+
+  /** Show signature details. */
+  void setShowSignatureDetails( bool showDetails = true ) { mShowSignatureDetails = showDetails; }
+
 signals:
   /** Emitted after parsing of a message to have it stored
       in unencrypted state in it's folder. */
@@ -356,10 +373,16 @@
   void slotLevelQuote( int l );
   void slotTouchMessage();
 
+  void slotDeleteAttachment( partNode* node );
+  void slotEditAttachment( partNode* node );
+
+  KMail::CSSHelper* cssHelper();
+
 protected slots:
   void slotCycleHeaderStyles();
   void slotBriefHeaders();
   void slotFancyHeaders();
+  void slotEnterpriseHeaders();
   void slotStandardHeaders();
   void slotLongHeaders();
   void slotAllHeaders();
@@ -399,7 +422,7 @@
 
   /** Creates a nice mail header depending on the current selected
     header style. */
-  QString writeMsgHeader(KMMessage* aMsg, bool hasVCard=false);
+  QString writeMsgHeader(KMMessage* aMsg, bool hasVCard=false, bool topLevel=false);
 
   /** Writes the given message part to a temporary file and returns the
       name of this file or QString::null if writing failed.
@@ -431,13 +454,13 @@
 
 private slots:
   void slotSetEncoding();
+  void injectAttachments();
 
 private:
   void adjustLayout();
   void createWidgets();
   void createActions( KActionCollection * ac );
   void saveSplitterSizes( KConfigBase & c ) const;
-  QString createAtmFileLink() const;
 
   KRadioAction * actionForHeaderStyle( const KMail::HeaderStyle *,
                                        const KMail::HeaderStrategy * );
@@ -445,6 +468,8 @@
   /** Read override codec from configuration */
   void readGlobalOverrideCodec();
 
+  QString renderAttachments( partNode *node, const QColor &bgColor );
+
 private:
   bool mHtmlMail, mHtmlLoadExternal, mHtmlOverride, mHtmlLoadExtOverride;
   int mAtmCurrent;
@@ -464,7 +489,7 @@
   /** where did the user save the attachment last time */
   QString mSaveAttachDir;
   static const int delay;
-  QTimer updateReaderWinTimer;
+  QTimer mUpdateReaderWinTimer;
   QTimer mResizeTimer;
   QTimer mDelayedMarkTimer;
   QString mOverrideEncoding;
@@ -501,6 +526,8 @@
   unsigned long mWaitingForSerNum;
   float mSavedRelativePosition;
 	int mLevelQuote;
+  bool mDecrytMessageOverwrite;
+  bool mShowSignatureDetails;
 };
 
 
Index: kmail/headerstyle.h
===================================================================
--- kmail/headerstyle.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/headerstyle.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -57,7 +57,7 @@
     //
     // Factory methods:
     //
-    enum Type { Brief, Plain, Fancy };
+    enum Type { Brief, Plain, Fancy, Enterprise };
 
     static const HeaderStyle * create( Type type );
     static const HeaderStyle * create( const QString & type );
@@ -65,6 +65,7 @@
     static const HeaderStyle * brief();
     static const HeaderStyle * plain();
     static const HeaderStyle * fancy();
+    static const HeaderStyle * enterprise();
 
     //
     // Methods for handling the styles:
@@ -79,7 +80,7 @@
     virtual QString format( const KMMessage * message,
 			    const KMail::HeaderStrategy * strategy,
 			    const QString & vCardName,
-			    bool printing=false ) const = 0;
+			    bool printing=false, bool topLevel = false ) const = 0;
   };
 
 } // namespace KMail
Index: kmail/kmfolderdia.cpp
===================================================================
--- kmail/kmfolderdia.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderdia.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -455,9 +455,14 @@
       mContentsComboBox->setCurrentItem( mDlg->folder()->storage()->contentsType() );
     connect ( mContentsComboBox, SIGNAL ( activated( int ) ),
               this, SLOT( slotFolderContentsSelectionChanged( int ) ) );
+    if ( mDlg->folder()->isReadOnly() )
+      mContentsComboBox->setEnabled( false );
   } else {
     mContentsComboBox = 0;
   }
+  
+  mIncidencesForComboBox = 0;
+  mAlarmsBlockedCheckBox = 0;
 
   // Kolab incidences-for annotation.
   // Show incidences-for combobox if the contents type can be changed (new folder),
@@ -466,39 +471,49 @@
          GlobalSettings::EnumTheIMAPResourceStorageFormat::XML ) &&
       mContentsComboBox ) {
     ++row;
+
     QLabel* label = new QLabel( i18n( "Generate free/&busy and activate alarms for:" ), this );
     gl->addWidget( label, row, 0 );
     mIncidencesForComboBox = new QComboBox( this );
     label->setBuddy( mIncidencesForComboBox );
     gl->addWidget( mIncidencesForComboBox, row, 1 );
 
-    QWhatsThis::add( mIncidencesForComboBox,
-                     i18n( "This setting defines which users sharing "
-                           "this folder should get \"busy\" periods in their freebusy lists "
-                           "and should see the alarms for the events or tasks in this folder. "
-                           "The setting applies to Calendar and Task folders only "
-                           "(for tasks, this setting is only used for alarms).\n\n"
-                           "Example use cases: if the boss shares a folder with his secretary, "
-                           "only the boss should be marked as busy for his meetings, so he should "
-                           "select \"Admins\", since the secretary has no admin rights on the folder.\n"
-                           "On the other hand if a working group shares a Calendar for "
-                           "group meetings, all readers of the folders should be marked "
-                           "as busy for meetings.\n"
-                           "A company-wide folder with optional events in it would use \"Nobody\" "
-                           "since it is not known who will go to those events." ) );
+    const QString whatsThisForMyOwnFolders = 
+      i18n( "This setting defines which users sharing "
+          "this folder should get \"busy\" periods in their freebusy lists "
+          "and should see the alarms for the events or tasks in this folder. "
+          "The setting applies to Calendar and Task folders only "
+          "(for tasks, this setting is only used for alarms).\n\n"
+          "Example use cases: if the boss shares a folder with his secretary, "
+          "only the boss should be marked as busy for his meetings, so he should "
+          "select \"Admins\", since the secretary has no admin rights on the folder.\n"
+          "On the other hand if a working group shares a Calendar for "
+          "group meetings, all readers of the folders should be marked "
+          "as busy for meetings.\n"
+          "A company-wide folder with optional events in it would use \"Nobody\" "
+          "since it is not known who will go to those events." );
 
+    QWhatsThis::add( mIncidencesForComboBox, whatsThisForMyOwnFolders );
     mIncidencesForComboBox->insertItem( i18n( "Nobody" ) );
     mIncidencesForComboBox->insertItem( i18n( "Admins of This Folder" ) );
     mIncidencesForComboBox->insertItem( i18n( "All Readers of This Folder" ) );
+    ++row;
+    const QString whatsThisForReadOnlyFolders =
+      i18n( "This setting allows you to disable alarms for folders shared by "
+          "others. ");
+    mAlarmsBlockedCheckBox = new QCheckBox( this );
+    gl->addWidget( mAlarmsBlockedCheckBox, row, 0 );
+    label = new QLabel( i18n( "Block free/&busy and alarms locally" ), this );
+    gl->addWidget( label, row, 1 );
+    label->setBuddy( mAlarmsBlockedCheckBox );
+    QWhatsThis::add( mAlarmsBlockedCheckBox, whatsThisForReadOnlyFolders );
 
     if ( mDlg->folder()->storage()->contentsType() != KMail::ContentsTypeCalendar
       && mDlg->folder()->storage()->contentsType() != KMail::ContentsTypeTask ) {
-      mIncidencesForComboBox->setEnabled( false );
+        mIncidencesForComboBox->setEnabled( false );
+        mAlarmsBlockedCheckBox->setEnabled( false );
     }
-  } else {
-    mIncidencesForComboBox = 0;
   }
-
   topLayout->addStretch( 100 ); // eat all superfluous space
 
   initializeWithValuesFromFolder( mDlg->folder() );
@@ -547,7 +562,12 @@
   if ( mIncidencesForComboBox ) {
     KMFolderCachedImap* dimap = static_cast<KMFolderCachedImap *>( folder->storage() );
     mIncidencesForComboBox->setCurrentItem( dimap->incidencesFor() );
+    mIncidencesForComboBox->setDisabled( mDlg->folder()->isReadOnly() );
   }
+  if ( mAlarmsBlockedCheckBox ) {
+    KMFolderCachedImap* dimap = static_cast<KMFolderCachedImap *>( folder->storage() );
+    mAlarmsBlockedCheckBox->setChecked( dimap->alarmsBlocked() );
+  }
 }
 
 //-----------------------------------------------------------------------------
@@ -569,10 +589,12 @@
         "to temporarily disable hiding of groupware folders to be able to see it.");
     KMessageBox::information( this, message );
   }
-
+  const bool enable = type == KMail::ContentsTypeCalendar ||
+                                          type == KMail::ContentsTypeTask;
   if ( mIncidencesForComboBox )
-      mIncidencesForComboBox->setEnabled( type == KMail::ContentsTypeCalendar ||
-                                          type == KMail::ContentsTypeTask );
+      mIncidencesForComboBox->setEnabled( enable );
+  if ( mAlarmsBlockedCheckBox )
+      mAlarmsBlockedCheckBox->setEnabled( enable );
 }
 
 //-----------------------------------------------------------------------------
@@ -634,12 +656,18 @@
       folder->storage()->setContentsType( type );
     }
 
-    if ( mIncidencesForComboBox && folder->folderType() == KMFolderTypeCachedImap ) {
-      KMFolderCachedImap::IncidencesFor incfor =
-        static_cast<KMFolderCachedImap::IncidencesFor>( mIncidencesForComboBox->currentItem() );
+    if ( folder->folderType() == KMFolderTypeCachedImap ) {
       KMFolderCachedImap* dimap = static_cast<KMFolderCachedImap *>( mDlg->folder()->storage() );
-      if ( dimap->incidencesFor() != incfor ) {
-        dimap->setIncidencesFor( incfor );
+      if ( mIncidencesForComboBox ) {
+        KMFolderCachedImap::IncidencesFor incfor = KMFolderCachedImap::IncForAdmins;
+        incfor = static_cast<KMFolderCachedImap::IncidencesFor>( mIncidencesForComboBox->currentItem() );
+        if ( dimap->incidencesFor() != incfor ) {
+          dimap->setIncidencesFor( incfor );
+          dimap->writeConfig();
+        }
+      }
+      if ( mAlarmsBlockedCheckBox && mAlarmsBlockedCheckBox->isChecked() != dimap->alarmsBlocked() ) {
+        dimap->setAlarmsBlocked( mAlarmsBlockedCheckBox->isChecked() );
         dimap->writeConfig();
       }
     }
@@ -676,7 +704,7 @@
 
 //----------------------------------------------------------------------------
 KMail::FolderDiaTemplatesTab::FolderDiaTemplatesTab( KMFolderDialog* dlg,
-                                                 QWidget* parent )
+                                                     QWidget* parent )
   : FolderDiaTab( parent, 0 ), mDlg( dlg )
 {
 
Index: kmail/tests/Makefile.am
===================================================================
--- kmail/tests/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/tests/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-INCLUDES = -I$(top_srcdir)/kmail $(all_includes)
+INCLUDES = -I$(top_srcdir)/kmail -I$(top_srcdir)/mimelib $(all_includes)
 AM_CPPFLAGS = -DKDESRCDIR=\"$(srcdir)\"
 METASOURCES = AUTO
 
@@ -7,13 +7,14 @@
         kunittest_mimelibmodule.la
 
 kunittest_storagelayermodule_la_SOURCES = storagelayermodule.cpp messagedicttests.cpp ../kmdict.cpp
+kunittest_storagelayermodule_la_LIBADD = -lkunittest
 kunittest_utilmodule_la_SOURCES = utiltests.cpp ../util.cpp
 kunittest_utilmodule_la_LIBADD = -lkunittest ../../mimelib/libmimelib.la
 kunittest_mimelibmodule_la_SOURCES = mimelibtests.cpp ../util.cpp
 kunittest_mimelibmodule_la_LIBADD = -lkunittest ../../mimelib/libmimelib.la
 
-LIBADD = -lkunittest
-LDFLAGS = -module $(KDE_CHECK_PLUGIN) $(all_libraries)
+#LIBADD = -lkunittest
+AM_LDFLAGS = -module $(KDE_CHECK_PLUGIN) $(all_libraries)
 
 check-local:
 	kunittestmodrunner
Index: kmail/vacationdialog.h
===================================================================
--- kmail/vacationdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/vacationdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,6 +41,8 @@
 		    const char * name=0, bool modal=true );
     virtual ~VacationDialog();
 
+    virtual void enableDomainAndSendForSpam( bool enable = true );
+
     bool activateVacation() const;
     virtual void setActivateVacation( bool activate );
 
@@ -53,6 +55,13 @@
     KMime::Types::AddrSpecList mailAliases() const;
     virtual void setMailAliases( const KMime::Types::AddrSpecList & aliases );
     virtual void setMailAliases( const QString & aliases );
+ 
+    QString domainName() const;
+    virtual void setDomainName( const QString & domain );
+
+    bool sendForSpam() const;
+    virtual void setSendForSpam( bool enable );
+
     
   private slots:
     void slotIntervalSpinChanged( int value );
@@ -62,6 +71,10 @@
     KIntSpinBox * mIntervalSpin;
     QLineEdit   * mMailAliasesEdit;
     QTextEdit   * mTextEdit;
+    QCheckBox   * mSpamCheck;
+    QCheckBox   * mDomainCheck;
+    QLineEdit   * mDomainEdit;
+
   };
 
 } // namespace KMail
Index: kmail/callback.cpp
===================================================================
--- kmail/callback.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/callback.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,31 +56,43 @@
 {
 }
 
-bool Callback::mailICal( const QString& to, const QString iCal,
-                         const QString& subject, const QString &status ) const
+bool Callback::mailICal( const QString& to, const QString &iCal,
+                         const QString& subject, const QString &status,
+                         bool delMessage ) const
 {
   kdDebug(5006) << "Mailing message:\n" << iCal << endl;
+
   KMMessage *msg = new KMMessage;
   msg->initHeader();
+  msg->setSubject( subject );
   if ( GlobalSettings::self()->exchangeCompatibleInvitations() ) {
-    if ( status == QString("cancel") ) msg->setSubject( QString("Declined: %1").arg(subject).replace("Answer: ","") );
-    else if ( status == QString("tentative") ) msg->setSubject(QString("Tentative: %1").arg(subject).replace("Answer: ","") );
-    else if ( status == QString("accepted") ) msg->setSubject( QString("Accepted: %1").arg(subject).replace("Answer: ","") );
-    else msg->setSubject( subject );
-  } else {
-    msg->setSubject( subject );
+    if ( status == QString("cancel") )
+      msg->setSubject( QString("Declined: %1").arg(subject).replace("Answer: ","") );
+    else if ( status == QString("tentative") )
+      msg->setSubject(QString("Tentative: %1").arg(subject).replace("Answer: ","") );
+    else if ( status == QString("accepted") )
+      msg->setSubject( QString("Accepted: %1").arg(subject).replace("Answer: ","") );
+    else if ( status == QString("delegated") )
+      msg->setSubject( QString("Delegated: %1").arg(subject).replace("Answer: ","") );
   }
   msg->setTo( to );
   msg->setFrom( receiver() );
-  /* We want the triggering mail to be moved to the trash once this one
-   * has been sent successfully. Set a link header which accomplishes that. */
-  msg->link( mMsg, KMMsgStatusDeleted );
 
+  if ( !GlobalSettings::self()->exchangeCompatibleInvitations() ) {
+    msg->setHeaderField( "Content-Type",
+                         "text/calendar; method=reply; charset=\"utf-8\"" );
+    msg->setBody( iCal.utf8() );
+  }
+
+  if ( delMessage && deleteInvitationAfterReply() )
+    /* We want the triggering mail to be moved to the trash once this one
+    * has been sent successfully. Set a link header which accomplishes that. */
+    msg->link( mMsg, KMMsgStatusDeleted );
+
   // Outlook will only understand the reply if the From: header is the
   // same as the To: header of the invitation message.
   KConfigGroup options( KMKernel::config(), "Groupware" );
-  if( !options.readBoolEntry( "LegacyMangleFromToHeaders", true ) )
-  {
+  if( !options.readBoolEntry( "LegacyMangleFromToHeaders", true ) ) {
     // Try and match the receiver with an identity
     const KPIM::Identity& identity =
       kmkernel->identityManager()->identityForAddress( receiver() );
@@ -96,7 +108,7 @@
   KMail::Composer * cWin = KMail::makeComposer();
   cWin->setMsg( msg, false /* mayAutoSign */ );
   // cWin->setCharset( "", true );
-  cWin->slotWordWrapToggled( false );
+  cWin->disableWordWrap();
   cWin->setSigningAndEncryptionDisabled( true );
 
   if( GlobalSettings::self()->exchangeCompatibleInvitations() ) {
@@ -112,10 +124,6 @@
     msgPart->setSubtypeStr( "calendar" );
     msgPart->setParameter( "method", "reply" );
     cWin->addAttach( msgPart );
-  } else {
-    msg->setHeaderField( "Content-Type",
-                         "text/calendar; method=reply; charset=\"utf-8\"" );
-    msg->setBody( iCal.utf8() );
   }
 
   if ( options.readBoolEntry( "AutomaticSending", true ) ) {
@@ -187,3 +195,19 @@
   if ( window )
     window->close();
 }
+
+bool Callback::askForComment( KCal::Attendee::PartStat status ) const
+{
+    if ( ( status != KCal::Attendee::Accepted
+            && GlobalSettings::self()->askForCommentWhenReactingToInvitation()
+            == GlobalSettings:: EnumAskForCommentWhenReactingToInvitation::AskForAllButAcceptance )
+        || GlobalSettings::self()->askForCommentWhenReactingToInvitation()
+        == GlobalSettings:: EnumAskForCommentWhenReactingToInvitation::AlwaysAsk )
+        return true;
+    return false;
+}
+
+bool Callback::deleteInvitationAfterReply() const
+{
+    return GlobalSettings::self()->deleteInvitationEmailsAfterSendingReply();
+}
Index: kmail/folderstorage.cpp
===================================================================
--- kmail/folderstorage.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/folderstorage.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -72,6 +72,7 @@
   mUnreadMsgs = -1;
   mGuessedUnreadMsgs = -1;
   mTotalMsgs = -1;
+  mSize = -1;
   needsCompact    = false;
   mConvertToUtf8  = false;
   mCompactable     = true;
@@ -98,12 +99,14 @@
 }
 
 
-void FolderStorage::close( const char * owner, bool aForced )
+void FolderStorage::close( const char* owner, bool aForced )
 {
   if (mOpenCount <= 0) return;
   if (mOpenCount > 0) mOpenCount--;
   if (mOpenCount > 0 && !aForced) return;
-    reallyDoClose( owner );
+
+  // kdWarning() << "Really closing: " << folder()->prettyURL()  << kdBacktrace() << endl;
+  reallyDoClose(owner);
 }
 
 //-----------------------------------------------------------------------------
@@ -409,6 +412,7 @@
   }
   --mTotalMsgs;
 
+  mSize = -1;
   QString msgIdMD5 = mb->msgIdMD5();
   emit msgRemoved( idx, msgIdMD5 );
   emit msgRemoved( folder() );
@@ -446,6 +450,7 @@
   --mTotalMsgs;
   msg->setParent(0);
   setDirty( true );
+  mSize = -1;
   needsCompact=true; // message is taken from here - needs to be compacted
   QString msgIdMD5 = msg->msgIdMD5();
   emit msgRemoved( idx, msgIdMD5 );
@@ -461,7 +466,8 @@
     if (msg->parent())
     {
       int idx = msg->parent()->find(msg);
-      take(idx);
+      if ( idx >= 0 )
+        take(idx);
     }
   }
 }
@@ -470,11 +476,20 @@
 //-----------------------------------------------------------------------------
 KMMessage* FolderStorage::getMsg(int idx)
 {
-  if ( idx < 0 || idx >= count() )
+  if ( mOpenCount <= 0 ) {
+    kdWarning(5006) << "FolderStorage::getMsg was called on a closed folder: " << folder()->prettyURL() << endl; 
     return 0;
+  }
+  if ( idx < 0 || idx >= count() ) { 
+    kdWarning(5006) << "FolderStorage::getMsg was asked for an invalid index. idx =" << idx << " count()=" << count() << endl; 
+    return 0;
+  }
 
   KMMsgBase* mb = getMsgBase(idx);
-  if (!mb) return 0;
+  if (!mb) {
+    kdWarning(5006) << "FolderStorage::getMsg, getMsgBase failed for index: " << idx << endl;
+    return 0;
+  }
 
   KMMessage *msg = 0;
   bool undo = mb->enableUndo();
@@ -495,8 +510,10 @@
   // Either isMessage and we had a sernum, or readMsg gives us one
   // (via insertion into mMsgList). sernum == 0 may still occur due to
   // an outdated or corrupt IMAP cache.
-  if ( msg->getMsgSerNum() == 0 )
+  if ( msg->getMsgSerNum() == 0 ) {
+    kdWarning(5006) << "FolderStorage::getMsg, message has no sernum, index: " << idx << endl;
     return 0;
+  }
   msg->setEnableUndo(undo);
   msg->setComplete( true );
   return msg;
@@ -771,6 +788,7 @@
 
   mUnreadMsgs = 0;
   mTotalMsgs = 0;
+  mSize = 0;
   emit numUnreadMsgsChanged( folder() );
   if ( mAutoCreateIndex ) // FIXME Heh? - Till
     writeConfig();
@@ -813,6 +831,22 @@
   return (unread > 0) ? unread : 0;
 }
 
+Q_INT64 FolderStorage::folderSize() const
+{
+    if ( mSize != -1 ) {
+        return mSize;
+    } else {
+        return doFolderSize();
+    }
+}
+
+
+/*virtual*/
+bool FolderStorage::isCloseToQuota() const
+{
+  return false;
+}
+
 //-----------------------------------------------------------------------------
 void FolderStorage::msgStatusChanged(const KMMsgStatus oldStatus,
   const KMMsgStatus newStatus, int idx)
@@ -878,7 +912,9 @@
   if (mTotalMsgs == -1)
     mTotalMsgs = config->readNumEntry("TotalMsgs", -1);
   mCompactable = config->readBoolEntry("Compactable", true);
-
+  if ( mSize == -1 )
+      mSize = config->readNum64Entry("FolderSize", -1);
+  
   int type = config->readNumEntry( "ContentsType", 0 );
   if ( type < 0 || type > KMail::ContentsTypeLast ) type = 0;
   setContentsType( static_cast<KMail::FolderContentsType>( type ) );
@@ -896,6 +932,7 @@
   config->writeEntry("TotalMsgs", mTotalMsgs);
   config->writeEntry("Compactable", mCompactable);
   config->writeEntry("ContentsType", mContentsType);
+  config->writeEntry("FolderSize", mSize);
 
   // Write the KMFolder parts
   if( folder() ) folder()->writeConfig( config );
@@ -1083,9 +1120,10 @@
 
 void FolderStorage::slotProcessNextSearchBatch()
 {
-  if ( !mSearchPattern ) return;
+  if ( !mSearchPattern )
+    return;
   QValueList<Q_UINT32> matchingSerNums;
-  int end = ( count() - mCurrentSearchedMsg > 100 ) ? 100+mCurrentSearchedMsg : count();
+  const int end = QMIN( mCurrentSearchedMsg + 15, count() );
   for ( int i = mCurrentSearchedMsg; i < end; ++i )
   {
     Q_UINT32 serNum = KMMsgDict::instance()->getMsgSerNum( folder(), i );
@@ -1093,7 +1131,7 @@
       matchingSerNums.append( serNum );
   }
   mCurrentSearchedMsg = end;
-  bool complete = ( end == count() ) ? true : false;
+  bool complete = ( end >= count() );
   emit searchResult( folder(), matchingSerNums, mSearchPattern, complete );
   if ( !complete )
     QTimer::singleShot( 0, this, SLOT(slotProcessNextSearchBatch()) );
@@ -1128,4 +1166,11 @@
   return ( folder()->isSystemFolder() ) ? false : true;
 }
 
+
+/*virtual*/
+KMAccount* FolderStorage::account() const
+{
+    return 0;
+}
+
 #include "folderstorage.moc"
Index: kmail/copyfolderjob.cpp
===================================================================
--- kmail/copyfolderjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/copyfolderjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,7 +50,7 @@
    mNewFolder( 0 ), mChildFolderNodeIterator( *mStorage->folder()->createChildFolder() ),
    mNextChildFolder( 0 )
 {
-  mStorage->open("copyfolder");
+  mStorage->open( "copyfolder" );
 }
 
 CopyFolderJob::~CopyFolderJob()
@@ -61,7 +61,7 @@
   if ( mStorage )
   {
     mStorage->folder()->setMoveInProgress( false );
-    mStorage->close("copyfolder");
+    mStorage->close( "copyfolder" );
   }
 }
 
@@ -126,7 +126,7 @@
 {
   //kdDebug(5006) << k_funcinfo << endl;
   if ( mNextChildFolder )
-    mNextChildFolder->close("copyfoldernext"); // refcount
+    mNextChildFolder->close( "copyfolder" ); // refcount
   // previous sibling failed
   if ( !success ) {
     kdDebug(5006) << "Failed to copy one subfolder, let's not continue:  " << mNewFolder->prettyURL() << endl;
@@ -158,7 +158,7 @@
     return;
   }
   // let it do its thing and report back when we are ready to do the next sibling
-  mNextChildFolder->open("copyfoldernext"); // refcount
+  mNextChildFolder->open( "copyfolder" ); // refcount
   FolderJob* job = new CopyFolderJob( mNextChildFolder->storage(), dir);
   connect( job, SIGNAL( folderCopyComplete( bool ) ),
            this, SLOT( slotCopyNextChild( bool ) ) );
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/configuredialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1715,6 +1715,7 @@
   { "PGPMessageWarn", I18N_NOOP("OpenPGP Message - Unchecked Signature") },
   { "PGPMessageErr", I18N_NOOP("OpenPGP Message - Bad Signature") },
   { "HTMLWarningColor", I18N_NOOP("Border Around Warning Prepending HTML Messages") },
+  { "CloseToQuotaColor", I18N_NOOP("Folder Name and Size When Close to Quota") },
   { "ColorbarBackgroundPlain", I18N_NOOP("HTML Status Bar Background - No HTML Message") },
   { "ColorbarForegroundPlain", I18N_NOOP("HTML Status Bar Foreground - No HTML Message") },
   { "ColorbarBackgroundHTML",  I18N_NOOP("HTML Status Bar Background - HTML Message") },
@@ -1751,11 +1752,26 @@
   connect( mRecycleColorCheck, SIGNAL( stateChanged( int ) ),
            this, SLOT( slotEmitChanged( void ) ) );
 
+  // close to quota threshold
+  QHBoxLayout *hbox = new QHBoxLayout(vlay);
+  QLabel *l = new QLabel( i18n("Close to quota threshold"), this );
+  hbox->addWidget( l );
+  l->setEnabled( false );
+  mCloseToQuotaThreshold = new QSpinBox( 0, 100, 1, this );
+  connect( mCloseToQuotaThreshold, SIGNAL( valueChanged( int ) ),
+           this, SLOT( slotEmitChanged( void ) ) );
+  mCloseToQuotaThreshold->setSuffix( i18n("%"));
+  hbox->addWidget( mCloseToQuotaThreshold );
+  hbox->addWidget( new QWidget(this), 2 );
+
   // {en,dir}able widgets depending on the state of mCustomColorCheck:
   connect( mCustomColorCheck, SIGNAL(toggled(bool)),
            mColorList, SLOT(setEnabled(bool)) );
   connect( mCustomColorCheck, SIGNAL(toggled(bool)),
            mRecycleColorCheck, SLOT(setEnabled(bool)) );
+  connect( mCustomColorCheck, SIGNAL(toggled(bool)),
+           l, SLOT(setEnabled(bool)) );
+
   connect( mCustomColorCheck, SIGNAL( stateChanged( int ) ),
            this, SLOT( slotEmitChanged( void ) ) );
 }
@@ -1765,6 +1781,7 @@
 
   mCustomColorCheck->setChecked( !reader.readBoolEntry( "defaultColors", true ) );
   mRecycleColorCheck->setChecked( reader.readBoolEntry( "RecycleQuoteColors", false ) );
+  mCloseToQuotaThreshold->setValue( GlobalSettings::closeToQuotaThreshold() );
 
   static const QColor defaultColor[ numColorNames ] = {
     kapp->palette().active().base(), // bg
@@ -1779,21 +1796,24 @@
     Qt::red, // new msg
     Qt::blue, // unread mgs
     QColor( 0x00, 0x7F, 0x00 ), // important msg
+    Qt::blue, // todo mgs
     QColor( 0x00, 0x80, 0xFF ), // light blue // pgp encrypted
     QColor( 0x40, 0xFF, 0x40 ), // light green // pgp ok, trusted key
     QColor( 0xFF, 0xFF, 0x40 ), // light yellow // pgp ok, untrusted key
     QColor( 0xFF, 0xFF, 0x40 ), // light yellow // pgp unchk
     Qt::red, // pgp bad
     QColor( 0xFF, 0x40, 0x40 ), // warning text color: light red
+    Qt::red, // close to quota
     Qt::lightGray, // colorbar plain bg
     Qt::black,     // colorbar plain fg
     Qt::black,     // colorbar html  bg
     Qt::white,     // colorbar html  fg
   };
 
-  for ( int i = 0 ; i < numColorNames ; i++ )
+  for ( int i = 0 ; i < numColorNames ; i++ ) {
     mColorList->setColor( i,
       reader.readColorEntry( colorNames[i].configName, &defaultColor[i] ) );
+  }
   connect( mColorList, SIGNAL( changed( ) ),
            this, SLOT( slotEmitChanged( void ) ) );
 }
@@ -1824,6 +1844,7 @@
       reader.writeEntry( colorNames[i].configName, mColorList->color(i) );
 
   reader.writeEntry( "RecycleQuoteColors", mRecycleColorCheck->isChecked() );
+  GlobalSettings::setCloseToQuotaThreshold( mCloseToQuotaThreshold->value() );
 }
 
 QString AppearancePage::LayoutTab::helpAnchor() const {
@@ -1884,6 +1905,10 @@
   connect( mFolderListGroup, SIGNAL ( clicked( int ) ),
            this, SLOT( slotEmitChanged() ) );
 
+  mFavoriteFolderViewCB = new QCheckBox( i18n("Show favorite folder view"), this );
+  connect( mFavoriteFolderViewCB, SIGNAL(toggled(bool)), SLOT(slotEmitChanged()) );
+  vlay->addWidget( mFavoriteFolderViewCB );
+
   // "show reader window" radio buttons:
   populateButtonGroup( mReaderWindowModeGroup = new QVButtonGroup( this ), readerWindowMode );
   vlay->addWidget( mReaderWindowModeGroup );
@@ -1913,6 +1938,7 @@
   loadWidget( mMIMETreeLocationGroup, reader, mimeTreeLocation );
   loadWidget( mMIMETreeModeGroup, reader, mimeTreeMode );
   loadWidget( mReaderWindowModeGroup, geometry, readerWindowMode );
+  mFavoriteFolderViewCB->setChecked( GlobalSettings::self()->enableFavoriteFolderView() );
 }
 
 void AppearancePage::LayoutTab::installProfile( KConfig * profile ) {
@@ -1933,6 +1959,7 @@
   saveButtonGroup( mMIMETreeLocationGroup, reader, mimeTreeLocation );
   saveButtonGroup( mMIMETreeModeGroup, reader, mimeTreeMode );
   saveButtonGroup( mReaderWindowModeGroup, geometry, readerWindowMode );
+  GlobalSettings::self()->setEnableFavoriteFolderView( mFavoriteFolderViewCB->isChecked() );
 }
 
 //
@@ -2557,6 +2584,12 @@
   connect( mAutoAppSignFileCheck, SIGNAL( stateChanged(int) ),
            this, SLOT( slotEmitChanged( void ) ) );
 
+  mTopQuoteCheck =
+    new QCheckBox( GlobalSettings::self()->prependSignatureItem()->label(), this );
+  vlay->addWidget( mTopQuoteCheck);
+  connect( mTopQuoteCheck, SIGNAL( stateChanged(int) ),
+           this, SLOT( slotEmitChanged( void ) ) );
+
   mSmartQuoteCheck = new QCheckBox(
            GlobalSettings::self()->smartQuoteItem()->label(),
            this, "kcfg_SmartQuote" );
@@ -2674,6 +2707,7 @@
 
   mAutoAppSignFileCheck->setChecked(
            GlobalSettings::self()->autoTextSignature()=="auto" );
+  mTopQuoteCheck->setChecked( GlobalSettings::self()->prependSignature() );
   mSmartQuoteCheck->setChecked( GlobalSettings::self()->smartQuote() );
   mAutoRequestMDNCheck->setChecked( GlobalSettings::self()->requestMDN() );
   mWordWrapCheck->setChecked( GlobalSettings::self()->wordWrap() );
@@ -2694,6 +2728,8 @@
     bool state = composer.readBoolEntry("signature");
     mAutoAppSignFileCheck->setChecked( state );
   }
+  if ( composer.hasKey( "prepend-signature" ) )
+    mTopQuoteCheck->setChecked( composer.readBoolEntry( "prepend-signature" ) );
   if ( composer.hasKey( "smart-quote" ) )
     mSmartQuoteCheck->setChecked( composer.readBoolEntry( "smart-quote" ) );
   if ( composer.hasKey( "request-mdn" ) )
@@ -2715,6 +2751,7 @@
 void ComposerPage::GeneralTab::save() {
   GlobalSettings::self()->setAutoTextSignature(
          mAutoAppSignFileCheck->isChecked() ? "auto" : "manual" );
+  GlobalSettings::self()->setPrependSignature( mTopQuoteCheck->isChecked());
   GlobalSettings::self()->setSmartQuote( mSmartQuoteCheck->isChecked() );
   GlobalSettings::self()->setRequestMDN( mAutoRequestMDNCheck->isChecked() );
   GlobalSettings::self()->setWordWrap( mWordWrapCheck->isChecked() );
@@ -3658,6 +3695,13 @@
 
   vlay->addWidget( group );
 
+  // encrypted messages group
+  group = new QVGroupBox( i18n("Encrypted Messages"), this );
+  group->layout()->setSpacing( KDialog::spacingHint() );
+  mAlwaysDecrypt = new QCheckBox( i18n( "Attempt decryption of encrypted messages when viewing" ), group );
+  connect( mAlwaysDecrypt, SIGNAL(stateChanged(int)), this, SLOT(slotEmitChanged()) );
+  vlay->addWidget( group );
+
   // "Message Disposition Notification" groupbox:
   group = new QVGroupBox( i18n("Message Disposition Notifications"), this );
   group->layout()->setSpacing( KDialog::spacingHint() );
@@ -3747,6 +3791,8 @@
   mExternalReferences->setChecked( reader.readBoolEntry( "htmlLoadExternal", false ) );
   mAutomaticallyImportAttachedKeysCheck->setChecked( reader.readBoolEntry( "AutoImportKeys", false ) );
 
+  mAlwaysDecrypt->setChecked( GlobalSettings::self()->alwaysDecrypt() );
+
   const KConfigGroup mdn( KMKernel::config(), "MDN" );
 
   int num = mdn.readNumEntry( "default-policy", 0 );
@@ -3817,6 +3863,7 @@
   mdn.writeEntry( "default-policy", mMDNGroup->id( mMDNGroup->selected() ) );
   mdn.writeEntry( "quote-message", mOrigQuoteGroup->id( mOrigQuoteGroup->selected() ) );
   mdn.writeEntry( "not-send-when-encrypted", mNoMDNsWhenEncryptedCheck->isChecked() );
+  GlobalSettings::self()->setAlwaysDecrypt( mAlwaysDecrypt->isChecked() );
 }
 
 
@@ -4645,7 +4692,7 @@
            this, SLOT( slotEmitChanged( void ) ) );
 
   mBox = new QWidget( b1 );
-  QGridLayout* grid = new QGridLayout( mBox, 4, 2, 0, KDialog::spacingHint() );
+  QGridLayout* grid = new QGridLayout( mBox, 5, 2, 0, KDialog::spacingHint() );
   grid->setColStretch( 1, 1 );
   connect( mEnableImapResCB, SIGNAL( toggled(bool) ),
            mBox, SLOT( setEnabled(bool) ) );
@@ -4742,6 +4789,19 @@
   connect( mOnlyShowGroupwareFolders, SIGNAL( toggled( bool ) ),
            this, SLOT( slotEmitChanged() ) );
 
+  mSyncImmediately = new QCheckBox( i18n( "Synchronize groupware changes immediately" ), mBox );
+  QToolTip::add( mSyncImmediately,
+                 i18n( "Synchronize groupware changes in disconnected IMAP folders immediately when being online." ) );
+  connect( mSyncImmediately, SIGNAL(toggled(bool)), SLOT(slotEmitChanged()) );
+  grid->addMultiCellWidget( mSyncImmediately, 4, 4, 0, 1 );
+  
+  mDeleteInvitations = new QCheckBox( 
+             i18n( GlobalSettings::self()->deleteInvitationEmailsAfterSendingReplyItem()->label().utf8() ), mBox );
+  QWhatsThis::add( mDeleteInvitations, i18n( GlobalSettings::self()
+             ->deleteInvitationEmailsAfterSendingReplyItem()->whatsThis().utf8() ) );
+    connect( mDeleteInvitations, SIGNAL(toggled(bool)), SLOT(slotEmitChanged()) );
+    grid->addMultiCellWidget( mDeleteInvitations, 5, 5, 0, 1 );
+
   // Groupware functionality compatibility setup
   b1 = new QVGroupBox( i18n("Groupware Compatibility && Legacy Options"), this );
 
@@ -4839,6 +4899,8 @@
   mStorageFormatCombo->setCurrentItem(i);
   slotStorageFormatChanged( i );
   mOnlyShowGroupwareFolders->setChecked( GlobalSettings::self()->showOnlyGroupwareFoldersForGroupwareAccount() );
+  mSyncImmediately->setChecked( GlobalSettings::self()->immediatlySyncDIMAPOnGroupwareChanges() );
+  mDeleteInvitations->setChecked( GlobalSettings::self()->deleteInvitationEmailsAfterSendingReply() );
 
   QString folderId( GlobalSettings::self()->theIMAPResourceFolderParent() );
   if( !folderId.isNull() && kmkernel->findFolderById( folderId ) ) {
@@ -4901,6 +4963,8 @@
   // Write the IMAP resource config
   GlobalSettings::self()->setHideGroupwareFolders( mHideGroupwareFolders->isChecked() );
   GlobalSettings::self()->setShowOnlyGroupwareFoldersForGroupwareAccount( mOnlyShowGroupwareFolders->isChecked() );
+  GlobalSettings::self()->setImmediatlySyncDIMAPOnGroupwareChanges( mSyncImmediately->isChecked() );
+  GlobalSettings::self()->setDeleteInvitationEmailsAfterSendingReply( mDeleteInvitations->isChecked() );
 
   // If there is a leftover folder in the foldercombo, getFolder can
   // return 0. In that case we really don't have it enabled
Index: kmail/kmfolder.h
===================================================================
--- kmail/kmfolder.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolder.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -382,7 +382,7 @@
   QString mailingListPostAddress() const;
 
   void setIdentity(uint identity);
-  uint identity() const { return mIdentity; }
+  uint identity() const;
 
   /** Get / set the name of the field that is used for the Sender/Receiver column in the headers (From/To) */
   QString whoField() const { return mWhoField; }
@@ -587,6 +587,9 @@
   /** Emitted when the variables for the config of the view have changed */
   void viewConfigChanged();
 
+  /** Emitted when the folder's size changes. */
+  void folderSizeChanged( KMFolder * );
+
 public slots:
   /** Incrementally update the index if possible else call writeIndex */
   int updateIndex();
@@ -602,6 +605,8 @@
 private slots:
   /** The type of contents of this folder changed. Do what is needed. */
   void slotContentsTypeChanged( KMail::FolderContentsType type );
+  /** Triggered by the storage when its size changed. */
+  void slotFolderSizeChanged();
 
 private:
   FolderStorage* mStorage;
@@ -650,20 +655,40 @@
   KShortcut mShortcut;
 };
 
+
 /**
    RAII for KMFolder::open() / close().
 
-   Usage: const KMFolderCloser closer( folder );
+   Usage: const KMFolderOpener opener( folder );
 */
-class KMFolderCloser {
-  KMFolder * f;
-  QString mOwner;
+class KMFolderOpener {
+  KMFolder* mFolder;
+  const char* const mOwner;
+  int mOpenRc;
+
 public:
-  KMFolderCloser( const char *owner, KMFolder * folder ) : f( folder ), mOwner( owner ) {}
-  ~KMFolderCloser() {
-    if ( f ) f->close(mOwner.latin1());
+  KMFolderOpener( KMFolder* folder, const char* const owner )
+   : mFolder( folder )
+   , mOwner( owner )
+  {
+    assert( folder ); //change if that's not what you want
+    mOpenRc = folder->open( owner );
   }
-  KMFolder * folder() const { return f; }
+
+  ~KMFolderOpener()
+  {
+    if ( !mOpenRc )
+      mFolder->close( mOwner );
+  }
+
+  KMFolder* folder() const { return mFolder; }
+
+  int openResult() const { return mOpenRc; }
+
+private:
+  //we forbid construction on the heap as good as we can
+  void* operator new( size_t size );
 };
 
+
 #endif /*kmfolder_h*/
Index: kmail/kmfoldermgr.cpp
===================================================================
--- kmail/kmfoldermgr.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermgr.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,6 +28,9 @@
 #include "kmfiltermgr.h"
 #include "kmfoldermgr.h"
 #include "folderstorage.h"
+#include "kmfolder.h"
+#include "kmfoldercachedimap.h"
+#include "kmacctcachedimap.h"
 #include "renamejob.h"
 #include "copyfolderjob.h"
 
@@ -180,6 +183,27 @@
 
   if (!aFolderDir)
     fldDir = &mDir;
+
+  // check if this is a dimap folder and the folder we want to create has been deleted
+  // since the last sync
+  if ( fldDir->owner() && fldDir->owner()->folderType() == KMFolderTypeCachedImap ) {
+    KMFolderCachedImap *storage = static_cast<KMFolderCachedImap*>( fldDir->owner()->storage() );
+    KMAcctCachedImap *account = storage->account();
+    // guess imap path
+    QString imapPath = storage->imapPath();
+    if ( !imapPath.endsWith( "/" ) )
+      imapPath += "/";
+    imapPath += fName;
+    if ( account->isDeletedFolder( imapPath ) || account->isDeletedFolder( imapPath + "/" )
+       || account->isPreviouslyDeletedFolder( imapPath )
+       || account->isPreviouslyDeletedFolder( imapPath + "/" ) ) {
+      KMessageBox::error( 0, i18n("A folder with the same name has been deleted since the last mail check."
+          "You need to check mails first before creating another folder with the same name."),
+          i18n("Could Not Create Folder") );
+      return 0;
+    }
+  }
+
   fld = fldDir->createFolder(fName, sysFldr, aFolderType);
   if (fld) {
     if ( fld->id() == 0 )
@@ -342,6 +366,22 @@
   aFolder->remove();
 }
 
+KMFolder* KMFolderMgr::parentFolder( KMFolder* folder )
+{
+  // find the parent folder by stripping "." and ".directory" from the name
+  KMFolderDir* fdir = folder->parent();
+  QString parentName = fdir->name();
+  parentName = parentName.mid( 1, parentName.length()-11 );
+  KMFolderNode* parent = fdir->hasNamedFolder( parentName );
+  if ( !parent && fdir->parent() ) // dimap obviously has a different structure
+    parent = fdir->parent()->hasNamedFolder( parentName );
+
+  KMFolder* parentF = 0;
+  if ( parent )
+    parentF = dynamic_cast<KMFolder*>( parent );
+  return parentF;
+}
+
 void KMFolderMgr::removeFolderAux(KMFolder* aFolder, bool success)
 {
   if (!success) {
@@ -357,17 +397,19 @@
       break;
     }
   }
-  // find the parent folder by stripping "." and ".directory" from the name
-  QString parentName = fdir->name();
-  parentName = parentName.mid( 1, parentName.length()-11 );
-  KMFolderNode* parent = fdir->hasNamedFolder( parentName );
-  if ( !parent && fdir->parent() ) // dimap obviously has a different structure
-    parent = fdir->parent()->hasNamedFolder( parentName );
+  KMFolder* parentF = parentFolder( aFolder );
+
   // aFolder will be deleted by the next call!
   aFolder->parent()->remove(aFolder);
+
   // update the children state
-  if ( parent )
-    static_cast<KMFolder*>(parent)->storage()->updateChildrenState();
+  if ( parentF )
+  {
+    if ( parentF != aFolder )
+    {
+      parentF->storage()->updateChildrenState();
+    }
+  }
   else
     kdWarning(5006) << "Can not find parent folder" << endl;
 
Index: kmail/kmfolderimap.cpp
===================================================================
--- kmail/kmfolderimap.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,7 +53,6 @@
 #include <kdebug.h>
 #include <kio/scheduler.h>
 #include <kconfig.h>
-#include <kmessagebox.h>
 
 #include <qbuffer.h>
 #include <qtextcodec.h>
@@ -68,11 +67,11 @@
   mContentState = imapNoInformation;
   mSubfolderState = imapNoInformation;
   mAccount = 0;
-  mIsSelected = FALSE;
+  mIsSelected = false;
   mLastUid = 0;
-  mCheckFlags = TRUE;
-  mCheckMail = TRUE;
-  mCheckingValidity = FALSE;
+  mCheckFlags = true;
+  mCheckMail = true;
+  mCheckingValidity = false;
   mUserRights = 0;
   mAlreadyRemoved = false;
   mHasChildren = ChildrenUnknown;
@@ -107,11 +106,11 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderImap::reallyDoClose(const char *owner)
+void KMFolderImap::reallyDoClose(const char* owner)
 {
-  if ( isSelected() ) {
+  if (isSelected()) {
       kdWarning(5006) << "Trying to close the selected folder " << label() <<
-        " - ignoring! " << kdBacktrace() << endl;
+          " - ignoring!" << endl;
       return;
   }
 
@@ -126,10 +125,7 @@
           msg->setTransferInProgress( false );
     }
   }
-
-  mCheckingValidity = false;
-
-  KMFolderMbox::reallyDoClose(owner);
+  KMFolderMbox::reallyDoClose( owner );
 }
 
 KMFolder* KMFolderImap::trashFolder() const
@@ -207,9 +203,10 @@
     folder()->setSystemFolder( true );
     folder()->setLabel( i18n("inbox") );
   }
-  mNoContent = config->readBoolEntry("NoContent", FALSE);
-  mReadOnly = config->readBoolEntry("ReadOnly", FALSE);
+  mNoContent = config->readBoolEntry("NoContent", false);
+  mReadOnly = config->readBoolEntry("ReadOnly", false);
   mUploadAllFlags = config->readBoolEntry( "UploadAllFlags", true );
+  mPermanentFlags = config->readNumEntry( "PermanentFlags", 31 /* default flags */ );
 
   KMFolderMbox::readConfig();
 }
@@ -225,6 +222,7 @@
   config->writeEntry("NoContent", mNoContent);
   config->writeEntry("ReadOnly", mReadOnly);
   config->writeEntry( "UploadAllFlags", mUploadAllFlags );
+  config->writeEntry( "PermanentFlags", mPermanentFlags );
   KMFolderMbox::writeConfig();
 }
 
@@ -245,7 +243,7 @@
     emit removed(folder(), false);
     return;
   }
-  KIO::SimpleJob *job = KIO::file_delete(url, FALSE);
+  KIO::SimpleJob *job = KIO::file_delete(url, false);
   KIO::Scheduler::assignJobToSlave(account()->slave(), job);
   ImapAccountBase::jobData jd(url.url());
   jd.progressItem = ProgressManager::createProgressItem(
@@ -723,6 +721,7 @@
         KMFolderImap* f = static_cast<KMFolderImap*> ( fld->storage() );
         f->initializeFrom( this, account()->addPathToNamespace( name ),
             "inode/directory" );
+        f->close( "kmfolderimap_create" );
         if ( !account()->listOnlyOpenFolders() )
         {
           f->slotListResult( subfolderNames, subfolderPaths,
@@ -839,6 +838,7 @@
       KMFolder *fld = folder()->child()->createFolder(subfolderNames[i]);
       if ( fld ) {
         f = static_cast<KMFolderImap*> ( fld->storage() );
+        f->close( "kmfolderimap_create" );
         settingsChanged = true;
       } else {
         kdWarning(5006) << "can't create folder " << subfolderNames[i] << endl;
@@ -903,6 +903,7 @@
     if ( f )
     {
       f->folder()->setLabel( i18n("inbox") );
+      f->close( "kmfolderimap" );
     }
     kmkernel->imapFolderMgr()->contentsChanged();
   }
@@ -946,9 +947,6 @@
     const QString& myNamespace )
 {
   QPtrList<KMFolder> toRemove;
-  if (!folder()->child())
-    return;
-
   KMFolderNode *node = folder()->child()->first();
   while ( node )
   {
@@ -1025,6 +1023,7 @@
 {
   if (!account()) {
     emit folderComplete(this, false);
+    close("checkvalidity");
     return;
   }
   KURL url = account()->getUrl();
@@ -1038,8 +1037,9 @@
   KMAcctImap::ConnectionState connectionState = account()->makeConnection();
   if ( connectionState == ImapAccountBase::Error ) {
     kdDebug(5006) << "KMFolderImap::checkValidity - got no connection" << endl;
-    emit folderComplete(this, FALSE);
+    emit folderComplete(this, false);
     mContentState = imapNoInformation;
+    close("checkvalidity");
     return;
   } else if ( connectionState == ImapAccountBase::Connecting ) {
     // We'll wait for the connectionResult signal from the account. If it
@@ -1052,6 +1052,7 @@
   // Only check once at a time.
   if (mCheckingValidity) {
     kdDebug(5006) << "KMFolderImap::checkValidity - already checking" << endl;
+    close("checkvalidity");
     return;
   }
   // otherwise we already are inside a mailcheck
@@ -1071,9 +1072,8 @@
   if ( account()->mailCheckProgressItem() ) {
     account()->mailCheckProgressItem()->setStatus( folder()->prettyURL() );
   }
-  open( "checkvalidity" );
   ImapAccountBase::jobData jd( url.url() );
-  KIO::SimpleJob *job = KIO::get(url, FALSE, FALSE);
+  KIO::SimpleJob *job = KIO::get(url, false, false);
   KIO::Scheduler::assignJobToSlave(account()->slave(), job);
   account()->insertJob(job, jd);
   connect(job, SIGNAL(result(KIO::Job *)),
@@ -1104,28 +1104,19 @@
 //-----------------------------------------------------------------------------
 void KMFolderImap::slotCheckValidityResult(KIO::Job * job)
 {
-  // if we closed the folder in between, we don't want this results
-  if (!mCheckingValidity)
-    return;
-
   kdDebug(5006) << "KMFolderImap::slotCheckValidityResult of: " << fileName() << endl;
   mCheckingValidity = false;
   ImapAccountBase::JobIterator it = account()->findJob(job);
-  if ( it == account()->jobsEnd() )
-  {
-    // the job has been killed internally, so we're not interested in its results
-    job = 0;
-  }
-  if (!job || job->error()) {
-    if ( job && job->error() != KIO::ERR_ACCESS_DENIED ) {
+  if ( it == account()->jobsEnd() ) return;
+  if (job->error()) {
+    if ( job->error() != KIO::ERR_ACCESS_DENIED ) {
       // we suppress access denied messages because they are normally a result of
       // explicitely set ACLs. Do not save this information (e.g. setNoContent) so that
       // we notice when this changes
       account()->handleJobError( job, i18n("Error while querying the server status.") );
     }
-    kdDebug() << "error in slotCheckValidityResult\n";
     mContentState = imapNoInformation;
-    emit folderComplete(this, FALSE);
+    emit folderComplete(this, false);
     close("checkvalidity");
   } else {
     QCString cstr((*it).data.data(), (*it).data.size() + 1);
@@ -1147,6 +1138,11 @@
     if ( (b - a - 9) >= 0 )
         exists = cstr.mid(a + 9, b - a - 9).toInt(&ok);
     if ( !ok ) exists = -1;
+    a = cstr.find( "X-PermanentFlags: " );
+    b = cstr.find( "\r\n", a );
+    if ( a >= 0 && (b - a - 18) >= 0 )
+      mPermanentFlags = cstr.mid( a + 18, b - a - 18 ).toInt(&ok);
+    if ( !ok ) mPermanentFlags = 0;
     QString startUid;
     if (uidValidity() != uidv)
     {
@@ -1180,7 +1176,6 @@
       mMailCheckProgressItem->setCompletedItems( 0 );
     }
     reallyGetFolder(startUid);
-    close("checkvalidity");
   }
 }
 
@@ -1194,7 +1189,7 @@
     account()->processNewMailSingleFolder( folder() );
   if (force) {
     // force an update
-    mCheckFlags = TRUE;
+    mCheckFlags = true;
   }
 }
 
@@ -1204,7 +1199,6 @@
   mGuessedUnreadMsgs = -1;
   if (mNoContent)
   {
-    kdDebug() << "getFolder " << force << " " << mContentState << endl;
     mContentState = imapFinished;
     emit folderComplete(this, true);
     return;
@@ -1213,10 +1207,9 @@
   mContentState = imapListingInProgress;
   if (force) {
     // force an update
-    mCheckFlags = TRUE;
+    mCheckFlags = true;
   }
   checkValidity();
-  close( "getfolder" );
 }
 
 
@@ -1227,7 +1220,8 @@
   if ( account()->makeConnection() != ImapAccountBase::Connected )
   {
     mContentState = imapNoInformation;
-    emit folderComplete(this, FALSE);
+    emit folderComplete(this, false);
+    close("listfolder");
     return;
   }
   quiet(true);
@@ -1236,8 +1230,7 @@
     if ( mMailCheckProgressItem )
       mMailCheckProgressItem->setStatus( i18n("Retrieving message status") );
     url.setPath(imapPath() + ";SECTION=UID FLAGS");
-    KIO::SimpleJob *job = KIO::listDir(url, FALSE);
-    open( "listfolder" );
+    KIO::SimpleJob *job = KIO::listDir(url, false);
     KIO::Scheduler::assignJobToSlave(account()->slave(), job);
     ImapAccountBase::jobData jd( url.url(), folder() );
     jd.cancellable = true;
@@ -1253,12 +1246,10 @@
       mMailCheckProgressItem->setStatus( i18n("Retrieving messages") );
     url.setPath(imapPath() + ";UID=" + startUid
       + ":*;SECTION=ENVELOPE");
-    kdDebug() << folder()->name() << " download " << url << endl;
-    KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
+    KIO::SimpleJob *newJob = KIO::get(url, false, false);
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     ImapAccountBase::jobData jd( url.url(), folder() );
     jd.cancellable = true;
-    open( "getMessage" );
     account()->insertJob(newJob, jd);
     connect(newJob, SIGNAL(result(KIO::Job *)),
             this, SLOT(slotGetLastMessagesResult(KIO::Job *)));
@@ -1282,7 +1273,7 @@
     finishMailCheck( "listfolder", imapNoInformation );
     return;
   }
-  mCheckFlags = FALSE;
+  mCheckFlags = false;
   QStringList::Iterator uid;
   /*
     The code below does the following:
@@ -1306,14 +1297,17 @@
       serverUid = (*uid).left( c ).toLong();
       serverFlags = (*uid).mid( c+1 ).toInt();
       if ( mailUid < serverUid ) {
-        removeMsg( idx, TRUE );
+        removeMsg( idx, true );
       } else if ( mailUid == serverUid ) {
         // if this is a read only folder, ignore status updates from the server
         // since we can't write our status back our local version is what has to
         // be considered correct.
-        if (!mReadOnly)
-          flagsToStatus( msgBase, serverFlags, false );
-        else
+        if ( !mReadOnly || !GlobalSettings::allowLocalFlags() ) {
+          int supportedFlags = mUploadAllFlags ? 31 : mPermanentFlags;
+          if ( mReadOnly )
+            supportedFlags = INT_MAX;
+          flagsToStatus( msgBase, serverFlags, false, supportedFlags );
+        } else
           seenFlagToStatus( msgBase, serverFlags, false );
         idx++;
         uid = (*it).items.remove(uid);
@@ -1325,7 +1319,7 @@
     }
     // remove all remaining entries in the local cache, they are no longer
     // present on the server
-    while (idx < count()) removeMsg(idx, TRUE);
+    while (idx < count()) removeMsg(idx, true);
   }
   // strip the flags from the list of uids, so it can be reused
   for (uid = (*it).items.begin(); uid != (*it).items.end(); ++uid)
@@ -1353,19 +1347,13 @@
   else sets = makeSets( (*it).items );
   account()->removeJob(it); // don't use *it below
 
-  if ( !sets.isEmpty() )
-    open( "getMessage" );
-
-  close( "listfolder" );
-
   // Now kick off the getting of envelopes for the new mails in the folder
   for (QStringList::Iterator i = sets.begin(); i != sets.end(); ++i)
   {
     mContentState = imapDownloadInProgress;
     KURL url = account()->getUrl();
     url.setPath(imapPath() + ";UID=" + *i + ";SECTION=ENVELOPE");
-    KIO::SimpleJob *newJob = KIO::get(url, FALSE, FALSE);
-    kdDebug() << folder()->name() << " download " << url << endl;
+    KIO::SimpleJob *newJob = KIO::get(url, false, false);
     jd.url = url.url();
     KIO::Scheduler::assignJobToSlave(account()->slave(), newJob);
     account()->insertJob(newJob, jd);
@@ -1430,25 +1418,36 @@
 //X }
 
 //-----------------------------------------------------------------------------
-void KMFolderImap::flagsToStatus(KMMsgBase *msg, int flags, bool newMsg)
+void KMFolderImap::flagsToStatus(KMMsgBase *msg, int flags, bool newMsg, int supportedFlags )
 {
   if ( !msg ) return;
 
+  // see imap4/imapinfo.h for the magic numbers
+  static const struct {
+    const int imapFlag;
+    const int kmFlag;
+    const bool standardFlag;
+  } imapFlagMap[] = {
+    { 2, KMMsgStatusReplied, true },
+    { 4, KMMsgStatusFlag, true },
+    { 128, KMMsgStatusForwarded, false },
+    { 256, KMMsgStatusTodo, false },
+    { 512, KMMsgStatusWatched, false },
+    { 1024, KMMsgStatusIgnored, false }
+  };
+  static const int numFlags = sizeof imapFlagMap / sizeof *imapFlagMap;
+
   const KMMsgStatus oldStatus = msg->status();
-  // Set flags if they are new
-  if ( (flags & 4) && (oldStatus & KMMsgStatusFlag) == 0 )
-    msg->setStatus( KMMsgStatusFlag );
-  if ( (flags & 2) && (oldStatus & KMMsgStatusReplied) == 0 )
-    msg->setStatus( KMMsgStatusReplied );
+  for ( int i = 0; i < numFlags; ++i ) {
+    if ( ( (supportedFlags & imapFlagMap[i].imapFlag) == 0 && (supportedFlags & 64) == 0 )
+         && !imapFlagMap[i].standardFlag ) {
+      continue;
+    }
+    if ( ((flags & imapFlagMap[i].imapFlag) > 0) != ((oldStatus & imapFlagMap[i].kmFlag) > 0) ) {
+      msg->toggleStatus( imapFlagMap[i].kmFlag );
+    }
+  }
 
-  // Toggle flags if they changed
-//  if ( ( (flags & 4) > 0 ) != ( (oldStatus & KMMsgStatusFlag) > 0 ) )
-//    msg->toggleStatus( KMMsgStatusFlag );
-//  if ( ( (flags & 2) > 0 ) != ( (oldStatus & KMMsgStatusReplied) > 0 ) )
-//    msg->toggleStatus( KMMsgStatusReplied );
-//  if ( ( (flags & 1) > 0 ) != ( (oldStatus & KMMsgStatusOld) > 0 ) )
-//    msg->toggleStatus( KMMsgStatusOld );
-
   seenFlagToStatus( msg, flags, newMsg );
 }
 
@@ -1476,7 +1475,7 @@
 
 
 //-----------------------------------------------------------------------------
-QString KMFolderImap::statusToFlags(KMMsgStatus status)
+QString KMFolderImap::statusToFlags(KMMsgStatus status, int supportedFlags)
 {
   QString flags;
   if (status & KMMsgStatusDeleted)
@@ -1487,7 +1486,16 @@
     if (status & KMMsgStatusReplied)
       flags += "\\ANSWERED ";
     if (status & KMMsgStatusFlag)
-      flags += "\\FLAGGED";
+      flags += "\\FLAGGED ";
+    // non standard flags
+    if ( (status & KMMsgStatusForwarded) && ((supportedFlags & 64) || (supportedFlags & 128)) )
+      flags += "$FORWARDED ";
+    if ( (status & KMMsgStatusTodo) && ((supportedFlags & 64) || (supportedFlags & 256)) )
+      flags += "$TODO ";
+    if ( (status & KMMsgStatusWatched) && ((supportedFlags & 64) || (supportedFlags & 512)) )
+      flags += "$WATCHED ";
+    if ( (status & KMMsgStatusIgnored) && ((supportedFlags & 64) || (supportedFlags & 1024)) )
+      flags += "$IGNORED ";
   }
 
   return flags.simplifyWhiteSpace();
@@ -1547,7 +1555,6 @@
     }
     (*it).cdata.remove(0, pos);
   }
-  open("digestsplit");
   pos = (*it).cdata.find("\r\n--IMAPDIGEST", 1);
   int flags;
   while (pos >= 0)
@@ -1603,7 +1610,7 @@
         }
         KMFolderMbox::addMsg(msg, 0);
         // Merge with the flags from the server.
-        flagsToStatus((KMMsgBase*)msg, flags);
+        flagsToStatus((KMMsgBase*)msg, flags, true, mUploadAllFlags ? 31 : mPermanentFlags);
         // set the correct size
         msg->setMsgSizeServer( msg->headerField("X-Length").toUInt() );
         msg->setUID(uid);
@@ -1629,7 +1636,6 @@
     (*it).done++;
     pos = (*it).cdata.find("\r\n--IMAPDIGEST", 1);
   } // while
-  close("digestsplit");
 }
 
 //-------------------------------------------------------------
@@ -1828,7 +1834,7 @@
   url.setPath(msg_parent->imapPath() + ";UID=" + QString::number(uid) );
   if ( account()->makeConnection() != ImapAccountBase::Connected )
     return;
-  KIO::SimpleJob *job = KIO::file_delete(url, FALSE);
+  KIO::SimpleJob *job = KIO::file_delete(url, false);
   KIO::Scheduler::assignJobToSlave(account()->slave(), job);
   ImapAccountBase::jobData jd( url.url(), 0 );
   account()->insertJob(job, jd);
@@ -1861,7 +1867,7 @@
     url.setPath(msg_parent->imapPath() + ";UID=" + uid);
     if ( account()->makeConnection() != ImapAccountBase::Connected )
       return;
-    KIO::SimpleJob *job = KIO::file_delete(url, FALSE);
+    KIO::SimpleJob *job = KIO::file_delete(url, false);
     KIO::Scheduler::assignJobToSlave(account()->slave(), job);
     ImapAccountBase::jobData jd( url.url(), 0 );
     account()->insertJob(job, jd);
@@ -1879,7 +1885,6 @@
 
 void KMFolderImap::setStatus(QValueList<int>& _ids, KMMsgStatus status, bool toggle)
 {
-  open( "setstatus" );
   FolderStorage::setStatus(_ids, status, toggle);
   QValueList<int> ids;
   if ( mUploadAllFlags ) {
@@ -1940,7 +1945,7 @@
     bool unget = !isMessage(*it);
     msg = getMsg(*it);
     if (!msg) continue;
-    QString flags = statusToFlags(msg->status());
+    QString flags = statusToFlags(msg->status(), mPermanentFlags);
     // Collect uids for each type of flags.
     groups[flags].append(QString::number(msg->UID()));
     if (unget) unGetMsg(*it);
@@ -1955,18 +1960,15 @@
        account()->setImapStatus(folder(), imappath, flags);
      }
   }
-  kdDebug() << folder()->name() << " setStatus " << mContentState << endl;
   if ( mContentState == imapListingInProgress ) {
     // we're currently get'ing this folder
     // to make sure that we get the latest flags abort the current listing and
     // create a new one
     kdDebug(5006) << "Set status during folder listing, restarting listing." << endl;
-    kdDebug() << "disconnct slotListFolderResult\n";
     disconnect(this, SLOT(slotListFolderResult(KIO::Job *)));
     quiet( false );
     reallyGetFolder( QString::null );
   }
-  close( "setstatus" );
 }
 
 //-----------------------------------------------------------------------------
@@ -2060,12 +2062,12 @@
 //-----------------------------------------------------------------------------
 void KMFolderImap::expungeFolder(KMFolderImap * aFolder, bool quiet)
 {
-  aFolder->setNeedsCompacting(FALSE);
+  aFolder->setNeedsCompacting(false);
   KURL url = account()->getUrl();
   url.setPath(aFolder->imapPath() + ";UID=*");
   if ( account()->makeConnection() != ImapAccountBase::Connected )
     return;
-  KIO::SimpleJob *job = KIO::file_delete(url, FALSE);
+  KIO::SimpleJob *job = KIO::file_delete(url, false);
   KIO::Scheduler::assignJobToSlave(account()->slave(), job);
   ImapAccountBase::jobData jd( url.url(), 0 );
   jd.quiet = quiet;
@@ -2127,7 +2129,7 @@
               false,
               account()->useSSL() || account()->useTLS() );
 
-  KIO::SimpleJob *job = KIO::stat(url, FALSE);
+  KIO::SimpleJob *job = KIO::stat(url, false);
   KIO::Scheduler::assignJobToSlave(account()->slave(), job);
   ImapAccountBase::jobData jd(url.url(), folder() );
   jd.cancellable = true;
@@ -2237,7 +2239,7 @@
   url.setPath( imapPath() + ";UID=1:*");
   if ( account()->makeConnection() == ImapAccountBase::Connected )
   {
-    KIO::SimpleJob *job = KIO::file_delete(url, FALSE);
+    KIO::SimpleJob *job = KIO::file_delete(url, false);
     KIO::Scheduler::assignJobToSlave(account()->slave(), job);
     ImapAccountBase::jobData jd( url.url(), 0 );
     jd.quiet = true;
@@ -2421,7 +2423,6 @@
 
 void KMFolderImap::finishMailCheck( const char *dbg, imapState state )
 {
-  kdDebug() << folder()->name() << " finishMailCheck " << dbg << " " << state << endl;
   quiet( false );
   mContentState = state;
   emit folderComplete( this, mContentState == imapFinished );
Index: kmail/configure.in.in
===================================================================
--- kmail/configure.in.in	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/configure.in.in	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -19,6 +19,50 @@
 
 ])
 
+dnl The following test is taken from kdelibs/kio/kio
+dnl ------------------------------------------------------------------------
+dnl Try to find if we have Linux Inode based Dir Notification
+dnl ------------------------------------------------------------------------
 
+AC_ARG_ENABLE(inotify,
+AC_HELP_STRING([--disable-inotify],[enable use of Linux inode notifications]),
+[ kde_enable_inotify=$enableval ], [kde_enable_inotify=yes])dnl
 
+AC_CHECK_GNU_EXTENSIONS
+
+if test "x$kde_enable_inotify" = "xyes"; then
+  AC_MSG_CHECKING([for Linux Inotify Notification])
+  AC_CACHE_VAL(kde_cv_have_inotify,
+  [
+  kde_cv_have_inotify=no
+  AC_LANG_SAVE
+  AC_LANG_C
+
+  AC_TRY_COMPILE(
+  [
+#include <asm/unistd.h>
+#define _S390_BITOPS_H
+#include <linux/inotify.h>
+  ],
+  [
+#ifndef IN_ALL_EVENTS
+#error no inotify notification
+#endif
+#ifndef __NR_inotify_init
+#error no __NR_inotify_init
+#endif
+
+  ],kde_cv_have_inotify=yes,kde_cv_have_inotify=no)
+
+  AC_LANG_RESTORE
+  ])
+
+  if test "$kde_cv_have_inotify" = "yes" ; then
+    AC_DEFINE_UNQUOTED(HAVE_INOTIFY, 1, [Define if your system has Linux Inode Notification])
+    AC_MSG_RESULT(yes)
+  else
+    AC_MSG_RESULT(no)
+  fi
+fi
+
 KMAIL_CHECK_INDEXLIB
Index: kmail/kmmsglist.cpp
===================================================================
--- kmail/kmmsglist.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmsglist.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -97,8 +97,6 @@
   if (!at(idx) && aMsg) mCount++;
   else if (at(idx) && !aMsg) mCount--;
 
-  delete at(idx);
-
   at(idx) = aMsg;
 
   if (!aMsg || idx >= mHigh) rethinkHigh();
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -114,12 +114,12 @@
 {
   NetworkAccount::init();
 
-  mUsePipelining = FALSE;
-  mLeaveOnServer = FALSE;
+  mUsePipelining = false;
+  mLeaveOnServer = false;
   mLeaveOnServerDays = -1;
   mLeaveOnServerCount = -1;
   mLeaveOnServerSize = -1;
-  mFilterOnServer = FALSE;
+  mFilterOnServer = false;
   //tz todo
   mFilterOnServerCheckSize = 50000;
 }
@@ -152,7 +152,7 @@
       bool b = storePasswd();
       if (KIO::PasswordDialog::getNameAndPassword(mLogin, passwd, &b,
         i18n("You need to supply a username and a password to access this "
-        "mailbox."), FALSE, QString::null, mName, i18n("Account:"))
+        "mailbox."), false, QString::null, mName, i18n("Account:"))
         != QDialog::Accepted)
       {
         checkDone( false, CheckAborted );
@@ -162,7 +162,7 @@
         if ( b ) {
           kmkernel->acctMgr()->writeConfig( true );
         }
-        mAskAgain = FALSE;
+        mAskAgain = false;
       }
     }
 
@@ -201,7 +201,7 @@
     mSizeOfNextSeenMsgsDict.clear();
 
     interactive = _interactive;
-    mUidlFinished = FALSE;
+    mUidlFinished = false;
     startJob();
   }
   else {
@@ -216,12 +216,12 @@
 {
   NetworkAccount::readConfig(config);
 
-  mUsePipelining = config.readNumEntry("pipelining", FALSE);
-  mLeaveOnServer = config.readNumEntry("leave-on-server", FALSE);
+  mUsePipelining = config.readNumEntry("pipelining", false);
+  mLeaveOnServer = config.readNumEntry("leave-on-server", false);
   mLeaveOnServerDays = config.readNumEntry("leave-on-server-days", -1);
   mLeaveOnServerCount = config.readNumEntry("leave-on-server-count", -1);
   mLeaveOnServerSize = config.readNumEntry("leave-on-server-size", -1);
-  mFilterOnServer = config.readNumEntry("filter-on-server", FALSE);
+  mFilterOnServer = config.readNumEntry("filter-on-server", false);
   mFilterOnServerCheckSize = config.readUnsignedNumEntry("filter-os-check-size", 50000);
 }
 
@@ -486,7 +486,7 @@
   }
   else if (stage == Uidl) {
     kdDebug(5006) << k_funcinfo << "stage == Uidl" << endl;
-    mUidlFinished = TRUE;
+    mUidlFinished = true;
 
     if ( mLeaveOnServer && mUidForIdMap.isEmpty() &&
         mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
@@ -788,7 +788,7 @@
     mSlave = 0;
     stage = Idle;
     if( mMailCheckProgressItem ) { // do this only once...
-      bool canceled = kmkernel->mailCheckAborted() || mMailCheckProgressItem->canceled();
+      bool canceled = !kmkernel || kmkernel->mailCheckAborted() || mMailCheckProgressItem->canceled();
       int numMessages = canceled ? indexOfCurrentMsg : idsOfMsgs.count();
       BroadcastStatus::instance()->setStatusMsgTransmissionCompleted(
         this->name(), numMessages, numBytes, numBytesRead, numBytesToRead, mLeaveOnServer, mMailCheckProgressItem );
@@ -1015,14 +1015,14 @@
     mSlave = 0;
   }
 
-  if (interactive) {
+  if (interactive && kmkernel) {
     KMessageBox::error(kmkernel->mainWin(), KIO::buildErrorString(error, errorMsg));
   }
 
 
   stage = Quit;
   if (error == KIO::ERR_COULD_NOT_LOGIN && !mStorePasswd)
-    mAskAgain = TRUE;
+    mAskAgain = true;
   /* We need a timer, otherwise slotSlaveError of the next account is also
      executed, if it reuses the slave, because the slave member variable
      is changed too early */
Index: kmail/headerlistquicksearch.h
===================================================================
--- kmail/headerlistquicksearch.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/headerlistquicksearch.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,9 +58,22 @@
      */
     bool eventFilter( QObject *watched, QEvent *event );
 
+    /**
+     * Returns the currently entered search text.
+     */
+    QString currentSearchTerm() const;
+
+    /**
+     * Returns the currently selected status filter.
+     */
+    int currentStatus() const;
+
 public slots:
    void reset();
 
+signals:
+    void requestFullSearch();
+
 protected:
     /**
      * checks whether @param item contains the search string and has the status
@@ -81,6 +94,7 @@
     QComboBox *mStatusCombo;
     KMMsgStatus mStatus;
     QValueVector<QString> statusList;
+    mutable QString mCurrentSearchTerm;
 };
 
 }
Index: kmail/attachmentlistview.cpp
===================================================================
--- kmail/attachmentlistview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/attachmentlistview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,6 +53,7 @@
     mComposer( composer )
 {
   setAcceptDrops( true );
+  setDragEnabled( true );
 }
 
 //-----------------------------------------------------------------------------
@@ -65,7 +66,7 @@
 
 void AttachmentListView::contentsDragEnterEvent( QDragEnterEvent* e )
 {
-  if( e->provides( MailListDrag::format() ) )
+  if( e->provides( MailListDrag::format() ) || KURLDrag::canDecode( e ) )
     e->accept( true );
   else
     KListView::dragEnterEvent( e );
@@ -75,7 +76,7 @@
 
 void AttachmentListView::contentsDragMoveEvent( QDragMoveEvent* e )
 {
-  if( e->provides( MailListDrag::format() ) )
+  if( e->provides( MailListDrag::format() ) || KURLDrag::canDecode( e ) )
     e->accept( true );
   else
     KListView::dragMoveEvent( e );
@@ -134,6 +135,11 @@
   }
 }
 
+/*virtual*/
+void AttachmentListView::startDrag()
+{
+    emit dragStarted();
+}
 
 } // namespace KMail
 
Index: kmail/kmfoldermbox.cpp
===================================================================
--- kmail/kmfoldermbox.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,6 +39,7 @@
 #include <kprocess.h>
 #include <kconfig.h>
 
+#include <ctype.h>
 #include <stdio.h>
 #include <errno.h>
 #include <assert.h>
@@ -84,8 +85,10 @@
 //-----------------------------------------------------------------------------
 KMFolderMbox::~KMFolderMbox()
 {
-  if (mOpenCount>0) close("~kmfoldermbox", true);
-  if (kmkernel->undoStack()) kmkernel->undoStack()->folderDestroyed( folder() );
+  if (mOpenCount>0)
+    close("~kmfoldermbox", true);
+  if (kmkernel->undoStack())
+    kmkernel->undoStack()->folderDestroyed( folder() );
 }
 
 //-----------------------------------------------------------------------------
@@ -96,10 +99,7 @@
   mOpenCount++;
   kmkernel->jobScheduler()->notifyOpeningFolder( folder() );
 
-  if (mOpenCount > 1) {
-     assert(mStream);
-     return 0;  // already open
-  }
+  if (mOpenCount > 1) return 0;  // already open
 
   assert(!folder()->name().isEmpty());
 
@@ -256,7 +256,7 @@
 
 
 //-----------------------------------------------------------------------------
-void KMFolderMbox::reallyDoClose(const char *owner)
+void KMFolderMbox::reallyDoClose(const char* owner)
 {
   if (mAutoCreateIndex)
   {
@@ -817,7 +817,8 @@
   assert(mi!=0 && !mi->isMessage());
   assert(mStream != 0);
 
-  KMMessage *msg = new KMMessage(*mi); // note that mi is deleted by the line below
+  KMMessage *msg = new KMMessage(*mi);
+  msg->setMsgInfo( mi ); // remember the KMMsgInfo object to that we can restore it when the KMMessage object is no longer needed
   mMsgList.set(idx,&msg->toMsgBase()); // done now so that the serial number can be computed
   msg->fromDwString(getDwString(idx));
   return msg;
@@ -928,7 +929,6 @@
 int KMFolderMbox::addMsg( KMMessage* aMsg, int* aIndex_ret )
 {
   if (!canAddMsgNow(aMsg, aIndex_ret)) return 0;
-  bool opened = false;
   QByteArray msgText;
   char endStr[3];
   int idx = -1, rc;
@@ -936,12 +936,12 @@
   bool editing = false;
   int growth = 0;
 
-  if (!mStream)
+  KMFolderOpener openThis(folder(), "mboxaddMsg");
+  rc = openThis.openResult();
+  if (rc)
   {
-    opened = true;
-    rc = open("mboxaddMsg");
-    kdDebug(5006) << "KMFolderMBox::addMsg-open: " << rc << " of folder: " << label() << endl;
-    if (rc) return rc;
+    kdDebug(5006) << "KMFolderMbox::addMsg-open: " << rc << " of folder: " << label() << endl;
+    return rc;
   }
 
   // take message out of the folder it is currently in, if any
@@ -994,7 +994,6 @@
   if (len <= 0)
   {
     kdDebug(5006) << "Message added to folder `" << name() << "' contains no data. Ignoring it." << endl;
-    if (opened) close("mboxaddMsg");
     return 0;
   }
 
@@ -1019,10 +1018,7 @@
   fseek(mStream,0,SEEK_END); // this is needed on solaris and others
   int error = ferror(mStream);
   if (error)
-  {
-    if (opened) close("mboxaddMsg");
     return error;
-  }
 
   QCString messageSeparator( aMsg->mboxMessageSeparator() );
   fwrite( messageSeparator.data(), messageSeparator.length(), 1, mStream );
@@ -1049,7 +1045,6 @@
                "(No space left on device or insufficient quota?)\n"
                "Free space and sufficient quota are required to continue safely."));
     if (busy) kmkernel->kbp()->busy();
-    if (opened) close();
     kmkernel->kbp()->idle();
     */
     return error;
@@ -1068,6 +1063,7 @@
       emit numUnreadMsgsChanged( folder() );
   }
   ++mTotalMsgs;
+  mSize = -1;
 
   if ( aMsg->attachmentState() == KMMsgAttachmentUnknown &&
        aMsg->readyToShow() )
@@ -1132,16 +1128,13 @@
              "(No space left on device or insufficient quota?)\n"
              "Free space and sufficient quota are required to continue safely."));
       if (busy) kmkernel->kbp()->busy();
-      if (opened) close();
       */
       return error;
     }
   }
 
-  // some "paper work"
   if (aIndex_ret) *aIndex_ret = idx;
   emitMsgAddedSignals(idx);
-  if (opened) close("mboxaddMsg");
 
   // All streams have been flushed without errors if we arrive here
   // Return success!
@@ -1274,4 +1267,12 @@
 }
 
 //-----------------------------------------------------------------------------
+/*virtual*/
+Q_INT64 KMFolderMbox::doFolderSize() const
+{
+  QFileInfo info( location() );
+  return (Q_INT64)(info.size());
+}
+
+//-----------------------------------------------------------------------------
 #include "kmfoldermbox.moc"
Index: kmail/kmfolderindex.cpp
===================================================================
--- kmail/kmfolderindex.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderindex.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -273,7 +273,7 @@
     else if (mi->isNew())
     {
       mi->setStatus(KMMsgStatusUnread);
-      mi->setDirty(FALSE);
+      mi->setDirty(false);
     }
 #endif
     if ((mi->isNew()) || (mi->isUnread()) ||
@@ -286,7 +286,7 @@
   }
   if( version < 1505)
   {
-    mConvertToUtf8 = FALSE;
+    mConvertToUtf8 = false;
     setDirty( true );
     writeIndex();
   }
@@ -319,14 +319,14 @@
   if (indexVersion < 1505 ) {
       if(indexVersion == 1503) {
 	  kdDebug(5006) << "Converting old index file " << indexLocation() << " to utf-8" << endl;
-	  mConvertToUtf8 = TRUE;
+	  mConvertToUtf8 = true;
       }
-      return TRUE;
+      return true;
   } else if (indexVersion == 1505) {
   } else if (indexVersion < INDEX_VERSION) {
       kdDebug(5006) << "Index file " << indexLocation() << " is out of date. Re-creating it." << endl;
       createIndexFromContents();
-      return FALSE;
+      return false;
   } else if(indexVersion > INDEX_VERSION) {
       kapp->setOverrideCursor(KCursor::arrowCursor());
       int r = KMessageBox::questionYesNo(0,
@@ -338,7 +338,7 @@
       kapp->restoreOverrideCursor();
       if (r == KMessageBox::Yes)
 	  createIndexFromContents();
-      return FALSE;
+      return false;
   }
   else {
       // Header
@@ -382,7 +382,7 @@
          kdDebug(5006) << "Index File sizeOfLong is " << mIndexSizeOfLong << " while sizeof(long) is " << sizeof(long) << " !" << endl;
 
   }
-  return TRUE;
+  return true;
 }
 
 
@@ -405,7 +405,7 @@
 	    munmap((char *)mIndexStreamPtr, mIndexStreamPtrLength);
 	mIndexStreamPtr = 0;
 	mIndexStreamPtrLength = 0;
-	return TRUE;
+	return true;
     }
 
     assert(mIndexStream);
@@ -415,7 +415,7 @@
 	    munmap((char *)mIndexStreamPtr, mIndexStreamPtrLength);
 	mIndexStreamPtr = 0;
 	mIndexStreamPtrLength = 0;
-	return FALSE;
+	return false;
     }
     if(mIndexStreamPtr)
 	munmap((char *)mIndexStreamPtr, mIndexStreamPtrLength);
@@ -425,10 +425,10 @@
     if(mIndexStreamPtr == MAP_FAILED) {
 	mIndexStreamPtr = 0;
 	mIndexStreamPtrLength = 0;
-	return FALSE;
+	return false;
     }
 #endif
-    return TRUE;
+    return true;
 }
 
 
@@ -473,9 +473,14 @@
 
 KMMsgInfo* KMFolderIndex::setIndexEntry( int idx, KMMessage *msg )
 {
-  KMMsgInfo *msgInfo = new KMMsgInfo( folder() );
+  KMMsgInfo *msgInfo = msg->msgInfo();
+  if ( !msgInfo )
+    msgInfo = new KMMsgInfo( folder() );
+
   *msgInfo = *msg;
   mMsgList.set( idx, msgInfo );
+  msg->setMsgInfo( 0 );
+  delete msg;
   return msgInfo;
 }
 
Index: kmail/filterimporterexporter.cpp
===================================================================
--- kmail/filterimporterexporter.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/filterimporterexporter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,187 @@
+#include "filterimporterexporter.h"
+
+#include "kmfilter.h"
+#include "kmfilteraction.h"
+#include "util.h"
+
+#include <kconfig.h>
+#include <kdebug.h>
+#include <kfiledialog.h>
+#include <kdialogbase.h>
+#include <klistview.h>
+
+#include <qregexp.h>
+
+
+using namespace KMail;
+
+class FilterSelectionDialog : public KDialogBase
+{
+public:
+    FilterSelectionDialog( QWidget * parent = 0 )
+        :KDialogBase( parent, "filterselection", true, i18n("Select Filters"), Ok|Cancel, Ok, true ),
+        wasCancelled( false )
+    {
+        filtersListView = new KListView( this );
+        setMainWidget(filtersListView);
+        filtersListView->setSorting( -1 );
+        filtersListView->setSelectionMode( QListView::NoSelection );
+        filtersListView->addColumn( i18n("Filters"), 300 );
+        filtersListView->setFullWidth( true );
+        resize( 300, 350 );
+    }
+
+    virtual ~FilterSelectionDialog()
+    {
+    }
+    
+    virtual void slotCancel()
+    {
+        wasCancelled = true;
+        KDialogBase::slotCancel();
+    }
+    
+    bool cancelled()
+    {
+        return wasCancelled;
+    }
+
+    void setFilters( const QValueList<KMFilter*>& filters )
+    {
+        originalFilters = filters;
+        filtersListView->clear();
+        QValueListConstIterator<KMFilter*> it = filters.constEnd();
+        while ( it != filters.constBegin() ) {
+            --it;
+            KMFilter* filter = *it;
+            QCheckListItem* item = new QCheckListItem( filtersListView, filter->name(), QCheckListItem::CheckBox );
+            item->setOn( true );
+        }
+    }
+    
+    QValueList<KMFilter*> selectedFilters() const
+    {
+        QValueList<KMFilter*> filters;
+        QListViewItemIterator it( filtersListView );
+        int i = 0;
+        while( it.current() ) {
+            QCheckListItem* item = static_cast<QCheckListItem*>( it.current() );
+            if ( item->isOn() )
+                filters << originalFilters[i];
+            ++i; ++it;
+        }
+        return filters;
+    }
+private:
+    KListView *filtersListView;
+    QValueList<KMFilter*> originalFilters;
+    bool wasCancelled;
+};
+
+/* static */
+QValueList<KMFilter*> FilterImporterExporter::readFiltersFromConfig( KConfig* config, bool bPopFilter )
+{
+    KConfigGroupSaver saver(config, "General");
+    int numFilters = 0;
+    if (bPopFilter)
+      numFilters = config->readNumEntry("popfilters",0);
+    else
+      numFilters = config->readNumEntry("filters",0);
+    
+    QValueList<KMFilter*> filters;
+    for ( int i=0 ; i < numFilters ; ++i ) {
+      QString grpName;
+      grpName.sprintf("%s #%d", (bPopFilter ? "PopFilter" : "Filter") , i);
+      KConfigGroupSaver saver(config, grpName);
+      KMFilter * filter = new KMFilter(config, bPopFilter);
+      filter->purify();
+      if ( filter->isEmpty() ) {
+    #ifndef NDEBUG
+        kdDebug(5006) << "KMFilter::readConfig: filter\n" << filter->asString()
+          << "is empty!" << endl;
+    #endif
+        delete filter;
+      } else
+        filters.append(filter);
+    }
+    return filters;
+}
+
+/* static */ 
+void FilterImporterExporter::writeFiltersToConfig( const QValueList<KMFilter*>& filters, KConfig* config, bool bPopFilter )
+{
+    // first, delete all groups:
+    QStringList filterGroups =
+      config->groupList().grep( QRegExp( bPopFilter ? "PopFilter #\\d+" : "Filter #\\d+" ) );
+    for ( QStringList::Iterator it = filterGroups.begin() ;
+          it != filterGroups.end() ; ++it )
+      config->deleteGroup( *it );
+    
+    int i = 0;
+    for ( QValueListConstIterator<KMFilter*> it = filters.constBegin() ;
+          it != filters.constEnd() ; ++it ) {
+      if ( !(*it)->isEmpty() ) {
+        QString grpName;
+        if ( bPopFilter )
+          grpName.sprintf("PopFilter #%d", i);
+        else
+          grpName.sprintf("Filter #%d", i);
+        KConfigGroupSaver saver(config, grpName);
+        (*it)->writeConfig(config);
+        ++i;
+      }
+    }
+    KConfigGroupSaver saver(config, "General");
+    if (bPopFilter)
+      config->writeEntry("popfilters", i);
+    else
+      config->writeEntry("filters", i);
+}
+
+
+FilterImporterExporter::FilterImporterExporter( QWidget* parent, bool popFilter )
+:mParent( parent), mPopFilter( popFilter )
+{
+}
+
+FilterImporterExporter::~FilterImporterExporter()
+{
+}
+
+QValueList<KMFilter*> FilterImporterExporter::importFilters()
+{
+    QString fileName = KFileDialog::getOpenFileName( QDir::homeDirPath(), QString::null, mParent, i18n("Import Filters") );
+    if ( fileName.isEmpty() ) 
+        return QValueList<KMFilter*>(); // cancel
+    
+    { // scoping
+        QFile f( fileName );
+        if ( !f.open( IO_ReadOnly ) ) {
+            KMessageBox::error( mParent, i18n("The selected file is not readable. Your file access permissions might be insufficient.") );
+            return QValueList<KMFilter*>();
+        }
+    }
+    
+    KConfig config( fileName );
+    QValueList<KMFilter*> imported = readFiltersFromConfig( &config, mPopFilter );
+    FilterSelectionDialog dlg( mParent );
+    dlg.setFilters( imported );
+    dlg.exec();
+    return dlg.cancelled() ? QValueList<KMFilter*>() : dlg.selectedFilters();
+}
+
+void FilterImporterExporter::exportFilters(const QValueList<KMFilter*> & filters )
+{
+    KURL saveUrl = KFileDialog::getSaveURL( QDir::homeDirPath(), QString::null, mParent, i18n("Export Filters") );
+    
+    if ( saveUrl.isEmpty() || !Util::checkOverwrite( saveUrl, mParent ) )
+      return;
+    
+    KConfig config( saveUrl.path() );
+    FilterSelectionDialog dlg( mParent );
+    dlg.setFilters( filters );
+    dlg.exec();
+    if ( !dlg.cancelled() )
+        writeFiltersToConfig( dlg.selectedFilters(), &config, mPopFilter );
+}
+
Index: kmail/kmfolder.cpp
===================================================================
--- kmail/kmfolder.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolder.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -33,6 +33,7 @@
 #include "compactionjob.h"
 #include "kmfoldertree.h"
 #include "kmailicalifaceimpl.h"
+#include "kmaccount.h"
 
 #include <errno.h>
 
@@ -126,6 +127,9 @@
 
   connect( mStorage, SIGNAL( contentsTypeChanged( KMail::FolderContentsType ) ),
                 this, SLOT( slotContentsTypeChanged( KMail::FolderContentsType ) ) );
+  
+  connect( mStorage, SIGNAL( folderSizeChanged() ),
+           this, SLOT( slotFolderSizeChanged() ) );
 
   //FIXME: Centralize all the readConfig calls somehow - Zack
   // Meanwhile, readConfig must be done before registerWithMessageDict, since
@@ -206,7 +210,10 @@
   config->writeEntry("MailingListEnabled", mMailingListEnabled);
   mMailingList.writeConfig( config );
 
-  config->writeEntry("Identity", mIdentity);
+  if ( mIdentity != 0 && ( !mStorage || !mStorage->account() || mIdentity != mStorage->account()->identityId() ) )
+      config->writeEntry("Identity", mIdentity);
+  else
+      config->deleteEntry("Identity");
 
   config->writeEntry("WhoField", mUserWhoField);
   config->writeEntry("Id", mId);
@@ -422,12 +429,12 @@
 
 int KMFolder::find( const KMMsgBase* msg ) const
 {
-  return mStorage ? mStorage->find( msg ) : 0;
+  return mStorage ? mStorage->find( msg ) : -1;
 }
 
 int KMFolder::find( const KMMessage* msg ) const
 {
-  return mStorage ? mStorage->find( msg ) : 0;
+  return mStorage ? mStorage->find( msg ) : -1;
 }
 
 int KMFolder::count( bool cache ) const
@@ -507,7 +514,7 @@
      the message dict, since its message list is empty, and the .ids
      file contents are not loaded. That can lead to lookups in the
      dict returning stale pointers to the folder later. */
-  mStorage->open( "KMFolder::remove" );
+  mStorage->open("kmfolder_remove");
   mStorage->remove();
 }
 
@@ -608,6 +615,16 @@
   kmkernel->slotRequestConfigSync();
 }
 
+uint KMFolder::identity() const
+{
+  // if we don't have one set ourselves, check our account
+  kdDebug() << "FOO: " << mIdentity << " :: " << mStorage << endl;
+  if ( !mIdentity && mStorage )
+    if ( KMAccount *act = mStorage->account() )
+      return act->identityId();
+  return mIdentity;
+}
+
 void KMFolder::setWhoField(const QString& aWhoField )
 {
   mWhoField = aWhoField;
@@ -850,4 +867,14 @@
   emit iconsChanged();
 }
 
+void KMFolder::slotFolderSizeChanged()
+{
+  emit folderSizeChanged( this );
+  KMFolder* papa = parent()->manager()->parentFolder( this );
+  if ( papa && papa != this ) {
+    papa->slotFolderSizeChanged();
+  }
+}
+
+
 #include "kmfolder.moc"
Index: kmail/snippetsettings.h
===================================================================
--- kmail/snippetsettings.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetsettings.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,41 @@
+/*
+ *  File : snippetsettings.h
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#ifndef SNIPPETSETTINGS_H
+#define SNIPPETSETTINGS_H
+
+#include "snippetsettingsbase.h"
+
+class SnippetWidget;
+class SnippetConfig;
+
+/**
+This class is the widget that is showen in the
+KDevelop settings dialog. It inherits the
+class SnippetSettingsBase which is created by the
+same named .ui file
+@author Robert Gruber
+*/
+class SnippetSettings : public SnippetSettingsBase
+{
+Q_OBJECT
+public:
+    SnippetSettings(QWidget *parent = 0, const char *name = 0);
+    SnippetSettings(SnippetWidget * w, QWidget *parent = 0, const char *name = 0);
+
+    ~SnippetSettings();
+
+public slots:
+    void slotOKClicked();
+
+private:
+  SnippetConfig * _cfg;
+  SnippetWidget * _widget;
+};
+
+#endif
Index: kmail/keyresolver.cpp
===================================================================
--- kmail/keyresolver.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/keyresolver.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -61,6 +61,8 @@
 #include <qstringlist.h>
 #include <qtl.h>
 
+#include <time.h>
+
 #include <algorithm>
 #include <memory>
 #include <iterator>
@@ -68,8 +70,8 @@
 #include <map>
 #include <set>
 #include <iostream>
+#include <cassert>
 
-#include <time.h>
 
 //
 // some predicates to be used in STL algorithms:
@@ -119,7 +121,7 @@
     return false;
   const std::vector<GpgME::UserID> uids = key.userIDs();
   for ( std::vector<GpgME::UserID>::const_iterator it = uids.begin() ; it != uids.end() ; ++it ) {
-    if ( !it->isRevoked() && it->validity() >= GpgME::UserID::Marginal )
+    if ( !it->isRevoked() && it->validity() != GpgME::UserID::Marginal )
       return true;
 #if 0
     else
@@ -189,6 +191,69 @@
   return !ValidSMIMESigningKey( key );
 }
 
+static QStringList keysAsStrings( const std::vector<GpgME::Key>& keys ) {
+  QStringList strings;
+  for ( std::vector<GpgME::Key>::const_iterator it = keys.begin() ; it != keys.end() ; ++it ) {
+    assert( !(*it).userID(0).isNull() );
+    QString keyLabel = QString::fromUtf8( (*it).userID(0).email() );
+    if ( keyLabel.isEmpty() )
+      keyLabel = QString::fromUtf8( (*it).userID(0).name() );
+    if ( keyLabel.isEmpty() )
+      keyLabel = QString::fromUtf8( (*it).userID(0).id() );
+    strings.append( keyLabel );
+  }
+  return strings;
+}
+
+static inline std::vector<GpgME::Key> TrustedOrConfirmed( const std::vector<GpgME::Key> & keys ) {
+
+  std::vector<GpgME::Key> fishies;
+  std::vector<GpgME::Key> ickies;
+  std::vector<GpgME::Key>::const_iterator it = keys.begin();
+  const std::vector<GpgME::Key>::const_iterator end = keys.end();
+  for ( ; it != end ; it++ ) {
+    const GpgME::Key key = *it;
+    assert( ValidTrustedEncryptionKey( key ) );
+    const std::vector<GpgME::UserID> uids = key.userIDs();
+    for ( std::vector<GpgME::UserID>::const_iterator it = uids.begin() ; it != uids.end() ; ++it ) {
+      if ( !it->isRevoked()  && it->validity() == GpgME::UserID::Marginal ) {
+        fishies.push_back( key );
+        break;
+      }
+      if ( !it->isRevoked()  && it->validity() < GpgME::UserID::Never ) {
+        ickies.push_back( key );
+        break;
+      }
+    }
+  }
+
+  if ( fishies.empty() && ickies.empty() )
+    return keys;
+
+  // if  some keys are not fully trusted, let the user confirm their use
+  QString msg = i18n("One or more of your configured OpenPGP encryption "
+                      "keys or S/MIME certificates is not fully trusted "
+                      "for encryption.");
+
+  if ( !fishies.empty() ) {
+    // certificates can't have marginal trust
+    msg += i18n( "\nThe following keys are only marginally trusted: \n");
+    msg += keysAsStrings( fishies ).join(",");
+  }
+  if ( !ickies.empty() ) {
+    msg += i18n( "\nThe following keys or certificates have unknown trust level: \n");
+    msg += keysAsStrings( ickies ).join(",");
+  }
+
+  if( KMessageBox::warningContinueCancel( 0, msg, i18n("Not Fully Trusted Encryption Keys"),
+                                              KStdGuiItem::cont(),
+                                              "not fully trusted encryption key warning" )
+          == KMessageBox::Continue )
+    return keys;
+  else
+    return std::vector<GpgME::Key>();
+}
+
 namespace {
   struct IsNotForFormat : public std::unary_function<GpgME::Key,bool> {
     IsNotForFormat( Kleo::CryptoMessageFormat f ) : format( f ) {}
@@ -1301,12 +1366,15 @@
 std::vector<GpgME::Key> Kleo::KeyResolver::selectKeys( const QString & person, const QString & msg, const std::vector<GpgME::Key> & selectedKeys ) const {
   Kleo::KeySelectionDialog dlg( i18n("Encryption Key Selection"),
 				msg, selectedKeys,
-				Kleo::KeySelectionDialog::ValidTrustedEncryptionKeys,
+				Kleo::KeySelectionDialog::ValidEncryptionKeys,
 				true, true ); // multi-selection and "remember choice" box
 
   if ( dlg.exec() != QDialog::Accepted )
     return std::vector<GpgME::Key>();
-  const std::vector<GpgME::Key> keys = dlg.selectedKeys();
+  std::vector<GpgME::Key> keys = dlg.selectedKeys();
+  keys.erase( std::remove_if( keys.begin(), keys.end(),
+                                      NotValidTrustedEncryptionKey ),
+                              keys.end() );
   if ( !keys.empty() && dlg.rememberSelection() )
     setKeysForAddress( person, dlg.pgpKeyFingerprints(), dlg.smimeFingerprints() );
   return keys;
@@ -1328,23 +1396,25 @@
     if ( !keys.empty() ) {
       // Check if all of the keys are trusted and valid encryption keys
       if ( std::find_if( keys.begin(), keys.end(),
-			 NotValidTrustedEncryptionKey ) == keys.end() )
-	return keys;
+                         NotValidTrustedEncryptionKey ) != keys.end() ) {
 
-      // not ok, let the user select: this is not conditional on !quiet,
-      // since it's a bug in the configuration and the user should be
-      // notified about it as early as possible:
-      keys = selectKeys( person,
-			 i18n("if in your language something like "
-			      "'key(s)' isn't possible please "
-			      "use the plural in the translation",
-			      "There is a problem with the "
-			      "encryption key(s) for \"%1\".\n\n"
-			      "Please re-select the key(s) which should "
-			      "be used for this recipient.").arg(person),
-			 keys );
+        // not ok, let the user select: this is not conditional on !quiet,
+        // since it's a bug in the configuration and the user should be
+        // notified about it as early as possible:
+        keys = selectKeys( person,
+            i18n("if in your language something like "
+              "'key(s)' isn't possible please "
+              "use the plural in the translation",
+              "There is a problem with the "
+              "encryption key(s) for \"%1\".\n\n"
+              "Please re-select the key(s) which should "
+              "be used for this recipient.").arg(person),
+            keys );
+      }
+      keys = TrustedOrConfirmed( keys );
+
       if ( !keys.empty() )
-	return keys;
+        return keys;
       // hmmm, should we not return the keys in any case here?
     }
   }
@@ -1363,28 +1433,33 @@
 			matchingKeys.end() );
   }
 
+  // if called with quite == true (from EncryptionPreferenceCounter), we only want to
+  // check if there are keys for this recipients, not (yet) their validity, so
+  // don't show the untrusted encryption key warning in that case
+  if ( !quiet )
+    matchingKeys = TrustedOrConfirmed( matchingKeys );
   if ( quiet || matchingKeys.size() == 1 )
     return matchingKeys;
 
   // no match until now, or more than one key matches; let the user
   // choose the key(s)
   // FIXME: let user get the key from keyserver
-  return selectKeys( person,
-		     matchingKeys.empty()
-		     ? i18n("if in your language something like "
-			    "'key(s)' isn't possible please "
-			    "use the plural in the translation",
-			    "No valid and trusted encryption key was "
-			    "found for \"%1\".\n\n"
-			    "Select the key(s) which should "
-			    "be used for this recipient.").arg(person)
-		     : i18n("if in your language something like "
-			    "'key(s)' isn't possible please "
-			    "use the plural in the translation",
-			    "More than one key matches \"%1\".\n\n"
-			    "Select the key(s) which should "
-			    "be used for this recipient.").arg(person),
-		     matchingKeys );
+  return TrustedOrConfirmed( selectKeys( person,
+          matchingKeys.empty()
+          ? i18n("if in your language something like "
+              "'key(s)' isn't possible please "
+              "use the plural in the translation",
+              "No valid and trusted encryption key was "
+              "found for \"%1\".\n\n"
+              "Select the key(s) which should "
+              "be used for this recipient.").arg(person)
+          : i18n("if in your language something like "
+              "'key(s)' isn't possible please "
+              "use the plural in the translation",
+              "More than one key matches \"%1\".\n\n"
+              "Select the key(s) which should "
+              "be used for this recipient.").arg(person),
+          matchingKeys ) );
 }
 
 
Index: kmail/quotajobs.h
===================================================================
--- kmail/quotajobs.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/quotajobs.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -51,6 +51,12 @@
   QuotaInfo() {} // for QValueVector
   QuotaInfo( const QString& _name, const QString& _root, const QVariant& _current, const QVariant& _max )
     : mName( _name ), mRoot( _root ), mCurrent( _current ),mMax( _max )  {}
+  bool operator==( const QuotaInfo & other ) const {
+    return mName == other.mName && mRoot == other.mRoot && mMax == other.mMax && mCurrent == other.mCurrent;
+  }
+  bool operator!=( const QuotaInfo & other ) const {
+    return !(operator==(other) );
+  }
   bool isValid() const { return !mName.isEmpty(); }
   bool isEmpty() const { return mName.isEmpty() || ( mRoot.isEmpty() && !mCurrent.isValid() && !mMax.isValid() ); }
 
Index: kmail/recipientseditor.cpp
===================================================================
--- kmail/recipientseditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/recipientseditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,6 +32,7 @@
 #include <libemailfunctions/email.h>
 
 #include <kapplication.h>
+#include <kcompletionbox.h>
 #include <kdebug.h>
 #include <kinputdialog.h>
 #include <klocale.h>
@@ -328,7 +329,9 @@
 
   addLine();
   setResizePolicy( QScrollView::Manual );
-  setSizePolicy( QSizePolicy::Expanding, QSizePolicy::Fixed );
+  setSizePolicy( QSizePolicy::Expanding, QSizePolicy::Expanding );
+
+  viewport()->setPaletteBackgroundColor( paletteBackgroundColor() );
 }
 
 RecipientLine *RecipientsView::activeLine()
@@ -528,8 +531,12 @@
   resizeContents( width(), mLines.count() * mLineHeight );
 
   if ( mLines.count() < 6 ) {
-    setFixedHeight( mLineHeight * mLines.count() );
+//    setFixedHeight( mLineHeight * mLines.count() );
   }
+
+  parentWidget()->layout()->activate();
+  emit sizeHintChanged();
+  QTimer::singleShot( 0, this, SLOT(moveCompletionPopup()) );
 }
 
 void RecipientsView::activateLine( RecipientLine *line )
@@ -543,6 +550,7 @@
   for( uint i = 0; i < mLines.count(); ++i ) {
     mLines.at( i )->resize( ev->size().width(), mLineHeight );
   }
+  ensureVisible( 0, mLines.count() * mLineHeight );
 }
 
 QSize RecipientsView::sizeHint() const
@@ -553,12 +561,9 @@
 QSize RecipientsView::minimumSizeHint() const
 {
   int height;
-
   uint numLines = 5;
-
   if ( mLines.count() < numLines ) height = mLineHeight * mLines.count();
   else height = mLineHeight * numLines;
-
   return QSize( 200, height );
 }
 
@@ -677,6 +682,20 @@
   return mFirstColumnWidth;
 }
 
+void RecipientsView::moveCompletionPopup()
+{
+  for( RecipientLine* line = mLines.first(); line; line = mLines.next() ) {
+    if ( line->lineEdit()->completionBox( false ) ) {
+      if ( line->lineEdit()->completionBox()->isVisible() ) {
+        // ### trigger moving, is there a nicer way to do that?
+        line->lineEdit()->completionBox()->hide();
+        line->lineEdit()->completionBox()->show();
+      }
+    }
+  }
+
+}
+
 RecipientsToolTip::RecipientsToolTip( RecipientsView *view, QWidget *parent )
   : QToolTip( parent ), mView( view )
 {
@@ -840,6 +859,9 @@
     mSideWidget, SLOT( setTotal( int, int ) ) );
   connect( mRecipientsView, SIGNAL( focusRight() ),
     mSideWidget, SLOT( setFocus() ) );
+
+  connect( mRecipientsView, SIGNAL(sizeHintChanged()),
+           SIGNAL(sizeHintChanged()) );
 }
 
 RecipientsEditor::~RecipientsEditor()
@@ -972,4 +994,5 @@
 {
   mRecipientsView->setCompletionMode( mode );
 }
+
 #include "recipientseditor.moc"
Index: kmail/kmkernel.h
===================================================================
--- kmail/kmkernel.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmkernel.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -386,6 +386,9 @@
 
   void raise();
 
+  void loadProfile( const QString& path );
+
+  void saveToProfile( const QString& path ) const;
 public slots:
 
   /// Save contents of all open composer widnows to ~/dead.letter
Index: kmail/kmfolderimap.h
===================================================================
--- kmail/kmfolderimap.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderimap.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -131,9 +131,6 @@
   /** Remove the IMAP folder on the server and if successful also locally */
   virtual void remove();
 
-  /** Closes and cancels all pending jobs. */
-  virtual void reallyDoClose(const char *owner);
-
   /** Automatically expunge deleted messages when leaving the folder */
   bool autoExpunge();
 
@@ -242,7 +239,7 @@
   /**
    * Convert message status to a list of IMAP flags
    */
-  static QString statusToFlags(KMMsgStatus status);
+  static QString statusToFlags(KMMsgStatus status, int supportedFalgs);
 
   /**
    * Return the filename of the folder (reimplemented from KFolder)
@@ -280,6 +277,9 @@
   /** imap folders cannot expire */
   virtual bool isAutoExpire() const { return false; }
 
+  /** Closes and cancels all pending jobs. */
+  virtual void reallyDoClose(const char* owner);
+
   void setCheckingValidity( bool val ) { mCheckingValidity = val; }
 
   /** Return the trash folder. */
@@ -318,6 +318,9 @@
   /** Initialize this storage from another one. Used when creating a child folder */
   void initializeFrom( KMFolderImap* parent, QString path, QString mimeType );
 
+  /** Returns the IMAP flags that can be stored on the server. */
+  int permanentFlags() const { return mPermanentFlags; }
+
 signals:
   void folderComplete(KMFolderImap *folder, bool success);
 
@@ -370,7 +373,7 @@
    * Convert IMAP flags to a message status
    * @param newMsg specifies whether unseen messages are new or unread
    */
-  static void flagsToStatus(KMMsgBase *msg, int flags, bool newMsg = TRUE);
+  static void flagsToStatus(KMMsgBase *msg, int flags, bool newMsg = TRUE, int supportedFalgs = 31 );
 
   /**
    * Convert IMAP seen flag to a message status.
@@ -536,6 +539,10 @@
   // this is needed for migrating local flags from the time where we didn't
   // have the ability to store them on the server
   bool mUploadAllFlags;
+
+  // PERMANENTFLAGS part of SELECT response, needed to determine if custom flags can be
+  // stored on the server
+  int mPermanentFlags;
 };
 
 #endif // kmfolderimap_h
Index: kmail/util.h
===================================================================
--- kmail/util.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/util.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,9 +39,17 @@
 #define KMAILUTIL_H
 
 #include <stdlib.h>
+
 #include <qobject.h>
 #include <qcstring.h>
+
+#include <kio/netaccess.h>
+#include <kmessagebox.h>
+#include <klocale.h>
+
 class DwString;
+class KURL;
+class QWidget;
 
 namespace KMail
 {
@@ -60,7 +68,7 @@
      */
     size_t crlf2lf( char* str, const size_t strLen );
 
-    
+
     /**
      * Convert "\n" line endings to "\r\n".
      * @param src The source string to convert.
@@ -161,11 +169,11 @@
 
     void insert( QByteArray& that, uint index, const char* s );
 
-    /**
+   /**
      * A LaterDeleter is intended to be used with the RAII ( Resource
      * Acquisition is Initialization ) paradigm. When an instance of it
-     * goes out of scope it deletes the associated object  It can be 
-     * disabled, in case the deletion needs to be avoided for some 
+     * goes out of scope it deletes the associated object  It can be
+     * disabled, in case the deletion needs to be avoided for some
      * reason, since going out-of-scope cannot be avoided.
      */
     class LaterDeleter
@@ -189,6 +197,25 @@
       QObject *m_object;
       bool m_disabled;
     };
+
+    // return true if we should proceed, false if we should abort
+    inline bool checkOverwrite( const KURL& url, QWidget* w )
+    {
+        if ( KIO::NetAccess::exists( url, false /*dest*/, w ) ) {
+            if ( KMessageBox::Cancel ==
+                    KMessageBox::warningContinueCancel(
+                        w,
+                        i18n( "A file named \"%1\" already exists. "
+                            "Are you sure you want to overwrite it?" ).arg( url.prettyURL() ),
+                        i18n( "Overwrite File?" ),
+                        i18n( "&Overwrite" ) ) )
+                return false;
+        }
+        return true;
+    }
+
+
+
 }
 }
 
Index: kmail/kmmimeparttree.cpp
===================================================================
--- kmail/kmmimeparttree.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmimeparttree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,10 +46,14 @@
 #include <kmessagebox.h>
 #include <kiconloader.h>
 
+#include <qclipboard.h>
 #include <qheader.h>
 #include <qpopupmenu.h>
 #include <qstyle.h>
+#include <kurldrag.h>
+#include <kurl.h>
 
+
 KMMimePartTree::KMMimePartTree( KMReaderWin* readerWin,
                                 QWidget* parent,
                                 const char* name )
@@ -74,6 +78,7 @@
     setAllColumnsShowFocus( true );
     setShowToolTips( true );
     setSorting(-1);
+    setDragEnabled( true );
 }
 
 
@@ -127,11 +132,33 @@
         kdDebug(5006) << "\n**\n** KMMimePartTree::itemRightClicked() **\n**" << endl;
 
         QPopupMenu* popup = new QPopupMenu;
+        if ( mCurrentContextMenuItem->node()->nodeId() > 2 &&
+             mCurrentContextMenuItem->node()->typeString() != "Multipart" ) {
+          popup->insertItem( SmallIcon("fileopen"), i18n("to open", "Open"), this, SLOT(slotOpen()) );
+          popup->insertItem( i18n("Open With..."), this, SLOT(slotOpenWith()) );
+          popup->insertItem( i18n("to view something", "View"), this, SLOT(slotView()) );
+        }
         popup->insertItem( SmallIcon("filesaveas"),i18n( "Save &As..." ), this, SLOT( slotSaveAs() ) );
+        /*
+         * FIXME mkae optional?
         popup->insertItem( i18n( "Save as &Encoded..." ), this,
                            SLOT( slotSaveAsEncoded() ) );
+        */
         popup->insertItem( i18n( "Save All Attachments..." ), this,
                            SLOT( slotSaveAll() ) );
+        // edit + delete only for attachments
+        if ( mCurrentContextMenuItem->node()->nodeId() > 2 &&
+             mCurrentContextMenuItem->node()->typeString() != "Multipart" ) {
+          popup->insertItem( SmallIcon("editcopy"), i18n("Copy"), this, SLOT(slotCopy()) );
+          if ( GlobalSettings::self()->allowAttachmentDeletion() )
+            popup->insertItem( SmallIcon("editdelete"), i18n( "Delete Attachment" ),
+                               this, SLOT( slotDelete() ) );
+          if ( GlobalSettings::self()->allowAttachmentEditing() )
+            popup->insertItem( SmallIcon( "edit" ), i18n( "Edit Attachment" ),
+                               this, SLOT( slotEdit() ) );
+        }
+        if ( mCurrentContextMenuItem->node()->nodeId() > 0 )
+          popup->insertItem( i18n("Properties"), this, SLOT(slotProperties()) );
         popup->exec( point );
         delete popup;
         mCurrentContextMenuItem = 0;
@@ -224,6 +251,69 @@
     correctSize( item->parent() );
 }
 
+void KMMimePartTree::slotDelete()
+{
+  QPtrList<QListViewItem> selected = selectedItems();
+  if ( selected.count() != 1 )
+    return;
+  mReaderWin->slotDeleteAttachment( static_cast<KMMimePartTreeItem*>( selected.first() )->node() );
+}
+
+void KMMimePartTree::slotEdit()
+{
+  QPtrList<QListViewItem> selected = selectedItems();
+  if ( selected.count() != 1 )
+    return;
+  mReaderWin->slotEditAttachment( static_cast<KMMimePartTreeItem*>( selected.first() )->node() );
+}
+
+void KMMimePartTree::slotOpen()
+{
+  startHandleAttachmentCommand( KMHandleAttachmentCommand::Open );
+}
+
+void KMMimePartTree::slotOpenWith()
+{
+  startHandleAttachmentCommand( KMHandleAttachmentCommand::OpenWith );
+}
+
+void KMMimePartTree::slotView()
+{
+  startHandleAttachmentCommand( KMHandleAttachmentCommand::View );
+}
+
+void KMMimePartTree::slotProperties()
+{
+  startHandleAttachmentCommand( KMHandleAttachmentCommand::Properties );
+}
+
+void KMMimePartTree::startHandleAttachmentCommand(int type)
+{
+  QPtrList<QListViewItem> selected = selectedItems();
+  if ( selected.count() != 1 )
+    return;
+  partNode* node = static_cast<KMMimePartTreeItem*>( selected.first() )->node();
+  QString name = mReaderWin->tempFileUrlFromPartNode( node ).path();
+  KMHandleAttachmentCommand* command = new KMHandleAttachmentCommand(
+      node, mReaderWin->message(), node->nodeId(), name,
+      KMHandleAttachmentCommand::AttachmentAction( type ), 0, this );
+  connect( command, SIGNAL( showAttachment( int, const QString& ) ),
+           mReaderWin, SLOT( slotAtmView( int, const QString& ) ) );
+  command->start();
+}
+
+void KMMimePartTree::slotCopy()
+{
+  KURL::List urls;
+  KMMimePartTreeItem *item = static_cast<KMMimePartTreeItem*>( currentItem() );
+  if ( !item ) return;
+  KURL url = mReaderWin->tempFileUrlFromPartNode( item->node() );
+  if ( !url.isValid() ) return;
+  urls.append( url );
+  KURLDrag* drag = new KURLDrag( urls, this );
+  QApplication::clipboard()->setData( drag, QClipboard::Clipboard );
+}
+
 //=============================================================================
 KMMimePartTreeItem::KMMimePartTreeItem( KMMimePartTree * parent,
                                         partNode* node,
@@ -287,4 +377,19 @@
 }
 
 
+void KMMimePartTree::startDrag()
+{
+    KURL::List urls;
+    KMMimePartTreeItem *item = static_cast<KMMimePartTreeItem*>( currentItem() );
+    if ( !item ) return;
+    partNode *node = item->node();
+    if ( !node ) return;
+    KURL url = mReaderWin->tempFileUrlFromPartNode( node );
+    if (!url.isValid() ) return;
+    urls.append( url );
+    KURLDrag* drag = new KURLDrag( urls, this );
+    drag->drag();
+}
+
 #include "kmmimeparttree.moc"
+
Index: kmail/compactionjob.cpp
===================================================================
--- kmail/compactionjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/compactionjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -65,7 +65,7 @@
   Q_ASSERT( mCancellable );
   // We must close the folder if we opened it and got interrupted
   if ( mFolderOpen && mSrcFolder && mSrcFolder->storage() )
-    mSrcFolder->storage()->close("mboxcompactjob");
+    mSrcFolder->storage()->close("mboxcompact");
 
   if ( mTmpFile )
     fclose( mTmpFile );
@@ -124,7 +124,7 @@
     return errno;
   }
   mOpeningFolder = true; // Ignore open-notifications while opening the folder
-  storage->open("mboxcompactjob");
+  storage->open("mboxcompact");
   mOpeningFolder = false;
   mFolderOpen = true;
   mOffset = 0;
Index: kmail/Mainpage.dox
===================================================================
--- kmail/Mainpage.dox	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/Mainpage.dox	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -215,11 +215,11 @@
 
 \section folders Folders
 
-Files: kmfolder*.{h,cpp} and *job.{h,cpp}
+Files: kmfolder*.{h,cpp}, folderstorage.{h,cpp} and *job.{h,cpp}
 
 Contact Zack Rusin <zack@kde.org> with questions...
 
-The inheritance hierarchy among KMail folder structure looks
+The collaboration among KMail folder classes looks
 as follows :
                
                      KMFolderNode
@@ -227,38 +227,39 @@
                     /            \
                KMFolderDir        \
                                   KMFolder
+                                    .
+                                    .
+                                    v
+                               FolderStorage
                                     |
-                                KMFolderIndex
                                     |
+                               KMFolderIndex
                                     |
+                                    |
         ---< actual folder types: KMFolderImap, KMFolderMbox... >--
 
-Besides the above mentioned classes one more relevant to our
-discussion is KMFolderMgr which as the name suggest serves as the
-folder manager.
-
 At the base KMail's folder design starts with KMFolderNode which
-inherits QObject. KMFolderNode is the base class encapsulating such
-common folder properties as the name, boolean saying whether the
-given folder is a directory storing the folders with mail or whether
-the folder is a folder holding mail directly and finally a
-KMFolderDir.
+inherits QObject. KMFolderNode is the base class encapsulating
+common folder properties such as the name and a boolean signifying whether
+the folder is a folder holding mail directly or a KMFolderDir.
+KMFolderNode's often do not have an on-disk representation, they are
+entities existing only within KMail's design. 
 
-KMFolderDir is, as one might say, a directory abstration which manages
-purely abstract KMFolder's. KMFolder's often don't have a disk based
-image, they are entities existing only within KMail's design. To
-manage the contents of one directory that may contain folders and/or
-other directories KMFolderDir was created.
-It inherits KMFolderNode and KMFolderNodeList. Yes, the inheritance is rather
-bogus and has to be fixed especially if you'll notice that
-KMFolderNode holds a pointer to the derived from it KMFolderDir. 
-KMFolderDir also inherits KMFolderNodeList which is a
-QPtrList<KMFolderNode>.  A special case of a KMFolderDir is known as
-KMFolderRootDir and is supposed to represent the toplevel KMFolderDir
-in the KMail's folder hierarchy. 
+KMFolder acts as the runtime representation of a folder with the physical
+storage part being represented by a member of type FolderStorage.
+KMFolder and FolderStorage have many functions with the same names and
+signatures, but there is no inheritance.
+KMFolderIndex contains some common indexing functionality for physical folders.
+Subclasses of KMFolderIndex finally interact directly with physical storage
+or with storage providers over the network.
 
-KMFolderDir's serve as folder holders which are managed by
-KMFolderMgr's. KMail contains three main KMFolderMgr's. They can be
+KMFolderDir is a directory abstraction which holds KMFolderNode's.
+It inherits KMFolderNode and KMFolderNodeList which is a QPtrList<KMFolderNode>.
+A special case of a KMFolderDir is KMFolderRootDir; it represents
+the toplevel KMFolderDir in KMail's folder hierarchy. 
+
+KMFolderDir's contents are managed by KMFolderMgr's.
+KMail contains three main KMFolderMgr's. They can be
 accessed via KMKernel ( the "kmkernel" construct ). Those methods are :
 1) KMFolderMgr *folderMgr() - which returns the folder manager for
    the folders stored locally.
@@ -268,17 +269,17 @@
    main contents of all messages is kept on the server.
 3) KMFolderMgr *dimapFolderMgr() - which returns disconnected IMAP (dimap) 
    folder manager. In dimap, both the headers and a copy of the full message
-   is cached locally.
+   are cached locally.
 4) KMFolderMgr *searchFolderMgr() - which returns the folder manager
-   for the search folders (the folders created by using the "find
-   messages" tool. Other email clients call that type of folders
+   for search folders (folders created by using the "find
+   messages" tool). Other email clients call this type of folder
    "virtual folders".
 
-Finally one has to remember FolderJob classes. These classes allow
-one to have asynchronous operations on KMFolder's. You simply create
-a Job on a heap, connect to one of its signals and wait till the job
-finishes. Folders serve as FolderJob's factories. For example to
-retrieve the full message from a folder you'd have to do something like :
+FolderJob classes - These classes allow asynchronous operations on
+KMFolder's. You create a Job on the heap, connect to one of its 
+signals and wait for the job to finish. Folders serve as FolderJob
+factories. For example, to retrieve the full message from a folder
+you do :
 
 FolderJob *job = folderParent->createJob( aMsg, tGetMessage );
 connect( job, SIGNAL(messageRetrieved(KMMessage*)),
Index: kmail/kmfoldersearch.cpp
===================================================================
--- kmail/kmfoldersearch.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldersearch.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -148,11 +148,12 @@
 {
     //close all referenced folders
     QValueListIterator<QGuardedPtr<KMFolder> > fit;
-    for (fit = mFolders.begin(); fit != mFolders.end(); ++fit) {
+    for (fit = mOpenedFolders.begin(); fit != mOpenedFolders.end(); ++fit) {
         if (!(*fit))
             continue;
-        (*fit)->close("kmsearch");
+        (*fit)->close( "kmsearch" );
     }
+    mOpenedFolders.clear();
     mFolders.clear();
 
     if ( running() )
@@ -219,7 +220,8 @@
         QValueListConstIterator<QGuardedPtr<KMFolder> > jt;
         for ( jt = mOpenedFolders.begin(); jt != mOpenedFolders.end(); ++jt ) {
             KMFolder *folder = *jt;
-            if ( !folder ) continue;
+            if ( !folder )
+                continue;
             // explicitely stop jobs for this folder as it will not be closed below
             // when the folder is currently selected
             if ( folder->folderType() == KMFolderTypeImap ) {
@@ -241,8 +243,8 @@
 }
 
 void KMSearch::indexFinished() {
-	mRunning = false;
-	mRunByIndex = false;
+    mRunning = false;
+    mRunByIndex = false;
 }
 
 void KMSearch::slotProcessNextBatch()
@@ -265,7 +267,7 @@
                 SLOT( slotSearchFolderResult( KMFolder*, QValueList<Q_UINT32>, const KMSearchPattern*, bool ) ) );
             folder->storage()->search( mSearchPattern );
         } else
-          --mRemainingFolders;
+            --mRemainingFolders;
         mProcessNextBatchTimer->start( 0, true );
         return;
     }
@@ -276,7 +278,8 @@
                                        const KMSearchPattern* pattern,
                                        bool complete )
 {
-    if ( pattern != mSearchPattern ) return;
+    if ( pattern != mSearchPattern )
+      return;
     kdDebug(5006) << k_funcinfo << folder->label() << " found " << serNums.count() << endl;
     mLastFolder = folder->label();
     QValueListIterator<Q_UINT32> it;
@@ -442,12 +445,15 @@
     int idx = -1;
     KMFolder *aFolder = 0;
     KMMsgDict::instance()->getLocation(serNum, &aFolder, &idx);
-    assert(aFolder && (idx != -1));
+    // warn instead of assert() because of
+    // https://intevation.de/roundup/kolab/issue2216
+    if (!aFolder || (idx == -1)) {
+        kdDebug(5006) << "Not adding message with serNum " << serNum
+                      << ": folder is " << aFolder << ", index is " << idx << endl;
+        return;
+    }
     if(mFolders.findIndex(aFolder) == -1) {
         aFolder->open("foldersearch");
-        // Exceptional case, for when folder has invalid ids
-        if (mInvalid)
-            return;
         mFolders.append(aFolder);
     }
     setDirty( true ); //TODO append a single entry to .ids file and sync.
@@ -539,7 +545,7 @@
     }
 }
 
-void KMFolderSearch::reallyDoClose(const char *)
+void KMFolderSearch::reallyDoClose(const char* owner)
 {
     if (mAutoCreateIndex) {
         if (mSearch)
@@ -850,9 +856,9 @@
         }
         mSerNums.push_back(serNum);
         if(mFolders.findIndex(folder) == -1) {
-            folder->open("foldersearch");
             if (mInvalid) //exceptional case for when folder has invalid ids
                 return false;
+            folder->open("foldersearch");
             mFolders.append(folder);
         }
         KMMsgBase *mb = folder->getMsgBase(folderIdx);
@@ -932,7 +938,7 @@
     if (!search()->inScope(aFolder))
         return;
     if (!mTempOpened) {
-        open( "foldersearch" );
+        open("foldersearch");
         mTempOpened = true;
     }
 
@@ -944,7 +950,7 @@
     KMMsgDict::instance()->getLocation(serNum, &folder, &idx);
     assert(folder && (idx != -1));
     assert(folder == aFolder);
-    folder->open("examineAddedMessage");
+    KMFolderOpener openFolder(folder, "foldersearch");
 
     // if we are already checking this folder, refcount
     if ( mFoldersCurrentlyBeingSearched.contains( folder ) ) {
@@ -959,7 +965,6 @@
       mFoldersCurrentlyBeingSearched.insert( folder, 1 );
     }
     folder->storage()->search( search()->searchPattern(), serNum );
-    folder->close("examineAddedMessage");
 }
 
 void KMFolderSearch::slotSearchExamineMsgDone( KMFolder* folder,
@@ -970,25 +975,22 @@
     if ( search()->searchPattern() != pattern ) return;
     kdDebug(5006) << folder->label() << ": serNum " << serNum
      << " matches?" << matches << endl;
-    folder->open("SearchExamineMsgDone");
+    KMFolderOpener openFolder(folder, "foldersearch");
 
-    if ( mFoldersCurrentlyBeingSearched.contains( folder ) ) {
-      unsigned int count = mFoldersCurrentlyBeingSearched[folder];
-      if ( count == 1 ) {
-        disconnect( folder->storage(),
-                    SIGNAL( searchDone( KMFolder*, Q_UINT32,
-                                        const KMSearchPattern*, bool ) ),
-                    this,
-                    SLOT( slotSearchExamineMsgDone( KMFolder*, Q_UINT32,
-                                                    const KMSearchPattern*, bool ) ) );
-        mFoldersCurrentlyBeingSearched.remove( folder );
-      } else {
-        mFoldersCurrentlyBeingSearched.replace( folder, count-1 );
-      }
+    Q_ASSERT( mFoldersCurrentlyBeingSearched.contains( folder ) );
+
+    unsigned int count = mFoldersCurrentlyBeingSearched[folder];
+    if ( count == 1 ) {
+      disconnect( folder->storage(),
+                  SIGNAL( searchDone( KMFolder*, Q_UINT32,
+                                      const KMSearchPattern*, bool ) ),
+                  this,
+                  SLOT( slotSearchExamineMsgDone( KMFolder*, Q_UINT32,
+                                                  const KMSearchPattern*, bool ) ) );
+      mFoldersCurrentlyBeingSearched.remove( folder );
     } else {
-      Q_ASSERT( 0 ); // Can't happen (TM)
+      mFoldersCurrentlyBeingSearched.replace( folder, count-1 );
     }
-    folder->close("SearchExamineMsgDone");
 
     if ( !matches ) {
         QValueVector<Q_UINT32>::const_iterator it;
@@ -1109,7 +1111,7 @@
         ++pos;
     }
     // let's try if the message matches our search
-    aFolder->open("foldersearch");
+    KMFolderOpener openAFolder(aFolder, "foldersearch");
 
     // if we are already checking this folder, refcount
     if ( mFoldersCurrentlyBeingSearched.contains( aFolder ) ) {
Index: kmail/kmailIface.h
===================================================================
--- kmail/kmailIface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmailIface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -211,6 +211,9 @@
   /** Clears the list of added message ids which is used to filter out
       duplicates. */
   virtual void dcopResetAddMessage() = 0;
+  
+  virtual void loadProfile( const QString& path ) = 0;
+  virtual void saveToProfile( const QString& path ) const = 0;
 };
 
 #endif
Index: kmail/snippetsettings.cpp
===================================================================
--- kmail/snippetsettings.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetsettings.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,48 @@
+/*
+ *  File : snippetsettings.cpp
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#include <qstring.h>
+#include <klineedit.h>
+#include <qcheckbox.h>
+#include <qbuttongroup.h>
+
+#include "snippetsettings.h"
+#include "snippet_widget.h"
+
+
+SnippetSettings::SnippetSettings(QWidget *parent, const char *name)
+ : SnippetSettingsBase(parent, name)
+{
+  _widget = NULL;
+}
+
+SnippetSettings::SnippetSettings(SnippetWidget * w, QWidget *parent, const char *name)
+ : SnippetSettingsBase(parent, name)
+{
+  _cfg = w->getSnippetConfig();
+  _widget = w;
+}
+
+
+SnippetSettings::~SnippetSettings()
+{
+}
+
+
+/*!
+    \fn SnippetSettings::slotOKClicked()
+ */
+void SnippetSettings::slotOKClicked()
+{
+    _cfg->setToolTips(cbToolTip->isChecked());
+    _cfg->setDelimiter(leDelimiter->text());
+    _cfg->setInputMethod(btnGroup->selectedId());
+}
+
+
+#include "snippetsettings.moc"
Index: kmail/kmfilterdlg.h
===================================================================
--- kmail/kmfilterdlg.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfilterdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -80,6 +80,15 @@
 
   /** Returns wheather the global option 'Show Later Msgs' is set or not */
   bool showLaterMsgs();
+  
+  void insertFilter( KMFilter* aFilter );
+  
+  void appendFilter( KMFilter* aFilter );
+  
+  /** Returns a list of _copies_ of the current list of filters.
+   * The list owns the contents and thus the caller needs to clean them
+   * up. */
+  QValueList<KMFilter*> filtersForSaving() const;
 
 signals:
   /** Emitted when a new filter has been selected by the user or if
@@ -153,7 +162,7 @@
   bool mShowLater;
 private:
   void enableControls();
-  void insertFilter( KMFilter* aFilter );
+ 
   void swapFilters( int from, int to );
   void swapNeighbouringFilters( int untouchedOne, int movedOne );
   bool bPopFilter;
@@ -362,6 +371,17 @@
   void slotFinished();
   // update the list of accounts shown in the advanced tab
   void slotUpdateAccountList();
+  
+  
+  /** Called when a user clicks the import filters button. Pops up
+   * a dialog asking the user which file to import from and which
+   * of the filters in that file to import. */
+  void slotImportFilters();
+  
+  /** Called when a user clicks the export filters button. Pops up
+   * a dialog asking the user which filters to export and which 
+   * file to export to. */
+  void slotExportFilters();
 
 protected:
   /** The widget that contains the ListBox showing the filters, and
Index: kmail/kmacctimap.cpp
===================================================================
--- kmail/kmacctimap.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmacctimap.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -275,10 +275,9 @@
   if (!mFolder || !mFolder->folder() || !mFolder->folder()->child() ||
       makeConnection() == ImapAccountBase::Error)
   {
-    // checks for mCountRemainChecks
-    checkDone( false, CheckError );
     mCountRemainChecks = 0;
     mCheckingSingleFolder = false;
+    checkDone( false, CheckError );
     return;
   }
   // if necessary then initialize the list of folders which should be checked
@@ -353,7 +352,7 @@
         else {
           connect(imapFolder, SIGNAL(numUnreadMsgsChanged(KMFolder*)),
               this, SLOT(postProcessNewMail(KMFolder*)));
-          bool ok = imapFolder->processNewMail(interactive); // this removes the local kmfolderimap if its imapPath is somehow empty, and removing it calls createFolderList, invalidating mMailCheckFolders, and causing a crash
+          bool ok = imapFolder->processNewMail(interactive);
           if (!ok)
           {
             // there was an error so cancel
@@ -363,8 +362,6 @@
               mMailCheckProgressItem->incCompletedItems();
               mMailCheckProgressItem->updateProgress();
             }
-            // since the list of folders might have been updated at this point, mMailCheckFolders may be invalid, so break
-            break;
           }
         }
       }
Index: kmail/kmmsgpart.h
===================================================================
--- kmail/kmmsgpart.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmsgpart.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -20,6 +20,8 @@
 #ifndef kmmsgpart_h
 #define kmmsgpart_h
 
+#include <kiconloader.h>
+
 #include <qstring.h>
 #include <qcstring.h>
 #include <qdict.h>
@@ -157,7 +159,7 @@
   /** Tries to find a good icon for the 'Content-Type' by scanning
     the installed mimelnk files. Returns the found icon. If no matching
     icon is found, the one for application/octet-stream is returned. */
-  QString iconName() const;
+  QString iconName( int size = KIcon::Desktop ) const;
 
   /** Get or set the 'Content-Transfer-Encoding' header field
     The member functions that involve enumerated types (ints)
Index: kmail/snippetconfig.h
===================================================================
--- kmail/snippetconfig.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetconfig.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,56 @@
+/*
+ *  File : snippetconfig.h
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+
+#ifndef SNIPPETCONFIG_H
+#define SNIPPETCONFIG_H
+
+#include <qstring.h>
+#include <qrect.h>
+
+
+/**
+This class stores the values that can be configured via the
+KDevelop settings dialog
+@author Robert Gruber
+*/
+class SnippetConfig{
+public:
+    SnippetConfig();
+
+    ~SnippetConfig();
+
+  bool useToolTips() { return (bToolTip); };
+  int getInputMethod() { return (iInputMethod); };
+  QString getDelimiter() { return (strDelimiter); };
+  QRect getSingleRect() { return (rSingle); };
+  QRect getMultiRect() { return (rMulti); };
+  int getAutoOpenGroups() { return iAutoOpenGroups; }
+  
+  void setToolTips(bool b) { bToolTip=b; };
+  void setInputMethod(int i) { iInputMethod=i; };
+  void setDelimiter(QString s) { strDelimiter=s; };
+  void setSingleRect(QRect r) {
+    rSingle = (r.isValid())?r:QRect();
+  }
+  void setMultiRect(QRect r) {
+    rMulti = (r.isValid())?r:QRect();
+  }
+  void setAutoOpenGroups(int autoopen) { iAutoOpenGroups = autoopen; }
+
+protected:
+    bool bToolTip;
+    int iInputMethod;
+    QString strDelimiter;
+    QRect rSingle;
+    QRect rMulti;
+    int iMultiBasicHeight;
+    int iMultiCount;
+    int iAutoOpenGroups;
+};
+
+#endif
Index: kmail/dcopmail.desktop
===================================================================
--- kmail/dcopmail.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/dcopmail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Comment[da]=E-mail-program med en DCOP-gr√¶nseflade
 Comment[de]=Mail-Programm mit DCOP-Schnittstelle
 Comment[el]=Œ†œÅœåŒ≥œÅŒ±ŒºŒºŒ± mail ŒºŒµ Œ≠ŒΩŒ± œÄŒµœÅŒπŒ≤Œ¨ŒªŒªŒøŒΩ œáœÅŒÆœÉŒ∑œÇ DCOP
+Comment[eo]=Retposhtprogramo kun DCOP-interfaco
 Comment[es]=Programa de correo con un interfaz DCOP
 Comment[et]=E-posti rakendus DCOP-liidesega
 Comment[eu]=DCOP interfazedun posta programa
Index: kmail/accountdialog.h
===================================================================
--- kmail/accountdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/accountdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -43,6 +43,10 @@
 class KMServerTest;
 class QButtonGroup;
 
+namespace KPIM {
+class IdentityCombo;
+}
+
 namespace KMail {
 
 class SieveConfigEditor;
@@ -79,7 +83,9 @@
       QLabel       *intervalLabel;
       KIntNumInput *intervalSpin;
       QComboBox    *folderCombo;
-      QComboBox    *identityCombo;
+      //QComboBox    *identityCombo;
+      KPIM::IdentityCombo    *identityCombo;
+      QLabel       *identityLabel;
     };
 
     struct MaildirWidgets
@@ -98,7 +104,9 @@
       QLabel       *intervalLabel;
       KIntNumInput *intervalSpin;
       QComboBox    *folderCombo;
-      QComboBox    *identityCombo;
+      //QComboBox    *identityCombo;
+      KPIM::IdentityCombo    *identityCombo;
+      QLabel       *identityLabel;
     };
 
     struct PopWidgets
@@ -146,7 +154,9 @@
       KIntNumInput *intervalSpin;
       KIntNumInput *filterOnServerSizeSpin;
       QComboBox    *folderCombo;
-      QComboBox    *identityCombo;
+      //QComboBox    *identityCombo;
+      KPIM::IdentityCombo    *identityCombo;
+      QLabel       *identityLabel;
     };
 
     struct ImapWidgets
@@ -196,6 +206,8 @@
       QToolButton  *editONS;
       QToolButton  *editSNS;
       ImapAccountBase::nsDelimMap nsMap;
+      KPIM::IdentityCombo    *identityCombo;
+      QLabel       *identityLabel;
     };
 
   private slots:
Index: kmail/kmedit.h
===================================================================
--- kmail/kmedit.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -9,6 +9,7 @@
 #include <keditcl.h>
 #include <qmap.h>
 #include <qstringlist.h>
+#include <qclipboard.h>
 
 class KMComposeWin;
 class KSpellConfig;
@@ -79,6 +80,7 @@
   void pasteImage();
   void focusUp();
   void focusChanged( bool );
+  void insertSnippet();
 public slots:
   void initializeAutoSpellChecking();
   void slotSpellcheck2(KSpell*);
@@ -98,6 +100,8 @@
    */
   bool eventFilter(QObject*, QEvent*);
   void keyPressEvent( QKeyEvent* );
+  
+  void contentsMouseReleaseEvent( QMouseEvent * e );
 
 private slots:
   void slotExternalEditorTempFileChanged( const QString & fileName );
@@ -120,6 +124,7 @@
   bool      mWasModifiedBeforeSpellCheck;
   KDictSpellingHighlighter *mSpellChecker;
   bool mSpellLineEdit;
+  QClipboard::Mode mPasteMode;
 };
 
 #endif // __KMAIL_KMEDIT_H__
Index: kmail/vacationdialog.cpp
===================================================================
--- kmail/vacationdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/vacationdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -35,6 +35,7 @@
 #include <qcheckbox.h>
 #include <qlineedit.h>
 #include <qtextedit.h>
+#include <qvalidator.h>
 
 namespace KMail {
 
@@ -44,7 +45,7 @@
   {
     KWin::setIcons( winId(), kapp->icon(), kapp->miniIcon() );
 
-    static const int rows = 4;
+    static const int rows = 7;
     int row = -1;
 
     QGridLayout * glay = new QGridLayout( plainPage(), rows, 2, 0, spacingHint() );
@@ -81,7 +82,24 @@
     glay->addWidget( new QLabel( mMailAliasesEdit, i18n("&Send responses for these addresses:"), plainPage() ), row, 0 );
     glay->addWidget( mMailAliasesEdit, row, 1 );
 
-    // row 5 is for stretch.
+    // "Send responses also to SPAM mail" checkbox:
+    ++row;
+    mSpamCheck = new QCheckBox( i18n("Do not send vacation replies to spam messages"), plainPage(), "mSpamCheck" );
+    mSpamCheck->setChecked( true );
+    glay->addMultiCellWidget( mSpamCheck, row, row, 0, 1 );
+
+    //  domain checkbox and linedit:
+    ++row;
+    mDomainCheck = new QCheckBox( i18n("Only react to mail coming from domain"), plainPage(), "mDomainCheck" );
+    mDomainCheck->setChecked( false );
+    mDomainEdit = new QLineEdit( plainPage(), "mDomainEdit" );
+    mDomainEdit->setEnabled( false );
+    mDomainEdit->setValidator( new QRegExpValidator( QRegExp( "[a-zA-Z0-9+-]+(?:\\.[a-zA-Z0-9+-]+)*" ), mDomainEdit ) );
+    glay->addWidget( mDomainCheck, row, 0 );
+    glay->addWidget( mDomainEdit, row, 1 );
+    connect( mDomainCheck, SIGNAL(toggled(bool)),
+             mDomainEdit, SLOT(setEnabled(bool)) );
+
     Q_ASSERT( row == rows - 1 );
   }
 
@@ -103,6 +121,8 @@
 
   void VacationDialog::setMessageText( const QString & text ) {
     mTextEdit->setText( text );
+    const int height = ( mTextEdit->fontMetrics().lineSpacing() + 1 ) * 11;
+    mTextEdit->setMinimumHeight( height );
   }
 
   int VacationDialog::notificationInterval() const {
@@ -143,6 +163,33 @@
     mIntervalSpin->setSuffix( i18n(" day", " days", value) );
   }
 
+  QString VacationDialog::domainName() const {
+    return mDomainCheck->isChecked() ? mDomainEdit->text() : QString::null ;
+  }
+
+  void VacationDialog::setDomainName( const QString & domain ) {
+    mDomainEdit->setText( domain );
+    if ( !domain.isEmpty() )
+      mDomainCheck->setChecked( true );
+  }
+
+  bool VacationDialog::sendForSpam() const {
+    return !mSpamCheck->isChecked();
+  }
+
+  void VacationDialog::setSendForSpam( bool enable ) {
+    mSpamCheck->setChecked( !enable );
+  }
+
+
+  /* virtual*/
+  void KMail::VacationDialog::enableDomainAndSendForSpam( bool enable ) {
+      mDomainCheck->setEnabled( enable );
+      mDomainEdit->setEnabled( enable );
+      mSpamCheck->setEnabled( enable );
+  }
+
+
 } // namespace KMail
 
 #include "vacationdialog.moc"
Index: kmail/kmmainwidget.h
===================================================================
--- kmail/kmmainwidget.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmmainwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -30,6 +30,7 @@
 
 #include "kmreaderwin.h" //for inline actions
 #include "kmkernel.h" // for access to config
+#include "messageactions.h"
 #include <kaction.h>
 
 class QVBoxLayout;
@@ -42,6 +43,7 @@
 class KRadioAction;
 class KToggleAction;
 class KMenuBar;
+class KStatusBarLabel;
 
 class KMFolder;
 class KMFolderDir;
@@ -71,6 +73,7 @@
   class HeaderListQuickSearch;
   class SearchWindow;
   class ImapAccountBase;
+  class FavoriteFolderView;
 }
 
 typedef QMap<int,KMFolder*> KMMenuToFolder;
@@ -106,24 +109,19 @@
   /** Easy access to main components of the window. */
   KMReaderWin* messageView(void) const { return mMsgView; }
   KMFolderTree* folderTree(void) const  { return mFolderTree; }
+  KMail::FavoriteFolderView *favoriteFolderView() const { return mFavoriteFolderView; }
 
   static void cleanup();
 
   KAction *action( const char *name ) { return mActionCollection->action( name ); }
-  KAction *replyAction() const { return mReplyAction; }
-  KAction *replyAuthorAction() const { return mReplyAuthorAction; }
-  KAction *replyAllAction() const { return mReplyAllAction; }
-  KAction *replyListAction() const { return mReplyListAction; }
   KActionMenu *customReplyAction() const { return mCustomReplyActionMenu; }
   KActionMenu *customReplyAllAction() const { return mCustomReplyAllActionMenu; }
-  KActionMenu * replyMenu() const { return mReplyActionMenu; }
   KActionMenu *forwardMenu() const { return mForwardActionMenu; }
   KAction *forwardInlineAction() const { return mForwardInlineAction; }
   KAction *forwardAttachedAction() const { return mForwardAttachedAction; }
   KAction *forwardDigestAction() const { return mForwardDigestAction; }
   KAction *redirectAction() const { return mRedirectAction; }
   KActionMenu *customForwardAction() const { return mCustomForwardActionMenu; }
-  KAction *noQuoteReplyAction() const { return mNoQuoteReplyAction; }
   KActionMenu *filterMenu() const { return mFilterMenu; }
   KAction *printAction() const { return mPrintAction; }
   KAction *trashAction() const { return mTrashAction; }
@@ -131,16 +129,17 @@
   KAction *trashThreadAction() const { return mTrashThreadAction; }
   KAction *deleteThreadAction() const { return mDeleteThreadAction; }
   KAction *saveAsAction() const { return mSaveAsAction; }
-  KAction *editAction() const { return mEditAction; }
+  KAction *editAction() const { return mMsgActions->editAction(); }
   KAction *useAction() const { return mUseAction; }
   KAction *sendAgainAction() const { return mSendAgainAction; }
   KAction *applyAllFiltersAction() const { return mApplyAllFiltersAction; }
   KAction *findInMessageAction() const { return mFindInMessageAction; }
   KAction *saveAttachmentsAction() const { return mSaveAttachmentsAction; }
   KAction *openAction() const { return mOpenAction; }
-  KAction *viewSourceAction() { return mViewSourceAction; }
+  KAction *viewSourceAction() const { return mViewSourceAction; }
+  KMail::MessageActions *messageActions() const { return mMsgActions; }
 
-  KActionMenu *statusMenu()  const{ return mStatusMenu; }
+  KActionMenu *statusMenu()  const{ return mMsgActions->messageStatusMenu(); }
   KActionMenu *threadStatusMenu() const { return mThreadStatusMenu; }
   KActionMenu *moveActionMenu() const{ return mMoveActionMenu; }
   KActionMenu *mopyActionMenu() const { return mCopyActionMenu; }
@@ -173,6 +172,14 @@
    */
   void setAccelsEnabled( bool enabled = true );
 
+  /**
+   * Sets up action list for forward menu.
+  */
+  void setupForwardingActionsList();
+
+  KStatusBarLabel* vacationScriptIndicator() const { return mVacationScriptIndicator; }
+  void updateVactionScriptStatus() { updateVactionScriptStatus( mVacationIndicatorActive ); }
+
 public slots:
   void slotMoveMsgToFolder( KMFolder *dest);
   void slotTrashMsg();   // move to trash
@@ -233,6 +240,7 @@
   void slotShortcutChanged( KMFolder *folder );
 
   void updateCustomTemplateMenus();
+  void slotEditVacation();
 
 signals:
   void messagesTransfered( bool );
@@ -246,10 +254,6 @@
   void updateFileMenu();
   void newFromTemplate( KMMessage *msg );
 
-  // helper functions for keeping reference to mFolder
-  void openFolder();
-  void closeFolder();
-
   KActionCollection * actionCollection() const { return mActionCollection; }
 
   /** @return the correct config dialog depending on whether the parent of the mainWidget
@@ -290,7 +294,6 @@
   void slotOverrideThread();
   void slotToggleSubjectThreading();
   void slotMessageQueuedOrDrafted();
-  void slotEditMsg();
   void slotUseTemplate();
   //void slotTrashMsg();   // move to trash
   void slotDeleteMsg( bool confirmDelete = true );  // completely delete message
@@ -307,7 +310,7 @@
   void slotCopyMsgToFolder( KMFolder *dest);
   void slotCopyMsg();
   void slotResendMsg();
-  void slotEditVacation();
+  void slotCheckVacation();
   void slotDebugSieve();
   void slotStartCertManager();
   void slotStartWatchGnuPG();
@@ -317,12 +320,6 @@
   void slotCollapseThread();
   void slotCollapseAllThreads();
   void slotShowMsgSrc();
-  void slotSetMsgStatusNew();
-  void slotSetMsgStatusUnread();
-  void slotSetMsgStatusRead();
-  void slotSetMsgStatusTodo();
-  void slotSetMsgStatusSent();
-  void slotSetMsgStatusFlag();
   void slotSetThreadStatusNew();
   void slotSetThreadStatusUnread();
   void slotSetThreadStatusRead();
@@ -332,6 +329,7 @@
   void slotSetThreadStatusIgnored();
   void slotToggleUnread();
   void slotToggleTotalColumn();
+  void slotToggleSizeColumn();
   void slotSendQueued();
   void slotSendQueuedVia( int item );
   void slotOnlineStatus();
@@ -391,11 +389,6 @@
   void slotChangeCaption(QListViewItem*);
   void removeDuplicates();
 
-  /** Slot to reply to a message */
-  void slotReplyToMsg();
-  void slotReplyAuthorToMsg();
-  void slotReplyListToMsg();
-  void slotReplyAllToMsg();
   void slotCustomReplyToMsg( int tid );
   void slotCustomReplyAllToMsg( int tid );
   void slotForwardInlineMsg();
@@ -409,6 +402,7 @@
   void slotFromFilter();
   void slotToFilter();
   void slotPrintMsg();
+  void slotCreateTodo();
 
   void slotConfigChanged();
   /** Remove the shortcut actions associated with a folder. */
@@ -436,18 +430,23 @@
    */
   QString findCurrentImapPath();
 
+  void setupFolderView();
+
+private slots:
+  void slotRequestFullSearchFromQuickSearch();
+  void updateVactionScriptStatus( bool active );
+
 private:
   // Message actions
   KAction *mTrashAction, *mDeleteAction, *mTrashThreadAction,
-    *mDeleteThreadAction, *mSaveAsAction, *mEditAction, *mUseAction,
+    *mDeleteThreadAction, *mSaveAsAction, *mUseAction,
     *mSendAgainAction, *mApplyAllFiltersAction, *mFindInMessageAction,
-    *mSaveAttachmentsAction, *mOpenAction, *mViewSourceAction;
+    *mSaveAttachmentsAction, *mOpenAction, *mViewSourceAction,
+    *mFavoritesCheckMailAction;
   // Composition actions
-  KAction *mPrintAction, *mReplyAction, *mReplyAllAction, *mReplyAuthorAction,
-    *mReplyListAction,
+  KAction *mPrintAction,
     *mForwardInlineAction, *mForwardAttachedAction, *mForwardDigestAction,
-    *mRedirectAction, *mNoQuoteReplyAction;
-  KActionMenu *mReplyActionMenu;
+    *mRedirectAction;
   KActionMenu *mForwardActionMenu;
   // Filter actions
   KActionMenu *mFilterMenu;
@@ -464,15 +463,13 @@
                 *mCustomReplyAllMapper,
                 *mCustomForwardMapper;
 
-  KActionMenu *mStatusMenu, *mThreadStatusMenu,
+  KActionMenu *mThreadStatusMenu,
     *mMoveActionMenu, *mCopyActionMenu, *mApplyFilterActionsMenu;
   KAction *mMarkThreadAsNewAction;
   KAction *mMarkThreadAsReadAction;
   KAction *mMarkThreadAsUnreadAction;
   KToggleAction *mToggleThreadTodoAction;
   KToggleAction *mToggleThreadFlagAction;
-  KToggleAction *mToggleTodoAction;
-  KToggleAction *mToggleFlagAction;
 
   KToggleAction *mWatchThreadAction, *mIgnoreThreadAction;
 
@@ -480,12 +477,17 @@
   KRadioAction* mUnreadColumnToggle;
   KRadioAction* mUnreadTextToggle;
   KToggleAction* mTotalColumnToggle;
+  KToggleAction* mSizeColumnToggle;
 
   KToggleAction *mToggleShowQuickSearchAction;
 
   KMFolderTree *mFolderTree;
+  KMail::FavoriteFolderView *mFavoriteFolderView;
+  QWidget      *mFolderView;
+  QSplitter    *mFolderViewParent;
   KMReaderWin  *mMsgView;
   QSplitter    *mPanner1, *mPanner2;
+  QSplitter    *mFolderViewSplitter;
   KMHeaders    *mHeaders;
   QVBox        *mSearchAndHeaders;
   KToolBar     *mSearchToolBar;
@@ -513,6 +515,7 @@
   bool mHtmlPref, mHtmlLoadExtPref, mThreadPref,
        mFolderHtmlPref, mFolderHtmlLoadExtPref, mFolderThreadPref,
        mFolderThreadSubjPref, mReaderWindowActive, mReaderWindowBelow;
+  bool mEnableFavoriteFolderView;
 
 //  QPopupMenu *mMessageMenu;
   KMail::SearchWindow *mSearchWin;
@@ -550,8 +553,12 @@
   KConfig *mConfig;
   KXMLGUIClient *mGUIClient;
 
+  KMail::MessageActions *mMsgActions;
+
   static QValueList<KMMainWidget*>* s_mainWidgetList;
-  bool mOpenedImapFolder;
+
+  KStatusBarLabel *mVacationScriptIndicator;
+  bool mVacationIndicatorActive;
 };
 
 #endif
Index: kmail/kmfolderdia.h
===================================================================
--- kmail/kmfolderdia.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfolderdia.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -136,6 +136,7 @@
   QComboBox *mShowSenderReceiverComboBox;
   QComboBox *mContentsComboBox;
   QComboBox *mIncidencesForComboBox;
+  QCheckBox *mAlarmsBlockedCheckBox;
   QLabel      *mNormalIconLabel;
   KIconButton *mNormalIconButton;
   QLabel      *mUnreadIconLabel;
Index: kmail/kmfoldertree.h
===================================================================
--- kmail/kmfoldertree.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldertree.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -18,8 +18,9 @@
 #ifndef __KMFOLDERTREE
 #define __KMFOLDERTREE
 
+#include "foldertreebase.h"
+
 #include <klocale.h>
-#include <kfoldertree.h>
 #include <kdepimmacros.h>
 
 #include <qguardedptr.h>
@@ -36,7 +37,6 @@
 class KMFolderDir;
 class KMFolderImap;
 class KMFolderTree;
-class KMMainWidget;
 class KMAccount;
 // duplication from kmcommands.h, to avoid the include
 typedef QMap<int,KMFolder*> KMMenuToFolder;
@@ -59,8 +59,8 @@
                     KMFolder* folder );
   virtual ~KMFolderTreeItem();
 
-  QPixmap normalIcon(int size=16) const;
-  QPixmap unreadIcon(int size=16) const;
+  QPixmap normalIcon( int size ) const;
+  QPixmap unreadIcon( int size ) const;
 
   void setNeedsRepaint( bool value ) { mNeedsRepaint = value; }
   bool needsRepaint() const { return mNeedsRepaint; }
@@ -88,17 +88,23 @@
   void slotShowExpiryProperties();
   void slotIconsChanged();
   void slotNameChanged();
+  void updateCount();
 
 protected:
   void init();
   KMFolder* mFolder;
+  /** Returns true when top-level/account icons should be used */
+  virtual bool useTopLevelIcon() const { return depth() == 0; }
+  /** Returns the icon size. */
+  virtual int iconSize() const { return 16; }
+
 private:
   bool mNeedsRepaint;
 };
 
 //==========================================================================
 
-class KMFolderTree : public KFolderTree
+class KMFolderTree : public KMail::FolderTreeBase
 {
   Q_OBJECT
 
@@ -115,15 +121,6 @@
   /** Recusively add folders in a folder directory to a listview item. */
   virtual void addDirectory( KMFolderDir *fdir, KMFolderTreeItem* parent );
 
-  /** Find index of given folder. Returns 0 if not found */
-  virtual QListViewItem* indexOfFolder( const KMFolder* folder ) const
-  {
-     if ( mFolderToItem.contains( folder ) )
-       return mFolderToItem[ folder ];
-     else
-       return 0;
-  }
-
   /** create a folderlist */
   void createFolderList( QStringList *str,
                          QValueList<QGuardedPtr<KMFolder> > *folders,
@@ -137,9 +134,6 @@
   /** Read config options. */
   virtual void readConfig(void);
 
-  /** Read color options and set palette. */
-  void readColorConfig(void);
-
   /** Remove information about not existing folders from the config file */
   void cleanupConfigFile();
 
@@ -153,7 +147,7 @@
 
   QValueList<QGuardedPtr<KMFolder> > selectedFolders();
 
-  enum ColumnMode {unread=15, total=16};
+  enum ColumnMode {unread=15, total=16, foldersize=17};
 
   /** toggles the unread and total columns on/off */
   void toggleColumn(int column, bool openFolders = false);
@@ -162,22 +156,9 @@
    *  in the popup correctly */
   virtual void updatePopup() const;
 
-  /** Returns the main widget that this widget is a child of. */
-  KMMainWidget * mainWidget() const { return mMainWidget; }
-
   /** Select the folder and make sure it's visible */
   void showFolder( KMFolder* );
 
-  void insertIntoFolderToItemMap( const KMFolder *folder, KMFolderTreeItem* item )
-  {
-    mFolderToItem.insert( folder, item );
-  }
-
-  void removeFromFolderToItemMap( const KMFolder *folder )
-  {
-    mFolderToItem.remove( folder );
-  }
-
   /** Valid actions for the folderToPopup method */
   enum MenuAction {
     CopyMessage,
@@ -197,13 +178,7 @@
   /** The selected folder has changed to go to an unread message */
   void folderSelectedUnread( KMFolder * );
 
-  /** Messages have been dropped onto a folder */
-  void folderDrop(KMFolder*);
-
-  /** Messages have been dropped onto a folder with Ctrl */
-  void folderDropCopy(KMFolder*);
-
-  /** unread/total column has changed */
+  /** unread/total/size column has changed */
   void columnsChanged();
 
   /** an icon of one of our folders changed */
@@ -282,17 +257,15 @@
   /** Check if the new name is valid and confirm the new name */
   void slotRenameFolder( QListViewItem * item, int col, const QString& text);
 
-  /** Update the total and unread columns (if available) */
-  void slotUpdateCounts(KMFolder * folder);
-  void slotUpdateCounts(KMFolderImap * folder, bool success = true);
   /** Update the total and unread columns but delayed */
   void slotUpdateCountsDelayed(KMFolder * folder);
   void slotUpdateCountTimeout();
   void slotUpdateOneCount();
 
-  /** slots for the unread/total-popup */
+  /** slots for the unread/total/size-popup */
   void slotToggleUnreadColumn();
   void slotToggleTotalColumn();
+  void slotToggleSizeColumn();
 
   void slotContextMenuRequested( QListViewItem *, const QPoint & );
 
@@ -310,9 +283,6 @@
   void updateCopyActions();
 
 protected:
-  /** Catch palette changes */
-  virtual bool event(QEvent *e);
-
   virtual void contentsMousePressEvent( QMouseEvent *e );
   virtual void contentsMouseReleaseEvent(QMouseEvent* me);
 
@@ -352,6 +322,10 @@
   /** Move or copy the folder @p source to @p destination. */
   void moveOrCopyFolder( QValueList<QGuardedPtr<KMFolder> > sources, KMFolder* destination, bool move=false );
 
+private slots:
+  void slotAddToFavorites();
+  void slotUnhideLocalInbox();
+
 private:
   /** total column */
   QListViewItemIterator mUpdateIterator;
@@ -360,10 +334,9 @@
   KPopupMenu* mPopup;
   int mUnreadPop;
   int mTotalPop;
+  int mSizePop;
 
-  KMMainWidget *mMainWidget;
   bool mReloading;
-  QMap<const KMFolder*, KMFolderTreeItem*> mFolderToItem;
   QValueList<QGuardedPtr<KMFolder> > mCopySourceFolders;
   bool mCutFolder;
 
Index: kmail/scalix.h
===================================================================
--- kmail/scalix.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/scalix.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,83 @@
+/*
+ *   This file is part of KMail.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+/**
+ * This file contains helper classes for Scalix groupware support.
+ * As the storage system of Scalix is quite similiar to Kolab we reuse some of
+ * the exsiting code and replace other code by our own.
+ *
+ * Differences between Kolab and Scalix:
+ *
+ * Groupware folder:
+ * Kolab marks the groupware folders (e.g. Contacts, Calendar etc.) by setting special
+ * annotations. Scalix however passes the information, which folder to treat as a
+ * special groupware folder, via custom IMAP attributes in the LIST result of the
+ * toplevel folder.
+ *
+ * Creating groupware folders:
+ * Kolab creates a normal folder and marks it as groupware folder by setting the right
+ * annotation. Scalix however has a special IMAP command 'X-CREATE-SPECIAL <type> <name>'
+ * to create a new groupware folder.
+ */
+
+#ifndef SCALIX_H
+#define SCALIX_H
+
+#include <qstring.h>
+
+#include "kmfoldertype.h"
+
+class KMFolder;
+class KMFolderDir;
+
+namespace Scalix {
+
+/**
+ * This class takes a folder attribute string as argument and provides access to the single
+ * parts.
+ */
+class FolderAttributeParser
+{
+  public:
+    FolderAttributeParser( const QString &attribute );
+
+    QString folderClass() const;
+    QString folderName() const;
+
+  private:
+    QString mFolderClass;
+    QString mFolderName;
+};
+
+class Utils
+{
+  public:
+    static KMFolder* findStandardResourceFolder( KMFolderDir* folderParentDir,
+                                                 KMail::FolderContentsType contentsType,
+                                                 const QStringList &attributes );
+
+    static KMail::FolderContentsType scalixIdToContentsType( const QString &name );
+
+    static QString contentsTypeToScalixId( KMail::FolderContentsType type );
+};
+
+}
+
+#endif
Index: kmail/snippetitem.cpp
===================================================================
--- kmail/snippetitem.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetitem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,148 @@
+/*
+ *  File : snippetitem.cpp
+ *
+ *  Author: Robert Gruber <rgruber@users.sourceforge.net>
+ *
+ *  Copyright: See COPYING file that comes with this distribution
+ */
+#include "snippetitem.h"
+
+#include <kaction.h>
+
+#include <qstring.h>
+
+SnippetItem::SnippetItem(QListView * parent, QString name, QString text )
+			: QListViewItem( parent, name ), action(0)
+{
+  strName = name;
+  strText = text;
+  iParent = -1;
+}
+
+SnippetItem::SnippetItem(QListViewItem * parent, QString name, QString text)
+			: QListViewItem( parent, name ), action(0)
+{
+  strName = name;
+  strText = text;
+  iParent = ((SnippetGroup *)parent)->getId();
+}
+
+SnippetItem::~SnippetItem()
+{
+    if ( action ) {
+        action->unplugAll();
+        delete action;
+    }
+}
+
+
+/*!
+    \fn SnippetItem::getName()
+ */
+QString SnippetItem::getName()
+{
+  return strName;
+}
+
+
+/*!
+    \fn SnippetItem::getText
+ */
+QString SnippetItem::getText()
+{
+  return strText;
+}
+
+
+/*!
+    \fn SnippetItem::setText(QString text)
+ */
+void SnippetItem::setText(QString text)
+{
+  strText = text;
+}
+
+
+/*!
+    \fn SnippetItem::setName(QString name)
+ */
+void SnippetItem::setName(QString name)
+{
+  strName = name;
+}
+
+void SnippetItem::resetParent()
+{
+  SnippetGroup * group = dynamic_cast<SnippetGroup*>(parent());
+  if (group)
+    iParent = group->getId();
+}
+
+
+KAction* SnippetItem::getAction()
+{   
+    return action;
+}
+
+void SnippetItem::setAction(KAction * anAction)
+{
+    action = anAction;
+}
+
+void SnippetItem::slotExecute()
+{
+    emit execute( this );
+}
+
+
+SnippetItem * SnippetItem::findItemByName(QString name, QPtrList<SnippetItem> &list)
+{
+  for ( SnippetItem * item = list.first(); item; item = list.next() ) {  //write the snippet-list
+    if (item->getName() == name)
+        return item;
+  }
+  return NULL;
+}
+
+SnippetGroup * SnippetItem::findGroupById(int id, QPtrList<SnippetItem> &list)
+{
+  for ( SnippetItem * item = list.first(); item; item = list.next() ) {  //write the snippet-list
+    SnippetGroup * group = dynamic_cast<SnippetGroup*>(item);
+    if (group && group->getId() == id)
+        return group;
+  }
+  return NULL;
+}
+
+
+/* * * * * * * * * * * * * * * * * * * *
+Deklaration for class SnippetGroup
+* * * * * * * * * * * * * * * * * * * */
+
+int SnippetGroup::iMaxId = 1;
+
+SnippetGroup::SnippetGroup(QListView * parent, QString name, int id)
+ : SnippetItem(parent, name, "GROUP")
+{
+    if (id > 0) {
+      iId = id;
+      if (id >= iMaxId)
+        iMaxId = id+1;
+    } else {
+      iId = iMaxId;
+      iMaxId++;
+    }
+}
+
+SnippetGroup::~SnippetGroup()
+{
+}
+
+void SnippetGroup::setId(int id)
+{
+    iId = id; 
+    if (iId >= iMaxId)
+        iMaxId = iId+1;
+}
+
+#include "snippetitem.moc"
Index: kmail/favoritefolderview.cpp
===================================================================
--- kmail/favoritefolderview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/favoritefolderview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,510 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "favoritefolderview.h"
+
+#include "kmfolder.h"
+#include "kmfoldermgr.h"
+#include "kmfolderseldlg.h"
+#include "kmmainwidget.h"
+#include "kmailicalifaceimpl.h"
+#include "folderstorage.h"
+#include "kmfolderimap.h"
+#include "kmfoldercachedimap.h"
+#include "kmacctcachedimap.h"
+#include "folderviewtooltip.h"
+#include "korghelper.h"
+
+#include <libkdepim/maillistdrag.h>
+#include <libkdepim/kaddrbook.h>
+
+#include <dcopclient.h>
+#include <kdebug.h>
+#include <kglobalsettings.h>
+#include <kiconloader.h>
+#include <kinputdialog.h>
+#include <klocale.h>
+#include <kpopupmenu.h>
+#include <kio/global.h>
+
+#include <qheader.h>
+#include <qtimer.h>
+
+#include <cassert>
+
+using namespace KMail;
+
+FavoriteFolderViewItem::FavoriteFolderViewItem(FavoriteFolderView * parent, const QString & name, KMFolder * folder)
+  : KMFolderTreeItem( parent, name, folder ),
+  mOldName( folder->label() )
+{
+  // same stuff as in KMFolderTreeItem again, this time even with virtual methods working
+  init();
+  connect( folder, SIGNAL(nameChanged()), SLOT(nameChanged()) );
+  connect( folder, SIGNAL(iconsChanged()), SLOT(slotIconsChanged()) );
+
+  connect( folder, SIGNAL(msgAdded(KMFolder*,Q_UINT32)), SLOT(updateCount()) );
+  connect( folder, SIGNAL(numUnreadMsgsChanged(KMFolder*)), SLOT(updateCount()) );
+  connect( folder, SIGNAL(msgRemoved(KMFolder*)), SLOT(updateCount()) );
+  connect( folder, SIGNAL(folderSizeChanged( KMFolder* )), SLOT(updateCount()) );
+
+  QTimer::singleShot( 0, this, SLOT(updateCount()) );
+
+  if ( unreadCount() > 0 )
+    setPixmap( 0, unreadIcon( iconSize() ) );
+  else
+    setPixmap( 0, normalIcon( iconSize() ) );
+}
+
+void FavoriteFolderViewItem::nameChanged()
+{
+  QString txt = text( 0 );
+  txt.replace( mOldName, folder()->label() );
+  setText( 0, txt );
+  mOldName = folder()->label();
+}
+
+QValueList<FavoriteFolderView*> FavoriteFolderView::mInstances;
+
+FavoriteFolderView::FavoriteFolderView( KMMainWidget *mainWidget, QWidget * parent) :
+    FolderTreeBase( mainWidget, parent ),
+    mContextMenuItem( 0 ),
+    mReadingConfig( false )
+{
+  assert( mainWidget );
+  addColumn( i18n("Favorite Folders") );
+  setResizeMode( LastColumn );
+  header()->setClickEnabled( false );
+  setDragEnabled( true );
+  setAcceptDrops( true );
+  setRootIsDecorated( false );
+  setSelectionModeExt( KListView::Single );
+  setSorting( -1 );
+  setShowSortIndicator( false );
+
+  connect( this, SIGNAL(selectionChanged()), SLOT(selectionChanged()) );
+  connect( this, SIGNAL(clicked(QListViewItem*)), SLOT(itemClicked(QListViewItem*)) );
+  connect( this, SIGNAL(dropped(QDropEvent*,QListViewItem*)), SLOT(dropped(QDropEvent*,QListViewItem*)) );
+  connect( this, SIGNAL(contextMenuRequested(QListViewItem*, const QPoint &, int)),
+           SLOT(contextMenu(QListViewItem*,const QPoint&)) );
+  connect( this, SIGNAL(moved()), SLOT(notifyInstancesOnChange()) );
+  connect( this, SIGNAL(triggerRefresh()), SLOT(refresh()) );
+
+  connect( kmkernel->folderMgr(), SIGNAL(changed()), SLOT(initializeFavorites()) );
+  connect( kmkernel->dimapFolderMgr(), SIGNAL(changed()), SLOT(initializeFavorites()) );
+  connect( kmkernel->imapFolderMgr(), SIGNAL(changed()), SLOT(initializeFavorites()) );
+  connect( kmkernel->searchFolderMgr(), SIGNAL(changed()), SLOT(initializeFavorites()) );
+
+  connect( kmkernel->folderMgr(), SIGNAL(folderRemoved(KMFolder*)), SLOT(folderRemoved(KMFolder*)) );
+  connect( kmkernel->dimapFolderMgr(), SIGNAL(folderRemoved(KMFolder*)), SLOT(folderRemoved(KMFolder*)) );
+  connect( kmkernel->imapFolderMgr(), SIGNAL(folderRemoved(KMFolder*)), SLOT(folderRemoved(KMFolder*)) );
+  connect( kmkernel->searchFolderMgr(), SIGNAL(folderRemoved(KMFolder*)), SLOT(folderRemoved(KMFolder*)) );
+
+  QFont f = font();
+  f.setItalic( true );
+  setFont( f );
+
+  new FolderViewToolTip( this );
+
+  mInstances.append( this );
+}
+
+FavoriteFolderView::~FavoriteFolderView()
+{
+  mInstances.remove( this );
+}
+
+void FavoriteFolderView::readConfig()
+{
+  mReadingConfig = true;
+  clear();
+  QValueList<int> folderIds = GlobalSettings::self()->favoriteFolderIds();
+  QStringList folderNames = GlobalSettings::self()->favoriteFolderNames();
+  QListViewItem *afterItem = 0;
+  for ( uint i = 0; i < folderIds.count(); ++i ) {
+    KMFolder *folder = kmkernel->folderMgr()->findById( folderIds[i] );
+    if ( !folder )
+      folder = kmkernel->imapFolderMgr()->findById( folderIds[i] );
+    if ( !folder )
+      folder = kmkernel->dimapFolderMgr()->findById( folderIds[i] );
+    if ( !folder )
+      folder = kmkernel->searchFolderMgr()->findById( folderIds[i] );
+    QString name;
+    if ( folderNames.count() > i )
+      name = folderNames[i];
+    afterItem = addFolder( folder, name, afterItem );
+  }
+  if ( firstChild() )
+    ensureItemVisible( firstChild() );
+
+  // folder tree is not yet populated at this point
+  QTimer::singleShot( 0, this, SLOT(initializeFavorites()) );
+
+  readColorConfig();
+  mReadingConfig = false;
+}
+
+void FavoriteFolderView::writeConfig()
+{
+  QValueList<int> folderIds;
+  QStringList folderNames;
+  for ( QListViewItemIterator it( this ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    folderIds << fti->folder()->id();
+    folderNames << fti->text( 0 );
+  }
+  GlobalSettings::self()->setFavoriteFolderIds( folderIds );
+  GlobalSettings::self()->setFavoriteFolderNames( folderNames );
+}
+
+bool FavoriteFolderView::acceptDrag(QDropEvent * e) const
+{
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  if ( e->provides( "application/x-qlistviewitem" ) &&
+       (e->source() == ft->viewport() || e->source() == viewport() ) )
+    return true;
+  return FolderTreeBase::acceptDrag( e );
+}
+
+KMFolderTreeItem* FavoriteFolderView::addFolder(KMFolder * folder, const QString &name, QListViewItem *after)
+{
+  if ( !folder )
+    return 0;
+  KMFolderTreeItem *item = new FavoriteFolderViewItem( this, name.isEmpty() ? folder->label() : name, folder );
+  if ( after )
+    item->moveItem( after );
+  else
+    item->moveItem( lastItem() );
+  ensureItemVisible( item );
+  insertIntoFolderToItemMap( folder, item );
+  notifyInstancesOnChange();
+  return item;
+}
+
+void FavoriteFolderView::selectionChanged()
+{
+  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( selectedItem() );
+  if ( !fti )
+    return;
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  assert( fti );
+  ft->showFolder( fti->folder() );
+  handleGroupwareFolder( fti );
+}
+
+void FavoriteFolderView::handleGroupwareFolder( KMFolderTreeItem *fti )
+{
+  if ( !fti || !fti->folder() || !fti->folder()->storage() )
+    return;
+  switch ( fti->folder()->storage()->contentsType() ) {
+    case KMail::ContentsTypeContact:
+      KAddrBookExternal::openAddressBook( this );
+      break;
+    case KMail::ContentsTypeNote:
+    {
+      QByteArray arg;
+      QDataStream s( arg, IO_WriteOnly );
+      s << QString( "kontact_knotesplugin" );
+      kapp->dcopClient()->send( "kontact", "KontactIface", "selectPlugin(QString)", arg );
+      break;
+    }
+    case KMail::ContentsTypeCalendar:
+    case KMail::ContentsTypeTask:
+    case KMail::ContentsTypeJournal:
+    {
+      KMail::KorgHelper::ensureRunning();
+      QByteArray arg;
+      QDataStream s( arg, IO_WriteOnly );
+      switch ( fti->folder()->storage()->contentsType() ) {
+        case KMail::ContentsTypeCalendar:
+          s << QString( "kontact_korganizerplugin" ); break;
+        case KMail::ContentsTypeTask:
+          s << QString( "kontact_todoplugin" ); break;
+        case KMail::ContentsTypeJournal:
+          s << QString( "kontact_journalplugin" ); break;
+        default: assert( false );
+      }
+      kapp->dcopClient()->send( "kontact", "KontactIface", "selectPlugin(QString)", arg );
+      break;
+    }
+    default: break;
+  }
+}
+
+void FavoriteFolderView::itemClicked(QListViewItem * item)
+{
+  if ( !item ) return;
+  if ( !item->isSelected() )
+    item->setSelected( true );
+  item->repaint();
+  handleGroupwareFolder( static_cast<KMFolderTreeItem*>( item ) );
+}
+
+void FavoriteFolderView::folderTreeSelectionChanged(KMFolder * folder)
+{
+  blockSignals( true );
+  bool found = false;
+  for ( QListViewItemIterator it( this ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    if ( fti->folder() == folder && !fti->isSelected() ) {
+      fti->setSelected( true );
+      setCurrentItem( fti );
+      ensureItemVisible( fti );
+      fti->repaint();
+      found = true;
+    } else if ( fti->folder() != folder && fti->isSelected() ) {
+      fti->setSelected( false );
+      fti->repaint();
+    }
+  }
+  blockSignals( false );
+  if ( !found ) {
+    clearSelection();
+    setSelectionModeExt( KListView::NoSelection );
+    setSelectionModeExt( KListView::Single );
+  }
+}
+
+void FavoriteFolderView::folderRemoved(KMFolder * folder)
+{
+  QValueList<KMFolderTreeItem*> delItems;
+  for ( QListViewItemIterator it( this ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    if ( fti->folder() == folder )
+      delItems << fti;
+    if ( fti == mContextMenuItem )
+      mContextMenuItem = 0;
+  }
+  for ( uint i = 0; i < delItems.count(); ++i )
+    delete delItems[i];
+  removeFromFolderToItemMap(folder);
+}
+
+void FavoriteFolderView::dropped(QDropEvent * e, QListViewItem * after)
+{
+  QListViewItem* afterItem = after;
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  if ( e->source() == ft->viewport() && e->provides( "application/x-qlistviewitem" ) ) {
+    for ( QListViewItemIterator it( ft ); it.current(); ++it ) {
+      if ( !it.current()->isSelected() )
+        continue;
+      KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+      if ( !fti->folder() )
+        continue;
+      afterItem = addFolder( fti->folder(), prettyName( fti ), afterItem );
+    }
+    e->accept();
+  }
+}
+
+void FavoriteFolderView::contextMenu(QListViewItem * item, const QPoint & point)
+{
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( item );
+  mContextMenuItem = fti;
+  KPopupMenu contextMenu;
+  if ( fti && fti->folder() ) {
+    contextMenu.insertItem( SmallIconSet("editdelete"), i18n("Remove From Favorites"),
+                            this, SLOT(removeFolder()) );
+    contextMenu.insertItem( SmallIconSet("edit"), i18n("Rename Favorite"), this, SLOT(renameFolder()) );
+    contextMenu.insertSeparator();
+
+    mainWidget()->action("mark_all_as_read")->plug( &contextMenu );
+    if ( fti->folder()->folderType() == KMFolderTypeImap || fti->folder()->folderType() == KMFolderTypeCachedImap )
+      mainWidget()->action("refresh_folder")->plug( &contextMenu );
+    if ( fti->folder()->isMailingListEnabled() )
+      mainWidget()->action("post_message")->plug( &contextMenu );
+
+    contextMenu.insertItem( SmallIconSet("configure_shortcuts"), i18n("&Assign Shortcut..."), fti, SLOT(assignShortcut()) );
+    contextMenu.insertItem( i18n("Expire..."), fti, SLOT(slotShowExpiryProperties()) );
+    mainWidget()->action("modify")->plug( &contextMenu );
+  } else {
+    contextMenu.insertItem( SmallIconSet("bookmark_add"), i18n("Add Favorite Folder..."),
+                            this, SLOT(addFolder()) );
+  }
+  contextMenu.exec( point, 0 );
+}
+
+void FavoriteFolderView::removeFolder()
+{
+  delete mContextMenuItem;
+  mContextMenuItem = 0;
+  notifyInstancesOnChange();
+}
+
+void FavoriteFolderView::initializeFavorites()
+{
+  QValueList<int> seenInboxes = GlobalSettings::self()->favoriteFolderViewSeenInboxes();
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  for ( QListViewItemIterator it( ft ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    if ( fti->type() == KFolderTreeItem::Inbox && fti->folder() && !seenInboxes.contains( fti->folder()->id() ) ) {
+      seenInboxes.append( fti->folder()->id() );
+      if ( fti->folder() == kmkernel->inboxFolder() && hideLocalInbox() )
+        continue;
+      if ( kmkernel->iCalIface().hideResourceFolder( fti->folder() ) )
+        continue;
+      addFolder( fti->folder(), prettyName( fti ) );
+    }
+  }
+  GlobalSettings::self()->setFavoriteFolderViewSeenInboxes( seenInboxes );
+}
+
+void FavoriteFolderView::renameFolder()
+{
+  if ( !mContextMenuItem )
+    return;
+  bool ok;
+  QString name = KInputDialog::getText( i18n("Rename Favorite"), i18n("Name"), mContextMenuItem->text( 0 ), &ok, this );
+  if ( !ok )
+    return;
+  mContextMenuItem->setText( 0, name );
+  notifyInstancesOnChange();
+}
+
+QString FavoriteFolderView::prettyName(KMFolderTreeItem * fti)
+{
+  assert( fti );
+  assert( fti->folder() );
+  QString name = fti->folder()->label();
+  QListViewItem *accountFti = fti;
+  while ( accountFti->parent() )
+    accountFti = accountFti->parent();
+  if ( fti->type() == KFolderTreeItem::Inbox ) {
+    if ( fti->protocol() == KFolderTreeItem::Local || fti->protocol() == KFolderTreeItem::NONE ) {
+      name = i18n( "Local Inbox" );
+    } else {
+      name = i18n( "Inbox of %1" ).arg( accountFti->text( 0 ) );
+    }
+  } else {
+    if ( fti->protocol() != KFolderTreeItem::Local && fti->protocol() != KFolderTreeItem::NONE ) {
+      name = i18n( "%1 on %2" ).arg( fti->text( 0 ) ).arg( accountFti->text( 0 ) );
+    } else {
+      name = i18n( "%1 (local)" ).arg( fti->text( 0 ) );
+    }
+  }
+  return name;
+}
+
+void FavoriteFolderView::contentsDragEnterEvent(QDragEnterEvent * e)
+{
+  if ( e->provides( "application/x-qlistviewitem" ) ) {
+    setDropVisualizer( true );
+    setDropHighlighter( false );
+  } else if ( e->provides( KPIM::MailListDrag::format() ) ) {
+    setDropVisualizer( false );
+    setDropHighlighter( true );
+  } else {
+    setDropVisualizer( false );
+    setDropHighlighter( false );
+  }
+  FolderTreeBase::contentsDragEnterEvent( e );
+}
+
+void FavoriteFolderView::readColorConfig()
+{
+  FolderTreeBase::readColorConfig();
+  KConfig* conf = KMKernel::config();
+  // Custom/System color support
+  KConfigGroupSaver saver(conf, "Reader");
+  QColor c = KGlobalSettings::alternateBackgroundColor();
+  if ( !conf->readBoolEntry("defaultColors", true) )
+    mPaintInfo.colBack = conf->readColorEntry( "AltBackgroundColor",&c );
+  else
+    mPaintInfo.colBack = c;
+
+  QPalette newPal = palette();
+  newPal.setColor( QColorGroup::Base, mPaintInfo.colBack );
+  setPalette( newPal );
+}
+
+void FavoriteFolderView::addFolder()
+{
+  KMFolderSelDlg dlg( mainWidget(), i18n("Add Favorite Folder"), false );
+  if ( dlg.exec() != QDialog::Accepted )
+    return;
+  KMFolder *folder = dlg.folder();
+  if ( !folder )
+    return;
+  KMFolderTreeItem *fti = findFolderTreeItem( folder );
+  addFolder( folder, fti ? prettyName( fti ) : folder->label() );
+}
+
+KMFolderTreeItem * FavoriteFolderView::findFolderTreeItem(KMFolder * folder) const
+{
+  assert( folder );
+  KMFolderTree *ft = mainWidget()->folderTree();
+  assert( ft );
+  for ( QListViewItemIterator it( ft ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    if ( fti->folder() == folder )
+      return fti;
+  }
+  return 0;
+}
+
+void FavoriteFolderView::checkMail()
+{
+  bool found = false;
+  for ( QListViewItemIterator it( this ); it.current(); ++it ) {
+    KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>( it.current() );
+    if ( fti->folder()->folderType() == KMFolderTypeImap || fti->folder()->folderType() == KMFolderTypeCachedImap ) {
+      if ( !found )
+        if ( !kmkernel->askToGoOnline() )
+          break;
+      found = true;
+      if ( fti->folder()->folderType() == KMFolderTypeImap ) {
+        KMFolderImap *imap = static_cast<KMFolderImap*>( fti->folder()->storage() );
+        imap->getAndCheckFolder();
+      } else if ( fti->folder()->folderType() == KMFolderTypeCachedImap ) {
+        KMFolderCachedImap* f = static_cast<KMFolderCachedImap*>( fti->folder()->storage() );
+        f->account()->processNewMailSingleFolder( fti->folder() );
+      }
+    }
+  }
+}
+
+void FavoriteFolderView::notifyInstancesOnChange()
+{
+  if ( mReadingConfig )
+    return;
+  writeConfig();
+  for ( QValueList<FavoriteFolderView*>::ConstIterator it = mInstances.begin(); it != mInstances.end(); ++it ) {
+    if ( (*it) == this || (*it)->mReadingConfig )
+      continue;
+    (*it)->readConfig();
+  }
+}
+
+void FavoriteFolderView::refresh()
+{
+  for ( QListViewItemIterator it( this ) ; it.current() ; ++it ) {
+    KMFolderTreeItem* fti = static_cast<KMFolderTreeItem*>(it.current());
+    if (!fti || !fti->folder())
+      continue;
+    fti->repaint();
+  }
+  update();
+}
+
+#include "favoritefolderview.moc"
Index: kmail/objecttreeparser.h
===================================================================
--- kmail/objecttreeparser.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/objecttreeparser.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -35,9 +35,11 @@
 
 #include "kmmsgbase.h"
 
-#include <cryptplugwrapper.h>
 #include <qcstring.h>
 
+#include <kleo/cryptobackend.h>
+#include <gpgmepp/verificationresult.h>
+
 class KMReaderWin;
 class KMMessagePart;
 class QString;
@@ -96,11 +98,11 @@
   };
 
   class ObjectTreeParser {
-    class CryptPlugWrapperSaver;
+    class CryptoProtocolSaver;
     /** Internal. Copies the context of @p other, but not it's rawReplyString() */
     ObjectTreeParser( const ObjectTreeParser & other );
   public:
-    ObjectTreeParser( KMReaderWin * reader=0, CryptPlugWrapper * wrapper=0,
+    ObjectTreeParser( KMReaderWin * reader=0, const Kleo::CryptoBackend::Protocol * protocol=0,
                       bool showOneMimePart=false, bool keepEncryptions=false,
                       bool includeSignatures=true,
                       const KMail::AttachmentStrategy * attachmentStrategy=0,
@@ -116,11 +118,11 @@
 
     QCString textualContentCharset() const { return mTextualContentCharset; }
 
-    void setCryptPlugWrapper( CryptPlugWrapper * wrapper ) {
-      mCryptPlugWrapper = wrapper;
+    void setCryptoProtocol( const Kleo::CryptoBackend::Protocol * protocol ) {
+      mCryptoProtocol = protocol;
     }
-    CryptPlugWrapper * cryptPlugWrapper() const {
-      return mCryptPlugWrapper;
+    const Kleo::CryptoBackend::Protocol* cryptoProtocol() const {
+      return mCryptoProtocol;
     }
 
     bool showOnlyOneMimePart() const { return mShowOnlyOneMimePart; }
@@ -184,7 +186,7 @@
                                            const QString & fromAddress,
                                            bool doCheck=true,
                                            QCString * cleartextData=0,
-                                           CryptPlug::SignatureMetaData * paramSigMeta=0,
+                                           std::vector<GpgME::Signature> paramSignatures = std::vector<GpgME::Signature>(),
                                            bool hideErrors=false );
 
     /** Returns the contents of the given multipart/encrypted
@@ -192,10 +194,12 @@
     bool okDecryptMIME( partNode& data,
                         QCString& decryptedData,
                         bool& signatureFound,
-                        CryptPlug::SignatureMetaData& sigMeta,
+                        std::vector<GpgME::Signature> &signatures,
                         bool showWarning,
                         bool& passphraseError,
-                        QString& aErrorText );
+                        bool& actuallyEncrypted,
+                        QString& aErrorText,
+                        QString& auditLog );
 
     bool processMailmanMessage( partNode * node );
 
@@ -233,13 +237,13 @@
 
     void writePartIcon( KMMessagePart * msgPart, int partNumber, bool inlineImage=false );
 
-    QString sigStatusToString( CryptPlugWrapper * cryptPlug,
+    QString sigStatusToString( const Kleo::CryptoBackend::Protocol * cryptProto,
                                int status_code,
-                               CryptPlugWrapper::SigStatusFlags statusFlags,
+                               GpgME::Signature::Summary summary,
                                int & frameColor,
                                bool & showKeyInfos );
     QString writeSigstatHeader( KMail::PartMetaData & part,
-                                CryptPlugWrapper * cryptPlug,
+                                const Kleo::CryptoBackend::Protocol * cryptProto,
                                 const QString & fromAddress,
                                 const QString & filename = QString::null );
     QString writeSigstatFooter( KMail::PartMetaData & part );
@@ -273,7 +277,7 @@
     QCString mRawReplyString;
     QCString mTextualContentCharset;
     QString mTextualContent;
-    CryptPlugWrapper * mCryptPlugWrapper;
+    const Kleo::CryptoBackend::Protocol * mCryptoProtocol;
     bool mShowOnlyOneMimePart;
     bool mKeepEncryptions;
     bool mIncludeSignatures;
Index: kmail/kmfoldermaildir.h
===================================================================
--- kmail/kmfoldermaildir.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermaildir.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -3,13 +3,20 @@
 
 #include "kmfolderindex.h"
 
+#include <kfileitem.h>
 
+#include <qguardedptr.h>
+
 class KMFolderMaildir;
 namespace KMail {
   class FolderJob;
   class MaildirJob;
   class AttachmentStrategy;
 }
+namespace KIO {
+    class Job;
+}
+
 using KMail::FolderJob;
 using KMail::MaildirJob;
 using KMail::AttachmentStrategy;
@@ -97,6 +104,9 @@
 
   /** Is the folder read-only? */
   virtual bool isReadOnly() const { return false; }
+ 
+  /** reimp */
+  virtual Q_INT64 doFolderSize() const;
 
 protected:
   virtual FolderJob* doCreateJob( KMMessage *msg, FolderJob::JobType jt, KMFolder *folder,
@@ -133,6 +143,9 @@
    * into the KMMoveCommand, where it can safely happen at a much higher level. */
   int addMsgInternal( KMMessage* msg, int* index_return = 0, bool stripUid=false );
 
+private slots:
+  void slotDirSizeJobResult( KIO::Job* job );
+
 private:
   void readFileHeaderIntern(const QString& dir, const QString& file, KMMsgStatus status);
   QString moveInternal(const QString& oldLoc, const QString& newLoc, KMMsgInfo* mi);
@@ -146,7 +159,11 @@
   */
   virtual IndexStatus indexStatus();
 
+  typedef QPair<QGuardedPtr<const KMFolderMaildir>,KFileItemList> DirSizeJobQueueEntry;
+  static QValueList<DirSizeJobQueueEntry> s_DirSizeJobQueue;
+
   QStrList mIdxToFileList;
   int mIdxCount;
+  mutable bool mCurrentlyCheckingFolderSize;
 };
 #endif /*kmfoldermaildir_h*/
Index: kmail/kmfoldermgr.h
===================================================================
--- kmail/kmfoldermgr.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermgr.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -121,6 +121,9 @@
   /** Copy a folder */
   void copyFolder( KMFolder* folder, KMFolderDir* newParent );
 
+  /** Returns the parent Folder for the given folder or 0 on failure.  */
+  KMFolder* parentFolder( KMFolder* folder );
+
 public slots:
   /** GUI action: compact all folders that need to be compacted */
   void compactAll() { compactAllFolders( true ); }
Index: kmail/kmreadermainwin.h
===================================================================
--- kmail/kmreadermainwin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmreadermainwin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,8 +14,14 @@
 class KActionMenu;
 class KMFolderIndex;
 class KMFolder;
+class KFontAction;
+class KFontSizeAction;
 template <typename T, typename S> class QMap;
 
+namespace KMail {
+class MessageActions;
+}
+
 class KMReaderMainWin : public KMail::SecondaryWindow
 {
   Q_OBJECT
@@ -33,6 +39,11 @@
   // take ownership of and show @param msg
   void showMsg( const QString & encoding, KMMessage *msg );
 
+  /**
+   * Sets up action list for forward menu.
+  */
+  void setupForwardingActionsList();
+
 private slots:
   void slotMsgPopup(KMMessage &aMsg, const KURL &aUrl, const QPoint& aPoint);
 
@@ -40,10 +51,6 @@
   void copySelectedToFolder( int menuId );
   void slotTrashMsg();
   void slotPrintMsg();
-  void slotReplyToMsg();
-  void slotReplyAllToMsg();
-  void slotReplyAuthorToMsg();
-  void slotReplyListToMsg();
   void slotForwardInlineMsg();
   void slotForwardAttachedMsg();
   void slotForwardDigestMsg();
@@ -53,8 +60,13 @@
   void slotCopy();
   void slotFind();
   void slotFindNext();
+  void slotFontAction(const QString &);
+  void slotSizeAction(int);
+  void slotCreateTodo();
+  void slotEditToolbars();
 
   void slotConfigChanged();
+  void slotUpdateToolbars();
 
   void slotFolderRemoved( QObject* folderPtr );
 
@@ -67,12 +79,13 @@
   KURL mUrl;
   QMap<int,KMFolder*> mMenuToFolder;
   // a few actions duplicated from kmmainwidget
-  KAction *mTrashAction, *mPrintAction, *mSaveAsAction, *mReplyAction,
-          *mReplyAllAction, *mReplyAuthorAction, *mReplyListAction, *mForwardInlineAction,
+  KAction *mTrashAction, *mPrintAction, *mSaveAsAction, *mForwardInlineAction,
           *mForwardAttachedAction, *mForwardDigestAction, *mRedirectAction,
           *mViewSourceAction;
-  KActionMenu *mReplyActionMenu;
   KActionMenu *mForwardActionMenu;
+  KFontAction *fontAction;
+  KFontSizeAction *fontSizeAction;
+  KMail::MessageActions *mMsgActions;
 
 };
 
Index: kmail/kmfoldertree.cpp
===================================================================
--- kmail/kmfoldertree.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,6 +23,9 @@
 #include "acljobs.h"
 #include "messagecopyhelper.h"
 using KMail::MessageCopyHelper;
+#include "favoritefolderview.h"
+#include "folderviewtooltip.h"
+using KMail::FolderViewToolTip;
 
 #include <maillistdrag.h>
 using namespace KPIM;
@@ -55,7 +58,7 @@
     mFolder( 0 ), mNeedsRepaint( true )
 {
   init();
-  setPixmap( 0, normalIcon() );
+  setPixmap( 0, normalIcon( iconSize() ) );
 }
 
 //-----------------------------------------------------------------------------
@@ -66,7 +69,7 @@
     mFolder( folder ), mNeedsRepaint( true )
 {
   init();
-  setPixmap( 0, normalIcon() );
+  setPixmap( 0, normalIcon( iconSize() ) );
 }
 
 //-----------------------------------------------------------------------------
@@ -77,7 +80,7 @@
     mFolder( folder ), mNeedsRepaint( true )
 {
   init();
-  setPixmap( 0, normalIcon() );
+  setPixmap( 0, normalIcon( iconSize() ) );
 }
 
 KMFolderTreeItem::~KMFolderTreeItem()
@@ -103,7 +106,7 @@
 QPixmap KMFolderTreeItem::normalIcon(int size) const
 {
   QString icon;
-  if ( (!mFolder && type() == Root) || depth() == 0 ) {
+  if ( (!mFolder && type() == Root) || useTopLevelIcon() ) {
     switch ( protocol() ) {
       case KFolderTreeItem::Imap:
       case KFolderTreeItem::CachedImap:
@@ -155,7 +158,7 @@
 {
   QPixmap pm;
 
-  if ( !mFolder || depth() == 0 || mFolder->isSystemFolder() ||
+  if ( !mFolder || useTopLevelIcon() || mFolder->isSystemFolder() ||
        kmkernel->folderIsTrash( mFolder ) ||
        kmkernel->folderIsTemplates( mFolder ) ||
        kmkernel->folderIsDraftOrOutbox( mFolder ) )
@@ -192,7 +195,7 @@
 
   setProtocol( protocolFor( mFolder->folderType() ) );
 
-  if ( depth() == 0 )
+  if ( useTopLevelIcon() )
     setType(Root);
   else {
     if ( mFolder == kmkernel->inboxFolder() )
@@ -222,17 +225,18 @@
   if ( !mFolder->isSystemFolder() )
     setRenameEnabled( 0, false );
 
-  KMFolderTree* tree = static_cast<KMFolderTree*>( listView() );
-  tree->insertIntoFolderToItemMap( mFolder, this );
+  KMFolderTree* tree = dynamic_cast<KMFolderTree*>( listView() );
+  if ( tree )
+    tree->insertIntoFolderToItemMap( mFolder, this );
 }
 
 void KMFolderTreeItem::adjustUnreadCount( int newUnreadCount ) {
   // adjust the icons if the folder is now newly unread or
   // now newly not-unread
   if ( newUnreadCount != 0 && unreadCount() == 0 )
-    setPixmap( 0, unreadIcon() );
+    setPixmap( 0, unreadIcon( iconSize() ) );
   if ( unreadCount() != 0 && newUnreadCount == 0 )
-    setPixmap( 0, normalIcon() );
+    setPixmap( 0, normalIcon( iconSize() ) );
 
   setUnreadCount( newUnreadCount );
 }
@@ -245,9 +249,9 @@
       setType( kmkernel->iCalIface().folderType(mFolder) );
 
   if ( unreadCount() > 0 )
-    setPixmap( 0, unreadIcon() );
+    setPixmap( 0, unreadIcon( iconSize() ) );
   else
-    setPixmap( 0, normalIcon() );
+    setPixmap( 0, normalIcon( iconSize() ) );
   emit iconChanged( this );
   repaint();
 }
@@ -263,6 +267,14 @@
 //-----------------------------------------------------------------------------
 bool KMFolderTreeItem::acceptDrag(QDropEvent* e) const
 {
+  // Do not allow drags from the favorite folder view, as they don't really
+  // make sense and do not work.
+  KMMainWidget *mainWidget = static_cast<KMFolderTree*>( listView() )->mainWidget();
+  assert( mainWidget );
+  if ( mainWidget->favoriteFolderView() &&
+       e->source() == mainWidget->favoriteFolderView()->viewport() )
+    return false;
+
   if ( protocol() == KFolderTreeItem::Search )
     return false; // nothing can be dragged into search folders
 
@@ -305,7 +317,7 @@
   if ( !mFolder )
     return;
 
-  KMFolderTree* tree = static_cast<KMFolderTree*>( listView() );
+  KMail::FolderTreeBase* tree = static_cast<KMail::FolderTreeBase*>( listView() );
   tree->mainWidget()->modifyFolder( this );
   //Nothing here the above may actually delete this KMFolderTreeItem
 }
@@ -318,19 +330,32 @@
 
   KMail::FolderShortcutDialog *shorty =
     new KMail::FolderShortcutDialog( mFolder,
-              static_cast<KMFolderTree *>( listView() )->mainWidget(),
+              kmkernel->getKMMainWidget(),
               listView() );
   shorty->exec();
   return;
 }
 
+//-----------------------------------------------------------------------------
+void KMFolderTreeItem::updateCount()
+{
+    if ( !folder() ) {
+      setTotalCount( -1 );
+      return;
+    }
+    KMail::FolderTreeBase* tree = dynamic_cast<KMail::FolderTreeBase*>( listView() );
+    if ( !tree ) return;
 
+    tree->slotUpdateCounts( folder(), true /* force update */ );
+}
+
+
 //=============================================================================
 
 
 KMFolderTree::KMFolderTree( KMMainWidget *mainWidget, QWidget *parent,
                             const char *name )
-  : KFolderTree( parent, name )
+  : KMail::FolderTreeBase( mainWidget, parent, name )
   , mUpdateTimer( 0, "mUpdateTimer" )
   , autoopen_timer( 0, "autoopen_timer" )
 {
@@ -344,7 +369,6 @@
   mUpdateCountTimer= new QTimer( this, "mUpdateCountTimer" );
 
   setDragEnabled( true );
-  addAcceptableDropMimetype(MailListDrag::format(), false);
   addAcceptableDropMimetype( "application/x-qlistviewitem", false );
 
   setSelectionModeExt( Extended );
@@ -363,6 +387,12 @@
   mPopup->setCheckable(true);
   mUnreadPop = mPopup->insertItem(i18n("Unread Column"), this, SLOT(slotToggleUnreadColumn()));
   mTotalPop = mPopup->insertItem(i18n("Total Column"), this, SLOT(slotToggleTotalColumn()));
+  mSizePop = mPopup->insertItem(i18n("Size Column"), this, SLOT(slotToggleSizeColumn()));
+
+  connect( this, SIGNAL( triggerRefresh() ),
+           this, SLOT( refresh() ) );
+
+  new FolderViewToolTip( this );
 }
 
 //-----------------------------------------------------------------------------
@@ -424,43 +454,6 @@
 }
 
 //-----------------------------------------------------------------------------
-bool KMFolderTree::event(QEvent *e)
-{
-  if (e->type() == QEvent::ApplicationPaletteChange)
-  {
-     readColorConfig();
-     return true;
-  }
-  return KListView::event(e);
-}
-
-//-----------------------------------------------------------------------------
-void KMFolderTree::readColorConfig (void)
-{
-  KConfig* conf = KMKernel::config();
-  // Custom/System color support
-  KConfigGroupSaver saver(conf, "Reader");
-  QColor c1=QColor(kapp->palette().active().text());
-  QColor c2=QColor("blue");
-  QColor c4=QColor(kapp->palette().active().base());
-
-  if (!conf->readBoolEntry("defaultColors",TRUE)) {
-    mPaintInfo.colFore = conf->readColorEntry("ForegroundColor",&c1);
-    mPaintInfo.colUnread = conf->readColorEntry("UnreadMessage",&c2);
-    mPaintInfo.colBack = conf->readColorEntry("BackgroundColor",&c4);
-  }
-  else {
-    mPaintInfo.colFore = c1;
-    mPaintInfo.colUnread = c2;
-    mPaintInfo.colBack = c4;
-  }
-  QPalette newPal = kapp->palette();
-  newPal.setColor( QColorGroup::Base, mPaintInfo.colBack );
-  newPal.setColor( QColorGroup::Text, mPaintInfo.colFore );
-  setPalette( newPal );
-}
-
-//-----------------------------------------------------------------------------
 void KMFolderTree::readConfig (void)
 {
   KConfig* conf = KMKernel::config();
@@ -470,7 +463,7 @@
   // Custom/Ssystem font support
   {
     KConfigGroupSaver saver(conf, "Fonts");
-    if (!conf->readBoolEntry("defaultFonts",TRUE)) {
+    if (!conf->readBoolEntry("defaultFonts",true)) {
       QFont folderFont( KGlobalSettings::generalFont() );
       setFont(conf->readFontEntry("folder-font", &folderFont));
     }
@@ -503,7 +496,7 @@
 void KMFolderTree::updateUnreadAll()
 {
   bool upd = isUpdatesEnabled();
-  setUpdatesEnabled(FALSE);
+  setUpdatesEnabled(false);
 
   KMFolderDir* fdir;
   KMFolderNode* folderNode;
@@ -599,20 +592,6 @@
     connect(fti->folder(),SIGNAL(nameChanged()),
             fti,SLOT(slotNameChanged()));
 
-    // With the use of slotUpdateCountsDelayed is not necesary
-    // a specific processing for Imap
-#if 0
-    if (fti->folder()->folderType() == KMFolderTypeImap) {
-      // imap-only
-      KMFolderImap *imapFolder =
-        dynamic_cast<KMFolderImap*> ( fti->folder()->storage() );
-      disconnect( imapFolder, SIGNAL(folderComplete(KMFolderImap*, bool)),
-          this,SLOT(slotUpdateCounts(KMFolderImap*, bool)));
-      connect( imapFolder, SIGNAL(folderComplete(KMFolderImap*, bool)),
-          this,SLOT(slotUpdateCounts(KMFolderImap*, bool)));
-    } else {*/
-#endif
-
     // we want to be noticed of changes to update the unread/total columns
     disconnect(fti->folder(), SIGNAL(msgAdded(KMFolder*,Q_UINT32)),
         this,SLOT(slotUpdateCountsDelayed(KMFolder*)));
@@ -629,13 +608,26 @@
     connect(fti->folder(), SIGNAL(msgRemoved(KMFolder*)),
             this,SLOT(slotUpdateCountsDelayed(KMFolder*)));
 
+  disconnect(fti->folder(), SIGNAL(folderSizeChanged( KMFolder* )),
+               this,SLOT(slotUpdateCountsDelayed(KMFolder*)));
+  connect(fti->folder(), SIGNAL(folderSizeChanged( KMFolder* )),
+               this,SLOT(slotUpdateCountsDelayed(KMFolder*)));
+
+
+
     disconnect(fti->folder(), SIGNAL(shortcutChanged(KMFolder*)),
                mMainWidget, SLOT( slotShortcutChanged(KMFolder*)));
     connect(fti->folder(), SIGNAL(shortcutChanged(KMFolder*)),
             mMainWidget, SLOT( slotShortcutChanged(KMFolder*)));
 
+
     if (!openFolders)
       slotUpdateCounts(fti->folder());
+
+    // populate the size column
+    fti->setFolderSize( 0 );
+    fti->setFolderIsCloseToQuota( fti->folder()->storage()->isCloseToQuota() );
+
   }
   ensureVisible(0, top + visibleHeight(), 0, 0);
   // if current and selected folder did not change set it again
@@ -696,18 +688,24 @@
     KMFolderTreeItem * fti = 0;
     if (!parent)
     {
-      // create new root-item, but only if this is not the root of a 
+      // create new root-item, but only if this is not the root of a
       // "groupware folders only" account
       if ( kmkernel->iCalIface().hideResourceAccountRoot( folder ) )
         continue;
       // it needs a folder e.g. to save it's state (open/close)
       fti = new KMFolderTreeItem( this, folder->label(), folder );
       fti->setExpandable( true );
+
+      // add child-folders
+      if (folder && folder->child()) {
+        addDirectory( folder->child(), fti );
+      }
     } else {
-      // Check if this is an IMAP resource folder
-      if ( kmkernel->iCalIface().hideResourceFolder( folder ) )
-        // It is
+      // hide local inbox if unused
+      if ( kmkernel->inboxFolder() == folder && hideLocalInbox() ) {
+        connect( kmkernel->inboxFolder(), SIGNAL(msgAdded(KMFolder*,Q_UINT32)), SLOT(slotUnhideLocalInbox()) );
         continue;
+      }
 
       // create new child
       fti = new KMFolderTreeItem( parent, folder->label(), folder );
@@ -720,20 +718,29 @@
         fti->setExpandable( false );
       }
 
+      // add child-folders
+      if (folder && folder->child()) {
+        addDirectory( folder->child(), fti );
+      }
+
+      // Check if this is an IMAP resource folder or a no-content parent only
+      // containing groupware folders
+      if ( (kmkernel->iCalIface().hideResourceFolder( folder ) || folder->noContent())
+            && fti->childCount() == 0 ) {
+        // It is
+        removeFromFolderToItemMap( folder );
+        delete fti;
+        continue;
+      }
+
       connect (fti, SIGNAL(iconChanged(KMFolderTreeItem*)),
           this, SIGNAL(iconChanged(KMFolderTreeItem*)));
       connect (fti, SIGNAL(nameChanged(KMFolderTreeItem*)),
           this, SIGNAL(nameChanged(KMFolderTreeItem*)));
-
     }
     // restore last open-state
     fti->setOpen( readIsListViewItemOpen(fti) );
-
-    // add child-folders
-    if (folder && folder->child()) {
-      addDirectory( folder->child(), fti );
-    }
-   } // for-end
+  } // for-end
 }
 
 //-----------------------------------------------------------------------------
@@ -749,7 +756,7 @@
 {
   bool upd = isUpdatesEnabled();
   if ( upd ) {
-    setUpdatesEnabled(FALSE);
+    setUpdatesEnabled(false);
 
     for ( QListViewItemIterator it( this ) ; it.current() ; ++it ) {
       KMFolderTreeItem* fti = static_cast<KMFolderTreeItem*>(it.current());
@@ -787,8 +794,9 @@
 //-----------------------------------------------------------------------------
 void KMFolderTree::slotFolderRemoved(KMFolder *aFolder)
 {
-  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>
-    (indexOfFolder(aFolder));
+  QListViewItem *item = indexOfFolder(aFolder);
+  if (!item) return;
+  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*> ( item );
   if ( oldCurrent == fti )
     oldCurrent = 0;
   if ( oldSelected == fti )
@@ -815,7 +823,7 @@
 void KMFolderTree::prepareItem( KMFolderTreeItem* fti )
 {
   for ( QListViewItem * parent = fti->parent() ; parent ; parent = parent->parent() )
-    parent->setOpen( TRUE );
+    parent->setOpen( true );
   ensureItemVisible( fti );
 }
 
@@ -980,7 +988,7 @@
      && (mLastItem->folder()->folderType() == KMFolderTypeImap))
   {
     KMFolderImap *imapFolder = static_cast<KMFolderImap*>(mLastItem->folder()->storage());
-    imapFolder->setSelected(FALSE);
+    imapFolder->setSelected(false);
   }
   mLastItem = fti;
 
@@ -988,7 +996,7 @@
     clearSelection();
   setCurrentItem( qlvi );
   if ( !keepSelection )
-    setSelected( qlvi, TRUE );
+    setSelected( qlvi, true );
   ensureItemVisible( qlvi );
   if (!folder) {
     emit folderSelected(0); // Root has been selected
@@ -1092,6 +1100,11 @@
 
       mMainWidget->action("compact")->plug(folderMenu);
 
+      if ( GlobalSettings::self()->enableFavoriteFolderView() ) {
+        folderMenu->insertItem( SmallIconSet("bookmark_add"), i18n("Add to Favorite Folders"),
+                                this, SLOT(slotAddToFavorites()) );
+      }
+
       folderMenu->insertSeparator();
       mMainWidget->action("empty")->plug(folderMenu);
       if ( !fti->folder()->isSystemFolder() ) {
@@ -1251,7 +1264,7 @@
   if (d->exec()) { // fti may be deleted here
     QListViewItem *qlvi = indexOfFolder( aFolder );
     if (qlvi) {
-      qlvi->setOpen(TRUE);
+      qlvi->setOpen(true);
       blockSignals( true );
       setCurrentItem( qlvi );
       blockSignals( false );
@@ -1351,7 +1364,7 @@
       }
 
       //KMessageBox::error( 0, "cleanupConfigFile: Deleting group " + *grpIt );
-      config->deleteGroup(*grpIt, TRUE);
+      config->deleteGroup(*grpIt, true);
       kdDebug(5006) << "Deleting information about folder " << name << endl;
     }
   }
@@ -1359,20 +1372,11 @@
 
 
 //-----------------------------------------------------------------------------
-// Drag and Drop handling -- based on the Troll Tech dirview example
-
-enum {
-  DRAG_COPY = 0,
-  DRAG_MOVE = 1,
-  DRAG_CANCEL = 2
-};
-
-//-----------------------------------------------------------------------------
 void KMFolderTree::openFolder()
 {
     autoopen_timer.stop();
     if ( dropItem && !dropItem->isOpen() ) {
-        dropItem->setOpen( TRUE );
+        dropItem->setOpen( true );
         dropItem->repaint();
     }
 }
@@ -1455,7 +1459,7 @@
 
     setCurrentItem( oldCurrent );
     if ( oldSelected )
-      setSelected( oldSelected, TRUE );
+      setSelected( oldSelected, true );
 }
 
 //-----------------------------------------------------------------------------
@@ -1481,24 +1485,7 @@
     }
     if (fti && acceptDrag(e) && ( fti != oldSelected || e->source() != mMainWidget->headers()->viewport() ) )
     {
-      int action = -1;
-      int keybstate = kapp->keyboardModifiers();
-      if ( keybstate & KApplication::ControlModifier ) {
-        action = DRAG_COPY;
-      } else if ( keybstate & KApplication::ShiftModifier ) {
-        action = DRAG_MOVE;
-      } else {
-        if ( GlobalSettings::self()->showPopupAfterDnD() || e->provides("application/x-qlistviewitem") ) {
-          KPopupMenu *menu = new KPopupMenu( this );
-          menu->insertItem( i18n("&Move Here"), DRAG_MOVE, 0 );
-          menu->insertItem( SmallIcon("editcopy"), i18n("&Copy Here"), DRAG_COPY, 1 );
-          menu->insertSeparator();
-          menu->insertItem( SmallIcon("cancel"), i18n("C&ancel"), DRAG_CANCEL, 3 );
-          action = menu->exec( QCursor::pos(), 0 );
-        }
-        else
-          action = DRAG_MOVE;
-      }
+      int action = dndMode( e->provides("application/x-qlistviewitem") /* always ask */ );
       if ( e->provides("application/x-qlistviewitem") ) {
         if ( (action == DRAG_COPY || action == DRAG_MOVE) && !mCopySourceFolders.isEmpty() ) {
           for ( QValueList<QGuardedPtr<KMFolder> >::ConstIterator it = mCopySourceFolders.constBegin();
@@ -1536,7 +1523,7 @@
     if ( oldSelected )
     {
       clearSelection();
-      setSelected( oldSelected, TRUE );
+      setSelected( oldSelected, true );
     }
 
     mCopySourceFolders.clear();
@@ -1546,9 +1533,11 @@
 void KMFolderTree::slotFolderExpanded( QListViewItem * item )
 {
   KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>(item);
+  if ( !fti || !fti->folder() || !fti->folder()->storage() ) return;
 
-  if ( fti && fti->folder() &&
-       fti->folder()->folderType() == KMFolderTypeImap )
+  fti->setFolderSize( fti->folder()->storage()->folderSize() );
+
+  if( fti->folder()->folderType() == KMFolderTypeImap )
   {
     KMFolderImap *folder = static_cast<KMFolderImap*>( fti->folder()->storage() );
     // if we should list all folders we limit this to the root folder
@@ -1579,6 +1568,10 @@
 void KMFolderTree::slotFolderCollapsed( QListViewItem * item )
 {
   slotResetFolderList( item, false );
+  KMFolderTreeItem *fti = static_cast<KMFolderTreeItem*>(item);
+  if ( !fti || !fti->folder() || !fti->folder()->storage() ) return;
+
+  fti->setFolderSize( fti->folder()->storage()->folderSize() );
 }
 
 //-----------------------------------------------------------------------------
@@ -1611,12 +1604,6 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMFolderTree::slotUpdateCounts(KMFolderImap * folder, bool success)
-{
-  if (success) slotUpdateCounts(folder->folder());
-}
-
-//-----------------------------------------------------------------------------
 void KMFolderTree::slotUpdateCountsDelayed(KMFolder * folder)
 {
 //  kdDebug(5006) << "KMFolderTree::slotUpdateCountsDelayed()" << endl;
@@ -1646,64 +1633,11 @@
 
 }
 
-void KMFolderTree::slotUpdateCounts(KMFolder * folder)
-{
- // kdDebug(5006) << "KMFolderTree::slotUpdateCounts()" << endl;
-  QListViewItem * current;
-  if (folder)
-    current = indexOfFolder(folder);
-  else
-    current = currentItem();
-
-  KMFolderTreeItem* fti = static_cast<KMFolderTreeItem*>(current);
-  // sanity check
-  if (!fti) return;
-  if (!fti->folder()) fti->setTotalCount(-1);
-
-  // get the unread count
-  int count = 0;
-  if (folder && folder->noContent()) // always empty
-    count = -1;
-  else {
-    if ( fti->folder() )
-      count = fti->folder()->countUnread();
-  }
-
-  // set it
-  bool repaint = false;
-  if (fti->unreadCount() != count) {
-     fti->adjustUnreadCount( count );
-     repaint = true;
-  }
-  if (isTotalActive())
-  {
-    // get the total-count
-    if (fti->folder()->noContent())
-      count = -1;
-    else {
-      // get the cached count if the folder is not open
-      count = fti->folder()->count( !fti->folder()->isOpened() );
-    }
-    // set it
-    if ( count != fti->totalCount() ) {
-      fti->setTotalCount(count);
-      repaint = true;
-    }
-  }
-  if (fti->parent() && !fti->parent()->isOpen())
-    repaint = false; // we're not visible
-  if (repaint) {
-    fti->setNeedsRepaint( true );
-    refresh();
-  }
-  // tell the kernel that one of the counts has changed
-  kmkernel->messageCountChanged();
-}
-
 void KMFolderTree::updatePopup() const
 {
    mPopup->setItemChecked( mUnreadPop, isUnreadActive() );
    mPopup->setItemChecked( mTotalPop, isTotalActive() );
+   mPopup->setItemChecked( mSizePop, isSizeActive() );
 }
 
 //-----------------------------------------------------------------------------
@@ -1733,8 +1667,19 @@
       addTotalColumn( i18n("Total"), 70 );
       reload(openFolders);
     }
-    // toggle KPopupMenu
     mPopup->setItemChecked( mTotalPop, isTotalActive() );
+  } else if (column == foldersize) {
+    // switch total
+    if ( isSizeActive() )
+    {
+      removeSizeColumn();
+      reload();
+    } else {
+      addSizeColumn( i18n("Size"), 70 );
+      reload( openFolders );
+    }
+    // toggle KPopupMenu
+    mPopup->setItemChecked( mSizePop, isSizeActive() );
 
   } else kdDebug(5006) << "unknown column:" << column << endl;
 
@@ -1756,6 +1701,14 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMFolderTree::slotToggleSizeColumn()
+{
+  // activate the size-column and force the folders to be opened
+  toggleColumn(foldersize, true);
+}
+
+
+//-----------------------------------------------------------------------------
 bool KMFolderTree::eventFilter( QObject *o, QEvent *e )
 {
   if ( e->type() == QEvent::MouseButtonPress &&
@@ -1775,10 +1728,10 @@
     return;
   KMFolderTreeItem* fti = static_cast<KMFolderTreeItem*>(currentItem());
   KMFolder* folder = fti->folder();
-  if (folder && folder->folderType() == KMFolderTypeImap)
-  {
-    KMAccount* acct = static_cast<KMFolderImap*>(folder->storage())->account();
-    kmkernel->acctMgr()->singleCheckMail(acct, true);
+  if (folder && folder->storage() ) {
+      if ( KMAccount* acct = folder->storage()->account() ) {
+         kmkernel->acctMgr()->singleCheckMail(acct, true);
+      }
   }
 }
 
@@ -2147,4 +2100,20 @@
     paste->setEnabled( true );
 }
 
+void KMFolderTree::slotAddToFavorites()
+{
+  QValueList<QGuardedPtr<KMFolder> > folders = selectedFolders();
+  KMail::FavoriteFolderView *favView = mMainWidget->favoriteFolderView();
+  assert( favView );
+  for ( QValueList<QGuardedPtr<KMFolder> >::ConstIterator it = folders.constBegin(); it != folders.constEnd(); ++it )
+    favView->addFolder( *it );
+}
+
+void KMFolderTree::slotUnhideLocalInbox()
+{
+  disconnect( kmkernel->inboxFolder(), SIGNAL(msgAdded(KMFolder*,Q_UINT32)),
+              this, SLOT(slotUnhideLocalInbox()) );
+  reload();
+}
+
 #include "kmfoldertree.moc"
Index: kmail/scalix.cpp
===================================================================
--- kmail/scalix.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/scalix.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,104 @@
+/*
+ *   This file is part of KMail.
+ *
+ *   Copyright (C) 2007 Trolltech ASA. All rights reserved.
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 2 of the License, or
+ *   (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#include <qmap.h>
+#include <qstringlist.h>
+
+#include "scalix.h"
+
+#include "kmfolder.h"
+#include "kmfolderdir.h"
+
+using namespace Scalix;
+
+FolderAttributeParser::FolderAttributeParser( const QString &attribute )
+{
+  QStringList parts = QStringList::split( ",", attribute, false );
+
+  for ( uint i = 0; i < parts.count(); ++i ) {
+    if ( parts[i].startsWith( "\\X-SpecialFolder=" ) )
+      mFolderName = parts[i].mid( 17 );
+    else if ( parts[i].startsWith( "\\X-FolderClass=" ) )
+      mFolderClass = parts[i].mid( 15 );
+  }
+}
+
+QString FolderAttributeParser::folderClass() const
+{
+  return mFolderClass;
+}
+
+QString FolderAttributeParser::folderName() const
+{
+  return mFolderName;
+}
+
+KMFolder* Utils::findStandardResourceFolder( KMFolderDir* folderParentDir,
+                                             KMail::FolderContentsType contentsType,
+                                             const QStringList &attributes )
+{
+  QMap<int, QString> typeMap;
+  typeMap.insert( KMail::ContentsTypeCalendar, "IPF.Appointment" );
+  typeMap.insert( KMail::ContentsTypeContact, "IPF.Contact" );
+  typeMap.insert( KMail::ContentsTypeNote, "IPF.StickyNote" );
+  typeMap.insert( KMail::ContentsTypeTask, "IPF.Task" );
+
+  if ( !typeMap.contains( contentsType ) )
+    return 0;
+
+  for ( uint i = 0; i < attributes.count(); ++i ) {
+    FolderAttributeParser parser( attributes[ i ] );
+    if ( parser.folderClass() == typeMap[ contentsType ] ) {
+      KMFolderNode* node = folderParentDir->hasNamedFolder( parser.folderName() );
+      if ( node && !node->isDir() )
+        return static_cast<KMFolder*>( node );
+    }
+  }
+
+  return 0;
+}
+
+KMail::FolderContentsType Utils::scalixIdToContentsType( const QString &name )
+{
+  if ( name == "IPF.Appointment" )
+    return KMail::ContentsTypeCalendar;
+  else if ( name == "IPF.Contact" )
+    return KMail::ContentsTypeContact;
+  else if ( name == "IPF.StickyNote" )
+    return KMail::ContentsTypeNote;
+  else if ( name == "IPF.Task" )
+    return KMail::ContentsTypeTask;
+  else
+    return KMail::ContentsTypeMail;
+}
+
+QString Utils::contentsTypeToScalixId( KMail::FolderContentsType type )
+{
+  if ( type == KMail::ContentsTypeCalendar )
+    return "IPF.Appointment";
+  else if ( type == KMail::ContentsTypeContact )
+    return "IPF.Contact";
+  else if ( type == KMail::ContentsTypeNote )
+    return "IPF.StickyNote";
+  else if ( type == KMail::ContentsTypeTask )
+    return "IPF.Task";
+  else
+    return "IPF.Note";
+}
Index: kmail/kmtransport.cpp
===================================================================
--- kmail/kmtransport.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmtransport.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -54,7 +54,7 @@
 {
   name = i18n("Unnamed");
   port = "25";
-  auth = FALSE;
+  auth = false;
   specifyHostname = false;
 }
 
@@ -559,22 +559,22 @@
     mSmtp.localHostnameEdit->setText(mTransportInfo->localHostname);
 
     if (mTransportInfo->encryption == "TLS")
-      mSmtp.encryptionTLS->setChecked(TRUE);
+      mSmtp.encryptionTLS->setChecked(true);
     else if (mTransportInfo->encryption == "SSL")
-      mSmtp.encryptionSSL->setChecked(TRUE);
-    else mSmtp.encryptionNone->setChecked(TRUE);
+      mSmtp.encryptionSSL->setChecked(true);
+    else mSmtp.encryptionNone->setChecked(true);
 
     if (mTransportInfo->authType == "LOGIN")
-      mSmtp.authLogin->setChecked(TRUE);
+      mSmtp.authLogin->setChecked(true);
     else if (mTransportInfo->authType == "CRAM-MD5")
-      mSmtp.authCramMd5->setChecked(TRUE);
+      mSmtp.authCramMd5->setChecked(true);
     else if (mTransportInfo->authType == "DIGEST-MD5")
-      mSmtp.authDigestMd5->setChecked(TRUE);
+      mSmtp.authDigestMd5->setChecked(true);
     else if (mTransportInfo->authType == "NTLM")
-      mSmtp.authNTLM->setChecked(TRUE);
+      mSmtp.authNTLM->setChecked(true);
     else if (mTransportInfo->authType == "GSSAPI")
-      mSmtp.authGSSAPI->setChecked(TRUE);
-    else mSmtp.authPlain->setChecked(TRUE);
+      mSmtp.authGSSAPI->setChecked(true);
+    else mSmtp.authPlain->setChecked(true);
 
     slotRequiresAuthClicked();
     mSmtp.localHostnameEdit->setEnabled(mTransportInfo->specifyHostname);
@@ -727,7 +727,7 @@
            SLOT( slotSmtpCapabilities( const QStringList &,
                                        const QStringList &, const QString &,
                                        const QString &, const QString & ) ) );
-  mSmtp.checkCapabilities->setEnabled(FALSE);
+  mSmtp.checkCapabilities->setEnabled(false);
 }
 
 
Index: kmail/kmfoldermbox.h
===================================================================
--- kmail/kmfoldermbox.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmfoldermbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -111,6 +111,9 @@
 
   virtual IndexStatus indexStatus();
 
+  /**  reimp */
+  virtual Q_INT64 doFolderSize() const;
+
 protected:
   virtual FolderJob* doCreateJob( KMMessage *msg, FolderJob::JobType jt, KMFolder *folder,
                                   QString partSpecifier, const AttachmentStrategy *as ) const;
Index: kmail/kmail_config_security.desktop
===================================================================
--- kmail/kmail_config_security.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_config_security.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 Name[da]=Sikkerhed
 Name[de]=Sicherheit
 Name[el]=ŒëœÉœÜŒ¨ŒªŒµŒπŒ±
+Name[eo]=Sekureco
 Name[es]=Seguridad
 Name[et]=Turvalisus
 Name[eu]=Sekuritatea
@@ -77,6 +78,7 @@
 Comment[da]=Sikkerheds- & Privathedsindstillinger
 Comment[de]=Einstellungen zu Sicherheit und Privatsph√§re
 Comment[el]=Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ ŒëœÉœÜŒ¨ŒªŒµŒπŒ±œÇ & Œ†œÅŒøœÉœâœÄŒπŒ∫Œøœç Œ±œÄœåœÅœÅŒ∑œÑŒøœÖ
+Comment[eo]=Agordoj pri Sekureco kaj Privateco
 Comment[es]=Opciones de seguridad y privacidad
 Comment[et]=Turvalisus- ja privaatsusseadistused
 Comment[eu]=Sekuritate & pribakortasun ezarpenak
@@ -95,7 +97,7 @@
 Comment[lt]=Saugumo ir privatumo nustatymai
 Comment[mk]=–ü–æ—Å—Ç–∞–≤—É–≤–∞—ö–∞ –∑–∞ –±–µ–∑–±–µ–¥–Ω–æ—Å—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç
 Comment[ms]=Seting Keselamatan & Peribadi
-Comment[nb]=Sikkerhet og personvern-instillinger
+Comment[nb]=Sikkerhet og personvern-innstillinger
 Comment[nds]=Sekerheit- un Privaatrebeet-Instellen
 Comment[ne]=‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§∞ ‡§ó‡•ã‡§™‡•ç‡§Ø‡§§‡§æ ‡§∏‡•á‡§ü‡§ø‡§ô
 Comment[nl]=Beveiligings- en privacy-instellingen
Index: kmail/searchjob.cpp
===================================================================
--- kmail/searchjob.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/searchjob.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -89,11 +89,19 @@
   QDataStream stream( packedArgs, IO_WriteOnly );
   stream << (int) 'E' << url;
   KIO::SimpleJob *job = KIO::special( url, packedArgs, false );
-  KIO::Scheduler::assignJobToSlave(mAccount->slave(), job);
-  connect( job, SIGNAL(infoMessage(KIO::Job*,const QString&)),
-      SLOT(slotSearchData(KIO::Job*,const QString&)) );
-  connect( job, SIGNAL(result(KIO::Job *)),
-      SLOT(slotSearchResult(KIO::Job *)) );
+  if ( mFolder->imapPath() != QString( "/" ) )
+  {
+    KIO::Scheduler::assignJobToSlave( mAccount->slave(), job );
+    connect( job, SIGNAL( infoMessage( KIO::Job*, const QString& ) ),
+      SLOT( slotSearchData( KIO::Job*, const QString& ) ) );
+    connect( job, SIGNAL( result( KIO::Job * ) ),
+      SLOT( slotSearchResult( KIO::Job * ) ) );
+  }
+  else
+  { // for the "/ folder" of an imap account, searching blocks the kioslave
+    slotSearchData( job, QString() );
+    slotSearchResult( job );
+  }
 }
 
 //-----------------------------------------------------------------------------
Index: kmail/objecttreeparser.cpp
===================================================================
--- kmail/objecttreeparser.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/objecttreeparser.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,9 +53,6 @@
 #include "globalsettings.h"
 #include "util.h"
 
-#include "cryptplugwrapperlist.h"
-#include "cryptplugfactory.h"
-
 // other module headers
 #include <mimelib/enum.h>
 #include <mimelib/bodypart.h>
@@ -63,10 +60,19 @@
 #include <mimelib/text.h>
 
 #include <kleo/specialjob.h>
-#include <kleo/cryptobackend.h>
 #include <kleo/cryptobackendfactory.h>
+#include <kleo/decryptverifyjob.h>
+#include <kleo/verifydetachedjob.h>
+#include <kleo/verifyopaquejob.h>
+#include <kleo/keylistjob.h>
+#include <kleo/importjob.h>
+#include <kleo/dn.h>
 
 #include <gpgmepp/importresult.h>
+#include <gpgmepp/decryptionresult.h>
+#include <gpgmepp/key.h>
+#include <gpgmepp/keylistresult.h>
+#include <gpgme.h>
 
 #include <kpgpblock.h>
 #include <kpgp.h>
@@ -107,36 +113,35 @@
 #include <unistd.h>
 #include "chiasmuskeyselector.h"
 
-
 namespace KMail {
 
   // A small class that eases temporary CryptPlugWrapper changes:
-  class ObjectTreeParser::CryptPlugWrapperSaver {
+  class ObjectTreeParser::CryptoProtocolSaver {
     ObjectTreeParser * otp;
-    CryptPlugWrapper * wrapper;
+    const Kleo::CryptoBackend::Protocol * protocol;
   public:
-    CryptPlugWrapperSaver( ObjectTreeParser * _otp, CryptPlugWrapper * _w )
-      : otp( _otp ), wrapper( _otp ? _otp->cryptPlugWrapper() : 0 )
+    CryptoProtocolSaver( ObjectTreeParser * _otp, const Kleo::CryptoBackend::Protocol* _w )
+      : otp( _otp ), protocol( _otp ? _otp->cryptoProtocol() : 0 )
     {
       if ( otp )
-        otp->setCryptPlugWrapper( _w );
+        otp->setCryptoProtocol( _w );
     }
 
-    ~CryptPlugWrapperSaver() {
+    ~CryptoProtocolSaver() {
       if ( otp )
-        otp->setCryptPlugWrapper( wrapper );
+        otp->setCryptoProtocol( protocol );
     }
   };
 
 
-  ObjectTreeParser::ObjectTreeParser( KMReaderWin * reader, CryptPlugWrapper * wrapper,
+  ObjectTreeParser::ObjectTreeParser( KMReaderWin * reader, const Kleo::CryptoBackend::Protocol * protocol,
                                       bool showOnlyOneMimePart, bool keepEncryptions,
                                       bool includeSignatures,
                                       const AttachmentStrategy * strategy,
                                       HtmlWriter * htmlWriter,
                                       CSSHelper * cssHelper )
     : mReader( reader ),
-      mCryptPlugWrapper( wrapper ),
+      mCryptoProtocol( protocol ),
       mShowOnlyOneMimePart( showOnlyOneMimePart ),
       mKeepEncryptions( keepEncryptions ),
       mIncludeSignatures( includeSignatures ),
@@ -155,7 +160,7 @@
 
   ObjectTreeParser::ObjectTreeParser( const ObjectTreeParser & other )
     : mReader( other.mReader ),
-      mCryptPlugWrapper( other.cryptPlugWrapper() ),
+      mCryptoProtocol( other.cryptoProtocol() ),
       mShowOnlyOneMimePart( other.showOnlyOneMimePart() ),
       mKeepEncryptions( other.keepEncryptions() ),
       mIncludeSignatures( other.includeSignatures() ),
@@ -217,7 +222,7 @@
                     << "\n                    we cannot insert new lines into MimePartTree. :-(\n" << endl;
     }
     kdDebug(5006) << "\n     ----->  Now parsing the MimePartTree\n" << endl;
-    ObjectTreeParser otp( mReader, cryptPlugWrapper() );
+    ObjectTreeParser otp( mReader, cryptoProtocol() );
     otp.parseObjectTree( newNode );
     mRawReplyString += otp.rawReplyString();
     mTextualContent += otp.textualContent();
@@ -255,6 +260,8 @@
 
       ProcessResult processResult;
 
+      if ( mReader )
+        htmlWriter()->queue( QString::fromLatin1("<a name=\"att%1\"/>").arg( node->nodeId() ) );
       if ( const Interface::BodyPartFormatter * formatter
            = BodyPartFormatterFactory::instance()->createFor( node->typeString(), node->subTypeString() ) ) {
         PartNodeBodyPart part( *node, codecFor( node ) );
@@ -348,30 +355,45 @@
   //////////////////
   //////////////////
 
+  static int signatureToStatus( const GpgME::Signature &sig )
+  {
+    switch ( sig.status().code() ) {
+      case GPG_ERR_NO_ERROR:
+        return GPGME_SIG_STAT_GOOD;
+      case GPG_ERR_BAD_SIGNATURE:
+        return GPGME_SIG_STAT_BAD;
+      case GPG_ERR_NO_PUBKEY:
+        return GPGME_SIG_STAT_NOKEY;
+      case GPG_ERR_NO_DATA:
+        return GPGME_SIG_STAT_NOSIG;
+      case GPG_ERR_SIG_EXPIRED:
+        return GPGME_SIG_STAT_GOOD_EXP;
+      case GPG_ERR_KEY_EXPIRED:
+        return GPGME_SIG_STAT_GOOD_EXPKEY;
+      default:
+        return GPGME_SIG_STAT_ERROR;
+    }
+  }
+
   bool ObjectTreeParser::writeOpaqueOrMultipartSignedData( partNode* data,
                                                       partNode& sign,
                                                       const QString& fromAddress,
                                                       bool doCheck,
                                                       QCString* cleartextData,
-                                                      CryptPlug::SignatureMetaData* paramSigMeta,
+                                                      std::vector<GpgME::Signature> paramSignatures,
                                                       bool hideErrors )
   {
     bool bIsOpaqueSigned = false;
     enum { NO_PLUGIN, NOT_INITIALIZED, CANT_VERIFY_SIGNATURES }
       cryptPlugError = NO_PLUGIN;
 
-    CryptPlugWrapper* cryptPlug = cryptPlugWrapper();
-    if ( !cryptPlug )
-      cryptPlug = CryptPlugFactory::instance()->active();
+    const Kleo::CryptoBackend::Protocol* cryptProto = cryptoProtocol();
 
     QString cryptPlugLibName;
     QString cryptPlugDisplayName;
-    if ( cryptPlug ) {
-      cryptPlugLibName = cryptPlug->libName();
-      if ( cryptPlug == CryptPlugFactory::instance()->openpgp() )
-        cryptPlugDisplayName = "OpenPGP";
-      else if ( cryptPlug == CryptPlugFactory::instance()->smime() )
-        cryptPlugDisplayName = "S/MIME";
+    if ( cryptProto ) {
+      cryptPlugLibName = cryptProto->name();
+      cryptPlugDisplayName = cryptProto->displayName();
     }
 
 #ifndef NDEBUG
@@ -384,28 +406,15 @@
         kdDebug(5006) << "ObjectTreeParser::writeOpaqueOrMultipartSignedData: processing Opaque Signed data" << endl;
 #endif
 
-    if ( doCheck && cryptPlug ) {
+    if ( doCheck && cryptProto ) {
       kdDebug(5006) << "ObjectTreeParser::writeOpaqueOrMultipartSignedData: going to call CRYPTPLUG "
                     << cryptPlugLibName << endl;
-
-      // check whether the crypto plug-in is usable
-      if ( cryptPlug->initStatus( 0 ) != CryptPlugWrapper::InitStatus_Ok ) {
-        cryptPlugError = NOT_INITIALIZED;
-        cryptPlug = 0;
-      }
-      else if ( !cryptPlug->hasFeature( Feature_VerifySignatures ) ) {
-        cryptPlugError = CANT_VERIFY_SIGNATURES;
-        cryptPlug = 0;
-      }
     }
 
     QCString cleartext;
-    char* new_cleartext = 0;
     QByteArray signaturetext;
-    bool signatureIsBinary = false;
-    int signatureLen = 0;
 
-    if ( doCheck && cryptPlug ) {
+    if ( doCheck && cryptProto ) {
       if ( data ) {
         cleartext = KMail::Util::CString( data->dwPart()->AsString() );
 
@@ -423,100 +432,109 @@
                   cleartext.data(), cleartext.length() );
 
       signaturetext = sign.msgPart().bodyDecodedBinary();
-      QCString signatureStr( signaturetext, signaturetext.size() + 1 );
-      signatureIsBinary = (-1 == signatureStr.find("BEGIN SIGNED MESSAGE", 0, false) ) &&
-                          (-1 == signatureStr.find("BEGIN PGP SIGNED MESSAGE", 0, false) ) &&
-                          (-1 == signatureStr.find("BEGIN PGP MESSAGE", 0, false) );
-      signatureLen = signaturetext.size();
-
       dumpToFile( "dat_03_reader.sig", signaturetext.data(),
                   signaturetext.size() );
     }
 
-    CryptPlug::SignatureMetaData localSigMeta;
-    if ( doCheck ){
-      localSigMeta.status              = 0;
-      localSigMeta.extended_info       = 0;
-      localSigMeta.extended_info_count = 0;
-    }
-    CryptPlug::SignatureMetaData* sigMeta = doCheck ? &localSigMeta : paramSigMeta;
+    std::vector<GpgME::Signature> signatures;
+    if ( doCheck )
+      signatures = paramSignatures;
 
-    const char* cleartextP = cleartext;
     PartMetaData messagePart;
     messagePart.isSigned = true;
-    messagePart.technicalProblem = ( cryptPlug == 0 );
+    messagePart.technicalProblem = ( cryptProto == 0 );
     messagePart.isGoodSignature = false;
     messagePart.isEncrypted = false;
     messagePart.isDecryptable = false;
     messagePart.keyTrust = Kpgp::KPGP_VALIDITY_UNKNOWN;
     messagePart.status = i18n("Wrong Crypto Plug-In.");
+    messagePart.status_code = GPGME_SIG_STAT_NONE;
 
-    if ( !doCheck ||
-        ( cryptPlug &&
-          cryptPlug->checkMessageSignature( data
-                                            ? const_cast<char**>(&cleartextP)
-                                            : &new_cleartext,
-                                            signaturetext,
-                                            signatureIsBinary,
-                                            signatureLen,
-                                            sigMeta ) ) ) {
-      messagePart.isGoodSignature = true;
+    if ( doCheck && cryptProto ) {
+      GpgME::VerificationResult result;
+      if ( data ) { // detached
+        if ( Kleo::VerifyDetachedJob * const job = cryptProto->verifyDetachedJob() ) {
+          QByteArray plainData = cleartext;
+          plainData.resize( cleartext.size() - 1 );
+          result = job->exec( signaturetext, plainData );
+          messagePart.auditLog = job->auditLogAsHtml();
+        } else {
+          cryptPlugError = CANT_VERIFY_SIGNATURES;
+        }
+      } else { // opaque
+        if ( Kleo::VerifyOpaqueJob * const job = cryptProto->verifyOpaqueJob() ) {
+          QByteArray plainData;
+          result = job->exec( signaturetext, plainData );
+          cleartext = QCString( plainData.data(), plainData.size() + 1 );
+          messagePart.auditLog = job->auditLogAsHtml();
+        } else {
+          cryptPlugError = CANT_VERIFY_SIGNATURES;
+        }
+      }
+      signatures = result.signatures();
     }
 
     if ( doCheck )
       kdDebug(5006) << "\nObjectTreeParser::writeOpaqueOrMultipartSignedData: returned from CRYPTPLUG" << endl;
 
-    if ( sigMeta->status && *sigMeta->status )
-      messagePart.status = QString::fromUtf8( sigMeta->status );
-    messagePart.status_code = sigMeta->status_code;
+    // ### only one signature supported
+    if ( signatures.size() > 0 ) {
+      kdDebug(5006) << "\nObjectTreeParser::writeOpaqueOrMultipartSignedData: found signature" << endl;
+      GpgME::Signature signature = signatures[0];
 
-    // only one signature supported
-    if ( sigMeta->extended_info_count != 0 ) {
-      kdDebug(5006) << "\nObjectTreeParser::writeOpaqueOrMultipartSignedData: found extended sigMeta info" << endl;
+      messagePart.status_code = signatureToStatus( signature );
+      messagePart.status = QString::fromUtf8( signature.status().asString() );
+      for ( uint i = 1; i < signatures.size(); ++i ) {
+        if ( signatureToStatus( signatures[i] ) != messagePart.status_code ) {
+          messagePart.status_code = GPGME_SIG_STAT_DIFF;
+          messagePart.status = i18n("Different results for signatures");
+        }
+      }
+      if ( messagePart.status_code & GPGME_SIG_STAT_GOOD )
+        messagePart.isGoodSignature = true;
 
-      CryptPlug::SignatureMetaDataExtendedInfo& ext = sigMeta->extended_info[0];
+      // get key for this signature
+      Kleo::KeyListJob *job = cryptProto->keyListJob();
+      std::vector<GpgME::Key> keys;
+      GpgME::KeyListResult keyListRes = job->exec( QString::fromLatin1( signature.fingerprint() ), false, keys );
+      GpgME::Key key;
+      if ( keys.size() == 1 )
+        key = keys[0];
+      else if ( keys.size() > 1 )
+        assert( false ); // ### wtf, what should we do in this case??
 
       // save extended signature status flags
-      messagePart.sigStatusFlags = ext.sigStatusFlags;
+      messagePart.sigSummary = signature.summary();
 
-      if ( messagePart.status.isEmpty()
-          && ext.status_text
-          && *ext.status_text )
-        messagePart.status = QString::fromUtf8( ext.status_text );
-      if ( ext.keyid && *ext.keyid )
-        messagePart.keyId = ext.keyid;
+      if ( key.keyID() )
+        messagePart.keyId = key.keyID();
       if ( messagePart.keyId.isEmpty() )
-        messagePart.keyId = ext.fingerprint; // take fingerprint if no id found (e.g. for S/MIME)
+        messagePart.keyId = signature.fingerprint();
       // ### Ugh. We depend on two enums being in sync:
-      messagePart.keyTrust = (Kpgp::Validity)ext.validity;
-      if ( ext.userid && *ext.userid )
-        messagePart.signer = QString::fromUtf8( ext.userid );
-      for( int iMail = 0; iMail < ext.emailCount; ++iMail )
+      messagePart.keyTrust = (Kpgp::Validity)signature.validity();
+      if ( key.numUserIDs() > 0 && key.userID( 0 ).id() )
+        messagePart.signer = Kleo::DN( key.userID( 0 ).id() ).prettyDN();
+      for ( uint iMail = 0; iMail < key.numUserIDs(); ++iMail ) {
         // The following if /should/ always result in TRUE but we
         // won't trust implicitely the plugin that gave us these data.
-        if ( ext.emailList[ iMail ] && *ext.emailList[ iMail ] ) {
-          QString email = QString::fromUtf8( ext.emailList[ iMail ] );
+        if ( key.userID( iMail ).email() ) {
+          QString email = QString::fromUtf8( key.userID( iMail ).email() );
           // ### work around gpgme 0.3.x / cryptplug bug where the
           // ### email addresses are specified as angle-addr, not addr-spec:
           if ( email.startsWith( "<" ) && email.endsWith( ">" ) )
             email = email.mid( 1, email.length() - 2 );
-          messagePart.signerMailAddresses.append( email );
+          if ( !email.isEmpty() )
+            messagePart.signerMailAddresses.append( email );
         }
-      if ( ext.creation_time )
-        messagePart.creationTime = *ext.creation_time;
-      if (     70 > messagePart.creationTime.tm_year
-          || 200 < messagePart.creationTime.tm_year
-          ||   0 > messagePart.creationTime.tm_mon
-          ||  12 < messagePart.creationTime.tm_mon
-          ||   1 > messagePart.creationTime.tm_mday
-          ||  31 < messagePart.creationTime.tm_mday ) {
-        messagePart.creationTime.tm_year = 0;
-        messagePart.creationTime.tm_mon  = 1;
-        messagePart.creationTime.tm_mday = 1;
       }
+
+      if ( signature.creationTime() )
+        messagePart.creationTime.setTime_t( signature.creationTime() );
+      else
+        messagePart.creationTime = QDateTime();
       if ( messagePart.signer.isEmpty() ) {
-        if ( ext.name && *ext.name )
-          messagePart.signer = QString::fromUtf8( ext.name );
+        if ( key.numUserIDs() > 0 && key.userID( 0 ).name() )
+          messagePart.signer = Kleo::DN( key.userID( 0 ).name() ).prettyDN();
         if ( !messagePart.signerMailAddresses.empty() ) {
           if ( messagePart.signer.isEmpty() )
             messagePart.signer = messagePart.signerMailAddresses.front();
@@ -530,26 +548,20 @@
                     << "\n  signer: " << messagePart.signer << endl;
 
     } else {
-      messagePart.creationTime.tm_year = 0;
-      messagePart.creationTime.tm_mon  = 1;
-      messagePart.creationTime.tm_mday = 1;
+      messagePart.creationTime = QDateTime();
     }
 
     if ( !doCheck || !data ){
-      if ( cleartextData || new_cleartext ) {
+      if ( cleartextData || !cleartext.isEmpty() ) {
         if ( mReader )
           htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                                   cryptPlug,
+                                                   cryptProto,
                                                    fromAddress ) );
         bIsOpaqueSigned = true;
 
-        CryptPlugWrapperSaver cpws( this, cryptPlug );
-        insertAndParseNewChildNode( sign,
-                                    doCheck ? new_cleartext
-                                            : cleartextData->data(),
+        CryptoProtocolSaver cpws( this, cryptProto );
+        insertAndParseNewChildNode( sign, doCheck ? cleartext.data() : cleartextData->data(),
                                     "opaqued signed data" );
-        if ( doCheck )
-          free( new_cleartext );
 
         if ( mReader )
           htmlWriter()->queue( writeSigstatFooter( messagePart ) );
@@ -562,9 +574,9 @@
         txt.append( "</h2></b>" );
         txt.append( "<br>&nbsp;<br>" );
         txt.append( i18n( "Status: " ) );
-        if ( sigMeta->status && *sigMeta->status ) {
+        if ( !messagePart.status.isEmpty() ) {
           txt.append( "<i>" );
-          txt.append( sigMeta->status );
+          txt.append( messagePart.status );
           txt.append( "</i>" );
         }
         else
@@ -575,7 +587,7 @@
     }
     else {
       if ( mReader ) {
-        if ( !cryptPlug ) {
+        if ( !cryptProto ) {
           QString errorMsg;
           switch ( cryptPlugError ) {
           case NOT_INITIALIZED:
@@ -604,11 +616,11 @@
 
         if ( mReader )
           htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                                   cryptPlug,
+                                                   cryptProto,
                                                  fromAddress ) );
       }
 
-      ObjectTreeParser otp( mReader, cryptPlug, true );
+      ObjectTreeParser otp( mReader, cryptProto, true );
       otp.parseObjectTree( data );
       mRawReplyString += otp.rawReplyString();
       mTextualContent += otp.textualContent();
@@ -619,9 +631,6 @@
         htmlWriter()->queue( writeSigstatFooter( messagePart ) );
     }
 
-    if ( cryptPlug )
-      cryptPlug->freeSignatureMetaData( sigMeta );
-
     kdDebug(5006) << "\nObjectTreeParser::writeOpaqueOrMultipartSignedData: done, returning "
                   << ( bIsOpaqueSigned ? "TRUE" : "FALSE" ) << endl;
     return bIsOpaqueSigned;
@@ -631,48 +640,50 @@
 bool ObjectTreeParser::okDecryptMIME( partNode& data,
                                       QCString& decryptedData,
                                       bool& signatureFound,
-                                      CryptPlug::SignatureMetaData& sigMeta,
+                                      std::vector<GpgME::Signature> &signatures,
                                       bool showWarning,
                                       bool& passphraseError,
-                                      QString& aErrorText )
+                                      bool& actuallyEncrypted,
+                                      QString& aErrorText,
+                                      QString& auditLog )
 {
   passphraseError = false;
   aErrorText = QString::null;
+  auditLog = QString::null;
   bool bDecryptionOk = false;
   enum { NO_PLUGIN, NOT_INITIALIZED, CANT_DECRYPT }
     cryptPlugError = NO_PLUGIN;
 
-  CryptPlugWrapper* cryptPlug = cryptPlugWrapper();
-  if ( !cryptPlug )
-    cryptPlug = CryptPlugFactory::instance()->active();
+  const Kleo::CryptoBackend::Protocol* cryptProto = cryptoProtocol();
 
   QString cryptPlugLibName;
-  if ( cryptPlug )
-    cryptPlugLibName = cryptPlug->libName();
+  if ( cryptProto )
+    cryptPlugLibName = cryptProto->name();
 
-  // check whether the crypto plug-in is usable
-  if ( cryptPlug ) {
-    if ( cryptPlug->initStatus( 0 ) != CryptPlugWrapper::InitStatus_Ok ) {
-      cryptPlugError = NOT_INITIALIZED;
-      cryptPlug = 0;
-    }
-    else if ( !cryptPlug->hasFeature( Feature_DecryptMessages ) ) {
-      cryptPlugError = CANT_DECRYPT;
-      cryptPlug = 0;
-    }
+  if ( mReader && !mReader->decryptMessage() ) {
+    QString iconName = KGlobal::instance()->iconLoader()->iconPath( "decrypted", KIcon::Small );
+    decryptedData = "<div style=\"font-size:large; text-align:center;"
+                      "padding-top:20pt;\">"
+                    + i18n("This message is encrypted.").utf8()
+                    + "</div>"
+                      "<div style=\"text-align:center; padding-bottom:20pt;\">"
+                      "<a href=\"kmail:decryptMessage\">"
+                      "<img src=\"" + iconName.utf8() + "\"/>"
+                    + i18n("Decrypt Message").utf8()
+                    + "</a></div>";
+    return false;
   }
 
-  if ( cryptPlug && !kmkernel->contextMenuShown() ) {
+  if ( cryptProto && !kmkernel->contextMenuShown() ) {
     QByteArray ciphertext( data.msgPart().bodyDecodedBinary() );
+#ifdef MARCS_DEBUG
     QCString cipherStr( ciphertext.data(), ciphertext.size() + 1 );
     bool cipherIsBinary = (-1 == cipherStr.find("BEGIN ENCRYPTED MESSAGE", 0, false) ) &&
                           (-1 == cipherStr.find("BEGIN PGP ENCRYPTED MESSAGE", 0, false) ) &&
                           (-1 == cipherStr.find("BEGIN PGP MESSAGE", 0, false) );
-    int cipherLen = ciphertext.size();
 
     dumpToFile( "dat_04_reader.encrypted", ciphertext.data(), ciphertext.size() );
 
-#ifdef MARCS_DEBUG
     QCString deb;
     deb =  "\n\nE N C R Y P T E D    D A T A = ";
     if ( cipherIsBinary )
@@ -687,47 +698,48 @@
 #endif
 
 
-
-    char* cleartext = 0;
-    const char* certificate = 0;
-
     kdDebug(5006) << "ObjectTreeParser::decryptMIME: going to call CRYPTPLUG "
                   << cryptPlugLibName << endl;
-    int errId = 0;
-    char* errTxt = 0;
     if ( mReader )
       emit mReader->noDrag(); // in case pineentry pops up, don't let kmheaders start a drag afterwards
-    bDecryptionOk = cryptPlug->decryptAndCheckMessage( ciphertext.data(),
-                                                       cipherIsBinary,
-                                                       cipherLen,
-                                                       &cleartext,
-                                                       certificate,
-                                                       &signatureFound,
-                                                       &sigMeta,
-                                                       &errId,
-                                                       &errTxt );
-    kdDebug(5006) << "ObjectTreeParser::decryptMIME: returned from CRYPTPLUG"
-                  << endl;
-    aErrorText = CryptPlugWrapper::errorIdToText( errId, passphraseError );
-    if ( bDecryptionOk )
-      decryptedData = cleartext;
-    else if ( mReader && showWarning ) {
-      decryptedData = "<div style=\"font-size:x-large; text-align:center;"
-                      "padding:20pt;\">"
-                    + i18n("Encrypted data not shown.").utf8()
-                    + "</div>";
-      if ( !passphraseError )
-        aErrorText = i18n("Crypto plug-in \"%1\" could not decrypt the data.")
-                       .arg( cryptPlugLibName )
-                   + "<br />"
-                   + i18n("Error: %1").arg( aErrorText );
+
+    Kleo::DecryptVerifyJob* job = cryptProto->decryptVerifyJob();
+    if ( !job ) {
+      cryptPlugError = CANT_DECRYPT;
+      cryptProto = 0;
+    } else {
+      QByteArray plainText;
+      const std::pair<GpgME::DecryptionResult,GpgME::VerificationResult> res = job->exec( ciphertext, plainText );
+      const GpgME::DecryptionResult & decryptResult = res.first;
+      const GpgME::VerificationResult & verifyResult = res.second;
+      signatureFound = verifyResult.signatures().size() > 0;
+      signatures = verifyResult.signatures();
+      bDecryptionOk = !decryptResult.error();
+      passphraseError =  decryptResult.error().isCanceled()
+        || decryptResult.error().code() == GPG_ERR_NO_SECKEY;
+      actuallyEncrypted = decryptResult.error().code() != GPG_ERR_NO_DATA;
+      aErrorText = QString::fromLocal8Bit( decryptResult.error().asString() );
+      auditLog = job->auditLogAsHtml();
+
+      kdDebug(5006) << "ObjectTreeParser::decryptMIME: returned from CRYPTPLUG"
+                    << endl;
+      if ( bDecryptionOk )
+        decryptedData = QCString( plainText.data(), plainText.size() + 1 );
+      else if ( mReader && showWarning ) {
+        decryptedData = "<div style=\"font-size:x-large; text-align:center;"
+                        "padding:20pt;\">"
+                      + i18n("Encrypted data not shown.").utf8()
+                      + "</div>";
+        if ( !passphraseError )
+          aErrorText = i18n("Crypto plug-in \"%1\" could not decrypt the data.")
+                        .arg( cryptPlugLibName )
+                    + "<br />"
+                    + i18n("Error: %1").arg( aErrorText );
+      }
     }
-    if ( errTxt )
-      free( errTxt );
-    if ( cleartext )
-      free( cleartext );
   }
-  else if ( !cryptPlug ) {
+
+  if ( !cryptProto ) {
     decryptedData = "<div style=\"text-align:center; padding:20pt;\">"
                   + i18n("Encrypted data not shown.").utf8()
                   + "</div>";
@@ -744,8 +756,7 @@
       aErrorText = i18n( "No appropriate crypto plug-in was found." );
       break;
     }
-  }
-  else {
+  } else if ( kmkernel->contextMenuShown() ) {
     // ### Workaround for bug 56693 (kmail freeze with the complete desktop
     // ### while pinentry-qt appears)
     QByteArray ciphertext( data.msgPart().bodyDecodedBinary() );
@@ -1127,16 +1138,20 @@
     // mimetype of "signature" (not required by the RFC, but practised
     // by all implementaions of security multiparts
 
-    CryptPlugWrapper * cpw =
-      CryptPlugFactory::instance()->createForProtocol( node->contentTypeParameter( "protocol" ) );
+    const QString contentType = node->contentTypeParameter( "protocol" ).lower();
+    const Kleo::CryptoBackend::Protocol *protocol = 0;
+    if ( contentType == "application/pkcs7-signature" || contentType == "application/x-pkcs7-signature" )
+      protocol = Kleo::CryptoBackendFactory::instance()->smime();
+    else if ( contentType == "application/pgp-signature" || contentType == "application/x-pgp-signature" )
+      protocol = Kleo::CryptoBackendFactory::instance()->openpgp();
 
-    if ( !cpw ) {
+    if ( !protocol ) {
       signature->setProcessed( true, true );
       stdChildHandling( signedData );
       return true;
     }
 
-    CryptPlugWrapperSaver saver( this, cpw );
+    CryptoProtocolSaver saver( this, protocol );
 
     node->setSignatureState( KMMsgFullySigned );
     writeOpaqueOrMultipartSignedData( signedData, *signature,
@@ -1159,7 +1174,7 @@
       return true;
     }
 
-    CryptPlugWrapper * useThisCryptPlug = 0;
+    const Kleo::CryptoBackend::Protocol * useThisCryptProto = 0;
 
     /*
       ATTENTION: This code is to be replaced by the new 'auto-detect' feature. --------------------------------------
@@ -1167,13 +1182,13 @@
     partNode * data = child->findType( DwMime::kTypeApplication,
                                        DwMime::kSubtypeOctetStream, false, true );
     if ( data ) {
-      useThisCryptPlug = KMail::CryptPlugFactory::instance()->openpgp();
+      useThisCryptProto = Kleo::CryptoBackendFactory::instance()->openpgp();
     }
     if ( !data ) {
       data = child->findType( DwMime::kTypeApplication,
                               DwMime::kSubtypePkcs7Mime, false, true );
       if ( data ) {
-        useThisCryptPlug = KMail::CryptPlugFactory::instance()->smime();
+        useThisCryptProto = Kleo::CryptoBackendFactory::instance()->smime();
       }
     }
     /*
@@ -1185,7 +1200,7 @@
       return true;
     }
 
-    CryptPlugWrapperSaver cpws( this, useThisCryptPlug );
+    CryptoProtocolSaver cpws( this, useThisCryptProto );
 
     if ( partNode * dataChild = data->firstChild() ) {
       kdDebug(5006) << "\n----->  Calling parseObjectTree( curNode->mChild )\n" << endl;
@@ -1199,19 +1214,19 @@
     node->setEncryptionState( KMMsgFullyEncrypted );
     QCString decryptedData;
     bool signatureFound;
-    CryptPlug::SignatureMetaData sigMeta;
-    sigMeta.status              = 0;
-    sigMeta.extended_info       = 0;
-    sigMeta.extended_info_count = 0;
+    std::vector<GpgME::Signature> signatures;
     bool passphraseError;
+    bool actuallyEncrypted = true;
 
     bool bOkDecrypt = okDecryptMIME( *data,
                                      decryptedData,
                                      signatureFound,
-                                     sigMeta,
+                                     signatures,
                                      true,
                                      passphraseError,
-                                     messagePart.errorText );
+                                     actuallyEncrypted,
+                                     messagePart.errorText,
+                                     messagePart.auditLog );
 
     // paint the frame
     if ( mReader ) {
@@ -1219,7 +1234,7 @@
       messagePart.isEncrypted = true;
       messagePart.isSigned = false;
       htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                               cryptPlugWrapper(),
+                                               cryptoProtocol(),
                                                node->trueFromAddress() ) );
     }
 
@@ -1241,7 +1256,7 @@
                                           node->trueFromAddress(),
                                           false,
                                           &decryptedData,
-                                          &sigMeta,
+                                          signatures,
                                           false );
         node->setSignatureState( KMMsgFullySigned );
       } else {
@@ -1273,7 +1288,7 @@
 
     if ( partNode * child = node->firstChild() ) {
       kdDebug(5006) << "\n----->  Calling parseObjectTree( curNode->mChild )\n" << endl;
-      ObjectTreeParser otp( mReader, cryptPlugWrapper() );
+      ObjectTreeParser otp( mReader, cryptoProtocol() );
       otp.parseObjectTree( child );
       mRawReplyString += otp.rawReplyString();
       mTextualContent += otp.textualContent();
@@ -1293,7 +1308,7 @@
         mReader->writeMessagePartToTempFile( &node->msgPart(),
                                             node->nodeId() );
       htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                               cryptPlugWrapper(),
+                                               cryptoProtocol(),
                                                node->trueFromAddress(),
                                                filename ) );
     }
@@ -1321,7 +1336,7 @@
   bool ObjectTreeParser::processApplicationOctetStreamSubtype( partNode * node, ProcessResult & result ) {
     if ( partNode * child = node->firstChild() ) {
       kdDebug(5006) << "\n----->  Calling parseObjectTree( curNode->mChild )\n" << endl;
-      ObjectTreeParser otp( mReader, cryptPlugWrapper() );
+      ObjectTreeParser otp( mReader, cryptoProtocol() );
       otp.parseObjectTree( child );
       mRawReplyString += otp.rawReplyString();
       mTextualContent += otp.textualContent();
@@ -1331,7 +1346,7 @@
       return true;
     }
 
-    CryptPlugWrapper* oldUseThisCryptPlug = cryptPlugWrapper();
+    const Kleo::CryptoBackend::Protocol* oldUseThisCryptPlug = cryptoProtocol();
     if (    node->parentNode()
             && DwMime::kTypeMultipart    == node->parentNode()->type()
             && DwMime::kSubtypeEncrypted == node->parentNode()->subType() ) {
@@ -1348,22 +1363,22 @@
           ATTENTION: This code is to be replaced by the planned 'auto-detect' feature.
         */
         PartMetaData messagePart;
-        setCryptPlugWrapper( KMail::CryptPlugFactory::instance()->openpgp() );
+        setCryptoProtocol( Kleo::CryptoBackendFactory::instance()->openpgp() );
         QCString decryptedData;
         bool signatureFound;
-        CryptPlug::SignatureMetaData sigMeta;
-        sigMeta.status              = 0;
-        sigMeta.extended_info       = 0;
-        sigMeta.extended_info_count = 0;
+        std::vector<GpgME::Signature> signatures;
         bool passphraseError;
+        bool actuallyEncrypted = true;
 
         bool bOkDecrypt = okDecryptMIME( *node,
                                          decryptedData,
                                          signatureFound,
-                                         sigMeta,
+                                         signatures,
                                          true,
                                          passphraseError,
-                                         messagePart.errorText );
+                                         actuallyEncrypted,
+                                         messagePart.errorText,
+                                         messagePart.auditLog );
 
         // paint the frame
         if ( mReader ) {
@@ -1371,7 +1386,7 @@
           messagePart.isEncrypted = true;
           messagePart.isSigned = false;
           htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                                   cryptPlugWrapper(),
+                                                   cryptoProtocol(),
                                                    node->trueFromAddress() ) );
         }
 
@@ -1394,14 +1409,14 @@
       }
       return true;
     }
-    setCryptPlugWrapper( oldUseThisCryptPlug );
+    setCryptoProtocol( oldUseThisCryptPlug );
     return false;
   }
 
   bool ObjectTreeParser::processApplicationPkcs7MimeSubtype( partNode * node, ProcessResult & result ) {
     if ( partNode * child = node->firstChild() ) {
       kdDebug(5006) << "\n----->  Calling parseObjectTree( curNode->mChild )\n" << endl;
-      ObjectTreeParser otp( mReader, cryptPlugWrapper() );
+      ObjectTreeParser otp( mReader, cryptoProtocol() );
       otp.parseObjectTree( child );
       mRawReplyString += otp.rawReplyString();
       mTextualContent += otp.textualContent();
@@ -1415,7 +1430,7 @@
     if ( !node->dwPart() || !node->dwPart()->hasHeaders() )
       return false;
 
-    CryptPlugWrapper * smimeCrypto = CryptPlugFactory::instance()->smime();
+    const Kleo::CryptoBackend::Protocol * smimeCrypto = Kleo::CryptoBackendFactory::instance()->smime();
 
     const QString smimeType = node->contentTypeParameter("smime-type").lower();
 
@@ -1430,8 +1445,8 @@
 
       const QByteArray certData = node->msgPart().bodyDecodedBinary();
 
-      const GpgME::ImportResult res
-        = smimeCrypto->importCertificate( certData.data(), certData.size() );
+      Kleo::ImportJob *import = smimeCrypto->importJob();
+      const GpgME::ImportResult res = import->exec( certData );
       if ( res.error() ) {
         htmlWriter()->queue( i18n( "Sorry, certificate could not be imported.<br>"
                                    "Reason: %1").arg( QString::fromLocal8Bit( res.error().asString() ) ) );
@@ -1473,8 +1488,9 @@
       htmlWriter()->queue( "<b>" + i18n( "Certificate import details:" ) + "</b><br>" );
       for ( std::vector<GpgME::Import>::const_iterator it = imports.begin() ; it != imports.end() ; ++it ) {
         if ( (*it).error() )
-          htmlWriter()->queue( i18n( "Failed: %1 (%2)" ).arg( (*it).fingerprint() )
-                               .arg( QString::fromLocal8Bit( (*it).error().asString() ) ) );
+          htmlWriter()->queue( i18n( "Failed: %1 (%2)" )
+                               .arg( (*it).fingerprint(),
+                                     QString::fromLocal8Bit( (*it).error().asString() ) ) );
         else if ( (*it).status() & ~GpgME::Import::ContainedSecretKey )
           if ( (*it).status() & GpgME::Import::ContainedSecretKey )
             htmlWriter()->queue( i18n( "New or changed: %1 (secret key available)" ).arg( (*it).fingerprint() ) );
@@ -1489,7 +1505,7 @@
 
     if ( !smimeCrypto )
       return false;
-    CryptPlugWrapperSaver cpws( this, smimeCrypto );
+    CryptoProtocolSaver cpws( this, smimeCrypto );
 
     bool isSigned      = smimeType == "signed-data";
     bool isEncrypted   = smimeType == "enveloped-data";
@@ -1513,19 +1529,19 @@
       messagePart.isEncrypted = true;
       messagePart.isSigned = false;
       bool signatureFound;
-      CryptPlug::SignatureMetaData sigMeta;
-      sigMeta.status              = 0;
-      sigMeta.extended_info       = 0;
-      sigMeta.extended_info_count = 0;
+      std::vector<GpgME::Signature> signatures;
       bool passphraseError;
+      bool actuallyEncrypted = true;
 
       if ( okDecryptMIME( *node,
                           decryptedData,
                           signatureFound,
-                          sigMeta,
+                          signatures,
                           false,
                           passphraseError,
-                          messagePart.errorText ) ) {
+                          actuallyEncrypted,
+                          messagePart.errorText,
+                          messagePart.auditLog ) ) {
         kdDebug(5006) << "pkcs7 mime  -  encryption found  -  enveloped (encrypted) data !" << endl;
         isEncrypted = true;
         node->setEncryptionState( KMMsgFullyEncrypted );
@@ -1534,7 +1550,7 @@
         messagePart.isDecryptable = true;
         if ( mReader )
           htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                                   cryptPlugWrapper(),
+                                                   cryptoProtocol(),
                                                    node->trueFromAddress() ) );
         insertAndParseNewChildNode( *node,
                                     &*decryptedData,
@@ -1542,8 +1558,11 @@
         if ( mReader )
           htmlWriter()->queue( writeSigstatFooter( messagePart ) );
       } else {
-
-        if ( passphraseError ) {
+          // decryption failed, which could be because the part was encrypted but
+          // decryption failed, or because we didn't know if it was encrypted, tried,
+          // and failed. If the message was not actually encrypted, we continue
+          // assuming it's signed
+        if ( passphraseError || ( smimeType.isEmpty() && actuallyEncrypted ) ) {
           isEncrypted = true;
           signTestNode = 0;
         }
@@ -1554,9 +1573,12 @@
           messagePart.isDecryptable = false;
           if ( mReader ) {
             htmlWriter()->queue( writeSigstatHeader( messagePart,
-                                                     cryptPlugWrapper(),
+                                                     cryptoProtocol(),
                                                      node->trueFromAddress() ) );
-            writePartIcon( &node->msgPart(), node->nodeId() );
+            if ( mReader->decryptMessage() )
+              writePartIcon( &node->msgPart(), node->nodeId() );
+            else
+              htmlWriter()->queue( QString::fromUtf8( decryptedData ) );
             htmlWriter()->queue( writeSigstatFooter( messagePart ) );
           }
         } else {
@@ -1579,7 +1601,7 @@
                                                         node->trueFromAddress(),
                                                         true,
                                                         0,
-                                                        0,
+                                                        std::vector<GpgME::Signature>(),
                                                         isEncrypted );
       if ( sigFound ) {
         if ( !isSigned ) {
@@ -1849,9 +1871,9 @@
 #define SIG_FRAME_COL_RED    -1
 #define SIG_FRAME_COL_YELLOW  0
 #define SIG_FRAME_COL_GREEN   1
-QString ObjectTreeParser::sigStatusToString( CryptPlugWrapper* cryptPlug,
+QString ObjectTreeParser::sigStatusToString( const Kleo::CryptoBackend::Protocol* cryptProto,
                                         int status_code,
-                                        CryptPlugWrapper::SigStatusFlags statusFlags,
+                                        GpgME::Signature::Summary summary,
                                         int& frameColor,
                                         bool& showKeyInfos )
 {
@@ -1860,8 +1882,8 @@
     // pending(khz): Implement usage of these for PGP sigs as well.
     showKeyInfos = true;
     QString result;
-    if( cryptPlug ) {
-        if( cryptPlug->protocol().lower() == "openpgp" ) {
+    if( cryptProto ) {
+        if( cryptProto == Kleo::CryptoBackendFactory::instance()->openpgp() ) {
             // process enum according to it's definition to be read in
             // GNU Privacy Guard CVS repository /gpgme/gpgme/gpgme.h
             switch( status_code ) {
@@ -1899,18 +1921,18 @@
                 break;
             }
         }
-        else if ( cryptPlug->protocol().lower() == "smime" ) {
+        else if ( cryptProto == Kleo::CryptoBackendFactory::instance()->smime() ) {
             // process status bits according to SigStatus_...
             // definitions in kdenetwork/libkdenetwork/cryptplug.h
 
-            if( CryptPlugWrapper::SigStatus_UNKNOWN == statusFlags ) {
+            if( summary == GpgME::Signature::None ) {
                 result = i18n("No status information available.");
                 frameColor = SIG_FRAME_COL_YELLOW;
                 showKeyInfos = false;
                 return result;
             }
 
-            if( CryptPlugWrapper::SigStatus_VALID & statusFlags ) {
+            if( summary & GpgME::Signature::Valid ) {
                 result = i18n("Good signature.");
                 // Note:
                 // Here we are work differently than KMail did before!
@@ -1930,36 +1952,36 @@
             // we assume green, test for yellow or red (in this order!)
             frameColor = SIG_FRAME_COL_GREEN;
             QString result2;
-            if( CryptPlugWrapper::SigStatus_KEY_EXPIRED & statusFlags ){
+            if( summary & GpgME::Signature::KeyExpired ){
                 // still is green!
                 result2 += i18n("One key has expired.");
             }
-            if( CryptPlugWrapper::SigStatus_SIG_EXPIRED & statusFlags ){
+            if( summary & GpgME::Signature::SigExpired ){
                 // and still is green!
                 result2 += i18n("The signature has expired.");
             }
 
             // test for yellow:
-            if( CryptPlugWrapper::SigStatus_KEY_MISSING & statusFlags ) {
+            if( summary & GpgME::Signature::KeyMissing ) {
                 result2 += i18n("Unable to verify: key missing.");
                 // if the signature certificate is missing
                 // we cannot show infos on it
                 showKeyInfos = false;
                 frameColor = SIG_FRAME_COL_YELLOW;
             }
-            if( CryptPlugWrapper::SigStatus_CRL_MISSING & statusFlags ){
+            if( summary & GpgME::Signature::CrlMissing ){
                 result2 += i18n("CRL not available.");
                 frameColor = SIG_FRAME_COL_YELLOW;
             }
-            if( CryptPlugWrapper::SigStatus_CRL_TOO_OLD & statusFlags ){
+            if( summary & GpgME::Signature::CrlTooOld ){
                 result2 += i18n("Available CRL is too old.");
                 frameColor = SIG_FRAME_COL_YELLOW;
             }
-            if( CryptPlugWrapper::SigStatus_BAD_POLICY & statusFlags ){
+            if( summary & GpgME::Signature::BadPolicy ){
                 result2 += i18n("A policy was not met.");
                 frameColor = SIG_FRAME_COL_YELLOW;
             }
-            if( CryptPlugWrapper::SigStatus_SYS_ERROR & statusFlags ){
+            if( summary & GpgME::Signature::SysError ){
                 result2 += i18n("A system error occurred.");
                 // if a system error occurred
                 // we cannot trust any information
@@ -1967,23 +1989,14 @@
                 showKeyInfos = false;
                 frameColor = SIG_FRAME_COL_YELLOW;
             }
-            if( CryptPlugWrapper::SigStatus_NUMERICAL_CODE & statusFlags ) {
-                result2 += i18n("Internal system error #%1 occurred.")
-                        .arg( statusFlags - CryptPlugWrapper::SigStatus_NUMERICAL_CODE );
-                // if an unsupported internal error occurred
-                // we cannot trust any information
-                // that was given back by the plug-in
-                showKeyInfos = false;
-                frameColor = SIG_FRAME_COL_YELLOW;
-            }
 
             // test for red:
-            if( CryptPlugWrapper::SigStatus_KEY_REVOKED & statusFlags ){
+            if( summary & GpgME::Signature::KeyRevoked ){
                 // this is red!
                 result2 += i18n("One key has been revoked.");
                 frameColor = SIG_FRAME_COL_RED;
             }
-            if( CryptPlugWrapper::SigStatus_RED & statusFlags ) {
+            if( summary & GpgME::Signature::Red ) {
                 if( result2.isEmpty() )
                     // Note:
                     // Here we are work differently than KMail did before!
@@ -2027,15 +2040,77 @@
 }
 
 
+static QString writeSimpleSigstatHeader( const PartMetaData &block )
+{
+  QString html;
+  html += "<table cellspacing=\"0\" cellpadding=\"0\" width=\"100%\"><tr><td>";
+
+  if ( block.signClass == "signErr" ) {
+    html += i18n( "Invalid signature." );
+  } else if ( block.signClass == "signOkKeyBad" || block.signClass == "signWarn" ) {
+    html += i18n( "Not enough information to check signature validity." );
+  } else if ( block.signClass == "signOkKeyOk" ) {
+    QString addr;
+    if ( !block.signerMailAddresses.isEmpty() )
+      addr = block.signerMailAddresses.first();
+    QString name = addr;
+    if ( name.isEmpty() )
+      name = block.signer;
+    if ( addr.isEmpty() ) {
+      html += i18n( "Signature is valid." );
+    } else {
+      html += i18n( "Signed by <a href=\"mailto:%1\">%2</a>." ).arg( addr, name );
+    }
+  } else {
+    // should not happen
+    html += i18n( "Unknown signature state" );
+  }
+  html += "</td><td align=\"right\">";
+  html += "<a href=\"kmail:showSignatureDetails\">";
+  html += i18n( "Show Details" );
+  html += "</a></td></tr></table>";
+  return html;
+}
+
+static QString beginVerboseSigstatHeader()
+{
+  return "<table cellspacing=\"0\" cellpadding=\"0\" width=\"100%\"><tr><td rowspan=\"2\">";
+}
+
+static QString makeShowAuditLogLink( const QString & auditLog ) {
+  if ( auditLog.isEmpty() )
+    return i18n("No Audit Log available");
+
+  KURL url;
+  url.setProtocol( "kmail" );
+  url.setPath( "showAuditLog" );
+  url.addQueryItem( "log", auditLog );
+
+  return "<a href=\"" + url.htmlURL() + "\">" + i18n("Show Audit Log") + "</a>";
+}
+
+static QString endVerboseSigstatHeader( const PartMetaData & pmd )
+{
+  QString html;
+  html += "</td><td align=\"right\" valign=\"top\" nowrap=\"nowrap\">";
+  html += "<a href=\"kmail:hideSignatureDetails\">";
+  html += i18n( "Hide Details" );
+  html += "</a></td></tr>";
+  html += "<tr><td align=\"right\" valign=\"bottom\" nowrap=\"nowrap\">";
+  html += makeShowAuditLogLink( pmd.auditLog );
+  html += "</td></tr></table>";
+  return html;
+}
+
 QString ObjectTreeParser::writeSigstatHeader( PartMetaData & block,
-                                              CryptPlugWrapper * cryptPlug,
+                                              const Kleo::CryptoBackend::Protocol * cryptProto,
                                               const QString & fromAddress,
                                               const QString & filename )
 {
-    bool isSMIME = cryptPlug && cryptPlug->protocol().lower() == "smime";
+    const bool isSMIME = cryptProto && ( cryptProto == Kleo::CryptoBackendFactory::instance()->smime() );
     QString signer = block.signer;
 
-    QString htmlStr;
+    QString htmlStr, simpleHtmlStr;
     QString dir = ( QApplication::reverseLayout() ? "rtl" : "ltr" );
     QString cellPadding("cellpadding=\"1\"");
 
@@ -2065,6 +2140,7 @@
         }
         htmlStr += "</td></tr><tr class=\"encrB\"><td>";
     }
+    simpleHtmlStr = htmlStr;
 
     if( block.isSigned ) {
         QStringList& blockAddrs( block.signerMailAddresses );
@@ -2075,9 +2151,9 @@
         bool showKeyInfos;
         bool onlyShowKeyURL = false;
         bool cannotCheckSignature = true;
-        QString statusStr = sigStatusToString( cryptPlug,
+        QString statusStr = sigStatusToString( cryptProto,
                                                block.status_code,
-                                               block.sigStatusFlags,
+                                               block.sigSummary,
                                                frameColor,
                                                showKeyInfos );
         // if needed fallback to english status text
@@ -2108,14 +2184,14 @@
         if( isSMIME )
             startKeyHREF =
                 QString("<a href=\"kmail:showCertificate#%1 ### %2 ### %3\">")
-                .arg( cryptPlug->displayName() )
-                .arg( cryptPlug->libName() )
-                .arg( block.keyId );
+                .arg( cryptProto->displayName(),
+                      cryptProto->name(),
+                      block.keyId );
         QString keyWithWithoutURL
             = isSMIME
             ? QString("%1%2</a>")
-                .arg( startKeyHREF )
-                .arg( cannotCheckSignature ? i18n("[Details]") : ("0x" + block.keyId) )
+                .arg( startKeyHREF,
+                      cannotCheckSignature ? i18n("[Details]") : ("0x" + block.keyId) )
             : "0x" + QString::fromUtf8( block.keyId );
 
 
@@ -2157,8 +2233,8 @@
                         certificate = "certificate";
                     else
                         certificate = QString("%1%2</a>")
-                                      .arg( startKeyHREF )
-                                      .arg( "certificate" );
+                                      .arg( startKeyHREF,
+                                            "certificate" );
                     if( !blockAddrs.empty() ){
                         if( blockAddrs.grep(
                                 msgFrom,
@@ -2194,8 +2270,7 @@
                             "</u> " +
                             i18n("No mail address is stored in the %1 used for signing, "
                                  "so we cannot compare it to the sender's address %2.")
-                            .arg(certificate)
-                            .arg(msgFrom);
+                            .arg(certificate,msgFrom);
                     }
                     if( !greenCaseWarning.isEmpty() ) {
                         if( !statusStr.isEmpty() )
@@ -2205,9 +2280,12 @@
                     break;
             }
 
-            htmlStr += "<table cellspacing=\"1\" "+cellPadding+" "
+            QString frame = "<table cellspacing=\"1\" "+cellPadding+" "
                 "class=\"" + block.signClass + "\">"
                 "<tr class=\"" + block.signClass + "H\"><td dir=\"" + dir + "\">";
+            htmlStr += frame + beginVerboseSigstatHeader();
+            simpleHtmlStr += frame;
+            simpleHtmlStr += writeSimpleSigstatHeader( block );
             if( block.technicalProblem ) {
                 htmlStr += block.errorText;
             }
@@ -2235,20 +2313,16 @@
                             htmlStr += i18n( "Message was signed by %1." )
                                     .arg( signer );
                     } else {
-                        bool dateOK = ( 0 < block.creationTime.tm_year &&
-                                        block.creationTime.tm_year < 3000 );
-                        QDateTime created;
-                        if ( dateOK )
-                          created.setTime_t( mktime(&block.creationTime) );
-                        if( dateOK && created.isValid() ) {
+                        QDateTime created = block.creationTime;
+                        if( created.isValid() ) {
                             if( signer.isEmpty() ) {
                                 if( onlyShowKeyURL )
                                     htmlStr += i18n( "Message was signed with key %1." )
                                                 .arg( keyWithWithoutURL );
                                 else
                                     htmlStr += i18n( "Message was signed on %1 with key %2." )
-                                                .arg( KGlobal::locale()->formatDateTime( created ) )
-                                                .arg( keyWithWithoutURL );
+                                                .arg( KGlobal::locale()->formatDateTime( created ),
+                                                      keyWithWithoutURL );
                             }
                             else {
                                 if( onlyShowKeyURL )
@@ -2256,9 +2330,9 @@
                                             .arg( keyWithWithoutURL );
                                 else
                                     htmlStr += i18n( "Message was signed by %3 on %1 with key %2" )
-                                            .arg( KGlobal::locale()->formatDateTime( created ) )
-                                            .arg( keyWithWithoutURL )
-                                            .arg( signer );
+                                            .arg( KGlobal::locale()->formatDateTime( created ),
+                                                  keyWithWithoutURL,
+                                                  signer );
                             }
                         }
                         else {
@@ -2267,8 +2341,8 @@
                                         .arg( keyWithWithoutURL );
                             else
                                 htmlStr += i18n( "Message was signed by %2 with key %1." )
-                                        .arg( keyWithWithoutURL )
-                                        .arg( signer );
+                                        .arg( keyWithWithoutURL,
+                                              signer );
                         }
                     }
                 }
@@ -2281,7 +2355,9 @@
             } else {
                 htmlStr += statusStr;
             }
-            htmlStr += "</td></tr><tr class=\"" + block.signClass + "B\"><td>";
+            frame = "</td></tr><tr class=\"" + block.signClass + "B\"><td>";
+            htmlStr += endVerboseSigstatHeader( block ) + frame;
+            simpleHtmlStr += frame;
 
         } else {
 
@@ -2289,23 +2365,22 @@
 
             if( block.signer.isEmpty() || block.technicalProblem ) {
                 block.signClass = "signWarn";
-                htmlStr += "<table cellspacing=\"1\" "+cellPadding+" "
+                QString frame = "<table cellspacing=\"1\" "+cellPadding+" "
                     "class=\"" + block.signClass + "\">"
                     "<tr class=\"" + block.signClass + "H\"><td dir=\"" + dir + "\">";
+                htmlStr += frame + beginVerboseSigstatHeader();
+                simpleHtmlStr += frame;
+                simpleHtmlStr += writeSimpleSigstatHeader( block );
                 if( block.technicalProblem ) {
                     htmlStr += block.errorText;
                 }
                 else {
                   if( !block.keyId.isEmpty() ) {
-                    bool dateOK = ( 0 < block.creationTime.tm_year &&
-                                    block.creationTime.tm_year < 3000 );
-                    QDateTime created;
-                    if ( dateOK )
-                      created.setTime_t( mktime(&block.creationTime) );
-                    if( dateOK && created.isValid() )
+                    QDateTime created = block.creationTime;
+                    if ( created.isValid() )
                         htmlStr += i18n( "Message was signed on %1 with unknown key %2." )
-                                .arg( KGlobal::locale()->formatDateTime( created ) )
-                                .arg( keyWithWithoutURL );
+                                .arg( KGlobal::locale()->formatDateTime( created ),
+                                      keyWithWithoutURL );
                     else
                         htmlStr += i18n( "Message was signed with unknown key %1." )
                                 .arg( keyWithWithoutURL );
@@ -2323,7 +2398,9 @@
                     htmlStr += "</i>";
                   }
                 }
-                htmlStr += "</td></tr><tr class=\"" + block.signClass + "B\"><td>";
+                frame = "</td></tr><tr class=\"" + block.signClass + "B\"><td>";
+                htmlStr += endVerboseSigstatHeader( block ) + frame;
+                simpleHtmlStr += frame;
             }
             else
             {
@@ -2336,13 +2413,16 @@
                         block.signClass = "signOkKeyBad";
                     else
                         block.signClass = "signOkKeyOk";
-                    htmlStr += "<table cellspacing=\"1\" "+cellPadding+" "
+                    QString frame = "<table cellspacing=\"1\" "+cellPadding+" "
                         "class=\"" + block.signClass + "\">"
                         "<tr class=\"" + block.signClass + "H\"><td dir=\"" + dir + "\">";
+                    htmlStr += frame + beginVerboseSigstatHeader();
+                    simpleHtmlStr += frame;
+                    simpleHtmlStr += writeSimpleSigstatHeader( block );
                     if( !block.keyId.isEmpty() )
                         htmlStr += i18n( "Message was signed by %2 (Key ID: %1)." )
-                                   .arg( keyWithWithoutURL )
-                                   .arg( signer );
+                                   .arg( keyWithWithoutURL,
+                                         signer );
                     else
                         htmlStr += i18n( "Message was signed by %1." ).arg( signer );
                     htmlStr += "<br />";
@@ -2369,31 +2449,40 @@
                         htmlStr += i18n( "The signature is valid, but the key is "
                                 "untrusted." );
                     }
-                    htmlStr += "</td></tr>"
+                    frame = "</td></tr>"
                         "<tr class=\"" + block.signClass + "B\"><td>";
+                    htmlStr += endVerboseSigstatHeader( block ) + frame;
+                    simpleHtmlStr += frame;
                 }
                 else
                 {
                     block.signClass = "signErr";
-                    htmlStr += "<table cellspacing=\"1\" "+cellPadding+" "
+                    QString frame = "<table cellspacing=\"1\" "+cellPadding+" "
                         "class=\"" + block.signClass + "\">"
                         "<tr class=\"" + block.signClass + "H\"><td dir=\"" + dir + "\">";
+                    htmlStr += frame + beginVerboseSigstatHeader();
+                    simpleHtmlStr += frame;
+                    simpleHtmlStr += writeSimpleSigstatHeader( block );
                     if( !block.keyId.isEmpty() )
                         htmlStr += i18n( "Message was signed by %2 (Key ID: %1)." )
-                        .arg( keyWithWithoutURL )
-                        .arg( signer );
+                        .arg( keyWithWithoutURL,
+                              signer );
                     else
                         htmlStr += i18n( "Message was signed by %1." ).arg( signer );
                     htmlStr += "<br />";
                     htmlStr += i18n("Warning: The signature is bad.");
-                    htmlStr += "</td></tr>"
+                    frame = "</td></tr>"
                         "<tr class=\"" + block.signClass + "B\"><td>";
+                    htmlStr += endVerboseSigstatHeader( block ) + frame;
+                    simpleHtmlStr += frame;
                 }
             }
         }
     }
 
-    return htmlStr;
+    if ( mReader->showSignatureDetails() )
+      return htmlStr;
+    return simpleHtmlStr;
 }
 
 QString ObjectTreeParser::writeSigstatFooter( PartMetaData& block )
Index: kmail/kmail_config_accounts.desktop
===================================================================
--- kmail/kmail_config_accounts.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmail_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 Name[da]=Konti
 Name[de]=Zug√§nge
 Name[el]=ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøŒØ
+Name[eo]=Kontoj
 Name[es]=Cuentas
 Name[et]=Kontod
 Name[eu]=Kontuak
@@ -76,6 +77,7 @@
 Comment[da]=Ops√¶tning til at sende og modtage breve
 Comment[de]=Einstellungen zum Senden und Empfangen von Nachrichten
 Comment[el]=Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ Œ≥ŒπŒ± Œ±œÄŒøœÉœÑŒøŒªŒÆ Œ∫Œ±Œπ ŒªŒÆœàŒ∑ ŒºŒ∑ŒΩœÖŒºŒ¨œÑœâŒΩ
+Comment[eo]=Agordo por sendi kaj ricevi mesaƒùojn
 Comment[es]=Configuraci√≥n para enviar y recibir mensajes
 Comment[et]=Kirjade saatmise ja saamise seadistused
 Comment[eu]=Mezuak bidali eta jasotzeko konfigurazioa
Index: kmail/kmsender.cpp
===================================================================
--- kmail/kmsender.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmsender.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -52,8 +52,8 @@
 {
   mPrecommand = 0;
   mSendProc = 0;
-  mSendProcStarted = FALSE;
-  mSendInProgress = FALSE;
+  mSendProcStarted = false;
+  mSendInProgress = false;
   mCurrentMsg = 0;
   mTransportInfo = new KMTransportInfo();
   readConfig();
@@ -70,7 +70,7 @@
 //-----------------------------------------------------------------------------
 KMSender::~KMSender()
 {
-  writeConfig(FALSE);
+  writeConfig(false);
   delete mSendProc;
   delete mPrecommand;
   delete mTransportInfo;
@@ -89,8 +89,8 @@
   QString str;
   KConfigGroup config(KMKernel::config(), SENDER_GROUP);
 
-  mSendImmediate = config.readBoolEntry("Immediate", TRUE);
-  mSendQuotedPrintable = config.readBoolEntry("Quoted-Printable", TRUE);
+  mSendImmediate = config.readBoolEntry("Immediate", true);
+  mSendQuotedPrintable = config.readBoolEntry("Quoted-Printable", true);
 }
 
 
@@ -130,7 +130,7 @@
   if(!aMsg)
       return false;
 
-  if (!settingsOk()) return FALSE;
+  if (!settingsOk()) return false;
 
   if (aMsg->to().isEmpty())
   {
@@ -161,12 +161,12 @@
 
   if (sendNow==-1) sendNow = mSendImmediate;
 
-  kmkernel->outboxFolder()->open("outbox");
-  const KMFolderCloser openOutbox( "outbox", kmkernel->outboxFolder() );
+  KMFolder * const outbox = kmkernel->outboxFolder();
+  const KMFolderOpener openOutbox( outbox, "outbox" );
 
   aMsg->setStatus(KMMsgStatusQueued);
 
-  if ( const int err = openOutbox.folder()->addMsg(aMsg) ) {
+  if ( const int err = outbox->addMsg(aMsg) ) {
     Q_UNUSED( err );
     KMessageBox::information(0,i18n("Cannot add message to outbox folder"));
     return false;
@@ -183,10 +183,10 @@
    * in this branch.
    * Note that the unencrypted mail will be lost if the mail remains in
    * the outbox across a restart anyhow, but that never worked, afaikt. */
-  const int idx = openOutbox.folder()->count() - 1;
+  const int idx = outbox->count() - 1;
   KMMessage * const unencryptedMsg = aMsg->unencryptedMsg();
-  openOutbox.folder()->unGetMsg( idx );
-  KMMessage * const tempMsg = openOutbox.folder()->getMsg( idx );
+  outbox->unGetMsg( idx );
+  KMMessage * const tempMsg = outbox->getMsg( idx );
   tempMsg->setUnencryptedMsg( unencryptedMsg );
 
   if ( !sendNow || mSendInProgress )
@@ -210,11 +210,11 @@
 //-----------------------------------------------------------------------------
 bool KMSender::doSendQueued( const QString &customTransport )
 {
-  if (!settingsOk()) return FALSE;
+  if (!settingsOk()) return false;
 
   if (mSendInProgress)
   {
-    return FALSE;
+    return false;
   }
 
   // open necessary folders
@@ -225,7 +225,7 @@
     // Nothing in the outbox. We are done.
     mOutboxFolder->close("dosendoutbox");
     mOutboxFolder = 0;
-    return TRUE;
+    return true;
   }
   mTotalBytes = 0;
   for( int i = 0 ; i<mTotalMessages ; ++i )
@@ -242,7 +242,7 @@
   // start sending the messages
   mCustomTransport = customTransport;
   doSendMsg();
-  return TRUE;
+  return true;
 }
 
 //-----------------------------------------------------------------------------
@@ -291,7 +291,7 @@
   KMFolder *sentFolder = 0, *imapSentFolder = 0;
   if (mCurrentMsg  && kmkernel->filterMgr())
   {
-    mCurrentMsg->setTransferInProgress( FALSE );
+    mCurrentMsg->setTransferInProgress( false );
     if( mCurrentMsg->hasUnencryptedMsg() ) {
       kdDebug(5006) << "KMSender::doSendMsg() post-processing: replace mCurrentMsg body by unencryptedMsg data" << endl;
       // delete all current body parts
@@ -460,7 +460,7 @@
     cleanup();
     return;
   }
-  mCurrentMsg->setTransferInProgress( TRUE );
+  mCurrentMsg->setTransferInProgress( true );
 
   // start the sender process or initialize communication
   if (!mSendInProgress)
@@ -474,7 +474,7 @@
     connect( mProgressItem, SIGNAL(progressItemCanceled(KPIM::ProgressItem*)),
              this, SLOT( slotAbortSend() ) );
     kapp->ref();
-    mSendInProgress = TRUE;
+    mSendInProgress = true;
   }
 
   QString msgTransport = mCustomTransport;
@@ -489,7 +489,7 @@
   if (!mSendProc || msgTransport != mMethodStr) {
     if (mSendProcStarted && mSendProc) {
       mSendProc->finish();
-      mSendProcStarted = FALSE;
+      mSendProcStarted = false;
     }
 
     mSendProc = createSendProcFromString(msgTransport);
@@ -590,7 +590,7 @@
 //-----------------------------------------------------------------------------
 void KMSender::doSendMsgAux()
 {
-  mSendProcStarted = TRUE;
+  mSendProcStarted = true;
 
   // start sending the current message
 
@@ -627,12 +627,12 @@
   kdDebug(5006) << k_funcinfo << endl;
   if (mSendProc && mSendProcStarted) mSendProc->finish();
   mSendProc = 0;
-  mSendProcStarted = FALSE;
+  mSendProcStarted = false;
   if (mSendInProgress) kapp->deref();
-  mSendInProgress = FALSE;
+  mSendInProgress = false;
   if (mCurrentMsg)
   {
-    mCurrentMsg->setTransferInProgress( FALSE );
+    mCurrentMsg->setTransferInProgress( false );
     mCurrentMsg = 0;
   }
   if ( mSentFolder ) {
@@ -796,7 +796,7 @@
     if (transport.startsWith("smtp://")) // should probably use KURL and SMTP_PROTOCOL
     {
       mTransportInfo->type = "smtp";
-      mTransportInfo->auth = FALSE;
+      mTransportInfo->auth = false;
       mTransportInfo->encryption = "NONE";
       QString serverport = transport.mid(7);
       int colon = serverport.find(':');
@@ -811,7 +811,7 @@
     if (transport.startsWith("smtps://"))  // should probably use KURL and SMTPS_PROTOCOL
     {
       mTransportInfo->type = "smtps";
-      mTransportInfo->auth = FALSE;
+      mTransportInfo->auth = false;
       mTransportInfo->encryption = "ssl";
       QString serverport = transport.mid(7);
       int colon = serverport.find(':');
@@ -859,7 +859,7 @@
     int index = -1;
     KMMsgDict::instance()->getLocation(msn, &folder, &index);
     if (folder && index != -1) {
-      folder->open("setstatus");
+      KMFolderOpener openFolder(folder, "setstatus");
       if ( status == KMMsgStatusDeleted ) {
         // Move the message to the trash folder
         KMDeleteMsgCommand *cmd =
@@ -868,7 +868,6 @@
       } else {
         folder->setStatus(index, status);
       }
-      folder->close("setstatus");
     } else {
       kdWarning(5006) << k_funcinfo << "Cannot update linked message, it could not be found!" << endl;
     }
@@ -889,16 +888,16 @@
 //-----------------------------------------------------------------------------
 void KMSendProc::reset()
 {
-  mSending = FALSE;
-  mSendOk = FALSE;
+  mSending = false;
+  mSendOk = false;
   mLastErrorMessage = QString::null;
 }
 
 //-----------------------------------------------------------------------------
 void KMSendProc::failed(const QString &aMsg)
 {
-  mSending = FALSE;
-  mSendOk = FALSE;
+  mSending = false;
+  mSendOk = false;
   mLastErrorMessage = aMsg;
 }
 
@@ -1091,19 +1090,19 @@
     if( (ti->user.isEmpty() || ti->passwd().isEmpty()) &&
       ti->authType != "GSSAPI" )
     {
-      bool b = FALSE;
+      bool b = false;
       int result;
 
       KCursorSaver idle(KBusyPtr::idle());
       QString passwd = ti->passwd();
       result = KIO::PasswordDialog::getNameAndPassword(ti->user, passwd,
 	&b, i18n("You need to supply a username and a password to use this "
-	     "SMTP server."), FALSE, QString::null, ti->name, QString::null);
+	     "SMTP server."), false, QString::null, ti->name, QString::null);
 
       if ( result != QDialog::Accepted )
       {
         abort();
-        return FALSE;
+        return false;
       }
       if (int id = KMTransportInfo::findTransport(ti->name)) {
         ti->setPasswd( passwd );
@@ -1162,7 +1161,7 @@
 void KMSendSMTP::cleanup() {
   if(mJob)
   {
-    mJob->kill(TRUE);
+    mJob->kill(true);
     mJob = 0;
     mSlave = 0;
   }
Index: kmail/kmversion.h
===================================================================
--- kmail/kmversion.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmail/kmversion.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -3,6 +3,6 @@
 #ifndef kmversion_h
 #define kmversion_h
 
-#define KMAIL_VERSION "1.9.7"
+#define KMAIL_VERSION "1.9.8"
 
 #endif /*kmversion_h*/
Index: kmail/snippetsettingsbase.ui
===================================================================
--- kmail/snippetsettingsbase.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kmail/snippetsettingsbase.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,184 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>SnippetSettingsBase</class>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>SnippetSettingsBase</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>574</width>
+            <height>398</height>
+        </rect>
+    </property>
+    <property name="caption">
+        <string>Snippet Settings</string>
+    </property>
+    <grid>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="QGroupBox" row="0" column="0">
+            <property name="name">
+                <cstring>groupBox1</cstring>
+            </property>
+            <property name="title">
+                <string>Tooltips</string>
+            </property>
+            <grid>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QCheckBox" row="0" column="0">
+                    <property name="name">
+                        <cstring>cbToolTip</cstring>
+                    </property>
+                    <property name="text">
+                        <string>Show snippet's text in &amp;tooltip</string>
+                    </property>
+                    <property name="checked">
+                        <bool>true</bool>
+                    </property>
+                    <property name="toolTip" stdset="0">
+                        <string>Decides if a tooltip should be shown containing text from the bookmarked line</string>
+                    </property>
+                </widget>
+            </grid>
+        </widget>
+        <spacer row="3" column="0">
+            <property name="name">
+                <cstring>spacer2</cstring>
+            </property>
+            <property name="orientation">
+                <enum>Vertical</enum>
+            </property>
+            <property name="sizeType">
+                <enum>Expanding</enum>
+            </property>
+            <property name="sizeHint">
+                <size>
+                    <width>20</width>
+                    <height>70</height>
+                </size>
+            </property>
+        </spacer>
+        <widget class="QButtonGroup" row="1" column="0">
+            <property name="name">
+                <cstring>buttonGroup1</cstring>
+            </property>
+            <property name="title">
+                <string>Variables</string>
+            </property>
+            <grid>
+                <property name="name">
+                    <cstring>unnamed</cstring>
+                </property>
+                <widget class="QButtonGroup" row="1" column="0">
+                    <property name="name">
+                        <cstring>btnGroup</cstring>
+                    </property>
+                    <property name="title">
+                        <string>Input Method for Variables</string>
+                    </property>
+                    <grid>
+                        <property name="name">
+                            <cstring>unnamed</cstring>
+                        </property>
+                        <widget class="QRadioButton" row="0" column="0">
+                            <property name="name">
+                                <cstring>rbSingle</cstring>
+                            </property>
+                            <property name="text">
+                                <string>Single dialog for each variable within a snippet</string>
+                            </property>
+                            <property name="accel">
+                                <string></string>
+                            </property>
+                            <property name="checked">
+                                <bool>true</bool>
+                            </property>
+                            <property name="toolTip" stdset="0">
+                                <string>An input dialog will be displayed for every variable within a snippet</string>
+                            </property>
+                        </widget>
+                        <widget class="QRadioButton" row="1" column="0">
+                            <property name="name">
+                                <cstring>rbAll</cstring>
+                            </property>
+                            <property name="text">
+                                <string>One dialog for all variables within a snippet</string>
+                            </property>
+                            <property name="accel">
+                                <string></string>
+                            </property>
+                            <property name="checked">
+                                <bool>false</bool>
+                            </property>
+                            <property name="toolTip" stdset="0">
+                                <string>A single dialog will be displayed where you can enter the values for all variables within a snippet</string>
+                            </property>
+                        </widget>
+                    </grid>
+                </widget>
+                <widget class="QLayoutWidget" row="0" column="0">
+                    <property name="name">
+                        <cstring>layout1</cstring>
+                    </property>
+                    <hbox>
+                        <property name="name">
+                            <cstring>unnamed</cstring>
+                        </property>
+                        <widget class="QLabel">
+                            <property name="name">
+                                <cstring>textLabel1</cstring>
+                            </property>
+                            <property name="text">
+                                <string>Delimiter:</string>
+                            </property>
+                            <property name="buddy" stdset="0">
+                                <cstring>kLineEdit1</cstring>
+                            </property>
+                        </widget>
+                        <widget class="KLineEdit">
+                            <property name="name">
+                                <cstring>leDelimiter</cstring>
+                            </property>
+                            <property name="maximumSize">
+                                <size>
+                                    <width>40</width>
+                                    <height>32767</height>
+                                </size>
+                            </property>
+                            <property name="maxLength">
+                                <number>1</number>
+                            </property>
+                        </widget>
+                        <spacer>
+                            <property name="name">
+                                <cstring>spacer3</cstring>
+                            </property>
+                            <property name="orientation">
+                                <enum>Horizontal</enum>
+                            </property>
+                            <property name="sizeType">
+                                <enum>Expanding</enum>
+                            </property>
+                            <property name="sizeHint">
+                                <size>
+                                    <width>40</width>
+                                    <height>20</height>
+                                </size>
+                            </property>
+                        </spacer>
+                    </hbox>
+                </widget>
+            </grid>
+        </widget>
+    </grid>
+</widget>
+<layoutdefaults spacing="6" margin="11"/>
+<includehints>
+    <includehint>klineedit.h</includehint>
+</includehints>
+</UI>
Index: networkstatus/networkstatus.h
===================================================================
--- networkstatus/networkstatus.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ networkstatus/networkstatus.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -71,7 +71,7 @@
 
 protected:
 	// QStringList networkUsers( const QString & networkName );
-	Network * networkForHost( const QString & host );
+	Network * networkForHost( const QString & host ) const;
 
 private:
 	class Private;
Index: networkstatus/networkstatus.desktop
===================================================================
--- networkstatus/networkstatus.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ networkstatus/networkstatus.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -9,6 +9,7 @@
 Name[da]=Netv√¶rkstatusd√¶mon
 Name[de]=√úberwachung des Netzwerkstatus
 Name[el]=ŒîŒ±ŒØŒºŒøŒΩŒ±œÇ Œ∫Œ±œÑŒ¨œÉœÑŒ±œÉŒ∑œÇ Œ¥ŒπŒ∫œÑœçŒøœÖ
+Name[eo]=Retstat-demono
 Name[es]=Daemon de estado de la red
 Name[et]=V√µrguoleku deemon
 Name[eu]=Sarearen egoera deabrua
Index: networkstatus/networkstatus.cpp
===================================================================
--- networkstatus/networkstatus.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ networkstatus/networkstatus.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -92,7 +92,7 @@
 	Network * p = networkForHost( host );
 	if ( !p )
 	{
-		kdDebug() << k_funcinfo << " no networks have status for host '" << host << "'" << endl;
+		//kdDebug() << k_funcinfo << " no networks have status for host '" << host << "'" << endl;
 		return (int)NetworkStatus::NoNetworks;
 	}
 	else
@@ -196,15 +196,15 @@
 /*
  * Determine the network to use for the supplied host
  */
-Network * NetworkStatusModule::networkForHost( const QString & host )
+Network * NetworkStatusModule::networkForHost( const QString & host ) const
 {
 	// return a null pointer if no networks are registered
 	if ( d->networks.isEmpty() )
 		return 0;
 	
-	NetworkList::iterator it = d->networks.begin();
+	NetworkList::const_iterator it = d->networks.begin();
 	Network * bestNetwork = *(it++);
-	NetworkList::iterator end = d->networks.end();
+	NetworkList::const_iterator end = d->networks.end();
  	for ( ; it != end; ++it )
 	{
 		if ( (*it)->reachabilityFor( host ) > bestNetwork->reachabilityFor( host ) )
Index: indexlib/compressed.cpp
===================================================================
--- indexlib/compressed.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ indexlib/compressed.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,6 +36,7 @@
 #include "format.h"
 #include <zlib.h>
 #include <cassert>
+#include <cstring>
 #include <iostream>
 
 namespace {
Index: indexlib/memvector.tcc
===================================================================
--- indexlib/memvector.tcc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ indexlib/memvector.tcc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,6 @@
 #include "format.h"
 #include "mmap_manager.h"
+#include <cstring>
 
 #include <cstring>
 
Index: knode/knode_config_identity.desktop
===================================================================
--- knode/knode_config_identity.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knode_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 Name[da]=Identitet
 Name[de]=Identit√§t
 Name[el]=Œ§Œ±œÖœÑœåœÑŒ∑œÑŒ±
+Name[eo]=Idento
 Name[es]=Identidad
 Name[et]=Identiteet
 Name[eu]=Identitatea
@@ -77,6 +78,7 @@
 Comment[da]=Personlig information
 Comment[de]=Pers√∂nliche Angaben
 Comment[el]=Œ†œÅŒøœÉœâœÄŒπŒ∫Œ≠œÇ œÄŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ
+Comment[eo]=Personaj Informoj
 Comment[es]=Informaci√≥n personal
 Comment[et]=Personaalne info
 Comment[eu]=Informazio pertsonala
Index: knode/knode_config_accounts.desktop
===================================================================
--- knode/knode_config_accounts.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knode_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 Name[da]=Konti
 Name[de]=Zug√§nge
 Name[el]=ŒõŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøŒØ
+Name[eo]=Kontoj
 Name[es]=Cuentas
 Name[et]=Kontod
 Name[eu]=Kontuak
Index: knode/knode_config_cleanup.desktop
===================================================================
--- knode/knode_config_cleanup.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knode_config_cleanup.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -21,6 +21,7 @@
 Name[da]=Oprydning
 Name[de]=Aufr√§umen
 Name[el]=ŒöŒ±Œ∏Œ±œÅŒπœÉŒºœåœÇ
+Name[eo]=Purigo
 Name[es]=Limpiar
 Name[et]=Puhastamine
 Name[eu]=Garbiketa
@@ -70,6 +71,7 @@
 Comment[da]=Bevarer diskplads
 Comment[de]=Plattenplatz bewahren
 Comment[el]=ŒîŒπŒ±œÜœçŒªŒ±ŒæŒ∑ œáœéœÅŒøœÖ œÉœÑŒø ŒîŒØœÉŒ∫Œø
+Comment[eo]=≈úpari diskspacon
 Comment[es]=Preservar el espacio de disco
 Comment[et]=Kettaruumi eest hoolitsemine
 Comment[eu]=Diskaren espazioa mantendu
Index: knode/Makefile.am
===================================================================
--- knode/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,7 +25,7 @@
 kcm_knode_la_LIBADD = libknodecommon.la $(LIB_KDECORE)
 knconfigpages.lo: smtpaccountwidget_base.h
 
-libknodecommon_la_LDFLAGS = -avoid-version -no-undefined $(all_libraries)
+libknodecommon_la_LDFLAGS = -version-info 3:0:0 -no-undefined $(all_libraries)
 libknodecommon_la_LIBADD = $(top_builddir)/libkmime/libkmime.la $(top_builddir)/libkpgp/libkpgp.la $(top_builddir)/libkdepim/libkdepim.la $(LIB_KSPELL) $(LIB_KABC) $(LIB_KFILE) $(LIB_KUTILS) $(LIBRESOLV) $(LIB_KHTML)
 libknodecommon_la_SOURCES =   knconfigmanager.cpp \
                   knconfig.cpp \
Index: knode/knconfig.cpp
===================================================================
--- knode/knconfig.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knconfig.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -611,6 +611,7 @@
   m_arkThreadReadCloseThread=conf->readBoolEntry("markThreadReadCloseThread", false);
   i_gnoreThreadGoNext=conf->readBoolEntry("ignoreThreadGoNext", false);
   i_gnoreThreadCloseThread=conf->readBoolEntry("ignoreThreadCloseThread", false);
+  mLeaveGroupMarkAsRead = conf->readBoolEntry( "leaveGroupMarkAsRead", false );
 }
 
 
@@ -634,6 +635,7 @@
   conf->writeEntry("markThreadReadCloseThread", m_arkThreadReadCloseThread);
   conf->writeEntry("ignoreThreadGoNext", i_gnoreThreadGoNext);
   conf->writeEntry("ignoreThreadCloseThread", i_gnoreThreadCloseThread);
+  conf->writeEntry("leaveGroupMarkAsRead=true", mLeaveGroupMarkAsRead );
   conf->sync();
   d_irty = false;
 }
Index: knode/knconfig.h
===================================================================
--- knode/knconfig.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knconfig.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -280,13 +280,15 @@
     bool markThreadReadCloseThread()const  { return m_arkThreadReadCloseThread; }
     bool ignoreThreadGoNext()const         { return i_gnoreThreadGoNext; }
     bool ignoreThreadCloseThread()const   { return i_gnoreThreadCloseThread; }
+    bool leaveGroupMarkAsRead() const    { return mLeaveGroupMarkAsRead; }
 
   protected:
     bool  m_arkAllReadGoNext,
           m_arkThreadReadGoNext,
           m_arkThreadReadCloseThread,
           i_gnoreThreadGoNext,
-          i_gnoreThreadCloseThread;
+          i_gnoreThreadCloseThread,
+          mLeaveGroupMarkAsRead;
 
 };
 
Index: knode/knmainwidget.cpp
===================================================================
--- knode/knmainwidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knode/knmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1067,7 +1067,9 @@
   h_drView->clear();
   slotArticleSelected(0);
 
-  // mark all articles in current group as not new
+  // mark all articles in current group as not new/read
+  if ( knGlobals.configManager()->readNewsNavigation()->leaveGroupMarkAsRead() )
+    a_rtManager->setAllRead( true );
   a_rtManager->setAllNotNew();
 
   if(i) {
Index: kioslaves/imap4/imapinfo.cc
===================================================================
--- kioslaves/imap4/imapinfo.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapinfo.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -220,6 +220,16 @@
       flags ^= Recent;
     else if (0 != entry.contains ("\\*"))
       flags ^= User;
+
+    // non standard kmail falgs
+    else if ( entry.contains( "KMAILFORWARDED" ) || entry.contains( "$FORWARDED" ) )
+      flags = flags | Forwarded;
+    else if ( entry.contains( "KMAILTODO" ) || entry.contains( "$TODO" ) )
+      flags = flags | Todo;
+    else if ( entry.contains( "KMAILWATCHED" ) || entry.contains( "$WATCHED" ) )
+      flags = flags | Watched;
+    else if ( entry.contains( "KMAILIGNORED" ) || entry.contains( "$IGNORED" ) )
+      flags = flags | Ignored;
   }
 
   return flags;
Index: kioslaves/imap4/imapparser.cc
===================================================================
--- kioslaves/imap4/imapparser.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapparser.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -129,7 +129,10 @@
            || command == "GETANNOTATION"
            || command == "NAMESPACE"
            || command == "GETQUOTAROOT"
-           || command == "GETQUOTA")
+           || command == "GETQUOTA"
+           || command == "X-GET-OTHER-USERS"
+           || command == "X-GET-DELEGATES"
+           || command == "X-GET-OUT-OF-OFFICE")
   {
     lastResults.clear ();
   }
@@ -377,8 +380,17 @@
     if (what[1] == 'K' && what.size() == 2)
     {
       parseResult (what, result);
+    } else if (qstrncmp(what, "OTHER-USER", 10) == 0) { // X-GET-OTHER-USER
+      parseOtherUser (result);
+    } else if (qstrncmp(what, "OUT-OF-OFFICE", 13) == 0) { // X-GET-OUT-OF-OFFICE
+      parseOutOfOffice (result);
     }
     break;
+  case 'D':
+    if (qstrncmp(what, "DELEGATE", 8) == 0) { // X-GET-DELEGATES
+      parseDelegate (result);
+    }
+    break;
 
   case 'P':                    // PREAUTH
     if (qstrncmp(what, "PREAUTH", what.size()) == 0)
@@ -454,7 +466,12 @@
     {
       parseQuota( result );
     }
-
+    break;
+  case 'X': // Custom command
+    {
+      parseCustom( result );
+    }
+    break;
   default:
     //better be a number
     {
@@ -774,6 +791,43 @@
   lastResults.append( roots.join(" ") );
 }
 
+void imapParser::parseCustom (parseString & result)
+{
+  int outlen = 1;
+  QCString word = parseLiteralC (result, false, false, &outlen);
+  lastResults.append( word );
+}
+
+void imapParser::parseOtherUser (parseString & result)
+{
+  lastResults.append( parseOneWordC( result ) );
+}
+
+void imapParser::parseDelegate (parseString & result)
+{
+  const QString email = parseOneWordC( result );
+
+  QStringList rights;
+  int outlen = 1;
+  while ( outlen && !result.isEmpty() ) {
+    QCString word = parseLiteralC( result, false, false, &outlen );
+    rights.append( word );
+  }
+
+  lastResults.append( email + ":" + rights.join( "," ) );
+}
+
+void imapParser::parseOutOfOffice (parseString & result)
+{
+  const QString state = parseOneWordC (result);
+  parseOneWordC (result); // skip encoding
+
+  int outlen = 1;
+  QCString msg = parseLiteralC (result, false, false, &outlen);
+
+  lastResults.append( state + "^" + QString::fromUtf8( msg ) );
+}
+
 void imapParser::parseMyRights (parseString & result)
 {
   parseOneWordC (result); // skip mailbox name
@@ -872,7 +926,7 @@
   inWords.pos++;
   skipWS (inWords);
 
-  retVal.setFullName(rfcDecoder::quoteIMAP(parseLiteralC(inWords)));
+  retVal.setFullName(parseLiteralC(inWords));
   retVal.setCommentRaw(parseLiteralC(inWords));
   retVal.setUser(parseLiteralC(inWords));
   retVal.setHost(parseLiteralC(inWords));
Index: kioslaves/imap4/imapinfo.h
===================================================================
--- kioslaves/imap4/imapinfo.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapinfo.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -40,7 +40,12 @@
     Deleted = 1 << 3,
     Draft = 1 << 4,
     Recent = 1 << 5,
-    User = 1 << 6
+    User = 1 << 6,
+    // non standard flags
+    Forwarded = 1 << 7,
+    Todo = 1 << 8,
+    Watched = 1 << 9,
+    Ignored = 1 << 10
   };
 
 
Index: kioslaves/imap4/imapparser.h
===================================================================
--- kioslaves/imap4/imapparser.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapparser.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -244,7 +244,7 @@
    * @param resultInfo The resultinfo from the command
    * @return success or failure
    */
-  bool clientAuthenticate (KIO::SlaveBase *slave, KIO::AuthInfo &ai, const QString & aFQDN, 
+  bool clientAuthenticate (KIO::SlaveBase *slave, KIO::AuthInfo &ai, const QString & aFQDN,
     const QString & aAuth, bool isSSL, QString & resultInfo);
 
   /**
@@ -294,6 +294,14 @@
   void parseQuotaRoot (parseString & result);
   /** @brief parse a QUOTA line */
   void parseQuota (parseString & result);
+  /** @brief parse a custom command line */
+  void parseCustom (parseString & result);
+  /** @brief parse a OTHER-USER line */
+  void parseOtherUser (parseString & result);
+  /** @brief parse a DELEGATE line */
+  void parseDelegate (parseString & result);
+  /** @brief parse a OUT-OF-OFFICE line */
+  void parseOutOfOffice (parseString & result);
 
   /**
    * parses the results of a fetch command
@@ -377,7 +385,7 @@
 
   /** extract the box,section,list type, uid, uidvalidity,info from an url */
   static void parseURL (const KURL & _url, QString & _box, QString & _section,
-                        QString & _type, QString & _uid, QString & _validity, 
+                        QString & _type, QString & _uid, QString & _validity,
                         QString & _info);
 
 
@@ -471,13 +479,13 @@
   /** @brief the results from search/acl commands */
   QStringList lastResults;
 
-  /** 
+  /**
    * @brief namespace prefix - delimiter association
-   * The namespace is cleaned before so that it does not contain the delimiter 
+   * The namespace is cleaned before so that it does not contain the delimiter
    */
   QMap<QString, QString> namespaceToDelimiter;
 
-  /** 
+  /**
    * @brief list of namespaces in the form: section=namespace=delimiter
    * section is 0 (personal), 1 (other users) or 2 (shared)
    */
Index: kioslaves/imap4/imap4.cc
===================================================================
--- kioslaves/imap4/imap4.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imap4.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1206,6 +1206,7 @@
  * AnnotateMore commands: data = 'M' + 'G'et/'S'et + URL + entry + command-dependent args
  * Search: data = 'E' + URL (KURL)
  * Quota commands: data = 'Q' + 'R'oot/'G'et/'S'et + URL + entry + command-dependent args
+ * Custom command: data = 'X' + 'N'ormal/'E'xtended + command + command-dependent args
  */
 void
 IMAP4Protocol::special (const QByteArray & aData)
@@ -1346,9 +1347,16 @@
     QString aBox, aSequence, aLType, aSection, aValidity, aDelimiter, aInfo;
     parseURL (_url, aBox, aSection, aLType, aSequence, aValidity, aDelimiter, aInfo);
     if (!assureBox(aBox, false)) return;
+
+    // make sure we only touch flags we know
+    QCString knownFlags = "\\SEEN \\ANSWERED \\FLAGGED \\DRAFT";
+    const imapInfo info = getSelected();
+    if ( info.permanentFlagsAvailable() && (info.permanentFlags() & imapInfo::User) ) {
+      knownFlags += " KMAILFORWARDED KMAILTODO KMAILWATCHED KMAILIGNORED $FORWARDED $TODO $WATCHED $IGNORED";
+    }
+
     imapCommand *cmd = doCommand (imapCommand::
-                                  clientStore (aSequence, "-FLAGS.SILENT",
-                                               "\\SEEN \\ANSWERED \\FLAGGED \\DRAFT"));
+                                  clientStore (aSequence, "-FLAGS.SILENT", knownFlags));
     if (cmd->result () != "OK")
     {
       completeQueue.removeRef (cmd);
@@ -1410,6 +1418,12 @@
     specialSearchCommand( stream );
     break;
   }
+  case 'X':
+  {
+    // custom command
+    specialCustomCommand( stream );
+    break;
+  }
   default:
     kdWarning(7116) << "Unknown command in special(): " << tmp << endl;
     error( ERR_UNSUPPORTED_ACTION, QString(QChar(tmp)) );
@@ -1548,6 +1562,85 @@
 }
 
 void
+IMAP4Protocol::specialCustomCommand( QDataStream& stream )
+{
+  kdDebug(7116) << "IMAP4Protocol::specialCustomCommand" << endl;
+
+  QString command, arguments;
+  int type;
+  stream >> type;
+  stream >> command >> arguments;
+
+  /**
+   * In 'normal' mode we send the command with all information in one go
+   * and retrieve the result.
+   */
+  if ( type == 'N' ) {
+    kdDebug(7116) << "IMAP4Protocol::specialCustomCommand: normal mode" << endl;
+    imapCommand *cmd = doCommand (imapCommand::clientCustom( command, arguments ));
+    if (cmd->result () != "OK")
+    {
+      error(ERR_SLAVE_DEFINED, i18n("Custom command %1:%2 "
+            "failed. The server returned: %3")
+          .arg(command)
+          .arg(arguments)
+          .arg(cmd->resultInfo()));
+      return;
+    }
+    completeQueue.removeRef(cmd);
+    QStringList lst = getResults();
+    kdDebug(7116) << "IMAP4Protocol::specialCustomCommand '" << command <<
+      ":" << arguments <<
+      "' returns " << lst << endl;
+    infoMessage( lst.join( " " ) );
+
+    finished();
+  } else
+  /**
+   * In 'extended' mode we send a first header and push the data of the request in
+   * streaming mode.
+   */
+  if ( type == 'E' ) {
+    kdDebug(7116) << "IMAP4Protocol::specialCustomCommand: extended mode" << endl;
+    imapCommand *cmd = sendCommand (imapCommand::clientCustom( command, QString() ));
+    while ( !parseLoop () );
+
+    // see if server is waiting
+    if (!cmd->isComplete () && !getContinuation ().isEmpty ())
+    {
+      const QByteArray buffer = arguments.utf8();
+
+      // send data to server
+      bool sendOk = (write (buffer.data (), buffer.size ()) == (ssize_t)buffer.size ());
+      processedSize( buffer.size() );
+
+      if ( !sendOk ) {
+        error ( ERR_CONNECTION_BROKEN, myHost );
+        completeQueue.removeRef ( cmd );
+        setState(ISTATE_CONNECT);
+        closeConnection();
+        return;
+      }
+    }
+    parseWriteLine ("");
+
+    do
+    {
+      while (!parseLoop ());
+    }
+    while (!cmd->isComplete ());
+
+    completeQueue.removeRef (cmd);
+
+    QStringList lst = getResults();
+    kdDebug(7116) << "IMAP4Protocol::specialCustomCommand: returns " << lst << endl;
+    infoMessage( lst.join( " " ) );
+
+    finished ();
+  }
+}
+
+void
 IMAP4Protocol::specialAnnotateMoreCommand( int command, QDataStream& stream )
 {
   // All commands start with the URL to the box
Index: kioslaves/imap4/imap4.h
===================================================================
--- kioslaves/imap4/imap4.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imap4.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -176,6 +176,9 @@
   /** Search current folder, the search string is passed as SECTION */
   void specialSearchCommand( QDataStream& );
 
+  /** Send a custom command to the server */
+  void specialCustomCommand( QDataStream& );
+
 private:
 
   // This method behaves like the above method but takes an already encoded url,
Index: kioslaves/imap4/imapcommand.cc
===================================================================
--- kioslaves/imap4/imapcommand.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapcommand.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -400,3 +400,9 @@
   return new imapCommand ("GETQUOTAROOT", parameter);
 }
 
+imapCommand *
+imapCommand::clientCustom( const QString& command, const QString& arguments )
+{
+  return new imapCommand (command, arguments);
+}
+
Index: kioslaves/imap4/imapcommand.h
===================================================================
--- kioslaves/imap4/imapcommand.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kioslaves/imap4/imapcommand.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -371,6 +371,14 @@
    */
   static imapCommand *clientGetQuotaroot ( const QString& box );
 
+  /**
+   * @brief Create a custom command
+   * @param command The custom command
+   * @param arguments The custom arguments
+   * @return a custom imapCommand
+   */
+  static imapCommand *clientCustom ( const QString& command, const QString& arguments );
+
 protected:
   QString aCommand;
   QString mId;
Index: libkdenetwork/gpgmepp/context.cpp
===================================================================
--- libkdenetwork/gpgmepp/context.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/context.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,6 +39,7 @@
 #include "util.h"
 
 #include <gpgme.h>
+#include <gpg-error.h>
 
 //#include <string>
 //using std::string;
@@ -431,9 +432,40 @@
     return d->lasterr = gpgme_op_decrypt_verify_start( d->ctx, cdp ? cdp->data : 0, pdp ? pdp->data : 0 );
   }
 
+#ifdef HAVE_GPGME_OP_GETAUDITLOG
+  unsigned int to_auditlog_flags( unsigned int flags ) {
+      unsigned int result = 0;
+      if ( flags & Context::HtmlAuditLog )
+          result |= GPGME_AUDITLOG_HTML;
+      if ( flags & Context::AuditLogWithHelp )
+          result |= GPGME_AUDITLOG_WITH_HELP;
+      return result;
+  }
+#endif // HAVE_GPGME_OP_GETAUDITLOG
 
 
+  Error Context::startGetAuditLog( Data & output, unsigned int flags ) {
+    d->lastop = Private::GetAuditLog;
+#ifdef HAVE_GPGME_OP_GETAUDITLOG
+    Data::Private * const odp = output.impl();
+    return Error( d->lasterr = gpgme_op_getauditlog_start( d->ctx, odp ? odp->data : 0, to_auditlog_flags( flags ) ) );
+#else
+    (void)output; (void)flags;
+    return Error( d->lasterr = gpg_error( GPG_ERR_NOT_IMPLEMENTED ) );
+#endif
+  }
 
+  Error Context::getAuditLog( Data & output, unsigned int flags ) {
+    d->lastop = Private::GetAuditLog;
+#ifdef HAVE_GPGME_OP_GETAUDITLOG
+    Data::Private * const odp = output.impl();
+    return Error( d->lasterr = gpgme_op_getauditlog( d->ctx, odp ? odp->data : 0, to_auditlog_flags( flags ) ) );
+#else
+    (void)output; (void)flags;
+    return Error( d->lasterr = gpg_error( GPG_ERR_NOT_IMPLEMENTED ) );
+#endif
+  }
+
   void Context::clearSigningKeys() {
     gpgme_signers_clear( d->ctx );
   }
@@ -619,3 +651,21 @@
   return gpgme_engine_check_version( p );
 }
 
+static const unsigned long supported_features = 0
+#ifdef HAVE_GPGME_KEYLIST_MODE_VALIDATE
+    | GpgME::ValidatingKeylistModeFeature
+#endif
+#ifdef HAVE_GPGME_CANCEL
+    | GpgME::CancelOperationFeature
+#endif
+#ifdef HAVE_GPGME_WRONG_KEY_USAGE
+    | GpgME::WrongKeyUsageFeature
+#endif
+#ifdef HAVE_GPGME_OP_GETAUDITLOG
+    | GpgME::AuditLogFeature
+#endif
+    ;
+
+bool GpgME::hasFeature( unsigned long features ) {
+    return features == ( features & supported_features );
+}
Index: libkdenetwork/gpgmepp/context_p.h
===================================================================
--- libkdenetwork/gpgmepp/context_p.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/context_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,7 +46,9 @@
 
       KeyGen    = 0x080,
       KeyList   = 0x100,
-      TrustList = 0x200 // gpgme_trustlist_result_t, but nevertheless...
+      TrustList = 0x200, // gpgme_trustlist_result_t, but nevertheless...
+
+      GetAuditLog = 0x1000 // no gpgme_getauditlog_result_t, but nevertheless...
     };
 
     Private( gpgme_ctx_t c=0 )
Index: libkdenetwork/gpgmepp/importresult.cpp
===================================================================
--- libkdenetwork/gpgmepp/importresult.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/importresult.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,8 +27,9 @@
 #include "result_p.h"
 
 #include <gpgme.h>
+#include <cstring>
 #include <cstdlib>
-#include <cstring>
+#include <cstdlib>
 
 class GpgME::ImportResult::Private : public GpgME::Shared {
 public:
Index: libkdenetwork/gpgmepp/configure.in.in
===================================================================
--- libkdenetwork/gpgmepp/configure.in.in	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/configure.in.in	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -152,6 +152,19 @@
 		AC_MSG_RESULT([no])
 	])
 
+	AC_MSG_CHECKING([if gpgme has gpgme_op_getauditlog])
+	AC_TRY_LINK([#include <gpgme.h>], [
+                gpgme_ctx_t ctx = 0;
+                gpgme_data_t data = 0;
+                unsigned int flags = 0;
+                gpgme_error_t e = gpgme_op_getauditlog( ctx, data, flags );
+	], [
+		AC_DEFINE(HAVE_GPGME_OP_GETAUDITLOG, 1, [Define to 1 if your gpgme supports gpgme_op_getauditlog])
+		AC_MSG_RESULT([yes])
+	], [
+		AC_MSG_RESULT([no])
+	])
+
 	CFLAGS="$kdepim_gpgmepp_save_cflags"
 	LIBS="$kdepim_gpgmepp_save_libs"
 	AC_LANG_RESTORE
Index: libkdenetwork/gpgmepp/callbacks.cpp
===================================================================
--- libkdenetwork/gpgmepp/callbacks.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/callbacks.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,7 +31,7 @@
 #include <cassert>
 #include <cerrno>
 #include <unistd.h>
-#include <stdlib.h>
+#include <cstdlib>
 #include <string.h>
 #include <cstdlib>
 
Index: libkdenetwork/gpgmepp/Makefile.am
===================================================================
--- libkdenetwork/gpgmepp/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,7 +46,7 @@
 #   (Interfaces added/removed/changed:  CURRENT++, REVISION=0)
 #   (Interfaces added:                  AGE++)
 #   (Interfaces removed/changed:        AGE=0)
-libgpgme___la_LDFLAGS = -no-undefined -version-info 2:0:2
+libgpgme___la_LDFLAGS = -no-undefined -version-info 3:0:3
 libgpgme___la_LIBADD = $(GPGME_LIBS)
 libgpgme___la_DEPENDENCIES = $(GPGME_LIBS_DEP)
 
Index: libkdenetwork/gpgmepp/context.h
===================================================================
--- libkdenetwork/gpgmepp/context.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/gpgmepp/context.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -250,6 +250,18 @@
 
     //
     //
+    // Audit Log
+    //
+    //
+    enum AuditLogFlags {
+        HtmlAuditLog = 1,
+        AuditLogWithHelp = 128
+    };
+    GpgME::Error startGetAuditLog( Data & output, unsigned int flags=0 );
+    GpgME::Error getAuditLog( Data & output, unsigned int flags=0 );
+
+    //
+    //
     // Run Control
     //
     //
@@ -287,6 +299,17 @@
 
   KDE_EXPORT GpgME::Error checkEngine( Context::Protocol proto );
 
+  enum Feature {
+      ValidatingKeylistModeFeature = 0x00000001,
+      CancelOperationFeature       = 0x00000002,
+      WrongKeyUsageFeature         = 0x00000004,
+
+      AuditLogFeature              = 0x00001000,
+
+      FeatureMaxValue              = 0x80000000
+  };
+  KDE_EXPORT bool hasFeature( unsigned long feature );
+
 } // namespace GpgME
 
 #endif // __GPGMEPP_CONTEXT_H__
Index: libkdenetwork/qgpgme/dataprovider.cpp
===================================================================
--- libkdenetwork/qgpgme/dataprovider.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdenetwork/qgpgme/dataprovider.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,12 +2,12 @@
    Copyright (C) 2004 Klar‰lvdalens Datakonsult AB
 
    This file is part of QGPGME.
- 
+
    QGPGME is free software; you can redistribute it and/or modify it
    under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.
- 
+
    QGPGME is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Index: doc/kmail/using-kmail.docbook
===================================================================
--- doc/kmail/using-kmail.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kmail/using-kmail.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,7 +31,7 @@
 may call them mailboxes). To select a folder, simply click on
 it. The messages contained in the folder will now appear in the Headers
 pane. The folder list can be displayed in both a short view, which takes up only
-a small portion of the left side of the screen, and a long view, which takes up the 
+a small portion of the left side of the screen, and a long view, which takes up the
 entire left side of the screen but is able to show more mailboxes. You can toggle
 between these two views under <guilabel>Appearance</guilabel>/<guilabel>Layout</guilabel>
 in the <menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure
@@ -68,18 +68,29 @@
 the preview pane. The placement of the preview pane as well as the placement
 of the structure viewer can be changed under <guilabel>Appearance</guilabel>/<guilabel>Layout</guilabel>
 in the <menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure
-&kmail;...</guimenuitem></menuchoice> dialog. Moreover, you can disable the 
+&kmail;...</guimenuitem></menuchoice> dialog. Moreover, you can disable the
 preview pane and you can choose when the message structure viewer should be
 shown.
 You can scroll through the message page-by-page
-using the <keycap>Page Up</keycap> and <keycap>Page down</keycap> keys, or 
+using the <keycap>Page Up</keycap> and <keycap>Page down</keycap> keys, or
 line-by-line using the <keycap>up arrow</keycap> and <keycap>down arrow</keycap>
-keys; you can also use <link linkend="keyboard-shortcuts">key shortcuts</link> to skip through 
+keys; you can also use <link linkend="keyboard-shortcuts">key shortcuts</link> to skip through
 your messages without having to use the mouse.</para>
 </listitem>
 </varlistentry>
+<varlistentry>
+<term>Font type and font size</term>
+<listitem>
+<para>Font type and font size buttons in main toolbar in the message reader window ( window that appears when an message is double clicked or enter is pressed on the message ) will change the font type or font size of the whole text of the email message in concern. This property is transient ( per email message ) and will be lost when the reader window is closed.</para>
+</listitem>
+</varlistentry>
+<varlistentry>
+<term>Delete Attachment</term>
+<listitem>
+<para>Right click on the attachment either in the message itself or in the message structure window, choose "Delete Attachment" to delete the attachement. Please note that deleting an attachment can invalidate any digital signature in the message.</para>
+</listitem>
+</varlistentry>
 </variablelist>
-
 </sect1>
 
 <sect1 id="keyboard-shortcuts">
@@ -98,7 +109,7 @@
 <tbody>
 <row>
 <entry><keycap>Space</keycap></entry>
-<entry>Scroll down in the current message or go to the next unread message if you are already 
+<entry>Scroll down in the current message or go to the next unread message if you are already
 at the bottom.</entry>
 </row>
 <row>
@@ -135,14 +146,14 @@
 </row>
 <row>
 <entry><keycombo action="simul">&Ctrl;<keycap>Left Arrow</keycap></keycombo></entry>
-<entry>Walk upwards in the list of folders. Use 
+<entry>Walk upwards in the list of folders. Use
 <keycombo action="simul">&Ctrl;<keycap>Space</keycap></keycombo> to actually
 enter the folder.</entry>
 <!-- TODO: or wait for timeout so the folder is selected? -->
 </row>
 <row>
 <entry><keycombo action="simul">&Ctrl;<keycap>Right Arrow</keycap></keycombo></entry>
-<entry>Walk downwards in the list of folders. Use 
+<entry>Walk downwards in the list of folders. Use
 <keycombo action="simul">&Ctrl;<keycap>Space</keycap></keycombo> to actually
 enter the folder.</entry>
 </row>
@@ -169,7 +180,7 @@
 <sect1 id="the-composer-window">
 <title>The Composer Window</title>
 
-<para>The composer window is used to write new messages; 
+<para>The composer window is used to write new messages;
 it can be invoked via <menuchoice><guimenu>Message</guimenu>
 <guimenuitem>New Message...</guimenuitem></menuchoice>
 menu or from the <guiicon>New Message</guiicon> icon on the main
@@ -193,14 +204,15 @@
 
 <para>When you start typing an address in the
 <guilabel>To:</guilabel>/<guilabel>CC:</guilabel>/<guilabel>BCC:</guilabel>
-fields, a popup will appear that offers matching addresses that have been used recently 
-and matching addresses from your address book; if you do not like the automatic 
-popup you can disable it by clicking with the &RMB; on the field and choosing 
+fields, a popup will appear that offers matching addresses that have been used recently
+and matching addresses from your address book. If you use multiple addressbooks, you can
+use the TAB key to select the first entry of the next addressbook in the list.
+If you do not like the automatic popup you can disable it by clicking with the &RMB; on the field and choosing
 a different completion mode.</para>
 
 <para>Whenever you want to add more than one
 recipient in one of the fields, use a comma to separate each address
-from the next one. 
+from the next one.
 <!-- fixme: there's now a setting for this: -->
 You may need to specify fully qualified addresses
 (&ie; <userinput>user@example.com</userinput>) even for local
@@ -221,7 +233,7 @@
  If you want to send an <link
 linkend="pgp-encrypt-your-messages">encrypted</link>
 or <link linkend="pgp-sign-your-messages">digitally signed</link> message, select the
-<guiicon>Sign Message</guiicon> or <guiicon>Encrypt 
+<guiicon>Sign Message</guiicon> or <guiicon>Encrypt
 Message</guiicon> icons in the toolbar. Moreover you can select the format that should be used to sign and/or encrypt the message. Depending on the
 installed encryption programs you can choose between:
 </para>
@@ -238,7 +250,7 @@
 <term><guilabel>Inline OpenPGP (deprecated)</guilabel></term>
 <listitem>
 <para>This format is outdated. If you use this format then only the
-message text will be signed and/or encrypted. <emphasis>Attachments will 
+message text will be signed and/or encrypted. <emphasis>Attachments will
 neither be signed nor encrypted.</emphasis> HTML messages cannot be signed
 with this format. You should only use this format
 if necessary, &ie; if you send messages to users of email clients that cannot
@@ -279,10 +291,10 @@
 allowed.</para>
 
 <para>In order to be able to create HTML messages you first have to enable
-the markup tools. To do this enable <guimenuitem>Formatting (HTML)</guimenuitem> in the <menuchoice><guimenu>Options</guimenu></menuchoice> menu. 
+the markup tools. To do this enable <guimenuitem>Formatting (HTML)</guimenuitem> in the <menuchoice><guimenu>Options</guimenu></menuchoice> menu.
 A toolbar with several tools to
 format the message will appear. Via the drop down box you can select between
-standard text and six different types of lists (three bulleted lists with 
+standard text and six different types of lists (three bulleted lists with
 different symbols and three numbered lists with different numbering).
 Moreover, you can select the font family, the font size, the font style (bold,
 italic, underlined) and the text color. Last but not least, you can select
@@ -305,7 +317,7 @@
 </listitem>
 <listitem>
 <para>Drag a file from the desktop or another folder into the
-composer window;</para> 
+composer window;</para>
 </listitem>
 <listitem>
 <para>Drag a message from &kmail;'s message list into the composer
@@ -330,7 +342,7 @@
 &MIME; type value may be wrong. You can then type in any &MIME; type or
 choose from the list of common &MIME; types. You can also select an encoding
 method for your file from the list of encoding options (normally, the default
-value works fine). Check the <guilabel>Suggest automatic display</guilabel> option 
+value works fine). Check the <guilabel>Suggest automatic display</guilabel> option
 if you want to suggest to the recipient the automatic (inline) display of this attachment. Whether this works or not depends on the recipient's email client
 and on his settings.</para>
 
@@ -353,9 +365,9 @@
 
 <para>To check the spelling of your message using a dialog, select
 <menuchoice><guimenu>Tools</guimenu>
-<guimenuitem>Spelling...</guimenuitem></menuchoice>. &kmail; uses 
+<guimenuitem>Spelling...</guimenuitem></menuchoice>. &kmail; uses
 <ulink url="/kspell/">&kspell;</ulink> to
-check spelling, which is the &kde; frontend to the 
+check spelling, which is the &kde; frontend to the
 <application>ispell</application> or <application>aspell</application> spelling
 checker. Note that you may first need to configure the spellchecker using
 <menuchoice><guimenu>Settings</guimenu>
@@ -419,7 +431,7 @@
 <para>You may find that the standard folders are fine for your
 needs; eventually, though, you will probably need folders to help you organize
 your messages. To create a new folder, select
-<menuchoice><guimenu>Folder</guimenu><guimenuitem>New Folder...</guimenuitem></menuchoice>: 
+<menuchoice><guimenu>Folder</guimenu><guimenuitem>New Folder...</guimenuitem></menuchoice>:
 the <link linkend="folders-properties-window">folder properties</link> dialog
 will then prompt you for the necessary information. If you ever need to change
 the settings for a folder, select the folder you wish to modify in the Folders pane and select
@@ -435,10 +447,16 @@
 
 <para>If you want to clear all of the messages out of a folder choose
 <menuchoice><guimenu>Folder</guimenu><guimenuitem>Move All Messages to
-Trash</guimenuitem></menuchoice>. You can use 
+Trash</guimenuitem></menuchoice>. You can use
 <menuchoice><guimenu>Folder</guimenu><guimenuitem>Delete Folder</guimenuitem></menuchoice>
 to remove a folder and all its messages and subfolders.</para>
 
+<para>Folders can be copied or moved by using either drag and drop or the <menuchoice>
+<guimenuitem>Copy Folder</guimenuitem></menuchoice> and <menuchoice>
+<guimenuitem>Move Folder</guimenuitem></menuchoice> context menu entries. Note that you cannot
+move the above listed special folders.
+</para>
+
 <sect2 id="folders-properties-window">
 <title>Folder Properties</title>
 
@@ -468,7 +486,7 @@
 to you will still default to the message's <quote>To</quote> address if an
 according identity is found.</para>
 
-<para>With <guilabel>Show Sender/Receiver</guilabel> you can set the 
+<para>With <guilabel>Show Sender/Receiver</guilabel> you can set the
 visible columns in the header pane. This is useful if you use a
 folder to save your own sent messages.</para>
 
@@ -477,9 +495,17 @@
 example useful for the folder where you move all detected spam messages to.</para>
 
 <para>Check <guilabel>Keep replies in this folder</guilabel> if you want
-replies to messages in this folder to be filed also into this folder rather 
+replies to messages in this folder to be filed also into this folder rather
 than into a special sent-mail folder.</para>
 
+<para>For calendar folders you can select who should get reminders for the contained
+events by using the <guilabel>Generate free/busy and activate alarms for</guilabel>
+choice box.</para>
+
+<para>In case you don't want to receive reminders for folders shared by someone else,
+you can block them locally by activating the <guilabel>Block free/busy and alarms locally</guilabel>
+checkbox.</para>
+
 </sect3>
 
 <sect3 id="folders-properties-expiry">
@@ -487,13 +513,13 @@
 
 <para>Here you can select what should happen with old messages in this
 folder. If you enable <guilabel>Expire old messages in this folder</guilabel>
-then &kmail; will regularly, depending on your choice, either delete old 
+then &kmail; will regularly, depending on your choice, either delete old
 messages or move old messages to another folder. You can also start
 expiration of old messages manually via <menuchoice><guimenu>Folder</guimenu><guisubmenu>Expire</guisubmenu></menuchoice> and via
 <menuchoice><guimenu>File</guimenu><guisubmenu>Expire
 All Folders</guisubmenu></menuchoice></para>
 
-<warning><para>Messages that are deleted during expiration of old messages 
+<warning><para>Messages that are deleted during expiration of old messages
 cannot be restored, so be careful with this setting.</para></warning>
 
 </sect3>
@@ -507,7 +533,7 @@
 click on <guilabel>Detect Automatically</guilabel>. &kmail; will then try
 to guess some information about the mailing list from the currently selected
 message. If &kmail; could not determine some addresses then you can add
-the missing information manually. To do this first select the 
+the missing information manually. To do this first select the
 <guilabel>Address type</guilabel> for which you want to add an address.
 You can choose between:</para>
 
@@ -577,16 +603,16 @@
 addresses.</para>
 
 <para>If all addresses have been added then you can execute an action, &eg;
-go to the list archives, by selecting the appropriate 
+go to the list archives, by selecting the appropriate
 <guilabel>Address type</guilabel> and then clicking on
 <guilabel>Invoke Handler</guilabel>. If there is an email address and an
 address of a webpage for the desired action then you will have to select
-the <guilabel>Preferred handler</guilabel> prior to clicking on 
+the <guilabel>Preferred handler</guilabel> prior to clicking on
 <guilabel>Invoke Handler</guilabel>. Select <guilabel>KMail;</guilabel> if you
-want to send a message to the email address and select 
+want to send a message to the email address and select
 <guilabel>Browser</guilabel> if you want to go to the webpage.</para>
 
-<para>Alternatively to invoking the handler for 
+<para>Alternatively to invoking the handler for
 <guilabel>Post to List</guilabel> you can send a new message to the
 mailing list via <menuchoice><guimenu>Message</guimenu><guimenuitem>New
 Message to Mailing-List...</guimenuitem></menuchoice> or by clicking with
@@ -947,12 +973,12 @@
 to use <menuchoice><guimenu>Message</guimenu><guimenuitem>Create
 Filter</guimenuitem></menuchoice>: this will call the filter dialog
 and present you with a new filter which has the first rule of the
-search pattern and the first action (as <guilabel>Move into Folder</guilabel>) 
+search pattern and the first action (as <guilabel>Move into Folder</guilabel>)
 preset. In most cases, all you have to do is select the folder where the message
 should be moved to; but you can, of course, edit the filter as you
 like.</para>
 
-<para>When creating a filter on mailing list messages this method 
+<para>When creating a filter on mailing list messages this method
 will try really hard to find a criterion that
 uniquely identifies messages from that list; If it succeeds, the guessed
 name of the list is presented in the
@@ -962,7 +988,7 @@
 
 <para>The second method is to manually construct a filter from scratch
 by calling the filter dialog through
-<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure 
+<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure
 Filters...</guimenuitem></menuchoice>. The filter dialog is described in
 detail in the following subsection.</para>
 </sect2>
@@ -977,7 +1003,7 @@
 <para>You can reach it either via
 <menuchoice><guimenu>Message</guimenu><guisubmenu>Create
 Filter</guisubmenu></menuchoice> or
-<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure 
+<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure
 Filters...</guimenuitem></menuchoice>.</para>
 
 <para>The dialog is divided into four main sections:</para>
@@ -985,7 +1011,7 @@
 <varlistentry>
 <term><guilabel>Available Filters</guilabel></term>
 <listitem><para>This group contains the list of filters and some action
-buttons to modify the filters, namely: to create new filters; to move them up or 
+buttons to modify the filters, namely: to create new filters; to move them up or
 down the list; to delete them; or to rename them. If you select
 a filter from the list, its properties are shown in the right-hand half
 of the dialog.</para></listitem>
@@ -1084,7 +1110,7 @@
 messages; this can be done by choosing <guilabel>From</guilabel>. A
 good bet for a mailing list would be
 <guilabel>&lt;recipients&gt;</guilabel>, but there are other criteria
-a filter can search for (note that all patterns are interpreted 
+a filter can search for (note that all patterns are interpreted
 case-insensitively):</para>
 
 <variablelist>
@@ -1167,8 +1193,8 @@
 <row>
 <entry><guilabel>matches regular expr.</guilabel>/<guilabel>does not match reg. expr.</guilabel></entry>
 <entry>all textual search items</entry>
-<entry>Matches if a part of the searched item matches the given regular 
-expression (or does not match it). If the regular expression editor is 
+<entry>Matches if a part of the searched item matches the given regular
+expression (or does not match it). If the regular expression editor is
 installed then you can edit the regular expression by clicking on the <guilabel>Edit...</guilabel> button.</entry>
 </row>
 <row>
@@ -1195,7 +1221,7 @@
 <row>
 <entry><guilabel>is equal to</guilabel>/<guilabel>is not equal to</guilabel></entry>
 <entry>numerical search items</entry>
-<entry>Matches if the value of the search item is equal to (or not equal to) 
+<entry>Matches if the value of the search item is equal to (or not equal to)
 the specified value.</entry>
 </row>
 <row>
@@ -1245,7 +1271,7 @@
 <term><guilabel>Move into Folder</guilabel></term>
 <listitem>
 <para>This will file the message into another folder, removing it from
-its current folder if necessary; you cannot, currently 
+its current folder if necessary; you cannot, currently
 use &imap; folders as a target.</para>
 <!-- fixme: still correct? -->
 </listitem>
@@ -1282,10 +1308,10 @@
 <varlistentry>
 <term><guilabel>Set Transport To</guilabel></term>
 <listitem>
-<para>This will set the method of transport (&eg; <acronym>SMTP</acronym>) 
+<para>This will set the method of transport (&eg; <acronym>SMTP</acronym>)
 that will be used if you reply to the message.</para>
 </listitem>
-</varlistentry> 
+</varlistentry>
 <varlistentry>
 <term><guilabel>Set Reply-To To</guilabel></term>
 <listitem><para>This will modify the <guilabel>Reply-To</guilabel> field of this
@@ -1376,7 +1402,7 @@
 <listitem>
 <para>If no such field is already present this will add a new header field
 with the given name and value to the message; if there already is a
-header field with that name, it is overwritten with the 
+header field with that name, it is overwritten with the
 given value; if there are already multiple headers with the given
 name (&eg; <quote>Received:</quote> headers), an arbitrary one of them is
 overwritten and the others are left unchanged -- this is a known
@@ -1441,7 +1467,7 @@
 almost unique, because this fails for cross-posted messages.</para>
 </step>
 <step>
-<para>Select <menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure 
+<para>Select <menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure
 Filters...</guimenuitem></menuchoice>.</para>
 </step>
 <step>
@@ -1510,14 +1536,14 @@
 <varlistentry>
 <term>Stop filter processing as early as possible:</term>
 <listitem>
-<para>If you know that a filter finally processes a certain class of 
-messages, please make sure to check the option <guilabel>If this filter 
-matches, stop processing here</guilabel> for the filter. 
+<para>If you know that a filter finally processes a certain class of
+messages, please make sure to check the option <guilabel>If this filter
+matches, stop processing here</guilabel> for the filter.
 This will avoid the evaluation of the filter rules of all subsequent
 filters. (See the advanced options in the <link linkend="filter-dialog-id">
 Filter Dialog</link>).</para>
 <para>An example is filtering messages from mailing lists via List-Id
-header into separate folders. Having found out that a message came from 
+header into separate folders. Having found out that a message came from
 list A means that you can avoid checking the next filter for messages
 from list B.
 </para>
@@ -1535,7 +1561,7 @@
 </para>
 <para>Another dependency is on the amount of data which is used for the
 evaluation of a filter rule. If the rule is based on a message header,
-its evaluation should normally be much faster than the evaluation of 
+its evaluation should normally be much faster than the evaluation of
 a rule based on the complete message.
 </para>
 <para>You should try to keep the filter rules as simple as possible.
@@ -1547,19 +1573,19 @@
 <varlistentry>
 <term>Check the order of your filters:</term>
 <listitem>
-<para>All the different filter actions have a different complexity. 
-The most expensive filter actions are <guilabel>pipe through</guilabel> 
-and <guilabel>execute command</guilabel>, because both need external 
+<para>All the different filter actions have a different complexity.
+The most expensive filter actions are <guilabel>pipe through</guilabel>
+and <guilabel>execute command</guilabel>, because both need external
 programs to be run. Placing filters containing these filter actions
 behind other filters that can reduce the number of times these complex
 actions are required is useful, if the filter logic does allow
-this.</para> 
-<para>An example is filtering messages from a mailing list and detecting 
-spam messages. For the spam detection you will usually use an external 
-tool via a <guilabel>pipe through</guilabel> action. Filtering the messages 
-for the mailing list is done via the List-Id header. If you do not want to 
+this.</para>
+<para>An example is filtering messages from a mailing list and detecting
+spam messages. For the spam detection you will usually use an external
+tool via a <guilabel>pipe through</guilabel> action. Filtering the messages
+for the mailing list is done via the List-Id header. If you do not want to
 check the messages from the mailing list for spam too, it is better to
-use the filter for the mailing list messages before the filter for the 
+use the filter for the mailing list messages before the filter for the
 spam detection. This way you avoid the expensive and slow spam check for all
 messages which were identified as mailing list messages.
 </para>
@@ -1572,11 +1598,11 @@
 <title>Filter Log</title>
 <para>If you want to verify that your filters work as intended, you can
 open a viewer for the filter log via <menuchoice><guimenu>Tools</guimenu>
-<guimenuitem>Filter Log Viewer...</guimenuitem></menuchoice>. 
+<guimenuitem>Filter Log Viewer...</guimenuitem></menuchoice>.
 </para>
-<para>In the viewer, there you can configure  the logging of the filter 
-processing. You can control the detail level of the log, clear the log 
-or save the log into a file. The log can provide valuable information if 
+<para>In the viewer, there you can configure  the logging of the filter
+processing. You can control the detail level of the log, clear the log
+or save the log into a file. The log can provide valuable information if
 you need to debug your filtering process.
 </para>
 </sect2>
@@ -1591,14 +1617,14 @@
 to prevent &kmail; from downloading huge messages and save time this
 way.</para>
 
-<para>In the configuration dialog of the POP account you can enable 
+<para>In the configuration dialog of the POP account you can enable
 download filtering by checking the <guilabel>Filter messages if
-they are greater than</guilabel> box; once you have done that, you can specify a size 
+they are greater than</guilabel> box; once you have done that, you can specify a size
 which is used as a threshold: messages exceeding this size will be
 checked against the filter rules you defined -- if no filter rule
 matches, they will be shown in a confirmation dialog and you can
 decide what to do with them. The default size for filtering is 50,000
-Bytes; this is a good value as the overhead is kept to a minimum -- 
+Bytes; this is a good value as the overhead is kept to a minimum --
 every message that is looked at by the filter causes additional
 traffic because the header of the message is downloaded twice. The
 default action is <guilabel>Download mail</guilabel> to prevent the
@@ -1625,7 +1651,7 @@
 can manage the existing filters. Use the <guiicon>New</guiicon>
 button to add a filter. On the right hand side you can configure
 under which conditions the current filter should match. Using <guilabel>Filter
-Action</guilabel> you specify what will happen to a message that is 
+Action</guilabel> you specify what will happen to a message that is
 matched by this rule. The available options are:</para>
 
 <variablelist>
@@ -1649,7 +1675,7 @@
 <varlistentry>
 <term><guilabel>Delete mail from server</guilabel></term>
 <listitem>
-<para>Will delete the message from the server and does not download it. Once you 
+<para>Will delete the message from the server and does not download it. Once you
 deleted a message from the server, there is <emphasis>no</emphasis> way you can undo this.
 Be careful, as rules could match messages you actually want, too.</para></listitem>
 </varlistentry>
@@ -1687,12 +1713,12 @@
 a certain action (download, download later, delete) by a filter rule.
 The checkbox is only enabled if you receive some messages that were
 matched by a filter rule; once you check it, a list similar to the
-one for the not-automatically-tagged messages will be displayed and you 
+one for the not-automatically-tagged messages will be displayed and you
 can change the action for every single message.</para>
 
 <para>Please note that if there is a message exceeding the size
 limit, but all messages are matched by a filter rule the dialog will
-not be displayed. One exception occurs if you have checked 
+not be displayed. One exception occurs if you have checked
 <guilabel>Always show matched 'Download Later' messages</guilabel> in
 the <guilabel>Global Options</guilabel> section of the POP filter
 configuration dialog; then, the dialog will also be displayed if you only
@@ -1723,25 +1749,25 @@
 
 <sect1 id="pgp">
 <!-- This section is from Andreas Gungl, 2000-05-21, updated 2002-10-06 by Ingo Kloecker -->
-<title>Signing and Encrypting Messages with <application>PGP</application> 
+<title>Signing and Encrypting Messages with <application>PGP</application>
 or <application>GnuPG</application></title>
 
-<note><para>There have been major changes in the way &kmail; handles 
+<note><para>There have been major changes in the way &kmail; handles
 signing/encryption. The following introduction applies to the previous
 version of &kmail;. You can still read the introduction to get an overview
 about how to sign/encrypt messages, but the details, especially those of
 the configuration, will differ.</para></note>
 
 <para>This is a short introduction on how to setup &kmail;'s
-<application>PGP</application> (<application>Pretty Good Privacy</application>) support; 
+<application>PGP</application> (<application>Pretty Good Privacy</application>) support;
 it gives some hints on the use of
 <application>PGP</application> too. It is written for people who are beginners in
 this area; if you are familiar with the use of <application>PGP</application>, you can
 skip most of the steps. This documentation, and the &kmail; user interface,
-generally talk only about  <quote>PGP</quote>, but it applies to 
-both <application>PGP</application> and <application>GnuPG</application> 
-(<application>GNU Privacy Guard</application>), 
-(although some <application>GnuPG</application> command-line parameters 
+generally talk only about  <quote>PGP</quote>, but it applies to
+both <application>PGP</application> and <application>GnuPG</application>
+(<application>GNU Privacy Guard</application>),
+(although some <application>GnuPG</application> command-line parameters
 may be different.)</para>
 
 <para>Please
@@ -1755,10 +1781,10 @@
 </para></warning>
 
 <warning><para>&kmail; has to rely on <application>PGP</application>'s
-output; this output is often different between different versions of 
+output; this output is often different between different versions of
 <application>PGP</application>, so it is important that you test if encryption
 really works with your setup before you start using it seriously. &kmail; might
-<emphasis>not</emphasis> warn you if something fails -- enable 
+<emphasis>not</emphasis> warn you if something fails -- enable
 <guilabel>Show signed/encrypted text
 after composing</guilabel>.  </para></warning>
 
@@ -1766,9 +1792,9 @@
 necessary to have <application>PGP</application> installed and set up
 properly; of course, we cannot give you a full introduction of
 <application>PGP</application> here. We will only mention the steps you have to
-do to get <application>PGP</application> going. For details you should have a look at 
-the excellent  <application>PGP</application> documentation 
-or <ulink url="http://www.gnupg.org/docs.html#guides">The GNU Privacy Handbook</ulink>.</para> 
+do to get <application>PGP</application> going. For details you should have a look at
+the excellent  <application>PGP</application> documentation
+or <ulink url="http://www.gnupg.org/docs.html#guides">The GNU Privacy Handbook</ulink>.</para>
 
 <para>It is certainly a good idea to study this documentation as well as an
 introduction into public key cryptography (&eg; out of the
@@ -1847,7 +1873,7 @@
 <listitem>
 <para>This will show you the result of encrypting and signing before the message
 gets sent; this way, you can still cancel sending if encrypting failed. It is
-strongly recommended to use this option.</para> 
+strongly recommended to use this option.</para>
 </listitem>
 </varlistentry>
 
@@ -1858,7 +1884,7 @@
 each recipient when you are sending an encrypted message; if this
 option is off, &kmail; will show this dialog only when it cannot
 find a key for a recipient or when there are conflicting or unset encryption
-preferences.</para> 
+preferences.</para>
 </listitem>
 </varlistentry>
 
@@ -1866,7 +1892,7 @@
 <term><guilabel>Automatically sign messages using OpenPGP</guilabel></term>
 <listitem><para>This lets you toggle whether to automatically sign your messages
 by default; of course, it is still possible to send unsigned messages by deselecting
-the icon in the composer window.</para> 
+the icon in the composer window.</para>
 </listitem>
 </varlistentry>
 
@@ -1905,10 +1931,10 @@
 <para>You can compose your message as usual in the composer
 window of &kmail;. Before you send the message, check the <guiicon>Sign Message</guiicon>
 icon on the toolbar of the composer window; then, you can send
-the message. The identity you are using to write the current message needs to 
+the message. The identity you are using to write the current message needs to
 be connected to an <guilabel>OpenPGP Key</guilabel> in the <guilabel>Identity</guilabel>
 section of the <guilabel>Configure</guilabel> dialog.
-To sign the message, &kmail; needs to know your <application>PGP</application> 
+To sign the message, &kmail; needs to know your <application>PGP</application>
 passphrase: if you did not select <guilabel>Keep passphrase in memory</guilabel> in the
 <guilabel>Security</guilabel> section, &kmail; will ask you for it; otherwise,
 if you have already given the phrase to &kmail;, it will sign the
@@ -1944,10 +1970,10 @@
 show the encryption keys for approval</guilabel> is selected in the
 <guilabel>Security</guilabel> section of &kmail;'s configuration dialog
 the <guilabel>Encryption Key Approval</guilabel> dialog will appear;
-here, you can select different keys for the recipients and can 
+here, you can select different keys for the recipients and can
 set the <guilabel>Encryption Preference</guilabel> for each recipient.
 The default option, <guilabel>Encrypt whenever encryption is
-possible</guilabel>, will automatically encrypt your message if there is a 
+possible</guilabel>, will automatically encrypt your message if there is a
 trusted key for each recipient.</para>
 
 <para>As mentioned above, you will not be able to read your own encrypted sent
@@ -1993,11 +2019,11 @@
 key, you should verify the key (check its fingerprint or look for
 trusted signatures); then, you can add this key to your public keyring
 by typing <userinput><command>pgp</command> <option>-ka</option>
-<replaceable>filename</replaceable></userinput> at the command line (if you are using 
-<application>PGP</application>) or by typing 
+<replaceable>filename</replaceable></userinput> at the command line (if you are using
+<application>PGP</application>) or by typing
 <userinput><command>gpg</command> <option>--import</option>
 <replaceable>filename</replaceable></userinput> at the command line (if you are using
-<application>GnuPG</application>). If the key is not certified with a trusted signature 
+<application>GnuPG</application>). If the key is not certified with a trusted signature
 you cannot use it to encrypt messages unless you have signed the key with your key.
 </para>
 
@@ -2011,9 +2037,9 @@
 <sect2 id="spam-wizard-basics">
 <title>Basics</title>
 
-<para>&kmail; does not have a built-in spam detection solution: the developers believe 
-using external, but specialized, tools is the better approach. &kmail; uses these tools 
-through its flexible filter architecture. The Anti-Spam Wizard helps you with the 
+<para>&kmail; does not have a built-in spam detection solution: the developers believe
+using external, but specialized, tools is the better approach. &kmail; uses these tools
+through its flexible filter architecture. The Anti-Spam Wizard helps you with the
 initial filter setup.
 </para>
 
@@ -2021,7 +2047,7 @@
 <varlistentry>
 <term>What can the wizard do to help you?</term>
 <listitem>
-<para>It will give you some choices about how you want the spam filtering to be set up. 
+<para>It will give you some choices about how you want the spam filtering to be set up.
 Afterwards it will automatically create the appropriate filter rules.
 </para>
 </listitem>
@@ -2029,7 +2055,7 @@
 <varlistentry>
 <term>What are the limitations of the wizard?</term>
 <listitem>
-<para>It can only initially set up the filters for you; and it will provide a 
+<para>It can only initially set up the filters for you; and it will provide a
 standard setup. Manual modifications in existing filters are not considered.
 Instead, these filters are overwritten by the wizard.
 </para>
@@ -2040,25 +2066,25 @@
 <para>You can activate the wizard via <menuchoice><guimenu>Tools</guimenu>
 <guisubmenu>Anti-Spam Wizard...</guisubmenu></menuchoice>.</para>
 
-<para>The wizard scans for known anti-spam tools on your computer. 
+<para>The wizard scans for known anti-spam tools on your computer.
 It is as well possible to use results of spam checks made by your provider
 by evaluating some header information which has been added to the messages.
 You can let the wizard prepare &kmail; to use one or many of them in parallel.
 However, note that anti-spam tool operations are usually time consuming.
-&kmail; can appear to be frozen during the scan of the messages for spam, 
-you may encounter problems with the responsiveness of &kmail;. Please consider 
-deleting the filter rules created by the wizard if the filtering becomes 
-too slow for you. 
+&kmail; can appear to be frozen during the scan of the messages for spam,
+you may encounter problems with the responsiveness of &kmail;. Please consider
+deleting the filter rules created by the wizard if the filtering becomes
+too slow for you.
 Here are some recommendations regarding the supported tools:</para>
 
 <variablelist>
 <varlistentry>
   <term>Bogofilter</term>
 <listitem>
-<para>Bogofilter is a bayesian filter, that means it's spam detection 
-relies on an initial training phase. On the other hand, it's a pretty 
-fast tool. That's why it is recommended to be used by people which 
-primarily want to have a fast spam detection, and which don't worry 
+<para>Bogofilter is a bayesian filter, that means it's spam detection
+relies on an initial training phase. On the other hand, it's a pretty
+fast tool. That's why it is recommended to be used by people which
+primarily want to have a fast spam detection, and which don't worry
 about the little training in the beginning before the detection rate
 increases significantly.
 </para>
@@ -2067,10 +2093,10 @@
 <varlistentry>
   <term>SpamAssassin</term>
 <listitem>
-<para>SpamAssassin is a pretty complex tool to fight against spam. 
-Although it's behavior depends heavily on it's configuration, that 
+<para>SpamAssassin is a pretty complex tool to fight against spam.
+Although it's behavior depends heavily on it's configuration, that
 tool can detect spam quite well without any training. However,
-scanning a message takes a little longer compared to pure bayesian 
+scanning a message takes a little longer compared to pure bayesian
 filters. Let's say, it's not the tool of choice for people without
 some background information about SpamAssassin's capabilities.
 </para>
@@ -2088,9 +2114,9 @@
   <term>GMX Spam Filter</term>
 <listitem>
 <para>Given that you get your mail via the GMX freemail provider,
-your messages are scanned for spam. The result of that process is 
+your messages are scanned for spam. The result of that process is
 documented in a special header field of each message. It's possible to
-use the content of this header field to sort out spam. There is no 
+use the content of this header field to sort out spam. There is no
 slowdown in the filtering if only this tool is used, as the messages
 have already been processed.
 </para>
@@ -2104,42 +2130,42 @@
 <sect2 id="spam-wizard-advanced">
 <title>Advanced</title>
 
-<para>Here are the details of how the wizard works: &kmail; can use several 
-external tools to detect spam messages; it will try to automatically find 
-out which of those tools are installed on your box and will show you these 
-tools in a list. The list is ordered by the average speed of the filtering 
-process of the tools. You can mark the tools which you want 
-to be used by &kmail; to detect spam. Of course, you 
+<para>Here are the details of how the wizard works: &kmail; can use several
+external tools to detect spam messages; it will try to automatically find
+out which of those tools are installed on your box and will show you these
+tools in a list. The list is ordered by the average speed of the filtering
+process of the tools. You can mark the tools which you want
+to be used by &kmail; to detect spam. Of course, you
 can close the wizard, install a tool, and restart the wizard again.
 </para>
 
 <para>If you have marked at least one tool, KMail is able to provide filters
-which allow the classification of the messages as spam or not spam. It will 
-also provide actions to let you manually classify messages. These actions will 
+which allow the classification of the messages as spam or not spam. It will
+also provide actions to let you manually classify messages. These actions will
 be available via the menu and via toolbar icons.
-If any of the tools you selected support Bayesian filtering (&ie; a method 
-to detect spam based on statistical analysis of the messages) then these 
-messages are not only marked but additionally transfered to the tools to 
+If any of the tools you selected support Bayesian filtering (&ie; a method
+to detect spam based on statistical analysis of the messages) then these
+messages are not only marked but additionally transfered to the tools to
 let them learn so they can improve their detection rate.
 </para>
 
-<para>On the second page, there you will be able to select some additional 
-actions to be done in &kmail; with regard to spam messages: if you 
-want messages detected as spam to be moved into a certain folder, please select 
-the appropriate folder and mark the <guilabel>Move known spam to:</guilabel> 
-option; if messages detected as spam should additionally be marked as read, 
+<para>On the second page, there you will be able to select some additional
+actions to be done in &kmail; with regard to spam messages: if you
+want messages detected as spam to be moved into a certain folder, please select
+the appropriate folder and mark the <guilabel>Move known spam to:</guilabel>
+option; if messages detected as spam should additionally be marked as read,
 then mark the <guilabel>Mark detected spam messages as read</guilabel> option.
 </para>
 
-<para>Having checked at least one of the available tools will allow you to 
-let the wizard finish the filter setup. The wizard will not take any 
-modifications in existing filters formerly created by the wizard into 
-consideration but will either append new filters or replace existing filters 
-in any case; you may want to inspect the result of this process in the 
-<link linkend="filter-dialog">Filter Dialog</link>. 
+<para>Having checked at least one of the available tools will allow you to
+let the wizard finish the filter setup. The wizard will not take any
+modifications in existing filters formerly created by the wizard into
+consideration but will either append new filters or replace existing filters
+in any case; you may want to inspect the result of this process in the
+<link linkend="filter-dialog">Filter Dialog</link>.
 The wizard will also create toolbar buttons for marking messages as spam or
-as ham; keep in mind that classifying messages as spam will also move those 
-messages to the folder you had specified for spam messages, if you haven't 
+as ham; keep in mind that classifying messages as spam will also move those
+messages to the folder you had specified for spam messages, if you haven't
 deselected the appropriate option.
 </para>
 
@@ -2148,33 +2174,33 @@
 <sect2 id="spam-wizard-details">
 <title>Some More Details for Experts</title>
 
-<para>The wizard uses information stored in a special configuration file named 
-<filename>kmail.antispamrc</filename> (stored in the global or local KDE 
-config directory). It will first check the global config file and then the local 
-config file: if the local config file contains entries with higher (newer) 
-version numbers per-tool the configuration data from the local file for that 
+<para>The wizard uses information stored in a special configuration file named
+<filename>kmail.antispamrc</filename> (stored in the global or local KDE
+config directory). It will first check the global config file and then the local
+config file: if the local config file contains entries with higher (newer)
+version numbers per-tool the configuration data from the local file for that
 tool is used; that way, both administrators and users can update the
 wizard configuration.
 </para>
 
-<para>The local detection of spam messages is achieved by creating 
-<guilabel>pipe through</guilabel> actions per-tool within a 
-special filter. Another filter contains rules to check for detected spam 
-messages and actions to mark them and (optionally, depending on the choice 
-in the wizard) to move them into a folder. Both filters are configured to 
+<para>The local detection of spam messages is achieved by creating
+<guilabel>pipe through</guilabel> actions per-tool within a
+special filter. Another filter contains rules to check for detected spam
+messages and actions to mark them and (optionally, depending on the choice
+in the wizard) to move them into a folder. Both filters are configured to
 be applied on incoming messages and on manual filtering.
 </para>
 
-<para>Two filters are needed for the classification of ham and spam. They 
-contain actions to mark the messages appropriately. As mentioned above, the filter 
-for classification as spam can have another action to move the message into a 
-predefined folder. If the selected tools support Bayesian filtering, 
-the wizard will create additional filter actions to pass the messages to the 
-tools (via <guilabel>execute command</guilabel> actions) in the 
+<para>Two filters are needed for the classification of ham and spam. They
+contain actions to mark the messages appropriately. As mentioned above, the filter
+for classification as spam can have another action to move the message into a
+predefined folder. If the selected tools support Bayesian filtering,
+the wizard will create additional filter actions to pass the messages to the
+tools (via <guilabel>execute command</guilabel> actions) in the
 appropriate learn mode.
 </para>
 
-<para>If you want to fine-tune the filtering process, you might be interested in the 
+<para>If you want to fine-tune the filtering process, you might be interested in the
 chapter about <link linkend="filter-optimization">Filter Optimization</link>.</para>
 
 </sect2>
@@ -2187,9 +2213,9 @@
 <sect2 id="virus-wizard-basics">
 <title>Basics</title>
 
-<para>&kmail; does not have a built-in virus detection solution: the developers believe 
-using external, but specialized, tools is the better approach. &kmail; uses these tools 
-through its flexible filter architecture. The Anti-Virus Wizard helps you with the 
+<para>&kmail; does not have a built-in virus detection solution: the developers believe
+using external, but specialized, tools is the better approach. &kmail; uses these tools
+through its flexible filter architecture. The Anti-Virus Wizard helps you with the
 initial filter setup.
 </para>
 
@@ -2197,7 +2223,7 @@
 <varlistentry>
 <term>What can the wizard do to help you?</term>
 <listitem>
-<para>It will give you some choices about how you want virus filtering to be set up. 
+<para>It will give you some choices about how you want virus filtering to be set up.
 Afterwards it will automatically create the appropriate filter rules.
 </para>
 </listitem>
@@ -2205,7 +2231,7 @@
 <varlistentry>
 <term>What are the limitations of the wizard?</term>
 <listitem>
-<para>It can only initially set up the filters for you; and it will provide a 
+<para>It can only initially set up the filters for you; and it will provide a
 standard setup. Modifying existing filters is not yet possible.
 </para>
 </listitem>
@@ -2220,31 +2246,31 @@
 <sect2 id="virus-wizard-advanced">
 <title>Advanced</title>
 
-<para>The Anti-Virus Wizard basically works exactly as the 
+<para>The Anti-Virus Wizard basically works exactly as the
 <link linkend="the-anti-spam-wizard">Anti-Spam Wizard</link>.
-Here are the details of how the wizard works: &kmail; can use several 
-external tools to detect messages containing viruses; it will try to automatically find 
-out which of those tools are installed on your box and will show you the 
-result of the search for each tool. You can mark the tools which you want 
-to be used by &kmail; to detect viruses; marking tools which were not found is 
-not possible because the appropriate checkboxes are disabled. Of course, you 
+Here are the details of how the wizard works: &kmail; can use several
+external tools to detect messages containing viruses; it will try to automatically find
+out which of those tools are installed on your box and will show you the
+result of the search for each tool. You can mark the tools which you want
+to be used by &kmail; to detect viruses; marking tools which were not found is
+not possible because the appropriate checkboxes are disabled. Of course, you
 can close the wizard, install a tool, and restart the wizard again.
 </para>
 
-<para>If you have marked at least one tool you will be able to select some actions 
-to be done in &kmail; with regard to messages containing viruses: to let &kmail; detect 
+<para>If you have marked at least one tool you will be able to select some actions
+to be done in &kmail; with regard to messages containing viruses: to let &kmail; detect
 messages containing viruses you definitely should mark the <guilabel>Check messages using the
-anti-virus tools</guilabel> option; if you want messages detected as 
-virus-infected to be moved into a certain folder, please select the appropriate folder and 
-mark the <guilabel>Move detected viral messages to the selected folder</guilabel> 
+anti-virus tools</guilabel> option; if you want messages detected as
+virus-infected to be moved into a certain folder, please select the appropriate folder and
+mark the <guilabel>Move detected viral messages to the selected folder</guilabel>
 option; if messages detected as virus-infected should additionally be marked as read,
 then mark the <guilabel>Additionally, mark detected viral messages as read</guilabel> option.
 </para>
 
-<para>Having checked at least one of these last options will allow you to 
-let the wizard finish the filter setup. The wizard will not take any existing 
-filter rules into consideration but will append new rules in any case; you 
-may want to inspect the result of this process in the 
+<para>Having checked at least one of these last options will allow you to
+let the wizard finish the filter setup. The wizard will not take any existing
+filter rules into consideration but will append new rules in any case; you
+may want to inspect the result of this process in the
 <link linkend="filter-dialog">Filter Dialog</link>.
 </para>
 
@@ -2253,20 +2279,20 @@
 <sect2 id="virus-wizard-details">
 <title>Details</title>
 
-<para>The wizard uses information stored in a special configuration file named 
-<filename>kmail.antivirusrc</filename> (stored in the global or local KDE 
-config directory). It will first check the global config file and then the local 
-config file: if the local config file contains entries with higher (newer) 
-version numbers per-tool the configuration data from the local file for that 
+<para>The wizard uses information stored in a special configuration file named
+<filename>kmail.antivirusrc</filename> (stored in the global or local KDE
+config directory). It will first check the global config file and then the local
+config file: if the local config file contains entries with higher (newer)
+version numbers per-tool the configuration data from the local file for that
 tool is used; that way, both administrators and users can update the
 wizard configuration.
 </para>
 
-<para>The detection of messages containing viruses is achieved by creating 
-<guilabel>pipe through</guilabel> actions per-tool within a 
-special filter. Another filter contains rules to check for detected viral 
-messages and actions to mark them and (optionally, depending on the choice 
-in the wizard) to move them into a folder. Both filters are configured to 
+<para>The detection of messages containing viruses is achieved by creating
+<guilabel>pipe through</guilabel> actions per-tool within a
+special filter. Another filter contains rules to check for detected viral
+messages and actions to mark them and (optionally, depending on the choice
+in the wizard) to move them into a folder. Both filters are configured to
 be applied on incoming messages and on manual filtering.
 </para>
 
Index: doc/kmail/configure.docbook
===================================================================
--- doc/kmail/configure.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kmail/configure.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -111,11 +111,11 @@
 
 <para>The page consists of a list of identities and buttons to manage
 them. The identities list will always show at
-least one identity, which is then the <guilabel>Default</guilabel> 
+least one identity, which is then the <guilabel>Default</guilabel>
 identity.</para>
 
 <para>To add a new identity to the identity list, click on the
-<guibutton>New...</guibutton> button. 
+<guibutton>New...</guibutton> button.
 The <link linkend="configure-identity-newidentitydialog">New identity</link> dialog
 will then appear.</para>
 
@@ -174,7 +174,7 @@
 <term><guilabel>Your name</guilabel></term>
 <listitem>
 <para>Enter your full name here (sometimes also called <emphasis>display name</emphasis>).
-Although this field is not strictly mandatory, it is recommended to enter 
+Although this field is not strictly mandatory, it is recommended to enter
 the correct value here.</para>
 </listitem>
 </varlistentry>
@@ -187,7 +187,7 @@
 <varlistentry>
 <term><guilabel>Email address</guilabel></term>
 <listitem>
-<para>Enter your email address here, &ie; something like 
+<para>Enter your email address here, &ie; something like
 <userinput>joe@example.com</userinput>.</para>
 </listitem>
 </varlistentry>
@@ -243,7 +243,7 @@
 	  </listitem>
 	</varlistentry>
 
-	
+
 	<varlistentry id="configure-identity-cryptography-openpgp-encrypt">
 	  <term>
 	    <guilabel>OpenPGP encryption key</guilabel>
@@ -272,7 +272,7 @@
 	  </listitem>
 	</varlistentry>
 
-	
+
 	<varlistentry id="configure-identity-cryptography-smime-sign">
 	  <term>
 	    <guilabel>&smime; signing certificate</guilabel>
@@ -297,7 +297,7 @@
 	  </listitem>
 	</varlistentry>
 
-	
+
 	<varlistentry id="configure-identity-cryptography-smime-encrypt">
 	  <term>
 	    <guilabel>&smime; encryption certificate</guilabel>
@@ -370,7 +370,7 @@
 <note><para>This field is only useful if you want replies to your mail
 to go somewhere else than your regular email address, &eg; if you are
 using this identity to send messages from an email address that cannot
-receive messages. Note that 
+receive messages. Note that
 some mailing lists overwrite this header field with their post address to
 make sure that replies go to the list instead of individuals. So the
 usefulness of this field is very limited and it should only be used in
@@ -383,8 +383,8 @@
 <listitem>
 <para>Optionally enter an address to which blind copies of your messages
 should be sent to. Note that a BCC is only send to this address, when
-<menuchoice><guimenu>View</guimenu><guimenuitem>BCC</guimenuitem></menuchoice> 
-is activated while composing a message. If you want to send a BCC regardless 
+<menuchoice><guimenu>View</guimenu><guimenuitem>BCC</guimenuitem></menuchoice>
+is activated while composing a message. If you want to send a BCC regardless
 of this setting, you should look at the <guilabel>Headers</guilabel> tab of the
 <guilabel>Composer</guilabel> page.</para>
 </listitem>
@@ -394,9 +394,9 @@
 <term><guilabel>Sent-mail folder</guilabel></term>
 <listitem>
 <para>Select the folder into which messages should be filed after sending
-when using this identity. <acronym>IMAP</acronym> users should consider changing this to an 
-<acronym>IMAP</acronym> folder, so their sent-mail is stored on a server instead of being 
-stored in a local folder. This way they can access these messages at a 
+when using this identity. <acronym>IMAP</acronym> users should consider changing this to an
+<acronym>IMAP</acronym> folder, so their sent-mail is stored on a server instead of being
+stored in a local folder. This way they can access these messages at a
 different location.</para>
 
 <tip><para>You can exercise more fine-grained control over where to
@@ -410,9 +410,9 @@
 <varlistentry>
 <term><guilabel>Drafts folder</guilabel></term>
 <listitem>
-<para>Select the folder into which drafts should be filed when using 
-this identity. <acronym>IMAP</acronym> users should consider changing this to an 
-<acronym>IMAP</acronym> folder, so their drafts are stored on a server instead of being 
+<para>Select the folder into which drafts should be filed when using
+this identity. <acronym>IMAP</acronym> users should consider changing this to an
+<acronym>IMAP</acronym> folder, so their drafts are stored on a server instead of being
 stored in a local folder. This way they can easily continue to work
 on their drafts at a different location.</para>
 </listitem>
@@ -492,7 +492,7 @@
 automatically prepend the signature text with this line if it is not
 already present in the signature text.</para>
 <para>If you do not wish the separator to be prepended
-automatically by &kmail;, simply add it to the signature 
+automatically by &kmail;, simply add it to the signature
 text yourself.</para>
 </note>
 
@@ -551,7 +551,7 @@
 <variablelist>
 <varlistentry>
 <term><guilabel>Never Automatically</guilabel></term>
-<listitem><para>Queued messages will only be sent if you select 
+<listitem><para>Queued messages will only be sent if you select
 <menuchoice><guimenu>File</guimenu><guimenuitem>Send queued messages</guimenuitem></menuchoice>.</para></listitem>
 </varlistentry>
 <varlistentry>
@@ -577,7 +577,7 @@
 the outbox to be sent later with the
 <menuchoice><guimenu>File</guimenu><guimenuitem>Send
 Queued Messages</guimenuitem></menuchoice> command or automatically when you
-check your mail, depending on the setting of 
+check your mail, depending on the setting of
 <guilabel>Send messages in outbox folder</guilabel> above.</para>
 
 <para><guilabel>Message property</guilabel> lets you select how your
@@ -587,7 +587,7 @@
 as accented letters will be sent as-is. If <guilabel>MIME Compliant
 (Quoted Printable)</guilabel> is selected, special characters will be
 encoded using standard &MIME; encodings, which may be more portable to
-mailing systems other than 8-bit <acronym>ASCII</acronym>. 
+mailing systems other than 8-bit <acronym>ASCII</acronym>.
 We recommend to use <guilabel>MIME Compliant</guilabel>.</para>
 
 <note><para>Even with <guilabel>Allow 8-bit</guilabel>
@@ -598,7 +598,7 @@
 <para><guilabel>Default domain</guilabel> lets you specify which domain name
 should be used to complete email addresses that only consist of the recipient's user
 name. For example when you set the default domain to <replaceable>kde.org</replaceable>
-then messages you send to <replaceable>johndoe</replaceable> will be sent to 
+then messages you send to <replaceable>johndoe</replaceable> will be sent to
 <replaceable>johndoe@kde.org</replaceable>.</para>
 
 </sect2>
@@ -617,7 +617,7 @@
 <guilabel>Beep</guilabel> will play a short beep sound;
 if <guilabel>Detailed new mail notification</guilabel> is enabled then
 &kmail; will show the number of new messages for each folder provided
-you have chosen to be notified with a dialog. More advanced 
+you have chosen to be notified with a dialog. More advanced
 notification options, like showing a dialog or running a certain command,
 are available via the <guibutton>Other Actions</guibutton> button.</para>
 
@@ -646,8 +646,11 @@
 <para>This section allows you to change the color of the text.
 <guilabel>Recycle colors on deep quoting</guilabel> means that even text that is
 quoted more than three times will appear in color. Note that the
-<guilabel>Quoted text</guilabel> colors only work in the message reader, not in 
-the composer.<!-- TODO --></para>
+<guilabel>Quoted text</guilabel> colors only work in the message reader, not in
+the composer. If you want folders which are close to their quota
+(space alotment, usually used on IMAP servers) to be displayed in a different color,
+you can specify a percentage value as a threshold for this. The color to be used
+can be configured along with the other custom colors.<!-- TODO --></para>
 
 </sect2>
 
@@ -660,9 +663,9 @@
 you should be aware of the fact that you are reading a &html; message. The &html;
 status bar itself cannot be influenced by the &html; code of the message.</para>
 
-<para>The <guilabel>Window Layout</guilabel> section lets you choose the 
-layout of the main window. You can choose where you want the 
-<guilabel>Message Preview Pane</guilabel> or choose not to have 
+<para>The <guilabel>Window Layout</guilabel> section lets you choose the
+layout of the main window. You can choose where you want the
+<guilabel>Message Preview Pane</guilabel> or choose not to have
 it at all.</para>
 
 <para>The <guilabel>Message Structure Viewer</guilabel> option lets you choose when
@@ -670,7 +673,7 @@
 lets you access all parts of a message. <guilabel>Show never</guilabel> will
 disable the structure viewer (note that you can still access attachments as icons),
 <guilabel>Show always</guilabel> will show the structure viewer even if there is only
-one plaintext part. <guilabel>Show only for non-plaintext messages</guilabel> will 
+one plaintext part. <guilabel>Show only for non-plaintext messages</guilabel> will
 display the structure viewer only if it makes sense, &ie; if the current message
 has attachments or has &html; parts.</para>
 
@@ -679,7 +682,7 @@
 <sect2 id="configure-appearance-headers">
 <title>Headers</title>
 
-<para>With <guilabel>Display message sizes</guilabel> selected there will be another 
+<para>With <guilabel>Display message sizes</guilabel> selected there will be another
 column in the header pane that shows the messages' size.</para>
 
 <para><guilabel>Show crypto icons</guilabel> will add more status information
@@ -690,15 +693,15 @@
 to select a message once before these icons will appear, until then only
 question marks will be displayed.</para>
 
-<para><guilabel>Thread list of message headers</guilabel> will put all the messages 
-in the header pane in a kind of tree list, so that the replies to a message are 
+<para><guilabel>Thread list of message headers</guilabel> will put all the messages
+in the header pane in a kind of tree list, so that the replies to a message are
 directly below that message.</para>
 
 <para>With <guilabel>Message header threading options</guilabel> you can select
 whether threads should appear expanded (<guilabel>open</guilabel>) by
 default or whether they should be collapsed (<guilabel>closed</guilabel>).
 You can of course still open/close threads using the  <guilabel>+</guilabel>/<guilabel>-</guilabel>
-buttons.</para> 
+buttons.</para>
 
 <para>With <guilabel>Date Display</guilabel> you can choose between several
 date formats. The <guilabel>Localized Format</guilabel> is the one you can
@@ -810,8 +813,8 @@
 	  <listitem>
 	    <para>
               A backup copy of the text in the composer window can be created
-	      regularly. This option lets you specify the interval used to 
-              create the backup. You can disable autosaving by setting it to 
+	      regularly. This option lets you specify the interval used to
+              create the backup. You can disable autosaving by setting it to
               the value <literal>0</literal>.
 	    </para>
 	  </listitem>
@@ -848,7 +851,7 @@
 
 <para>The <guilabel>Phrases</guilabel> tab lets you define the automatically
 generated lines that are added to message replies, forwarded messages, and the
-character that is added in front of quoted text. 
+character that is added in front of quoted text.
 There are special &percnt;-denoted characters that will insert certain
 values, which are also displayed at the top of the <guilabel>Phrases</guilabel> section.
 You can add reply phrases in languages other than
@@ -864,10 +867,10 @@
 
 <para>This section contains a list of prefixes for <quote>Reply</quote> and
 <quote>Forward</quote>. If you receive messages that use prefixes different
-to the standard ones, you can add them here so &kmail; will recognize 
+to the standard ones, you can add them here so &kmail; will recognize
 them. This way &kmail; can ignore them for sorting messages and
-when setting the subject of a reply or a forwarded messages, and optionally 
-replace them with <quote>Re:</quote> or <quote>Fwd:</quote> 
+when setting the subject of a reply or a forwarded messages, and optionally
+replace them with <quote>Re:</quote> or <quote>Fwd:</quote>
 respectively.</para>
 
 </sect2>
@@ -875,11 +878,11 @@
 <sect2 id="configure-composer-charset">
 <title>Charset</title>
 
-<para>Here you can manage the default charsets used for your own messages. 
+<para>Here you can manage the default charsets used for your own messages.
 Every message you send will be checked if it is written in one of the listed
 charsets, starting at the top of the list. If it is, this charset will be used.
 If it is not, a dialog will show up and tell you that you manually have to choose
-a charset using 
+a charset using
 <menuchoice><guimenu>Options</guimenu><guisubmenu>Set Encoding</guisubmenu></menuchoice>.
 </para>
 
@@ -913,7 +916,7 @@
 <sect2 id="configure-composer-attachments">
 <title>Attachments</title>
 
-<para>If you have to send attachments with filenames containing non-English 
+<para>If you have to send attachments with filenames containing non-English
 characters to users of Outlook(TM) or Outlook Express(TM) then you might want
 to check the <guilabel>Outlook-compatible attachment naming</guilabel> option.
 &kmail; will then encode the attachment names in a non-standard way that is
@@ -1465,7 +1468,7 @@
 	  </term>
 	  <listitem>
 	    <para>
-	      If checked, &smime; certificates are validated using 
+	      If checked, &smime; certificates are validated using
 	      Certificate Revocation Lists (<acronym>CRLs</acronym>).
 	    </para>
 	  </listitem>
@@ -1477,14 +1480,14 @@
 	  </term>
 	  <listitem>
 	    <para>
-	      If this option is selected, &smime; certificates are validated 
-              using the Online Certificates Status Protocol 
+	      If this option is selected, &smime; certificates are validated
+              using the Online Certificates Status Protocol
               (<acronym>OCSP</acronym>).
             </para>
             <para>
               Fill in the <acronym>URL</acronym> of the <acronym>OCSP</acronym>
-              responder in the field reserved at this effect.  
-	    </para> 
+              responder in the field reserved at this effect.
+	    </para>
 	  </listitem>
 	</varlistentry>
 
@@ -1496,7 +1499,7 @@
 	      <para>
 		Enter the address of the server for online validation
 		of certificates. The <acronym>URL</acronym>
-                is usually starting with <emphasis>http://</emphasis>. 
+                is usually starting with <emphasis>http://</emphasis>.
 	      </para>
 	  </listitem>
 	</varlistentry>
@@ -1530,7 +1533,7 @@
 	  </term>
 	  <listitem>
 	    <para>
-	      By default, <guilabel>GnuPG</guilabel> uses the file 
+	      By default, <guilabel>GnuPG</guilabel> uses the file
               <emphasis>~/.gnupg/policies.txt</emphasis> to check if a
               certificate policy is allowed. If this option is selected,
               policies are not checked.
@@ -1544,7 +1547,7 @@
 	  </term>
 	  <listitem>
 	    <para>
-	      If this option is checked, Certificate Revocation Lists are 
+	      If this option is checked, Certificate Revocation Lists are
               never used to validate <acronym>&smime;</acronym> certificates.
 	    </para>
 	  </listitem>
@@ -1557,7 +1560,7 @@
 	  <listitem>
 	    <para>
 	      Check this option if you want the missing issuer certificates
-              to be fetched when necessary. This applies to both validation 
+              to be fetched when necessary. This applies to both validation
               methods, <acronym>CRLs</acronym> and <acronym>OCSP</acronym>.
 	    </para>
 	  </listitem>
@@ -1569,7 +1572,7 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     Entirely disables the use of <acronym>HTTP</acronym> for 
+	     Entirely disables the use of <acronym>HTTP</acronym> for
              <acronym>&smime;</acronym>.
 	    </para>
 	  </listitem>
@@ -1581,14 +1584,14 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     When looking for the location of a <acronym>CRL</acronym>, 
-             <quote>the "to-be-tested"</quote>certificate usually contains 
+	     When looking for the location of a <acronym>CRL</acronym>,
+             <quote>the "to-be-tested"</quote>certificate usually contains
              what are known as CRL Distribution Point (<acronym>DP</acronym>) entries,
-             which are <acronym>URLs</acronym> describing the way to access 
+             which are <acronym>URLs</acronym> describing the way to access
              the <acronym>URL</acronym>. The first found <acronym>DP</acronym>
-             entry is used.  
+             entry is used.
              With this option all entries using the <acronym>HTTP</acronym>
-             scheme are ignored when looking for a suitable 
+             scheme are ignored when looking for a suitable
              <acronym>DP</acronym>.
 	    </para>
 	  </listitem>
@@ -1600,9 +1603,9 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     If this option is selected, the value of the 
-             <acronym>HTTP</acronym> proxy shown on the right 
-             (which comes from the environment variable http_proxy) 
+	     If this option is selected, the value of the
+             <acronym>HTTP</acronym> proxy shown on the right
+             (which comes from the environment variable http_proxy)
              will be used for any <acronym>HTTP</acronym> request.
 	    </para>
 	  </listitem>
@@ -1614,10 +1617,10 @@
 	  </term>
 	  <listitem>
 	    <para>
-	      Enter here the location of your <acronym>HTTP</acronym> Proxy, 
-              which will be used for all <acronym>HTTP</acronym> requests 
-              relating to <acronym>&smime;</acronym>. 
-              The syntax is <quote>"host:port"</quote>, for instance 
+	      Enter here the location of your <acronym>HTTP</acronym> Proxy,
+              which will be used for all <acronym>HTTP</acronym> requests
+              relating to <acronym>&smime;</acronym>.
+              The syntax is <quote>"host:port"</quote>, for instance
               <emphasis>myproxy.nowhere.com:3128</emphasis>.
 	    </para>
 	  </listitem>
@@ -1629,7 +1632,7 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     Entirely disables the use of <acronym>LDAP</acronym> for 
+	     Entirely disables the use of <acronym>LDAP</acronym> for
              <acronym>&smime;</acronym>.
 	    </para>
 	  </listitem>
@@ -1641,14 +1644,14 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     When looking for the location of a <acronym>CRL</acronym>, 
-             the <quote>"to-be-tested"</quote> certificate usually contains 
+	     When looking for the location of a <acronym>CRL</acronym>,
+             the <quote>"to-be-tested"</quote> certificate usually contains
              what are known as CRL Distribution Point (<acronym>DP</acronym>) entries,
-             which are <acronym>URLs</acronym> describing the way to access 
-             the <acronym>URL</acronym>. 
-             The first found <acronym>DP</acronym> entry is used.  
+             which are <acronym>URLs</acronym> describing the way to access
+             the <acronym>URL</acronym>.
+             The first found <acronym>DP</acronym> entry is used.
              With this option all entries using the <acronym>LDAP</acronym>
-             scheme are ignored when looking for a suitable 
+             scheme are ignored when looking for a suitable
              <acronym>DP</acronym>.
 	    </para>
 	  </listitem>
@@ -1660,17 +1663,17 @@
 	  </term>
 	  <listitem>
 	    <para>
-	     Entering a <acronym>LDAP</acronym> server here will make all 
-             <acronym>LDAP</acronym> requests go to that server first. 
-             More precisely, this setting overrides any specified host 
-             and port part in a <acronym>LDAP URL</acronym> and will also 
-             be used if host and port have been omitted from the 
-             <acronym>URL</acronym>. Other <acronym>LDAP</acronym> servers 
-             will be used only if the connection to the 
+	     Entering a <acronym>LDAP</acronym> server here will make all
+             <acronym>LDAP</acronym> requests go to that server first.
+             More precisely, this setting overrides any specified host
+             and port part in a <acronym>LDAP URL</acronym> and will also
+             be used if host and port have been omitted from the
+             <acronym>URL</acronym>. Other <acronym>LDAP</acronym> servers
+             will be used only if the connection to the
              <emphasis>proxy</emphasis> failed.
-             The syntax is <acronym>HOST</acronym> or 
-             <acronym>HOST:PORT</acronym>. If <acronym>PORT</acronym> is 
-             omitted, <quote>port 389</quote> 
+             The syntax is <acronym>HOST</acronym> or
+             <acronym>HOST:PORT</acronym>. If <acronym>PORT</acronym> is
+             omitted, <quote>port 389</quote>
              (standard <acronym>LDAP</acronym> port) is used.
 	    </para>
 	  </listitem>
@@ -1773,7 +1776,7 @@
 </para>
 </listitem>
 <listitem>
-<para>If <guilabel>Loop in Current Folder</guilabel> is selected then &kmail; 
+<para>If <guilabel>Loop in Current Folder</guilabel> is selected then &kmail;
 will search from the beginning of the current folder for an unread message. If
 none is found then nothing happens.</para>
 </listitem>
@@ -1802,7 +1805,7 @@
 <varlistentry>
 <term><guilabel>Mark selected message as read after...</guilabel></term>
 <listitem>
-<para>When you select a <guilabel>new</guilabel> or 
+<para>When you select a <guilabel>new</guilabel> or
 <guilabel>unread</guilabel> message, &kmail; will change the
 message's status to <guilabel>read</guilabel> after the number of seconds
 entered here. If you disable this option, messages will keep their
@@ -1832,8 +1835,8 @@
 <listitem>
 <para>Here you can set the folder that should be selected by default if you
 start &kmail;. If you use only &imap; folders then you might want to set
-this to your &imap; inbox folder. If you do that, you can collapse the local 
-folders in the folder list, and then they will stay collapsed when &kmail; 
+this to your &imap; inbox folder. If you do that, you can collapse the local
+folders in the folder list, and then they will stay collapsed when &kmail;
 starts.</para>
 </listitem>
 </varlistentry>
@@ -1842,7 +1845,7 @@
 <term><guilabel>Empty trash on program exit</guilabel></term>
 <listitem>
 <para>The trash folder is cleared of messages when you quit &kmail; if this
-option is selected.</para> 
+option is selected.</para>
 </listitem>
 </varlistentry>
 
@@ -1902,13 +1905,144 @@
 <varlistentry>
 <term><guilabel>Send invitations in the mail body</guilabel></term>
 <listitem>
-<para>Invitations use to be send as attachments to a mail. By enabling this option, you let the invitation mails to be sent in the text of the mail, which is necessary to send invitations and replies to Microsoft Outlook(tm).</para> 
+<para>Invitations use to be send as attachments to a mail. By enabling this option, you let the invitation mails to be sent in the text of the mail, which is necessary to send invitations and replies to Microsoft Outlook(tm).</para>
 </listitem>
 </varlistentry>
 </variablelist>
 </sect2>
 
+<sect2 id="configure-non-gui-options">
+<title>Options without a user interface representation</title>
+<para>
+Apart from the options presented in the configuration dialog, some options
+can only be set directly in the configuration file ($KDEHOME/share/config/kmailrc)
+or through KIOSK.
+</para>
 
+<variablelist>
+
+<varlistentry>
+<term><guilabel>Send Message Distribution Notifications with an empty sender string (SendMDNsWithEmptySender)</guilabel></term>
+<listitem>
+<para>
+Send Message Disposition Notifications with an empty sender string. Some servers might be configured to reject
+such messages, so if you are experiencing problems sending MDNs, make sure this option is set to false. To
+enable this feature, add a line reading:
+
+SendMDNsWithEmptySender=true
+
+to the [MDN] section of the kmail configuration file. If there is no such section, simply add "[MDN]" on
+a line by itself just above the option.
+
+Note that the default setting of "false" strictly speaking violates internet standards, but is
+set that way for practical reasons, to avoid servers rejecting MDNs that KMail generates because they
+think they are SPAM.
+</para>
+
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>Allow Semicolon As EMail Address Separator (AllowSemicolonAsAddressSeparator)</guilabel></term>
+<listitem>
+<para>
+In RFC2822, the comma (,) is the only allowed separator for email addresses in fields like To, CC and BCC. This option allows to also use the semi-colon (;) as separator. This only affects the user interface, the created messages still use commas only and thus do no violate the standard.
+
+The option is enabled by default. To disable the feature, add a line reading (under [Composer] section):
+</para>
+<programlisting>AllowSemicolonAsAddressSeparator=false
+</programlisting>
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>ForwardingInlineByDefault</guilabel></term>
+<listitem>
+<para>
+This option allows you to make inline forwarding the default forwarding method instead
+of forwarding as attachement.
+
+To enable the feature, add a line reading (under [Composer] section):
+</para>
+<programlisting>ForwardingInlineByDefault=true
+</programlisting>
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>MaximumAttachmentSize</guilabel></term>
+<listitem>
+<para>
+This allows the maximum file size allowed for attachments in the mail
+composer to be limited.
+
+To limit attachments to 20 MB ins size, for example, add a line reading (under [Composer] section):
+</para>
+<programlisting>MaximumAttachmentSize=20
+</programlisting>
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>CloseDespiteSystemTray</guilabel></term>
+<listitem>
+<para>
+This option allows you to configure the application to close fully, even if there
+is a system tray icon configured, which would normally keep the application running.
+
+To enable the feature, add a line reading (under [General] section):
+</para>
+<programlisting>CloseDespiteSystemTray=true
+</programlisting>
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>CheckOutOfOfficeOnStartup</guilabel></term>
+<listitem>
+<para>
+With this option enabled, KMail will check on every startup if there is an
+active out-of-office configured and show a warning if this is the case.
+
+To disable the feature, add a line reading (under [OutOfOffice] section):
+</para>
+<programlisting>CheckOutOfOfficeOnStartup=false
+</programlisting>
+</listitem>
+</varlistentry>
+
+
+<varlistentry>
+<term><guilabel>disregardUmask</guilabel></term>
+<listitem>
+<para>
+This option allows you to disregard the users umask setting and use "read-write for the user only".
+
+To enable the feature, add a line reading (under [General] section):
+</para>
+<programlisting>disregardUmask=false
+</programlisting>
+</listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guilabel>AutoLostFoundMove</guilabel></term>
+<listitem><para>Activate this option to automate the handling of not yet uploaded messages in disconnected IMAP
+folders that can not be uploaded. This can happen if the folder was removed from the server or your access
+rights have been restricted. Such messages will automatically moved to a newly created lost+found folder if
+this option is enabled, you will be ask how to proceed everytime otherwise.
+
+To enable the feature, add a line reading:
+</para>
+<programlisting>AutoLostFoundMove=true</programlisting>
+<para>to the [Behaviour] section of the configuration file </para>
+</listitem>
+</varlistentry>
+
+</variablelist>
+</sect2>
+
+
 </sect1>
 
 </chapter>
Index: doc/kmail/faq.docbook
===================================================================
--- doc/kmail/faq.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kmail/faq.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -554,7 +554,37 @@
 the &imap; account, the Local Folders will stay collapsed when &kmail; starts.
 </para></answer>
 </qandaentry>
+    <qandaentry id="faq-decrypt-on-read">
+      <!-- ideally, this should be in the documentation of the  -->
+      <!-- reader window, but oops, there's no documentation of -->
+      <!-- the reader window >:-(           (mmutz)             -->
+      <question>
+	<para>
+	  How do I enable permanent decryption of read messages?
+	</para>
+      </question>
+      <answer>
+	<para>
+	  The global reversal of encryption is considered extremely
+	  insecure. Shared access to messages for multiple persons
+	  should be implemented using semantic solutions (&eg; by
+	  defining roles like <quote>department
+	  manager</quote>).
+	</para>
+	<para>
+	  In case it is imperative to use it in the insecure mode, it
+	  has to be manually enabled in the file
+	  <filename>$KDEHOME/share/config/kmailrc</filename> by adding
+	  the following directive in the <literal>[Reader]</literal>
+	  group:
+	  <programlisting>
+	    store-displayed-messages-unencrypted=true
+	  </programlisting>
+	</para>
+      </answer>
+    </qandaentry>
 
+
 </qandaset>
 
 </chapter>
Index: doc/kmail/menus.docbook
===================================================================
--- doc/kmail/menus.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kmail/menus.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -692,6 +692,30 @@
 <term>
 <menuchoice>
 <guimenu>Folder</guimenu>
+<guimenuitem>Troubleshoot IMAP Cache...</guimenuitem>
+</menuchoice>
+</term>
+<listitem>
+<para>Opens a dialog that helps to solve problems with synchronizing disconnected &imap; folders.
+</para>
+<para><guilabel>Rebuild Index</guilabel>. As a first step to solve synchronization problems, you can rebuild the index file. This will take some time, but can not cause any problems or data loss.
+You can select if the indexes should be rebuilt for the selected folder only (<guilabel>Only current folder</guilabel>), the selected folder and its folder subtree (<guilabel>Current folder and all subfolders</guilabel>), or for the whole account (<guilabel>All folders of this account</guilabel>).
+</para>
+<para>
+<guilabel>Refresh Cache</guilabel>: 
+If rebuilding the index does not solve the problem, you can refresh the local IMAP cache for the current folder and all subfolders. The cache is deleted and the mails are refetched from the server. This will delete all your local changes in these folders!
+</para>
+<para>
+This option is only available for disconnected &imap; folders.
+</para>
+</listitem>
+</varlistentry>
+
+
+<varlistentry>
+<term>
+<menuchoice>
+<guimenu>Folder</guimenu>
 <guimenuitem>Move All Messages to Trash</guimenuitem>
 </menuchoice>
 </term>
Index: doc/kontact/index.docbook
===================================================================
--- doc/kontact/index.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kontact/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -211,7 +211,8 @@
 
 <para>If you dislike the sidebar, you can simply hide it by dragging the
 splitter. An alternative navigation between part is provided by the 
-<guilabel>navigator</guilabel> toolbar, which can be freely positioned.</para>
+<guilabel>navigator</guilabel> toolbar, which will always be aligned on the opposite
+side of the mainwindow from the side pane.</para>
 
 </sect1>
 
@@ -331,7 +332,9 @@
 </caption>
 </mediaobject>
 </screenshot>
-
+<para>
+Another common action is the <guimenuitem>Synchronize</guimenuitem> action. It synchronizes mail and groupware folders depending on the active component. E.g., if the Calendar component is active, the button synchronizes all Calendar folders. In the Summary, the action synchronizes all folders independent of their content. 
+</para>
 </sect1>
 
 <sect1 id="side-pane-drag-and-drop">
@@ -461,7 +464,21 @@
 
 </sect2>
 
+<sect2 id="side-pane-drag-and-drop-knotes-todo">
+<title>&knotes; -> &korganizer;'s Todo List</title>
 
+<para>
+Dragging a note from &knotes; to the icon for &korganizer;'s Todo List
+(<guiicon><inlinemediaobject><imageobject> <imagedata
+                                           fileref="todo-list-sidebar-icon.png" 
+                                           format="PNG"/>
+</imageobject></inlinemediaobject></guiicon>) will create a new Todo
+with the title set to the title of the note and the description set to the note itself.
+</para>
+
+</sect2>
+
+
 </sect1>
 
 </chapter>
@@ -929,7 +946,14 @@
 </sect2>
 
 </sect1>
-
+<sect1 id="kontact-configure-profiles">
+<title>&kontact; Profiles</title>
+<para>&kontact;'s profile support makes it possible to load and save user settings in profiles.
+The settings stored in the profile include typical Look&amp;Feel related options such as app-specific color schemes, icon sets, toolbar layout and application defaults. Personal information, e.g. accounts and identities are not stored in profiles. 
+Two default profiles are provided by Kontact: &quot;&kontact; Style&quot;, which contains the default &kontact; settings, and &quot;Outlook Style&quot;, adapting &kontact; to Microsoft Outlook Look&amp;Feel.
+The user can adapt existing profiles, create new profiles from his current settings, and import and export profiles. To manage profiles, choose &quot;Configure Profiles&quot; from the &quot;Settings&quot; menu.
+</para>
+</sect1>
 </chapter>
 
 
Index: doc/kalarm/editwindow.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = image/png
Index: doc/kalarm/index.docbook
===================================================================
--- doc/kalarm/index.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/kalarm/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -18,14 +18,14 @@
 <firstname>David</firstname>
 <surname>Jarvie</surname>
 <affiliation>
-<address><email>software@astrojar.org.uk</email></address>
+<address><email>&David.Jarvie.mail;</email></address>
 </affiliation>
 </author>
 
 <othercredit role="developer">
 <firstname>David</firstname>
 <surname>Jarvie</surname>
-<affiliation><address><email>software@astrojar.org.uk</email></address></affiliation>
+<affiliation><address><email>&David.Jarvie.mail;</email></address></affiliation>
 <contrib>Developer</contrib>
 </othercredit>
 
@@ -33,7 +33,7 @@
 </authorgroup>
 
 <copyright>
-<year>2001</year><year>2002</year><year>2003</year><year>2004</year><year>2005</year><year>2006</year>
+<year>2001</year><year>2002</year><year>2003</year><year>2004</year><year>2005</year><year>2006</year><year>2007</year><year>2008</year>
 <holder>David Jarvie</holder>
 </copyright>
 
@@ -41,8 +41,8 @@
 
 <!-- Don't change format of date and version of the documentation -->
 
-<date>2007-04-16</date>
-<releaseinfo>1.04.11</releaseinfo>
+<date>2008-01-23</date>
+<releaseinfo>1.05.00</releaseinfo>
 
 <abstract>
 <para>&kalarm; is a personal alarm message, command and email scheduler for &kde;.</para>
@@ -145,9 +145,10 @@
 <para>The main &kalarm; window displays the current list of pending
 alarms, showing their times, repetition intervals, colors, and
 message texts, names of files to display, commands to execute or email
-subjects. (For a recurring alarm or an alarm with a reminder, the time
-shown is its next scheduled trigger time.) An icon at the left of each
-alarm text/file/command/email subject indicates the type of
+subjects. (For a recurring alarm, the time shown is its next scheduled
+trigger time. For an alarm with a reminder, the time shown is the time
+of the alarm proper, not the reminder time.) An icon at the left of
+each alarm text/file/command/email subject indicates the type of
 alarm.</para>
 
 <screenshot>
@@ -771,9 +772,11 @@
 
 <itemizedlist>
 <listitem>
-<para>Enter the sound file path, or use the button beside the edit box
-to display a file selection dialog. You can listen to the selected
-file by clicking the play button to the left of the edit field.</para>
+<para>Enter the sound file path, or use the button beside the
+edit box to display a file selection dialog. You can listen to the
+selected file by clicking the play button to the left of the edit
+field. That button then changes function to allow you to stop playing
+when you have heard enough.</para>
 </listitem>
 
 <listitem>
@@ -815,21 +818,19 @@
 </listitem>
 
 <listitem>
-<para>Select the background color for the alarm message window.
-(The color selection list can be configured in the
-<link linkend="preferences-fontcolour">Preferences dialog</link>.)</para>
-</listitem>
-
-<listitem>
 <para>Use the <guibutton>Font &amp; Color...</guibutton> button to
-select a font, or foreground or background color, for the alarm
+select a font, and foreground and background colors, for the alarm
 message. In the <guilabel>Choose Alarm Font &amp; Color</guilabel>
 dialog, check <guilabel>Use default font</guilabel> to display the
 message in whatever font is configured as the default at the time
-the message is displayed. (The default font can be set in the
-<link linkend="preferences-fontcolour">Preferences dialog</link>.)
-To choose a specific font for the message, uncheck
-<guilabel>Use default font</guilabel>.</para>
+the message is displayed. To choose a specific font for the message,
+uncheck <guilabel>Use default font</guilabel>. (The default font, and
+the colors shown in the color selection lists, can be set in the
+<link linkend="preferences-fontcolour">Preferences dialog</link>.)</para>
+
+<para>The selected font and colors are shown in a sample text
+alongside the button. You can edit this text to show special
+characters.</para>
 </listitem>
 
 <listitem>
@@ -1040,12 +1041,9 @@
 its recurrences (if any). Enter how long in advance using the edit
 controls beside the checkbox.</para>
 
-<note><para>You can only display a reminder before each repetition of
-an alarm if the repetitions are set up using the
-<guilabel>Recurrence</guilabel> tab. If the
-<guibutton>Simple Repetition</guibutton> button is used instead, a
-reminder will be displayed before the first occurrence
-only.</para></note>
+<note><para>Reminders are not displayed for sub-repetitions within a
+recurrence. Reminders are only shown before each main
+recurrence of the alarm.</para></note>
 
 <para>If the alarm recurs, check <guilabel>Reminder for first
 recurrence only</guilabel> if you only want a reminder before the
@@ -1099,90 +1097,14 @@
 <title>Recurrence</title>
 
 <para>Specify whether or how the alarm should be repeated using the
-<guibutton>Simple Repetition</guibutton> button and the
-<guilabel>Recurrence</guilabel> tab. The
-<guilabel>Recurrence</guilabel> tab allows the greatest flexibility
-in setting up a recurrence, but for simple repetitions which can be
-described in terms of a number of occurrences with a fixed interval
-between, the <guibutton>Simple Repetition</guibutton> button
-provides a simpler dialog.</para>
+<guilabel>Recurrence</guilabel> tab.</para>
 
-<note><para>Reminders are handled differently depending on which
-method is used to set up a repeating alarm. If you use the
-<guibutton>Simple Repetition</guibutton> button a reminder will only
-be displayed before the alarm's first occurrence, whereas if you use
-the <guilabel>Recurrence</guilabel> tab a reminder will be displayed
-before each recurrence.</para></note>
+<note><para>The alarm's basic repetition characteristics are displayed
+for convenience in the title of the <guilabel>Recurrence</guilabel>
+tab. The recurrence interval is shown first, followed by any
+sub-repetition interval set up using the
+<guibutton>Sub-Repetition</guibutton> button.</para></note>
 
-<para>You can also use the <guibutton>Simple Repetition</guibutton>
-button in conjunction with the <guilabel>Recurrence</guilabel> tab to
-set up a repetition within a repetition. In this case, each time the
-alarm is due as specified in the <guilabel>Recurrence</guilabel> tab,
-instead of being triggered just once it is triggered repeatedly in
-accordance with your simple repetition specification. For example,
-to set up an alarm which repeats every hour from noon to 6 pm each
-Thursday, you would use the <guilabel>Recurrence</guilabel> tab to set
-up a weekly recurrence on Thursday at 12:00, and the Simple Repetition
-dialog to specify an interval of 1 hour and either a count of 7 or a
-duration of 6 hours.</para>
-
-<para>The alarm's basic repetition characteristics are displayed for
-convenience in the <guilabel>Alarm</guilabel> tab, beside the
-<guibutton>Simple Repetition</guibutton> button. The recurrence
-interval as set up in the <guilabel>Recurrence</guilabel> tab is shown
-first, followed by the repetition interval set up using the
-<guibutton>Simple Repetition</guibutton> button.</para>
-
-<sect3>
-<title>Simple Repetition dialog</title>
-
-<para>Check <guilabel>Repeat every</guilabel> to set up a repetition,
-or uncheck it to remove the repetition. If
-<guilabel>Repeat every</guilabel> is checked, set up the repetition as
-follows:</para>
-
-<itemizedlist>
-<listitem><para>Enter the time interval between repetitions in the
-controls beside <guilabel>Repeat every</guilabel>. Select the desired
-time units (&eg; <guilabel>days</guilabel>) and then enter the number
-of units.</para>
-</listitem>
-
-<listitem><para>Specify either the repetition count or its
-duration:</para>
-
-<itemizedlist>
-<listitem><para>Select <guilabel>Number of times</guilabel> to enter
-how many times the alarm should be triggered, including the initial
-occurrence. So, for example, to make the alarm occur an additional 3
-times after it first triggers, you should enter 4 here.</para>
-</listitem>
-
-<listitem><para>Select <guilabel>Duration</guilabel> to enter the
-total time period during which the alarm should be repeated. This need
-not be an exact multiple of the repetition interval; it will
-automatically be rounded down when you click
-<guibutton>OK</guibutton>.</para>
-</listitem>
-</itemizedlist>
-</listitem>
-</itemizedlist>
-
-<note><para>A simple repetition's duration is restricted if it is
-used in conjunction with a recurrence set up using the
-<guilabel>Recurrence</guilabel> tab. In this case, each time the alarm
-recurs as specified in the <guilabel>Recurrence</guilabel> tab, any
-still active simple repetition which started at the previous
-recurrence is automatically canceled. This prevents overlapping simple
-repetitions for the same alarm. The simple repetition's duration is
-therefore restricted to be less than the longest interval between
-recurrences.</para></note>
-
-</sect3>
-
-<sect3>
-<title>Recurrence tab</title>
-
 <para>In the <guilabel>Recurrence Rule</guilabel> group box, set the
 recurrence type or time period as follows:</para>
 
@@ -1256,6 +1178,60 @@
 <guibutton>Change</guibutton>. To delete an exception, highlight it
 in the list and press <guibutton>Delete</guibutton>.</para>
 
+<sect3>
+<title>Sub-Repetition</title>
+
+<para>You can use the <guibutton>Sub-Repetition</guibutton> button to
+set up a repetition within a repetition. In this case, each time the
+alarm is due as specified in the main recurrence, instead of being
+triggered just once it is triggered repeatedly in accordance with your
+sub-repetition specification. For example, to set up an alarm which
+repeats every hour from noon to 6 pm each Thursday, you would set up a
+weekly recurrence on Thursday at 12:00, and use the Sub-Repetition
+dialog to specify an interval of 1 hour and either a count of 6 or a
+duration of 6 hours.</para>
+
+<para>In the Sub-Repetition dialog which is displayed when you click
+the <guibutton>Sub-Repetition</guibutton> button, check
+<guilabel>Repeat every</guilabel> to set up a repetition, or uncheck
+it to remove the repetition. If <guilabel>Repeat every</guilabel> is
+checked, set up the repetition as follows:</para>
+
+<itemizedlist>
+<listitem><para>Enter the time interval between repetitions in the
+controls beside <guilabel>Repeat every</guilabel>. Select the desired
+time units (&eg; <guilabel>days</guilabel>) and then enter the number
+of units.</para>
+</listitem>
+
+<listitem><para>Specify either the repetition count or its
+duration:</para>
+
+<itemizedlist>
+<listitem><para>Select <guilabel>Number of times</guilabel> to enter
+how many times the alarm should be triggered after the main
+recurrence. So, for example, to make the alarm occur 4 times at each
+main recurrence, &ie; 3 additional times, you should enter 3
+here.</para>
+</listitem>
+
+<listitem><para>Select <guilabel>Duration</guilabel> to enter the
+total time period during which the alarm should be repeated. This need
+not be an exact multiple of the repetition interval; it will
+automatically be rounded down when you click
+<guibutton>OK</guibutton>.</para>
+</listitem>
+</itemizedlist>
+</listitem>
+</itemizedlist>
+
+<note><para>To prevent overlapping sub-repetitions for the same alarm,
+a sub-repetition's duration is restricted to be less than the longest
+interval between main recurrences. Each time the alarm recurs as
+specified in the main recurrence, any still active sub-repetition
+which started at the previous recurrence is automatically
+cancelled.</para></note>
+
 </sect3>
 </sect2>
 
@@ -2041,27 +2017,6 @@
 <itemizedlist>
 
 <listitem>
-<para><guilabel>Alarm List</guilabel> group box: These options control
-what information is initially shown in the alarm list, when &kalarm;
-starts up. (Once &kalarm; has started, use the <guimenu>View</guimenu>
-menu to change what is displayed.)</para>
-
-<itemizedlist>
-<listitem>
-<para><guilabel>Show alarm time</guilabel>: Select this option to show
-the date and time at which each alarm is next scheduled.</para>
-</listitem>
-
-<listitem>
-<para><guilabel>Show time until alarm</guilabel>: Select this option to
-show the length of time remaining before each alarm's next scheduled
-occurrence. The length of time is shown in days (if applicable), hours
-and minutes.</para>
-</listitem>
-</itemizedlist>
-</listitem>
-
-<listitem>
 <para><guilabel>System Tray Tooltip</guilabel> group box: These options
 control what information is shown in the tooltip which appears when the
 mouse cursor hovers over &kalarm;'s system tray icon.</para>
@@ -2107,14 +2062,6 @@
 details.</para>
 </listitem>
 
-<listitem><para><guilabel>Show expired alarms</guilabel>: Select this
-option to initially show expired alarms in the alarm list, when
-&kalarm; starts up. (Once &kalarm; has started, use the
-<menuchoice><guimenu>View</guimenu><guimenuitem>Show Expired
-Alarms</guimenuitem></menuchoice> menu option to change what is
-displayed.)</para>
-</listitem>
-
 <listitem><para><guilabel>System tray icon update interval</guilabel>: Set
 the frequency at which the &kalarm; system tray icon is updated to
 reflect whether alarms are currently being monitored. This involves
@@ -2939,8 +2886,8 @@
                      const KURL&amp; <replaceable>audioURL</replaceable>, 
                      int <replaceable>reminder</replaceable>, 
                      const QString&amp; <replaceable>recurrence</replaceable>,
-                     int <replaceable>simpleRepeatInterval</replaceable>, 
-                     int <replaceable>simpleRepeatCount</replaceable>)
+                     int <replaceable>subRepeatInterval</replaceable>, 
+                     int <replaceable>subRepeatCount</replaceable>)
 </synopsis>
 <synopsis>
 bool scheduleMessage(const QString&amp; <replaceable>message</replaceable>, 
@@ -3126,17 +3073,18 @@
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatInterval</parameter></term>
+<term><parameter>subRepeatInterval</parameter></term>
 <listitem>
-<para>Specifies the number of minutes between simple repetitions of
-the alarm. Specify 0 for no simple repetition.</para>
+<para>Specifies the number of minutes between sub-repetitions of
+the alarm. Specify 0 for no sub-repetition. Ignored if no recurrence
+is specified.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatCount</parameter></term>
+<term><parameter>subRepeatCount</parameter></term>
 <listitem>
-<para>Specifies the number of simple repetitions of the alarm,
+<para>Specifies the number of sub-repetitions of the alarm,
 including the initial occurrence.</para>
 </listitem>
 </varlistentry>
@@ -3183,8 +3131,8 @@
                   const KURL&amp; <replaceable>audioURL</replaceable>,
                   int <replaceable>reminder</replaceable>,
                   const QString&amp; <replaceable>recurrence</replaceable>,
-                  int <replaceable>simpleRepeatInterval</replaceable>, 
-                  int <replaceable>simpleRepeatCount</replaceable>)
+                  int <replaceable>subRepeatInterval</replaceable>, 
+                  int <replaceable>subRepeatCount</replaceable>)
 </synopsis>
 <synopsis>
 bool scheduleFile(const KURL&amp; <replaceable>URL</replaceable>,
@@ -3348,17 +3296,18 @@
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatInterval</parameter></term>
+<term><parameter>subRepeatInterval</parameter></term>
 <listitem>
-<para>Specifies the number of minutes between simple repetitions of
-the alarm. Specify 0 for no simple repetition.</para>
+<para>Specifies the number of minutes between sub-repetitions of
+the alarm. Specify 0 for no sub-repetition. Ignored if no recurrence
+is specified.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatCount</parameter></term>
+<term><parameter>subRepeatCount</parameter></term>
 <listitem>
-<para>Specifies the number of simple repetitions of the alarm,
+<para>Specifies the number of sub-repetitions of the alarm,
 including the initial occurrence.</para>
 </listitem>
 </varlistentry>
@@ -3394,8 +3343,8 @@
                      int <replaceable>lateCancel</replaceable>,
                      int <replaceable>flags</replaceable>,
                      const QString&amp; <replaceable>recurrence</replaceable>,
-                     int <replaceable>simpleRepeatInterval</replaceable>, 
-                     int <replaceable>simpleRepeatCount</replaceable>)
+                     int <replaceable>subRepeatInterval</replaceable>, 
+                     int <replaceable>subRepeatCount</replaceable>)
 </synopsis>
 <synopsis>
 bool scheduleCommand(const QString&amp; <replaceable>commandLine</replaceable>,
@@ -3521,17 +3470,18 @@
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatInterval</parameter></term>
+<term><parameter>subRepeatInterval</parameter></term>
 <listitem>
-<para>Specifies the number of minutes between simple repetitions of
-the alarm. Specify 0 for no simple repetition.</para>
+<para>Specifies the number of minutes between sub-repetitions of
+the alarm. Specify 0 for no sub-repetition. Ignored if no recurrence
+is specified.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatCount</parameter></term>
+<term><parameter>subRepeatCount</parameter></term>
 <listitem>
-<para>Specifies the number of simple repetitions of the alarm,
+<para>Specifies the number of sub-repetitions of the alarm,
 including the initial occurrence.</para>
 </listitem>
 </varlistentry>
@@ -3571,8 +3521,8 @@
                    int <replaceable>lateCancel</replaceable>,
                    int <replaceable>flags</replaceable>,
                    const QString&amp; <replaceable>recurrence</replaceable>,
-                   int <replaceable>simpleRepeatInterval</replaceable>, 
-                   int <replaceable>simpleRepeatCount</replaceable>)
+                   int <replaceable>subRepeatInterval</replaceable>, 
+                   int <replaceable>subRepeatCount</replaceable>)
 </synopsis>
 <synopsis>
 bool scheduleEmail(const QString&amp; <replaceable>fromID</replaceable>,
@@ -3736,17 +3686,18 @@
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatInterval</parameter></term>
+<term><parameter>subRepeatInterval</parameter></term>
 <listitem>
-<para>Specifies the number of minutes between simple repetitions of
-the alarm. Specify 0 for no simple repetition.</para>
+<para>Specifies the number of minutes between sub-repetitions of
+the alarm. Specify 0 for no sub-repetition. Ignored if no recurrence
+is specified.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry>
-<term><parameter>simpleRepeatCount</parameter></term>
+<term><parameter>subRepeatCount</parameter></term>
 <listitem>
-<para>Specifies the number of simple repetitions of the alarm,
+<para>Specifies the number of sub-repetitions of the alarm,
 including the initial occurrence.</para>
 </listitem>
 </varlistentry>
@@ -4016,11 +3967,14 @@
 (iCalendar)</ulink>. This is the standard format used by all kdepim
 applications. &kalarm; uses certain non-standard properties in the
 Alarm component, in conformance with RFC2445:
+<literal>X-KDE-KALARM-NEXTRECUR</literal>,
+<literal>X-KDE-KALARM-REPEAT</literal>,
 <literal>X-KDE-KALARM-TYPE</literal>,
+<literal>X-KDE-KALARM-NEXTREPEAT</literal>,
 <literal>X-KDE-KALARM-FONTCOLOR</literal>,
 <literal>X-KDE-KALARM-VOLUME</literal>,
 <literal>X-KDE-KALARM-SPEAK</literal>,
-<literal>X-KDE-KALARM-KMAILID</literal>.</para>
+<literal>X-KDE-KALARM-EMAILID</literal>.</para>
 </answer>
 </qandaentry>
 
@@ -4048,14 +4002,14 @@
 &kalarm;
 </para>
 <para>
-Program copyright 2001, 2002, 2003, 2004, 2005, 2006 David Jarvie <email>software@astrojar.org.uk</email>
+Program copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008 David Jarvie <email>&David.Jarvie.mail;</email>
 </para>
 <para>
 Alarm daemon authors:
 <itemizedlist>
 <listitem><para>Preston Brown <email>pbrown@kde.org</email></para>
 </listitem>
-<listitem><para>David Jarvie <email>software@astrojar.org.uk</email></para>
+<listitem><para>David Jarvie <email>&David.Jarvie.mail;</email></para>
 </listitem>
 <listitem><para>Cornelius Schumacher <email>schumacher@kde.org</email></para>
 </listitem>
@@ -4063,7 +4017,7 @@
 </para>
 
 <para>
-Documentation copyright 2001, 2002, 2003, 2004, 2005, 2006 David Jarvie <email>software@astrojar.org.uk</email>
+Documentation copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008 David Jarvie <email>&David.Jarvie.mail;</email>
 </para>
 
 <!-- TRANS:CREDIT_FOR_TRANSLATORS -->
Index: doc/korganizer/index.docbook
===================================================================
--- doc/korganizer/index.docbook	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ doc/korganizer/index.docbook	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,6 +4,8 @@
   <!ENTITY kappname "&korganizer;">
   <!ENTITY package "kdepim">
   <!ENTITY plugins-chapter SYSTEM "plugins-chapter.docbook">
+  <!ENTITY exchange-plugin-workshop SYSTEM "exchange-plugin.docbook">
+  <!ENTITY group-scheduling-workshop SYSTEM "group-scheduling.docbook">
   <!ENTITY outlook-to-vcalendar-workshop SYSTEM "outlook-to-vcalendar.docbook">
   <!ENTITY % addindex "IGNORE">
   <!ENTITY % English "INCLUDE">
@@ -1107,6 +1109,12 @@
 will be able to quickly identify the type of event by its color.
 </para>
 
+<para>
+The aganda view can display events from all your calendars merged into one view or
+show a view per calendar. Having both views available via tabs is also possible and
+can be <link linkend="config-main-views">customized in the preferences dialog</link>.
+</para>
+
 <sect3 id="day-view">
 <title>Day View</title>
 
@@ -1214,6 +1222,18 @@
 
 </sect2>
 
+<sect2 id="timeline-view">
+<title>Timeline View</title>
+
+<para> The timeline view shows all events for the selected timespan in a gantt
+view. Every calendar is displayed in a separate line. </para>
+
+<para>Hover your mouse over any calendar item to display a tooltip with the
+item details. Double click an empty area to create an event, double
+click any calendar item to edit it.</para>
+
+</sect2>
+
 <sect2 id="todo-view">
 <title>To-do List</title>
 
@@ -1798,12 +1818,16 @@
 <para>This tab shows the free/busy schedule chart on the right, where each line
 represents one of the attendees, listed on the left. The marked areas on the
 chart represent the time already taken by other events, unmarked areas represent
-time free from other events. The free/busy information is only available if the
+time free from other events. You can move the event to a different point in time
+by dragging it with the mouse, or resize it, by moving the edges of the highlighted
+area with the mouse.</para>
+
+<para>The free/busy information is only available if the
 attendee publishes his free/busy schedule, and if &korganizer; is correctly
 configured to retrieve it. For more information about configuring &korganizer;
 to publish and retrieve free/busy information, please check the
 <xref linkend="config" />. Double-clicking on an attendee entry in the list
-will allow you to enter the location of their free/busy information.
+will allow you to enter the location of their free/busy information. 
 </para>
 
 <variablelist>
@@ -1854,11 +1878,47 @@
 <sect2 id="entering-data-events-attachments">
 <title><guilabel>Attachments</guilabel> Tab</title>
 
-<para>Some to-dos require attachments. You can <guibutton>Add...</guibutton>, 
-<guibutton>Edit...</guibutton>, <guibutton>Remove</guibutton>, and
-<guibutton>Show</guibutton> attachments. You can refer to the attachment by
-entering the &URI; (path or Internet address) to the attachment.</para>
+<screenshot id="screenshot-event-attachments">
+<screeninfo>A screenshot of &korganizer;'s Edit Event dialog - Attachments tab</screeninfo>
+<mediaobject>
+<imageobject><imagedata fileref="event-attachments.png" format="PNG"/></imageobject>
+<textobject><phrase>A screenshot of &korganizer;'s Edit Event dialog - Attachments tab</phrase></textobject>
+<caption><para>A screenshot of &korganizer;'s Edit Event dialog - Attachments tab</para></caption>
+</mediaobject>
+</screenshot>
 
+<para>Events and to-dos can contain attachments. Attachments can either be stored as links
+or inline. The following actions are provided to work with attachments:</para>
+
+<variablelist>
+
+<varlistentry>
+<term><guibutton>Add URI...</guibutton></term>
+<listitem><para>Adds a link attachment.</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guibutton>Add File...</guibutton></term>
+<listitem><para>Adds an inline attachment.</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guibutton>Edit...</guibutton></term>
+<listitem><para>Allows to change an existing attachment.</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guibutton>Remove</guibutton></term>
+<listitem><para>Deletes the selected attachment.</para></listitem>
+</varlistentry>
+
+<varlistentry>
+<term><guibutton>Show</guibutton></term>
+<listitem><para>Display the selected attachment.</para></listitem>
+</varlistentry>
+
+</variablelist>
+
 <para>When you want to confirm, call off or revert the entered data, choose
 among the <link linkend="reference-action-buttons">Action Buttons</link>,
 <guibutton>OK</guibutton>, <guibutton>Apply</guibutton> and
@@ -2179,6 +2239,12 @@
 inserted in their calendar.
 </para>
 
+<para>Publishing an event as described above will only inform the receiver about
+the event, but not give her the option to ask for attendance. Use
+<menuchoice><guimenu>Schedule</guimenu><guimenuitem>Send as iCalendar...</guimenuitem></menuchoice>
+if you want to provide that option instead.
+</para>
+
 </sect1>
 
 
@@ -2222,9 +2288,12 @@
 to Attendees</guimenuitem></menuchoice> menu item.
 The attendees get an email containing all the relevant information
 for the event or to-do. They can respond to the meeting proposal by accepting or
-rejecting it or by making a counter proposal. All this information is sent to
-you by email again and, if you have configured &kmail; appropriately,
-the attendees responses are automatically inserted in your calendar.
+rejecting it or by making a counter proposal. They can also delegate or forward the 
+invitation.
+All this information is sent to you by email again and, if you have configured &kmail; 
+appropriately the attendees responses are automatically inserted in your calendar. If
+there are additional attendees willing to participate (e.g. by accepting a forwarded 
+invitation) you will be asked to accept the new attendees.
 </para>
 
 </sect2>
@@ -2271,7 +2340,12 @@
 <guibutton>Accept</guibutton> or <guibutton>Accept Cond.</guibutton>. The
 last two actions will insert the item to your calendar. In any case, &kmail; will
 send your response to the organizer automatically.</para>
-
+<para>You can also <guibutton>Delegate</guibutton> or <guibutton>Forward</guibutton> 
+the invitation. When delegating, you can suggest another person as your proxy.
+Using <guibutton>Forward</guibutton> you can forward the invitation to one or more 
+people not yet invited.
+When the receiver of the delegation or forward accepts the invitation, 
+the organizer will be asked to approve the new attendee.</para>
 <para>If for any reason you changed your mind, edit your status in the item's
 <link linkend="entering-data-events-attendees">attendee tab</link>. If you
 checked the <guilabel>Use Groupware Communication</guilabel> box
@@ -2564,6 +2638,15 @@
 </listitem>
 </varlistentry>
 
+<varlistentry>
+<term><guilabel>Default email attachment method</guilabel></term>
+<listitem><para>This option allows you to select the way an email is attached to
+an event. You can attach an email the complete email including attachments, the email
+excluding attachments or only a link to the email.</para>
+<para>Note that attaching an email without attachments might invalidate its signature.
+</para></listitem>
+</varlistentry>
+
 </variablelist>
 
 </sect2>
@@ -2739,6 +2822,13 @@
 all resources.</para></listitem>
 </varlistentry>
 
+<varlistentry>
+<term><guilabel>Agenda view calendar display</guilabel></term>
+<listitem><para>
+Select if all calendars should be merged into one agenda view, each calendar should
+be displayed in its own aganda view or if both view should be available via tabs.
+</para></listitem>
+</varlistentry>
 
 </variablelist>
 
Index: doc/korganizer/event-attachments.png
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream
Index: kalarm/kamail.cpp
===================================================================
--- kalarm/kamail.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kamail.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kamail.cpp  -  email functions
  *  Program:  kalarm
- *  Copyright ¬© 2002-2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2005,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -45,6 +45,7 @@
 
 #include <libkpimidentities/identitymanager.h>
 #include <libkpimidentities/identity.h>
+#include <libemailfunctions/email.h>
 #include <libkcal/person.h>
 
 #include <kmime_header_parsing.h>
@@ -105,14 +106,23 @@
 {
 	QString err;
 	QString from;
-	if (event.emailFromKMail().isEmpty())
+	KPIM::Identity identity;
+	if (!event.emailFromId())
 		from = Preferences::emailAddress();
 	else
 	{
-		from = mIdentityManager->identityForName(event.emailFromKMail()).fullEmailAddr();
+		identity = mIdentityManager->identityForUoid(event.emailFromId());
+		if (identity.isNull())
+		{
+			kdError(5950) << "KAMail::send(): identity" << event.emailFromId() << "not found" << endl;
+			errmsgs = errors(i18n("Invalid 'From' email address.\nKMail identity '%1' not found.").arg(event.emailFromId()));
+			return false;
+		}
+		from = identity.fullEmailAddr();
 		if (from.isEmpty())
 		{
-			errmsgs = errors(i18n("Invalid 'From' email address.\nKMail identity '%1' not found.").arg(event.emailFromKMail()));
+			kdError(5950) << "KAMail::send(): identity" << identity.identityName() << "uoid" << identity.uoid() << ": no email address" << endl;
+			errmsgs = errors(i18n("Invalid 'From' email address.\nEmail identity '%1' has no email address").arg(identity.identityName()));
 			return false;
 		}
 	}
@@ -147,6 +157,8 @@
 		                                         QString::fromLatin1("/sbin:/usr/sbin:/usr/lib"));
 		if (!command.isNull())
 		{
+			command += QString::fromLatin1(" -f ");
+			command += KPIM::getEmailAddress(from);
 			command += QString::fromLatin1(" -oi -t ");
 			textComplete = initHeaders(data, false);
 		}
@@ -542,6 +554,29 @@
 	identityManager();    // create identity manager if not already done
 	return mIdentityManager->begin() != mIdentityManager->end();
 }
+ 
+/******************************************************************************
+*  Fetch the uoid of an email identity name or uoid string.
+*/
+uint KAMail::identityUoid(const QString& identityUoidOrName)
+{
+	bool ok;
+	uint id = identityUoidOrName.toUInt(&ok);
+	if (!ok  ||  identityManager()->identityForUoid(id).isNull())
+	{
+		identityManager();   // fetch it if not already done
+		for (KPIM::IdentityManager::ConstIterator it = mIdentityManager->begin();
+		     it != mIdentityManager->end();  ++it)
+		{
+			if ((*it).identityName() == identityUoidOrName)
+			{
+				id = (*it).uoid();
+				break;
+			}
+		}
+	}
+	return id;
+}
 
 /******************************************************************************
 *  Fetch the user's email address configured in the KDE Control Centre.
Index: kalarm/alarmevent.cpp
===================================================================
--- kalarm/alarmevent.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/alarmevent.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmevent.cpp  -  represents calendar alarms and events
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -32,6 +32,7 @@
 #include "alarmtext.h"
 #include "functions.h"
 #include "kalarmapp.h"
+#include "kamail.h"
 #include "preferences.h"
 #include "alarmcalendar.h"
 #include "alarmevent.h"
@@ -43,8 +44,8 @@
 // KAlarm version which first used the current calendar/event format.
 // If this changes, KAEvent::convertKCalEvents() must be changed correspondingly.
 // The string version is the KAlarm version string used in the calendar file.
-QString KAEvent::calVersionString()  { return QString::fromLatin1("1.4.14"); }
-int     KAEvent::calVersion()        { return KAlarm::Version(1,4,14); }
+QString KAEvent::calVersionString()  { return QString::fromLatin1("1.5.0"); }
+int     KAEvent::calVersion()        { return KAlarm::Version(1,5,0); }
 
 // Custom calendar properties.
 // Note that all custom property names are prefixed with X-KDE-KALARM- in the calendar file.
@@ -67,7 +68,7 @@
 // - Display alarm properties
 static const QCString FONT_COLOUR_PROPERTY("FONTCOLOR");    // X-KDE-KALARM-FONTCOLOR property
 // - Email alarm properties
-static const QCString KMAIL_ID_PROPERTY("KMAILID");         // X-KDE-KALARM-KMAILID property
+static const QCString EMAIL_ID_PROPERTY("EMAILID");         // X-KDE-KALARM-EMAILID property
 // - Audio alarm properties
 static const QCString VOLUME_PROPERTY("VOLUME");            // X-KDE-KALARM-VOLUME property
 static const QCString SPEAK_PROPERTY("SPEAK");              // X-KDE-KALARM-SPEAK property
@@ -99,7 +100,7 @@
 {
 	const Alarm*           alarm;
 	QString                cleanText;       // text or audio file name
-	QString                emailFromKMail;
+	uint                   emailFromId;
 	EmailAddressList       emailAddresses;
 	QString                emailSubject;
 	QStringList            emailAttachments;
@@ -180,7 +181,6 @@
 	mArchiveReminderMinutes  = event.mArchiveReminderMinutes;
 	mDeferDefaultMinutes     = event.mDeferDefaultMinutes;
 	mRevision                = event.mRevision;
-	mRemainingRecurrences    = event.mRemainingRecurrences;
 	mAlarmCount              = event.mAlarmCount;
 	mDeferral                = event.mDeferral;
 	mLogFile                 = event.mLogFile;
@@ -225,16 +225,15 @@
 	mArchiveReminderMinutes = 0;
 	mDeferDefaultMinutes    = 0;
 	mLateCancel             = 0;
-	mRepeatInterval         = 0;
-	mRepeatCount            = 0;
 	mKMailSerialNumber      = 0;
 	mBgColour               = QColor(255, 255, 255);    // missing/invalid colour - return white background
 	mFgColour               = QColor(0, 0, 0);          // and black foreground
 	mDefaultFont            = true;
 	mEnabled                = true;
+	clearRecur();
 	bool ok;
 	bool dateOnly = false;
-	const QStringList& cats = event.categories();
+	const QStringList cats = event.categories();
 	for (unsigned int i = 0;  i < cats.count();  ++i)
 	{
 		if (cats[i] == DATE_ONLY_CATEGORY)
@@ -318,6 +317,7 @@
 	QString prop = event.customProperty(APPNAME, REPEAT_PROPERTY);
 	if (!prop.isEmpty())
 	{
+		// This property is used when the main alarm has expired
 		QStringList list = QStringList::split(':', prop);
 		if (list.count() >= 2)
 		{
@@ -339,27 +339,25 @@
 
 	// Extract status from the event's alarms.
 	// First set up defaults.
-	mActionType       = T_MESSAGE;
-	mMainExpired      = true;
-	mRepeatAtLogin    = false;
-	mDisplaying       = false;
-	mRepeatSound      = false;
-	mCommandScript    = false;
-	mDeferral         = NO_DEFERRAL;
-	mSoundVolume      = -1;
-	mFadeVolume       = -1;
-	mFadeSeconds      = 0;
-	mReminderMinutes  = 0;
-	mNextRepeat       = 0;
-	mText             = "";
-	mAudioFile        = "";
-	mPreAction        = "";
-	mPostAction       = "";
-	mEmailFromKMail   = "";
-	mEmailSubject     = "";
+	mActionType        = T_MESSAGE;
+	mMainExpired       = true;
+	mRepeatAtLogin     = false;
+	mDisplaying        = false;
+	mRepeatSound       = false;
+	mCommandScript     = false;
+	mDeferral          = NO_DEFERRAL;
+	mSoundVolume       = -1;
+	mFadeVolume        = -1;
+	mFadeSeconds       = 0;
+	mReminderMinutes   = 0;
+	mEmailFromIdentity = 0;
+	mText              = "";
+	mAudioFile         = "";
+	mPreAction         = "";
+	mPostAction        = "";
+	mEmailSubject      = "";
 	mEmailAddresses.clear();
 	mEmailAttachments.clear();
-	clearRecur();
 
 	// Extract data from all the event's alarms and index the alarms by sequence number
 	AlarmMap alarmMap;
@@ -491,10 +489,10 @@
 							mCommandScript = data.commandScript;
 							break;
 						case T_EMAIL:
-							mEmailFromKMail   = data.emailFromKMail;
-							mEmailAddresses   = data.emailAddresses;
-							mEmailSubject     = data.emailSubject;
-							mEmailAttachments = data.emailAttachments;
+							mEmailFromIdentity = data.emailFromId;
+							mEmailAddresses    = data.emailAddresses;
+							mEmailSubject      = data.emailSubject;
+							mEmailAttachments  = data.emailAttachments;
 							break;
 						default:
 							break;
@@ -526,6 +524,8 @@
 		if (nextRepeat <= mRepeatCount)
 			mNextRepeat = nextRepeat;
 	}
+	else
+		checkRepetition();
 
 	if (mMainExpired  &&  deferralOffset.asSeconds()  &&  checkRecur() != KARecurrence::NO_RECUR)
 	{
@@ -635,7 +635,7 @@
 			break;
 		case Alarm::Email:
 			data.action           = T_EMAIL;
-			data.emailFromKMail   = alarm.customProperty(APPNAME, KMAIL_ID_PROPERTY);
+			data.emailFromId      = alarm.customProperty(APPNAME, EMAIL_ID_PROPERTY).toUInt();
 			data.emailAddresses   = alarm.mailAddresses();
 			data.emailSubject     = alarm.mailSubject();
 			data.emailAttachments = alarm.mailAttachments();
@@ -800,16 +800,20 @@
 	mFgColour               = fg;
 	mFont                   = font;
 	mAlarmCount             = 1;
-	mLateCancel             = lateCancel;     // do this before set(flags)
-	mDeferral               = NO_DEFERRAL;    // do this before set(flags)
-	set(flags);
+	mLateCancel             = lateCancel;     // do this before setting flags
+	mDeferral               = NO_DEFERRAL;    // do this before setting flags
+
+	KAAlarmEventBase::set(flags & ~READ_ONLY_FLAGS);
+	mStartDateTime.setDateOnly(flags & ANY_TIME);
+	set_deferral((flags & DEFERRAL) ? NORMAL_DEFERRAL : NO_DEFERRAL);
+	mCommandXterm           = flags & EXEC_IN_XTERM;
+	mCopyToKOrganizer       = flags & COPY_KORGANIZER;
+	mEnabled                = !(flags & DISABLED);
+
 	mKMailSerialNumber      = 0;
 	mReminderMinutes        = 0;
 	mArchiveReminderMinutes = 0;
 	mDeferDefaultMinutes    = 0;
-	mRepeatInterval         = 0;
-	mRepeatCount            = 0;
-	mNextRepeat             = 0;
 	mArchiveRepeatAtLogin   = false;
 	mReminderOnceOnly       = false;
 	mDisplaying             = false;
@@ -847,32 +851,32 @@
 /******************************************************************************
  * Initialise an email KAEvent.
  */
-void KAEvent::setEmail(const QDate& d, const QString& from, const EmailAddressList& addresses, const QString& subject,
+void KAEvent::setEmail(const QDate& d, uint from, const EmailAddressList& addresses, const QString& subject,
 			    const QString& message, const QStringList& attachments, int lateCancel, int flags)
 {
 	set(d, message, QColor(), QColor(), QFont(), EMAIL, lateCancel, flags | ANY_TIME);
-	mEmailFromKMail   = from;
-	mEmailAddresses   = addresses;
-	mEmailSubject     = subject;
-	mEmailAttachments = attachments;
+	mEmailFromIdentity = from;
+	mEmailAddresses    = addresses;
+	mEmailSubject      = subject;
+	mEmailAttachments  = attachments;
 }
 
-void KAEvent::setEmail(const QDateTime& dt, const QString& from, const EmailAddressList& addresses, const QString& subject,
+void KAEvent::setEmail(const QDateTime& dt, uint from, const EmailAddressList& addresses, const QString& subject,
 			    const QString& message, const QStringList& attachments, int lateCancel, int flags)
 {
 	set(dt, message, QColor(), QColor(), QFont(), EMAIL, lateCancel, flags);
-	mEmailFromKMail   = from;
-	mEmailAddresses   = addresses;
-	mEmailSubject     = subject;
-	mEmailAttachments = attachments;
+	mEmailFromIdentity = from;
+	mEmailAddresses    = addresses;
+	mEmailSubject      = subject;
+	mEmailAttachments  = attachments;
 }
 
-void KAEvent::setEmail(const QString& from, const EmailAddressList& addresses, const QString& subject, const QStringList& attachments)
+void KAEvent::setEmail(uint from, const EmailAddressList& addresses, const QString& subject, const QStringList& attachments)
 {
-	mEmailFromKMail   = from;
-	mEmailAddresses   = addresses;
-	mEmailSubject     = subject;
-	mEmailAttachments = attachments;
+	mEmailFromIdentity = from;
+	mEmailAddresses    = addresses;
+	mEmailSubject      = subject;
+	mEmailAttachments  = attachments;
 }
 
 void KAEvent::setAudioFile(const QString& filename, float volume, float fadeVolume, int fadeSeconds)
@@ -900,40 +904,13 @@
 }
 
 /******************************************************************************
- * Reinitialise the start date/time by adjusting its date part, and setting
- * the next scheduled alarm to the new start date/time.
- */
-void KAEvent::adjustStartDate(const QDate& d)
-{
-	if (mStartDateTime.isDateOnly())
-	{
-		mStartDateTime = d;
-		if (mRecurrence)
-			mRecurrence->setStartDate(d);
-	}
-	else
-	{
-		mStartDateTime.set(d, mStartDateTime.time());
-		if (mRecurrence)
-			mRecurrence->setStartDateTime(mStartDateTime.dateTime());
-	}
-	mNextMainDateTime = mStartDateTime;
-}
-
-/******************************************************************************
  * Return the time of the next scheduled occurrence of the event.
  * Reminders and deferred reminders can optionally be ignored.
  */
-DateTime KAEvent::nextDateTime(bool includeReminders) const
+DateTime KAEvent::displayDateTime() const
 {
-	if (includeReminders  &&  mReminderMinutes)
-	{
-		if (!mReminderOnceOnly  ||  mNextMainDateTime == mStartDateTime)
-			return mNextMainDateTime.addSecs(-mReminderMinutes * 60);
-	}
 	DateTime dt = mainDateTime(true);
-	if (mDeferral > 0
-	&&  (includeReminders  ||  mDeferral != REMINDER_DEFERRAL))
+	if (mDeferral > 0  &&  mDeferral != REMINDER_DEFERRAL)
 	{
 		if (mMainExpired)
 			return mDeferralTime;
@@ -1008,17 +985,6 @@
 	return ACTIVE;
 }
 
-void KAEvent::set(int flags)
-{
-	KAAlarmEventBase::set(flags & ~READ_ONLY_FLAGS);
-	mStartDateTime.setDateOnly(flags & ANY_TIME);
-	set_deferral((flags & DEFERRAL) ? NORMAL_DEFERRAL : NO_DEFERRAL);
-	mCommandXterm     = flags & EXEC_IN_XTERM;
-	mCopyToKOrganizer = flags & COPY_KORGANIZER;
-	mEnabled          = !(flags & DISABLED);
-	mUpdated          = true;
-}
-
 int KAEvent::flags() const
 {
 	return KAAlarmEventBase::flags()
@@ -1191,15 +1157,20 @@
 	if (mDeferral > 0  ||  mDeferral == CANCEL_DEFERRAL && !cancelCancelledDefer)
 	{
 		DateTime nextDateTime = mNextMainDateTime;
-		if (mMainExpired && !original  &&  checkRecur() != KARecurrence::NO_RECUR)
+		if (mMainExpired)
 		{
-			// It's a deferral of an expired recurrence.
-			// Need to ensure that the alarm offset is to an occurrence
-			// which isn't excluded by an exception - otherwise, it will
-			// never be triggered. So choose the first recurrence which
-			// isn't an exception.
-			nextDateTime = mRecurrence->getNextDateTime(mStartDateTime.dateTime().addDays(-1));
-			nextDateTime.setDateOnly(mStartDateTime.isDateOnly());
+			if (checkRecur() == KARecurrence::NO_RECUR)
+				nextDateTime = mStartDateTime;
+			else if (!original)
+			{
+				// It's a deferral of an expired recurrence.
+				// Need to ensure that the alarm offset is to an occurrence
+				// which isn't excluded by an exception - otherwise, it will
+				// never be triggered. So choose the first recurrence which
+				// isn't an exception.
+				nextDateTime = mRecurrence->getNextDateTime(mStartDateTime.dateTime().addDays(-1));
+				nextDateTime.setDateOnly(mStartDateTime.isDateOnly());
+			}
 		}
 		int startOffset;
 		QStringList list;
@@ -1355,8 +1326,8 @@
 					break;
 				case T_EMAIL:
 					alarm->setEmailAlarm(mEmailSubject, mText, mEmailAddresses, mEmailAttachments);
-					if (!mEmailFromKMail.isEmpty())
-						alarm->setCustomProperty(APPNAME, KMAIL_ID_PROPERTY, mEmailFromKMail);
+					if (mEmailFromIdentity)
+						alarm->setCustomProperty(APPNAME, EMAIL_ID_PROPERTY, QString::number(mEmailFromIdentity));
 					break;
 				case T_AUDIO:
 					break;
@@ -1408,10 +1379,10 @@
 		al.mCommandScript  = mCommandScript;
 		if (mActionType == T_EMAIL)
 		{
-			al.mEmailFromKMail   = mEmailFromKMail;
-			al.mEmailAddresses   = mEmailAddresses;
-			al.mEmailSubject     = mEmailSubject;
-			al.mEmailAttachments = mEmailAttachments;
+			al.mEmailFromIdentity = mEmailFromIdentity;
+			al.mEmailAddresses    = mEmailAddresses;
+			al.mEmailSubject      = mEmailSubject;
+			al.mEmailAttachments  = mEmailAttachments;
 		}
 		switch (type)
 		{
@@ -1613,7 +1584,8 @@
 					set_deferral(NO_DEFERRAL);
 			}
 			// Remove any reminder alarm, but keep a note of it for archiving purposes
-			set_archiveReminder();
+			if (mReminderMinutes)
+				set_archiveReminder();
 		}
 		if (mDeferral != REMINDER_DEFERRAL)
 		{
@@ -1866,7 +1838,7 @@
 
 /******************************************************************************
  * Determine whether the event will occur after the specified date/time.
- * If 'includeRepetitions' is true and the alarm has a simple repetition, it
+ * If 'includeRepetitions' is true and the alarm has a sub-repetition, it
  * returns true if any repetitions occur after the specified date/time.
  */
 bool KAEvent::occursAfter(const QDateTime& preDateTime, bool includeRepetitions) const
@@ -1893,8 +1865,7 @@
 
 	if (includeRepetitions  &&  mRepeatCount)
 	{
-		dt.addSecs(mRepeatCount * mRepeatInterval * 60);
-		if (preDateTime < dt)
+		if (preDateTime < dt.addSecs(mRepeatCount * mRepeatInterval * 60))
 			return true;
 	}
 	return false;
@@ -1912,7 +1883,7 @@
 	QDateTime pre = preDateTime;
 	if (includeRepetitions != IGNORE_REPETITION)
 	{
-		if (!mRepeatCount)
+		if (!mRepeatCount  ||  !mRepeatInterval)
 			includeRepetitions = IGNORE_REPETITION;
 		else
 		{
@@ -1924,10 +1895,7 @@
 	OccurType type;
 	bool recurs = (checkRecur() != KARecurrence::NO_RECUR);
 	if (recurs)
-	{
-		int remainingCount;
-		type = nextRecurrence(pre, result, remainingCount);
-	}
+		type = nextRecurrence(pre, result);
 	else if (pre < mNextMainDateTime.dateTime())
 	{
 		result = mNextMainDateTime;
@@ -1939,15 +1907,15 @@
 		type = NO_OCCURRENCE;
 	}
 
-	if (type != NO_OCCURRENCE  &&  result <= preDateTime)
+	if (type != NO_OCCURRENCE  &&  result <= preDateTime  &&  includeRepetitions != IGNORE_REPETITION)
 	{
-		// The next occurrence is a simple repetition
+		// The next occurrence is a sub-repetition
 		int repetition = result.secsTo(preDateTime) / repeatSecs + 1;
 		DateTime repeatDT = result.addSecs(repetition * repeatSecs);
 		if (recurs)
 		{
 			// We've found a recurrence before the specified date/time, which has
-			// a simple repetition after the date/time.
+			// a sub-repetition after the date/time.
 			// However, if the intervals between recurrences vary, we could possibly
 			// have missed a later recurrence, which fits the criterion, so check again.
 			DateTime dt;
@@ -1958,7 +1926,7 @@
 				result = dt;
 				if (includeRepetitions == RETURN_REPETITION  &&  result <= preDateTime)
 				{
-					// The next occurrence is a simple repetition
+					// The next occurrence is a sub-repetition
 					int repetition = result.secsTo(preDateTime) / repeatSecs + 1;
 					result = result.addSecs(repetition * repeatSecs);
 					type = static_cast<OccurType>(type | OCCURRENCE_REPEAT);
@@ -1968,7 +1936,7 @@
 		}
 		if (includeRepetitions == RETURN_REPETITION)
 		{
-			// The next occurrence is a simple repetition
+			// The next occurrence is a sub-repetition
 			result = repeatDT;
 			type = static_cast<OccurType>(type | OCCURRENCE_REPEAT);
 		}
@@ -1979,7 +1947,7 @@
 /******************************************************************************
  * Get the date/time of the last previous occurrence of the event, before the
  * specified date/time.
- * If 'includeRepetitions' is true and the alarm has a simple repetition, the
+ * If 'includeRepetitions' is true and the alarm has a sub-repetition, the
  * last previous repetition is returned if appropriate.
  * 'result' = date/time of previous occurrence, or invalid date/time if none.
  */
@@ -2042,9 +2010,9 @@
  * Set the date/time of the event to the next scheduled occurrence after the
  * specified date/time, provided that this is later than its current date/time.
  * Any reminder alarm is adjusted accordingly.
- * If 'includeRepetitions' is true and the alarm has a simple repetition, and
- * a repetition of a previous recurrence occurs after the specified date/time,
- * that repetition is set as the next occurrence.
+ * If the alarm has a sub-repetition, and a repetition of a previous
+ * recurrence occurs after the specified date/time, that repetition is set as
+ * the next occurrence.
  */
 KAEvent::OccurType KAEvent::setNextOccurrence(const QDateTime& preDateTime)
 {
@@ -2066,16 +2034,13 @@
 	}
 	else if (checkRecur() != KARecurrence::NO_RECUR)
 	{
-		int remainingCount;
-		type = nextRecurrence(pre, dt, remainingCount);
+		type = nextRecurrence(pre, dt);
 		if (type == NO_OCCURRENCE)
 			return NO_OCCURRENCE;
 		if (type != FIRST_OR_ONLY_OCCURRENCE  &&  dt != mNextMainDateTime)
 		{
 			// Need to reschedule the next trigger date/time
 			mNextMainDateTime = dt;
-			if (mRecurrence->duration() > 0)
-				mRemainingRecurrences = remainingCount;
 			// Reinstate the reminder (if any) for the rescheduled recurrence
 			if (mDeferral == REMINDER_DEFERRAL  ||  mArchiveReminderMinutes)
 			{
@@ -2100,7 +2065,7 @@
 		int secs = dt.dateTime().secsTo(preDateTime);
 		if (secs >= 0)
 		{
-			// The next occurrence is a simple repetition.
+			// The next occurrence is a sub-repetition.
 			type = static_cast<OccurType>(type | OCCURRENCE_REPEAT);
 			mNextRepeat = (secs / (60 * mRepeatInterval)) + 1;
 			// Repetitions can't have a reminder, so remove any.
@@ -2124,26 +2089,23 @@
  * Get the date/time of the next recurrence of the event, after the specified
  * date/time.
  * 'result' = date/time of next occurrence, or invalid date/time if none.
- * 'remainingCount' = number of repetitions due, including the next occurrence.
  */
-KAEvent::OccurType KAEvent::nextRecurrence(const QDateTime& preDateTime, DateTime& result, int& remainingCount) const
+KAEvent::OccurType KAEvent::nextRecurrence(const QDateTime& preDateTime, DateTime& result) const
 {
 	QDateTime recurStart = mRecurrence->startDateTime();
 	QDateTime pre = preDateTime;
 	if (mStartDateTime.isDateOnly()  &&  preDateTime.time() < Preferences::startOfDay())
+	{
 		pre = pre.addDays(-1);    // today's recurrence (if today recurs) is still to come
-	remainingCount = 0;
+		pre.setTime(Preferences::startOfDay());
+	}
 	QDateTime dt = mRecurrence->getNextDateTime(pre);
 	result.set(dt, mStartDateTime.isDateOnly());
 	if (!dt.isValid())
 		return NO_OCCURRENCE;
 	if (dt == recurStart)
-	{
-		remainingCount = mRecurrence->duration();
 		return FIRST_OR_ONLY_OCCURRENCE;
-	}
-	remainingCount = mRecurrence->duration() - mRecurrence->durationTo(dt) + 1;
-	if (remainingCount == 1)
+	if (mRecurrence->duration() >= 0  &&  dt == mRecurrence->endDateTime())
 		return LAST_RECURRENCE;
 	return result.isDateOnly() ? RECURRENCE_DATE : RECURRENCE_DATE_TIME;
 }
@@ -2239,9 +2201,8 @@
 	// Set the frequency to 1 to find the first possible occurrence
 	int frequency = mRecurrence->frequency();
 	mRecurrence->setFrequency(1);
-	int remainingCount;
 	DateTime next;
-	nextRecurrence(mNextMainDateTime.dateTime(), next, remainingCount);
+	nextRecurrence(mNextMainDateTime.dateTime(), next);
 	if (!next.isValid())
 		mRecurrence->setStartDateTime(recurStart);   // reinstate the old value
 	else
@@ -2266,22 +2227,16 @@
 		mRecurrence = new KARecurrence(recurrence);
 		mRecurrence->setStartDateTime(mStartDateTime.dateTime());
 		mRecurrence->setFloats(mStartDateTime.isDateOnly());
-		mRemainingRecurrences = mMainExpired ? 0 : mRecurrence->duration();
-		if (mRemainingRecurrences > 0  &&  !isTemplate())
-			mRemainingRecurrences -= mRecurrence->durationTo(mNextMainDateTime.dateTime()) - 1;
 	}
 	else
-	{
 		mRecurrence = 0;
-		mRemainingRecurrences = 0;
-	}
 
-	// Adjust simple repetition values to fit the recurrence
+	// Adjust sub-repetition values to fit the recurrence
 	setRepetition(mRepeatInterval, mRepeatCount);
 }
 
 /******************************************************************************
-*  Initialise the event's simple repetition.
+*  Initialise the event's sub-repetition.
 *  The repetition length is adjusted if necessary to fit any recurrence interval.
 *  Reply = false if a non-daily interval was specified for a date-only recurrence.
 */
@@ -2293,6 +2248,7 @@
 	mNextRepeat     = 0;
 	if (interval > 0  &&  count > 0  &&  !mRepeatAtLogin)
 	{
+		Q_ASSERT(checkRecur() != KARecurrence::NO_RECUR);
 		if (interval % 1440  &&  mStartDateTime.isDateOnly())
 			return false;    // interval must be in units of days for date-only alarms
 		if (checkRecur() != KARecurrence::NO_RECUR)
@@ -2476,7 +2432,6 @@
 		if (mRecurrence->init(recurType, freq, count, mNextMainDateTime, end, feb29))
 		{
 			mUpdated = true;
-			mRemainingRecurrences = count;
 			return true;
 		}
 	}
@@ -2489,17 +2444,19 @@
  */
 void KAEvent::clearRecur()
 {
-	mUpdated = true;
 	delete mRecurrence;
-	mRecurrence = 0;
-	mRemainingRecurrences = 0;
+	mRecurrence     = 0;
+	mRepeatInterval = 0;
+	mRepeatCount    = 0;
+	mNextRepeat     = 0;
+	mUpdated        = true;
 }
 
 /******************************************************************************
- * Validate the event's recurrence and alarm repetition data, correcting any
- * inconsistencies (which should never occur!).
- * Reply = true if a recurrence (as opposed to a login repetition) exists.
- */
+* Validate the event's recurrence data, correcting any inconsistencies (which
+* should never occur!).
+* Reply = true if a recurrence (as opposed to a login repetition) exists.
+*/
 KARecurrence::Type KAEvent::checkRecur() const
 {
 	if (mRecurrence)
@@ -2517,10 +2474,7 @@
 				return type;
 			default:
 				if (mRecurrence)
-				{
-					delete mRecurrence;     // this shouldn't exist!!
-					const_cast<KAEvent*>(this)->mRecurrence = 0;
-				}
+					const_cast<KAEvent*>(this)->clearRecur();  // recurrence shouldn't exist!!
 				break;
 		}
 	}
@@ -2552,6 +2506,18 @@
 	return 0;
 }
 
+/******************************************************************************
+* Validate the event's alarm sub-repetition data, correcting any
+* inconsistencies (which should never occur!).
+*/
+void KAEvent::checkRepetition() const
+{
+	if (mRepeatCount  &&  !mRepeatInterval)
+		const_cast<KAEvent*>(this)->mRepeatCount = 0;
+	if (!mRepeatCount  &&  mRepeatInterval)
+		const_cast<KAEvent*>(this)->mRepeatInterval = 0;
+}
+
 #if 0
 /******************************************************************************
  * Convert a QValueList<WDayPos> to QValueList<MonthPos>.
@@ -2621,7 +2587,7 @@
 	for (Event::List::ConstIterator evit = events.begin();  evit != events.end();  ++evit)
 	{
 		Event* event = *evit;
-		const QStringList& cats = event->categories();
+		const QStringList cats = event->categories();
 		if (cats.find(DATE_ONLY_CATEGORY) != cats.end())
 		{
 			// It's an untimed event, so fix it
@@ -2720,6 +2686,9 @@
 	// KAlarm pre-1.3.1 XTERM category
 	static const QString EXEC_IN_XTERM_CAT  = QString::fromLatin1("XTERM");
 
+	// KAlarm pre-1.4.22 properties
+	static const QCString KMAIL_ID_PROPERTY("KMAILID");    // X-KDE-KALARM-KMAILID property
+
 	if (version >= calVersion())
 		return;
 
@@ -2732,7 +2701,8 @@
 	bool pre_1_3_0 = (version < KAlarm::Version(1,3,0));
 	bool pre_1_3_1 = (version < KAlarm::Version(1,3,1));
 	bool pre_1_4_14 = (version < KAlarm::Version(1,4,14));
-	Q_ASSERT(calVersion() == KAlarm::Version(1,4,14));
+	bool pre_1_5_0 = (version < KAlarm::Version(1,5,0));
+	Q_ASSERT(calVersion() == KAlarm::Version(1,5,0));
 
 	QDateTime dt0(QDate(1970,1,1), QTime(0,0,0));
 	QTime startOfDay = Preferences::startOfDay();
@@ -2940,7 +2910,6 @@
 					break;
 				}
 			}
-
 		}
 
 		if (pre_1_1_1)
@@ -3096,9 +3065,90 @@
 				}
 			}
 		}
+		
+		if (pre_1_5_0)
+		{
+			/*
+			 * It's a KAlarm pre-1.5.0 calendar file.
+			 * Convert email identity names to uoids.
+			 * Convert simple repetitions without a recurrence, to a recurrence.
+			 */
+			for (Alarm::List::ConstIterator alit = alarms.begin();  alit != alarms.end();  ++alit)
+			{
+				Alarm* alarm = *alit;
+				QString name = alarm->customProperty(APPNAME, KMAIL_ID_PROPERTY);
+				if (name.isEmpty())
+					continue;
+				uint id = KAMail::identityUoid(name);
+				if (id)
+					alarm->setCustomProperty(APPNAME, EMAIL_ID_PROPERTY, QString::number(id));
+				alarm->removeCustomProperty(APPNAME, KMAIL_ID_PROPERTY);
+			}
+			convertRepetition(event);
+		}
 	}
 }
 
+/******************************************************************************
+* If the calendar was written by a pre-1.4.22 version of KAlarm, or another
+* program, convert simple repetitions in events without a recurrence, to a
+* recurrence.
+* Reply = true if any conversions were done.
+*/
+void KAEvent::convertRepetitions(KCal::CalendarLocal& calendar)
+{
+
+	Event::List events = calendar.rawEvents();
+	for (Event::List::ConstIterator ev = events.begin();  ev != events.end();  ++ev)
+		convertRepetition(*ev);
+}
+
+/******************************************************************************
+* Convert simple repetitions in an event without a recurrence, to a
+* recurrence. Repetitions which are an exact multiple of 24 hours are converted
+* to daily recurrences; else they are converted to minutely recurrences. Note
+* that daily and minutely recurrences produce different results when they span
+* a daylight saving time change.
+* Reply = true if any conversions were done.
+*/
+bool KAEvent::convertRepetition(KCal::Event* event)
+{
+	Alarm::List alarms = event->alarms();
+	if (alarms.isEmpty())
+		return false;
+	Recurrence* recur = event->recurrence();   // guaranteed to return non-null
+	if (!recur->doesRecur())
+		return false;
+	bool converted = false;
+	bool readOnly = event->isReadOnly();
+	for (Alarm::List::ConstIterator alit = alarms.begin();  alit != alarms.end();  ++alit)
+	{
+		Alarm* alarm = *alit;
+		if (alarm->repeatCount() > 0  &&  alarm->snoozeTime() > 0)
+		{
+			if (!converted)
+			{
+				if (readOnly)
+					event->setReadOnly(false);
+				if (alarm->snoozeTime() % (24*3600))
+					recur->setMinutely(alarm->snoozeTime());
+				else
+					recur->setDaily(alarm->snoozeTime() / (24*3600));
+				recur->setDuration(alarm->repeatCount() + 1);
+				converted = true;
+			}
+			alarm->setRepeatCount(0);
+			alarm->setSnoozeTime(0);
+		}
+	}
+	if (converted)
+	{
+		if (readOnly)
+			event->setReadOnly(true);
+	}
+	return converted;
+}
+
 #ifndef NDEBUG
 void KAEvent::dumpDebug() const
 {
@@ -3149,8 +3199,6 @@
 	}
 	kdDebug(5950) << "-- mRevision:" << mRevision << ":\n";
 	kdDebug(5950) << "-- mRecurrence:" << (mRecurrence ? "true" : "false") << ":\n";
-	if (mRecurrence)
-		kdDebug(5950) << "-- mRemainingRecurrences:" << mRemainingRecurrences << ":\n";
 	kdDebug(5950) << "-- mAlarmCount:" << mAlarmCount << ":\n";
 	kdDebug(5950) << "-- mMainExpired:" << (mMainExpired ? "true" : "false") << ":\n";
 	kdDebug(5950) << "KAEvent dump end\n";
@@ -3230,34 +3278,34 @@
 
 void KAAlarmEventBase::copy(const KAAlarmEventBase& rhs)
 {
-	mEventID          = rhs.mEventID;
-	mText             = rhs.mText;
-	mNextMainDateTime = rhs.mNextMainDateTime;
-	mBgColour         = rhs.mBgColour;
-	mFgColour         = rhs.mFgColour;
-	mFont             = rhs.mFont;
-	mEmailFromKMail   = rhs.mEmailFromKMail;
-	mEmailAddresses   = rhs.mEmailAddresses;
-	mEmailSubject     = rhs.mEmailSubject;
-	mEmailAttachments = rhs.mEmailAttachments;
-	mSoundVolume      = rhs.mSoundVolume;
-	mFadeVolume       = rhs.mFadeVolume;
-	mFadeSeconds      = rhs.mFadeSeconds;
-	mActionType       = rhs.mActionType;
-	mCommandScript    = rhs.mCommandScript;
-	mRepeatCount      = rhs.mRepeatCount;
-	mRepeatInterval   = rhs.mRepeatInterval;
-	mNextRepeat       = rhs.mNextRepeat;
-	mBeep             = rhs.mBeep;
-	mSpeak            = rhs.mSpeak;
-	mRepeatSound      = rhs.mRepeatSound;
-	mRepeatAtLogin    = rhs.mRepeatAtLogin;
-	mDisplaying       = rhs.mDisplaying;
-	mLateCancel       = rhs.mLateCancel;
-	mAutoClose        = rhs.mAutoClose;
-	mEmailBcc         = rhs.mEmailBcc;
-	mConfirmAck       = rhs.mConfirmAck;
-	mDefaultFont      = rhs.mDefaultFont;
+	mEventID           = rhs.mEventID;
+	mText              = rhs.mText;
+	mNextMainDateTime  = rhs.mNextMainDateTime;
+	mBgColour          = rhs.mBgColour;
+	mFgColour          = rhs.mFgColour;
+	mFont              = rhs.mFont;
+	mEmailFromIdentity = rhs.mEmailFromIdentity;
+	mEmailAddresses    = rhs.mEmailAddresses;
+	mEmailSubject      = rhs.mEmailSubject;
+	mEmailAttachments  = rhs.mEmailAttachments;
+	mSoundVolume       = rhs.mSoundVolume;
+	mFadeVolume        = rhs.mFadeVolume;
+	mFadeSeconds       = rhs.mFadeSeconds;
+	mActionType        = rhs.mActionType;
+	mCommandScript     = rhs.mCommandScript;
+	mRepeatCount       = rhs.mRepeatCount;
+	mRepeatInterval    = rhs.mRepeatInterval;
+	mNextRepeat        = rhs.mNextRepeat;
+	mBeep              = rhs.mBeep;
+	mSpeak             = rhs.mSpeak;
+	mRepeatSound       = rhs.mRepeatSound;
+	mRepeatAtLogin     = rhs.mRepeatAtLogin;
+	mDisplaying        = rhs.mDisplaying;
+	mLateCancel        = rhs.mLateCancel;
+	mAutoClose         = rhs.mAutoClose;
+	mEmailBcc          = rhs.mEmailBcc;
+	mConfirmAck        = rhs.mConfirmAck;
+	mDefaultFont       = rhs.mDefaultFont;
 }
 
 void KAAlarmEventBase::set(int flags)
@@ -3304,7 +3352,7 @@
 	kdDebug(5950) << "-- mNextMainDateTime:" << mNextMainDateTime.toString() << ":\n";
 	if (mActionType == T_EMAIL)
 	{
-		kdDebug(5950) << "-- mEmail: FromKMail:" << mEmailFromKMail << ":\n";
+		kdDebug(5950) << "-- mEmail: FromKMail:" << mEmailFromIdentity << ":\n";
 		kdDebug(5950) << "--         Addresses:" << mEmailAddresses.join(", ") << ":\n";
 		kdDebug(5950) << "--         Subject:" << mEmailSubject << ":\n";
 		kdDebug(5950) << "--         Attachments:" << mEmailAttachments.join(", ") << ":\n";
Index: kalarm/messagewin.cpp
===================================================================
--- kalarm/messagewin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/messagewin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -123,8 +123,16 @@
 // Basic flags for the window
 static const Qt::WFlags WFLAGS = Qt::WStyle_StaysOnTop | Qt::WDestructiveClose;
 
+// Error message bit masks
+enum {
+	ErrMsg_Speak     = 0x01,
+	ErrMsg_AudioFile = 0x02,
+	ErrMsg_Volume    = 0x04
+};
 
+
 QValueList<MessageWin*> MessageWin::mWindowList;
+QMap<QString, unsigned> MessageWin::mErrorMessages;
 
 
 /******************************************************************************
@@ -261,6 +269,7 @@
 	stopPlay();
 	delete mWinModule;
 	mWinModule = 0;
+	mErrorMessages.remove(mEventID);
 	mWindowList.remove(this);
 	if (!mRecreating)
 	{
@@ -808,7 +817,11 @@
 		if (kapp->startServiceByDesktopName("kttsd", QStringList(), &error))
 		{
 			kdDebug(5950) << "MessageWin::slotSpeak(): failed to start kttsd: " << error << endl;
-			KMessageBox::detailedError(0, i18n("Unable to speak message"), error);
+			if (!haveErrorMessage(ErrMsg_Speak))
+			{
+				KMessageBox::detailedError(0, i18n("Unable to speak message"), error);
+				clearErrorMessage(ErrMsg_Speak);
+			}
 			return;
 		}
 	}
@@ -818,7 +831,11 @@
 	if (!client->send("kttsd", "KSpeech", "sayMessage(QString,QString)", data))
 	{
 		kdDebug(5950) << "MessageWin::slotSpeak(): sayMessage() DCOP error" << endl;
-		KMessageBox::detailedError(0, i18n("Unable to speak message"), i18n("DCOP Call sayMessage failed"));
+		if (!haveErrorMessage(ErrMsg_Speak))
+		{
+			KMessageBox::detailedError(0, i18n("Unable to speak message"), i18n("DCOP Call sayMessage failed"));
+			clearErrorMessage(ErrMsg_Speak);
+		}
 	}
 }
 
@@ -836,7 +853,11 @@
 	||  !KIO::NetAccess::download(url, mLocalAudioFile, mmw))
 	{
 		kdError(5950) << "MessageWin::playAudio(): Open failure: " << mAudioFile << endl;
-		KMessageBox::error(this, i18n("Cannot open audio file:\n%1").arg(mAudioFile));
+		if (!haveErrorMessage(ErrMsg_AudioFile))
+		{
+			KMessageBox::error(this, i18n("Cannot open audio file:\n%1").arg(mAudioFile));
+			clearErrorMessage(ErrMsg_AudioFile);
+		}
 		return;
 	}
 	if (!mArtsDispatcher)
@@ -855,9 +876,13 @@
 		{
 			// Output error message now that everything else has been done.
 			// (Outputting it earlier would delay things until it is acknowledged.)
-			KMessageBox::information(this, i18n("Unable to set master volume\n(Error accessing KMix:\n%1)").arg(mKMixError),
-			                         QString::null, QString::fromLatin1("KMixError"));
 			kdWarning(5950) << "Unable to set master volume (KMix: " << mKMixError << ")\n";
+			if (!haveErrorMessage(ErrMsg_Volume))
+			{
+				KMessageBox::information(this, i18n("Unable to set master volume\n(Error accessing KMix:\n%1)").arg(mKMixError),
+				                         QString::null, QString::fromLatin1("KMixError"));
+				clearErrorMessage(ErrMsg_Volume);
+			}
 		}
 #endif
 	}
@@ -1588,7 +1613,32 @@
 	KAlarm::displayMainWindowSelected(mEventID);
 }
 
+/******************************************************************************
+* Check whether the specified error message is already displayed for this
+* alarm, and note that it will now be displayed.
+* Reply = true if message is already displayed.
+*/
+bool MessageWin::haveErrorMessage(unsigned msg) const
+{
+	if (!mErrorMessages.contains(mEventID))
+		mErrorMessages.insert(mEventID, 0);
+	bool result = (mErrorMessages[mEventID] & msg);
+	mErrorMessages[mEventID] |= msg;
+	return result;
+}
 
+void MessageWin::clearErrorMessage(unsigned msg) const
+{
+	if (mErrorMessages.contains(mEventID))
+	{
+		if (mErrorMessages[mEventID] == msg)
+			mErrorMessages.remove(mEventID);
+		else
+			mErrorMessages[mEventID] &= ~msg;
+	}
+}
+
+
 /*=============================================================================
 = Class MWMimeSourceFactory
 * Gets the mime type of a text file from not only its extension (as per
Index: kalarm/kalarmiface.h
===================================================================
--- kalarm/kalarmiface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmiface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kalarmiface.h  -  DCOP interface to KAlarm
  *  Program:  kalarm
- *  Copyright ¬© 2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2004-2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -115,8 +115,8 @@
 	 *  @param reminderMins   The number of minutes in advance of the main alarm and its recurrences to display
 	 *                        a reminder alarm, or 0 for no reminder.
 	 *  @param recurrence     Recurrence specification using iCalendar syntax (defined in RFC2445).
-	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no simple repetition.
-	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no simple repetition.
+	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no sub-repetition.
+	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no sub-repetition.
 	 *  @return true if alarm was scheduled successfully, false if configuration errors were found.
 	 */
 	virtual bool scheduleMessage(const QString& message, const QString& startDateTime, int lateCancel, unsigned flags,
@@ -190,8 +190,8 @@
 	 *  @param reminderMins   The number of minutes in advance of the main alarm and its recurrences to display
 	 *                        a reminder alarm, or 0 for no reminder.
 	 *  @param recurrence     Recurrence specification using iCalendar syntax (defined in RFC2445).
-	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no simple repetition.
-	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no simple repetition.
+	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no sub-repetition.
+	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no sub-repetition.
 	 *  @return true if alarm was scheduled successfully, false if configuration errors were found.
 	 */
 	virtual bool scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
@@ -245,8 +245,8 @@
 	 *  @param lateCancel     Late-cancellation period in minutes, or 0 for no cancellation.
 	 *  @param flags          OR of flag bits defined in Flags enum.
 	 *  @param recurrence     Recurrence specification using iCalendar syntax (defined in RFC2445).
-	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no simple repetition.
-	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no simple repetition.
+	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no sub-repetition.
+	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no sub-repetition.
 	 *  @return true if alarm was scheduled successfully, false if configuration errors were found.
 	 */
 	virtual bool scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
@@ -291,8 +291,8 @@
 	 *  @param lateCancel     Late-cancellation period in minutes, or 0 for no cancellation.
 	 *  @param flags          OR of flag bits defined in Flags enum.
 	 *  @param recurrence     Recurrence specification using iCalendar syntax (defined in RFC2445).
-	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no simple repetition.
-	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no simple repetition.
+	 *  @param repeatInterval Simple repetition repeat interval in minutes, or 0 for no sub-repetition.
+	 *  @param repeatCount    Simple repetition repeat count (after the first occurrence), or 0 for no sub-repetition.
 	 *  @return true if alarm was scheduled successfully, false if configuration errors were found.
 	 */
 	virtual bool scheduleEmail(const QString& fromID, const QString& addresses, const QString& subject, const QString& message,
Index: kalarm/preferences.h
===================================================================
--- kalarm/preferences.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/preferences.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  preferences.h  -  program preference settings
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -69,9 +69,6 @@
 		static void              setConfirmAlarmDeletion(bool yes){ setNotify(CONFIRM_ALARM_DELETION, yes); }
 		static bool              modalMessages()                  { return mModalMessages; }
 		static int               messageButtonDelay()             { return mMessageButtonDelay; }
-		static bool              showExpiredAlarms()              { return mShowExpiredAlarms; }
-		static bool              showAlarmTime()                  { return mShowAlarmTime; }
-		static bool              showTimeToAlarm()                { return mShowTimeToAlarm; }
 		static int               tooltipAlarmCount()              { return mTooltipAlarmCount; }
 		static bool              showTooltipAlarmTime()           { return mShowTooltipAlarmTime; }
 		static bool              showTooltipTimeToAlarm()         { return mShowTooltipTimeToAlarm; }
@@ -128,9 +125,6 @@
 		static const bool                       default_confirmAlarmDeletion;
 		static const bool                       default_modalMessages;
 		static const int                        default_messageButtonDelay;
-		static const bool                       default_showExpiredAlarms;
-		static const bool                       default_showAlarmTime;
-		static const bool                       default_showTimeToAlarm;
 		static const int                        default_tooltipAlarmCount;
 		static const bool                       default_showTooltipAlarmTime;
 		static const bool                       default_showTooltipTimeToAlarm;
@@ -202,9 +196,6 @@
 		static bool                mAutostartTrayIcon;
 		static bool                mModalMessages;
 		static int                 mMessageButtonDelay;  // 0 = scatter; -1 = no delay, no scatter; >0 = delay, no scatter
-		static bool                mShowExpiredAlarms;
-		static bool                mShowAlarmTime;
-		static bool                mShowTimeToAlarm;
 		static int                 mTooltipAlarmCount;
 		static bool                mShowTooltipAlarmTime;
 		static bool                mShowTooltipTimeToAlarm;
Index: kalarm/editdlgprivate.h
===================================================================
--- kalarm/editdlgprivate.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/editdlgprivate.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  editdlgprivate.h  -  private classes for editdlg.cpp
  *  Program:  kalarm
- *  Copyright (C) 2003 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2003-2005,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -21,7 +21,7 @@
 #ifndef EDITDLGPRIVATE_H
 #define EDITDLGPRIVATE_H
 
-#include <qtextedit.h>
+#include <ktextedit.h>
 
 
 class PageFrame : public QFrame
@@ -35,7 +35,7 @@
 		void             shown();
 };
 
-class TextEdit : public QTextEdit
+class TextEdit : public KTextEdit
 {
 		Q_OBJECT
 	public:
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.cpp  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -76,7 +76,6 @@
 #include "radiobutton.h"
 #include "recurrenceedit.h"
 #include "reminder.h"
-#include "repetition.h"
 #include "shellprocess.h"
 #include "soundpicker.h"
 #include "specialactions.h"
@@ -128,7 +127,12 @@
 
 inline QString recurText(const KAEvent& event)
 {
-	return QString::fromLatin1("%1 / %2").arg(event.recurrenceText()).arg(event.repetitionText());
+	QString r;
+	if (event.repeatCount())
+		r = QString::fromLatin1("%1 / %2").arg(event.recurrenceText()).arg(event.repetitionText());
+	else
+		r = event.recurrenceText();
+	return i18n("&Recurrence - [%1]").arg(r);
 }
 
 // Collect these widget labels together to ensure consistent wording and
@@ -213,12 +217,13 @@
 	// Recurrence tab
 	QVBox* recurTab = new QVBox(mTabs);
 	mainPageBox->setSpacing(spacingHint());
-	mTabs->addTab(recurTab, i18n("&Recurrence"));
+	mTabs->addTab(recurTab, QString::null);
 	mRecurPageIndex = 1;
 	mRecurrenceEdit = new RecurrenceEdit(readOnly, recurTab, "recurPage");
 	connect(mRecurrenceEdit, SIGNAL(shown()), SLOT(slotShowRecurrenceEdit()));
 	connect(mRecurrenceEdit, SIGNAL(typeChanged(int)), SLOT(slotRecurTypeChange(int)));
 	connect(mRecurrenceEdit, SIGNAL(frequencyChanged()), SLOT(slotRecurFrequencyChange()));
+	connect(mRecurrenceEdit, SIGNAL(repeatNeedsInitialisation()), SLOT(slotSetSubRepetition()));
 
 	// Alarm action
 
@@ -354,27 +359,6 @@
 		topLayout->addWidget(mTimeWidget);
 	}
 
-	// Recurrence type display
-	layout = new QHBoxLayout(topLayout, 2*spacingHint());
-	QHBox* box = new QHBox(mainPage);   // this is to control the QWhatsThis text display area
-	box->setSpacing(KDialog::spacingHint());
-	label = new QLabel(i18n("Recurrence:"), box);
-	label->setFixedSize(label->sizeHint());
-	mRecurrenceText = new QLabel(box);
-	QWhatsThis::add(box,
-	      i18n("How often the alarm recurs.\nThe times shown are those configured in the Recurrence tab and in the Simple Repetition dialog."));
-	box->setFixedHeight(box->sizeHint().height());
-	layout->addWidget(box);
-	layout->addStretch();
-
-	// Simple repetition button
-	mSimpleRepetition = new RepetitionButton(i18n("Simple Repetition"), true, mainPage);
-	mSimpleRepetition->setFixedSize(mSimpleRepetition->sizeHint());
-	connect(mSimpleRepetition, SIGNAL(needsInitialisation()), SLOT(slotSetSimpleRepetition()));
-	connect(mSimpleRepetition, SIGNAL(changed()), SLOT(slotRecurFrequencyChange()));
-	QWhatsThis::add(mSimpleRepetition, i18n("Set up a simple, or additional, alarm repetition"));
-	layout->addWidget(mSimpleRepetition);
-
 	// Reminder
 	static const QString reminderText = i18n("Enter how long in advance of the main alarm to display a reminder alarm.");
 	mReminder = new Reminder(i18n("Rem&inder:"),
@@ -438,7 +422,7 @@
 
 	// Text message edit box
 	mTextMessageEdit = new TextEdit(mDisplayAlarmsFrame);
-	mTextMessageEdit->setWordWrap(QTextEdit::NoWrap);
+	mTextMessageEdit->setWordWrap(KTextEdit::NoWrap);
 	QWhatsThis::add(mTextMessageEdit, i18n("Enter the text of the alarm message. It may be multi-line."));
 	frameLayout->addWidget(mTextMessageEdit);
 
@@ -457,24 +441,13 @@
 	QWhatsThis::add(mFileBrowseButton, i18n("Select a text or image file to display."));
 	mFileRadio->init(mFileBrowseButton, mFileMessageEdit);
 
-	// Colour choice drop-down list
-	QBoxLayout* layout = new QHBoxLayout(frameLayout);
-	QHBox* box;
-	mBgColourChoose = createBgColourChooser(&box, mDisplayAlarmsFrame);
-	mBgColourChoose->setFixedSize(mBgColourChoose->sizeHint());
-	connect(mBgColourChoose, SIGNAL(highlighted(const QColor&)), SLOT(slotBgColourSelected(const QColor&)));
-	layout->addWidget(box);
-	layout->addSpacing(2*spacingHint());
-	layout->addStretch();
-
-	// Font and colour choice drop-down list
+	// Font and colour choice button and sample text
 	mFontColourButton = new FontColourButton(mDisplayAlarmsFrame);
-	mFontColourButton->setFixedSize(mFontColourButton->sizeHint());
-	connect(mFontColourButton, SIGNAL(selected()), SLOT(slotFontColourSelected()));
-	layout->addWidget(mFontColourButton);
+	mFontColourButton->setMaximumHeight(mFontColourButton->sizeHint().height());
+	frameLayout->addWidget(mFontColourButton);
 
 	// Sound checkbox and file selector
-	layout = new QHBoxLayout(frameLayout);
+	QHBoxLayout* layout = new QHBoxLayout(frameLayout);
 	mSoundPicker = new SoundPicker(mDisplayAlarmsFrame);
 	mSoundPicker->setFixedSize(mSoundPicker->sizeHint());
 	layout->addWidget(mSoundPicker);
@@ -703,7 +676,6 @@
 			mFontColourButton->setFont(event->font());
 		mFontColourButton->setBgColour(event->bgColour());
 		mFontColourButton->setFgColour(event->fgColour());
-		mBgColourChoose->setColour(event->bgColour());     // set colour before setting alarm type buttons
 		if (mTemplate)
 		{
 			// Editing a template
@@ -787,9 +759,8 @@
 		mReminder->enableOnceOnly(event->recurs());
 		if (mSpecialActionsButton)
 			mSpecialActionsButton->setActions(event->preAction(), event->postAction());
-		mSimpleRepetition->set(event->repeatInterval(), event->repeatCount());
-		mRecurrenceText->setText(recurText(*event));
 		mRecurrenceEdit->set(*event);   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
+		mTabs->setTabLabel(mTabs->page(mRecurPageIndex), recurText(*event));
 		SoundPicker::Type soundType = event->speak()                ? SoundPicker::SPEAK
 		                            : event->beep()                 ? SoundPicker::BEEP
 		                            : !event->audioFile().isEmpty() ? SoundPicker::PLAY_FILE
@@ -806,7 +777,7 @@
 		mEmailSubjectEdit->setText(event->emailSubject());
 		mEmailBcc->setChecked(event->emailBcc());
 		if (mEmailFromList)
-			mEmailFromList->setCurrentIdentity(event->emailFromKMail());
+			mEmailFromList->setCurrentIdentity(event->emailFromId());
 	}
 	else
 	{
@@ -821,7 +792,6 @@
 		mFontColourButton->setDefaultFont();
 		mFontColourButton->setBgColour(Preferences::defaultBgColour());
 		mFontColourButton->setFgColour(Preferences::defaultFgColour());
-		mBgColourChoose->setColour(Preferences::defaultBgColour());     // set colour before setting alarm type buttons
 		QDateTime defaultTime = QDateTime::currentDateTime().addSecs(60);
 		if (mTemplate)
 		{
@@ -883,14 +853,12 @@
 		mDeferChangeButton->hide();
 	else
 		mDeferChangeButton->show();
-	mSimpleRepetition->setReadOnly(mReadOnly);
 	if (mShowInKorganizer)
 		mShowInKorganizer->setReadOnly(mReadOnly);
 
 	// Message alarm controls
 	mTextMessageEdit->setReadOnly(mReadOnly);
 	mFileMessageEdit->setReadOnly(mReadOnly);
-	mBgColourChoose->setReadOnly(mReadOnly);
 	mFontColourButton->setReadOnly(mReadOnly);
 	mSoundPicker->setReadOnly(mReadOnly);
 	mConfirmAck->setReadOnly(mReadOnly);
@@ -989,24 +957,6 @@
 }
 
 /******************************************************************************
- * Create a widget to choose the alarm message background colour.
- */
-ColourCombo* EditAlarmDlg::createBgColourChooser(QHBox** box, QWidget* parent, const char* name)
-{
-	*box = new QHBox(parent);   // this is to control the QWhatsThis text display area
-	QLabel* label = new QLabel(i18n("&Background color:"), *box);
-	label->setFixedSize(label->sizeHint());
-	ColourCombo* widget = new ColourCombo(*box, name);
-	QSize size = widget->sizeHint();
-	widget->setMinimumHeight(size.height() + 4);
-	QToolTip::add(widget, i18n("Message color"));
-	label->setBuddy(widget);
-	(*box)->setFixedHeight((*box)->sizeHint().height());
-	QWhatsThis::add(*box, i18n("Choose the background color for the alarm message."));
-	return widget;
-}
-
-/******************************************************************************
  * Create an "acknowledgement confirmation required" checkbox.
  */
 CheckBox* EditAlarmDlg::createConfirmAckCheckbox(QWidget* parent, const char* name)
@@ -1041,7 +991,7 @@
 	mSavedConfirmAck       = mConfirmAck->isChecked();
 	mSavedFont             = mFontColourButton->font();
 	mSavedFgColour         = mFontColourButton->fgColour();
-	mSavedBgColour         = mBgColourChoose->color();
+	mSavedBgColour         = mFontColourButton->bgColour();
 	mSavedReminder         = mReminder->minutes();
 	mSavedOnceOnly         = mReminder->isOnceOnly();
 	if (mSpecialActionsButton)
@@ -1068,8 +1018,6 @@
 	if (mShowInKorganizer)
 		mSavedShowInKorganizer = mShowInKorganizer->isChecked();
 	mSavedRecurrenceType   = mRecurrenceEdit->repeatType();
-	mSavedRepeatInterval   = mSimpleRepetition->interval();
-	mSavedRepeatCount      = mSimpleRepetition->count();
 }
 
 /******************************************************************************
@@ -1102,9 +1050,7 @@
 	||  mSavedLateCancel       != mLateCancel->minutes()
 	||  mShowInKorganizer && mSavedShowInKorganizer != mShowInKorganizer->isChecked()
 	||  textFileCommandMessage != mSavedTextFileCommandMessage
-	||  mSavedRecurrenceType   != mRecurrenceEdit->repeatType()
-	||  mSavedRepeatInterval   != mSimpleRepetition->interval()
-	||  mSavedRepeatCount      != mSimpleRepetition->count())
+	||  mSavedRecurrenceType   != mRecurrenceEdit->repeatType())
 		return true;
 	if (mMessageRadio->isOn()  ||  mFileRadio->isOn())
 	{
@@ -1112,7 +1058,7 @@
 		||  mSavedConfirmAck != mConfirmAck->isChecked()
 		||  mSavedFont       != mFontColourButton->font()
 		||  mSavedFgColour   != mFontColourButton->fgColour()
-		||  mSavedBgColour   != mBgColourChoose->color()
+		||  mSavedBgColour   != mFontColourButton->bgColour()
 		||  mSavedReminder   != mReminder->minutes()
 		||  mSavedOnceOnly   != mReminder->isOnceOnly()
 		||  mSavedAutoClose  != mLateCancel->isAutoClose())
@@ -1214,7 +1160,7 @@
 			dt = QDateTime(QDate(2000,1,1), mTemplateTime->time());
 	}
 	KAEvent::Action type = getAlarmType();
-	event.set(dt, text, mBgColourChoose->color(), mFontColourButton->fgColour(), mFontColourButton->font(),
+	event.set(dt, text, mFontColourButton->bgColour(), mFontColourButton->fgColour(), mFontColourButton->font(),
 	          type, (trial ? 0 : mLateCancel->minutes()), getAlarmFlags());
 	switch (type)
 	{
@@ -1236,9 +1182,7 @@
 		}
 		case KAEvent::EMAIL:
 		{
-			QString from;
-			if (mEmailFromList)
-				from = mEmailFromList->currentIdentityName();
+			uint from = mEmailFromList ? mEmailFromList->currentIdentity() : 0;
 			event.setEmail(from, mEmailAddresses, mEmailSubjectEdit->text(), mEmailAttachments);
 			break;
 		}
@@ -1254,6 +1198,15 @@
 		if (mRecurrenceEdit->repeatType() != RecurrenceEdit::NO_RECUR)
 		{
 			mRecurrenceEdit->updateEvent(event, !mTemplate);
+			QDateTime now = QDateTime::currentDateTime();
+			bool dateOnly = mAlarmDateTime.isDateOnly();
+			if (dateOnly  &&  mAlarmDateTime.date() < now.date()
+			||  !dateOnly  &&  mAlarmDateTime.rawDateTime() < now)
+			{
+				// A timed recurrence has an entered start date which has
+				// already expired, so we must adjust the next repetition.
+				event.setNextOccurrence(now);
+			}
 			mAlarmDateTime = event.startDateTime();
 			if (mDeferDateTime.isValid()  &&  mDeferDateTime < mAlarmDateTime)
 			{
@@ -1275,8 +1228,6 @@
 					event.defer(mDeferDateTime, deferReminder, false);
 			}
 		}
-		if (mSimpleRepetition->count())
-			event.setRepetition(mSimpleRepetition->interval(), mSimpleRepetition->count());
 		if (mTemplate)
 		{
 			int afterTime = mTemplateDefaultTime->isOn() ? 0
@@ -1376,7 +1327,6 @@
 	&&  mTabs->currentPageIndex() == mRecurPageIndex  &&  recurType == RecurrenceEdit::AT_LOGIN)
 		mTimeWidget->setDateTime(mRecurrenceEdit->endDateTime());
 	bool timedRecurrence = mRecurrenceEdit->isTimedRepeatType();    // does it recur other than at login?
-	bool repeated = mSimpleRepetition->count();
 	if (mTemplate)
 	{
 		// Check that the template name is not blank and is unique
@@ -1400,7 +1350,7 @@
 	else
 	{
 		QWidget* errWidget;
-		mAlarmDateTime = mTimeWidget->getDateTime(0, !(timedRecurrence || repeated), false, &errWidget);
+		mAlarmDateTime = mTimeWidget->getDateTime(0, !timedRecurrence, false, &errWidget);
 		if (errWidget)
 		{
 			// It's more than just an existing deferral being changed, so the time matters
@@ -1446,58 +1396,44 @@
 			return;
 		}
 	}
-	int longestRecurInterval = -1;
 	if (recurType != RecurrenceEdit::NO_RECUR)
 	{
+		KAEvent recurEvent;
+		int longestRecurInterval = -1;
 		int reminder = mReminder->minutes();
-		if (reminder)
+		if (reminder  &&  !mReminder->isOnceOnly())
 		{
-			KAEvent event;
-			mRecurrenceEdit->updateEvent(event, false);
-			if (!mReminder->isOnceOnly())
+			mRecurrenceEdit->updateEvent(recurEvent, false);
+			longestRecurInterval = recurEvent.longestRecurrenceInterval();
+			if (longestRecurInterval  &&  reminder >= longestRecurInterval)
 			{
-				longestRecurInterval = event.longestRecurrenceInterval();
-				if (longestRecurInterval  &&  reminder >= longestRecurInterval)
-				{
-					mTabs->setCurrentPage(mMainPageIndex);
-					mReminder->setFocusOnCount();
-					KMessageBox::sorry(this, i18n("Reminder period must be less than the recurrence interval, unless '%1' is checked."
-					                             ).arg(Reminder::i18n_first_recurrence_only()));
-					return;
-				}
+				mTabs->setCurrentPage(mMainPageIndex);
+				mReminder->setFocusOnCount();
+				KMessageBox::sorry(this, i18n("Reminder period must be less than the recurrence interval, unless '%1' is checked."
+				                             ).arg(Reminder::i18n_first_recurrence_only()));
+				return;
 			}
 		}
-	}
-	if (mSimpleRepetition->count())
-	{
-		switch (recurType)
+		if (mRecurrenceEdit->subRepeatCount())
 		{
-			case RecurrenceEdit::AT_LOGIN:    // alarm repeat not allowed
-				mSimpleRepetition->set(0, 0);
-				break;
-			default:          // repeat duration must be less than recurrence interval
-				if (longestRecurInterval < 0)
-				{
-					KAEvent event;
-					mRecurrenceEdit->updateEvent(event, false);
-					longestRecurInterval = event.longestRecurrenceInterval();
-				}
-				if (mSimpleRepetition->count() * mSimpleRepetition->interval() >= longestRecurInterval - mReminder->minutes())
-				{
-					KMessageBox::sorry(this, i18n("Simple alarm repetition duration must be less than the recurrence interval minus any reminder period"));
-					mSimpleRepetition->activate();   // display the alarm repetition dialog again
-					return;
-				}
-				// fall through to NO_RECUR
-			case RecurrenceEdit::NO_RECUR:    // no restriction on repeat duration
-				if (mSimpleRepetition->interval() % 1440
-				&&  (mTemplate && mTemplateAnyTime->isOn()  ||  !mTemplate && mAlarmDateTime.isDateOnly()))
-				{
-					KMessageBox::sorry(this, i18n("Simple alarm repetition period must be in units of days or weeks for a date-only alarm"));
-					mSimpleRepetition->activate();   // display the alarm repetition dialog again
-					return;
-				}
-				break;
+			if (longestRecurInterval < 0)
+			{
+				mRecurrenceEdit->updateEvent(recurEvent, false);
+				longestRecurInterval = recurEvent.longestRecurrenceInterval();
+			}
+			if (recurEvent.repeatInterval() * recurEvent.repeatCount() >= longestRecurInterval - reminder)
+			{
+				KMessageBox::sorry(this, i18n("The duration of a repetition within the recurrence must be less than the recurrence interval minus any reminder period"));
+				mRecurrenceEdit->activateSubRepetition();   // display the alarm repetition dialog again
+				return;
+			}
+			if (recurEvent.repeatInterval() % 1440
+			&&  (mTemplate && mTemplateAnyTime->isOn()  ||  !mTemplate && mAlarmDateTime.isDateOnly()))
+			{
+				KMessageBox::sorry(this, i18n("For a repetition within the recurrence, its period must be in units of days or weeks for a date-only alarm"));
+				mRecurrenceEdit->activateSubRepetition();   // display the alarm repetition dialog again
+				return;
+			}
 		}
 	}
 	if (checkText(mAlarmMessage))
@@ -1569,7 +1505,8 @@
 	if (!mTimeWidget)
 		return;
 	bool limit = true;
-	int repeatCount = mSimpleRepetition->count();
+	int repeatInterval;
+	int repeatCount = mRecurrenceEdit->subRepeatCount(&repeatInterval);
 	DateTime start = mTimeWidget->getDateTime(0, !repeatCount, !mExpiredRecurrence);
 	if (!start.isValid())
 	{
@@ -1582,15 +1519,15 @@
 	{
 		if (repeatCount  &&  start < now)
 		{
-			// Simple repetition - find the time of the next one
-			int interval = mSimpleRepetition->interval() * 60;
-			int repetition = (start.secsTo(now) + interval - 1) / interval;
+			// Sub-repetition - find the time of the next one
+			repeatInterval *= 60;
+			int repetition = (start.secsTo(now) + repeatInterval - 1) / repeatInterval;
 			if (repetition > repeatCount)
 			{
 				mTimeWidget->getDateTime();    // output the appropriate error message
 				return;
 			}
-			start = start.addSecs(repetition * interval);
+			start = start.addSecs(repetition * repeatInterval);
 		}
 	}
 
@@ -1695,43 +1632,30 @@
 }
 
 /******************************************************************************
-*  Called when the recurrence frequency selection changes, or the simple
+*  Called when the recurrence frequency selection changes, or the sub-
 *  repetition interval changes.
 *  Updates the recurrence frequency text.
 */
 void EditAlarmDlg::slotRecurFrequencyChange()
 {
+	slotSetSubRepetition();
 	KAEvent event;
 	mRecurrenceEdit->updateEvent(event, false);
-	event.setRepetition(mSimpleRepetition->interval(), mSimpleRepetition->count());
-	mRecurrenceText->setText(recurText(event));
+	mTabs->setTabLabel(mTabs->page(mRecurPageIndex), recurText(event));
 }
 
 /******************************************************************************
-*  Called when the Simple Repetition button has been pressed to display the
-*  alarm repetition dialog.
+*  Called when the Repetition within Recurrence button has been pressed to
+*  display the sub-repetition dialog.
 *  Alarm repetition has the following restrictions:
 *  1) Not allowed for a repeat-at-login alarm
 *  2) For a date-only alarm, the repeat interval must be a whole number of days.
 *  3) The overall repeat duration must be less than the recurrence interval.
 */
-void EditAlarmDlg::slotSetSimpleRepetition()
+void EditAlarmDlg::slotSetSubRepetition()
 {
 	bool dateOnly = mTemplate ? mTemplateAnyTime->isOn() : mTimeWidget->anyTime();
-	int maxDuration;
-	switch (mRecurrenceEdit->repeatType())
-	{
-		case RecurrenceEdit::NO_RECUR:  maxDuration = -1;  break;  // no restriction on repeat duration
-		case RecurrenceEdit::AT_LOGIN:  maxDuration = 0;  break;   // alarm repeat not allowed
-		default:          // repeat duration must be less than recurrence interval
-		{
-			KAEvent event;
-			mRecurrenceEdit->updateEvent(event, false);
-			maxDuration = event.longestRecurrenceInterval() - mReminder->minutes() - 1;
-			break;
-		}
-	}
-	mSimpleRepetition->initialise(mSimpleRepetition->interval(), mSimpleRepetition->count(), dateOnly, maxDuration);
+	mRecurrenceEdit->setSubRepetition(mReminder->minutes(), dateOnly);
 }
 
 /******************************************************************************
@@ -1922,24 +1846,6 @@
 }
 
 /******************************************************************************
-*  Called when the a new background colour has been selected using the colour
-*  combo box.
-*/
-void EditAlarmDlg::slotBgColourSelected(const QColor& colour)
-{
-	mFontColourButton->setBgColour(colour);
-}
-
-/******************************************************************************
-*  Called when the a new font and colour have been selected using the font &
-*  colour pushbutton.
-*/
-void EditAlarmDlg::slotFontColourSelected()
-{
-	mBgColourChoose->setColour(mFontColourButton->bgColour());
-}
-
-/******************************************************************************
 *  Called when the "Any time" checkbox is toggled in the date/time widget.
 *  Sets the advance reminder and late cancel units to days if any time is checked.
 */
@@ -2104,7 +2010,7 @@
 = Provides KDE 2 compatibility.
 =============================================================================*/
 TextEdit::TextEdit(QWidget* parent, const char* name)
-	: QTextEdit(parent, name)
+	: KTextEdit(parent, name)
 {
 	QSize tsize = sizeHint();
 	tsize.setHeight(fontMetrics().lineSpacing()*13/4 + 2*frameWidth());
@@ -2115,5 +2021,5 @@
 {
 	if (KCal::ICalDrag::canDecode(e))
 		e->accept(false);   // don't accept "text/calendar" objects
-	QTextEdit::dragEnterEvent(e);
+	KTextEdit::dragEnterEvent(e);
 }
Index: kalarm/dcophandler.cpp
===================================================================
--- kalarm/dcophandler.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/dcophandler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  dcophandler.cpp  -  handler for DCOP calls by other applications
  *  Program:  kalarm
- *  Copyright ¬© 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -24,9 +24,6 @@
 
 #include <kdebug.h>
 
-#include <libkpimidentities/identitymanager.h>
-#include <libkpimidentities/identity.h>
-
 #include "alarmcalendar.h"
 #include "daemon.h"
 #include "functions.h"
@@ -68,13 +65,13 @@
 bool DcopHandler::scheduleMessage(const QString& message, const QString& startDateTime, int lateCancel, unsigned flags,
                                   const QString& bgColor, const QString& fgColor, const QString& font,
                                   const KURL& audioFile, int reminderMins, const QString& recurrence,
-                                  int repeatInterval, int repeatCount)
+                                  int subRepeatInterval, int subRepeatCount)
 {
 	DateTime start;
 	KARecurrence recur;
-	if (!convertRecurrence(start, recur, startDateTime, recurrence))
+	if (!convertRecurrence(start, recur, startDateTime, recurrence, subRepeatInterval))
 		return false;
-	return scheduleMessage(message, start, lateCancel, flags, bgColor, fgColor, font, audioFile, reminderMins, recur, repeatInterval, repeatCount);
+	return scheduleMessage(message, start, lateCancel, flags, bgColor, fgColor, font, audioFile, reminderMins, recur, subRepeatInterval, subRepeatCount);
 }
 
 bool DcopHandler::scheduleMessage(const QString& message, const QString& startDateTime, int lateCancel, unsigned flags,
@@ -103,13 +100,13 @@
 
 bool DcopHandler::scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
                                const KURL& audioFile, int reminderMins, const QString& recurrence,
-                               int repeatInterval, int repeatCount)
+                               int subRepeatInterval, int subRepeatCount)
 {
 	DateTime start;
 	KARecurrence recur;
-	if (!convertRecurrence(start, recur, startDateTime, recurrence))
+	if (!convertRecurrence(start, recur, startDateTime, recurrence, subRepeatInterval))
 		return false;
-	return scheduleFile(file, start, lateCancel, flags, bgColor, audioFile, reminderMins, recur, repeatInterval, repeatCount);
+	return scheduleFile(file, start, lateCancel, flags, bgColor, audioFile, reminderMins, recur, subRepeatInterval, subRepeatCount);
 }
 
 bool DcopHandler::scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
@@ -133,13 +130,13 @@
 }
 
 bool DcopHandler::scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
-                                  const QString& recurrence, int repeatInterval, int repeatCount)
+                                  const QString& recurrence, int subRepeatInterval, int subRepeatCount)
 {
 	DateTime start;
 	KARecurrence recur;
-	if (!convertRecurrence(start, recur, startDateTime, recurrence))
+	if (!convertRecurrence(start, recur, startDateTime, recurrence, subRepeatInterval))
 		return false;
-	return scheduleCommand(commandLine, start, lateCancel, flags, recur, repeatInterval, repeatCount);
+	return scheduleCommand(commandLine, start, lateCancel, flags, recur, subRepeatInterval, subRepeatCount);
 }
 
 bool DcopHandler::scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
@@ -166,13 +163,13 @@
 
 bool DcopHandler::scheduleEmail(const QString& fromID, const QString& addresses, const QString& subject, const QString& message,
                                 const QString& attachments, const QString& startDateTime, int lateCancel, unsigned flags,
-                                const QString& recurrence, int repeatInterval, int repeatCount)
+                                const QString& recurrence, int subRepeatInterval, int subRepeatCount)
 {
 	DateTime start;
 	KARecurrence recur;
-	if (!convertRecurrence(start, recur, startDateTime, recurrence))
+	if (!convertRecurrence(start, recur, startDateTime, recurrence, subRepeatInterval))
 		return false;
-	return scheduleEmail(fromID, addresses, subject, message, attachments, start, lateCancel, flags, recur, repeatInterval, repeatCount);
+	return scheduleEmail(fromID, addresses, subject, message, attachments, start, lateCancel, flags, recur, subRepeatInterval, subRepeatCount);
 }
 
 bool DcopHandler::scheduleEmail(const QString& fromID, const QString& addresses, const QString& subject, const QString& message,
@@ -214,7 +211,7 @@
 bool DcopHandler::scheduleMessage(const QString& message, const DateTime& start, int lateCancel, unsigned flags,
                                   const QString& bgColor, const QString& fgColor, const QString& fontStr,
                                   const KURL& audioFile, int reminderMins, const KARecurrence& recurrence,
-                                  int repeatInterval, int repeatCount)
+                                  int subRepeatInterval, int subRepeatCount)
 {
 	unsigned kaEventFlags = convertStartFlags(start, flags);
 	QColor bg = convertBgColour(bgColor);
@@ -244,7 +241,7 @@
 		}
 	}
 	return theApp()->scheduleEvent(KAEvent::MESSAGE, message, start.dateTime(), lateCancel, kaEventFlags, bg, fg, font,
-	                               audioFile.url(), -1, reminderMins, recurrence, repeatInterval, repeatCount);
+	                               audioFile.url(), -1, reminderMins, recurrence, subRepeatInterval, subRepeatCount);
 }
 
 /******************************************************************************
@@ -253,14 +250,14 @@
 bool DcopHandler::scheduleFile(const KURL& file,
                                const DateTime& start, int lateCancel, unsigned flags, const QString& bgColor,
                                const KURL& audioFile, int reminderMins, const KARecurrence& recurrence,
-                               int repeatInterval, int repeatCount)
+                               int subRepeatInterval, int subRepeatCount)
 {
 	unsigned kaEventFlags = convertStartFlags(start, flags);
 	QColor bg = convertBgColour(bgColor);
 	if (!bg.isValid())
 		return false;
 	return theApp()->scheduleEvent(KAEvent::FILE, file.url(), start.dateTime(), lateCancel, kaEventFlags, bg, Qt::black, QFont(),
-	                               audioFile.url(), -1, reminderMins, recurrence, repeatInterval, repeatCount);
+	                               audioFile.url(), -1, reminderMins, recurrence, subRepeatInterval, subRepeatCount);
 }
 
 /******************************************************************************
@@ -268,11 +265,11 @@
 */
 bool DcopHandler::scheduleCommand(const QString& commandLine,
                                   const DateTime& start, int lateCancel, unsigned flags,
-                                  const KARecurrence& recurrence, int repeatInterval, int repeatCount)
+                                  const KARecurrence& recurrence, int subRepeatInterval, int subRepeatCount)
 {
 	unsigned kaEventFlags = convertStartFlags(start, flags);
 	return theApp()->scheduleEvent(KAEvent::COMMAND, commandLine, start.dateTime(), lateCancel, kaEventFlags, Qt::black, Qt::black, QFont(),
-	                               QString::null, -1, 0, recurrence, repeatInterval, repeatCount);
+	                               QString::null, -1, 0, recurrence, subRepeatInterval, subRepeatCount);
 }
 
 /******************************************************************************
@@ -281,12 +278,14 @@
 bool DcopHandler::scheduleEmail(const QString& fromID, const QString& addresses, const QString& subject,
                                 const QString& message, const QString& attachments,
                                 const DateTime& start, int lateCancel, unsigned flags,
-                                const KARecurrence& recurrence, int repeatInterval, int repeatCount)
+                                const KARecurrence& recurrence, int subRepeatInterval, int subRepeatCount)
 {
 	unsigned kaEventFlags = convertStartFlags(start, flags);
+	uint senderId = 0;
 	if (!fromID.isEmpty())
 	{
-		if (KAMail::identityManager()->identityForName(fromID).isNull())
+		senderId = KAMail::identityUoid(fromID);
+		if (!senderId)
 		{
 			kdError(5950) << "DCOP call scheduleEmail(): unknown sender ID: " << fromID << endl;
 			return false;
@@ -312,7 +311,7 @@
 		return false;
 	}
 	return theApp()->scheduleEvent(KAEvent::EMAIL, message, start.dateTime(), lateCancel, kaEventFlags, Qt::black, Qt::black, QFont(),
-	                               QString::null, -1, 0, recurrence, repeatInterval, repeatCount, fromID, addrs, subject, atts);
+	                               QString::null, -1, 0, recurrence, subRepeatInterval, subRepeatCount, senderId, addrs, subject, atts);
 }
 
 
@@ -388,12 +387,20 @@
 }
 
 bool DcopHandler::convertRecurrence(DateTime& start, KARecurrence& recurrence, 
-                                    const QString& startDateTime, const QString& icalRecurrence)
+                                    const QString& startDateTime, const QString& icalRecurrence,
+                                    int& subRepeatInterval)
 {
 	start = convertStartDateTime(startDateTime);
 	if (!start.isValid())
 		return false;
-	return recurrence.set(icalRecurrence);
+	if (!recurrence.set(icalRecurrence))
+		return false;
+	if (subRepeatInterval  &&  recurrence.type() == KARecurrence::NO_RECUR)
+	{
+		subRepeatInterval = 0;
+		kdWarning(5950) << "DCOP call: no recurrence specified, so sub-repetition ignored" << endl;
+	}
+	return true;
 }
 
 bool DcopHandler::convertRecurrence(DateTime& start, KARecurrence& recurrence, const QString& startDateTime,
@@ -451,7 +458,7 @@
 		case YEARLY:    type = KARecurrence::ANNUAL_DATE;  break;
 			break;
 		default:
-			kdError(5950) << "DCOP call: invalid repeat type: " << recurType << endl;
+			kdError(5950) << "DCOP call: invalid recurrence type: " << recurType << endl;
 			return false;
 	}
 	recurrence.set(type, recurInterval, recurCount, start, end);
@@ -479,7 +486,6 @@
 	kdDebug(5950) << "DcopHandlerOld::process(): " << func << endl;
 	enum
 	{
-		ERR            = 0,
 		OPERATION      = 0x0007,    // mask for main operation
 		  HANDLE       = 0x0001,
 		  CANCEL       = 0x0002,
@@ -754,7 +760,7 @@
 				recurrence.set(rule);
 			}
 			return theApp()->scheduleEvent(action, text, dateTime, lateCancel, flags, bgColour, fgColour, font, audioFile,
-			                               audioVolume, reminderMinutes, recurrence, 0, 0, QString::null, mailAddresses, mailSubject, mailAttachments);
+			                               audioVolume, reminderMinutes, recurrence, 0, 0, 0, mailAddresses, mailSubject, mailAttachments);
 		}
 	}
 	return false;
Index: kalarm/fontcolourbutton.h
===================================================================
--- kalarm/fontcolourbutton.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/fontcolourbutton.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  fontcolourbutton.h  -  pushbutton widget to select a font and colour
  *  Program:  kalarm
- *  Copyright (C) 2003 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2003,2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -23,27 +23,29 @@
 
 #include <qfont.h>
 #include <qcolor.h>
+#include <qframe.h>
 #include <kdialogbase.h>
-#include "pushbutton.h"
 
+class QLineEdit;
 class FontColourChooser;
+class PushButton;
 
 
-class FontColourButton : public PushButton
+class FontColourButton : public QFrame
 {
 		Q_OBJECT
 	public:
 		FontColourButton(QWidget* parent = 0, const char* name = 0);
-		void          setDefaultFont()                   { mDefaultFont = true; }
-		void          setFont(const QFont& font)         { mFont = font;  mDefaultFont = false; }
-		void          setBgColour(const QColor& colour)  { mBgColour = colour; }
-		void          setFgColour(const QColor& colour)  { mFgColour = colour; }
-		bool          defaultFont() const                { return mDefaultFont; }
-		QFont         font() const                       { return mFont; }
-		QColor        bgColour() const                   { return mBgColour; }
-		QColor        fgColour() const                   { return mFgColour; }
-		virtual void  setReadOnly(bool ro)               { mReadOnly = ro; }
-		virtual bool  isReadOnly() const                 { return mReadOnly; }
+		void          setDefaultFont();
+		void          setFont(const QFont&);
+		void          setBgColour(const QColor&);
+		void          setFgColour(const QColor&);
+		bool          defaultFont() const    { return mDefaultFont; }
+		QFont         font() const           { return mFont; }
+		QColor        bgColour() const       { return mBgColour; }
+		QColor        fgColour() const       { return mFgColour; }
+		virtual void  setReadOnly(bool ro)   { mReadOnly = ro; }
+		virtual bool  isReadOnly() const     { return mReadOnly; }
 
 	signals:
 		void          selected();
@@ -52,10 +54,12 @@
 		void          slotButtonPressed();
 
 	private:
-		QColor    mBgColour, mFgColour;
-		QFont     mFont;
-		bool      mDefaultFont;
-		bool      mReadOnly;
+		PushButton* mButton;
+		QColor      mBgColour, mFgColour;
+		QFont       mFont;
+		QLineEdit*  mSample;
+		bool        mDefaultFont;
+		bool        mReadOnly;
 };
 
 
Index: kalarm/preferences.cpp
===================================================================
--- kalarm/preferences.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/preferences.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  preferences.cpp  -  program preference settings
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -55,9 +55,6 @@
 const bool                       Preferences::default_confirmAlarmDeletion    = true;
 const bool                       Preferences::default_modalMessages           = true;
 const int                        Preferences::default_messageButtonDelay      = 0;     // (seconds)
-const bool                       Preferences::default_showExpiredAlarms       = false;
-const bool                       Preferences::default_showAlarmTime           = true;
-const bool                       Preferences::default_showTimeToAlarm         = false;
 const int                        Preferences::default_tooltipAlarmCount       = 5;
 const bool                       Preferences::default_showTooltipAlarmTime    = true;
 const bool                       Preferences::default_showTooltipTimeToAlarm  = true;
@@ -105,9 +102,6 @@
 KARecurrence::Feb29Type    Preferences::mDefaultFeb29Type;
 bool                       Preferences::mModalMessages;
 int                        Preferences::mMessageButtonDelay;
-bool                       Preferences::mShowExpiredAlarms;
-bool                       Preferences::mShowAlarmTime;
-bool                       Preferences::mShowTimeToAlarm;
 int                        Preferences::mTooltipAlarmCount;
 bool                       Preferences::mShowTooltipAlarmTime;
 bool                       Preferences::mShowTooltipTimeToAlarm;
@@ -160,9 +154,6 @@
 static const QString FEB29_RECUR_TYPE         = QString::fromLatin1("Feb29Recur");
 static const QString MODAL_MESSAGES           = QString::fromLatin1("ModalMessages");
 static const QString MESSAGE_BUTTON_DELAY     = QString::fromLatin1("MessageButtonDelay");
-static const QString SHOW_EXPIRED_ALARMS      = QString::fromLatin1("ShowExpiredAlarms");
-static const QString SHOW_ALARM_TIME          = QString::fromLatin1("ShowAlarmTime");
-static const QString SHOW_TIME_TO_ALARM       = QString::fromLatin1("ShowTimeToAlarm");
 static const QString TOOLTIP_ALARM_COUNT      = QString::fromLatin1("TooltipAlarmCount");
 static const QString TOOLTIP_ALARM_TIME       = QString::fromLatin1("ShowTooltipAlarmTime");
 static const QString TOOLTIP_TIME_TO_ALARM    = QString::fromLatin1("ShowTooltipTimeToAlarm");
@@ -192,7 +183,7 @@
 static const QString DEF_LOG_FILE             = QString::fromLatin1("DefLogFile");
 static const QString DEF_EMAIL_BCC            = QString::fromLatin1("DefEmailBcc");
 static const QString DEF_RECUR_PERIOD         = QString::fromLatin1("DefRecurPeriod");
-static const QString DEF_REMIND_UNITS         = QString::fromLatin1("DefRemindUnits");
+static const QString DEF_REMIND_UNITS         = QString::fromLatin1("RemindUnits");
 static const QString DEF_PRE_ACTION           = QString::fromLatin1("DefPreAction");
 static const QString DEF_POST_ACTION          = QString::fromLatin1("DefPostAction");
 
@@ -287,9 +278,6 @@
 		mMessageButtonDelay = 10;    // prevent windows being unusable for a long time
 	if (mMessageButtonDelay < -1)
 		mMessageButtonDelay = -1;
-	mShowExpiredAlarms        = config->readBoolEntry(SHOW_EXPIRED_ALARMS, default_showExpiredAlarms);
-	mShowTimeToAlarm          = config->readBoolEntry(SHOW_TIME_TO_ALARM, default_showTimeToAlarm);
-	mShowAlarmTime            = !mShowTimeToAlarm ? true : config->readBoolEntry(SHOW_ALARM_TIME, default_showAlarmTime);
 	mTooltipAlarmCount        = static_cast<int>(config->readUnsignedNumEntry(TOOLTIP_ALARM_COUNT, default_tooltipAlarmCount));
 	if (mTooltipAlarmCount < 1)
 		mTooltipAlarmCount = 1;
@@ -349,9 +337,11 @@
 	                          ? default_defaultRecurPeriod : (RecurrenceEdit::RepeatType)recurPeriod;
 	QCString feb29            = config->readEntry(FEB29_RECUR_TYPE, defaultFeb29RecurType).local8Bit();
 	mDefaultFeb29Type         = (feb29 == "Mar1") ? KARecurrence::FEB29_MAR1 : (feb29 == "Feb28") ? KARecurrence::FEB29_FEB28 : KARecurrence::FEB29_FEB29;
-	int reminderUnits         = config->readNumEntry(DEF_REMIND_UNITS, default_defaultReminderUnits);
-	mDefaultReminderUnits     = (reminderUnits < TimePeriod::HOURS_MINUTES || reminderUnits > TimePeriod::WEEKS)
-	                          ? default_defaultReminderUnits : (TimePeriod::Units)reminderUnits;
+	QString remindUnits       = config->readEntry(DEF_REMIND_UNITS);
+	mDefaultReminderUnits     = (remindUnits == QString::fromLatin1("Minutes"))      ? TimePeriod::MINUTES
+	                          : (remindUnits == QString::fromLatin1("HoursMinutes")) ? TimePeriod::HOURS_MINUTES
+	                          : (remindUnits == QString::fromLatin1("Days"))         ? TimePeriod::DAYS
+	                          : (remindUnits == QString::fromLatin1("Weeks"))        ? TimePeriod::WEEKS : default_defaultReminderUnits;
 	mDefaultPreAction         = config->readEntry(DEF_PRE_ACTION, default_defaultPreAction);
 	mDefaultPostAction        = config->readEntry(DEF_POST_ACTION, default_defaultPostAction);
 	mInstance->emitPreferencesChanged();
@@ -382,9 +372,6 @@
 	config->writeEntry(AUTOSTART_TRAY, mAutostartTrayIcon);
 	config->writeEntry(MODAL_MESSAGES, mModalMessages);
 	config->writeEntry(MESSAGE_BUTTON_DELAY, mMessageButtonDelay);
-	config->writeEntry(SHOW_EXPIRED_ALARMS, mShowExpiredAlarms);
-	config->writeEntry(SHOW_ALARM_TIME, mShowAlarmTime);
-	config->writeEntry(SHOW_TIME_TO_ALARM, mShowTimeToAlarm);
 	config->writeEntry(TOOLTIP_ALARM_COUNT, mTooltipAlarmCount);
 	config->writeEntry(TOOLTIP_ALARM_TIME, mShowTooltipAlarmTime);
 	config->writeEntry(TOOLTIP_TIME_TO_ALARM, mShowTooltipTimeToAlarm);
@@ -416,7 +403,16 @@
 	config->writeEntry(DEF_EMAIL_BCC, mDefaultEmailBcc);
 	config->writeEntry(DEF_RECUR_PERIOD, mDefaultRecurPeriod);
 	config->writeEntry(FEB29_RECUR_TYPE, (mDefaultFeb29Type == KARecurrence::FEB29_MAR1 ? "Mar1" : mDefaultFeb29Type == KARecurrence::FEB29_FEB28 ? "Feb28" : "None"));
-	config->writeEntry(DEF_REMIND_UNITS, mDefaultReminderUnits);
+	QString value;
+	switch (mDefaultReminderUnits)
+	{
+		case TimePeriod::MINUTES:       value = QString::fromLatin1("Minutes");      break;
+		case TimePeriod::HOURS_MINUTES: value = QString::fromLatin1("HoursMinutes"); break;
+		case TimePeriod::DAYS:          value = QString::fromLatin1("Days");         break;
+		case TimePeriod::WEEKS:         value = QString::fromLatin1("Weeks");        break;
+		default:                        value = QString::null; break;
+	}
+	config->writeEntry(DEF_REMIND_UNITS, value);
 	config->writeEntry(DEF_PRE_ACTION, mDefaultPreAction);
 	config->writeEntry(DEF_POST_ACTION, mDefaultPostAction);
 
@@ -556,17 +552,54 @@
 	KConfig* config = KGlobal::config();
 	config->setGroup(GENERAL_SECTION);
 	int version = KAlarm::getVersionNumber(config->readEntry(VERSION_NUM));
-	if (version >= KAlarm::Version(1,4,6))
+	if (version >= KAlarm::Version(1,4,22))
 		return;     // config format is up to date
 
-	// Convert KAlarm 1.4.5 preferences
-	static const QString DEF_SOUND = QString::fromLatin1("DefSound");
-	config->setGroup(DEFAULTS_SECTION);
-	bool sound = config->readBoolEntry(DEF_SOUND, false);
-	if (!sound)
-		config->writeEntry(DEF_SOUND_TYPE, SoundPicker::NONE);
-	config->deleteEntry(DEF_SOUND);
+	if (version <= KAlarm::Version(1,4,21))
+	{
+		// Convert KAlarm 1.4.21 preferences
+		static const QString OLD_REMIND_UNITS = QString::fromLatin1("DefRemindUnits");
+		config->setGroup(DEFAULTS_SECTION);
+		int intUnit     = config->readNumEntry(OLD_REMIND_UNITS, 0);
+		QString strUnit = (intUnit == 1) ? QString::fromLatin1("Days")
+		                : (intUnit == 2) ? QString::fromLatin1("Weeks")
+		                :                  QString::fromLatin1("HoursMinutes");
+		config->deleteEntry(OLD_REMIND_UNITS);
+		config->writeEntry(DEF_REMIND_UNITS, strUnit);
+	}
 
+	if (version <= KAlarm::Version(1,4,20))
+	{
+		// Convert KAlarm 1.4.20 preferences
+		static const QString VIEW_SECTION = QString::fromLatin1("View");
+		static const QString SHOW_ARCHIVED_ALARMS = QString::fromLatin1("ShowArchivedAlarms");
+		static const QString SHOW_EXPIRED_ALARMS  = QString::fromLatin1("ShowExpiredAlarms");
+		static const QString SHOW_ALARM_TIME      = QString::fromLatin1("ShowAlarmTime");
+		static const QString SHOW_TIME_TO_ALARM   = QString::fromLatin1("ShowTimeToAlarm");
+		config->setGroup(GENERAL_SECTION);
+		bool showExpired = config->readBoolEntry(SHOW_EXPIRED_ALARMS, false);
+		bool showTime    = config->readBoolEntry(SHOW_ALARM_TIME, true);
+		bool showTimeTo  = config->readBoolEntry(SHOW_TIME_TO_ALARM, false);
+		config->deleteEntry(SHOW_EXPIRED_ALARMS);
+		config->deleteEntry(SHOW_ALARM_TIME);
+		config->deleteEntry(SHOW_TIME_TO_ALARM);
+		config->setGroup(VIEW_SECTION);
+		config->writeEntry(SHOW_ARCHIVED_ALARMS, showExpired);
+		config->writeEntry(SHOW_ALARM_TIME, showTime);
+		config->writeEntry(SHOW_TIME_TO_ALARM, showTimeTo);
+	}
+
+	if (version <= KAlarm::Version(1,4,5))
+	{
+		// Convert KAlarm 1.4.5 preferences
+		static const QString DEF_SOUND = QString::fromLatin1("DefSound");
+		config->setGroup(DEFAULTS_SECTION);
+		bool sound = config->readBoolEntry(DEF_SOUND, false);
+		if (!sound)
+			config->writeEntry(DEF_SOUND_TYPE, SoundPicker::NONE);
+		config->deleteEntry(DEF_SOUND);
+	}
+
 	if (version < KAlarm::Version(1,3,0))
 	{
 		// Convert KAlarm pre-1.3 preferences
Index: kalarm/kamail.h
===================================================================
--- kalarm/kamail.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kamail.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kamail.h  -  email functions
  *  Program:  kalarm
- *  Copyright ¬© 2002-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -43,6 +43,7 @@
 		static QString     convertAttachments(const QString& attachments, QStringList& list);
 		static KPIM::IdentityManager* identityManager();
 		static bool        identitiesExist();
+		static uint        identityUoid(const QString& identityUoidOrName);
 		static QString     controlCentreAddress();
 		static QString     getMailBody(Q_UINT32 serialNumber);
 		static QString     i18n_NeedFromEmailAddress();
Index: kalarm/alarmevent.h
===================================================================
--- kalarm/alarmevent.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/alarmevent.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmevent.h  -  represents calendar alarms and events
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -30,7 +30,7 @@
 #include <libkcal/event.h>
 namespace KCal {
 	class Calendar;
-	class Recurrence;
+	class CalendarLocal;
 }
 
 #include "datetime.h"
@@ -61,7 +61,7 @@
 		QString            message() const             { return (mActionType == T_MESSAGE || mActionType == T_EMAIL) ? mText : QString::null; }
 		QString            fileName() const            { return (mActionType == T_FILE) ? mText : QString::null; }
 		QString            command() const             { return (mActionType == T_COMMAND) ? mText : QString::null; }
-		QString            emailFromKMail() const      { return mEmailFromKMail; }
+		uint               emailFromId() const         { return mEmailFromIdentity; }
 		const EmailAddressList& emailAddresses() const { return mEmailAddresses; }
 		QString            emailAddresses(const QString& sep) const  { return mEmailAddresses.join(sep); }
 		const QString&     emailSubject() const        { return mEmailSubject; }
@@ -92,7 +92,7 @@
 	protected:
 		enum Type  { T_MESSAGE, T_FILE, T_COMMAND, T_AUDIO, T_EMAIL };
 
-		KAAlarmEventBase() : mLateCancel(0), mAutoClose(false), mBeep(false), mRepeatAtLogin(false),
+		KAAlarmEventBase() : mRepeatCount(0), mLateCancel(0), mAutoClose(false), mBeep(false), mRepeatAtLogin(false),
 		                     mDisplaying(false), mEmailBcc(false), mConfirmAck(false) { }
 		KAAlarmEventBase(const KAAlarmEventBase& rhs)             { copy(rhs); }
 		KAAlarmEventBase& operator=(const KAAlarmEventBase& rhs)  { copy(rhs);  return *this; }
@@ -105,7 +105,7 @@
 		QColor             mBgColour;         // background colour of alarm message
 		QColor             mFgColour;         // foreground colour of alarm message, or invalid for default
 		QFont              mFont;             // font of alarm message (ignored if mDefaultFont true)
-		QString            mEmailFromKMail;   // KMail identity for email 'From' field, or empty
+		uint               mEmailFromIdentity;// KMail identity for email 'From' field, or empty
 		EmailAddressList   mEmailAddresses;   // ATTENDEE: addresses to send email to
 		QString            mEmailSubject;     // SUMMARY: subject line of email
 		QStringList        mEmailAttachments; // ATTACH: email attachment file names
@@ -113,9 +113,9 @@
 		float              mFadeVolume;       // initial volume for sound file, or < 0 for no fade
 		int                mFadeSeconds;      // fade time for sound file, or 0 if none
 		Type               mActionType;       // alarm action type
-		int                mRepeatCount;      // simple repetition count (excluding the first time)
-		int                mRepeatInterval;   // simple repetition interval (minutes)
-		int                mNextRepeat;       // repetition count of next due repetition
+		int                mRepeatCount;      // sub-repetition count (excluding the first time)
+		int                mRepeatInterval;   // sub-repetition interval (minutes)
+		int                mNextRepeat;       // repetition count of next due sub-repetition
 		int                mLateCancel;       // how many minutes late will cancel the alarm, or 0 for no cancellation
 		bool               mAutoClose;        // whether to close the alarm window after the late-cancel period
 		bool               mCommandScript;    // the command text is a script, not a shell command line
@@ -330,25 +330,23 @@
 		                            { set(dt, filename, bg, fg, f, FILE, lateCancel, flags); }
 		void               setCommand(const QDate&, const QString& command, int lateCancel, int flags, const QString& logfile = QString::null);
 		void               setCommand(const QDateTime&, const QString& command, int lateCancel, int flags, const QString& logfile = QString::null);
-		void               setEmail(const QDate&, const QString& from, const EmailAddressList&, const QString& subject,
+		void               setEmail(const QDate&, uint from, const EmailAddressList&, const QString& subject,
 		                            const QString& message, const QStringList& attachments, int lateCancel, int flags);
-		void               setEmail(const QDateTime&, const QString& from, const EmailAddressList&, const QString& subject,
+		void               setEmail(const QDateTime&, uint from, const EmailAddressList&, const QString& subject,
 		                            const QString& message, const QStringList& attachments, int lateCancel, int flags);
-		void               setEmail(const QString& from, const EmailAddressList&, const QString& subject, const QStringList& attachments);
+		void               setEmail(uint from, const EmailAddressList&, const QString& subject, const QStringList& attachments);
 		void               setAudioFile(const QString& filename, float volume, float fadeVolume, int fadeSeconds);
 		void               setTemplate(const QString& name, int afterTime = -1)  { mTemplateName = name;  mTemplateAfterTime = afterTime;  mUpdated = true; }
 		void               setActions(const QString& pre, const QString& post)   { mPreAction = pre;  mPostAction = post;  mUpdated = true; }
 		OccurType          setNextOccurrence(const QDateTime& preDateTime);
 		void               setFirstRecurrence();
 		void               setEventID(const QString& id)                     { mEventID = id;  mUpdated = true; }
-		void               adjustStartDate(const QDate&);
 		void               setDate(const QDate& d)                           { mNextMainDateTime.set(d);  mUpdated = true; }
 		void               setTime(const QDateTime& dt)                      { mNextMainDateTime.set(dt);  mUpdated = true; }
 		void               setSaveDateTime(const QDateTime& dt)              { mSaveDateTime = dt;  mUpdated = true; }
 		void               setLateCancel(int lc)                             { mLateCancel = lc;  mUpdated = true; }
 		void               setAutoClose(bool ac)                             { mAutoClose = ac;  mUpdated = true; }
 		void               setRepeatAtLogin(bool rl)                         { mRepeatAtLogin = rl;  mUpdated = true; }
-		void               set(int flags);
 		void               setUid(Status s)                                  { mEventID = uid(mEventID, s);  mUpdated = true; }
 		void               setKMailSerialNumber(unsigned long n)             { mKMailSerialNumber = n; }
 		void               setLogFile(const QString& logfile);
@@ -397,7 +395,7 @@
 		DateTime           deferDateTime() const          { return mDeferralTime; }
 		DateTime           deferralLimit(DeferLimitType* = 0) const;
 		int                deferDefaultMinutes() const    { return mDeferDefaultMinutes; }
-		DateTime           nextDateTime(bool includeReminders = true) const;
+		DateTime           displayDateTime() const;
 		const QString&     messageFileOrCommand() const   { return mText; }
 		QString            logFile() const                { return mLogFile; }
 		bool               commandXterm() const           { return mCommandXterm; }
@@ -417,7 +415,6 @@
 		int                longestRecurrenceInterval() const    { return mRecurrence ? mRecurrence->longestInterval() : 0; }
 		QString            recurrenceText(bool brief = false) const;
 		QString            repetitionText(bool brief = false) const;
-		int                remainingRecurrences() const   { return mRemainingRecurrences; }
 		bool               occursAfter(const QDateTime& preDateTime, bool includeRepetitions) const;
 		OccurType          nextOccurrence(const QDateTime& preDateTime, DateTime& result, OccurOption = IGNORE_REPETITION) const;
 		OccurType          previousOccurrence(const QDateTime& afterDateTime, DateTime& result, bool includeRepetitions = false) const;
@@ -459,6 +456,7 @@
 		static QString     calVersionString();
 		static bool        adjustStartOfDay(const KCal::Event::List&);
 		static void        convertKCalEvents(KCal::Calendar&, int version, bool adjustSummerTime);
+		static void        convertRepetitions(KCal::CalendarLocal&);
 
 	private:
 		enum DeferType {
@@ -472,8 +470,10 @@
 		bool               setRecur(KCal::RecurrenceRule::PeriodType, int freq, int count, const QDateTime& end, KARecurrence::Feb29Type = KARecurrence::FEB29_FEB29);
 		void               clearRecur();
 		KARecurrence::Type checkRecur() const;
-		OccurType          nextRecurrence(const QDateTime& preDateTime, DateTime& result, int& remainingCount) const;
+		void               checkRepetition() const;
+		OccurType          nextRecurrence(const QDateTime& preDateTime, DateTime& result) const;
 		OccurType          previousRecurrence(const QDateTime& afterDateTime, DateTime& result) const;
+		static bool        convertRepetition(KCal::Event*);
 		KCal::Alarm*       initKCalAlarm(KCal::Event&, const DateTime&, const QStringList& types, KAAlarm::Type = KAAlarm::INVALID_ALARM) const;
 		KCal::Alarm*       initKCalAlarm(KCal::Event&, int startOffsetSecs, const QStringList& types, KAAlarm::Type = KAAlarm::INVALID_ALARM) const;
 		static DateTime    readDateTime(const KCal::Event&, bool dateOnly, DateTime& start);
@@ -498,7 +498,6 @@
 		int                mDeferDefaultMinutes; // default number of minutes for deferral dialogue, or 0 to select time control
 		int                mRevision;         // SEQUENCE: revision number of the original alarm, or 0
 		KARecurrence*      mRecurrence;       // RECUR: recurrence specification, or 0 if none
-		int                mRemainingRecurrences; // remaining number of alarm recurrences including initial time, -1 to repeat indefinitely
 		int                mAlarmCount;       // number of alarms: count of !mMainExpired, mRepeatAtLogin, mDeferral, mReminderMinutes, mDisplaying
 		DeferType          mDeferral;         // whether the alarm is an extra deferred/deferred-reminder alarm
 		unsigned long      mKMailSerialNumber;// if email text, message's KMail serial number
Index: kalarm/messagewin.h
===================================================================
--- kalarm/messagewin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/messagewin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,6 +23,8 @@
 
 /** @file messagewin.h - displays an alarm message */
 
+#include <qmap.h>
+
 #include "mainwindowbase.h"
 #include "alarmevent.h"
 
@@ -92,8 +94,11 @@
 		void                displayComplete();
 		void                playAudio();
 		void                setDeferralLimit(const KAEvent&);
+		bool                haveErrorMessage(unsigned msg) const;
+		void                clearErrorMessage(unsigned msg) const;
 
 		static QValueList<MessageWin*> mWindowList;  // list of existing message windows
+		static QMap<QString, unsigned> mErrorMessages;  // error messages currently displayed, by event ID
 		// Properties needed by readProperties()
 		QString             mMessage;
 		QFont               mFont;
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kalarm.h  -  global header file
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.17"
+#define KALARM_VERSION "1.5.0"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  mainwindow.cpp  -  main application window
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -71,6 +71,12 @@
 static const char* UI_FILE     = "kalarmui.rc";
 static const char* WINDOW_NAME = "MainWindow";
 
+static const QString VIEW_GROUP         = QString::fromLatin1("View");
+static const QString SHOW_TIME_KEY      = QString::fromLatin1("ShowAlarmTime");
+static const QString SHOW_TIME_TO_KEY   = QString::fromLatin1("ShowTimeToAlarm");
+static const QString SHOW_ARCHIVED_KEY  = QString::fromLatin1("ShowArchivedAlarms");
+static const QString SHOW_RESOURCES_KEY = QString::fromLatin1("ShowResources");
+
 static QString   undoText;
 static QString   undoTextStripped;
 static QString   undoIcon;
@@ -91,10 +97,8 @@
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
 QString MainWindow::i18n_a_ShowAlarmTimes()    { return i18n("Show &Alarm Times"); }
-QString MainWindow::i18n_t_ShowAlarmTime()     { return i18n("Show alarm &time"); }
 QString MainWindow::i18n_m_ShowAlarmTime()     { return i18n("Show alarm ti&me"); }
 QString MainWindow::i18n_o_ShowTimeToAlarms()  { return i18n("Show Time t&o Alarms"); }
-QString MainWindow::i18n_n_ShowTimeToAlarm()   { return i18n("Show time u&ntil alarm"); }
 QString MainWindow::i18n_l_ShowTimeToAlarm()   { return i18n("Show time unti&l alarm"); }
 QString MainWindow::i18n_ShowExpiredAlarms()   { return i18n("Show Expired Alarms"); }
 QString MainWindow::i18n_e_ShowExpiredAlarms() { return i18n("Show &Expired Alarms"); }
@@ -116,21 +120,22 @@
 MainWindow::MainWindow(bool restored)
 	: MainWindowBase(0, "MainWin", WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
 	  mMinuteTimerActive(false),
-	  mHiddenTrayParent(false),
-	  mShowExpired(Preferences::showExpiredAlarms()),
-	  mShowTime(Preferences::showAlarmTime()),
-	  mShowTimeTo(Preferences::showTimeToAlarm())
+	  mHiddenTrayParent(false)
 {
 	kdDebug(5950) << "MainWindow::MainWindow()\n";
 	setAutoSaveSettings(QString::fromLatin1(WINDOW_NAME));    // save window sizes etc.
 	setPlainCaption(kapp->aboutData()->programName());
+	KConfig* config = KGlobal::config();
+	config->setGroup(VIEW_GROUP);
+	mShowExpired = config->readBoolEntry(SHOW_ARCHIVED_KEY, false);
+	mShowTime    = config->readBoolEntry(SHOW_TIME_KEY, true);
+	mShowTimeTo  = config->readBoolEntry(SHOW_TIME_TO_KEY, false);
 	if (!restored)
 	{
 		QSize s;
 		if (KAlarm::readConfigWindowSize(WINDOW_NAME, s))
 			resize(s);
 	}
-	KConfig* config = KGlobal::config();
 	config->setGroup(QString::fromLatin1(WINDOW_NAME));
 	QValueList<int> order = config->readIntListEntry(QString::fromLatin1("ColumnOrder"));
 
@@ -146,6 +151,8 @@
 
 	connect(mListView, SIGNAL(itemDeleted()), SLOT(slotDeletion()));
 	connect(mListView, SIGNAL(selectionChanged()), SLOT(slotSelection()));
+	connect(mListView, SIGNAL(contextMenuRequested(QListViewItem*, const QPoint&, int)),
+	        SLOT(slotContextMenuRequested(QListViewItem*, const QPoint&, int)));
 	connect(mListView, SIGNAL(mouseButtonClicked(int, QListViewItem*, const QPoint&, int)),
 	        SLOT(slotMouseClicked(int, QListViewItem*, const QPoint&, int)));
 	connect(mListView, SIGNAL(executed(QListViewItem*)), SLOT(slotDoubleClicked(QListViewItem*)));
@@ -455,40 +462,6 @@
 }
 
 /******************************************************************************
-* Called when the show-alarm-time or show-time-to-alarm setting changes in the
-* user preferences.
-* Update the alarm list in every main window instance to show the new default
-* columns. No change is made if a window isn't using the old settings.
-*/
-void MainWindow::updateTimeColumns(bool oldTime, bool oldTimeTo)
-{
-	kdDebug(5950) << "MainWindow::updateShowAlarmTimes()\n";
-	bool newTime   = Preferences::showAlarmTime();
-	bool newTimeTo = Preferences::showTimeToAlarm();
-	if (!newTime  &&  !newTimeTo)
-		newTime = true;     // at least one time column must be displayed
-	if (!oldTime  &&  !oldTimeTo)
-		oldTime = true;     // at least one time column must have been displayed
-	if (newTime != oldTime  ||  newTimeTo != oldTimeTo)
-	{
-		for (WindowList::Iterator it = mWindowList.begin();  it != mWindowList.end();  ++it)
-		{
-			MainWindow* w = *it;
-			if (w->mShowTime   == oldTime
-			&&  w->mShowTimeTo == oldTimeTo)
-			{
-				w->mShowTime   = newTime;
-				w->mShowTimeTo = newTimeTo;
-				w->mActionShowTime->setChecked(newTime);
-				w->mActionShowTimeTo->setChecked(newTimeTo);
-				w->mListView->selectTimeColumns(newTime, newTimeTo);
-			}
-		}
-		setUpdateTimer();
-	}
-}
-
-/******************************************************************************
 * Start or stop the timer which updates the time-to-alarm values every minute.
 * Should be called whenever a main window is created or destroyed, or shown or
 * hidden.
@@ -817,7 +790,13 @@
 	if (!mShowTime  &&  !mShowTimeTo)
 		slotShowTimeTo();    // at least one time column must be displayed
 	else
+	{
 		mListView->selectTimeColumns(mShowTime, mShowTimeTo);
+		KConfig* config = KGlobal::config();
+		config->setGroup(VIEW_GROUP);
+		config->writeEntry(SHOW_TIME_KEY, mShowTime);
+		config->writeEntry(SHOW_TIME_TO_KEY, mShowTimeTo);
+	}
 }
 
 /******************************************************************************
@@ -830,7 +809,13 @@
 	if (!mShowTimeTo  &&  !mShowTime)
 		slotShowTime();    // at least one time column must be displayed
 	else
+	{
 		mListView->selectTimeColumns(mShowTime, mShowTimeTo);
+		KConfig* config = KGlobal::config();
+		config->setGroup(VIEW_GROUP);
+		config->writeEntry(SHOW_TIME_KEY, mShowTime);
+		config->writeEntry(SHOW_TIME_TO_KEY, mShowTimeTo);
+	}
 	setUpdateTimer();
 }
 
@@ -844,6 +829,9 @@
 	mActionShowExpired->setToolTip(mShowExpired ? i18n_HideExpiredAlarms() : i18n_ShowExpiredAlarms());
 	mListView->showExpired(mShowExpired);
 	mListView->refresh();
+	KConfig* config = KGlobal::config();
+	config->setGroup(VIEW_GROUP);
+	config->writeEntry(SHOW_ARCHIVED_KEY, mShowExpired);
 }
 
 /******************************************************************************
@@ -1035,8 +1023,7 @@
 		QString actText = Undo::actionText(type, id);
 		QString descrip = Undo::description(type, id);
 		QString text = descrip.isEmpty()
-//		             ? i18n("Undo/Redo [action]", "%1 %2").arg(action).arg(actText)
-		             ? QString("%1 %2").arg(action).arg(actText)
+		             ? i18n("Undo/Redo [action]", "%1 %2").arg(action).arg(actText)
 		             : i18n("Undo [action]: message", "%1 %2: %3").arg(action).arg(actText).arg(descrip);
 		menu->insertItem(text, id);
 	}
@@ -1346,21 +1333,26 @@
 }
 
 /******************************************************************************
-*  Called when the mouse is clicked on the ListView.
-*  Deselects the current item and disables the actions if appropriate, or
-*  displays a context menu to modify or delete the selected item.
+* Called when a context menu is requested either by a mouse click or by a
+* key press.
 */
+void MainWindow::slotContextMenuRequested(QListViewItem* item, const QPoint& pt, int)
+{
+	kdDebug(5950) << "MainWindow::slotContextMenuRequested()" << endl;
+	if (mContextMenu)
+		mContextMenu->popup(pt);
+}
+
+/******************************************************************************
+* Called when the mouse is clicked on the ListView.
+* Deselects the current item and disables the actions if appropriate.
+* Note that if a right button click is handled by slotContextMenuRequested().
+*/
 void MainWindow::slotMouseClicked(int button, QListViewItem* item, const QPoint& pt, int)
 {
-	if (button == Qt::RightButton)
+	if (button != Qt::RightButton  &&  !item)
 	{
-		kdDebug(5950) << "MainWindow::slotMouseClicked(right)\n";
-		if (mContextMenu)
-			mContextMenu->popup(pt);
-	}
-	else if (!item)
-	{
-		kdDebug(5950) << "MainWindow::slotMouseClicked(left)\n";
+		kdDebug(5950) << "MainWindow::slotMouseClicked(left)" << endl;
 		mListView->clearSelection();
 		mActionCreateTemplate->setEnabled(false);
 		mActionCopy->setEnabled(false);
Index: kalarm/editdlg.h
===================================================================
--- kalarm/editdlg.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/editdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.h  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -38,7 +38,6 @@
 class QVBox;
 class QHBox;
 class EmailIdCombo;
-class ColourCombo;
 class FontColourButton;
 class ButtonGroup;
 class TimeEdit;
@@ -49,7 +48,6 @@
 class RecurrenceEdit;
 class Reminder;
 class SpecialActionsButton;
-class RepetitionButton;
 class TimeSpinBox;
 class LineEdit;
 class TextEdit;
@@ -69,8 +67,7 @@
 		bool            getEvent(KAEvent&);
 		void            setAction(KAEvent::Action, const AlarmText& = AlarmText());
 
-		static ColourCombo* createBgColourChooser(QHBox** box, QWidget* parent, const char* name = 0);
-		static CheckBox*    createConfirmAckCheckbox(QWidget* parent, const char* name = 0);
+		static CheckBox* createConfirmAckCheckbox(QWidget* parent, const char* name = 0);
 
 		static QString  i18n_ConfirmAck();         // plain text of 'Confirm acknowledgement' checkbox
 		static QString  i18n_k_ConfirmAck();       // text of 'Confirm acknowledgement' checkbox, with 'k' shortcut
@@ -105,8 +102,6 @@
 		void            slotRecurFrequencyChange();
 		void            slotAlarmTypeChanged(int id);
 		void            slotEditDeferral();
-		void            slotFontColourSelected();
-		void            slotBgColourSelected(const QColor&);
 		void            openAddressBook();
 		void            slotAddAttachment();
 		void            slotRemoveAttachment();
@@ -114,7 +109,7 @@
 		void            slotShowRecurrenceEdit();
 		void            slotAnyTimeToggled(bool anyTime);
 		void            slotTemplateTimeType(int id);
-		void            slotSetSimpleRepetition();
+		void            slotSetSubRepetition();
 		void            slotCmdScriptToggled(bool);
 
 	private:
@@ -166,7 +161,6 @@
 		SoundPicker*        mSoundPicker;
 		CheckBox*           mConfirmAck;
 		FontColourButton*   mFontColourButton;
-		ColourCombo*        mBgColourChoose;
 		SpecialActionsButton* mSpecialActionsButton;
 		Reminder*           mReminder;
 		bool                mReminderDeferral;
@@ -206,8 +200,6 @@
 		LateCancelSelector* mLateCancel;
 		CheckBox*           mShowInKorganizer;
 
-		RepetitionButton*   mSimpleRepetition;
-		QLabel*             mRecurrenceText;
 		RecurrenceEdit*     mRecurrenceEdit;
 
 		QString             mAlarmMessage;       // message text/file name/command/email message
@@ -240,7 +232,7 @@
 		int                 mSavedSoundFadeSeconds;// mSoundPicker fade time
 		bool                mSavedConfirmAck;     // mConfirmAck status
 		QFont               mSavedFont;           // mFontColourButton font
-		QColor              mSavedBgColour;       // mBgColourChoose selection
+		QColor              mSavedBgColour;       // mFontColourButton background colour
 		QColor              mSavedFgColour;       // mFontColourButton foreground colour
 		QString             mSavedPreAction;      // mSpecialActionsButton pre-alarm action
 		QString             mSavedPostAction;     // mSpecialActionsButton post-alarm action
@@ -257,8 +249,6 @@
 		QString             mSavedCmdLogFile;     // mCmdLogFileEdit value
 		DateTime            mSavedDateTime;       // mTimeWidget value
 		int                 mSavedRecurrenceType; // RecurrenceEdit::RepeatType value
-		int                 mSavedRepeatInterval; // alarm repetition interval (via mSimpleRepetition button)
-		int                 mSavedRepeatCount;    // alarm repetition count (via mSimpleRepetition button)
 		int                 mSavedLateCancel;     // mLateCancel value
 		bool                mSavedAutoClose;      // mLateCancel->isAutoClose() value
 		bool                mSavedShowInKorganizer; // mShowInKorganizer status
Index: kalarm/alarmlistview.cpp
===================================================================
--- kalarm/alarmlistview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/alarmlistview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmlistview.cpp  -  widget showing list of outstanding alarms
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -421,7 +421,7 @@
 {
 	setLastColumnText();     // set the message column text
 
-	DateTime dateTime = event.expired() ? event.startDateTime() : event.nextDateTime(false);
+	DateTime dateTime = event.expired() ? event.startDateTime() : event.displayDateTime();
 	if (parent->column(AlarmListView::TIME_COLUMN) >= 0)
 		setText(parent->column(AlarmListView::TIME_COLUMN), alarmTimeText(dateTime));
 	if (parent->column(AlarmListView::TIME_TO_COLUMN) >= 0)
@@ -527,7 +527,7 @@
 {
 	if (event().expired())
 		return QString::null;
-	DateTime dateTime = event().nextDateTime(false);
+	DateTime dateTime = event().displayDateTime();
 	if (dateTime.isDateOnly())
 	{
 		int days = now.date().daysTo(dateTime.date());
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -140,6 +140,7 @@
 		TimeEdit*      mStartOfDay;
 		QButtonGroup*  mXtermType;
 		QLineEdit*     mXtermCommand;
+		int            mXtermFirst;              // id of first terminal window radio button
 		int            mXtermCount;              // number of terminal window types
 };
 
@@ -229,19 +230,14 @@
 		virtual void setDefaults();
 
 	private slots:
-		void         slotListTimeToggled(bool);
-		void         slotListTimeToToggled(bool);
 		void         slotTooltipAlarmsToggled(bool);
 		void         slotTooltipMaxToggled(bool);
 		void         slotTooltipTimeToggled(bool);
 		void         slotTooltipTimeToToggled(bool);
 
 	private:
-		void         setList(bool time, bool timeTo);
 		void         setTooltip(int maxAlarms, bool time, bool timeTo, const QString& prefix);
 
-		QCheckBox*     mListShowTime;
-		QCheckBox*     mListShowTimeTo;
 		QCheckBox*     mTooltipShowAlarms;
 		QCheckBox*     mTooltipMaxAlarms;
 		SpinBox*       mTooltipMaxAlarmCount;
@@ -250,7 +246,6 @@
 		QLineEdit*     mTooltipTimeToPrefix;
 		QLabel*        mTooltipTimeToPrefixLabel;
 		QCheckBox*     mModalMessages;
-		QCheckBox*     mShowExpiredAlarms;
 		SpinBox*       mDaemonTrayCheckInterval;
 };
 
Index: kalarm/kalarmd/alarmguiiface.h
===================================================================
--- kalarm/kalarmd/alarmguiiface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/alarmguiiface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmguiiface.h  -  DCOP interface which alarm daemon clients must implement
  *  Program:  KAlarm's alarm daemon (kalarmd)
- *  Copyright (C) 2001, 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001,2004,2007 by David Jarvie <software@astrojar.org.uk>
  *  Based on the original, (c) 1998, 1999 Preston Brown
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
  *  Copyright (c) 1997-1999 Preston Brown <pbrown@kde.org>
@@ -63,8 +63,9 @@
 
 		/** Called to indicate success/failure of (re)register() call.
 		    @param result success/failure code. Value is of type RegisterResult.
+		    @param version kalarmd version, e.g. 50101 indicates 5.1.1.
 		 */
-		virtual ASYNC registered(bool reregister, int result) = 0;
+		virtual ASYNC registered(bool reregister, int result, int version) = 0;
 };
 
 #endif
Index: kalarm/kalarmd/kalarmd.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/kalarmd.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,6 +10,7 @@
 Name[da]=KAlarm D√¶mon
 Name[de]=KAlarm Erinnerungsprogramm
 Name[el]=ŒîŒ±ŒØŒºŒøŒΩŒ±œÇ KAlarm
+Name[eo]=KAlarm-demono
 Name[es]=Daemon de KAlarm
 Name[et]=KAlarmi h√§iredeemon
 Name[eu]=KAlarm deabrua
Index: kalarm/kalarmd/alarmdaemoniface.h
===================================================================
--- kalarm/kalarmd/alarmdaemoniface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/alarmdaemoniface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmdaemoniface.h  -  DCOP request interface
  *  Program:  KAlarm's alarm daemon (kalarmd)
- *  Copyright (c) 2001, 2004, 2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001,2004-2007 by David Jarvie <software@astrojar.org.uk>
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
  *  Copyright (c) 1997-1999 Preston Brown <pbrown@kde.org>
  *
@@ -34,10 +34,11 @@
     virtual ASYNC enableCalendar(const QString& urlString, bool enable) = 0;
     virtual ASYNC reloadCalendar(const QCString& appname, const QString& urlString) = 0;
     virtual ASYNC resetCalendar(const QCString& appname, const QString& urlString) = 0;
-    virtual ASYNC registerApp(const QCString& appName, const QString& appTitle,
-                              const QCString& dcopObject, const QString& calendarUrl, bool startClient) = 0;
+    virtual ASYNC registerApp(const QCString& appName, const QString& appTitle, const QCString& dcopObject,
+                              const QString& calendarUrl, bool startClient) = 0;
     virtual ASYNC registerChange(const QCString& appName, bool startClient) = 0;
     virtual ASYNC eventHandled(const QCString& appname, const QString& calendarURL, const QString& eventID, bool reload) = 0;
+    virtual ASYNC timeConfigChanged() = 0;
     virtual ASYNC quit() = 0;
 };
 
Index: kalarm/kalarmd/alarmdaemon.cpp
===================================================================
--- kalarm/kalarmd/alarmdaemon.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/alarmdaemon.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -51,8 +51,13 @@
 // Allow plenty of time for session restoration to happen first.
 static const int KALARM_AUTOSTART_TIMEOUT = 30;
 #endif
+static const int SECS_PER_DAY = 3600 * 24;
 
+// KAlarm config file keys
+static const QString START_OF_DAY(QString::fromLatin1("StartOfDay"));
+static const QString AUTOSTART_TRAY(QString::fromLatin1("AutostartTray"));
 
+
 AlarmDaemon::AlarmDaemon(bool autostart, QObject *parent, const char *name)
 	: DCOPObject(name),
 	  QObject(parent, name),
@@ -63,6 +68,8 @@
 
 	ADConfigData::enableAutoStart(true);    // switch autostart on whenever the program is run
 
+	readKAlarmConfig();       // read time-related KAlarm config items
+
 #ifdef AUTOSTART_KALARM
 	if (autostart)
 	{
@@ -78,7 +85,7 @@
 		 */
 		KConfig kaconfig(locate("config", "kalarmrc"));
 		kaconfig.setGroup(QString::fromLatin1("General"));
-		autostart = kaconfig.readBoolEntry(QString::fromLatin1("AutostartTray"), false);
+		autostart = kaconfig.readBoolEntry(AUTOSTART_TRAY, false);
 		if (autostart)
 		{
 			kdDebug(5900) << "AlarmDaemon::AlarmDaemon(): wait to autostart KAlarm\n";
@@ -262,7 +269,7 @@
 
 	// Notify the client of whether the call succeeded.
 	AlarmGuiIface_stub stub(appName, dcopObject);
-	stub.registered(false, result);
+	stub.registered(false, result, DAEMON_VERSION_NUM);
 	kdDebug(5900) << "AlarmDaemon::registerApp() -> " << result << endl;
 }
 
@@ -294,7 +301,7 @@
 
 	// Notify the client of whether the call succeeded.
 	AlarmGuiIface_stub stub(appName, client->dcopObject());
-	stub.registered(true, result);
+	stub.registered(true, result, DAEMON_VERSION_NUM);
 	kdDebug(5900) << "AlarmDaemon::registerChange() -> " << result << endl;
 }
 
@@ -305,7 +312,7 @@
 {
 	ADConfigData::enableAutoStart(on);
 }
-
+ 
 /******************************************************************************
 * Check if any alarms are pending for any enabled calendar, and display the
 * pending alarms.
@@ -377,8 +384,8 @@
 		// The times in 'alarmtimes' corresponding to due alarms are set.
 		// The times for non-due alarms are set invalid in 'alarmtimes'.
 		bool recurs = event->doesRecur();
-		QStringList flags = QStringList::split(QString::fromLatin1(";"), event->customProperty("KALARM", "FLAGS"), false);
-		bool floats = (flags.find(QString::fromLatin1("DATE")) != flags.end());
+		const QStringList cats = event->categories();
+		bool floats = (cats.find(QString::fromLatin1("DATE")) != cats.end());
 		QDateTime nextDateTime = event->dtStart();
 		if (recurs)
 		{
@@ -400,6 +407,8 @@
 				}
 			}
 		}
+		if (floats)
+			nextDateTime.setTime(mStartOfDay);
 		QValueList<QDateTime> alarmtimes;
 		KCal::Alarm::List alarms = event->alarms();
 		for (KCal::Alarm::List::ConstIterator al = alarms.begin();  al != alarms.end();  ++al)
@@ -409,7 +418,7 @@
 			if (alarm->enabled())
 			{
 				QDateTime dt1;
-				if (recurs  &&  !alarm->hasTime())
+				if (!alarm->hasTime())
 				{
 					// Find the latest recurrence for the alarm.
 					// Need to do this for alarms with offsets in order to detect
@@ -418,7 +427,7 @@
 					           : alarm->endOffset().asSeconds() + event->dtStart().secsTo(event->dtEnd());
 					if (offset)
 					{
-						dt1 = nextDateTime.addSecs(offset);
+						dt1 = nextDateTime.addSecs(floats ? (offset/SECS_PER_DAY)*SECS_PER_DAY : offset);
 						if (dt1 > now)
 							dt1 = QDateTime();
 					}
@@ -428,13 +437,15 @@
 				if (nextDateTime <= now  &&  alarm->repeatCount() > 0)
 				{
 					int snoozeSecs = alarm->snoozeTime() * 60;
-					QDateTime lastRepetition = nextDateTime.addSecs(alarm->repeatCount() * snoozeSecs);
+					int offset = alarm->repeatCount() * snoozeSecs;
+					QDateTime lastRepetition = nextDateTime.addSecs(floats ? (offset/SECS_PER_DAY)*SECS_PER_DAY : offset);
 					if (lastRepetition <= now)
 						dt = lastRepetition;
 					else
 					{
 						int repetition = nextDateTime.secsTo(now) / snoozeSecs;
-						dt = nextDateTime.addSecs(repetition * snoozeSecs);
+						int offset = repetition * snoozeSecs;
+						dt = nextDateTime.addSecs(floats ? (offset/SECS_PER_DAY)*SECS_PER_DAY : offset);
 					}
 				}
 				if (!dt.isValid()  ||  dt > now
@@ -577,6 +588,20 @@
 }
 
 /******************************************************************************
+* Read all relevant items from KAlarm config.
+* Executed on DCOP call to notify a time related value change in the KAlarm
+* config file.
+*/
+void AlarmDaemon::readKAlarmConfig()
+{
+	KConfig config(locate("config", "kalarmrc"));
+	config.setGroup(QString::fromLatin1("General"));
+	QDateTime defTime(QDate(1900,1,1), QTime());
+	mStartOfDay = config.readDateTimeEntry(START_OF_DAY, &defTime).time();
+	kdDebug(5900) << "AlarmDaemon::readKAlarmConfig()" << endl;
+}
+
+/******************************************************************************
 * Expand a DCOP call parameter URL to a full URL.
 * (We must store full URLs in the calendar data since otherwise later calls to
 * reload or remove calendars won't necessarily find a match.)
Index: kalarm/kalarmd/kalarmd.h
===================================================================
--- kalarm/kalarmd/kalarmd.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/kalarmd.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kalarmd.h  -  global header file
  *  Program:  KAlarm's alarm daemon (kalarmd)
- *  Copyright ¬© 2004-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2004,2005,2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,7 +25,8 @@
 #include <config.h>
 #endif
 
-#define DAEMON_VERSION            "4.1.3"       // kalarmd version number
+#define DAEMON_VERSION            "4.3"         // kalarmd version number string
+#define DAEMON_VERSION_NUM        40300         // kalarmd version number integer
 #define DAEMON_APP_NAME           "kalarmd"     // DCOP name of alarm daemon application
 #define DAEMON_DCOP_OBJECT        "ad"          // DCOP name of kalarmd's DCOP interface
 
@@ -34,6 +35,6 @@
 #define DAEMON_AUTOSTART_SECTION  "General"     // daemon's config file section for autostart-at-login
 #define DAEMON_AUTOSTART_KEY      "Autostart"   // daemon's config file entry for autostart-at-login
 
-#define AUTOSTART_KALARM   // temporary fix for KAlarm autostart before session restoration
+#define AUTOSTART_KALARM   // fix for KAlarm autostart before session restoration
 
 #endif // KALARMD_H
Index: kalarm/kalarmd/alarmdaemon.h
===================================================================
--- kalarm/kalarmd/alarmdaemon.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/alarmdaemon.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  alarmdaemon.h  -  alarm daemon control routines
  *  Program:  KAlarm's alarm daemon (kalarmd)
- *  Copyright (c) 2001, 2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001,2004-2007 by David Jarvie <software@astrojar.org.uk>
  *  Based on the original, (c) 1998, 1999 Preston Brown
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -52,12 +52,14 @@
 		               { reloadCal(appname, expandURL(urlString), false); }
 		void    resetCalendar(const QCString& appname, const QString& urlString)
 		               { reloadCal(appname, expandURL(urlString), true); }
-		void    registerApp(const QCString& appName, const QString& appTitle,
-		                    const QCString& dcopObject, const QString& calendarUrl, bool startClient);
+		void    registerApp(const QCString& appName, const QString& appTitle, const QCString& dcopObject,
+		                    const QString& calendarUrl, bool startClient);
 		void    registerChange(const QCString& appName, bool startClient);
 		void    eventHandled(const QCString& appname, const QString& calendarURL, const QString& eventID, bool reload);
+		void    timeConfigChanged()   { readKAlarmConfig(); }
 		void    quit();
 		// Other methods
+		void    readKAlarmConfig();
 		void    startMonitoring();
 		void    enableCal(const QString& urlString, bool enable);
 		void    reloadCal(const QCString& appname, const QString& urlString, bool reset);
@@ -71,6 +73,7 @@
 		QTimer* mAlarmTimer;
 		int     mAlarmTimerSyncCount; // countdown to re-synching the alarm timer
 		bool    mAlarmTimerSyncing;   // true while alarm timer interval < 1 minute
+		QTime   mStartOfDay;          // start of day for date-only alarms
 };
 
 #endif // ALARMDAEMON_H
Index: kalarm/kalarmd/kalarmd.autostart.desktop
===================================================================
--- kalarm/kalarmd/kalarmd.autostart.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmd/kalarmd.autostart.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,6 +10,7 @@
 Name[da]=KAlarm D√¶mon
 Name[de]=KAlarm Erinnerungsprogramm
 Name[el]=ŒîŒ±ŒØŒºŒøŒΩŒ±œÇ KAlarm
+Name[eo]=KAlarm-demono
 Name[es]=Daemon de KAlarm
 Name[et]=KAlarmi h√§iredeemon
 Name[eu]=KAlarm deabrua
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,583 +1,616 @@
-KAlarm
+KAlarm Change Log
 
-=== Version 1.4.17 --- 8 October 2007 ===
-Allow time-from-now values up to 999 hours to be entered.
-Fix incorrect email headers resulting in failure to send some emails.
+=== Version 1.5.0 --- 27 January 2008 ===
+- Replace simple repetitions with recurrence sub-repetitions, to save confusion.
+- Add option to enter reminder times in minutes, in addition to hours/minutes.
+- Replace alarm edit dialogue background colour selector with font/colour sample.
+- Store email unique IDs instead of names in email alarms to prevent problems if
+  email IDs are renamed.
+- Fix error "Sender verify failed (in reply to RCPT TO command)" using sendmail
+  on some systems, by adding envelope sender address to emails.
+- Fix minimum value set in sub-repetition dialogue after recurrence type change.
+- Fix OpenSolaris build error.
 
+=== Version 1.4.21 --- 19 December 2007 ===
+- Remember last used main window show/hide options instead of setting them in
+  Preferences dialogue.
+- Make the Menu key work in the alarm list.
+- Fix crash when saving preferences, if 'xterm' is not installed in the system.
+- Prevent multiple identical error messages being displayed for the same alarm.
+
+=== Version 1.4.20 --- 18 November 2007 ===
+- Fix deferral of non-recurring alarms not working.
+- Fix loss of reminder details in archive when alarm has had a reminder deferred.
+- Fix inability to reactivate deleted alarms which still have repetitions to go.
+- Fix incorrect interpretation of --late-cancel weekly parameter on command line.
+
+=== Version 1.4.19 --- 11 November 2007 ===
+- Fix KAlarm hanging and freezing the system for a while, especially on startup.
+- Fix next occurrence time set after editing alarm, when it's a sub-repetition.
+- Prevent error messages while typing date value, until user finishes entering it.
+
+=== Version 1.4.18 --- 2 November 2007 ===
+- Fix failure to trigger some recurring date-only alarms (e.g. after suspend-resume).
+- Fix date-only alarms triggering every minute from midnight to start-of-day time.
+- Simplify recurrence text shown in alarm edit dialogue Alarm tab when possible.
+- Prevent error after browsing for command log file, due to file:// prefix.
+
+=== Version 1.4.17 (KDE 3.5.8) --- 8 October 2007 ===
+- Allow time-from-now values up to 999 hours to be entered.
+- Fix incorrect email headers resulting in failure to send some emails.
+
 === Version 1.4.16a --- 12 September 2007 ===
-Fix failure to retrieve font and colour settings for display alarms.
-Disable reminder etc. controls for at-login recurrence in alarm edit dialogue.
+- Fix failure to retrieve font and colour settings for display alarms.
+- Disable reminder etc. controls for at-login recurrence in alarm edit dialogue.
 
 === Version 1.4.15 --- 7 September 2007 ===
-Fix deferrals of recurring alarms not triggering correctly.
-Fix failure to archive details of repetitions within a recurrence.
-Enable/disable "Show expired alarms" action when preferences change.
+- Fix deferrals of recurring alarms not triggering correctly.
+- Fix failure to archive details of repetitions within a recurrence.
+- Enable/disable "Show expired alarms" action when preferences change.
 
 === Version 1.4.14 --- 5 August 2007 ===
-Fix handling of exception dates in recurrences.
-In sound file dialogue change Play button to a Stop button while playing a file.
+- Fix handling of exception dates in recurrences.
+- In sound file dialogue change Play button to a Stop button while playing a file.
 
 === Version 1.4.13 --- 18 May 2007 ===
-Fix time value in templates not being stored.
-Expand time spin boxes to make room for all digits.
-Make Preferences dialogue non-modal.
+- Fix time value in templates not being stored.
+- Expand time spin boxes to make room for all digits.
+- Make Preferences dialogue non-modal.
 
 === Version 1.4.12 (KDE 3.5.7) --- 11 May 2007 ===
-Display advance reminders for each occurrence of recurring alarms.
-Fix Undo of deletion of active alarms.
-Disable simple repetition controls if repetitions can't fit between recurrences.
-Make the system tray tooltip take account of alarm repetitions.
-Show repetition & special action status by button states in alarm edit dialogue.
-Fix reminder alarms displaying very big numbers for how long until alarm is due.
-Fix KMail omitting attachments from email alarms (if KMail is the email client).
+- Display advance reminders for each occurrence of recurring alarms.
+- Fix Undo of deletion of active alarms.
+- Disable simple repetition controls if repetitions can't fit between recurrences.
+- Make the system tray tooltip take account of alarm repetitions.
+- Show repetition & special action status by button states in alarm edit dialogue.
+- Fix reminder alarms displaying very big numbers for how long until alarm is due.
+- Fix KMail omitting attachments from email alarms (if KMail is the email client).
 
 === Version 1.4.11 --- 16 April 2007 ===
-Prevent pre-alarm actions being executed multiple times when alarm is triggered.
-Prevent alarm daemon triggering alarms multiple times.
-Only execute pre-alarm actions once (not for reminders or deferrals).
-Only execute post-alarm actions once when alarm is finally acknowledged (after
-    any deferrals), and not after reminders.
-Show file name as a tooltip on sound type combo box when "file" is selected.
+- Prevent pre-alarm actions being executed multiple times when alarm is triggered.
+- Prevent alarm daemon triggering alarms multiple times.
+- Only execute pre-alarm actions once (not for reminders or deferrals).
+- Only execute post-alarm actions once when alarm is finally acknowledged (after
+  any deferrals), and not after reminders.
+- Show file name as a tooltip on sound type combo box when "file" is selected.
 
 === Version 1.4.10 --- 3 March 2007 ===
-Add play button to sound file selection dialogue.
-Prevent simple repetitions triggering again when KAlarm is restarted.
-Fix recurring alarms being triggered on exception days.
-Fix start-of-day time being ignored for date-only alarms.
-Disable Defer button in new message window when deferral limit has been reached.
-Fix failure to save "Execute in terminal window" option in Preferences dialogue.
-Ensure up-to-date menus are displayed if user has a customised toolbar.
+- Add play button to sound file selection dialogue.
+- Prevent simple repetitions triggering again when KAlarm is restarted.
+- Fix recurring alarms being triggered on exception days.
+- Fix start-of-day time being ignored for date-only alarms.
+- Disable Defer button in new message window when deferral limit has been reached.
+- Fix failure to save "Execute in terminal window" option in Preferences dialogue.
+- Ensure up-to-date menus are displayed if user has a customised toolbar.
 
 === Version 1.4.9 (KDE 3.5.6) --- 3 January 2007 ===
-Minor changes.
+- Minor changes.
 
 === Version 1.4.8 --- 28 December 2006 ===
-Fix Find always using first search text entered even after entering a new one.
+- Fix Find always using first search text entered even after entering a new one.
 
 === Version 1.4.7 --- 14 December 2006 ===
-Fix crash saving Preferences dialogue (due to command alarm terminal setting).
+- Fix crash saving Preferences dialogue (due to command alarm terminal setting).
 
 === Version 1.4.6 --- 30 November 2006 ===
-Fix crash if an alarm triggers while user is deleting it.
-Fix "Start alarm monitoring at login" value shown in preferences dialogue.
-Fix deselecting "Start alarm monitoring at login" when daemon not running.
-Fix editing of 29th February alarm options for non-leap years.
-Tidy up preferences dialogue Run mode options.
-Tidy up alarm edit/preferences dialogue sound type options into a combo box.
-Add context help for sound file fade options.
+- Fix crash if an alarm triggers while user is deleting it.
+- Fix "Start alarm monitoring at login" value shown in preferences dialogue.
+- Fix deselecting "Start alarm monitoring at login" when daemon not running.
+- Fix editing of 29th February alarm options for non-leap years.
+- Tidy up preferences dialogue Run mode options.
+- Tidy up alarm edit/preferences dialogue sound type options into a combo box.
+- Add context help for sound file fade options.
 
 === Version 1.4.5 (KDE 3.5.5) --- 29 September 2006 ===
-Improve alarm edit dialogue layout (Reminder controls moved to below Time box).
+- Improve alarm edit dialogue layout (Reminder controls moved to below Time box).
 
 === Version 1.4.4 --- 11 July 2006 ===
-Use an alarm's previous deferral time interval as default for its next deferral.
+- Use an alarm's previous deferral time interval as default for its next deferral.
 
 === Version 1.4.3 (KDE 3.5.4) --- 11 July 2006 ===
-Add facility to import alarms from other calendar files.
-Fix Defer dialog time interval maximum to match maximum date/time value.
-Fix crash when a deferred expired recurring alarm is edited from message window.
-Fix crash when a message is redisplayed after login.
-Prevent inapplicable 'Unable to speak' error when alarm redisplayed after login.
-Save main window column order changes to use on restart (except message column).
+- Add facility to import alarms from other calendar files.
+- Fix Defer dialog time interval maximum to match maximum date/time value.
+- Fix crash when a deferred expired recurring alarm is edited from message window.
+- Fix crash when a message is redisplayed after login.
+- Prevent inapplicable 'Unable to speak' error when alarm redisplayed after login.
+- Save main window column order changes to use on restart (except message column).
 
 === Version 1.3.10 (KDE 3.5.3) --- 22 May 2006 ===
-Add DCOP calls and command line options to display the edit alarm dialogue.
-Add Select All and Deselect actions & shortcuts for import birthdays list.
-Make system tray icon appear in non-KDE window managers.
-Output error message if deleting copy of alarm from KOrganizer fails.
-Fix corruption of alarms displayed at logout and then deferred after login.
-Fix reminder time not being saved in alarm templates.
-Fix erroneous date adjustment of start of recurrence when saving alarm.
-Fix crash when --play command line option is used, if compiled without aRts.
-Don't show disabled alarms in system tray tooltip alarm list.
+- Add DCOP calls and command line options to display the edit alarm dialogue.
+- Add Select All and Deselect actions & shortcuts for import birthdays list.
+- Make system tray icon appear in non-KDE window managers.
+- Output error message if deleting copy of alarm from KOrganizer fails.
+- Fix corruption of alarms displayed at logout and then deferred after login.
+- Fix reminder time not being saved in alarm templates.
+- Fix erroneous date adjustment of start of recurrence when saving alarm.
+- Fix crash when --play command line option is used, if compiled without aRts.
+- Don't show disabled alarms in system tray tooltip alarm list.
 
 === Version 1.3.9 (KDE 3.5.2) --- 7 March 2006 ===
-Notify daemon by DCOP that alarm has been processed: to prevent alarm loss, and
-    to prevent defunct kalarm processes when run mode is on-demand.
-Add Select All and Deselect actions & shortcuts for alarm and template lists.
+- Notify daemon by DCOP that alarm has been processed: to prevent alarm loss, and
+  to prevent defunct kalarm processes when run mode is on-demand.
+- Add Select All and Deselect actions & shortcuts for alarm and template lists.
 
 === Version 1.3.8 --- 24 January 2006 ===
-Fix kalarmd hang when triggering late alarm and KAlarm run mode is on-demand.
+- Fix kalarmd hang when triggering late alarm and KAlarm run mode is on-demand.
 
 === Version 1.3.7 --- 22 January 2006 ===
-Fix column widths when main window is resized, if columns have been reordered.
+- Fix column widths when main window is resized, if columns have been reordered.
 
 === Version 1.3.6 (KDE 3.5.1) --- 10 January 2006 ===
-Make autoclose of message windows work.
-Fix New From Template not creating alarm if template contents are not changed.
-Ensure that day and month names translations are independent of locale calendar.
-Display alarm message windows within current screen in multi-head systems.
-Reduce size of Preferences dialog to fit in 1024x768 screen.
+- Make autoclose of message windows work.
+- Fix New From Template not creating alarm if template contents are not changed.
+- Ensure that day and month names translations are independent of locale calendar.
+- Display alarm message windows within current screen in multi-head systems.
+- Reduce size of Preferences dialog to fit in 1024x768 screen.
 
 === Version 1.3.5 --- 14 December 2005 ===
-Fix email attachments being forgotten when saving alarms.
-Fix toolbar configuration being lost after quitting KAlarm.
+- Fix email attachments being forgotten when saving alarms.
+- Fix toolbar configuration being lost after quitting KAlarm.
 
 === Version 1.3.4 (KDE 3.5) --- 30 October 2005 ===
-Fix incorrect recurrence frequency in Alarm Edit dialogue's Alarm tab.
+- Fix incorrect recurrence frequency in Alarm Edit dialogue's Alarm tab.
 
 === Version 1.3.3 --- 22 September 2005 ===
-Add day-of-week selection to daily recurrence dialog.
+- Add day-of-week selection to daily recurrence dialog.
 
 === Version 1.3.2 (KDE 3.5 beta 1) --- 10 September 2005 ===
-Add option to show alarms in KOrganizer's active calendar.
-Add option for email text alarms to locate the email in KMail.
-When email alarm triggers and KMail isn't running, start KMail and send mail
-    automatically instead of opening KMail composer window.
-Provide per-alarm option for yearly February 29th recurrences.
-Wait longer (20 seconds) before reporting alarm daemon registration failed.
-Minimise KMix window if KMix is started by KAlarm when displaying a message.
-Fix Plastik style 'enabled' indication for time spinbox left-hand buttons.
-Prevent message windows always being full screen after a big message is shown.
-Prevent message windows being initially larger than the desktop.
-Prevent message windows initially overlapping the KDE panel.
-Prevent session restoration displaying main windows which should be hidden.
-Fix alarms getting stuck if due during a daylight savings clock change.
-Change --volume command line option short form to -V (-v is used by --version).
-Fix reported shell errors when output from command alarm is discarded.
-Use 'KAlarm' untranslated in calendar product ID, to cater for locale changes.
+- Add option to show alarms in KOrganizer's active calendar.
+- Add option for email text alarms to locate the email in KMail.
+- When email alarm triggers and KMail isn't running, start KMail and send mail
+  automatically instead of opening KMail composer window.
+- Provide per-alarm option for yearly February 29th recurrences.
+- Wait longer (20 seconds) before reporting alarm daemon registration failed.
+- Minimise KMix window if KMix is started by KAlarm when displaying a message.
+- Fix Plastik style 'enabled' indication for time spinbox left-hand buttons.
+- Prevent message windows always being full screen after a big message is shown.
+- Prevent message windows being initially larger than the desktop.
+- Prevent message windows initially overlapping the KDE panel.
+- Prevent session restoration displaying main windows which should be hidden.
+- Fix alarms getting stuck if due during a daylight savings clock change.
+- Change --volume command line option short form to -V (-v is used by --version).
+- Fix reported shell errors when output from command alarm is discarded.
+- Use 'KAlarm' untranslated in calendar product ID, to cater for locale changes.
 
 === Version 1.3.1 --- 30 May 2005 ===
-Add Undo/Redo facility for alarm edit/creation/deletion/reactivation.
-Add text search facility.
-Add option to speak alarm messages (if speech synthesis is installed).
-Add command line option --speak.
-Add 'New alarm from template' menu option and toolbar button.
-Add 'Time from now' option in alarm templates.
-Add fade option for playing sound files.
-Add option to log command alarm output to a file.
-Add Edit button to alarm message window to allow the alarm to be edited.
-Enable drag and drop of alarms to other applications.
-Email drag-and-drop from KMail (KDE >= 3.5) now presets alarm edit dialog with
-    full From/To/Cc/Subject headers and body text.
+- Add Undo/Redo facility for alarm edit/creation/deletion/reactivation.
+- Add text search facility.
+- Add option to speak alarm messages (if speech synthesis is installed).
+- Add command line option --speak.
+- Add 'New alarm from template' menu option and toolbar button.
+- Add 'Time from now' option in alarm templates.
+- Add fade option for playing sound files.
+- Add option to log command alarm output to a file.
+- Add Edit button to alarm message window to allow the alarm to be edited.
+- Enable drag and drop of alarms to other applications.
+- Email drag-and-drop from KMail (KDE >= 3.5) now presets alarm edit dialog with
+  full From/To/Cc/Subject headers and body text.
 
 === Version 1.2.8 (KDE 3.4.1) --- 9 May 2005 ===
-Fix failure to enable "Reminder for first recurrence only" checkbox.
+- Fix failure to enable "Reminder for first recurrence only" checkbox.
 
 === Version 1.2.7 --- 20 April 2005 ===
-Use a sensible default for terminal window command in Preferences dialog.
-Validate terminal window command entered in Preferences dialog.
-Fix date range no longer being validated in Defer dialog.
-Don't ignore Sound setting in Preferences dialog Edit tab.
-Reset sound volume (if it was set) as soon as audio file playing is complete.
-Don't start KMix when an alarm is displayed if no sound volume is specified.
-Add command script and execute-in-terminal options to DCOP interface.
+- Use a sensible default for terminal window command in Preferences dialog.
+- Validate terminal window command entered in Preferences dialog.
+- Fix date range no longer being validated in Defer dialog.
+- Don't ignore Sound setting in Preferences dialog Edit tab.
+- Reset sound volume (if it was set) as soon as audio file playing is complete.
+- Don't start KMix when an alarm is displayed if no sound volume is specified.
+- Add command script and execute-in-terminal options to DCOP interface.
 
 === Version 1.2.6 (KDE 3.4) --- 22 February 2005 ===
-Pop up message windows far from cursor to avoid accidental acknowledgement.
-Start KMix if not already running, for setting alarm sound level.
-Fix alarms not triggering if IDs are duplicated in different calendar files.
-Improve validation when reading configuration file values.
+- Pop up message windows far from cursor to avoid accidental acknowledgement.
+- Start KMix if not already running, for setting alarm sound level.
+- Fix alarms not triggering if IDs are duplicated in different calendar files.
+- Improve validation when reading configuration file values.
 
 === Version 1.2.5 (KDE 3.4 beta2) --- 21 January 2005 ===
-Prevent multiple "Failed to start Alarm Daemon" error messages at startup.
-Fix missing left border for time spinboxes in Plastik style.
+- Prevent multiple "Failed to start Alarm Daemon" error messages at startup.
+- Fix missing left border for time spinboxes in Plastik style.
 
 === Version 1.2.4 (KDE 3.4 beta1) --- 9 January 2005 ===
-Provide option to enter a script for a command alarm, instead of a command line.
-Add option to run command alarms in terminal windows.
-Accept drag and drop of KAddressBook entries to alarm edit dialog email fields.
-Drag and drop now inserts text where appropriate, rather than replacing it.
-Display correct controls after loading a template in alarm edit dialog.
+- Provide option to enter a script for a command alarm, instead of a command line.
+- Add option to run command alarms in terminal windows.
+- Accept drag and drop of KAddressBook entries to alarm edit dialog email fields.
+- Drag and drop now inserts text where appropriate, rather than replacing it.
+- Display correct controls after loading a template in alarm edit dialog.
 
 === Version 1.2.3 --- 7 December 2004 ===
-Put alarm type icons in a separate, sortable, column in alarm list.
-Align times in alarm list.
-Fix crash when the last recurrence of an alarm is reached.
-Fix random limit on expired alarm discard time if stepping with spinbox buttons.
-Fix dialog layouts for right-to-left languages.
-Fix time spin box layout for right-to-left languages.
+- Put alarm type icons in a separate, sortable, column in alarm list.
+- Align times in alarm list.
+- Fix crash when the last recurrence of an alarm is reached.
+- Fix random limit on expired alarm discard time if stepping with spinbox buttons.
+- Fix dialog layouts for right-to-left languages.
+- Fix time spin box layout for right-to-left languages.
 
 === Version 1.2.2 --- 27 November 2004 ===
-Make alarm daemon (kalarmd) exclusive to KAlarm.
-Move control options for alarm daemon into KAlarm preferences dialog.
-Allow user to specify the late-cancellation period for an alarm.
-Add option to automatically close window after late-cancellation period.
-Add facility to enable and disable individual alarms.
-Add simple repetition facility, including repetition within a recurrence.
-Add option to pick a KMail identity to use as sender of email alarms.
-Add option to copy emails sent via sendmail, to KMail sent-mail folder.
-Show scheduled times, not reminder times, in alarm list and system tray tooltip.
-Make time edit controls use 12-hour clock when that is the user's default.
-Also fill in alarm edit dialog email fields when email is dropped onto KAlarm.
-New revised DCOP request interface (old interface still kept for compatibility).
-Make detection of email message display alarms independent of language.
-Use KMix whenever possible to set hardware sound volume.
-Limit range of entered date/time to valid values in deferral dialogue.
-Prevent kalarm failing to register with kalarmd except when really necessary.
-Fix time-to-alarm column in main window not always updating every minute.
+- Make alarm daemon (kalarmd) exclusive to KAlarm.
+- Move control options for alarm daemon into KAlarm preferences dialog.
+- Allow user to specify the late-cancellation period for an alarm.
+- Add option to automatically close window after late-cancellation period.
+- Add facility to enable and disable individual alarms.
+- Add simple repetition facility, including repetition within a recurrence.
+- Add option to pick a KMail identity to use as sender of email alarms.
+- Add option to copy emails sent via sendmail, to KMail sent-mail folder.
+- Show scheduled times, not reminder times, in alarm list and system tray tooltip.
+- Make time edit controls use 12-hour clock when that is the user's default.
+- Also fill in alarm edit dialog email fields when email is dropped onto KAlarm.
+- New revised DCOP request interface (old interface still kept for compatibility).
+- Make detection of email message display alarms independent of language.
+- Use KMix whenever possible to set hardware sound volume.
+- Limit range of entered date/time to valid values in deferral dialogue.
+- Prevent kalarm failing to register with kalarmd except when really necessary.
+- Fix time-to-alarm column in main window not always updating every minute.
 
 === Version 1.1.7 (KDE 3.3.2) --- 27 November 2004 ===
-Fix KAlarm button on message windows to make it always display main window.
-Show scheduled times, not reminder times, in alarm list and system tray tooltip.
-Fix time-to-alarm column in main window not always updating every minute.
+- Fix KAlarm button on message windows to make it always display main window.
+- Show scheduled times, not reminder times, in alarm list and system tray tooltip.
+- Fix time-to-alarm column in main window not always updating every minute.
 
 === Version 1.1.6 (KDE 3.3.1) --- 30 September 2004 ===
-Prevent crash, and output error message, if menu creation fails.
-Unsuppress Quit warning message box if default answer is Cancel quit.
-Prevent blind copy to self of email alarms via KMail when bcc is deselected.
+- Prevent crash, and output error message, if menu creation fails.
+- Unsuppress Quit warning message box if default answer is Cancel quit.
+- Prevent blind copy to self of email alarms via KMail when bcc is deselected.
 
 === Version 1.1.5 --- 1 September 2004 ===
-Show erroneous control in alarm edit dialog when an error message is displayed.
-Make alarm edit dialog always appear on current desktop.
-Make weekly/monthly/yearly recurrences scheduled from command line correspond
+- Show erroneous control in alarm edit dialog when an error message is displayed.
+- Make alarm edit dialog always appear on current desktop.
+- Make weekly/monthly/yearly recurrences scheduled from command line correspond
   correctly to the start date.
-Fix start date for monthly/yearly recurrences scheduled from the command line.
-Fix DCOP triggerEvent() call to not reschedule alarm if it isn't due yet.
+- Fix start date for monthly/yearly recurrences scheduled from the command line.
+- Fix DCOP triggerEvent() call to not reschedule alarm if it isn't due yet.
 
 === Version 1.1.4 --- 21 August 2004 ===
-Fix errors when altering or cancelling deferrals of expired recurrences.
+- Fix errors when altering or cancelling deferrals of expired recurrences.
 
 === Version 1.1.3 (KDE 3.3) --- 28 July 2004 ===
-Fix dialog sizing the first time KAlarm is run.
+- Fix dialog sizing the first time KAlarm is run.
 
 === Version 1.1.2 (KDE 3.3 beta2) --- 11 July 2004 ===
-Fix hangup in interactions with alarm daemon introduced in version 1.1.1.
-Only tick Alarms Enabled menu items once alarms have actually been enabled.
-Fix build for "./configure --without-arts".
+- Fix hangup in interactions with alarm daemon introduced in version 1.1.1.
+- Only tick Alarms Enabled menu items once alarms have actually been enabled.
+- Fix build for "./configure --without-arts".
 
 === Version 1.1.1 (KDE 3.3 beta1) --- 20 June 2004 ===
-Output error message and disable alarms if can't register with alarm daemon.
-Exit if error in alarm calendar name configuration.
-Fix bug where sound file is selected even when Cancel is pressed.
+- Output error message and disable alarms if can't register with alarm daemon.
+- Exit if error in alarm calendar name configuration.
+- Fix bug where sound file is selected even when Cancel is pressed.
 
 === Version 1.1.0 --- 1 June 2004 ===
-Add facility to define alarm templates.
-Add facility to specify pre- and post-alarm shell command actions.
-Add option to play sound file repeatedly until alarm window is closed.
-Add volume control for playing sound file.
-Add 'stop sound' button to alarm message window when sound file is played.
-Rename command line option --sound to --play, add option --play-repeat.
-Add command line option --volume.
-Add 'Configure Shortcuts' and 'Configure Toolbars' menu options in main window.
-After creating/editing alarm, prompt to re-enable alarms if currently disabled.
-Middle mouse button over system tray icon displays new alarm dialog.
-Add option to display a reminder once only before the first alarm recurrence.
-Display time-to-alarm in reminder message window.
-For message texts which are truncated in main window, show full text in tooltip.
-Allow time of day to be entered in format HHMM in time spin boxes.
-Allow hour to be omitted when colon format time is entered in time spin boxes.
-Add "Don't ask again" option to alarm deletion confirmation prompt.
-Prevent expired alarm calendar purges clashing with other alarm actions.
-Fix initial recurrence date/time for weekly/monthly/yearly recurrences.
-Fix yearly recurrences of the last day in the month.
-Disable yearly recurrence's month checkboxes depending on selected day of month.
-Update which time columns are displayed in alarm list when Preferences change.
-Don't store audio/reminder details in email/command alarms.
-Don't store email details in message/file/command alarms.
-Don't close message windows when quit is selected.
-Fix "Warn before quitting" configuration option.
-Don't redisplay error message windows on session restoration.
-Remove obsolete --displayEvent command line option (replaced by --triggerEvent).
-Remove obsolete pre-version 0.7 DCOP calls.
+- Add facility to define alarm templates.
+- Add facility to specify pre- and post-alarm shell command actions.
+- Add option to play sound file repeatedly until alarm window is closed.
+- Add volume control for playing sound file.
+- Add 'stop sound' button to alarm message window when sound file is played.
+- Rename command line option --sound to --play, add option --play-repeat.
+- Add command line option --volume.
+- Add 'Configure Shortcuts' and 'Configure Toolbars' menu options in main window.
+- After creating/editing alarm, prompt to re-enable alarms if currently disabled.
+- Middle mouse button over system tray icon displays new alarm dialog.
+- Add option to display a reminder once only before the first alarm recurrence.
+- Display time-to-alarm in reminder message window.
+- For message texts which are truncated in main window, show full text in tooltip.
+- Allow time of day to be entered in format HHMM in time spin boxes.
+- Allow hour to be omitted when colon format time is entered in time spin boxes.
+- Add "Don't ask again" option to alarm deletion confirmation prompt.
+- Prevent expired alarm calendar purges clashing with other alarm actions.
+- Fix initial recurrence date/time for weekly/monthly/yearly recurrences.
+- Fix yearly recurrences of the last day in the month.
+- Disable yearly recurrence's month checkboxes depending on selected day of month.
+- Update which time columns are displayed in alarm list when Preferences change.
+- Don't store audio/reminder details in email/command alarms.
+- Don't store email details in message/file/command alarms.
+- Don't close message windows when quit is selected.
+- Fix "Warn before quitting" configuration option.
+- Don't redisplay error message windows on session restoration.
+- Remove obsolete --displayEvent command line option (replaced by --triggerEvent).
+- Remove obsolete pre-version 0.7 DCOP calls.
 
 === Version 1.0.7 --- 2 May 2004 ===
-Fix scheduleCommand() and scheduleEmail() DCOP handling.
-Make KAlarm build for "./configure --without-arts".
-Fix email body text not being saved in email alarms.
-Fix loss of --exec command line arguments.
-Remove wasted vertical space from message windows.
+- Fix scheduleCommand() and scheduleEmail() DCOP handling.
+- Make KAlarm build for "./configure --without-arts".
+- Fix email body text not being saved in email alarms.
+- Fix loss of --exec command line arguments.
+- Remove wasted vertical space from message windows.
 
 === Version 1.0.6 (KDE 3.2.2) --- 26 March 2004 ===
-Make the Quit menu item in main window quit the program.
-Update time entry field after editing as soon as mouse cursor leaves it.
-Cancel deferral if reminder is set before it, to prevent it becoming stuck.
-Prevent undeleted recurring alarms being triggered immediately.
-Don't allow alarms to be undeleted if they are completely expired.
+- Make the Quit menu item in main window quit the program.
+- Update time entry field after editing as soon as mouse cursor leaves it.
+- Cancel deferral if reminder is set before it, to prevent it becoming stuck.
+- Prevent undeleted recurring alarms being triggered immediately.
+- Don't allow alarms to be undeleted if they are completely expired.
 
 === Version 1.0.5 (KDE 3.2.1) --- 24 February 2004 ===
-Fix whatsThis text on bottom row of alarm list.
+- Fix whatsThis text on bottom row of alarm list.
 
 === Version 1.0.4 --- 22 February 2004 ===
-Fix freeze at login when multiple alarms trigger.
-Show all audio file types in sound file chooser dialogue.
+- Fix freeze at login when multiple alarms trigger.
+- Show all audio file types in sound file chooser dialogue.
 
 === Version 1.0.3 --- 15 February 2004 ===
-Prevent email alarms from being sent if no 'From' address is configured.
-Omit 'Bcc' when sending email alarms if no 'Bcc' address is configured.
-Fix freeze when starting the alarm daemon.
-Fix memory leaks displaying dialogs.
-Fix scheduleCommand() and scheduleEmail() DCOP handling.
-Fix errors saving expired alarm calendar.
+- Prevent email alarms from being sent if no 'From' address is configured.
+- Omit 'Bcc' when sending email alarms if no 'Bcc' address is configured.
+- Fix freeze when starting the alarm daemon.
+- Fix memory leaks displaying dialogs.
+- Fix scheduleCommand() and scheduleEmail() DCOP handling.
+- Fix errors saving expired alarm calendar.
 
 === Version 1.0.2 (KDE 3.2) --- 29 January 2004 ===
-Prevent editing alarm and saving without changes from deleting the alarm.
+- Prevent editing alarm and saving without changes from deleting the alarm.
 
 === Version 1.0.1 --- 4 January 2004 ===
-Fix failure to see alarms if KAlarm is reactivated while restoring session.
+- Fix failure to see alarms if KAlarm is reactivated while restoring session.
 
 === Version 1.0.0 --- 7 December 2003 ===
-Allow entered start date for timed recurrence events to be earlier than now.
-Prevent attempted entry of recurrence end date earlier than start date or today.
-Fix error displaying time of expired repeat-at-login alarms.
-Fix memory leak when sending emails with attachments.
-Fix error trying to send emails with very small attachments.
-Eliminate duplicate reload-calendar calls to alarm daemon.
+- Allow entered start date for timed recurrence events to be earlier than now.
+- Prevent attempted entry of recurrence end date earlier than start date or today.
+- Fix error displaying time of expired repeat-at-login alarms.
+- Fix memory leak when sending emails with attachments.
+- Fix error trying to send emails with very small attachments.
+- Eliminate duplicate reload-calendar calls to alarm daemon.
 
 === Version 0.9.6 (KDE 3.2 beta1) --- 7 November 2003 ===
-Add option to choose foreground colour for alarm messages.
-Create new alarm by dragging KMail email onto main window or system tray icon.
-Set initial recurrence defaults to correspond to alarm start date.
-Add option for how February 29th recurrences are handled in non-leap years.
-Monthly/yearly recurrence edit: adhere to user preference for start day of week.
-Eliminate multiple confirmation prompts when deleting multiple alarms.
-Eliminate duplicate alarms in system tray tooltip.
-Fix crash after reporting error opening calendar file.
-Fix wrong status in system tray icon if KAlarm starts up with alarms disabled.
-Fix wrong number of days in Time-to-alarm column in main window.
-Fix omission of deferred alarms from system tray tooltip.
+- Add option to choose foreground colour for alarm messages.
+- Create new alarm by dragging KMail email onto main window or system tray icon.
+- Set initial recurrence defaults to correspond to alarm start date.
+- Add option for how February 29th recurrences are handled in non-leap years.
+- Monthly/yearly recurrence edit: adhere to user preference for start day of week.
+- Eliminate multiple confirmation prompts when deleting multiple alarms.
+- Eliminate duplicate alarms in system tray tooltip.
+- Fix crash after reporting error opening calendar file.
+- Fix wrong status in system tray icon if KAlarm starts up with alarms disabled.
+- Fix wrong number of days in Time-to-alarm column in main window.
+- Fix omission of deferred alarms from system tray tooltip.
 
 === Version 0.9.5 --- 3 September 2003 ===
-Add option for non-modal alarm message windows.
-Add option to display a notification when an email alarm queues an email.
-Emails via KMail are sent without opening composer window, if KMail is running.
-Provide separate configuration for 'From' and 'Bcc' addresses for email alarms.
-Add exceptions to recurrence specification.
-Add multiple month selection to yearly recurrence.
-Add day of month selection in yearly recurrence.
-Add last day of month option in monthly and yearly recurrences.
-Add 2nd - 5th last week of month options in monthly and yearly recurrences.
-Add filename completion to file and command alarm edit fields.
-Display alarms-disabled indication in system tray tooltip.
-Enable file alarms to display image files.
-Fix file alarms not dislaying some text files, and improve HTML file display.
-Fix loss of changes to attachment list after editing email alarms.
-Fix wrong recurrence end date being displayed when editing an existing alarm.
+- Add option for non-modal alarm message windows.
+- Add option to display a notification when an email alarm queues an email.
+- Emails via KMail are sent without opening composer window, if KMail is running.
+- Provide separate configuration for 'From' and 'Bcc' addresses for email alarms.
+- Add exceptions to recurrence specification.
+- Add multiple month selection to yearly recurrence.
+- Add day of month selection in yearly recurrence.
+- Add last day of month option in monthly and yearly recurrences.
+- Add 2nd - 5th last week of month options in monthly and yearly recurrences.
+- Add filename completion to file and command alarm edit fields.
+- Display alarms-disabled indication in system tray tooltip.
+- Enable file alarms to display image files.
+- Fix file alarms not dislaying some text files, and improve HTML file display.
+- Fix loss of changes to attachment list after editing email alarms.
+- Fix wrong recurrence end date being displayed when editing an existing alarm.
 
 === Version 0.9.4 --- 3 July 2003 ===
-Add time-to-alarm display option to main alarm list.
-Add option to list next 24 hours' alarms in system tray tooltip.
-Create new alarm by dragging text or URL onto main window or system tray icon.
-Display reasons for failure to send an email.
-Allow editing of the list of message colours.
-Edit new alarm by context menu or double click on white space in alarm list.
-Add show expired alarms option to preferences dialog.
-Display HTML files correctly in file display alarms.
+- Add time-to-alarm display option to main alarm list.
+- Add option to list next 24 hours' alarms in system tray tooltip.
+- Create new alarm by dragging text or URL onto main window or system tray icon.
+- Display reasons for failure to send an email.
+- Allow editing of the list of message colours.
+- Edit new alarm by context menu or double click on white space in alarm list.
+- Add show expired alarms option to preferences dialog.
+- Display HTML files correctly in file display alarms.
 
 === Version 0.9.3 --- 4 March 2003 ===
-Add preferences option to set default sound file for the Edit Alarm dialog.
-Fix display of "Invalid date" message before Edit Alarm dialog displays.
+- Add preferences option to set default sound file for the Edit Alarm dialog.
+- Fix display of "Invalid date" message before Edit Alarm dialog displays.
 
 === Version 0.9.2 --- 28 February 2003 ===
-Option to set font for individual alarm messages.
-Allow multiple alarm selection in the main window.
-KAlarm icon in alarm message window selects the alarm in the main window.
-In Edit Alarm dialog, move all recurrence edit controls into Recurrence tab.
-Add quit warning message option to preferences dialog.
-Add "New Alarm" option to system tray context menu.
-Disallow command alarms when KDE is running in kiosk mode.
-Revised storage of beep, font, colour and program arguments in calendar file.
-Always save alarms in iCalendar format (but vCalendar may still be read).
-Add reminder, recurrence and font parameters to DCOP calls.
-Fix failure to enable alarms when running in on-demand mode.
+- Option to set font for individual alarm messages.
+- Allow multiple alarm selection in the main window.
+- KAlarm icon in alarm message window selects the alarm in the main window.
+- In Edit Alarm dialog, move all recurrence edit controls into Recurrence tab.
+- Add quit warning message option to preferences dialog.
+- Add "New Alarm" option to system tray context menu.
+- Disallow command alarms when KDE is running in kiosk mode.
+- Revised storage of beep, font, colour and program arguments in calendar file.
+- Always save alarms in iCalendar format (but vCalendar may still be read).
+- Add reminder, recurrence and font parameters to DCOP calls.
+- Fix failure to enable alarms when running in on-demand mode.
 
 === Version 0.9.1 --- 16 January 2003 ===
-Add option to set advance reminders for display alarms.
-In run-in-system-tray mode, warn that alarms will be disabled before quitting.
-Fix monthly and yearly recurrences on nth Monday etc. of the month.
-Fix yearly recurrences on February 29th.
-Fix recurrence start times stored in expired calendar file.
-Fix extra empty events being stored in expired calendar file.
+- Add option to set advance reminders for display alarms.
+- In run-in-system-tray mode, warn that alarms will be disabled before quitting.
+- Fix monthly and yearly recurrences on nth Monday etc. of the month.
+- Fix yearly recurrences on February 29th.
+- Fix recurrence start times stored in expired calendar file.
+- Fix extra empty events being stored in expired calendar file.
 
 === Version 0.9.0 --- 3 January 2003 ===
-Add facility to import birthdays from KAddressBook
-Add option to send an email instead of displaying an alarm message.
-Add option to store and view expired alarms.
-Add copy, view and undelete actions (as applicable) for the selected alarm.
-In alarm message window, message text can be copied to clipboard using mouse.
-Allow message text to be scrolled in alarm message window if too big to fit.
-Shift key with left mouse button steps time edit arrows by 5 minutes/6 hours.
-Report failure to run command alarm (bash, ksh shells only).
-Retain repeat-at-login status on alarm deferral.
-Restore alarm messages which were displayed before KAlarm was killed or crashed.
-Store alarm data in the calendar file in a more standard way.
-Alarm message defer dialog: update recurrence deferral time limit in real time.
-Weekly recurrence edit: adhere to user preference for start day of week.
-Use standard action icons.
+- Add facility to import birthdays from KAddressBook
+- Add option to send an email instead of displaying an alarm message.
+- Add option to store and view expired alarms.
+- Add copy, view and undelete actions (as applicable) for the selected alarm.
+- In alarm message window, message text can be copied to clipboard using mouse.
+- Allow message text to be scrolled in alarm message window if too big to fit.
+- Shift key with left mouse button steps time edit arrows by 5 minutes/6 hours.
+- Report failure to run command alarm (bash, ksh shells only).
+- Retain repeat-at-login status on alarm deferral.
+- Restore alarm messages which were displayed before KAlarm was killed or crashed.
+- Store alarm data in the calendar file in a more standard way.
+- Alarm message defer dialog: update recurrence deferral time limit in real time.
+- Weekly recurrence edit: adhere to user preference for start day of week.
+- Use standard action icons.
 
 === Version 0.8.5 (KDE 3.1.1) --- 21 February 2003 ===
-Fix monthly and yearly recurrences on nth Monday etc. of the month.
-Fix yearly recurrences on February 29th.
-Fix failure to enable alarms when running in on-demand mode.
+- Fix monthly and yearly recurrences on nth Monday etc. of the month.
+- Fix yearly recurrences on February 29th.
+- Fix failure to enable alarms when running in on-demand mode.
 
 === Version 0.8.4 (KDE 3.1) --- 8 January 2003 ===
-*Fix monthly and yearly recurrences on nth Monday etc. of the month.
-*Fix yearly recurrences on February 29th.
-Make KAlarm icon in message window bring main window to current desktop.
-Fix detection of KDE desktop.
-Fix entry of yearly recurrences on a specified date in the year.
+- Make KAlarm icon in message window bring main window to current desktop.
+- Fix detection of KDE desktop.
+- Fix entry of yearly recurrences on a specified date in the year.
 
 === Version 0.8.3 --- 9 November 2002 ===
-Fix no system tray icon being displayed.
-Fix multiple system tray icons being displayed.
-Fix alarms being missed after changing "Disable alarms when not running" status.
+- Fix no system tray icon being displayed.
+- Fix multiple system tray icons being displayed.
+- Fix alarms being missed after changing "Disable alarms when not running" status.
 
 === Version 0.8.2 --- 2 November 2002 ===
-Fix audio files not playing.
+- Fix audio files not playing.
 
 === Version 0.8.1 --- 1 November 2002 ===
-Adhere to KDE single/double click setting when clicking on alarm list.
-Fix possible loss of alarms if KAlarm has previously used another calendar file.
-Fix coordination between "At time" and "After time" values when they change.
-Always remove alarm deferral even when next recurrence triggers instead.
-When alarm triggers, replace any existing repeat-at-login alarm message window.
-Fix deselection of Sound not working after selecting a sound file.
-Fix display of hour spin buttons in time edit spin boxes.
-Prevent time edit spin box buttons from selecting the text.
-Clean up previous alarm list highlight properly when a new alarm is selected.
-Set sensible initial focus when edit alarm dialog pages are displayed.
-Fix Quit duplicate entry in system tray context menu.
+- Adhere to KDE single/double click setting when clicking on alarm list.
+- Fix possible loss of alarms if KAlarm has previously used another calendar file.
+- Fix coordination between "At time" and "After time" values when they change.
+- Always remove alarm deferral even when next recurrence triggers instead.
+- When alarm triggers, replace any existing repeat-at-login alarm message window.
+- Fix deselection of Sound not working after selecting a sound file.
+- Fix display of hour spin buttons in time edit spin boxes.
+- Prevent time edit spin box buttons from selecting the text.
+- Clean up previous alarm list highlight properly when a new alarm is selected.
+- Set sensible initial focus when edit alarm dialog pages are displayed.
+- Fix Quit duplicate entry in system tray context menu.
 
 === Version 0.8 (KDE 3.1 beta2) --- 16 September 2002 ===
-Move recurrence edit to separate tab in alarm dialog (now fits 800x600 display).
-Add accelerator keys in dialogs.
-Provide date picker for entering dates.
+- Move recurrence edit to separate tab in alarm dialog (now fits 800x600 display).
+- Add accelerator keys in dialogs.
+- Provide date picker for entering dates.
 
 === Version 0.7.5 --- 1 September 2002 ===
-Add preferences options to choose default settings for the Edit Alarm dialog.
-Fix right-to-left character sets not being displayed in message edit control.
-Make "Help -> Report Bug" use the KDE bug system (bug #43250).
-Fix session restoration not occurring.
+- Add preferences options to choose default settings for the Edit Alarm dialog.
+- Fix right-to-left character sets not being displayed in message edit control.
+- Make "Help -> Report Bug" use the KDE bug system (bug #43250).
+- Fix session restoration not occurring.
 
 === Version 0.7.4 (KDE 3.1 beta1) --- 5 August 2002 ===
-Add option to prompt for confirmation on alarm deletion.
-Add option to prompt for confirmation on alarm acknowedgement.
-Display KAlarm handbook Preferences section when Help clicked in config dialog.
-Correctly adjust wrong summer times stored by version 0.5.7 (KDE 3.0.0).
+- Add option to prompt for confirmation on alarm deletion.
+- Add option to prompt for confirmation on alarm acknowedgement.
+- Display KAlarm handbook Preferences section when Help clicked in config dialog.
+- Correctly adjust wrong summer times stored by version 0.5.7 (KDE 3.0.0).
 
 === Version 0.7.3 --- 24 July 2002 ===
-Fix loss of alarm times after saving pre-version 0.7 calendar file.
-Fix main alarm list display of hours or hours/minutes repeat interval.
-Display KAlarm handbook when Help clicked in configuration dialog.
+- Fix loss of alarm times after saving pre-version 0.7 calendar file.
+- Fix main alarm list display of hours or hours/minutes repeat interval.
+- Display KAlarm handbook when Help clicked in configuration dialog.
 
 === Version 0.7.2 --- 2 July 2002 ===
-Fix reading wrong alarm times from pre-version 0.7 calendar file.
-Partially fix loss of alarm times after saving pre-version 0.7 calendar file.
+- Fix reading wrong alarm times from pre-version 0.7 calendar file.
+- Partially fix loss of alarm times after saving pre-version 0.7 calendar file.
 
 === Version 0.7.1 --- 29 June 2002 ===
-Prevent duplicate message windows from being displayed.
-Make Close button on message window not the default button to reduce chance
-    of accidental acknowledgement.
-Fix non-ASCII message texts being saved as question marks.
-Fix memory leak with recurrences.
+- Prevent duplicate message windows from being displayed.
+- Make Close button on message window not the default button to reduce chance
+  of accidental acknowledgement.
+- Fix non-ASCII message texts being saved as question marks.
+- Fix memory leak with recurrences.
 
 === Version 0.7.0 --- 15 June 2002 ===
-Add option to play audio file when message is displayed.
-Add daily, weekly, monthly, annual recurrences.
-Allow deferring only up to next scheduled repetition time.
-Don't defer repetitions when an alarm is deferred.
-Make regular repetition and repeat-at-login mutually exclusive.
-Double click on alarm in main window opens alarm edit dialog.
-Change Reset Daemon menu option to Refresh Alarms.
-Save and restore window sizes.
+- Add option to play audio file when message is displayed.
+- Add daily, weekly, monthly, annual recurrences.
+- Allow deferring only up to next scheduled repetition time.
+- Don't defer repetitions when an alarm is deferred.
+- Make regular repetition and repeat-at-login mutually exclusive.
+- Double click on alarm in main window opens alarm edit dialog.
+- Change Reset Daemon menu option to Refresh Alarms.
+- Save and restore window sizes.
 
 === Version 0.6.4 --- 8 May 2002 ===
-Make click on system tray icon always bring KAlarm to top on current desktop.
-Fix alarms not being triggered (depending on time zone).
+- Make click on system tray icon always bring KAlarm to top on current desktop.
+- Fix alarms not being triggered (depending on time zone).
 
 === Version 0.6.0 --- 8 March 2002 ===
-Add option to execute a command instead of displaying an alarm message.
-Add Try button to alarm message edit dialog.
-Add icons in the alarm list to indicate each alarm's type.
-Display error message if a file to be displayed is not a text file.
-Reduce chance of lost late-cancel alarms when daemon check interval is reduced.
-Rename command line option --displayEvent to --triggerEvent.
-Rename DCOP function displayMessage() to triggerEvent().
-Rename DCOP function cancelMessage() to cancelEvent().
+- Add option to execute a command instead of displaying an alarm message.
+- Add Try button to alarm message edit dialog.
+- Add icons in the alarm list to indicate each alarm's type.
+- Display error message if a file to be displayed is not a text file.
+- Reduce chance of lost late-cancel alarms when daemon check interval is reduced.
+- Rename command line option --displayEvent to --triggerEvent.
+- Rename DCOP function displayMessage() to triggerEvent().
+- Rename DCOP function cancelMessage() to cancelEvent().
 
 === Version 0.5.8 (KDE 3.0.5A) --- 23 November 2002 ===
-Fix detection of KDE desktop.
+- Fix detection of KDE desktop.
 
 === Version 0.5.8 (KDE 3.0.5) --- 4 October 2002 ===
-Fix possible loss of alarms if KAlarm has previously used another calendar file.
+- Fix possible loss of alarms if KAlarm has previously used another calendar file.
 
 === Version 0.5.8 (KDE 3.0.4) --- 18 August 2002 ===
-Make "Help -> Report Bug" use the KDE bug system (bug #43250).
-Fix right-to-left character sets not being displayed in message edit control.
+- Make "Help -> Report Bug" use the KDE bug system (bug #43250).
+- Fix right-to-left character sets not being displayed in message edit control.
 
 === Version 0.5.8 (KDE 3.0.3) --- 5 August 2002 ===
-Adjust wrong summer times stored by version 0.5.7 (KDE 3.0.0).
-Display KAlarm handbook when Help clicked in configuration dialog.
-Make Close button on message window not the default button to reduce chance
+- Adjust wrong summer times stored by version 0.5.7 (KDE 3.0.0).
+- Display KAlarm handbook when Help clicked in configuration dialog.
+- Make Close button on message window not the default button to reduce chance
   of accidental acknowledgement.
-Fix session restoration often not occurring at login.
+- Fix session restoration often not occurring at login.
 
 === Version 0.5.7 (KDE 3.0.1) --- 9 May 2002 ===
-Use local time for alarm times instead of using a time zone.
-Make click on system tray icon always bring KAlarm to top on current desktop.
+- Use local time for alarm times instead of using a time zone.
+- Make click on system tray icon always bring KAlarm to top on current desktop.
 
 === Version 0.5.7 (KDE 3.0) --- 17 March 2002 ===
-Show system tray icon on deferring command line-initiated message (run-in-
-    system-tray mode).
-Associate main window with system tray icon when displayed from message window.
-Don't start KAlarm at login, until it has been run for the first time.
-Add startup notification to kalarm.desktop.
-Prevent open main window from cancelling KDE session shutdown.
-Fix failure to display messages after daemon is restarted (run-on-demand mode).
-Fix possible failure to display command line-initiated message.
-Fix crash in some circumstances on changing run mode to run-on-demand.
-Fix crash on clicking KAlarm icon in command line-initiated message window.
-Fix crash on deferring alarm in command line-initiated message window.
-Fix duplication of repeat-at-login alarms at login.
-Fix error displaying text file messages.
+- Show system tray icon on deferring command line-initiated message (run-in-
+  system-tray mode).
+- Associate main window with system tray icon when displayed from message window.
+- Don't start KAlarm at login, until it has been run for the first time.
+- Add startup notification to kalarm.desktop.
+- Prevent open main window from cancelling KDE session shutdown.
+- Fix failure to display messages after daemon is restarted (run-on-demand mode).
+- Fix possible failure to display command line-initiated message.
+- Fix crash in some circumstances on changing run mode to run-on-demand.
+- Fix crash on clicking KAlarm icon in command line-initiated message window.
+- Fix crash on deferring alarm in command line-initiated message window.
+- Fix duplication of repeat-at-login alarms at login.
+- Fix error displaying text file messages.
 
 === Version 0.5.4 --- 7 February 2002 ===
-Fix extra window being displayed in session restoration.
+- Fix extra window being displayed in session restoration.
 
 === Version 0.5.2 --- 31 January 2002 ===
-Fix session restore crash if in 'run continuously in system tray' mode.
+- Fix session restore crash if in 'run continuously in system tray' mode.
 
 === Version 0.5.1 --- 30 January 2002 ===
-Change configuration defaults.
+- Change configuration defaults.
 
 === Version 0.5 --- 29 January 2002 ===
-Incorporate system tray icon into KAlarm, add --tray option.
-Add 'run continuously in system tray' operating mode.
-Don't use alarm daemon GUI application.
-Add enable/disable alarms option to main window menu.
-Add show/hide system tray icon option to main window menu.
-Add toolbar.
-Rename alarm dialog Set Alarm button to OK.
-Rename message window OK button to Close.
-Remove keyboard accelerator for Reset Daemon.
-Fix magnified system tray icon.
-Include README, etc. files in installation.
+- Incorporate system tray icon into KAlarm, add --tray option.
+- Add 'run continuously in system tray' operating mode.
+- Don't use alarm daemon GUI application.
+- Add enable/disable alarms option to main window menu.
+- Add show/hide system tray icon option to main window menu.
+- Add toolbar.
+- Rename alarm dialog Set Alarm button to OK.
+- Rename message window OK button to Close.
+- Remove keyboard accelerator for Reset Daemon.
+- Fix magnified system tray icon.
+- Include README, etc. files in installation.
 
 === Version 0.4 --- 22 December 2001 ===
-Modify to use split alarm daemon/alarm daemon GUI.
-Prevent a command line error exiting all open KAlarm windows.
-Ensure the program exits after starting with --stop or --reset options.
+- Modify to use split alarm daemon/alarm daemon GUI.
+- Prevent a command line error exiting all open KAlarm windows.
+- Ensure the program exits after starting with --stop or --reset options.
 
 === Version 0.3.5 --- 5 December 2001 ===
-Add option to repeat alarms at login.
-Add context help button to main window and message window.
-Fix occasional crash on displaying non-repeating alarms.
-Fix possible failure to display alarms at login.
-Fix blank title bar when main window restored at login.
-Fix alarms not deleted from main window when displayed at login.
-Fix handling of zero-length calendar file.
-Improve error messages.
-Make documentation files installation dependent on KDE version.
+- Add option to repeat alarms at login.
+- Add context help button to main window and message window.
+- Fix occasional crash on displaying non-repeating alarms.
+- Fix possible failure to display alarms at login.
+- Fix blank title bar when main window restored at login.
+- Fix alarms not deleted from main window when displayed at login.
+- Fix handling of zero-length calendar file.
+- Improve error messages.
+- Make documentation files installation dependent on KDE version.
 
 === Version 0.3.1 --- 20 November 2001 ===
-Fix build fault when using ./configure --enable-final
+- Fix build fault when using ./configure --enable-final
 
 === Version 0.3 --- 4 November 2001 ===
-Add option to display a file's contents instead of specifying a message.
-Add dialog option to set an alarm's time as an interval from the current time.
-Add defer option to alarm message window.
-Provide button in alarm message window to activate KAlarm.
-Make dialogs modal only for their parent window.
+- Add option to display a file's contents instead of specifying a message.
+- Add dialog option to set an alarm's time as an interval from the current time.
+- Add defer option to alarm message window.
+- Provide button in alarm message window to activate KAlarm.
+- Make dialogs modal only for their parent window.
 
 === Version 0.2 --- 20 October 2001 ===
-Implement repeating alarms.
-Add extra pair of arrow buttons to time spinbox to change the hour.
-Fix sorting by colour column.
-Better What's This? texts for the main window.
-Remove -r, -s short options (use --reset, --stop instead).
+- Implement repeating alarms.
+- Add extra pair of arrow buttons to time spinbox to change the hour.
+- Fix sorting by colour column.
+- Better What's This? texts for the main window.
+- Remove -r, -s short options (use --reset, --stop instead).
 
 === Version 0.1.1 --- 1 September 2001 ===
-Fix documentation not being created by build.
+- Fix documentation not being created by build.
 
 === Version 0.1 --- 31 August 2001 ===
-Initial release.
+- Initial release.
Index: kalarm/kalarmapp.cpp
===================================================================
--- kalarm/kalarmapp.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmapp.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kalarmapp.cpp  -  the KAlarm application object
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -68,7 +68,7 @@
 
 
 static bool convWakeTime(const QCString& timeParam, QDateTime&, bool& noTime);
-static bool convInterval(const QCString& timeParam, KARecurrence::Type&, int& timeInterval, bool allowMonthYear = true);
+static bool convInterval(const QCString& timeParam, KARecurrence::Type&, int& timeInterval, bool allowMonthYear = false);
 
 /******************************************************************************
 * Find the maximum number of seconds late which a late-cancel alarm is allowed
@@ -131,8 +131,6 @@
 		DateTime::setStartOfDay(mStartOfDay);
 		mPrefsExpiredColour   = Preferences::expiredColour();
 		mPrefsExpiredKeepDays = Preferences::expiredKeepDays();
-		mPrefsShowTime        = Preferences::showAlarmTime();
-		mPrefsShowTimeTo      = Preferences::showTimeToAlarm();
 	}
 
 	// Check if the speech synthesis daemon is installed
@@ -394,7 +392,7 @@
 				// Display a message or file, execute a command, or send an email
 				KAEvent::Action action = KAEvent::MESSAGE;
 				QCString         alMessage;
-				QCString         alFromID;
+				uint             alFromID = 0;
 				EmailAddressList alAddresses;
 				QStringList      alAttachments;
 				QCString         alSubject;
@@ -430,7 +428,7 @@
 					if (args->isSet("subject"))
 						alSubject = args->getOption("subject");
 					if (args->isSet("from-id"))
-						alFromID = args->getOption("from-id");
+						alFromID = KAMail::identityUoid(args->getOption("from-id"));
 					QCStringList params = args->getOptionList("mail");
 					for (QCStringList::Iterator i = params.begin();  i != params.end();  ++i)
 					{
@@ -550,7 +548,7 @@
 
 					if (haveRecurrence)
 					{
-						// There is a also a recurrence specified, so set up a simple repetition
+						// There is a also a recurrence specified, so set up a sub-repetition
 						int longestInterval = recurrence.longestInterval();
 						if (count * interval > longestInterval)
 							USAGE(i18n("Invalid %1 and %2 parameters: repetition is longer than %3 interval").arg(QString::fromLatin1("--interval")).arg(QString::fromLatin1("--repeat")).arg(QString::fromLatin1("--recurrence")));
@@ -625,29 +623,17 @@
 						USAGE(i18n("%1 incompatible with %2").arg(opt).arg(QString::fromLatin1("--mail")))
 					KARecurrence::Type recurType;
 					QString optval = args->getOption(onceOnly ? "reminder-once" : "reminder");
-					bool ok = convInterval(args->getOption(onceOnly ? "reminder-once" : "reminder"), recurType, reminderMinutes);
-					if (ok)
-					{
-						switch (recurType)
-						{
-							case KARecurrence::MINUTELY:
-								if (alarmNoTime)
-									USAGE(i18n("Invalid %1 parameter for date-only alarm").arg(opt))
-								break;
-							case KARecurrence::DAILY:     reminderMinutes *= 1440;  break;
-							case KARecurrence::WEEKLY:    reminderMinutes *= 7*1440;  break;
-							default:   ok = false;  break;
-						}
-					}
-					if (!ok)
+					if (!convInterval(args->getOption(onceOnly ? "reminder-once" : "reminder"), recurType, reminderMinutes))
 						USAGE(i18n("Invalid %1 parameter").arg(opt))
+					if (recurType == KARecurrence::MINUTELY  &&  alarmNoTime)
+						USAGE(i18n("Invalid %1 parameter for date-only alarm").arg(opt))
 				}
 
 				int lateCancel = 0;
 				if (args->isSet("late-cancel"))
 				{
 					KARecurrence::Type recurType;
-					bool ok = convInterval(args->getOption("late-cancel"), recurType, lateCancel, false);
+					bool ok = convInterval(args->getOption("late-cancel"), recurType, lateCancel);
 					if (!ok  ||  lateCancel <= 0)
 						USAGE(i18n("Invalid %1 parameter").arg(QString::fromLatin1("late-cancel")))
 				}
@@ -1116,15 +1102,6 @@
 	// In case the date for February 29th recurrences has changed
 	KARecurrence::setDefaultFeb29Type(Preferences::defaultFeb29Type());
 
-	if (Preferences::showAlarmTime()   != mPrefsShowTime
-	||  Preferences::showTimeToAlarm() != mPrefsShowTimeTo)
-	{
-		// The default alarm list time columns selection has changed
-		MainWindow::updateTimeColumns(mPrefsShowTime, mPrefsShowTimeTo);
-		mPrefsShowTime   = Preferences::showAlarmTime();
-		mPrefsShowTimeTo = Preferences::showTimeToAlarm();
-	}
-
 	if (Preferences::expiredColour() != mPrefsExpiredColour)
 	{
 		// The expired alarms text colour has changed
@@ -1152,6 +1129,7 @@
 */
 void KAlarmApp::changeStartOfDay()
 {
+	Daemon::notifyTimeChanged();   // tell the alarm daemon the new time
 	QTime sod = Preferences::startOfDay();
 	DateTime::setStartOfDay(sod);
 	AlarmCalendar* cal = AlarmCalendar::activeCalendar();
@@ -1188,7 +1166,7 @@
                               int lateCancel, int flags, const QColor& bg, const QColor& fg, const QFont& font,
                               const QString& audioFile, float audioVolume, int reminderMinutes,
                               const KARecurrence& recurrence, int repeatInterval, int repeatCount,
-                              const QString& mailFromID, const EmailAddressList& mailAddresses,
+                              uint mailFromID, const EmailAddressList& mailAddresses,
                               const QString& mailSubject, const QStringList& mailAttachments)
 {
 	kdDebug(5950) << "KAlarmApp::scheduleEvent(): " << text << endl;
@@ -1287,7 +1265,6 @@
 		case EVENT_HANDLE:     // handle it if it's due
 		{
 			QDateTime now = QDateTime::currentDateTime();
-			DateTime  repeatDT;
 			bool updateCalAndDisplay = false;
 			bool alarmToExecuteValid = false;
 			KAAlarm alarmToExecute;
@@ -1295,20 +1272,8 @@
 			// Note that the main alarm is fetched before any other alarms.
 			for (KAAlarm alarm = event.firstAlarm();  alarm.valid();  alarm = event.nextAlarm(alarm))
 			{
-				if (alarm.deferred()  &&  event.repeatCount()
-				&&  repeatDT.isValid()  &&  alarm.dateTime() > repeatDT)
-				{
-					// This deferral of a repeated alarm is later than the last previous
-					// occurrence of the main alarm, so use the deferral alarm instead.
-					// If the deferral is not yet due, this prevents the main alarm being
-					// triggered repeatedly. If the deferral is due, this triggers it
-					// in preference to the main alarm.
-					alarmToExecute      = KAAlarm();
-					alarmToExecuteValid = false;
-					updateCalAndDisplay = false;
-				}
 				// Check if the alarm is due yet.
-				int secs = alarm.dateTime(true).secsTo(now);
+				int secs = alarm.dateTime(true).dateTime().secsTo(now);
 				if (secs < 0)
 				{
 					// This alarm is definitely not due yet
@@ -2118,8 +2083,10 @@
 }
 
 /******************************************************************************
-*  Convert a time interval command line parameter.
-*  Reply = true if successful.
+* Convert a time interval command line parameter.
+* 'timeInterval' receives the count for the recurType. If 'allowMonthYear' is
+* false, 'timeInterval' is converted to minutes.
+* Reply = true if successful.
 */
 static bool convInterval(const QCString& timeParam, KARecurrence::Type& recurType, int& timeInterval, bool allowMonthYear)
 {
@@ -2171,6 +2138,21 @@
 	}
 	if (ok)
 		interval += timeString.toUInt(&ok);
+	if (!allowMonthYear)
+	{
+		// Convert time interval to minutes
+		switch (recurType)
+		{
+			case KARecurrence::WEEKLY:
+				interval *= 7;
+				// fall through to DAILY
+			case KARecurrence::DAILY:
+				interval *= 24*60;
+				break;
+			default:
+				break;
+		}
+	}
 	timeInterval = static_cast<int>(interval);
 	if (negative)
 		timeInterval = -timeInterval;
Index: kalarm/daemon.h
===================================================================
--- kalarm/daemon.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/daemon.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  daemon.h  -  interface with alarm daemon
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -48,6 +48,7 @@
 		static bool      stop();
 		static bool      autoStart();
 		static void      enableAutoStart(bool enable);
+		static void      notifyTimeChanged();
 		static void      setAlarmsEnabled()      { mInstance->setAlarmsEnabled(true); }
 		static void      checkStatus()           { checkIfRunning(); }
 		static bool      monitoringAlarms();
@@ -83,7 +84,7 @@
 		};
 		Daemon() { }
 		static bool      registerWith(bool reregister);
-		static void      registrationResult(bool reregister, int result);
+		static void      registrationResult(bool reregister, int result, int version = 0);
 		static void      reload();
 		static void      notifyEventHandled(const QString& eventID, bool reloadCal);
 		static void      updateRegisteredStatus(bool timeout = false);
Index: kalarm/recurrenceedit.h
===================================================================
--- kalarm/recurrenceedit.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/recurrenceedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  recurrenceedit.h  -  widget to edit the event's recurrence definition
  *  Program:  kalarm
- *  Copyright ¬© 2002-2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2005,2008 by David Jarvie <djarvie@kde.org>
  *
  *  Based originally on KOrganizer module koeditorrecurrence.h,
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
@@ -42,6 +42,7 @@
 class DateEdit;
 class TimeEdit;
 class ButtonGroup;
+class RepetitionButton;
 class KAEvent;
 class Rule;
 class NoRule;
@@ -71,11 +72,14 @@
 		QWidget*      checkData(const QDateTime& startDateTime, QString& errorMessage) const;
 		RepeatType    repeatType() const                    { return mRuleButtonType; }
 		bool          isTimedRepeatType() const             { return mRuleButtonType >= SUBDAILY; }
+		int           subRepeatCount(int* subRepeatInterval = 0) const;
+		void          setSubRepetition(int reminderMinutes, bool dateOnly);
 		void          setStartDate(const QDate&, const QDate& today);
 		void          setDefaultEndDate(const QDate&);
 		void          setEndDateTime(const DateTime&);
 		DateTime      endDateTime() const;
 		bool          stateChanged() const;
+		void          activateSubRepetition();
 
 		static QString i18n_Norecur();           // text of 'No recurrence' selection, lower case
 		static QString i18n_NoRecur();           // text of 'No Recurrence' selection, initial capitals
@@ -99,6 +103,7 @@
 		void          shown();
 		void          typeChanged(int recurType);   // returns a RepeatType value
 		void          frequencyChanged();
+		void          repeatNeedsInitialisation();
 
 	protected:
 		virtual void  showEvent(QShowEvent*);
@@ -169,15 +174,18 @@
 
 		// Current start date and time
 		QDateTime         mCurrStartDateTime;
+		RepetitionButton* mSubRepetition;
 		bool              mNoEmitTypeChanged;        // suppress typeChanged() signal
 		bool              mReadOnly;
 
 		// Initial state of non-rule controls
 		QButton*          mSavedRuleButton;          // which rule button was selected
 		QButton*          mSavedRangeButton;         // which range button was selected
-		int               mSavedRepeatCount;         // repeat count
+		int               mSavedRecurCount;          // recurrence repeat count
 		DateTime          mSavedEndDateTime;         // end date/time
 		QValueList<QDate> mSavedExceptionDates;      // exception dates
+		int               mSavedRepeatInterval;      // sub-repetition interval (via mSubRepetition button)
+		int               mSavedRepeatCount;         // sub-repetition count (via mSubRepetition button)
 };
 
 #endif // RECURRENCEEDIT_H
Index: kalarm/alarmtimewidget.cpp
===================================================================
--- kalarm/alarmtimewidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/alarmtimewidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -101,7 +101,7 @@
 	// Date edit box
 	mDateEdit = new DateEdit(this);
 	mDateEdit->setFixedSize(mDateEdit->sizeHint());
-	connect(mDateEdit, SIGNAL(dateChanged(const QDate&)), SLOT(dateTimeChanged()));
+	connect(mDateEdit, SIGNAL(dateEntered(const QDate&)), SLOT(dateTimeChanged()));
 	static const QString enterDateText = i18n("Enter the date to schedule the alarm.");
 	QWhatsThis::add(mDateEdit, ((mode & DEFER_TIME) ? enterDateText
 	                            : QString("%1\n%2").arg(enterDateText).arg(recurText)));
Index: kalarm/mainwindow.h
===================================================================
--- kalarm/mainwindow.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  mainwindow.h  -  main application window
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -53,7 +53,6 @@
 
 		static void        refresh();
 		static void        updateExpired();
-		static void        updateTimeColumns(bool oldTime, bool oldTimeTo);
 		static void        addEvent(const KAEvent&, MainWindow*);
 		static void        executeNew(MainWindow* w = 0, KAEvent::Action a = KAEvent::MESSAGE, const AlarmText& t = AlarmText())
 		                                      { executeNew(w, 0, a, t); }
@@ -69,10 +68,8 @@
 		static int         count()            { return mWindowList.count(); }
 
 		static QString i18n_a_ShowAlarmTimes();     // text of 'Show Alarm Times' checkbox, with 'A' shortcut
-		static QString i18n_t_ShowAlarmTime();      // text of 'Show alarm time' checkbox, with 'T' shortcut
 		static QString i18n_m_ShowAlarmTime();      // text of 'Show alarm time' checkbox, with 'M' shortcut
 		static QString i18n_o_ShowTimeToAlarms();   // text of 'Show Time to Alarms' checkbox, with 'O' shortcut
-		static QString i18n_n_ShowTimeToAlarm();    // text of 'Show time until alarm' checkbox, with 'N' shortcut
 		static QString i18n_l_ShowTimeToAlarm();    // text of 'Show time until alarm' checkbox, with 'L' shortcut
 		static QString i18n_ShowExpiredAlarms();    // plain text of 'Show Expired Alarms' action
 		static QString i18n_e_ShowExpiredAlarms();  // text of 'Show Expired Alarms' checkbox, with 'E' shortcut
@@ -115,7 +112,8 @@
 		void           slotQuit();
 		void           slotDeletion();
 		void           slotSelection();
-		void           slotMouseClicked(int button, QListViewItem* item, const QPoint&, int);
+		void           slotContextMenuRequested(QListViewItem*, const QPoint&, int);
+		void           slotMouseClicked(int button, QListViewItem*, const QPoint&, int);
 		void           slotDoubleClicked(QListViewItem*);
 		void           slotShowTime();
 		void           slotShowTimeTo();
Index: kalarm/repetition.cpp
===================================================================
--- kalarm/repetition.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/repetition.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
- *  repetition.cpp  -  pushbutton and dialogue to specify alarm repetition
+ *  repetition.cpp  -  pushbutton and dialogue to specify alarm sub-repetition
  *  Program:  kalarm
- *  Copyright ¬© 2004,2005,2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2004,2005,2007,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -20,13 +20,11 @@
 
 #include "kalarm.h"
 
-#include <qlabel.h>
 #include <qlayout.h>
-#include <qtimer.h>
 #include <qwhatsthis.h>
 
+#include <kdebug.h>
 #include <kdialog.h>
-#include <kseparator.h>
 #include <klocale.h>
 
 #include "buttongroup.h"
@@ -39,7 +37,7 @@
 
 /*=============================================================================
 = Class RepetitionButton
-= Button to display the Simple Alarm Repetition dialogue.
+= Button to display the Alarm Sub-Repetition dialogue.
 =============================================================================*/
 
 RepetitionButton::RepetitionButton(const QString& caption, bool waitForInitialisation, QWidget* parent, const char* name)
@@ -84,7 +82,7 @@
 void RepetitionButton::activate(bool waitForInitialisation)
 {
 	if (!mDialog)
-		mDialog = new RepetitionDlg(i18n("Alarm Repetition"), mReadOnly, this);
+		mDialog = new RepetitionDlg(i18n("Alarm Sub-Repetition"), mReadOnly, this);
 	mDialog->set(mInterval, mCount, mDateOnly, mMaxDuration);
 	if (waitForInitialisation)
 		emit needsInitialisation();     // request dialog initialisation
@@ -98,7 +96,7 @@
 */
 void RepetitionButton::initialise(int interval, int count, bool dateOnly, int maxDuration)
 {
-	mInterval    = interval;
+	mInterval    = (maxDuration > 0 && interval > maxDuration) ? 1 : interval;
 	mCount       = count;
 	mMaxDuration = maxDuration;
 	mDateOnly    = dateOnly;
@@ -112,7 +110,7 @@
 }
 
 /******************************************************************************
-*  Display the simple alarm repetition dialog.
+*  Display the alarm sub-repetition dialog.
 *  Alarm repetition has the following restrictions:
 *  1) Not allowed for a repeat-at-login alarm
 *  2) For a date-only alarm, the repeat interval must be a whole number of days.
@@ -120,6 +118,8 @@
 */
 void RepetitionButton::displayDialog()
 {
+	kdDebug(5950) << "RepetitionButton::displayDialog()" << endl;
+	bool change = false;
 	if (mReadOnly)
 	{
 		mDialog->setReadOnly(true);
@@ -129,19 +129,19 @@
 	{
 		mCount    = mDialog->count();
 		mInterval = mDialog->interval();
-		emit changed();
+		change = true;
 	}
 	setOn(mInterval && mCount);
 	delete mDialog;
 	mDialog = 0;
+	if (change)
+		emit changed();   // delete dialog first, or initialise() will redisplay dialog
 }
 
 
 /*=============================================================================
 = Class RepetitionDlg
-= Simple alarm repetition dialogue.
-* Note that the displayed repetition count is one greater than the value set or
-* returned in the external methods.
+= Alarm sub-repetition dialogue.
 =============================================================================*/
 
 static const int MAX_COUNT = 9999;    // maximum range for count spinbox
@@ -158,45 +158,22 @@
 	setMainWidget(page);
 	QVBoxLayout* topLayout = new QVBoxLayout(page, 0, spacing);
 
-	QBoxLayout* layout = new QHBoxLayout(topLayout, 0);
-	int hintMargin = 2*marginHint();
-	layout->addSpacing(hintMargin);
-	QLabel* hintLabel = new QLabel(
-	     i18n("Use this dialog either:\n"
-	          "- instead of the Recurrence tab, or\n"
-	          "- after using the Recurrence tab, to set up a repetition within a repetition."),
-	     page);
-	hintLabel->setFrameStyle(QFrame::Panel | QFrame::Sunken);
-	hintLabel->setLineWidth(2);
-	hintLabel->setMargin(marginHint());
-	hintLabel->setAlignment(Qt::WordBreak);
-//	hintLabel->setTextFormat(Qt::RichText);
-	layout->addWidget(hintLabel);
-	layout->addSpacing(hintMargin);
-	topLayout->addSpacing(spacing);
-
-	// Group the other controls together so that the minimum width can be found easily
-	QWidget* controls = new QWidget(page);
-	topLayout->addWidget(controls);
-	topLayout = new QVBoxLayout(controls, 0, spacing);
-
 	mTimeSelector = new TimeSelector(i18n("Repeat every 10 minutes", "&Repeat every"), QString::null,
-	                  i18n("Check to repeat the alarm each time it recurs. "
-	                       "Instead of the alarm triggering once at each recurrence, "
-	                       "this option makes the alarm trigger multiple times at each recurrence."),
+	                  i18n("Instead of the alarm triggering just once at each recurrence, "
+	                       "checking this option makes the alarm trigger multiple times at each recurrence."),
 	                  i18n("Enter the time between repetitions of the alarm"),
-	                  true, controls);
+	                  true, page);
 	mTimeSelector->setFixedSize(mTimeSelector->sizeHint());
 	connect(mTimeSelector, SIGNAL(valueChanged(int)), SLOT(intervalChanged(int)));
 	connect(mTimeSelector, SIGNAL(toggled(bool)), SLOT(repetitionToggled(bool)));
 	topLayout->addWidget(mTimeSelector, 0, Qt::AlignAuto);
 
-	mButtonGroup = new ButtonGroup(controls, "buttonGroup");
+	mButtonGroup = new ButtonGroup(page, "buttonGroup");
 	connect(mButtonGroup, SIGNAL(buttonSet(int)), SLOT(typeClicked()));
 	topLayout->addWidget(mButtonGroup);
 
 	QBoxLayout* vlayout = new QVBoxLayout(mButtonGroup, marginHint(), spacing);
-	layout = new QHBoxLayout(vlayout, spacing);
+	QBoxLayout* layout = new QHBoxLayout(vlayout, spacing);
 	mCountButton = new RadioButton(i18n("&Number of repetitions:"), mButtonGroup);
 	mCountButton->setFixedSize(mCountButton->sizeHint());
 	QWhatsThis::add(mCountButton,
@@ -228,8 +205,6 @@
 	mDurationButton->setFocusWidget(mDuration);
 	layout->addStretch();
 
-	hintLabel->setMinimumWidth(controls->sizeHint().width() - 2*hintMargin);   // this enables a minimum size for the dialogue
-
 	mCountButton->setChecked(true);
 	repetitionToggled(false);
 	setReadOnly(mReadOnly);
@@ -258,12 +233,13 @@
 		mTimeSelector->setMaximum(maxhm, maxdw);
 		mDuration->setMaximum(maxhm, maxdw);
 	}
+	// Set the units - needed later if the control is unchecked initially.
+	TimePeriod::Units units = mDateOnly ? TimePeriod::DAYS : TimePeriod::HOURS_MINUTES;
+	mTimeSelector->setMinutes(interval, mDateOnly, units);
 	if (!mMaxDuration  ||  !count)
 		mTimeSelector->setChecked(false);
 	else
 	{
-		TimePeriod::Units units = mDateOnly ? TimePeriod::DAYS : TimePeriod::HOURS_MINUTES;
-		mTimeSelector->setMinutes(interval, mDateOnly, units);
 		bool on = mTimeSelector->isChecked();
 		repetitionToggled(on);    // enable/disable controls
 		if (on)
@@ -318,7 +294,7 @@
 */
 void RepetitionDlg::intervalChanged(int minutes)
 {
-	if (mTimeSelector->isChecked())
+	if (mTimeSelector->isChecked()  &&  minutes > 0)
 	{
 		mCount->setRange(1, (mMaxDuration >= 0 ? mMaxDuration / minutes : MAX_COUNT));
 		if (mCountButton->isOn())
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.cpp  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -107,7 +107,7 @@
 	else
 	{
 #ifdef Q_WS_X11
-		KWin::WindowInfo info = KWin::windowInfo(mInstance->winId(), NET::WMGeometry | NET::WMDesktop);
+		KWin::WindowInfo info = KWin::windowInfo(mInstance->winId(), static_cast<unsigned long>(NET::WMGeometry | NET::WMDesktop));
 		KWin::setCurrentDesktop(info.desktop());
 #endif
 		mInstance->showNormal();   // un-minimise it if necessary
@@ -387,6 +387,7 @@
 	mXtermType->hide();
 	QString whatsThis = i18n("The parameter is a command line, e.g. 'xterm -e'", "Check to execute command alarms in a terminal window by '%1'");
 	int index = 0;
+	mXtermFirst = -1;
 	for (mXtermCount = 0;  !xtermCommands[mXtermCount].isNull();  ++mXtermCount)
 	{
 		QString cmd = xtermCommands[mXtermCount];
@@ -396,6 +397,8 @@
 		QRadioButton* radio = new QRadioButton(args[0], group);
 		radio->setMinimumSize(radio->sizeHint());
 		mXtermType->insert(radio, mXtermCount);
+		if (mXtermFirst < 0)
+			mXtermFirst = mXtermCount;   // note the id of the first button
 		cmd.replace("%t", kapp->aboutData()->programName());
 		cmd.replace("%c", "<command>");
 		cmd.replace("%w", "<command; sleep>");
@@ -412,6 +415,8 @@
 	radio->setFixedSize(radio->sizeHint());
 	connect(radio, SIGNAL(toggled(bool)), SLOT(slotOtherTerminalToggled(bool)));
 	mXtermType->insert(radio, mXtermCount);
+	if (mXtermFirst < 0)
+		mXtermFirst = mXtermCount;   // note the id of the first button
 	mXtermCommand = new QLineEdit(box);
 	QWhatsThis::add(box,
 	      i18n("Enter the full command line needed to execute a command in your chosen terminal window. "
@@ -434,7 +439,7 @@
 	mStartOfDay->setValue(Preferences::mStartOfDay);
 	setExpiredControls(Preferences::mExpiredKeepDays);
 	QString xtermCmd = Preferences::cmdXTermCommand();
-	int id = 0;
+	int id = mXtermFirst;
 	if (!xtermCmd.isEmpty())
 	{
 		for ( ;  id < mXtermCount;  ++id)
@@ -457,7 +462,7 @@
 	{
 		QString cmd = mXtermCommand->text();
 		if (cmd.isEmpty())
-			xtermID = 0;       // 'Other' is only acceptable if it's non-blank
+			xtermID = -1;       // 'Other' is only acceptable if it's non-blank
 		else
 		{
 			QStringList args = KShell::splitArgs(cmd);
@@ -471,6 +476,12 @@
 			}
 		}
 	}
+	if (xtermID < 0)
+	{
+		xtermID = mXtermFirst;
+		mXtermType->setButton(mXtermFirst);
+	}
+
 	bool systray = mRunInSystemTray->isChecked();
 	Preferences::mRunInSystemTray        = systray;
 	Preferences::mDisableAlarmsIfStopped = mDisableAlarmsIfStopped->isChecked();
@@ -505,7 +516,7 @@
 	mConfirmAlarmDeletion->setChecked(Preferences::default_confirmAlarmDeletion);
 	mStartOfDay->setValue(Preferences::default_startOfDay);
 	setExpiredControls(Preferences::default_expiredKeepDays);
-	mXtermType->setButton(0);
+	mXtermType->setButton(mXtermFirst);
 	mXtermCommand->setEnabled(false);
 	slotDisableIfStoppedToggled(true);
 }
@@ -917,6 +928,7 @@
 	QLabel* label = new QLabel(i18n("Reminder &units:"), box);
 	label->setFixedSize(label->sizeHint());
 	mReminderUnits = new QComboBox(box, "defWarnUnits");
+	mReminderUnits->insertItem(TimePeriod::i18n_Minutes(), TimePeriod::MINUTES);
 	mReminderUnits->insertItem(TimePeriod::i18n_Hours_Mins(), TimePeriod::HOURS_MINUTES);
 	mReminderUnits->insertItem(TimePeriod::i18n_Days(), TimePeriod::DAYS);
 	mReminderUnits->insertItem(TimePeriod::i18n_Weeks(), TimePeriod::WEEKS);
@@ -1192,26 +1204,7 @@
 ViewPrefTab::ViewPrefTab(QVBox* frame)
 	: PrefsTabBase(frame)
 {
-	QGroupBox* group = new QGroupBox(i18n("Alarm List"), mPage);
-	QBoxLayout* layout = new QVBoxLayout(group, KDialog::marginHint(), KDialog::spacingHint());
-	layout->addSpacing(fontMetrics().lineSpacing()/2);
-
-	mListShowTime = new QCheckBox(MainWindow::i18n_t_ShowAlarmTime(), group, "listTime");
-	mListShowTime->setMinimumSize(mListShowTime->sizeHint());
-	connect(mListShowTime, SIGNAL(toggled(bool)), SLOT(slotListTimeToggled(bool)));
-	QWhatsThis::add(mListShowTime,
-	      i18n("Specify whether to show in the alarm list, the time at which each alarm is due"));
-	layout->addWidget(mListShowTime, 0, Qt::AlignAuto);
-
-	mListShowTimeTo = new QCheckBox(MainWindow::i18n_n_ShowTimeToAlarm(), group, "listTimeTo");
-	mListShowTimeTo->setMinimumSize(mListShowTimeTo->sizeHint());
-	connect(mListShowTimeTo, SIGNAL(toggled(bool)), SLOT(slotListTimeToToggled(bool)));
-	QWhatsThis::add(mListShowTimeTo,
-	      i18n("Specify whether to show in the alarm list, how long until each alarm is due"));
-	layout->addWidget(mListShowTimeTo, 0, Qt::AlignAuto);
-	group->setMaximumHeight(group->sizeHint().height());
-
-	group = new QGroupBox(i18n("System Tray Tooltip"), mPage);
+	QGroupBox* group = new QGroupBox(i18n("System Tray Tooltip"), mPage);
 	QGridLayout* grid = new QGridLayout(group, 5, 3, KDialog::marginHint(), KDialog::spacingHint());
 	grid->setColStretch(2, 1);
 	grid->addColSpacing(0, indentWidth());
@@ -1272,11 +1265,6 @@
 	           "- If unchecked, the window does not interfere with your typing when "
 	           "it is displayed, but it has no title bar and cannot be moved or resized."));
 
-	mShowExpiredAlarms = new QCheckBox(MainWindow::i18n_e_ShowExpiredAlarms(), mPage, "showExpired");
-	mShowExpiredAlarms->setMinimumSize(mShowExpiredAlarms->sizeHint());
-	QWhatsThis::add(mShowExpiredAlarms,
-	      i18n("Specify whether to show expired alarms in the alarm list"));
-
 	QHBox* itemBox = new QHBox(mPage);   // this is to control the QWhatsThis text display area
 	box = new QHBox(itemBox);
 	box->setSpacing(KDialog::spacingHint());
@@ -1296,21 +1284,16 @@
 
 void ViewPrefTab::restore()
 {
-	setList(Preferences::mShowAlarmTime,
-	        Preferences::mShowTimeToAlarm);
 	setTooltip(Preferences::mTooltipAlarmCount,
 	           Preferences::mShowTooltipAlarmTime,
 	           Preferences::mShowTooltipTimeToAlarm,
 	           Preferences::mTooltipTimeToPrefix);
 	mModalMessages->setChecked(Preferences::mModalMessages);
-	mShowExpiredAlarms->setChecked(Preferences::mShowExpiredAlarms);
 	mDaemonTrayCheckInterval->setValue(Preferences::mDaemonTrayCheckInterval);
 }
 
 void ViewPrefTab::apply(bool syncToDisc)
 {
-	Preferences::mShowAlarmTime           = mListShowTime->isChecked();
-	Preferences::mShowTimeToAlarm         = mListShowTimeTo->isChecked();
 	int n = mTooltipShowAlarms->isChecked() ? -1 : 0;
 	if (n  &&  mTooltipMaxAlarms->isChecked())
 		n = mTooltipMaxAlarmCount->value();
@@ -1319,41 +1302,20 @@
 	Preferences::mShowTooltipTimeToAlarm  = mTooltipShowTimeTo->isChecked();
 	Preferences::mTooltipTimeToPrefix     = mTooltipTimeToPrefix->text();
 	Preferences::mModalMessages           = mModalMessages->isChecked();
-	Preferences::mShowExpiredAlarms       = mShowExpiredAlarms->isChecked();
 	Preferences::mDaemonTrayCheckInterval = mDaemonTrayCheckInterval->value();
 	PrefsTabBase::apply(syncToDisc);
 }
 
 void ViewPrefTab::setDefaults()
 {
-	setList(Preferences::default_showAlarmTime,
-	        Preferences::default_showTimeToAlarm);
 	setTooltip(Preferences::default_tooltipAlarmCount,
 	           Preferences::default_showTooltipAlarmTime,
 	           Preferences::default_showTooltipTimeToAlarm,
 	           Preferences::default_tooltipTimeToPrefix);
 	mModalMessages->setChecked(Preferences::default_modalMessages);
-	mShowExpiredAlarms->setChecked(Preferences::default_showExpiredAlarms);
 	mDaemonTrayCheckInterval->setValue(Preferences::default_daemonTrayCheckInterval);
 }
 
-void ViewPrefTab::setList(bool time, bool timeTo)
-{
-	if (!timeTo)
-		time = true;    // ensure that at least one option is ticked
-
-	// Set the states of the two checkboxes without calling signal
-	// handlers, since these could change the checkboxes' states.
-	mListShowTime->blockSignals(true);
-	mListShowTimeTo->blockSignals(true);
-
-	mListShowTime->setChecked(time);
-	mListShowTimeTo->setChecked(timeTo);
-
-	mListShowTime->blockSignals(false);
-	mListShowTimeTo->blockSignals(false);
-}
-
 void ViewPrefTab::setTooltip(int maxAlarms, bool time, bool timeTo, const QString& prefix)
 {
 	if (!timeTo)
@@ -1381,18 +1343,6 @@
 	slotTooltipAlarmsToggled(maxAlarms);
 }
 
-void ViewPrefTab::slotListTimeToggled(bool on)
-{
-	if (!on  &&  !mListShowTimeTo->isChecked())
-		mListShowTimeTo->setChecked(true);
-}
-
-void ViewPrefTab::slotListTimeToToggled(bool on)
-{
-	if (!on  &&  !mListShowTime->isChecked())
-		mListShowTime->setChecked(true);
-}
-
 void ViewPrefTab::slotTooltipAlarmsToggled(bool on)
 {
 	mTooltipMaxAlarms->setEnabled(on);
Index: kalarm/lib/datetime.h
===================================================================
--- kalarm/lib/datetime.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/datetime.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -69,7 +69,7 @@
 		 *  Sets the value to a specified date-only value.
 		 */
 		DateTime& operator=(const QDate& d)
-		                               { mDateTime.setDate(d);  mDateOnly = true;  return *this; }
+		                               { mDateTime.setDate(d); mDateTime.setTime(QTime());  mDateOnly = true;  return *this; }
 		/** Returns true if the date is null and, if it is a date-time value, the time is also null. */
 		bool      isNull() const       { return mDateTime.date().isNull()  &&  (mDateOnly || mDateTime.time().isNull()); }
 		/** Returns true if the date is valid and, if it is a date-time value, the time is also valid. */
Index: kalarm/lib/timespinbox.cpp
===================================================================
--- kalarm/lib/timespinbox.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/timespinbox.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.cpp  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright ¬© 2001-2004,2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2004,2007,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -217,6 +217,15 @@
 }
 
 /******************************************************************************
+* Set the spin box's minimum value.
+*/
+void TimeSpinBox::setMinValue(int minutes)
+{
+        mMinimumValue = minutes;
+        SpinBox2::setMinValue(mMinimumValue - (mInvalid ? 1 : 0));
+}
+
+/******************************************************************************
  * Set the spin box's value.
  */
 void TimeSpinBox::setValue(int minutes)
Index: kalarm/lib/timeperiod.h
===================================================================
--- kalarm/lib/timeperiod.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/timeperiod.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  timeperiod.cpp  -  time period data entry widget
  *  Program:  kalarm
- *  Copyright (C) 2003, 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2003,2004,2007,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -34,13 +34,13 @@
  *  @short Time period entry widget.
  *
  *  The TimePeriod class provides a widget for entering a time period as a number of
- *  weeks, days, or hours and minutes.
+ *  weeks, days, hours and minutes, or minutes.
  *
- *  It displays a combo box to select the time units (weeks, days or hours and minutes)
- *  alongside a spin box to enter the number of units. The type of spin box displayed
- *  alters according to the units selection: day and week values are entered in a normal
- *  spin box, while hours and minutes are entered in a time spin box (with two pairs of
- *  spin buttons, one for hours and one for minutes).
+ *  It displays a combo box to select the time units (weeks, days, hours and minutes, or
+ *  minutes) alongside a spin box to enter the number of units. The type of spin box
+ *  displayed alters according to the units selection: day, week and minute values are
+ *  entered in a normal spin box, while hours and minutes are entered in a time spin box
+ *  (with two pairs of spin buttons, one for hours and one for minutes).
  *
  *  The widget may be set as read-only. This has the same effect as disabling it, except
  *  that its appearance is unchanged.
@@ -52,20 +52,22 @@
 		Q_OBJECT
 	public:
 		/** Units for the time period.
+		 *  @li MINUTES - the time period is entered as a number of minutes.
 		 *  @li HOURS_MINUTES - the time period is entered as an hours/minutes value.
 		 *  @li DAYS - the time period is entered as a number of days.
 		 *  @li WEEKS - the time period is entered as a number of weeks.
 		 */
-		enum Units { HOURS_MINUTES, DAYS, WEEKS };
+		enum Units { MINUTES, HOURS_MINUTES, DAYS, WEEKS };
 
 		/** Constructor.
-		 *  @param allowHourMinute Set false to prevent hours/minutes from being allowed
-		 *         as units; only days and weeks can ever be used, regardless of other
-		 *         method calls. Set true to allow hours/minutes, days or weeks as units.
+		 *  @param allowMinute Set false to prevent hours/minutes or minutes from
+		 *         being allowed as units; only days and weeks can ever be used,
+		 *         regardless of other method calls. Set true to allow minutes,
+		 *         hours/minutes, days or weeks as units.
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
-		TimePeriod(bool allowHourMinute, QWidget* parent, const char* name = 0);
+		TimePeriod(bool allowMinute, QWidget* parent, const char* name = 0);
 		/** Returns true if the widget is read only. */
 		bool          isReadOnly() const             { return mReadOnly; }
 		/** Sets whether the widget is read-only for the user. If read-only,
@@ -81,13 +83,15 @@
 		 *  @param defaultUnits The units to display initially in the combo box.
 		 */
 		void          setMinutes(int minutes, bool dateOnly, Units defaultUnits);
-		/** Enables or disables hours/minutes units in the combo box. To disable hours/minutes,
-		 *  set @p dateOnly true; to enable hours/minutes, set @p dateOnly false. But note that
+		/** Enables or disables minutes and hours/minutes units in the combo box. To
+		 *  disable minutes and hours/minutes, set @p dateOnly true; to enable minutes
+		 *  and hours/minutes, set @p dateOnly false. But note that minutes and
 		 *  hours/minutes cannot be enabled if it was disallowed in the constructor.
 		 */
 		void          setDateOnly(bool dateOnly)     { setDateOnly(minutes(), dateOnly, true); }
-		/** Sets the maximum values for the hours/minutes and days/weeks spin boxes.
-		 *  Set @p hourmin = 0 to leave the hours/minutes maximum unchanged.
+		/** Sets the maximum values for the minutes and hours/minutes, and days/weeks
+		 *  spin boxes.
+		 *  Set @p hourmin = 0 to leave the minutes and hours/minutes maximum unchanged.
 		 */
 		void          setMaximum(int hourmin, int days);
 		/** Sets whether the editor text is to be selected whenever spin buttons are
@@ -101,6 +105,8 @@
 		 */
 		void          setWhatsThis(const QString& units, const QString& dayWeek, const QString& hourMin = QString::null);
 
+		static QString i18n_minutes();     // text of 'minutes' units, lower case
+		static QString i18n_Minutes();     // text of 'Minutes' units, initial capitals
 		static QString i18n_hours_mins();  // text of 'hours/minutes' units, lower case
 		static QString i18n_Hours_Mins();  // text of 'Hours/Minutes' units, initial capitals
 		static QString i18n_days();        // text of 'days' units, lower case
@@ -126,11 +132,11 @@
 		void          adjustDayWeekShown();
 
 		QWidgetStack* mSpinStack;          // displays either the days/weeks or hours:minutes spinbox
-		SpinBox*      mSpinBox;            // the days/weeks value spinbox
+		SpinBox*      mSpinBox;            // the minutes/days/weeks value spinbox
 		TimeSpinBox*  mTimeSpinBox;        // the hours:minutes value spinbox
 		ComboBox*     mUnitsCombo;
 		int           mMaxDays;            // maximum day count
-		int           mDateOnlyOffset;     // for mUnitsCombo: 1 if hours/minutes is disabled, else 0
+		int           mDateOnlyOffset;     // for mUnitsCombo: 2 if minutes & hours/minutes are disabled, else 0
 		Units         mMaxUnitShown;       // for mUnitsCombo: maximum units shown
 		bool          mNoHourMinute;       // hours/minutes cannot be displayed, ever
 		bool          mReadOnly;           // the widget is read only
Index: kalarm/lib/dateedit.h
===================================================================
--- kalarm/lib/dateedit.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/dateedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  dateedit.h  -  date entry widget
  *  Program:  kalarm
- *  Copyright ¬© 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -74,11 +74,10 @@
 		virtual void mouseMoveEvent(QMouseEvent*);
 		virtual void keyPressEvent(QKeyEvent*);
 		virtual void keyReleaseEvent(QKeyEvent*);
-		/** Checks whether @p date lies within the allowed range of values.
-		 *  If so, sets the new value. If not, an error message is displayed.
-		 */
-		virtual bool assignDate(const QDate& date);
 
+	private slots:
+		void         newDateEntered(const QDate&);
+
 	private:
 		void         pastLimitMessage(const QDate& limit, const QString& error, const QString& defaultError);
 
Index: kalarm/lib/timeperiod.cpp
===================================================================
--- kalarm/lib/timeperiod.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/timeperiod.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  timeperiod.h  -  time period data entry widget
  *  Program:  kalarm
- *  Copyright (C) 2003, 2004 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2003,2004,2007,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -34,6 +34,8 @@
 
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
+QString TimePeriod::i18n_minutes()      { return i18n("minutes"); }
+QString TimePeriod::i18n_Minutes()      { return i18n("Minutes"); }
 QString TimePeriod::i18n_hours_mins()   { return i18n("hours/minutes"); }
 QString TimePeriod::i18n_Hours_Mins()   { return i18n("Hours/Minutes"); }
 QString TimePeriod::i18n_days()         { return i18n("days"); }
@@ -41,7 +43,7 @@
 QString TimePeriod::i18n_weeks()        { return i18n("weeks"); }
 QString TimePeriod::i18n_Weeks()        { return i18n("Weeks"); }
 
-static const int maxMinutes = 100*60-1;   // absolute maximum value for hours:minutes = 99H59M
+static const int maxMinutes = 1000*60-1;   // absolute maximum value for hours:minutes = 999H59M
 
 /*=============================================================================
 = Class TimePeriod
@@ -65,7 +67,7 @@
 	mSpinStack->addWidget(mSpinBox, 0);
 
 	mTimeSpinBox = new TimeSpinBox(0, 99999, mSpinStack);
-	mTimeSpinBox->setRange(1, maxMinutes);    // max 99H59M
+	mTimeSpinBox->setRange(1, maxMinutes);    // max 999H59M
 	connect(mTimeSpinBox, SIGNAL(valueChanged(int)), SLOT(slotTimeChanged(int)));
 	mSpinStack->addWidget(mTimeSpinBox, 1);
 
@@ -75,10 +77,11 @@
 
 	mUnitsCombo = new ComboBox(false, this);
 	if (mNoHourMinute)
-		mDateOnlyOffset = 1;
+		mDateOnlyOffset = 2;
 	else
 	{
 		mDateOnlyOffset = 0;
+		mUnitsCombo->insertItem(i18n_minutes());
 		mUnitsCombo->insertItem(i18n_hours_mins());
 	}
 	mUnitsCombo->insertItem(i18n_days());
@@ -147,22 +150,22 @@
  */
 int TimePeriod::minutes() const
 {
+	int factor = 0;
 	switch (mUnitsCombo->currentItem() + mDateOnlyOffset)
 	{
 		case HOURS_MINUTES:
 			return mTimeSpinBox->value();
-		case DAYS:
-			return mSpinBox->value() * 24*60;
-		case WEEKS:
-			return mSpinBox->value() * 7*24*60;
+		case MINUTES:  factor = 1;  break;
+		case DAYS:     factor = 24*60;  break;
+		case WEEKS:    factor = 7*24*60;  break;
 	}
-	return 0;
+	return mSpinBox->value() * factor;
 }
 
 /******************************************************************************
 *  Initialise the controls with a specified time period.
 *  The time unit combo-box is initialised to 'defaultUnits', but if 'dateOnly'
-*  is true, it will never be initialised to hours/minutes.
+*  is true, it will never be initialised to minutes or hours/minutes.
 */
 void TimePeriod::setMinutes(int mins, bool dateOnly, TimePeriod::Units defaultUnits)
 {
@@ -174,7 +177,7 @@
 	{
 		int count = mins;
 		if (mins % (24*60))
-			item = HOURS_MINUTES;
+			item = (defaultUnits == MINUTES && count <= mSpinBox->maxValue()) ? MINUTES : HOURS_MINUTES;
 		else if (mins % (7*24*60))
 		{
 			item = DAYS;
@@ -230,21 +233,25 @@
 		if (!dateOnly  &&  mDateOnlyOffset)
 		{
 			// Change from date-only to allow hours/minutes
-			mUnitsCombo->insertItem(i18n_hours_mins(), 0);
+			mUnitsCombo->insertItem(i18n_minutes(), 0);
+			mUnitsCombo->insertItem(i18n_hours_mins(), 1);
 			mDateOnlyOffset = 0;
 			adjustDayWeekShown();
-			mUnitsCombo->setCurrentItem(++index);
+			mUnitsCombo->setCurrentItem(index += 2);
 		}
 		else if (dateOnly  &&  !mDateOnlyOffset)
 		{
 			// Change from allowing hours/minutes to date-only
 			mUnitsCombo->removeItem(0);
-			mDateOnlyOffset = 1;
-			if (index)
-				--index;
+			mUnitsCombo->removeItem(0);
+			mDateOnlyOffset = 2;
+			if (index > 2)
+				index -= 2;
+			else
+				index = 0;
 			adjustDayWeekShown();
 			mUnitsCombo->setCurrentItem(index);
-			if (units == HOURS_MINUTES)
+			if (units == HOURS_MINUTES  ||  units == MINUTES)
 			{
 				// Set units to days and round up the warning period
 				units = DAYS;
@@ -305,6 +312,9 @@
 		case DAYS:
 			maxval = mMaxDays ? mMaxDays : 1;
 			break;
+		case MINUTES:
+			maxval = mTimeSpinBox->maxValue();
+			break;
 		case HOURS_MINUTES:
 		default:
 			return;
Index: kalarm/lib/timespinbox.h
===================================================================
--- kalarm/lib/timespinbox.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/timespinbox.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  timespinbox.h  -  time spinbox widget
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -76,7 +76,11 @@
 		/** Sets the maximum value which can be held in the spin box.
 		 *  @param minutes The maximum value expressed in minutes.
 		 */
-		void            setMaxValue(int minutes)     { SpinBox2::setMaxValue(minutes); }
+		virtual void    setMinValue(int minutes);
+		/** Sets the maximum value which can be held in the spin box.
+		 *  @param minutes The maximum value expressed in minutes.
+		 */
+		virtual void    setMaxValue(int minutes)     { SpinBox2::setMaxValue(minutes); }
 		/** Sets the maximum value which can be held in the spin box. */
 		void            setMaxValue(const QTime& t)  { SpinBox2::setMaxValue(t.hour()*60 + t.minute()); }
 		/** Returns the maximum value which can be held in the spin box. */
Index: kalarm/lib/dateedit.cpp
===================================================================
--- kalarm/lib/dateedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/lib/dateedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  dateedit.cpp  -  date entry widget
  *  Program:  kalarm
- *  Copyright (c) 2002 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,6 +28,7 @@
 DateEdit::DateEdit(QWidget* parent, const char* name)
 	: KDateEdit(parent, name)
 {
+	connect(this, SIGNAL(dateEntered(const QDate&)), SLOT(newDateEntered(const QDate&)));
 }
 
 void DateEdit::setMinDate(const QDate& d, const QString& errorDate)
@@ -52,7 +53,7 @@
 }
 
 // Check a new date against any minimum or maximum date.
-bool DateEdit::assignDate(const QDate& newDate)
+void DateEdit::newDateEntered(const QDate& newDate)
 {
 	if (newDate.isValid())
 	{
@@ -60,16 +61,13 @@
 		{
 			pastLimitMessage(mMinDate, mMinDateErrString,
 					 i18n("Date cannot be earlier than %1"));
-			return false;
 		}
-		if (mMaxDate.isValid()  &&  newDate > mMaxDate)
+		else if (mMaxDate.isValid()  &&  newDate > mMaxDate)
 		{
 			pastLimitMessage(mMaxDate, mMaxDateErrString,
 					 i18n("Date cannot be later than %1"));
-			return false;
 		}
 	}
-	return KDateEdit::assignDate(newDate);
 }
 
 void DateEdit::pastLimitMessage(const QDate& limit, const QString& error, const QString& defaultError)
Index: kalarm/kalarm.desktop
===================================================================
--- kalarm/kalarm.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,6 +31,7 @@
 GenericName[da]=Personlig skemal√¶gning af alarm
 GenericName[de]=Pers√∂nliche Termin-Erinnerung
 GenericName[el]=Œ†œÅŒøœÉœâœÄŒπŒ∫œåœÇ œÄœÅŒøŒ≥œÅŒ±ŒºŒºŒ±œÑŒπœÉœÑŒÆœÇ ŒµŒπŒ¥ŒøœÄŒøŒπŒÆœÉŒµœâŒΩ
+GenericName[eo]=Persona alarmplanilo
 GenericName[es]=Planificador de alarmas personales
 GenericName[et]=Meeldetuletuste ajastaja
 GenericName[eu]=Alarma pertsonalen programatzailea
Index: kalarm/birthdaydlg.h
===================================================================
--- kalarm/birthdaydlg.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/birthdaydlg.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  birthdaydlg.h  -  dialog to pick birthdays from address book
  *  Program:  kalarm
- *  Copyright (c) 2002-2004,2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2004,2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -29,7 +29,6 @@
 class QCheckBox;
 class KListView;
 class CheckBox;
-class ColourCombo;
 class FontColourButton;
 class SoundPicker;
 class SpecialActionsButton;
@@ -54,8 +53,6 @@
 	private slots:
 		void              slotSelectionChanged();
 		void              slotTextLostFocus();
-		void              slotFontColourSelected();
-		void              slotBgColourSelected(const QColor&);
 		void              updateSelectionList();
 
 	private:
@@ -68,11 +65,10 @@
 		Reminder*                mReminder;
 		SoundPicker*             mSoundPicker;
 		FontColourButton*        mFontColourButton;
-		ColourCombo*             mBgColourChoose;
 		CheckBox*                mConfirmAck;
 		LateCancelSelector*      mLateCancel;
 		SpecialActionsButton*    mSpecialActionsButton;
-		RepetitionButton*        mSimpleRepetition;
+		RepetitionButton*        mSubRepetition;
 		QString                  mPrefixText;   // last entered value of prefix text
 		QString                  mSuffixText;   // last entered value of suffix text
 		int                      mFlags;        // event flag bits
Index: kalarm/daemon.cpp
===================================================================
--- kalarm/daemon.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/daemon.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  daemon.cpp  -  interface with alarm daemon
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -60,7 +60,7 @@
 		// DCOP interface
 		void  alarmDaemonUpdate(int calendarStatus, const QString& calendarURL);
 		void  handleEvent(const QString& calendarURL, const QString& eventID);
-		void  registered(bool reregister, int result);
+		void  registered(bool reregister, int result, int version);
 };
 
 
@@ -173,10 +173,18 @@
 {
 	if (mRegisterTimer)
 		return true;
-	if (mStatus == STOPPED  ||  mStatus == RUNNING)
-		return false;
-	if (mStatus == REGISTERED  &&  !reregister)
-		return true;
+	switch (mStatus)
+	{
+		case STOPPED:
+		case RUNNING:
+			return false;
+		case REGISTERED:
+			if (!reregister)
+				return true;
+			break;
+		case READY:
+			break;
+	}
 
 	bool disabledIfStopped = theApp()->alarmsDisabledIfStopped();
 	kdDebug(5950) << (reregister ? "Daemon::reregisterWith(): " : "Daemon::registerWith(): ") << (disabledIfStopped ? "NO_START" : "COMMAND_LINE") << endl;
@@ -188,6 +196,7 @@
 		s.registerApp(appname, kapp->aboutData()->programName(), QCString(NOTIFY_DCOP_OBJECT), AlarmCalendar::activeCalendar()->urlString(), !disabledIfStopped);
 	if (!s.ok())
 	{
+		kdError(5950) << "Daemon::registerWith(" << reregister << "): DCOP error" << endl;
 		registrationResult(reregister, KAlarmd::FAILURE);
 		return false;
 	}
@@ -200,37 +209,64 @@
 /******************************************************************************
 * Called when the daemon has notified us of the result of the register() DCOP call.
 */
-void Daemon::registrationResult(bool reregister, int result)
+void Daemon::registrationResult(bool reregister, int result, int version)
 {
-	kdDebug(5950) << "Daemon::registrationResult(" << reregister << ")\n";
+	kdDebug(5950) << "Daemon::registrationResult(" << reregister << ") version: " << version << endl;
 	delete mRegisterTimer;
 	mRegisterTimer = 0;
-	switch (result)
+	bool failed = false;
+	QString errmsg;
+	if (version  &&  version != DAEMON_VERSION_NUM)
 	{
-		case KAlarmd::SUCCESS:
-			break;
-		case KAlarmd::NOT_FOUND:
-			kdError(5950) << "Daemon::registrationResult(" << reregister << "): registerApp dcop call: " << kapp->aboutData()->appName() << " not found\n";
-			KMessageBox::error(0, i18n("Alarms will be disabled if you stop KAlarm.\n"
-			                           "(Installation or configuration error: %1 cannot locate %2 executable.)")
-			                           .arg(QString::fromLatin1(DAEMON_APP_NAME))
-			                           .arg(kapp->aboutData()->appName()));
-			break;
-		case KAlarmd::FAILURE:
-		default:
-			kdError(5950) << "Daemon::registrationResult(" << reregister << "): registerApp dcop call failed -> " << result << endl;
-			if (!reregister)
-			{
-				if (mStatus == REGISTERED)
-					mStatus = READY;
-				if (!mRegisterFailMsg)
+		failed = true;
+		kdError(5950) << "Daemon::registrationResult(" << reregister << "): kalarmd reports incompatible version " << version << endl;
+		errmsg = i18n("Cannot enable alarms.\nInstallation or configuration error: Alarm Daemon (%1) version is incompatible.")
+		              .arg(QString::fromLatin1(DAEMON_APP_NAME));
+	}
+	else
+	{
+		switch (result)
+		{
+			case KAlarmd::SUCCESS:
+				break;
+			case KAlarmd::NOT_FOUND:
+				// We've successfully registered with the daemon, but the daemon can't
+				// find the KAlarm executable so won't be able to restart KAlarm if
+				// KAlarm exits.
+				kdError(5950) << "Daemon::registrationResult(" << reregister << "): registerApp dcop call: " << kapp->aboutData()->appName() << " not found\n";
+				KMessageBox::error(0, i18n("Alarms will be disabled if you stop KAlarm.\n"
+							   "(Installation or configuration error: %1 cannot locate %2 executable.)")
+							   .arg(QString::fromLatin1(DAEMON_APP_NAME))
+							   .arg(kapp->aboutData()->appName()));
+				break;
+			case KAlarmd::FAILURE:
+			default:
+				// Either the daemon reported an error in the registration DCOP call,
+				// there was a DCOP error calling the daemon, or a timeout on the reply.
+				kdError(5950) << "Daemon::registrationResult(" << reregister << "): registerApp dcop call failed -> " << result << endl;
+				failed = true;
+				if (!reregister)
 				{
-					mRegisterFailMsg = true;
-					KMessageBox::error(0, i18n("Cannot enable alarms:\nFailed to register with Alarm Daemon (%1)")
-					                           .arg(QString::fromLatin1(DAEMON_APP_NAME)));
+					errmsg = i18n("Cannot enable alarms:\nFailed to register with Alarm Daemon (%1)")
+					              .arg(QString::fromLatin1(DAEMON_APP_NAME));
 				}
+				break;
+		}
+	}
+
+	if (failed)
+	{
+		if (!errmsg.isEmpty())
+		{
+			if (mStatus == REGISTERED)
+				mStatus = READY;
+			if (!mRegisterFailMsg)
+			{
+				mRegisterFailMsg = true;
+				KMessageBox::error(0, errmsg);
 			}
-			return;
+		}
+		return;
 	}
 
 	if (!reregister)
@@ -384,6 +420,18 @@
 }
 
 /******************************************************************************
+* Notify the alarm daemon that the start-of-day time for date-only alarms has
+* changed.
+*/
+void Daemon::notifyTimeChanged()
+{
+	AlarmDaemonIface_stub s(DAEMON_APP_NAME, DAEMON_DCOP_OBJECT);
+	s.timeConfigChanged();
+	if (!s.ok())
+		kdError(5950) << "Daemon::timeConfigChanged(): dcop send failed" << endl;
+}
+
+/******************************************************************************
 * Read the alarm daemon's autostart-at-login setting.
 */
 bool Daemon::autoStart()
@@ -665,9 +713,9 @@
  * DCOP call from the alarm daemon to notify the success or failure of a
  * registration request from KAlarm.
  */
-void NotificationHandler::registered(bool reregister, int result)
+void NotificationHandler::registered(bool reregister, int result, int version)
 {
-	Daemon::registrationResult(reregister, result);
+	Daemon::registrationResult(reregister, result, version);
 }
 
 
Index: kalarm/recurrenceedit.cpp
===================================================================
--- kalarm/recurrenceedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/recurrenceedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  recurrenceedit.cpp  -  widget to edit the event's recurrence definition
  *  Program:  kalarm
- *  Copyright ¬© 2002-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2008 by David Jarvie <djarvie@kde.org>
  *
  *  Based originally on KOrganizer module koeditorrecurrence.cpp,
  *  Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
@@ -36,6 +36,7 @@
 
 #include <kglobal.h>
 #include <klocale.h>
+#include <kcalendarsystem.h>
 #include <kiconloader.h>
 #include <kdialog.h>
 #include <kmessagebox.h>
@@ -53,6 +54,7 @@
 #include "karecurrence.h"
 #include "preferences.h"
 #include "radiobutton.h"
+#include "repetition.h"
 #include "spinbox.h"
 #include "timeedit.h"
 #include "timespinbox.h"
@@ -62,8 +64,6 @@
 #include "recurrenceedit.moc"
 #include "recurrenceeditprivate.moc"
 
-static QString weekDayName(int day, const KLocale*);
-
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
 QString RecurrenceEdit::i18n_Norecur()           { return i18n("No recurrence"); }
@@ -246,7 +246,8 @@
 	mEndDateButton = new RadioButton(i18n("End &by:"), mRangeButtonGroup);
 	mEndDateButton->setReadOnly(mReadOnly);
 	QWhatsThis::add(mEndDateButton,
-	      i18n("Repeat the alarm until the date/time specified"));
+	      i18n("Repeat the alarm until the date/time specified.\n\n"
+	           "Note: This applies to the main recurrence only. It does not limit any sub-repetition which will occur regardless after the last main recurrence."));
 	mEndDateEdit = new DateEdit(mRangeButtonGroup);
 	mEndDateEdit->setFixedSize(mEndDateEdit->sizeHint());
 	mEndDateEdit->setReadOnly(mReadOnly);
@@ -334,6 +335,15 @@
 		layout->addWidget(mDeleteExceptionButton);
 	}
 
+	// Sub-repetition button
+	mSubRepetition = new RepetitionButton(i18n("Sub-Repetition"), true, this);
+	mSubRepetition->setFixedSize(mSubRepetition->sizeHint());
+	mSubRepetition->setReadOnly(mReadOnly);
+	connect(mSubRepetition, SIGNAL(needsInitialisation()), SIGNAL(repeatNeedsInitialisation()));
+	connect(mSubRepetition, SIGNAL(changed()), SIGNAL(frequencyChanged()));
+	QWhatsThis::add(mSubRepetition, i18n("Set up a repetition within the recurrence, to trigger the alarm multiple times each time the recurrence is due."));
+	topLayout->addWidget(mSubRepetition);
+
 	mNoEmitTypeChanged = false;
 }
 
@@ -433,6 +443,7 @@
 			mRepeatCountButton->setEnabled(!atLogin);
 		}
 		rangeTypeClicked();
+		mSubRepetition->setEnabled(!(none || atLogin));
 		if (!mNoEmitTypeChanged)
 			emit typeChanged(mRuleButtonType);
 	}
@@ -468,8 +479,57 @@
 		mRuleButtonGroup->selected()->setFocus();
 	emit shown();
 }
+ 
+ /******************************************************************************
+* Return the sub-repetition count within the recurrence, i.e. the number of
+* repetitions after the main recurrence.
+*/
+int RecurrenceEdit::subRepeatCount(int* subRepeatInterval) const
+{
+	int count = (mRuleButtonType >= SUBDAILY) ? mSubRepetition->count() : 0;
+	if (subRepeatInterval)
+		*subRepeatInterval = count ? mSubRepetition->interval() : 0;
+	return count;
+}
 
 /******************************************************************************
+*  Called when the Sub-Repetition button has been pressed to display the
+*  sub-repetition dialog.
+*  Alarm repetition has the following restrictions:
+*  1) Not allowed for a repeat-at-login alarm
+*  2) For a date-only alarm, the repeat interval must be a whole number of days.
+*  3) The overall repeat duration must be less than the recurrence interval.
+*/
+void RecurrenceEdit::setSubRepetition(int reminderMinutes, bool dateOnly)
+{
+	int maxDuration;
+	switch (mRuleButtonType)
+	{
+		case RecurrenceEdit::NO_RECUR:
+		case RecurrenceEdit::AT_LOGIN:   // alarm repeat not allowed
+			maxDuration = 0;
+			break;
+		default:          // repeat duration must be less than recurrence interval
+		{
+			KAEvent event;
+			updateEvent(event, false);
+			maxDuration = event.longestRecurrenceInterval() - reminderMinutes - 1;
+			break;
+		}
+	}
+	mSubRepetition->initialise(mSubRepetition->interval(), mSubRepetition->count(), dateOnly, maxDuration);
+	mSubRepetition->setEnabled(mRuleButtonType >= SUBDAILY && maxDuration);
+}
+
+/******************************************************************************
+* Activate the sub-repetition dialog.
+*/
+void RecurrenceEdit::activateSubRepetition()
+{
+	mSubRepetition->activate();
+}
+
+/******************************************************************************
  * Called when the value of the repeat count field changes, to reset the
  * minimum value to 1 if the value was 0.
  */
@@ -683,7 +743,6 @@
 		return;
 	}
 	mRuleButtonGroup->setButton(mNoneButtonId);
-	int repeatDuration;
 	KARecurrence* recurrence = event.recurrence();
 	if (!recurrence)
 		return;
@@ -770,21 +829,26 @@
 	}
 
 	mRule->setFrequency(recurrence->frequency());
-	repeatDuration = event.remainingRecurrences();
 
 	// Get range information
 	QDateTime endtime = mCurrStartDateTime;
-	if (repeatDuration == -1)
+	int duration = recurrence->duration();
+	if (duration == -1)
 		mNoEndDateButton->setChecked(true);
-	else if (repeatDuration)
+	else if (duration)
 	{
 		mRepeatCountButton->setChecked(true);
-		if (event.mainExpired())
+		int repeatCount;
+		if (event.expired())
+			repeatCount = duration;
+		else if (event.mainExpired())
 		{
 			mRepeatCountEntry->setMinValue(0);
-			repeatDuration = 0;
+			repeatCount = 0;
 		}
-		mRepeatCountEntry->setValue(repeatDuration);
+		else
+			repeatCount = duration - recurrence->durationTo(QDateTime::currentDateTime());
+		mRepeatCountEntry->setValue(repeatCount);
 	}
 	else
 	{
@@ -802,6 +866,9 @@
 		mExceptionDateList->insertItem(KGlobal::locale()->formatDate(*it));
 	enableExceptionButtons();
 
+	// Get repetition within recurrence
+	mSubRepetition->set(event.repeatInterval(), event.repeatCount());
+
 	rangeTypeClicked();
 
 	saveState();
@@ -899,8 +966,16 @@
 	if (adjustStart)
 		event.setFirstRecurrence();
 
+	// Set up repetition within the recurrence.
+	// N.B. This requires the main recurrence to be set up first.
+	int count = mSubRepetition->count();
+	if (mRuleButtonType < SUBDAILY)
+		count = 0;
+	event.setRepetition(mSubRepetition->interval(), count);
+
 	// Set up exceptions
 	event.recurrence()->setExDates(mExceptionDates);
+
 	event.setUpdated();
 }
 
@@ -914,10 +989,12 @@
 		mRule->saveState();
 	mSavedRangeButton = mRangeButtonGroup->selected();
 	if (mSavedRangeButton == mRepeatCountButton)
-		mSavedRepeatCount = mRepeatCountEntry->value();
+		mSavedRecurCount = mRepeatCountEntry->value();
 	else if (mSavedRangeButton == mEndDateButton)
 		mSavedEndDateTime.set(QDateTime(mEndDateEdit->date(), mEndTimeEdit->time()), mEndAnyTimeCheckBox->isChecked());
 	mSavedExceptionDates = mExceptionDates;
+	mSavedRepeatInterval = mSubRepetition->interval();
+	mSavedRepeatCount    = mSubRepetition->count();
 }
 
 /******************************************************************************
@@ -930,12 +1007,14 @@
 	||  mRule  &&  mRule->stateChanged())
 		return true;
 	if (mSavedRangeButton == mRepeatCountButton
-	&&  mSavedRepeatCount != mRepeatCountEntry->value())
+	&&  mSavedRecurCount  != mRepeatCountEntry->value())
 		return true;
 	if (mSavedRangeButton == mEndDateButton
 	&&  mSavedEndDateTime != DateTime(QDateTime(mEndDateEdit->date(), mEndTimeEdit->time()), mEndAnyTimeCheckBox->isChecked()))
 		return true;
-	if (mSavedExceptionDates != mExceptionDates)
+	if (mSavedExceptionDates != mExceptionDates
+	||  mSavedRepeatInterval != mSubRepetition->interval()
+	||  mSavedRepeatCount    != mSubRepetition->count())
 		return true;
 	return false;
 }
@@ -1052,11 +1131,11 @@
 	// Save the first day of the week, just in case it changes while the dialog is open.
 	QWidget* box = new QWidget(this);   // this is to control the QWhatsThis text display area
 	QGridLayout* dgrid = new QGridLayout(box, 4, 2, 0, KDialog::spacingHint());
-	const KLocale* locale = KGlobal::locale();
+	const KCalendarSystem* calendar = KGlobal::locale()->calendar();
 	for (int i = 0;  i < 7;  ++i)
 	{
 		int day = KAlarm::localeDayInWeek_to_weekDay(i);
-		mDayBox[i] = new CheckBox(weekDayName(day, locale), box);
+		mDayBox[i] = new CheckBox(calendar->weekDayName(day), box);
 		mDayBox[i]->setFixedSize(mDayBox[i]->sizeHint());
 		mDayBox[i]->setReadOnly(readOnly);
 		dgrid->addWidget(mDayBox[i], i%4, i/4, Qt::AlignAuto);
@@ -1246,11 +1325,11 @@
 	mPosButton->setFocusWidget(mWeekCombo);
 
 	mDayOfWeekCombo = new ComboBox(false, box);
-	const KLocale* locale = KGlobal::locale();
+	const KCalendarSystem* calendar = KGlobal::locale()->calendar();
 	for (int i = 0;  i < 7;  ++i)
 	{
 		int day = KAlarm::localeDayInWeek_to_weekDay(i);
-		mDayOfWeekCombo->insertItem(weekDayName(day, locale));
+		mDayOfWeekCombo->insertItem(calendar->weekDayName(day));
 	}
 	mDayOfWeekCombo->setReadOnly(readOnly);
 	QWhatsThis::add(mDayOfWeekCombo, i18n("Select the day of the week on which to repeat the alarm"));
@@ -1397,24 +1476,14 @@
 	QWidget* w = new QWidget(this);   // this is to control the QWhatsThis text display area
 	hlayout->addWidget(w, 1, Qt::AlignAuto);
 	QGridLayout* grid = new QGridLayout(w, 4, 3, 0, KDialog::spacingHint());
-	const KLocale* locale = KGlobal::locale();
-	mMonthBox[0] = new CheckBox(locale->translate("January"), w);
-	mMonthBox[1] = new CheckBox(locale->translate("February"), w);
-	mMonthBox[2] = new CheckBox(locale->translate("March"), w);
-	mMonthBox[3] = new CheckBox(locale->translate("April"), w);
-	mMonthBox[4] = new CheckBox(locale->translate("May"), w);
-	mMonthBox[5] = new CheckBox(locale->translate("June"), w);
-	mMonthBox[6] = new CheckBox(locale->translate("July"), w);
-	mMonthBox[7] = new CheckBox(locale->translate("August"), w);
-	mMonthBox[8] = new CheckBox(locale->translate("September"), w);
-	mMonthBox[9] = new CheckBox(locale->translate("October"), w);
-	mMonthBox[10] = new CheckBox(locale->translate("November"), w);
-	mMonthBox[11] = new CheckBox(locale->translate("December"), w);
+	const KCalendarSystem* calendar = KGlobal::locale()->calendar();
+	int year = QDate::currentDate().year();
 	for (int i = 0;  i < 12;  ++i)
 	{
+		mMonthBox[i] = new CheckBox(calendar->monthName(i + 1, year, true), w);
 		mMonthBox[i]->setFixedSize(mMonthBox[i]->sizeHint());
 		mMonthBox[i]->setReadOnly(readOnly);
-		grid->addWidget(mMonthBox[i], i%4, i/4, Qt::AlignAuto);
+		grid->addWidget(mMonthBox[i], i%3, i/3, Qt::AlignAuto);
 	}
 	connect(mMonthBox[1], SIGNAL(toggled(bool)), SLOT(enableFeb29()));
 	w->setFixedHeight(w->sizeHint().height());
@@ -1579,18 +1648,3 @@
 	    ||  mSavedMonths    != months()
 	    ||  mSavedFeb29Type != feb29Type());
 }
-
-QString weekDayName(int day, const KLocale* locale)
-{
-	switch (day)
-	{
-		case 1: return locale->translate("Monday");
-		case 2: return locale->translate("Tuesday");
-		case 3: return locale->translate("Wednesday");
-		case 4: return locale->translate("Thursday");
-		case 5: return locale->translate("Friday");
-		case 6: return locale->translate("Saturday");
-		case 7: return locale->translate("Sunday");
-	}
-	return QString();
-}
Index: kalarm/traywindow.cpp
===================================================================
--- kalarm/traywindow.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/traywindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -239,7 +239,7 @@
 		if (event.enabled()  &&  !event.expired()  &&  event.action() == KAEvent::MESSAGE)
 		{
 			TipItem item;
-			DateTime dateTime = event.nextDateTime(false);
+			DateTime dateTime = event.displayDateTime();
 			if (dateTime.date() > now.date())
 			{
 				// Ignore alarms after tomorrow at the current clock time
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/functions.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  functions.cpp  -  miscellaneous functions
  *  Program:  kalarm
- *  Copyright ¬© 2001-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -881,7 +881,7 @@
 		return QString::null;
 	KURL url = fileDlg.selectedURL();
 	defaultDir = url.path();
-	return url.prettyURL();
+	return (mode & KFile::LocalOnly) ? url.path() : url.prettyURL();
 }
 
 /******************************************************************************
@@ -953,9 +953,9 @@
 			break;
 		case KAEvent::EMAIL:
 		{
-			QString from = event.emailFromKMail().isEmpty()
-			             ? Preferences::emailAddress()
-			             : KAMail::identityManager()->identityForName(event.emailFromKMail()).fullEmailAddr();
+			QString from = event.emailFromId()
+			             ? KAMail::identityManager()->identityForUoid(event.emailFromId()).fullEmailAddr()
+			             : Preferences::emailAddress();
 			AlarmText atext;
 			atext.setEmail(event.emailAddresses(", "), from, QString::null, QString::null, event.emailSubject(), QString::null);
 			kcalEvent->setSummary(atext.displayText());
Index: kalarm/deferdlg.cpp
===================================================================
--- kalarm/deferdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/deferdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  deferdlg.cpp  -  dialogue to defer an alarm
  *  Program:  kalarm
- *  Copyright ¬© 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -93,12 +93,10 @@
 		switch (limitType)
 		{
 			case KAEvent::LIMIT_REPETITION:
-				text = i18n("This refers to simple repetitions set up using the Simple Repetition dialog",
-				            "Cannot defer past the alarm's next repetition (currently %1)");
+				text = i18n("Cannot defer past the alarm's next sub-repetition (currently %1)");
 				break;
 			case KAEvent::LIMIT_RECURRENCE:
-				text = i18n("This refers to recurrences set up using the Recurrence tab",
-				            "Cannot defer past the alarm's next recurrence (currently %1)");
+				text = i18n("Cannot defer past the alarm's next recurrence (currently %1)");
 				break;
 			case KAEvent::LIMIT_REMINDER:
 				text = i18n("Cannot defer past the alarm's next reminder (currently %1)");
Index: kalarm/kalarmapp.h
===================================================================
--- kalarm/kalarmapp.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/kalarmapp.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  kalarmapp.h  -  the KAlarm application object
  *  Program:  kalarm
- *  Copyright ¬© 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -83,8 +83,7 @@
 		                                 const QFont&, const QString& audioFile, float audioVolume,
 		                                 int reminderMinutes, const KARecurrence& recurrence,
 						 int repeatInterval, int repeatCount,
-		                                 const QString& mailFromID = QString::null,
-		                                 const EmailAddressList& mailAddresses = EmailAddressList(),
+		                                 uint mailFromID = 0, const EmailAddressList& mailAddresses = EmailAddressList(),
 		                                 const QString& mailSubject = QString::null,
 		                                 const QStringList& mailAttachments = QStringList());
 		bool               handleEvent(const QString& calendarFile, const QString& eventID)    { return handleEvent(calendarFile, eventID, EVENT_HANDLE); }
@@ -183,8 +182,6 @@
 		bool                  mRefreshExpiredAlarms; // need to refresh the expired alarms display
 		bool                  mSpeechEnabled;       // speech synthesis is enabled (kttsd exists)
 		bool                  mKOrganizerEnabled;   // KOrganizer options are enabled (korganizer exists)
-		bool                  mPrefsShowTime;       // Preferences setting for show alarm times in alarm list
-		bool                  mPrefsShowTimeTo;     // Preferences setting for show time-to-alarms in alarm list
 };
 
 inline KAlarmApp* theApp()  { return KAlarmApp::getInstance(); }
Index: kalarm/fontcolourbutton.cpp
===================================================================
--- kalarm/fontcolourbutton.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/fontcolourbutton.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  fontcolourbutton.cpp  -  pushbutton widget to select a font and colour
  *  Program:  kalarm
- *  Copyright (C) 2003 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2003-2005,2007 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,23 +28,67 @@
 #include <kdebug.h>
 
 #include "fontcolour.h"
+#include "pushbutton.h"
 #include "fontcolourbutton.moc"
 
 
 /*=============================================================================
 = Class FontColourButton
-= Font/colour selection buttong.
+= Font/colour selection button.
 =============================================================================*/
 
 FontColourButton::FontColourButton(QWidget* parent, const char* name)
-	: PushButton(i18n("Font && Co&lor..."), parent, name),
+	: QFrame(parent, name),
 	  mReadOnly(false)
 {
-	connect(this, SIGNAL(clicked()), SLOT(slotButtonPressed()));
-	QWhatsThis::add(this,
+	setFrameStyle(NoFrame);
+	QHBoxLayout* layout = new QHBoxLayout(this, 0, KDialog::spacingHint());
+
+	mButton = new PushButton(i18n("Font && Co&lor..."), this);
+	mButton->setFixedSize(mButton->sizeHint());
+	connect(mButton, SIGNAL(clicked()), SLOT(slotButtonPressed()));
+	QWhatsThis::add(mButton,
 	      i18n("Choose the font, and foreground and background color, for the alarm message."));
+	layout->addWidget(mButton);
+
+	// Font and colour sample display
+	mSample = new QLineEdit(this);
+	mSample->setMinimumHeight(QMAX(mSample->fontMetrics().lineSpacing(), mButton->height()*3/2));
+	mSample->setSizePolicy(QSizePolicy::Ignored, QSizePolicy::MinimumExpanding);
+	mSample->setText(i18n("The Quick Brown Fox Jumps Over The Lazy Dog"));
+	mSample->setCursorPosition(0);
+	mSample->setAlignment(Qt::AlignCenter);
+	QWhatsThis::add(mSample,
+	      i18n("This sample text illustrates the current font and color settings. "
+	           "You may edit it to test special characters."));
+	layout->addWidget(mSample);
 }
 
+void FontColourButton::setDefaultFont()
+{
+	mDefaultFont = true;
+	mSample->setFont(QFont());
+}
+
+void FontColourButton::setFont(const QFont& font)
+{
+	mDefaultFont = false;
+	mFont = font;
+	mSample->setFont(mFont);
+}
+
+void FontColourButton::setBgColour(const QColor& colour)
+{
+	mBgColour = colour;
+	mSample->setPaletteBackgroundColor(mBgColour);
+}
+
+void FontColourButton::setFgColour(const QColor& colour)
+{
+	mFgColour = colour;
+	mSample->setPaletteForegroundColor(mFgColour);
+}
+
 /******************************************************************************
 *  Called when the OK button is clicked.
 *  Display a font and colour selection dialog and get the selections.
@@ -58,8 +102,11 @@
 	{
 		mDefaultFont = dlg.defaultFont();
 		mFont        = dlg.font();
+		mSample->setFont(mFont);
 		mBgColour    = dlg.bgColour();
+		mSample->setPaletteBackgroundColor(mBgColour);
 		mFgColour    = dlg.fgColour();
+		mSample->setPaletteForegroundColor(mFgColour);
 		emit selected();
 	}
 }
Index: kalarm/dcophandler.h
===================================================================
--- kalarm/dcophandler.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/dcophandler.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  dcophandler.h  -  handler for DCOP calls by other applications
  *  Program:  kalarm
- *  Copyright ¬© 2001,2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2001,2002,2004-2006,2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -38,7 +38,7 @@
 	virtual bool scheduleMessage(const QString& message, const QString& startDateTime, int lateCancel, unsigned flags,
 	                             const QString& bgColor, const QString& fgColor, const QString& font,
 	                             const KURL& audioFile, int reminderMins, const QString& recurrence,
-	                             int repeatInterval, int repeatCount);
+	                             int subRepeatInterval, int subRepeatCount);
 	virtual bool scheduleMessage(const QString& message, const QString& startDateTime, int lateCancel, unsigned flags,
 	                             const QString& bgColor, const QString& fgColor, const QString& font,
 	                             const KURL& audioFile, int reminderMins, int recurType, int recurInterval, int recurCount);
@@ -47,13 +47,13 @@
 	                             const KURL& audioFile, int reminderMins, int recurType, int recurInterval, const QString& endDateTime);
 	virtual bool scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
 	                          const KURL& audioFile, int reminderMins, const QString& recurrence,
-	                          int repeatInterval, int repeatCount);
+	                          int subRepeatInterval, int subRepeatCount);
 	virtual bool scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
 	                          const KURL& audioFile, int reminderMins, int recurType, int recurInterval, int recurCount);
 	virtual bool scheduleFile(const KURL& file, const QString& startDateTime, int lateCancel, unsigned flags, const QString& bgColor,
 	                          const KURL& audioFile, int reminderMins, int recurType, int recurInterval, const QString& endDateTime);
 	virtual bool scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
-	                             const QString& recurrence, int repeatInterval, int repeatCount);
+	                             const QString& recurrence, int subRepeatInterval, int subRepeatCount);
 	virtual bool scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
 	                             int recurType, int recurInterval, int recurCount);
 	virtual bool scheduleCommand(const QString& commandLine, const QString& startDateTime, int lateCancel, unsigned flags,
@@ -74,19 +74,19 @@
 	static bool scheduleMessage(const QString& message, const DateTime& start, int lateCancel, unsigned flags,
                                 const QString& bgColor, const QString& fgColor, const QString& fontStr,
                                 const KURL& audioFile, int reminderMins, const KARecurrence&,
-	                            int repeatInterval = 0, int repeatCount = 0);
+	                            int subRepeatInterval = 0, int subRepeatCount = 0);
 	static bool scheduleFile(const KURL& file, const DateTime& start, int lateCancel, unsigned flags, const QString& bgColor,
                              const KURL& audioFile, int reminderMins, const KARecurrence&,
-	                         int repeatInterval = 0, int repeatCount = 0);
+	                         int subRepeatInterval = 0, int subRepeatCount = 0);
 	static bool scheduleCommand(const QString& commandLine, const DateTime& start, int lateCancel, unsigned flags,
-                                const KARecurrence&, int repeatInterval = 0, int repeatCount = 0);
+                                const KARecurrence&, int subRepeatInterval = 0, int subRepeatCount = 0);
 	static bool scheduleEmail(const QString& fromID, const QString& addresses, const QString& subject, const QString& message,
                               const QString& attachments, const DateTime& start, int lateCancel, unsigned flags,
-                              const KARecurrence&, int repeatInterval = 0, int repeatCount = 0);
+                              const KARecurrence&, int subRepeatInterval = 0, int subRepeatCount = 0);
 	static DateTime  convertStartDateTime(const QString& startDateTime);
 	static unsigned  convertStartFlags(const DateTime& start, unsigned flags);
 	static QColor    convertBgColour(const QString& bgColor);
-	static bool      convertRecurrence(DateTime& start, KARecurrence&, const QString& startDateTime, const QString& icalRecurrence);
+	static bool      convertRecurrence(DateTime& start, KARecurrence&, const QString& startDateTime, const QString& icalRecurrence, int& subRepeatInterval);
 	static bool      convertRecurrence(DateTime& start, KARecurrence&, const QString& startDateTime, int recurType, int recurInterval, int recurCount);
 	static bool      convertRecurrence(DateTime& start, KARecurrence&, const QString& startDateTime, int recurType, int recurInterval, const QString& endDateTime);
 	static bool      convertRecurrence(KARecurrence&, const DateTime& start, int recurType, int recurInterval, int recurCount, const QDateTime& end);
Index: kalarm/birthdaydlg.cpp
===================================================================
--- kalarm/birthdaydlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kalarm/birthdaydlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
  *  birthdaydlg.cpp  -  dialog to pick birthdays from address book
  *  Program:  kalarm
- *  Copyright ¬© 2002-2007 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright ¬© 2002-2008 by David Jarvie <djarvie@kde.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -128,19 +128,10 @@
 	QBoxLayout* groupLayout = new QVBoxLayout(group, marginHint(), spacingHint());
 	groupLayout->addSpacing(fontMetrics().lineSpacing()/2);
 
-	// Colour choice drop-down list
-	QBoxLayout* layout = new QHBoxLayout(groupLayout, 2*spacingHint());
-	QHBox* box;
-	mBgColourChoose = EditAlarmDlg::createBgColourChooser(&box, group);
-	connect(mBgColourChoose, SIGNAL(highlighted(const QColor&)), SLOT(slotBgColourSelected(const QColor&)));
-	layout->addWidget(box);
-	layout->addStretch();
-
-	// Font and colour choice drop-down list
+	// Font and colour choice button and sample text
 	mFontColourButton = new FontColourButton(group);
-	mFontColourButton->setFixedSize(mFontColourButton->sizeHint());
-	connect(mFontColourButton, SIGNAL(selected()), SLOT(slotFontColourSelected()));
-	layout->addWidget(mFontColourButton);
+	mFontColourButton->setMaximumHeight(mFontColourButton->sizeHint().height() * 3/2);
+	groupLayout->addWidget(mFontColourButton);
 
 	// Sound checkbox and file selector
 	mSoundPicker = new SoundPicker(group);
@@ -159,7 +150,7 @@
 	groupLayout->addWidget(mReminder, 0, Qt::AlignAuto);
 
 	// Acknowledgement confirmation required - default = no confirmation
-	layout = new QHBoxLayout(groupLayout, 2*spacingHint());
+	QHBoxLayout* layout = new QHBoxLayout(groupLayout, 2*spacingHint());
 	mConfirmAck = EditAlarmDlg::createConfirmAckCheckbox(group);
 	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
 	layout->addWidget(mConfirmAck);
@@ -181,17 +172,17 @@
 	layout->addWidget(mLateCancel);
 	layout->addStretch();
 
-	// Simple repetition button
-	mSimpleRepetition = new RepetitionButton(i18n("Simple Repetition"), false, group);
-	mSimpleRepetition->setFixedSize(mSimpleRepetition->sizeHint());
-	mSimpleRepetition->set(0, 0, true, 364*24*60);
-	QWhatsThis::add(mSimpleRepetition, i18n("Set up an additional alarm repetition"));
-	layout->addWidget(mSimpleRepetition);
+	// Sub-repetition button
+	mSubRepetition = new RepetitionButton(i18n("Sub-Repetition"), false, group);
+	mSubRepetition->setFixedSize(mSubRepetition->sizeHint());
+	mSubRepetition->set(0, 0, true, 364*24*60);
+	QWhatsThis::add(mSubRepetition, i18n("Set up an additional alarm repetition"));
+	layout->addWidget(mSubRepetition);
 
 	// Set the values to their defaults
 	mFontColourButton->setDefaultFont();
 	mFontColourButton->setBgColour(Preferences::defaultBgColour());
-	mBgColourChoose->setColour(Preferences::defaultBgColour());     // set colour before setting alarm type buttons
+	mFontColourButton->setFgColour(Preferences::defaultFgColour());     // set colour before setting alarm type buttons
 	mLateCancel->setMinutes(Preferences::defaultLateCancel(), true, TimePeriod::DAYS);
 	mConfirmAck->setChecked(Preferences::defaultConfirmAck());
 	mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
@@ -316,7 +307,7 @@
 					date.setYMD(thisYear + 1, date.month(), date.day());
 				KAEvent event(date,
 				              mPrefix->text() + aItem->text(AddresseeItem::NAME) + mSuffix->text(),
-				              mBgColourChoose->color(), mFontColourButton->fgColour(),
+				              mFontColourButton->bgColour(), mFontColourButton->fgColour(),
 				              mFontColourButton->font(), KAEvent::MESSAGE, mLateCancel->minutes(),
 				              mFlags);
 				float fadeVolume;
@@ -326,7 +317,7 @@
 				QValueList<int> months;
 				months.append(date.month());
 				event.setRecurAnnualByDate(1, months, 0, Preferences::defaultFeb29Type(), -1, QDate());
-				event.setRepetition(mSimpleRepetition->interval(), mSimpleRepetition->count());
+				event.setRepetition(mSubRepetition->interval(), mSubRepetition->count());
 				event.setNextOccurrence(todayNoon);
 				if (reminder)
 					event.setReminder(reminder, false);
@@ -394,25 +385,7 @@
 	}
 }
 
-/******************************************************************************
-*  Called when the a new background colour has been selected using the colour
-*  combo box.
-*/
-void BirthdayDlg::slotBgColourSelected(const QColor& colour)
-{
-	mFontColourButton->setBgColour(colour);
-}
 
-/******************************************************************************
-*  Called when the a new font and colour have been selected using the font &
-*  colour pushbutton.
-*/
-void BirthdayDlg::slotFontColourSelected()
-{
-	mBgColourChoose->setColour(mFontColourButton->bgColour());
-}
-
-
 /*=============================================================================
 = Class: AddresseeItem
 =============================================================================*/
Index: libemailfunctions/email.cpp
===================================================================
--- libemailfunctions/email.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libemailfunctions/email.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -74,6 +74,7 @@
       index++; // ignore the quoted character
       break;
     case ',' :
+    case ';' :
       if (!insidequote && (commentlevel == 0)) {
         addr = aStr.mid(addrstart, index-addrstart);
         if (!addr.isEmpty())
@@ -151,7 +152,8 @@
                  else
                    return KPIM::UnexpectedEnd;
                  break;
-      case ',' : if ( !inQuotedString ) {
+          case ',' :
+          case ';' : if ( !inQuotedString ) {
                    if ( allowMultipleAddresses )
                      stop = true;
                    else
@@ -343,7 +345,8 @@
             return UnexpectedEnd;
           }
           break;
-        case ',' :
+            case ',' :
+            case ';' :
           if ( !inQuotedString )
             return UnexpectedComma;
           break;
@@ -393,7 +396,8 @@
 
     case InAngleAddress : {
       switch ( aStr[index] ) {
-        case ',' :
+            case ',' :
+            case ';' :
           if ( !inQuotedString ) {
             return UnexpectedComma;
           }
Index: libkpimidentities/identity.h
===================================================================
--- libkpimidentities/identity.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkpimidentities/identity.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -227,6 +227,7 @@
 
   void setSignature( const Signature & sig ) { mSignature = sig; }
   Signature & signature() /* _not_ const! */ { return mSignature; }
+  const Signature & signature() const { return mSignature; }
 
 protected:
   /** @return true if the signature is read from the output of a command */
Index: kmailcvt/filter_kmail_maildir.cxx
===================================================================
--- kmailcvt/filter_kmail_maildir.cxx	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmailcvt/filter_kmail_maildir.cxx	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -131,7 +131,7 @@
 
             QByteArray input(MAX_LINE);
 
-            while ( ! mailfile.atEnd() ) {
+            while ( !mailfile.atEnd() && status_flag.isEmpty()) {
                 QCString seperate;
 
                 while ( ! mailfile.atEnd() && mailfile.readLine(input.data(),MAX_LINE) ) {
Index: kmailcvt/filter_evolution_v2.cxx
===================================================================
--- kmailcvt/filter_evolution_v2.cxx	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmailcvt/filter_evolution_v2.cxx	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -78,25 +78,14 @@
         QDir dir(mailDir);
         QStringList rootSubDirs = dir.entryList("[^\\.]*", QDir::Dirs, QDir::Name); // Removal of . and ..
         int currentDir = 1, numSubDirs = rootSubDirs.size();
-        for(QStringList::Iterator filename = rootSubDirs.begin() ; filename != rootSubDirs.end() ; ++filename, ++currentDir) {
+        for(QStringList::Iterator dirname = rootSubDirs.begin() ; dirname != rootSubDirs.end() ; ++dirname, ++currentDir) {
             if (info->shouldTerminate()) break;
-            importDirContents(info, dir.filePath(*filename), *filename, *filename);
+            importDirContents(info, false, dir.filePath(*dirname), *dirname, *dirname);
             info->setOverall((int) ((float) currentDir / numSubDirs * 100));
         }
 
         /** import last but not least all archives from the root-dir */
-        QDir importDir (mailDir);
-        QStringList files = importDir.entryList("[^\\.]*", QDir::Files, QDir::Name);
-        for ( QStringList::Iterator mailFile = files.begin(); mailFile != files.end(); ++mailFile) {
-            if (info->shouldTerminate()) break;
-            QString temp_mailfile = *mailFile;
-            if (temp_mailfile.endsWith(".cmeta") || temp_mailfile.endsWith(".ev-summary") ||
-                temp_mailfile.endsWith(".ibex.index") || temp_mailfile.endsWith(".ibex.index.data") ) {}
-            else {
-                info->addLog( i18n("Start import file %1...").arg( temp_mailfile ) );
-                importMBox(info, mailDir + temp_mailfile , temp_mailfile, QString::null);
-            }
-        }
+	importDirContents(info, true, mailDir, QString::null, QString::null);
 
         info->addLog( i18n("Finished importing emails from %1").arg( mailDir ));
         if(count_duplicates > 0) {
@@ -111,11 +100,13 @@
 /**
  * Import of a directory contents.
  * @param info Information storage for the operation.
+ * @param root if this is the rootdir or not
  * @param dirName The name of the directory to import.
  * @param KMailRootDir The directory's root directory in KMail's folder structure.
  * @param KMailSubDir The directory's direct ancestor in KMail's folder structure.
  */
-void FilterEvolution_v2::importDirContents(FilterInfo *info, const QString& dirName, const QString& KMailRootDir, const QString& KMailSubDir)
+void FilterEvolution_v2::importDirContents(FilterInfo *info, bool root, 
+					   const QString& dirName, const QString& KMailRootDir, const QString& KMailSubDir)
 {
     if (info->shouldTerminate()) return;
     
@@ -125,26 +116,32 @@
     QDir importDir (dirName);
     QStringList files = importDir.entryList("[^\\.]*", QDir::Files, QDir::Name);
     for ( QStringList::Iterator mailFile = files.begin(); mailFile != files.end(); ++mailFile) {
+        if (info->shouldTerminate()) break;
         QString temp_mailfile = *mailFile;
-        if (temp_mailfile.endsWith(".cmeta") || temp_mailfile.endsWith(".ev-summary") ||
+        if (temp_mailfile.endsWith(".cmeta") || temp_mailfile.endsWith(".ev-summary") || temp_mailfile.endsWith(".ev-summary-meta") ||
             temp_mailfile.endsWith(".ibex.index") || temp_mailfile.endsWith(".ibex.index.data") ) {}
         else {
             info->addLog( i18n("Start import file %1...").arg( temp_mailfile ) );
-            importMBox(info, (dirName + "/" + temp_mailfile) , KMailRootDir, KMailSubDir);
+	    if (!root)
+                 importMBox(info, (dirName + "/" + temp_mailfile) , KMailRootDir, KMailSubDir);
+            else 
+                 importMBox(info, dirName + temp_mailfile , temp_mailfile, QString::null);
         }
     }
 
-    /** If there are subfolders, we import them one by one */
-    QDir subfolders(dirName);
-    QStringList subDirs = subfolders.entryList("[^\\.]*", QDir::Dirs, QDir::Name);
-    for(QStringList::Iterator filename = subDirs.begin() ; filename != subDirs.end() ; ++filename) {
-        QString kSubDir;
-        if(!KMailSubDir.isNull()) {
-            kSubDir = KMailSubDir + "/" + *filename;
-        } else {
-            kSubDir = *filename;
+    if (!root) {
+        /** If there are subfolders, we import them one by one */
+        QDir subfolders(dirName);
+        QStringList subDirs = subfolders.entryList("[^\\.]*", QDir::Dirs, QDir::Name);
+        for(QStringList::Iterator filename = subDirs.begin() ; filename != subDirs.end() ; ++filename) {
+            QString kSubDir;
+            if(!KMailSubDir.isNull()) {
+                kSubDir = KMailSubDir + "/" + *filename;
+            } else {
+                kSubDir = *filename;
+            }
+            importDirContents(info, false, subfolders.filePath(*filename), KMailRootDir, kSubDir);
         }
-        importDirContents(info, subfolders.filePath(*filename), KMailRootDir, kSubDir);
     }
 }
 
Index: kmailcvt/filter_evolution_v2.hxx
===================================================================
--- kmailcvt/filter_evolution_v2.hxx	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmailcvt/filter_evolution_v2.hxx	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,7 +36,7 @@
 private:
     QString mailDir;
 
-    void importDirContents(FilterInfo*, const QString&, const QString&, const QString&);
+    void importDirContents(FilterInfo*, bool, const QString&, const QString&, const QString&);
     void importMBox(FilterInfo*, const QString&, const QString&, const QString&);
 };
 
Index: kmailcvt/filter_thebat.cxx
===================================================================
--- kmailcvt/filter_thebat.cxx	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kmailcvt/filter_thebat.cxx	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -165,6 +165,10 @@
                 return;
             }
             QString _tmp = input.data();
+
+	    if (tbb.atEnd())
+ 		break;
+
             iFound = _tmp.contains(regexp);
             if(!iFound) {
                 iFound = _tmp.findRev("!");
Index: kaddressbook/interfaces/core.h
===================================================================
--- kaddressbook/interfaces/core.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/interfaces/core.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -109,16 +109,30 @@
      */
     virtual void deleteContacts( const QStringList &uids ) = 0;
 
+    /**
+      Deletes given contacts from the address book.
+
+      @param uids The uids of the contacts, which shall be deleted.
+     */
+    virtual void deleteDistributionLists( const QStringList &uids ) = 0;
+
 #ifdef KDEPIM_NEW_DISTRLISTS
     /**
       Returns all the distribution lists.
      */
     virtual KPIM::DistributionList::List distributionLists() const = 0;
 
+
     /**
       Returns the name of all the distribution lists.
      */
     virtual QStringList distributionListNames() const = 0;
+
+    /**
+      sets the distribution list to display. If null, the regular
+      address book is to be displayed.  
+     */
+    virtual void setSelectedDistributionList( const QString &name ) = 0;
 #endif
 
     //// This class isn't part of interfaces/, so this method here isn't really useful
@@ -160,6 +174,11 @@
     virtual void newContact() = 0;
 
     /**
+      DCOP METHOD: Opens distribution list editor to input a new distribution list.
+     */
+    virtual void newDistributionList() = 0;
+
+    /**
       DCOP METHOD: Returns the name of the contact, that matches the given
                    phone number.
      */
@@ -170,6 +189,11 @@
      */
     virtual void editContact( const QString &uid = QString::null ) = 0;
 
+    /**
+      Shows an edit dialog for the given distribution list 
+    */
+    virtual void editDistributionList( const QString &name ) = 0;
+
   private:
     KXMLGUIClient *mGUIClient;
 };
Index: kaddressbook/kaddressbook_part.h
===================================================================
--- kaddressbook/kaddressbook_part.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbook_part.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -45,12 +45,15 @@
 
     static KAboutData *createAboutData();
 
+    virtual void saveToProfile( const QString& path ) const;
+    virtual void loadProfile( const QString& path );
   public slots:
     virtual void addEmail( QString addr );
     virtual void importVCard( const KURL& url );
     virtual void importVCardFromData( const QString& vCard );
     virtual ASYNC showContactEditor( QString uid );
     virtual void newContact();
+    virtual void newDistributionList();
     virtual QString getNameByPhone( QString phone );
     virtual void save();
     virtual void exit();
Index: kaddressbook/extensionmanager.cpp
===================================================================
--- kaddressbook/extensionmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/extensionmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,8 +27,12 @@
 #include <klocale.h>
 #include <ktrader.h>
 
+#include <qlayout.h>
+#include <qobjectlist.h>
 #include <qsignalmapper.h>
+#include <qsplitter.h>
 #include <qtimer.h>
+#include <qwidgetstack.h>
 
 #include "addresseeeditorextension.h"
 #include "core.h"
@@ -36,15 +40,26 @@
 
 #include "extensionmanager.h"
 
-ExtensionManager::ExtensionManager( KAB::Core *core, QWidget *parent,
+ExtensionData::ExtensionData() : action( 0 ), widget( 0 ), weight( 0 ), isDetailsExtension( false )
+{
+}
+
+ExtensionManager::ExtensionManager( QWidget* extensionBar, QWidgetStack* detailsStack, KAB::Core *core, QObject *parent,
                                     const char *name )
-  : QHBox( parent, name ), mCore( core ), mCurrentExtensionWidget( 0 ),
-    mMapper( 0 )
+    : QObject( parent, name ), mExtensionBar( extensionBar ), mCore( core ), 
+      mMapper( 0 ), mDetailsStack( detailsStack ), mActiveDetailsWidget( 0 )
 {
+  Q_ASSERT( mExtensionBar ); 
+  QVBoxLayout* layout = new QVBoxLayout( mExtensionBar );
+  mSplitter = new QSplitter( mExtensionBar );
+  mSplitter->setOrientation( QSplitter::Vertical );
+  layout->addWidget( mSplitter );
+
   createExtensionWidgets();
 
   mActionCollection = new KActionCollection( this, "ActionCollection" );
 
+  extensionBar->setShown( false );
   QTimer::singleShot( 0, this, SLOT( createActions() ) );
 }
 
@@ -52,35 +67,28 @@
 {
 }
 
-void ExtensionManager::restoreSettings()
+
+void ExtensionManager::restoreSettings() 
 {
-  for ( uint index = 0; index < mExtensionList.size(); ++index ) {
-    ExtensionData data = mExtensionList[ index ];
-    if ( data.identifier == KABPrefs::instance()->currentExtension() ) {
-      KToggleAction *action = static_cast<KToggleAction*>( mActionList.at( index ) );
+  const QStringList activeExtensions = KABPrefs::instance()->activeExtensions();
+
+  typedef QMap<QString, ExtensionData>::ConstIterator ConstIterator;
+  for ( ConstIterator it = mExtensionMap.begin(), end = mExtensionMap.end(); it != end; ++it ) {
+    if ( activeExtensions.contains( it.data().identifier ) ) {
+      KToggleAction *action = static_cast<KToggleAction*>( it.data().action );
       if ( action )
         action->setChecked( true );
-      setActiveExtension( index );
-      return;
+      setExtensionActive( it.data().identifier, true );
     }
   }
-
-  if ( mActionList.first() )
-    static_cast<KToggleAction*>( mActionList.first() )->setChecked( true );
-  setActiveExtension( 0 );
+  const QValueList<int> sizes = KABPrefs::instance()->extensionsSplitterSizes();
+  mSplitter->setSizes( sizes );
 }
 
 void ExtensionManager::saveSettings()
 {
-  KAction *action;
-  uint index = 0;
-  for ( action = mActionList.first(); action; action = mActionList.next(), index++ )
-    if ( static_cast<KToggleAction*>( action )->isChecked() )
-      break;
-
-  Q_ASSERT( index < mExtensionList.size() );
-
-  KABPrefs::instance()->setCurrentExtension( mExtensionList[ index ].identifier );
+  KABPrefs::instance()->setActiveExtensions( mActiveExtensions );
+  KABPrefs::instance()->setExtensionsSplitterSizes( mSplitter->sizes() );
 }
 
 void ExtensionManager::reconfigure()
@@ -89,43 +97,62 @@
   createExtensionWidgets();
   createActions();
   restoreSettings();
+  mExtensionBar->setShown( !mActiveExtensions.isEmpty() );
 }
 
 bool ExtensionManager::isQuickEditVisible() const
 {
-  return ( mCurrentExtensionWidget &&
-      mCurrentExtensionWidget->identifier() == "contact_editor" );
+  return mActiveExtensions.contains( "contact_editor" );
 }
 
 void ExtensionManager::setSelectionChanged()
 {
-  if ( mCurrentExtensionWidget )
-    mCurrentExtensionWidget->contactsSelectionChanged();
+  for ( QStringList::ConstIterator it = mActiveExtensions.begin(), end = mActiveExtensions.end(); it != end; ++it ) {
+    if ( mExtensionMap.contains( *it ) && mExtensionMap[*it].widget )
+      mExtensionMap[*it].widget->contactsSelectionChanged();
+  } 
 }
 
-void ExtensionManager::setActiveExtension( int id )
+void ExtensionManager::activationToggled( const QString &extid )
 {
-  if ( id == 0 ) {
-    hide();
-    if ( mCurrentExtensionWidget )
-      mCurrentExtensionWidget->hide();
-    mCurrentExtensionWidget = 0;
-  } else if ( id > 0 ) {
-    if ( mCurrentExtensionWidget )
-      mCurrentExtensionWidget->hide();
+  if ( !mExtensionMap.contains( extid ) )
+    return;
+  const ExtensionData data = mExtensionMap[ extid ];
+  const bool activated = data.action->isChecked();
+  setExtensionActive( extid, activated );
+}
 
-    mCurrentExtensionWidget = mExtensionList[ id ].widget;
-    if ( mCurrentExtensionWidget ) {
-      show();
-      mCurrentExtensionWidget->show();
-      mCurrentExtensionWidget->contactsSelectionChanged();
-    } else {
-      hide();
-      mCurrentExtensionWidget = 0;
+void ExtensionManager::setExtensionActive( const QString& extid, bool active )
+{
+  if ( !mExtensionMap.contains( extid ) )
+    return;
+  if ( mActiveExtensions.contains( extid ) == active )
+    return; 
+  const ExtensionData data = mExtensionMap[ extid ];
+  if ( active ) {
+    mActiveExtensions.append( extid );
+    if ( data.widget ) {
+      if ( data.isDetailsExtension ) {
+        mActiveDetailsWidget = data.widget;
+        emit detailsWidgetActivated( data.widget );
+      } else {
+          data.widget->show();
+      }
+      data.widget->contactsSelectionChanged();
     }
+  } else {
+    mActiveExtensions.remove( extid );
+    if ( data.widget && !data.isDetailsExtension ) {
+      data.widget->hide();
+    }
+    if ( data.isDetailsExtension ) {
+      mActiveDetailsWidget = 0;
+      emit detailsWidgetDeactivated( data.widget );
+    }
   }
+  mExtensionBar->setShown( !mActiveExtensions.isEmpty() );
 }
-
+ 
 void ExtensionManager::createActions()
 {
   mCore->guiClient()->unplugActionList( "extensions_list" );
@@ -135,52 +162,43 @@
 
   delete mMapper;
   mMapper = new QSignalMapper( this, "SignalMapper" );
-  connect( mMapper, SIGNAL( mapped( int ) ),
-           this, SLOT( setActiveExtension( int ) ) );
+  connect( mMapper, SIGNAL( mapped( const QString& ) ),
+           this, SLOT( activationToggled( const QString& ) ) );
 
-  int actionCounter = 0;
   ExtensionData::List::ConstIterator it;
-  for ( it = mExtensionList.begin(); it != mExtensionList.end(); ++it ) {
-    ExtensionData data = *it;
-    KToggleAction *action = new KToggleAction( data.title, 0, mMapper, SLOT( map() ),
+  for ( QMap<QString, ExtensionData>::Iterator it = mExtensionMap.begin(), end = mExtensionMap.end(); it != end; ++it ) {
+    ExtensionData& data = it.data();
+    data.action = new KToggleAction( data.title, 0, mMapper, SLOT( map() ),
                                                mActionCollection,
                                                QString( data.identifier + "_extension" ).latin1() );
-    action->setExclusiveGroup( "extensions" );
-    mMapper->setMapping( action, actionCounter++ );
-    mActionList.append( action );
+    mMapper->setMapping( data.action, data.identifier );
+    mActionList.append( data.action );
 
-    if ( data.widget == mCurrentExtensionWidget )
-      action->setChecked( true );
+    if ( mActiveExtensions.contains( data.identifier ) )
+      data.action->setChecked( true );
   }
 
   mCore->guiClient()->plugActionList( "extensions_list", mActionList );
+}
 
-  if ( mCurrentExtensionWidget == 0 && mActionList.first() )
-    static_cast<KToggleAction*>( mActionList.first() )->setChecked( true );
+QWidget* ExtensionManager::activeDetailsWidget() const
+{
+    return mActiveDetailsWidget;
 }
 
 void ExtensionManager::createExtensionWidgets()
 {
   // clean up
-  ExtensionData::List::ConstIterator dataIt;
-  for ( dataIt = mExtensionList.begin(); dataIt != mExtensionList.end(); ++dataIt )
-    delete (*dataIt).widget;
-  mExtensionList.clear();
+  for ( QMap<QString, ExtensionData>::ConstIterator it = mExtensionMap.begin(), end = mExtensionMap.end(); it != end; ++it ) {
+    delete it.data().widget;
+  }
+  mExtensionMap.clear();
 
   KAB::ExtensionWidget *wdg = 0;
 
   {
-    // add 'None' entry
-    ExtensionData data;
-    data.identifier = "none";
-    data.title = i18n( "None" );
-    data.widget = 0;
-    mExtensionList.append( data );
-  }
-
-  {
     // add addressee editor as default
-    wdg = new AddresseeEditorExtension( mCore, this );
+    wdg = new AddresseeEditorExtension( mCore, mDetailsStack );
     wdg->hide();
 
     connect( wdg, SIGNAL( modified( const KABC::Addressee::List& ) ),
@@ -192,7 +210,8 @@
     data.identifier = wdg->identifier();
     data.title = wdg->title();
     data.widget = wdg;
-    mExtensionList.append( data );
+    data.isDetailsExtension = true;
+    mExtensionMap.insert( data.identifier, data );
   }
 
   // load the other extensions
@@ -214,7 +233,7 @@
       continue;
     }
 
-    wdg = extensionFactory->extension( mCore, this );
+    wdg = extensionFactory->extension( mCore, mSplitter );
     if ( wdg ) {
       wdg->hide();
       connect( wdg, SIGNAL( modified( const KABC::Addressee::List& ) ),
@@ -226,11 +245,9 @@
       data.identifier = wdg->identifier();
       data.title = wdg->title();
       data.widget = wdg;
-      mExtensionList.append( data );
+      mExtensionMap.insert( data.identifier, data );
     }
   }
-
-  mCurrentExtensionWidget = 0;
 }
 
 #include "extensionmanager.moc"
Index: kaddressbook/kaddressbookmain.h
===================================================================
--- kaddressbook/kaddressbookmain.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbookmain.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,6 +56,7 @@
     virtual void importVCardFromData( const QString& vCard );
     virtual ASYNC showContactEditor( QString uid );
     virtual void newContact();
+    virtual void newDistributionList();
     virtual QString getNameByPhone( QString phone );
     virtual void save();
     virtual void exit();
@@ -79,6 +80,12 @@
 
     virtual bool queryClose();
 
+    //override
+    void loadProfile( const QString& path );
+
+    //override
+    void saveToProfile( const QString& path ) const;
+
   private slots:
     void configureKeyBindings();
     void configureToolbars();
Index: kaddressbook/kaddressbookui.rc
===================================================================
--- kaddressbook/kaddressbookui.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbookui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,10 +1,12 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="kaddressbook" version="16">
+<kpartgui name="kaddressbook" version="22">
 
   <MenuBar>
     <Menu name="file" noMerge="1"><text>&amp;File</text>
-      <Action name="file_new_contact"/>
-      <Action name="file_properties"/>
+      <Menu name="file_new_actions_menu"><text>New</text>
+        <Action name="file_new_contact"/>
+        <Action name="file_new_distributionlist"/>
+      </Menu>
       <Separator/>
       <Action name="file_sync"/>
       <Menu name="file_import"><text>&amp;Import</text>
@@ -27,10 +29,13 @@
       <Action name="edit_cut"/>
       <Action name="edit_copy"/>
       <Action name="edit_paste"/>
+      <Action name="copy_contact_to"/>
+      <Action name="move_contact_to"/>
       <Separator/>
       <Action name="edit_delete" append="edit_paste_merge"/>
-      <Action name="edit_store_in"/>
+      <Separator/>
       <Action name="edit_select_all"/>
+      <Separator/>
       <Action name="edit_merge"/>
       <Action name="edit_set_categories"/>
       <Action name="edit_set_personal"/>
@@ -51,7 +56,7 @@
 
     <Menu name="settings" noMerge="1"><text>&amp;Settings</text>
       <Merge name="StandardToolBarMenuHandler" />
-      <Menu name="show_extensions_menu"><text>Show Extension Bar</text>
+      <Menu name="show_extensions_menu"><text>Show Extension</text>
         <ActionList name="extensions_list"/>
       </Menu>
       <Action name="options_show_jump_bar"/>
@@ -73,8 +78,14 @@
   <Menu name="RMBPopup">
     <Action name="file_properties"/>
     <Action name="file_new_contact"/>
+    <Separator/>
+    <Action name="edit_cut"/>
+    <Action name="edit_copy"/>
+    <Action name="edit_paste"/>
+    <Action name="copy_contact_to"/>
+    <Action name="move_contact_to"/>
+    <Separator/>
     <Action name="edit_delete"/>
-    <Action name="edit_store_in"/>
     <Separator/>
     <Action name="file_mail"/>
     <Action name="file_mail_vcard"/>
@@ -83,6 +94,7 @@
 
   <ToolBar name="mainToolBar" noMerge="1"><text>Main Toolbar</text>
     <Action name="file_new_contact"/>
+    <Action name="file_new_distributionlist"/>
     <Action name="file_properties"/>
     <Separator/>
     <Action name="file_sync" />
@@ -100,7 +112,6 @@
     <Action name="edit_paste"/>
     <Separator/>
     <Action name="edit_delete"/>
-    <Action name="edit_store_in"/>
   </ToolBar>
 
 </kpartgui>
Index: kaddressbook/ldapsearchdialog.h
===================================================================
--- kaddressbook/ldapsearchdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/ldapsearchdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 /* ldapsearchdialogimpl.h - LDAP access
- *      Copyright (C) 2002 Klar‰lvdalens Datakonsult AB
+ *      Copyright (C) 2002 KlarÔøΩlvdalens Datakonsult AB
  *
  *      Author: Steffen Hansen <hansen@kde.org>
  *
@@ -21,12 +21,18 @@
 #ifndef LDAPSEARCHDIALOG_H
 #define LDAPSEARCHDIALOG_H
 
+#include "config.h"
+
 #include <qptrlist.h>
 
 #include <kabc/addressbook.h>
 #include <ldapclient.h>
 #include <kdialogbase.h>
 
+#ifdef KDEPIM_NEW_DISTRLISTS
+#include <libkdepim/distributionlist.h>
+#endif
+
 class KAddressBookTableView;
 class KComboBox;
 class KLineEdit;
@@ -35,7 +41,12 @@
 class QListView;
 class QPushButton;
 class KABCore;
+class ContactListItem;
 
+namespace KABC {
+    class Resource;
+}
+
 class LDAPSearchDialog : public KDialogBase
 {
   Q_OBJECT
@@ -60,8 +71,15 @@
     void slotError( const QString& );
     virtual void slotHelp();
     virtual void slotUser1();
+    virtual void slotUser2();
     void slotSelectAll();
     void slotUnselectAll();
+    /**
+     * Traverses the given items and adds them to the given resource,
+     * unless they already exist. Returns the list of both the added
+     * and the existing contacts.
+     */
+    KABC::Addressee::List importContactsUnlessTheyExist( const QValueList<ContactListItem*>& items, KABC::Resource * const resource );
 
   protected:
     QString selectedEMails() const;
@@ -70,6 +88,10 @@
 
   private:
     void saveSettings();
+    static KABC::Addressee convertLdapAttributesToAddressee( const KPIM::LdapAttrMap& attrs );
+#ifdef KDEPIM_NEW_DISTRLISTS
+    KPIM::DistributionList selectDistributionList();
+#endif
 
     QString makeFilter( const QString& query, const QString& attr, bool startsWith );
 
@@ -88,6 +110,8 @@
     QCheckBox* mRecursiveCheckbox;
     QListView* mResultListView;
     QPushButton* mSearchButton;
+    class Private;
+    Private* const d;
 };
 
 #endif
Index: kaddressbook/distributionlistentryview.h
===================================================================
--- kaddressbook/distributionlistentryview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlistentryview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,58 @@
+#ifndef KAB_DISTRIBUTIONLISTENTRYVIEW_H
+#define KAB_DISTRIBUTIONLISTENTRYVIEW_H
+
+#include <libkdepim/distributionlist.h>
+
+#include <qmap.h>
+#include <qstring.h>
+#include <qwidget.h>
+
+class QBoxLayout;
+class QButtonGroup;
+class QComboBox;
+class QGridLayout;
+class QLabel;
+
+class KURLLabel;
+
+class ImageButton;
+
+namespace KAB {
+
+class Core;
+
+class DistributionListEntryView : public QWidget
+{
+    Q_OBJECT
+
+public:
+    explicit DistributionListEntryView( KAB::Core* core, QWidget* parent = 0 );
+    void setEntry( const KPIM::DistributionList& list, const KPIM::DistributionList::Entry& entry );
+
+public slots:
+    void clear();
+
+signals:
+    void distributionListClicked( const QString& );
+
+private slots:
+    void emailButtonClicked( int id );
+
+private:
+    QMap<int, QString> m_idToEmail;
+    KAB::Core* m_core;
+    KPIM::DistributionList m_list;
+    KPIM::DistributionList::Entry m_entry;
+    QGridLayout* m_radioLayout;
+    QBoxLayout* m_mainLayout;
+    QButtonGroup* m_emailGroup;
+    QLabel* m_addresseeLabel;
+    KURLLabel* m_distListLabel;
+    QLabel* m_imageLabel;
+    QLabel* m_resourceLabel;
+    QMap<int, QString> m_indexToIdentifier; 
+};
+
+}
+
+#endif // KAB_DISTRIBUTIONLISTENTRYVIEW_H
Index: kaddressbook/kaddressbook_part.cpp
===================================================================
--- kaddressbook/kaddressbook_part.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbook_part.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -107,6 +107,12 @@
   mCore->newContact();
 }
 
+
+void KAddressbookPart::newDistributionList()
+{
+  mCore->newDistributionList();
+}
+
 QString KAddressbookPart::getNameByPhone( QString phone )
 {
   return mCore->getNameByPhone( phone );
@@ -162,4 +168,12 @@
   }
 }
 
+void KAddressbookPart::loadProfile( const QString& )
+{
+}
+
+void KAddressbookPart::saveToProfile( const QString& ) const
+{
+}
+
 #include "kaddressbook_part.moc"
Index: kaddressbook/kaddressbook.desktop
===================================================================
--- kaddressbook/kaddressbook.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbook.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,6 +58,7 @@
 GenericName[pt]=Livro de Endere√ßos
 GenericName[pt_BR]=Livro de Endere√ßos
 GenericName[ru]=–ê–¥—Ä–µ—Å–Ω–∞—è –∫–Ω–∏–≥–∞
+GenericName[se]=ƒåujuhusgieƒëahalli
 GenericName[sk]=Spr√°vca adries
 GenericName[sl]=Upravitelj naslovov
 GenericName[sr]=–ú–µ–Ω–∞—ü–µ—Ä –∞–¥—Ä–µ—Å–∞
Index: kaddressbook/distributionlisteditor_p.h
===================================================================
--- kaddressbook/distributionlisteditor_p.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlisteditor_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,78 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KPIM_DISTRIBUTIONLISTEDITOR_P_H
+#define KPIM_DISTRIBUTIONLISTEDITOR_P_H
+
+#include <libkdepim/addresseelineedit.h>
+#include <libkdepim/distributionlist.h>
+
+#include <qstring.h>
+
+namespace KABC {
+    class Addressee;
+    class AddressBook;
+}
+
+namespace KPIM {
+namespace DistributionListEditor {
+
+class LineEdit : public KPIM::AddresseeLineEdit
+{
+    Q_OBJECT
+public:
+    explicit LineEdit( QWidget* parent = 0 );
+};
+
+
+class Line : public QWidget
+{
+    Q_OBJECT
+public:
+    explicit Line( KABC::AddressBook* book, QWidget* parent = 0 );
+
+    void setEntry( const KPIM::DistributionList::Entry& entry );
+    KPIM::DistributionList::Entry entry() const; 
+
+signals:
+    void cleared();
+    void textChanged();
+
+private:
+    KABC::Addressee findAddressee( const QString& name, const QString& email ) const; 
+
+private slots:
+    void textChanged( const QString& );
+
+private:
+    QString m_uid;
+    QString m_initialText;
+    LineEdit* m_lineEdit;
+    KABC::AddressBook* m_addressBook;
+};
+
+} // namespace DisributionListEditor
+} // namespace KPIM
+
+#endif // KPIM_DISTRIBUTIONLISTEDITOR_P_H
+
+
Index: kaddressbook/views/cardview.cpp
===================================================================
--- kaddressbook/views/cardview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/views/cardview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1023,6 +1023,12 @@
 
   // The RMB click
   if ( e->button() & Qt::RightButton ) {
+    // clear previous selection
+    bool blocked = signalsBlocked();
+    blockSignals( true );
+    selectAll( false );
+    blockSignals( blocked );
+
     // select current item
     item->setSelected( true );
 
Index: kaddressbook/views/tableview.desktop
===================================================================
--- kaddressbook/views/tableview.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/views/tableview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,6 +14,7 @@
 Name[da]=Tabel-visning
 Name[de]=Tabellenansicht
 Name[el]=Œ†œÅŒøŒ≤ŒøŒªŒÆ œÄŒØŒΩŒ±Œ∫Œ±
+Name[eo]=Tabelrigardo
 Name[es]=Vista de tabla
 Name[et]=Tabelivaade
 Name[eu]=Taula ikupegia
Index: kaddressbook/views/cardview.desktop
===================================================================
--- kaddressbook/views/cardview.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/views/cardview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,6 +14,7 @@
 Name[da]=Kort-visning
 Name[de]=Visitenkarten-Betrachter
 Name[el]=Œ†œÅŒøŒ≤ŒøŒªŒÆ Œ∫Œ±œÅœÑœéŒΩ
+Name[eo]=Kartrigardo
 Name[es]=Vista de tarjeta
 Name[et]=Kaardivaade
 Name[eu]=Txartel ikuspegia
Index: kaddressbook/kaddressbook_part.rc
===================================================================
--- kaddressbook/kaddressbook_part.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbook_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,10 +1,12 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="kaddressbook" version="16">
+<kpartgui name="kaddressbook" version="22">
 
   <MenuBar>
     <Menu name="file" noMerge="1"><text>&amp;File</text>
-      <Action name="file_new_contact"/>
-      <Action name="file_properties"/>
+      <Menu name="file_new_actions_menu"><text>New</text>
+        <Action name="file_new_contact"/>
+        <Action name="file_new_distributionlist"/>
+      </Menu>
       <Separator/>
       <Action name="file_sync"/>
       <Menu name="file_import"><text>&amp;Import</text>
@@ -27,10 +29,13 @@
       <Action name="edit_cut"/>
       <Action name="edit_copy"/>
       <Action name="edit_paste"/>
+      <Action name="copy_contact_to"/>
+      <Action name="move_contact_to"/>
       <Separator/>
       <Action name="edit_delete" append="edit_paste_merge"/>
-      <Action name="edit_store_in"/>
+      <Separator/>
       <Action name="edit_select_all"/>
+      <Separator/>
       <Action name="edit_merge"/>
       <Action name="edit_set_categories"/>
       <Action name="edit_set_personal"/>
@@ -51,7 +56,7 @@
 
     <Menu name="settings" noMerge="1"><text>&amp;Settings</text>
       <Merge name="StandardToolBarMenuHandler" />
-      <Menu name="show_extensions_menu"><text>Show Extension Bar</text>
+      <Menu name="show_extensions_menu"><text>Show Extension</text>
         <ActionList name="extensions_list"/>
       </Menu>
       <Action name="options_show_jump_bar"/>
@@ -64,14 +69,19 @@
       <Separator/>
       <Action name="kaddressbook_configure" group="settings_configure"/>
     </Menu>
-
   </MenuBar>
 
   <Menu name="RMBPopup">
     <Action name="file_properties"/>
     <Action name="file_new_contact"/>
+    <Separator/>
+    <Action name="edit_cut"/>
+    <Action name="edit_copy"/>
+    <Action name="edit_paste"/>
+    <Action name="copy_contact_to"/>
+    <Action name="move_contact_to"/>
+    <Separator/>
     <Action name="edit_delete"/>
-    <Action name="edit_store_in"/>
     <Separator/>
     <Action name="file_mail"/>
     <Action name="file_mail_vcard"/>
@@ -80,6 +90,7 @@
 
   <ToolBar name="mainToolBar" noMerge="1"><text>Main Toolbar</text>
     <Action name="file_new_contact"/>
+    <Action name="file_new_distributionlist"/>
     <Action name="file_properties"/>
     <Separator/>
     <Action name="file_sync" />
@@ -97,7 +108,6 @@
     <Action name="edit_paste"/>
     <Separator/>
     <Action name="edit_delete"/>
-    <Action name="edit_store_in"/>
   </ToolBar>
 
 </kpartgui>
Index: kaddressbook/xxport/vcard_xxport.cpp
===================================================================
--- kaddressbook/xxport/vcard_xxport.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/xxport/vcard_xxport.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -205,10 +205,8 @@
         if ( file.open( IO_ReadOnly ) ) {
           QByteArray rawData = file.readAll();
           file.close();
-          if ( rawData.size() > 0 ) {
-            const QString data = QString::fromUtf8( rawData.data(), rawData.size() );
-            addrList += parseVCard( data );
-          }
+          if ( rawData.size() > 0 )
+            addrList += parseVCard( rawData );
 
           KIO::NetAccess::removeTempFile( fileName );
         } else {
Index: kaddressbook/editors/protocols/groupwiseprotocol.desktop
===================================================================
--- kaddressbook/editors/protocols/groupwiseprotocol.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/editors/protocols/groupwiseprotocol.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -9,6 +9,7 @@
 Comment[bg]=–ú–µ—Å–∏–Ω–¥–∂—ä—Ä Novell GroupWise
 Comment[cs]=Novell GroupWise komunik√°tor
 Comment[el]=GroupWise Messenger œÑŒ∑œÇ Novell
+Comment[eo]=Novell GroupWise Mesaƒùilo
 Comment[es]=Servidor de mensajer√≠a de Novell GroupWise
 Comment[et]=Novelli GroupWise Messenger
 Comment[eu]=Novell GroupWise mezularia
Index: kaddressbook/editors/cryptosettings.desktop
===================================================================
--- kaddressbook/editors/cryptosettings.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/editors/cryptosettings.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -29,7 +29,7 @@
 Name[km]=·ûÖ·üÜ·ûé·ûÑ·üã‚Äã·ûÖ·üÜ·ûé·ûº·ûõ‚Äã·ûÖ·û∑·ûè·üí·ûè Crypto
 Name[lt]=≈†ifravimo pasirinkimai
 Name[ms]=Keutamaan Kripto 
-Name[nb]=Krypterings instillinger
+Name[nb]=Krypteringsinnstillinger
 Name[nds]=Versl√∂teln-Instellen
 Name[ne]=‡§ó‡•Å‡§™‡•ç‡§§‡§ø‡§ï‡§∞‡§£ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ
 Name[nl]=Versleutelingsinstellingen
Index: kaddressbook/searchmanager.cpp
===================================================================
--- kaddressbook/searchmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/searchmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -68,6 +68,20 @@
     } else
       ++rmIt;
   }
+
+  typedef KPIM::DistributionList::Entry Entry;
+  if ( !mSelectedDistributionList.isNull() ) {
+    const KPIM::DistributionList dl = KPIM::DistributionList::findByName( mAddressBook, mSelectedDistributionList );
+    if ( !dl.isEmpty() ) {
+      allContacts.clear();
+      const Entry::List entries = dl.entries( mAddressBook );
+      const Entry::List::ConstIterator end = entries.end();
+      for ( Entry::List::ConstIterator it = entries.begin(); it != end; ++it ) {
+        allContacts.append( (*it).addressee ); 
+      }
+    }
+  }
+
 #endif
 
   if ( mPattern.isEmpty() ) { // no pattern, return all
@@ -155,6 +169,15 @@
 }
 
 #ifdef KDEPIM_NEW_DISTRLISTS
+
+void KAB::SearchManager::setSelectedDistributionList( const QString &name )
+{
+  if ( mSelectedDistributionList == name )
+    return;     
+  mSelectedDistributionList = name;
+  reload();
+}
+
 KPIM::DistributionList::List KAB::SearchManager::distributionLists() const
 {
   return mDistributionLists;
Index: kaddressbook/kabcore.cpp
===================================================================
--- kaddressbook/kabcore.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kabcore.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,8 +28,10 @@
 #include <qclipboard.h>
 #include <qdir.h>
 #include <qfile.h>
+#include <qlabel.h>
 #include <qlayout.h>
 #include <qptrlist.h>
+#include <qwidgetstack.h>
 #include <qregexp.h>
 #include <qvbox.h>
 
@@ -53,6 +55,7 @@
 #include <kmessagebox.h>
 #include <kprinter.h>
 #include <kprotocolinfo.h>
+#include <kpushbutton.h>
 #include <kresources/selectdialog.h>
 #include <kstandarddirs.h>
 #include <kstatusbar.h>
@@ -62,9 +65,11 @@
 #include <libkdepim/addresseeview.h>
 #include <libkdepim/categoryeditdialog.h>
 #include <libkdepim/categoryselectdialog.h>
+#include "distributionlisteditor.h"
 
 #include "addresseeutil.h"
 #include "addresseeeditordialog.h"
+#include "distributionlistentryview.h"
 #include "extensionmanager.h"
 #include "filterselectionwidget.h"
 #include "incsearchwidget.h"
@@ -111,6 +116,10 @@
   }
   mAddressBook->setErrorHandler( new KABC::GuiErrorHandler( mWidget ) );
 
+#if ! KDE_IS_VERSION(3,5,8)
+  mAddressBook->addCustomField( i18n( "Department" ), KABC::Field::Organization,
+                                "X-Department", "KADDRESSBOOK" );
+#endif
   mAddressBook->addCustomField( i18n( "Profession" ), KABC::Field::Organization,
                                 "X-Profession", "KADDRESSBOOK" );
   mAddressBook->addCustomField( i18n( "Assistant's Name" ), KABC::Field::Organization,
@@ -160,7 +169,7 @@
   connect( mXXPortManager, SIGNAL( modified() ),
            SLOT( setModified() ) );
 
-  connect( mDetails, SIGNAL( highlightedMessage( const QString& ) ),
+  connect( mDetailsViewer, SIGNAL( highlightedMessage( const QString& ) ),
            SLOT( detailsHighlighted( const QString& ) ) );
 
   connect( mIncSearchWidget, SIGNAL( scrollUp() ),
@@ -208,15 +217,8 @@
   updateIncSearchWidget();
   mIncSearchWidget->setCurrentItem( KABPrefs::instance()->currentIncSearchField() );
 
-  QValueList<int> splitterSize = KABPrefs::instance()->extensionsSplitter();
+  QValueList<int> splitterSize = KABPrefs::instance()->detailsSplitter();
   if ( splitterSize.count() == 0 ) {
-    splitterSize.append( mDetailsSplitter->height() / 2 );
-    splitterSize.append( mDetailsSplitter->height() / 2 );
-  }
-  mExtensionBarSplitter->setSizes( splitterSize );
-
-  splitterSize = KABPrefs::instance()->detailsSplitter();
-  if ( splitterSize.count() == 0 ) {
     splitterSize.append( 360 );
     splitterSize.append( 260 );
   }
@@ -228,8 +230,6 @@
 {
   KABPrefs::instance()->setJumpButtonBarVisible( mActionJumpBar->isChecked() );
   KABPrefs::instance()->setDetailsPageVisible( mActionDetails->isChecked() );
-
-  KABPrefs::instance()->setExtensionsSplitter( mExtensionBarSplitter->sizes() );
   KABPrefs::instance()->setDetailsSplitter( mDetailsSplitter->sizes() );
 
   mExtensionManager->saveSettings();
@@ -291,7 +291,7 @@
 KAboutData *KABCore::createAboutData()
 {
   KAboutData *about = new KAboutData( "kaddressbook", I18N_NOOP( "KAddressBook" ),
-                                      "3.5.7", I18N_NOOP( "The KDE Address Book" ),
+                                      "3.5.6", I18N_NOOP( "The KDE Address Book" ),
                                       KAboutData::License_GPL_V2,
                                       I18N_NOOP( "(c) 1997-2005, The KDE PIM Team" ) );
   about->addAuthor( "Tobias Koenig", I18N_NOOP( "Current maintainer" ), "tokoe@kde.org" );
@@ -324,9 +324,13 @@
 void KABCore::setContactSelected( const QString &uid )
 {
   KABC::Addressee addr = mAddressBook->findByUid( uid );
-  if ( !mDetails->isHidden() )
-    mDetails->setAddressee( addr );
-
+  if ( !mDetailsViewer->isHidden() )
+    mDetailsViewer->setAddressee( addr );
+#ifdef KDEPIM_NEW_DISTRLISTS 
+  if ( !mSelectedDistributionList.isNull() && mDistListEntryView->isShown() ) {
+      showDistributionListEntry( uid );
+  }
+#endif
   mExtensionManager->setSelectionChanged();
 
   // update the actions
@@ -343,7 +347,8 @@
   mActionCopy->setEnabled( selected );
   mActionDelete->setEnabled( selected );
   mActionEditAddressee->setEnabled( selected );
-  mActionStoreAddresseeIn->setEnabled( selected );
+  mActionCopyAddresseeTo->setEnabled( selected );
+  mActionMoveAddresseeTo->setEnabled( selected );
   mActionMail->setEnabled( selected );
   mActionMailVCard->setEnabled( selected );
   mActionChat->setEnabled( selected && mKIMProxy && mKIMProxy->initialize() );
@@ -398,6 +403,24 @@
   deleteContacts( uidList );
 }
 
+void KABCore::deleteDistributionLists( const QStringList & names )
+{
+  if ( names.isEmpty() )
+      return;
+  if ( KMessageBox::warningContinueCancelList( mWidget, i18n( "Do you really want to delete this distribution list?",
+                                                 "Do you really want to delete these %n distribution lists?", names.count() ),
+                                                 names, QString::null, KStdGuiItem::del() ) == KMessageBox::Cancel )
+   return;
+
+  QStringList uids;
+  for ( QStringList::ConstIterator it = names.begin(); it != names.end(); ++it ) {
+      uids.append( KPIM::DistributionList::findByName( mAddressBook, *it ).uid() ); 
+  }
+  DeleteCommand *command = new DeleteCommand( mAddressBook, uids );
+  mCommandHistory->addCommand( command );  
+  setModified( true );
+}
+
 void KABCore::deleteContacts( const QStringList &uids )
 {
   if ( uids.count() > 0 ) {
@@ -578,6 +601,26 @@
   setModified( true );
 }
 
+void KABCore::newDistributionList()
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+  QString name = i18n( "New Distribution List" );
+  const KPIM::DistributionList distList = KPIM::DistributionList::findByName( addressBook(), name );
+  if ( !distList.isEmpty() ) {
+    bool foundUnused = false;
+    int i = 1;
+    while ( !foundUnused ) {
+      name = i18n( "New Distribution List (%1)" ).arg( i++ );  
+      foundUnused = KPIM::DistributionList::findByName( addressBook(), name ).isEmpty();
+    }
+  }
+  KPIM::DistributionList list;
+  list.setUid( KApplication::randomString( 10 ) );
+  list.setName( name );
+  editDistributionList( list );
+#endif
+}
+
 void KABCore::newContact()
 {
   AddresseeEditorDialog *dialog = 0;
@@ -697,8 +740,19 @@
   }
 }
 
-void KABCore::storeContactIn( const QString &uid )
+
+void KABCore::copySelectedContactToResource()
 {
+    storeContactIn( QString(), true /*copy*/);
+}
+
+void KABCore::moveSelectedContactToResource()
+{
+    storeContactIn( QString(), false /*copy*/);
+}
+
+void KABCore::storeContactIn( const QString &uid, bool copy /*false*/ )
+{
   // First, locate the contact entry
   QStringList uidList;
   if ( uid.isNull() ) {
@@ -722,12 +776,17 @@
       newAddr.setUid( KApplication::randomString( 10 ) );
       newAddr.setResource( resource );
       addressBook()->insertAddressee( newAddr );
-      KABLock::self( mAddressBook )->lock( addr.resource() );
-      addressBook()->removeAddressee( addr );
-      KABLock::self( mAddressBook )->unlock( addr.resource() );
+      if ( !copy ) {
+          KABLock::self( mAddressBook )->lock( addr.resource() );
+          addressBook()->removeAddressee( addr );
+          KABLock::self( mAddressBook )->unlock( addr.resource() );
+      }
     }
   }
   KABLock::self( mAddressBook )->unlock( resource );
+
+  addressBookChanged();
+  setModified( true );
 }
 
 void KABCore::save()
@@ -997,6 +1056,20 @@
   return dialog;
 }
 
+void KABCore::activateDetailsWidget( QWidget *widget )
+{
+  if ( mDetailsStack->visibleWidget() == widget )
+    return;
+  mDetailsStack->raiseWidget( widget );
+}
+
+void KABCore::deactivateDetailsWidget( QWidget *widget )
+{
+  if ( mDetailsStack->visibleWidget() != widget )
+    return;
+  mDetailsStack->raiseWidget( mDetailsWidget );
+}
+
 void KABCore::slotEditorDestroyed( const QString &uid )
 {
   AddresseeEditorDialog *dialog = mEditorDict.take( uid );
@@ -1020,15 +1093,56 @@
   connect( mIncSearchWidget, SIGNAL( doSearch( const QString& ) ),
            SLOT( incrementalTextSearch( const QString& ) ) );
 
-  mFilterSelectionWidget = new FilterSelectionWidget( searchTB , "kde toolbar widget" );
-
   mDetailsSplitter = new QSplitter( mWidget );
   topLayout->addWidget( searchTB );
   topLayout->addWidget( mDetailsSplitter );
 
-  mExtensionBarSplitter = new QSplitter( mDetailsSplitter );
-  mExtensionBarSplitter->setOrientation( Qt::Vertical );
+  mDetailsStack = new QWidgetStack( mDetailsSplitter );
+  mExtensionManager = new ExtensionManager( new QWidget( mDetailsSplitter ), mDetailsStack, this, this );
+  connect( mExtensionManager, SIGNAL( detailsWidgetDeactivated( QWidget* ) ), 
+           this, SLOT( deactivateDetailsWidget( QWidget* ) ) );
+  connect( mExtensionManager, SIGNAL( detailsWidgetActivated( QWidget* ) ), 
+           this, SLOT( activateDetailsWidget( QWidget* ) ) );
 
+  
+  QWidget *viewWidget = new QWidget( mDetailsSplitter );
+  QVBoxLayout *viewLayout = new QVBoxLayout( viewWidget );
+  viewLayout->setSpacing( KDialog::spacingHint() );
+
+  mViewHeaderLabel = new QLabel( viewWidget );
+//  mViewHeaderLabel->setSizePolicy( QSizePolicy::Minimum, QSizePolicy::Fixed );
+  mViewHeaderLabel->setText( i18n( "Contacts" ) );
+  viewLayout->addWidget( mViewHeaderLabel );
+  mViewManager = new ViewManager( this, viewWidget );
+  viewLayout->addWidget( mViewManager, 1 );
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+  mDistListButtonWidget = new QWidget( viewWidget );
+  QHBoxLayout *buttonLayout = new QHBoxLayout( mDistListButtonWidget );
+  buttonLayout->setSpacing( KDialog::spacingHint() );
+  buttonLayout->addStretch( 1 );
+
+  KPushButton *addDistListButton = new KPushButton( mDistListButtonWidget );
+  addDistListButton->setText( i18n( "Add" ) );
+  connect( addDistListButton, SIGNAL( clicked() ), 
+           this, SLOT( editSelectedDistributionList() ) );
+  buttonLayout->addWidget( addDistListButton );
+  mDistListButtonWidget->setShown( false );
+  viewLayout->addWidget( mDistListButtonWidget );
+
+  KPushButton *removeDistListButton = new KPushButton( mDistListButtonWidget );
+  removeDistListButton->setText( i18n( "Remove" ) );
+  connect( removeDistListButton, SIGNAL( clicked() ), 
+           this, SLOT( removeSelectedContactsFromDistList() ) );
+  buttonLayout->addWidget( removeDistListButton );
+#endif
+
+  mFilterSelectionWidget = new FilterSelectionWidget( searchTB , "kde toolbar widget" );
+  mViewManager->setFilterSelectionWidget( mFilterSelectionWidget );
+
+  connect( mFilterSelectionWidget, SIGNAL( filterActivated( int ) ),
+           mViewManager, SLOT( setActiveFilter( int ) ) );
+
   mDetailsWidget = new QWidget( mDetailsSplitter );
   mDetailsLayout = new QHBoxLayout( mDetailsWidget );
 
@@ -1036,21 +1150,21 @@
   mDetailsLayout->addWidget( mDetailsPage );
 
   QHBoxLayout *detailsPageLayout = new QHBoxLayout( mDetailsPage, 0, 0 );
-  mDetails = new KPIM::AddresseeView( mDetailsPage );
-  mDetails->setVScrollBarMode( QScrollView::Auto );
-  detailsPageLayout->addWidget( mDetails );
+  mDetailsViewer = new KPIM::AddresseeView( mDetailsPage );
+  mDetailsViewer->setVScrollBarMode( QScrollView::Auto );
+  detailsPageLayout->addWidget( mDetailsViewer );
 
-  connect( mDetails, SIGNAL( addressClicked( const QString&) ),
+  mDistListEntryView = new KAB::DistributionListEntryView( this, mWidget );
+  connect( mDistListEntryView, SIGNAL( distributionListClicked( const QString& ) ),
+           this, SLOT( sendMailToDistributionList( const QString& ) ) );
+  mDetailsStack->addWidget( mDistListEntryView );
+  mDetailsStack->addWidget( mDetailsWidget );
+  mDetailsStack->raiseWidget( mDetailsWidget );
+  mDetailsSplitter->moveToLast( mDetailsStack );
+
+  connect( mDetailsViewer, SIGNAL( addressClicked( const QString&) ),
            this, SLOT( showContactsAddress( const QString& ) ) );
 
-  mViewManager = new ViewManager( this, mExtensionBarSplitter );
-  mViewManager->setFilterSelectionWidget( mFilterSelectionWidget );
-
-  connect( mFilterSelectionWidget, SIGNAL( filterActivated( int ) ),
-           mViewManager, SLOT( setActiveFilter( int ) ) );
-
-  mExtensionManager = new ExtensionManager( this, mExtensionBarSplitter );
-
   topLayout->setStretchFactor( mDetailsSplitter, 1 );
 
   mXXPortManager = new XXPortManager( this, mWidget );
@@ -1092,6 +1206,10 @@
                SLOT( newContact() ), actionCollection(), "file_new_contact" );
   action->setWhatsThis( i18n( "Create a new contact<p>You will be presented with a dialog where you can add all data about a person, including addresses and phone numbers." ) );
 
+  action = new KAction( i18n( "&New Distribution List..." ), "kontact_contacts", 0, this,
+               SLOT( newDistributionList() ), actionCollection(), "file_new_distributionlist" );
+  action->setWhatsThis( i18n( "Create a new distribution list<p>You will be presented with a dialog where you can create a new distribution list." ) );
+
   mActionMailVCard = new KAction( i18n("Send &Contact..."), "mail_post_to", 0,
                                   this, SLOT( mailVCard() ),
                                   actionCollection(), "file_mail_vcard" );
@@ -1129,11 +1247,17 @@
   mActionDelete->setWhatsThis( i18n( "Delete all selected contacts." ) );
 
 
-  mActionStoreAddresseeIn = new KAction( i18n( "St&ore Contact In..." ), "kaddressbook", 0,
-                                      this, SLOT( storeContactIn() ),
-                                      actionCollection(), "edit_store_in" );
-  mActionStoreAddresseeIn->setWhatsThis( i18n( "Store a contact in a different Addressbook<p>You will be presented with a dialog where you can select a new storage place for this contact." ) );
+  mActionCopyAddresseeTo = new KAction( i18n( "&Copy Contact To..." ), "", 0,
+                                      this, SLOT( copySelectedContactToResource() ),
+                                      actionCollection(), "copy_contact_to" );
+  const QString copyMoveWhatsThis = i18n( "Store a contact in a different Addressbook<p>You will be presented with a dialog where you can select a new storage place for this contact." );
+  mActionCopyAddresseeTo->setWhatsThis( copyMoveWhatsThis );
 
+  mActionMoveAddresseeTo = new KAction( i18n( "M&ove Contact To..." ), "", 0,
+                                      this, SLOT( moveSelectedContactToResource() ),
+                                      actionCollection(), "move_contact_to" );
+  mActionMoveAddresseeTo->setWhatsThis( copyMoveWhatsThis );
+
   // settings menu
   mActionJumpBar = new KToggleAction( i18n( "Show Jump Bar" ), "next", 0,
                                       actionCollection(), "options_show_jump_bar" );
@@ -1348,12 +1472,109 @@
   return doneSomething;
 }
 
+void KABCore::removeSelectedContactsFromDistList()
+{
 #ifdef KDEPIM_NEW_DISTRLISTS
+
+  KPIM::DistributionList dist = KPIM::DistributionList::findByName( addressBook(), mSelectedDistributionList );
+  if ( dist.isEmpty() )
+    return;
+  const QStringList uids = selectedUIDs();
+  if ( uids.isEmpty() )
+      return;
+  for ( QStringList::ConstIterator it = uids.begin(); it != uids.end(); ++it ) {
+      dist.removeEntry ( *it );
+  }
+  addressBook()->insertAddressee( dist );
+  setModified();
+#endif
+}
+
+void KABCore::sendMailToDistributionList( const QString &name )
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+  KPIM::DistributionList dist = KPIM::DistributionList::findByName( addressBook(), name );
+  if ( dist.isEmpty() )
+    return;
+  typedef KPIM::DistributionList::Entry::List EntryList; 
+  QStringList mails;
+  const EntryList entries = dist.entries( addressBook() );
+  for ( EntryList::ConstIterator it = entries.begin(); it != entries.end(); ++it )
+    mails += (*it).addressee.fullEmail( (*it).email );
+  sendMail( mails.join( ", " ) ); 
+#endif
+}
+
+void KABCore::editSelectedDistributionList()
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+  editDistributionList( KPIM::DistributionList::findByName( addressBook(), mSelectedDistributionList ) );
+#endif
+}
+
+
+void KABCore::editDistributionList( const QString &name )
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+  editDistributionList( KPIM::DistributionList::findByName( addressBook(), name ) );
+#endif
+}
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+
+void KABCore::showDistributionListEntry( const QString& uid )
+{
+  KPIM::DistributionList dist = KPIM::DistributionList::findByName( addressBook(), mSelectedDistributionList );
+  if ( !dist.isEmpty() ) {
+    mDistListEntryView->clear();
+    typedef KPIM::DistributionList::Entry::List EntryList;   
+    const EntryList entries = dist.entries( addressBook() ); 
+    for (EntryList::ConstIterator it = entries.begin(); it != entries.end(); ++it ) {
+      if ( (*it).addressee.uid() == uid ) {
+        mDistListEntryView->setEntry( dist, *it );
+        break;
+      }
+    }
+  }
+}
+
+void KABCore::editDistributionList( const KPIM::DistributionList &dist )
+{
+  if ( dist.isEmpty() )
+    return;
+  QGuardedPtr<KPIM::DistributionListEditor::EditorWidget> dlg = new KPIM::DistributionListEditor::EditorWidget( addressBook(), widget() );
+  dlg->setDistributionList( dist );
+  if ( dlg->exec() == QDialog::Accepted ) {
+    const KPIM::DistributionList newDist = dlg->distributionList();
+    if ( newDist != dist ) {
+      addressBook()->insertAddressee( newDist );
+      setModified();
+    }
+  }
+  delete dlg;
+}
+
+
 KPIM::DistributionList::List KABCore::distributionLists() const
 {
   return mSearchManager->distributionLists();
 }
 
+void KABCore::setSelectedDistributionList( const QString &name )
+{
+  mSelectedDistributionList = name;
+  mSearchManager->setSelectedDistributionList( name );
+  mViewHeaderLabel->setText( name.isNull() ? i18n( "Contacts" ) : i18n( "Distribution List: %1" ).arg( name ) );
+  mDistListButtonWidget->setShown( !mSelectedDistributionList.isNull() );
+  if ( !name.isNull() ) {
+    mDetailsStack->raiseWidget( mDistListEntryView );
+    const QStringList selectedUids = selectedUIDs();
+    showDistributionListEntry( selectedUids.isEmpty() ? QString() : selectedUids.first() );
+  }
+  else
+    mDetailsStack->raiseWidget( mExtensionManager->activeDetailsWidget() ? mExtensionManager->activeDetailsWidget() : mDetailsWidget );
+}
+
 QStringList KABCore::distributionListNames() const
 {
   return mSearchManager->distributionListNames();
Index: kaddressbook/kaddressbookiface.h
===================================================================
--- kaddressbook/kaddressbookiface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbookiface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,12 +41,18 @@
     virtual ASYNC showContactEditor( QString uid ) = 0;
 
     /**
-      Show's dialog for creation of a new contact.  Returns once a contact
+      Shows dialog for creation of a new contact.  Returns once a contact
       is created (or canceled).
      */
     virtual void newContact() = 0;
 
     /**
+      Shows dialog for creation of a new distribution list.  Returns once a distribution list
+      is created (or canceled).
+     */
+    virtual void newDistributionList() = 0;
+
+    /**
       Save changes to the address book files.
      */
     virtual QString getNameByPhone( QString phone ) = 0;
@@ -58,6 +64,9 @@
      * Return true if handled, false if command-line was empty.
      */
     virtual bool handleCommandLine() = 0;
+
+    virtual void loadProfile( const QString& path ) = 0;
+    virtual void saveToProfile( const QString& path ) const = 0;
 };
 
 #endif
Index: kaddressbook/addresseeeditorwidget.cpp
===================================================================
--- kaddressbook/addresseeeditorwidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/addresseeeditorwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,6 +53,7 @@
 #include <libkdepim/categoryeditdialog.h>
 #include <libkdepim/categoryselectdialog.h>
 #include <libkdepim/kdateedit.h>
+#include <libkdepim/resourceabc.h>
 
 #include "addresseditwidget.h"
 #include "advancedcustomfields.h"
@@ -90,11 +91,23 @@
 void AddresseeEditorWidget::setAddressee( const KABC::Addressee &addr )
 {
   if ( mAddressee.uid() == addr.uid() )
-	  return;
-
+    return;
   mAddressee = addr;
 
-  bool readOnly = ( !addr.resource() ? false : addr.resource()->readOnly() );
+  bool readOnly = false;
+  if ( KABC::Resource *res = addr.resource() ) {
+    if ( res->readOnly() ) {
+      readOnly = true;
+
+    //Kolab resources have finer access control than planned in the overall design.
+    } else if ( res->inherits( "KPIM::ResourceABC" ) ) {
+      KPIM::ResourceABC *resAbc = static_cast<KPIM::ResourceABC *>( res );
+
+      QString subresource = resAbc->uidToResourceMap()[ addr.uid() ];
+      if ( !subresource.isEmpty() )
+        readOnly |= !resAbc->subresourceWritable( subresource );
+    }
+  }
   setReadOnly( readOnly );
 
   load();
@@ -529,9 +542,11 @@
 
   mRoleEdit->setText( mAddressee.role() );
   mOrgEdit->setText( mAddressee.organization() );
+#if KDE_IS_VERSION(3,5,8)
   mDepartmentEdit->setText( mAddressee.department() );
   // compatibility with older versions
   if ( mAddressee.department().isEmpty() )
+#endif
     mDepartmentEdit->setText( mAddressee.custom( "KADDRESSBOOK", "X-Department" ) );
   mURLEdit->setURL( mAddressee.url() );
   mURLEdit->home( false );
@@ -575,7 +590,14 @@
 
   mAddressee.setRole( mRoleEdit->text() );
   mAddressee.setOrganization( mOrgEdit->text() );
+#if KDE_IS_VERSION(3,5,8)
   mAddressee.setDepartment( mDepartmentEdit->text() );
+#else
+  if ( !mDepartmentEdit->text().isEmpty() )
+    mAddressee.insertCustom( "KADDRESSBOOK", "X-Department", mDepartmentEdit->text() );
+  else
+    mAddressee.removeCustom( "KADDRESSBOOK", "X-Department" );
+#endif
 
   QString homepage = mURLEdit->text().stripWhiteSpace();
   if ( homepage.isEmpty() )
Index: kaddressbook/distributionlistpicker.h
===================================================================
--- kaddressbook/distributionlistpicker.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlistpicker.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,69 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KPIM_DISTRIBUTIONLISTPICKER_H
+#define KPIM_DISTRIBUTIONLISTPICKER_H
+
+#include <kdialogbase.h>
+
+#include <qstring.h>
+
+class KListBox;
+
+namespace KABC {
+    class AddressBook;
+}
+
+namespace KPIM {
+
+class DistributionListPickerDialog : public KDialogBase
+{
+    Q_OBJECT
+public:
+    explicit DistributionListPickerDialog( KABC::AddressBook* book, QWidget* parent = 0 );
+    QString selectedDistributionList() const;
+
+    void setLabelText( const QString& text );
+
+private slots:
+
+    //override
+    void slotOk();
+
+    //override
+    void slotCancel();
+
+    //override
+    void slotUser1();
+
+    void entrySelected( const QString& name );
+
+private:
+    KABC::AddressBook* m_book;
+    QLabel* m_label;
+    KListBox* m_listBox;
+    QString m_selectedDistributionList;
+};
+    
+} //namespace KPIM
+
+#endif // KPIM_DISTRIBUTIONLISTPICKER_H 
Index: kaddressbook/distributionlisteditor.cpp
===================================================================
--- kaddressbook/distributionlisteditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlisteditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,275 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "distributionlisteditor.h"
+#include "distributionlisteditor_p.h"
+
+#include <libkdepim/addresseelineedit.h>
+#include <libkdepim/distributionlist.h>
+#include <libemailfunctions/email.h>
+
+#include <kabc/addressbook.h>
+
+#include <kapplication.h>
+#include <kdialogbase.h>
+#include <kglobal.h> 
+#include <kiconloader.h>
+#include <klineedit.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qsignalmapper.h>
+#include <qtoolbutton.h>
+
+class KPIM::DistributionListEditor::EditorWidgetPrivate
+{
+public:
+    QScrollView* scrollView;
+    QSignalMapper* mapper;
+    KABC::AddressBook* addressBook;
+    QString distListUid;
+    QLabel* nameLabel;
+    QLabel* memberListLabel;
+    KLineEdit* nameLineEdit;
+    QWidget* memberListWidget;
+    QVBoxLayout* addresseeLayout;
+    QValueList<KPIM::DistributionListEditor::Line*> addressees;
+    KPIM::DistributionList distributionList;
+    void addLineForEntry( const KPIM::DistributionList::Entry& entry );
+    int lastLineId;
+};
+
+
+KPIM::DistributionListEditor::Line::Line( KABC::AddressBook* book, QWidget* parent ) : QWidget( parent ), m_addressBook( book )
+{
+    Q_ASSERT( m_addressBook );
+    QBoxLayout* layout = new QHBoxLayout( this );
+    layout->setSpacing( KDialog::spacingHint() );
+    m_lineEdit = new KPIM::DistributionListEditor::LineEdit( this );
+    connect( m_lineEdit, SIGNAL( textChanged( const QString& ) ),
+             this, SLOT( textChanged( const QString& ) ) );
+    layout->addWidget( m_lineEdit );
+    QToolButton *button = new QToolButton( this );
+    button->setIconSet( KApplication::reverseLayout() ? SmallIconSet("locationbar_erase") : SmallIconSet( "clear_left" ) );
+ 
+
+    layout->addWidget( button );
+    connect( button, SIGNAL( clicked() ), m_lineEdit, SLOT( clear() ) );
+}
+
+void KPIM::DistributionListEditor::Line::textChanged( const QString& text )
+{
+    if ( text.isEmpty() )
+        emit cleared();
+    emit textChanged();
+}
+
+void KPIM::DistributionListEditor::Line::setEntry( const KPIM::DistributionList::Entry& entry )
+{
+    m_uid = entry.addressee.uid();
+    m_initialText = entry.addressee.fullEmail( entry.email );
+    m_lineEdit->setText( m_initialText ); 
+}
+
+KABC::Addressee KPIM::DistributionListEditor::Line::findAddressee( const QString& name, const QString& email ) const
+{
+    if ( name.isEmpty() && email.isEmpty() )
+        return KABC::Addressee();
+
+    typedef KABC::Addressee::List List;
+    const List byEmail = m_addressBook->findByEmail( email );
+    if ( !byEmail.isEmpty() )
+    {        
+        const List::ConstIterator end = byEmail.end();
+        for ( List::ConstIterator it = byEmail.begin(); it != end; ++it )
+        {
+            if ( (*it).formattedName() == name )
+                return *it;
+        }
+        return byEmail.first();
+    }
+    // no entry found, create new addressee:
+    KABC::Addressee addressee;
+    addressee.setUid( KApplication::randomString( 10 ) );
+    addressee.setFormattedName( name );
+    addressee.setEmails( email );
+    m_addressBook->insertAddressee( addressee );
+    return addressee;
+}
+
+KPIM::DistributionList::Entry KPIM::DistributionListEditor::Line::entry() const
+{
+    const QString text = m_lineEdit->text();
+    QString name;
+    QString email;
+    KPIM::getNameAndMail(m_lineEdit->text(), name, email );
+
+    KPIM::DistributionList::Entry res;
+    if ( !m_uid.isNull() )
+    {
+        const KABC::Addressee addr = m_addressBook->findByUid( m_uid );
+        if ( m_initialText == text || addr.formattedName() == name )
+            res.addressee = addr;
+    }
+    if ( res.addressee.isEmpty() )
+        res.addressee = findAddressee( name, email ); 
+    res.email = res.addressee.preferredEmail() != email ? email : QString();
+    return res;
+}
+
+
+KPIM::DistributionListEditor::LineEdit::LineEdit( QWidget* parent ) : KPIM::AddresseeLineEdit( parent )
+{
+}
+
+
+KPIM::DistributionListEditor::EditorWidget::EditorWidget( KABC::AddressBook* book,  QWidget* parent ) 
+    : KDialogBase( parent, /*name=*/0, /*modal=*/ true, /*caption=*/QString(), KDialogBase::Ok|KDialogBase::Cancel ), d( new DistributionListEditor::EditorWidgetPrivate )
+{
+    d->addressBook = book;
+    Q_ASSERT( d->addressBook );
+    d->lastLineId = 0;
+    d->mapper = new QSignalMapper( this );
+    connect( d->mapper, SIGNAL( mapped( int ) ), 
+             this, SLOT( lineTextChanged( int ) ) ); 
+    setCaption( i18n( "Edit Distribution List" ) );
+    QWidget* main = new QWidget( this );
+    QGridLayout* mainLayout = new QGridLayout( main );
+    mainLayout->setMargin( KDialog::marginHint() );
+    mainLayout->setSpacing( KDialog::spacingHint() );
+
+    QHBoxLayout* nameLayout = new QHBoxLayout;
+    nameLayout->setSpacing( KDialog::spacingHint() );
+
+    d->nameLabel = new QLabel( main );
+    d->nameLabel->setText( i18n( "Name:" ) );
+    nameLayout->addWidget( d->nameLabel );
+
+    d->nameLineEdit = new KLineEdit( main );
+    nameLayout->addWidget( d->nameLineEdit );
+
+    mainLayout->addLayout( nameLayout, 0, 0 );
+
+    d->memberListLabel = new QLabel( main );
+    d->memberListLabel->setText( i18n( "Distribution list members:" ) );
+    mainLayout->addWidget( d->memberListLabel, 1, 0 );
+
+    d->scrollView = new QScrollView( main );
+    d->scrollView->setFrameShape( QFrame::NoFrame );
+    mainLayout->addWidget( d->scrollView, 2, 0 );
+    d->memberListWidget = new QWidget( d->scrollView->viewport() );
+    d->memberListWidget->setSizePolicy( QSizePolicy::MinimumExpanding, QSizePolicy::MinimumExpanding );
+    QVBoxLayout* memberLayout = new QVBoxLayout( d->memberListWidget );
+    d->addresseeLayout = new QVBoxLayout;
+    d->addresseeLayout->setSpacing( KDialog::spacingHint() );
+    memberLayout->addItem( d->addresseeLayout );
+    memberLayout->addStretch();
+    d->scrollView->addChild( d->memberListWidget );
+    d->scrollView->setResizePolicy( QScrollView::AutoOneFit );
+    
+    setMainWidget( main );
+
+    d->addLineForEntry( KPIM::DistributionList::Entry() );
+}
+
+KPIM::DistributionListEditor::EditorWidget::~EditorWidget()
+{
+    delete d;
+}
+
+void KPIM::DistributionListEditor::EditorWidget::lineTextChanged( int id )
+{
+    if ( id != d->lastLineId )
+        return;
+    d->addLineForEntry( KPIM::DistributionList::Entry() );
+    d->scrollView->updateContents();
+}
+
+void KPIM::DistributionListEditor::EditorWidget::setDistributionList( const KPIM::DistributionList& list )
+{
+    d->distListUid = list.uid();
+    d->nameLineEdit->setText( list.name() );
+
+    using KPIM::DistributionListEditor::Line;
+    typedef QValueList<Line*>::ConstIterator ListIterator;
+    for ( ListIterator it = d->addressees.begin(), end = d->addressees.end(); it != end; ++it )
+    {
+        delete *it;
+    }
+    d->addressees.clear();
+
+    typedef KPIM::DistributionList::Entry Entry;
+    const Entry::List entries = list.entries( d->addressBook );
+
+    for ( Entry::List::ConstIterator it = entries.begin(), end = entries.end(); it != end; ++it )
+    {
+        d->addLineForEntry( *it );
+    }
+    d->addLineForEntry( Entry() );
+}
+
+void KPIM::DistributionListEditor::EditorWidgetPrivate::addLineForEntry( const KPIM::DistributionList::Entry& entry )
+{  
+    KPIM::DistributionListEditor::Line* line = new KPIM::DistributionListEditor::Line( addressBook, memberListWidget );
+    line->setEntry( entry );
+    addresseeLayout->addWidget( line );
+    addressees.append( line );
+    QObject::connect( line, SIGNAL( textChanged() ), 
+                      mapper, SLOT( map() ) );
+    mapper->setMapping( line, ++lastLineId );
+    line->setShown( true );
+}
+
+void KPIM::DistributionListEditor::EditorWidget::slotOk()
+{
+    const QString name = d->nameLineEdit->text();
+    const KPIM::DistributionList existing = KPIM::DistributionList::findByName( d->addressBook, name );
+    if ( !existing.isEmpty() && existing.uid() != d->distListUid )
+    {
+        KMessageBox::error( this, i18n( "A distribution list with the name %1 already exists. Please choose another name." ).arg( name ), i18n( "Name in Use" ) ); 
+        return;
+    }
+
+    KPIM::DistributionList list;
+    list.setUid( d->distListUid.isNull() ? KApplication::randomString( 10 ) :d->distListUid );
+    list.setName( name );
+    typedef QValueList<KPIM::DistributionListEditor::Line*>::ConstIterator ListIterator;
+    for ( ListIterator it = d->addressees.begin(), end = d->addressees.end(); it != end; ++it )
+    { 
+        const KPIM::DistributionList::Entry entry = (*it)->entry();
+        if ( entry.addressee.isEmpty() )
+            continue;
+        list.insertEntry( entry.addressee, entry.email );
+    }
+    d->distributionList = list;
+    accept();
+}
+
+KPIM::DistributionList KPIM::DistributionListEditor::EditorWidget::distributionList() const
+{
+    return d->distributionList;
+}
+
+#include "distributionlisteditor.moc"
+#include "distributionlisteditor_p.moc"
Index: kaddressbook/phoneeditwidget.h
===================================================================
--- kaddressbook/phoneeditwidget.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/phoneeditwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -109,8 +109,7 @@
     void changed( int pos );
 
   private:
-    void updateWidgets();
-    void updateButtons();
+    void recreateNumberWidgets();
 
     KABC::PhoneNumber::List mPhoneNumberList;
     QPtrList<PhoneNumberWidget> mWidgets;
Index: kaddressbook/kcmconfigs/kabcustomfields.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabcustomfields.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kcmconfigs/kabcustomfields.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -74,6 +74,7 @@
 Comment[da]=Indstil de selvvalgte sider
 Comment[de]=Einstellungen f√ºr benutzerdefinierte Seiten
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œÑœâŒΩ œÄœÅŒøœÉŒ±œÅŒºŒøœÉŒºŒ≠ŒΩœâŒΩ œÉŒµŒªŒØŒ¥œâŒΩ
+Comment[eo]=Agordi la proprajn paƒùojn
 Comment[es]=Configura las p√°ginas personalizadas
 Comment[et]=Omaloodud lehek√ºlgede seadistamine
 Comment[eu]=Konfiguratu orri pertsonalizatuak
Index: kaddressbook/kcmconfigs/kabldapconfig.desktop
===================================================================
--- kaddressbook/kcmconfigs/kabldapconfig.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kcmconfigs/kabldapconfig.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 Name[da]=LDAP-Opslag
 Name[de]=LDAP-Nachschlagefunktion
 Name[el]=ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑ LDAP
+Name[eo]=LDAP-Serƒâo
 Name[es]=B√∫squeda LDAP
 Name[et]=LDAP otsing
 Name[eu]=LDAP bilaketa
@@ -73,6 +74,7 @@
 Comment[da]=Indstil adressebogens LDAP-ops√¶tning
 Comment[de]=Adressbuch-Modul f√ºr LDAP-Einstellungen
 Comment[el]=ŒëŒªŒªŒ¨ŒæœÑŒµ œÑŒπœÇ œÅœÖŒ∏ŒºŒØœÉŒµŒπœÇ LDAP œÑŒøœÖ ŒíŒπŒ≤ŒªŒØŒøœÖ Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ
+Comment[eo]=Agordo de tenejo
 Comment[es]=Configura las opciones de b√∫squeda LDAP en la libreta de direcciones
 Comment[et]=Aadressiraamatu LDAP seadistused
 Comment[eu]=Konfiguratu Helbide-liburuaren LDAP ezarpenak
Index: kaddressbook/searchmanager.h
===================================================================
--- kaddressbook/searchmanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/searchmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -68,6 +68,11 @@
 
 #ifdef KDEPIM_NEW_DISTRLISTS
     /**
+      sets the distribution list to be shown 
+     */
+    void setSelectedDistributionList( const QString &name );
+
+    /**
       Returns all the distribution lists.
      */
     KPIM::DistributionList::List distributionLists() const;
@@ -90,6 +95,7 @@
   private:
     KABC::Addressee::List mContacts;
 #ifdef KDEPIM_NEW_DISTRLISTS
+    QString mSelectedDistributionList;
     KPIM::DistributionList::List mDistributionLists;
 #endif
     KABC::AddressBook *mAddressBook;
Index: kaddressbook/common/kaddressbook.kcfg
===================================================================
--- kaddressbook/common/kaddressbook.kcfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/common/kaddressbook.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,6 +60,8 @@
     <entry type="String" name="CurrentExtension">
       <default>resourceselection</default>
     </entry>
+    <entry type="StringList" name="activeExtensions"/>
+    <entry type="IntList" name="ExtensionsSplitterSizes"/>
   </group>
 
   <group name="Filters">
Index: kaddressbook/distributionlistpicker.cpp
===================================================================
--- kaddressbook/distributionlistpicker.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlistpicker.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,142 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "distributionlistpicker.h"
+#include "config.h"
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+#include <libkdepim/distributionlist.h>
+#endif
+
+#include <kabc/addressbook.h>
+
+#include <kapplication.h>
+#include <kinputdialog.h>
+#include <klistbox.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qpushbutton.h>
+#include <qregexp.h>
+#include <qvalidator.h>
+
+KPIM::DistributionListPickerDialog::DistributionListPickerDialog( KABC::AddressBook* book, QWidget* parent ) : KDialogBase( parent, 0, true, QString(), Ok | Cancel | User1 ), m_book( book )
+{
+    Q_ASSERT( m_book );
+    setModal( true );
+    enableButton( Ok, false );
+    setButtonText( User1, i18n( "Add New Distribution List" ) );
+    QWidget* main = new QWidget( this );
+    QGridLayout* layout = new QGridLayout( main );
+    layout->setSpacing( KDialog::spacingHint() );
+    m_label = new QLabel( main );
+    layout->addWidget( m_label, 0, 0 );
+    m_listBox = new KListBox( main );
+    layout->addWidget( m_listBox, 1, 0 );
+    connect( m_listBox, SIGNAL( highlighted( const QString& ) ),
+             this, SLOT( entrySelected( const QString& ) ) ); 
+    connect( m_listBox, SIGNAL( selected( const QString& ) ),
+             this, SLOT( entrySelected( const QString& ) ) ); 
+    setMainWidget( main );
+#ifdef KDEPIM_NEW_DISTRLISTS
+    typedef QValueList<KPIM::DistributionList> DistListList;
+    const DistListList lists = KPIM::DistributionList::allDistributionLists( m_book );
+    for ( DistListList::ConstIterator it = lists.begin(); it != lists.end(); ++it )
+    {
+        m_listBox->insertItem ( (*it).name() );
+    }
+#endif
+}
+
+void KPIM::DistributionListPickerDialog::entrySelected( const QString& name )
+{
+    actionButton( Ok )->setEnabled( !name.isNull() );
+}
+
+void KPIM::DistributionListPickerDialog::setLabelText( const QString& text )
+{
+    m_label->setText( text );
+}
+
+void KPIM::DistributionListPickerDialog::slotUser1()
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+    const QValueList<KPIM::DistributionList> lists = KPIM::DistributionList::allDistributionLists( m_book );
+    QStringList listNames;
+    for ( QValueList<KPIM::DistributionList>::ConstIterator it = lists.begin(); it != lists.end(); ++it ) 
+    {
+        listNames += (*it).name();
+    }
+
+    bool validName = false;
+    do
+    {
+        QRegExpValidator validator( QRegExp( "\\S+.*" ), 0 );
+        const QString name = KInputDialog::getText( i18n( "Enter Name" ), i18n( "Enter a name for the new distribution list:" ), QString(), 0, this, 0, &validator ).stripWhiteSpace();
+        if ( name.isEmpty() )
+            return;
+
+        validName = !listNames.contains( name );
+
+        if ( validName )
+        {
+            KPIM::DistributionList list;
+            list.setName( name );
+            list.setUid( KApplication::randomString( 10 ) );
+            m_book->insertAddressee( list );
+
+            m_listBox->insertItem( name );
+            QListBoxItem* item = m_listBox->findItem( name );
+            m_listBox->setSelected( item, true );
+        }
+        else
+        {
+            KMessageBox::error( this, i18n( "A distribution list with the the name %1 already exists. Please choose another name" ).arg( name ), i18n( "Name Exists" ) );
+        }
+    }
+    while ( !validName );
+#endif
+}
+
+
+void KPIM::DistributionListPickerDialog::slotOk()
+{
+    QListBoxItem* item = m_listBox->selectedItem();
+    m_selectedDistributionList = item ? item->text() : QString();
+    KDialogBase::slotOk();
+}
+
+void KPIM::DistributionListPickerDialog::slotCancel()
+{
+    m_selectedDistributionList = QString();
+    KDialogBase::slotCancel();
+}
+
+QString KPIM::DistributionListPickerDialog::selectedDistributionList() const
+{
+    return m_selectedDistributionList;
+}
+
+#include "distributionlistpicker.moc"
+
Index: kaddressbook/kabcore.h
===================================================================
--- kaddressbook/kabcore.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kabcore.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,6 +27,7 @@
 #include <kabc/field.h>
 
 #include <qdict.h>
+#include <qlabel.h>
 #include <qwidget.h>
 
 #include "core.h"
@@ -53,6 +54,7 @@
 
 class QSplitter;
 class QHBoxLayout;
+class QWidgetStack;
 
 class AddresseeEditorDialog;
 class ExtensionManager;
@@ -66,6 +68,10 @@
 class ViewManager;
 class XXPortManager;
 
+namespace KAB {
+    class DistributionListEntryView;
+}
+
 typedef struct {
   KABC::Ticket *ticket;
   int counter;
@@ -148,6 +154,12 @@
       Returns the name of all the distribution lists.
      */
     virtual QStringList distributionListNames() const;
+
+    /**
+      sets the distribution list to display. If null, the regular
+      address book is to be displayed.  
+     */
+    virtual void setSelectedDistributionList( const QString &name );
 #endif
 
   public slots:
@@ -200,6 +212,14 @@
     void deleteContacts( const QStringList &uids );
 
     /**
+      Deletes given distribution lists from the address book.
+
+      @param uids The names of the distribution lists which shall be deleted.
+     */
+    void deleteDistributionLists( const QStringList &names );
+
+
+    /**
       Copys the selected contacts into clipboard for later pasting.
      */
     void copyContacts();
@@ -288,6 +308,11 @@
      */
     virtual void newContact();
 
+    /** 
+     DCOP METHOD: Opens distribution list editor to create a new distribution list
+    */
+    virtual void newDistributionList();
+
     /**
       DCOP METHOD: Returns the name of the contact, that matches the given
                    phone number.
@@ -315,10 +340,22 @@
     /**
      * Let the user chose a different resource for the selected contacts.
      * If the adding to the new resource is successfull, the contact is
-     * removed from the old one. */
-    void storeContactIn( const QString &uid = QString::null );
+     * removed from the old one, unless the Copy flag is given. */
+    void storeContactIn( const QString &uid = QString::null, bool copy = false );
+    
+    /**
+     * Lets the user chose a different resource for the selected contacts and
+     * copies it there.
+     */
+    void copySelectedContactToResource();
 
     /**
+     * Lets the user chose a different resource for the selected contacts and
+     * moves it there.
+     */
+    void moveSelectedContactToResource();
+
+    /**
       Launches the ldap search dialog.
      */
     void openLDAPDialog();
@@ -347,6 +384,13 @@
      */
     void reinitXMLGUI();
 
+  private:
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+    void editDistributionList( const KPIM::DistributionList &list );
+    void showDistributionListEntry( const QString &uid );
+#endif
+
   private slots:
     void setJumpButtonBarVisible( bool visible );
     void setDetailsVisible( bool visible );
@@ -365,6 +409,15 @@
     void slotClearSearchBar();
     void slotContactsUpdated();
 
+    void activateDetailsWidget( QWidget *widget );
+    void deactivateDetailsWidget( QWidget *widget );
+
+    void editDistributionList( const QString &name );
+
+    void removeSelectedContactsFromDistList();
+    void editSelectedDistributionList();
+    void sendMailToDistributionList( const QString &id ); 
+
   private:
     void initGUI();
     void createJumpButtonBar();
@@ -381,21 +434,28 @@
     KStatusBar *mStatusBar;
 
     ViewManager *mViewManager;
+    QLabel *mViewHeaderLabel;
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+    QString mSelectedDistributionList;
+    QWidget *mDistListButtonWidget;
+#endif
+
     ExtensionManager *mExtensionManager;
     XXPortManager *mXXPortManager;
 
     JumpButtonBar *mJumpButtonBar;
     FilterSelectionWidget *mFilterSelectionWidget;
     IncSearchWidget *mIncSearchWidget;
-    KPIM::AddresseeView *mDetails;
+    KAB::DistributionListEntryView* mDistListEntryView;
+    KPIM::AddresseeView *mDetailsViewer;
     KPIM::CategorySelectDialog *mCategorySelectDialog;
     KPIM::CategoryEditDialog *mCategoryEditDialog;
     QWidget *mDetailsPage;
     QWidget *mDetailsWidget;
     QHBoxLayout *mDetailsLayout;
     QSplitter *mDetailsSplitter;
-    QSplitter *mExtensionBarSplitter;
-
+    QWidgetStack *mDetailsStack;
     LDAPSearchDialog *mLdapSearchDialog;
     QDict<AddresseeEditorDialog> mEditorDict;
 
@@ -410,7 +470,8 @@
     KAction *mActionDelete;
     KAction *mActionCopy;
     KAction *mActionEditAddressee;
-    KAction *mActionStoreAddresseeIn;
+    KAction *mActionMoveAddresseeTo;
+    KAction *mActionCopyAddresseeTo;
     KAction *mActionMerge;
     KAction *mActionMail;
     KAction *mActionMailVCard;
@@ -421,7 +482,6 @@
     KAction *mActionCategories;
     KToggleAction *mActionJumpBar;
     KToggleAction *mActionDetails;
-
     KCommandHistory *mCommandHistory;
 
     KAddressBookService *mAddressBookService;
@@ -429,7 +489,6 @@
     KAB::SearchManager *mSearchManager;
     // KIMProxy provides access to up to date instant messaging presence data
     ::KIMProxy *mKIMProxy;
-
     class KABCorePrivate;
     KABCorePrivate *d;
 };
Index: kaddressbook/extensionmanager.h
===================================================================
--- kaddressbook/extensionmanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/extensionmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,34 +24,41 @@
 #ifndef EXTENSIONMANAGER_H
 #define EXTENSIONMANAGER_H
 
-#include <qhbox.h>
+#include "extensionwidget.h"
+
+#include <qwidget.h>
+#include <qmap.h>
 #include <qptrlist.h>
+#include <qstringlist.h>
 
-#include "extensionwidget.h"
+class QSignalMapper;
+class QWidgetStack;
+class KActionCollection;
 
 namespace KAB {
 class Core;
 }
 
-class QSignalMapper;
-class KActionCollection;
-
 class ExtensionData
 {
   public:
+    ExtensionData();
     typedef QValueList<ExtensionData> List;
 
+    KToggleAction* action;
     KAB::ExtensionWidget *widget;
     QString identifier;
     QString title;
+    int weight;
+    bool isDetailsExtension;
 };
 
-class ExtensionManager : public QHBox
+class ExtensionManager : public QObject
 {
   Q_OBJECT
 
   public:
-    ExtensionManager( KAB::Core *core, QWidget *parent, const char *name = 0 );
+    ExtensionManager( QWidget *extensionBar, QWidgetStack *detailsStack, KAB::Core *core, QObject *parent, const char *name = 0 );
     ~ExtensionManager();
 
     /**
@@ -75,27 +82,37 @@
      */
     bool isQuickEditVisible() const;
 
+    QWidget *activeDetailsWidget() const;
+ 
   public slots:
     void setSelectionChanged();
     void createActions();
 
   signals:
+
+    void detailsWidgetActivated( QWidget* widget );
+    void detailsWidgetDeactivated( QWidget* widget );
     void modified( const KABC::Addressee::List& );
     void deleted( const QStringList& );
 
   private slots:
-    void setActiveExtension( int id );
+    void activationToggled( const QString &extid );
 
   private:
     void createExtensionWidgets();
+    void setExtensionActive( const QString &extid, bool active ); 
 
+  private:
+    QWidget *mExtensionBar;
     KAB::Core *mCore;
-
-    KAB::ExtensionWidget *mCurrentExtensionWidget;
-    ExtensionData::List mExtensionList;
+    QMap<QString, ExtensionData> mExtensionMap;
+    QStringList mActiveExtensions;
     QSignalMapper *mMapper;
     QPtrList<KAction> mActionList;
     KActionCollection *mActionCollection;
+    QSplitter *mSplitter;
+    QWidgetStack *mDetailsStack; 
+    QWidget *mActiveDetailsWidget;
 };
 
 #endif
Index: kaddressbook/kaddressbookmain.cpp
===================================================================
--- kaddressbook/kaddressbookmain.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/kaddressbookmain.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -99,6 +99,11 @@
   mCore->editContact( uid );
 }
 
+void KAddressBookMain::newDistributionList()
+{
+  mCore->newDistributionList();
+}
+
 void KAddressBookMain::newContact()
 {
   mCore->newContact();
@@ -153,6 +158,14 @@
   KKeyDialog::configure( actionCollection(), this );
 }
 
+void KAddressBookMain::loadProfile( const QString& )
+{
+}
+
+void KAddressBookMain::saveToProfile( const QString& ) const
+{
+}
+
 void KAddressBookMain::configureToolbars()
 {
   saveMainWindowSettings( KGlobal::config(), "MainWindow" );
Index: kaddressbook/thumbnailcreator/ldifvcardcreator.cpp
===================================================================
--- kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/thumbnailcreator/ldifvcardcreator.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -75,9 +75,7 @@
   text.truncate(0);
 
   // read the file
-  QTextStream t( &file );
-  t.setEncoding( QTextStream::UnicodeUTF8 );
-  QString contents = t.read();
+  QString contents = file.readAll();
   file.close();
 
   // convert the file contents to a KABC::Addressee address
Index: kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop
===================================================================
--- kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/thumbnailcreator/ldifvcardthumbnail.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Elektroniske forretningskort-filer
 Name[de]=Dateien f√ºr elektronische Visitenkarten
 Name[el]=ŒëœÅœáŒµŒØŒ± ŒµœÄŒ±Œ≥Œ≥ŒµŒªŒºŒ±œÑŒπŒ∫œéŒΩ Œ∑ŒªŒµŒ∫œÑœÅŒøŒΩŒπŒ∫œéŒΩ Œ∫Œ±œÅœÑœéŒΩ
+Name[eo]=Dosieroj de Elektronika Vizitkarto
 Name[es]=Archivos de tarjetas de visita electr√≥nicas
 Name[et]=Elektrooniline visiitkaart
 Name[eu]=Electronic Business Card fitxategiak
Index: kaddressbook/phoneeditwidget.cpp
===================================================================
--- kaddressbook/phoneeditwidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/phoneeditwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -91,11 +91,13 @@
     if ( *it == -1 ) { // "Other..." entry
       insertItem( i18n( "Other..." ) );
     } else {
-      insertItem( KABC::PhoneNumber::typeLabel( *it ) );
+      KABC::PhoneNumber number;
+      number.setType( *it );
+      insertItem( number.typeLabel() );
     }
   }
 
-  setCurrentItem( mTypeList.findIndex( mType ) );
+  setCurrentItem( mLastSelected = mTypeList.findIndex( mType ) );
 
   blockSignals( blocked );
 }
@@ -195,6 +197,8 @@
 void PhoneEditWidget::setReadOnly( bool readOnly )
 {
   mReadOnly = readOnly;
+  mAddButton->setEnabled( !readOnly );
+  mRemoveButton->setEnabled( !readOnly && mPhoneNumberList.count() > 3 );
 
   QPtrListIterator<PhoneNumberWidget> it( mWidgets );
   while ( it.current() ) {
@@ -217,8 +221,7 @@
     for ( int i = mPhoneNumberList.count(); i < 3; ++i )
       mPhoneNumberList.append( KABC::PhoneNumber( "", types[ i ] ) );
 
-  updateWidgets();
-  updateButtons();
+  recreateNumberWidgets();
 }
 
 KABC::PhoneNumber::List PhoneEditWidget::phoneNumbers() const
@@ -243,8 +246,7 @@
 {
   mPhoneNumberList.append( KABC::PhoneNumber() );
 
-  updateWidgets();
-  updateButtons();
+  recreateNumberWidgets();
 }
 
 void PhoneEditWidget::remove()
@@ -252,15 +254,16 @@
   mPhoneNumberList.remove( mPhoneNumberList.last() );
   changed();
 
-  updateWidgets();
-  updateButtons();
+  recreateNumberWidgets();
 }
 
-void PhoneEditWidget::updateWidgets()
+void PhoneEditWidget::recreateNumberWidgets()
 {
-  mWidgets.setAutoDelete( true );
+  for ( QWidget *w = mWidgets.first(); w; w = mWidgets.next() ) {
+    mWidgetLayout->remove( w );
+    w->deleteLater();
+  }
   mWidgets.clear();
-  mWidgets.setAutoDelete( false );
 
   KABC::PhoneNumber::List::ConstIterator it;
   int counter = 0;
@@ -277,13 +280,9 @@
 
     ++counter;
   }
+  setReadOnly(mReadOnly);
 }
 
-void PhoneEditWidget::updateButtons()
-{
-  mRemoveButton->setEnabled( mPhoneNumberList.count() > 3 );
-}
-
 void PhoneEditWidget::changed( int pos )
 {
   mPhoneNumberList[ pos ] = mWidgets.at( pos )->number();
Index: kaddressbook/ldapsearchdialog.cpp
===================================================================
--- kaddressbook/ldapsearchdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/ldapsearchdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -18,6 +18,7 @@
  * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
  */
 
+#include "config.h"
 
 #include <qcheckbox.h>
 #include <qgroupbox.h>
@@ -25,6 +26,7 @@
 #include <qlabel.h>
 #include <qlayout.h>
 #include <qlistview.h>
+#include <qmap.h>
 #include <qpushbutton.h>
 
 #include <addresseelineedit.h>
@@ -40,6 +42,10 @@
 #include "ldapsearchdialog.h"
 #include "kablock.h"
 
+#ifdef KDEPIM_NEW_DISTRLISTS
+#include "distributionlistpicker.h"
+#endif
+
 static QString asUtf8( const QByteArray &val )
 {
   if ( val.isEmpty() )
@@ -113,11 +119,30 @@
     }
 };
 
+class LDAPSearchDialog::Private
+{
+  public:
+    static QValueList<ContactListItem*> selectedItems( QListView* );
+    QMap<const ContactListItem*, QString> itemToServer;
+};
+
+QValueList<ContactListItem*> LDAPSearchDialog::Private::selectedItems( QListView* view )
+{
+  QValueList<ContactListItem*> selected;
+  ContactListItem* cli = static_cast<ContactListItem*>( view->firstChild() );
+  while ( cli ) {
+    if ( cli->isSelected() )
+      selected.append( cli );
+    cli = static_cast<ContactListItem*>( cli->nextSibling() );
+  }
+  return selected;
+}
+
 LDAPSearchDialog::LDAPSearchDialog( KABC::AddressBook *ab, KABCore *core,
                                     QWidget* parent, const char* name )
-  : KDialogBase( Plain, i18n( "Search for Addresses in Directory" ), Help | User1 |
+  : KDialogBase( Plain, i18n( "Search for Addresses in Directory" ), Help | User1 | User2 |
                  Cancel, Default, parent, name, false, true ),
-    mAddressBook( ab ), mCore( core )
+    mAddressBook( ab ), mCore( core ), d( new Private )
 {
   setButtonCancel( KStdGuiItem::close() );
   QFrame *page = plainPage();
@@ -187,6 +212,13 @@
 
   setButtonText( User1, i18n( "Add Selected" ) );
 
+  showButton( User2, false );
+
+#ifdef KDEPIM_NEW_DISTRLISTS
+  showButton( User2, true );
+  setButtonText( User2, i18n( "Add to Distribution List..." ) );
+#endif
+
   mNumHosts = 0;
   mIsOK = false;
 
@@ -205,6 +237,7 @@
 LDAPSearchDialog::~LDAPSearchDialog()
 {
   saveSettings();
+  delete d;
 }
 
 void LDAPSearchDialog::restoreSettings()
@@ -277,6 +310,7 @@
     mResultListView->addColumn( i18n( "Title" ) );
 
     mResultListView->clear();
+    d->itemToServer.clear();
   }
 }
 
@@ -297,7 +331,8 @@
 
 void LDAPSearchDialog::slotAddResult( const KPIM::LdapObject& obj )
 {
-  new ContactListItem( mResultListView, obj.attrs );
+  ContactListItem* item = new ContactListItem( mResultListView, obj.attrs );
+  d->itemToServer[item] = obj.client->server().host();
 }
 
 void LDAPSearchDialog::slotSetScope( bool rec )
@@ -363,6 +398,7 @@
 
    // loop in the list and run the KPIM::LdapClients
   mResultListView->clear();
+  d->itemToServer.clear();
   for ( KPIM::LdapClient* client = mLdapClientList.first(); client; client = mLdapClientList.next() )
     client->startQuery( filter );
 
@@ -445,80 +481,154 @@
   mResultListView->selectAll( true );
 }
 
-void LDAPSearchDialog::slotUser1()
+KABC::Addressee LDAPSearchDialog::convertLdapAttributesToAddressee( const KPIM::LdapAttrMap& attrs )
 {
+  KABC::Addressee addr;
 
-  KABC::Resource *resource = mCore->requestResource( this );
-  if ( !resource ) return;
-  KABLock::self( mAddressBook )->lock( resource );
+  // name
+  addr.setNameFromString( asUtf8( attrs["cn"].first() ) );
 
-  ContactListItem* cli = static_cast<ContactListItem*>( mResultListView->firstChild() );
-  while ( cli ) {
-    if ( cli->isSelected() ) {
-      KABC::Addressee addr;
+  // email
+  KPIM::LdapAttrValue lst = attrs["mail"];
+  KPIM::LdapAttrValue::ConstIterator it = lst.begin();
+  bool pref = true;
+  if ( it != lst.end() ) {
+    addr.insertEmail( asUtf8( *it ), pref );
+    pref = false;
+    ++it;
+  }
 
-      // name
-      addr.setNameFromString( asUtf8( cli->mAttrs["cn"].first() ) );
+  addr.setOrganization( asUtf8( attrs[ "o" ].first() ) );
+  if ( addr.organization().isEmpty() )
+    addr.setOrganization( asUtf8( attrs[ "Company" ].first() ) );
 
-      // email
-      KPIM::LdapAttrValue lst = cli->mAttrs["mail"];
-      KPIM::LdapAttrValue::ConstIterator it = lst.begin();
-      bool pref = true;
-      if ( it != lst.end() ) {
-        addr.insertEmail( asUtf8( *it ), pref );
-        pref = false;
-        ++it;
-      }
+#if KDE_IS_VERSION(3,5,8)
+  addr.setDepartment( asUtf8( attrs[ "department" ].first() ) );
+#else
+  addr.insertCustom( "KADDRESSBOOK", "X-Department", asUtf8( attrs[ "department" ].first() ) );
+#endif
 
-      addr.setOrganization( asUtf8( cli->mAttrs[ "o" ].first() ) );
-      if ( addr.organization().isEmpty() )
-         addr.setOrganization( asUtf8( cli->mAttrs[ "Company" ].first() ) );
+  // Address
+  KABC::Address workAddr( KABC::Address::Work );
 
-      addr.setDepartment( asUtf8( cli->mAttrs[ "department" ].first() ) );
+  workAddr.setStreet( asUtf8( attrs[ "street" ].first()) );
+  workAddr.setLocality( asUtf8( attrs[ "l" ].first()) );
+  workAddr.setRegion( asUtf8( attrs[ "st" ].first()));
+  workAddr.setPostalCode( asUtf8( attrs[ "postalCode" ].first()) );
+  workAddr.setCountry( asUtf8( attrs[ "co" ].first()) );
 
-      // Address
-      KABC::Address workAddr( KABC::Address::Work );
+  if ( !workAddr.isEmpty() )
+    addr.insertAddress( workAddr );
 
-      workAddr.setStreet( asUtf8( cli->mAttrs[ "street" ].first()) );
-      workAddr.setLocality( asUtf8( cli->mAttrs[ "l" ].first()) );
-      workAddr.setRegion( asUtf8( cli->mAttrs[ "st" ].first()));
-      workAddr.setPostalCode( asUtf8( cli->mAttrs[ "postalCode" ].first()) );
-      workAddr.setCountry( asUtf8( cli->mAttrs[ "co" ].first()) );
+  // phone
+  KABC::PhoneNumber homeNr = asUtf8( attrs[  "homePhone" ].first() );
+  homeNr.setType( KABC::PhoneNumber::Home );
+  addr.insertPhoneNumber( homeNr );
 
-      if ( !workAddr.isEmpty() )
-        addr.insertAddress( workAddr );
+  KABC::PhoneNumber workNr = asUtf8( attrs[  "telephoneNumber" ].first() );
+  workNr.setType( KABC::PhoneNumber::Work );
+  addr.insertPhoneNumber( workNr );
 
-      // phone
-      KABC::PhoneNumber homeNr = asUtf8( cli->mAttrs[  "homePhone" ].first() );
-      homeNr.setType( KABC::PhoneNumber::Home );
-      addr.insertPhoneNumber( homeNr );
+  KABC::PhoneNumber faxNr = asUtf8( attrs[  "facsimileTelephoneNumber" ].first() );
+  faxNr.setType( KABC::PhoneNumber::Fax );
+  addr.insertPhoneNumber( faxNr );
 
-      KABC::PhoneNumber workNr = asUtf8( cli->mAttrs[  "telephoneNumber" ].first() );
-      workNr.setType( KABC::PhoneNumber::Work );
-      addr.insertPhoneNumber( workNr );
+  KABC::PhoneNumber cellNr = asUtf8( attrs[  "mobile" ].first() );
+  cellNr.setType( KABC::PhoneNumber::Cell );
+  addr.insertPhoneNumber( cellNr );
 
-      KABC::PhoneNumber faxNr = asUtf8( cli->mAttrs[  "facsimileTelephoneNumber" ].first() );
-      faxNr.setType( KABC::PhoneNumber::Fax );
-      addr.insertPhoneNumber( faxNr );
+  KABC::PhoneNumber pagerNr = asUtf8( attrs[  "pager" ].first() );
+  pagerNr.setType( KABC::PhoneNumber::Pager );
+  addr.insertPhoneNumber( pagerNr );
+  return addr;
+}
 
-      KABC::PhoneNumber cellNr = asUtf8( cli->mAttrs[  "mobile" ].first() );
-      cellNr.setType( KABC::PhoneNumber::Cell );
-      addr.insertPhoneNumber( cellNr );
+#ifdef KDEPIM_NEW_DISTRLISTS
+KPIM::DistributionList LDAPSearchDialog::selectDistributionList()
+{
+  QGuardedPtr<KPIM::DistributionListPickerDialog> picker = new KPIM::DistributionListPickerDialog( mCore->addressBook(), this );
+  picker->setLabelText( i18n( "Select a distribution list to add the selected contacts to." ) );
+  picker->setCaption( i18n( "Select Distribution List" ) );
+  picker->exec();
+  const KPIM::DistributionList list = KPIM::DistributionList::findByName( mCore->addressBook(), picker
+? picker->selectedDistributionList() : QString() );
+  delete picker;
+  return list;
+}
+#endif
 
-      KABC::PhoneNumber pagerNr = asUtf8( cli->mAttrs[  "pager" ].first() );
-      pagerNr.setType( KABC::PhoneNumber::Pager );
-      addr.insertPhoneNumber( pagerNr );
+KABC::Addressee::List LDAPSearchDialog::importContactsUnlessTheyExist( const QValueList<ContactListItem*>& selectedItems,
+                                                                       KABC::Resource * const resource )
+{
+    const QDateTime now = QDateTime::currentDateTime();
+    QStringList importedAddrs;
+    KABC::Addressee::List localAddrs;
 
-      if ( mAddressBook ) {
+    KABLock::self( mCore->addressBook() )->lock( resource );
+
+    for ( QValueList<ContactListItem*>::ConstIterator it = selectedItems.begin(); it != selectedItems.end(); ++it ) {
+      const ContactListItem * const cli = *it;
+      KABC::Addressee addr = convertLdapAttributesToAddressee( cli->mAttrs );
+      const KABC::Addressee::List existing = mCore->addressBook()->findByEmail( addr.preferredEmail() );
+
+      if ( existing.isEmpty() ) {
+        addr.setUid( KApplication::randomString( 10 ) );
+        addr.setNote( i18n( "arguments are host name, datetime", "Imported from LDAP directory %1 on %2" ).arg( d->itemToServer[cli], KGlobal::locale()->formatDateTime( now ) ) );
         addr.setResource( resource );
-        mAddressBook->insertAddressee( addr );
+        mCore->addressBook()->insertAddressee( addr );
+        importedAddrs.append( addr.fullEmail() );
+        localAddrs.append( addr );
+      } else {
+        localAddrs.append( existing.first() );
       }
     }
-    cli = static_cast<ContactListItem*>( cli->nextSibling() );
-  }
+    KABLock::self( mCore->addressBook() )->unlock( resource );
+    if ( !importedAddrs.isEmpty() ) {
+      KMessageBox::informationList( this, i18n( "The following contact was imported into your address book:",
+                                    "The following %n contacts were imported into your address book:", importedAddrs.count() ),
+                                    importedAddrs );
+      emit addresseesAdded();
+    }
+    return localAddrs;
+}
 
-  KABLock::self( mAddressBook )->unlock( resource );
-  emit addresseesAdded();
+void LDAPSearchDialog::slotUser2()
+{
+#ifdef KDEPIM_NEW_DISTRLISTS
+    KABC::Resource *resource = mCore->requestResource( this );
+    if ( !resource ) return;
+
+    const QValueList<ContactListItem*> selectedItems = d->selectedItems( mResultListView );
+    if ( selectedItems.isEmpty() ) {
+      KMessageBox::information( this, i18n( "Please select the contacts you want to add to the distribution list." ), i18n( "No Contacts Selected" ) );
+      return;
+    }
+    KPIM::DistributionList dist = selectDistributionList();
+    if ( dist.isEmpty() )
+      return;
+
+
+    KABC::Addressee::List localAddrs = importContactsUnlessTheyExist( selectedItems, resource );
+
+    if ( localAddrs.isEmpty() )
+      return;
+
+    for ( KABC::Addressee::List::ConstIterator it = localAddrs.begin(); it != localAddrs.end(); ++it ) {
+      dist.insertEntry( *it, QString() );
+    }
+    KABLock::self( mCore->addressBook() )->lock( resource );
+    mCore->addressBook()->insertAddressee( dist );
+    KABLock::self( mCore->addressBook() )->unlock( resource );
+    emit addresseesAdded();
+#endif
 }
 
+void LDAPSearchDialog::slotUser1()
+{
+    KABC::Resource *resource = mCore->requestResource( this );
+    if ( !resource ) return;
+    const QValueList<ContactListItem*> selectedItems = d->selectedItems( mResultListView );
+    importContactsUnlessTheyExist( selectedItems, resource );
+}
+
 #include "ldapsearchdialog.moc"
Index: kaddressbook/distributionlisteditor.h
===================================================================
--- kaddressbook/distributionlisteditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlisteditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,62 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KPIM_DISTRIBUTIONLISTEDITOR_H
+#define KPIM_DISTRIBUTIONLISTEDITOR_H
+
+#include <kdialogbase.h>
+
+namespace KABC {
+    class AddressBook;
+}
+
+namespace KPIM {
+
+class DistributionList;
+
+namespace DistributionListEditor {
+
+class EditorWidgetPrivate;
+class EditorWidget : public KDialogBase
+{
+    Q_OBJECT
+public:
+    explicit EditorWidget( KABC::AddressBook* book, QWidget* parent = 0 );
+    ~EditorWidget();
+
+    void setDistributionList( const KPIM::DistributionList& list );
+    KPIM::DistributionList distributionList() const;
+
+private slots:
+
+    //override
+    void slotOk();
+    void lineTextChanged( int id );
+
+private:
+    EditorWidgetPrivate* const d;
+};
+
+} // namespace DisributionListEditor
+} // namespace KPIM
+
+#endif // KPIM_DISTRIBUTIONLISTEDITOR_H
Index: kaddressbook/Makefile.am
===================================================================
--- kaddressbook/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-SUBDIRS = interfaces common printing editors . views features kcmconfigs xxport pics csv-templates \
+SUBDIRS = interfaces common printing editors . views features xxport kcmconfigs pics csv-templates \
           thumbnailcreator
 SRCDOC_DEST = $(kde_htmldir)/en/kaddressbook
 
@@ -39,7 +39,7 @@
     viewconfigurewidget.cpp undocmds.cpp viewmanager.cpp \
     xxportmanager.cpp xxportselectdialog.cpp contacteditorwidgetmanager.cpp \
     simpleaddresseeeditor.cpp advancedcustomfields.cpp customfieldswidget.cpp \
-    freebusywidget.cpp searchmanager.cpp imeditwidget.cpp kabtools.cpp
+    freebusywidget.cpp searchmanager.cpp imeditwidget.cpp kabtools.cpp distributionlistpicker.cpp distributionlisteditor.cpp distributionlistentryview.cpp
 libkaddressbook_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -no-undefined
 libkaddressbook_la_LIBADD = $(top_builddir)/kaddressbook/printing/libprinter.la \
                             $(top_builddir)/kaddressbook/interfaces/libkabinterfaces.la \
Index: kaddressbook/distributionlistentryview.cpp
===================================================================
--- kaddressbook/distributionlistentryview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/distributionlistentryview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,140 @@
+#include "distributionlistentryview.h"
+#include "imagewidget.h"
+#include <interfaces/core.h>
+
+#include <libkdepim/resourceabc.h>
+
+#include <kabc/addressbook.h>
+#include <kabc/resource.h>
+
+#include <kdialog.h>
+#include <kiconloader.h>
+#include <klocale.h>
+#include <kurllabel.h>
+
+#include <qbuttongroup.h>
+#include <qcombobox.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qradiobutton.h>
+#include <qstringlist.h>
+#include <qvbuttongroup.h>
+
+KAB::DistributionListEntryView::DistributionListEntryView( KAB::Core* core, QWidget* parent ) : QWidget( parent ), m_core( core ), m_emailGroup( 0 )
+{
+    m_mainLayout = new QVBoxLayout( this );
+    m_mainLayout->setSpacing( KDialog::spacingHint() );
+    m_mainLayout->setMargin( KDialog::marginHint() );
+
+    QBoxLayout* headerLayout = new QHBoxLayout;
+    headerLayout->setSpacing( KDialog::spacingHint() * 3 );
+
+    m_imageLabel = new QLabel( this );
+    m_imageLabel->setAutoResize( true );
+    headerLayout->addWidget( m_imageLabel, 0, Qt::AlignTop );
+
+    m_addresseeLabel = new QLabel( this );
+    headerLayout->addWidget( m_addresseeLabel, 0, Qt::AlignTop );
+    headerLayout->addStretch();
+
+    m_mainLayout->addItem( headerLayout );
+
+    QBoxLayout* distLayout = new QHBoxLayout;
+    distLayout->setSpacing( KDialog::spacingHint() );
+
+    QLabel* distLabel = new QLabel( this );
+    distLabel->setText( i18n( "<b>Distribution list:</b>" ) );
+    distLabel->setAlignment( Qt::SingleLine );
+    distLayout->addWidget( distLabel );
+
+    m_distListLabel = new KURLLabel( this );
+    distLabel->setBuddy( m_distListLabel );
+    connect( m_distListLabel, SIGNAL( leftClickedURL( const QString& ) ), 
+             this, SIGNAL( distributionListClicked( const QString& ) ) );
+    distLayout->addWidget( m_distListLabel );
+    distLayout->addStretch();
+    m_mainLayout->addItem( distLayout );
+
+    QLabel* emailLabel = new QLabel( this );
+    emailLabel->setText( i18n( "<b>Email address to use in this list:</b>" ) );
+    emailLabel->setAlignment( Qt::SingleLine );
+    m_mainLayout->addWidget( emailLabel );
+
+    QBoxLayout* emailLayout = new QHBoxLayout;
+    emailLayout->setSpacing( KDialog::spacingHint() );
+    emailLayout->addSpacing( 30 );
+
+    m_radioLayout = new QGridLayout;
+    emailLayout->addItem( m_radioLayout );
+    emailLayout->addStretch();
+    m_mainLayout->addItem( emailLayout );
+
+    QBoxLayout* resourceLayout = new QHBoxLayout;
+    resourceLayout->setSpacing( KDialog::spacingHint() );
+    m_resourceLabel = new QLabel( this );
+    resourceLayout->addWidget( m_resourceLabel );
+    resourceLayout->addStretch();
+
+    m_mainLayout->addItem( resourceLayout );
+    m_mainLayout->addStretch();
+}
+
+void KAB::DistributionListEntryView::emailButtonClicked( int id )
+{
+    const QString email = m_idToEmail[ id ];
+    if ( m_entry.email == email )
+        return;
+    m_list.removeEntry( m_entry.addressee, m_entry.email );
+    m_entry.email = email;
+    m_list.insertEntry( m_entry.addressee, m_entry.email );
+    m_core->addressBook()->insertAddressee( m_list ); 
+}
+
+void KAB::DistributionListEntryView::clear()
+{
+    setEntry( KPIM::DistributionList(), KPIM::DistributionList::Entry() );
+}
+
+void KAB::DistributionListEntryView::setEntry( const KPIM::DistributionList& list, const KPIM::DistributionList::Entry& entry )
+{    
+    m_list = list;
+    m_entry = entry;
+
+    delete m_emailGroup;
+    m_emailGroup = 0;
+
+    QPixmap pixmap;
+    pixmap.convertFromImage( m_entry.addressee.photo().data() );
+    m_imageLabel->setPixmap( pixmap.isNull() ? KGlobal::iconLoader()->loadIcon( "personal", KIcon::Desktop ) : pixmap );
+    m_addresseeLabel->setText( i18n( "Formatted name, role, organization", "<qt><h2>%1</h2><p>%2<br/>%3</p></qt>" ).arg( m_entry.addressee.formattedName(), m_entry.addressee.role(), m_entry.addressee.organization() ) );
+    m_distListLabel->setURL( m_list.name() );
+    m_distListLabel->setText( m_list.name() );
+    m_resourceLabel->setText( i18n( "<b>Address book:</b> %1" ).arg( m_entry.addressee.resource() ? m_entry.addressee.resource()->resourceName() : QString() ) );
+    m_resourceLabel->setAlignment( Qt::SingleLine );
+ 
+    m_emailGroup = new QVButtonGroup( this );
+    m_emailGroup->setFlat( true );
+    m_emailGroup->setExclusive( true );
+    m_emailGroup->setFrameShape( QFrame::NoFrame );
+
+    const QString preferred = m_entry.email.isNull() ? m_entry.addressee.preferredEmail() : m_entry.email;
+    const QStringList mails = m_entry.addressee.emails();
+    m_idToEmail.clear();
+    for ( QStringList::ConstIterator it = mails.begin(); it != mails.end(); ++it )
+    {
+        QRadioButton* button = new QRadioButton( m_emailGroup );
+        button->setText( *it );
+        m_idToEmail.insert( m_emailGroup->insert( button ), *it );
+        if ( *it == preferred )
+            button->setChecked( true );
+        button->setShown( true );
+    }
+    connect( m_emailGroup, SIGNAL( clicked( int ) ), 
+             this, SLOT( emailButtonClicked( int ) ) ); 
+    m_radioLayout->addWidget( m_emailGroup, 0, 0 );
+    m_emailGroup->setShown( true );
+    m_mainLayout->invalidate();
+}
+
+
+#include "distributionlistentryview.moc"
Index: kaddressbook/features/distributionlistngwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistngwidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/features/distributionlistngwidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,249 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "distributionlistngwidget.h"
+#include "interfaces/core.h"
+#include "searchmanager.h"
+
+#include <libkdepim/distributionlist.h>
+#include <libkdepim/kvcarddrag.h>
+
+#include <kabc/vcardconverter.h>
+
+#include <kdialog.h>
+#include <kiconloader.h>
+#include <klistview.h>
+#include <klocale.h>
+#include <kpopupmenu.h>
+
+#include <qevent.h>
+#include <qguardedptr.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qpoint.h>
+#include <qtimer.h>
+#include <qpushbutton.h>
+#include <qtooltip.h>
+
+KAB::DistributionListNg::ListBox::ListBox( QWidget* parent ) : KListBox( parent )
+{
+    setAcceptDrops( true );
+}
+
+void KAB::DistributionListNg::ListBox::dragMoveEvent( QDragMoveEvent *event )
+{
+    QListBoxItem *item = itemAt( event->pos() );
+    if ( !item ) {
+        event->ignore();
+    }
+    else {
+        event->accept( itemRect( item ) );
+    }
+}
+
+void KAB::DistributionListNg::ListBox::dragEnterEvent( QDragEnterEvent *event )
+{
+    KListBox::dragEnterEvent( event );
+}
+
+void KAB::DistributionListNg::ListBox::dropEvent( QDropEvent *event )
+{
+    QListBoxItem *item = itemAt( event->pos() );
+    if ( !item || index( item ) == 0 )
+        return;
+
+    QString vcards;
+    if ( !KVCardDrag::decode( event, vcards ) )
+        return;
+
+    KABC::VCardConverter converter;
+    emit dropped( item->text(), converter.parseVCards( vcards ) );
+}
+
+namespace KAB {
+namespace DistributionListNg {
+
+class Factory : public KAB::ExtensionFactory
+{
+  public:
+    KAB::ExtensionWidget *extension( KAB::Core *core, QWidget *parent, const char *name )
+    {
+      return new KAB::DistributionListNg::MainWidget( core, parent, name );
+    }
+
+    QString identifier() const
+    {
+      return "distribution_list_editor";
+    }
+};
+
+}
+}
+
+extern "C" {
+  void *init_libkaddrbk_distributionlistng()
+  {
+    return ( new KAB::DistributionListNg::Factory );
+  }
+}
+
+QString KAB::DistributionListNg::MainWidget::title() const
+{
+    return i18n( "Distribution List Editor NG" );
+}
+
+QString KAB::DistributionListNg::MainWidget::identifier() const
+{
+    return "distribution_list_editor_ng";
+}
+
+KAB::DistributionListNg::MainWidget::MainWidget( KAB::Core *core, QWidget *parent, const char *name ) : KAB::ExtensionWidget( core, parent, name )
+{
+    QVBoxLayout *layout = new QVBoxLayout( this );
+    layout->setSpacing( KDialog::spacingHint() );
+
+    QHBoxLayout *buttonLayout = new QHBoxLayout();
+    layout->addLayout( buttonLayout );
+
+    QLabel *label = new QLabel( this );
+    label->setText( i18n( "Distribution Lists" ) );
+    buttonLayout->addWidget( label );
+    buttonLayout->addStretch( 1 );
+
+    mAddButton = new QPushButton( this );
+    mAddButton->setIconSet( SmallIconSet( "add" ) );
+    QToolTip::add( mAddButton, i18n( "Add distribution list" ) );
+    connect( mAddButton, SIGNAL(clicked()), core, SLOT(newDistributionList()) );
+    buttonLayout->addWidget( mAddButton );
+
+    mEditButton = new QPushButton( this );
+    mEditButton->setIconSet( SmallIconSet( "edit" ) );
+    QToolTip::add( mEditButton, i18n( "Edit distribution list" ) );
+    connect( mEditButton, SIGNAL(clicked()), this, SLOT(editSelectedDistributionList()) );
+    buttonLayout->addWidget( mEditButton );
+
+    mRemoveButton = new QPushButton( this );
+    mRemoveButton->setIconSet( SmallIconSet( "remove" ) );
+    QToolTip::add( mRemoveButton, i18n( "Remove distribution list" ) );
+    connect( mRemoveButton, SIGNAL(clicked()), this, SLOT(deleteSelectedDistributionList()) );
+    buttonLayout->addWidget( mRemoveButton );
+
+    mListBox = new ListBox( this );
+    connect( mListBox, SIGNAL( contextMenuRequested( QListBoxItem*, const QPoint& ) ),
+             this, SLOT( contextMenuRequested( QListBoxItem*, const QPoint& ) ) );
+    connect( mListBox, SIGNAL( dropped( const QString &, const KABC::Addressee::List & ) ),
+             this, SLOT( contactsDropped( const QString &, const KABC::Addressee::List & ) ) );
+    connect( mListBox, SIGNAL( highlighted( int ) ),
+             this, SLOT( itemSelected( int ) ) );
+    layout->addWidget( mListBox );
+
+    connect( core, SIGNAL( contactsUpdated() ),
+             this, SLOT( updateEntries() ) );
+    connect( core->addressBook(), SIGNAL( addressBookChanged( AddressBook* ) ),
+             this, SLOT( updateEntries() ) );
+
+    // When contacts are changed, update both distr list combo and contents of displayed distr list
+    connect( core, SIGNAL( contactsUpdated() ),
+             this, SLOT( updateEntries() ) );
+
+    QTimer::singleShot( 0, this, SLOT( updateEntries() ) );
+}
+
+void KAB::DistributionListNg::MainWidget::contextMenuRequested( QListBoxItem *item, const QPoint &point )
+{
+    QGuardedPtr<KPopupMenu> menu = new KPopupMenu( this );
+    menu->insertItem( i18n( "New Distribution List..." ), core(), SLOT( newDistributionList() ) );
+    if ( item )
+    {
+        menu->insertItem( i18n( "Edit..." ), this, SLOT( editSelectedDistributionList() ) );
+        menu->insertItem( i18n( "Delete" ), this, SLOT( deleteSelectedDistributionList() ) );
+    }
+    menu->exec( point );
+    delete menu;
+}
+
+void KAB::DistributionListNg::MainWidget::editSelectedDistributionList()
+{
+    const QListBoxItem* const item = mListBox->selectedItem();
+    if ( !item )
+        return;
+    core()->editDistributionList( item->text() );
+}
+
+void KAB::DistributionListNg::MainWidget::deleteSelectedDistributionList()
+{
+    const QListBoxItem* const item = mListBox->selectedItem();
+    const QString name = item ? item->text() : QString();
+    if ( name.isNull() )
+        return;
+    const KPIM::DistributionList list = KPIM::DistributionList::findByName(
+    core()->addressBook(), name );
+    if ( list.isEmpty() )
+        return;
+    core()->deleteDistributionLists( name );
+}
+
+void KAB::DistributionListNg::MainWidget::contactsDropped( const QString &listName, const KABC::Addressee::List &addressees )
+{
+    if ( addressees.isEmpty() )
+        return;
+
+    KPIM::DistributionList list = KPIM::DistributionList::findByName(
+    core()->addressBook(), listName );
+    if ( list.isEmpty() ) // not found [should be impossible]
+        return;
+
+    for ( KABC::Addressee::List::ConstIterator it = addressees.begin(); it != addressees.end(); ++it ) {
+        list.insertEntry( *it );
+    }
+
+    core()->addressBook()->insertAddressee( list );
+    changed( list );
+}
+
+void KAB::DistributionListNg::MainWidget::changed( const KABC::Addressee& dist )
+{
+    emit modified( KABC::Addressee::List() << dist );
+}
+
+void KAB::DistributionListNg::MainWidget::updateEntries()
+{
+    const bool hadSelection = mListBox->selectedItem() != 0;
+    const QStringList newEntries = core()->distributionListNames();
+    if ( !mCurrentEntries.isEmpty() && newEntries == mCurrentEntries )
+        return;
+    mCurrentEntries = newEntries;
+    mListBox->clear();
+    mListBox->insertItem( i18n( "All Contacts" ), 0 );
+    mListBox->insertStringList( mCurrentEntries );
+    if ( !hadSelection )
+        mListBox->setSelected( 0, true );
+}
+
+void KAB::DistributionListNg::MainWidget::itemSelected( int index )
+{
+    core()->setSelectedDistributionList( index == 0 ? QString() : mListBox->item( index )->text()  );
+    mEditButton->setEnabled( index > 0 );
+    mRemoveButton->setEnabled( index > 0 );
+}
+
+#include "distributionlistngwidget.moc"
Index: kaddressbook/features/distributionlistng.desktop
===================================================================
--- kaddressbook/features/distributionlistng.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/features/distributionlistng.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,66 @@
+[Desktop Entry]
+Encoding=UTF-8
+X-KDE-Library=libkaddrbk_distributionlistng
+Name=KAB Distribution List Next Generation Plugin
+Name[da]=N√¶ste generations-plugin til KAB-Distribution-liste
+Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø ŒµœÄœåŒºŒµŒΩŒ∑œÇ Œ≥ŒµŒΩŒπŒ¨œÇ ŒªŒØœÉœÑŒ±œÇ Œ¥ŒπŒ±ŒΩŒøŒºŒÆœÇ œÑŒøœÖ KAB
+Name[sk]=KAB plugin distribuƒçn√©ho zoznamu ƒèaƒæ≈°ej gener√°cie
+Name[sv]=Adressbokens n√§sta generation insticksprogram f√∂r distributionslistor
+Comment=Plugin for managing distribution lists
+Comment[af]=Inprop module vir die bestuur van verspreiding lyste
+Comment[ar]=ŸÖŸÑÿ≠ŸÇ ŸÑÿ•ÿØÿßÿ±ÿ© ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
+Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –¥–ª—è –∫—ñ—Ä–∞–≤–∞–Ω–Ω—è —Å—å–ø—ñ—Å–∞–º—ñ —Ä–∞—Å–ø–∞—û—Å—é–¥–∂–≤–∞–Ω–Ω—è
+Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏—Å—ä—Ü–∏
+Comment[br]=Lugent melestradur ar rollo√π ingaladur
+Comment[bs]=Dodatak za upravljanje distribucionim listama
+Comment[ca]=Endollable per a gestionar llistes de distribuci√≥
+Comment[cs]=Modul pro spr√°vu distribuƒçn√≠ch seznam≈Ø
+Comment[cy]=Ategyn ar gyfer rheoli rhestri dosbarthu
+Comment[da]=Plugin til at h√•ndtere distributionslister
+Comment[de]=Modul zur Verwaltung von Verteilerlisten
+Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø Œ≥ŒπŒ± œÑŒ∑ Œ¥ŒπŒ±œáŒµŒØœÅŒπœÉŒ∑ ŒªŒπœÉœÑœéŒΩ Œ¥ŒπŒ±ŒΩŒøŒºŒÆœÇ
+Comment[eo]=Kromaƒµo por administri distribulistojn
+Comment[es]=Plugin para gestionar listas de distribuci√≥n
+Comment[et]=Plugin postiloendite haldamiseks
+Comment[eu]=Banaketa zerrendak kudeatzeko plugin-a
+Comment[fa]=ŸàÿµŸÑŸá ÿ®ÿ±ÿß€å ŸÖÿØ€åÿ±€åÿ™ ŸÅŸáÿ±ÿ≥ÿ™Ÿáÿß€å ÿ™Ÿàÿ≤€åÿπ
+Comment[fi]=Liit√§nn√§inen jakelulistojen hallintaan
+Comment[fr]=Module pour g√©rer des listes de diffusion
+Comment[fy]=Plugin foar nit behearen fan distrib√∫sjelisten
+Comment[gl]=Plugin para manexar listas de distribuci√≥n
+Comment[he]=◊™◊ï◊°◊£ ◊ú◊†◊ô◊î◊ï◊ú ◊®◊©◊ô◊û◊ï◊™ ◊™◊§◊ï◊¶◊î
+Comment[hi]=‡§µ‡§ø‡§§‡§∞‡§£ ‡§∏‡•Ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§≤‡§ó‡§á‡§®
+Comment[hu]=B≈ëv√≠t≈ëmodul c√≠mlist√°k kezel√©s√©hez
+Comment[is]=√çforrit til a√∞ sj√° um dreifilista
+Comment[it]=Plugin per gestire liste di distribuzione
+Comment[ja]=ÈÖçÂ∏É„É™„Çπ„ÉàÁÆ°ÁêÜÁî®„Éó„É©„Ç∞„Ç§„É≥
+Comment[kk]=–¢–∞—Ä–∞—Ç—É —Ç—ñ–∑—ñ–º—ñ–º–µ–Ω –∞–π–Ω–∞–ª—ã—Å—É –ø–ª–∞–≥–∏–Ω –º–æ–¥—É–ª—ñ
+Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûä·ûæ·ûò·üí·ûî·û∏‚Äã·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ‚Äã·ûî·ûâ·üí·ûá·û∏‚Äã·ûÖ·üÇ·ûÄ·ûÖ·û∂·ûô
+Comment[lt]=Priedas platinimo sƒÖra≈°≈≥ tvarkymui
+Comment[ms]=Plug masuk untuk pengurusan senarai edaran
+Comment[nb]=Programtillegg for √• h√•ndtere distribusjonslister
+Comment[nds]=Moduul f√∂r't Plegen vun Verdeellisten
+Comment[ne]=‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§µ‡§ø‡§§‡§∞‡§£ ‡§∏‡•Ç‡§ö‡•Ä‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®
+Comment[nl]=Plugin voor het beheren van distributielijsten
+Comment[nn]=Programtillegg for handtering av distibusjonsliste
+Comment[pl]=Wtyczka do zarzƒÖdzania listami wysy≈Çkowymi
+Comment[pt]=Um 'plugin' para gerir as listas de distribui√ß√£o
+Comment[pt_BR]=Plug-in para gerenciar listas de distribui√ß√£o
+Comment[ro]=Modul pentru administrarea listelor de distribu≈£ie
+Comment[ru]=–†–∞–±–æ—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–∞–º–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
+Comment[se]=Lassemoduvla mii gieƒëahall√° distribu≈°uvdnalisttuid
+Comment[sk]=Plugin pre spr√°vu distribuƒçn√Ωch zoznamov
+Comment[sl]=Vstavek za upravljanje distribucijskih seznamov
+Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ –∑–∞ —É–ø—Ä–∞–≤—ô–∞—ö–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ü–∏–æ–Ω–∏–º –ª–∏—Å—Ç–∞–º–∞
+Comment[sr@Latn]=Prikljuƒçak za upravljanje distribucionim listama
+Comment[sv]=Insticksprogram f√∂r att hantera distributionslistor
+Comment[ta]=‡Æ™‡Æï‡Æø‡Æ∞‡Øç‡Æ§‡Æ≤‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç ‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Æï‡Æø‡Æ§‡Øç‡Æ§‡Æ≤‡Æø‡Æ©‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
+Comment[tg]=–ö–æ—Ä –±–æ —Ä”Ø–π—Ö–∞—Ç–∏ –±–∞ “≥–∞—Ä —Ç–∞—Ä–∞—Ñ –º–µ—Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞–≥”£
+Comment[tr]=Daƒüƒ±tƒ±m listelerini y√∂netmek i√ßin eklenti
+Comment[uk]=–í—Ç—É–ª–æ–∫ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫–∞–º–∏ —Ä–æ–∑–ø–æ–≤—Å—é–¥–∂–µ–Ω–Ω—è
+Comment[uz]=–¢–∞—Ä“õ–∞—Ç–∏—à —Ä—û–π—Ö–∞—Ç–ª–∞—Ä–Ω–∏ –±–æ—à“õ–∞—Ä–∏—à —É—á—É –ø–ª–∞–≥–∏–Ω
+Comment[zh_CN]=ÁÆ°ÁêÜÂàÜÂèëÂàóË°®ÁöÑÊèí‰ª∂
+Comment[zh_TW]=ÁÆ°ÁêÜÂàÜÈÖçÊ∏ÖÂñÆÂ§ñÊéõÁ®ãÂºè
+Type=Service
+ServiceTypes=KAddressBook/Extension
+X-KDE-KAddressBook-ExtensionPluginVersion=1
Index: kaddressbook/features/Makefile.am
===================================================================
--- kaddressbook/features/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/features/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,8 +1,13 @@
 INCLUDES = -I$(top_srcdir)/kaddressbook/interfaces -I$(top_srcdir)/kaddressbook \
            -I$(top_srcdir)  $(all_includes)
 
-kde_module_LTLIBRARIES = libkaddrbk_distributionlist.la libkaddrbk_resourceselection.la
+if compile_newdistrlists
+TARGET_DISTRIBUTIONLISTNG=libkaddrbk_distributionlistng.la
+DISTRIBUTIONLISTNG_DESKTOPFILE=distributionlistng.desktop
+endif
 
+kde_module_LTLIBRARIES = $(TARGET_DISTRIBUTIONLISTNG) libkaddrbk_distributionlist.la libkaddrbk_resourceselection.la
+
 XXLIBS = $(top_builddir)/kaddressbook/interfaces/libkabinterfaces.la \
          $(top_builddir)/libkdepim/libkdepim.la
 
@@ -10,13 +15,19 @@
 libkaddrbk_distributionlist_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
 libkaddrbk_distributionlist_la_LIBADD = $(XXLIBS)
 
+if compile_newdistrlists
+libkaddrbk_distributionlistng_la_SOURCES = distributionlistngwidget.cpp
+libkaddrbk_distributionlistng_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
+libkaddrbk_distributionlistng_la_LIBADD = $(XXLIBS)
+endif
+
 libkaddrbk_resourceselection_la_SOURCES = resourceselection.cpp
 libkaddrbk_resourceselection_la_LDFLAGS = -module $(KDE_PLUGIN) $(KDE_RPATH) $(all_libraries) -no-undefined
 libkaddrbk_resourceselection_la_LIBADD = $(XXLIBS)
 
-noinst_HEADERS = distributionlistwidget.h resourceselection.h
+noinst_HEADERS = distributionlistwidget.h distributionlistngwidget.h resourceselection.h
 
 METASOURCES = AUTO
 
 servicedir  = $(kde_servicesdir)/kaddressbook
-service_DATA = distributionlist.desktop resourceselection.desktop
+service_DATA = $(DISTRIBUTIONLISTNG_DESKTOPFILE) distributionlist.desktop resourceselection.desktop
Index: kaddressbook/features/distributionlistngwidget.h
===================================================================
--- kaddressbook/features/distributionlistngwidget.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kaddressbook/features/distributionlistngwidget.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,104 @@
+/*
+    This file is part of KAddressBook.
+    Copyright (c) 2007 Klaralvdalens Datakonsult AB <frank@kdab.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KAB_DISTRIBUTIONLISTNG_MAINWIDGET_H
+#define KAB_DISTRIBUTIONLISTNG_MAINWIDGET_H
+
+#include "extensionwidget.h"
+
+#include <kabc/addressee.h>
+
+#include <klistbox.h>
+
+#include <qstringlist.h>
+
+class QDragEnterEvent;
+class QDragMoveEvent;
+class QDropEvent;
+class QPoint;
+class QPushButton;
+
+namespace KABC {
+    class DistributionListManager;
+}
+
+namespace KAB {
+namespace DistributionListNg {
+
+class ListBox : public KListBox
+{
+    Q_OBJECT
+public:
+    ListBox( QWidget* parent = 0 );
+
+signals:
+
+    void dropped( const QString &listName, const KABC::Addressee::List &addressees );
+
+protected:
+    //override
+    void dragEnterEvent( QDragEnterEvent *event );
+    //override
+    void dragMoveEvent( QDragMoveEvent *event );
+    //override
+    void dropEvent( QDropEvent *event );
+};
+
+class MainWidget : public KAB::ExtensionWidget
+{
+    Q_OBJECT
+
+public:
+    explicit MainWidget( KAB::Core *core, QWidget *parent = 0, const char *name = 0 );
+
+    //impl
+    QString title() const;
+
+    //impl
+    QString identifier() const;
+
+
+private:
+    void changed( const KABC::Addressee& );
+
+private slots:
+
+    void deleteSelectedDistributionList();
+    void editSelectedDistributionList();
+
+    void contextMenuRequested( QListBoxItem *item, const QPoint &point );
+    void updateEntries();
+    void itemSelected( int index );
+    void contactsDropped( const QString &listName, const KABC::Addressee::List &addressees );
+
+private:
+    ListBox *mListBox;
+    QStringList mCurrentEntries;
+    QPushButton *mAddButton;
+    QPushButton *mEditButton;
+    QPushButton *mRemoveButton;
+};
+
+} // namespace DistributionListNg
+} // namespace KAB
+
+#endif // KAB_DISTRIBUTIONLISTNG_MAINWIDGET_H
Index: kaddressbook/features/resourceselection.cpp
===================================================================
--- kaddressbook/features/resourceselection.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kaddressbook/features/resourceselection.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,9 @@
 #include <qlayout.h>
 #include <qpushbutton.h>
 #include <qtimer.h>
+#include <qlabel.h>
+#include <qheader.h>
+#include <qtooltip.h>
 
 #include <kabc/resource.h>
 #include <kdialog.h>
@@ -363,22 +366,37 @@
 
 void ResourceSelection::initGUI()
 {
-  QGridLayout *layout = new QGridLayout( this, 2, 3, 2, 5 );
+  QBoxLayout *topLayout = new QVBoxLayout( this );
+  topLayout->setSpacing( KDialog::spacingHint() );
 
-  mListView = new KListView( this );
-  mListView->addColumn( i18n( "Address Books" ) );
-  mListView->setFullWidth( true );
-  layout->addMultiCellWidget( mListView, 0, 0, 0, 2 );
+  QBoxLayout *buttonLayout = new QHBoxLayout();
+  buttonLayout->setSpacing( KDialog::spacingHint() );
+  topLayout->addLayout( buttonLayout );
 
-  mAddButton = new QPushButton( i18n( "Add..." ), this );
-  mEditButton = new QPushButton( i18n( "Edit..." ), this );
+  QLabel *abLabel = new QLabel( i18n( "Address Books" ), this );
+  buttonLayout->addWidget( abLabel );
+  buttonLayout->addStretch( 1 );
+
+  mAddButton = new QPushButton( this );
+  mAddButton->setIconSet( SmallIconSet( "add" ) );
+  QToolTip::add( mAddButton, i18n( "Add addressbook" ) );
+  buttonLayout->addWidget( mAddButton );
+  mEditButton = new QPushButton( this );
+  mEditButton->setIconSet( SmallIconSet( "edit" ) );
   mEditButton->setEnabled( false );
-  mRemoveButton = new QPushButton( i18n( "Remove" ), this );
+  QToolTip::add( mEditButton, i18n( "Edit addressbook settings" ) );
+  buttonLayout->addWidget( mEditButton );
+  mRemoveButton = new QPushButton( this );
+  mRemoveButton->setIconSet( SmallIconSet( "remove" ) );
   mRemoveButton->setEnabled( false );
+  QToolTip::add( mRemoveButton, i18n( "Remove addressbook" ) );
+  buttonLayout->addWidget( mRemoveButton );
 
-  layout->addWidget( mAddButton, 1, 0 );
-  layout->addWidget( mEditButton, 1, 1 );
-  layout->addWidget( mRemoveButton, 1, 2 );
+  mListView = new KListView( this );
+  mListView->header()->hide();
+  mListView->addColumn( i18n( "Address Books" ) );
+  mListView->setFullWidth( true );
+  topLayout->addWidget( mListView );
 }
 
 class ResourceSelectionFactory : public KAB::ExtensionFactory
Index: libksieve/tests/parsertest.cpp
===================================================================
--- libksieve/tests/parsertest.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libksieve/tests/parsertest.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -207,8 +207,8 @@
   },
 
 #if SIZEOF_UNSIGNED_LONG == 8
-#  define ULONG_MAX_STRING "9223372036854775807"
-#  define ULONG_MAXP1_STRING "9223372036854775808"
+#  define ULONG_MAX_STRING "18446744073709551615"
+#  define ULONG_MAXP1_STRING "18446744073709551616"
 #elif SIZEOF_UNSIGNED_LONG == 4
 #  define ULONG_MAX_STRING "4294967295"
 #  define ULONG_MAXP1_STRING "4G"
Index: libkholidays/holidays/holiday_gr
===================================================================
--- libkholidays/holidays/holiday_gr	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkholidays/holidays/holiday_gr	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -279,30 +279,30 @@
 
 : ŒöŒπŒΩŒ∑œÑŒ≠œÇ ŒµŒøœÅœÑŒ≠œÇ
 
-small black "Œ§ŒµŒªœéŒΩŒøœÖ Œ∫Œ±Œπ Œ¶Œ±œÅŒπœÉŒ±ŒØŒøœÖ - ŒëœÅœáŒÆ Œ§œÅŒπœâŒ¥ŒØŒøœÖ" on easter minus 70 days
-small black "Œ§ŒøœÖ ŒëœÉœéœÑŒøœÖ" on easter minus 63 days
-small black "Œ§œÉŒπŒ∫ŒΩŒøœÄŒ≠ŒºœÄœÑŒ∑" on easter minus 59 days
-small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑœâŒΩ ŒëœÄœåŒ∫œÅŒµœâ" on easter minus 56 days
-small black "Œ§œÖœÅŒøœÜŒ¨Œ≥ŒøœÖ" on easter minus 49 days
-small black "ŒöŒ±Œ∏Œ±œÅŒÆ ŒîŒµœÖœÑŒ≠œÅŒ± (ŒëœÅŒ≥ŒØŒ±)" on easter minus 48 days
-small black "ŒòŒµœåŒ¥œâœÅŒøœÇ, ŒòŒµŒøŒ¥œéœÅŒ±, ŒîœéœÅŒ±, ŒòœéŒ¥Œ∑œÇ, ŒòœéŒ¥ŒøœÇ, ŒîœéœÅŒ∑œÇ" on easter minus 43 days
-small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑŒ∑œÇ ŒüœÅŒ∏ŒøŒ¥ŒøŒæŒØŒ±œÇ" on easter minus 42 days
-small black "Œ£Œ¨Œ≤Œ≤Œ±œÑŒø œÑŒøœÖ ŒõŒ±Œ∂Œ¨œÅŒøœÖ" on easter minus 8 days
-small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑœâŒΩ ŒíŒ±ŒêœâŒΩ" on easter minus 7 days
-small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ ŒîŒµœÖœÑŒ≠œÅŒ±" on easter minus 6 days
-small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ§œÅŒØœÑŒ∑" on easter minus 5 days
-small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ§ŒµœÑŒ¨œÅœÑŒ∑" on easter minus 4 days
-small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ†Œ≠ŒºœÄœÑŒ∑" on easter minus 3 days
-weekend "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ†Œ±œÅŒ±œÉŒ∫ŒµœÖŒÆ (ŒëœÅŒ≥ŒØŒ±)" on easter minus 2 days
-weekend "ŒúŒµŒ≥Œ¨ŒªŒø Œ£Œ¨Œ≤Œ≤Œ±œÑŒø" on easter minus 1 days
-weekend "Œ§Œø ŒÜŒ≥ŒπŒøŒΩ Œ†Œ¨œÉœáŒ±" on easter
-weekend "ŒîŒµœÖœÑŒ≠œÅŒ± œÑŒøœÖ Œ†Œ¨œÉœáŒ± (ŒëœÅŒ≥ŒØŒ±)" on easter plus 1 days
-small black "Œ†Œ∑Œ≥ŒÆ, ŒñŒÆœÉŒ∑œÇ, ŒñŒ∑œÉŒøœçŒªŒ±, ŒñŒÆœÉŒπŒºŒøœÇ, ŒñœâŒÆ, ŒñœéŒ∑œÇ" on easter plus 5 days
-small black "Œ§ŒøœÖ ŒòœâŒºŒ¨" on easter plus 7 days
-small black "ŒëŒΩŒ¨ŒªŒ∑œàŒ∑ œÑŒøœÖ ŒßœÅŒπœÉœÑŒøœç" on easter plus 39 days
-small black "Œ†ŒµŒΩœÑŒ∑Œ∫ŒøœÉœÑŒÆ" on easter plus 49 days
-small black "ŒëŒ≥. Œ†ŒΩŒµœçŒºŒ±œÑŒøœÇ" on easter plus 50 days
-small black "ŒëŒ≥. Œ†Œ¨ŒΩœÑœâŒΩ" on easter plus 56 days
+small black "Œ§ŒµŒªœéŒΩŒøœÖ Œ∫Œ±Œπ Œ¶Œ±œÅŒπœÉŒ±ŒØŒøœÖ - ŒëœÅœáŒÆ Œ§œÅŒπœâŒ¥ŒØŒøœÖ" on pascha minus 70 days
+small black "Œ§ŒøœÖ ŒëœÉœéœÑŒøœÖ" on pascha minus 63 days
+small black "Œ§œÉŒπŒ∫ŒΩŒøœÄŒ≠ŒºœÄœÑŒ∑" on pascha minus 59 days
+small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑœâŒΩ ŒëœÄœåŒ∫œÅŒµœâ" on pascha minus 56 days
+small black "Œ§œÖœÅŒøœÜŒ¨Œ≥ŒøœÖ" on pascha minus 49 days
+small black "ŒöŒ±Œ∏Œ±œÅŒÆ ŒîŒµœÖœÑŒ≠œÅŒ± (ŒëœÅŒ≥ŒØŒ±)" on pascha minus 48 days
+small black "ŒòŒµœåŒ¥œâœÅŒøœÇ, ŒòŒµŒøŒ¥œéœÅŒ±, ŒîœéœÅŒ±, ŒòœéŒ¥Œ∑œÇ, ŒòœéŒ¥ŒøœÇ, ŒîœéœÅŒ∑œÇ" on pascha minus 43 days
+small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑŒ∑œÇ ŒüœÅŒ∏ŒøŒ¥ŒøŒæŒØŒ±œÇ" on pascha minus 42 days
+small black "Œ£Œ¨Œ≤Œ≤Œ±œÑŒø œÑŒøœÖ ŒõŒ±Œ∂Œ¨œÅŒøœÖ" on pascha minus 8 days
+small black "ŒöœÖœÅŒπŒ±Œ∫ŒÆ œÑœâŒΩ ŒíŒ±ŒêœâŒΩ" on pascha minus 7 days
+small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ ŒîŒµœÖœÑŒ≠œÅŒ±" on pascha minus 6 days
+small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ§œÅŒØœÑŒ∑" on pascha minus 5 days
+small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ§ŒµœÑŒ¨œÅœÑŒ∑" on pascha minus 4 days
+small black "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ†Œ≠ŒºœÄœÑŒ∑" on pascha minus 3 days
+weekend "ŒúŒµŒ≥Œ¨ŒªŒ∑ Œ†Œ±œÅŒ±œÉŒ∫ŒµœÖŒÆ (ŒëœÅŒ≥ŒØŒ±)" on pascha minus 2 days
+weekend "ŒúŒµŒ≥Œ¨ŒªŒø Œ£Œ¨Œ≤Œ≤Œ±œÑŒø" on pascha minus 1 days
+weekend "Œ§Œø ŒÜŒ≥ŒπŒøŒΩ Œ†Œ¨œÉœáŒ±" on pascha
+weekend "ŒîŒµœÖœÑŒ≠œÅŒ± œÑŒøœÖ Œ†Œ¨œÉœáŒ± (ŒëœÅŒ≥ŒØŒ±)" on pascha plus 1 days
+small black "Œ†Œ∑Œ≥ŒÆ, ŒñŒÆœÉŒ∑œÇ, ŒñŒ∑œÉŒøœçŒªŒ±, ŒñŒÆœÉŒπŒºŒøœÇ, ŒñœâŒÆ, ŒñœéŒ∑œÇ" on pascha plus 5 days
+small black "Œ§ŒøœÖ ŒòœâŒºŒ¨" on pascha plus 7 days
+small black "ŒëŒΩŒ¨ŒªŒ∑œàŒ∑ œÑŒøœÖ ŒßœÅŒπœÉœÑŒøœç" on pascha plus 39 days
+small black "Œ†ŒµŒΩœÑŒ∑Œ∫ŒøœÉœÑŒÆ" on pascha plus 49 days
+small black "ŒëŒ≥. Œ†ŒΩŒµœçŒºŒ±œÑŒøœÇ" on pascha plus 50 days
+small black "ŒëŒ≥. Œ†Œ¨ŒΩœÑœâŒΩ" on pascha plus 56 days
 
 : ŒëŒªŒªŒ±Œ≥ŒÆ œéœÅŒ±œÇ
 small black "ŒëŒªŒªŒ±Œ≥ŒÆ œéœÅŒ±œÇ (1 œéœÅŒ± œÄŒØœÉœâ)" on last sunday in october
Index: plugins/kmail/bodypartformatter/attendeeselector.h
===================================================================
--- plugins/kmail/bodypartformatter/attendeeselector.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ plugins/kmail/bodypartformatter/attendeeselector.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,49 @@
+/*
+    Copyright (c) a2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#ifndef ATTENDEESELECTOR_H_H
+#define ATTENDEESELECTOR_H_H
+
+#include <kdialogbase.h>
+
+class AttendeeSelectorWidget;
+
+/**
+  Dialog to select a set off attendees.
+*/
+class AttendeeSelector : public KDialogBase
+{
+  Q_OBJECT
+  public:
+    AttendeeSelector( QWidget *parent = 0 );
+
+    QStringList attendees() const;
+
+  private slots:
+    void addClicked();
+    void removeClicked();
+    void textChanged( const QString &text );
+    void selectionChanged();
+
+  private:
+    AttendeeSelectorWidget *ui;
+};
+
+
+#endif
Index: plugins/kmail/bodypartformatter/delegateselector.h
===================================================================
--- plugins/kmail/bodypartformatter/delegateselector.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ plugins/kmail/bodypartformatter/delegateselector.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,49 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#ifndef DELEGATESELECTOR_H
+#define DELEGATESELECTOR_H
+
+#include <kdialogbase.h>
+
+namespace KPIM {
+  class AddresseeLineEdit;
+}
+
+class QCheckBox;
+
+/**
+  Selection dialog for a delegate.
+*/
+class DelegateSelector : public KDialogBase
+{
+  Q_OBJECT
+
+  public:
+    DelegateSelector( QWidget *parent = 0 );
+
+    QString delegate() const;
+    bool rsvp() const;
+
+  private:
+    KPIM::AddresseeLineEdit *mDelegate;
+    QCheckBox *mRsvp;
+};
+
+#endif
Index: plugins/kmail/bodypartformatter/ui_attendeeselector.ui
===================================================================
--- plugins/kmail/bodypartformatter/ui_attendeeselector.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ plugins/kmail/bodypartformatter/ui_attendeeselector.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,91 @@
+<!DOCTYPE UI><UI version="3.3" stdsetdef="1">
+<class>AttendeeSelectorWidget</class>
+<author>Volker Krause &lt;vkrause@kde.org&gt;</author>
+<widget class="QWidget">
+    <property name="name">
+        <cstring>AttendeeSelectorWidget</cstring>
+    </property>
+    <property name="geometry">
+        <rect>
+            <x>0</x>
+            <y>0</y>
+            <width>333</width>
+            <height>200</height>
+        </rect>
+    </property>
+    <property name="caption">
+        <string>AttendeeSelectorWidget</string>
+    </property>
+    <grid>
+        <property name="name">
+            <cstring>unnamed</cstring>
+        </property>
+        <widget class="KPushButton" row="0" column="1">
+            <property name="name">
+                <cstring>addButton</cstring>
+            </property>
+            <property name="enabled">
+                <bool>false</bool>
+            </property>
+            <property name="text">
+                <string>Add</string>
+            </property>
+        </widget>
+        <widget class="KPushButton" row="1" column="1">
+            <property name="name">
+                <cstring>removeButton</cstring>
+            </property>
+            <property name="enabled">
+                <bool>false</bool>
+            </property>
+            <property name="text">
+                <string>Remove</string>
+            </property>
+        </widget>
+        <widget class="KListBox" row="1" column="0" rowspan="2" colspan="1">
+            <property name="name">
+                <cstring>attendeeList</cstring>
+            </property>
+        </widget>
+        <widget class="KPIM::AddresseeLineEdit" row="0" column="0">
+            <property name="name">
+                <cstring>attendeeEdit</cstring>
+            </property>
+            <property name="minimumSize">
+                <size>
+                    <width>250</width>
+                    <height>0</height>
+                </size>
+            </property>
+        </widget>
+        <spacer row="2" column="1">
+            <property name="name">
+                <cstring>spacer1</cstring>
+            </property>
+            <property name="orientation">
+                <enum>Vertical</enum>
+            </property>
+            <property name="sizeType">
+                <enum>Expanding</enum>
+            </property>
+            <property name="sizeHint">
+                <size>
+                    <width>20</width>
+                    <height>140</height>
+                </size>
+            </property>
+        </spacer>
+    </grid>
+</widget>
+<includes>
+    <include location="global" impldecl="in declaration">libkdepim/addresseelineedit.h</include>
+</includes>
+<layoutdefaults spacing="6" margin="0"/>
+<layoutfunctions spacing="KDialog::spacingHint" margin="KDialog::marginHint"/>
+<includehints>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>kpushbutton.h</includehint>
+    <includehint>klistbox.h</includehint>
+    <includehint>libkdepim/addresseelineedit.h</includehint>
+</includehints>
+</UI>
Index: plugins/kmail/bodypartformatter/text_calendar.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ plugins/kmail/bodypartformatter/text_calendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,6 +5,7 @@
 Name[ca]=Aplicaci√≥ Octetstream
 Name[cs]=Aplikace octetstream
 Name[da]=Program oktetstr√∏m
+Name[eo]=Aplikaƒµa Bitokfluo
 Name[es]=Aplicaci√≥n en flujo de octetos
 Name[eu]=Aplikazioa/zortzikote-jarioa
 Name[fa]=Octetstream ⁄©ÿßÿ±ÿ®ÿ±ÿØ
Index: plugins/kmail/bodypartformatter/Makefile.am
===================================================================
--- plugins/kmail/bodypartformatter/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ plugins/kmail/bodypartformatter/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
            -I$(top_srcdir)/libemailfunctions \
            -I$(top_srcdir) \
            -I$(top_builddir)/libkdepim \
+           -I$(top_srcdir)/korganizer \
            $(all_includes)
 
 kde_module_LTLIBRARIES = libkmail_bodypartformatter_text_vcard.la \
@@ -21,12 +22,19 @@
                                                    ../../../libkmime/libkmime.la \
                                                    ../../../libemailfunctions/libemailfunctions.la
 
-libkmail_bodypartformatter_text_calendar_la_SOURCES = text_calendar.cpp
+libkmail_bodypartformatter_text_calendar_la_SOURCES = \
+	text_calendar.cpp \
+	delegateselector.cpp \
+	attendeeselector.cpp \
+	ui_attendeeselector.ui \
+	kcalendariface.stub
 libkmail_bodypartformatter_text_calendar_la_LDFLAGS = \
   $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
 libkmail_bodypartformatter_text_calendar_la_LIBADD  = $(LIB_QT) $(LIB_KABC) \
   $(top_builddir)/libkcal/libkcal.la $(top_builddir)/kmail/libkmailprivate.la
 
+kcalendariface_DIR = $(top_srcdir)/korganizer
+
 libkmail_bodypartformatter_text_xdiff_la_SOURCES = text_xdiff.cpp
 libkmail_bodypartformatter_text_xdiff_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
 libkmail_bodypartformatter_text_xdiff_la_LIBADD  = $(LIB_QT)
@@ -38,6 +46,7 @@
 METASOURCES = AUTO
 
 messages:
+	$(EXTRACTRC) ui_attendeeselector.ui >> ui_attendeeselector.rc.cpp
 	$(XGETTEXT) text_vcard.cpp -o $(podir)/kmail_text_vcard_plugin.pot
-	$(XGETTEXT) text_calendar.cpp -o $(podir)/kmail_text_calendar_plugin.pot
+	$(XGETTEXT) text_calendar.cpp delegateselector.cpp attendeeselector.cpp ui_attendeeselector.rc.cpp -o $(podir)/kmail_text_calendar_plugin.pot
 	$(XGETTEXT) text_xdiff.cpp -o $(podir)/kmail_text_xdiff_plugin.pot
Index: plugins/kmail/bodypartformatter/attendeeselector.cpp
===================================================================
--- plugins/kmail/bodypartformatter/attendeeselector.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ plugins/kmail/bodypartformatter/attendeeselector.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,82 @@
+/*
+    Copyright (c) a2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#include "attendeeselector.h"
+#include "ui_attendeeselector.h"
+
+#include <libkdepim/addresseelineedit.h>
+
+#include <klocale.h>
+#include <kpushbutton.h>
+
+#include <qlayout.h>
+
+AttendeeSelector::AttendeeSelector(QWidget * parent)
+  : KDialogBase( parent, 0, true, i18n("Select Attendees"), Ok|Cancel, NoDefault, true )
+{
+  ui = new AttendeeSelectorWidget( this );
+  setMainWidget( ui );
+
+  QGridLayout *layout = static_cast<QGridLayout*>( ui->layout() );
+  layout->setMargin( 0 );
+
+  ui->addButton->setGuiItem( KStdGuiItem::add() );
+  connect( ui->addButton, SIGNAL(clicked()), SLOT(addClicked()) );
+  ui->removeButton->setGuiItem( KStdGuiItem::remove() );
+  connect( ui->removeButton, SIGNAL(clicked()), SLOT(removeClicked()) );
+
+  ui->attendeeEdit->setClickMessage( i18n("Click to add a new attendee") );
+  connect( ui->attendeeEdit, SIGNAL(textChanged(const QString&)), SLOT(textChanged(const QString&)) );
+  connect( ui->attendeeEdit, SIGNAL(returnPressed(const QString&)), SLOT(addClicked()) );
+
+  connect( ui->attendeeList, SIGNAL(selectionChanged()), SLOT(selectionChanged()) );
+}
+
+QStringList AttendeeSelector::attendees() const
+{
+  QStringList rv;
+  for ( uint i = 0; i < ui->attendeeList->count(); ++i )
+    rv << ui->attendeeList->item( i )->text();
+  return rv;
+}
+
+void AttendeeSelector::addClicked()
+{
+  if ( !ui->attendeeEdit->text().isEmpty() )
+    ui->attendeeList->insertItem( ui->attendeeEdit->text() );
+  ui->attendeeEdit->clear();
+}
+
+void AttendeeSelector::removeClicked()
+{
+  if ( ui->attendeeList->currentItem() >= 0 )
+    ui->attendeeList->removeItem( ui->attendeeList->currentItem() );
+}
+
+void AttendeeSelector::textChanged( const QString &text )
+{
+  ui->addButton->setEnabled( !text.isEmpty() );
+}
+
+void AttendeeSelector::selectionChanged()
+{
+  ui->removeButton->setEnabled( ui->attendeeList->currentItem() >= 0 );
+}
+
+#include "attendeeselector.moc"
Index: plugins/kmail/bodypartformatter/text_vcard.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_vcard.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ plugins/kmail/bodypartformatter/text_vcard.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,6 +5,7 @@
 Name[ca]=Aplicaci√≥ Octetstream
 Name[cs]=Aplikace octetstream
 Name[da]=Program oktetstr√∏m
+Name[eo]=Aplikaƒµa Bitokfluo
 Name[es]=Aplicaci√≥n en flujo de octetos
 Name[eu]=Aplikazioa/zortzikote-jarioa
 Name[fa]=Octetstream ⁄©ÿßÿ±ÿ®ÿ±ÿØ
@@ -59,7 +60,7 @@
 Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûí·üí·ûú·ûæ‚Äã·ûë·üí·ûö·ûÑ·üã·ûë·üí·ûö·û∂·ûô‚Äã·ûï·üí·ûì·üÇ·ûÄ‚Äã·ûè·ûΩ ·ûü·ûò·üí·ûö·û∂·ûî·üã‚Äã·û¢·ûè·üí·ûê·ûî·ûë/vcard
 Comment[lt]= Teksto/vcard formatavimo priedas
 Comment[ms]=Plugin pemformat bahagian isi untuk teks/vcard
-Comment[nb]=Et programtilllegg for text/vcard for br√∏dtekst-formatering
+Comment[nb]=Et programtillegg for text/vcard for br√∏dtekst-formatering
 Comment[nds]=En H√∂√∂ftdeel-Formateermoduul f√∂r text/vcard
 Comment[ne]=‡§™‡§æ‡§†/‡§≠‡§ø‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§≠‡§æ‡§ó ‡§¢‡§æ‡§Å‡§ö‡§æ‡§¨‡§¶‡•ç‡§ß ‡§ó‡§∞‡•ç‡§®‡•á ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Comment[nl]=Een opmaakplugin voor text/vcard
Index: plugins/kmail/bodypartformatter/delegateselector.cpp
===================================================================
--- plugins/kmail/bodypartformatter/delegateselector.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ plugins/kmail/bodypartformatter/delegateselector.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,54 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#include "delegateselector.h"
+
+#include <libkdepim/addresseelineedit.h>
+
+#include <klocale.h>
+
+#include <qcheckbox.h>
+#include <qhbox.h>
+#include <qlabel.h>
+#include <qvbox.h>
+
+DelegateSelector::DelegateSelector(QWidget * parent)
+  : KDialogBase( parent, 0, true, i18n("Select delegate"), Ok|Cancel, Ok, true )
+{
+  QVBox *page = makeVBoxMainWidget();
+
+  QHBox *delegateBox = new QHBox( page );
+  new QLabel( i18n("Delegate:"), delegateBox );
+  mDelegate = new KPIM::AddresseeLineEdit( delegateBox );
+
+  mRsvp = new QCheckBox( i18n("Keep me informed about status changes of this incidence."), page );
+  mRsvp->setChecked( true );
+}
+
+QString DelegateSelector::delegate() const
+{
+  return mDelegate->text();
+}
+
+bool DelegateSelector::rsvp() const
+{
+  return mRsvp->isChecked();
+}
+
+#include "delegateselector.moc"
Index: plugins/kmail/bodypartformatter/text_xdiff.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,6 +5,7 @@
 Name[ca]=Aplicaci√≥ Octetstream
 Name[cs]=Aplikace octetstream
 Name[da]=Program oktetstr√∏m
+Name[eo]=Aplikaƒµa Bitokfluo
 Name[es]=Aplicaci√≥n en flujo de octetos
 Name[eu]=Aplikazioa/zortzikote-jarioa
 Name[fa]=Octetstream ⁄©ÿßÿ±ÿ®ÿ±ÿØ
@@ -57,7 +58,7 @@
 Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûí·üí·ûú·ûæ‚Äã·ûë·üí·ûö·ûÑ·üã·ûë·üí·ûö·û∂·ûô‚Äã·ûï·üí·ûì·üÇ·ûÄ‚Äã·ûè·ûΩ ·ûü·ûò·üí·ûö·û∂·ûî·üã‚Äã·û¢·ûè·üí·ûê·ûî·ûë/x-diff
 Comment[lt]=text/x-diff formatavimo priedas
 Comment[ms]=Plugin pemformat bahagian untuk teks/x-diff
-Comment[nb]=Et programtilllegg for text/x-diff for br√∏dtekst-formatering
+Comment[nb]=Et programtillegg for text/x-diff for br√∏dtekst-formatering
 Comment[nds]=En H√∂√∂ftdeel-Formateermoduul f√∂r text/x-diff
 Comment[ne]=‡§™‡§æ‡§†/x-diff ‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§≠‡§æ‡§ó ‡§¢‡§æ‡§Å‡§ö‡§æ‡§¨‡§¶‡•ç‡§ß ‡§ó‡§∞‡•ç‡§®‡•á ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Comment[nl]=Een opmaakplugin voor text/x-diff
Index: plugins/kmail/bodypartformatter/text_calendar.cpp
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ plugins/kmail/bodypartformatter/text_calendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,6 +2,7 @@
     This file is part of kdepim.
 
     Copyright (c) 2004 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
 
     This program is free software; you can redistribute it and/or modify it
     under the terms of the GNU General Public License as published by
@@ -29,12 +30,16 @@
     your version.
 */
 
+#include "attendeeselector.h"
+#include "delegateselector.h"
+
 #include <interfaces/bodypartformatter.h>
 #include <interfaces/bodypart.h>
 #include <interfaces/bodyparturlhandler.h>
 #include <khtmlparthtmlwriter.h>
 
 #include <libkcal/calendarlocal.h>
+#include <libkcal/calendarresources.h>
 #include <libkcal/icalformat.h>
 #include <libkcal/attendee.h>
 #include <libkcal/incidence.h>
@@ -49,6 +54,7 @@
 #include <email.h>
 
 #include <kglobal.h>
+#include <kinputdialog.h>
 #include <klocale.h>
 #include <kstringhandler.h>
 #include <kglobalsettings.h>
@@ -69,15 +75,55 @@
 #include <dcopclient.h>
 #include <dcopref.h>
 
+#include "kcalendariface_stub.h"
+
 using namespace KCal;
 
 namespace {
 
+class CalendarManager
+{
+  public:
+    CalendarManager();
+    ~CalendarManager();
+    static KCal::Calendar* calendar();
+
+  private:
+    KCal::CalendarResources* mCalendar;
+    static CalendarManager* mSelf;
+};
+
+static KStaticDeleter<CalendarManager> sCalendarDeleter;
+CalendarManager* CalendarManager::mSelf = 0;
+
+CalendarManager::CalendarManager()
+{
+  mCalendar = new CalendarResources( KPimPrefs::timezone() );
+  mCalendar->readConfig();
+  mCalendar->load();
+}
+
+CalendarManager::~CalendarManager()
+{
+  delete mCalendar;
+  mSelf = 0;
+}
+
+KCal::Calendar* CalendarManager::calendar()
+{
+  if ( !mSelf ) {
+    sCalendarDeleter.setObject( mSelf, new CalendarManager() );
+  }
+  return mSelf->mCalendar;
+}
+
+
 class KMInvitationFormatterHelper : public KCal::InvitationFormatterHelper
 {
   public:
     KMInvitationFormatterHelper( KMail::Interface::BodyPart *bodyPart ) : mBodyPart( bodyPart ) {}
     virtual QString generateLinkURL( const QString &id ) { return mBodyPart->makeLink( id ); }
+    KCal::Calendar* calendar() const { return CalendarManager::calendar(); }
   private:
     KMail::Interface::BodyPart *mBodyPart;
 };
@@ -112,6 +158,28 @@
     }
 };
 
+static QString directoryForStatus( Attendee::PartStat status )
+{
+  QString dir;
+  switch ( status ) {
+  case Attendee::Accepted:
+    dir = "accepted";
+    break;
+  case Attendee::Tentative:
+    dir = "tentative";
+    break;
+  case Attendee::Declined:
+    dir = "cancel";
+    break;
+  case Attendee::Delegated:
+    dir = "delegated";
+    break;
+  default:
+    break;
+  }
+  return dir;
+}
+
 class UrlHandler : public KMail::Interface::BodyPartURLHandler
 {
   public:
@@ -140,18 +208,13 @@
       Attendee* myself = 0;
       // Find myself. There will always be all attendees listed, even if
       // only I need to answer it.
-      if ( attendees.count() == 1 )
-        // Only one attendee, that must be me
-        myself = *attendees.begin();
-      else {
-        for ( it = attendees.begin(); it != attendees.end(); ++it ) {
-          // match only the email part, not the name
-          if( KPIM::compareEmail( (*it)->email(), receiver, false ) ) {
-            // We are the current one, and even the receiver, note
-            // this and quit searching.
-            myself = (*it);
-            break;
-          }
+      for ( it = attendees.begin(); it != attendees.end(); ++it ) {
+        // match only the email part, not the name
+        if( KPIM::compareEmail( (*it)->email(), receiver, false ) ) {
+          // We are the current one, and even the receiver, note
+          // this and quit searching.
+          myself = (*it);
+          break;
         }
       }
       return myself;
@@ -194,7 +257,7 @@
 
     }
 
-    void setStatusOnMyself( Incidence* incidence, Attendee* myself,
+    Attendee* setStatusOnMyself( Incidence* incidence, Attendee* myself,
                             Attendee::PartStat status, const QString &receiver ) const
     {
       Attendee* newMyself = 0;
@@ -210,45 +273,57 @@
                                 status,
                                 myself ? myself->role() : heuristicalRole( incidence ),
                                 myself ? myself->uid() : QString::null );
+      if ( myself ) {
+        newMyself->setDelegate( myself->delegate() );
+        newMyself->setDelegator( myself->delegator() );
+      }
 
       // Make sure only ourselves is in the event
       incidence->clearAttendees();
       if( newMyself )
         incidence->addAttendee( newMyself );
+      return newMyself;
     }
 
-    bool mail( Incidence* incidence, KMail::Callback& callback, const QString &status ) const
+    enum MailType {
+      Answer,
+      Delegation,
+      Forward
+    };
+
+    bool mail( Incidence* incidence, KMail::Callback& callback,
+               Attendee::PartStat status,
+               Scheduler::Method method = Scheduler::Reply,
+               const QString &to = QString::null, MailType type = Answer ) const
     {
-      //status is accepted/tentative/declined
       ICalFormat format;
       format.setTimeZone( KPimPrefs::timezone(), false );
-      QString msg = format.createScheduleMessage( incidence,
-                                                  Scheduler::Reply );
-      kdDebug() << "scheduler::REPly=" << Scheduler::Reply << endl;
+      QString msg = format.createScheduleMessage( incidence, method );
+      QString summary = incidence->summary();
+      if ( summary.isEmpty() )
+        summary = i18n( "Incidence with no summary" );
       QString subject;
-      if ( !incidence->summary().isEmpty() )
-        subject = i18n( "Answer: %1" ).arg( incidence->summary() );
-      else
-        subject = i18n( "Answer: Incidence with no summary" );
-      return callback.mailICal( incidence->organizer().fullName(), msg, subject, status );
+      switch ( type ) {
+        case Answer:
+          subject = i18n( "Answer: %1" ).arg( summary );
+          break;
+        case Delegation:
+          subject = i18n( "Delegated: %1" ).arg( summary );
+          break;
+        case Forward:
+          subject = i18n( "Forwarded: %1" ).arg( summary );
+          break;
+      }
+
+      QString recv = to;
+      if ( recv.isEmpty() )
+        recv = incidence->organizer().fullName();
+      QString statusString = directoryForStatus( status );  //it happens to return the right strings
+      return callback.mailICal( recv, msg, subject, statusString, type != Forward );
     }
 
-    bool saveFile( const QString& receiver, const QString& iCal,
-                   const QString& type ) const
+    void ensureKorganizerRunning() const
     {
-      KTempFile file( locateLocal( "data", "korganizer/income." + type + '/',
-                                   true ) );
-      QTextStream* ts = file.textStream();
-      if ( !ts ) {
-        KMessageBox::error( 0, i18n("Could not save file to KOrganizer") );
-        return false;
-      }
-      ts->setEncoding( QTextStream::UnicodeUTF8 );
-      (*ts) << receiver << '\n' << iCal;
-      file.close();
-
-      // Now ensure that korganizer is running; otherwise start it, to prevent surprises
-      // (https://intevation.de/roundup/kolab/issue758)
       QString error;
       QCString dcopService;
       int result = KDCOPServiceStarter::self()->findServiceFor( "DCOP/Organizer", QString::null, QString::null, &error, &dcopService );
@@ -272,7 +347,26 @@
       }
       else
         kdWarning() << "Couldn't start DCOP/Organizer: " << dcopService << " " << error << endl;
+    }
 
+    bool saveFile( const QString& receiver, const QString& iCal,
+                   const QString& type ) const
+    {
+      KTempFile file( locateLocal( "data", "korganizer/income." + type + '/',
+                                   true ) );
+      QTextStream* ts = file.textStream();
+      if ( !ts ) {
+        KMessageBox::error( 0, i18n("Could not save file to KOrganizer") );
+        return false;
+      }
+      ts->setEncoding( QTextStream::UnicodeUTF8 );
+      (*ts) << receiver << '\n' << iCal;
+      file.close();
+
+      // Now ensure that korganizer is running; otherwise start it, to prevent surprises
+      // (https://intevation.de/roundup/kolab/issue758)
+      ensureKorganizerRunning();
+
       return true;
     }
 
@@ -281,34 +375,141 @@
     {
       bool ok = true;
       const QString receiver = callback.receiver();
+
       if ( receiver.isEmpty() )
         // Must be some error. Still return true though, since we did handle it
         return true;
 
+      // get comment for tentative acceptance
+      Incidence* incidence = icalToString( iCal );
+
+      if ( callback.askForComment( status ) ) {
+        bool ok = false;
+        QString comment = KInputDialog::getMultiLineText( i18n("Reaction to Invitation"),
+            i18n("Comment:"), QString(), &ok );
+        if ( !ok )
+          return true;
+        if ( !comment.isEmpty() )
+          incidence->addComment( comment );
+      }
+
       // First, save it for KOrganizer to handle
-      QString dir;
-      if ( status == Attendee::Accepted ) dir = "accepted";
-      else if ( status == Attendee::Tentative  ) dir = "tentative";
-      else if ( status == Attendee::Declined ) dir = "cancel";
-      else return true; // unknown status
+      QString dir = directoryForStatus( status );
+      if ( dir.isEmpty() )
+        return true; // unknown status
+      if ( status != Attendee::Delegated ) // we do that below for delegated incidences
+        saveFile( receiver, iCal, dir );
 
-      saveFile( receiver, iCal, dir );
+      QString delegateString;
+      bool delegatorRSVP = false;
+      if ( status == Attendee::Delegated ) {
+        DelegateSelector dlg;
+        if ( dlg.exec() == QDialog::Rejected )
+          return true;
+        delegateString = dlg.delegate();
+        delegatorRSVP = dlg.rsvp();
+        if ( delegateString.isEmpty() )
+          return true;
+        if ( KPIM::compareEmail( delegateString, incidence->organizer().email(), false ) ) {
+          KMessageBox::sorry( 0, i18n("Delegation to organizer is not possible.") );
+          return true;
+        }
+      }
 
-      // Now produce the return message
-      Incidence* incidence = icalToString( iCal );
-
       if( !incidence ) return false;
       Attendee *myself = findMyself( incidence, receiver );
+
+      // find our delegator, we need to inform him as well
+      QString delegator;
+      if ( myself && !myself->delegator().isEmpty() ) {
+        Attendee::List attendees = incidence->attendees();
+        for ( Attendee::List::ConstIterator it = attendees.constBegin(); it != attendees.constEnd(); ++it ) {
+          if( KPIM::compareEmail( (*it)->fullName(), myself->delegator(), false ) && (*it)->status() == Attendee::Delegated ) {
+            delegator = (*it)->fullName();
+            delegatorRSVP = (*it)->RSVP();
+            break;
+          }
+        }
+      }
+
       if ( ( myself && myself->RSVP() ) || heuristicalRSVP( incidence ) ) {
-        setStatusOnMyself( incidence, myself, status, receiver );
-        ok =  mail( incidence, callback, dir );
+        Attendee* newMyself = setStatusOnMyself( incidence, myself, status, receiver );
+        if ( newMyself && status == Attendee::Delegated ) {
+          newMyself->setDelegate( delegateString );
+          newMyself->setRSVP( delegatorRSVP );
+        }
+        ok = mail( incidence, callback, status );
+
+        // check if we need to inform our delegator about this as well
+        if ( newMyself && (status == Attendee::Accepted || status == Attendee::Declined)
+             && !delegator.isEmpty() ) {
+          if ( delegatorRSVP || status == Attendee::Declined )
+            ok = mail( incidence, callback, status, Scheduler::Reply, delegator );
+        }
+
+      } else if ( !myself && (status != Attendee::Declined) ) {
+        // forwarded invitation
+        Attendee* newMyself = 0;
+        QString name;
+        QString email;
+        KPIM::getNameAndMail( receiver, name, email );
+        if ( !email.isEmpty() ) {
+          newMyself = new Attendee( name,
+                                    email,
+                                    true, // RSVP, otherwise we would not be here
+                                    status,
+                                    heuristicalRole( incidence ),
+                                    QString::null );
+          incidence->clearAttendees();
+          incidence->addAttendee( newMyself );
+          ok = mail( incidence, callback, status, Scheduler::Reply );
+        }
       } else {
-        ( new KMDeleteMsgCommand( callback.getMsg()->getMsgSerNum() ) )->start();
+        if ( callback.deleteInvitationAfterReply() )
+          ( new KMDeleteMsgCommand( callback.getMsg()->getMsgSerNum() ) )->start();
       }
       delete incidence;
+
+      // create invitation for the delegate (same as the original invitation
+      // with the delegate as additional attendee), we also use that for updating
+      // our calendar
+      if ( status == Attendee::Delegated ) {
+        incidence = icalToString( iCal );
+        myself = findMyself( incidence, receiver );
+        myself->setStatus( status );
+        myself->setDelegate( delegateString );
+        QString name, email;
+        KPIM::getNameAndMail( delegateString, name, email );
+        Attendee *delegate = new Attendee( name, email, true );
+        delegate->setDelegator( receiver );
+        incidence->addAttendee( delegate );
+
+        ICalFormat format;
+        format.setTimeZone( KPimPrefs::timezone(), false );
+        QString iCal = format.createScheduleMessage( incidence, Scheduler::Request );
+        saveFile( receiver, iCal, dir );
+
+        ok = mail( incidence, callback, status, Scheduler::Request, delegateString, Delegation );
+      }
       return ok;
     }
 
+    void showCalendar( const QDate &date ) const
+    {
+      ensureKorganizerRunning();
+      // raise korganizer part in kontact or the korganizer app
+      kapp->dcopClient()->send( "korganizer", "korganizer", "newInstance()", QByteArray() );
+      QByteArray arg;
+      QDataStream s( arg, IO_WriteOnly );
+      s << QString( "kontact_korganizerplugin" );
+      kapp->dcopClient()->send( "kontact", "KontactIface", "selectPlugin(QString)", arg );
+
+      KCalendarIface_stub *iface = new KCalendarIface_stub( kapp->dcopClient(), "korganizer", "CalendarIface" );
+      iface->showEventView();
+      iface->showDate( date );
+      delete iface;
+    }
+
     bool handleIgnore( const QString&, KMail::Callback& c ) const
     {
       // simply move the message to trash
@@ -316,6 +517,17 @@
       return true;
     }
 
+    bool counterProposal( const QString &iCal, KMail::Callback &callback ) const
+    {
+      const QString receiver = callback.receiver();
+      if ( receiver.isEmpty() )
+        return true;
+      saveFile( receiver, iCal, "counter" );
+      if ( callback.deleteInvitationAfterReply() )
+        ( new KMDeleteMsgCommand( callback.getMsg()->getMsgSerNum() ) )->start();
+      return true;
+    }
+
     bool handleClick( KMail::Interface::BodyPart *part,
                       const QString &path, KMail::Callback& c ) const
     {
@@ -325,14 +537,34 @@
         result = handleInvitation( iCal, Attendee::Accepted, c );
       if ( path == "accept_conditionally" )
         result = handleInvitation( iCal, Attendee::Tentative, c );
+      if ( path == "counter" )
+        result = counterProposal( iCal, c );
       if ( path == "ignore" )
         result = handleIgnore( iCal, c );
       if ( path == "decline" )
         result = handleInvitation( iCal, Attendee::Declined, c );
+      if ( path == "delegate" )
+        result = handleInvitation( iCal, Attendee::Delegated, c );
+      if ( path == "forward" ) {
+        Incidence* incidence = icalToString( iCal );
+        AttendeeSelector dlg;
+        if ( dlg.exec() == QDialog::Rejected )
+          return true;
+        QString fwdTo = dlg.attendees().join( ", " );
+        if ( fwdTo.isEmpty() )
+          return true;
+        result = mail( incidence, c, Attendee::Delegated /*### right ?*/,
+                       Scheduler::Request, fwdTo, Forward );
+      }
+      if ( path == "check_calendar" ) {
+        Incidence* incidence = icalToString( iCal );
+        showCalendar( incidence->dtStart().date() );
+      }
       if ( path == "reply" || path == "cancel" ) {
         // These should just be saved with their type as the dir
         if ( saveFile( "Receiver Not Searched", iCal, path ) ) {
-          ( new KMDeleteMsgCommand( c.getMsg()->getMsgSerNum() ) )->start();
+          if ( c.deleteInvitationAfterReply() )
+            ( new KMDeleteMsgCommand( c.getMsg()->getMsgSerNum() ) )->start();
           result = true;
         }
       }
@@ -356,6 +588,8 @@
           return i18n("Accept incidence");
         if ( path == "accept_conditionally" )
           return i18n( "Accept incidence conditionally" );
+        if ( path == "counter" )
+          return i18n( "Create a counter proposal..." );
         if ( path == "ignore" )
           return i18n( "Throw mail away" );
         if ( path == "decline" )
@@ -364,6 +598,10 @@
           return i18n("Check my calendar..." );
         if ( path == "reply" )
           return i18n( "Enter incidence into my calendar" );
+        if ( path == "delegate" )
+          return i18n( "Delegate incidence" );
+        if ( path == "forward" )
+          return i18n( "Forward incidence" );
         if ( path == "cancel" )
           return i18n( "Remove incidence from my calendar" );
       }
Index: kitchensync/src/kitchensync.desktop
===================================================================
--- kitchensync/src/kitchensync.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kitchensync/src/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 GenericName[da]=Synkronisering
 GenericName[de]=Abgleich
 GenericName[el]=Œ£œÖŒ≥œáœÅŒøŒΩŒπœÉŒºœåœÇ
+GenericName[eo]=Sinkronigo
 GenericName[es]=Sincronizaci√≥n
 GenericName[et]=S√ºnkroniseerimine
 GenericName[eu]=Sinkronizazioa
Index: libkdepim/kdateedit.h
===================================================================
--- libkdepim/kdateedit.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kdateedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,6 +2,7 @@
     This file is part of libkdepim.
 
     Copyright (c) 2002 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2002 David Jarvie <software@astrojar.org.uk>
     Copyright (c) 2004 Tobias Koenig <tokoe@kde.org>
 
     This library is free software; you can redistribute it and/or
@@ -81,6 +82,14 @@
 
   signals:
     /**
+      This signal is emitted whenever the user has entered a new date.
+      When the user changes the date by editing the line edit field,
+      the signal is not emitted until focus leaves the line edit field.
+      The passed date can be invalid.
+     */
+    void dateEntered( const QDate &date );
+
+    /**
       This signal is emitted whenever the user modifies the date.
       The passed date can be invalid.
      */
@@ -98,7 +107,6 @@
   protected slots:
     void lineEnterPressed();
     void slotTextChanged( const QString& );
-    void dateEntered( QDate );
     void dateSelected( QDate );
 
   protected:
Index: libkdepim/kprefsdialog.cpp
===================================================================
--- libkdepim/kprefsdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kprefsdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -439,7 +439,42 @@
   return w;
 }
 
+KPrefsWidCombo::KPrefsWidCombo( KConfigSkeleton::ItemEnum *item,
+                                  QWidget *parent )
+  : mItem( item )
+{
+  QHBox *hbox = new QHBox(parent);
+  new QLabel( mItem->label(), hbox );
+  mCombo = new QComboBox( hbox );
+  connect( mCombo, SIGNAL( activated( int ) ), SIGNAL( changed() ) );
+}
 
+KPrefsWidCombo::~KPrefsWidCombo()
+{
+}
+
+void KPrefsWidCombo::readConfig()
+{
+  mCombo->setCurrentItem( mItem->value() );
+}
+
+void KPrefsWidCombo::writeConfig()
+{
+  mItem->setValue( mCombo->currentItem() );
+}
+
+QValueList<QWidget *> KPrefsWidCombo::widgets() const
+{
+  QValueList<QWidget *> w;
+  w.append( mCombo );
+  return w;
+}
+
+QComboBox* KPrefsWidCombo::comboBox()
+{
+  return mCombo;
+}
+
 KPrefsWidString::KPrefsWidString( KConfigSkeleton::ItemString *item,
                                   QWidget *parent,
                                   QLineEdit::EchoMode echomode )
@@ -608,6 +643,20 @@
   return w;
 }
 
+KPrefsWidCombo *KPrefsWidManager::addWidCombo( KConfigSkeleton::ItemEnum *item,
+                                               QWidget* parent )
+{
+  KPrefsWidCombo *w = new KPrefsWidCombo( item, parent );
+  QValueList<KConfigSkeleton::ItemEnum::Choice> choices;
+  choices = item->choices();
+  QValueList<KConfigSkeleton::ItemEnum::Choice>::ConstIterator it;
+  for( it = choices.begin(); it != choices.end(); ++it ) {
+    w->comboBox()->insertItem( (*it).label, -1 );
+  }
+  addWid( w );
+  return w;
+}
+
 KPrefsWidString *KPrefsWidManager::addWidString( KConfigSkeleton::ItemString *item,
                                                  QWidget *parent )
 {
Index: libkdepim/addresseelineedit.h
===================================================================
--- libkdepim/addresseelineedit.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/addresseelineedit.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -61,6 +61,7 @@
     virtual ~AddresseeLineEdit();
 
     virtual void setFont( const QFont& );
+    void allowSemiColonAsSeparator( bool );
 
   public slots:
     void cursorAtEnd();
@@ -92,12 +93,12 @@
     virtual QPopupMenu *createPopupMenu();
 
     /**
-     * Adds the name of a completion source to the internal list of 
+     * Adds the name of a completion source to the internal list of
      * such sources and returns its index, such that that can be used
      * for insertion of items associated with that source.
      */
     int addCompletionSource( const QString& );
-    
+
     /** return whether we are using sorted or weighted display */
     static KCompletion::CompOrder completionOrder();
 
@@ -134,6 +135,7 @@
     bool m_addressBookConnected;
     bool m_lastSearchMode;
     bool m_searchExtended; //has \" been added?
+    bool m_useSemiColonAsSeparator;
 
     //QMap<QString, KABC::Addressee> m_contactMap;
 
Index: libkdepim/categoryeditdialog.cpp
===================================================================
--- libkdepim/categoryeditdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/categoryeditdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -43,6 +43,20 @@
     QPushButton *mDeleteButton;
 };
 
+class CategoryListViewItem : public QListViewItem
+{
+  public:
+    CategoryListViewItem( QListView *view, const QString &text ) :
+      QListViewItem( view, text )
+    {
+    }
+
+    void okRename ( int col ) // we need that public to explicitly accept renaming when closing the dialog
+    {
+      QListViewItem::okRename( col );
+    }
+};
+
 CategoryEditDialog::CategoryEditDialog( KPimPrefs *prefs, QWidget* parent,
                                         const char* name, bool modal )
   : KDialogBase::KDialogBase( parent, name, modal,
@@ -57,6 +71,7 @@
   d->mView = new QListView( widget );
   d->mView->addColumn( "" );
   d->mView->header()->hide();
+  d->mView->setDefaultRenameAction( QListView::Accept );
 
   layout->addMultiCellWidget( d->mView, 0, 3, 0, 0 );
 
@@ -93,7 +108,7 @@
   for ( it = mPrefs->mCustomCategories.begin();
         it != mPrefs->mCustomCategories.end(); ++it ) {
 
-    QListViewItem *item = new QListViewItem( d->mView, *it );
+    QListViewItem *item = new CategoryListViewItem( d->mView, *it );
     item->setRenameEnabled( 0, true );
 
     categoriesExist = true;
@@ -109,7 +124,7 @@
   if ( d->mView->firstChild() )
     d->mView->setCurrentItem( d->mView->firstChild() );
 
-  QListViewItem *item = new QListViewItem( d->mView, i18n( "New category" ) );
+  QListViewItem *item = new CategoryListViewItem( d->mView, i18n( "New category" ) );
   item->setRenameEnabled( 0, true );
 
   d->mView->setSelected( item, true );
@@ -142,6 +157,9 @@
 
 void CategoryEditDialog::slotOk()
 {
+  // accept the currently ongoing rename
+  if ( d->mView->selectedItem() )
+    static_cast<CategoryListViewItem*>( d->mView->selectedItem() )->okRename( 0 );
   slotApply();
   accept();
 }
Index: libkdepim/kprefsdialog.h
===================================================================
--- libkdepim/kprefsdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kprefsdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -37,6 +37,7 @@
 
 class KColorButton;
 class QCheckBox;
+class QComboBox;
 class QLabel;
 class QSpinBox;
 class QButtonGroup;
@@ -411,7 +412,42 @@
     QButtonGroup *mBox;
 };
 
+/**
+  @short Widgets for settings represented by a combo box in
+  @ref KPrefsDialog.
 
+  This class provides a control element for configuring selections. It is meant
+  to be used by KPrefsDialog. The user is responsible for the layout management.
+
+  The setting is interpreted as an int value, corresponding to the index in 
+  the combo box.
+*/
+class KDE_EXPORT KPrefsWidCombo : public KPrefsWid
+{
+  public:
+    /**
+      Create a control element for selection of an option. It consists of a
+      combo box.
+
+      @param item    The KConfigSkeletonItem representing the preferences entry.
+      @param parent  Parent widget.
+    */
+    KPrefsWidCombo( KConfigSkeleton::ItemEnum *item, QWidget *parent );
+    virtual ~KPrefsWidCombo();
+
+    void readConfig();
+    void writeConfig();
+
+    QComboBox *comboBox();
+    QValueList<QWidget *> widgets() const;
+
+  private:
+    KConfigSkeleton::ItemEnum *mItem;
+    QComboBox *mCombo;
+};
+
+
+
 /**
   @short Widgets for string settings in @ref KPrefsDialog.
 
@@ -601,6 +637,16 @@
                                    QWidget *parent );
 
     /**
+      Register a @ref KPrefsWidCombo object. The choices represented by the
+      given item object are automatically added to the combo box.
+
+      @param item    The KConfigSkeletonItem representing the preferences entry.
+      @param parent  Parent widget.
+    */
+    KPrefsWidCombo *addWidCombo( KConfigSkeleton::ItemEnum *item,
+                                   QWidget *parent );
+
+    /**
       Register a @ref KPrefsWidString object.
 
       @param item    The KConfigSkeletonItem representing the preferences entry.
Index: libkdepim/kscoringeditor.cpp
===================================================================
--- libkdepim/kscoringeditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kscoringeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -428,6 +428,8 @@
   expireCheck = new QCheckBox(i18n("&Expire rule automatically"), groupB);
   groupL->addMultiCellWidget( expireCheck, 4,4, 0,1 );
   expireEdit = new KIntSpinBox(1,99999,1,30,10, groupB, "expireWidget");
+  //Init suffix
+  slotExpireEditChanged(30);
   connect(expireEdit, SIGNAL(valueChanged(int)), SLOT(slotExpireEditChanged(int)));
   groupL->addWidget( expireEdit, 5, 1 );
   expireLabel = new QLabel(expireEdit, i18n("&Rule is valid for:"), groupB, "expireLabel");
Index: libkdepim/csshelper.cpp
===================================================================
--- libkdepim/csshelper.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/csshelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -282,6 +282,10 @@
                "div.senderstatus{\n"
                "  text-align:center ! important;\n"
                "}\n\n"
+
+               "div.noprint {\n"
+               "  display:none ! important;\n"
+               "}\n\n"
             )
       .arg( headerFont,
             cg.background().name(),
@@ -359,6 +363,10 @@
                "  text-decoration: none ! important;\n"
                "}\n\n"
 
+               "a.white {\n"
+               "  color: white ! important;\n"
+               "}\n\n"
+
                "table.textAtm { background-color: %2 ! important; }\n\n"
 
                "tr.textAtmH {\n"
@@ -611,4 +619,15 @@
       ;
   }
 
+
+  void CSSHelper::setBodyFont( const QFont& font )
+  {
+    mBodyFont = font;
+  }
+
+  void CSSHelper::setPrintFont( const QFont& font )
+  {
+    mPrintFont = font;
+  }
+
 } // namespace KPIM
Index: libkdepim/addresseeview.cpp
===================================================================
--- libkdepim/addresseeview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/addresseeview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,6 +27,7 @@
 #include <kabc/address.h>
 #include <kabc/addressee.h>
 #include <kabc/phonenumber.h>
+#include <kabc/resource.h>
 #include <kactionclasses.h>
 #include <kapplication.h>
 #include <kconfig.h>
@@ -222,7 +223,7 @@
     KABC::PhoneNumber::List phones = addr.phoneNumbers();
     KABC::PhoneNumber::List::ConstIterator phoneIt;
     for ( phoneIt = phones.begin(); phoneIt != phones.end(); ++phoneIt ) {
-      QString number = (*phoneIt).number();
+      QString number = QStyleSheet::escape( (*phoneIt).number() );
 
       QString url;
       if ( (*phoneIt).type() & KABC::PhoneNumber::Fax )
@@ -236,11 +237,11 @@
           smsURL = QString(" (<a href=\"sms:%1\">%2</a>)" ).arg( number ).arg( i18n( "SMS") );
 
         dynamicPart += rowFmtStr
-          .arg( KABC::PhoneNumber::typeLabel( (*phoneIt).type() ).replace( " ", "&nbsp;" ) )
+          .arg( (*phoneIt).typeLabel().replace( " ", "&nbsp;" ) )
           .arg( QString::fromLatin1( "<a href=\"%1\">%2</a>%3" ).arg( url ).arg( number ).arg( smsURL ) );
       } else {
         dynamicPart += rowFmtStr
-          .arg( KABC::PhoneNumber::typeLabel( (*phoneIt).type() ).replace( " ", "&nbsp;" ) )
+          .arg( (*phoneIt).typeLabel().replace( " ", "&nbsp;" ) )
           .arg( number );
       }
     }
@@ -257,7 +258,7 @@
       if ( linkMask & EmailLinks ) {
         dynamicPart += rowFmtStr.arg( type )
           .arg( QString::fromLatin1( "<a href=\"mailto:%1\">%2</a>" )
-          .arg( fullEmail, *emailIt ) );
+          .arg( fullEmail, QStyleSheet::escape( *emailIt ) ) );
       } else {
         dynamicPart += rowFmtStr.arg( type ).arg( *emailIt );
       }
@@ -293,28 +294,7 @@
       if ( (*addrIt).label().isEmpty() ) {
         QString formattedAddress;
 
-#if KDE_IS_VERSION(3,1,90)
-        formattedAddress = (*addrIt).formattedAddress().stripWhiteSpace();
-#else
-        if ( !(*addrIt).street().isEmpty() )
-          formattedAddress += (*addrIt).street() + "\n";
-
-        if ( !(*addrIt).postOfficeBox().isEmpty() )
-          formattedAddress += (*addrIt).postOfficeBox() + "\n";
-
-        formattedAddress += (*addrIt).locality() + QString::fromLatin1(" ") + (*addrIt).region();
-
-        if ( !(*addrIt).postalCode().isEmpty() )
-          formattedAddress += QString::fromLatin1(", ") + (*addrIt).postalCode();
-
-        formattedAddress += "\n";
-
-        if ( !(*addrIt).country().isEmpty() )
-          formattedAddress += (*addrIt).country() + "\n";
-
-        formattedAddress += (*addrIt).extended();
-#endif
-
+        formattedAddress = QStyleSheet::escape( (*addrIt).formattedAddress().stripWhiteSpace() );
         formattedAddress = formattedAddress.replace( '\n', "<br>" );
 
         QString link = "<a href=\"addr:" + (*addrIt).id() + "\">" +
@@ -351,7 +331,8 @@
     // @STYLE@ - substitute the cell style in first, and append
     // the data afterwards (keeps us safe from possible % signs
     // in either one).
-    notes = rowFmtStr.arg( i18n( "Notes" ) ).arg( addr.note().replace( '\n', "<br>" ) ) ;
+    notes = QStyleSheet::escape( addr.note() );
+    notes = rowFmtStr.arg( i18n( "Notes" ) ).arg( notes.replace( '\n', "<br>" ) ) ;
   }
 
   QString customData;
@@ -389,21 +370,21 @@
           if ( keyIt != titleMap.end() )
             key = keyIt.data();
 
-          customData += rowFmtStr.arg( key ).arg( value ) ;
+          customData += rowFmtStr.arg( key ).arg( QStyleSheet::escape( value ) ) ;
         }
       }
     }
   }
 
-  QString name( addr.realName() );
-  QString role( addr.role() );
-  QString organization( addr.organization() );
+  QString name( QStyleSheet::escape( addr.realName() ) );
+  QString role( QStyleSheet::escape( addr.role() ) );
+  QString organization( QStyleSheet::escape( addr.organization() ) );
 
   if ( fieldMask & IMFields ) {
 
     const QString imAddress = addr.custom( "KADDRESSBOOK", "X-IMAddress" );
     if ( !imAddress.isEmpty() ) {
-      customData += rowFmtStr.arg( i18n( "IM Address" ) ).arg( imAddress ) ;
+      customData += rowFmtStr.arg( i18n( "IM Address" ) ).arg( QStyleSheet::escape( imAddress ) ) ;
     }
 
     if ( proxy ) {
@@ -485,6 +466,8 @@
   strAddr.append( customData );
   strAddr.append( QString::fromLatin1( "</table></div>\n" ) );
 
+  if ( addr.resource() )
+      strAddr.append( i18n( "<p><b>Address book</b>: %1</p>" ).arg( addr.resource()->resourceName() ) );
   return strAddr;
 }
 
Index: libkdepim/kfoldertree.cpp
===================================================================
--- libkdepim/kfoldertree.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kfoldertree.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,6 +2,7 @@
 
 #include "kfoldertree.h"
 #include <klocale.h>
+#include <kio/global.h>
 #include <kiconloader.h>
 #include <kdebug.h>
 #include <kstringhandler.h>
@@ -14,7 +15,7 @@
 KFolderTreeItem::KFolderTreeItem( KFolderTree *parent, const QString & label,
 				  Protocol protocol, Type type )
   : KListViewItem( parent, label ), mProtocol( protocol ), mType( type ),
-    mUnread(-1), mTotal(0)
+    mUnread(-1), mTotal(0), mSize(0), mFolderIsCloseToQuota( false )
 {
 }
 
@@ -23,7 +24,7 @@
 				  const QString & label, Protocol protocol, Type type,
           int unread, int total )
     : KListViewItem( parent, label ), mProtocol( protocol ), mType( type ),
-      mUnread( unread ), mTotal( total )
+      mUnread( unread ), mTotal( total ), mSize(0), mFolderIsCloseToQuota( false )
 {
 }
 
@@ -117,7 +118,7 @@
   else
   {
     // sort by unread or total-column
-    int a = 0, b = 0;
+    Q_INT64 a = 0, b = 0;
     if (col == static_cast<KFolderTree*>(listView())->unreadIndex())
     {
       a = mUnread;
@@ -128,6 +129,11 @@
       a = mTotal;
       b = other->totalCount();
     }
+    else if (col == static_cast<KFolderTree*>(listView())->sizeIndex())
+    {
+      a = mSize;
+      b = other->folderSize();
+    }
 
     if ( a == b )
       return 0;
@@ -175,6 +181,49 @@
 }
 
 //-----------------------------------------------------------------------------
+void KFolderTreeItem::setFolderSize( Q_INT64 aSize )
+{
+  if ( aSize < 0 ) return;  // we need to update even if nothing changed, kids ...
+
+  mSize = aSize;
+
+  QString size;
+  if (mType != Root) {
+      if (mSize == 0 && (childCount() == 0 || isOpen() ) )
+          size = "- ";
+      else
+          size = KIO::convertSize(mSize);
+  }
+  if ( childCount() > 0 && !isOpen() ) {
+      Q_INT64 recursiveSize = recursiveFolderSize();
+      if ( recursiveSize != mSize ) {
+            if ( mType != Root )
+                size += QString::fromLatin1(" + %1").arg( KIO::convertSize( recursiveSize - mSize ) );
+            else 
+                size = KIO::convertSize( recursiveSize );
+      }
+  }
+  size += " ";
+
+  setText( static_cast<KFolderTree*>(listView())->sizeIndex(), size );
+}
+
+//-----------------------------------------------------------------------------
+Q_INT64 KFolderTreeItem::recursiveFolderSize() const
+{
+  Q_INT64 size = mSize;
+
+  for ( QListViewItem *item = firstChild() ;
+      item ; item = item->nextSibling() )
+  {
+    size += static_cast<KFolderTreeItem*>(item)->recursiveFolderSize();
+  }
+  return size;
+}
+
+
+
+//-----------------------------------------------------------------------------
 int KFolderTreeItem::countUnreadRecursive()
 {
   int count = (mUnread > 0) ? mUnread : 0;
@@ -197,6 +246,14 @@
   const int unreadRecursiveCount = countUnreadRecursive();
   const int unreadCount = ( mUnread > 0 ) ? mUnread : 0;
 
+
+  // use a special color for folders which are close to their quota
+  QColorGroup mycg = cg;
+  if ( ( column == 0 || column == ft->sizeIndex() ) && folderIsCloseToQuota() )
+  {
+    mycg.setColor( QColorGroup::Text, ft->paintInfo().colCloseToQuota );
+  }
+ 
   // use a bold-font for the folder- and the unread-columns
   if ( (column == 0 || column == ft->unreadIndex())
         && ( unreadCount > 0
@@ -207,6 +264,7 @@
     p->setFont(f);
   }
 
+
   // most cells can be handled by KListView::paintCell, we only need to
   // deal with the folder column if the unread column is not shown
 
@@ -216,7 +274,7 @@
    * two painting passes which flickers. Since that flicker is not
    * needed when there is the unread column, special case that. */
   if ( ft->isUnreadActive() || column != 0 ) {
-    KListViewItem::paintCell( p, cg, column, width, align );
+    KListViewItem::paintCell( p, mycg, column, width, align );
   } else {
     QListView *lv = listView();
     QString oldText = text(column);
@@ -225,55 +283,54 @@
     // but still benefit from KListView::paintCell
     setText( column, "" );
 
-    KListViewItem::paintCell( p, cg, column, width, align );
+    KListViewItem::paintCell( p, mycg, column, width, align );
 
     const QPixmap *icon = pixmap( column );
     int marg = lv ? lv->itemMargin() : 1;
     int r = marg;
 
-    QString t;
-    QRect br;
     setText( column, oldText );
     if ( isSelected() )
-      p->setPen( cg.highlightedText() );
+      p->setPen( mycg.highlightedText() );
     else
-      p->setPen( ft->paintInfo().colFore );
+      p->setPen( mycg.color( QColorGroup::Text ) );
 
     if ( icon ) {
       r += icon->width() + marg;
     }
-    t = text( column );
-    if ( !t.isEmpty() )
-    {
-      // draw the unread-count if the unread-column is not active
-      QString unread;
+    QString t = text( column );
+    if (t.isEmpty())
+      return;
 
-      if ( unreadCount > 0 || ( !isOpen() && unreadRecursiveCount > 0 ) ) {
-        if ( isOpen() )
-          unread = " (" + QString::number( unreadCount ) + ")";
-        else if ( unreadRecursiveCount == unreadCount || mType == Root )
-          unread = " (" + QString::number( unreadRecursiveCount ) + ")";
-        else
-          unread = " (" + QString::number( unreadCount ) + " + " +
-                    QString::number( unreadRecursiveCount-unreadCount ) + ")";
-      }
+    // draw the unread-count if the unread-column is not active
+    QString unread;
 
-      // check if the text needs to be squeezed
-      QFontMetrics fm( p->fontMetrics() );
-      int unreadWidth = fm.width( unread );
-      if ( fm.width( t ) + marg + r + unreadWidth > width )
-        t = squeezeFolderName( t, fm, width - marg - r - unreadWidth );
+    if ( unreadCount > 0 || ( !isOpen() && unreadRecursiveCount > 0 ) ) {
+      if ( isOpen() )
+        unread = " (" + QString::number( unreadCount ) + ")";
+      else if ( unreadRecursiveCount == unreadCount || mType == Root )
+        unread = " (" + QString::number( unreadRecursiveCount ) + ")";
+      else
+        unread = " (" + QString::number( unreadCount ) + " + " +
+          QString::number( unreadRecursiveCount-unreadCount ) + ")";
+    }
 
-      p->drawText( r, 0, width-marg-r, height(),
-                    align | AlignVCenter, t, -1, &br );
+    // check if the text needs to be squeezed
+    QFontMetrics fm( p->fontMetrics() );
+    int unreadWidth = fm.width( unread );
+    if ( fm.width( t ) + marg + r + unreadWidth > width )
+      t = squeezeFolderName( t, fm, width - marg - r - unreadWidth );
 
-      if ( !unread.isEmpty() ) {
-        if (!isSelected())
-          p->setPen( ft->paintInfo().colUnread );
-        p->drawText( br.right(), 0, width-marg-br.right(), height(),
-                      align | AlignVCenter, unread );
-      }
-    } // end !t.isEmpty()
+    QRect br;
+    p->drawText( r, 0, width-marg-r, height(),
+        align | AlignVCenter, t, -1, &br );
+
+    if ( !unread.isEmpty() ) {
+      if (!isSelected())
+        p->setPen( ft->paintInfo().colUnread );
+      p->drawText( br.right(), 0, width-marg-br.right(), height(),
+          align | AlignVCenter, unread );
+    }
   }
 }
 
@@ -285,12 +342,25 @@
   return KStringHandler::rPixelSqueeze( text, fm, width );
 }
 
+bool KFolderTreeItem::folderIsCloseToQuota() const
+{
+  return mFolderIsCloseToQuota;
+}
 
+void KFolderTreeItem::setFolderIsCloseToQuota( bool v )
+{
+  if ( mFolderIsCloseToQuota != v) {
+    mFolderIsCloseToQuota = v;
+    repaint();
+  }
+}
+
+
 //=============================================================================
 
 
 KFolderTree::KFolderTree( QWidget *parent, const char* name )
-  : KListView( parent, name ), mUnreadIndex(-1), mTotalIndex(-1)
+  : KListView( parent, name ), mUnreadIndex(-1), mTotalIndex(-1), mSizeIndex(-1)
 {
   // GUI-options
   setStyleDependantFrameWidth();
@@ -413,6 +483,9 @@
   removeColumn( mUnreadIndex );
   if ( isTotalActive() && mTotalIndex > mUnreadIndex )
     mTotalIndex--;
+  if ( isSizeActive() && mSizeIndex > mUnreadIndex )
+    mSizeIndex--;
+
   mUnreadIndex = -1;
   header()->adjustHeaderSize();
 }
@@ -424,11 +497,35 @@
   removeColumn( mTotalIndex );
   if ( isUnreadActive() && mTotalIndex < mUnreadIndex )
     mUnreadIndex--;
+  if ( isSizeActive() && mTotalIndex < mSizeIndex )
+    mSizeIndex--;
   mTotalIndex = -1;
   header()->adjustHeaderSize();
 }
 
 //-----------------------------------------------------------------------------
+void KFolderTree::addSizeColumn( const QString & name, int width )
+{
+  mSizeIndex = addColumn( name, width );
+  setColumnAlignment( mSizeIndex, qApp->reverseLayout() ? Qt::AlignLeft : Qt::AlignRight );
+  header()->adjustHeaderSize();
+}
+
+//-----------------------------------------------------------------------------
+void KFolderTree::removeSizeColumn()
+{
+  if ( !isSizeActive() ) return;
+  removeColumn( mSizeIndex );
+  if ( isUnreadActive() && mSizeIndex < mUnreadIndex )
+    mUnreadIndex--;
+  if ( isTotalActive() && mSizeIndex < mTotalIndex )
+    mTotalIndex--;
+  mSizeIndex = -1;
+  header()->adjustHeaderSize();
+}
+
+
+//-----------------------------------------------------------------------------
 void KFolderTree::setFullWidth( bool fullWidth )
 {
   if (fullWidth)
Index: libkdepim/tests/testdistrlist.cpp
===================================================================
--- libkdepim/tests/testdistrlist.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/tests/testdistrlist.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,7 +48,7 @@
 
     KApplication::disableAutoDcopRegistration();
     KCmdLineArgs::init(argc,argv,"testdistrlist", 0, 0, 0, 0);
-    KApplication app;
+    KApplication app( false, false );
 
     TestDistrList test;
     test.setup();
@@ -111,6 +111,38 @@
     return true;
 }
 
+// taken from KMail
+#include <sys/types.h>
+#include <dirent.h>
+static bool removeDirAndContentsRecursively( const QString & path )
+{
+  kdDebug() << k_funcinfo << path << endl;
+  bool success = true;
+
+  QDir d;
+  d.setPath( path );
+  d.setFilter( QDir::Files | QDir::Dirs | QDir::Hidden );
+
+  const QFileInfoList *list = d.entryInfoList();
+  QFileInfoListIterator it( *list );
+  QFileInfo *fi;
+
+  while ( (fi = it.current()) != 0 ) {
+    if( fi->isDir() && !fi->isSymLink() ) {
+      if ( fi->fileName() != "." && fi->fileName() != ".." )
+        success = success && removeDirAndContentsRecursively( fi->absFilePath() );
+    } else {
+      success = success && d.remove( fi->absFilePath() );
+    }
+    ++it;
+  }
+
+  if ( success ) {
+    success = success && d.rmdir( path ); // nuke ourselves, we should be empty now
+  }
+  return success;
+}
+
 void TestDistrList::cleanup()
 {
     kdDebug() << k_funcinfo << endl;
@@ -120,7 +152,9 @@
 
     QString kdehome = QFile::decodeName( getenv("KDEHOME") );
     KURL urlkdehome; urlkdehome.setPath( kdehome );
-    KIO::NetAccess::del( urlkdehome, 0 );
+    // don't use KIO::NetAccess here since it needs X
+    // KIO::NetAccess::del( urlkdehome, 0 )i;
+    assert( removeDirAndContentsRecursively( kdehome ) );
 }
 
 void TestDistrList::testEmpty()
Index: libkdepim/configure.in.in
===================================================================
--- libkdepim/configure.in.in	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/configure.in.in	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -17,4 +17,4 @@
 esac
 ], [AC_MSG_RESULT([no])])
 
-dnl AM_CONDITIONAL(compile_newdistrlists, test "$enable_new_distrlists" = "xyes")
+AM_CONDITIONAL(compile_newdistrlists, test "x$enable_new_distrlists" = "xyes")
Index: libkdepim/kfoldertree.h
===================================================================
--- libkdepim/kfoldertree.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kfoldertree.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 #include <qpixmap.h>
 #include <qbitarray.h>
 #include <qdragobject.h>
+#include <qcolor.h>
 #include <klistview.h>
 #include <kdepimmacros.h>
 
@@ -94,6 +95,7 @@
   QColor colUnread;
   QColor colFlag;
   QColor colTodo;
+  QColor colCloseToQuota;
 
   bool showSize;
   bool showAttachment;
@@ -181,6 +183,10 @@
     int totalCount() { return mTotal; }
     virtual void setTotalCount( int aTotal );
 
+    /** set/get the total-count */
+    Q_INT64 folderSize() { return mSize; }
+    virtual void setFolderSize( Q_INT64 aSize );
+
     /** set/get the protocol of the item */
     Protocol protocol() const { return mProtocol; }
     virtual void setProtocol( Protocol aProtocol ) { mProtocol = aProtocol; }
@@ -192,6 +198,8 @@
     /** recursive unread count */
     virtual int countUnreadRecursive();
 
+    virtual Q_INT64 recursiveFolderSize() const;
+
     /** paints the cell */
     virtual void paintCell( QPainter * p, const QColorGroup & cg,
         int column, int width, int align );
@@ -199,6 +207,9 @@
     /** dnd */
     virtual bool acceptDrag(QDropEvent* ) const { return true; }
 
+    void setFolderIsCloseToQuota( bool );
+    bool folderIsCloseToQuota() const;
+
   private:
     /** returns a sorting key based on the folder's protocol */
     int protocolSortingKey() const;
@@ -215,6 +226,8 @@
     Type mType;
     int mUnread;
     int mTotal;
+    Q_INT64 mSize;
+    bool mFolderIsCloseToQuota;
 };
 
 //==========================================================================
@@ -243,14 +256,19 @@
     virtual void removeUnreadColumn();
     virtual void addTotalColumn( const QString & name, int width=70 );
     virtual void removeTotalColumn();
+    virtual void addSizeColumn( const QString & name, int width=70 );
+    virtual void removeSizeColumn();
 
+
     /** the current index of the unread/total column */
     int unreadIndex() const { return mUnreadIndex; }
     int totalIndex() const { return mTotalIndex;  }
+    int sizeIndex() const { return mSizeIndex;  }
 
     /** is the unread/total-column active? */
     bool isUnreadActive() const { return mUnreadIndex >= 0; }
     bool isTotalActive() const { return mTotalIndex >=  0; }
+    bool isSizeActive() const { return mSizeIndex >=  0; }
 
     /** reimp to set full width of the _first_ column */
     virtual void setFullWidth( bool fullWidth );
@@ -281,6 +299,7 @@
      * -1 is deactivated */
     int mUnreadIndex;
     int mTotalIndex;
+    int mSizeIndex;
 
   private slots:
     /** repaints the complete column (instead of only parts of it as done in
Index: libkdepim/komposer/plugins/default/defaulteditor.desktop
===================================================================
--- libkdepim/komposer/plugins/default/defaulteditor.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/komposer/plugins/default/defaulteditor.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 Name[cs]=Komposer editor
 Name[da]=Komposer-editor
 Name[el]=ŒïœÄŒµŒæŒµœÅŒ≥Œ±œÉœÑŒÆœÇ Komposer
+Name[eo]=Komposer-redaktilo
 Name[es]=Editor Komposer
 Name[et]=Komposeri redaktor
 Name[eu]=Komposer editorea
@@ -68,6 +69,7 @@
 Comment[da]=Komposer standardeditor
 Comment[de]=Komposer Standardeditor
 Comment[el]=Œ†œÅŒøŒµœÄŒπŒªŒµŒ≥ŒºŒ≠ŒΩŒøœÇ ŒµœÄŒµŒæŒµœÅŒ≥Œ±œÉœÑŒÆœÇ œÑŒøœÖ Komposer
+Comment[eo]=Komposer-redaktilo apriora
 Comment[es]=Editor predefinido Komposer
 Comment[et]=Komposeri vaikeredaktor
 Comment[eu]=Komposer editore lehenetsia
Index: libkdepim/komposer/core/komposerplugin.desktop
===================================================================
--- libkdepim/komposer/core/komposerplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/komposer/core/komposerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Name[da]=Brevskriver-plugin
 Name[de]=Komposer-Modul
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ Komposer
+Name[eo]=Komposer-kromaƒµo
 Name[es]=Accesorio Komposer
 Name[et]=Komposeri plugin
 Name[eu]=Komposer plugin-a
Index: libkdepim/komposer/core/komposereditor.desktop
===================================================================
--- libkdepim/komposer/core/komposereditor.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/komposer/core/komposereditor.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Comment[cs]=Komposer editor
 Comment[da]=Komposer editor
 Comment[el]=ŒïœÄŒµŒæŒµœÅŒ≥Œ±œÉœÑŒÆœÇ Komposer
+Comment[eo]=Komposer-redaktilo
 Comment[es]=Editor Komposer
 Comment[et]=Komposeri redaktor
 Comment[eu]=Komposer editorea
Index: libkdepim/resourceabc.h
===================================================================
--- libkdepim/resourceabc.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/resourceabc.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -70,6 +70,11 @@
   virtual bool subresourceActive( const QString& ) const { return true; }
 
   /**
+   * Is the given subresource writable?
+   */
+  virtual bool subresourceWritable( const QString& ) const = 0;
+
+  /**
    * Completion weight for a given subresource
    */
   virtual int subresourceCompletionWeight( const QString& ) const = 0;
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -182,6 +182,11 @@
     completionBox()->setFont( font );
 }
 
+void AddresseeLineEdit::allowSemiColonAsSeparator( bool useSemiColonAsSeparator )
+{
+  m_useSemiColonAsSeparator = useSemiColonAsSeparator;
+}
+
 void AddresseeLineEdit::keyPressEvent( QKeyEvent *e )
 {
   bool accept = false;
@@ -259,14 +264,15 @@
 
   QString contents = text();
   int start_sel = 0;
+  int end_sel = 0;
   int pos = cursorPosition( );
-
-  if ( hasSelectedText() ) {
+  if ( getSelection( &start_sel, &end_sel ) ) {
     // Cut away the selection.
-    start_sel = selectionStart();
-    pos = start_sel;
-    contents = contents.left( start_sel ) +
-               contents.mid( start_sel + selectedText().length() );
+    if ( pos > end_sel )
+      pos -= (end_sel - start_sel);
+    else if ( pos > start_sel )
+      pos = start_sel;
+    contents = contents.left( start_sel ) + contents.right( end_sel + 1 );
   }
 
   int eot = contents.length();
@@ -483,6 +489,7 @@
   setText( m_previousAddresses + completion.stripWhiteSpace() );
   cursorAtEnd();
 //  slotMatched( m_previousAddresses + completion );
+  updateSearchString();
 }
 
 void AddresseeLineEdit::slotReturnPressed( const QString& item )
@@ -785,6 +792,16 @@
     if ( !items.isEmpty() &&
          !(items.count() == 1 && m_searchString == items.first()) )
     {
+        QString oldCurrentText = completionBox->currentText();
+        QListBoxItem *itemUnderMouse = completionBox->itemAt(
+            completionBox->viewport()->mapFromGlobal(QCursor::pos()) );
+        QString oldTextUnderMouse;
+        QPoint oldPosOfItemUnderMouse;
+        if ( itemUnderMouse ) {
+            oldTextUnderMouse = itemUnderMouse->text();
+            oldPosOfItemUnderMouse = completionBox->itemRect( itemUnderMouse ).topLeft();
+        }
+
         completionBox->setItems( items );
 
         if ( !completionBox->isVisible() ) {
@@ -798,11 +815,33 @@
             qApp->installEventFilter( this );
         }
 
-        QListBoxItem* item = completionBox->item( 1 );
+        // Try to re-select what was selected before, otherrwise use the first
+        // item, if there is one
+        QListBoxItem* item = 0;
+        if ( oldCurrentText.isEmpty()
+           || ( item = completionBox->findItem( oldCurrentText ) ) == 0 ) {
+            item = completionBox->item( 1 );
+        }
         if ( item )
         {
+          if ( itemUnderMouse ) {
+              QListBoxItem *newItemUnderMouse = completionBox->findItem( oldTextUnderMouse );
+              // if the mouse was over an item, before, but now that's elsewhere,
+              // move the cursor, so folks don't accidently click the wrong item
+              if ( newItemUnderMouse ) {
+                  QRect r = completionBox->itemRect( newItemUnderMouse );
+                  QPoint target = r.topLeft();
+                  if ( oldPosOfItemUnderMouse != target ) {
+                      target.setX( target.x() + r.width()/2 );
+                      QCursor::setPos( completionBox->viewport()->mapToGlobal(target) );
+                  }
+              }
+          }
           completionBox->blockSignals( true );
           completionBox->setSelected( item, true );
+          completionBox->setCurrentItem( item );
+          completionBox->ensureCurrentVisible();
+
           completionBox->blockSignals( false );
         }
 
@@ -861,7 +900,20 @@
 void AddresseeLineEdit::updateSearchString()
 {
   m_searchString = text();
-  int n = m_searchString.findRev(',');
+
+  int n = -1;
+  bool inQuote = false;
+  for ( uint i = 0; i < m_searchString.length(); ++i ) {
+    if ( m_searchString[ i ] == '"' )
+      inQuote = !inQuote;
+    if ( m_searchString[ i ] == '\\' && (i + 1) < m_searchString.length() && m_searchString[ i + 1 ] == '"' )
+      ++i;
+    if ( inQuote )
+      continue;
+    if ( m_searchString[ i ] == ',' || ( m_useSemiColonAsSeparator && m_searchString[ i ] == ';' ) )
+      n = i;
+  }
+
   if ( n >= 0 ) {
     ++n; // Go past the ","
 
@@ -1018,7 +1070,7 @@
       // find the next header (searching backwards, for Key_Backtab
       QListBoxItem *nextHeader = 0;
       const int iterationstep = ke->key() == Key_Tab ?  1 : -1;
-      // when iterating forward, start at the currentindex, when backwards, 
+      // when iterating forward, start at the currentindex, when backwards,
       // one up from our header, or at the end
       uint j = ke->key() == Key_Tab ? currentIndex : i==0 ? completionBox()->count()-1 : (i-1) % completionBox()->count();
       while ( ( nextHeader = completionBox()->item( j ) ) && nextHeader != myHeader ) {
@@ -1031,6 +1083,8 @@
         QListBoxItem *item = completionBox()->item( j + 1 );
         if ( item && !itemIsHeader(item) ) {
           completionBox()->setSelected( j+1, true );
+          completionBox()->setCurrentItem( item );
+          completionBox()->ensureCurrentVisible();
         }
       }
       return true;
Index: libkdepim/csshelper.h
===================================================================
--- libkdepim/csshelper.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/csshelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -64,6 +64,9 @@
 
     QFont bodyFont( bool fixedFont = false, bool printing = false ) const;
 
+    void setBodyFont( const QFont& font );
+    void setPrintFont( const QFont& font );
+
   protected:
     /** Recalculate PGP frame and body colors (should be called after changing
         color settings) */
Index: libkdepim/kdateedit.cpp
===================================================================
--- libkdepim/kdateedit.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkdepim/kdateedit.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,6 +2,7 @@
     This file is part of libkdepim.
 
     Copyright (c) 2002 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2002 David Jarvie <software@astrojar.org.uk>
     Copyright (c) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
     Copyright (c) 2004 Tobias Koenig <tokoe@kde.org>
 
@@ -180,6 +181,7 @@
   if (assignDate( date ) ) {
     updateView();
     emit dateChanged( date );
+    emit dateEntered( date );
 
     if ( date.isValid() ) {
       mPopup->hide();
@@ -187,14 +189,6 @@
   }
 }
 
-void KDateEdit::dateEntered( QDate date )
-{
-  if (assignDate( date ) ) {
-    updateView();
-    emit dateChanged( date );
-  }
-}
-
 void KDateEdit::lineEnterPressed()
 {
   bool replaced = false;
@@ -206,6 +200,7 @@
       updateView();
 
     emit dateChanged( date );
+    emit dateEntered( date );
   }
 }
 
@@ -279,6 +274,7 @@
           if ( assignDate( date ) ) {
             updateView();
             emit dateChanged( date );
+            emit dateEntered( date );
             return true;
           }
         }
Index: libkcal/localdir.desktop
===================================================================
--- libkcal/localdir.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/localdir.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Kalender i lokal mappe
 Name[de]=Kalender in lokalem Ordner
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø œÉŒµ œÑŒøœÄŒπŒ∫œå Œ∫Œ±œÑŒ¨ŒªŒøŒ≥Œø
+Name[eo]=Kalendaro en loka dosierujo
 Name[es]=Calendario en el directorio local
 Name[et]=Kalender kohalikus kataloogis
 Name[eu]=Egutegia direktorio lokalean
Index: libkcal/incidencebase.h
===================================================================
--- libkcal/incidencebase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidencebase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -87,12 +87,14 @@
       public:
         virtual ~Observer() {}
         virtual void incidenceUpdated( IncidenceBase * ) = 0;
+        virtual void incidenceUpdatedSilent( IncidenceBase * ) {};
     };
 
     IncidenceBase();
     IncidenceBase( const IncidenceBase & );
     virtual ~IncidenceBase();
 
+    IncidenceBase& operator=( const IncidenceBase &i );
     bool operator==( const IncidenceBase & ) const;
 
     /**
@@ -222,6 +224,7 @@
       Set synchronisation satus.
     */
     void setSyncStatus( int status );
+    void setSyncStatusSilent( int status );
     /**
       Return synchronisation status.
     */
@@ -250,6 +253,7 @@
       changed.
     */
     void updated();
+    void updatedSilent();
 
   protected:
     /**
Index: libkcal/local.desktop
===================================================================
--- libkcal/local.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Kalender i lokal fil
 Name[de]=Kalender in lokaler Datei
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø œÉŒµ œÑŒøœÄŒπŒ∫œå Œ±œÅœáŒµŒØŒø
+Name[eo]=Kalendaro en loka dosiero
 Name[es]=Calendario en archivo local
 Name[et]=Kalender kohalikus failis
 Name[eu]=Egutegia fitxategi lokalean
Index: libkcal/kcal_manager.desktop
===================================================================
--- libkcal/kcal_manager.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/kcal_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -13,6 +13,7 @@
 Name[da]=Kalender
 Name[de]=Kalender
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø
+Name[eo]=Kalendaro
 Name[es]=Calendario
 Name[et]=Kalender
 Name[eu]=Egutegia
Index: libkcal/libical/README.zoneinfo
===================================================================
--- libkcal/libical/README.zoneinfo	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/README.zoneinfo	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,9 +4,9 @@
     from ftp://elsie.nci.nih.gov/pub/ to the tzdata subdir
 
     % cd tzdata
-    % wget ftp://elsie.nci.nih.gov/pub/tzdata2007g.tar.gz
-    % cat tzdata2007g.tar.gz | gunzip -c | tar xvf -
-    % rm tzdata2007g.tar.gz
+    % wget ftp://elsie.nci.nih.gov/pub/tzdata2007h.tar.gz
+    % cat tzdata2007h.tar.gz | gunzip -c | tar xvf -
+    % rm tzdata2007h.tar.gz
     % cd ..
 
  2. Make sure we have the most recent version of the vzic program
@@ -30,19 +30,15 @@
    % make
    % cd ..
 
- 4. Prepare for to generate the zoneinfo files
+ 4. Do it!
 
-    % svn mv zoneinfo zoneinfo.bak
-
- 5. Do it!
-
     % cd vzic-1.3
     % ./vzic --pure --output-dir ../zoneinfo
 
- 6. Cleanup
+ 5. Cleanup
 
     % make clean
 
- 7. Commit new tzdata and vzic, if necessary
+ 6. Commit new tzdata and vzic, if necessary
 
- 8. Commit new zoneinfo and remove zoneinfo.bak
+ 7. Commit new zoneinfo
Index: libkcal/libical/src/libical/icalvalue.c
===================================================================
--- libkcal/libical/src/libical/icalvalue.c	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/src/libical/icalvalue.c	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -314,6 +314,15 @@
 	}
 
     case ICAL_BINARY_VALUE:
+    {
+        icalattach *attach;
+        attach = icalattach_new_from_data (str, 0, 0);
+        if ( !attach )
+          break;
+        value = icalvalue_new_attach (attach);
+        icalattach_unref (attach);
+        break;
+    }
     case ICAL_BOOLEAN_VALUE:
         {
             /* HACK */
@@ -801,9 +810,15 @@
 	str = icalmemory_tmp_buffer (strlen (url) + 1);
 	strcpy (str, url);
 	return str;
-    } else
-	return icalvalue_binary_as_ical_string (value);
+    } else {
+/* 	return icalvalue_binary_as_ical_string (value);*/
+      const char *data = 0;
+      data = (const char*)icalattach_get_data(a);
+      str = icalmemory_tmp_buffer (strlen (data) + 1);
+      strcpy (str, data);
+      return str;
 }
+}
 
 
 static char* icalvalue_duration_as_ical_string(const icalvalue* value) {
Index: libkcal/libical/src/libical/icalproperty.c
===================================================================
--- libkcal/libical/src/libical/icalproperty.c	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/src/libical/icalproperty.c	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -387,15 +387,16 @@
 	    =  icalproperty_kind_to_value_kind(prop->kind);
 
 	if(orig_val_param){
-	    orig_kind = (icalvalue_kind)icalparameter_get_value(orig_val_param);
+	    orig_kind = icalparameter_value_to_value_kind( icalparameter_get_value(orig_val_param) );
 	}
 
 	if(value != 0){
 	    this_kind = icalvalue_isa(value);
 	}
 	
-	
-	if(this_kind == default_kind &&
+    if ( orig_kind != ICAL_NO_VALUE ) {
+      kind_string = icalvalue_kind_to_string( orig_kind );
+    } else if(this_kind == default_kind &&
 	   orig_kind != ICAL_NO_VALUE){
 	    /* The kind is the default, so it does not need to be
                included, but do it anyway, since it was explicit in
Index: libkcal/libical/tzdata/southamerica
===================================================================
--- libkcal/libical/tzdata/southamerica	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/tzdata/southamerica	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-# @(#)southamerica	8.11
+# @(#)southamerica	8.12
 # <pre>
 
 # This data is by no means authoritative; if you think you know better,
@@ -424,6 +424,10 @@
 # modern Brazilian eletronic voting machines which, apparently, can't deal
 # with a time change between the first and the second rounds of the elections.
 
+# From Steffen Thorsen (2007-09-20):
+# Brazil will start DST on 2007-10-14 00:00 and end on 2008-02-17 00:00:
+# http://www.mme.gov.br/site/news/detail.do;jsessionid=BBA06811AFCAAC28F0285210913513DA?newsId=13975
+
 # From Paul Eggert (2002-10-10):
 # The official decrees referenced below are mostly taken from
 # <a href="http://pcdsh01.on.br/DecHV.html">
@@ -557,13 +561,18 @@
 # Decree <a href="http://pcdsh01.on.br/DecHV5539.gif">5,539</a> (2005-09-19),
 # adopted by the same states as before.
 Rule	Brazil	2005	only	-	Oct	16	 0:00	1:00	S
-# Decree <a href="http://www.planalto.gov.br/ccivil_03/_Ato2004-2006/2006/Decreto/D5920.htm">5,920</a>
-# (2006-10-03), adopted by the same states as before.
-Rule	Brazil	2006	max	-	Nov	Sun>=1	 0:00	1:00	S
-Rule	Brazil	2007	max	-	Feb	lastSun	 0:00	0	-
+# Decree <a href="http://pcdsh01.on.br/DecHV5920.gif">5,920</a> (2006-10-03),
+# adopted by the same states as before.
+Rule	Brazil	2006	only	-	Nov	 5	 0:00	1:00	S
+Rule	Brazil	2007	only	-	Feb	25	 0:00	0	-
+# (Decree number not yet known)
+# http://www.brasil.gov.br/noticias/ultimas_noticias/horario_verao070920/
+# (2007-09-20) after a heads-up from Steffen Thorsen:
+Rule	Brazil	2007	max	-	Oct	Sun>=8	 0:00	1:00	S
+Rule	Brazil	2008	max	-	Feb	Sun>=15	 0:00	0	-
 # The latest ruleset listed above says that the following states observe DST:
 # DF, ES, GO, MG, MS, MT, PR, RJ, RS, SC, SP.
-# For dates after mid-2007, the above rules with TO="max" are guesses
+# For dates after mid-2008, the above rules with TO="max" are guesses
 # and are quite possibly wrong, but are more likely than no DST at all.
 
 
@@ -1097,8 +1106,20 @@
 			-3:00	Uruguay	UY%sT
 
 # Venezuela
+#
+# From Kiraz Janicke (2007-09-25), in
+# http://www.venezuelanalysis.com/analysis/2645:
+# The proposal ... involves turning the clock back half an hour from
+# +4.00 Greenwich Mean Time (GMT), to +4.30GMT, the time zone
+# Venezuela had until December 31, 1964, when the current time zone
+# was adopted. The change was due to take place on September 17 and
+# then on September 24, but has since been postponed until December
+# 31, to allow for compliance with international organizations, such
+# as the International Office of Weights and Measures.
+
 # Zone	NAME		GMTOFF	RULES	FORMAT	[UNTIL]
 Zone	America/Caracas	-4:27:44 -	LMT	1890
 			-4:27:40 -	CMT	1912 Feb 12 # Caracas Mean Time?
 			-4:30	-	VET	1965	     # Venezuela Time
-			-4:00	-	VET
+			-4:00	-	VET	2008
+			-4:30	-	VET
Index: libkcal/libical/tzdata/africa
===================================================================
--- libkcal/libical/tzdata/africa	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/tzdata/africa	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-# @(#)africa	8.9
+# @(#)africa	8.10
 # <pre>
 
 # This data is by no means authoritative; if you think you know better,
@@ -224,9 +224,19 @@
 # From Jesper Norgaard Welen (2007-08-15): [The following agree:]
 # http://www.nentjes.info/Bill/bill5.htm 
 # http://www.timeanddate.com/worldclock/city.html?n=53
+# From Steffen Thorsen (2007-09-04): The official information...:
+# http://www.sis.gov.eg/En/EgyptOnline/Miscellaneous/000002/0207000000000000001580.htm
+Rule	Egypt	2007	only	-	Sep	Thu>=1	23:00s	0	-
+# From Abdelrahman Hassan (2007-09-06):
+# Due to the Hijri (lunar Islamic calendar) year being 11 days shorter
+# than the year of the Gregorian calendar, Ramadan shifts earlier each
+# year. This year it will be observed September 13 (September is quite
+# hot in Egypt), and the idea is to make fasting easier for workers by
+# shifting business hours one hour out of daytime heat. Consequently,
+# unless discontinued, next DST may end Thursday 28 August 2008.
 # From Paul Eggert (2007-08-17):
-# For lack of better info, assume the new rule is first Thursday.
-Rule	Egypt	2007	max	-	Sep	Thu>=1	23:00s	0	-
+# For lack of better info, assume the new rule is last Thursday in August.
+Rule	Egypt	2008	max	-	Aug	lastThu	23:00s	0	-
 
 # Zone	NAME		GMTOFF	RULES	FORMAT	[UNTIL]
 Zone	Africa/Cairo	2:05:00 -	LMT	1900 Oct
Index: libkcal/libical/tzdata/asia
===================================================================
--- libkcal/libical/tzdata/asia	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/tzdata/asia	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-# @(#)asia	8.11
+# @(#)asia	8.12
 # <pre>
 
 # This data is by no means authoritative; if you think you know better,
@@ -568,14 +568,15 @@
 # Reingold's/Dershowitz' calculator gives correctly the Gregorian date
 # 2058-03-21 for 1 Farvardin 1437 (astronomical).
 #
-# From Paul Eggert (2006-03-22):
-# The above comments about post-2006 transitions may become relevant again,
-# if Iran ever resuscitates DST, so we'll leave the comments in.
-#
 # From Steffen Thorsen (2006-03-22):
 # Several of my users have reported that Iran will not observe DST anymore:
 # http://www.irna.ir/en/news/view/line-17/0603193812164948.htm
 #
+# From Reuters (2007-09-16), with a heads-up from Jesper Norgaard Welen:
+# ... the Guardian Council ... approved a law on Sunday to re-introduce
+# daylight saving time ...
+# http://uk.reuters.com/article/oilRpt/idUKBLA65048420070916
+#
 # Rule	NAME	FROM	TO	TYPE	IN	ON	AT	SAVE	LETTER/S
 Rule	Iran	1978	1980	-	Mar	21	0:00	1:00	D
 Rule	Iran	1978	only	-	Oct	21	0:00	0	S
@@ -596,6 +597,36 @@
 Rule	Iran	2004	only	-	Sep	21	0:00	0	S
 Rule	Iran	2005	only	-	Mar	22	0:00	1:00	D
 Rule	Iran	2005	only	-	Sep	22	0:00	0	S
+Rule	Iran	2008	only	-	Mar	21	0:00	1:00	D
+Rule	Iran	2008	only	-	Sep	21	0:00	0	S
+Rule	Iran	2009	2011	-	Mar	22	0:00	1:00	D
+Rule	Iran	2009	2011	-	Sep	22	0:00	0	S
+Rule	Iran	2012	only	-	Mar	21	0:00	1:00	D
+Rule	Iran	2012	only	-	Sep	21	0:00	0	S
+Rule	Iran	2013	2015	-	Mar	22	0:00	1:00	D
+Rule	Iran	2013	2015	-	Sep	22	0:00	0	S
+Rule	Iran	2016	only	-	Mar	21	0:00	1:00	D
+Rule	Iran	2016	only	-	Sep	21	0:00	0	S
+Rule	Iran	2017	2019	-	Mar	22	0:00	1:00	D
+Rule	Iran	2017	2019	-	Sep	22	0:00	0	S
+Rule	Iran	2020	only	-	Mar	21	0:00	1:00	D
+Rule	Iran	2020	only	-	Sep	21	0:00	0	S
+Rule	Iran	2021	2023	-	Mar	22	0:00	1:00	D
+Rule	Iran	2021	2023	-	Sep	22	0:00	0	S
+Rule	Iran	2024	only	-	Mar	21	0:00	1:00	D
+Rule	Iran	2024	only	-	Sep	21	0:00	0	S
+Rule	Iran	2025	2027	-	Mar	22	0:00	1:00	D
+Rule	Iran	2025	2027	-	Sep	22	0:00	0	S
+Rule	Iran	2028	2029	-	Mar	21	0:00	1:00	D
+Rule	Iran	2028	2029	-	Sep	21	0:00	0	S
+Rule	Iran	2030	2031	-	Mar	22	0:00	1:00	D
+Rule	Iran	2030	2031	-	Sep	22	0:00	0	S
+Rule	Iran	2032	2033	-	Mar	21	0:00	1:00	D
+Rule	Iran	2032	2033	-	Sep	21	0:00	0	S
+Rule	Iran	2034	2035	-	Mar	22	0:00	1:00	D
+Rule	Iran	2034	2035	-	Sep	22	0:00	0	S
+Rule	Iran	2036	2037	-	Mar	21	0:00	1:00	D
+Rule	Iran	2036	2037	-	Sep	21	0:00	0	S
 # Zone	NAME		GMTOFF	RULES	FORMAT	[UNTIL]
 Zone	Asia/Tehran	3:25:44	-	LMT	1916
 			3:25:44	-	TMT	1946	# Tehran Mean Time
@@ -1518,6 +1549,17 @@
 # I guess it is likely that next year's date will be moved as well,
 # because of the Ramadan.
 
+# From Jesper Norgaard Welen (2007-09-18):
+# According to Steffen Thorsen's web site the Gaza Strip and the rest of the
+# Palestinian territories left DST early on 13.th. of September at 2:00.
+
+# From Paul Eggert (2007-09-20):
+# My understanding is that Gaza and the West Bank disagree even over when
+# the weekend is (Thursday+Friday versus Friday+Saturday), so I'd be a bit
+# surprised if they agreed about DST.  But for now, assume they agree.
+# For lack of better information, predict that future changes will be
+# the 2nd Thursday of September at 02:00.
+
 # The rules for Egypt are stolen from the `africa' file.
 # Rule	NAME	FROM	TO	TYPE	IN	ON	AT	SAVE	LETTER/S
 Rule EgyptAsia	1957	only	-	May	10	0:00	1:00	S
@@ -1533,7 +1575,7 @@
 Rule Palestine	2005	only	-	Oct	 4	2:00	0	-
 Rule Palestine	2006	max	-	Apr	 1	0:00	1:00	S
 Rule Palestine	2006	only	-	Sep	22	0:00	0	-
-Rule Palestine	2007	max	-	Oct	Fri>=15	0:00	0	-
+Rule Palestine	2007	max	-	Sep	Thu>=8	2:00	0	-
 
 # Zone	NAME		GMTOFF	RULES	FORMAT	[UNTIL]
 Zone	Asia/Gaza	2:17:52	-	LMT	1900 Oct
Index: libkcal/libical/zoneinfo/Atlantic/Madeira.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Madeira.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Madeira.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Madeira
+TZID:/kde.org/Olson_20071016_1/Atlantic/Madeira
 X-LIC-LOCATION:Atlantic/Madeira
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Atlantic/St_Helena.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/St_Helena.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/St_Helena.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/St_Helena
+TZID:/kde.org/Olson_20071016_1/Atlantic/St_Helena
 X-LIC-LOCATION:Atlantic/St_Helena
 BEGIN:STANDARD
 TZOFFSETFROM:-002248
Index: libkcal/libical/zoneinfo/Atlantic/Azores.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Azores.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Azores.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Azores
+TZID:/kde.org/Olson_20071016_1/Atlantic/Azores
 X-LIC-LOCATION:Atlantic/Azores
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0100
Index: libkcal/libical/zoneinfo/Atlantic/Faroe.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Faroe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Faroe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Faroe
+TZID:/kde.org/Olson_20071016_1/Atlantic/Faroe
 X-LIC-LOCATION:Atlantic/Faroe
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Atlantic/Canary.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Canary.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Canary.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Canary
+TZID:/kde.org/Olson_20071016_1/Atlantic/Canary
 X-LIC-LOCATION:Atlantic/Canary
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Atlantic/Cape_Verde.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Cape_Verde.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Cape_Verde.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Cape_Verde
+TZID:/kde.org/Olson_20071016_1/Atlantic/Cape_Verde
 X-LIC-LOCATION:Atlantic/Cape_Verde
 BEGIN:STANDARD
 TZOFFSETFROM:-013404
Index: libkcal/libical/zoneinfo/Atlantic/Bermuda.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Bermuda.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Bermuda.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Bermuda
+TZID:/kde.org/Olson_20071016_1/Atlantic/Bermuda
 X-LIC-LOCATION:Atlantic/Bermuda
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/Atlantic/Reykjavik.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Reykjavik.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Reykjavik.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Reykjavik
+TZID:/kde.org/Olson_20071016_1/Atlantic/Reykjavik
 X-LIC-LOCATION:Atlantic/Reykjavik
 BEGIN:STANDARD
 TZOFFSETFROM:-012724
Index: libkcal/libical/zoneinfo/Atlantic/South_Georgia.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/South_Georgia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/South_Georgia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/South_Georgia
+TZID:/kde.org/Olson_20071016_1/Atlantic/South_Georgia
 X-LIC-LOCATION:Atlantic/South_Georgia
 BEGIN:STANDARD
 TZOFFSETFROM:-022608
Index: libkcal/libical/zoneinfo/Atlantic/Stanley.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Stanley.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Stanley.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Stanley
+TZID:/kde.org/Olson_20071016_1/Atlantic/Stanley
 X-LIC-LOCATION:Atlantic/Stanley
 BEGIN:STANDARD
 TZOFFSETFROM:-0300
Index: libkcal/libical/zoneinfo/Atlantic/Jan_Mayen.ics
===================================================================
--- libkcal/libical/zoneinfo/Atlantic/Jan_Mayen.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Atlantic/Jan_Mayen.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Atlantic/Jan_Mayen
+TZID:/kde.org/Olson_20071016_1/Atlantic/Jan_Mayen
 X-LIC-LOCATION:Atlantic/Jan_Mayen
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Rome.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Rome.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Rome.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Rome
+TZID:/kde.org/Olson_20071016_1/Europe/Rome
 X-LIC-LOCATION:Europe/Rome
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Chisinau.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Chisinau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Chisinau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Chisinau
+TZID:/kde.org/Olson_20071016_1/Europe/Chisinau
 X-LIC-LOCATION:Europe/Chisinau
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Warsaw.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Warsaw.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Warsaw.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Warsaw
+TZID:/kde.org/Olson_20071016_1/Europe/Warsaw
 X-LIC-LOCATION:Europe/Warsaw
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Helsinki.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Helsinki.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Helsinki.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Helsinki
+TZID:/kde.org/Olson_20071016_1/Europe/Helsinki
 X-LIC-LOCATION:Europe/Helsinki
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Podgorica.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Podgorica.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Podgorica.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Podgorica
+TZID:/kde.org/Olson_20071016_1/Europe/Podgorica
 X-LIC-LOCATION:Europe/Podgorica
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Berlin.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Berlin.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Berlin.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Berlin
+TZID:/kde.org/Olson_20071016_1/Europe/Berlin
 X-LIC-LOCATION:Europe/Berlin
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Oslo.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Oslo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Oslo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Oslo
+TZID:/kde.org/Olson_20071016_1/Europe/Oslo
 X-LIC-LOCATION:Europe/Oslo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Dublin.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Dublin.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Dublin.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Dublin
+TZID:/kde.org/Olson_20071016_1/Europe/Dublin
 X-LIC-LOCATION:Europe/Dublin
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Europe/Paris.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Paris.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Paris.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Paris
+TZID:/kde.org/Olson_20071016_1/Europe/Paris
 X-LIC-LOCATION:Europe/Paris
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Simferopol.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Simferopol.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Simferopol.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Simferopol
+TZID:/kde.org/Olson_20071016_1/Europe/Simferopol
 X-LIC-LOCATION:Europe/Simferopol
 BEGIN:STANDARD
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Europe/Vienna.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Vienna.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Vienna.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Vienna
+TZID:/kde.org/Olson_20071016_1/Europe/Vienna
 X-LIC-LOCATION:Europe/Vienna
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Minsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Minsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Minsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Minsk
+TZID:/kde.org/Olson_20071016_1/Europe/Minsk
 X-LIC-LOCATION:Europe/Minsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Istanbul.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Istanbul.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Istanbul.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Istanbul
+TZID:/kde.org/Olson_20071016_1/Europe/Istanbul
 X-LIC-LOCATION:Europe/Istanbul
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Athens.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Athens.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Athens.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Athens
+TZID:/kde.org/Olson_20071016_1/Europe/Athens
 X-LIC-LOCATION:Europe/Athens
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Kaliningrad.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Kaliningrad.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Kaliningrad.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Kaliningrad
+TZID:/kde.org/Olson_20071016_1/Europe/Kaliningrad
 X-LIC-LOCATION:Europe/Kaliningrad
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Bratislava.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Bratislava.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Bratislava.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Bratislava
+TZID:/kde.org/Olson_20071016_1/Europe/Bratislava
 X-LIC-LOCATION:Europe/Bratislava
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/London.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/London.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/London.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/London
+TZID:/kde.org/Olson_20071016_1/Europe/London
 X-LIC-LOCATION:Europe/London
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Europe/Vaduz.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Vaduz.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Vaduz.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Vaduz
+TZID:/kde.org/Olson_20071016_1/Europe/Vaduz
 X-LIC-LOCATION:Europe/Vaduz
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Malta.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Malta.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Malta.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Malta
+TZID:/kde.org/Olson_20071016_1/Europe/Malta
 X-LIC-LOCATION:Europe/Malta
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Kiev.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Kiev.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Kiev.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Kiev
+TZID:/kde.org/Olson_20071016_1/Europe/Kiev
 X-LIC-LOCATION:Europe/Kiev
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Madrid.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Madrid.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Madrid.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Madrid
+TZID:/kde.org/Olson_20071016_1/Europe/Madrid
 X-LIC-LOCATION:Europe/Madrid
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Jersey.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Jersey.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Jersey.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Jersey
+TZID:/kde.org/Olson_20071016_1/Europe/Jersey
 X-LIC-LOCATION:Europe/Jersey
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Europe/Ljubljana.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Ljubljana.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Ljubljana.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Ljubljana
+TZID:/kde.org/Olson_20071016_1/Europe/Ljubljana
 X-LIC-LOCATION:Europe/Ljubljana
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Brussels.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Brussels.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Brussels.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Brussels
+TZID:/kde.org/Olson_20071016_1/Europe/Brussels
 X-LIC-LOCATION:Europe/Brussels
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Stockholm.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Stockholm.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Stockholm.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Stockholm
+TZID:/kde.org/Olson_20071016_1/Europe/Stockholm
 X-LIC-LOCATION:Europe/Stockholm
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Samara.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Samara.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Samara.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Samara
+TZID:/kde.org/Olson_20071016_1/Europe/Samara
 X-LIC-LOCATION:Europe/Samara
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0400
Index: libkcal/libical/zoneinfo/Europe/Zurich.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Zurich.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Zurich.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Zurich
+TZID:/kde.org/Olson_20071016_1/Europe/Zurich
 X-LIC-LOCATION:Europe/Zurich
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Belgrade.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Belgrade.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Belgrade.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Belgrade
+TZID:/kde.org/Olson_20071016_1/Europe/Belgrade
 X-LIC-LOCATION:Europe/Belgrade
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Moscow.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Moscow.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Moscow.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Moscow
+TZID:/kde.org/Olson_20071016_1/Europe/Moscow
 X-LIC-LOCATION:Europe/Moscow
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Europe/Budapest.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Budapest.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Budapest.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Budapest
+TZID:/kde.org/Olson_20071016_1/Europe/Budapest
 X-LIC-LOCATION:Europe/Budapest
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Copenhagen.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Copenhagen.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Copenhagen.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Copenhagen
+TZID:/kde.org/Olson_20071016_1/Europe/Copenhagen
 X-LIC-LOCATION:Europe/Copenhagen
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Gibraltar.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Gibraltar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Gibraltar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Gibraltar
+TZID:/kde.org/Olson_20071016_1/Europe/Gibraltar
 X-LIC-LOCATION:Europe/Gibraltar
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Sarajevo.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Sarajevo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Sarajevo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Sarajevo
+TZID:/kde.org/Olson_20071016_1/Europe/Sarajevo
 X-LIC-LOCATION:Europe/Sarajevo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Zagreb.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Zagreb.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Zagreb.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Zagreb
+TZID:/kde.org/Olson_20071016_1/Europe/Zagreb
 X-LIC-LOCATION:Europe/Zagreb
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Zaporozhye.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Zaporozhye.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Zaporozhye.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Zaporozhye
+TZID:/kde.org/Olson_20071016_1/Europe/Zaporozhye
 X-LIC-LOCATION:Europe/Zaporozhye
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Isle_of_Man.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Isle_of_Man.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Isle_of_Man.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Isle_of_Man
+TZID:/kde.org/Olson_20071016_1/Europe/Isle_of_Man
 X-LIC-LOCATION:Europe/Isle_of_Man
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Europe/Monaco.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Monaco.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Monaco.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Monaco
+TZID:/kde.org/Olson_20071016_1/Europe/Monaco
 X-LIC-LOCATION:Europe/Monaco
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Amsterdam.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Amsterdam.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Amsterdam.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Amsterdam
+TZID:/kde.org/Olson_20071016_1/Europe/Amsterdam
 X-LIC-LOCATION:Europe/Amsterdam
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Bucharest.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Bucharest.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Bucharest.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Bucharest
+TZID:/kde.org/Olson_20071016_1/Europe/Bucharest
 X-LIC-LOCATION:Europe/Bucharest
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Riga.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Riga.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Riga.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Riga
+TZID:/kde.org/Olson_20071016_1/Europe/Riga
 X-LIC-LOCATION:Europe/Riga
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Tirane.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Tirane.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Tirane.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Tirane
+TZID:/kde.org/Olson_20071016_1/Europe/Tirane
 X-LIC-LOCATION:Europe/Tirane
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Prague.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Prague.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Prague.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Prague
+TZID:/kde.org/Olson_20071016_1/Europe/Prague
 X-LIC-LOCATION:Europe/Prague
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Volgograd.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Volgograd.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Volgograd.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Volgograd
+TZID:/kde.org/Olson_20071016_1/Europe/Volgograd
 X-LIC-LOCATION:Europe/Volgograd
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Europe/Nicosia.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Nicosia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Nicosia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Nicosia
+TZID:/kde.org/Olson_20071016_1/Europe/Nicosia
 X-LIC-LOCATION:Europe/Nicosia
 BEGIN:STANDARD
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Europe/Vatican.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Vatican.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Vatican.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Vatican
+TZID:/kde.org/Olson_20071016_1/Europe/Vatican
 X-LIC-LOCATION:Europe/Vatican
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Lisbon.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Lisbon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Lisbon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Lisbon
+TZID:/kde.org/Olson_20071016_1/Europe/Lisbon
 X-LIC-LOCATION:Europe/Lisbon
 BEGIN:STANDARD
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Andorra.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Andorra.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Andorra.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Andorra
+TZID:/kde.org/Olson_20071016_1/Europe/Andorra
 X-LIC-LOCATION:Europe/Andorra
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/San_Marino.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/San_Marino.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/San_Marino.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/San_Marino
+TZID:/kde.org/Olson_20071016_1/Europe/San_Marino
 X-LIC-LOCATION:Europe/San_Marino
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Luxembourg.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Luxembourg.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Luxembourg.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Luxembourg
+TZID:/kde.org/Olson_20071016_1/Europe/Luxembourg
 X-LIC-LOCATION:Europe/Luxembourg
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Vilnius.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Vilnius.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Vilnius.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Vilnius
+TZID:/kde.org/Olson_20071016_1/Europe/Vilnius
 X-LIC-LOCATION:Europe/Vilnius
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Skopje.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Skopje.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Skopje.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Skopje
+TZID:/kde.org/Olson_20071016_1/Europe/Skopje
 X-LIC-LOCATION:Europe/Skopje
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Europe/Mariehamn.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Mariehamn.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Mariehamn.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Mariehamn
+TZID:/kde.org/Olson_20071016_1/Europe/Mariehamn
 X-LIC-LOCATION:Europe/Mariehamn
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Guernsey.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Guernsey.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Guernsey.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Guernsey
+TZID:/kde.org/Olson_20071016_1/Europe/Guernsey
 X-LIC-LOCATION:Europe/Guernsey
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Europe/Sofia.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Sofia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Sofia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Sofia
+TZID:/kde.org/Olson_20071016_1/Europe/Sofia
 X-LIC-LOCATION:Europe/Sofia
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Tallinn.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Tallinn.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Tallinn.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Tallinn
+TZID:/kde.org/Olson_20071016_1/Europe/Tallinn
 X-LIC-LOCATION:Europe/Tallinn
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Europe/Uzhgorod.ics
===================================================================
--- libkcal/libical/zoneinfo/Europe/Uzhgorod.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Europe/Uzhgorod.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Europe/Uzhgorod
+TZID:/kde.org/Olson_20071016_1/Europe/Uzhgorod
 X-LIC-LOCATION:Europe/Uzhgorod
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/America/Port_of_Spain.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Port_of_Spain.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Port_of_Spain.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Port_of_Spain
+TZID:/kde.org/Olson_20071016_1/America/Port_of_Spain
 X-LIC-LOCATION:America/Port_of_Spain
 BEGIN:STANDARD
 TZOFFSETFROM:-040604
Index: libkcal/libical/zoneinfo/America/Regina.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Regina.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Regina.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Regina
+TZID:/kde.org/Olson_20071016_1/America/Regina
 X-LIC-LOCATION:America/Regina
 BEGIN:STANDARD
 TZOFFSETFROM:-065836
Index: libkcal/libical/zoneinfo/America/Glace_Bay.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Glace_Bay.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Glace_Bay.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Glace_Bay
+TZID:/kde.org/Olson_20071016_1/America/Glace_Bay
 X-LIC-LOCATION:America/Glace_Bay
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Mazatlan.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Mazatlan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Mazatlan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Mazatlan
+TZID:/kde.org/Olson_20071016_1/America/Mazatlan
 X-LIC-LOCATION:America/Mazatlan
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/St_Vincent.ics
===================================================================
--- libkcal/libical/zoneinfo/America/St_Vincent.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/St_Vincent.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/St_Vincent
+TZID:/kde.org/Olson_20071016_1/America/St_Vincent
 X-LIC-LOCATION:America/St_Vincent
 BEGIN:STANDARD
 TZOFFSETFROM:-040456
Index: libkcal/libical/zoneinfo/America/Asuncion.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Asuncion.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Asuncion.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Asuncion
+TZID:/kde.org/Olson_20071016_1/America/Asuncion
 X-LIC-LOCATION:America/Asuncion
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Campo_Grande.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Campo_Grande.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Campo_Grande.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,21 +2,21 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Campo_Grande
+TZID:/kde.org/Olson_20071016_1/America/Campo_Grande
 X-LIC-LOCATION:America/Campo_Grande
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
 TZOFFSETTO:-0300
 TZNAME:AMST
-DTSTART:20061105T000000
-RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
+DTSTART:20071014T000000
+RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=2SU
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0300
 TZOFFSETTO:-0400
 TZNAME:AMT
-DTSTART:20070225T000000
-RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=-1SU
+DTSTART:20080217T000000
+RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=3SU
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:-033828
@@ -62,6 +62,7 @@
 RDATE:20031019T000000
 RDATE:20041102T000000
 RDATE:20051016T000000
+RDATE:20061105T000000
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0300
@@ -100,6 +101,7 @@
 RDATE:20040215T000000
 RDATE:20050220T000000
 RDATE:20060219T000000
+RDATE:20070225T000000
 END:STANDARD
 END:VTIMEZONE
 END:VCALENDAR
Index: libkcal/libical/zoneinfo/America/Montreal.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Montreal.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Montreal.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Montreal
+TZID:/kde.org/Olson_20071016_1/America/Montreal
 X-LIC-LOCATION:America/Montreal
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Thule.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Thule.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Thule.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Thule
+TZID:/kde.org/Olson_20071016_1/America/Thule
 X-LIC-LOCATION:America/Thule
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Cayenne.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Cayenne.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Cayenne.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Cayenne
+TZID:/kde.org/Olson_20071016_1/America/Cayenne
 X-LIC-LOCATION:America/Cayenne
 BEGIN:STANDARD
 TZOFFSETFROM:-032920
Index: libkcal/libical/zoneinfo/America/Yakutat.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Yakutat.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Yakutat.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Yakutat
+TZID:/kde.org/Olson_20071016_1/America/Yakutat
 X-LIC-LOCATION:America/Yakutat
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0900
Index: libkcal/libical/zoneinfo/America/Denver.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Denver.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Denver.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Denver
+TZID:/kde.org/Olson_20071016_1/America/Denver
 X-LIC-LOCATION:America/Denver
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Scoresbysund.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Scoresbysund.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Scoresbysund.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Scoresbysund
+TZID:/kde.org/Olson_20071016_1/America/Scoresbysund
 X-LIC-LOCATION:America/Scoresbysund
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0100
Index: libkcal/libical/zoneinfo/America/Monterrey.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Monterrey.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Monterrey.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Monterrey
+TZID:/kde.org/Olson_20071016_1/America/Monterrey
 X-LIC-LOCATION:America/Monterrey
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Jamaica.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Jamaica.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Jamaica.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Jamaica
+TZID:/kde.org/Olson_20071016_1/America/Jamaica
 X-LIC-LOCATION:America/Jamaica
 BEGIN:STANDARD
 TZOFFSETFROM:-050712
Index: libkcal/libical/zoneinfo/America/Indiana/Petersburg.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Petersburg.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Petersburg.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Petersburg
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Petersburg
 X-LIC-LOCATION:America/Indiana/Petersburg
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Indiana/Marengo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Marengo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Marengo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Marengo
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Marengo
 X-LIC-LOCATION:America/Indiana/Marengo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Indiana/Tell_City.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Tell_City.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Tell_City.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Tell_City
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Tell_City
 X-LIC-LOCATION:America/Indiana/Tell_City
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Indiana/Vincennes.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Vincennes.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Vincennes.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Vincennes
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Vincennes
 X-LIC-LOCATION:America/Indiana/Vincennes
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Indiana/Indianapolis.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Indianapolis.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Indianapolis.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Indianapolis
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Indianapolis
 X-LIC-LOCATION:America/Indiana/Indianapolis
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Indiana/Vevay.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Vevay.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Vevay.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Vevay
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Vevay
 X-LIC-LOCATION:America/Indiana/Vevay
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Indiana/Knox.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Knox.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Knox.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Knox
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Knox
 X-LIC-LOCATION:America/Indiana/Knox
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Indiana/Winamac.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Indiana/Winamac.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Indiana/Winamac.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Indiana/Winamac
+TZID:/kde.org/Olson_20071016_1/America/Indiana/Winamac
 X-LIC-LOCATION:America/Indiana/Winamac
 BEGIN:STANDARD
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Juneau.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Juneau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Juneau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Juneau
+TZID:/kde.org/Olson_20071016_1/America/Juneau
 X-LIC-LOCATION:America/Juneau
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0900
Index: libkcal/libical/zoneinfo/America/Fortaleza.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Fortaleza.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Fortaleza.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Fortaleza
+TZID:/kde.org/Olson_20071016_1/America/Fortaleza
 X-LIC-LOCATION:America/Fortaleza
 BEGIN:STANDARD
 TZOFFSETFROM:-0234
Index: libkcal/libical/zoneinfo/America/Araguaina.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Araguaina.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Araguaina.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Araguaina
+TZID:/kde.org/Olson_20071016_1/America/Araguaina
 X-LIC-LOCATION:America/Araguaina
 BEGIN:STANDARD
 TZOFFSETFROM:-031248
Index: libkcal/libical/zoneinfo/America/Yellowknife.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Yellowknife.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Yellowknife.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Yellowknife
+TZID:/kde.org/Olson_20071016_1/America/Yellowknife
 X-LIC-LOCATION:America/Yellowknife
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Miquelon.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Miquelon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Miquelon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Miquelon
+TZID:/kde.org/Olson_20071016_1/America/Miquelon
 X-LIC-LOCATION:America/Miquelon
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0300
Index: libkcal/libical/zoneinfo/America/Guadeloupe.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Guadeloupe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Guadeloupe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Guadeloupe
+TZID:/kde.org/Olson_20071016_1/America/Guadeloupe
 X-LIC-LOCATION:America/Guadeloupe
 BEGIN:STANDARD
 TZOFFSETFROM:-040608
Index: libkcal/libical/zoneinfo/America/Los_Angeles.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Los_Angeles.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Los_Angeles.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Los_Angeles
+TZID:/kde.org/Olson_20071016_1/America/Los_Angeles
 X-LIC-LOCATION:America/Los_Angeles
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0800
Index: libkcal/libical/zoneinfo/America/Tijuana.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Tijuana.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Tijuana.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Tijuana
+TZID:/kde.org/Olson_20071016_1/America/Tijuana
 X-LIC-LOCATION:America/Tijuana
 BEGIN:STANDARD
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Anguilla.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Anguilla.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Anguilla.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Anguilla
+TZID:/kde.org/Olson_20071016_1/America/Anguilla
 X-LIC-LOCATION:America/Anguilla
 BEGIN:STANDARD
 TZOFFSETFROM:-041216
Index: libkcal/libical/zoneinfo/America/Caracas.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Caracas.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Caracas.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Caracas
+TZID:/kde.org/Olson_20071016_1/America/Caracas
 X-LIC-LOCATION:America/Caracas
 BEGIN:STANDARD
 TZOFFSETFROM:-042744
@@ -25,5 +25,12 @@
 DTSTART:19650101T000000
 RDATE:19650101T000000
 END:STANDARD
+BEGIN:STANDARD
+TZOFFSETFROM:-0400
+TZOFFSETTO:-0430
+TZNAME:VET
+DTSTART:20080101T000000
+RDATE:20080101T000000
+END:STANDARD
 END:VTIMEZONE
 END:VCALENDAR
Index: libkcal/libical/zoneinfo/America/Montserrat.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Montserrat.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Montserrat.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Montserrat
+TZID:/kde.org/Olson_20071016_1/America/Montserrat
 X-LIC-LOCATION:America/Montserrat
 BEGIN:STANDARD
 TZOFFSETFROM:-040852
Index: libkcal/libical/zoneinfo/America/Chihuahua.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Chihuahua.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Chihuahua.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Chihuahua
+TZID:/kde.org/Olson_20071016_1/America/Chihuahua
 X-LIC-LOCATION:America/Chihuahua
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Guatemala.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Guatemala.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Guatemala.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Guatemala
+TZID:/kde.org/Olson_20071016_1/America/Guatemala
 X-LIC-LOCATION:America/Guatemala
 BEGIN:STANDARD
 TZOFFSETFROM:-060204
Index: libkcal/libical/zoneinfo/America/North_Dakota/New_Salem.ics
===================================================================
--- libkcal/libical/zoneinfo/America/North_Dakota/New_Salem.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/North_Dakota/New_Salem.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/North_Dakota/New_Salem
+TZID:/kde.org/Olson_20071016_1/America/North_Dakota/New_Salem
 X-LIC-LOCATION:America/North_Dakota/New_Salem
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/North_Dakota/Center.ics
===================================================================
--- libkcal/libical/zoneinfo/America/North_Dakota/Center.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/North_Dakota/Center.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/North_Dakota/Center
+TZID:/kde.org/Olson_20071016_1/America/North_Dakota/Center
 X-LIC-LOCATION:America/North_Dakota/Center
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Porto_Velho.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Porto_Velho.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Porto_Velho.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Porto_Velho
+TZID:/kde.org/Olson_20071016_1/America/Porto_Velho
 X-LIC-LOCATION:America/Porto_Velho
 BEGIN:STANDARD
 TZOFFSETFROM:-041536
Index: libkcal/libical/zoneinfo/America/Santo_Domingo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Santo_Domingo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Santo_Domingo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Santo_Domingo
+TZID:/kde.org/Olson_20071016_1/America/Santo_Domingo
 X-LIC-LOCATION:America/Santo_Domingo
 BEGIN:STANDARD
 TZOFFSETFROM:-043936
Index: libkcal/libical/zoneinfo/America/St_Thomas.ics
===================================================================
--- libkcal/libical/zoneinfo/America/St_Thomas.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/St_Thomas.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/St_Thomas
+TZID:/kde.org/Olson_20071016_1/America/St_Thomas
 X-LIC-LOCATION:America/St_Thomas
 BEGIN:STANDARD
 TZOFFSETFROM:-041944
Index: libkcal/libical/zoneinfo/America/St_Lucia.ics
===================================================================
--- libkcal/libical/zoneinfo/America/St_Lucia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/St_Lucia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/St_Lucia
+TZID:/kde.org/Olson_20071016_1/America/St_Lucia
 X-LIC-LOCATION:America/St_Lucia
 BEGIN:STANDARD
 TZOFFSETFROM:-0404
Index: libkcal/libical/zoneinfo/America/Bahia.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Bahia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Bahia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Bahia
+TZID:/kde.org/Olson_20071016_1/America/Bahia
 X-LIC-LOCATION:America/Bahia
 BEGIN:STANDARD
 TZOFFSETFROM:-023404
Index: libkcal/libical/zoneinfo/America/Noronha.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Noronha.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Noronha.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Noronha
+TZID:/kde.org/Olson_20071016_1/America/Noronha
 X-LIC-LOCATION:America/Noronha
 BEGIN:STANDARD
 TZOFFSETFROM:-020940
Index: libkcal/libical/zoneinfo/America/Santiago.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Santiago.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Santiago.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Santiago
+TZID:/kde.org/Olson_20071016_1/America/Santiago
 X-LIC-LOCATION:America/Santiago
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Boa_Vista.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Boa_Vista.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Boa_Vista.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Boa_Vista
+TZID:/kde.org/Olson_20071016_1/America/Boa_Vista
 X-LIC-LOCATION:America/Boa_Vista
 BEGIN:STANDARD
 TZOFFSETFROM:-040240
Index: libkcal/libical/zoneinfo/America/Cancun.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Cancun.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Cancun.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Cancun
+TZID:/kde.org/Olson_20071016_1/America/Cancun
 X-LIC-LOCATION:America/Cancun
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Costa_Rica.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Costa_Rica.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Costa_Rica.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Costa_Rica
+TZID:/kde.org/Olson_20071016_1/America/Costa_Rica
 X-LIC-LOCATION:America/Costa_Rica
 BEGIN:STANDARD
 TZOFFSETFROM:-053620
Index: libkcal/libical/zoneinfo/America/Cambridge_Bay.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Cambridge_Bay.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Cambridge_Bay.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Cambridge_Bay
+TZID:/kde.org/Olson_20071016_1/America/Cambridge_Bay
 X-LIC-LOCATION:America/Cambridge_Bay
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Managua.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Managua.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Managua.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Managua
+TZID:/kde.org/Olson_20071016_1/America/Managua
 X-LIC-LOCATION:America/Managua
 BEGIN:STANDARD
 TZOFFSETFROM:-054508
Index: libkcal/libical/zoneinfo/America/Phoenix.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Phoenix.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Phoenix.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Phoenix
+TZID:/kde.org/Olson_20071016_1/America/Phoenix
 X-LIC-LOCATION:America/Phoenix
 BEGIN:STANDARD
 TZOFFSETFROM:-072818
Index: libkcal/libical/zoneinfo/America/Halifax.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Halifax.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Halifax.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Halifax
+TZID:/kde.org/Olson_20071016_1/America/Halifax
 X-LIC-LOCATION:America/Halifax
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Menominee.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Menominee.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Menominee.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Menominee
+TZID:/kde.org/Olson_20071016_1/America/Menominee
 X-LIC-LOCATION:America/Menominee
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Hermosillo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Hermosillo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Hermosillo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Hermosillo
+TZID:/kde.org/Olson_20071016_1/America/Hermosillo
 X-LIC-LOCATION:America/Hermosillo
 BEGIN:STANDARD
 TZOFFSETFROM:-072352
Index: libkcal/libical/zoneinfo/America/Curacao.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Curacao.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Curacao.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Curacao
+TZID:/kde.org/Olson_20071016_1/America/Curacao
 X-LIC-LOCATION:America/Curacao
 BEGIN:STANDARD
 TZOFFSETFROM:-043544
Index: libkcal/libical/zoneinfo/America/Paramaribo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Paramaribo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Paramaribo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Paramaribo
+TZID:/kde.org/Olson_20071016_1/America/Paramaribo
 X-LIC-LOCATION:America/Paramaribo
 BEGIN:STANDARD
 TZOFFSETFROM:-034040
Index: libkcal/libical/zoneinfo/America/Martinique.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Martinique.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Martinique.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Martinique
+TZID:/kde.org/Olson_20071016_1/America/Martinique
 X-LIC-LOCATION:America/Martinique
 BEGIN:STANDARD
 TZOFFSETFROM:-040420
Index: libkcal/libical/zoneinfo/America/Winnipeg.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Winnipeg.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Winnipeg.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Winnipeg
+TZID:/kde.org/Olson_20071016_1/America/Winnipeg
 X-LIC-LOCATION:America/Winnipeg
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Lima.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Lima.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Lima.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Lima
+TZID:/kde.org/Olson_20071016_1/America/Lima
 X-LIC-LOCATION:America/Lima
 BEGIN:STANDARD
 TZOFFSETFROM:-050812
Index: libkcal/libical/zoneinfo/America/Shiprock.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Shiprock.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Shiprock.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Shiprock
+TZID:/kde.org/Olson_20071016_1/America/Shiprock
 X-LIC-LOCATION:America/Shiprock
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Edmonton.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Edmonton.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Edmonton.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Edmonton
+TZID:/kde.org/Olson_20071016_1/America/Edmonton
 X-LIC-LOCATION:America/Edmonton
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Dominica.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Dominica.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Dominica.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Dominica
+TZID:/kde.org/Olson_20071016_1/America/Dominica
 X-LIC-LOCATION:America/Dominica
 BEGIN:STANDARD
 TZOFFSETFROM:-040536
Index: libkcal/libical/zoneinfo/America/Belem.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Belem.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Belem.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Belem
+TZID:/kde.org/Olson_20071016_1/America/Belem
 X-LIC-LOCATION:America/Belem
 BEGIN:STANDARD
 TZOFFSETFROM:-031356
Index: libkcal/libical/zoneinfo/America/Anchorage.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Anchorage.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Anchorage.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Anchorage
+TZID:/kde.org/Olson_20071016_1/America/Anchorage
 X-LIC-LOCATION:America/Anchorage
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0900
Index: libkcal/libical/zoneinfo/America/Rainy_River.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Rainy_River.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Rainy_River.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Rainy_River
+TZID:/kde.org/Olson_20071016_1/America/Rainy_River
 X-LIC-LOCATION:America/Rainy_River
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Argentina/Jujuy.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Jujuy.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Jujuy.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Jujuy
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Jujuy
 X-LIC-LOCATION:America/Argentina/Jujuy
 BEGIN:STANDARD
 TZOFFSETFROM:-042112
Index: libkcal/libical/zoneinfo/America/Argentina/Rio_Gallegos.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Rio_Gallegos.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Rio_Gallegos.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Rio_Gallegos
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Rio_Gallegos
 X-LIC-LOCATION:America/Argentina/Rio_Gallegos
 BEGIN:STANDARD
 TZOFFSETFROM:-043652
Index: libkcal/libical/zoneinfo/America/Argentina/Cordoba.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Cordoba.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Cordoba.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Cordoba
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Cordoba
 X-LIC-LOCATION:America/Argentina/Cordoba
 BEGIN:STANDARD
 TZOFFSETFROM:-041648
Index: libkcal/libical/zoneinfo/America/Argentina/Catamarca.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Catamarca.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Catamarca.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Catamarca
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Catamarca
 X-LIC-LOCATION:America/Argentina/Catamarca
 BEGIN:STANDARD
 TZOFFSETFROM:-042308
Index: libkcal/libical/zoneinfo/America/Argentina/Tucuman.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Tucuman.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Tucuman.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Tucuman
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Tucuman
 X-LIC-LOCATION:America/Argentina/Tucuman
 BEGIN:STANDARD
 TZOFFSETFROM:-042052
Index: libkcal/libical/zoneinfo/America/Argentina/Mendoza.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Mendoza.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Mendoza.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Mendoza
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Mendoza
 X-LIC-LOCATION:America/Argentina/Mendoza
 BEGIN:STANDARD
 TZOFFSETFROM:-043516
Index: libkcal/libical/zoneinfo/America/Argentina/Buenos_Aires.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Buenos_Aires.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Buenos_Aires.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Buenos_Aires
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Buenos_Aires
 X-LIC-LOCATION:America/Argentina/Buenos_Aires
 BEGIN:STANDARD
 TZOFFSETFROM:-035348
Index: libkcal/libical/zoneinfo/America/Argentina/San_Juan.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/San_Juan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/San_Juan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/San_Juan
+TZID:/kde.org/Olson_20071016_1/America/Argentina/San_Juan
 X-LIC-LOCATION:America/Argentina/San_Juan
 BEGIN:STANDARD
 TZOFFSETFROM:-043404
Index: libkcal/libical/zoneinfo/America/Argentina/Ushuaia.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/Ushuaia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/Ushuaia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/Ushuaia
+TZID:/kde.org/Olson_20071016_1/America/Argentina/Ushuaia
 X-LIC-LOCATION:America/Argentina/Ushuaia
 BEGIN:STANDARD
 TZOFFSETFROM:-043312
Index: libkcal/libical/zoneinfo/America/Argentina/La_Rioja.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Argentina/La_Rioja.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Argentina/La_Rioja.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Argentina/La_Rioja
+TZID:/kde.org/Olson_20071016_1/America/Argentina/La_Rioja
 X-LIC-LOCATION:America/Argentina/La_Rioja
 BEGIN:STANDARD
 TZOFFSETFROM:-042724
Index: libkcal/libical/zoneinfo/America/Pangnirtung.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Pangnirtung.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Pangnirtung.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Pangnirtung
+TZID:/kde.org/Olson_20071016_1/America/Pangnirtung
 X-LIC-LOCATION:America/Pangnirtung
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Maceio.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Maceio.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Maceio.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Maceio
+TZID:/kde.org/Olson_20071016_1/America/Maceio
 X-LIC-LOCATION:America/Maceio
 BEGIN:STANDARD
 TZOFFSETFROM:-022252
Index: libkcal/libical/zoneinfo/America/New_York.ics
===================================================================
--- libkcal/libical/zoneinfo/America/New_York.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/New_York.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/New_York
+TZID:/kde.org/Olson_20071016_1/America/New_York
 X-LIC-LOCATION:America/New_York
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Panama.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Panama.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Panama.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Panama
+TZID:/kde.org/Olson_20071016_1/America/Panama
 X-LIC-LOCATION:America/Panama
 BEGIN:STANDARD
 TZOFFSETFROM:-051808
Index: libkcal/libical/zoneinfo/America/Adak.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Adak.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Adak.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Adak
+TZID:/kde.org/Olson_20071016_1/America/Adak
 X-LIC-LOCATION:America/Adak
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-1000
Index: libkcal/libical/zoneinfo/America/Merida.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Merida.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Merida.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Merida
+TZID:/kde.org/Olson_20071016_1/America/Merida
 X-LIC-LOCATION:America/Merida
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Resolute.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Resolute.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Resolute.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Resolute
+TZID:/kde.org/Olson_20071016_1/America/Resolute
 X-LIC-LOCATION:America/Resolute
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/America/Nipigon.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Nipigon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Nipigon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Nipigon
+TZID:/kde.org/Olson_20071016_1/America/Nipigon
 X-LIC-LOCATION:America/Nipigon
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Dawson_Creek.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Dawson_Creek.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Dawson_Creek.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Dawson_Creek
+TZID:/kde.org/Olson_20071016_1/America/Dawson_Creek
 X-LIC-LOCATION:America/Dawson_Creek
 BEGIN:STANDARD
 TZOFFSETFROM:-080056
Index: libkcal/libical/zoneinfo/America/Thunder_Bay.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Thunder_Bay.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Thunder_Bay.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Thunder_Bay
+TZID:/kde.org/Olson_20071016_1/America/Thunder_Bay
 X-LIC-LOCATION:America/Thunder_Bay
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Toronto.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Toronto.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Toronto.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Toronto
+TZID:/kde.org/Olson_20071016_1/America/Toronto
 X-LIC-LOCATION:America/Toronto
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Port-au-Prince.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Port-au-Prince.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Port-au-Prince.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Port-au-Prince
+TZID:/kde.org/Olson_20071016_1/America/Port-au-Prince
 X-LIC-LOCATION:America/Port-au-Prince
 BEGIN:STANDARD
 TZOFFSETFROM:-044920
Index: libkcal/libical/zoneinfo/America/La_Paz.ics
===================================================================
--- libkcal/libical/zoneinfo/America/La_Paz.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/La_Paz.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/La_Paz
+TZID:/kde.org/Olson_20071016_1/America/La_Paz
 X-LIC-LOCATION:America/La_Paz
 BEGIN:STANDARD
 TZOFFSETFROM:-043236
Index: libkcal/libical/zoneinfo/America/Goose_Bay.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Goose_Bay.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Goose_Bay.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Goose_Bay
+TZID:/kde.org/Olson_20071016_1/America/Goose_Bay
 X-LIC-LOCATION:America/Goose_Bay
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Godthab.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Godthab.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Godthab.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Godthab
+TZID:/kde.org/Olson_20071016_1/America/Godthab
 X-LIC-LOCATION:America/Godthab
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0300
Index: libkcal/libical/zoneinfo/America/Cayman.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Cayman.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Cayman.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Cayman
+TZID:/kde.org/Olson_20071016_1/America/Cayman
 X-LIC-LOCATION:America/Cayman
 BEGIN:STANDARD
 TZOFFSETFROM:-052532
Index: libkcal/libical/zoneinfo/America/Vancouver.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Vancouver.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Vancouver.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Vancouver
+TZID:/kde.org/Olson_20071016_1/America/Vancouver
 X-LIC-LOCATION:America/Vancouver
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0800
Index: libkcal/libical/zoneinfo/America/Bogota.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Bogota.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Bogota.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Bogota
+TZID:/kde.org/Olson_20071016_1/America/Bogota
 X-LIC-LOCATION:America/Bogota
 BEGIN:STANDARD
 TZOFFSETFROM:-045620
Index: libkcal/libical/zoneinfo/America/Moncton.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Moncton.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Moncton.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Moncton
+TZID:/kde.org/Olson_20071016_1/America/Moncton
 X-LIC-LOCATION:America/Moncton
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Rio_Branco.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Rio_Branco.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Rio_Branco.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Rio_Branco
+TZID:/kde.org/Olson_20071016_1/America/Rio_Branco
 X-LIC-LOCATION:America/Rio_Branco
 BEGIN:STANDARD
 TZOFFSETFROM:-043112
Index: libkcal/libical/zoneinfo/America/Whitehorse.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Whitehorse.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Whitehorse.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Whitehorse
+TZID:/kde.org/Olson_20071016_1/America/Whitehorse
 X-LIC-LOCATION:America/Whitehorse
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0800
Index: libkcal/libical/zoneinfo/America/Cuiaba.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Cuiaba.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Cuiaba.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,21 +2,21 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Cuiaba
+TZID:/kde.org/Olson_20071016_1/America/Cuiaba
 X-LIC-LOCATION:America/Cuiaba
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
 TZOFFSETTO:-0300
 TZNAME:AMST
-DTSTART:20061105T000000
-RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
+DTSTART:20071014T000000
+RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=2SU
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0300
 TZOFFSETTO:-0400
 TZNAME:AMT
-DTSTART:20070225T000000
-RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=-1SU
+DTSTART:20080217T000000
+RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=3SU
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:-034420
@@ -61,6 +61,7 @@
 RDATE:20021103T000000
 RDATE:20041102T000000
 RDATE:20051016T000000
+RDATE:20061105T000000
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0300
@@ -98,6 +99,7 @@
 RDATE:20030216T000000
 RDATE:20050220T000000
 RDATE:20060219T000000
+RDATE:20070225T000000
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/America/Tortola.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Tortola.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Tortola.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Tortola
+TZID:/kde.org/Olson_20071016_1/America/Tortola
 X-LIC-LOCATION:America/Tortola
 BEGIN:STANDARD
 TZOFFSETFROM:-041828
Index: libkcal/libical/zoneinfo/America/St_Johns.ics
===================================================================
--- libkcal/libical/zoneinfo/America/St_Johns.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/St_Johns.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/St_Johns
+TZID:/kde.org/Olson_20071016_1/America/St_Johns
 X-LIC-LOCATION:America/St_Johns
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0330
Index: libkcal/libical/zoneinfo/America/Antigua.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Antigua.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Antigua.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Antigua
+TZID:/kde.org/Olson_20071016_1/America/Antigua
 X-LIC-LOCATION:America/Antigua
 BEGIN:STANDARD
 TZOFFSETFROM:-040712
Index: libkcal/libical/zoneinfo/America/Puerto_Rico.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Puerto_Rico.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Puerto_Rico.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Puerto_Rico
+TZID:/kde.org/Olson_20071016_1/America/Puerto_Rico
 X-LIC-LOCATION:America/Puerto_Rico
 BEGIN:STANDARD
 TZOFFSETFROM:-042425
Index: libkcal/libical/zoneinfo/America/Havana.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Havana.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Havana.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Havana
+TZID:/kde.org/Olson_20071016_1/America/Havana
 X-LIC-LOCATION:America/Havana
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/St_Kitts.ics
===================================================================
--- libkcal/libical/zoneinfo/America/St_Kitts.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/St_Kitts.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/St_Kitts
+TZID:/kde.org/Olson_20071016_1/America/St_Kitts
 X-LIC-LOCATION:America/St_Kitts
 BEGIN:STANDARD
 TZOFFSETFROM:-041052
Index: libkcal/libical/zoneinfo/America/Inuvik.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Inuvik.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Inuvik.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Inuvik
+TZID:/kde.org/Olson_20071016_1/America/Inuvik
 X-LIC-LOCATION:America/Inuvik
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/America/Iqaluit.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Iqaluit.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Iqaluit.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Iqaluit
+TZID:/kde.org/Olson_20071016_1/America/Iqaluit
 X-LIC-LOCATION:America/Iqaluit
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Montevideo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Montevideo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Montevideo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Montevideo
+TZID:/kde.org/Olson_20071016_1/America/Montevideo
 X-LIC-LOCATION:America/Montevideo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0300
Index: libkcal/libical/zoneinfo/America/Detroit.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Detroit.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Detroit.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Detroit
+TZID:/kde.org/Olson_20071016_1/America/Detroit
 X-LIC-LOCATION:America/Detroit
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Belize.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Belize.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Belize.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Belize
+TZID:/kde.org/Olson_20071016_1/America/Belize
 X-LIC-LOCATION:America/Belize
 BEGIN:STANDARD
 TZOFFSETFROM:-055248
Index: libkcal/libical/zoneinfo/America/Eirunepe.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Eirunepe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Eirunepe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Eirunepe
+TZID:/kde.org/Olson_20071016_1/America/Eirunepe
 X-LIC-LOCATION:America/Eirunepe
 BEGIN:STANDARD
 TZOFFSETFROM:-043928
Index: libkcal/libical/zoneinfo/America/Mexico_City.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Mexico_City.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Mexico_City.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Mexico_City
+TZID:/kde.org/Olson_20071016_1/America/Mexico_City
 X-LIC-LOCATION:America/Mexico_City
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Barbados.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Barbados.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Barbados.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Barbados
+TZID:/kde.org/Olson_20071016_1/America/Barbados
 X-LIC-LOCATION:America/Barbados
 BEGIN:STANDARD
 TZOFFSETFROM:-035828
Index: libkcal/libical/zoneinfo/America/Danmarkshavn.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Danmarkshavn.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Danmarkshavn.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Danmarkshavn
+TZID:/kde.org/Olson_20071016_1/America/Danmarkshavn
 X-LIC-LOCATION:America/Danmarkshavn
 BEGIN:STANDARD
 TZOFFSETFROM:-011440
Index: libkcal/libical/zoneinfo/America/Rankin_Inlet.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Rankin_Inlet.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Rankin_Inlet.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Rankin_Inlet
+TZID:/kde.org/Olson_20071016_1/America/Rankin_Inlet
 X-LIC-LOCATION:America/Rankin_Inlet
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Kentucky/Monticello.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Kentucky/Monticello.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Kentucky/Monticello.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Kentucky/Monticello
+TZID:/kde.org/Olson_20071016_1/America/Kentucky/Monticello
 X-LIC-LOCATION:America/Kentucky/Monticello
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Kentucky/Louisville.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Kentucky/Louisville.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Kentucky/Louisville.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Kentucky/Louisville
+TZID:/kde.org/Olson_20071016_1/America/Kentucky/Louisville
 X-LIC-LOCATION:America/Kentucky/Louisville
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Sao_Paulo.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Sao_Paulo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Sao_Paulo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,21 +2,21 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Sao_Paulo
+TZID:/kde.org/Olson_20071016_1/America/Sao_Paulo
 X-LIC-LOCATION:America/Sao_Paulo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0300
 TZOFFSETTO:-0200
 TZNAME:BRST
-DTSTART:20061105T000000
-RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
+DTSTART:20071014T000000
+RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=2SU
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0200
 TZOFFSETTO:-0300
 TZNAME:BRT
-DTSTART:20070225T000000
-RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=-1SU
+DTSTART:20080217T000000
+RRULE:FREQ=YEARLY;BYMONTH=2;BYDAY=3SU
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:-030628
@@ -62,6 +62,7 @@
 RDATE:20031019T000000
 RDATE:20041102T000000
 RDATE:20051016T000000
+RDATE:20061105T000000
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:-0200
@@ -100,6 +101,7 @@
 RDATE:20040215T000000
 RDATE:20050220T000000
 RDATE:20060219T000000
+RDATE:20070225T000000
 END:STANDARD
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0200
Index: libkcal/libical/zoneinfo/America/Manaus.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Manaus.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Manaus.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Manaus
+TZID:/kde.org/Olson_20071016_1/America/Manaus
 X-LIC-LOCATION:America/Manaus
 BEGIN:STANDARD
 TZOFFSETFROM:-040004
Index: libkcal/libical/zoneinfo/America/Guyana.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Guyana.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Guyana.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Guyana
+TZID:/kde.org/Olson_20071016_1/America/Guyana
 X-LIC-LOCATION:America/Guyana
 BEGIN:STANDARD
 TZOFFSETFROM:-035240
Index: libkcal/libical/zoneinfo/America/Tegucigalpa.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Tegucigalpa.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Tegucigalpa.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Tegucigalpa
+TZID:/kde.org/Olson_20071016_1/America/Tegucigalpa
 X-LIC-LOCATION:America/Tegucigalpa
 BEGIN:STANDARD
 TZOFFSETFROM:-054852
Index: libkcal/libical/zoneinfo/America/Aruba.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Aruba.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Aruba.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Aruba
+TZID:/kde.org/Olson_20071016_1/America/Aruba
 X-LIC-LOCATION:America/Aruba
 BEGIN:STANDARD
 TZOFFSETFROM:-044024
Index: libkcal/libical/zoneinfo/America/Nassau.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Nassau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Nassau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Nassau
+TZID:/kde.org/Olson_20071016_1/America/Nassau
 X-LIC-LOCATION:America/Nassau
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/El_Salvador.ics
===================================================================
--- libkcal/libical/zoneinfo/America/El_Salvador.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/El_Salvador.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/El_Salvador
+TZID:/kde.org/Olson_20071016_1/America/El_Salvador
 X-LIC-LOCATION:America/El_Salvador
 BEGIN:STANDARD
 TZOFFSETFROM:-055648
Index: libkcal/libical/zoneinfo/America/Blanc-Sablon.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Blanc-Sablon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Blanc-Sablon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Blanc-Sablon
+TZID:/kde.org/Olson_20071016_1/America/Blanc-Sablon
 X-LIC-LOCATION:America/Blanc-Sablon
 BEGIN:STANDARD
 TZOFFSETFROM:-034828
Index: libkcal/libical/zoneinfo/America/Dawson.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Dawson.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Dawson.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Dawson
+TZID:/kde.org/Olson_20071016_1/America/Dawson
 X-LIC-LOCATION:America/Dawson
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0800
Index: libkcal/libical/zoneinfo/America/Chicago.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Chicago.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Chicago.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Chicago
+TZID:/kde.org/Olson_20071016_1/America/Chicago
 X-LIC-LOCATION:America/Chicago
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/America/Recife.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Recife.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Recife.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Recife
+TZID:/kde.org/Olson_20071016_1/America/Recife
 X-LIC-LOCATION:America/Recife
 BEGIN:STANDARD
 TZOFFSETFROM:-021936
Index: libkcal/libical/zoneinfo/America/Nome.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Nome.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Nome.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Nome
+TZID:/kde.org/Olson_20071016_1/America/Nome
 X-LIC-LOCATION:America/Nome
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0900
Index: libkcal/libical/zoneinfo/America/Swift_Current.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Swift_Current.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Swift_Current.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Swift_Current
+TZID:/kde.org/Olson_20071016_1/America/Swift_Current
 X-LIC-LOCATION:America/Swift_Current
 BEGIN:STANDARD
 TZOFFSETFROM:-071120
Index: libkcal/libical/zoneinfo/America/Grand_Turk.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Grand_Turk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Grand_Turk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Grand_Turk
+TZID:/kde.org/Olson_20071016_1/America/Grand_Turk
 X-LIC-LOCATION:America/Grand_Turk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0500
Index: libkcal/libical/zoneinfo/America/Guayaquil.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Guayaquil.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Guayaquil.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Guayaquil
+TZID:/kde.org/Olson_20071016_1/America/Guayaquil
 X-LIC-LOCATION:America/Guayaquil
 BEGIN:STANDARD
 TZOFFSETFROM:-051920
Index: libkcal/libical/zoneinfo/America/Grenada.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Grenada.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Grenada.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Grenada
+TZID:/kde.org/Olson_20071016_1/America/Grenada
 X-LIC-LOCATION:America/Grenada
 BEGIN:STANDARD
 TZOFFSETFROM:-0407
Index: libkcal/libical/zoneinfo/America/Atikokan.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Atikokan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Atikokan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Atikokan
+TZID:/kde.org/Olson_20071016_1/America/Atikokan
 X-LIC-LOCATION:America/Atikokan
 BEGIN:STANDARD
 TZOFFSETFROM:-060628
Index: libkcal/libical/zoneinfo/America/Boise.ics
===================================================================
--- libkcal/libical/zoneinfo/America/Boise.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/America/Boise.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/America/Boise
+TZID:/kde.org/Olson_20071016_1/America/Boise
 X-LIC-LOCATION:America/Boise
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0700
Index: libkcal/libical/zoneinfo/Indian/Mauritius.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Mauritius.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Mauritius.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Mauritius
+TZID:/kde.org/Olson_20071016_1/Indian/Mauritius
 X-LIC-LOCATION:Indian/Mauritius
 BEGIN:STANDARD
 TZOFFSETFROM:+0350
Index: libkcal/libical/zoneinfo/Indian/Mayotte.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Mayotte.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Mayotte.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Mayotte
+TZID:/kde.org/Olson_20071016_1/Indian/Mayotte
 X-LIC-LOCATION:Indian/Mayotte
 BEGIN:STANDARD
 TZOFFSETFROM:+030056
Index: libkcal/libical/zoneinfo/Indian/Chagos.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Chagos.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Chagos.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Chagos
+TZID:/kde.org/Olson_20071016_1/Indian/Chagos
 X-LIC-LOCATION:Indian/Chagos
 BEGIN:STANDARD
 TZOFFSETFROM:+044940
Index: libkcal/libical/zoneinfo/Indian/Maldives.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Maldives.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Maldives.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Maldives
+TZID:/kde.org/Olson_20071016_1/Indian/Maldives
 X-LIC-LOCATION:Indian/Maldives
 BEGIN:STANDARD
 TZOFFSETFROM:+0454
Index: libkcal/libical/zoneinfo/Indian/Cocos.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Cocos.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Cocos.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Cocos
+TZID:/kde.org/Olson_20071016_1/Indian/Cocos
 X-LIC-LOCATION:Indian/Cocos
 BEGIN:STANDARD
 TZOFFSETFROM:+062740
Index: libkcal/libical/zoneinfo/Indian/Mahe.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Mahe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Mahe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Mahe
+TZID:/kde.org/Olson_20071016_1/Indian/Mahe
 X-LIC-LOCATION:Indian/Mahe
 BEGIN:STANDARD
 TZOFFSETFROM:+034148
Index: libkcal/libical/zoneinfo/Indian/Christmas.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Christmas.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Christmas.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Christmas
+TZID:/kde.org/Olson_20071016_1/Indian/Christmas
 X-LIC-LOCATION:Indian/Christmas
 BEGIN:STANDARD
 TZOFFSETFROM:+070252
Index: libkcal/libical/zoneinfo/Indian/Comoro.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Comoro.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Comoro.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Comoro
+TZID:/kde.org/Olson_20071016_1/Indian/Comoro
 X-LIC-LOCATION:Indian/Comoro
 BEGIN:STANDARD
 TZOFFSETFROM:+025304
Index: libkcal/libical/zoneinfo/Indian/Reunion.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Reunion.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Reunion.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Reunion
+TZID:/kde.org/Olson_20071016_1/Indian/Reunion
 X-LIC-LOCATION:Indian/Reunion
 BEGIN:STANDARD
 TZOFFSETFROM:+034152
Index: libkcal/libical/zoneinfo/Indian/Antananarivo.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Antananarivo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Antananarivo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Antananarivo
+TZID:/kde.org/Olson_20071016_1/Indian/Antananarivo
 X-LIC-LOCATION:Indian/Antananarivo
 BEGIN:STANDARD
 TZOFFSETFROM:+031004
Index: libkcal/libical/zoneinfo/Indian/Kerguelen.ics
===================================================================
--- libkcal/libical/zoneinfo/Indian/Kerguelen.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Indian/Kerguelen.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Indian/Kerguelen
+TZID:/kde.org/Olson_20071016_1/Indian/Kerguelen
 X-LIC-LOCATION:Indian/Kerguelen
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Africa/Luanda.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Luanda.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Luanda.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Luanda
+TZID:/kde.org/Olson_20071016_1/Africa/Luanda
 X-LIC-LOCATION:Africa/Luanda
 BEGIN:STANDARD
 TZOFFSETFROM:+005256
Index: libkcal/libical/zoneinfo/Africa/Lagos.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Lagos.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Lagos.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Lagos
+TZID:/kde.org/Olson_20071016_1/Africa/Lagos
 X-LIC-LOCATION:Africa/Lagos
 BEGIN:STANDARD
 TZOFFSETFROM:+001336
Index: libkcal/libical/zoneinfo/Africa/Douala.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Douala.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Douala.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Douala
+TZID:/kde.org/Olson_20071016_1/Africa/Douala
 X-LIC-LOCATION:Africa/Douala
 BEGIN:STANDARD
 TZOFFSETFROM:+003848
Index: libkcal/libical/zoneinfo/Africa/Bangui.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Bangui.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Bangui.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Bangui
+TZID:/kde.org/Olson_20071016_1/Africa/Bangui
 X-LIC-LOCATION:Africa/Bangui
 BEGIN:STANDARD
 TZOFFSETFROM:+011420
Index: libkcal/libical/zoneinfo/Africa/Sao_Tome.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Sao_Tome.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Sao_Tome.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Sao_Tome
+TZID:/kde.org/Olson_20071016_1/Africa/Sao_Tome
 X-LIC-LOCATION:Africa/Sao_Tome
 BEGIN:STANDARD
 TZOFFSETFROM:+002656
Index: libkcal/libical/zoneinfo/Africa/Windhoek.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Windhoek.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Windhoek.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Windhoek
+TZID:/kde.org/Olson_20071016_1/Africa/Windhoek
 X-LIC-LOCATION:Africa/Windhoek
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Africa/Djibouti.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Djibouti.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Djibouti.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Djibouti
+TZID:/kde.org/Olson_20071016_1/Africa/Djibouti
 X-LIC-LOCATION:Africa/Djibouti
 BEGIN:STANDARD
 TZOFFSETFROM:+025236
Index: libkcal/libical/zoneinfo/Africa/Accra.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Accra.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Accra.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Accra
+TZID:/kde.org/Olson_20071016_1/Africa/Accra
 X-LIC-LOCATION:Africa/Accra
 BEGIN:STANDARD
 TZOFFSETFROM:-000052
Index: libkcal/libical/zoneinfo/Africa/Banjul.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Banjul.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Banjul.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Banjul
+TZID:/kde.org/Olson_20071016_1/Africa/Banjul
 X-LIC-LOCATION:Africa/Banjul
 BEGIN:STANDARD
 TZOFFSETFROM:-010636
Index: libkcal/libical/zoneinfo/Africa/El_Aaiun.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/El_Aaiun.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/El_Aaiun.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/El_Aaiun
+TZID:/kde.org/Olson_20071016_1/Africa/El_Aaiun
 X-LIC-LOCATION:Africa/El_Aaiun
 BEGIN:STANDARD
 TZOFFSETFROM:-005248
Index: libkcal/libical/zoneinfo/Africa/Ndjamena.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Ndjamena.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Ndjamena.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Ndjamena
+TZID:/kde.org/Olson_20071016_1/Africa/Ndjamena
 X-LIC-LOCATION:Africa/Ndjamena
 BEGIN:STANDARD
 TZOFFSETFROM:+010012
Index: libkcal/libical/zoneinfo/Africa/Ouagadougou.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Ouagadougou.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Ouagadougou.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Ouagadougou
+TZID:/kde.org/Olson_20071016_1/Africa/Ouagadougou
 X-LIC-LOCATION:Africa/Ouagadougou
 BEGIN:STANDARD
 TZOFFSETFROM:-000604
Index: libkcal/libical/zoneinfo/Africa/Mogadishu.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Mogadishu.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Mogadishu.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Mogadishu
+TZID:/kde.org/Olson_20071016_1/Africa/Mogadishu
 X-LIC-LOCATION:Africa/Mogadishu
 BEGIN:STANDARD
 TZOFFSETFROM:+030128
Index: libkcal/libical/zoneinfo/Africa/Porto-Novo.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Porto-Novo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Porto-Novo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Porto-Novo
+TZID:/kde.org/Olson_20071016_1/Africa/Porto-Novo
 X-LIC-LOCATION:Africa/Porto-Novo
 BEGIN:STANDARD
 TZOFFSETFROM:+001028
Index: libkcal/libical/zoneinfo/Africa/Johannesburg.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Johannesburg.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Johannesburg.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Johannesburg
+TZID:/kde.org/Olson_20071016_1/Africa/Johannesburg
 X-LIC-LOCATION:Africa/Johannesburg
 BEGIN:STANDARD
 TZOFFSETFROM:+0152
Index: libkcal/libical/zoneinfo/Africa/Brazzaville.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Brazzaville.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Brazzaville.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Brazzaville
+TZID:/kde.org/Olson_20071016_1/Africa/Brazzaville
 X-LIC-LOCATION:Africa/Brazzaville
 BEGIN:STANDARD
 TZOFFSETFROM:+010108
Index: libkcal/libical/zoneinfo/Africa/Abidjan.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Abidjan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Abidjan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Abidjan
+TZID:/kde.org/Olson_20071016_1/Africa/Abidjan
 X-LIC-LOCATION:Africa/Abidjan
 BEGIN:STANDARD
 TZOFFSETFROM:-001608
Index: libkcal/libical/zoneinfo/Africa/Libreville.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Libreville.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Libreville.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Libreville
+TZID:/kde.org/Olson_20071016_1/Africa/Libreville
 X-LIC-LOCATION:Africa/Libreville
 BEGIN:STANDARD
 TZOFFSETFROM:+003748
Index: libkcal/libical/zoneinfo/Africa/Freetown.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Freetown.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Freetown.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Freetown
+TZID:/kde.org/Olson_20071016_1/Africa/Freetown
 X-LIC-LOCATION:Africa/Freetown
 BEGIN:STANDARD
 TZOFFSETFROM:-0053
Index: libkcal/libical/zoneinfo/Africa/Addis_Ababa.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Addis_Ababa.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Addis_Ababa.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Addis_Ababa
+TZID:/kde.org/Olson_20071016_1/Africa/Addis_Ababa
 X-LIC-LOCATION:Africa/Addis_Ababa
 BEGIN:STANDARD
 TZOFFSETFROM:+023448
Index: libkcal/libical/zoneinfo/Africa/Bamako.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Bamako.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Bamako.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Bamako
+TZID:/kde.org/Olson_20071016_1/Africa/Bamako
 X-LIC-LOCATION:Africa/Bamako
 BEGIN:STANDARD
 TZOFFSETFROM:-0032
Index: libkcal/libical/zoneinfo/Africa/Lubumbashi.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Lubumbashi.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Lubumbashi.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Lubumbashi
+TZID:/kde.org/Olson_20071016_1/Africa/Lubumbashi
 X-LIC-LOCATION:Africa/Lubumbashi
 BEGIN:STANDARD
 TZOFFSETFROM:+014952
Index: libkcal/libical/zoneinfo/Africa/Gaborone.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Gaborone.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Gaborone.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Gaborone
+TZID:/kde.org/Olson_20071016_1/Africa/Gaborone
 X-LIC-LOCATION:Africa/Gaborone
 BEGIN:STANDARD
 TZOFFSETFROM:+014340
Index: libkcal/libical/zoneinfo/Africa/Cairo.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Cairo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Cairo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Cairo
+TZID:/kde.org/Olson_20071016_1/Africa/Cairo
 X-LIC-LOCATION:Africa/Cairo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
@@ -15,8 +15,8 @@
 TZOFFSETFROM:+0200
 TZOFFSETTO:+0200
 TZNAME:EET
-DTSTART:20070906T230000
-RRULE:FREQ=YEARLY;BYMONTH=9;BYDAY=1TH
+DTSTART:20080828T230000
+RRULE:FREQ=YEARLY;BYMONTH=8;BYDAY=-1TH
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:+0205
@@ -142,6 +142,7 @@
 RDATE:20040930T230000
 RDATE:20050929T230000
 RDATE:20060921T230000
+RDATE:20070906T230000
 END:STANDARD
 END:VTIMEZONE
 END:VCALENDAR
Index: libkcal/libical/zoneinfo/Africa/Kigali.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Kigali.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Kigali.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Kigali
+TZID:/kde.org/Olson_20071016_1/Africa/Kigali
 X-LIC-LOCATION:Africa/Kigali
 BEGIN:STANDARD
 TZOFFSETFROM:+020016
Index: libkcal/libical/zoneinfo/Africa/Ceuta.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Ceuta.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Ceuta.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Ceuta
+TZID:/kde.org/Olson_20071016_1/Africa/Ceuta
 X-LIC-LOCATION:Africa/Ceuta
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Africa/Harare.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Harare.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Harare.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Harare
+TZID:/kde.org/Olson_20071016_1/Africa/Harare
 X-LIC-LOCATION:Africa/Harare
 BEGIN:STANDARD
 TZOFFSETFROM:+020412
Index: libkcal/libical/zoneinfo/Africa/Tunis.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Tunis.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Tunis.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Tunis
+TZID:/kde.org/Olson_20071016_1/Africa/Tunis
 X-LIC-LOCATION:Africa/Tunis
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Africa/Asmara.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Asmara.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Asmara.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Asmara
+TZID:/kde.org/Olson_20071016_1/Africa/Asmara
 X-LIC-LOCATION:Africa/Asmara
 BEGIN:STANDARD
 TZOFFSETFROM:+023532
Index: libkcal/libical/zoneinfo/Africa/Maputo.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Maputo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Maputo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Maputo
+TZID:/kde.org/Olson_20071016_1/Africa/Maputo
 X-LIC-LOCATION:Africa/Maputo
 BEGIN:STANDARD
 TZOFFSETFROM:+021020
Index: libkcal/libical/zoneinfo/Africa/Kampala.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Kampala.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Kampala.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Kampala
+TZID:/kde.org/Olson_20071016_1/Africa/Kampala
 X-LIC-LOCATION:Africa/Kampala
 BEGIN:STANDARD
 TZOFFSETFROM:+020940
Index: libkcal/libical/zoneinfo/Africa/Conakry.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Conakry.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Conakry.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Conakry
+TZID:/kde.org/Olson_20071016_1/Africa/Conakry
 X-LIC-LOCATION:Africa/Conakry
 BEGIN:STANDARD
 TZOFFSETFROM:-005452
Index: libkcal/libical/zoneinfo/Africa/Casablanca.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Casablanca.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Casablanca.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Casablanca
+TZID:/kde.org/Olson_20071016_1/Africa/Casablanca
 X-LIC-LOCATION:Africa/Casablanca
 BEGIN:STANDARD
 TZOFFSETFROM:-003020
Index: libkcal/libical/zoneinfo/Africa/Dar_es_Salaam.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Dar_es_Salaam.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Dar_es_Salaam.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Dar_es_Salaam
+TZID:/kde.org/Olson_20071016_1/Africa/Dar_es_Salaam
 X-LIC-LOCATION:Africa/Dar_es_Salaam
 BEGIN:STANDARD
 TZOFFSETFROM:+023708
Index: libkcal/libical/zoneinfo/Africa/Nouakchott.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Nouakchott.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Nouakchott.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Nouakchott
+TZID:/kde.org/Olson_20071016_1/Africa/Nouakchott
 X-LIC-LOCATION:Africa/Nouakchott
 BEGIN:STANDARD
 TZOFFSETFROM:-010348
Index: libkcal/libical/zoneinfo/Africa/Blantyre.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Blantyre.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Blantyre.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Blantyre
+TZID:/kde.org/Olson_20071016_1/Africa/Blantyre
 X-LIC-LOCATION:Africa/Blantyre
 BEGIN:STANDARD
 TZOFFSETFROM:+0220
Index: libkcal/libical/zoneinfo/Africa/Lusaka.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Lusaka.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Lusaka.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Lusaka
+TZID:/kde.org/Olson_20071016_1/Africa/Lusaka
 X-LIC-LOCATION:Africa/Lusaka
 BEGIN:STANDARD
 TZOFFSETFROM:+015308
Index: libkcal/libical/zoneinfo/Africa/Dakar.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Dakar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Dakar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Dakar
+TZID:/kde.org/Olson_20071016_1/Africa/Dakar
 X-LIC-LOCATION:Africa/Dakar
 BEGIN:STANDARD
 TZOFFSETFROM:-010944
Index: libkcal/libical/zoneinfo/Africa/Niamey.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Niamey.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Niamey.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Niamey
+TZID:/kde.org/Olson_20071016_1/Africa/Niamey
 X-LIC-LOCATION:Africa/Niamey
 BEGIN:STANDARD
 TZOFFSETFROM:+000828
Index: libkcal/libical/zoneinfo/Africa/Tripoli.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Tripoli.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Tripoli.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Tripoli
+TZID:/kde.org/Olson_20071016_1/Africa/Tripoli
 X-LIC-LOCATION:Africa/Tripoli
 BEGIN:STANDARD
 TZOFFSETFROM:+005244
Index: libkcal/libical/zoneinfo/Africa/Nairobi.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Nairobi.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Nairobi.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Nairobi
+TZID:/kde.org/Olson_20071016_1/Africa/Nairobi
 X-LIC-LOCATION:Africa/Nairobi
 BEGIN:STANDARD
 TZOFFSETFROM:+022716
Index: libkcal/libical/zoneinfo/Africa/Mbabane.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Mbabane.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Mbabane.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Mbabane
+TZID:/kde.org/Olson_20071016_1/Africa/Mbabane
 X-LIC-LOCATION:Africa/Mbabane
 BEGIN:STANDARD
 TZOFFSETFROM:+020424
Index: libkcal/libical/zoneinfo/Africa/Algiers.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Algiers.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Algiers.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Algiers
+TZID:/kde.org/Olson_20071016_1/Africa/Algiers
 X-LIC-LOCATION:Africa/Algiers
 BEGIN:STANDARD
 TZOFFSETFROM:+001212
Index: libkcal/libical/zoneinfo/Africa/Bissau.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Bissau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Bissau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Bissau
+TZID:/kde.org/Olson_20071016_1/Africa/Bissau
 X-LIC-LOCATION:Africa/Bissau
 BEGIN:STANDARD
 TZOFFSETFROM:-010220
Index: libkcal/libical/zoneinfo/Africa/Khartoum.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Khartoum.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Khartoum.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Khartoum
+TZID:/kde.org/Olson_20071016_1/Africa/Khartoum
 X-LIC-LOCATION:Africa/Khartoum
 BEGIN:STANDARD
 TZOFFSETFROM:+021008
Index: libkcal/libical/zoneinfo/Africa/Monrovia.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Monrovia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Monrovia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Monrovia
+TZID:/kde.org/Olson_20071016_1/Africa/Monrovia
 X-LIC-LOCATION:Africa/Monrovia
 BEGIN:STANDARD
 TZOFFSETFROM:-004308
Index: libkcal/libical/zoneinfo/Africa/Malabo.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Malabo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Malabo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Malabo
+TZID:/kde.org/Olson_20071016_1/Africa/Malabo
 X-LIC-LOCATION:Africa/Malabo
 BEGIN:STANDARD
 TZOFFSETFROM:+003508
Index: libkcal/libical/zoneinfo/Africa/Lome.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Lome.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Lome.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Lome
+TZID:/kde.org/Olson_20071016_1/Africa/Lome
 X-LIC-LOCATION:Africa/Lome
 BEGIN:STANDARD
 TZOFFSETFROM:+000452
Index: libkcal/libical/zoneinfo/Africa/Bujumbura.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Bujumbura.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Bujumbura.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Bujumbura
+TZID:/kde.org/Olson_20071016_1/Africa/Bujumbura
 X-LIC-LOCATION:Africa/Bujumbura
 BEGIN:STANDARD
 TZOFFSETFROM:+015728
Index: libkcal/libical/zoneinfo/Africa/Maseru.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Maseru.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Maseru.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Maseru
+TZID:/kde.org/Olson_20071016_1/Africa/Maseru
 X-LIC-LOCATION:Africa/Maseru
 BEGIN:STANDARD
 TZOFFSETFROM:+0150
Index: libkcal/libical/zoneinfo/Africa/Kinshasa.ics
===================================================================
--- libkcal/libical/zoneinfo/Africa/Kinshasa.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Africa/Kinshasa.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Africa/Kinshasa
+TZID:/kde.org/Olson_20071016_1/Africa/Kinshasa
 X-LIC-LOCATION:Africa/Kinshasa
 BEGIN:STANDARD
 TZOFFSETFROM:+010112
Index: libkcal/libical/zoneinfo/Arctic/Longyearbyen.ics
===================================================================
--- libkcal/libical/zoneinfo/Arctic/Longyearbyen.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Arctic/Longyearbyen.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Arctic/Longyearbyen
+TZID:/kde.org/Olson_20071016_1/Arctic/Longyearbyen
 X-LIC-LOCATION:Arctic/Longyearbyen
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0100
Index: libkcal/libical/zoneinfo/Australia/Lord_Howe.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Lord_Howe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Lord_Howe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Lord_Howe
+TZID:/kde.org/Olson_20071016_1/Australia/Lord_Howe
 X-LIC-LOCATION:Australia/Lord_Howe
 BEGIN:STANDARD
 TZOFFSETFROM:+1100
Index: libkcal/libical/zoneinfo/Australia/Perth.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Perth.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Perth.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Perth
+TZID:/kde.org/Olson_20071016_1/Australia/Perth
 X-LIC-LOCATION:Australia/Perth
 BEGIN:STANDARD
 TZOFFSETFROM:+074324
Index: libkcal/libical/zoneinfo/Australia/Darwin.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Darwin.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Darwin.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Darwin
+TZID:/kde.org/Olson_20071016_1/Australia/Darwin
 X-LIC-LOCATION:Australia/Darwin
 BEGIN:STANDARD
 TZOFFSETFROM:+084320
Index: libkcal/libical/zoneinfo/Australia/Brisbane.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Brisbane.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Brisbane.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Brisbane
+TZID:/kde.org/Olson_20071016_1/Australia/Brisbane
 X-LIC-LOCATION:Australia/Brisbane
 BEGIN:STANDARD
 TZOFFSETFROM:+101208
Index: libkcal/libical/zoneinfo/Australia/Lindeman.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Lindeman.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Lindeman.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Lindeman
+TZID:/kde.org/Olson_20071016_1/Australia/Lindeman
 X-LIC-LOCATION:Australia/Lindeman
 BEGIN:STANDARD
 TZOFFSETFROM:+095556
Index: libkcal/libical/zoneinfo/Australia/Adelaide.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Adelaide.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Adelaide.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Adelaide
+TZID:/kde.org/Olson_20071016_1/Australia/Adelaide
 X-LIC-LOCATION:Australia/Adelaide
 BEGIN:STANDARD
 TZOFFSETFROM:+1030
Index: libkcal/libical/zoneinfo/Australia/Broken_Hill.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Broken_Hill.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Broken_Hill.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Broken_Hill
+TZID:/kde.org/Olson_20071016_1/Australia/Broken_Hill
 X-LIC-LOCATION:Australia/Broken_Hill
 BEGIN:STANDARD
 TZOFFSETFROM:+1030
Index: libkcal/libical/zoneinfo/Australia/Melbourne.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Melbourne.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Melbourne.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Melbourne
+TZID:/kde.org/Olson_20071016_1/Australia/Melbourne
 X-LIC-LOCATION:Australia/Melbourne
 BEGIN:STANDARD
 TZOFFSETFROM:+1100
Index: libkcal/libical/zoneinfo/Australia/Currie.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Currie.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Currie.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Currie
+TZID:/kde.org/Olson_20071016_1/Australia/Currie
 X-LIC-LOCATION:Australia/Currie
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1000
Index: libkcal/libical/zoneinfo/Australia/Eucla.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Eucla.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Eucla.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Eucla
+TZID:/kde.org/Olson_20071016_1/Australia/Eucla
 X-LIC-LOCATION:Australia/Eucla
 BEGIN:STANDARD
 TZOFFSETFROM:+083528
Index: libkcal/libical/zoneinfo/Australia/Sydney.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Sydney.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Sydney.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Sydney
+TZID:/kde.org/Olson_20071016_1/Australia/Sydney
 X-LIC-LOCATION:Australia/Sydney
 BEGIN:STANDARD
 TZOFFSETFROM:+1100
Index: libkcal/libical/zoneinfo/Australia/Hobart.ics
===================================================================
--- libkcal/libical/zoneinfo/Australia/Hobart.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Australia/Hobart.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Australia/Hobart
+TZID:/kde.org/Olson_20071016_1/Australia/Hobart
 X-LIC-LOCATION:Australia/Hobart
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1000
Index: libkcal/libical/zoneinfo/Antarctica/Syowa.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Syowa.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Syowa.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Syowa
+TZID:/kde.org/Olson_20071016_1/Antarctica/Syowa
 X-LIC-LOCATION:Antarctica/Syowa
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Casey.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Casey.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Casey.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Casey
+TZID:/kde.org/Olson_20071016_1/Antarctica/Casey
 X-LIC-LOCATION:Antarctica/Casey
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Mawson.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Mawson.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Mawson.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Mawson
+TZID:/kde.org/Olson_20071016_1/Antarctica/Mawson
 X-LIC-LOCATION:Antarctica/Mawson
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Rothera.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Rothera.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Rothera.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Rothera
+TZID:/kde.org/Olson_20071016_1/Antarctica/Rothera
 X-LIC-LOCATION:Antarctica/Rothera
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Vostok.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Vostok.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Vostok.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Vostok
+TZID:/kde.org/Olson_20071016_1/Antarctica/Vostok
 X-LIC-LOCATION:Antarctica/Vostok
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Davis.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Davis.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Davis.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Davis
+TZID:/kde.org/Olson_20071016_1/Antarctica/Davis
 X-LIC-LOCATION:Antarctica/Davis
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/McMurdo.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/McMurdo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/McMurdo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/McMurdo
+TZID:/kde.org/Olson_20071016_1/Antarctica/McMurdo
 X-LIC-LOCATION:Antarctica/McMurdo
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1200
Index: libkcal/libical/zoneinfo/Antarctica/DumontDUrville.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/DumontDUrville.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/DumontDUrville.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/DumontDUrville
+TZID:/kde.org/Olson_20071016_1/Antarctica/DumontDUrville
 X-LIC-LOCATION:Antarctica/DumontDUrville
 BEGIN:STANDARD
 TZOFFSETFROM:+0000
Index: libkcal/libical/zoneinfo/Antarctica/Palmer.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/Palmer.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/Palmer.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/Palmer
+TZID:/kde.org/Olson_20071016_1/Antarctica/Palmer
 X-LIC-LOCATION:Antarctica/Palmer
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0400
Index: libkcal/libical/zoneinfo/Antarctica/South_Pole.ics
===================================================================
--- libkcal/libical/zoneinfo/Antarctica/South_Pole.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Antarctica/South_Pole.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Antarctica/South_Pole
+TZID:/kde.org/Olson_20071016_1/Antarctica/South_Pole
 X-LIC-LOCATION:Antarctica/South_Pole
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1200
Index: libkcal/libical/zoneinfo/Asia/Makassar.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Makassar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Makassar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Makassar
+TZID:/kde.org/Olson_20071016_1/Asia/Makassar
 X-LIC-LOCATION:Asia/Makassar
 BEGIN:STANDARD
 TZOFFSETFROM:+075736
Index: libkcal/libical/zoneinfo/Asia/Karachi.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Karachi.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Karachi.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Karachi
+TZID:/kde.org/Olson_20071016_1/Asia/Karachi
 X-LIC-LOCATION:Asia/Karachi
 BEGIN:STANDARD
 TZOFFSETFROM:+042812
Index: libkcal/libical/zoneinfo/Asia/Rangoon.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Rangoon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Rangoon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Rangoon
+TZID:/kde.org/Olson_20071016_1/Asia/Rangoon
 X-LIC-LOCATION:Asia/Rangoon
 BEGIN:STANDARD
 TZOFFSETFROM:+062440
Index: libkcal/libical/zoneinfo/Asia/Harbin.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Harbin.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Harbin.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Harbin
+TZID:/kde.org/Olson_20071016_1/Asia/Harbin
 X-LIC-LOCATION:Asia/Harbin
 BEGIN:STANDARD
 TZOFFSETFROM:+082644
Index: libkcal/libical/zoneinfo/Asia/Novosibirsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Novosibirsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Novosibirsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Novosibirsk
+TZID:/kde.org/Olson_20071016_1/Asia/Novosibirsk
 X-LIC-LOCATION:Asia/Novosibirsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0600
Index: libkcal/libical/zoneinfo/Asia/Yerevan.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Yerevan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Yerevan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Yerevan
+TZID:/kde.org/Olson_20071016_1/Asia/Yerevan
 X-LIC-LOCATION:Asia/Yerevan
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0400
Index: libkcal/libical/zoneinfo/Asia/Ashgabat.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Ashgabat.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Ashgabat.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Ashgabat
+TZID:/kde.org/Olson_20071016_1/Asia/Ashgabat
 X-LIC-LOCATION:Asia/Ashgabat
 BEGIN:STANDARD
 TZOFFSETFROM:+035332
Index: libkcal/libical/zoneinfo/Asia/Ulaanbaatar.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Ulaanbaatar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Ulaanbaatar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Ulaanbaatar
+TZID:/kde.org/Olson_20071016_1/Asia/Ulaanbaatar
 X-LIC-LOCATION:Asia/Ulaanbaatar
 BEGIN:STANDARD
 TZOFFSETFROM:+070732
Index: libkcal/libical/zoneinfo/Asia/Jakarta.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Jakarta.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Jakarta.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Jakarta
+TZID:/kde.org/Olson_20071016_1/Asia/Jakarta
 X-LIC-LOCATION:Asia/Jakarta
 BEGIN:STANDARD
 TZOFFSETFROM:+070712
Index: libkcal/libical/zoneinfo/Asia/Thimphu.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Thimphu.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Thimphu.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Thimphu
+TZID:/kde.org/Olson_20071016_1/Asia/Thimphu
 X-LIC-LOCATION:Asia/Thimphu
 BEGIN:STANDARD
 TZOFFSETFROM:+055836
Index: libkcal/libical/zoneinfo/Asia/Saigon.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Saigon.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Saigon.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Saigon
+TZID:/kde.org/Olson_20071016_1/Asia/Saigon
 X-LIC-LOCATION:Asia/Saigon
 BEGIN:STANDARD
 TZOFFSETFROM:+070640
Index: libkcal/libical/zoneinfo/Asia/Riyadh.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Riyadh.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Riyadh.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Riyadh
+TZID:/kde.org/Olson_20071016_1/Asia/Riyadh
 X-LIC-LOCATION:Asia/Riyadh
 BEGIN:STANDARD
 TZOFFSETFROM:+030652
Index: libkcal/libical/zoneinfo/Asia/Bishkek.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Bishkek.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Bishkek.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Bishkek
+TZID:/kde.org/Olson_20071016_1/Asia/Bishkek
 X-LIC-LOCATION:Asia/Bishkek
 BEGIN:STANDARD
 TZOFFSETFROM:+045824
Index: libkcal/libical/zoneinfo/Asia/Dili.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Dili.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Dili.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Dili
+TZID:/kde.org/Olson_20071016_1/Asia/Dili
 X-LIC-LOCATION:Asia/Dili
 BEGIN:STANDARD
 TZOFFSETFROM:+082220
Index: libkcal/libical/zoneinfo/Asia/Istanbul.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Istanbul.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Istanbul.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Istanbul
+TZID:/kde.org/Olson_20071016_1/Asia/Istanbul
 X-LIC-LOCATION:Asia/Istanbul
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Asia/Pontianak.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Pontianak.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Pontianak.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Pontianak
+TZID:/kde.org/Olson_20071016_1/Asia/Pontianak
 X-LIC-LOCATION:Asia/Pontianak
 BEGIN:STANDARD
 TZOFFSETFROM:+071720
Index: libkcal/libical/zoneinfo/Asia/Kamchatka.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kamchatka.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kamchatka.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kamchatka
+TZID:/kde.org/Olson_20071016_1/Asia/Kamchatka
 X-LIC-LOCATION:Asia/Kamchatka
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1200
Index: libkcal/libical/zoneinfo/Asia/Seoul.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Seoul.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Seoul.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Seoul
+TZID:/kde.org/Olson_20071016_1/Asia/Seoul
 X-LIC-LOCATION:Asia/Seoul
 BEGIN:STANDARD
 TZOFFSETFROM:+082752
Index: libkcal/libical/zoneinfo/Asia/Oral.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Oral.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Oral.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Oral
+TZID:/kde.org/Olson_20071016_1/Asia/Oral
 X-LIC-LOCATION:Asia/Oral
 BEGIN:STANDARD
 TZOFFSETFROM:+032524
Index: libkcal/libical/zoneinfo/Asia/Choibalsan.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Choibalsan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Choibalsan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Choibalsan
+TZID:/kde.org/Olson_20071016_1/Asia/Choibalsan
 X-LIC-LOCATION:Asia/Choibalsan
 BEGIN:STANDARD
 TZOFFSETFROM:+0738
Index: libkcal/libical/zoneinfo/Asia/Kuwait.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kuwait.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kuwait.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kuwait
+TZID:/kde.org/Olson_20071016_1/Asia/Kuwait
 X-LIC-LOCATION:Asia/Kuwait
 BEGIN:STANDARD
 TZOFFSETFROM:+031156
Index: libkcal/libical/zoneinfo/Asia/Krasnoyarsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Krasnoyarsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Krasnoyarsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Krasnoyarsk
+TZID:/kde.org/Olson_20071016_1/Asia/Krasnoyarsk
 X-LIC-LOCATION:Asia/Krasnoyarsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0700
Index: libkcal/libical/zoneinfo/Asia/Omsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Omsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Omsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Omsk
+TZID:/kde.org/Olson_20071016_1/Asia/Omsk
 X-LIC-LOCATION:Asia/Omsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0600
Index: libkcal/libical/zoneinfo/Asia/Baghdad.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Baghdad.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Baghdad.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Baghdad
+TZID:/kde.org/Olson_20071016_1/Asia/Baghdad
 X-LIC-LOCATION:Asia/Baghdad
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Asia/Taipei.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Taipei.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Taipei.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Taipei
+TZID:/kde.org/Olson_20071016_1/Asia/Taipei
 X-LIC-LOCATION:Asia/Taipei
 BEGIN:STANDARD
 TZOFFSETFROM:+0806
Index: libkcal/libical/zoneinfo/Asia/Yekaterinburg.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Yekaterinburg.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Yekaterinburg.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Yekaterinburg
+TZID:/kde.org/Olson_20071016_1/Asia/Yekaterinburg
 X-LIC-LOCATION:Asia/Yekaterinburg
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0500
Index: libkcal/libical/zoneinfo/Asia/Jayapura.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Jayapura.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Jayapura.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Jayapura
+TZID:/kde.org/Olson_20071016_1/Asia/Jayapura
 X-LIC-LOCATION:Asia/Jayapura
 BEGIN:STANDARD
 TZOFFSETFROM:+092248
Index: libkcal/libical/zoneinfo/Asia/Baku.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Baku.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Baku.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Baku
+TZID:/kde.org/Olson_20071016_1/Asia/Baku
 X-LIC-LOCATION:Asia/Baku
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0400
Index: libkcal/libical/zoneinfo/Asia/Urumqi.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Urumqi.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Urumqi.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Urumqi
+TZID:/kde.org/Olson_20071016_1/Asia/Urumqi
 X-LIC-LOCATION:Asia/Urumqi
 BEGIN:STANDARD
 TZOFFSETFROM:+055020
Index: libkcal/libical/zoneinfo/Asia/Vientiane.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Vientiane.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Vientiane.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Vientiane
+TZID:/kde.org/Olson_20071016_1/Asia/Vientiane
 X-LIC-LOCATION:Asia/Vientiane
 BEGIN:STANDARD
 TZOFFSETFROM:+065024
Index: libkcal/libical/zoneinfo/Asia/Dubai.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Dubai.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Dubai.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Dubai
+TZID:/kde.org/Olson_20071016_1/Asia/Dubai
 X-LIC-LOCATION:Asia/Dubai
 BEGIN:STANDARD
 TZOFFSETFROM:+034112
Index: libkcal/libical/zoneinfo/Asia/Nicosia.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Nicosia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Nicosia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Nicosia
+TZID:/kde.org/Olson_20071016_1/Asia/Nicosia
 X-LIC-LOCATION:Asia/Nicosia
 BEGIN:STANDARD
 TZOFFSETFROM:+0300
Index: libkcal/libical/zoneinfo/Asia/Singapore.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Singapore.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Singapore.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Singapore
+TZID:/kde.org/Olson_20071016_1/Asia/Singapore
 X-LIC-LOCATION:Asia/Singapore
 BEGIN:STANDARD
 TZOFFSETFROM:+065525
Index: libkcal/libical/zoneinfo/Asia/Dushanbe.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Dushanbe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Dushanbe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Dushanbe
+TZID:/kde.org/Olson_20071016_1/Asia/Dushanbe
 X-LIC-LOCATION:Asia/Dushanbe
 BEGIN:STANDARD
 TZOFFSETFROM:+043512
Index: libkcal/libical/zoneinfo/Asia/Sakhalin.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Sakhalin.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Sakhalin.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Sakhalin
+TZID:/kde.org/Olson_20071016_1/Asia/Sakhalin
 X-LIC-LOCATION:Asia/Sakhalin
 BEGIN:STANDARD
 TZOFFSETFROM:+1100
Index: libkcal/libical/zoneinfo/Asia/Qyzylorda.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Qyzylorda.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Qyzylorda.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Qyzylorda
+TZID:/kde.org/Olson_20071016_1/Asia/Qyzylorda
 X-LIC-LOCATION:Asia/Qyzylorda
 BEGIN:STANDARD
 TZOFFSETFROM:+042152
Index: libkcal/libical/zoneinfo/Asia/Kabul.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kabul.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kabul.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kabul
+TZID:/kde.org/Olson_20071016_1/Asia/Kabul
 X-LIC-LOCATION:Asia/Kabul
 BEGIN:STANDARD
 TZOFFSETFROM:+043648
Index: libkcal/libical/zoneinfo/Asia/Calcutta.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Calcutta.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Calcutta.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Calcutta
+TZID:/kde.org/Olson_20071016_1/Asia/Calcutta
 X-LIC-LOCATION:Asia/Calcutta
 BEGIN:STANDARD
 TZOFFSETFROM:+055328
Index: libkcal/libical/zoneinfo/Asia/Samarkand.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Samarkand.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Samarkand.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Samarkand
+TZID:/kde.org/Olson_20071016_1/Asia/Samarkand
 X-LIC-LOCATION:Asia/Samarkand
 BEGIN:STANDARD
 TZOFFSETFROM:+042712
Index: libkcal/libical/zoneinfo/Asia/Manila.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Manila.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Manila.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Manila
+TZID:/kde.org/Olson_20071016_1/Asia/Manila
 X-LIC-LOCATION:Asia/Manila
 BEGIN:STANDARD
 TZOFFSETFROM:-1556
Index: libkcal/libical/zoneinfo/Asia/Kuala_Lumpur.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kuala_Lumpur.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kuala_Lumpur.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kuala_Lumpur
+TZID:/kde.org/Olson_20071016_1/Asia/Kuala_Lumpur
 X-LIC-LOCATION:Asia/Kuala_Lumpur
 BEGIN:STANDARD
 TZOFFSETFROM:+064646
Index: libkcal/libical/zoneinfo/Asia/Katmandu.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Katmandu.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Katmandu.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Katmandu
+TZID:/kde.org/Olson_20071016_1/Asia/Katmandu
 X-LIC-LOCATION:Asia/Katmandu
 BEGIN:STANDARD
 TZOFFSETFROM:+054116
Index: libkcal/libical/zoneinfo/Asia/Bahrain.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Bahrain.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Bahrain.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Bahrain
+TZID:/kde.org/Olson_20071016_1/Asia/Bahrain
 X-LIC-LOCATION:Asia/Bahrain
 BEGIN:STANDARD
 TZOFFSETFROM:+032220
Index: libkcal/libical/zoneinfo/Asia/Aden.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Aden.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Aden.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Aden
+TZID:/kde.org/Olson_20071016_1/Asia/Aden
 X-LIC-LOCATION:Asia/Aden
 BEGIN:STANDARD
 TZOFFSETFROM:+030048
Index: libkcal/libical/zoneinfo/Asia/Qatar.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Qatar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Qatar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Qatar
+TZID:/kde.org/Olson_20071016_1/Asia/Qatar
 X-LIC-LOCATION:Asia/Qatar
 BEGIN:STANDARD
 TZOFFSETFROM:+032608
Index: libkcal/libical/zoneinfo/Asia/Dhaka.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Dhaka.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Dhaka.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Dhaka
+TZID:/kde.org/Olson_20071016_1/Asia/Dhaka
 X-LIC-LOCATION:Asia/Dhaka
 BEGIN:STANDARD
 TZOFFSETFROM:+060140
Index: libkcal/libical/zoneinfo/Asia/Pyongyang.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Pyongyang.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Pyongyang.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Pyongyang
+TZID:/kde.org/Olson_20071016_1/Asia/Pyongyang
 X-LIC-LOCATION:Asia/Pyongyang
 BEGIN:STANDARD
 TZOFFSETFROM:+0823
Index: libkcal/libical/zoneinfo/Asia/Aqtobe.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Aqtobe.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Aqtobe.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Aqtobe
+TZID:/kde.org/Olson_20071016_1/Asia/Aqtobe
 X-LIC-LOCATION:Asia/Aqtobe
 BEGIN:STANDARD
 TZOFFSETFROM:+034840
Index: libkcal/libical/zoneinfo/Asia/Aqtau.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Aqtau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Aqtau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Aqtau
+TZID:/kde.org/Olson_20071016_1/Asia/Aqtau
 X-LIC-LOCATION:Asia/Aqtau
 BEGIN:STANDARD
 TZOFFSETFROM:+032104
Index: libkcal/libical/zoneinfo/Asia/Chongqing.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Chongqing.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Chongqing.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Chongqing
+TZID:/kde.org/Olson_20071016_1/Asia/Chongqing
 X-LIC-LOCATION:Asia/Chongqing
 BEGIN:STANDARD
 TZOFFSETFROM:+070620
Index: libkcal/libical/zoneinfo/Asia/Anadyr.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Anadyr.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Anadyr.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Anadyr
+TZID:/kde.org/Olson_20071016_1/Asia/Anadyr
 X-LIC-LOCATION:Asia/Anadyr
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1200
Index: libkcal/libical/zoneinfo/Asia/Kashgar.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kashgar.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kashgar.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kashgar
+TZID:/kde.org/Olson_20071016_1/Asia/Kashgar
 X-LIC-LOCATION:Asia/Kashgar
 BEGIN:STANDARD
 TZOFFSETFROM:+050356
Index: libkcal/libical/zoneinfo/Asia/Tashkent.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Tashkent.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Tashkent.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Tashkent
+TZID:/kde.org/Olson_20071016_1/Asia/Tashkent
 X-LIC-LOCATION:Asia/Tashkent
 BEGIN:STANDARD
 TZOFFSETFROM:+043712
Index: libkcal/libical/zoneinfo/Asia/Tehran.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Tehran.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Tehran.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Tehran
+TZID:/kde.org/Olson_20071016_1/Asia/Tehran
 X-LIC-LOCATION:Asia/Tehran
 BEGIN:STANDARD
 TZOFFSETFROM:+032544
@@ -68,6 +68,36 @@
 RDATE:20030322T000000
 RDATE:20040321T000000
 RDATE:20050322T000000
+RDATE:20080321T000000
+RDATE:20090322T000000
+RDATE:20100322T000000
+RDATE:20110322T000000
+RDATE:20120321T000000
+RDATE:20130322T000000
+RDATE:20140322T000000
+RDATE:20150322T000000
+RDATE:20160321T000000
+RDATE:20170322T000000
+RDATE:20180322T000000
+RDATE:20190322T000000
+RDATE:20200321T000000
+RDATE:20210322T000000
+RDATE:20220322T000000
+RDATE:20230322T000000
+RDATE:20240321T000000
+RDATE:20250322T000000
+RDATE:20260322T000000
+RDATE:20270322T000000
+RDATE:20280321T000000
+RDATE:20290321T000000
+RDATE:20300322T000000
+RDATE:20310322T000000
+RDATE:20320321T000000
+RDATE:20330321T000000
+RDATE:20340322T000000
+RDATE:20350322T000000
+RDATE:20360321T000000
+RDATE:20370321T000000
 END:DAYLIGHT
 BEGIN:STANDARD
 TZOFFSETFROM:+0430
@@ -91,6 +121,36 @@
 RDATE:20030922T000000
 RDATE:20040921T000000
 RDATE:20050922T000000
+RDATE:20080921T000000
+RDATE:20090922T000000
+RDATE:20100922T000000
+RDATE:20110922T000000
+RDATE:20120921T000000
+RDATE:20130922T000000
+RDATE:20140922T000000
+RDATE:20150922T000000
+RDATE:20160921T000000
+RDATE:20170922T000000
+RDATE:20180922T000000
+RDATE:20190922T000000
+RDATE:20200921T000000
+RDATE:20210922T000000
+RDATE:20220922T000000
+RDATE:20230922T000000
+RDATE:20240921T000000
+RDATE:20250922T000000
+RDATE:20260922T000000
+RDATE:20270922T000000
+RDATE:20280921T000000
+RDATE:20290921T000000
+RDATE:20300922T000000
+RDATE:20310922T000000
+RDATE:20320921T000000
+RDATE:20330921T000000
+RDATE:20340922T000000
+RDATE:20350922T000000
+RDATE:20360921T000000
+RDATE:20370921T000000
 END:STANDARD
 END:VTIMEZONE
 END:VCALENDAR
Index: libkcal/libical/zoneinfo/Asia/Magadan.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Magadan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Magadan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Magadan
+TZID:/kde.org/Olson_20071016_1/Asia/Magadan
 X-LIC-LOCATION:Asia/Magadan
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1100
Index: libkcal/libical/zoneinfo/Asia/Colombo.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Colombo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Colombo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Colombo
+TZID:/kde.org/Olson_20071016_1/Asia/Colombo
 X-LIC-LOCATION:Asia/Colombo
 BEGIN:STANDARD
 TZOFFSETFROM:+051924
Index: libkcal/libical/zoneinfo/Asia/Phnom_Penh.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Phnom_Penh.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Phnom_Penh.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Phnom_Penh
+TZID:/kde.org/Olson_20071016_1/Asia/Phnom_Penh
 X-LIC-LOCATION:Asia/Phnom_Penh
 BEGIN:STANDARD
 TZOFFSETFROM:+065940
Index: libkcal/libical/zoneinfo/Asia/Yakutsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Yakutsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Yakutsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Yakutsk
+TZID:/kde.org/Olson_20071016_1/Asia/Yakutsk
 X-LIC-LOCATION:Asia/Yakutsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0900
Index: libkcal/libical/zoneinfo/Asia/Muscat.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Muscat.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Muscat.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Muscat
+TZID:/kde.org/Olson_20071016_1/Asia/Muscat
 X-LIC-LOCATION:Asia/Muscat
 BEGIN:STANDARD
 TZOFFSETFROM:+035420
Index: libkcal/libical/zoneinfo/Asia/Damascus.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Damascus.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Damascus.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Damascus
+TZID:/kde.org/Olson_20071016_1/Asia/Damascus
 X-LIC-LOCATION:Asia/Damascus
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Asia/Hovd.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Hovd.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Hovd.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Hovd
+TZID:/kde.org/Olson_20071016_1/Asia/Hovd
 X-LIC-LOCATION:Asia/Hovd
 BEGIN:STANDARD
 TZOFFSETFROM:+060636
Index: libkcal/libical/zoneinfo/Asia/Tokyo.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Tokyo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Tokyo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Tokyo
+TZID:/kde.org/Olson_20071016_1/Asia/Tokyo
 X-LIC-LOCATION:Asia/Tokyo
 BEGIN:STANDARD
 TZOFFSETFROM:+091859
Index: libkcal/libical/zoneinfo/Asia/Vladivostok.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Vladivostok.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Vladivostok.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Vladivostok
+TZID:/kde.org/Olson_20071016_1/Asia/Vladivostok
 X-LIC-LOCATION:Asia/Vladivostok
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1000
Index: libkcal/libical/zoneinfo/Asia/Hong_Kong.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Hong_Kong.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Hong_Kong.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Hong_Kong
+TZID:/kde.org/Olson_20071016_1/Asia/Hong_Kong
 X-LIC-LOCATION:Asia/Hong_Kong
 BEGIN:STANDARD
 TZOFFSETFROM:+073636
Index: libkcal/libical/zoneinfo/Asia/Bangkok.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Bangkok.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Bangkok.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Bangkok
+TZID:/kde.org/Olson_20071016_1/Asia/Bangkok
 X-LIC-LOCATION:Asia/Bangkok
 BEGIN:STANDARD
 TZOFFSETFROM:+064204
Index: libkcal/libical/zoneinfo/Asia/Shanghai.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Shanghai.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Shanghai.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Shanghai
+TZID:/kde.org/Olson_20071016_1/Asia/Shanghai
 X-LIC-LOCATION:Asia/Shanghai
 BEGIN:STANDARD
 TZOFFSETFROM:+080552
Index: libkcal/libical/zoneinfo/Asia/Gaza.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Gaza.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Gaza.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Gaza
+TZID:/kde.org/Olson_20071016_1/Asia/Gaza
 X-LIC-LOCATION:Asia/Gaza
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
@@ -15,8 +15,8 @@
 TZOFFSETFROM:+0300
 TZOFFSETTO:+0200
 TZNAME:EET
-DTSTART:20071019T000000
-RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=3FR
+DTSTART:20070913T020000
+RRULE:FREQ=YEARLY;BYMONTH=9;BYDAY=2TH
 END:STANDARD
 BEGIN:STANDARD
 TZOFFSETFROM:+021752
Index: libkcal/libical/zoneinfo/Asia/Brunei.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Brunei.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Brunei.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Brunei
+TZID:/kde.org/Olson_20071016_1/Asia/Brunei
 X-LIC-LOCATION:Asia/Brunei
 BEGIN:STANDARD
 TZOFFSETFROM:+073940
Index: libkcal/libical/zoneinfo/Asia/Macau.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Macau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Macau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Macau
+TZID:/kde.org/Olson_20071016_1/Asia/Macau
 X-LIC-LOCATION:Asia/Macau
 BEGIN:STANDARD
 TZOFFSETFROM:+073420
Index: libkcal/libical/zoneinfo/Asia/Almaty.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Almaty.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Almaty.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Almaty
+TZID:/kde.org/Olson_20071016_1/Asia/Almaty
 X-LIC-LOCATION:Asia/Almaty
 BEGIN:STANDARD
 TZOFFSETFROM:+050748
Index: libkcal/libical/zoneinfo/Asia/Jerusalem.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Jerusalem.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Jerusalem.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Jerusalem
+TZID:/kde.org/Olson_20071016_1/Asia/Jerusalem
 X-LIC-LOCATION:Asia/Jerusalem
 BEGIN:STANDARD
 TZOFFSETFROM:+022056
Index: libkcal/libical/zoneinfo/Asia/Kuching.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Kuching.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Kuching.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Kuching
+TZID:/kde.org/Olson_20071016_1/Asia/Kuching
 X-LIC-LOCATION:Asia/Kuching
 BEGIN:STANDARD
 TZOFFSETFROM:+072120
Index: libkcal/libical/zoneinfo/Asia/Amman.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Amman.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Amman.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Amman
+TZID:/kde.org/Olson_20071016_1/Asia/Amman
 X-LIC-LOCATION:Asia/Amman
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Asia/Beirut.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Beirut.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Beirut.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Beirut
+TZID:/kde.org/Olson_20071016_1/Asia/Beirut
 X-LIC-LOCATION:Asia/Beirut
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0200
Index: libkcal/libical/zoneinfo/Asia/Irkutsk.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Irkutsk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Irkutsk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Irkutsk
+TZID:/kde.org/Olson_20071016_1/Asia/Irkutsk
 X-LIC-LOCATION:Asia/Irkutsk
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+0800
Index: libkcal/libical/zoneinfo/Asia/Tbilisi.ics
===================================================================
--- libkcal/libical/zoneinfo/Asia/Tbilisi.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Asia/Tbilisi.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Asia/Tbilisi
+TZID:/kde.org/Olson_20071016_1/Asia/Tbilisi
 X-LIC-LOCATION:Asia/Tbilisi
 BEGIN:STANDARD
 TZOFFSETFROM:+025916
Index: libkcal/libical/zoneinfo/Pacific/Palau.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Palau.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Palau.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Palau
+TZID:/kde.org/Olson_20071016_1/Pacific/Palau
 X-LIC-LOCATION:Pacific/Palau
 BEGIN:STANDARD
 TZOFFSETFROM:+085756
Index: libkcal/libical/zoneinfo/Pacific/Tongatapu.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Tongatapu.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Tongatapu.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Tongatapu
+TZID:/kde.org/Olson_20071016_1/Pacific/Tongatapu
 X-LIC-LOCATION:Pacific/Tongatapu
 BEGIN:STANDARD
 TZOFFSETFROM:+121920
Index: libkcal/libical/zoneinfo/Pacific/Fakaofo.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Fakaofo.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Fakaofo.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Fakaofo
+TZID:/kde.org/Olson_20071016_1/Pacific/Fakaofo
 X-LIC-LOCATION:Pacific/Fakaofo
 BEGIN:STANDARD
 TZOFFSETFROM:-112456
Index: libkcal/libical/zoneinfo/Pacific/Gambier.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Gambier.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Gambier.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Gambier
+TZID:/kde.org/Olson_20071016_1/Pacific/Gambier
 X-LIC-LOCATION:Pacific/Gambier
 BEGIN:STANDARD
 TZOFFSETFROM:-085948
Index: libkcal/libical/zoneinfo/Pacific/Norfolk.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Norfolk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Norfolk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Norfolk
+TZID:/kde.org/Olson_20071016_1/Pacific/Norfolk
 X-LIC-LOCATION:Pacific/Norfolk
 BEGIN:STANDARD
 TZOFFSETFROM:+111152
Index: libkcal/libical/zoneinfo/Pacific/Apia.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Apia.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Apia.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Apia
+TZID:/kde.org/Olson_20071016_1/Pacific/Apia
 X-LIC-LOCATION:Pacific/Apia
 BEGIN:STANDARD
 TZOFFSETFROM:+123304
Index: libkcal/libical/zoneinfo/Pacific/Saipan.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Saipan.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Saipan.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Saipan
+TZID:/kde.org/Olson_20071016_1/Pacific/Saipan
 X-LIC-LOCATION:Pacific/Saipan
 BEGIN:STANDARD
 TZOFFSETFROM:-1417
Index: libkcal/libical/zoneinfo/Pacific/Tarawa.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Tarawa.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Tarawa.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Tarawa
+TZID:/kde.org/Olson_20071016_1/Pacific/Tarawa
 X-LIC-LOCATION:Pacific/Tarawa
 BEGIN:STANDARD
 TZOFFSETFROM:+113204
Index: libkcal/libical/zoneinfo/Pacific/Fiji.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Fiji.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Fiji.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Fiji
+TZID:/kde.org/Olson_20071016_1/Pacific/Fiji
 X-LIC-LOCATION:Pacific/Fiji
 BEGIN:STANDARD
 TZOFFSETFROM:+115340
Index: libkcal/libical/zoneinfo/Pacific/Funafuti.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Funafuti.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Funafuti.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Funafuti
+TZID:/kde.org/Olson_20071016_1/Pacific/Funafuti
 X-LIC-LOCATION:Pacific/Funafuti
 BEGIN:STANDARD
 TZOFFSETFROM:+115652
Index: libkcal/libical/zoneinfo/Pacific/Easter.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Easter.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Easter.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Easter
+TZID:/kde.org/Olson_20071016_1/Pacific/Easter
 X-LIC-LOCATION:Pacific/Easter
 BEGIN:DAYLIGHT
 TZOFFSETFROM:-0600
Index: libkcal/libical/zoneinfo/Pacific/Port_Moresby.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Port_Moresby.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Port_Moresby.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Port_Moresby
+TZID:/kde.org/Olson_20071016_1/Pacific/Port_Moresby
 X-LIC-LOCATION:Pacific/Port_Moresby
 BEGIN:STANDARD
 TZOFFSETFROM:+094840
Index: libkcal/libical/zoneinfo/Pacific/Kosrae.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Kosrae.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Kosrae.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Kosrae
+TZID:/kde.org/Olson_20071016_1/Pacific/Kosrae
 X-LIC-LOCATION:Pacific/Kosrae
 BEGIN:STANDARD
 TZOFFSETFROM:+105156
Index: libkcal/libical/zoneinfo/Pacific/Truk.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Truk.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Truk.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Truk
+TZID:/kde.org/Olson_20071016_1/Pacific/Truk
 X-LIC-LOCATION:Pacific/Truk
 BEGIN:STANDARD
 TZOFFSETFROM:+100708
Index: libkcal/libical/zoneinfo/Pacific/Wake.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Wake.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Wake.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Wake
+TZID:/kde.org/Olson_20071016_1/Pacific/Wake
 X-LIC-LOCATION:Pacific/Wake
 BEGIN:STANDARD
 TZOFFSETFROM:+110628
Index: libkcal/libical/zoneinfo/Pacific/Guam.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Guam.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Guam.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Guam
+TZID:/kde.org/Olson_20071016_1/Pacific/Guam
 X-LIC-LOCATION:Pacific/Guam
 BEGIN:STANDARD
 TZOFFSETFROM:-1421
Index: libkcal/libical/zoneinfo/Pacific/Pago_Pago.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Pago_Pago.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Pago_Pago.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Pago_Pago
+TZID:/kde.org/Olson_20071016_1/Pacific/Pago_Pago
 X-LIC-LOCATION:Pacific/Pago_Pago
 BEGIN:STANDARD
 TZOFFSETFROM:+123712
Index: libkcal/libical/zoneinfo/Pacific/Majuro.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Majuro.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Majuro.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Majuro
+TZID:/kde.org/Olson_20071016_1/Pacific/Majuro
 X-LIC-LOCATION:Pacific/Majuro
 BEGIN:STANDARD
 TZOFFSETFROM:+112448
Index: libkcal/libical/zoneinfo/Pacific/Galapagos.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Galapagos.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Galapagos.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Galapagos
+TZID:/kde.org/Olson_20071016_1/Pacific/Galapagos
 X-LIC-LOCATION:Pacific/Galapagos
 BEGIN:STANDARD
 TZOFFSETFROM:-055824
Index: libkcal/libical/zoneinfo/Pacific/Enderbury.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Enderbury.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Enderbury.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Enderbury
+TZID:/kde.org/Olson_20071016_1/Pacific/Enderbury
 X-LIC-LOCATION:Pacific/Enderbury
 BEGIN:STANDARD
 TZOFFSETFROM:-112420
Index: libkcal/libical/zoneinfo/Pacific/Johnston.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Johnston.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Johnston.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Johnston
+TZID:/kde.org/Olson_20071016_1/Pacific/Johnston
 X-LIC-LOCATION:Pacific/Johnston
 BEGIN:STANDARD
 TZOFFSETFROM:-1000
Index: libkcal/libical/zoneinfo/Pacific/Kwajalein.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Kwajalein.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Kwajalein.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Kwajalein
+TZID:/kde.org/Olson_20071016_1/Pacific/Kwajalein
 X-LIC-LOCATION:Pacific/Kwajalein
 BEGIN:STANDARD
 TZOFFSETFROM:+110920
Index: libkcal/libical/zoneinfo/Pacific/Chatham.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Chatham.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Chatham.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Chatham
+TZID:/kde.org/Olson_20071016_1/Pacific/Chatham
 X-LIC-LOCATION:Pacific/Chatham
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1245
Index: libkcal/libical/zoneinfo/Pacific/Honolulu.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Honolulu.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Honolulu.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Honolulu
+TZID:/kde.org/Olson_20071016_1/Pacific/Honolulu
 X-LIC-LOCATION:Pacific/Honolulu
 BEGIN:STANDARD
 TZOFFSETFROM:-103126
Index: libkcal/libical/zoneinfo/Pacific/Kiritimati.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Kiritimati.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Kiritimati.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Kiritimati
+TZID:/kde.org/Olson_20071016_1/Pacific/Kiritimati
 X-LIC-LOCATION:Pacific/Kiritimati
 BEGIN:STANDARD
 TZOFFSETFROM:-102920
Index: libkcal/libical/zoneinfo/Pacific/Pitcairn.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Pitcairn.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Pitcairn.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Pitcairn
+TZID:/kde.org/Olson_20071016_1/Pacific/Pitcairn
 X-LIC-LOCATION:Pacific/Pitcairn
 BEGIN:STANDARD
 TZOFFSETFROM:-084020
Index: libkcal/libical/zoneinfo/Pacific/Ponape.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Ponape.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Ponape.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Ponape
+TZID:/kde.org/Olson_20071016_1/Pacific/Ponape
 X-LIC-LOCATION:Pacific/Ponape
 BEGIN:STANDARD
 TZOFFSETFROM:+103252
Index: libkcal/libical/zoneinfo/Pacific/Auckland.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Auckland.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Auckland.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Auckland
+TZID:/kde.org/Olson_20071016_1/Pacific/Auckland
 X-LIC-LOCATION:Pacific/Auckland
 BEGIN:DAYLIGHT
 TZOFFSETFROM:+1200
Index: libkcal/libical/zoneinfo/Pacific/Tahiti.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Tahiti.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Tahiti.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Tahiti
+TZID:/kde.org/Olson_20071016_1/Pacific/Tahiti
 X-LIC-LOCATION:Pacific/Tahiti
 BEGIN:STANDARD
 TZOFFSETFROM:-095816
Index: libkcal/libical/zoneinfo/Pacific/Noumea.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Noumea.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Noumea.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Noumea
+TZID:/kde.org/Olson_20071016_1/Pacific/Noumea
 X-LIC-LOCATION:Pacific/Noumea
 BEGIN:STANDARD
 TZOFFSETFROM:+110548
Index: libkcal/libical/zoneinfo/Pacific/Efate.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Efate.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Efate.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Efate
+TZID:/kde.org/Olson_20071016_1/Pacific/Efate
 X-LIC-LOCATION:Pacific/Efate
 BEGIN:STANDARD
 TZOFFSETFROM:+111316
Index: libkcal/libical/zoneinfo/Pacific/Nauru.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Nauru.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Nauru.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Nauru
+TZID:/kde.org/Olson_20071016_1/Pacific/Nauru
 X-LIC-LOCATION:Pacific/Nauru
 BEGIN:STANDARD
 TZOFFSETFROM:+110740
Index: libkcal/libical/zoneinfo/Pacific/Midway.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Midway.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Midway.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Midway
+TZID:/kde.org/Olson_20071016_1/Pacific/Midway
 X-LIC-LOCATION:Pacific/Midway
 BEGIN:STANDARD
 TZOFFSETFROM:-114928
Index: libkcal/libical/zoneinfo/Pacific/Wallis.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Wallis.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Wallis.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Wallis
+TZID:/kde.org/Olson_20071016_1/Pacific/Wallis
 X-LIC-LOCATION:Pacific/Wallis
 BEGIN:STANDARD
 TZOFFSETFROM:+121520
Index: libkcal/libical/zoneinfo/Pacific/Rarotonga.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Rarotonga.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Rarotonga.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Rarotonga
+TZID:/kde.org/Olson_20071016_1/Pacific/Rarotonga
 X-LIC-LOCATION:Pacific/Rarotonga
 BEGIN:STANDARD
 TZOFFSETFROM:-103904
Index: libkcal/libical/zoneinfo/Pacific/Guadalcanal.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Guadalcanal.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Guadalcanal.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Guadalcanal
+TZID:/kde.org/Olson_20071016_1/Pacific/Guadalcanal
 X-LIC-LOCATION:Pacific/Guadalcanal
 BEGIN:STANDARD
 TZOFFSETFROM:+103948
Index: libkcal/libical/zoneinfo/Pacific/Niue.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Niue.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Niue.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Niue
+TZID:/kde.org/Olson_20071016_1/Pacific/Niue
 X-LIC-LOCATION:Pacific/Niue
 BEGIN:STANDARD
 TZOFFSETFROM:-111940
Index: libkcal/libical/zoneinfo/Pacific/Marquesas.ics
===================================================================
--- libkcal/libical/zoneinfo/Pacific/Marquesas.ics	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/libical/zoneinfo/Pacific/Marquesas.ics	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -2,7 +2,7 @@
 PRODID:-//KDE//NONSGML KCal Olson-VTIMEZONE Converter//EN
 VERSION:2.0
 BEGIN:VTIMEZONE
-TZID:/kde.org/Olson_20070903_1/Pacific/Marquesas
+TZID:/kde.org/Olson_20071016_1/Pacific/Marquesas
 X-LIC-LOCATION:Pacific/Marquesas
 BEGIN:STANDARD
 TZOFFSETFROM:-0918
Index: libkcal/calendarlocal.cpp
===================================================================
--- libkcal/calendarlocal.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/calendarlocal.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -350,6 +350,20 @@
 }
 
 
+void CalendarLocal::incidenceUpdated( IncidenceBase *incidence )
+{
+  incidence->setSyncStatusSilent( Event::SYNCMOD );
+  incidence->setLastModified( QDateTime::currentDateTime() );
+  // we should probably update the revision number here,
+  // or internally in the Event itself when certain things change.
+  // need to verify with ical documentation.
+
+  // The static_cast is ok as the CalendarLocal only observes Incidence objects
+  notifyIncidenceChanged( static_cast<Incidence *>( incidence ) );
+
+  setModified( true );
+}
+
 void CalendarLocal::insertEvent( Event *event )
 {
   QString uid = event->uid();
Index: libkcal/event.h
===================================================================
--- libkcal/event.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/event.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -45,6 +45,7 @@
     Event();
     Event( const Event & );
     ~Event();
+    Event& operator=( const Event &e );
     bool operator==( const Event & ) const;
 
     QCString type() const { return "Event"; }
Index: libkcal/attachment.cpp
===================================================================
--- libkcal/attachment.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/attachment.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -77,7 +77,8 @@
 char *Attachment::data() const
 {
   if (mBinary)
-    return mData.utf8().data();
+    // this method actually return a const char*, but that can't be done because of the uneededly non-const libical API
+    return const_cast<char*>( mData.latin1() ); //mData.utf8().data();
   else
     return 0;
 }
Index: libkcal/icalformatimpl.cpp
===================================================================
--- libkcal/icalformatimpl.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/icalformatimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,6 +28,7 @@
 
 #include <kdebug.h>
 #include <klocale.h>
+#include <kmdcodec.h>
 
 extern "C" {
   #include <ical.h>
@@ -610,6 +611,16 @@
     icalproperty_add_parameter(p,icalparameter_uid);
   }
 
+  if ( !attendee->delegate().isEmpty() ) {
+    icalparameter* icalparameter_delegate = icalparameter_new_delegatedto( attendee->delegate().utf8() );
+    icalproperty_add_parameter( p, icalparameter_delegate );
+  }
+
+  if ( !attendee->delegator().isEmpty() ) {
+    icalparameter* icalparameter_delegator = icalparameter_new_delegatedfrom( attendee->delegator().utf8() );
+    icalproperty_add_parameter( p, icalparameter_delegator );
+  }
+
   return p;
 }
 
@@ -1068,13 +1079,19 @@
       case ICAL_FREEBUSY_PROPERTY: { //Any FreeBusy Times
         icalperiodtype icalperiod = icalproperty_get_freebusy(p);
         QDateTime period_start = readICalDateTime(icalperiod.start);
+        Period period;
         if ( !icaltime_is_null_time(icalperiod.end) ) {
           QDateTime period_end = readICalDateTime(icalperiod.end);
-          periods.append( Period(period_start, period_end) );
+          period = Period(period_start, period_end);
         } else {
           Duration duration = readICalDuration( icalperiod.duration );
-          periods.append( Period(period_start, duration) );
+          period = Period(period_start, duration);
         }
+        QCString param = icalproperty_get_parameter_as_string( p, "X-SUMMARY" );
+        period.setSummary( QString::fromUtf8( KCodecs::base64Decode( param ) ) );
+        param = icalproperty_get_parameter_as_string( p, "X-LOCATION" );
+        period.setLocation( QString::fromUtf8( KCodecs::base64Decode( param ) ) );
+        periods.append( period );
         break;}
 
       default:
@@ -1183,7 +1200,17 @@
     p = icalproperty_get_next_parameter(attendee,ICAL_X_PARAMETER);
   } */
 
-  return new Attendee( name, email, rsvp, status, role, uid );
+  Attendee *a = new Attendee( name, email, rsvp, status, role, uid );
+
+  p = icalproperty_get_first_parameter( attendee, ICAL_DELEGATEDTO_PARAMETER );
+  if ( p )
+    a->setDelegate( icalparameter_get_delegatedto( p ) );
+
+  p = icalproperty_get_first_parameter( attendee, ICAL_DELEGATEDFROM_PARAMETER );
+  if ( p )
+    a->setDelegator( icalparameter_get_delegatedfrom( p ) );
+
+  return a;
 }
 
 Person ICalFormatImpl::readOrganizer( icalproperty *organizer )
@@ -1211,7 +1238,7 @@
 
   icalvalue_kind value_kind = icalvalue_isa(icalproperty_get_value(attach));
 
-  if ( value_kind == ICAL_ATTACH_VALUE ) {
+  if ( value_kind == ICAL_ATTACH_VALUE || value_kind == ICAL_BINARY_VALUE ) {
     icalattach *a = icalproperty_get_attach(attach);
 
     int isurl = icalattach_get_is_url (a);
@@ -1229,6 +1256,13 @@
   if (p && attachment)
     attachment->setMimeType(QString(icalparameter_get_fmttype(p)));
 
+  p = icalproperty_get_first_parameter(attach,ICAL_X_PARAMETER);
+  while (p) {
+   if ( strncmp (icalparameter_get_xname(p), "X-LABEL", 7) == 0 )
+     attachment->setLabel( icalparameter_get_xvalue(p) );
+    p = icalproperty_get_next_parameter(attach, ICAL_X_PARAMETER);
+  }
+
   return attachment;
 }
 
@@ -1454,7 +1488,7 @@
   icalproperty *next =0;
 
   for ( p = icalcomponent_get_first_property(parent,ICAL_X_PROPERTY);
-       p != 0; 
+       p != 0;
        p = next )
   {
 
Index: libkcal/incidenceformatter.h
===================================================================
--- libkcal/incidenceformatter.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidenceformatter.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,6 +36,7 @@
   public:
     virtual QString generateLinkURL( const QString &id ) { return id; }
     virtual QString makeLink( const QString &id, const QString &text );
+    virtual Calendar* calendar() const { return 0; }
 };
 
 /**
@@ -60,11 +61,14 @@
                                          InvitationFormatterHelper *helper );
     // Transform a TNEF attachment to an iCal or vCard
     static QString msTNEFToVPart( const QByteArray& tnef );
+
+    static QString recurrenceString( Incidence *incidence );
   private:
     class EventViewerVisitor;
     class ScheduleMessageVisitor;
     class InvitationHeaderVisitor;
     class InvitationBodyVisitor;
+    class IncidenceCompareVisitor;
     class ToolTipVisitor;
     class MailBodyVisitor;
 };
Index: libkcal/todo.h
===================================================================
--- libkcal/todo.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/todo.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -36,6 +36,7 @@
     Todo();
     Todo( const Todo & );
     ~Todo();
+    Todo& operator=( const Todo& );
     bool operator==( const Todo& ) const;
 
     QCString type() const { return "Todo"; }
Index: libkcal/calendar.h
===================================================================
--- libkcal/calendar.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/calendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -374,6 +374,12 @@
     Incidence *incidenceFromSchedulingID( const QString &sid );
 
     /**
+     * Searches all events and todos for (an incidence with this
+     * scheduling ID. Returns a list of matching results.
+     **/
+    Incidence::List incidencesFromSchedulingID( const QString &UID );
+
+    /**
        Create a merged list of Events, Todos, and Journals.
 
        @param events is an Event list to merge.
Index: libkcal/event.cpp
===================================================================
--- libkcal/event.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/event.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,6 +50,15 @@
   return new Event(*this);
 }
 
+Event& Event::operator=( const Event &e )
+{
+  Incidence::operator=( e );
+  mDtEnd = e.mDtEnd;
+  mHasEndDate = e.mHasEndDate;
+  mTransparency = e.mTransparency;
+  return *this;
+}
+
 bool Event::operator==( const Event& e2 ) const
 {
     return
Index: libkcal/tests/testrecurrencetype.cpp
===================================================================
--- libkcal/tests/testrecurrencetype.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testrecurrencetype.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,10 @@
 
 #include "calendarlocal.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -57,6 +61,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   kdDebug(5800) << "Input file: " << input << endl;
 
Index: libkcal/tests/testrecurson.cpp
===================================================================
--- libkcal/tests/testrecurson.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testrecurson.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,10 @@
 
 #include "calendarlocal.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -57,6 +61,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   kdDebug(5800) << "Input file: " << input << endl;
 
Index: libkcal/tests/readandwrite.cpp
===================================================================
--- libkcal/tests/readandwrite.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/readandwrite.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -21,6 +21,10 @@
 
 #include "calendarlocal.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -54,6 +58,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   QString output = QFile::decodeName( args->arg( 1 ) );
 
Index: libkcal/tests/testrecurprevious.cpp
===================================================================
--- libkcal/tests/testrecurprevious.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testrecurprevious.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,10 @@
 
 #include "calendarlocal.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -57,6 +61,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   kdDebug(5800) << "Input file: " << input << endl;
 
Index: libkcal/tests/testincidence.cpp
===================================================================
--- libkcal/tests/testincidence.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testincidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -43,8 +43,7 @@
   KCmdLineArgs::init(argc,argv,&aboutData);
   KCmdLineArgs::addCmdLineOptions( options );
 
-//  KApplication app( false, false );
-  KApplication app;
+ KApplication app( false, false );
 
   KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
 
@@ -79,7 +78,7 @@
   QString todoString1 = f.toString( todo1 );
   if( verbose )
     kdDebug(5800) << "todo1 START:" << todoString1 << "todo1 END" << endl;
-    
+
   Incidence *todo2 = todo1->clone();
   QString todoString2 = f.toString( todo2 );
   if( verbose )
Index: libkcal/tests/testfb.cpp
===================================================================
--- libkcal/tests/testfb.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ libkcal/tests/testfb.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,64 @@
+/*
+    This file is part of libkcal.
+
+    Copyright (c) 2003 Cornelius Schumacher <schumacher@kde.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include <iostream>
+#include <kdebug.h>
+
+#include "event.h"
+#include "icalformat.h"
+#include "freebusy.h"
+
+using namespace KCal;
+
+int main( int, char ** )
+{
+  const QString fbString =
+    "BEGIN:VCALENDAR\n" 
+    "PRODID:-//proko2//freebusy 1.0//EN\n"
+    "METHOD:PUBLISH\n"
+    "VERSION:2.0\n"
+    "BEGIN:VFREEBUSY\n"
+    "ORGANIZER:MAILTO:test3@kdab.net\n"
+    "X-KDE-Foo:bla\n"
+    "DTSTAMP:20071202T152453Z\n"
+    "URL:http://mail.kdab.net/freebusy/test3%40kdab.net.ifb\n"
+    "DTSTART:19700101T000000Z\n"
+    "DTEND:200700101T000000Z\n"
+    "COMMENT:This is a dummy vfreebusy that indicates an empty calendar\n"
+    "FREEBUSY:19700101T000000Z/19700101T000000Z\n"
+    "FREEBUSY;X-UID=bGlia2NhbC0xODk4MjgxNTcuMTAxMA==;X-\n"
+    " SUMMARY=RW1wbG95ZWUgbWVldGluZw==;X-LOCATION=Um9vb\n"
+    " SAyMTM=:20080131T170000Z/20080131T174500Z\n"
+    "END:VFREEBUSY\n"
+    "END:VCALENDAR\n";
+
+  ICalFormat format;
+  FreeBusy *fb = format.parseFreeBusy( fbString );
+  kdDebug() << fb->busyPeriods().count() << " " << fb->dtStart() << endl;
+  const PeriodList l = fb->busyPeriods();
+  for ( PeriodList::ConstIterator it = l.begin(); it != l.end(); ++it )
+    kdDebug() << (*it).start() << " " << (*it).end() << "+ " << (*it).summary() << ":" << (*it).location() << endl;
+
+  typedef QMap<QCString, QString> FooMap;
+  const FooMap props = fb->customProperties();
+  for ( FooMap::ConstIterator it = props.begin(); it != props.end(); ++it )
+    kdDebug() << it.key() << ": " << it.data() << endl;
+}
Index: libkcal/tests/testvcalexport.cpp
===================================================================
--- libkcal/tests/testvcalexport.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testvcalexport.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,10 @@
 #include "vcalformat.h"
 #include "filestorage.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -50,7 +54,7 @@
   KCmdLineArgs::init( argc, argv, &aboutData );
   KCmdLineArgs::addCmdLineOptions( options );
 
-  KApplication app/*( false, false )*/;
+  KApplication app( false, false );
 
   KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
 
@@ -58,6 +62,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   QString output = QFile::decodeName( args->arg( 1 ) );
 
Index: libkcal/tests/Makefile.am
===================================================================
--- libkcal/tests/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,10 @@
-INCLUDES = -I$(top_srcdir)/libkcal -I$(top_srcdir) $(all_includes)
+INCLUDES = -I$(top_srcdir)/libkcal \
+  -I$(srcdir)/../libical/src/libical \
+  -I$(srcdir)/../libical/src/libicalss -I../libical/src/libical \
+  -I../libical/src/libicalss -I$(srcdir)/../versit \
+  -I$(top_srcdir) $(all_includes)
 
+AM_CPPFLAGS = -DKDETOPSRCDIR=\"$(top_srcdir)\"
 
 check_PROGRAMS = testtostring \
                  testincidence \
@@ -12,7 +17,8 @@
                  testrecurprevious \
                  testrecurson \
                  testrecurrencetype \
-                 testvcalexport
+                 testvcalexport \
+                 testfb
 
 
 METASOURCES = AUTO
@@ -66,22 +72,26 @@
 testfields_LDADD   = ../libkcal.la
 testfields_CXXFLAGS= -DINPUT='"$(srcdir)/data/test_pilot.ics"'
 
+testfb_SOURCES = testfb.cpp
+testfb_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+testfb_LDADD = ../libkcal.la
+
 TESTFILES = test1.ics test2.ics test3.ics test4.ics test5.ics test_Mozilla.ics
 
 check-local: readandwrite testrecurrence testrecurprevious testrecurson testvcalexport
-	rm -f FAILED; \
+	rm -f FAILED;
 	for i in `find $(srcdir)/data/RecurrenceRule/ -name "*.ics"`; do \
 	  perl $(srcdir)/runtestcase.pl testrecurrence "next" $$i; \
-	done; \
+	done;
 	for i in `find $(srcdir)/data/RecurrenceRule/ -name "*.ics"`; do \
 	  perl $(srcdir)/runtestcase.pl testrecurprevious "prev" $$i; \
-	done; \
+	done;
 	for i in `find $(srcdir)/data/RecurrenceRule/ -name "*.ics"`; do \
 	  perl $(srcdir)/runtestcase.pl testrecurson "recurson" $$i; \
-	done; \
-	for i in `find $(srcdir)/data/Compat/ -name "*.ics"`; do \
-	  perl $(srcdir)/runtestcase.pl readandwrite "ical" $$i; \
-	done; \
+	done;
+#	for i in `find $(srcdir)/data/Compat/ -name "*.ics"`; do \
+#	  perl $(srcdir)/runtestcase.pl readandwrite "ical" $$i; \
+#	done;
 	for i in `find $(srcdir)/data/vCalendar/ -name "*.ics"`; do \
 	  perl $(srcdir)/runtestcase.pl testvcalexport "vcal" $$i; \
 	done;
Index: libkcal/tests/testrecurrence.cpp
===================================================================
--- libkcal/tests/testrecurrence.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/tests/testrecurrence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,10 @@
 
 #include "calendarlocal.h"
 
+extern "C" {
+#include "icaltimezone.h"
+}
+
 #include <kaboutdata.h>
 #include <kapplication.h>
 #include <kdebug.h>
@@ -57,6 +61,9 @@
     args->usage( "Wrong number of arguments." );
   }
 
+  // use zoneinfo data from source dir
+  set_zone_directory( KDETOPSRCDIR "/libkcal/libical/zoneinfo" );
+
   QString input = QFile::decodeName( args->arg( 0 ) );
   kdDebug(5800) << "Input file: " << input << endl;
 
Index: libkcal/period.cpp
===================================================================
--- libkcal/period.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/period.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -70,3 +70,23 @@
 {
   return mHasDuration;
 }
+
+QString KCal::Period::summary() const
+{
+  return mSummary;
+}
+
+void KCal::Period::setSummary(const QString & summary)
+{
+  mSummary = summary;
+}
+
+QString KCal::Period::location() const
+{
+  return mLocation;
+}
+
+void KCal::Period::setLocation(const QString & location)
+{
+  mLocation = location;
+}
Index: libkcal/incidence.h
===================================================================
--- libkcal/incidence.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidence.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -96,6 +96,7 @@
     Incidence( const Incidence & );
     ~Incidence();
 
+    Incidence& operator=( const Incidence &i );
     bool operator==( const Incidence & ) const;
 
     /**
@@ -113,7 +114,7 @@
 
     /** Set whether the incidence floats, i.e. has a date but no time attached to it. */
     void setFloats( bool f );
-    
+
     /**
       Recreate event. The event is made a new unique event, but already stored
       event information is preserved. Sets uniquie id, creation date, last
Index: libkcal/resourcecalendar.h
===================================================================
--- libkcal/resourcecalendar.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/resourcecalendar.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -181,7 +181,7 @@
       keys are resource specific.
 
       This method is provided to make it possible
-      to set resource-type specific settings without actually linking to 
+      to set resource-type specific settings without actually linking to
       the resource's library. Its use is discouraged, but in
       some situations the only possibility to avoid unwanted compiling and
       linking dependencies. E.g. if you don't want to link to the remote
@@ -314,6 +314,11 @@
     virtual QStringList subresources() const { return QStringList(); }
 
     /**
+      Is this subresource capable of having subresources or not?
+    */
+    virtual bool canHaveSubresources() const { return false; }
+
+    /**
       Is this subresource active or not?
     */
     virtual bool subresourceActive( const QString& ) const { return true; }
@@ -333,9 +338,28 @@
 
       @return the identifier of the subresource or an empty string.
     */
-    virtual QString subresourceIdentifier( Incidence *incidence ) 
+    virtual QString subresourceIdentifier( Incidence *incidence )
     { Q_UNUSED( incidence ); return QString(); }
 
+
+
+    /**
+     * Remove a subresource with the id @param resource
+     */
+    virtual bool removeSubresource( const QString& resource );
+
+    /**
+     * Add a subresource with the name @param resource and the parent
+     * id @param parent.
+     */
+    virtual bool addSubresource( const QString& resource, const QString& parent );
+
+    /**
+     * Returns the type of the subresource: "event", "todo" or "journal",
+     * QString() if unknown/mixed.
+     */
+    virtual QString subresourceType( const QString &resource );
+
   public slots:
     /**
       (De-)activate a subresource.
Index: libkcal/calendarlocal.h
===================================================================
--- libkcal/calendarlocal.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/calendarlocal.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -193,6 +193,9 @@
   
   protected:
 
+    /** Notification function of IncidenceBase::Observer. */
+    void incidenceUpdated( IncidenceBase *i );
+
     /** inserts an event into its "proper place" in the calendar. */
     void insertEvent( Event *event );
 
Index: libkcal/attendee.h
===================================================================
--- libkcal/attendee.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/attendee.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,6 +23,7 @@
 #define KCAL_ATTENDEE_H
 
 #include <qstring.h>
+#include <qstringlist.h>
 
 #include "listbase.h"
 #include "person.h"
@@ -40,10 +41,10 @@
     enum Role { ReqParticipant, OptParticipant, NonParticipant, Chair };
 
     typedef ListBase<Attendee> List;
-  
+
     /**
       Create Attendee.
-      
+
       @param name Name
       @param email Email address
       @param rsvp Request for reply
@@ -64,12 +65,12 @@
     */
     // FIXME: List of roles still has to be documented.
     void setRole( Role );
-    
+
     /**
       Return role of Attendee.
     */
     Role role() const;
-    
+
     /**
       Return role as clear text string.
     */
@@ -101,7 +102,7 @@
       Return status.
     */
     PartStat status() const;
-    
+
     /**
       Return status as human-readable string.
     */
@@ -124,11 +125,31 @@
     */
     bool RSVP() const { return mRSVP; }
 
+    /**
+      Sets the delegate.
+    */
+    void setDelegate( const QString &delegate ) { mDelegate = delegate; }
+    /**
+      Returns the delegate.
+    */
+    QString delegate() const { return mDelegate; }
+
+    /**
+      Sets the delegator.
+    */
+    void setDelegator( const QString &delegator ) { mDelegator = delegator; }
+    /**
+      Returns the delegator.
+    */
+    QString delegator() const { return mDelegator; }
+
   private:
     bool mRSVP;
     Role mRole;
     PartStat mStatus;
     QString mUid;
+    QString mDelegate;
+    QString mDelegator;
 
     class Private;
     Private *d;
Index: libkcal/incidenceformatter.cpp
===================================================================
--- libkcal/incidenceformatter.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidenceformatter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -30,6 +30,7 @@
 #include <libkcal/calendarlocal.h>
 #include <libkcal/icalformat.h>
 #include <libkcal/freebusy.h>
+#include <libkcal/calendarresources.h>
 
 #include <libemailfunctions/email.h>
 
@@ -160,6 +161,12 @@
     for( it = attendees.begin(); it != attendees.end(); ++it ) {
       Attendee *a = *it;
       tmpStr += linkPerson( a->email(), a->name(), a->uid() );
+      if ( !a->delegator().isEmpty() ) {
+          tmpStr += i18n(" (delegated by %1)" ).arg( a->delegator() );
+      }
+      if ( !a->delegate().isEmpty() ) {
+          tmpStr += i18n(" (delegated to %1)" ).arg( a->delegate() );
+      }
     }
     tmpStr += "</ul>";
   }
@@ -588,11 +595,61 @@
   return QStyleSheet::convertFromPlainText(str, QStyleSheetItem::WhiteSpaceNormal);
 }
 
+static QString eventStartTimeStr( Event *event )
+{
+  QString tmp;
+  if ( ! event->doesFloat() ) {
+    tmp =  i18n("%1: Start Date, %2: Start Time", "%1 %2")
+             .arg( event->dtStartDateStr(), event->dtStartTimeStr() );
+  } else {
+    tmp = i18n("%1: Start Date", "%1 (time unspecified)")
+            .arg( event->dtStartDateStr() );
+  }
+  return tmp;
+}
+
+static QString eventEndTimeStr( Event *event )
+{
+  QString tmp;
+  if ( event->hasEndDate() ) {
+    if ( ! event->doesFloat() ) {
+      tmp =  i18n("%1: End Date, %2: End Time", "%1 %2")
+               .arg( event->dtEndDateStr(), event->dtEndTimeStr() );
+    } else {
+      tmp = i18n("%1: End Date", "%1 (time unspecified)")
+              .arg( event->dtEndDateStr() );
+    }
+  } else {
+    tmp = i18n( "Unspecified" );
+  }
+  return tmp;
+}
+
 static QString invitationRow( const QString &cell1, const QString &cell2 )
 {
   return "<tr><td>" + cell1 + "</td><td>" + cell2 + "</td></tr>\n";
 }
 
+static QString invitationsDetailsIncidence( Incidence *incidence )
+{
+  QString html;
+  QString descr = incidence->description();
+  if( !descr.isEmpty() ) {
+    html += "<br/><u>" + i18n("Description:")
+      + "</u><table border=\"0\"><tr><td>&nbsp;</td><td>";
+    html += string2HTML(descr) + "</td></tr></table>";
+  }
+  QStringList comments = incidence->comments();
+  if ( !comments.isEmpty() ) {
+    html += "<br><u>" + i18n("Comments:")
+          + "</u><table border=\"0\"><tr><td>&nbsp;</td><td><ul>";
+    for ( uint i = 0; i < comments.count(); ++i )
+      html += "<li>" + string2HTML( comments[i] ) + "</li>";
+    html += "</ul></td></tr></table>";
+  }
+  return html;
+}
+
 static QString invitationDetailsEvent( Event* event )
 {
   // Meeting details are formatted into an HTML table
@@ -622,28 +679,10 @@
   html += invitationRow( i18n( "Where:" ), sLocation );
 
   // Meeting Start Time Row
-  if ( ! event->doesFloat() ) {
-    tmp =  i18n("%1: Start Date, %2: Start Time", "%1 %2")
-             .arg( event->dtStartDateStr(), event->dtStartTimeStr() );
-  } else {
-    tmp = i18n("%1: Start Date", "%1 (time unspecified)")
-            .arg( event->dtStartDateStr() );
-  }
-  html += invitationRow( i18n( "Start Time:" ), tmp );
+  html += invitationRow( i18n( "Start Time:" ), eventStartTimeStr( event ) );
 
   // Meeting End Time Row
-  if ( event->hasEndDate() ) {
-    if ( ! event->doesFloat() ) {
-      tmp =  i18n("%1: End Date, %2: End Time", "%1 %2")
-               .arg( event->dtEndDateStr(), event->dtEndTimeStr() );
-    } else {
-      tmp = i18n("%1: End Date", "%1 (time unspecified)")
-              .arg( event->dtEndDateStr() );
-    }
-  } else {
-    tmp = i18n( "Unspecified" );
-  }
-  html += invitationRow( i18n( "End Time:" ), tmp );
+  html += invitationRow( i18n( "End Time:" ), eventEndTimeStr( event ) );
 
   // Meeting Duration Row
   if ( !event->doesFloat() && event->hasEndDate() ) {
@@ -662,6 +701,7 @@
   }
 
   html += "</table>\n";
+  html += invitationsDetailsIncidence( event );
   html += "</div>\n";
 
   return html;
@@ -685,6 +725,7 @@
   html += invitationRow( i18n( "Summary:" ), sSummary );
   html += invitationRow( i18n( "Description:" ), sDescr );
   html += "</table>\n";
+  html += invitationsDetailsIncidence( todo );
 
   return html;
 }
@@ -707,6 +748,7 @@
   html += invitationRow( i18n( "Date:" ), journal->dtStartDateStr( false ) );
   html += invitationRow( i18n( "Description:" ), sDescr );
   html += "</table>\n";
+  html += invitationsDetailsIncidence( journal );
 
   return html;
 }
@@ -775,6 +817,8 @@
     case Scheduler::Publish:
         return i18n("This event has been published");
     case Scheduler::Request:
+        if ( event->revision() > 0 )
+            return i18n( "This meeting has been updated" );
         return i18n( "You have been invited to this meeting" );
     case Scheduler::Refresh:
         return i18n( "This invitation was refreshed" );
@@ -792,22 +836,49 @@
           kdDebug(5850) << "Warning: attendeecount in the reply should be 1 "
                         << "but is " << attendees.count() << endl;
         Attendee* attendee = *attendees.begin();
+        QString attendeeName = attendee->name();
+        if ( attendeeName.isEmpty() )
+          attendeeName = attendee->email();
+        if ( attendeeName.isEmpty() )
+          attendeeName = i18n( "Sender" );
 
+        QString delegatorName, dummy;
+        KPIM::getNameAndMail( attendee->delegator(), delegatorName, dummy );
+        if ( delegatorName.isEmpty() )
+          delegatorName = attendee->delegator();
+
         switch( attendee->status() ) {
           case Attendee::NeedsAction:
-              return i18n( "Sender indicates this invitation still needs some action" );
+              return i18n( "%1 indicates this invitation still needs some action" ).arg( attendeeName );
           case Attendee::Accepted:
-              return i18n( "Sender accepts this meeting invitation" );
+              if ( delegatorName.isEmpty() )
+                  return i18n( "%1 accepts this meeting invitation" ).arg( attendeeName );
+              return i18n( "%1 accepts this meeting invitation on behalf of %2" )
+                  .arg( attendeeName ).arg( delegatorName );
           case Attendee::Tentative:
-              return i18n( "Sender tentatively accepts this meeting invitation" );
+              if ( delegatorName.isEmpty() )
+                  return i18n( "%1 tentatively accepts this meeting invitation" ).arg( attendeeName );
+              return i18n( "%1 tentatively accepts this meeting invitation on behalf of %2" )
+                  .arg( attendeeName ).arg( delegatorName );
           case Attendee::Declined:
-              return i18n( "Sender declines this meeting invitation" );
-          case Attendee::Delegated:
-              return i18n( "Sender has delegated this meeting invitation" );
+              if ( delegatorName.isEmpty() )
+                  return i18n( "%1 declines this meeting invitation" ).arg( attendeeName );
+              return i18n( "%1 declines this meeting invitation on behalf of %2" )
+                  .arg( attendeeName ).arg( delegatorName );
+          case Attendee::Delegated: {
+              QString delegate, dummy;
+              KPIM::getNameAndMail( attendee->delegate(), delegate, dummy );
+              if ( delegate.isEmpty() )
+                  delegate = attendee->delegate();
+              if ( !delegate.isEmpty() )
+                return i18n( "%1 has delegated this meeting invitation to %2" )
+                    .arg( attendeeName ) .arg( delegate );
+              return i18n( "%1 has delegated this meeting invitation" ).arg( attendeeName );
+          }
           case Attendee::Completed:
               return i18n( "This meeting invitation is now completed" );
           case Attendee::InProcess:
-              return i18n( "Sender is still processing the invitation" );
+              return i18n( "%1 is still processing the invitation" ).arg( attendeeName );
           default:
               return i18n( "Unknown response to this meeting invitation" );
         }
@@ -831,6 +902,8 @@
     case Scheduler::Publish:
         return i18n("This task has been published");
     case Scheduler::Request:
+        if ( todo->revision() > 0 )
+            return i18n( "This task has been updated" );
         return i18n( "You have been assigned this task" );
     case Scheduler::Refresh:
         return i18n( "This task was refreshed" );
@@ -858,8 +931,15 @@
               return i18n( "Sender tentatively accepts this task" );
           case Attendee::Declined:
               return i18n( "Sender declines this task" );
-          case Attendee::Delegated:
+          case Attendee::Delegated: {
+              QString delegate, dummy;
+              KPIM::getNameAndMail( attendee->delegate(), delegate, dummy );
+              if ( delegate.isEmpty() )
+                delegate = attendee->delegate();
+              if ( !delegate.isEmpty() )
+                return i18n( "Sender has delegated this request for the task to %1" ).arg( delegate );
               return i18n( "Sender has delegated this request for the task " );
+          }
           case Attendee::Completed:
               return i18n( "The request for this task is now completed" );
           case Attendee::InProcess:
@@ -1022,7 +1102,98 @@
     }
 };
 
+class IncidenceFormatter::IncidenceCompareVisitor :
+  public IncidenceBase::Visitor
+{
+  public:
+    IncidenceCompareVisitor() : mExistingIncidence(0) {}
+    bool act( IncidenceBase *incidence, Incidence* existingIncidence )
+    {
+      mExistingIncidence = existingIncidence;
+      return incidence->accept( *this );
+    }
 
+    QString result() const
+    {
+      if ( mChanges.isEmpty() )
+        return QString();
+      QString html = "<div align=\"left\"><ul><li>";
+      html += mChanges.join( "</li><li>" );
+      html += "</li><ul></div>";
+      return html;
+    }
+
+  protected:
+    bool visit( Event *event )
+    {
+      compareEvents( event, dynamic_cast<Event*>( mExistingIncidence ) );
+      compareIncidences( event, mExistingIncidence );
+      return !mChanges.isEmpty();
+    }
+    bool visit( Todo *todo )
+    {
+      compareIncidences( todo, mExistingIncidence );
+      return !mChanges.isEmpty();
+    }
+    bool visit( Journal *journal )
+    {
+      compareIncidences( journal, mExistingIncidence );
+      return !mChanges.isEmpty();
+    }
+    bool visit( FreeBusy *fb )
+    {
+      Q_UNUSED( fb );
+      return !mChanges.isEmpty();
+    }
+
+  private:
+    void compareEvents( Event *newEvent, Event *oldEvent )
+    {
+      if ( !oldEvent || !newEvent )
+        return;
+      if ( oldEvent->dtStart() != newEvent->dtStart() || oldEvent->doesFloat() != newEvent->doesFloat() )
+        mChanges += i18n( "The begin of the meeting has been changed from %1 to %2" )
+            .arg( eventStartTimeStr( oldEvent ) ).arg( eventStartTimeStr( newEvent ) );
+      if ( oldEvent->dtEnd() != newEvent->dtEnd() || oldEvent->doesFloat() != newEvent->doesFloat() )
+        mChanges += i18n( "The end of the meeting has been changed from %1 to %2" )
+            .arg( eventEndTimeStr( oldEvent ) ).arg( eventEndTimeStr( newEvent ) );
+    }
+
+    void compareIncidences( Incidence *newInc, Incidence *oldInc )
+    {
+      if ( !oldInc || !newInc )
+        return;
+      if ( oldInc->summary() != newInc->summary() )
+        mChanges += i18n( "The summary has been changed to: \"%1\"" ).arg( newInc->summary() );
+      if ( oldInc->location() != newInc->location() )
+        mChanges += i18n( "The location has been changed to: \"%1\"" ).arg( newInc->location() );
+      if ( oldInc->description() != newInc->description() )
+        mChanges += i18n( "The description has been changed to: \"%1\"" ).arg( newInc->description() );
+      Attendee::List oldAttendees = oldInc->attendees();
+      Attendee::List newAttendees = newInc->attendees();
+      for ( Attendee::List::ConstIterator it = newAttendees.constBegin(); it != newAttendees.constEnd(); ++it ) {
+        Attendee *oldAtt = oldInc->attendeeByMail( (*it)->email() );
+        if ( !oldAtt ) {
+          mChanges += i18n( "Attendee %1 has been added" ).arg( (*it)->fullName() );
+        } else {
+          if ( oldAtt->status() != (*it)->status() )
+            mChanges += i18n( "The status of attendee %1 has been changed to: %2" ).arg( (*it)->fullName() )
+                .arg( (*it)->statusStr() );
+        }
+      }
+      for ( Attendee::List::ConstIterator it = oldAttendees.constBegin(); it != oldAttendees.constEnd(); ++it ) {
+        Attendee *newAtt = newInc->attendeeByMail( (*it)->email() );
+        if ( !newAtt )
+          mChanges += i18n( "Attendee %1 has been removed" ).arg( (*it)->fullName() );
+      }
+    }
+
+  private:
+    Incidence* mExistingIncidence;
+    QStringList mChanges;
+};
+
+
 QString InvitationFormatterHelper::makeLink( const QString &id, const QString &text )
 {
   QString res( "<a href=\"%1\"><b>%2</b></a>" );
@@ -1049,6 +1220,20 @@
 
   IncidenceBase *incBase = msg->event();
 
+  Incidence* existingIncidence = 0;
+  if ( helper->calendar() ) {
+    existingIncidence = helper->calendar()->incidence( incBase->uid() );
+    if ( !existingIncidence ) {
+      const Incidence::List list = helper->calendar()->incidences();
+      for ( Incidence::List::ConstIterator it = list.begin(), end = list.end(); it != end; ++it ) {
+        if ( (*it)->schedulingID() == incBase->uid() ) {
+          existingIncidence = *it;
+          break;
+        }
+      }
+    }
+  }
+
   // First make the text of the message
   QString html;
 
@@ -1071,9 +1256,17 @@
     return QString::null;
   html += bodyVisitor.result();
 
-  html += "<br>&nbsp;<br>&nbsp;<br>";
-  html += "<table border=\"0\" cellspacing=\"0\"><tr><td>&nbsp;</td><td>";
+  if ( msg->method() == Scheduler::Request ) { // ### Scheduler::Publish/Refresh/Add as well?
+    IncidenceCompareVisitor compareVisitor;
+    if ( compareVisitor.act( incBase, existingIncidence ) ) {
+      html += i18n("<p align=\"left\">The following changes have been made by the organizer:</p>");
+      html += compareVisitor.result();
+    }
+  }
 
+  html += "<br/>";
+  html += "<table border=\"0\" cellspacing=\"0\"><tr><td>&nbsp;</td></tr><tr>";
+
 #if 0
   html += helper->makeLinkURL( "accept", i18n("[Enter this into my calendar]") );
   html += "</td><td> &nbsp; </td><td>";
@@ -1086,20 +1279,48 @@
     case Scheduler::Request:
     case Scheduler::Refresh:
     case Scheduler::Add:
-        // Accept
-        html += helper->makeLink( "accept", i18n( "[Accept]" ) );
-        html += "</td><td> &nbsp; </td><td>";
-        html += helper->makeLink( "accept_conditionally",
-                          i18n( "Accept conditionally", "[Accept cond.]" ) );
-        html += "</td><td> &nbsp; </td><td>";
-        // Decline
-        html += helper->makeLink( "decline", i18n( "[Decline]" ) );
-#if 0
-        // TODO: implement this
-        html += "</b></a></td><td> &nbsp; </td><td>";
-        html += helper->makeLink( "check_calendar", i18n("[Check my calendar...]" ) );
-#endif
+    {
+        Incidence *inc = dynamic_cast<Incidence*>( incBase );
+        if ( inc && inc->revision() > 0 && (existingIncidence || !helper->calendar()) ) {
+            if ( incBase->type() == "Todo" ) {
+                html += "<td colspan=\"9\">";
+                html += helper->makeLink( "reply", i18n( "[Enter this into my task list]" ) );
+            } else {
+                html += "<td colspan=\"13\">";
+                html += helper->makeLink( "reply", i18n( "[Enter this into my calendar]" ) );
+            }
+            html += "</td></tr><tr>";
+        }
+        html += "<td>";
+
+        if ( helper->calendar() && !existingIncidence ) {
+          // Accept
+          html += helper->makeLink( "accept", i18n( "[Accept]" ) );
+          html += "</td><td> &nbsp; </td><td>";
+          html += helper->makeLink( "accept_conditionally",
+                            i18n( "Accept conditionally", "[Accept cond.]" ) );
+          html += "</td><td> &nbsp; </td><td>";
+          // counter proposal
+          html += helper->makeLink( "counter", i18n( "[Counter proposal]" ) );
+          html += "</td><td> &nbsp; </td><td>";
+          // Decline
+          html += helper->makeLink( "decline", i18n( "[Decline]" ) );
+          html += "</td><td> &nbsp; </td><td>";
+
+          // Delegate
+          html += helper->makeLink( "delegate", i18n( "[Delegate]" ) );
+          html += "</td><td> &nbsp; </td><td>";
+
+          // Forward
+          html += helper->makeLink( "forward", i18n( "[Forward]" ) );
+
+          if ( incBase->type() == "Event" ) {
+              html += "</b></a></td><td> &nbsp; </td><td>";
+              html += helper->makeLink( "check_calendar", i18n("[Check my calendar]" ) );
+          }
+        }
         break;
+    }
 
     case Scheduler::Cancel:
         // Cancel event from my calendar
@@ -1123,17 +1344,6 @@
 
   html += "</td></tr></table>";
 
-  Incidence* incidence = dynamic_cast<Incidence*>( incBase );
-  if ( incidence ) {
-    QString sDescr = incidence->description();
-    if( ( msg->method() == Scheduler::Request || msg->method() == Scheduler::Cancel ) &&
-        !sDescr.isEmpty() ) {
-      html += "<br>&nbsp;<br>&nbsp;<br><u>" + i18n("Description:")
-        + "</u><br><table border=\"0\"><tr><td>&nbsp;</td><td>";
-      html += string2HTML(sDescr) + "</td></tr></table>";
-    }
-  }
-
   html += "</td></tr></table><br></div>";
 
   return html;
@@ -1923,3 +2133,59 @@
   }
   return QString::null;
 }
+
+static QString recurEnd( Incidence *incidence )
+{
+  QString endstr;
+  if ( incidence->doesFloat() ) {
+    endstr = KGlobal::locale()->formatDate( incidence->recurrence()->endDate() );
+  } else {
+    endstr = KGlobal::locale()->formatDateTime( incidence->recurrence()->endDateTime() );
+  }
+  return endstr;
+}
+
+QString IncidenceFormatter::recurrenceString(Incidence * incidence)
+{
+  if ( !incidence->doesRecur() )
+    return i18n( "No recurrence" );
+
+  Recurrence *recur = incidence->recurrence();
+  switch ( recur->recurrenceType() ) {
+    case Recurrence::rNone:
+      return i18n( "No recurrence" );
+    case Recurrence::rMinutely:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs every minute until %1", "Recurs every %n minutes until %1", recur->frequency() )
+            .arg( recurEnd( incidence ) );
+      return i18n( "Recurs every minute", "Recurs every %n minutes", recur->frequency() );
+    case Recurrence::rHourly:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs hourly until %1", "Recurs every %n hours until %1", recur->frequency() )
+            .arg( recurEnd( incidence ) );
+      return i18n( "Recurs hourly", "Recurs every %n hours", recur->frequency() );
+    case Recurrence::rDaily:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs daily until %1", "Recurs every %n days until %1", recur->frequency() )
+            .arg( recurEnd( incidence ) );
+      return i18n( "Recurs daily", "Recurs every %n days", recur->frequency() );
+    case Recurrence::rWeekly:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs weekly until %1", "Recurs every %n weeks until %1", recur->frequency() )
+            .arg( recurEnd( incidence ) );
+      return i18n( "Recurs weekly", "Recurs every %n weeks", recur->frequency() );
+    case Recurrence::rMonthlyPos:
+    case Recurrence::rMonthlyDay:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs monthly until %1" ).arg( recurEnd( incidence ) );
+      return i18n( "Recurs monthly" );
+    case Recurrence::rYearlyMonth:
+    case Recurrence::rYearlyDay:
+    case Recurrence::rYearlyPos:
+      if ( recur->duration() != -1 )
+        return i18n( "Recurs yearly until %1" ).arg( recurEnd( incidence ) );
+      return i18n( "Recurs yearly" );
+    default:
+      return i18n( "Incidence recurs" );
+  }
+}
Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -57,6 +57,19 @@
 }
 
 
+Todo& Todo::operator=( const Todo &t )
+{
+  Incidence::operator=( t );
+  mDtDue = t.mDtDue;
+  mHasDueDate = t.mHasDueDate;
+  mHasStartDate = t.mHasStartDate;
+  mCompleted = t.mCompleted;
+  mHasCompletedDate = t.mHasCompletedDate;
+  mPercentComplete = t.mPercentComplete;
+  mDtRecurrence = t.mDtRecurrence;
+  return *this;
+}
+
 bool Todo::operator==( const Todo& t2 ) const
 {
     return
Index: libkcal/calendar.cpp
===================================================================
--- libkcal/calendar.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/calendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -379,12 +379,23 @@
   return i;
 }
 
-Incidence *Calendar::incidenceFromSchedulingID( const QString &sid )
+Incidence::List Calendar::incidencesFromSchedulingID( const QString &UID )
 {
+  Incidence::List result;
   Incidence::List incidences = rawIncidences();
   Incidence::List::iterator it = incidences.begin();
   for ( ; it != incidences.end(); ++it )
-    if ( (*it)->schedulingID() == sid )
+    if ( (*it)->schedulingID() == UID )
+      result.append( *it );
+  return result;
+}
+
+Incidence *Calendar::incidenceFromSchedulingID( const QString &UID )
+{
+  Incidence::List incidences = rawIncidences();
+  Incidence::List::iterator it = incidences.begin();
+  for ( ; it != incidences.end(); ++it )
+    if ( (*it)->schedulingID() == UID )
       // Touchdown, and the crowd goes wild
       return *it;
   // Not found
Index: libkcal/incidencebase.cpp
===================================================================
--- libkcal/incidencebase.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidencebase.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -57,6 +57,7 @@
   mLastModified = i.mLastModified;
   mPilotId = i.mPilotId;
   mSyncStatus = i.mSyncStatus;
+  mComments = i.mComments;
 
   // The copied object is a new one, so it isn't observed by the observer
   // of the original object.
@@ -69,7 +70,33 @@
 {
 }
 
+IncidenceBase& IncidenceBase::operator=( const IncidenceBase& i )
+{
+  CustomProperties::operator=( i );
+  mReadOnly = i.mReadOnly;
+  mDtStart = i.mDtStart;
+  mDuration = i.mDuration;
+  mHasDuration = i.mHasDuration;
+  mOrganizer = i.mOrganizer;
+  mUid = i.mUid;
+  mAttendees.clear();
+  Attendee::List attendees = i.attendees();
+  Attendee::List::ConstIterator it;
+  for( it = attendees.begin(); it != attendees.end(); ++it ) {
+    mAttendees.append( new Attendee( *(*it) ) );
+  }
+  mFloats = i.mFloats;
+  mLastModified = i.mLastModified;
+  mPilotId = i.mPilotId;
+  mSyncStatus = i.mSyncStatus;
+  mComments = i.mComments;
 
+  // The copied object is a new one, so it isn't observed by the observer
+  // of the original object.
+  mObservers.clear();
+  return *this;
+}
+
 bool IncidenceBase::operator==( const IncidenceBase& i2 ) const
 {
   if( attendees().count() != i2.attendees().count() ) {
@@ -340,8 +367,15 @@
 void IncidenceBase::setSyncStatus(int stat)
 {
   if (mReadOnly) return;
+  if ( mSyncStatus == stat ) return;
   mSyncStatus = stat;
+  updatedSilent();
 }
+void IncidenceBase::setSyncStatusSilent(int stat)
+{
+  if (mReadOnly) return;
+  mSyncStatus = stat;
+}
 
 int IncidenceBase::syncStatus() const
 {
@@ -351,8 +385,9 @@
 void IncidenceBase::setPilotId( unsigned long id )
 {
   if (mReadOnly) return;
+  if ( mPilotId == id) return;
   mPilotId = id;
-  updated();
+  updatedSilent();
 }
 
 unsigned long IncidenceBase::pilotId() const
@@ -384,3 +419,14 @@
 {
   updated();
 }
+
+void IncidenceBase::updatedSilent()
+{
+  QPtrListIterator<Observer> it(mObservers);
+  while( it.current() ) {
+    Observer *o = it.current();
+    ++it;
+    o->incidenceUpdatedSilent( this );
+  }
+}
+
Index: libkcal/scheduler.cpp
===================================================================
--- libkcal/scheduler.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/scheduler.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,7 @@
 
 #include <klocale.h>
 #include <kdebug.h>
+#include <kmessagebox.h>
 #include <kstandarddirs.h>
 
 #include "event.h"
@@ -292,27 +293,93 @@
   bool ret = false;
   Event *ev = mCalendar->event(incidence->uid());
   Todo *to = mCalendar->todo(incidence->uid());
+
+  // try harder to find the correct incidence
+  if ( !ev && !to ) {
+    const Incidence::List list = mCalendar->incidences();
+    for ( Incidence::List::ConstIterator it = list.begin(), end = list.end(); it != end; ++it ) {
+      if ( (*it)->schedulingID() == incidence->uid() ) {
+        ev = dynamic_cast<Event*>( *it );
+        to = dynamic_cast<Todo*>( *it );
+        break;
+      }
+    }
+  }
+
   if (ev || to) {
     //get matching attendee in calendar
     kdDebug(5800) << "Scheduler::acceptTransaction match found!" << endl;
     Attendee::List attendeesIn = incidence->attendees();
     Attendee::List attendeesEv;
+    Attendee::List attendeesNew;
     if (ev) attendeesEv = ev->attendees();
     if (to) attendeesEv = to->attendees();
     Attendee::List::ConstIterator inIt;
     Attendee::List::ConstIterator evIt;
     for ( inIt = attendeesIn.begin(); inIt != attendeesIn.end(); ++inIt ) {
       Attendee *attIn = *inIt;
+      bool found = false;
       for ( evIt = attendeesEv.begin(); evIt != attendeesEv.end(); ++evIt ) {
         Attendee *attEv = *evIt;
         if (attIn->email().lower()==attEv->email().lower()) {
           //update attendee-info
           kdDebug(5800) << "Scheduler::acceptTransaction update attendee" << endl;
           attEv->setStatus(attIn->status());
+          attEv->setDelegate(attIn->delegate());
+          attEv->setDelegator(attIn->delegator());
           ret = true;
+          found = true;
         }
       }
+      if ( !found && attIn->status() != Attendee::Declined )
+        attendeesNew.append( attIn );
     }
+
+    bool attendeeAdded = false;
+    for ( Attendee::List::ConstIterator it = attendeesNew.constBegin(); it != attendeesNew.constEnd(); ++it ) {
+      Attendee* attNew = *it;
+      QString msg = i18n("%1 wants to attend %2 but was not invited.").arg( attNew->fullName() )
+          .arg( ev ? ev->summary() : to->summary() );
+      if ( !attNew->delegator().isEmpty() )
+        msg = i18n("%1 wants to attend %2 on behalf of %3.").arg( attNew->fullName() )
+            .arg( ev ? ev->summary() : to->summary() )
+            .arg( attNew->delegator() );
+      if ( KMessageBox::questionYesNo( 0, msg, i18n("Uninvited attendee"),
+           KGuiItem(i18n("Accept Attendance")), KGuiItem(i18n("Reject Attendance")) )
+           != KMessageBox::Yes )
+      {
+        KCal::Incidence *cancel = dynamic_cast<Incidence*>( incidence );
+        if ( cancel )
+          cancel->addComment( i18n( "The organizer rejected your attendance at this meeting." ) );
+        performTransaction( cancel ? cancel : incidence, Scheduler::Cancel, attNew->fullName() );
+        delete cancel;
+        continue;
+      }
+
+      Attendee *a = new Attendee( attNew->name(), attNew->email(), attNew->RSVP(),
+                                  attNew->status(), attNew->role(), attNew->uid() );
+      a->setDelegate( attNew->delegate() );
+      a->setDelegator( attNew->delegator() );
+      if ( ev )
+        ev->addAttendee( a );
+      else if ( to )
+        to->addAttendee( a );
+      ret = true;
+      attendeeAdded = true;
+    }
+
+    // send update about new participants
+    if ( attendeeAdded ) {
+      if ( ev ) {
+        ev->setRevision( ev->revision() + 1 );
+        performTransaction( ev, Scheduler::Request );
+      }
+      if ( to ) {
+        to->setRevision( ev->revision() + 1 );
+        performTransaction( to, Scheduler::Request );
+      }
+    }
+
     if ( ret ) {
       // We set at least one of the attendees, so the incidence changed
       // Note: This should not result in a sequence number bump
@@ -322,7 +389,7 @@
         to->updated();
     }
     if ( to ) {
-      // for VTODO a REPLY can be used to update the completion status of 
+      // for VTODO a REPLY can be used to update the completion status of
       // a task. see RFC2446 3.4.3
       Todo *update = dynamic_cast<Todo*> ( incidence );
       Q_ASSERT( update );
Index: libkcal/incidence.cpp
===================================================================
--- libkcal/incidence.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/incidence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -105,6 +105,50 @@
   return ( s1.isEmpty() && s2.isEmpty() ) || (s1 == s2);
 }
 
+Incidence& Incidence::operator=( const Incidence &i )
+{
+  IncidenceBase::operator=( i );
+  mRevision = i.mRevision;
+  mCreated = i.mCreated;
+  mDescription = i.mDescription;
+  mSummary = i.mSummary;
+  mCategories = i.mCategories;
+  mRelatedTo = 0;
+  mRelatedToUid = i.mRelatedToUid;
+  mRelations.clear();
+  mResources = i.mResources;
+  mStatusString = i.mStatusString;
+  mStatus = i.mStatus;
+  mSecrecy = i.mSecrecy;
+  mPriority = i.mPriority;
+  mLocation = i.mLocation;
+
+  mAlarms.clear();
+  Alarm::List::ConstIterator it;
+  for( it = i.mAlarms.begin(); it != i.mAlarms.end(); ++it ) {
+    Alarm *b = new Alarm( **it );
+    b->setParent( this );
+    mAlarms.append( b );
+  }
+
+  mAttachments.clear();
+  Attachment::List::ConstIterator it1;
+  for ( it1 = i.mAttachments.begin(); it1 != i.mAttachments.end(); ++it1 ) {
+    Attachment *a = new Attachment( **it1 );
+    mAttachments.append( a );
+  }
+
+  delete mRecurrence;
+  if (i.mRecurrence) {
+    mRecurrence = new Recurrence( *(i.mRecurrence) );
+    mRecurrence->addObserver( this );
+  } else
+    mRecurrence = 0;
+
+  mSchedulingID = i.mSchedulingID;
+  return *this;
+}
+
 bool Incidence::operator==( const Incidence& i2 ) const
 {
     if( alarms().count() != i2.alarms().count() ) {
Index: libkcal/resourcecalendar.cpp
===================================================================
--- libkcal/resourcecalendar.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/resourcecalendar.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -99,6 +99,18 @@
 {
 }
 
+bool ResourceCalendar::addSubresource( const QString &, const QString & )
+{
+  return true;
+}
+
+bool ResourceCalendar::removeSubresource( const QString & )
+{
+  return true;
+}
+
+
+
 bool ResourceCalendar::load()
 {
   kdDebug(5800) << "Loading resource " + resourceName() << endl;
@@ -183,5 +195,11 @@
   return false;
 }
 
+QString ResourceCalendar::subresourceType( const QString &resource )
+{
+  Q_UNUSED( resource );
+  return QString();
+}
 
+
 #include "resourcecalendar.moc"
Index: libkcal/period.h
===================================================================
--- libkcal/period.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/period.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,11 +48,18 @@
 
     bool hasDuration()const;
 
+    QString summary() const;
+    void setSummary( const QString &summary );
+    QString location() const;
+    void setLocation( const QString &location );
+
   private:
     QDateTime mStart;
     QDateTime mEnd;
 
     bool mHasDuration;
+    QString mSummary;
+    QString mLocation;
 
     class Private;
     Private *d;
Index: libkcal/attendee.cpp
===================================================================
--- libkcal/attendee.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/attendee.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,7 +48,9 @@
              a1.RSVP() == a2.RSVP() &&
              a1.role() == a2.role() &&
              a1.status() == a2.status() &&
-             a1.uid() == a2.uid() );
+             a1.uid() == a2.uid() &&
+             a1.delegate() == a2.delegate() &&
+             a1.delegator() == a2.delegator() );
 }
 
 void Attendee::setStatus( Attendee::PartStat s )
Index: libkcal/versit/vcc.c
===================================================================
--- libkcal/versit/vcc.c	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ libkcal/versit/vcc.c	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -198,6 +198,9 @@
 #endif
 
 #include <string.h>
+#if !defined(__FreeBSD__) && !defined(__APPLE__)
+#include <malloc.h>
+#endif
 #include <stdio.h>
 #include <stdlib.h>
 #include <ctype.h>
Index: kpilot/ChangeLog
===================================================================
--- kpilot/ChangeLog	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/ChangeLog	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,6 +15,29 @@
 TODO: give the knotes conduit a decent test mode.
 TODO: only re-write a local database if it is changed.
 
+2007-12-30  Jason 'vanRijn' Kasper
+* Fixing bug reported by Pablo Yepes on kdepim-users mailing list. We did
+  severe goofiness with middle names... The Palm can't handle them, so we
+  blindly tacked firstname + " " + lastname and stuck it into the Palm's
+  firstname field. The problem is that whenever a copy from palm->pc is
+  done, the kludged first name is transferred to kabc ("firstname middle").
+  And, it's compounded by every change in either direction. It's an ugly
+  hack and I've removed it. The only way to work around it would be to add
+  an additional check for !firstname.endsWith(abEntry.additionalName()),
+  but that's even sillier. Stop the insanity!
+
+2007-12-17  Jason 'vanRijn' Kasper
+* Woot! Fixing major breakage for funky usb devices.  pulled back some
+  removed code from KDE 3.5.6's kpilot for usb workaround code and fit it
+  into the new threaded model.  This fixes syncing for me on my Palm Treo
+  700p.
+* Reformatting and cleaning up kpilotdevicelink.cc.
+* New Private.h to hold the bits of kpilotdevicelink.cc that should not be
+  exposed via kpilotdevicelink.h.  Also, DeviceCommThread extends QObject
+  and QThread, so we need to have automoc run on it.
+* Switching from using QCustomEvent to using QEvent for device tickle
+  thread to match what is done in kpilotdevicelink.  
+
 2007-04-15  Jason 'vanRijn' Kasper
 * merging all development and bug fixes from kdepim-3.5.5+ branch into
   stable branches/KDE/3.5 in preparation for KDE 3.5.7
Index: kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/sysinfoconduit/sysinfo_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,6 +60,7 @@
 Name[da]=Systeminformation
 Name[de]=System-Information
 Name[el]=Œ†ŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ œÉœÖœÉœÑŒÆŒºŒ±œÑŒøœÇ
+Name[eo]=Sisteminformoj
 Name[es]=Informaci√≥n del sistema
 Name[et]=S√ºsteemi info
 Name[eu]=Sistemaren informazioa
Index: kpilot/conduits/memofileconduit/memofile-conduit.desktop
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Memo-fil
 Name[de]=Memo Datei
 Name[el]=ŒëœÅœáŒµŒØŒø œÖœÄŒøŒºŒΩŒÆŒºŒ±œÑŒøœÇ
+Name[eo]=Memo-dosiero
 Name[es]=Archivo de nota
 Name[et]=Memofail
 Name[eu]=Ohar fitxategia
@@ -50,6 +51,7 @@
 Comment[da]=Denne kanal synkroniserer dine h√•ndholdte memoer med en lokal mappe.
 Comment[de]=Abgleich der Memos von Taschencomputer und einem lokalen Ordner
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ œÉœÖŒ≥œáœÅŒøŒΩŒØŒ∂ŒµŒπ œÑŒ± œÖœÄŒøŒºŒΩŒÆŒºŒ±œÑŒ± œÑŒøœÖ œÖœÄŒøŒªŒøŒ≥ŒπœÉœÑŒÆ œÄŒ±ŒªŒ¨ŒºŒ∑œÇ œÉŒ±œÇ ŒºŒµ Œ≠ŒΩŒ±ŒΩ œÑŒøœÄŒπŒ∫œå Œ∫Œ±œÑŒ¨ŒªŒøŒ≥Œø.
+Comment[eo]=Tiu kanalo sinkronigas viajn po≈ùkomputil-memoojn kun loka dosierujo.
 Comment[es]=Este conducto sincroniza las notas de su agenda electr√≥nica con el directorio local.
 Comment[et]=See kanal s√ºnkroniseerib pihuarvutis ja arvutis olevad memod.
 Comment[eu]=Kanal honek zure agendako oharrak direktorio lokal batekin sinkronizatzen ditu.
Index: kpilot/conduits/timeconduit/time_conduit.desktop
===================================================================
--- kpilot/conduits/timeconduit/time_conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/timeconduit/time_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,6 +60,7 @@
 Name[de]=Zeit-Abgleich
 Name[el]=Œ£œÖŒ≥œáœÅŒøŒΩŒπœÉŒºœåœÇ œéœÅŒ±œÇ
 Name[en_GB]=Time Synchronisation
+Name[eo]=Temposinkronigo
 Name[es]=Sincronizaci√≥n de hora
 Name[et]=Aja s√ºnkroniseerimine
 Name[eu]=Ordu sinkronizazioa
Index: kpilot/conduits/docconduit/kpalmdoc.desktop
===================================================================
--- kpilot/conduits/docconduit/kpalmdoc.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/docconduit/kpalmdoc.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,6 +15,7 @@
 GenericName[da]=PalmDOC konverterer
 GenericName[de]=PalmDOC-Konvertierung
 GenericName[el]=ŒúŒµœÑŒ±œÑœÅŒøœÄŒ≠Œ±œÇ PalmDOC
+GenericName[eo]=PalmDOC-konvertilo
 GenericName[es]=Conversor de PalmDOC
 GenericName[et]=PalmDOC konverter
 GenericName[eu]=PalmDOC bihurtzailea
Index: kpilot/conduits/popmail/popmail-conduit.desktop
===================================================================
--- kpilot/conduits/popmail/popmail-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/popmail/popmail-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -9,6 +9,7 @@
 Comment[da]=Send post fra din h√•ndholdte gennem KMail.
 Comment[de]=Zum Versenden von E-Mails mit dem Taschencomputer via KMail.
 Comment[el]=ŒëœÄŒøœÉœÑŒøŒªŒÆ Œ±ŒªŒªŒ∑ŒªŒøŒ≥œÅŒ±œÜŒØŒ±œÇ Œ±œÄœå œÑŒøŒΩ œÖœÄŒøŒªŒøŒ≥ŒπœÉœÑŒÆ œÄŒ±ŒªŒ¨ŒºŒ∑œÇ œÉŒ±œÇ ŒºŒ≠œÉœâ œÑŒøœÖ KMail.
+Comment[eo]=Sendu po≈ùton de via po≈ùkomputilo per KMail.
 Comment[es]=Env√≠a el correo de la agenda electr√≥nica a trav√©s de KMail.
 Comment[et]=Saadab pihuseadmest KMaili vahendusel e-kirja.
 Comment[eu]=Bidali posta zure agenda elektronikotik KMail-en bidez.
@@ -53,6 +54,7 @@
 Name[cy]=Ebost
 Name[da]=Brev
 Name[de]=E-Mail
+Name[eo]=Retpo≈ùto
 Name[es]=Correo
 Name[et]=E-post
 Name[eu]=Posta
Index: kpilot/conduits/knotes/knotes-conduit.desktop
===================================================================
--- kpilot/conduits/knotes/knotes-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/knotes/knotes-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Comment[da]=Denne kanal synkroniserer dit memopad-program med KNotes.
 Comment[de]=Abgleich des Memo Pad mit KNotes
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ œÉœÖŒ≥œáœÅŒøŒΩŒØŒ∂ŒµŒπ œÑŒ∑ŒΩ ŒµœÜŒ±œÅŒºŒøŒ≥ŒÆ Memo Pad ŒºŒµ œÑŒø KNotes.
+Comment[eo]=Tiu kanalo sinkronigas la MemoPad-aplikaƒµon kun KNotoj.
 Comment[es]=Este conducto sincroniza la aplicaci√≥n de Notas con KNotes.
 Comment[et]=See kanal s√ºnkroniseerib Memo Pad rakenduse ja KNotesi.
 Comment[eu]=Kanal honek Memo Pad aplikazioa KNotes-ekin sinkronizatzen du.
@@ -57,6 +58,7 @@
 Name[cy]=KNodiadau/Memos
 Name[da]=KNotes / Memoer
 Name[el]=KNotes / Œ•œÄŒøŒºŒΩŒÆŒºŒ±œÑŒ±
+Name[eo]=KNotoj
 Name[et]=KNotes / memod
 Name[eu]=KNotes / Oharrak
 Name[fr]=KNotes / M√©mos
Index: kpilot/conduits/recordconduit/record-conduit.desktop
===================================================================
--- kpilot/conduits/recordconduit/record-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/recordconduit/record-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -47,6 +47,7 @@
 Comment[da]=Denne kanal g√∏r ingenting.
 Comment[de]=Diese Erweiterung (Conduit) ist ohne Funktion
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ Œ¥ŒµŒΩ Œ∫Œ¨ŒΩŒµŒπ œÑŒØœÄŒøœÑŒ±.
+Comment[eo]=Tiu kanalo faras nenion.
 Comment[et]=See kanal ei tee mitte kui midagi.
 Comment[eu]=Kanal honek ez du ezer egiten.
 Comment[fa]=ÿß€åŸÜ ŸÑŸàŸÑŸá Ÿá€å⁄Ü ⁄Ü€åÿ≤ ŸÜÿØÿßÿ±ÿØ.
Index: kpilot/conduits/null/null-conduit.desktop
===================================================================
--- kpilot/conduits/null/null-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/null/null-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -19,6 +19,7 @@
 Comment[da]=Denne kanal g√∏r ingenting.
 Comment[de]=Diese Erweiterung (Conduit) ist ohne Funktion
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ Œ¥ŒµŒΩ Œ∫Œ¨ŒΩŒµŒπ œÑŒØœÄŒøœÑŒ±.
+Comment[eo]=Tiu kanalo faras nenion.
 Comment[et]=See kanal ei tee mitte kui midagi.
 Comment[eu]=Kanal honek ez du ezer egiten.
 Comment[fa]=ÿß€åŸÜ ŸÑŸàŸÑŸá Ÿá€å⁄Ü ⁄Ü€åÿ≤ ŸÜÿØÿßÿ±ÿØ.
Index: kpilot/conduits/vcalconduit/todo-conduit.desktop
===================================================================
--- kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Comment[da]=Denne kanal synkroniserer din g√∏rem√•lsliste fra din h√•ndholdte til KOrganizer.
 Comment[de]=Abgleich der Aufgabenlisten von Taschencomputer und KOrganizer
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ œÉœÖŒ≥œáœÅŒøŒΩŒØŒ∂ŒµŒπ œÑŒ∑ ŒªŒØœÉœÑŒ± œÄœÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑ Œ±œÄœå œÑŒøŒΩ œÖœÄŒøŒªŒøŒ≥ŒπœÉœÑŒÆ œÄŒ±ŒªŒ¨ŒºŒ∑œÇ œÉŒ±œÇ œÉœÑŒø KOrganizer.
+Comment[eo]=Tiu kanalo sinkronigas la farendaƒµliston de via po≈ùkomputilo kun KOrganizilo.
 Comment[es]=Este conducto sincroniza la lista de tareas pendientes de su agenda electr√≥nica con KOrganizer.
 Comment[et]=See kanal s√ºnkroniseerib pihuarvuti ja KOrganizeri √ºlesannete nimekirja.
 Comment[eu]=Kanal honek zure agenda elektronikoko egitekoen zerrenda KOrganizer-era sinkronizatzen du.
@@ -59,6 +60,7 @@
 Name[da]=G√∏rem√•l (KOrganizer)
 Name[de]=Aufgaben (KOrganizer)
 Name[el]=Œ†œÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑ ŒµœÅŒ≥Œ±œÉŒØŒµœÇ (KOrganizer)
+Name[eo]=Farendaƒµoj (KOrganizilo)
 Name[es]=Tareas pendientes (KOrganizer)
 Name[et]=√úlesanded (KOrganizer)
 Name[eu]=Egitekoak (KOrganizer)
Index: kpilot/conduits/vcalconduit/vcal-conduit.desktop
===================================================================
--- kpilot/conduits/vcalconduit/vcal-conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/vcalconduit/vcal-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Kalender (KOrganizer)
 Name[de]=Kalender (KOrganizer)
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø (KOrganizer)
+Name[eo]=Kalendaro (KOrganizilo)
 Name[es]=Calendario (KOrganizer)
 Name[et]=Kalender (KOrganizer)
 Name[eu]=Egutegia (KOrganizer)
@@ -61,6 +62,7 @@
 Comment[de]=Abgleich des Taschencomputers mit dem KOrganizer-Terminkalender
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ œÉœÖŒ≥œáœÅŒøŒΩŒØŒ∂ŒµŒπ œÑŒøŒΩ œÖœÄŒøŒªŒøŒ≥ŒπœÉœÑŒÆ œÄŒ±ŒªŒ¨ŒºŒ∑œÇ œÉŒ±œÇ ŒºŒµ œÑŒø Œ≤ŒπŒ≤ŒªŒØŒø Œ∑ŒºŒµœÅŒøŒºŒ∑ŒΩŒπœéŒΩ œÑŒøœÖ KOrganizer.
 Comment[en_GB]=This conduit synchronises your handheld with the KOrganizer datebook.
+Comment[eo]=Tiu kanalo sinkronigas vian po≈ùkomputilon kun la datlibro de KOrganizilo.
 Comment[es]=Este conducto sincroniza su agenda electr√≥nica con la libreta de fechas de KOrganizer.
 Comment[et]=See kanal s√ºnkroniseerib pihuseadme ja KOrganizeri kalendri.
 Comment[eu]=Kanal honek zure agenda elektronikoa  KOrganizer-en data-liburuarekin sinkronizatzen du.
Index: kpilot/conduits/abbrowserconduit/kabcRecord.cc
===================================================================
--- kpilot/conduits/abbrowserconduit/kabcRecord.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/abbrowserconduit/kabcRecord.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -521,9 +521,7 @@
 	// don't do a reset since this could wipe out non copied info
 	//toPilotAddr.reset();
 	toPilotAddr.setField(entryLastname, fromAbEntry.familyName());
-	QString firstAndMiddle = fromAbEntry.givenName();
-	if(!fromAbEntry.additionalName().isEmpty()) firstAndMiddle += CSL1(" ") + fromAbEntry.additionalName();
-	toPilotAddr.setField(entryFirstname, firstAndMiddle);
+	toPilotAddr.setField(entryFirstname, fromAbEntry.givenName());
 	toPilotAddr.setField(entryCompany, fromAbEntry.organization());
 	toPilotAddr.setField(entryTitle, fromAbEntry.prefix());
 	toPilotAddr.setField(entryNote, fromAbEntry.note());
Index: kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/abbrowserconduit/abbrowser_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Comment[da]=Denne kanal synkroniserer din h√•ndholdte med KDE's adressebog.
 Comment[de]=Abgleich der Adressb√ºcher von Taschencomputer und KDE.
 Comment[el]=ŒëœÖœÑœåœÇ Œø œÉœçŒΩŒ¥ŒµœÉŒºŒøœÇ œÉœÖŒ≥œáœÅŒøŒΩŒØŒ∂ŒµŒπ œÑŒø Œ≤ŒπŒ≤ŒªŒØŒø Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ œÑŒøœÖ œÖœÄŒøŒªŒøŒ≥ŒπœÉœÑŒÆ œÄŒ±ŒªŒ¨ŒºŒ∑œÇ ŒºŒµ œÑŒø Œ≤ŒπŒ≤ŒªŒØŒø Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ œÑŒøœÖ KDE.
+Comment[eo]=Tiu kanalo sinkronigas vian po≈ùkomputil-adreslibron kun la KDE-aadreslibro.
 Comment[es]=Este conducto sincroniza la libreta de direcciones de su agenda electr√≥nica con la de KDE
 Comment[et]=See kanal s√ºnkroniseerib pihuarvuti ja KDE aadressiraamatu.
 Comment[eu]=Kanal honek agenda-elektronikoaren helbide-liburua KDE-ren helbide-liburuarekin sinkronizatzen du.
@@ -62,6 +63,7 @@
 Name[da]=Adressebog
 Name[de]=Adressbuch
 Name[el]=ŒíŒπŒ≤ŒªŒØŒø Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ
+Name[eo]=Adresaro
 Name[es]=Libreta de direcciones
 Name[et]=Aadressiraamat
 Name[eu]=Helbide-liburua
Index: kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc
===================================================================
--- kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/conduits/abbrowserconduit/abbrowser-conduit.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1290,11 +1290,7 @@
 		DEBUGKPILOT << fname  << ": last name not equal" << endl;
 			return false;
 		}
-		// goofiness that we do in _copy(), duplicated here for your viewing pleasure... *grrr*
-		QString firstAndMiddle = abEntry.givenName();
-		if(!abEntry.additionalName().isEmpty()) firstAndMiddle += CSL1(" ") + abEntry.additionalName();
-
-		if(!_equal(firstAndMiddle, piAddress->getField(entryFirstname)))
+		if(!_equal(abEntry.givenName(), piAddress->getField(entryFirstname)))
 		{
 		DEBUGKPILOT << fname  << ": first name not equal" << endl;
 			return false;
Index: kpilot/kpilot/kpilot_config.desktop
===================================================================
--- kpilot/kpilot/kpilot_config.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/kpilot/kpilot_config.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,7 @@
 Name[da]=KPilot indstilling
 Name[de]=KPilot-Einrichtung
 Name[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ KPilot
+Name[eo]=KPilot-Agordo
 Name[es]=Configuraci√≥n de KPilot
 Name[et]=KPiloti seadistamine
 Name[eu]=KPilot-en konfigurazioa
@@ -71,6 +72,7 @@
 Comment[da]=KPilot hovedindstilling
 Comment[de]=Grundeinrichtung f√ºr KPilot
 Comment[el]=ŒöœçœÅŒπŒ± œÅœçŒ∏ŒºŒπœÉŒ∑ œÑŒøœÖ KPilot
+Comment[eo]=KPilot-ƒàefagordo
 Comment[es]=Configuraci√≥n principal de KPilot
 Comment[et]=KPiloti p√µhiseadistused
 Comment[eu]=KPilot-en konfigurazio nagusia
@@ -116,6 +118,7 @@
 Keywords[da]=kpilot,hoved
 Keywords[de]=KPilot
 Keywords[el]=kpilot,Œ∫œçœÅŒπŒ±
+Keywords[eo]=reto,dosieroj,dosierujoj
 Keywords[es]=kpilot,principal
 Keywords[et]=kpilot,peamine
 Keywords[eu]=kpilot,nagusia
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/options.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -140,7 +140,7 @@
 #define FUNCTIONSETUPL(a) const int fname = a; Q_UNUSED(fname);
 #endif
 
-#define KPILOT_VERSION	"4.9.2-358 (moribund alleycat)"
+#define KPILOT_VERSION	"4.9.3-359 (palo alto)"
 
 
 // Function to expand newlines in rich text to <br>\n
Index: kpilot/lib/kpilotdevicelinkPrivate.h
===================================================================
--- kpilot/lib/kpilotdevicelinkPrivate.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kpilot/lib/kpilotdevicelinkPrivate.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,330 @@
+#ifndef _KPILOT_KPILOTDEVICELINKPRIVATE_H
+#define _KPILOT_KPILOTDEVICELINKPRIVATE_H
+/*
+**
+** Copyright (C) 2007 by Jason 'vanRijn' Kasper <vR@movingparts.net>
+**
+*/
+
+/*
+** This program is free software; you can redistribute it and/or modify
+** it under the terms of the GNU Lesser General Public License as published by
+** the Free Software Foundation; either version 2.1 of the License, or
+** (at your option) any later version.
+**
+** This program is distributed in the hope that it will be useful,
+** but WITHOUT ANY WARRANTY; without even the implied warranty of
+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+** GNU Lesser General Public License for more details.
+**
+** You should have received a copy of the GNU Lesser General Public License
+** along with this program in a file called COPYING; if not, write to
+** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+** MA 02110-1301, USA.
+*/
+
+/*
+** Bug reports and questions can be sent to kde-pim@kde.org
+*/
+
+#include <errno.h>
+
+#include <qstringlist.h>
+#include <qthread.h>
+
+#include "kpilotdevicelink.h"
+#include "options.h"
+
+class QTimer;
+class QSocketNotifier;
+
+// singleton helper class
+class DeviceMap
+{
+public:
+	static DeviceMap *self()
+	{
+		if (!mThis)
+			mThis = new DeviceMap();
+		return mThis;
+	}
+
+	bool canBind(const QString &device)
+	{
+		FUNCTIONSETUPL(5);
+		DEBUGKPILOT << fname << ": device: ["
+			<< device << "]" << endl;
+
+		showList();
+		return !mBoundDevices.contains(device);
+	}
+
+	void bindDevice(const QString &device)
+	{
+		FUNCTIONSETUPL(5);
+		DEBUGKPILOT << fname << ": device: ["
+			<< device << "]" << endl;
+
+		mBoundDevices.append(device);
+		showList();
+	}
+
+	void unbindDevice(const QString &device)
+	{
+		FUNCTIONSETUPL(5);
+		DEBUGKPILOT << fname << ": device: ["
+			<< device << "]" << endl;
+
+		mBoundDevices.remove(device);
+		showList();
+	}
+
+protected:
+	DeviceMap()
+	{
+		mBoundDevices.clear();
+	}
+	~DeviceMap()
+	{
+	}
+
+	QStringList mBoundDevices;
+	static DeviceMap *mThis;
+
+private:
+	void showList() const
+	{
+		FUNCTIONSETUPL(5);
+
+		if ( !(mBoundDevices.count() > 0))
+			return;
+
+		DEBUGKPILOT << fname << ": Bound devices: ["
+			<< ((mBoundDevices.count() > 0) ?
+					mBoundDevices.join(CSL1(", ")) : CSL1("<none>"))
+			<< "]" << endl;
+	}
+};
+
+class Messages
+{
+public:
+	Messages(KPilotDeviceLink *parent) :
+		fDeviceLink(parent)
+	{
+		reset();
+	}
+
+	void reset()
+	{
+		messages = 0;
+		messagesMask = ~messageIsError; // Never block errors
+	}
+
+	void block(unsigned int m, bool force=false)
+	{
+		if (force)
+		{
+			// Force blocking this message, even if it's an error msg.
+			messages |= m;
+		}
+		else
+		{
+			messages |= (m & messagesMask);
+		}
+	}
+
+	/**
+	 * Some messages are only printed once and are suppressed
+	 * after that. These are indicated by flag bits in
+	 * messages. The following enum is a bitfield.
+	 */
+	enum
+	{
+		OpenMessage=1, ///< Trying to open device ..
+		OpenFailMessage=2 ///< Failed to open device ...
+	};
+	int messages;
+	int messagesMask;
+	static const int messageIsError = 0;
+
+	/** Determines whether message @p s which has an id of @p msgid (one of
+	 *  the enum values mentioned above) should be printed, which is only if that
+	 *  message has not been suppressed through messagesMask.
+	 *  If return is true, this method also adds it to the messagesMask.
+	 */
+	bool shouldPrint(int msgid)
+	{
+		if (!(messages & msgid))
+		{
+			block(msgid);
+			return true;
+		}
+		else
+		{
+			return false;
+		}
+	}
+
+protected:
+	KPilotDeviceLink *fDeviceLink;
+};
+
+class DeviceCommEvent : public QEvent
+{
+public:
+	DeviceCommEvent(DeviceCustomEvents type, QString msg = QString::null,
+			int progress = 0) :
+		QEvent( (QEvent::Type)type ), fMessage(msg), fProgress(progress),
+				fPilotSocket(-1)
+	{
+	}
+	QString message() const
+	{
+		return fMessage;
+	}
+	int progress()
+	{
+		return fProgress;
+	}
+
+	inline void setCurrentSocket(int i)
+	{
+		fPilotSocket = i;
+	}
+
+	inline int currentSocket()
+	{
+		return fPilotSocket;
+	}
+private:
+	QString fMessage;
+	int fProgress;
+	/**
+	 * Pilot-link library handles for the device once it's opened.
+	 */
+	int fPilotSocket;
+};
+
+/** Class that handles all device communications.  We do this
+ in a different thread so that we do not block the main Qt
+ Event thread (similar to Swing's AWT event dispatch thread).
+ */
+
+class DeviceCommThread : public QObject, public QThread
+{
+friend class KPilotDeviceLink;
+
+Q_OBJECT
+
+public:
+	DeviceCommThread(KPilotDeviceLink *d);
+	virtual ~DeviceCommThread();
+
+	virtual void run();
+
+	void setDone(bool b)
+	{
+		FUNCTIONSETUP;
+		fDone = b;
+	}
+
+protected:
+
+	void close();
+	
+	void reset();
+
+	/**
+	 * Does the low-level opening of the device and handles the
+	 * pilot-link library initialisation.
+	 */
+	bool open(const QString &device = QString::null);
+
+protected slots:
+	/**
+	* Attempt to open the device. Called regularly to check
+	* if the device exists (to handle USB-style devices).
+	*/
+	void openDevice();
+
+	/**
+	* Called when the device is opened *and* activity occurs on the
+	* device. This indicates the beginning of a hotsync.
+	*/
+	void acceptDevice();
+	
+	/**
+	* This slot fires whenever we've been trying to establish a hotsync with
+	* the device for longer than a given amount of time.  When this slot is
+	* fired, we will tear down the communications process and start over again.
+	*/
+	void workaroundUSB();
+
+private:
+	volatile bool fDone;
+
+	KPilotDeviceLink *fHandle;
+	inline KPilotDeviceLink *link()
+	{
+		if (fHandle)
+		{
+			return fHandle;
+		}
+		else
+		{
+			FUNCTIONSETUP;
+			WARNINGKPILOT << "Link asked for, but either I'm "
+				<< "done or I don't have a valid handle.  "
+				<< "Shutting down comm thread." << endl;
+			QThread::exit();
+			return 0;
+		}
+	}
+
+	/**
+	 * Timers and Notifiers for detecting activity on the device.
+	 */
+	QTimer *fOpenTimer;
+	QSocketNotifier *fSocketNotifier;
+	bool fSocketNotifierActive;
+
+	/** Timer used to check for a badly-connected Z31/72 */
+	QTimer *fWorkaroundUSBTimer;
+	
+	/**
+	 * Pilot-link library handles for the device once it's opened.
+	 */
+	int fPilotSocket;
+	int fTempSocket;
+
+	inline QString errorMessage(int e)
+	{
+		switch (e)
+		{
+		case ENOENT:
+			return i18n(" The port does not exist.");
+			break;
+		case ENODEV:
+			return i18n(" There is no such device.");
+			break;
+		case EPERM:
+			return i18n(" You do not have permission to open the "
+				"Pilot device.");
+			break;
+		default:
+			return i18n(" Check Pilot path and permissions.");
+		}
+	}
+	
+	/**
+	* Handle cases where we can't accept or open the device,
+	* and data remains available on the pilot socket.
+	*/
+	int fAcceptedCount;
+
+};
+
+
+#endif
+
Index: kpilot/lib/kpilotdevicelink.h
===================================================================
--- kpilot/lib/kpilotdevicelink.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/kpilotdevicelink.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,7 +58,7 @@
 * Custom events we can be handling...
 */
 enum DeviceCustomEvents { 
-	EventLogMessage = 1077,
+	EventLogMessage = QEvent::User + 777,
 	EventLogError,
 	EventLogProgress,
 	EventDeviceReady
@@ -117,7 +117,7 @@
 	virtual void reset( const QString & );
 	virtual void close();
 	virtual void reset();
-		void customEvent(QCustomEvent *e);
+	virtual bool event(QEvent *e);
 	virtual bool tickle();
 	virtual const KPilotCard *getCardInfo(int card);
 	virtual void endSync( EndOfSyncFlags f );
Index: kpilot/lib/kpilotlink.cc
===================================================================
--- kpilot/lib/kpilotlink.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/kpilotlink.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -115,7 +115,7 @@
 			{
 				if (!(--timeout))
 				{
-					QApplication::postEvent(fHandle, new QCustomEvent(static_cast<QEvent::Type>(KPilotLink::EventTickleTimeout)));
+					QApplication::postEvent(fHandle, new QEvent(static_cast<QEvent::Type>(KPilotLink::EventTickleTimeout)));
 					break;
 				}
 			}
@@ -169,13 +169,15 @@
 	KPILOT_DELETE(fPilotSysInfo);
 }
 
-void KPilotLink::customEvent(QCustomEvent *e)
+/* virtual */ bool KPilotLink::event(QEvent *e)
 {
 	if ((int)e->type() == EventTickleTimeout)
 	{
 		stopTickle();
 		emit timeout();
+		return true;
 	}
+	else return QObject::event(e);
 }
 
 /*
Index: kpilot/lib/pluginfactory.h
===================================================================
--- kpilot/lib/pluginfactory.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/pluginfactory.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,6 +32,8 @@
 #include <kdebug.h>
 #include <klibloader.h>
 
+#include "options.h"
+
 /** @file Defines a template class for factories for KPilot's conduits. */
 
 class KPilotLink;
Index: kpilot/lib/kpilotdevicelink.cc
===================================================================
--- kpilot/lib/kpilotdevicelink.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/kpilotdevicelink.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,37 +1,35 @@
 /* KPilot
-**
-** Copyright (C) 1998-2001 by Dan Pilone
-** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
-** Copyright (C) 2006-2007 Adriaan de Groot <groot@kde.org>
-** Copyright (C) 2007 Jason 'vanRijn' Kasper <vR@movingparts.net>
-**
-*/
+ **
+ ** Copyright (C) 1998-2001 by Dan Pilone
+ ** Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+ ** Copyright (C) 2006-2007 Adriaan de Groot <groot@kde.org>
+ ** Copyright (C) 2007 Jason 'vanRijn' Kasper <vR@movingparts.net>
+ **
+ */
 
 /*
-** This program is free software; you can redistribute it and/or modify
-** it under the terms of the GNU Lesser General Public License as published by
-** the Free Software Foundation; either version 2.1 of the License, or
-** (at your option) any later version.
-**
-** This program is distributed in the hope that it will be useful,
-** but WITHOUT ANY WARRANTY; without even the implied warranty of
-** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-** GNU Lesser General Public License for more details.
-**
-** You should have received a copy of the GNU Lesser General Public License
-** along with this program in a file called COPYING; if not, write to
-** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
-** MA 02110-1301, USA.
-*/
+ ** This program is free software; you can redistribute it and/or modify
+ ** it under the terms of the GNU Lesser General Public License as published by
+ ** the Free Software Foundation; either version 2.1 of the License, or
+ ** (at your option) any later version.
+ **
+ ** This program is distributed in the hope that it will be useful,
+ ** but WITHOUT ANY WARRANTY; without even the implied warranty of
+ ** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ ** GNU Lesser General Public License for more details.
+ **
+ ** You should have received a copy of the GNU Lesser General Public License
+ ** along with this program in a file called COPYING; if not, write to
+ ** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+ ** MA 02110-1301, USA.
+ */
 
 /*
-** Bug reports and questions can be sent to kde-pim@kde.org
-*/
+ ** Bug reports and questions can be sent to kde-pim@kde.org
+ */
 
 #include "options.h"
 
-
-
 #include <sys/stat.h>
 #include <sys/types.h>
 #include <stdio.h>
@@ -51,6 +49,7 @@
 #include <qtimer.h>
 #include <qdatetime.h>
 #include <qthread.h>
+#include <qsocketnotifier.h>
 
 #include <kconfig.h>
 #include <kmessagebox.h>
@@ -65,254 +64,110 @@
 #include "pilotLocalDatabase.h"
 
 #include "kpilotlink.h"
+#include "kpilotdevicelinkPrivate.moc"
 #include "kpilotdevicelink.moc"
 
 
-// singleton helper class
-class DeviceMap
-{
-public:
-	static DeviceMap *self()
-	{
-		if (!mThis) mThis = new DeviceMap();
-		return mThis;
-	}
+DeviceMap *DeviceMap::mThis = 0L;
 
-	bool canBind( const QString &device )
-	{
-		showList();
-		return !mBoundDevices.contains( device );
-	}
 
-	void bindDevice( const QString &device )
+static inline void startOpenTimer(DeviceCommThread *dev, QTimer *&t)
+{
+	if ( !t)
 	{
-		mBoundDevices.append( device );
-		showList();
+		t = new QTimer(dev);
+		QObject::connect(t, SIGNAL(timeout()), dev, SLOT(openDevice()));
 	}
+	// just a single-shot timer.  we'll know when to start it again...
+	t->start(1000, true);
+}
 
-	void unbindDevice( const QString &device )
-	{
-		mBoundDevices.remove( device );
-		showList();
-	}
+DeviceCommThread::DeviceCommThread(KPilotDeviceLink *d) :
+	QThread(),
+	fDone(true),
+	fHandle(d),
+	fOpenTimer(0L),
+	fSocketNotifier(0L),
+	fSocketNotifierActive(false),
+	fWorkaroundUSBTimer(0L),
+	fPilotSocket(-1),
+	fTempSocket(-1),
+	fAcceptedCount(0)
+{
+	FUNCTIONSETUP;
+}
 
-protected:
-	DeviceMap() {}
-	~DeviceMap() {}
 
-	QStringList mBoundDevices;
-	static DeviceMap *mThis;
+DeviceCommThread::~DeviceCommThread()
+{
+	FUNCTIONSETUPL(2);
+	close();
+	KPILOT_DELETE(fWorkaroundUSBTimer);
+}
 
-private:
-	inline void showList() const
-	{
-		if ( !(mBoundDevices.count() > 0) ) return;
-		FUNCTIONSETUPL(3);
-		DEBUGKPILOT << fname << ": Bound devices: ["
-			<< ((mBoundDevices.count() > 0) ?
-			mBoundDevices.join(CSL1(", ")) : CSL1("<none>")) 
-			<< "]" << endl;
-	}
-} ;
+void DeviceCommThread::close()
+{
+	FUNCTIONSETUPL(2);
 
-DeviceMap *DeviceMap::mThis = 0L;
+	KPILOT_DELETE(fWorkaroundUSBTimer);
+	KPILOT_DELETE(fOpenTimer);
+	KPILOT_DELETE(fSocketNotifier);
+	fSocketNotifierActive=false;
 
-class Messages
-{
-public:
-	Messages(KPilotDeviceLink *parent) :
-		fDeviceLink(parent)
+	if (fTempSocket != -1)
 	{
-		reset();
-	}
+		DEBUGKPILOT << fname
+		<< ": device comm thread closing socket: ["
+		<< fTempSocket << "]" << endl;
 
-	void reset()
-	{
-		messages = 0;
-		messagesMask = ~messageIsError; // Never block errors
+		pi_close(fTempSocket);
 	}
 
-	void block(unsigned int m, bool force=false)
+	if (fPilotSocket != -1)
 	{
-		if (force)
-		{
-			// Force blocking this message, even if it's an error msg.
-			messages |= m;
-		}
-		else
-		{
-			messages |= (m & messagesMask);
-		}
-	}
+		DEBUGKPILOT << fname
+		<< ": device comm thread closing socket: ["
+		<< fPilotSocket << "]" << endl;
 
-	/**
-	* Some messages are only printed once and are suppressed
-	* after that. These are indicated by flag bits in
-	* messages. The following enum is a bitfield.
-	*/
-	enum {
-		OpenMessage=1, ///< Trying to open device ..
-		OpenFailMessage=2 ///< Failed to open device ...
-	} ;
-	int messages;
-	int messagesMask;
-	static const int messageIsError = 0;
-
-	/** Determines whether message @p s which has an id of @p msgid (one of
-	 *  the enum values mentioned above) should be printed, which is only if that
-	 *  message has not been suppressed through messagesMask.
-	 *  If return is true, this method also adds it to the messagesMask.
-	 */
-	bool shouldPrint(int msgid)
-	{
-		if (!(messages & msgid))
-		{
-			block(msgid);
-			return true;
-		}
-		else
-		{
-			return false;
-		}
+		pi_close(fPilotSocket);
 	}
-	
-protected:
-	KPilotDeviceLink *fDeviceLink;
-} ;
 
-class DeviceCommEvent : public QCustomEvent
-{
-public:
-	DeviceCommEvent ( DeviceCustomEvents type, QString msg = QString::null, int progress = 0)
-		: QCustomEvent( type ),
-		fMessage( msg ),
-		fProgress( progress ),
-		fPilotSocket(-1) {}
-	QString message() const
-	{
-		return fMessage;
-	}
-	int progress()
-	{
-		return fProgress;
-	}
+	fTempSocket = (-1);
+	fPilotSocket = (-1);
 
-	inline void setCurrentSocket(int i) { fPilotSocket = i; }
+	DeviceMap::self()->unbindDevice(link()->fRealPilotPath);
+}
 
-	inline int currentSocket() { return fPilotSocket; }
-private:
-	QString fMessage;
-	int fProgress;
-	/**
-	* Pilot-link library handles for the device once it's opened.
-	*/
-	int fPilotSocket;
-};
-
-
-/** Class that handles all device communications.  We do this
-    in a different thread so that we do not block the main Qt
-    Event thread (similar to Swing's AWT event dispatch thread).
-*/
-
-class DeviceCommThread : public QThread
+void DeviceCommThread::reset()
 {
-friend class KPilotDeviceLink;
-public:
-	DeviceCommThread(KPilotDeviceLink *d) :
-		QThread(),
-		fDone(true),
-		fHandle(d),
-		fPilotSocket(-1),
-		fTempSocket(-1)
-	{ };
-	virtual ~DeviceCommThread();
+	FUNCTIONSETUP;
 
-	virtual void run();
-
-	static const int SecondsBetweenPoll = 1;
-
-	void setDone(bool b) 
-	{ 
-		FUNCTIONSETUP;
-		fDone = b; 
-	}
-
-private:
-	volatile bool fDone;
-
-	KPilotDeviceLink *fHandle;
-	inline KPilotDeviceLink *link() 
+	if (link()->fMessages->shouldPrint(Messages::OpenFailMessage))
 	{
-		if (fHandle) 
-		{
-			return fHandle;
-		}
-		else
-		{
-			FUNCTIONSETUP;
-			WARNINGKPILOT << "Link asked for, but either I'm "
-				<< "done or I don't have a valid handle.  "
-				<< "Shutting down comm thread." << endl;
-			QThread::exit();
-			return 0;
-		}
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogMessage,
+				i18n("Could not open device: %1 (will retry)")
+				.arg(link()->pilotPath() )));
 	}
 
-	/**
-	* Pilot-link library handles for the device once it's opened.
-	*/
-	int fPilotSocket;
-	int fTempSocket;
+	link()->fMessages->reset();
+	close();
 
-protected:
-	/**
-	* Attempt to open the device. Called regularly to check
-	* if the device exists (to handle USB-style devices).  This does
-	* everything necessary to connect to a Palm device.  If the
-	* open was successful, this method returns true, otherwise false.
-	*/
-	bool openDevice();
+	// Timer already deleted by close() call.
+	startOpenTimer(this,fOpenTimer);
 
-	void close();
-
-protected:
-	/**
-	* Does the low-level opening of the device and handles the
-	* pilot-link library initialisation.
-	*/
-	bool open( const QString &device = QString::null );
-	
-private:
-	inline QString errorMessage(int e) 
-	{
-		switch (e)
-		{
-		case ENOENT:
-			return i18n(" The port does not exist.");
-			break;
-		case ENODEV:
-			return i18n(" There is no such device.");
-			break;
-		case EPERM:
-			return i18n(" You do not have permission to open the "
-				"Pilot device.");
-			break;
-		default:
-			return i18n(" Check Pilot path and permissions.");
-		}
-	}
-
-} ;
-
-DeviceCommThread::~DeviceCommThread()
-{
-	FUNCTIONSETUPL(2);
-	close();
+	link()->fLinkStatus = WaitingForDevice;
 }
 
-
-bool DeviceCommThread::openDevice()
+/**
+ * This is an asyncronous process.  We try to create a socket with the Palm
+ * and then bind to it (in open()).  If we're able to do those 2 things, then
+ * we do 2 things:  we set a timeout timer (which will tell us that X amount of
+ * time has transpired before we get into the meat of the sync transaction), and
+ * we also set up a QSocketNotifier, which will tell us when data is available
+ * to be read from the Palm socket.  If we were unable to create a socket
+ * and/or bind to the Palm in this method, we'll start our timer again.
+ */
+void DeviceCommThread::openDevice()
 {
 	FUNCTIONSETUPL(2);
 
@@ -329,37 +184,39 @@
 	if (link()->fMessages->shouldPrint(Messages::OpenMessage))
 	{
 		QApplication::postEvent(link(), new DeviceCommEvent(EventLogMessage,
-			i18n("Trying to open device %1...")
-			.arg(link()->fPilotPath)));
+				i18n("Trying to open device %1...")
+				.arg(link()->fPilotPath)));
 	}
 
 	// if we're not supposed to be done, try to open the main pilot
 	// path...
 	if (!fDone && link()->fPilotPath.length() > 0)
 	{
-		DEBUGKPILOT << fname << ": Opening main pilot path: [" 
+		DEBUGKPILOT << fname << ": Opening main pilot path: ["
 			<< link()->fPilotPath << "]." << endl;
-		deviceOpened = open( link()->fPilotPath ); 
+		deviceOpened = open(link()->fPilotPath);
 	}
 
 	// only try the temp device if our earlier attempt didn't work and the temp
 	// device is different than the main device, and it's a non-empty
 	// string
-	bool tryTemp = !deviceOpened && 
-			(link()->fTempDevice.length() > 0) &&
-			(link()->fPilotPath != link()->fTempDevice) ;
+	bool tryTemp = !deviceOpened && (link()->fTempDevice.length() > 0) && (link()->fPilotPath != link()->fTempDevice);
 
 	// if we're not supposed to be done, and we should try the temp
 	// device, try the temp device...
 	if (!fDone && tryTemp)
 	{
 		DEBUGKPILOT << fname << ": Couldn't open main pilot path. "
-			<< "Now trying temp device: [" 
+			<< "Now trying temp device: ["
 			<< link()->fTempDevice << "]." << endl;
-		deviceOpened = open( link()->fTempDevice );
+		deviceOpened = open(link()->fTempDevice);
 	}
 
-	return deviceOpened;
+	// if we couldn't connect, try to connect again...
+	if (!fDone && !deviceOpened)
+	{
+		startOpenTimer(this, fOpenTimer);
+	}
 }
 
 bool DeviceCommThread::open(const QString &device)
@@ -370,24 +227,30 @@
 	int e = 0;
 	QString msg;
 
-	link()->fRealPilotPath = KStandardDirs::realFilePath(device.isEmpty() ? link()->fPilotPath : device );
+	if (fTempSocket != -1)
+	{
+		pi_close(fTempSocket);
+	}
+	fTempSocket = (-1);
 
-	if ( !DeviceMap::self()->canBind( link()->fRealPilotPath ) ) {
+	link()->fRealPilotPath
+			= KStandardDirs::realFilePath(device.isEmpty() ? link()->fPilotPath : device);
+
+	if ( !DeviceMap::self()->canBind(link()->fRealPilotPath) )
+	{
 		msg = i18n("Already listening on that device");
-		
+
 		WARNINGKPILOT << "Pilot Path: ["
 			<< link()->fRealPilotPath << "] already connected." << endl;
 		WARNINGKPILOT << msg << endl;
 
 		link()->fLinkStatus = PilotLinkError;
 
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError, msg));
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError, msg));
 
 		return false;
 	}
 
-
 	DEBUGKPILOT << fname << ": Trying to create socket." << endl;
 
 	fTempSocket = pi_socket(PI_AF_PILOT, PI_SOCK_STREAM, PI_PF_DLP);
@@ -396,15 +259,14 @@
 	{
 		e = errno;
 		msg = i18n("Cannot create socket for communicating "
-			"with the Pilot (%1)").arg(errorMessage(e));
+				"with the Pilot (%1)").arg(errorMessage(e));
 		DEBUGKPILOT << msg << endl;
 		DEBUGKPILOT << "(" << strerror(e) << ")" << endl;
-	
+
 		link()->fLinkStatus = PilotLinkError;
-		
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError, msg));
-	
+
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError, msg));
+
 		return false;
 	}
 
@@ -412,7 +274,7 @@
 
 	link()->fLinkStatus = CreatedSocket;
 
-	DEBUGKPILOT << fname << ": Binding to path: [" 
+	DEBUGKPILOT << fname << ": Binding to path: ["
 		<< link()->fRealPilotPath << "]" << endl;
 
 	ret = pi_bind(fTempSocket, QFile::encodeName(link()->fRealPilotPath));
@@ -425,24 +287,92 @@
 
 		e = errno;
 		msg = i18n("Cannot open Pilot port \"%1\". ").arg(link()->fRealPilotPath);
-		
+
 		DEBUGKPILOT << msg << endl;
 		DEBUGKPILOT << "(" << strerror(e) << ")" << endl;
-	
+
 		link()->fLinkStatus = PilotLinkError;
-		
+
 		if (link()->fMessages->shouldPrint(Messages::OpenFailMessage))
 		{
-			QApplication::postEvent(link(),
-				new DeviceCommEvent(EventLogError, msg));
+			QApplication::postEvent(link(), new DeviceCommEvent(EventLogError, msg));
 		}
 
 		return false;
 	}
 
 	link()->fLinkStatus = DeviceOpen;
-	DeviceMap::self()->bindDevice( link()->fRealPilotPath );
+	DeviceMap::self()->bindDevice(link()->fRealPilotPath);
 
+	fSocketNotifier = new QSocketNotifier(fTempSocket,
+			QSocketNotifier::Read, this);
+	QObject::connect(fSocketNotifier, SIGNAL(activated(int)),
+			this, SLOT(acceptDevice()));
+	fSocketNotifierActive=true;
+
+	/**
+	 * We _always_ want to set a maximum amount of time that we will wait
+	 * for the sync process to start.  In the case where our user
+	 * has told us that he has a funky USB device, set the workaround timeout
+	 * for shorter than normal.
+	 */
+	int timeout=20000;
+	if (link()->fWorkaroundUSB)
+	{
+		timeout=5000;
+	}
+
+	fWorkaroundUSBTimer = new QTimer(this);
+	connect(fWorkaroundUSBTimer, SIGNAL(timeout()), this, SLOT(workaroundUSB()));
+	fWorkaroundUSBTimer->start(timeout, true);
+
+	return true;
+}
+
+/**
+ * We've been notified by our QSocketNotifier that we have data available on the
+ * socket.  Try to go through the remaining steps of the connnection process.
+ * Note: If we return at all from this before the very end without a successful
+ * connection, we need to make sure we restart our connection open timer, otherwise
+ * it won't be restarted.
+ */
+void DeviceCommThread::acceptDevice()
+{
+	FUNCTIONSETUP;
+
+	int ret;
+
+	/**
+	 * Our socket notifier should be the only reason that we end up here.
+	 * If we're here without him being active, we have a problem.  Try to clean
+	 * up and get out.
+	 */
+	if (!fSocketNotifierActive)
+	{
+		if (!fAcceptedCount)
+		{
+		kdWarning() << k_funcinfo << ": Accidentally in acceptDevice()"
+			<< endl;
+		}
+		fAcceptedCount++;
+		if (fAcceptedCount>10)
+		{
+			// Damn the torpedoes
+			KPILOT_DELETE(fSocketNotifier);
+		}
+		return;
+	}
+
+	if (fSocketNotifier)
+	{
+		// fSocketNotifier->setEnabled(false);
+		fSocketNotifierActive=false;
+		KPILOT_DELETE(fSocketNotifier);
+	}
+
+	DEBUGKPILOT << fname << ": Found connection on device: ["
+		<< link()->pilotPath().latin1() << "]." <<endl;
+
 	DEBUGKPILOT << fname
 		<< ": Current status: ["
 		<< link()->statusString()
@@ -457,25 +387,19 @@
 
 		// Presumably, strerror() returns things in
 		// local8Bit and not latin1.
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError,
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError,
 				i18n("Cannot listen on Pilot socket (%1)").
-				arg(QString::fromLocal8Bit(s)))
-			);
-
-		return false;
+				arg(QString::fromLocal8Bit(s))));
+		reset();
+		return;
 	}
 
-	QApplication::postEvent(link(),
-		new DeviceCommEvent(EventLogProgress, QString::null, 10));
+	QApplication::postEvent(link(), new DeviceCommEvent(EventLogProgress, QString::null, 10));
 
 	DEBUGKPILOT << fname <<
 		": Listening to pilot. Now trying accept..." << endl;
 
-	int timeout=20;
-	if (link()->fWorkaroundUSB)
-		timeout=10;
-
+	int timeout = 20;
 	fPilotSocket = pi_accept_to(fTempSocket, 0, 0, timeout);
 
 	if (fPilotSocket < 0)
@@ -484,12 +408,12 @@
 
 		WARNINGKPILOT << "pi_accept returned: [" << s << "]" << endl;
 
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError, i18n("Cannot accept Pilot (%1)")
-			.arg(QString::fromLocal8Bit(s))));
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError, i18n("Cannot accept Pilot (%1)")
+				.arg(QString::fromLocal8Bit(s))));
 
 		link()->fLinkStatus = PilotLinkError;
-		return false;
+		reset();
+		return;
 	}
 
 	DEBUGKPILOT << fname << ": Link accept done." << endl;
@@ -499,33 +423,32 @@
 		link()->fLinkStatus = PilotLinkError;
 		WARNINGKPILOT << "Already connected or unable to connect!" << endl;
 
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError, i18n("Cannot accept Pilot (%1)")
-			.arg(i18n("already connected"))));
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError, i18n("Cannot accept Pilot (%1)")
+				.arg(i18n("already connected"))));
 
-		return false;
+		reset();
+		return;
 	}
 
-	QApplication::postEvent(link(),
-		new DeviceCommEvent(EventLogProgress, QString::null, 30));
+	QApplication::postEvent(link(), new DeviceCommEvent(EventLogProgress, QString::null, 30));
 
 	DEBUGKPILOT << fname << ": doing dlp_ReadSysInfo..." << endl;
 
 	struct SysInfo sys_info;
 	if (dlp_ReadSysInfo(fPilotSocket, &sys_info) < 0)
 	{
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError,
-			i18n("Unable to read system information from Pilot")));
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError,
+				i18n("Unable to read system information from Pilot")));
 
 		link()->fLinkStatus=PilotLinkError;
-		return false;
+		reset();
+		return;
 	}
 	else
 	{
 		DEBUGKPILOT << fname << ": dlp_ReadSysInfo successful..." << endl;
 
-        	KPILOT_DELETE(link()->fPilotSysInfo);
+		KPILOT_DELETE(link()->fPilotSysInfo);
 		link()->fPilotSysInfo = new KPilotSysInfo(&sys_info);
 		DEBUGKPILOT << fname
 			<< ": RomVersion: [" << link()->fPilotSysInfo->getRomVersion()
@@ -534,10 +457,13 @@
 			<< "]" << endl;
 	}
 
-	QApplication::postEvent(link(),
-		new DeviceCommEvent(EventLogProgress, QString::null, 60));
+	// If we've made it this far, make sure our USB workaround timer doesn't fire!
+	fWorkaroundUSBTimer->stop();
+	KPILOT_DELETE(fWorkaroundUSBTimer);
 
-        KPILOT_DELETE(link()->fPilotUser);
+	QApplication::postEvent(link(), new DeviceCommEvent(EventLogProgress, QString::null, 60));
+
+	KPILOT_DELETE(link()->fPilotUser);
 	link()->fPilotUser = new KPilotUser;
 
 	DEBUGKPILOT << fname << ": doing dlp_ReadUserInfo..." << endl;
@@ -549,8 +475,7 @@
 	DEBUGKPILOT << fname
 		<< ": Read user name: [" << n << "]" << endl;
 
-	QApplication::postEvent(link(),
-		new DeviceCommEvent(EventLogProgress, i18n("Checking last PC..."), 90));
+	QApplication::postEvent(link(), new DeviceCommEvent(EventLogProgress, i18n("Checking last PC..."), 90));
 
 	/* Tell user (via Pilot) that we are starting things up */
 	if ((ret=dlp_OpenConduit(fPilotSocket)) < 0)
@@ -558,79 +483,36 @@
 		DEBUGKPILOT << fname
 			<< ": dlp_OpenConduit returned: [" << ret << "]" << endl;
 
-		QApplication::postEvent(link(),
-			new DeviceCommEvent(EventLogError,
-			i18n("Could not read user information from the Pilot. "
-			"Perhaps you have a password set on the device?")));
+		QApplication::postEvent(link(), new DeviceCommEvent(EventLogError,
+				i18n("Could not read user information from the Pilot. "
+						"Perhaps you have a password set on the device?")));
 
 	}
 	link()->fLinkStatus = AcceptedDevice;
 
-	QApplication::postEvent(link(),
-		new DeviceCommEvent(EventLogProgress, QString::null, 100));
+	QApplication::postEvent(link(), new DeviceCommEvent(EventLogProgress, QString::null, 100));
 
-	return true;
+	DeviceCommEvent * ev = new DeviceCommEvent(EventDeviceReady);
+	ev->setCurrentSocket(fPilotSocket);
+	QApplication::postEvent(link(), ev);
+
 }
 
-void DeviceCommThread::close()
+void DeviceCommThread::workaroundUSB()
 {
-	FUNCTIONSETUPL(2);
+	FUNCTIONSETUP;
 
-	pi_close(fTempSocket);
-
-	if (fPilotSocket != -1)
-	{
-		DEBUGKPILOT << fname
-			<< ": device comm thread closing socket: ["
-			<< fPilotSocket << "]" << endl;
-
-		pi_close(fPilotSocket);
-	}
-	fPilotSocket = (-1);
-
-	DeviceMap::self()->unbindDevice( link()->fRealPilotPath );
+	reset();
 }
 
-
 void DeviceCommThread::run()
 {
 	FUNCTIONSETUP;
-	int sleepBetweenPoll = SecondsBetweenPoll;
 	fDone = false;
 
-	DEBUGKPILOT << fname << ": Polling every: ["
-		<< sleepBetweenPoll << "] seconds." << endl;
+	startOpenTimer(this, fOpenTimer);
 
-	while (!fDone)
-	{
-		openDevice();
-
-		if (link()->fLinkStatus == AcceptedDevice)
-		{
-			DeviceCommEvent * ev = new DeviceCommEvent(EventDeviceReady);
-			ev->setCurrentSocket(fPilotSocket);
-			QApplication::postEvent(link(), ev);
-
-			break;
-		}
-		else
-		{
-			if (link()->fMessages->shouldPrint(Messages::OpenFailMessage))
-			{
-				QApplication::postEvent(link(), 
-					new DeviceCommEvent(EventLogMessage, 
-						i18n("Could not open device: %1 (will retry)")
-						.arg(link()->fPilotPath)));
-			}
-			close();
-
-			// sleep before trying again
-			QThread::sleep(sleepBetweenPoll);
-		}
-	}
-
-	DEBUGKPILOT << fname << ": comm thread waiting to be done..." << endl;
-
+	int sleepBetweenPoll = 2;
 	// keep the thread alive until we're supposed to be done
 	while (!fDone)
 	{
@@ -645,17 +527,10 @@
 	DEBUGKPILOT << fname << ": comm thread now done..." << endl;
 }
 
-
-
-
-KPilotDeviceLink::KPilotDeviceLink(QObject * parent, const char *name, const QString &tempDevice) :
-	KPilotLink(parent, name),
-	fLinkStatus(Init),
-	fWorkaroundUSB(false),
-	fPilotSocket(-1),
-	fTempDevice(tempDevice),
-	fMessages(new Messages(this)),
-	fDeviceCommThread(0L)
+KPilotDeviceLink::KPilotDeviceLink(QObject * parent, const char *name,
+		const QString &tempDevice) :
+	KPilotLink(parent, name), fLinkStatus(Init), fWorkaroundUSB(false),
+			fPilotSocket(-1), fTempDevice(tempDevice), fMessages(new Messages(this)), fDeviceCommThread(0L)
 {
 	FUNCTIONSETUP;
 
@@ -673,72 +548,48 @@
 	KPILOT_DELETE(fMessages);
 }
 
-/* virtual */ bool KPilotDeviceLink::isConnected() const
+/* virtual */bool KPilotDeviceLink::isConnected() const
 {
-	 return fLinkStatus == AcceptedDevice;
+	return fLinkStatus == AcceptedDevice;
 }
 
-void KPilotDeviceLink::customEvent(QCustomEvent *e)
+/* virtual */bool KPilotDeviceLink::event(QEvent *e)
 {
 	FUNCTIONSETUP;
 
+	bool handled = false;
+
 	if ((int)e->type() == EventDeviceReady)
 	{
-		DeviceCommEvent* t = dynamic_cast<DeviceCommEvent*>(e);
-		if (t)
-		{
-			fPilotSocket = t->currentSocket();
-			emit deviceReady( this );
-		}
-		else
-		{
-			DEBUGKPILOT << fname
-				<< ": unable to cast event: [" << e << "]" << endl;
-		}
+		DeviceCommEvent* t = static_cast<DeviceCommEvent*>(e);
+		fPilotSocket = t->currentSocket();
+		emit deviceReady( this);
+		handled = true;
 	}
 	else if ((int)e->type() == EventLogMessage)
 	{
-		DeviceCommEvent* t = dynamic_cast<DeviceCommEvent*>(e);
-		if (t)
-		{
-			emit logMessage(t->message());
-		}
-		else
-		{
-			DEBUGKPILOT << fname
-				<< ": unable to cast event: [" << e << "]" << endl;
-		}
+		DeviceCommEvent* t = static_cast<DeviceCommEvent*>(e);
+		emit logMessage(t->message());
+		handled = true;
 	}
 	else if ((int)e->type() == EventLogError)
 	{
-		DeviceCommEvent* t = dynamic_cast<DeviceCommEvent*>(e);
-		if (t)
-		{
-			emit logError(t->message());
-		}
-		else
-		{
-			DEBUGKPILOT << fname
-				<< ": unable to cast event: [" << e << "]" << endl;
-		}
+		DeviceCommEvent* t = static_cast<DeviceCommEvent*>(e);
+		emit logError(t->message());
+		handled = true;
 	}
 	else if ((int)e->type() == EventLogProgress)
 	{
-		DeviceCommEvent* t = dynamic_cast<DeviceCommEvent*>(e);
-		if (t)
-		{
-			emit logProgress(t->message(), t->progress());
-		}
-		else
-		{
-			DEBUGKPILOT << fname
-				<< ": unable to cast event: [" << e << "]" << endl;
-		}
+		DeviceCommEvent* t = static_cast<DeviceCommEvent*>(e);
+		emit logProgress(t->message(), t->progress());
+		handled = true;
 	}
 	else
 	{
-		KPilotLink::customEvent(e);
+		handled = KPilotLink::event(e);
 	}
+
+	return handled;
 }
 
 void KPilotDeviceLink::stopCommThread()
@@ -750,12 +601,12 @@
 
 		// try to wait for our thread to finish, but don't
 		// block the main thread forever
-		if (fDeviceCommThread->running()) 
+		if (fDeviceCommThread->running())
 		{
 			DEBUGKPILOT << fname
 				<< ": comm thread still running. "
 				<< "waiting for it to complete." << endl;
-			bool done = fDeviceCommThread->wait(30000);
+			bool done = fDeviceCommThread->wait(5000);
 			if (!done)
 			{
 				DEBUGKPILOT << fname
@@ -798,7 +649,7 @@
 
 	fPilotPath = dP;
 	if (fPilotPath.isEmpty())
-	   fPilotPath = fTempDevice;
+		fPilotPath = fTempDevice;
 	if (fPilotPath.isEmpty())
 		return;
 
@@ -819,9 +670,8 @@
 		QString msg = i18n("The Pilot device is not configured yet.");
 		WARNINGKPILOT << msg << endl;
 
-
 		fLinkStatus = PilotLinkError;
-		
+
 		emit logError(msg);
 		return;
 	}
@@ -830,7 +680,6 @@
 	fDeviceCommThread->start();
 }
 
-
 void KPilotDeviceLink::reset()
 {
 	FUNCTIONSETUP;
@@ -858,7 +707,7 @@
 		if (!(fi.isReadable() && fi.isWritable()))
 		{
 			emit logError(i18n("Pilot device %1 is not read-write.")
-				.arg(fPilotPath));
+			.arg(fPilotPath));
 		}
 	}
 	else
@@ -866,32 +715,33 @@
 		// It doesn't exist, mention this in the log
 		// (relevant as long as we use only one device type)
 		//
-		emit logError(i18n("Pilot device %1 does not exist. "
-			"Probably it is a USB device and will appear during a HotSync.")
+		emit
+				logError(i18n("Pilot device %1 does not exist. "
+						"Probably it is a USB device and will appear during a HotSync.")
 				.arg(fPilotPath));
 		// Suppress all normal and error messages about opening the device.
-		fMessages->block(Messages::OpenMessage | Messages::OpenFailMessage, true);
+		fMessages->block(Messages::OpenMessage | Messages::OpenFailMessage,
+				true);
 	}
 }
 
-void KPilotDeviceLink::setTempDevice( const QString &d )
+void KPilotDeviceLink::setTempDevice(const QString &d)
 {
 	fTempDevice = d;
-	DeviceMap::self()->bindDevice( fTempDevice );
+	DeviceMap::self()->bindDevice(fTempDevice);
 }
 
-
-/* virtual */ bool KPilotDeviceLink::tickle()
+/* virtual */bool KPilotDeviceLink::tickle()
 {
 	// No FUNCTIONSETUP here because it may be called from
 	// a separate thread.
 	return pi_tickle(pilotSocket()) >= 0;
 }
 
-/* virtual */ void KPilotDeviceLink::addSyncLogEntryImpl( const QString &entry )
+/* virtual */void KPilotDeviceLink::addSyncLogEntryImpl(const QString &entry)
 {
 	dlp_AddSyncLogEntry(fPilotSocket,
-		const_cast<char *>((const char *)Pilot::toPilot(entry)));
+			const_cast<char *>((const char *)Pilot::toPilot(entry)));
 }
 
 bool KPilotDeviceLink::installFile(const QString & f, const bool deleteFile)
@@ -904,17 +754,16 @@
 		return false;
 
 	char buffer[PATH_MAX];
-	memset(buffer,0,PATH_MAX);
-	strlcpy(buffer,QFile::encodeName(f),PATH_MAX);
-	struct pi_file *pf =
-		pi_file_open(buffer);
+	memset(buffer, 0, PATH_MAX);
+	strlcpy(buffer, QFile::encodeName(f), PATH_MAX);
+	struct pi_file *pf = pi_file_open(buffer);
 
 	if (!f)
 	{
 		WARNINGKPILOT << "Cannot open file " << f << endl;
 		emit logError(i18n
 			("<qt>Cannot install the file &quot;%1&quot;.</qt>").
-			arg(f));
+		arg(f));
 		return false;
 	}
 
@@ -922,18 +771,18 @@
 	{
 		WARNINGKPILOT << "Cannot pi_file_install " << f << endl;
 		emit logError(i18n
-			("<qt>Cannot install the file &quot;%1&quot;.</qt>").
-			arg(f));
+				("<qt>Cannot install the file &quot;%1&quot;.</qt>").
+		arg(f));
 		return false;
 	}
 
 	pi_file_close(pf);
-	if (deleteFile) QFile::remove(f);
+	if (deleteFile)
+		QFile::remove(f);
 
 	return true;
 }
 
-
 int KPilotDeviceLink::openConduit()
 {
 	return dlp_OpenConduit(fPilotSocket);
@@ -941,7 +790,7 @@
 
 QString KPilotDeviceLink::statusString(LinkStatus l)
 {
-	QString s = CSL1("KPilotDeviceLink=");
+	QString s= CSL1("KPilotDeviceLink=");
 
 	switch (l)
 	{
@@ -979,21 +828,21 @@
 
 QString KPilotDeviceLink::statusString() const
 {
-	return statusString( status() );
+	return statusString(status() );
 }
 
-void KPilotDeviceLink::endSync( EndOfSyncFlags f )
+void KPilotDeviceLink::endSync(EndOfSyncFlags f)
 {
 	FUNCTIONSETUP;
 
-	if ( UpdateUserInfo == f )
+	if (UpdateUserInfo == f)
 	{
 		getPilotUser().setLastSyncPC((unsigned long) gethostid());
 		getPilotUser().setLastSyncDate(time(0));
 
 		DEBUGKPILOT << fname << ": Writing username " << getPilotUser().name() << endl;
 
-		dlp_WriteUserInfo(pilotSocket(),getPilotUser().data());
+		dlp_WriteUserInfo(pilotSocket(), getPilotUser().data());
 		addSyncLogEntry(i18n("End of HotSync\n"));
 	}
 	dlp_EndOfSync(pilotSocket(), 0);
@@ -1001,34 +850,33 @@
 	KPILOT_DELETE(fPilotUser);
 }
 
-
-int KPilotDeviceLink::getNextDatabase(int index,struct DBInfo *dbinfo)
+int KPilotDeviceLink::getNextDatabase(int index, struct DBInfo *dbinfo)
 {
 	FUNCTIONSETUP;
 
-	pi_buffer_t buf = { 0,0,0 };
-	int r = dlp_ReadDBList(pilotSocket(),0,dlpDBListRAM,index,&buf);
+	pi_buffer_t buf = 	{ 0, 0, 0 };
+	int r = dlp_ReadDBList(pilotSocket(), 0, dlpDBListRAM, index, &buf);
 	if (r >= 0)
 	{
-		memcpy(dbinfo,buf.data,sizeof(struct DBInfo));
+		memcpy(dbinfo, buf.data, sizeof(struct DBInfo));
 	}
 	return r;
 }
 
 // Find a database with the given name. Info about the DB is stored into dbinfo (e.g. to be used later on with retrieveDatabase).
 int KPilotDeviceLink::findDatabase(const char *name, struct DBInfo *dbinfo,
-	int index, unsigned long type, unsigned long creator)
+		int index, unsigned long type, unsigned long creator)
 {
 	FUNCTIONSETUP;
-	return dlp_FindDBInfo(pilotSocket(), 0, index,
-		const_cast<char *>(name), type, creator, dbinfo);
+	return dlp_FindDBInfo(pilotSocket(), 0, index, const_cast<char *>(name),
+			type, creator, dbinfo);
 }
 
-bool KPilotDeviceLink::retrieveDatabase(const QString &fullBackupName,	DBInfo *info)
+bool KPilotDeviceLink::retrieveDatabase(const QString &fullBackupName,
+		DBInfo *info)
 {
 	FUNCTIONSETUP;
 
-
 	if (fullBackupName.isEmpty() || !info)
 	{
 		// Don't even bother trying to convert or retrieve.
@@ -1039,7 +887,7 @@
 		<< " to " << fullBackupName << endl;
 
 	QCString encodedName = QFile::encodeName(fullBackupName);
-	struct pi_file *f = pi_file_create(encodedName,info);
+	struct pi_file *f = pi_file_create(encodedName, info);
 
 	if (!f)
 	{
@@ -1059,7 +907,6 @@
 	return true;
 }
 
-
 KPilotLink::DBInfoList KPilotDeviceLink::getDBList(int cardno, int flags)
 {
 	bool cont=true;
@@ -1067,10 +914,11 @@
 	int index=0;
 	while (cont)
 	{
-		pi_buffer_t buf = { 0,0,0 };
+		pi_buffer_t buf = { 0, 0, 0 };
 		pi_buffer_clear(&buf);
 		// DBInfo*dbi=new DBInfo();
-		if (dlp_ReadDBList(pilotSocket(), cardno, flags | dlpDBListMultiple, index, &buf)<0)
+		if (dlp_ReadDBList(pilotSocket(), cardno, flags | dlpDBListMultiple,
+				index, &buf)<0)
 		{
 			cont=false;
 		}
@@ -1080,9 +928,9 @@
 			DBInfo *db_it = (DBInfo *)buf.data;
 			int info_count = buf.used / sizeof(struct DBInfo);
 
-			while(info_count>0)
+			while (info_count>0)
 			{
-				memcpy(&db_n,db_it,sizeof(struct DBInfo));
+				memcpy(&db_n, db_it, sizeof(struct DBInfo));
 				++db_it;
 				info_count--;
 				dbs.append(db_n);
@@ -1098,21 +946,20 @@
 	KPilotCard *cardinfo=new KPilotCard();
 	if (dlp_ReadStorageInfo(pilotSocket(), card, cardinfo->cardInfo())<0)
 	{
-		WARNINGKPILOT << "Could not get info for card "
-			<< card << endl;
+		WARNINGKPILOT << "Could not get info for card " << card << endl;
 
 		KPILOT_DELETE(cardinfo);
 		return 0L;
-	};
+	}
 	return cardinfo;
 }
 
-PilotDatabase *KPilotDeviceLink::database( const QString &name )
+PilotDatabase *KPilotDeviceLink::database(const QString &name)
 {
 	return new PilotSerialDatabase( this, name );
 }
 
-PilotDatabase *KPilotDeviceLink::database( const DBInfo *info )
+PilotDatabase *KPilotDeviceLink::database(const DBInfo *info)
 {
 	return new PilotSerialDatabase( this, info );
 }
Index: kpilot/lib/kpilotlink.h
===================================================================
--- kpilot/lib/kpilotlink.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/kpilotlink.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -223,7 +223,7 @@
 	* will be giving to us, including tickle timeouts and 
 	* device communication events. 
 	*/
-	void customEvent(QCustomEvent *e);
+	virtual bool event(QEvent *e);
 
 	/**
 	* Install the list of files (full paths!) named by @p l
Index: kpilot/lib/Makefile.am
===================================================================
--- kpilot/lib/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -52,7 +52,7 @@
 	for i in $(srcdir)/*.h ; do \
 		( echo "#include <kdemacros.h>" ; echo "#include \"$$i\"" ; echo "int main(int argc,char **argv){return 0;}" ) > header-test.cc; \
 		echo "$$i" ; \
-		g++ $(all_includes) -I$(top_builddir) -c header-test.cc || echo "$$i" >> FAILED; \
+		g++ $(all_includes) -I$(top_builddir) -DQT_THREAD_SUPPORT -c header-test.cc || echo "$$i" >> FAILED; \
 	done
 	test ! -e FAILED
 
Index: kpilot/lib/pilot.cc
===================================================================
--- kpilot/lib/pilot.cc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/pilot.cc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,6 +32,7 @@
 #include "options.h"
 
 #include <qtextcodec.h>
+#include <qmutex.h>
 #include <kcharsets.h>
 #include <kglobal.h>
 
@@ -44,25 +45,36 @@
 namespace Pilot
 {
 static QTextCodec *codec = 0L;
+static QMutex* mutex = 0L;
 
 
 QString fromPilot( const char *c, int len )
 {
-	return codec->toUnicode(c,len);
+	mutex->lock();
+	QString str = codec->toUnicode(c,len);
+	mutex->unlock();
+	return str;
 }
 
 QString fromPilot( const char *c )
 {
-	return codec->toUnicode(c);
+	mutex->lock();
+	QString str = codec->toUnicode(c);
+	mutex->unlock();
+	return str;
 }
 
 QCString toPilot( const QString &s )
 {
-	return codec->fromUnicode(s);
+	mutex->lock();
+	QCString str = codec->fromUnicode(s);
+	mutex->unlock();
+	return str;
 }
 
 int toPilot( const QString &s, char *buf, int len)
 {
+	mutex->lock();
 	// See toPilot() below.
 	memset( buf, 0, len );
 	int used = len;
@@ -72,11 +84,13 @@
 		used=len;
 	}
 	memcpy( buf, cbuf.data(), used );
+	mutex->unlock();
 	return used;
 }
 
 int toPilot( const QString &s, unsigned char *buf, int len)
 {
+	mutex->lock();
 	// Clear the buffer
 	memset( buf, 0, len );
 
@@ -95,12 +109,15 @@
 
 	// Fill the buffer with encoded data.
 	memcpy( buf, cbuf.data(), used );
+	mutex->unlock();
 	return used;
 }
 
 bool setupPilotCodec(const QString &s)
 {
 	FUNCTIONSETUP;
+	mutex = new QMutex();
+	mutex->lock();
 	QString encoding(KGlobal::charsets()->encodingForName(s));
 
 	DEBUGKPILOT << fname << ": Using codec name " << s << endl;
@@ -114,6 +131,7 @@
 		DEBUGKPILOT << fname << ": Got codec " << codec->name() << endl;
 	}
 
+	mutex->unlock();
 	return codec;
 }
 
@@ -129,7 +147,11 @@
 		return QString::null;
 	}
 
-	return codec->toUnicode(info->name[i],CATEGORY_SIZE-1);
+	mutex->lock();
+	QString str = codec->toUnicode(info->name[i],
+                                  MIN(strlen(info->name[i]), CATEGORY_SIZE-1));
+	mutex->unlock();
+	return str;
 }
 
 
Index: kpilot/lib/pilot.h
===================================================================
--- kpilot/lib/pilot.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kpilot/lib/pilot.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -29,6 +29,8 @@
 ** Bug reports and questions can be sent to kde-pim@kde.org
 */
 
+#include <sys/types.h>
+
 #include <pi-appinfo.h>
 #include <pi-buffer.h>
 #include <pi-dlp.h>
@@ -49,6 +51,7 @@
 class PilotRecord;       // ... has records
 class PilotCategoryInfo; // ... and category information
 
+#define MIN(X, Y)  ((X) < (Y) ? (X) : (Y))
 
 /**
 * The Pilot namespace holds constants that are global for
@@ -146,7 +149,11 @@
 	{
 		if ( ( i < CATEGORY_COUNT ) && ( info->name[i][0] ) )
 		{
-			return fromPilot( info->name[i], CATEGORY_SIZE );
+			/*
+			 * Seems to be important that we try to pass the real length here
+			 * to the codec.
+			 */
+			return fromPilot( info->name[i], MIN(strlen(info->name[i]),CATEGORY_SIZE) );
 		}
 		else
 		{
Index: knotes/knote.cpp
===================================================================
--- knotes/knote.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knotes/knote.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -42,7 +42,6 @@
 #include <kxmlguifactory.h>
 #include <kcolordrag.h>
 #include <kiconeffect.h>
-#include <kprinter.h>
 #include <klocale.h>
 #include <kstandarddirs.h>
 #include <kmessagebox.h>
@@ -65,6 +64,7 @@
 #include "knotealarmdlg.h"
 #include "knotehostdlg.h"
 #include "knotesnetsend.h"
+#include "knoteprinter.h"
 #include "version.h"
 
 #include "pushpin.xpm"
@@ -804,61 +804,19 @@
 {
     saveData();
 
-    KPrinter printer;
-    printer.setFullPage( true );
+    QString content;
+    if ( m_editor->textFormat() == PlainText )
+        content = QStyleSheet::convertFromPlainText( m_editor->text() );
+    else
+        content = m_editor->text();
 
-    if ( printer.setup( 0, i18n("Print %1").arg(name()) ) )
-    {
-        QPainter painter;
-        painter.begin( &printer );
-
-        const int margin = 40;  // pt
-
-        QPaintDeviceMetrics metrics( painter.device() );
-        int marginX = margin * metrics.logicalDpiX() / 72;
-        int marginY = margin * metrics.logicalDpiY() / 72;
-
-        QRect body( marginX, marginY,
-                    metrics.width() - marginX * 2,
-                    metrics.height() - marginY * 2 );
-
-        QString content;
-        if ( m_editor->textFormat() == PlainText )
-            content = QStyleSheet::convertFromPlainText( m_editor->text() );
-        else
-            content = m_editor->text();
-
-        QSimpleRichText text( content, m_config->font(), m_editor->context(),
-                              m_editor->styleSheet(), m_editor->mimeSourceFactory(),
-                              body.height() /*, linkColor, linkUnderline? */ );
-
-        text.setWidth( &painter, body.width() );
-        QRect view( body );
-
-        int page = 1;
-
-        for (;;)
-        {
-            text.draw( &painter, body.left(), body.top(), view, colorGroup() );
-            view.moveBy( 0, body.height() );
-            painter.translate( 0, -body.height() );
-
-            // page numbers
-            painter.setFont( m_config->font() );
-            painter.drawText(
-                view.right() - painter.fontMetrics().width( QString::number( page ) ),
-                view.bottom() + painter.fontMetrics().ascent() + 5, QString::number( page )
-            );
-
-            if ( view.top() >= text.height() )
-                break;
-
-            printer.newPage();
-            page++;
-        }
-
-        painter.end();
-    }
+    KNotePrinter printer;
+    printer.setMimeSourceFactory( m_editor->mimeSourceFactory() );
+    printer.setFont( m_config->font() );
+    printer.setContext( m_editor->context() );
+    printer.setStyleSheet( m_editor->styleSheet() );
+    printer.setColorGroup( colorGroup() );
+    printer.printNote( QString(), content );
 }
 
 void KNote::slotSaveAs()
Index: knotes/local.desktop
===================================================================
--- knotes/local.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knotes/local.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Noter i lokal fil
 Name[de]=Notizen in lokaler Datei
 Name[el]=Œ£Œ∑ŒºŒµŒπœéœÉŒµŒπœÇ œÉŒµ œÑŒøœÄŒπŒ∫œå Œ±œÅœáŒµŒØŒø
+Name[eo]=Notoj en loka dosiero
 Name[es]=Avisos sobre el archivo local
 Name[et]=M√§rkmed kohalikus failis
 Name[eu]=Oharrak fitxategi lokalean
Index: knotes/knoteprinter.cpp
===================================================================
--- knotes/knoteprinter.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ knotes/knoteprinter.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,153 @@
+#include "knoteprinter.h"
+
+#include <libkcal/journal.h>
+
+#include <klocale.h>
+#include <kprinter.h>
+
+#include <qfont.h>
+#include <qpaintdevicemetrics.h>
+#include <qpainter.h>
+#include <qrect.h>
+#include <qsimplerichtext.h>
+#include <qstring.h>
+
+KNotePrinter::KNotePrinter() : m_styleSheet( 0 ), m_mimeSourceFactory( 0 )
+{
+}
+
+void KNotePrinter::setContext( const QString& context )
+{
+    m_context = context;
+}
+
+QString KNotePrinter::context() const
+{
+    return m_context;
+}
+
+void KNotePrinter::setMimeSourceFactory( QMimeSourceFactory* factory )
+{
+    m_mimeSourceFactory = factory;
+}
+
+QMimeSourceFactory* KNotePrinter::mimeSourceFactory() const
+{
+    return m_mimeSourceFactory;
+}
+
+void KNotePrinter::setFont( const QFont& font )
+{
+    m_font = font;
+}
+
+QFont KNotePrinter::font() const
+{
+    return m_font;
+}
+
+void KNotePrinter::setColorGroup( const QColorGroup& colorGroup )
+{
+    m_colorGroup = colorGroup;
+}
+
+QColorGroup KNotePrinter::colorGroup() const
+{
+    return m_colorGroup;
+}
+
+void KNotePrinter::setStyleSheet( QStyleSheet* styleSheet )
+{
+    m_styleSheet = styleSheet;
+}
+
+QStyleSheet* KNotePrinter::styleSheet() const
+{
+    return m_styleSheet;
+}
+
+void KNotePrinter::doPrint( KPrinter& printer, QPainter& painter,
+                            const QString& content ) const
+{
+    const int margin = 40;  // pt
+
+    QPaintDeviceMetrics metrics( painter.device() );
+    int marginX = margin * metrics.logicalDpiX() / 72;
+    int marginY = margin * metrics.logicalDpiY() / 72;
+
+    QRect body( marginX, marginY,
+            metrics.width() - marginX * 2,
+            metrics.height() - marginY * 2 );
+
+    QSimpleRichText text( content, m_font, m_context,
+            m_styleSheet, m_mimeSourceFactory,
+            body.height() /*, linkColor, linkUnderline? */ );
+
+    text.setWidth( &painter, body.width() );
+    QRect view( body );
+
+    int page = 1;
+
+    for (;;)
+    {
+        text.draw( &painter, body.left(), body.top(), view, m_colorGroup );
+        view.moveBy( 0, body.height() );
+        painter.translate( 0, -body.height() );
+
+        // page numbers
+        painter.setFont( m_font );
+        painter.drawText(
+                view.right() - painter.fontMetrics().width( QString::number( page ) ),
+                view.bottom() + painter.fontMetrics().ascent() + 5, QString::number( page )
+                );
+
+        if ( view.top() >= text.height() )
+            break;
+
+        printer.newPage();
+        page++;
+    }
+}
+
+void KNotePrinter::printNote( const QString& name, const QString& content ) const
+{
+    KPrinter printer;
+    printer.setFullPage( true );
+
+    if ( !printer.setup( 0, i18n("Print %1").arg(name) ) )
+        return;
+    QPainter painter;
+    painter.begin( &printer );
+    doPrint( printer, painter, content );
+    painter.end();
+}
+
+void KNotePrinter::printNotes( const QValueList<KCal::Journal*>& journals ) const
+{
+    if ( journals.isEmpty() )
+        return;
+
+    KPrinter printer;
+    printer.setFullPage( true );
+
+    if ( !printer.setup( 0, i18n("Print Note", "Print %n notes", journals.count() ) ) )
+        return;
+
+    QPainter painter;
+    painter.begin( &printer );
+    QString content;
+    QValueListConstIterator<KCal::Journal*> it( journals.begin() );
+    QValueListConstIterator<KCal::Journal*> end( journals.end() );
+    while ( it != end ) {
+        KCal::Journal *j = *it;
+        it++;
+        content += "<h2>" + j->summary() + "</h2>";
+        content += j->description();
+        if ( it != end )
+            content += "<hr>";
+    }
+    doPrint( printer, painter, content );
+    painter.end();
+}
+
+
Index: knotes/knotes_manager.desktop
===================================================================
--- knotes/knotes_manager.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knotes/knotes_manager.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=Noter
 Name[de]=Notizen
 Name[el]=Œ£Œ∑ŒºŒµŒπœéœÉŒµŒπœÇ
+Name[eo]=Notoj
 Name[es]=Notas
 Name[et]=M√§rkmed
 Name[eu]=Oharrak
Index: knotes/Makefile.am
===================================================================
--- knotes/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knotes/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,11 +12,12 @@
                   knotealarmdlg.h knotesalarm.h
 
 noinst_LTLIBRARIES = libknote.la libknoteseditor.la libknoteslegacy.la libknotesconfig.la \
-                     libknotesresources.la libknotesnetwork.la
+                     libknotesresources.la libknotesnetwork.la libknotesprinting.la
 
 libknoteslegacy_la_SOURCES = knoteslegacy.cpp
 libknotesconfig_la_SOURCES = knoteconfig.kcfgc knotesglobalconfig.kcfgc
 libknoteseditor_la_SOURCES = knoteedit.cpp
+libknotesprinting_la_SOURCES = knoteprinter.cpp
 libknotesnetwork_la_SOURCES = knotesnetrecv.cpp knotesnetsend.cpp
 libknotesresources_la_SOURCES = resourcemanager.cpp resourcenotes.cpp \
                                 resourcelocal.cpp resourcelocalconfig.cpp
@@ -25,7 +26,7 @@
 
 knotes_SOURCES  = main.cpp knotesapp.cpp KNotesAppIface.skel
 knotes_LDADD    = libknote.la libknoteseditor.la libknotesnetwork.la libknotesresources.la \
-                  libknoteslegacy.la libknotesconfig.la  $(top_builddir)/libkcal/libkcal.la \
+                  libknoteslegacy.la libknotesconfig.la libknotesprinting.la $(top_builddir)/libkcal/libkcal.la \
                   $(top_builddir)/libkdepim/libkdepim.la $(LIB_KIO) -lkresources -lkdeprint -lkutils
 knotes_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
 knotes_COMPILE_FIRST = knoteconfig.h
@@ -33,7 +34,7 @@
 kde_module_LTLIBRARIES  = knotes_local.la
 knotes_local_la_SOURCES = resourcelocal_plugin.cpp
 knotes_local_la_LDFLAGS = $(KDE_LDFLAGS) $(all_libraries) -module $(KDE_PLUGIN)
-knotes_local_la_LIBADD  = libknotesresources.la libknotesconfig.la \
+knotes_local_la_LIBADD  = libknotesresources.la libknotesconfig.la libknotesprinting.la \
                           $(top_builddir)/libkcal/libkcal.la -lkdeprint
 
 METASOURCES     = AUTO
Index: knotes/knoteprinter.h
===================================================================
--- knotes/knoteprinter.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ knotes/knoteprinter.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,53 @@
+#ifndef KNOTEPRINTER_H
+#define KNOTEPRINTER_H
+
+#include <qfont.h>
+#include <qpalette.h>
+#include <qstring.h>
+
+class QMimeSourceFactory;
+class QStyleSheet;
+template <class T> class QValueList;
+class KPrinter;
+
+namespace KCal {
+    class Journal;
+}
+
+class KNotePrinter {
+public:
+
+    KNotePrinter();
+
+    void printNote( const QString& name,
+                    const QString& content ) const;
+
+    void printNotes( const QValueList<KCal::Journal*>& journals ) const;
+
+    void setFont( const QFont& font );
+    QFont font() const;
+
+    void setColorGroup( const QColorGroup& colorGroup );
+    QColorGroup colorGroup() const;
+
+    void setStyleSheet( QStyleSheet* styleSheet );
+    QStyleSheet* styleSheet() const;
+
+    void setContext( const QString& context );
+    QString context() const;
+
+    void setMimeSourceFactory( QMimeSourceFactory* factory );
+    QMimeSourceFactory* mimeSourceFactory() const;
+
+private:
+    void doPrint( KPrinter& printer, QPainter& painter,
+                  const QString& content ) const;
+
+    QColorGroup m_colorGroup;
+    QFont m_font;
+    QStyleSheet* m_styleSheet;
+    QMimeSourceFactory* m_mimeSourceFactory;
+    QString m_context;
+};
+
+#endif // KNOTEPRINTER
Index: knotes/knotes.desktop
===================================================================
--- knotes/knotes.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ knotes/knotes.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -40,11 +40,11 @@
 GenericName[mk]=–°–∫–æ–∫-–±–µ–ª–µ—à–∫–∏
 GenericName[ms]=Nota Popup 
 GenericName[mt]=Noti ≈ºgƒßar
-GenericName[nb]=Oppsprett-notater
+GenericName[nb]=Sprettopp-notater
 GenericName[nds]=Opduk-Notizen
 GenericName[ne]=‡§™‡§™‡§Ö‡§™ ‡§ü‡§ø‡§™‡•ã‡§ü
 GenericName[nl]=Notities
-GenericName[nn]=Oppsprettnotat
+GenericName[nn]=Sprettoppnotat
 GenericName[nso]=Ditshwao tsa Thlarogo
 GenericName[pl]=≈ª√≥≈Çte karteczki
 GenericName[pt]=Notas
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_akregator
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libakregatorpart
 X-KDE-KontactPartLoadOnStart=false
 
@@ -14,53 +14,7 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Akregator Plugin
-Comment[af]=Akregator inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ Akregator
-Comment[br]=Lugant Akregator
-Comment[ca]=Endollable Akregator
-Comment[cs]=Modul Akregatoru
-Comment[de]=Akregator-Modul
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ Akregator
-Comment[es]=Extensi√≥n de Akregator
-Comment[et]=Akregatori plugin
-Comment[eu]=Akregator plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Akregator
-Comment[fi]=Akregator-liit√§nn√§inen
-Comment[fr]=Module pour Akregator
-Comment[fy]=Akregatorplugin
-Comment[ga]=Breise√°n Akregator
-Comment[gl]=Extensi√≥n para Akregator
-Comment[he]=◊™◊ï◊°◊£ ◊¢◊ë◊ï◊® Akregator
-Comment[hu]=Akregator b≈ëv√≠t≈ëmodul
-Comment[is]=Akregator √≠forrit
-Comment[it]=Plugin aKregator
-Comment[ja]=Akregator „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=Akregator –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô Akregator
-Comment[lt]=Akregator priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ Akregator
-Comment[ms]=Plugin Akregator 
-Comment[nb]=Akgregator-programtillegg
-Comment[nds]=Akregator-Moduul
-Comment[ne]=‡§è‡§ï‡•ç‡§∞‡§ø‡§ó‡•á‡§ü‡§∞ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=Akregatorplugin
-Comment[nn]=Akregator-programtillegg
-Comment[pl]=Wtyczka Akregatora
-Comment[pt]='Plugin' Akregator
-Comment[pt_BR]=Plugin do Akregator
-Comment[ru]=–ú–æ–¥—É–ª—å Akregator
-Comment[sk]=Modul Akregator
-Comment[sl]=Vstavek Akregator
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Akregator-–∞
-Comment[sr@Latn]=Prikljuƒçak Akregator-a
-Comment[sv]=Akregator-insticksprogram
-Comment[ta]=Akregator ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
-Comment[tr]=Akregator Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ Akregator
-Comment[uz]=Akregator –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Akregator Êèí‰ª∂
-Comment[zh_TW]=Akregator Â§ñÊéõÁ®ãÂºè
+Comment=Feed Reader Component (Akregator Plugin)
 Name=Feeds
 Name[af]=Strome
 Name[bg]=–ù–æ–≤–∏–Ω–∏
@@ -69,6 +23,7 @@
 Name[da]=Kilder
 Name[de]=Nachrichten
 Name[el]=Œ°ŒøŒ≠œÇ
+Name[eo]=Fluoj
 Name[es]=Or√≠genes
 Name[et]=Uudisevood
 Name[eu]=Iturriak
Index: kontact/plugins/akregator/akregatorplugin3.2.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -21,6 +21,7 @@
 Comment[cs]=Modul Akregatoru
 Comment[de]=Akregator-Modul
 Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ Akregator
+Comment[eo]=Akregator-kromaƒµo
 Comment[es]=Extensi√≥n de Akregator
 Comment[et]=Akregatori plugin
 Comment[eu]=Akregator plugin-a
@@ -68,6 +69,7 @@
 Name[da]=Kilder
 Name[de]=Nachrichten
 Name[el]=Œ°ŒøŒ≠œÇ
+Name[eo]=Fluoj
 Name[es]=Or√≠genes
 Name[et]=Uudisevood
 Name[eu]=Iturriak
Index: kontact/plugins/test/kptestplugin.desktop
===================================================================
--- kontact/plugins/test/kptestplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/test/kptestplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkptestplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 
 X-KDE-PluginInfo-Name=kptestplugin
 X-KDE-PluginInfo-Version=0.1
@@ -21,6 +21,7 @@
 Comment[da]=Kontact Test-plugin
 Comment[de]=Test-Modul f√ºr Kontact
 Comment[el]=ŒîŒøŒ∫ŒπŒºŒ±œÉœÑŒπŒ∫œå œÄœÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ Kontact
+Comment[eo]=Kontact-Testkromaƒµo
 Comment[es]=Plugin de prueba para Kontact
 Comment[et]=Kontacti testplugin
 Comment[eu]=Kontact-en proba plugin-a
Index: kontact/plugins/weather/summarywidget.cpp
===================================================================
--- kontact/plugins/weather/summarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/weather/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,7 +46,7 @@
   mLayout->setAlignment( Qt::AlignTop );
 
   QPixmap icon = KGlobal::iconLoader()->loadIcon( "kweather", KIcon::Desktop, KIcon::SizeMedium );
-  QWidget *header = createHeader( this, icon, i18n( "Weather Information" ) );
+  QWidget *header = createHeader( this, icon, i18n( "Weather Service" ) );
   mLayout->addWidget( header );
 
   QString error;
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -7,7 +7,7 @@
 
 X-KDE-Library=libkontact_weatherplugin
 X-KDE-KontactIdentifier=weather
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
@@ -16,58 +16,7 @@
 X-KDE-PluginInfo-License=LGPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact Weather Plugin
-Comment[af]=Kontact weer inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "–ù–∞–¥–≤–æ—Ä'–µ"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–Ω–æ—Ç–æ –≤—Ä–µ–º–µ
-Comment[bs]=Kontact dodatak za vremensku prognozu
-Comment[ca]=Endollable del temps per a Kontact
-Comment[cs]=Modul poƒças√≠ pro aplikaci Kontact
-Comment[cy]=Ategyn Tywydd Kontact
-Comment[da]=Kontact Vejr-plugin
-Comment[de]=Wetter-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø Œ∫Œ±ŒπœÅŒøœç œÑŒøœÖ Kontact
-Comment[es]=Extensi√≥n de meteorolog√≠a para Kontact
-Comment[et]=Kontacti ilmaplugin
-Comment[eu]=Kontact-en eguraldi plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ÿ¢ÿ® Ÿà ŸáŸàÿß€å Kontact
-Comment[fi]=Kontactin s√§√§liit√§nn√§inen
-Comment[fr]=Module m√©t√©o pour Kontact
-Comment[fy]=Kontact Waarplugin
-Comment[gl]=Extensi√≥n de clima para Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§Æ‡•å‡§∏‡§Æ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact id≈ëj√°r√°s-el≈ërejelz√©si b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact ve√∞ur √≠forrit
-Comment[it]=Plugin Kontact meteorologico
-Comment[ja]=Kontact Ê∞óË±°„Çµ„Éº„Éì„Çπ„Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=–ê—É–∞ —Ä–∞–π—ã –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·û¢·û∂·ûÄ·û∂·ûü·ûí·û∂·ûè·ûª‚Äã·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact or≈≥ prane≈°ƒójo priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –Ω–∞ –ö–æ–Ω—Ç–∞–∫—Ç –∑–∞ –≤—Ä–µ–º–µ
-Comment[ms]=Plugin Cuaca Kontact 
-Comment[nb]=Kontact v√¶r-programtillegg
-Comment[nds]=Weder-Moduul f√∂r Kontact
-Comment[ne]=‡§Æ‡•å‡§∏‡§Æ ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡§Æ‡§æ ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact Weerplugin
-Comment[nn]=Kontact, programtillegg for v√™rmelding
-Comment[pl]=Wtyczka Kontact do wy≈õwietlania pogody
-Comment[pt]='Plugin' Meteorol√≥gico do Kontact
-Comment[pt_BR]=Plugin de Tempo do Kontact
-Comment[ro]=Modul meteorologie Kontact
-Comment[ru]=–ü–æ–≥–æ–¥–∞
-Comment[se]=Kontact, d√°ldedieƒë√°husaid lassemoduvla
-Comment[sk]=Modul poƒçasia pre Kontact
-Comment[sl]=Vremenski vstavek za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ –≤—Ä–µ–º–µ
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za vreme
-Comment[sv]=Kontact-v√§derinsticksprogram
-Comment[ta]=‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ –ø–µ—à–≥”Ø–∏–∏ “≥–∞–≤–æ–∏ Kontact
-Comment[tr]=Kontact Hava Durumu Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –ø–æ–≥–æ–¥–∏ Kontact
-Comment[uz]=Kontact —É—á—É–Ω –æ–±-“≥–∞–≤–æ –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact Â§©Ê∞îÊèí‰ª∂
-Comment[zh_TW]=Kontact Â§©Ê∞£Â§ñÊéõÁ®ãÂºè
+Comment=Kontact Weather Component
 Name=Weather Service
 Name[af]=Weer diens
 Name[ar]=ÿÆÿØŸÖÿ© ÿßŸÑÿ∑ŸÇÿ≥
@@ -78,6 +27,7 @@
 Name[da]=Vejrtjeneste
 Name[de]=Wetterdienst
 Name[el]=Œ•œÄŒ∑œÅŒµœÉŒØŒ± œÄœÅœåŒ≤ŒªŒµœàŒ∑œÇ ŒöŒ±ŒπœÅŒøœç
+Name[eo]=Veterservo
 Name[es]=Servicio meteorol√≥gico
 Name[et]=Ilmateade
 Name[eu]=Eguraldiaren zerbitzua
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knodeplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libknodepart
 X-KDE-KontactPartExecutableName=knode
 
@@ -14,59 +14,7 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=false
 
-Comment=Kontact KNode Plugin
-Comment[af]=Kontact KNode inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "KNode"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ —á–µ—Ç–µ–Ω–µ –Ω–∞ –Ω–æ–≤–∏–Ω–∏
-Comment[br]=Lugent Kontact KNode
-Comment[bs]=Kontact KNode dodatak
-Comment[ca]=Endollable KNode per a Kontact
-Comment[cs]=Modul KNode pro aplikaci Kontact
-Comment[cy]=Ategyn KNode Kontact
-Comment[da]=Kontact KNode-plugin
-Comment[de]=KNode-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KNode œÑŒøœÖ Kontact
-Comment[es]=Accesorio KNode para Kontact
-Comment[et]=Kontacti KNode plugin
-Comment[eu]=Kontact-en KNode plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact KNode
-Comment[fi]=Kontactin KNode-liit√§nn√§inen
-Comment[fr]=Module KNode pour Kontact
-Comment[fy]=Kontact KNode-plugin
-Comment[ga]=Breise√°n KNode le haghaidh Kontact
-Comment[gl]=Extensi√≥n de KNode para Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§ï‡•á-‡§®‡•ã‡§° ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact KNode-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact KNode √≠forrit
-Comment[it]=Plugin Knode Kontact
-Comment[ja]=Kontact KNode „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KNode –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KNode ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KNode priedas
-Comment[ms]=Plugin KNode Kontact 
-Comment[nb]=Kontact programtillegg for KNode
-Comment[nds]=KNode-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§®‡•ã‡§° ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KNode-plugin
-Comment[nn]=Kontact-programtillegg for KNode
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KNode
-Comment[pt]='Plugin' do KNode para o Kontact
-Comment[pt_BR]=Plug-in para Knode do Kontact
-Comment[ro]=Modul KNode pentru Kontact
-Comment[ru]=–ù–æ–≤–æ—Å—Ç–∏ KNode
-Comment[se]=Kontact, KNode-lassemoduvla
-Comment[sk]=Modul KNode pre Kontact
-Comment[sl]=Vstavek KNode za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KNode
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KNode
-Comment[sv]=Kontact insticksdelprogram f√∂r Knode
-Comment[ta]=‡Æï‡Øá‡Æ®‡Øã‡Æü‡ØÅ ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ KNode
-Comment[tr]=Kontact KNode Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –Ω–æ–≤–∏–Ω (KNode) Kontact
-Comment[uz]=Kontact —É—á—É–Ω KNode –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KNode Êèí‰ª∂
-Comment[zh_TW]=Kontact KNode Â§ñÊéõÁ®ãÂºè
+Comment=Newsreader Component (KNode Plugin)
 Name=News
 Name[af]=Nuus
 Name[ar]=ÿßŸÑÿ£ÿÆÿ®ÿßÿ±
@@ -79,6 +27,7 @@
 Name[da]=Nyheder
 Name[de]=Usenet
 Name[el]=ŒùŒ≠Œ±
+Name[eo]=Novaƒµoj
 Name[es]=Noticias
 Name[et]=Uudisegrupid
 Name[eu]=Berriak
Index: kontact/plugins/specialdates/kcmsdsummary.desktop
===================================================================
--- kontact/plugins/specialdates/kcmsdsummary.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/specialdates/kcmsdsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,55 +11,7 @@
 X-KDE-ParentComponents=kontact_specialdatesplugin
 X-KDE-CfgDlgHierarchy=KontactSummary
 
-Name=Special Dates
-Name[af]=Spesiale datums
-Name[ar]=ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ŸÇŸàŸÖÿ©
-Name[br]=Deiziado√π dibar
-Name[ca]=Dates especials
-Name[cs]=Speci√°ln√≠ data
-Name[da]=S√¶rlige datoer
-Name[de]=Besondere Termine
-Name[el]=Œ£Œ∑ŒºŒ±ŒΩœÑŒπŒ∫Œ≠œÇ Œ∑ŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒµœÇ
-Name[es]=Fechas especiales
-Name[et]=T√§htp√§evad
-Name[eu]=Data bereziak
-Name[fa]=ÿ™ÿßÿ±€åÿÆŸáÿß€å Ÿà€å⁄òŸá
-Name[fi]=Erikoisp√§iv√§t
-Name[fr]=Dates particuli√®res
-Name[fy]=Spesjale datums
-Name[ga]=D√°ta√≠ Speisialta
-Name[gl]=Datas Especiais
-Name[he]=◊™◊ê◊®◊ô◊õ◊ô◊ù ◊û◊ô◊ï◊ó◊ì◊ô◊ù
-Name[hu]=Fontos d√°tumok
-Name[is]=S√©rstakir dagar
-Name[it]=Date speciali
-Name[ja]=ÁâπÂà•„Å™Êó•
-Name[kk]=–ï—Ä–µ–∫—à–µ –∫“Ø–Ω–¥–µ—Ä
-Name[km]=·ûê·üí·ûÑ·üÉ‚Äã·ûñ·û∑·ûü·üÅ·ûü
-Name[lt]=Ypatingos datos
-Name[mk]=–°–ø–µ—Ü–∏—ò–∞–ª–Ω–∏ –¥–∞—Ç—É–º–∏
-Name[ms]=Tarikh Khusus
-Name[nb]=Spesielle datoer
-Name[nds]=Bes√ºnner Daag
-Name[ne]=‡§µ‡§ø‡§∂‡•á‡§∑ ‡§Æ‡§ø‡§§‡§ø
-Name[nl]=Speciale data
-Name[nn]=Spesielle datoar
-Name[pl]=Daty specjalne
-Name[pt]=Datas Especiais
-Name[pt_BR]=Datas Especiais
-Name[ru]=–û—Å–æ–±—ã–µ –¥–∞—Ç—ã
-Name[sk]=≈†peci√°lne d√°tumy
-Name[sl]=Posebni datumi
-Name[sr]=–ü–æ—Å–µ–±–Ω–∏ –¥–∞—Ç—É–º–∏
-Name[sr@Latn]=Posebni datumi
-Name[sv]=Speciella datum
-Name[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç
-Name[th]=‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
-Name[tr]=√ñzel Tarihler
-Name[uk]=–û—Å–æ–±–ª–∏–≤—ñ –¥–∞—Ç–∏
-Name[uz]=–ú–∞—Ö—Å—É—Å –∫—É–Ω–ª–∞—Ä
-Name[zh_CN]=ÁâπÊÆäÊó•Êúü
-Name[zh_TW]=ÁâπÊÆäÊó•Êúü
+Name=Special Dates Overview
 Comment=Special Dates Summary Setup
 Comment[af]=Spesiale datums opsomming opstelling
 Comment[bg]=–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏—Ç–µ —Å–ª—É—á–∞–∏
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_specialdatesplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPluginHasPart=false
 X-KDE-KontactPluginHasSummary=true
 
@@ -23,6 +23,7 @@
 Name[da]=S√¶rlige datoer
 Name[de]=Besondere Termine
 Name[el]=Œ£Œ∑ŒºŒ±ŒΩœÑŒπŒ∫Œ≠œÇ Œ∑ŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒµœÇ
+Name[eo]=Specialaj Datoj
 Name[es]=Fechas especiales
 Name[et]=T√§htp√§evad
 Name[eu]=Data bereziak
@@ -63,49 +64,4 @@
 Name[uz]=–ú–∞—Ö—Å—É—Å –∫—É–Ω–ª–∞—Ä
 Name[zh_CN]=ÁâπÊÆäÊó•Êúü
 Name[zh_TW]=ÁâπÊÆäÊó•Êúü
-Comment=Special Dates Plugin
-Comment[af]=Spesiale datums inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ —Å–ª—É—á–∞–∏
-Comment[ca]=Endollable de dates especials
-Comment[cs]=Modul speci√°ln√≠ch datum≈Ø
-Comment[da]=Plugin for s√¶rlige datoer
-Comment[de]=Modul f√ºr besondere Termine
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÉŒ∑ŒºŒ±ŒΩœÑŒπŒ∫œéŒΩ Œ∑ŒºŒµœÅŒøŒºŒ∑ŒΩŒπœéŒΩ
-Comment[es]=Extensi√≥n para fechas especiales
-Comment[et]=T√§htp√§evade plugin
-Comment[eu]=Data berezien plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ÿ™ÿßÿ±€åÿÆŸáÿß€å Ÿà€å⁄òŸá
-Comment[fi]=Kalenteriliit√§nn√§inen
-Comment[fr]=Module de dates particuli√®res
-Comment[fy]=Plugin foar spesjale datums
-Comment[gl]=Extensi√≥n de Datas Especiais
-Comment[he]=◊™◊ï◊°◊£ ◊™◊ê◊®◊ô◊õ◊ô◊ù ◊ó◊©◊ï◊ë◊ô◊ù
-Comment[hu]=Fontos d√°tumok b≈ëv√≠t≈ëmodul
-Comment[is]=S√©rstakir dagar √≠forrit
-Comment[it]=Plugin per le date speciali
-Comment[ja]=ÁâπÂà•„Å™Êó•„Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=–ï—Ä–µ–∫—à–µ –∫“Ø–Ω–¥–µ—Ä –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûê·üí·ûÑ·üÉ‚Äã·ûñ·û∑·ûü·üÅ·ûü
-Comment[lt]=Ypating≈≥ dien≈≥ priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ —Å–ø–µ—Ü–∏—ò–∞–ª–Ω–∏ –¥–∞—Ç—É–º–∏
-Comment[ms]=Plugin Tarikh Khusus
-Comment[nb]=Programtillegg for spesielle datoer
-Comment[nds]=Moduul f√∂r bes√ºnner Daag
-Comment[ne]=‡§µ‡§ø‡§∂‡•á‡§∑ ‡§Æ‡§ø‡§§‡§ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=Plugin voor speciale data
-Comment[nn]=Programtillegg for spesielle datoar
-Comment[pl]=Wtyczka specjalnych dat
-Comment[pt]='Plugin' de Datas Especiais
-Comment[pt_BR]=Plugin de Datas Especiais
-Comment[ru]=–û—Å–æ–±—ã–µ –¥–∞—Ç—ã
-Comment[sk]=Modul ≈°peci√°lnych d√°tumov
-Comment[sl]=Vstavek za posebne datume
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ –∑–∞ –ø–æ—Å–µ–±–Ω–µ –¥–∞—Ç—É–º–µ
-Comment[sr@Latn]=Prikljuƒçak za posebne datume
-Comment[sv]=Insticksprogram f√∂r speciella datum
-Comment[ta]=‡Æµ‡Æø‡Æö‡Øá‡Æ∑ ‡Æ§‡Øá‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
-Comment[th]=‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
-Comment[tr]=√ñzel Tarihler Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –æ—Å–æ–±–ª–∏–≤–∏—Ö –¥–∞—Ç
-Comment[zh_CN]=ÁâπÊÆäÊó•ÊúüÊèí‰ª∂
-Comment[zh_TW]=ÁâπÊÆäÊó•ÊúüÂ§ñÊéõÁ®ãÂºè
+Comment=Special Dates Component
Index: kontact/plugins/kitchensync/kitchensync.desktop
===================================================================
--- kontact/plugins/kitchensync/kitchensync.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kitchensync/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kitchensync
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkitchensyncpart
 
 X-KDE-PluginInfo-Name=kontact_kitchensync
@@ -13,109 +13,5 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=false
 
-Comment=KitchenSync Plugin
-Comment[af]=KitchenSync inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
-Comment[br]=Lugent KitchenSync
-Comment[bs]=KitchenSync dodatak
-Comment[ca]=Endollable KitchenSync
-Comment[cs]=Modul KitchenSync
-Comment[cy]=Ategyn KitchenSync
-Comment[da]=K√∏kkenvask-plugin
-Comment[de]=KitchenSync-Modul
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KitchenSync
-Comment[es]=Accesorio de KitchenSync
-Comment[et]=KitchenSynci plugin
-Comment[eu]=KitchenSync plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä KitchenSync
-Comment[fi]=KitchenSync-liit√§nn√§inen
-Comment[fr]=Module KitchenSync
-Comment[fy]=KitchenSync-plugin
-Comment[ga]=Breise√°n KitchenSync
-Comment[gl]=Extensi√≥n KitchenSync
-Comment[hi]=‡§ï‡§ø‡§ö‡§®-‡§∏‡§ø‡§Ç‡§ï ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=KitchenSync b≈ëv√≠t≈ëmodul
-Comment[is]=KitchenSync √≠forrit
-Comment[it]=Plugin KitchenSync
-Comment[ja]=KitchenSync „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KitchenSync –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KitchenSync
-Comment[lt]=KitchenSync priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ KitchenSync
-Comment[ms]=Plugin KitchenSync
-Comment[nb]=Programtillegg for KitchenSync
-Comment[nds]=KitchenSync-Moduul
-Comment[ne]=KitchenSync ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=KitchenSync-plugin
-Comment[nn]=KitchenSync-programtillegg
-Comment[pl]=Wtyczka KitchenSync
-Comment[pt]='Plugin' do KitchenSync
-Comment[pt_BR]=Plug-in para KitchenSync
-Comment[ru]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
-Comment[se]=KitchenSync-lassemoduvla
-Comment[sk]=Modul pre KitchenSync
-Comment[sl]=Vstavek KitchenSync
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ KitchenSync-–∞
-Comment[sr@Latn]=Prikljuƒçak KitchenSync-a
-Comment[sv]=Kitchensync-insticksprogram
-Comment[ta]=‡Æï‡Æø‡Æö‡Øç‡Æö‡Æ©‡Øç ‡Æí‡Æ©‡Øç‡Æ±‡Æø‡Æ£‡Øà ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ KitchenSync
-Comment[tr]=KitchenSync Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ KitchenSync
-Comment[zh_CN]=KitchenSync Êèí‰ª∂
-Comment[zh_TW]=KitchenSync Â§ñÊéõÁ®ãÂºè
-Name=Synchronization
-Name[af]=Sinkronisasie
-Name[ar]=ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
-Name[be]=–°—ã–Ω—Ö—Ä–∞–Ω—ñ–∑–∞—Ü—ã—è
-Name[bs]=Sinhronizacija
-Name[ca]=Sincronitzaci√≥
-Name[cs]=Synchronizace
-Name[cy]=Cydamseriad
-Name[da]=Synkronisering
-Name[de]=Abgleich
-Name[el]=Œ£œÖŒ≥œáœÅŒøŒΩŒπœÉŒºœåœÇ
-Name[en_GB]=Synchronisation
-Name[es]=Sincronizaci√≥n
-Name[et]=S√ºnkroniseerimine
-Name[eu]=Sinkronizazioa
-Name[fa]=ŸáŸÖ⁄ØÿßŸÖ‚Äåÿ≥ÿßÿ≤€å
-Name[fi]=Synkronointi
-Name[fr]=Synchronisation
-Name[fy]=Syngronisaasje
-Name[ga]=Sioncr√≥n√∫
-Name[gl]=Sincronizaci√≥n
-Name[hi]=‡§∏‡§ø‡§Ç‡§ï‡•ç‡§∞‡•ã‡§®‡§æ‡§á‡§ú‡•á‡§∂‡§®
-Name[hu]=Szinkroniz√°ci√≥
-Name[is]=Samstilling
-Name[it]=Sincronizzazione
-Name[ja]=ÂêåÊúü
-Name[kk]=“ö–∞–¥–∞–º–¥–∞—Å—Ç—ã—Ä—É
-Name[km]=·ûü·ûò·ûÄ·û∂·ûõ·ûÄ·ûò·üí·ûò
-Name[lt]=Sinchronizacija
-Name[mk]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞
-Name[ms]=Segerakan
-Name[nb]=Synkronisering
-Name[nds]=Synkroniseren
-Name[ne]=‡§∏‡§Æ‡§ï‡•ç‡§∞‡§Æ‡§£
-Name[nl]=Sync
-Name[nn]=Synkronisering
-Name[pa]=‡®∏‡®Æ‡®ï‡®æ‡®≤‡©Ä
-Name[pl]=Synchronizacja
-Name[pt]=Sincroniza√ß√£o
-Name[pt_BR]=Sincroniza√ß√£o
-Name[ro]=Sincronizare
-Name[ru]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
-Name[se]=Buohtalastin
-Name[sk]=Synchroniz√°cia
-Name[sl]=Usklajevanje
-Name[sr]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞
-Name[sr@Latn]=Sinhronizacija
-Name[sv]=Synkronisering
-Name[ta]=‡Æí‡Æ©‡Øç‡Æ±‡Æø‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡ØÅ
-Name[tg]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç—Å–∏—è
-Name[tr]=Senkronizasyon
-Name[uk]=–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
-Name[uz]=–¢–µ–Ω–≥–ª–∞—à—Ç–∏—Ä–∏—à
-Name[zh_CN]=ÂêåÊ≠•
-Name[zh_TW]=ÂêåÊ≠•
+Comment=Synchronization Component (Kitchensynk Plugin)
+Name=Sync
Index: kontact/plugins/kpilot/summarywidget.cpp
===================================================================
--- kontact/plugins/kpilot/summarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kpilot/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,7 +60,7 @@
 
   int row=0;
   QPixmap icon = KGlobal::iconLoader()->loadIcon( "kpilot", KIcon::Desktop, KIcon::SizeMedium );
-  QWidget *header = createHeader( this, icon, i18n( "KPilot Information" ) );
+  QWidget *header = createHeader( this, icon, i18n( "KPilot Configuration" ) );
   mLayout->addMultiCellWidget( header, row,row, 0,3 );
 
   // Last sync information
Index: kontact/plugins/kpilot/kpilotplugin.desktop
===================================================================
--- kontact/plugins/kpilot/kpilotplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kpilot/kpilotplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -6,7 +6,7 @@
 
 X-KDE-Library=libkontact_kpilotplugin
 X-KDE-KontactIdentifier=kpilot
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
@@ -16,104 +16,5 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KPilot Plugin
-Comment[af]=Kontact KPilot inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "KPilot"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –≤—Ä—ä–∑–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å–Ω–∏–∫–∞ —Å –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
-Comment[br]=Lugent Kontact KPilot
-Comment[bs]=Kontact KPilot dodatak
-Comment[ca]=Endollable de KPilot per a Kontact
-Comment[cs]=Modul KPilotu pro aplikaci Kontact
-Comment[da]=Kontact KPilot-plugin
-Comment[de]=Kontact KPilot-Modul
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KPilot œÑŒøœÖ Kontact
-Comment[es]=Accesorio KPilot para Kontact
-Comment[et]=Kontacti KPiloti plugin
-Comment[eu]=Kontact-en KPilot plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact KPilot
-Comment[fi]=Kontactin KPilot-liit√§nn√§inen
-Comment[fr]=Module KPilot pour Kontact
-Comment[fy]=Kontact KPilot-plugin
-Comment[ga]=Breise√°n KPilot le haghaidh Kontact
-Comment[gl]=Extensi√≥n de KPilot para Kontact
-Comment[hu]=Kontact KPilot-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact KPilot √≠forrit
-Comment[it]=Plugin KPilot Kontact
-Comment[ja]=Kontact KPilot „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KPilot –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KPilot ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KPilot priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ö–ü–∏–ª–æ—Ç –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin KPilot Kontact 
-Comment[nb]=Kontact programtillegg for KPilot
-Comment[nds]=KPilot-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§™‡§æ‡§á‡§≤‡§ü ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KPilot-plugin
-Comment[nn]=Kontact-programtillegg for KPilot
-Comment[pl]=Wtyczka KPilota do Kontact
-Comment[pt]='Plugin' do KPilot para o Kontact
-Comment[pt_BR]=Plug-in do KPilot para o Kontact
-Comment[ru]=–î–æ—Å—Ç—É–ø –∫ –ö–ü–ö —á–µ—Ä–µ–∑ KPilot
-Comment[se]=Kontact, KPilot-lassemoduvla
-Comment[sk]=Modul KPilot pre Kontact
-Comment[sl]=Vstavek KPilota za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KPilot
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KPilot
-Comment[sv]=Kontact-insticksprogram f√∂r Kpilot
-Comment[ta]=‡Æï‡Øá‡Æ™‡Øà‡Æ≤‡Æü‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ KPilot
-Comment[tr]=Kontact KPilot Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ Kontact –¥–ª—è KPilot
-Comment[uz]=Kontact —É—á—É–Ω KPilot –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KPilot Êèí‰ª∂
-Comment[zh_TW]=Kontact KPilot Â§ñÊéõÁ®ãÂºè
-Name=KPilot Configuration
-Name[af]=KPilot opstelling
-Name[ar]=ÿ•ÿπÿØÿßÿØ KPilot
-Name[be]=–ö–∞–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ã—è KPilot
-Name[br]=Kefluniadur KPilot
-Name[bs]=KPilot pode≈°avanje
-Name[ca]=Configuraci√≥ de KPilot
-Name[cs]=Nastaven√≠ KPilotu
-Name[da]=KPilot indstilling
-Name[de]=KPilot-Einrichtung
-Name[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ KPilot
-Name[es]=Configuraci√≥n de KPilot
-Name[et]=KPiloti seadistamine
-Name[eu]=KPilot-en konfigurazioa
-Name[fa]=Ÿæ€å⁄©ÿ±ÿ®ŸÜÿØ€å KPilot
-Name[fi]=KPilot-asetukset
-Name[fr]=Configuration de KPilot
-Name[fy]=KPilot ynstellings
-Name[ga]=Cumra√≠ocht KPilot
-Name[gl]=Configuraci√≥n de KPilot
-Name[hu]=A KPilot be√°ll√≠t√°sai
-Name[is]=KPilot stillingar
-Name[it]=Configurazione KPilot
-Name[ja]=KPilot „ÅÆË®≠ÂÆö
-Name[kk]=KPilot –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ
-Name[km]=·ûÄ·û∂·ûö‚Äã·ûÄ·üÜ·ûé·ûè·üã‚Äã·ûö·ûÖ·ûì·û∂·ûü·ûò·üí·ûñ·üê·ûì·üí·ûí KPilot
-Name[lt]=Kpilot konfig≈´racija
-Name[mk]=–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò–∞ –Ω–∞ –ö–ü–∏–ª–æ—Ç
-Name[ms]=Konfigurasi KPilot
-Name[nb]=KPilot oppsett
-Name[nds]=KPilot instellen
-Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§™‡§æ‡§á‡§≤‡§ü ‡§ï‡§®‡•ç‡§´‡§ø‡§ó‡§∞‡•á‡§∏‡§®
-Name[nl]=KPilot instellingen
-Name[nn]=KPilot-oppsett
-Name[pl]=konfiguracja KPilota
-Name[pt]=Configura√ß√£o do KPilot
-Name[pt_BR]=Configura√ß√£o do KPilot
-Name[ru]=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ö–ü–ö
-Name[se]=KPilot-heivehus
-Name[sk]=Nastavenie KPilot
-Name[sl]=Nastavitve KPilota
-Name[sr]=KPilot –ø–æ–¥–µ—à–∞–≤–∞—ö–µ
-Name[sr@Latn]=KPilot pode≈°avanje
-Name[sv]=Inst√§llning av Kpilot
-Name[ta]=K‡Æ™‡Øà‡Æ≤‡Æü‡Øç ‡Æï‡Æü‡Øç‡Æü‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ
-Name[tg]=–¢–∞–Ω–∑–∏–º–æ—Ç–∏ KPilot
-Name[tr]=KPilot Yapƒ±landƒ±rmasƒ±
-Name[uk]=–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è KPilot
-Name[zh_CN]=KPilot ÈÖçÁΩÆ
-Name[zh_TW]=KPilot Ë®≠ÂÆö
+Comment=Palm Tools Component (KPilot Plugin)
+Name=Palm
Index: kontact/plugins/knotes/knotes_part.h
===================================================================
--- kontact/plugins/knotes/knotes_part.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_part.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -87,6 +87,8 @@
     void popupRMB( QIconViewItem *item, const QPoint& pos );
     void killSelectedNotes();
 
+    void printSelectedNotes();
+
   private:
     KIconView *mNotesView;
     KNoteTip *mNoteTip;
Index: kontact/plugins/knotes/knotes_plugin.cpp
===================================================================
--- kontact/plugins/knotes/knotes_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -18,6 +18,7 @@
        Boston, MA 02110-1301, USA.
 */
 
+#include <dcopref.h>
 #include <kaboutdata.h>
 #include <kaction.h>
 #include <kdebug.h>
@@ -45,6 +46,8 @@
 
   insertNewAction( new KAction( i18n( "New Note..." ), "knotes", CTRL+SHIFT+Key_N,
                    this, SLOT( slotNewNote() ), actionCollection(), "new_note" ) );
+  insertSyncAction( new KAction( i18n( "Synchronize Notes" ), "reload", 0,
+                   this, SLOT( slotSyncNotes() ), actionCollection(), "knotes_sync" ) );
 }
 
 KNotesPlugin::~KNotesPlugin()
@@ -84,5 +87,11 @@
       static_cast<KNotesPart *>( part() )->newNote();
 }
 
+void KNotesPlugin::slotSyncNotes()
+{
+  DCOPRef ref( "kmail", "KMailICalIface" );
+  ref.send( "triggerSync", QString("Note") );
+}
+
 #include "knotes_plugin.moc"
 
Index: kontact/plugins/knotes/summarywidget.cpp
===================================================================
--- kontact/plugins/knotes/summarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -74,14 +74,14 @@
 void KNotesSummaryWidget::updateView()
 {
   mNotes = mCalendar->journals();
+  QLabel *label;
 
-  mLabels.setAutoDelete( true );
+  for ( label = mLabels.first(); label; label = mLabels.next() )
+    label->deleteLater();
   mLabels.clear();
-  mLabels.setAutoDelete( false );
 
   KIconLoader loader( "knotes" );
 
-  QLabel *label = 0;
   int counter = 0;
   QPixmap pm = loader.loadIcon( "knotes", KIcon::Small );
 
Index: kontact/plugins/knotes/knotes_plugin.h
===================================================================
--- kontact/plugins/knotes/knotes_plugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,6 +48,7 @@
 
   private slots:
     void slotNewNote();
+    void slotSyncNotes();
 
   private:
     KAboutData *mAboutData;
Index: kontact/plugins/knotes/Makefile.am
===================================================================
--- kontact/plugins/knotes/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,9 +4,10 @@
 libkontact_knotesplugin_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN)
 libkontact_knotesplugin_la_LIBADD = $(top_builddir)/kontact/interfaces/libkpinterfaces.la \
                                     $(LIB_KPARTS) $(top_builddir)/libkdepim/libkdepim.la \
-                                    $(top_builddir)/libkcal/libkcal.la -lkresources \
+                                    $(top_builddir)/libkcal/libkcal.la -lkresources -lkdeprint \
                                     $(top_builddir)/knotes/libknotesresources.la \
-                                    $(top_builddir)/knotes/libknoteseditor.la
+                                    $(top_builddir)/knotes/libknoteseditor.la \
+                                    $(top_builddir)/knotes/libknotesprinting.la
 
 libkontact_knotesplugin_la_SOURCES = knotes_plugin.cpp knotes_part.cpp summarywidget.cpp \
                                      knotetip.cpp KNotesIface.skel
Index: kontact/plugins/knotes/knotes_part.cpp
===================================================================
--- kontact/plugins/knotes/knotes_part.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_part.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -30,6 +30,7 @@
 #include <libkdepim/infoextension.h>
 #include <libkdepim/sidebarextension.h>
 
+#include "knotes/knoteprinter.h"
 #include "knotes/resourcemanager.h"
 
 #include "knotes_part.h"
@@ -39,7 +40,7 @@
 
 KNotesPart::KNotesPart( QObject *parent, const char *name )
   : DCOPObject( "KNotesIface" ), KParts::ReadOnlyPart( parent, name ),
-    mNotesView( new KIconView() ),
+    mNotesView( new KNotesIconView() ),
     mNoteTip( new KNoteTip( mNotesView ) ),
     mNoteEditDlg( 0 ),
     mManager( new KNotesResourceManager() )
@@ -55,6 +56,8 @@
                actionCollection(), "edit_rename" );
   new KAction( i18n( "Delete" ), "editdelete", Key_Delete, this, SLOT( killSelectedNotes() ),
                actionCollection(), "edit_delete" );
+  new KAction( i18n( "Print Selected Notes..." ), "print", CTRL+Key_P, this, SLOT( printSelectedNotes() ),
+               actionCollection(), "print_note" );
 
   // TODO icons: s/editdelete/knotes_delete/ or the other way round in knotes
 
@@ -106,6 +109,41 @@
   mManager = 0;
 }
 
+void KNotesPart::printSelectedNotes()
+{
+  QValueList<KCal::Journal*> journals;
+
+  for ( QIconViewItem *it = mNotesView->firstItem(); it; it = it->nextItem() ) {
+    if ( it->isSelected() ) {
+      journals.append( static_cast<KNotesIconViewItem *>( it )->journal() );
+    }
+  }
+
+  if ( journals.isEmpty() ) {
+    KMessageBox::information( mNotesView, i18n("To print notes, first select the notes to print from the list."), i18n("Print Notes") );
+    return;
+  }
+
+  KNotePrinter printer;
+  printer.printNotes(journals );
+
+#if 0
+    QString content;
+    if ( m_editor->textFormat() == PlainText )
+        content = QStyleSheet::convertFromPlainText( m_editor->text() );
+    else
+        content = m_editor->text();
+
+    KNotePrinter printer;
+    printer.setMimeSourceFactory( m_editor->mimeSourceFactory() );
+    //printer.setFont( m_config->font() );
+    //printer.setContext( m_editor->context() );
+    //printer.setStyleSheet( m_editor->styleSheet() );
+    printer.setColorGroup( colorGroup() );
+    printer.printNote( , content );
+#endif
+}
+
 bool KNotesPart::openFile()
 {
   return false;
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knotesplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPluginHasSummary=true
 
 X-KDE-PluginInfo-Website=http://pim.kde.org/components/knotes.php
@@ -14,59 +14,7 @@
 X-KDE-PluginInfo-License=LGPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KNotes Plugin
-Comment[af]=Kontact KNotes inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "K –ù–∞—Ç–∞—Ç–∫—ñ"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –±–µ–ª–µ–∂–∫–∏
-Comment[br]=Lugent Kontact KNotes
-Comment[bs]=Kontact KNotes dodatak
-Comment[ca]=Endollable KNotes per a Kontact
-Comment[cs]=Modul KNotes pro aplikaci Kontact
-Comment[cy]=Ategyn KNotes Kontact 
-Comment[da]=Kontact KNotes-plugin
-Comment[de]=KNotes-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KNotes œÑŒøœÖ Kontact
-Comment[es]=Plugin de KNotes para Kontact
-Comment[et]=Kontacti KNotesi plugin
-Comment[eu]=Kontact-en KNotes plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact KNotes
-Comment[fi]=Kontactin KNotes-liit√§nn√§inen
-Comment[fr]=Module KNotes pour Kontact
-Comment[fy]=Kontact KNotes-plugin
-Comment[ga]=Breise√°n KNotes le haghaidh Kontact
-Comment[gl]=Extensi√≥n de KNotes para Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§ï‡•á-‡§®‡•ã‡§ü‡•ç‡§∏ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact KNotes-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact KNotes √≠forrit
-Comment[it]=Plugin Kontact KNotes
-Comment[ja]=Kontact KNotes „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KNotes –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KNotes ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KNotes priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ö–ë–µ–ª–µ—à–∫–∏ –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin KNotes Kontact KNotes 
-Comment[nb]=Kontact programtillegg for KNotes
-Comment[nds]=KNotes-Moduul f√∂r Kontact
-Comment[ne]=‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•á‡§°‡•Ä‡§à ‡§ü‡§ø‡§™‡•ã‡§ü ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=Kontact KNotes-plugin
-Comment[nn]=Kontact-programtillegg for KNotes
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KNotes
-Comment[pt]='Plugin' do KNotes para o Kontact
-Comment[pt_BR]=Plug-in para Knotes do Kontact
-Comment[ro]=Modul KNotes pentru Kontact
-Comment[ru]=–ó–∞–º–µ—Ç–∫–∏
-Comment[se]=Kontact, KNotes-lassemoduvla
-Comment[sl]=Vstavek KNotes za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KNotes
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KNotes
-Comment[sv]=Kontact insticksdelprogram f√∂r Knotes
-Comment[ta]= ‡Æï‡Øá‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ –∞—Ö–±–æ—Ä–æ—Ç
-Comment[tr]=Kontact KNotes Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –ø—Ä–∏–º—ñ—Ç–æ–∫ (KNotes) Kontact
-Comment[uz]=Kontact —É—á—É–Ω KNotes –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KNotes Êèí‰ª∂
-Comment[zh_TW]=Kontact KNotes Â§ñÊéõÁ®ãÂºè
+Comment=Notes Component (KNotes Plugin)
 Name=Notes
 Name[af]=Notas
 Name[ar]=ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
@@ -78,6 +26,7 @@
 Name[da]=Noter
 Name[de]=Notizen
 Name[el]=Œ£Œ∑ŒºŒµŒπœéœÉŒµŒπœÇ
+Name[eo]=Notoj
 Name[es]=Notas
 Name[et]=M√§rkmed
 Name[eu]=Oharrak
Index: kontact/plugins/knotes/knotes_part.rc
===================================================================
--- kontact/plugins/knotes/knotes_part.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,16 +1,20 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="knotes" version="3">
+<kpartgui name="knotes" version="5">
   <MenuBar>
+    <Menu name="file"><text>&amp;File</text>
+      <Merge/>
+      <Action name="print_note"/>
+    </Menu>
     <Menu name="edit"><text>&amp;Edit</text>
       <Action name="edit_rename"/>
       <Action name="edit_delete"/>
     </Menu>
   </MenuBar>
-
   <Menu name="note_context">
     <Action name="file_new"/>
     <Action name="edit_rename"/>
     <Action name="edit_delete"/>
+    <Action name="print_note"/>
   </Menu>
   <Menu name="notepart_context">
     <Action name="file_new"/>
Index: kontact/plugins/knotes/knotes_part_p.h
===================================================================
--- kontact/plugins/knotes/knotes_part_p.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/knotes/knotes_part_p.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -49,7 +49,10 @@
 #include <kxmlguifactory.h>
 #include <kxmlguibuilder.h>
 
+#include <libkcal/calendarlocal.h>
 #include <libkcal/journal.h>
+#include <libkcal/icaldrag.h>
+#include <libkdepim/kpimprefs.h>
 
 #include "knotes/knoteedit.h"
 
@@ -87,6 +90,28 @@
 };
 
 
+class KNotesIconView : public KIconView
+{
+  protected:
+    QDragObject* dragObject()
+    {
+      QValueList<KNotesIconViewItem*> selectedItems;
+      for ( QIconViewItem *it = firstItem(); it; it = it->nextItem() ) {
+        if ( it->isSelected() )
+          selectedItems.append( static_cast<KNotesIconViewItem *>( it ) );
+      }
+      if ( selectedItems.count() != 1 )
+        return KIconView::dragObject();
+
+      KCal::CalendarLocal cal( KPimPrefs::timezone() );
+      KCal::Incidence *i = selectedItems.first()->journal()->clone();
+      cal.addIncidence( i );
+      KCal::ICalDrag *icd = new KCal::ICalDrag( &cal, this );
+      return icd;
+    }
+};
+
+
 class KNoteEditDlg : public KDialogBase, virtual public KXMLGUIClient
 {
   Q_OBJECT
Index: kontact/plugins/karm/karmplugin.desktop
===================================================================
--- kontact/plugins/karm/karmplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/karm/karmplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_karm
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkarmpart
 
 X-KDE-PluginInfo-Name=kontact_karm
@@ -13,58 +13,6 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=false
 
-Comment=KArm Plugin
-Comment[af]=KArm inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ KArm
-Comment[br]=Lugent KArm
-Comment[ca]=Endollable KArm
-Comment[cs]=Modul KArm
-Comment[da]=KArm-plugin
-Comment[de]=KArm-Modul
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ KArm
-Comment[es]=Extensi√≥n KArm
-Comment[et]=KArmi plugin
-Comment[eu]=KArm plugina
-Comment[fa]=ŸàÿµŸÑ€Ä KArm
-Comment[fi]=KArm-liit√§nn√§inen
-Comment[fr]=Module pour KArm
-Comment[fy]=KArm-plugin
-Comment[ga]=Breise√°n KArm
-Comment[gl]=Extensi√≥n para KArm
-Comment[hu]=KArm b≈ëv√≠t≈ëmodul
-Comment[is]=KArm √≠forrit
-Comment[it]=Plugin KArm
-Comment[ja]=KArm „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KArm –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KArm
-Comment[lt]=KArm priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ KArm
-Comment[ms]=Plugin KArm 
-Comment[nb]=KArm-programtillegg
-Comment[nds]=KArm-Moduul
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§∞‡•ç‡§Æ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=KArm-plugin
-Comment[nn]=KArm-programtillegg
-Comment[pl]=Wtyczka KArm
-Comment[pt]='Plugin' KArm
-Comment[pt_BR]=Plugin do KArm
-Comment[ru]=–ú–æ–¥—É–ª—å KArm
-Comment[sk]=Modul KArm
-Comment[sl]=Vstavek za KArm
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ KArm-–∞
-Comment[sr@Latn]=Prikljuƒçak KArm-a
-Comment[sv]=Karm-insticksprogram
-Comment[tr]=KArm Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ KArm
-Comment[uz]=KArm –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=KArm Êèí‰ª∂
-Comment[zh_TW]=KArm Â§ñÊéõÁ®ãÂºè
+Comment=Time Tracker Component (KArm Plugin)
 
-Name=KArm
-Name[af]=Karm
-Name[eo]=Tempomezurilo
-Name[hi]=‡§ï‡•á-‡§Ü‡§∞‡•ç‡§Æ
-Name[sv]=Karm
-Name[ta]=K‡ÆÖ‡ÆÆ‡Øç
-Name[xh]=KAlrm
-Name[zh_TW]=KArm ÂÄã‰∫∫ÊôÇÁ®ãÁ¥ÄÈåÑ
+Name=Timer
Index: kontact/plugins/kaddressbook/kaddressbook_plugin.h
===================================================================
--- kontact/plugins/kaddressbook/kaddressbook_plugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kaddressbook/kaddressbook_plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -65,10 +65,18 @@
 
     KAddressBookIface_stub *interface();
 
+    //override
+    void loadProfile( const QString& directory );
+
+    //override
+    void saveToProfile( const QString& directory ) const;
+
   protected:
     KParts::ReadOnlyPart *createPart();
   private slots:
     void slotNewContact();
+    void slotNewDistributionList();
+    void slotSyncContacts();
 
   private:
     KAddressBookIface_stub *mStub;
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kaddressbookplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkaddressbookpart
 X-KDE-KontactPartExecutableName=kaddressbook
 X-KDE-KontactPluginHasSummary=false
@@ -16,59 +16,7 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KAddressBook Plugin
-Comment[af]=Kontact adresboek inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "K –ê–¥—Ä–∞—Å–Ω–∞—è –∫–Ω—ñ–≥–∞"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –∞–¥—Ä–µ—Å–Ω–∏–∫–∞
-Comment[br]=Lugent Kontact KAddressBook
-Comment[bs]=Kontact KAddressBook dodatak
-Comment[ca]=Endollable de la llibreta d'adreces per a Kontact
-Comment[cs]=Modul Knihy adres pro Kontact
-Comment[cy]=Ategyn KLlyfrCyfeiriadau Kontact
-Comment[da]=Kontact KAddressbook-plugin
-Comment[de]=Adressbuch-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KAddressBook œÑŒøœÖ Kontact
-Comment[es]=Plugin de KAddressbook para Kontact
-Comment[et]=Kontacti KDE aadressiraamatu plugin
-Comment[eu]=Kontact-en KAddressBook plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ⁄©ÿ™ÿßÿ® ŸÜÿ¥ÿßŸÜ€å Kontact
-Comment[fi]=Kontactin KAddressBook-liit√§nn√§inen
-Comment[fr]=Module KAddressBook pour Kontact
-Comment[fy]=Kontact KAddressBook-plugin
-Comment[ga]=Breise√°n KAddressBook Kontact
-Comment[gl]=Extensi√≥n de KAddressBook para Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§ï‡•á-‡§è‡§°‡•ç‡§∞‡•á‡§∏-‡§¨‡•Å‡§ï ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact-b≈ëv√≠t≈ëmodul a KAddressbookhoz
-Comment[is]=Kontact KAddressBook √≠forrit
-Comment[it]=Plugin Kontact di KAddressbook
-Comment[ja]=Kontact KAddressbook „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KAddressBook –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KAddressBook ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KAddressBook priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ö–ê–¥—Ä–µ—Å–∞—Ä –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin KAddressBook Kontact 
-Comment[nb]=Kontact programtillegg for KAddressbook
-Comment[nds]=KAdressbook-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§†‡•á‡§ó‡§æ‡§®‡§æ ‡§™‡•Å‡§∏‡•ç‡§§‡§ø‡§ï‡§æ ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KAddressBook-plugin
-Comment[nn]=Kontact, programtillegg for KDE-adresseboka
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KAddressBook
-Comment[pt]='Plugin' do KAddressbook para o Kontact
-Comment[pt_BR]=Plug-in para KAddressBook do Kontact
-Comment[ro]=Modul KAddressBook pentru Kontact
-Comment[ru]=–ê–¥—Ä–µ—Å–Ω–∞—è –∫–Ω–∏–≥–∞
-Comment[se]=Kontact, KDE-ƒçujuhusgirjji lassemoduvla
-Comment[sl]=Vstavek Adresarja za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KAddressBook
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KAddressBook
-Comment[sv]=Kontact-insticksprogram f√∂r adressbok
-Comment[ta]= ‡Æï‡Øá‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡Æï ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ –∫–∏—Ç–æ–±–∏ –∞–¥—Ä–µ—Å”£
-Comment[tr]=Kontact KAdresDefteri Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –∞–¥—Ä–µ—Å–Ω–æ—ó –∫–Ω–∏–≥–∏ Kontact
-Comment[uz]=Kontact —É—á—É–Ω KAddressBook –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KAddressbook Êèí‰ª∂
-Comment[zh_TW]=Kontact KAddressBook Â§ñÊéõÁ®ãÂºè
+Comment=Contacts Component (KAdressbook Plugin)
 Name=Contacts
 Name[af]=Kontakte
 Name[ar]=ÿßŸÑŸÖÿ±ÿßÿ≥ŸÑŸàŸÜ
@@ -81,6 +29,7 @@
 Name[da]=Kontakter
 Name[de]=Kontakte
 Name[el]=ŒïœÄŒ±œÜŒ≠œÇ
+Name[eo]=Kontaktoj
 Name[es]=Contactos
 Name[et]=Kontaktid
 Name[eu]=Kontaktuak
Index: kontact/plugins/kaddressbook/kaddressbook_plugin.cpp
===================================================================
--- kontact/plugins/kaddressbook/kaddressbook_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kaddressbook/kaddressbook_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,6 +60,13 @@
   insertNewAction( new KAction( i18n( "New Contact..." ), "identity",
 			             CTRL+SHIFT+Key_C, this, SLOT( slotNewContact() ), actionCollection(),
                    "new_contact" ) );
+
+  insertNewAction( new KAction( i18n( "&New Distribution List..." ), "kontact_contacts", 0, this,
+                                SLOT( slotNewDistributionList() ), actionCollection(), "new_distributionlist" ) );
+
+  insertSyncAction( new KAction( i18n( "Synchronize Contacts" ), "reload",
+                    0, this, SLOT( slotSyncContacts() ), actionCollection(),
+                   "kaddressbook_sync" ) );
   mUniqueAppWatcher = new Kontact::UniqueAppWatcher(
       new Kontact::UniqueAppHandlerFactory<KABUniqueAppHandler>(), this );
 }
@@ -105,6 +112,18 @@
   interface()->newContact();
 }
 
+
+void KAddressbookPlugin::slotNewDistributionList()
+{
+  interface()->newDistributionList();
+}
+
+void KAddressbookPlugin::slotSyncContacts()
+{
+  DCOPRef ref( "kmail", "KMailICalIface" );
+  ref.send( "triggerSync", QString("Contact") );
+}
+
 bool KAddressbookPlugin::createDCOPInterface( const QString& serviceType )
 {
   if ( serviceType == "DCOP/AddressBook" )  {
@@ -156,6 +175,19 @@
                       .arg( event->format() ) );
 }
 
+
+void KAddressbookPlugin::loadProfile( const QString& directory )
+{
+  DCOPRef ref( "kaddressbook", "KAddressBookIface" );
+  ref.send( "loadProfile", directory );
+}
+
+void KAddressbookPlugin::saveToProfile( const QString& directory ) const
+{
+  DCOPRef ref( "kaddressbook", "KAddressBookIface" );
+  ref.send( "saveToProfile", directory );
+}
+
 ////
 
 #include "../../../kaddressbook/kaddressbook_options.h"
Index: kontact/plugins/korganizer/journalplugin.h
===================================================================
--- kontact/plugins/korganizer/journalplugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/journalplugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,6 +53,7 @@
 
   private slots:
     void slotNewJournal();
+    void slotSyncJournal();
 
   private:
     KCalendarIface_stub *mIface;
Index: kontact/plugins/korganizer/korganizerplugin.h
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/korganizerplugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,11 +56,16 @@
 
     KCalendarIface_stub *interface();
 
+
+    void loadProfile( const QString& path );
+    void saveToProfile( const QString& path ) const;
+
   protected:
     KParts::ReadOnlyPart *createPart();
 
   private slots:
     void slotNewEvent();
+    void slotSyncEvents();
 
   private:
     KCalendarIface_stub *mIface;
Index: kontact/plugins/korganizer/summarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/summarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,7 +58,7 @@
 
   QPixmap icon = KGlobal::iconLoader()->loadIcon( "kontact_date",
                    KIcon::Desktop, KIcon::SizeMedium );
-  QWidget *header = createHeader( this, icon, i18n( "Appointments" ) );
+  QWidget *header = createHeader( this, icon, i18n( "Calendar" ) );
   mainLayout->addWidget( header );
 
   mLayout = new QGridLayout( mainLayout, 7, 5, 3 );
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,49 +11,7 @@
 X-KDE-ParentComponents=kontact_korganizerplugin,kontact_todoplugin
 X-KDE-CfgDlgHierarchy=KontactSummary
 
-Name=Appointments and To-dos
-Name[af]=Afsprake en te-doen lys
-Name[ar]=ÿßŸÑŸÖŸàÿßÿπŸäÿØ Ÿà ÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™
-Name[ca]=Cites i tasques pendents
-Name[cs]=Sch≈Øzky a √∫koly
-Name[da]=M√∏der og g√∏rem√•l
-Name[de]=Termine und Aufgaben
-Name[el]=Œ°Œ±ŒΩœÑŒµŒ≤Œøœç Œ∫Œ±Œπ ŒµœÅŒ≥Œ±œÉŒØŒµœÇ œÄœÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑
-Name[es]=Citas y tareas pendientes
-Name[et]=Kohtumised ja √ºlesanded
-Name[eu]=Hitzorduak eta egitekoak
-Name[fa]=ŸÇÿ±ÿßÿ± ŸÖŸÑÿßŸÇÿßÿ™Ÿáÿß Ÿà ⁄©ÿßÿ±Ÿáÿß€å€å ⁄©Ÿá ÿ®ÿß€åÿØ ÿßŸÜÿ¨ÿßŸÖ ÿ¥ŸàŸÜÿØ
-Name[fi]=Tapaamiset ja teht√§v√§t
-Name[fr]=√âv√®nements et t√¢ches
-Name[fy]=Eveneminten en taken
-Name[gl]=Apuntamentos e Tarefas
-Name[he]=◊§◊í◊ô◊©◊ï◊™ ◊ï◊û◊ò◊ú◊ï◊™
-Name[hu]=Tal√°lkoz√≥k √©s feladatok
-Name[is]=Fundir og verk√æ√¶ttir
-Name[it]=Appuntamenti e cose da fare
-Name[ja]=Á¥ÑÊùü„Å® To-do
-Name[kk]=–ö–µ–∑–¥–µ—Å—É–ª–µ—Ä –º–µ–Ω –ñ–æ—Å–ø–∞—Ä–ª–∞—Ä
-Name[km]=·ûÄ·û∂·ûö‚Äã·ûé·û∂·ûè·üã ·ûì·û∑·ûÑ‚Äã·ûÄ·û∂·ûö·ûÑ·û∂·ûö‚Äã·ûè·üí·ûö·ûº·ûú‚Äã·ûí·üí·ûú·ûæ
-Name[lt]=Susitikimai ir u≈æduotys
-Name[nb]=Avtaler og gj√∏rem√•l
-Name[nds]=Terminen un Opgaven
-Name[ne]=‡§≠‡•á‡§ü‡§ò‡§æ‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§π‡§∞‡•Ç
-Name[nl]=Evenementen en taken
-Name[nn]=Avtalar og oppg√•ver
-Name[pl]=Spotkania i zadania
-Name[pt]=Compromissos e A-fazeres
-Name[pt_BR]=Compromissos e Tarefas
-Name[ru]=–í—Å—Ç—Ä–µ—á–∏ –∏ –∑–∞–¥–∞—á–∏
-Name[sk]=Pripomienky a √∫lohy
-Name[sl]=Sestanki in opravila
-Name[sr]=–°–∞—Å—Ç–∞–Ω—Ü–∏ –∏ –æ–±–∞–≤–µ–∑–µ
-Name[sr@Latn]=Sastanci i obaveze
-Name[sv]=M√∂ten och uppgifter
-Name[th]=‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥
-Name[tr]=√ñzel G√ºnler ve Yapƒ±lacaklar
-Name[uk]=–ó—É—Å—Ç—Ä—ñ—á—ñ —ñ –∑–∞–≤–¥–∞–Ω–Ω—è
-Name[zh_CN]=Á∫¶‰ºöÂíåÂæÖÂäû
-Name[zh_TW]=Á¥ÑÊúÉËàáÂæÖËæ¶‰∫ãÈ†Ö
+Name=Appointment and To-do Overview
 Comment=Appointments and To-dos Summary Setup
 Comment[af]=Afsprake en te-doen opsomming opstelling
 Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –æ–±–æ–±—â–µ–Ω –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å—Ä–µ—â–∏—Ç–µ –∏ –∑–∞–¥–∞—á–∏—Ç–µ
@@ -104,7 +62,7 @@
 Keywords[ca]=calendari, pendents, configuraci√≥, arranjament
 Keywords[cs]=kalend√°≈ô,√∫koly,nastavit,nastaven√≠
 Keywords[da]=kalender, g√∏rem√•l, indstil, ops√¶tning
-Keywords[de]=Kalendar,Aufgaben,einstellen,Einstellungen
+Keywords[de]=Kalender,Aufgaben,einstellen,Einstellungen
 Keywords[el]=Œ∑ŒºŒµœÅŒøŒªœåŒ≥ŒπŒø, œÄœÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑, œÅœçŒ∏ŒºŒπœÉŒ∑, œÅœÖŒ∏ŒºŒØœÉŒµŒπœÇ
 Keywords[es]=calendario, tareas pendientes, configurar, opciones
 Keywords[et]=kalender, √ºlesanded, seadistamine, seadistused
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_todoplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
@@ -16,97 +16,5 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KOrganizer To-do List Plugin
-Comment[af]=Kontact KOrganizer te-doen lys inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ —Å–ø–∏—Å—ä–∫ —Å—ä—Å –∑–∞–¥–∞—á–∏ –∏ –≤—Ä—ä–∑–∫–∞ —Å KOrganizer
-Comment[ca]=Endollable de la llista de pendents de KOrganizer - Kontact
-Comment[cs]=Modul √∫kol≈Ø KOrganizeru pro aplikaci Kontact
-Comment[da]=Kontact KOrganizer g√∏rem√•lsliste-plugin
-Comment[de]=Kontact KOrganizer-Aufgabenlisten-Modul
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÑŒøœÖ Kontact Œ≥ŒπŒ± œÑŒ∑ŒΩ œÄœÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑ ŒªŒØœÉœÑŒ± œÑŒøœÖ KOrganizer
-Comment[es]=Extensi√≥n de tareas pendientes de KOrganizer para Kontact
-Comment[et]=Kontacti KOrganizeri √ºlesannete nimekirja plugin
-Comment[eu]=Kontact-en KOrganizer-en egitekoen plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ŸÅŸáÿ±ÿ≥ÿ™ ⁄©ÿßÿ±Ÿáÿß€å ÿßŸÜÿ¨ÿßŸÖ€å Kontact KOrganizer
-Comment[fi]=Kontact KOrganizer -teht√§v√§t-liit√§nn√§inen
-Comment[fr]=Module de liste des t√¢ches de KOrganizer pour Kontact
-Comment[fy]=Kontact KOrganizer takenlijstplugin
-Comment[ga]=Breise√°n Tascliosta KOrganizer le haghaidh Kontact
-Comment[gl]=Extensi√≥n de Tarefas Pendentes para KOrganizer de Kontact
-Comment[hu]=Kontact-b≈ëv√≠t≈ëmodul a KOrganizer feladatlist√°hoz
-Comment[is]=Kontact KOrganizer verk√æ√°tta √≠forrit
-Comment[it]=Plugin Kontact per le cose da fare di KOrganizer
-Comment[ja]=Kontact KOrganizer To-do „É™„Çπ„Éà „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KOrganizer –∂–æ—Å–ø–∞—Ä–ª–∞—Ä —Ç—ñ–∑—ñ–º—ñ–Ω—ñ“£ –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûî·ûâ·üí·ûá·û∏‚Äã·ûÄ·û∂·ûö·ûÑ·û∂·ûö‚Äã·ûè·üí·ûö·ûº·ûú‚Äã·ûí·üí·ûú·ûæ‚Äã·ûö·ûî·ûü·üã KOrganizer ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KOrganizer darb≈≥ sƒÖra≈°o priedas
-Comment[ms]=Plugin Senarai Tugasan KOrganizer Kontact 
-Comment[nb]=Kontact programtillegg for KOrganizer gj√∏reliste
-Comment[nds]=KOrganizer-Opgavenlistmoduul f√∂r Kontact
-Comment[ne]=‡§ó‡§∞‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡•Ç‡§ö‡•Ä ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§® ‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï‡§≤‡§æ‡§à ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KOrganizer takenlijstplugin
-Comment[nn]=Kontact-programtillegg for KOrganizer-hugselister
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z listƒÖ zada≈Ñ KOrganizera
-Comment[pt]='Plugin' de A-Fazer do KOrganizer para o Kontact
-Comment[pt_BR]=Plug-in de Lista de Pend√™ncias do KOrganizer para Kontact
-Comment[ru]=–ó–∞–¥–∞—á–∏
-Comment[sk]=KOrganizer modul zoznamu √∫loh pre Kontact
-Comment[sl]=Vstavek opravil KOrganizerja za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KOrganizer-–æ–≤—É –ª–∏—Å—Ç—É –ø–æ—Å–ª–æ–≤–∞
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KOrganizer-ovu listu poslova
-Comment[sv]=Kontact-insticksprogram f√∂r Korganizers uppgiftslista
-Comment[ta]=‡Æï‡Øá‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡Æø‡ÆØ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tr]=Kontact KOrganizer Yapƒ±lacaklar Listesi Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å KOrganizer –¥–ª—è Kontact
-Comment[zh_CN]=Kontact KOrganizer ÂæÖÂäûÊ∏ÖÂçïÊèí‰ª∂
-Comment[zh_TW]=Kontact KOrganizer ÂæÖËæ¶‰∫ãÈ†ÖÂ§ñÊéõÁ®ãÂºè
-Name=To-do List
-Name[af]=Te-doen lys
-Name[ar]=ŸÑÿßÿ¶ÿ≠ÿ© ÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™
-Name[br]=Roll an trao√π d'ober
-Name[ca]=Pendents
-Name[cs]=Seznam √∫kol≈Ø
-Name[cy]=Rhestr I'w-Wneud
-Name[da]=G√∏rem√•lsliste
-Name[de]=Aufgaben
-Name[el]=ŒõŒØœÉœÑŒ± œÄœÅŒøœÇ œÖŒªŒøœÄŒøŒØŒ∑œÉŒ∑
-Name[es]=Tareas pendientes
-Name[et]=√úlesanded
-Name[eu]=Egitekoen zerrenda
-Name[fa]=ŸÅŸáÿ±ÿ≥ÿ™ ⁄©ÿßÿ±Ÿáÿß€å ÿßŸÜÿ¨ÿßŸÖ€å
-Name[fi]=Teht√§v√§luettelo
-Name[fr]=Liste de t√¢ches
-Name[fy]=Takenlist
-Name[ga]=Tascliosta
-Name[gl]=Lista de Tarefas Pendentes
-Name[he]=◊®◊©◊ô◊û◊™ ◊û◊ò◊ú◊ï◊™
-Name[hu]=Feladatok
-Name[is]=Verk√æ√¶ttir
-Name[it]=Cose da fare
-Name[ja]=To-do „É™„Çπ„Éà
-Name[kk]=–ñ–æ—Å–ø–∞—Ä —Ç—ñ–∑—ñ–º—ñ
-Name[km]=·ûî·ûâ·üí·ûá·û∏‚Äã·ûÄ·û∂·ûö·ûÑ·û∂·ûö‚Äã·ûè·üí·ûö·ûº·ûú‚Äã·ûí·üí·ûú·ûæ
-Name[lt]=Darbai
-Name[ms]=Senarai Tugasan
-Name[nb]=Gj√∏reliste
-Name[nds]=Opgavenlist
-Name[ne]=‡§ó‡§∞‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä
-Name[nl]=Takenlijst
-Name[nn]=Hugseliste
-Name[pa]=‡®ï‡©∞‡®Æ ‡®ï‡®∞‡®® ‡®≤‡®à
-Name[pl]=Lista zada≈Ñ
-Name[pt]=Lista de A-Fazeres
-Name[pt_BR]=Lista de Pend√™ncias
-Name[ru]=–ó–∞–¥–∞—á–∏
-Name[sk]=Zoznam √∫loh
-Name[sl]=Seznam opravil
-Name[sr]=–õ–∏—Å—Ç–∞ –ø–æ—Å–ª–æ–≤–∞
-Name[sr@Latn]=Lista poslova
-Name[sv]=Uppgiftslista
-Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡Æø‡ÆØ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øç
-Name[th]=‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥
-Name[tr]=Yapƒ±lacaklar Listesi
-Name[uk]=–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å
-Name[uz]=–í–∞–∑–∏—Ñ–∞–ª–∞—Ä
-Name[zh_CN]=ÂæÖÂäûÊ∏ÖÂçï
-Name[zh_TW]=ÂæÖËæ¶‰∫ãÈ†ÖÊ∏ÖÂñÆ
+Comment=To-do List Component (KOrganizer plugin)
+Name=To-do
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_journalplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=false
@@ -16,49 +16,7 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KOrganizer Journal Plugin
-Comment[af]=Kontact KOrganizer joernaal inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞
-Comment[ca]=Endollable de diaris KOrganizer per a Kontact
-Comment[cs]=Modul den√≠ku KOrganizeru pro aplikaci Kontact
-Comment[da]=Kontact KOrganizer journal-plugin
-Comment[de]=Kontact KOrganizer-Modul f√ºr Journaleintr√§ge
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KOrganizer ŒßœÅŒøŒΩŒπŒ∫Œøœç œÑŒøœÖ Kontact
-Comment[es]=Extensi√≥n de Kontact para el diario de KOrganizer
-Comment[et]=Kontacti KOrganizeri p√§evikuplugin
-Comment[eu]=Kontact-en KOrganizer egunkari plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ŸÜÿ¥ÿ±€å€Ä Kontact KOrganizer
-Comment[fi]=P√§iv√§kirjaliit√§nn√§inen
-Comment[fr]=Module de journal KOrganizer pour Kontact
-Comment[fy]=Kontact KOrganizer Journaalplugin
-Comment[gl]=Extensi√≥n para Xornal no KOrganizer de Kontact
-Comment[hu]=Kontact-b≈ëv√≠t≈ëmodul a KOrganizer-napl√≥hoz
-Comment[is]=Kontact KOrganizer dagb√≥kar √≠forrit
-Comment[it]=Plugin Kontact per il diario di KOrganizer
-Comment[ja]=Kontact KOrganizer „Ç∏„É£„Éº„Éä„É´ „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KOrganizer –∫“Ø–Ω–¥–µ–ª—ñ–≥—ñ–Ω—ñ“£ –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûë·û∑·ûì·û∂·ûì·ûª·ûî·üí·ûî·ûú·ûè·üí·ûè·û∑ KOrganizer ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KOrganizer dienyno priedas
-Comment[ms]=Plugin Jurnal KOrganizer Kontact 
-Comment[nb]=Kontact programtillegg for KOrganizer dagbok
-Comment[nds]=KOrganizer-Daagbookmoduul f√∂r Kontact
-Comment[ne]=‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§ú‡§∞‡•ç‡§®‡§≤ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[nl]=Kontact KOrganizer Journaalplugin
-Comment[nn]=Kontact-programtillegg for KOrganizer-dagb√∏ker
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z dziennikiem KOrganizera
-Comment[pt]='Plugin' de Di√°rios do KOrganizer para o Kontact
-Comment[pt_BR]=Plug-in de Di√°rio do KOrganizer para o Kontact
-Comment[ru]=–ñ—É—Ä–Ω–∞–ª
-Comment[sk]=Modul Kontact KOrganizer ≈æurn√°lu
-Comment[sl]=Vstavek dnevnika KOrganizer za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KOrganizer Journal
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KOrganizer Journal
-Comment[sv]=Kontact-journalinsticksprogram f√∂r Korganizer
-Comment[ta]=‡Æï‡Øá‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tr]=Kontact KOrganizer G√ºnl√ºk Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –∂—É—Ä–Ω–∞–ª—É –¥–ª—è (KOrganizer) Kontact
-Comment[zh_CN]=Kontact KOrganizer Êó•ËÆ∞Êèí‰ª∂
-Comment[zh_TW]=Kontact KOrganizer Journal Â§ñÊéõÁ®ãÂºè
+Comment=Journal Component (KOrganizer Plugin)
 Name=Journal
 Name[af]=Joernaal
 Name[ar]=ÿßŸÑŸäŸàŸÖŸäÿ©
@@ -67,6 +25,7 @@
 Name[cs]=Den√≠k
 Name[cy]=Dyddlyfr
 Name[el]=ŒßœÅŒøŒΩŒπŒ∫œå
+Name[eo]=ƒ¥urnalo
 Name[es]=Diario
 Name[et]=P√§evik
 Name[eu]=Egunkaria
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_korganizerplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
@@ -16,60 +16,7 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KOrganizer Plugin
-Comment[af]=Kontact KOrganizer inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "K –ê—Ä–≥–∞–Ω—ñ–∑–∞—Ç–∞—Ä"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä –∏ –≤—Ä—ä–∑–∫–∞ —Å KOrganizer
-Comment[br]=Lugent Kontact KOrganizer
-Comment[bs]=Kontact KOrganizer dodatak
-Comment[ca]=Endollable KOrganizer per a Kontact
-Comment[cs]=Modul KOrganizeru pro aplikaci Kontact
-Comment[cy]=Ategyn KOrganizer Kontact 
-Comment[da]=Kontact KOrganizer-plugin
-Comment[de]=KOrganizer-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KOrganizer œÑŒøœÖ Kontact
-Comment[es]=Plugin de KOrganizer para Kontact
-Comment[et]=Kontacti KOrganizeri plugin
-Comment[eu]=Kontact-en KOrganizer plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact KOrganizer
-Comment[fi]=Kontactin KOrganizer-liit√§nn√§inen
-Comment[fr]=Module KOrganizer pour Kontact
-Comment[fy]=Kontact KOrganizer-plugin
-Comment[ga]=Breise√°n KOrganizer le haghaidh Kontact
-Comment[gl]=Extensi√≥n de KOrganizer para Kontact
-Comment[he]=◊™◊ï◊°◊£ KOrganizer ◊¢◊ë◊ï◊® Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§ï‡•á-‡§Ü‡§∞‡•ç‡§ó‡•á‡§®‡§æ‡§á‡§ú‡§º‡§∞ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact KOrganizer-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact KOrganizer √≠forrit
-Comment[it]=Plugin KOrganizer Kontact
-Comment[ja]=Kontact KOrganizer „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KOrganizer –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KOrganizer ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KOrganizer priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ö–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin KOragnizer Kontact 
-Comment[nb]=Kontact programtillegg for KOrganizer
-Comment[nds]=KOrganizer-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KOrganizer-plugin
-Comment[nn]=Kontact-programtillegg for KOrganizer
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KOrganizerem
-Comment[pt]='Plugin' do KOrganizer para o Kontact
-Comment[pt_BR]=Plug-in para KOrganizer do Kontact
-Comment[ro]=Modul KOrganizer pentru Kontact
-Comment[ru]=–ö–∞–ª–µ–Ω–¥–∞—Ä—å
-Comment[se]=Kontact, KOrganizer-lassemoduvla
-Comment[sl]=Vstavek KOrganizer za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KOrganizer
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KOrganizer
-Comment[sv]=Kontact-insticksprogram f√∂r Korganizer
-Comment[ta]=‡Æï‡Øá‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øà ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ –æ—Ä–≥–∞–Ω–∞–π–∑–µ—Ä
-Comment[tr]=Kontact KOrganizer Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è KOrganizer –¥–ª—è Kontact
-Comment[uz]=Kontact —É—á—É–Ω KOrganizer –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KOrganizer Êèí‰ª∂
-Comment[zh_TW]=Kontact KOrganizer Â§ñÊéõÁ®ãÂºè
+Comment=Calendar Component (KOrganizer Plugin)
 Name=Calendar
 Name[af]=Kalender
 Name[ar]=ÿßŸÑÿ™ŸÇŸàŸäŸÖ
@@ -82,6 +29,7 @@
 Name[da]=Kalender
 Name[de]=Kalender
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø
+Name[eo]=Kalendaro
 Name[es]=Calendario
 Name[et]=Kalender
 Name[eu]=Egutegia
Index: kontact/plugins/korganizer/todoplugin.cpp
===================================================================
--- kontact/plugins/korganizer/todoplugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/todoplugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 
 #include <qwidget.h>
 #include <qdragobject.h>
+#include <qfile.h>
 
 #include <kapplication.h>
 #include <kabc/vcardconverter.h>
@@ -33,9 +34,15 @@
 #include <kiconloader.h>
 #include <kmessagebox.h>
 #include <dcopclient.h>
+#include <dcopref.h>
+#include <ktempfile.h>
 
+#include <libkcal/calendarlocal.h>
+#include <libkcal/icaldrag.h>
+
 #include <libkdepim/maillistdrag.h>
 #include <libkdepim/kvcarddrag.h>
+#include <libkdepim/kpimprefs.h>
 
 #include "core.h"
 
@@ -58,6 +65,10 @@
                    CTRL+SHIFT+Key_T, this, SLOT( slotNewTodo() ), actionCollection(),
                    "new_todo" ) );
 
+  insertSyncAction( new KAction( i18n( "Synchronize To-do List" ), "reload",
+                   0, this, SLOT( slotSyncTodos() ), actionCollection(),
+                   "todo_sync" ) );
+
   mUniqueAppWatcher = new Kontact::UniqueAppWatcher(
       new Kontact::UniqueAppHandlerFactory<KOrganizerUniqueAppHandler>(), this );
 }
@@ -120,6 +131,12 @@
   interface()->openTodoEditor( "" );
 }
 
+void TodoPlugin::slotSyncTodos()
+{
+  DCOPRef ref( "kmail", "KMailICalIface" );
+  ref.send( "triggerSync", QString("Todo") );
+}
+
 bool TodoPlugin::createDCOPInterface( const QString& serviceType )
 {
   kdDebug(5602) << k_funcinfo << serviceType << endl;
@@ -165,6 +182,20 @@
     return;
   }
 
+  if ( KCal::ICalDrag::canDecode( event) ) {
+    KCal::CalendarLocal cal( KPimPrefs::timezone() );
+    if ( KCal::ICalDrag::decode( event, &cal ) ) {
+      KCal::Journal::List journals = cal.journals();
+      if ( !journals.isEmpty() ) {
+        event->accept();
+        KCal::Journal *j = journals.first();
+        interface()->openTodoEditor( i18n("Note: %1").arg( j->summary() ), j->description(), QString() );
+        return;
+      }
+      // else fall through to text decoding
+    }
+  }
+
   if ( QTextDrag::decode( event, text ) ) {
     interface()->openTodoEditor( text );
     return;
@@ -179,10 +210,15 @@
       KPIM::MailSummary mail = mails.first();
       QString txt = i18n("From: %1\nTo: %2\nSubject: %3").arg( mail.from() )
                     .arg( mail.to() ).arg( mail.subject() );
+
+      KTempFile tf;
+      tf.setAutoDelete( true );
       QString uri = "kmail:" + QString::number( mail.serialNumber() ) + "/" +
                     mail.messageId();
+      tf.file()->writeBlock( event->encodedData( "message/rfc822" ) );
+      tf.close();
       interface()->openTodoEditor( i18n("Mail: %1").arg( mail.subject() ), txt,
-                                   uri );
+                                   uri, tf.name(), QStringList(), "message/rfc822" );
     }
     return;
   }
Index: kontact/plugins/korganizer/todosummarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/todosummarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/todosummarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -60,7 +60,7 @@
 
   QPixmap icon = KGlobal::iconLoader()->loadIcon( "kontact_todo",
                    KIcon::Desktop, KIcon::SizeMedium );
-  QWidget *header = createHeader( this, icon, i18n( "To-dos" ) );
+  QWidget *header = createHeader( this, icon, i18n( "To-do" ) );
   mainLayout->addWidget( header );
 
   mLayout = new QGridLayout( mainLayout, 7, 4, 3 );
Index: kontact/plugins/korganizer/journalplugin.cpp
===================================================================
--- kontact/plugins/korganizer/journalplugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/journalplugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -31,12 +31,13 @@
 #include <kiconloader.h>
 #include <kmessagebox.h>
 #include <dcopclient.h>
+#include <dcopref.h>
 
 #include "core.h"
-
-#include "journalplugin.h"
+#include "journalplugin.h" 
 #include "korg_uniqueapp.h"
 
+
 typedef KGenericFactory< JournalPlugin, Kontact::Core > JournalPluginFactory;
 K_EXPORT_COMPONENT_FACTORY( libkontact_journalplugin,
                             JournalPluginFactory( "kontact_journalplugin" ) )
@@ -51,6 +52,9 @@
   insertNewAction( new KAction( i18n( "New Journal..." ), "newjournal",
                    CTRL+SHIFT+Key_J, this, SLOT( slotNewJournal() ), actionCollection(),
                    "new_journal" ) );
+  insertSyncAction( new KAction( i18n( "Synchronize Journal" ), "reload",
+                   0, this, SLOT( slotSyncJournal() ), actionCollection(),
+                   "journal_sync" ) );
 
 
   mUniqueAppWatcher = new Kontact::UniqueAppWatcher(
@@ -110,6 +114,12 @@
   interface()->openJournalEditor( "" );
 }
 
+void JournalPlugin::slotSyncJournal()
+{
+  DCOPRef ref( "kmail", "KMailICalIface" );
+  ref.send( "triggerSync", QString("Journal") );
+}
+
 bool JournalPlugin::createDCOPInterface( const QString& serviceType )
 {
   kdDebug(5602) << k_funcinfo << serviceType << endl;
Index: kontact/plugins/korganizer/todoplugin.h
===================================================================
--- kontact/plugins/korganizer/todoplugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/todoplugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,6 +58,7 @@
 
   private slots:
     void slotNewTodo();
+    void slotSyncTodos();
 
   private:
     KCalendarIface_stub *mIface;
Index: kontact/plugins/korganizer/korganizerplugin.cpp
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/korganizer/korganizerplugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,17 +22,21 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include <qcursor.h>
+#include <qfile.h>
 #include <qwidget.h>
 #include <qdragobject.h>
 
 #include <kapplication.h>
 #include <kabc/vcardconverter.h>
 #include <kaction.h>
+#include <dcopref.h>
 #include <kdebug.h>
 #include <kgenericfactory.h>
 #include <kiconloader.h>
 #include <kmessagebox.h>
 #include <kstandarddirs.h>
+#include <ktempfile.h>
 
 #include <dcopclient.h>
 
@@ -60,6 +64,10 @@
                    CTRL+SHIFT+Key_E, this, SLOT( slotNewEvent() ), actionCollection(),
                    "new_event" ) );
 
+  insertSyncAction( new KAction( i18n( "Synchronize Calendar" ), "reload",
+                   0, this, SLOT( slotSyncEvents() ), actionCollection(),
+                   "korganizer_sync" ) );
+
   mUniqueAppWatcher = new Kontact::UniqueAppWatcher(
       new Kontact::UniqueAppHandlerFactory<KOrganizerUniqueAppHandler>(), this );
 }
@@ -122,6 +130,12 @@
   interface()->openEventEditor( "" );
 }
 
+void KOrganizerPlugin::slotSyncEvents()
+{
+  DCOPRef ref( "kmail", "KMailICalIface" );
+  ref.send( "triggerSync", QString("Calendar") );
+}
+
 bool KOrganizerPlugin::createDCOPInterface( const QString& serviceType )
 {
   kdDebug(5602) << k_funcinfo << serviceType << endl;
@@ -182,9 +196,14 @@
       KPIM::MailSummary mail = mails.first();
       QString txt = i18n("From: %1\nTo: %2\nSubject: %3").arg( mail.from() )
                     .arg( mail.to() ).arg( mail.subject() );
-      QString uri = "kmail:" + QString::number( mail.serialNumber() );
+
+      KTempFile tf;
+      tf.setAutoDelete( true );
+      QString uri = QString::fromLatin1("kmail:") + QString::number( mail.serialNumber() );
+      tf.file()->writeBlock( event->encodedData( "message/rfc822" ) );
+      tf.close();
       interface()->openEventEditor( i18n("Mail: %1").arg( mail.subject() ), txt,
-                                    uri );
+                                    uri, tf.name(), QStringList(), "message/rfc822" );
     }
     return;
   }
@@ -193,4 +212,16 @@
                               .arg( event->format() ) );
 }
 
+void KOrganizerPlugin::loadProfile( const QString& directory )
+{
+  DCOPRef ref( "korganizer", "KOrganizerIface" );
+  ref.send( "loadProfile", directory );
+}
+
+void KOrganizerPlugin::saveToProfile( const QString& directory ) const
+{
+  DCOPRef ref( "korganizer", "KOrganizerIface" );
+  ref.send( "saveToProfile", directory );
+}
+
 #include "korganizerplugin.moc"
Index: kontact/plugins/kmail/kmail_plugin.h
===================================================================
--- kontact/plugins/kmail/kmail_plugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kmail/kmail_plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -59,6 +59,13 @@
 
     virtual QStringList invisibleToolbarActions() const;
     virtual bool queryClose() const;
+
+    //override
+    void loadProfile( const QString& profileDirectory );
+
+    //override
+    void saveToProfile( const QString& profileDirectory );
+
   protected:
     virtual KParts::ReadOnlyPart* createPart();
     void openComposer( const KURL& = KURL() );
@@ -69,6 +76,7 @@
 
   protected slots:
     void slotNewMail();
+    void slotSyncFolders();
 
   private:
     KMailIface_stub *mStub;
Index: kontact/plugins/kmail/summarywidget.cpp
===================================================================
--- kontact/plugins/kmail/summarywidget.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kmail/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,7 +50,7 @@
 
   QPixmap icon = KGlobal::iconLoader()->loadIcon( "kontact_mail", KIcon::Desktop,
                                                   KIcon::SizeMedium );
-  QWidget *header = createHeader(this, icon, i18n("New Messages"));
+  QWidget *header = createHeader(this, icon, i18n("E-Mail"));
   mLayout = new QGridLayout( 1, 3, 3 );
 
   mainLayout->addWidget(header);
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kmailplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPartLibraryName=libkmailpart
 X-KDE-KontactPartExecutableName=kmail
 X-KDE-KontactPartLoadOnStart=true
@@ -17,113 +17,5 @@
 X-KDE-PluginInfo-License=GPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact KMail Plugin
-Comment[af]=Kontact kMail inprop module
-Comment[be]=–î–∞–ø–∞—û–Ω–µ–Ω–Ω–µ –ö–∞–Ω—Ç–∞–∫—Ç—É "K –ü–æ—à—Ç–∞"
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –≤—Ä—ä–∑–∫–∞ –º–µ–∂–¥—É –ø–æ—â–∞—Ç–∞ –∏ –∞–¥—Ä–µ—Å–Ω–∏–∫–∞
-Comment[br]=Lugent Kontact KMail
-Comment[bs]=Kontact KMail dodatak
-Comment[ca]=Endollable KMail per a Kontact
-Comment[cs]=Modul KMailu pro aplikaci Kontact
-Comment[cy]=Ategyn KMail Kontact
-Comment[da]=Kontact KMail-plugin
-Comment[de]=KMail-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø KMail œÑŒøœÖ Kontact
-Comment[es]=Plugin de KMail para Kontact
-Comment[et]=Kontacti KMaili plugin
-Comment[eu]=Kontact-en KMail plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact KMail
-Comment[fi]=Kontactin KMail-liit√§nn√§inen
-Comment[fr]=Module KMail pour Kontact
-Comment[fy]=Kontact KMail-plugin
-Comment[ga]=Breise√°n KMail le haghaidh Kontact
-Comment[gl]=Extensi√≥n de KMail para Kontact
-Comment[he]=◊™◊ï◊°◊£ KMail ◊ú-Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§ï‡•á-‡§Æ‡•á‡§≤ ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact KMail-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact KMail √≠forrit
-Comment[it]=Plugin KMail Kontact
-Comment[ja]=Kontact KMail „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=KMail –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô KMail ·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact KMail priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ö–ü–æ—à—Ç–∞ –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin KMail Kontact 
-Comment[nb]=Kontact programtillegg for KMail
-Comment[nds]=KMail-Moduul f√∂r Kontact
-Comment[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§™‡§§‡•ç‡§∞ ‡§™‡•ç‡§≤‡§ó‡§á‡§® ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact KMail-plugin
-Comment[nn]=Kontact-programtillegg for KMail
-Comment[pl]=Wtyczka Kontact do wsp√≥≈Çpracy z KMail
-Comment[pt]='Plugin' do KMail para o Kontact
-Comment[pt_BR]=Plug-in para KMail do Kontact
-Comment[ro]=Modul KMail pentru Kontact
-Comment[ru]=–ü–æ—á—Ç–∞ KMail
-Comment[se]=Kontackt, KMail-lassemoduvla
-Comment[sl]=Vstavek KMaila za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ KMail
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za KMail
-Comment[sv]=Kontact-insticksprogram f√∂r Kmail
-Comment[ta]=‡Æï‡Øá‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ Kontact –±–∞—Ä–æ–∏ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞—Ä–æ–∏ KMail
-Comment[tr]=Kontact KMail Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—ó –ø–æ—à—Ç–∏ Kontact
-Comment[uz]=Kontact —É—á—É–Ω KMail –ø–ª–∞–≥–∏–Ω–∏
-Comment[zh_CN]=Kontact KMail Êèí‰ª∂
-Comment[zh_TW]=Kontact KMail Â§ñÊéõÁ®ãÂºè
-Name=Mail
-Name[af]=Pos
-Name[ar]=ÿßŸÑÿ®ÿ±ŸäÿØ
-Name[be]=–ü–æ—à—Ç–∞
-Name[br]=Lizher
-Name[ca]=Correu
-Name[cs]=Po≈°ta
-Name[cy]=Ebost
-Name[da]=Brev
-Name[de]=E-Mail
-Name[es]=Correo
-Name[et]=E-post
-Name[eu]=Posta
-Name[fa]=ŸÜÿßŸÖŸá
-Name[fi]=S√§hk√∂posti
-Name[fr]=Messages
-Name[fy]=E-post
-Name[ga]=R√≠omhphost
-Name[gl]=Correo-e
-Name[he]=◊ì◊ï◊ê"◊ú
-Name[hi]=‡§°‡§æ‡§ï
-Name[hr]=Po≈°ta
-Name[hu]=E-mail
-Name[is]=P√≥stur
-Name[it]=Posta
-Name[ja]=„É°„Éº„É´
-Name[kk]=–ü–æ—à—Ç–∞
-Name[km]=·ûü·üÜ·ûî·ûª·ûè·üí·ûö
-Name[lt]=Pa≈°tas
-Name[mk]=–ï-–ø–æ—à—Ç–∞
-Name[ms]=Mel
-Name[nb]=E-post
-Name[nds]=Nettpost
-Name[ne]=‡§™‡§§‡•ç‡§∞
-Name[nl]=E-mail
-Name[nn]=E-post
-Name[pa]=‡®™‡©±‡®§‡®∞
-Name[pl]=Poczta
-Name[pt]=E-mail
-Name[pt_BR]=Correio
-Name[ro]=E-Mail
-Name[ru]=–ü–æ—á—Ç–∞
-Name[se]=E-boasta
-Name[sk]=Po≈°ta
-Name[sl]=Po≈°ta
-Name[sr]=–ü–æ—à—Ç–∞
-Name[sr@Latn]=Po≈°ta
-Name[sv]=Brev
-Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
-Name[tg]=–ú–∞–∫—Ç—É–±
-Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
-Name[tr]=Posta
-Name[uk]=–ü–æ—à—Ç–∞
-Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
-Name[zh_CN]=ÈÇÆ‰ª∂
-Name[zh_TW]=ÈÉµ‰ª∂
+Comment=E-Mail Component (KMail Plugin)
+Name=E-Mail
Index: kontact/plugins/kmail/kmail_plugin.cpp
===================================================================
--- kontact/plugins/kmail/kmail_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kmail/kmail_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -65,6 +65,10 @@
                    CTRL+SHIFT+Key_M, this, SLOT( slotNewMail() ), actionCollection(),
                    "new_mail" ) );
 
+  insertSyncAction( new KAction( i18n( "Synchronize Mail" ), "reload",
+                   0, this, SLOT( slotSyncFolders() ), actionCollection(),
+                   "sync_mail" ) );
+
   mUniqueAppWatcher = new Kontact::UniqueAppWatcher(
       new Kontact::UniqueAppHandlerFactory<KMailUniqueAppHandler>(), this );
 }
@@ -124,6 +128,12 @@
   openComposer( QString::null );
 }
 
+void KMailPlugin::slotSyncFolders()
+{
+  DCOPRef ref( "kmail", "KMailIface" );
+  ref.send( "checkMail" );
+}
+
 KMailPlugin::~KMailPlugin()
 {
 }
@@ -198,4 +208,14 @@
   return canClose;
 }
 
+void KMailPlugin::loadProfile( const QString& profileDirectory ) {
+  DCOPRef ref( "kmail", "KMailIface" );
+  ref.send( "loadProfile", profileDirectory );
+}
+
+void KMailPlugin::saveToProfile( const QString& profileDirectory ) {
+  DCOPRef ref( "kmail", "KMailIface" );
+  ref.send( "saveToProfile", profileDirectory );
+}
+
 #include "kmail_plugin.moc"
Index: kontact/plugins/kmail/kcmkmailsummary.desktop
===================================================================
--- kontact/plugins/kmail/kcmkmailsummary.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/kmail/kcmkmailsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,112 +11,8 @@
 X-KDE-ParentComponents=kontact_kmailplugin
 X-KDE-CfgDlgHierarchy=KontactSummary
 
-Name=Mail
-Name[af]=Pos
-Name[ar]=ÿßŸÑÿ®ÿ±ŸäÿØ
-Name[be]=–ü–æ—à—Ç–∞
-Name[br]=Lizher
-Name[ca]=Correu
-Name[cs]=Po≈°ta
-Name[cy]=Ebost
-Name[da]=Brev
-Name[de]=E-Mail
-Name[es]=Correo
-Name[et]=E-post
-Name[eu]=Posta
-Name[fa]=ŸÜÿßŸÖŸá
-Name[fi]=S√§hk√∂posti
-Name[fr]=Messages
-Name[fy]=E-post
-Name[ga]=R√≠omhphost
-Name[gl]=Correo-e
-Name[he]=◊ì◊ï◊ê"◊ú
-Name[hi]=‡§°‡§æ‡§ï
-Name[hr]=Po≈°ta
-Name[hu]=E-mail
-Name[is]=P√≥stur
-Name[it]=Posta
-Name[ja]=„É°„Éº„É´
-Name[kk]=–ü–æ—à—Ç–∞
-Name[km]=·ûü·üÜ·ûî·ûª·ûè·üí·ûö
-Name[lt]=Pa≈°tas
-Name[mk]=–ï-–ø–æ—à—Ç–∞
-Name[ms]=Mel
-Name[nb]=E-post
-Name[nds]=Nettpost
-Name[ne]=‡§™‡§§‡•ç‡§∞
-Name[nl]=E-mail
-Name[nn]=E-post
-Name[pa]=‡®™‡©±‡®§‡®∞
-Name[pl]=Poczta
-Name[pt]=E-mail
-Name[pt_BR]=Correio
-Name[ro]=E-Mail
-Name[ru]=–ü–æ—á—Ç–∞
-Name[se]=E-boasta
-Name[sk]=Po≈°ta
-Name[sl]=Po≈°ta
-Name[sr]=–ü–æ—à—Ç–∞
-Name[sr@Latn]=Po≈°ta
-Name[sv]=Brev
-Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
-Name[tg]=–ú–∞–∫—Ç—É–±
-Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
-Name[tr]=Posta
-Name[uk]=–ü–æ—à—Ç–∞
-Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
-Name[zh_CN]=ÈÇÆ‰ª∂
-Name[zh_TW]=ÈÉµ‰ª∂
-Comment=Mail Summary Setup
-Comment[af]=Pos opsomming opstelling
-Comment[ar]=ÿ™ÿπŸäŸäŸÜ ŸÖŸÑÿÆÿµ ÿßŸÑÿ®ÿ±ŸäÿØ
-Comment[bg]=–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –æ–±–æ–±—â–µ–Ω–∏–µ—Ç–æ –Ω–∞ –ø–∏—Å–º–∞—Ç–∞
-Comment[bs]=Postavke mail sa≈æetka
-Comment[ca]=Configuraci√≥ del resum de correu
-Comment[cs]=Nastaven√≠ souhrnu po≈°ty
-Comment[da]=Ops√¶tning af post-opsummering
-Comment[de]=Mail√ºbersicht-Einstellungen
-Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œÉœçŒΩŒøœàŒ∑œÇ Œ±ŒªŒªŒ∑ŒªŒøŒ≥œÅŒ±œÜŒØŒ±œÇ
-Comment[es]=Configuraci√≥n del resumen de correo
-Comment[et]=E-posti kokkuv√µtte seadistus
-Comment[eu]=Postaren laburpenaren konfigurazioa
-Comment[fa]=ÿ®ÿ±Ÿæÿß€å€å ÿÆŸÑÿßÿµ€Ä ŸÜÿßŸÖŸá
-Comment[fi]=S√§hk√∂postiyhteenvedon asetukset
-Comment[fr]=Configuration du r√©sum√© du courrier
-Comment[fy]=E-post oersichts-ynstellings
-Comment[gl]=Configuraci√≥n do Resumo de Correo-e
-Comment[he]=◊î◊í◊ì◊®◊ï◊™ ◊™◊ß◊¶◊ô◊® ◊ì◊ï◊ê"◊ú
-Comment[hu]=A levelek √°ttekint√©s√©nek be√°ll√≠t√°sai
-Comment[is]=Uppsetning p√≥styfirlits
-Comment[it]=Impostazioni sommario posta
-Comment[ja]=„É°„Éº„É´Ë¶ÅÁ¥Ñ„ÅÆË®≠ÂÆö
-Comment[kk]=–ü–æ—à—Ç–∞ —Ç“±–∂—ã—Ä—ã–º—ã–Ω—ã“£ –±–∞–ø—Ç–∞—É
-Comment[km]=·ûö·üÄ·ûî·ûÖ·üÜ‚Äã·ûü·üÅ·ûÖ·ûÄ·üí·ûä·û∏‚Äã·ûü·ûÑ·üí·ûÅ·üÅ·ûî‚Äã·ûü·üÜ·ûî·ûª·ûè·üí·ûö
-Comment[lt]=Pa≈°to santraukos nustatymai
-Comment[mk]=–ü–æ—Å—Ç–∞–≤—É–≤–∞—ö–µ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥ –∑–∞ –µ-–ø–æ—à—Ç–∞
-Comment[ms]=Setup Ringkasan Mel 
-Comment[nb]=E-post sammendrag oppsett
-Comment[nds]=Nettpost-√ñversicht instellen
-Comment[ne]=‡§™‡§§‡•ç‡§∞ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∏‡•á‡§ü‡§Ö‡§™
-Comment[nl]=E-mail Overzichts-instellingen
-Comment[nn]=Oppsett av e-postsamandrag
-Comment[pl]=Ustawienia podsumowania poczty
-Comment[pt]=Configura√ß√£o do Sum√°rio de E-mail
-Comment[pt_BR]=Configura√ß√£o de Resumo de E-mail
-Comment[ru]=–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞–π–¥–∂–µ—Å—Ç–∞ –ø–æ—á—Ç—ã
-Comment[se]=Heivet e-boastaƒçoahkk√°igeasu
-Comment[sk]=Nastavenie s√∫hrnu po≈°ty
-Comment[sl]=Nastavitve povzetka po≈°te
-Comment[sr]=–ü–æ–¥–µ—à–∞–≤–∞—ö–µ —Å–∞–∂–µ—Ç–∫–∞ –ø–æ—à—Ç–µ
-Comment[sr@Latn]=Pode≈°avanje sa≈æetka po≈°te
-Comment[sv]=Inst√§llning av post√∂versikt
-Comment[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ
-Comment[tg]=–¢–∞–Ω–∑–∏–º–æ—Ç–∏ –¥–∞–π–¥–∂–µ—Å—Ç–∏ –ø–æ—á—Ç–∞
-Comment[th]=‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
-Comment[tr]=E-posta √ñzeti Yapƒ±landƒ±rmasƒ±
-Comment[uk]=–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—É –ø–æ—à—Ç–∏
-Comment[zh_CN]=ÈÇÆ‰ª∂ÊëòË¶ÅËÆæÁΩÆ
-Comment[zh_TW]=ÈÉµ‰ª∂ÊëòË¶ÅË®≠ÂÆö
+Name=E-Mail Overview
+Comment=E-Mail Summary Setup
 Keywords=email, summary, configure, settings
 Keywords[af]=email,summary,configure,settings
 Keywords[bg]=—Ä–µ–∑—é–º–µ, –æ–±—â–æ, –æ–±–æ–±—â–µ–Ω–∏–µ, –ø–æ—â–µ–Ω—Å–∫–∏, –∫–ª–∏–µ–Ω—Ç, –µ-–ø–æ—â–∞, email, summary, configure, settings
Index: kontact/plugins/summary/summaryview_part.cpp
===================================================================
--- kontact/plugins/summary/summaryview_part.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/summaryview_part.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -93,11 +93,6 @@
                                SLOT( slotConfigure() ), actionCollection(),
                                "summaryview_configure" );
 
-  mRefreshAction = new KAction( i18n( "&Refresh Summary View..." ),
-                                "reload", 0, this,
-                                SLOT( updateSummaries() ), actionCollection(),
-                                "summaryview_refresh" );
-
   setXMLFile( "kontactsummary_part.rc" );
 
   QTimer::singleShot( 0, this, SLOT( slotTextChanged() ) );
Index: kontact/plugins/summary/kcmkontactsummary.desktop
===================================================================
--- kontact/plugins/summary/kcmkontactsummary.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/kcmkontactsummary.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,55 +11,7 @@
 X-KDE-ParentComponents=kontact_summaryplugin
 X-KDE-CfgDlgHierarchy=KontactSummary
 
-Name=Components
-Name[af]=Komponente
-Name[ar]=ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™
-Name[be]=–ö–∞–º–ø–∞–Ω—ç–Ω—Ç—ã
-Name[br]=Parzhio√π
-Name[cs]=Komponenty
-Name[cy]=Cydrannau
-Name[da]=Komponenter
-Name[de]=Komponenten
-Name[el]=Œ£œÑŒøŒπœáŒµŒØŒ±
-Name[et]=Komponendid
-Name[eu]=Osagaiak
-Name[fa]=ŸÖÿ≠ÿ™Ÿà€åÿßÿ™
-Name[fi]=Komponentit
-Name[fr]=Composants
-Name[fy]=Komponinten
-Name[ga]=Comhph√°irteanna
-Name[gl]=Compo√±entes
-Name[he]=◊®◊õ◊ô◊ë◊ô◊ù
-Name[hu]=Komponensek
-Name[is]=Einingar
-Name[it]=Componenti
-Name[ja]=„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
-Name[kk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—Ç–µ—Ä—ñ
-Name[km]=·ûü·ûò·û∂·ûü·ûó·û∂·ûÇ
-Name[lt]=Komponentai
-Name[mk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
-Name[ms]=Komponen
-Name[nb]=Komponenter
-Name[nds]=Komponenten
-Name[ne]=‡§Ö‡§µ‡§Ø‡§µ
-Name[nl]=Componenten
-Name[nn]=Komponentar
-Name[pl]=Sk≈Çadniki
-Name[pt]=Componentes
-Name[pt_BR]=Componentes
-Name[ru]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
-Name[sk]=Komponenty
-Name[sl]=Komponente
-Name[sr]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
-Name[sr@Latn]=Komponente
-Name[sv]=Komponenter
-Name[ta]=‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øç
-Name[th]=‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
-Name[tr]=Bile≈üenler
-Name[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
-Name[uz]=“ö–∏—Å–º–ª–∞—Ä
-Name[zh_CN]=ÁªÑ‰ª∂
-Name[zh_TW]=ÂÖÉ‰ª∂
+Name=Summary View Items
 Comment=General Configuration of Kontact's Summary View
 Comment[af]=Algemene opstelling van Kontact se opsomming aansig
 Comment[bg]=–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –æ–±–æ–±—â–µ–Ω–∏–µ—Ç–æ
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -5,62 +5,14 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_summaryplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 
 X-KDE-PluginInfo-Name=kontact_summaryplugin
 X-KDE-PluginInfo-Version=0.1
 X-KDE-PluginInfo-License=LGPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact SummaryView Plugin
-Comment[af]=Kontact opsomming aansig inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –æ–±–æ–±—â–µ–Ω –ø—Ä–µ–≥–ª–µ–¥
-Comment[bs]=Kontact dodatak za Sa≈æetak
-Comment[ca]=Endollable de la vista resum per a Kontact
-Comment[cs]=Modul souhrnu pro aplikaci Kontact
-Comment[cy]=Ategyn Golwg Grynodeb Kontact
-Comment[da]=Kontact SummaryView-plugin
-Comment[de]=√úbersichts-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÄœÅŒøŒ≤ŒøŒªŒÆœÇ Œ£œçŒΩŒøœàŒ∑œÇ œÑŒøœÖ Kontact
-Comment[es]=Accesorio Vista resumen para Kontact
-Comment[et]=Kontakti kokkuv√µttevaate plugin
-Comment[eu]=Kontact-en SummaryView plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä ŸÜŸÖÿß€å ÿÆŸÑÿßÿµ€Ä Kontact
-Comment[fi]=Kontactin yhteenveton√§kym√§n liit√§nn√§inen
-Comment[fr]=Module de vue r√©sum√©e pour Kontact
-Comment[fy]=Kontact SummaryView-plugin
-Comment[gl]=Extensi√≥n de VistaResumo para Kontact
-Comment[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂-‡§µ‡•ç‡§Ø‡•Ç ‡§™‡•ç‡§≤‡§ó‡§á‡§®
-Comment[hu]=Kontact b≈ëv√≠t≈ëmodul a n√©vjegyek √°ttekint√©s√©hez
-Comment[is]=Kontact yfirlitss√Ωnar √≠forrit
-Comment[it]=Plugin SummaryView Kontact
-Comment[ja]=Kontact „Çµ„Éû„É™„Éì„É•„Éº„Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=–¢“±–∂—ã—Ä—ã–º–¥–∞–º–∞ –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûë·û∑·ûä·üí·ûã·ûó·û∂·ûñ‚Äã·ûü·ûÑ·üí·ûÅ·üÅ·ûî‚Äã·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact Santraukos vaizdo priedas
-Comment[mk]=–ü—Ä–∏–∫–ª—É—á–æ–∫ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ –≤–æ –ö–æ–Ω—Ç–∞–∫—Ç
-Comment[ms]=Plugin Paparan Ringkasan Kontact 
-Comment[nb]=Kontact programtillegg for sammendragsvisning
-Comment[nds]=√ñversichtansicht-Moduul f√∂r Kontact
-Comment[ne]=‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡§Æ‡§æ ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact SummaryView-plugin
-Comment[nn]=Kontact, programtillegg for samandragsvising
-Comment[pl]=Wtyczka Kontact do wy≈õwietlania podsumowania
-Comment[pt]='Plugin' do SummaryView do Kontact
-Comment[pt_BR]=Plug-in SummaryView do Kontact
-Comment[ru]=–î–∞–π–¥–∂–µ—Å—Ç Kontact
-Comment[se]=Kontact, ƒçoahkk√°igeassoƒç√°jeheami lassemoduvla
-Comment[sk]=Modul s√∫hrnu pre Kontact
-Comment[sl]=Vstavek povzetega pogleda za Kontact
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ Kontact-–∞ –∑–∞ –ø—Ä–∏–∫–∞–∑ —Å–∞–∂–µ—Ç–∫–∞
-Comment[sr@Latn]=Prikljuƒçak Kontact-a za prikaz sa≈æetka
-Comment[sv]=Kontact-insticksprogram f√∂r √∂versikt
-Comment[ta]=‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æï‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æö‡Æø ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–ú–æ–¥—É–ª–∏ –¥–∞–π–¥–∂–µ—Å—Ç–∏ Kontact
-Comment[tr]=Kontact √ñzet G√∂sterim Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ Kontact –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–≤–µ–¥–µ–Ω—å
-Comment[zh_CN]=Kontact Ê¶ÇËßàËßÜÂõæÊèí‰ª∂
-Comment[zh_TW]=Kontact ÊëòË¶ÅÊ™¢Ë¶ñÂ§ñÊéõÁ®ãÂºè
+Comment=Summary View Component
 Name=Summary
 Name[af]=Opsomming
 Name[ar]=ÿßŸÑŸÖŸàÿ¨ÿ≤
@@ -72,6 +24,7 @@
 Name[da]=Opsummering
 Name[de]=√úbersicht
 Name[el]=Œ£œçŒΩŒøœàŒ∑
+Name[eo]=Resumo
 Name[es]=Resumen
 Name[et]=Kokkuv√µte
 Name[eu]=Laburpena
Index: kontact/plugins/summary/summaryview_part.h
===================================================================
--- kontact/plugins/summary/summaryview_part.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/summaryview_part.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -63,6 +63,7 @@
     void slotTextChanged();
     void slotAdjustPalette();
     void setDate( const QDate& newDate );
+    void updateSummaries();
 
   signals:
     void textChanged( const QString& );
@@ -73,7 +74,6 @@
 
   protected slots:
     void slotConfigure();
-    void updateSummaries();
     void updateWidgets();
     void summaryWidgetMoved( QWidget *target, QWidget *widget, int alignment );
 
@@ -95,7 +95,6 @@
     QLabel *mUsernameLabel;
     QLabel *mDateLabel;
     KAction *mConfigAction;
-    KAction *mRefreshAction;
 
     QStringList mLeftColumnSummaries;
     QStringList mRightColumnSummaries;
Index: kontact/plugins/summary/summaryview_plugin.cpp
===================================================================
--- kontact/plugins/summary/summaryview_plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/summaryview_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 /* This file is part of the KDE project
-   Copyright (C) 2003 Sven L¸ppken <sven@kde.org>
+   Copyright (C) 2003 Sven LÔøΩppken <sven@kde.org>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -17,34 +17,90 @@
    Boston, MA 02110-1301, USA.
  */
 
+#include "summaryview_plugin.h"
+#include "core.h"
+#include "summaryview_part.h"
+
+#include <dcopref.h>
 #include <kgenericfactory.h>
 #include <kparts/componentfactory.h>
 #include <kaboutdata.h>
+#include <kaction.h>
 
-#include "core.h"
-#include "summaryview_part.h"
+#include <qpopupmenu.h>
 
-#include "summaryview_plugin.h"
-
 typedef KGenericFactory< SummaryView, Kontact::Core > SummaryViewFactory;
 K_EXPORT_COMPONENT_FACTORY( libkontact_summaryplugin,
                             SummaryViewFactory( "kontact_summaryplugin" ) )
 
 SummaryView::SummaryView( Kontact::Core *core, const char *name, const QStringList& )
   : Kontact::Plugin( core, core, name),
-    mAboutData( 0 )
+    mAboutData( 0 ), mPart( 0 )
 {
   setInstance( SummaryViewFactory::instance() );
+
+  mSyncAction = new KSelectAction( i18n( "Synchronize All" ), "reload", 0, this,
+                                   SLOT( doSync() ), actionCollection(),
+                                   "kontact_summary_sync" );
+  connect( mSyncAction, SIGNAL( activated( const QString& ) ), this, SLOT( syncAccount( const QString& ) ) );
+  connect( mSyncAction->popupMenu(), SIGNAL( aboutToShow() ), this, SLOT( fillSyncActionSubEntries() ) );
+
+  insertSyncAction( mSyncAction );
+  fillSyncActionSubEntries();
 }
 
+void SummaryView::fillSyncActionSubEntries()
+{
+  QStringList menuItems;
+  menuItems.append( i18n("All") );
+
+  DCOPRef ref( "kmail", "KMailIface" );
+  DCOPReply reply = ref.call( "accounts" );
+
+  if ( reply.isValid() )
+  {
+    const QStringList accounts = reply;
+    menuItems += accounts;
+  }
+  mSyncAction->clear();
+  mSyncAction->setItems( menuItems );
+}
+
+void SummaryView::syncAccount( const QString& account )
+{
+  const QString acc = account == i18n("All") ? QString() : account;
+  DCOPRef ref( "kmail", "KMailIface" );
+  ref.send( "checkAccount", acc );
+  fillSyncActionSubEntries();
+}
+
 SummaryView::~SummaryView()
 {
 }
 
+void SummaryView::doSync()
+{
+  if ( mPart )
+    mPart->updateSummaries();
+
+  const QValueList<Kontact::Plugin*> pluginList = core()->pluginList();
+  for ( QValueList<Kontact::Plugin*>::ConstIterator it = pluginList.begin(), end = pluginList.end();
+        it != end; ++it ) {
+    // execute all sync actions but our own
+    QPtrList<KAction> *actions = (*it)->syncActions();
+    for ( QPtrList<KAction>::Iterator jt = actions->begin(), end = actions->end(); jt != end; ++jt ) {
+      if ( *jt != mSyncAction )
+        (*jt)->activate();
+    }
+  }
+  fillSyncActionSubEntries();
+}
+
 KParts::ReadOnlyPart *SummaryView::createPart()
 {
-  return new SummaryViewPart( core(), "summarypartframe", aboutData(),
-                              this, "summarypart" );
+  mPart = new SummaryViewPart( core(), "summarypartframe", aboutData(),
+                               this, "summarypart" );
+  return mPart;
 }
 
 const KAboutData *SummaryView::aboutData()
Index: kontact/plugins/summary/kontactsummary_part.rc
===================================================================
--- kontact/plugins/summary/kontactsummary_part.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/kontactsummary_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,15 +1,9 @@
 <?xml version="1.0"?>
 <!DOCTYPE gui>
-<gui name="kontactsummary" version="2">
+<gui name="kontactsummary" version="3">
   <MenuBar>
     <Menu name="settings"><text>&amp;Settings</text>
       <Action name="summaryview_configure" group="settings_configure"/>
     </Menu>
   </MenuBar>
-
-  <ToolBar position="Top" noMerge="1" name="mainToolBar"><text>Main Toolbar</text>
-    <Separator/>
-    <Action name="summaryview_refresh"/>
-    <Separator/>
-  </ToolBar>
 </gui>
Index: kontact/plugins/summary/summaryview_plugin.h
===================================================================
--- kontact/plugins/summary/summaryview_plugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/summary/summaryview_plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,7 @@
 /*
    This file is part of KDE Kontact.
 
-   Copyright (C) 2003 Sven L¸ppken <sven@kde.org>
+   Copyright (C) 2003 Sven LÔøΩppken <sven@kde.org>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -21,12 +21,17 @@
 
 #ifndef SUMMARYVIEW_PLUGIN_H
 #define SUMMARYVIEW_PLUGIN_H
+#include "plugin.h"
 
 #include <klocale.h>
 #include <kparts/part.h>
 
-#include "plugin.h"
+#include <qmap.h>
 
+class KSelectAction;
+
+class SummaryViewPart;
+
 class SummaryView : public Kontact::Plugin
 {
   Q_OBJECT
@@ -42,8 +47,16 @@
   protected:
     virtual KParts::ReadOnlyPart* createPart();
 
+  private slots:
+
+    void doSync();
+    void syncAccount( const QString& account );
+    void fillSyncActionSubEntries();
+
   private:
     KAboutData *mAboutData;
+    SummaryViewPart *mPart;
+    KSelectAction *mSyncAction; 
 };
 
 #endif
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -6,7 +6,7 @@
 TryExec=rssservice
 
 X-KDE-Library=libkontact_newstickerplugin
-X-KDE-KontactPluginVersion=5
+X-KDE-KontactPluginVersion=6
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
@@ -15,84 +15,61 @@
 X-KDE-PluginInfo-License=LGPL
 X-KDE-PluginInfo-EnabledByDefault=true
 
-Comment=Kontact NewsTicker Plugin
-Comment[af]=Kontact nuus tikker inprop module
-Comment[bg]=–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ –∑–∞ –Ω–æ–≤–∏–Ω–∏
-Comment[bs]=Kontact NewsTicker dodatak
-Comment[ca]=Endollable del teletip de noticies per a Kontact
-Comment[cs]=Modul NewsTicker pro aplikaci Kontact
-Comment[da]=Kontact plugin for nyhedstelegraf
-Comment[de]=Newsticker-Modul f√ºr Kontact
-Comment[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÄœÅŒøŒ≤ŒøŒªŒ≠Œ± ŒµŒπŒ¥ŒÆœÉŒµœâŒΩ œÑŒøœÖ Kontact
-Comment[es]=Extensi√≥n de teletipo de noticias para Kontact
-Comment[et]=Kontacti uudistej√§lgija plugin
-Comment[eu]=Kontact-en NewsTicker plugin-a
-Comment[fa]=ŸàÿµŸÑ€Ä Kontact NewsTicker
-Comment[fi]=Kontactin uutisn√§ytin
-Comment[fr]=Module NewsTicker pour Kontact
-Comment[fy]=Kontact NewsTicker-plugin
-Comment[ga]=Breise√°n NewsTicker le haghaidh Kontact
-Comment[gl]=Extensi√≥n de NewsTicker para Kontact
-Comment[he]=◊™◊ï◊°◊£ ◊ó◊ì◊©◊ï◊™ ◊®◊¶◊ï◊™ ◊¢◊ë◊ï◊® Kontact
-Comment[hu]=Kontact KNewsTicker-b≈ëv√≠t≈ëmodul
-Comment[is]=Kontact fr√©ttastrimils-√≠forrit
-Comment[it]=Plugin Kontact Ticker Notizie
-Comment[ja]=Kontact „Éã„É•„Éº„Çπ„ÉÜ„Ç£„ÉÉ„Ç´„Éº „Éó„É©„Ç∞„Ç§„É≥
-Comment[kk]=NewsTicker –º–æ–¥—É–ª—ñ
-Comment[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûë·ûë·ûΩ·ûõ‚Äã·ûñ·üê·ûè·üå·ûò·û∂·ûì‚Äã·ûÄ·üí·ûì·ûª·ûÑ Kontact
-Comment[lt]=Kontact Naujien≈≥ prane≈°ƒójo priedas
-Comment[ms]=Plugin Pengetik Berita Kontact 
-Comment[nb]=Kontact programtillegg for nyhetstelegrafen
-Comment[nds]=Narichtentelegraaf-Moduul f√ºr Kontact
-Comment[ne]=‡§®‡•ç‡§Ø‡•Ç‡§ú ‡§ü‡§ø‡§ï‡§∞ ‡§™‡•ç‡§≤‡§ó‡§á‡§®‡§Æ‡§æ ‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
-Comment[nl]=Kontact NewsTicker-plugin
-Comment[nn]=Programtillegg for nyhendetelegraf i Kontact
-Comment[pl]=Wtyczka wiadomo≈õci do Kontact
-Comment[pt]='Plugin' do Not√≠cias para o Kontact
-Comment[pt_BR]=Plug-in para Kontact do Mostrador de Not√≠cias
-Comment[ru]=–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
-Comment[sk]=Modul spr√°v pre Kontact
-Comment[sl]=Vstavek za prikazovanje novic v Kontactu
-Comment[sr]=–ü—Ä–∏–∫—ô—É—á–∞–∫ News Ticker-–∞ –∑–∞ Kontact
-Comment[sr@Latn]=Prikljuƒçak News Ticker-a za Kontact
-Comment[sv]=Kontact insticksprogram f√∂r Nyhets√∂vervakaren
-Comment[ta]= ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æü‡Æø‡Æï‡Øç‡Æï‡Æ∞‡Øç ‡Æö‡Øä‡Æ∞‡ØÅ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ‡Æï‡Øä‡Æ≥‡Øç
-Comment[tg]=–¢–∞–º–æ—Å –≥–∏—Ä–∏—Ñ—Ç–∞–Ω –±–æ NewsTicker Plugin
-Comment[tr]=Kontact Haberƒ∞zleyici Eklentisi
-Comment[uk]=–í—Ç—É–ª–æ–∫ —Å—Ç—Ä—ñ—á–∫–∏ –Ω–æ–≤–∏–Ω Kontact
-Comment[zh_CN]=Kontact Êñ∞ÈóªÁÇπÁÇπÈÄöÊèí‰ª∂
-Comment[zh_TW]=Kontact NewsTicker Â§ñÊéõÁ®ãÂºè
-Name=NewsTicker
-Name[af]=Nuus tikker
-Name[ca]=Teletip de not√≠cies
-Name[da]=Nyhedstelegraf
-Name[de]=Newsticker
-Name[el]=Œ†œÅŒøŒ≤ŒøŒªŒ≠Œ±œÇ ŒµŒπŒ¥ŒÆœÉŒµœâŒΩ
-Name[es]=Teletipo de noticias
-Name[et]=Uudistej√§lgija
-Name[fa]=Ticker ÿßÿÆÿ®ÿßÿ±
-Name[fi]=Uutisn√§ytin
-Name[fr]=T√©l√©scripteur de nouvelles
-Name[fy]=Nijstikker
-Name[he]=◊ó◊ì◊©◊ï◊™ ◊®◊¶◊ï◊™
-Name[hu]=RSS h√≠rmegjelen√≠t≈ë
-Name[is]=Fr√©ttastrimill
-Name[it]=Ticker notizie
-Name[ja]=„Éã„É•„Éº„Çπ„ÉÜ„Ç£„ÉÉ„Ç´„Éº
-Name[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûë·ûë·ûΩ·ûõ‚Äã·ûñ·üê·ûè·üå·ûò·û∂·ûì
-Name[lt]=Naujien≈≥ prane≈°ƒójas
-Name[ms]=Pengetik Berita
-Name[nb]=Nyhetstelegraf
-Name[nds]=Narichtentelegraaf
-Name[ne]=‡§®‡•ç‡§Ø‡•Ç‡§ú ‡§ü‡§ø‡§ï‡§∞
-Name[nn]=Nyhendetelegraf
-Name[pl]=Wiadomo≈õci
+Comment=Newsticker Component
+Name=News
+Name[af]=Nuus
+Name[ar]=ÿßŸÑÿ£ÿÆÿ®ÿßÿ±
+Name[be]=–ù–∞–≤—ñ–Ω—ã
+Name[br]=Keleier
+Name[bs]=Usenet
+Name[ca]=Not√≠cies
+Name[cs]=Novinky
+Name[cy]=Newyddion
+Name[da]=Nyheder
+Name[de]=Usenet
+Name[el]=ŒùŒ≠Œ±
+Name[eo]=Novaƒµoj
+Name[es]=Noticias
+Name[et]=Uudisegrupid
+Name[eu]=Berriak
+Name[fa]=ÿßÿÆÿ®ÿßÿ±
+Name[fi]=Uutiset
+Name[fr]=Nouvelles
+Name[fy]=Nijs
+Name[ga]=Nuacht
+Name[gl]=Novas
+Name[he]=◊ó◊ì◊©◊ï◊™
+Name[hi]=‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞
+Name[hu]=H√≠rek
+Name[is]=Fr√©ttir
+Name[ja]=„Éã„É•„Éº„Çπ
+Name[kk]=–ñ–∞“£–∞–ª—ã“õ—Ç–∞—Ä
+Name[km]=·ûñ·üê·ûè·üå·ûò·û∂·ûì
+Name[lt]=Naujienos
+Name[mk]=–í–µ—Å—Ç–∏
+Name[ms]=Berita
+Name[nb]=Njus
+Name[nds]=Narichten
+Name[ne]=‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞
+Name[nl]=Nieuws
+Name[nn]=Nyheiter
+Name[pa]=‡®ñ‡®º‡®¨‡®∞‡®æ‡®Ç
+Name[pl]=Listy dyskusyjne
 Name[pt]=Not√≠cias
-Name[ru]=–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
-Name[sk]=Spr√°vy
-Name[sl]=Prikazovalnik novic
-Name[sv]=Nyhets√∂vervakare
-Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Øç
-Name[th]=‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡πà‡∏≤‡∏ß
-Name[tr]=Haberƒ∞zleyici
-Name[zh_CN]=Êñ∞ÈóªÁÇπÁÇπÈÄö
+Name[pt_BR]=Not√≠cias
+Name[ro]=≈ûtiri
+Name[ru]=–ù–æ–≤–æ—Å—Ç–∏
+Name[se]=Oƒëƒëasat
+Name[sk]=Diskusn√© skupiny
+Name[sl]=Novice
+Name[sr]=–í–µ—Å—Ç–∏
+Name[sr@Latn]=Vesti
+Name[sv]=Nyheter
+Name[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç
+Name[tg]=–ê—Ö–±–æ—Ä–æ—Ç
+Name[th]=‡∏Ç‡πà‡∏≤‡∏ß
+Name[tr]=Haberler
+Name[uk]=–ù–æ–≤–∏–Ω–∏
+Name[uz]=–Ø–Ω–≥–∏–ª–∏–∫–ª–∞—Ä
+Name[zh_CN]=Êñ∞Èóª
+Name[zh_TW]=Êñ∞ËÅû
Index: kontact/interfaces/plugin.cpp
===================================================================
--- kontact/interfaces/plugin.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/interfaces/plugin.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,6 +41,7 @@
     Kontact::Core *core;
     DCOPClient *dcopClient;
     QPtrList<KAction> *newActions;
+    QPtrList<KAction> *syncActions;
     QString identifier;
     QString title;
     QString icon;
@@ -48,6 +49,7 @@
     QCString partLibraryName;
     bool hasPart;
     KParts::ReadOnlyPart *part;
+    bool disabled;
 };
 
 
@@ -60,8 +62,10 @@
   d->core = core;
   d->dcopClient = 0;
   d->newActions = new QPtrList<KAction>;
+  d->syncActions = new QPtrList<KAction>;
   d->hasPart = true;
   d->part = 0;
+  d->disabled = false;
 }
 
 
@@ -174,11 +178,21 @@
   d->newActions->append( action );
 }
 
+void Plugin::insertSyncAction( KAction *action )
+{
+  d->syncActions->append( action );
+}
+
 QPtrList<KAction> *Plugin::newActions() const
 {
   return d->newActions;
 }
 
+QPtrList<KAction> *Plugin::syncActions() const
+{
+  return d->syncActions;
+}
+
 Kontact::Core *Plugin::core() const
 {
   return d->core;
@@ -218,6 +232,24 @@
   d->hasPart = hasPart;
 }
 
+void Kontact::Plugin::setDisabled( bool disabled )
+{
+    d->disabled = disabled;
+}
+
+bool Kontact::Plugin::disabled() const
+{
+    return d->disabled;
+}
+
+void Kontact::Plugin::loadProfile( const QString& )
+{
+}
+
+void Kontact::Plugin::saveToProfile( const QString& ) const
+{
+}
+
 void Plugin::virtual_hook( int, void* ) {
 	//BASE::virtual_hook( id, data );
 }
Index: kontact/interfaces/plugin.h
===================================================================
--- kontact/interfaces/plugin.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/interfaces/plugin.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -42,7 +42,7 @@
   Increase this version number whenever you make a change
   in the API.
  */
-#define KONTACT_PLUGIN_VERSION 5
+#define KONTACT_PLUGIN_VERSION 6
 
 namespace Kontact
 {
@@ -213,11 +213,21 @@
     void insertNewAction( KAction *action );
 
     /**
+      Insert "Sync" action.
+    */
+    void insertSyncAction( KAction *action );
+
+    /**
       FIXME: write API doc for Kontact::Plugin::newActions().
     */
     QPtrList<KAction>* newActions() const;
 
     /**
+      FIXME: write API doc for Kontact::Plugin::syncActions().
+    */
+    QPtrList<KAction>* syncActions() const;
+
+    /**
       Returns a list of action name which shall be hidden in the main toolbar.
      */
     virtual QStringList invisibleToolbarActions() const { return QStringList(); }
@@ -232,6 +242,10 @@
     */
     virtual void processDropEvent( QDropEvent * ) {}
 
+    virtual void loadProfile( const QString& directoryPath );
+
+    virtual void saveToProfile( const QString& directoryPath ) const;
+
     /**
      * Session management: read properties
      */
@@ -244,6 +258,9 @@
 
     Core *core() const;
 
+    bool disabled() const;
+    void setDisabled( bool v );
+
   public slots:
     /**
       internal usage
Index: kontact/profiles/OutlookDefaults/korganizerrc
===================================================================
--- kontact/profiles/OutlookDefaults/korganizerrc	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/OutlookDefaults/korganizerrc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,3 @@
+[Views]
+Agenda View Calendar Display=CalendarsSideBySide
+
Index: kontact/profiles/OutlookDefaults/kontactrc
===================================================================
--- kontact/profiles/OutlookDefaults/kontactrc	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/OutlookDefaults/kontactrc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,33 @@
+[General]
+activeBackground=47,103,255
+activeBlend=41,93,180
+activeForeground=255,255,255
+activeTitleBtnBg=220,220,220
+alternateBackground=240,240,240
+background=238,238,230
+buttonBackground=238,234,222
+buttonForeground=0,0,0
+contrast=7
+foreground=0,0,0
+frame=238,238,230
+handle=238,238,230
+inactiveBackground=220,220,220
+inactiveBlend=220,220,220
+inactiveForeground=0,0,0
+inactiveFrame=238,238,230
+inactiveHandle=238,238,230
+inactiveTitleBtnBg=220,220,220
+linkColor=0,0,192
+selectBackground=74,121,205
+selectForeground=255,255,255
+shadeSortColumn=true
+visitedLinkColor=128,0,128
+windowBackground=255,255,255
+windowForeground=0,0,0
+[Icons]
+Theme=Locolor
+
+[MainWindow Toolbar navigatorToolBar]
+Hidden=false
+
+
Index: kontact/profiles/OutlookDefaults/Makefile.am
===================================================================
--- kontact/profiles/OutlookDefaults/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/OutlookDefaults/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,6 @@
+profile_DATA = \
+        profile.cfg \
+        kontactrc \
+        korganizerrc
+
+profiledir = $(kde_datadir)/kontact/profiles/OutlookDefaults
Index: kontact/profiles/OutlookDefaults/profile.cfg
===================================================================
--- kontact/profiles/OutlookDefaults/profile.cfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/OutlookDefaults/profile.cfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,4 @@
+[Kontact Profile]
+Description=Settings resembling MS Outlook
+Identifier=OutlookDefaults
+Name=Outlook Style 
Index: kontact/profiles/Makefile.am
===================================================================
--- kontact/profiles/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1 @@
+SUBDIRS = KontactDefaults OutlookDefaults
Index: kontact/profiles/KontactDefaults/korganizerrc
===================================================================
--- kontact/profiles/KontactDefaults/korganizerrc	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/KontactDefaults/korganizerrc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,3 @@
+[Views]
+Agenda View Calendar Display=CalendarsMerged
+
Index: kontact/profiles/KontactDefaults/kontactrc
===================================================================
--- kontact/profiles/KontactDefaults/kontactrc	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/KontactDefaults/kontactrc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,35 @@
+[General]
+activeBackground=KONTACT_PROFILE_DELETE_KEY
+activeBlend=KONTACT_PROFILE_DELETE_KEY
+activeForeground=KONTACT_PROFILE_DELETE_KEY
+activeTitleBtnBg=KONTACT_PROFILE_DELETE_KEY
+alternateBackground=KONTACT_PROFILE_DELETE_KEY
+background=KONTACT_PROFILE_DELETE_KEY
+buttonBackground=KONTACT_PROFILE_DELETE_KEY
+buttonForeground=KONTACT_PROFILE_DELETE_KEY
+contrast=KONTACT_PROFILE_DELETE_KEY
+foreground=KONTACT_PROFILE_DELETE_KEY
+frame=KONTACT_PROFILE_DELETE_KEY
+handle=KONTACT_PROFILE_DELETE_KEY
+inactiveBackground=KONTACT_PROFILE_DELETE_KEY
+inactiveBlend=KONTACT_PROFILE_DELETE_KEY
+inactiveForeground=KONTACT_PROFILE_DELETE_KEY
+inactiveFrame=KONTACT_PROFILE_DELETE_KEY
+inactiveHandle=KONTACT_PROFILE_DELETE_KEY
+inactiveTitleBtnBg=KONTACT_PROFILE_DELETE_KEY
+linkColor=KONTACT_PROFILE_DELETE_KEY
+selectBackground=KONTACT_PROFILE_DELETE_KEY
+selectForeground=KONTACT_PROFILE_DELETE_KEY
+shadeSortColumn=KONTACT_PROFILE_DELETE_KEY
+visitedLinkColor=KONTACT_PROFILE_DELETE_KEY
+windowBackground=KONTACT_PROFILE_DELETE_KEY
+windowForeground=KONTACT_PROFILE_DELETE_KEY
+
+[MainWindow Toolbar navigatorToolBar]
+Hidden=true
+
+[View]
+SidePaneSplitter=115,1088
+
+[Icons]
+Theme=KONTACT_PROFILE_DELETE_KEY
Index: kontact/profiles/KontactDefaults/Makefile.am
===================================================================
--- kontact/profiles/KontactDefaults/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/KontactDefaults/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,6 @@
+profile_DATA = \
+        profile.cfg \
+        kontactrc \
+        korganizerrc
+
+profiledir = $(kde_datadir)/kontact/profiles/KontactDefaults
Index: kontact/profiles/KontactDefaults/profile.cfg
===================================================================
--- kontact/profiles/KontactDefaults/profile.cfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/profiles/KontactDefaults/profile.cfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,4 @@
+[Kontact Profile]
+Description=Default KDE Kontact settings
+Identifier=KontactDefaults
+Name=Kontact Style
Index: kontact/src/kontactdcop.desktop
===================================================================
--- kontact/src/kontactdcop.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/kontactdcop.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,19 @@
+[Desktop Entry]
+Encoding=UTF-8
+Name=Kontact
+Name[be]=–ö–∞–Ω—Ç–∞–∫—Ç
+Name[hi]=‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§ï‡•ç‡§ü
+Name[mk]=–ö–æ–Ω—Ç–∞–∫—Ç
+Name[ne]=‡§∏‡§Æ‡•ç‡§™‡§∞‡•ç‡§ï ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
+Name[sv]=Kontakt
+Name[ta]=‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ ‡Æï‡Øä‡Æ≥‡Øç
+Name[zh_TW]=Kontact ÂÄã‰∫∫Ë≥áË®äÁÆ°ÁêÜ
+Exec=kontact --iconify
+Type=Application
+Icon=kontact
+NoDisplay=true
+X-DCOP-ServiceType=Unique
+X-DCOP-ServiceName=kontact
+ServiceTypes=DCOP/ResourceBackend/IMAP,DCOP/Mailer
+X-KDE-StartupNotify=false
+Categories=Qt;KDE;Office
Index: kontact/src/kontactiface.h
===================================================================
--- kontact/src/kontactiface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/kontactiface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,36 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#ifndef KONTACT_INTERFACE_H
+#define KONTACT_INTERFACE_H
+
+#include <dcopobject.h>
+
+class KontactIface : public DCOPObject
+{
+  K_DCOP
+  public:
+    KontactIface() : DCOPObject("KontactIface") {}
+
+  k_dcop:
+    virtual void selectPlugin( const QString &name ) = 0;
+
+};
+
+#endif
Index: kontact/src/profilemanager.h
===================================================================
--- kontact/src/profilemanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/profilemanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,162 @@
+/*
+    This file is part of KDE Kontact.
+
+    Copyright (c) 2007 Frank Osterfeld <frank.osterfeld@kdemail.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KONTACT_PROFILEMANAGER_H
+#define KONTACT_PROFILEMANAGER_H
+
+#include <qmap.h>
+#include <qobject.h>
+#include <qstring.h>
+
+template <class T> class QValueList;
+
+namespace KIO {
+    class Job;
+}
+
+namespace Kontact {
+
+class Profile
+{
+    friend class ProfileManager;
+public:
+    Profile();
+
+    explicit Profile( const QString& id, bool isLocal = false );
+
+    QString id() const;
+
+    QString name() const;
+
+    QString description() const;
+
+    bool isNull() const;
+
+    void setName( const QString& name );
+
+    void setDescription( const QString& description );
+
+    bool operator==( const Kontact::Profile& other ) const;
+
+    QString saveLocation() const;
+
+private: // ProfileManager only
+
+    enum SetLocalMode {
+        DoNotCopyProfileFiles,
+        CopyProfileFiles
+    };
+    void setLocal( SetLocalMode mode );
+    bool isLocal() const;
+    void setOriginalLocation( const QString& path );
+    void setId( const QString& id );
+
+private:
+
+    static void copyConfigFiles( const QString& source, const QString& dest );
+
+    QString localSaveLocation() const;
+
+private:
+    QString m_id;
+    QString m_name;
+    QString m_description;
+    bool m_local;
+    QString m_originalLocation;
+};
+
+class ProfileManager : public QObject
+{
+Q_OBJECT
+public:
+    enum ImportError {
+        SuccessfulImport=0,
+        NoValidProfile
+    };
+
+    enum ExportError {
+        SuccessfulExport=0,
+        DirectoryDoesNotExist,
+        DirectoryNotWritable
+    };
+
+    static ProfileManager* self();
+
+    ~ProfileManager();
+
+    Kontact::Profile profileById( const QString& id ) const;
+
+    bool addProfile( const Kontact::Profile& profile, bool syncConfig = true );
+
+    void removeProfile( const Kontact::Profile& profile );
+
+    void removeProfile( const QString& id );
+
+    void updateProfile( const Kontact::Profile& profile );
+
+    void loadProfile( const QString& id );
+
+    void saveToProfile( const QString& id );
+
+    QValueList<Kontact::Profile> profiles() const;
+
+    ExportError exportProfileToDirectory( const QString& id, const QString& path );
+
+    ImportError importProfileFromDirectory( const QString& path );
+
+    QString generateNewId() const;
+
+signals:
+    void profileAdded( const QString& id );
+
+    void profileRemoved( const QString& id );
+
+    void profileUpdated( const QString& id );
+
+    void profileLoaded( const QString& id );
+
+    void saveToProfileRequested( const QString& id );
+
+    void profileImportFinished( ImportError status );
+
+private:
+    static ProfileManager* m_self;
+
+    static Kontact::Profile readFromConfiguration( const QString& configFile, bool isLocal );
+
+    explicit ProfileManager( QObject* parent = 0 );
+
+    void readConfig();
+
+    void writeConfig() const;
+
+    void writeProfileConfig( const Kontact::Profile& profile ) const;
+
+private:
+    QMap<QString, Kontact::Profile> m_profiles;
+};
+
+}
+
+#endif // KONTACT_PROFILEMANAGER_H
Index: kontact/src/iconsidepane.cpp
===================================================================
--- kontact/src/iconsidepane.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/iconsidepane.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -112,7 +112,10 @@
   int size = (int)navigator()->viewMode();
   if ( size != 0 )
     mPixmap = KGlobal::iconLoader()->loadIcon( mPlugin->icon(),
-                                               KIcon::Desktop, size );
+                                               KIcon::Desktop, size,
+                                               mPlugin->disabled() ? 
+                                                 KIcon::DisabledState 
+                                               : KIcon::DefaultState);
   else
     mPixmap = QPixmap();
 }
@@ -219,10 +222,12 @@
         y += mPixmap.height()/2 - fm.height()/2 + fm.ascent();
     }
 
-    if ( isCurrent() || isSelected() || mHasHover ) {
+    if ( plugin()->disabled() ) {
+      p->setPen( box->palette().disabled().text( ) );
+    } else if ( isCurrent() || isSelected() || mHasHover ) {
       p->setPen( box->colorGroup().highlight().dark(115) );
       p->drawText( x + ( QApplication::reverseLayout() ? -1 : 1),
-                   y + 1, text() );
+          y + 1, text() );
       p->setPen( box->colorGroup().highlightedText() );
     }
     else
@@ -334,6 +339,7 @@
       continue;
 
     EntryItem *item = new EntryItem( this, plugin );
+    item->setSelectable( !plugin->disabled() );
 
     if ( item->width( this ) > minWidth )
       minWidth = item->width( this );
Index: kontact/src/kontact.setdlg
===================================================================
--- kontact/src/kontact.setdlg	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/kontact.setdlg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,213 +1,12 @@
 [KontactSummary]
-Name=Summary
-Name[af]=Opsomming
-Name[ar]=ÿßŸÑŸÖŸàÿ¨ÿ≤
-Name[br]=Diverra√±
-Name[bs]=Sa≈æetak
-Name[ca]=Resum
-Name[cs]=Souhrn
-Name[cy]=Crynodeb
-Name[da]=Opsummering
-Name[de]=√úbersicht
-Name[el]=Œ£œçŒΩŒøœàŒ∑
-Name[es]=Resumen
-Name[et]=Kokkuv√µte
-Name[eu]=Laburpena
-Name[fa]=ÿÆŸÑÿßÿµŸá
-Name[fi]=Yhteenveto
-Name[fr]=R√©sum√©
-Name[fy]=Oersicht
-Name[ga]=Achoimre
-Name[gl]=Resumo
-Name[he]=◊™◊ß◊¶◊ô◊®
-Name[hi]=‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂
-Name[hu]=√Åttekint≈ë
-Name[is]=Yfirlit
-Name[it]=Sommario
-Name[ja]=Ë¶ÅÁ¥Ñ
-Name[kk]=–¢“±–∂—ã—Ä—ã–º
-Name[km]=·ûü·ûÑ·üí·ûÅ·üÅ·ûî
-Name[lt]=Santrauka
-Name[mk]=–ü—Ä–µ–≥–ª–µ–¥
-Name[ms]=Ringkasan
-Name[nb]=Sammendrag
-Name[nds]=√ñversicht
-Name[ne]=‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂
-Name[nl]=Overzicht
-Name[nn]=Samandrag
-Name[pl]=Podsumowanie
-Name[pt]=Resumo
-Name[pt_BR]=Resumo
-Name[ro]=Sumar
-Name[ru]=–î–∞–π–¥–∂–µ—Å—Ç
-Name[se]=ƒåoahkk√°igeassu
-Name[sk]=S√∫hrn
-Name[sl]=Povzetek
-Name[sr]=–°–∞–∂–µ—Ç–∞–∫
-Name[sr@Latn]=Sa≈æetak
-Name[sv]=√ñversikt
-Name[ta]=‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç
-Name[tg]=–î–∞–π–¥–∂–µ—Å—Ç
-Name[th]=‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
-Name[tr]=√ñzet
-Name[uk]=–ó–≤–µ–¥–µ–Ω–Ω—è
-Name[uz]=“≤–∏—Å–æ–±–æ—Ç
-Name[zh_CN]=Ê¶ÇËßà
-Name[zh_TW]=ÊëòË¶Å
-Comment=Summary View
-Comment[af]=Opsomming aansig
-Comment[ar]=ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑÿÆÿµ
-Comment[bg]=–û–±–æ–±—â–µ–Ω–∏–µ
-Comment[ca]=Vista resum
-Comment[cs]=Souhrn√Ω pohled
-Comment[da]=Sammendragsvisning
-Comment[de]=Zusammenfassungsansicht
-Comment[el]=Œ†œÅŒøŒ≤ŒøŒªŒÆ œÉœçŒΩŒøœàŒ∑œÇ
-Comment[es]=Vista del resumen
-Comment[et]=Kokkuv√µttevaade
-Comment[eu]=Laburpen ikuspegia
-Comment[fa]=ŸÜŸÖÿß€å ÿÆŸÑÿßÿµŸá
-Comment[fi]=Yhteenveton√§ytt√∂
-Comment[fr]=Vue r√©sum√©e
-Comment[fy]=Oersichtswerjefte
-Comment[gl]=Vista de Sumario
-Comment[he]=◊™◊¶◊ï◊í◊™ ◊™◊ß◊¶◊ô◊®
-Comment[hu]=√Åttekint≈ë n√©zet
-Comment[is]=Yfirlitss√Ωn
-Comment[it]=Vista sommario
-Comment[ja]=Ë¶ÅÁ¥Ñ„Éì„É•„Éº
-Comment[kk]=–¢“±–∂—ã—Ä—ã–º–¥–∞–º–∞
-Comment[km]=·ûë·û∑·ûä·üí·ûã·ûó·û∂·ûñ‚Äã·ûü·ûÑ·üí·ûÅ·üÅ·ûî
-Comment[lt]=Santraukos vaizdas
-Comment[mk]=–ü—Ä–∏–∫–∞–∑ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥–æ—Ç
-Comment[ms]=Paparan Ringkasan
-Comment[nb]=Sammendragsvisning
-Comment[nds]=√ñversichtansicht
-Comment[ne]=‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡•É‡§∂‡•ç‡§Ø
-Comment[nl]=Overzichtsweergave
-Comment[nn]=Samandragsvising
-Comment[pl]=Widok podsumowania
-Comment[pt]=Vista Sum√°ria
-Comment[pt_BR]=Sum√°rio
-Comment[ru]=–í–∏–¥ –¥–∞–π–¥–∂–µ—Å—Ç–∞
-Comment[sk]=S√∫hrnn√Ω pohƒæad
-Comment[sl]=Pogled povzetka
-Comment[sr]=–ü—Ä–∏–∫–∞–∑ —Å–∞–∂–µ—Ç–∫–∞
-Comment[sr@Latn]=Prikaz sa≈æetka
-Comment[sv]=√ñversiktsvy
-Comment[ta]=‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æö‡Æø
-Comment[tr]=√ñzet G√∂r√ºn√ºm
-Comment[uk]=–í–∏–≥–ª—è–¥ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—ñ–¥—Å—É–º–∫—É
-Comment[zh_CN]=ÊëòË¶ÅËßÜÂõæ
-Comment[zh_TW]=ÊëòË¶ÅÊ™¢Ë¶ñ
+Name=Summary View
+Comment=Configuration of Kontact's <b>Summary View</b>. Some plugins provide <i>Summary View</i> items, choose the ones you would like to list.
 Weight=100
 Icon=kontact_summary
 
 [KMail]
-Name=Mail
-Name[af]=Pos
-Name[ar]=ÿßŸÑÿ®ÿ±ŸäÿØ
-Name[be]=–ü–æ—à—Ç–∞
-Name[br]=Lizher
-Name[ca]=Correu
-Name[cs]=Po≈°ta
-Name[cy]=Ebost
-Name[da]=Brev
-Name[de]=E-Mail
-Name[es]=Correo
-Name[et]=E-post
-Name[eu]=Posta
-Name[fa]=ŸÜÿßŸÖŸá
-Name[fi]=S√§hk√∂posti
-Name[fr]=Messages
-Name[fy]=E-post
-Name[ga]=R√≠omhphost
-Name[gl]=Correo-e
-Name[he]=◊ì◊ï◊ê"◊ú
-Name[hi]=‡§°‡§æ‡§ï
-Name[hr]=Po≈°ta
-Name[hu]=E-mail
-Name[is]=P√≥stur
-Name[it]=Posta
-Name[ja]=„É°„Éº„É´
-Name[kk]=–ü–æ—à—Ç–∞
-Name[km]=·ûü·üÜ·ûî·ûª·ûè·üí·ûö
-Name[lt]=Pa≈°tas
-Name[mk]=–ï-–ø–æ—à—Ç–∞
-Name[ms]=Mel
-Name[nb]=E-post
-Name[nds]=Nettpost
-Name[ne]=‡§™‡§§‡•ç‡§∞
-Name[nl]=E-mail
-Name[nn]=E-post
-Name[pa]=‡®™‡©±‡®§‡®∞
-Name[pl]=Poczta
-Name[pt]=E-mail
-Name[pt_BR]=Correio
-Name[ro]=E-Mail
-Name[ru]=–ü–æ—á—Ç–∞
-Name[se]=E-boasta
-Name[sk]=Po≈°ta
-Name[sl]=Po≈°ta
-Name[sr]=–ü–æ—à—Ç–∞
-Name[sr@Latn]=Po≈°ta
-Name[sv]=Brev
-Name[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç
-Name[tg]=–ú–∞–∫—Ç—É–±
-Name[th]=‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢
-Name[tr]=Posta
-Name[uk]=–ü–æ—à—Ç–∞
-Name[uz]=–•–∞—Ç-—Ö–∞–±–∞—Ä
-Name[zh_CN]=ÈÇÆ‰ª∂
-Name[zh_TW]=ÈÉµ‰ª∂
-Comment=Mail Component
-Comment[af]=Pos komponent
-Comment[ar]=ŸÖŸÉŸàŸëŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ
-Comment[be]=–ö–∞–º–ø–∞–Ω—ç–Ω—Ç "–ü–æ—à—Ç–∞"
-Comment[bg]=–ú–æ–¥—É–ª –∑–∞ –µ-–ø–æ—â–∞
-Comment[br]=Perzh postel
-Comment[ca]=Component de correu
-Comment[cs]=Po≈°tovn√≠ komponenta
-Comment[da]=Post-komponent
-Comment[de]=Mail-Komponente
-Comment[el]=Œ£œÑŒøŒπœáŒµŒØŒø Œ±ŒªŒªŒ∑ŒªŒøŒ≥œÅŒ±œÜŒØŒ±œÇ
-Comment[es]=Componente de correo
-Comment[et]=E-posti komponent
-Comment[eu]=Posta osagaia
-Comment[fa]=ŸÖÿ§ŸÑŸÅ€Ä ŸÜÿßŸÖŸá
-Comment[fi]=S√§hk√∂postiohjelma
-Comment[fr]=Composant messagerie
-Comment[fy]=E-postkomponint
-Comment[gl]=Compo√±ente de Correo
-Comment[he]=◊®◊õ◊ô◊ë ◊ì◊ï◊ê◊®
-Comment[hu]=Levelez≈ëkomponens
-Comment[is]=P√≥sthluti
-Comment[it]=Componente posta
-Comment[ja]=„É°„Éº„É´„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
-Comment[kk]=–ü–æ—à—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ
-Comment[km]=·ûü·ûò·û∂·ûü·ûó·û∂·ûÇ‚Äã·ûü·üÜ·ûî·ûª·ûè·üí·ûö
-Comment[lt]=Pa≈°to komponentas
-Comment[mk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞ –µ-–ø–æ—à—Ç–∞
-Comment[ms]=Komponen Mel
-Comment[nb]=E-postkomponent
-Comment[nds]=Nettpost-Komponent
-Comment[ne]=‡§™‡§§‡•ç‡§∞ ‡§Ö‡§µ‡§Ø‡§µ
-Comment[nl]=E-mailcomponent
-Comment[nn]=E-postkomponent
-Comment[pl]=Sk≈Çadnik poczty
-Comment[pt]=Componente de E-mail
-Comment[pt_BR]=Componente de Email
-Comment[ru]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç KMail
-Comment[sk]=Komponent po≈°ty
-Comment[sl]=Po≈°tna komponenta
-Comment[sr]=–ü–æ—à—Ç–∞–Ω—Å–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
-Comment[sr@Latn]=Po≈°tanska komponenta
-Comment[sv]=E-postkomponent
-Comment[ta]=‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø
-Comment[tr]=E-posta Bile≈üeni
-Comment[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ—à—Ç–∏
-Comment[zh_CN]=ÈÇÆ‰ª∂ÁªÑ‰ª∂
-Comment[zh_TW]=ÈÉµ‰ª∂ÂÖÉ‰ª∂
+Name=E-Mail
+Comment=Configuration of Kontact's E-Mail Plugin <b>KMail</b>, includes a <i>Summary View Item</i> and represents a <i>Kontact Component</i>.
 Weight=200
 Icon=kontact_mail
 
@@ -224,6 +23,7 @@
 Name[da]=Kontakter
 Name[de]=Kontakte
 Name[el]=ŒïœÄŒ±œÜŒ≠œÇ
+Name[eo]=Kontaktoj
 Name[es]=Contactos
 Name[et]=Kontaktid
 Name[eu]=Kontaktuak
@@ -268,53 +68,7 @@
 Name[uz]=–ê–ª–æ“õ–∞–ª–∞—Ä
 Name[zh_CN]=ËÅîÁ≥ª‰∫∫
 Name[zh_TW]=ËÅØÁµ°‰∫∫
-Comment=Address Book Component
-Comment[af]=Adres boek komponent
-Comment[ar]=ŸÖŸÉŸàŸÜ ÿØŸÅÿ™ÿ± ÿßŸÑÿπŸÜÿßŸàŸäŸÜ
-Comment[be]=–ö–∞–º–ø–∞–Ω—ç–Ω—Ç "–ê–¥—Ä–∞—Å–Ω–∞—è –∫–Ω—ñ–≥–∞"
-Comment[bg]=–ú–æ–¥—É–ª –∑–∞ –∞–¥—Ä–µ—Å–Ω–∏–∫–∞
-Comment[ca]=Component de llibreta d'adreces
-Comment[cs]=Komponenta knihy adres
-Comment[da]=Adressebogskomponent
-Comment[de]=Adressbuch-Komponente
-Comment[el]=Œ£œÑŒøŒπœáŒµŒØŒø Œ≤ŒπŒ≤ŒªŒØŒøœÖ Œ¥ŒπŒµœÖŒ∏œçŒΩœÉŒµœâŒΩ
-Comment[es]=Componente de la libreta de direcciones
-Comment[et]=Aadressiraamatu komponent
-Comment[eu]=Helbide-liburu osagaia
-Comment[fa]=ŸÖÿ§ŸÑŸÅ€Ä ⁄©ÿ™ÿßÿ® ŸÜÿ¥ÿßŸÜ€å
-Comment[fi]=Osoitekirja
-Comment[fr]=Composant de carnet d'adresses
-Comment[fy]=Adresboekkomponint
-Comment[gl]=Compo√±ente do Caderno de Enderezos
-Comment[he]=◊®◊õ◊ô◊ë ◊§◊†◊ß◊° ◊õ◊™◊ï◊ë◊ï◊™
-Comment[hu]=C√≠mjegyz√©k-komponens
-Comment[is]=Vistfangahluti
-Comment[it]=Componente rubrica indirizzi
-Comment[ja]=„Ç¢„Éâ„É¨„ÇπÂ∏≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
-Comment[kk]=–ê–¥—Ä–µ—Å—Ç—ñ–∫ –∫—ñ—Ç–∞–ø—à–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ
-Comment[km]=·ûü·ûò·û∂·ûü·ûó·û∂·ûÇ‚Äã·ûü·üÄ·ûú·ûó·üÖ‚Äã·û¢·û∂·ûü·ûô·ûä·üí·ûã·û∂·ûì
-Comment[lt]=Adres≈≥ knygelƒós komponentas
-Comment[mk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞ –∞–¥—Ä–µ—Å–∞—Ä
-Comment[ms]=Komponen Buku Alamat 
-Comment[nb]=Adressebok-komponent
-Comment[nds]=Adressbook-Komponent
-Comment[ne]=‡§†‡•á‡§ó‡§æ‡§®‡§æ ‡§™‡•Å‡§∏‡•ç‡§§‡§ø‡§ï‡§æ ‡§Ö‡§µ‡§Ø‡§µ
-Comment[nl]=Adresboekcomponent
-Comment[nn]=Adressebok-komponent
-Comment[pl]=Sk≈Çadnik ksiƒÖ≈ºki adresowej
-Comment[pt]=Componente de Livro de Endere√ßos
-Comment[pt_BR]=Componente de Livro de Endere√ßos
-Comment[ru]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–¥—Ä–µ—Å–Ω–æ–π –∫–Ω–∏–≥–∏
-Comment[sk]=Komponent adres√°ra
-Comment[sl]=Komponenta za adresar
-Comment[sr]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∞–¥—Ä–µ—Å–∞—Ä–∞
-Comment[sr@Latn]=Komponenta adresara
-Comment[sv]=Adressbokskomponent
-Comment[ta]=‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡Æï ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø
-Comment[tr]=Adres Defteri Bile≈üeni
-Comment[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–¥—Ä–µ—Å–Ω–æ—ó –∫–Ω–∏–≥–∏
-Comment[zh_CN]=Âú∞ÂùÄÁ∞øÁªÑ‰ª∂
-Comment[zh_TW]=ÈÄöË®äÈåÑÂÖÉ‰ª∂
+Comment=Configuration of Kontact's Adress Book Plugin <b>KAdressbook</b> which represents a <i>Kontact Component</i>.
 Weight=300
 Icon=kontact_contacts
 
@@ -327,6 +81,7 @@
 Name[da]=Opsummering af s√¶rlige datoer
 Name[de]=√úbersicht √ºber besondere Termine
 Name[el]=Œ£œçŒΩŒøœàŒ∑ œÉŒ∑ŒºŒ±ŒΩœÑŒπŒ∫œéŒΩ Œ∑ŒºŒµœÅŒøŒºŒ∑ŒΩŒπœéŒΩ
+Name[eo]=Resumo pri Specialaj Datoj
 Name[es]=Resumen de fechas especiales
 Name[et]=T√§htp√§evade kokkuv√µte
 Name[eu]=Data berezien laburpena
@@ -373,6 +128,7 @@
 Comment[da]=Opsummeringskomponent for s√¶rlige datoer
 Comment[de]=Komponente f√ºr √úbersicht √ºber besondere Termine
 Comment[el]=Œ£œÑŒøŒπœáŒµŒØŒø œÉœçŒΩŒøœàŒ∑œÇ Œ£Œ∑ŒºŒ±ŒΩœÑŒπŒ∫œéŒΩ ŒóŒºŒµœÅŒøŒºŒ∑ŒΩŒπœéŒΩ
+Comment[eo]=Specialdatresuma Komponanto
 Comment[es]=Componente de resumen de fechas especiales
 Comment[et]=T√§htp√§evade kokkuv√µtte komponent
 Comment[eu]=Data berezien laburpenaren osagaia
@@ -426,6 +182,7 @@
 Name[da]=Kalender
 Name[de]=Kalender
 Name[el]=ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒø
+Name[eo]=Kalendaro
 Name[es]=Calendario
 Name[et]=Kalender
 Name[eu]=Egutegia
@@ -470,52 +227,7 @@
 Name[uz]=–ö–∞–ª–µ–Ω–¥–∞—Ä
 Name[zh_CN]=Êó•ÂéÜ
 Name[zh_TW]=Ë°å‰∫ãÊõÜ
-Comment=Calendar Component
-Comment[af]=Kalender komponent
-Comment[be]=–ö–∞–º–ø–∞–Ω—ç–Ω—Ç "–ö–∞–ª–µ–Ω–¥–∞—Ä"
-Comment[bg]=–ú–æ–¥—É–ª –∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞
-Comment[ca]=Component de calendari
-Comment[cs]=Komponenta kalend√°≈ôe
-Comment[da]=Calendar-komponent
-Comment[de]=Kalender-Komponente
-Comment[el]=Œ£œÑŒøŒπœáŒµŒØŒø Œ∑ŒºŒµœÅŒøŒªŒøŒ≥ŒØŒøœÖ
-Comment[es]=Componente de calendario
-Comment[et]=Kalendrikomponent
-Comment[eu]=Egutegi osagaia
-Comment[fa]=ŸÖÿ§ŸÑŸÅ€Ä ÿ™ŸÇŸà€åŸÖ
-Comment[fi]=Kalenterikomponentti
-Comment[fr]=Composant d'agenda
-Comment[fy]=Agindakomponint
-Comment[gl]=Compo√±ente de Calendario
-Comment[he]=◊®◊õ◊ô◊ë ◊ú◊ï◊ó ◊©◊†◊î
-Comment[hu]=Napt√°rkezel≈ë komponens
-Comment[is]=Dagatalshluti
-Comment[it]=Componente calendario
-Comment[ja]=„Ç´„É¨„É≥„ÉÄ„Éº„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
-Comment[kk]=–ö“Ø–Ω—Ç—ñ–∑–±–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ
-Comment[km]=·ûü·ûò·û∂·ûó·û∂·ûÇ‚Äã·ûî·üí·ûö·ûè·û∑·ûë·û∑·ûì
-Comment[lt]=Kalendoriaus komponentas
-Comment[mk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä
-Comment[ms]=Komponen Kalendar
-Comment[nb]=Calendar-komponent
-Comment[nds]=Kalenner-Komponent
-Comment[ne]=‡§ï‡•ç‡§Ø‡§æ‡§≤‡•á‡§®‡•ç‡§°‡§∞ ‡§Ö‡§µ‡§Ø‡§µ
-Comment[nl]=Agendacomponent
-Comment[nn]=Kalenderkomponent
-Comment[pl]=Sk≈Çadnik kalendarza
-Comment[pt]=Componente de Calend√°rio
-Comment[pt_BR]=Componente de Calend√°rio
-Comment[ru]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
-Comment[sk]=Komponent kalend√°ra
-Comment[sl]=Komponenta za koledar
-Comment[sr]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞
-Comment[sr@Latn]=Komponenta kalendara
-Comment[sv]=Kalenderkomponent
-Comment[ta]=‡Æ®‡Ææ‡Æ≥‡Øç‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø
-Comment[tr]=Takvim Bile≈üeni
-Comment[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
-Comment[zh_CN]=Êó•ÂéÜÁªÑ‰ª∂
-Comment[zh_TW]=Ë°å‰∫ãÊõÜÂÖÉ‰ª∂
+Comment=Configuration of Kontact's Calendar Plugin <b>KOrganizer</b>, includes a <i>Summary View Item</i> and represents a <i>Kontact Component</i>.
 Weight=400
 Icon=kontact_date
 
@@ -532,6 +244,7 @@
 Name[da]=Nyheder
 Name[de]=Usenet
 Name[el]=ŒùŒ≠Œ±
+Name[eo]=Novaƒµoj
 Name[es]=Noticias
 Name[et]=Uudisegrupid
 Name[eu]=Berriak
@@ -576,52 +289,7 @@
 Name[uz]=–Ø–Ω–≥–∏–ª–∏–∫–ª–∞—Ä
 Name[zh_CN]=Êñ∞Èóª
 Name[zh_TW]=Êñ∞ËÅû
-Comment=News Component
-Comment[af]=Nuus komponent
-Comment[be]=–ö–∞–º–ø–∞–Ω—ç–Ω—Ç "–ù–∞–≤—ñ–Ω—ã"
-Comment[bg]=–ú–æ–¥—É–ª –∑–∞ –Ω–æ–≤–∏–Ω–∏—Ç–µ
-Comment[ca]=Component ne not√≠cies
-Comment[cs]=Komponenta novinek
-Comment[da]=Nyhedskomponent
-Comment[de]=News-Komponente
-Comment[el]=Œ£œÑŒøŒπœáŒµŒØŒø ŒΩŒ≠œâŒΩ
-Comment[es]=Componente de noticias
-Comment[et]=Uudistekomponent
-Comment[eu]=Berrien osagaia
-Comment[fa]=ŸÖÿ§ŸÑŸÅ€Ä ÿßÿÆÿ®ÿßÿ±
-Comment[fi]=Uutiskomponentti
-Comment[fr]=Composant de Nouvelles
-Comment[fy]=Nijskomponint
-Comment[gl]=Compo√±ente de Novas
-Comment[he]=◊®◊õ◊ô◊ë ◊ó◊ì◊©◊ï◊™
-Comment[hu]=H√≠rkezel≈ë komponens
-Comment[is]=Fr√©ttahluti
-Comment[it]=Componente news
-Comment[ja]=„Éã„É•„Éº„Çπ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
-Comment[kk]=–ñ–∞“£–∞–ª—ã“õ—Ç–∞—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ
-Comment[km]=·ûü·ûò·û∂·ûü·ûó·û∂·ûÇ‚Äã·ûñ·üê·ûè·üå·ûò·û∂·ûì
-Comment[lt]=Naujien≈≥ komponentas
-Comment[mk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞ –≤–µ—Å—Ç–∏
-Comment[ms]=Komponen Berita
-Comment[nb]=Njus-komponent
-Comment[nds]=Narichten-Komponente
-Comment[ne]=‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§Ö‡§µ‡§Ø‡§µ
-Comment[nl]=Nieuwscomponent
-Comment[nn]=Nyhendekomponent
-Comment[pl]=Sk≈Çadnik wiadomo≈õci
-Comment[pt]=Componente de Not√≠cias
-Comment[pt_BR]=Componente de Not√≠cias
-Comment[ru]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–æ–≤–æ—Å—Ç–µ–π
-Comment[sk]=Komponent spr√°v
-Comment[sl]=Komponenta za novice
-Comment[sr]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–µ—Å—Ç–∏
-Comment[sr@Latn]=Komponenta vesti
-Comment[sv]=Diskussionsgruppskomponent
-Comment[ta]=‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø
-Comment[tr]=Haber Grubu Bile≈üeni
-Comment[uk]=–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–æ–≤–∏–Ω
-Comment[zh_CN]=Êñ∞ÈóªÁªÑ‰ª∂
-Comment[zh_TW]=Êñ∞ËÅûÂÖÉ‰ª∂
+Comment=Configuration of Kontact's News Plugin <b>KNode</b> which represents a <i>Kontact Component</i>.
 Weight=500
 Icon=kontact_news
 
@@ -638,6 +306,7 @@
 Name[da]=Vejr
 Name[de]=Wetter
 Name[el]=ŒöŒ±ŒπœÅœåœÇ
+Name[eo]=Vetero
 Name[es]=Meteorolog√≠a
 Name[et]=Ilm
 Name[eu]=Eguraldia
@@ -682,57 +351,7 @@
 Name[uz]=–û–±-“≥–∞–≤–æ
 Name[zh_CN]=Â§©Ê∞î
 Name[zh_TW]=Â§©Ê∞£
-Comment=Weather Information
-Comment[af]=Weer informasie
-Comment[ar]=ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ÿßŸÑÿ∑ŸÇÿ≥
-Comment[be]=–Ü–Ω—Ñ–∞—Ä–º–∞—Ü—ã—è –ø—Ä–∞ –Ω–∞–¥–≤–æ—Ä‚Äô–µ
-Comment[bg]=–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≤—Ä–µ–º–µ—Ç–æ
-Comment[br]=Titouro√π diwar-benn an amzer
-Comment[ca]=Informaci√≥ del temps
-Comment[cs]=Informace o poƒças√≠
-Comment[cy]=Gwybodaeth Dywydd
-Comment[da]=Vejrinformation
-Comment[de]=Wetterinformationen
-Comment[el]=Œ†ŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ Œ∫Œ±ŒπœÅŒøœç
-Comment[es]=Informaci√≥n meteorol√≥gica
-Comment[et]=Ilmateade
-Comment[eu]=Eguraldi informazioa
-Comment[fa]=ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¢ÿ® Ÿà ŸáŸàÿß
-Comment[fi]=S√§√§tiedot
-Comment[fr]=Informations m√©t√©o
-Comment[fy]=It waar
-Comment[ga]=Eolas faoin aimsir
-Comment[gl]=Informaci√≥n do Tempo
-Comment[he]=◊û◊ô◊ì◊¢ ◊ê◊ï◊ì◊ï◊™ ◊û◊ñ◊í ◊î◊ê◊ï◊ï◊ô◊®
-Comment[hu]=Id≈ëj√°r√°si adatok
-Comment[is]=Ve√∞uruppl√Ωsingar
-Comment[it]=Informazioni meteorologiche
-Comment[ja]=Ê∞óË±°ÊÉÖÂ†±
-Comment[kk]=–ê—É–∞ —Ä–∞–π—ã –º”ô–ª—ñ–º–µ—Ç—ñ
-Comment[km]=·ûñ·üê·ûè·üå·ûò·û∂·ûì‚Äã·û¢·üÜ·ûñ·û∏‚Äã·û¢·û∂·ûÄ·û∂·ûü·ûí·û∂·ûè·ûª
-Comment[lt]=Or≈≥ informacija
-Comment[mk]=–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞ –≤—Ä–µ–º–µ—Ç–æ
-Comment[ms]=Maklumat Cuaca
-Comment[nb]=V√¶rinformasjon
-Comment[nds]=Wederinformatschonen
-Comment[ne]=‡§Æ‡•å‡§∏‡§Æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä
-Comment[nl]=Het weer
-Comment[nn]=V√™rinformasjon
-Comment[pl]=Informacje o pogodzie
-Comment[pt]=Informa√ß√µes Meteorol√≥gicas
-Comment[pt_BR]=Informa√ß√µes sobre o Clima
-Comment[ru]=–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–≥–æ–¥–µ
-Comment[sk]=Inform√°cie o poƒças√≠
-Comment[sl]=Podatki o vremenu
-Comment[sr]=–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—ò–µ –æ –≤—Ä–µ–º–µ–Ω—É
-Comment[sr@Latn]=Informacije o vremenu
-Comment[sv]=V√§derrapport
-Comment[ta]=‡Æ§‡Æü‡Øç‡Æ™‡Æµ‡ØÜ‡Æ™‡Øç‡Æ™‡Æ®‡Æø‡Æ≤‡Øà ‡Æ§‡Æï‡Æµ‡Æ≤‡Øç
-Comment[tr]=Hava Durumu Bilgisi
-Comment[uk]=–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–≥–æ–¥—É
-Comment[uz]=–û–±-“≥–∞–≤–æ “≥–∞“õ–∏–¥–∞ –º–∞—ä–ª—É–º–æ—Ç
-Comment[zh_CN]=Â§©Ê∞î‰ø°ÊÅØ
-Comment[zh_TW]=Â§©Ê∞£Ë≥áË®ä
+Comment=Weather Information Component
 Weight=1000
 Icon=kweather
 
@@ -801,6 +420,7 @@
 Comment[da]=Nyhedstelegraf-komponent
 Comment[de]=Newsticker-Komponente
 Comment[el]=Œ£œÖœÉœÑŒ±œÑŒπŒ∫œå œÄœÅŒøŒ≤ŒøŒªŒ≠Œ± ŒµŒπŒ¥ŒÆœÉŒµœâŒΩ
+Comment[eo]=Novaƒµprezentila Komponanto
 Comment[es]=Componente de teletipo de noticias
 Comment[et]=Uudistej√§lgija komponent
 Comment[eu]=Berri markatzaile osagaia
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -21,6 +21,8 @@
 */
 
 #include <qcombobox.h>
+#include <qdockarea.h>
+#include <qguardedptr.h>
 #include <qhbox.h>
 #include <qimage.h>
 #include <qobjectlist.h>
@@ -65,12 +67,16 @@
 #include <kaboutdata.h>
 #include <kmenubar.h>
 #include <kstdaccel.h>
+#include <kcmultidialog.h>
+#include <kipc.h>
 
 #include "aboutdialog.h"
 #include "iconsidepane.h"
 #include "mainwindow.h"
 #include "plugin.h"
 #include "prefs.h"
+#include "profiledialog.h"
+#include "profilemanager.h"
 #include "progressdialog.h"
 #include "statusbarprogresswidget.h"
 #include "broadcaststatus.h"
@@ -91,13 +97,13 @@
       QObject *object = widget->child( "KJanusWidget::buttonBelowList" );
       QPushButton *button = static_cast<QPushButton*>( object );
       if ( button )
-        button->setText( i18n( "Select Components..." ) );
+        button->setText( i18n( "Select Components ..." ) );
     }
 };
 
 MainWindow::MainWindow()
   : Kontact::Core(), mTopWidget( 0 ), mSplitter( 0 ),
-    mCurrentPlugin( 0 ), mAboutDialog( 0 ), mReallyClose( false )
+    mCurrentPlugin( 0 ), mAboutDialog( 0 ), mReallyClose( false ), mSyncActionsEnabled( true )
 {
   // Set this to be the group leader for all subdialogs - this means
   // modal subdialogs will only affect this dialog, not the other windows
@@ -126,6 +132,11 @@
 
   resize( 700, 520 ); // initial size to prevent a scrollbar in sidepane
   setAutoSaveSettings();
+
+  connect( Kontact::ProfileManager::self(), SIGNAL( profileLoaded( const QString& ) ), 
+           this, SLOT( slotLoadProfile( const QString& ) ) );
+  connect( Kontact::ProfileManager::self(), SIGNAL( saveToProfileRequested( const QString& ) ), 
+           this, SLOT( slotSaveToProfile( const QString& ) ) );
 }
 
 
@@ -141,7 +152,6 @@
     ( *it )->load();
   }
 
-
   // prepare the part manager
   mPartManager = new KParts::PartManager( this );
   connect( mPartManager, SIGNAL( activePartChanged( KParts::Part* ) ),
@@ -319,17 +329,123 @@
                                          KStdAccel::shortcut(KStdAccel::New), this, SLOT( slotNewClicked() ),
                                          actionCollection(), "action_new" );
 
+  KConfig* const cfg = Prefs::self()->config();
+  cfg->setGroup( "Kontact Groupware Settings" );
+  mSyncActionsEnabled = cfg->readBoolEntry( "GroupwareMailFoldersEnabled", true );
+
+  if ( mSyncActionsEnabled ) {
+    mSyncActions = new KToolBarPopupAction( KGuiItem( i18n( "Synchronize" ), "kitchensync" ),
+                                            KStdAccel::shortcut(KStdAccel::Reload), this, SLOT( slotSyncClicked() ),
+                                            actionCollection(), "action_sync" );
+  }
   new KAction( i18n( "Configure Kontact..." ), "configure", 0, this, SLOT( slotPreferences() ),
                actionCollection(), "settings_configure_kontact" );
 
+  new KAction( i18n( "Configure &Profiles..." ), 0, this, SLOT( slotConfigureProfiles() ),
+               actionCollection(), "settings_configure_kontact_profiles" );
+
   new KAction( i18n( "&Kontact Introduction" ), 0, this, SLOT( slotShowIntroduction() ),
                actionCollection(), "help_introduction" );
   new KAction( i18n( "&Tip of the Day" ), 0, this, SLOT( slotShowTip() ),
                actionCollection(), "help_tipofday" );
   new KAction( i18n( "&Request Feature..." ), 0, this, SLOT( slotRequestFeature() ),
                actionCollection(), "help_requestfeature" );
+  
+  KWidgetAction* spacerAction = new KWidgetAction( new QWidget( this ), "SpacerAction", "", 0, 0, actionCollection(), "navigator_spacer_item" );
+  spacerAction->setAutoSized( true );
 }
 
+void MainWindow::slotConfigureProfiles()
+{
+  QGuardedPtr<Kontact::ProfileDialog> dlg = new Kontact::ProfileDialog( this );
+  dlg->setModal( true );
+  dlg->exec();
+  delete dlg;
+}
+
+namespace {
+    void copyConfigEntry( KConfig* source, KConfig* dest, const QString& group, const QString& key, const QString& defaultValue=QString() )
+    {
+        source->setGroup( group );
+        dest->setGroup( group );
+        dest->writeEntry( key, source->readEntry( key, defaultValue ) );
+    }
+}
+
+void MainWindow::slotSaveToProfile( const QString& id )
+{
+  const QString path = Kontact::ProfileManager::self()->profileById( id ).saveLocation();
+  if ( path.isNull() )
+    return;
+
+  KConfig* const cfg = Prefs::self()->config();
+  Prefs::self()->writeConfig();
+  saveMainWindowSettings( cfg );
+  saveSettings();
+
+  KConfig profile( path+"/kontactrc", /*read-only=*/false, /*useglobals=*/false );
+  ::copyConfigEntry( cfg, &profile, "MainWindow Toolbar navigatorToolBar", "Hidden", "true" );
+  ::copyConfigEntry( cfg, &profile, "View", "SidePaneSplitter" );
+  ::copyConfigEntry( cfg, &profile, "Icons", "Theme" );
+  
+  for ( PluginList::Iterator it = mPlugins.begin(); it != mPlugins.end(); ++it ) {
+    if ( !(*it)->isRunningStandalone() ) {
+        (*it)->part();
+    }
+    (*it)->saveToProfile( path );
+  }
+}
+
+void MainWindow::slotLoadProfile( const QString& id )
+{
+  const QString path = Kontact::ProfileManager::self()->profileById( id ).saveLocation();
+  if ( path.isNull() )
+    return;
+
+  KConfig* const cfg = Prefs::self()->config();
+  Prefs::self()->writeConfig();
+  saveMainWindowSettings( cfg );
+  saveSettings();
+
+  const KConfig profile( path+"/kontactrc", /*read-only=*/false, /*useglobals=*/false );
+  const QStringList groups = profile.groupList();
+  for ( QStringList::ConstIterator it = groups.begin(), end = groups.end(); it != end; ++it )
+  {
+    cfg->setGroup( *it );
+    typedef QMap<QString, QString> StringMap;
+    const StringMap entries = profile.entryMap( *it );
+    for ( StringMap::ConstIterator it2 = entries.begin(), end = entries.end(); it2 != end; ++it2 )
+    {
+      if ( it2.data() == "KONTACT_PROFILE_DELETE_KEY" )
+        cfg->deleteEntry( it2.key() );
+      else
+        cfg->writeEntry( it2.key(), it2.data() );
+    }
+  }
+
+  cfg->sync();
+  Prefs::self()->readConfig();
+  applyMainWindowSettings( cfg );
+  KIconTheme::reconfigure();
+  const WId wid = winId();
+  KIPC::sendMessage( KIPC::PaletteChanged, wid );
+  KIPC::sendMessage( KIPC::FontChanged, wid );
+  KIPC::sendMessage( KIPC::StyleChanged, wid );
+  KIPC::sendMessage( KIPC::SettingsChanged, wid );
+  for ( int i = 0; i < KIcon::LastGroup; ++i )
+      KIPC::sendMessage( KIPC::IconChanged, wid, i );
+
+  loadSettings();
+
+  for ( PluginList::Iterator it = mPlugins.begin(); it != mPlugins.end(); ++it ) {
+    if ( !(*it)->isRunningStandalone() ) {
+        kdDebug() << "Ensure loaded: " << (*it)->identifier() << endl;
+        (*it)->part();
+    }
+    (*it)->loadProfile( path );
+  }
+}
+
 bool MainWindow::isPluginLoaded( const KPluginInfo *info )
 {
   return (pluginFromInfo( info ) != 0);
@@ -409,10 +525,19 @@
       action->plug( mNewActions->popupMenu() );
     }
 
+    if ( mSyncActionsEnabled ) {
+      actionList = plugin->syncActions();
+      for ( action = actionList->first(); action; action = actionList->next() ) {
+        kdDebug(5600) << "Plugging " << action->name() << endl;
+        action->plug( mSyncActions->popupMenu() );
+      }
+    }
     addPlugin( plugin );
   }
 
   mNewActions->setEnabled( mPlugins.size() != 0 );
+  if ( mSyncActionsEnabled )
+    mSyncActions->setEnabled( mPlugins.size() != 0 );
 }
 
 void MainWindow::unloadPlugins()
@@ -440,6 +565,13 @@
         action->unplug( mNewActions->popupMenu() );
       }
 
+      if ( mSyncActionsEnabled ) {
+        actionList = plugin->syncActions();
+        for ( action = actionList->first(); action; action = actionList->next() ) {
+          kdDebug(5600) << "Unplugging " << action->name() << endl;
+          action->unplug( mSyncActions->popupMenu() );
+        }
+      }
       removeChildClient( plugin );
 
       if ( mCurrentPlugin == plugin )
@@ -519,6 +651,29 @@
   }
 }
 
+void MainWindow::slotSyncClicked()
+{
+  KAction *action = mCurrentPlugin->syncActions()->first();
+  if ( action ) {
+    action->activate();
+  } else {
+    PluginList::Iterator it;
+    for ( it = mPlugins.begin(); it != mPlugins.end(); ++it ) {
+      action = (*it)->syncActions()->first();
+      if ( action ) {
+        action->activate();
+        return;
+      }
+    }
+  }
+}
+
+KToolBar* Kontact::MainWindow::findToolBar(const char* name)
+{
+  // like KMainWindow::toolBar, but which doesn't create the toolbar if not found
+  return static_cast<KToolBar *>(child(name, "KToolBar"));
+}
+
 void MainWindow::selectPlugin( Kontact::Plugin *plugin )
 {
   if ( !plugin )
@@ -540,6 +695,8 @@
     KMessageBox::error( this, i18n( "Cannot load part for %1." )
                               .arg( plugin->title() )
                         + "\n" + lastErrorMessage() );
+    plugin->setDisabled( true );
+    mSidePane->updatePlugins();
     return;
   }
 
@@ -577,28 +734,51 @@
       view->setFocus();
 
     mCurrentPlugin = plugin;
-    KAction *action = plugin->newActions()->first();
+    KAction *newAction = plugin->newActions()->first();
+    KAction *syncAction = plugin->syncActions()->first();
 
     createGUI( plugin->part() );
 
+    KToolBar* navigatorToolBar = findToolBar( "navigatorToolBar" );
+    // Let the navigator toolbar be always the last one, if it's in the top dockwindow
+    if ( navigatorToolBar && !navigatorToolBar->isHidden() &&
+         navigatorToolBar->barPos() == KToolBar::Top ) {
+      topDock()->moveDockWindow( navigatorToolBar, -1 );
+    }
+
     setCaption( i18n( "Plugin dependent window title" ,"%1 - Kontact" ).arg( plugin->title() ) );
 
-    if ( action ) {
-      mNewActions->setIcon( action->icon() );
-      mNewActions->setText( action->text() );
+    if ( newAction ) {
+      mNewActions->setIcon( newAction->icon() );
+      mNewActions->setText( newAction->text() );
     } else { // we'll use the action of the first plugin which offers one
       PluginList::Iterator it;
       for ( it = mPlugins.begin(); it != mPlugins.end(); ++it ) {
-        action = (*it)->newActions()->first();
-        if ( action ) {
-          mNewActions->setIcon( action->icon() );
-          mNewActions->setText( action->text() );
+        newAction = (*it)->newActions()->first();
+        if ( newAction ) {
+          mNewActions->setIcon( newAction->icon() );
+          mNewActions->setText( newAction->text() );
           break;
         }
       }
     }
+    if ( mSyncActionsEnabled ) {
+      if ( syncAction ) {
+        mSyncActions->setIcon( syncAction->icon() );
+        mSyncActions->setText( syncAction->text() );
+      } else { // we'll use the action of the first plugin which offers one
+        PluginList::Iterator it;
+        for ( it = mPlugins.begin(); it != mPlugins.end(); ++it ) {
+          syncAction = (*it)->syncActions()->first();
+          if ( syncAction ) {
+            mSyncActions->setIcon( syncAction->icon() );
+            mSyncActions->setText( syncAction->text() );
+            break;
+          }
+        }
+      }
+    }
   }
-
   QStringList invisibleActions = plugin->invisibleToolbarActions();
 
   QStringList::ConstIterator it;
@@ -686,8 +866,6 @@
 {
   static SettingsDialogWrapper *dlg = 0;
   if ( !dlg ) {
-    dlg = new SettingsDialogWrapper( KSettings::Dialog::Configurable, this );
-
     // do not show settings of components running standalone
     QValueList<KPluginInfo*> filteredPlugins = mPluginInfos;
     PluginList::ConstIterator it;
@@ -701,7 +879,7 @@
           }
         }
       }
-
+    dlg = new SettingsDialogWrapper( KSettings::Dialog::Configurable, this );
     dlg->addPluginInfos( filteredPlugins );
     connect( dlg, SIGNAL( pluginSelectionChanged() ),
              SLOT( pluginsChanged() ) );
@@ -919,5 +1097,4 @@
   return info;
 }
 
-
 #include "mainwindow.moc"
Index: kontact/src/profiledialog.cpp
===================================================================
--- kontact/src/profiledialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/profiledialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,267 @@
+/*
+    This file is part of KDE Kontact.
+
+    Copyright (c) 2007 Frank Osterfeld <frank.osterfeld@kdemail.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "profiledialog.h"
+#include "profilemanager.h"
+
+#include <kfiledialog.h>
+#include <klistview.h>
+#include <klocale.h>
+#include <kmessagebox.h>
+
+#include <qlayout.h>
+#include <qpushbutton.h>
+#include <qstring.h>
+
+Kontact::ProfileDialog::ProfileDialog( QWidget* parent, WFlags flags ) : KDialogBase( parent, /*name=*/0, /*modal=*/true, /*caption=*/QString(), /*buttonMask=*/KDialogBase::Ok|KDialogBase::Close )
+{
+    setWFlags( flags );
+    setCaption( i18n("Configure Profiles") );
+    setButtonOK( i18n("Load Profile") );
+
+    QWidget* mainWidget = new QWidget( this );
+
+    QHBoxLayout* horizontalLayout = new QHBoxLayout( mainWidget );
+    horizontalLayout->setSpacing( 5 );
+
+    m_list = new KListView( mainWidget );
+    m_list->addColumn( i18n("Name") );
+    m_list->addColumn( i18n("Description") );
+    m_list->setSelectionMode( QListView::Single );
+    m_list->setItemsRenameable( true );
+    m_list->setRenameable( NameColumn, true );
+    m_list->setRenameable( DescriptionColumn, true );
+
+    connect( m_list, SIGNAL( selectionChanged() ), 
+             this, SLOT( listSelectionChanged() ) );
+    connect( m_list, SIGNAL( itemRenamed( QListViewItem*, const QString&, int ) ),
+             this, SLOT( listItemRenamed( QListViewItem*, const QString&, int ) ) );
+    horizontalLayout->addWidget( m_list );
+
+    QVBoxLayout* buttonLayout = new QVBoxLayout( horizontalLayout );
+    buttonLayout->setSpacing( 5 );
+
+    m_newProfileButton = new QPushButton( mainWidget );
+    m_newProfileButton->setText( i18n("New Profile") );
+    connect( m_newProfileButton, SIGNAL( clicked() ),
+             this, SLOT( addNewProfile() ) );
+    buttonLayout->addWidget( m_newProfileButton );
+
+    m_deleteProfileButton = new QPushButton( mainWidget );
+    m_deleteProfileButton->setText( i18n("Delete Profile") );
+    m_deleteProfileButton->setEnabled( false );
+    connect( m_deleteProfileButton, SIGNAL( clicked() ),
+             this, SLOT( deleteSelectedProfile() ) );
+    buttonLayout->addWidget( m_deleteProfileButton );
+
+    m_saveProfileButton = new QPushButton( mainWidget );
+    m_saveProfileButton->setText( i18n("Save Profile") );
+    m_saveProfileButton->setEnabled( false );
+    connect( m_saveProfileButton, SIGNAL( clicked() ),
+             this, SLOT( saveToSelectedProfile() ) );
+    buttonLayout->addWidget( m_saveProfileButton );
+
+    buttonLayout->addStretch();
+
+    m_importProfileButton = new QPushButton( mainWidget );
+    m_importProfileButton->setText( i18n("Import Profile") );
+    connect( m_importProfileButton, SIGNAL( clicked() ),
+             this, SLOT( importProfile() ) );
+    buttonLayout->addWidget( m_importProfileButton );
+
+    m_exportProfileButton = new QPushButton( mainWidget );
+    m_exportProfileButton->setText( i18n("Export Profile") );
+    m_exportProfileButton->setEnabled( false );
+    connect( m_exportProfileButton, SIGNAL( clicked() ),
+             this, SLOT( exportSelectedProfile() ) );
+    buttonLayout->addWidget( m_exportProfileButton );
+
+    setMainWidget( mainWidget );
+
+    connect( Kontact::ProfileManager::self(), SIGNAL( profileAdded( const QString& ) ), 
+             this, SLOT( profileAdded( const QString& ) ) );
+    connect( Kontact::ProfileManager::self(), SIGNAL( profileRemoved( const QString& ) ), 
+             this, SLOT( profileRemoved( const QString& ) ) );
+    connect( Kontact::ProfileManager::self(), SIGNAL( profileLoaded( const QString& ) ), 
+             this, SLOT( profileLoaded( const QString& ) ) );
+    connect( Kontact::ProfileManager::self(), SIGNAL( profileUpdated( const QString& ) ), 
+             this, SLOT( profileUpdated( const QString& ) ) );
+
+    const QValueList<Kontact::Profile> profiles = Kontact::ProfileManager::self()->profiles();
+    for ( QValueList<Kontact::Profile>::ConstIterator it = profiles.begin(), end = profiles.end(); it != end; ++it )
+    {
+        profileAdded( (*it).id() );
+    }
+    updateButtonState();
+}
+
+void Kontact::ProfileDialog::slotOk()
+{
+    loadSelectedProfile();
+    KDialogBase::slotOk();
+}
+
+QString Kontact::ProfileDialog::selectedProfile() const
+{
+    return m_itemToProfile[m_list->selectedItem()];
+}
+
+void Kontact::ProfileDialog::loadSelectedProfile()
+{
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( selectedProfile() );
+    if ( profile.isNull() )
+        return;
+    Kontact::ProfileManager::self()->loadProfile( profile.id() );
+}
+
+void Kontact::ProfileDialog::profileLoaded( const QString& id )
+{
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( id );
+    if ( profile.isNull() )
+        return;
+    KMessageBox::information( this, i18n("The profile \"%1\" was successfully loaded. Some profile settings require a restart to get activated.").arg( profile.name() ), i18n("Profile Loaded") );
+}
+
+void Kontact::ProfileDialog::saveToSelectedProfile()
+{
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( selectedProfile() );
+    if ( profile.isNull() )
+        return;
+    if ( KMessageBox::Yes != KMessageBox::warningYesNo( this, i18n("The profile \"%1\" will be overwritten with the current settings. Are you sure?").arg( profile.name() ), i18n("Save to Profile"), KStdGuiItem::overwrite(), KStdGuiItem::cancel() ) )
+        return;
+    Kontact::ProfileManager::self()->saveToProfile( profile.id() );
+}
+
+void Kontact::ProfileDialog::deleteSelectedProfile()
+{
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( selectedProfile() );
+    if ( profile.isNull() )
+        return;
+    if ( KMessageBox::Yes != KMessageBox::warningYesNo( this, i18n("Do you really want to delete the profile \"%1\"? All profile settings will be lost!").arg( profile.name() ), i18n("Delete Profile"), KStdGuiItem::del(), KStdGuiItem::cancel() ) )
+        return;
+    Kontact::ProfileManager::self()->removeProfile( profile );
+}
+
+void Kontact::ProfileDialog::exportSelectedProfile()
+{
+    const QString id = selectedProfile();
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( id );
+    if ( profile.isNull() )
+        return;
+    const QString path = KFileDialog::getExistingDirectory( QString(), this, i18n("Select Profile Folder") );
+    if ( path.isNull() )
+        return;
+    const Kontact::ProfileManager::ExportError error = Kontact::ProfileManager::self()->exportProfileToDirectory( id, path );
+    if ( error == Kontact::ProfileManager::SuccessfulExport )
+    {
+        KMessageBox::information( this, i18n("The profile \"%1\" was successfully exported.").arg( profile.name() ), i18n("Profile Exported") );
+    }
+    else
+    {
+        // TODO print error
+    }
+}
+
+void Kontact::ProfileDialog::importProfile()
+{
+    const QString path = KFileDialog::getExistingDirectory( QString(), this, i18n("Select Profile Folder") );
+    if ( path.isNull() )
+        return;
+    const Kontact::ProfileManager::ImportError error = Kontact::ProfileManager::self()->importProfileFromDirectory( path );
+    if ( error != Kontact::ProfileManager::SuccessfulImport )
+    {
+        // TODO print error
+    }
+}
+
+void Kontact::ProfileDialog::profileAdded( const QString& id )
+{
+    Q_ASSERT( !m_profileToItem[id] );
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( id );
+    Q_ASSERT( !profile.isNull() );
+    QListViewItem* const item = new QListViewItem( m_list );
+    m_profileToItem[id] = item;
+    m_itemToProfile[item] = id;
+    profileUpdated( id );
+}
+
+void Kontact::ProfileDialog::profileRemoved( const QString& id )
+{
+    QListViewItem* item = m_profileToItem[id];
+    Q_ASSERT( item );
+    m_profileToItem.remove( id );
+    m_itemToProfile.remove( item );
+    delete item;
+}
+
+void Kontact::ProfileDialog::profileUpdated( const QString& id )
+{
+    QListViewItem* item = m_profileToItem[id];
+    Q_ASSERT( item );
+    const Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( id );
+    Q_ASSERT( !profile.isNull() );
+    item->setText( NameColumn, profile.name() );
+    item->setText( DescriptionColumn, profile.description() );
+}
+
+void Kontact::ProfileDialog::addNewProfile()
+{
+    Kontact::Profile profile( Kontact::ProfileManager::self()->generateNewId(), true );
+    profile.setName( i18n("New profile") );
+    profile.setDescription( i18n("Enter description") );
+    Kontact::ProfileManager::self()->addProfile( profile );
+}
+
+void Kontact::ProfileDialog::listItemRenamed( QListViewItem* item, const QString& text, int col )
+{
+    Kontact::Profile profile = Kontact::ProfileManager::self()->profileById( m_itemToProfile[item] );
+    Q_ASSERT( !profile.isNull() );
+    switch ( col )
+    {
+        case NameColumn:
+            profile.setName( text );
+            Kontact::ProfileManager::self()->updateProfile( profile );
+            break;
+        case DescriptionColumn:
+            profile.setDescription( text );
+            Kontact::ProfileManager::self()->updateProfile( profile );
+            break;
+    }
+}
+
+void Kontact::ProfileDialog::updateButtonState()
+{
+    const bool hasSelection = m_list->selectedItem() != 0;
+    m_deleteProfileButton->setEnabled( hasSelection );
+    m_saveProfileButton->setEnabled( hasSelection);
+    actionButton( KDialogBase::Ok )->setEnabled( hasSelection );
+    m_exportProfileButton->setEnabled( hasSelection );
+}
+
+void Kontact::ProfileDialog::listSelectionChanged()
+{
+    updateButtonState();
+}
+
+#include "profiledialog.moc"
Index: kontact/src/mainwindow.h
===================================================================
--- kontact/src/mainwindow.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -34,6 +34,7 @@
 #include <kdcopservicestarter.h>
 
 #include "core.h"
+#include "kontactiface.h"
 
 class QHBox;
 class QSplitter;
@@ -61,7 +62,7 @@
 
 typedef QValueList<Kontact::Plugin*> PluginList;
 
-class MainWindow : public Kontact::Core, public KDCOPServiceStarter
+class MainWindow : public Kontact::Core, public KDCOPServiceStarter, public KontactIface
 {
   Q_OBJECT
 
@@ -91,9 +92,13 @@
     void slotActivePartChanged( KParts::Part *part );
     void slotPreferences();
     void slotNewClicked();
+    void slotSyncClicked();
     void slotQuit();
     void slotShowTip();
     void slotRequestFeature();
+    void slotConfigureProfiles();
+    void slotLoadProfile( const QString& id );
+    void slotSaveToProfile( const QString& id );
     void slotNewToolbarConfig();
     void slotShowIntroduction();
     void showAboutDialog();
@@ -101,7 +106,7 @@
     void activatePluginModule();
     void slotOpenUrl( const KURL &url );
 
-  protected:
+  private:
     void initWidgets();
     void initAboutScreen();
     void loadSettings();
@@ -121,6 +126,7 @@
     virtual void saveProperties( KConfig *config );
     void paintAboutScreen( const QString& msg );
     static QString introductionString();
+    KToolBar* findToolBar(const char* name);
 
   private slots:
     void pluginsChanged();
@@ -134,6 +140,7 @@
     QSplitter *mSplitter;
 
     KToolBarPopupAction *mNewActions;
+    KToolBarPopupAction *mSyncActions;
     SidePaneBase *mSidePane;
     QWidgetStack *mPartsStack;
     Plugin *mCurrentPlugin;
@@ -152,6 +159,7 @@
 
     AboutDialog *mAboutDialog;
     bool mReallyClose;
+    bool mSyncActionsEnabled;
 };
 
 }
Index: kontact/src/kontactui.rc
===================================================================
--- kontact/src/kontactui.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/kontactui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <!DOCTYPE gui SYSTEM "kpartgui.dtd">
-<gui version="19" name="kontact" >
+<gui version="22" name="kontact" >
 <MenuBar>
   <Menu name="file" noMerge="1">
     <text>&amp;File</text>
@@ -18,6 +18,7 @@
 <!-- <Separator/> -->
      <DefineGroup name="settings_configure" append="configure_merge"/>
      <Action name="settings_configure_kontact" append="configure_merge"/>
+     <Action name="settings_configure_kontact_profiles" append="configure_merge"/>
 
 <!-- Those actions have to be set by the parts because some applications
      have app.rc == part.rc
@@ -36,10 +37,12 @@
 </MenuBar>
 <ToolBar position="Top" noMerge="1" name="mainToolBar"><text>Main Toolbar</text>
   <Action name="action_new"/>
+  <Action name="action_sync"/>
   <Merge/>
   <Action name="help_whats_this"/>
 </ToolBar>
 <ToolBar position="Top" hidden="true" name="navigatorToolBar"><text>Navigator</text>
+  <Action name="navigator_spacer_item"/>
   <ActionList name="navigator_actionlist" />
 </ToolBar>
 </gui>
Index: kontact/src/main.cpp
===================================================================
--- kontact/src/main.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,7 +46,7 @@
 static const char description[] =
     I18N_NOOP( "KDE personal information manager" );
 
-static const char version[] = "1.2.5";
+static const char version[] = "1.2.4 (enterprise 0.20080118.763038)";
 
 class KontactApp : public KUniqueApplication {
   public:
Index: kontact/src/profiledialog.h
===================================================================
--- kontact/src/profiledialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/profiledialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,90 @@
+/*
+    This file is part of KDE Kontact.
+
+    Copyright (c) 2007 Frank Osterfeld <frank.osterfeld@kdemail.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#ifndef KONTACT_PROFILEDIALOG_H
+#define KONTACT_PROFILEDIALOG_H
+
+#include <kdialogbase.h>
+
+#include <qmap.h>
+#include <qstring.h>
+
+class QListViewItem;
+
+class KListView;
+class QPushButton;
+
+namespace Kontact {
+
+class ProfileDialog : public KDialogBase
+{
+Q_OBJECT
+
+public:
+    explicit ProfileDialog( QWidget* parent = 0, WFlags f = 0 );
+
+private:
+    enum ListColumn {
+        NameColumn=0,
+        DescriptionColumn=1
+    };
+
+    QString selectedProfile() const;
+    void updateButtonState();
+
+protected slots:
+
+    //override
+    void slotOk();
+
+private slots:
+
+    void loadSelectedProfile();
+    void saveToSelectedProfile();
+    void deleteSelectedProfile();
+    void importProfile();
+    void exportSelectedProfile();
+    void addNewProfile();
+    void listSelectionChanged();
+    void listItemRenamed( QListViewItem* item, const QString& text, int col );
+
+    void profileAdded( const QString& id );
+    void profileRemoved( const QString& id );
+    void profileUpdated( const QString& id );
+    void profileLoaded( const QString& id );
+
+private:
+    KListView* m_list;
+    QPushButton* m_newProfileButton;
+    QPushButton* m_deleteProfileButton;
+    QPushButton* m_saveProfileButton;
+    QPushButton* m_importProfileButton;
+    QPushButton* m_exportProfileButton;
+    QMap<QListViewItem*, QString> m_itemToProfile;
+    QMap<QString, QListViewItem*> m_profileToItem;
+};
+
+} // Kontact
+
+#endif // KONTACT_PROFILEDIALOG_H
Index: kontact/src/Makefile.am
===================================================================
--- kontact/src/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,7 +15,8 @@
   $(top_builddir)/kontact/interfaces/libkpinterfaces.la libkontact.la \
   $(LIB_KPARTS) $(LIB_KUTILS) $(LIB_KHTML)
 kontact_SOURCES = main.cpp mainwindow.cpp sidepanebase.cpp \
-  iconsidepane.cpp aboutdialog.cpp
+  iconsidepane.cpp aboutdialog.cpp profilemanager.cpp profiledialog.cpp \
+  kontactiface.skel
 kontact_COMPILE_FIRST = prefs.h
 
 kde_module_LTLIBRARIES = kcm_kontact.la
@@ -29,7 +30,7 @@
 rcdir = $(kde_datadir)/kontact
 rc_DATA = kontactui.rc
 
-xdg_apps_DATA = Kontact.desktop
+xdg_apps_DATA = Kontact.desktop kontactdcop.desktop
 
 kde_kcfg_DATA = kontact.kcfg
 
Index: kontact/src/Kontact.desktop
===================================================================
--- kontact/src/Kontact.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/src/Kontact.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -23,6 +23,7 @@
 GenericName[da]=Personlig informationsh√•ndtering
 GenericName[de]=Pers√∂nlicher Informationsmanager
 GenericName[el]=Œ†œÅŒøœÉœâœÄŒπŒ∫œåœÇ Œ¥ŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ œÄŒªŒ∑œÅŒøœÜŒøœÅŒπœéŒΩ
+GenericName[eo]=Persona Inform-Mastrumilo
 GenericName[es]=Gestor de informaci√≥n personal
 GenericName[et]=Personaalse info haldur
 GenericName[eu]=Informazio pertsonalaren kudeatzailea
Index: kontact/src/profilemanager.cpp
===================================================================
--- kontact/src/profilemanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ kontact/src/profilemanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,340 @@
+/*
+    This file is part of KDE Kontact.
+
+    Copyright (c) 2007 Frank Osterfeld <frank.osterfeld@kdemail.net>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+#include "profilemanager.h"
+
+#include <kio/job.h>
+
+#include <kapplication.h>
+#include <kconfig.h>
+#include <kglobal.h>
+#include <kstandarddirs.h>
+#include <kstaticdeleter.h>
+#include <kurl.h>
+
+#include <qdir.h>
+#include <qstringlist.h>
+#include <qvaluelist.h>
+
+Kontact::Profile::Profile( const QString& id, bool isLocal ) : m_id( id ), m_local( isLocal )
+{
+}
+
+Kontact::Profile::Profile() : m_local( false )
+{
+}
+
+QString Kontact::Profile::id() const
+{
+    return m_id;
+}
+
+QString Kontact::Profile::name() const
+{
+    return m_name;
+}
+
+QString Kontact::Profile::description() const
+{
+    return m_description;
+}
+
+bool Kontact::Profile::isNull() const
+{
+    return m_id.isNull();
+}
+
+void Kontact::Profile::setId( const QString& id )
+{
+    m_id = id;
+}
+
+void Kontact::Profile::setDescription( const QString& description )
+{
+    m_description = description;
+}
+
+void Kontact::Profile::setName( const QString& name )
+{
+    m_name = name;
+}
+
+void Kontact::Profile::setLocal( SetLocalMode mode )
+{
+    if ( m_local )
+        return;
+
+    if ( mode == CopyProfileFiles )
+        copyConfigFiles( m_originalLocation, localSaveLocation() );
+
+    m_local = true;
+}
+
+bool Kontact::Profile::isLocal() const
+{
+    return m_local;
+}
+
+void Kontact::Profile::setOriginalLocation( const QString& path )
+{
+    m_originalLocation = path;
+}
+
+QString Kontact::Profile::localSaveLocation() const
+{
+
+    return  m_id.isNull() ? QString() : locateLocal( "data", "kontact/profiles/" + m_id, /*create folder=*/true );
+}
+
+QString Kontact::Profile::saveLocation() const
+{
+    return m_local ? localSaveLocation() : m_originalLocation;
+}
+
+bool Kontact::Profile::operator==( const Kontact::Profile& other ) const
+{
+    return m_id == other.m_id && m_name == other.m_name && m_description == other.m_description;
+}
+
+Kontact::ProfileManager* Kontact::ProfileManager::m_self = 0;
+
+static KStaticDeleter<Kontact::ProfileManager> profileManagerSD;
+
+Kontact::ProfileManager* Kontact::ProfileManager::self() 
+{
+    if ( m_self == 0 )
+    {
+        profileManagerSD.setObject( m_self, new Kontact::ProfileManager );
+        m_self->readConfig();
+    }
+    return m_self;
+}
+
+Kontact::ProfileManager::ProfileManager( QObject* parent ) : QObject( parent )
+{
+}
+
+Kontact::ProfileManager::~ProfileManager()
+{
+    writeConfig();
+}
+
+void Kontact::ProfileManager::writeConfig() const
+{
+    const QValueList<Kontact::Profile> profiles = m_profiles.values();
+    for ( QValueList<Kontact::Profile>::ConstIterator it = profiles.begin(), end = profiles.end(); it != end; ++it )
+    {
+        writeProfileConfig( *it );
+    }
+}
+
+Kontact::Profile Kontact::ProfileManager::readFromConfiguration( const QString& configFile, bool isLocal )
+{
+    KConfig profileCfg( configFile, true /*read-only*/, false /*no KDE global*/ );
+    const QString configDir = configFile.left( configFile.findRev( QDir::separator(), -1 ) );
+    profileCfg.setGroup( "Kontact Profile" );
+    const QString id = profileCfg.readEntry( "Identifier" );
+    Kontact::Profile profile( id );
+    profile.setName( profileCfg.readEntry( "Name" ) );
+    profile.setDescription( profileCfg.readEntry( "Description" ) );
+    profile.setOriginalLocation( configDir );
+    if ( isLocal )
+        profile.setLocal( Kontact::Profile::DoNotCopyProfileFiles );
+    return profile;
+}
+
+void Kontact::ProfileManager::writeProfileConfig( const Kontact::Profile& profile ) const
+{
+    const QString profileDir = profile.saveLocation();
+    const QString cfgPath = profileDir + "/profile.cfg";
+    KConfig profileCfg( cfgPath, false /*read-only*/, false /*no KDE global*/ );
+    profileCfg.setGroup( "Kontact Profile" );
+    profileCfg.writeEntry( "Identifier", profile.id() );
+    profileCfg.writeEntry( "Name", profile.name() );
+    profileCfg.writeEntry( "Description", profile.description() );
+}
+
+void Kontact::ProfileManager::readConfig()
+{
+    
+    const QStringList profilePaths = KGlobal::dirs()->findAllResources( "data", QString::fromLatin1( "kontact/profiles/*/profile.cfg" ) );
+
+    typedef QMap<QString, Kontact::Profile> ProfileMap;
+    ProfileMap profiles;
+    ProfileMap globalProfiles;
+
+    const QString localPrefix = locateLocal( "data", "kontact/profiles/", /*createDir=*/false );
+    for ( QStringList::ConstIterator it = profilePaths.begin(), end = profilePaths.end(); it != end; ++it )
+    {
+        const bool isLocal = (*it).startsWith( localPrefix );
+        const Kontact::Profile profile = readFromConfiguration( *it, isLocal );
+        if ( profile.isNull() )
+            continue;
+        if ( isLocal )
+            profiles[profile.id()] = profile;
+        else 
+            globalProfiles[profile.id()] = profile;
+    }
+    
+    for ( ProfileMap::ConstIterator it = globalProfiles.begin(), end = globalProfiles.end(); it != end; ++it )
+    {
+        if ( !profiles.contains( it.key() ) )
+            profiles[it.key()] = it.data();
+    }
+
+    for ( ProfileMap::ConstIterator it = profiles.begin(), end = profiles.end(); it != end; ++it )
+    {
+        addProfile( *it, false /*dont sync config */ );
+    }
+}
+
+QValueList<Kontact::Profile> Kontact::ProfileManager::profiles() const
+{
+    return m_profiles.values();
+}
+
+Kontact::Profile Kontact::ProfileManager::profileById( const QString& id ) const
+{
+    return m_profiles[id];
+}
+
+void Kontact::ProfileManager::updateProfile( const Kontact::Profile& profile_ )
+{
+    const QString id = profile_.id();
+    if ( id.isNull() || m_profiles[id] == profile_ )
+        return;
+    Kontact::Profile profile( profile_ );
+    m_profiles[id] = profile;
+    profile.setLocal( Kontact::Profile::CopyProfileFiles );
+    writeProfileConfig( profile );
+    emit profileUpdated( id );
+}
+
+void Kontact::Profile::copyConfigFiles( const QString& source_, const QString& dest_ )
+{
+    const KURL source = KURL::fromPathOrURL( source_+"/*rc" );
+    const KURL dest = KURL::fromPathOrURL( dest_ );
+    KIO::CopyJob* job = KIO::copy( source, dest, /*showProgressInfo=*/false );
+    // TODO better check for the copy result
+}
+
+void Kontact::ProfileManager::saveToProfile( const QString& id )
+{
+    Kontact::Profile profile = profileById( id );
+    if ( profile.isNull() )
+        return;
+    profile.setLocal( Kontact::Profile::CopyProfileFiles );
+    writeProfileConfig( profile );
+    emit saveToProfileRequested( id );
+}
+
+bool Kontact::ProfileManager::addProfile( const Kontact::Profile& profile, bool syncConfig )
+{
+    const QString id = profile.id();
+    if ( m_profiles.contains( id ) )
+        return false;
+    m_profiles[id] = profile;
+    emit profileAdded( id );
+    emit saveToProfileRequested( id );
+    if ( syncConfig ) {
+        writeProfileConfig( profile );
+    }
+
+    return true;
+}
+
+void Kontact::ProfileManager::loadProfile( const QString& id )
+{
+    if ( !m_profiles.contains( id ) )
+        return;
+    emit profileLoaded( id );
+}
+
+void Kontact::ProfileManager::removeProfile( const Kontact::Profile& profile )
+{
+    removeProfile( profile.id() );
+}
+
+void Kontact::ProfileManager::removeProfile( const QString& id )
+{
+    if ( !m_profiles.contains( id ) )
+        return;
+    Kontact::Profile profile = profileById( id );
+    if ( profile.isLocal() ) {
+        KURL location = KURL::fromPathOrURL( profile.saveLocation() );
+        KIO::DeleteJob* job = KIO::del( location, /*shred*/ false, /*showProgressInfo=*/false );
+        // TODO check result
+    }
+    m_profiles.remove( id );
+    emit profileRemoved( id );
+ }
+
+Kontact::ProfileManager::ExportError Kontact::ProfileManager::exportProfileToDirectory( const QString& id, const QString& path )
+{
+    if ( !m_profiles.contains( id ) )
+        return SuccessfulExport;
+
+    if ( !QDir( path ).exists() )
+        return DirectoryDoesNotExist;
+
+    const Kontact::Profile profile = profileById( id );
+    const KURL source = KURL::fromPathOrURL( profile.saveLocation() );
+    const KURL target = KURL::fromPathOrURL( path + QDir::separator() + profile.name() );
+
+    KIO::CopyJob* job = KIO::copy( source, target, /*showProgressInfo=*/false );
+    // TODO check result
+
+    return SuccessfulExport;
+}
+
+Kontact::ProfileManager::ImportError Kontact::ProfileManager::importProfileFromDirectory( const QString& path )
+{
+    Kontact::Profile profile = readFromConfiguration( path + "/profile.cfg", /*isLocal=*/ true );
+    if ( profile.isNull() )
+        return NoValidProfile;
+
+    profile.setId( generateNewId() );
+
+    const KURL source = KURL::fromPathOrURL( path );
+    const KURL target = KURL::fromPathOrURL( profile.saveLocation() );
+
+    KIO::CopyJob* job = KIO::copy( source, target, /*showProgressInfo=*/false );
+    // TODO better check for the copy result
+
+    addProfile( profile );
+
+    return SuccessfulImport;
+}
+
+QString Kontact::ProfileManager::generateNewId() const
+{
+    while ( true )
+    {
+        const QString newId = KApplication::randomString( 10 );
+        if ( !m_profiles.contains( newId ) )
+            return newId;
+    }
+}
+
+#include "profilemanager.moc"
Index: kontact/Makefile.am
===================================================================
--- kontact/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kontact/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-SUBDIRS = interfaces plugins src pics
+SUBDIRS = interfaces plugins src pics profiles
 
 DOXYGEN_REFERENCES = kdeui kparts libkcal
 include $(top_srcdir)/admin/Doxyfile.am
Index: kandy/src/kandy.desktop
===================================================================
--- kandy/src/kandy.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kandy/src/kandy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,7 +1,6 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Kandy
-Name[eo]=Po≈ùtelefonilo
 Name[hi]=‡§ï‡•á‡§Ç‡§°‡•Ä
 Name[ne]=‡§ï‡•á‡§®‡•ç‡§°‡•Ä
 Name[ta]=K‡ÆÖ‡Æ©‡Øç‡Æü‡Æø
Index: ktnef/tests/parsertest.h
===================================================================
--- ktnef/tests/parsertest.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ ktnef/tests/parsertest.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,32 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#ifndef PARSERTEST_H
+#define PARSERTEST_H
+
+class ParserTest
+{
+  public:
+    void testSingleAttachment();
+    void testTwoAttachments();
+    void testMAPIAttachments();
+};
+
+
+#endif
Index: ktnef/tests/two-files.tnef
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: ktnef/tests/two-files.tnef
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: ktnef/tests/mapi_attach_data_obj.tnef
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: ktnef/tests/mapi_attach_data_obj.tnef
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: ktnef/tests/Makefile.am
===================================================================
--- ktnef/tests/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ ktnef/tests/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,10 @@
+AM_CPPFLAGS = -I$(top_srcdir)/ktnef $(all_includes) -DKDESRCDIR=\"$(srcdir)\"
+LDADD = ../lib/libktnef.la $(LIB_KDECORE)
+
+check_PROGRAMS = parsertest
+TESTS = parsertest
+
+parsertest_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+parsertest_SOURCES = parsertest.cpp
+
+METASOURCES = AUTO
Index: ktnef/tests/one-file.tnef
===================================================================
Nie mo≈ºna wy≈õwietliƒá: plik binarny.
svn:mime-type = application/octet-stream

Zmiany atrybut√≥w dla: ktnef/tests/one-file.tnef
___________________________________________________________________
Nazwa: svn:mime-type
   + application/octet-stream

Index: ktnef/tests/README
===================================================================
--- ktnef/tests/README	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ ktnef/tests/README	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1 @@
+TNEF test files are taken from tnef.sf.net.
Index: ktnef/tests/parsertest.cpp
===================================================================
--- ktnef/tests/parsertest.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ ktnef/tests/parsertest.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,104 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This library is free software; you can redistribute it and/or modify it
+    under the terms of the GNU Library General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or (at your
+    option) any later version.
+
+    This library is distributed in the hope that it will be useful, but WITHOUT
+    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public
+    License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to the
+    Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+    02110-1301, USA.
+*/
+
+#include "parsertest.h"
+
+#include <ktnef/ktnefparser.h>
+#include <ktnef/ktnefmessage.h>
+#include <ktnef/ktnefattach.h>
+
+#include "assert.h"
+
+void ParserTest::testSingleAttachment()
+{
+  KTNEFParser parser;
+  assert( parser.openFile( KDESRCDIR "/one-file.tnef" ) == true );
+
+  KTNEFMessage *msg = parser.message();
+  assert( msg != 0 );
+
+  QPtrList<KTNEFAttach> atts = msg->attachmentList();
+  assert( atts.count() == 1 );
+
+  KTNEFAttach* att = atts.first();
+  assert( att != 0 );
+  assert( att->size() == 244 );
+  assert( att->name() == QString( "AUTHORS" ) );
+}
+
+void ParserTest::testTwoAttachments()
+{
+  KTNEFParser parser;
+  assert( parser.openFile( KDESRCDIR "/two-files.tnef" ) == true );
+
+  KTNEFMessage *msg = parser.message();
+  assert( msg != 0 );
+
+  QPtrList<KTNEFAttach> atts = msg->attachmentList();
+  assert( atts.count() == 2 );
+
+  KTNEFAttach* att = atts.at( 0 );
+  assert( att != 0 );
+  assert( att->size() == 244 );
+  assert( att->name() == QString( "AUTHORS" ) );
+
+  att = atts.at( 1 );
+  assert( att != 0 );
+  assert( att->size() == 893 );
+  assert( att->name() == QString( "README" ) );
+}
+
+void ParserTest::testMAPIAttachments()
+{
+  KTNEFParser parser;
+  assert( parser.openFile( KDESRCDIR "/mapi_attach_data_obj.tnef" ) == true );
+
+  KTNEFMessage *msg = parser.message();
+  assert( msg != 0 );
+
+  QPtrList<KTNEFAttach> atts = msg->attachmentList();
+  assert( atts.count() == 3 );
+
+  KTNEFAttach* att = atts.at( 0 );
+  assert( att != 0 );
+  assert( att->size() == 61952 );
+  assert( att->name() == QString( "VIA_Nytt_1402.doc" ) );
+
+  att = atts.at( 1 );
+  assert( att != 0 );
+  assert( att->size() == 213688 );
+  assert( att->name() == QString( "VIA_Nytt_1402.pdf" ) );
+
+  att = atts.at( 2 );
+  assert( att != 0 );
+  assert( att->size() == 68920 );
+  assert( att->name() == QString( "VIA_Nytt_14021.htm" ) );
+}
+
+#include <kinstance.h>
+
+int main( int argc, char** argv )
+{
+  KInstance inst( "ktnef-parsertest" );
+  ParserTest test;
+  test.testSingleAttachment();
+  test.testTwoAttachments();
+  test.testMAPIAttachments();
+  return 0;
+}

Zmiany atrybut√≥w dla: ktnef/tests
___________________________________________________________________
Nazwa: svn:ignore
   + .deps
.libs
Makefile
Makefile.in
*.moc
parsertest


Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 GenericName[da]=TNEF Fil-fremviser
 GenericName[de]=TNEF-Dateibetrachter
 GenericName[el]=Œ†œÅŒøŒ≤ŒøŒªŒ≠Œ±œÇ Œ±œÅœáŒµŒØœâŒΩ TNEF
+GenericName[eo]=TNEF-dosierorigardilo
 GenericName[es]=Visor de archivos TNEF
 GenericName[et]=TNEF-failide n√§itaja
 GenericName[eu]=TNEF fitxategi ikustailea
Index: ktnef/gui/ms-tnef.desktop
===================================================================
--- ktnef/gui/ms-tnef.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ ktnef/gui/ms-tnef.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -14,6 +14,7 @@
 Comment[cy]=Ffeil TNEF
 Comment[de]=TNEF-Datei
 Comment[el]=ŒëœÅœáŒµŒØŒø TNEF
+Comment[eo]=TNEF-dosiero
 Comment[es]=Archivo TNEF
 Comment[et]=TNEF-fail
 Comment[eu]=TNEF fitxategia
Index: ktnef/Makefile.am
===================================================================
--- ktnef/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ ktnef/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,4 +1,4 @@
-SUBDIRS = ktnef lib gui
+SUBDIRS = ktnef lib gui tests
 
 messages: rc.cpp
 	$(EXTRACTRC) gui/*.rc gui/*.ui >> rc.cpp
Index: kfile-plugins/rfc822/kfile_rfc822.desktop
===================================================================
--- kfile-plugins/rfc822/kfile_rfc822.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kfile-plugins/rfc822/kfile_rfc822.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=E-mail-info
 Name[de]=E-Mail-Info
 Name[el]=Œ†ŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ Email
+Name[eo]=Retpo≈ùt-informo
 Name[es]=Info de correo electr√≥nico
 Name[et]=Kirja info
 Name[eu]=E-posta informazioa
Index: kfile-plugins/ics/kfile_ics.desktop
===================================================================
--- kfile-plugins/ics/kfile_ics.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kfile-plugins/ics/kfile_ics.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Name[da]=ICS-information
 Name[de]=ICS-Information
 Name[el]=Œ†ŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ ICS
+Name[eo]=ICS-Informo
 Name[es]=Informaci√≥n ICS
 Name[et]=ICS info
 Name[eu]=ICS informazioa
Index: kfile-plugins/palm-databases/kfile_palm.desktop
===================================================================
--- kfile-plugins/palm-databases/kfile_palm.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kfile-plugins/palm-databases/kfile_palm.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -12,6 +12,7 @@
 Name[da]=PalmOS database-info
 Name[de]=PalmOS Datenbank Informationen
 Name[el]=Œ†ŒªŒ∑œÅŒøœÜŒøœÅŒØŒµœÇ Œ≤Œ¨œÉŒ∑œÇ Œ¥ŒµŒ¥ŒøŒºŒ≠ŒΩœâŒΩ PalmOS
+Name[eo]=PalmOS-Datumbazinformo
 Name[es]=Info. de la base de datos de PalmOS
 Name[et]=PalmOS andmebaasi info
 Name[eu]=PalmOS datu-base informazioa
Index: kfile-plugins/vcf/Makefile.am
===================================================================
--- kfile-plugins/vcf/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kfile-plugins/vcf/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,7 +10,7 @@
 
 kfile_vcf_la_SOURCES = kfile_vcf.cpp 
 kfile_vcf_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
-kfile_vcf_la_LIBADD = $(LIB_KSYCOCA)
+kfile_vcf_la_LIBADD = $(LIB_KSYCOCA) $(LIB_KABC)
 
 # let automoc handle all of the meta source files (moc)
 METASOURCES = AUTO
Index: kfile-plugins/vcf/kfile_vcf.cpp
===================================================================
--- kfile-plugins/vcf/kfile_vcf.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ kfile-plugins/vcf/kfile_vcf.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,20 +24,11 @@
 #include <kprocess.h>
 #include <klocale.h>
 #include <kgenericfactory.h>
-#include <kstringvalidator.h>
+#include <kabc/vcardconverter.h>
 
 #include <qdict.h>
-#include <qvalidator.h>
-#include <qcstring.h>
 #include <qfile.h>
-#include <qdatetime.h>
 
-#if !defined(__osf__)
-#include <inttypes.h>
-#else
-typedef unsigned short uint32_t;
-#endif
-
 typedef KGenericFactory<KVcfPlugin> VcfFactory;
 
 K_EXPORT_COMPONENT_FACTORY(kfile_vcf, VcfFactory( "kfile_vcf" ))
@@ -63,7 +54,6 @@
 
 bool KVcfPlugin::readInfo( KFileMetaInfo& info, uint /*what*/ )
 {
-
     QFile file(info.path());
 
     if (!file.open(IO_ReadOnly))
@@ -72,58 +62,38 @@
         return false;
     }
 
-    char id_name[] = "FN:";
-    char id_email[] = "EMAIL;INTERNET:";
+    // even the vcard thumbnail QString::fromUtf8(buf_name));creator reads the full file ...
+    // The following is partly copied from there
+    QString contents = file.readAll();
+    file.close();
 
-    // we need a buffer for lines
-    char linebuf[1000];
+    KABC::VCardConverter converter;
+    KABC::Addressee addr = converter.parseVCard(contents);
 
-    // we need a buffer for other stuff
-    char buf_name[1000] = "";
-    char buf_email[1000] = "";
-    buf_name[999] = '\0';
-    buf_email[999] = '\0';
-    char * myptr;
+    KFileMetaInfoGroup group = appendGroup(info, "Technical");
 
-    // FIXME: This is intensely inefficient!!!
+    // prepare the text
+    QString name = addr.formattedName().simplifyWhiteSpace();
+    if ( name.isEmpty() )
+      name = addr.givenName() + " " + addr.familyName();
+    name = name.simplifyWhiteSpace();
 
-    bool done=false;
-    while (!done) {
+    if ( ! name.isEmpty() )
+        appendItem(group, "Name", name);
 
-        // read a line
-        int r = file.readLine(linebuf, sizeof( linebuf ));
+    if ( ! addr.preferredEmail().isEmpty() )
+        appendItem(group, "Email", addr.preferredEmail());
 
-        if ( r < 0 ) {
-            done = true;
-            break;
-        }
-
-        // have we got something useful?
-        if (memcmp(linebuf, id_name, 3) == 0) {
-            // we have a name
-            myptr = linebuf + 3;
-            strlcpy(buf_name, myptr, sizeof( buf_name ));
-        } else if (memcmp(linebuf, id_email, 15) == 0) {
-            // we have an email
-            myptr = linebuf + 15;
-            strlcpy(buf_email, myptr, sizeof( buf_email ));
-        }
-
-        // are we done yet?
-        if ((strlen(buf_name) > 0 && strlen(buf_email) > 0) || file.atEnd())
-            done = true;
-
+    KABC::PhoneNumber::List pnList = addr.phoneNumbers();
+    QStringList phoneNumbers;
+    for (unsigned int no=0; no<pnList.count(); ++no) {
+      QString pn = pnList[no].number().simplifyWhiteSpace();
+      if (!pn.isEmpty() && !phoneNumbers.contains(pn))
+        phoneNumbers.append(pn);
     }
+    if ( !phoneNumbers.isEmpty() )
+        appendItem(group, "Telephone", phoneNumbers.join("\n"));
 
-
-    KFileMetaInfoGroup group = appendGroup(info, "Technical");
-
-    if (strlen(buf_name) > 0)
-        appendItem(group, "Name", QString::fromUtf8(buf_name));
-
-    if (strlen(buf_email) > 0)
-        appendItem(group, "Email", buf_email);
-
     return true;
 }
 
Index: korganizer/korganizer_configfonts.desktop
===================================================================
--- korganizer/korganizer_configfonts.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configfonts.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -89,6 +89,7 @@
 Comment[da]=KOrganizer skrifttypeindstilling
 Comment[de]=Schriftenfestlegung f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ Œ≥œÅŒ±ŒºŒºŒ±œÑŒøœÉŒµŒπœÅœéŒΩ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo Tipar-agordo
 Comment[es]=Configuraci√≥n de las tipograf√≠as de KOrganizer
 Comment[et]=KOrganizeri fontide seadistamine
 Comment[eu]=KOrganizer-en letra-tipoen konfigurazioa
@@ -142,6 +143,7 @@
 Keywords[da]=korganizer,skrifttyper
 Keywords[de]=KOrganizer,Schriften
 Keywords[el]=korganizer,Œ≥œÅŒ±ŒºŒºŒ±œÑŒøœÉŒµŒπœÅŒ≠œÇ
+Keywords[eo]=korganizilo, tiparoj
 Keywords[es]=korganizer,tipograf√≠as
 Keywords[et]=korganizer,fondid
 Keywords[eu]=korganizer,letra-tipoak
Index: korganizer/kogroupware.cpp
===================================================================
--- korganizer/kogroupware.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kogroupware.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,6 +39,7 @@
 #include "calendarview.h"
 #include "mailscheduler.h"
 #include "koprefs.h"
+#include "koincidenceeditor.h"
 #include <libemailfunctions/email.h>
 #include <libkcal/attendee.h>
 #include <libkcal/journal.h>
@@ -50,6 +51,7 @@
 #include <qfile.h>
 #include <qregexp.h>
 #include <qdir.h>
+#include <qtimer.h>
 
 FreeBusyManager *KOGroupware::mFreeBusyManager = 0;
 
@@ -78,26 +80,24 @@
   KDirWatch* watcher = KDirWatch::self();
   watcher->addDir( locateLocal( "data", "korganizer/income.accepted/" ) );
   watcher->addDir( locateLocal( "data", "korganizer/income.tentative/" ) );
+  watcher->addDir( locateLocal( "data", "korganizer/income.counter/" ) );
   watcher->addDir( locateLocal( "data", "korganizer/income.cancel/" ) );
   watcher->addDir( locateLocal( "data", "korganizer/income.reply/" ) );
+  watcher->addDir( locateLocal( "data", "korganizer/income.delegated/" ) );
   connect( watcher, SIGNAL( dirty( const QString& ) ),
            this, SLOT( incomingDirChanged( const QString& ) ) );
   // Now set the ball rolling
+  QTimer::singleShot( 0, this, SLOT(initialCheckForChanges()) );
+}
+
+void KOGroupware::initialCheckForChanges()
+{
   incomingDirChanged( locateLocal( "data", "korganizer/income.accepted/" ) );
   incomingDirChanged( locateLocal( "data", "korganizer/income.tentative/" ) );
+  incomingDirChanged( locateLocal( "data", "korganizer/income.counter/" ) );
   incomingDirChanged( locateLocal( "data", "korganizer/income.cancel/" ) );
   incomingDirChanged( locateLocal( "data", "korganizer/income.reply/" ) );
-
-  if ( !mFreeBusyManager ) {
-    mFreeBusyManager = new FreeBusyManager( this, "freebusymanager" );
-    mFreeBusyManager->setCalendar( mCalendar );
-    connect( mCalendar, SIGNAL( calendarChanged() ),
-             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
-    connect( mView, SIGNAL( newIncidenceChanger( IncidenceChangerBase* ) ),
-             this, SLOT( slotViewNewIncidenceChanger( IncidenceChangerBase* ) ) );
-    slotViewNewIncidenceChanger( mView->incidenceChanger() );
-  }
-
+  incomingDirChanged( locateLocal( "data", "korganizer/income.delegated/" ) );
 }
 
 void KOGroupware::slotViewNewIncidenceChanger( IncidenceChangerBase* changer )
@@ -115,6 +115,16 @@
 
 FreeBusyManager *KOGroupware::freeBusyManager()
 {
+  if ( !mFreeBusyManager ) {
+    mFreeBusyManager = new FreeBusyManager( this, "freebusymanager" );
+    mFreeBusyManager->setCalendar( mCalendar );
+    connect( mCalendar, SIGNAL( calendarChanged() ),
+             mFreeBusyManager, SLOT( slotPerhapsUploadFB() ) );
+    connect( mView, SIGNAL( newIncidenceChanger( IncidenceChangerBase* ) ),
+             this, SLOT( slotViewNewIncidenceChanger( IncidenceChangerBase* ) ) );
+    slotViewNewIncidenceChanger( mView->incidenceChanger() );
+  }
+
   return mFreeBusyManager;
 }
 
@@ -170,7 +180,8 @@
   KCal::Incidence* incidence =
     dynamic_cast<KCal::Incidence*>( message->event() );
   KCal::MailScheduler scheduler( mCalendar );
-  if ( action.startsWith( "accepted" ) || action.startsWith( "tentative" ) ) {
+  if ( action.startsWith( "accepted" ) || action.startsWith( "tentative" )
+       || action.startsWith( "delegated" ) || action.startsWith( "counter" ) ) {
     // Find myself and set my status. This can't be done in the scheduler,
     // since this does not know the choice I made in the KMail bpf
     KCal::Attendee::List attendees = incidence->attendees();
@@ -179,8 +190,10 @@
       if( (*it)->email() == receiver ) {
         if ( action.startsWith( "accepted" ) )
           (*it)->setStatus( KCal::Attendee::Accepted );
-        else
+        else if ( action.startsWith( "tentative" ) || action.startsWith( "counter" ) )
           (*it)->setStatus( KCal::Attendee::Tentative );
+        else if ( action.startsWith( "delegated" ) )
+          (*it)->setStatus( KCal::Attendee::Delegated );
         break;
       }
     }
@@ -192,6 +205,12 @@
     scheduler.acceptTransaction( incidence, method, status );
   else
     kdError(5850) << "Unknown incoming action " << action << endl;
+
+  if ( action.startsWith( "counter" ) ) {
+    mView->editIncidence( incidence );
+    KOIncidenceEditor *tmp = mView->editorDialog( incidence );
+    tmp->selectInvitationCounterProposal( true );
+  }
   mView->updateView();
 }
 
Index: korganizer/actionmanager.h
===================================================================
--- korganizer/actionmanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/actionmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -169,6 +169,12 @@
                           const QString& description,
                           const QString& attachment,
                           const QStringList& attendees );
+    void openEventEditor( const QString& summary,
+                          const QString& description,
+                          const QString& uri,
+                          const QString& file,
+                          const QStringList& attendees,
+                          const QString& attachmentMimetype );
 
     void openTodoEditor( const QString& );
     void openTodoEditor( const QString& summary,
@@ -178,6 +184,12 @@
                          const QString& description,
                          const QString& attachment,
                          const QStringList& attendees );
+    void openTodoEditor( const QString& summary,
+                         const QString& description,
+                         const QString& uri,
+                         const QString& file,
+                         const QStringList& attendees,
+                         const QString& attachmentMimetype );
 
     void openJournalEditor( const QDate& date );
     void openJournalEditor( const QString& text, const QDate& date );
@@ -193,11 +205,16 @@
 
     void goDate( const QDate& );
     void goDate( const QString& );
+    void showDate( const QDate &date );
 
     QString localFileName();
 
     bool queryClose();
 
+    void loadProfile( const QString & path );
+
+    void saveToProfile( const QString & path ) const;
+
   signals:
     /**
       Emitted when the "New" action is activated.
@@ -377,6 +394,7 @@
     KAction *mDeleteAction;
     KAction *mNextXDays;
     KAction *mPublishEvent;
+    KAction *mForwardEvent;
 
     KAction *mUndoAction;
     KAction *mRedoAction;
Index: korganizer/kodialogmanager.cpp
===================================================================
--- korganizer/kodialogmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kodialogmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -237,7 +237,7 @@
 }
 
 void KODialogManager::connectTypeAhead( KOEventEditor *editor,
-                                        KOAgendaView *agenda )
+                                        KOrg::AgendaView *agenda )
 {
   if ( editor && agenda ) {
     agenda->setTypeAheadReceiver( editor->typeAheadReceiver() );
@@ -248,11 +248,11 @@
 
 void KODialogManager::connectEditor( KOIncidenceEditor*editor )
 {
-/*  connect( editor, SIGNAL( deleteIncidenceSignal( Incidence * ) ),
-           mMainView, SLOT( deleteIncidence( Incidence * ) ) );*/
+  connect( editor, SIGNAL( deleteIncidenceSignal( Incidence * ) ),
+           mMainView, SLOT( deleteIncidence( Incidence * ) ) );
 
   connect( mCategoryEditDialog, SIGNAL( categoryConfigChanged() ),
-           editor, SLOT( updateCategoryConfig() ) );
+           editor, SIGNAL( updateCategoryConfig() ) );
   connect( editor, SIGNAL( editCategories() ),
            mCategoryEditDialog, SLOT( show() ) );
 
Index: korganizer/koeditorgeneralevent.h
===================================================================
--- korganizer/koeditorgeneralevent.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneralevent.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -48,6 +48,7 @@
 
     void initTime(QWidget *,QBoxLayout *);
     void initClass(QWidget *,QBoxLayout *);
+    void initInvitationBar( QWidget* parent, QBoxLayout *layout );
 
     void finishSetup();
 
@@ -57,13 +58,15 @@
       Read event object and setup widgets accordingly. If templ is true, the
       event is read as template, i.e. the time and date information isn't set.
     */
-    void readEvent( Event *, bool tmpl = false );
+    void readEvent( Event *event, Calendar *calendar, bool tmpl = false );
     /** Write event settings to event object */
     void writeEvent( Event * );
 
     /** Check if the input is valid. */
     bool validateInput();
 
+    void updateRecurrenceSummary( const QString &summary );
+
   public slots:
     void setDateTimes( const QDateTime &start, const QDateTime &end );
     void setDuration();
@@ -83,6 +86,9 @@
     void allDayChanged(bool);
     void dateTimeStrChanged( const QString & );
     void dateTimesChanged( const QDateTime &start, const QDateTime &end );
+    void editRecurrence();
+    void acceptInvitation();
+    void declineInvitation();
 
   private:
     QLabel                  *mStartDateLabel;
@@ -92,8 +98,10 @@
     KTimeEdit               *mStartTimeEdit;
     KTimeEdit               *mEndTimeEdit;
     QLabel                  *mDurationLabel;
-    QCheckBox               *mTimeAssociateButton;
+    QCheckBox               *mAlldayEventCheckbox;
     QComboBox               *mFreeTimeCombo;
+    QLabel                  *mRecurrenceSummary;
+    QFrame                  *mInvitationBar;
 
     // current start and end date and time
     QDateTime mCurrStartDateTime;
Index: korganizer/korganizer_configplugins.desktop
===================================================================
--- korganizer/korganizer_configplugins.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configplugins.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 Name[da]=Plugin
 Name[de]=Module
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒ±
+Name[eo]=Kromaƒµoj
 Name[es]=Extensiones
 Name[et]=Pluginad
 Name[eu]=Plugin-ak
@@ -71,6 +72,7 @@
 Comment[da]=KOrganizer plugin-indstilling
 Comment[de]=Modul-Einrichtung f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œÄœÅŒøœÉŒ∏Œ≠œÑœâŒΩ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo-Kromaƒµagordo
 Comment[es]=Configuraci√≥n de las extensiones de KOrganizer
 Comment[et]=KOrganizeri pluginate seadistused
 Comment[eu]=KOrganizer-en plugin konfigurazioa
Index: korganizer/koattendeeeditor.cpp
===================================================================
--- korganizer/koattendeeeditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/koattendeeeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,446 @@
+/*
+    Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+        This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "koattendeeeditor.h"
+#include "koprefs.h"
+#include "koglobals.h"
+
+#ifndef KORG_NOKABC
+#include <kabc/addresseedialog.h>
+#include <libkdepim/addressesdialog.h>
+#include <libkdepim/addresseelineedit.h>
+#endif
+
+#include <libkcal/incidence.h>
+
+#include <libemailfunctions/email.h>
+
+#include <kiconloader.h>
+#include <klocale.h>
+
+#include <qcheckbox.h>
+#include <qcombobox.h>
+#include <qhbox.h>
+#include <qlabel.h>
+#include <qlayout.h>
+#include <qpushbutton.h>
+#include <qwhatsthis.h>
+
+using namespace KCal;
+
+KOAttendeeEditor::KOAttendeeEditor( QWidget * parent, const char *name ) :
+    QWidget( parent, name ),
+    mDisableItemUpdate( true )
+{
+}
+
+void KOAttendeeEditor::initOrganizerWidgets(QWidget * parent, QBoxLayout * layout)
+{
+  mOrganizerHBox = new QHBox( parent );
+  layout->addWidget( mOrganizerHBox );
+  // If creating a new event, then the user is the organizer -> show the
+  // identity combo
+  // readEvent will delete it and set another label text instead, if the user
+  // isn't the organizer.
+  // Note that the i18n text below is duplicated in readEvent
+  QString whatsThis = i18n("Sets the identity corresponding to "
+                           "the organizer of this to-do or event. "
+                           "Identities can be set in the 'Personal' "
+                           "section of the KOrganizer configuration, or in the "
+                           "'Security & Privacy'->'Password & User Account' "
+                           "section of the KDE Control Center. In addition, "
+                           "identities are gathered from your KMail settings "
+                           "and from your address book. If you choose "
+                           "to set it globally for KDE in the Control Center, "
+                           "be sure to check 'Use email settings from "
+                           "Control Center' in the 'Personal' section of the "
+                           "KOrganizer configuration.");
+  mOrganizerLabel = new QLabel( i18n( "Identity as organizer:" ),
+                                mOrganizerHBox );
+  mOrganizerCombo = new QComboBox( mOrganizerHBox );
+  QWhatsThis::add( mOrganizerLabel, whatsThis );
+  QWhatsThis::add( mOrganizerCombo, whatsThis );
+  fillOrganizerCombo();
+  mOrganizerHBox->setStretchFactor( mOrganizerCombo, 100 );
+}
+
+void KOAttendeeEditor::initEditWidgets(QWidget * parent, QBoxLayout * layout)
+{
+  QGridLayout *topLayout = new QGridLayout();
+  layout->addLayout( topLayout );
+
+  QString whatsThis = i18n("Edits the name of the attendee selected in the list "
+                           "above, or adds a new attendee if there are no attendees"
+                           "in the list.");
+  QLabel *attendeeLabel = new QLabel( parent );
+  QWhatsThis::add( attendeeLabel, whatsThis );
+  attendeeLabel->setText( i18n("Na&me:") );
+  topLayout->addWidget( attendeeLabel, 0, 0 );
+
+  mNameEdit = new KPIM::AddresseeLineEdit( parent );
+  QWhatsThis::add( mNameEdit, whatsThis );
+  mNameEdit->setClickMessage( i18n("Click to add a new attendee") );
+  attendeeLabel->setBuddy( mNameEdit );
+  mNameEdit->installEventFilter( this );
+  connect( mNameEdit, SIGNAL( textChanged( const QString & ) ),
+           SLOT( updateAttendee() ) );
+  topLayout->addMultiCellWidget( mNameEdit, 0, 0, 1, 2 );
+
+  whatsThis = i18n("Edits the role of the attendee selected "
+                   "in the list above.");
+  QLabel *attendeeRoleLabel = new QLabel( parent );
+  QWhatsThis::add( attendeeRoleLabel, whatsThis );
+  attendeeRoleLabel->setText( i18n("Ro&le:") );
+  topLayout->addWidget( attendeeRoleLabel, 1, 0 );
+
+  mRoleCombo = new QComboBox( false, parent );
+  QWhatsThis::add( mRoleCombo, whatsThis );
+  mRoleCombo->insertStringList( Attendee::roleList() );
+  attendeeRoleLabel->setBuddy( mRoleCombo );
+  connect( mRoleCombo, SIGNAL( activated( int ) ),
+           SLOT( updateAttendee() ) );
+  topLayout->addWidget( mRoleCombo, 1, 1 );
+
+  mDelegateLabel = new QLabel( parent );
+  topLayout->addWidget( mDelegateLabel, 1, 2 );
+
+  whatsThis = i18n("Edits the current attendance status of the attendee "
+                   "selected in the list above.");
+  QLabel *statusLabel = new QLabel( parent );
+  QWhatsThis::add( statusLabel, whatsThis );
+  statusLabel->setText( i18n("Stat&us:") );
+  topLayout->addWidget( statusLabel, 2, 0 );
+
+  mStatusCombo = new QComboBox( false, parent );
+  QWhatsThis::add( mStatusCombo, whatsThis );
+//   mStatusCombo->insertStringList( Attendee::statusList() );
+  mStatusCombo->insertItem( SmallIcon( "help" ), Attendee::statusName( Attendee::NeedsAction ) );
+  mStatusCombo->insertItem( KOGlobals::self()->smallIcon( "ok" ), Attendee::statusName( Attendee::Accepted ) );
+  mStatusCombo->insertItem( KOGlobals::self()->smallIcon( "no" ), Attendee::statusName( Attendee::Declined ) );
+  mStatusCombo->insertItem( KOGlobals::self()->smallIcon( "apply" ), Attendee::statusName( Attendee::Tentative ) );
+  mStatusCombo->insertItem( KOGlobals::self()->smallIcon( "mail_forward" ), Attendee::statusName( Attendee::Delegated ) );
+  mStatusCombo->insertItem( Attendee::statusName( Attendee::Completed ) );
+  mStatusCombo->insertItem( KOGlobals::self()->smallIcon( "help" ), Attendee::statusName( Attendee::InProcess ) );
+
+  statusLabel->setBuddy( mStatusCombo );
+  connect( mStatusCombo, SIGNAL( activated( int ) ),
+           SLOT( updateAttendee() ) );
+  topLayout->addWidget( mStatusCombo, 2, 1 );
+
+  topLayout->setColStretch( 2, 1 );
+
+  mRsvpButton = new QCheckBox( parent );
+  QWhatsThis::add( mRsvpButton,
+		   i18n("Edits whether to send an email to the attendee "
+			"selected in the list above to request "
+			"a response concerning attendance.") );
+  mRsvpButton->setText( i18n("Re&quest response") );
+  connect( mRsvpButton, SIGNAL( clicked() ), SLOT( updateAttendee() ) );
+  topLayout->addWidget( mRsvpButton, 2, 2 );
+
+  QWidget *buttonBox = new QWidget( parent );
+  QVBoxLayout *buttonLayout = new QVBoxLayout( buttonBox );
+
+  mAddButton = new QPushButton( i18n("&New"), buttonBox );
+  QWhatsThis::add( mAddButton,
+		   i18n("Adds a new attendee to the list. Once the "
+		   	"attendee is added, you will be able to "
+			"edit the attendee's name, role, attendance "
+			"status, and whether or not the attendee is required "
+			"to respond to the invitation. To select an attendee "
+			"from your addressbook, click the 'Select Addressee' "
+			"button instead.") );
+  buttonLayout->addWidget( mAddButton );
+  connect( mAddButton, SIGNAL( clicked() ), SLOT( addNewAttendee() ) );
+
+  mRemoveButton = new QPushButton( i18n("&Remove"), buttonBox );
+  QWhatsThis::add( mRemoveButton,
+		   i18n("Removes the attendee selected in "
+		   	"the list above.") );
+  buttonLayout->addWidget( mRemoveButton );
+
+  mAddressBookButton = new QPushButton( i18n("Select Addressee..."),
+                                        buttonBox );
+  QWhatsThis::add( mAddressBookButton,
+		   i18n("Opens your address book, allowing you to select "
+			"new attendees from it.") );
+  buttonLayout->addWidget( mAddressBookButton );
+  connect( mAddressBookButton, SIGNAL( clicked() ), SLOT( openAddressBook() ) );
+
+  topLayout->addMultiCellWidget( buttonBox, 0, 3, 3, 3 );
+
+#ifdef KORG_NOKABC
+  mAddressBookButton->hide();
+#endif
+}
+
+void KOAttendeeEditor::openAddressBook()
+{
+#ifndef KORG_NOKABC
+  KPIM::AddressesDialog *dia = new KPIM::AddressesDialog( this, "adddialog" );
+  dia->setShowCC( false );
+  dia->setShowBCC( false );
+  if ( dia->exec() ) {
+    KABC::Addressee::List aList = dia->allToAddressesNoDuplicates();
+    for ( KABC::Addressee::List::iterator itr = aList.begin();
+          itr != aList.end(); ++itr ) {
+      insertAttendeeFromAddressee( (*itr) );
+    }
+  }
+  delete dia;
+  return;
+#if 0
+    // old code
+    KABC::Addressee a = KABC::AddresseeDialog::getAddressee(this);
+    if (!a.isEmpty()) {
+        // If this is myself, I don't want to get a response but instead
+        // assume I will be available
+        bool myself = KOPrefs::instance()->thatIsMe( a.preferredEmail() );
+        KCal::Attendee::PartStat partStat =
+            myself ? KCal::Attendee::Accepted : KCal::Attendee::NeedsAction;
+        insertAttendee( new Attendee( a.realName(), a.preferredEmail(),
+                                      !myself, partStat,
+                                      KCal::Attendee::ReqParticipant, a.uid() ) );
+    }
+#endif
+#endif
+}
+
+void KOAttendeeEditor::insertAttendeeFromAddressee(const KABC::Addressee &a, const Attendee * at)
+{
+  bool myself = KOPrefs::instance()->thatIsMe( a.preferredEmail() );
+  bool sameAsOrganizer = mOrganizerCombo &&
+  KPIM::compareEmail( a.preferredEmail(), mOrganizerCombo->currentText(), false );
+  KCal::Attendee::PartStat partStat = at? at->status() : KCal::Attendee::NeedsAction;
+  bool rsvp = at? at->RSVP() : true;
+
+  if ( myself && sameAsOrganizer ) {
+    partStat = KCal::Attendee::Accepted;
+    rsvp = false;
+  }
+  Attendee *newAt = new Attendee( a.realName(),
+                               a.preferredEmail(),
+                               !myself, partStat,
+                               at ? at->role() : Attendee::ReqParticipant,
+                               a.uid() );
+  newAt->setRSVP( rsvp );
+  insertAttendee( newAt, true );
+}
+
+void KOAttendeeEditor::fillOrganizerCombo()
+{
+  Q_ASSERT( mOrganizerCombo );
+  // Get all emails from KOPrefs (coming from various places),
+  // and insert them - removing duplicates
+  const QStringList lst = KOPrefs::instance()->fullEmails();
+  QStringList uniqueList;
+  for( QStringList::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
+    if ( uniqueList.find( *it ) == uniqueList.end() )
+      uniqueList << *it;
+  }
+  mOrganizerCombo->insertStringList( uniqueList );
+}
+
+void KOAttendeeEditor::addNewAttendee()
+{
+  Attendee *a = new Attendee( i18n("Firstname Lastname"),
+                              i18n("name") + "@example.net", true );
+  insertAttendee( a, false );
+  updateAttendeeInput();
+  // We don't want the hint again
+  mNameEdit->setClickMessage( "" );
+  mNameEdit->setFocus();
+  QTimer::singleShot( 0, mNameEdit, SLOT( selectAll() ) );
+}
+
+void KOAttendeeEditor::readEvent(KCal::Incidence * incidence)
+{
+  mdelAttendees.clear();
+  if ( KOPrefs::instance()->thatIsMe( incidence->organizer().email() ) ) {
+    if ( !mOrganizerCombo ) {
+      mOrganizerCombo = new QComboBox( mOrganizerHBox );
+      fillOrganizerCombo();
+    }
+    mOrganizerLabel->setText( i18n( "Identity as organizer:" ) );
+
+    int found = -1;
+    QString fullOrganizer = incidence->organizer().fullName();
+    for ( int i = 0 ; i < mOrganizerCombo->count(); ++i ) {
+      if ( mOrganizerCombo->text( i ) == fullOrganizer ) {
+        found = i;
+        mOrganizerCombo->setCurrentItem( i );
+        break;
+      }
+    }
+    if ( found < 0 ) {
+      mOrganizerCombo->insertItem( fullOrganizer, 0 );
+      mOrganizerCombo->setCurrentItem( 0 );
+    }
+  } else { // someone else is the organizer
+    if ( mOrganizerCombo ) {
+      delete mOrganizerCombo;
+      mOrganizerCombo = 0;
+    }
+    mOrganizerLabel->setText( i18n( "Organizer: %1" ).arg( incidence->organizer().fullName() ) );
+  }
+
+  Attendee::List al = incidence->attendees();
+  Attendee::List::ConstIterator it;
+  for( it = al.begin(); it != al.end(); ++it )
+    insertAttendee( new Attendee( **it ), true );
+}
+
+void KOAttendeeEditor::writeEvent(KCal::Incidence * incidence)
+{
+  if ( mOrganizerCombo ) {
+    // TODO: Don't take a string and split it up... Is there a better way?
+    incidence->setOrganizer( mOrganizerCombo->currentText() );
+  }
+}
+
+void KOAttendeeEditor::setEnableAttendeeInput(bool enabled)
+{
+  //mNameEdit->setEnabled( enabled );
+  mRoleCombo->setEnabled( enabled );
+  mStatusCombo->setEnabled( enabled );
+  mRsvpButton->setEnabled( enabled );
+
+  mRemoveButton->setEnabled( enabled );
+}
+
+void KOAttendeeEditor::clearAttendeeInput()
+{
+  mNameEdit->setText("");
+  mUid = QString::null;
+  mRoleCombo->setCurrentItem(0);
+  mStatusCombo->setCurrentItem(0);
+  mRsvpButton->setChecked(true);
+  setEnableAttendeeInput( false );
+  mDelegateLabel->setText( QString() );
+}
+
+void KOAttendeeEditor::updateAttendee()
+{
+  Attendee *a = currentAttendee();
+  if ( !a || mDisableItemUpdate )
+    return;
+
+  QString name;
+  QString email;
+  KPIM::getNameAndMail(mNameEdit->text(), name, email);
+
+  bool iAmTheOrganizer = mOrganizerCombo &&
+    KOPrefs::instance()->thatIsMe( mOrganizerCombo->currentText() );
+  if ( iAmTheOrganizer ) {
+    bool myself =
+      KPIM::compareEmail( email, mOrganizerCombo->currentText(), false );
+    bool wasMyself =
+      KPIM::compareEmail( a->email(), mOrganizerCombo->currentText(), false );
+    if ( myself ) {
+      mStatusCombo->setCurrentItem( KCal::Attendee::Accepted );
+      mRsvpButton->setChecked( false );
+      mRsvpButton->setEnabled( false );
+    } else if ( wasMyself ) {
+      // this was me, but is no longer, reset
+      mStatusCombo->setCurrentItem( KCal::Attendee::NeedsAction );
+      mRsvpButton->setChecked( true );
+      mRsvpButton->setEnabled( true );
+    }
+  }
+  a->setName( name );
+  a->setUid( mUid );
+  a->setEmail( email );
+  a->setRole( Attendee::Role( mRoleCombo->currentItem() ) );
+  a->setStatus( Attendee::PartStat( mStatusCombo->currentItem() ) );
+  a->setRSVP( mRsvpButton->isChecked() );
+
+  updateCurrentItem();
+}
+
+void KOAttendeeEditor::fillAttendeeInput( KCal::Attendee *a )
+{
+  mDisableItemUpdate = true;
+
+  QString name = a->name();
+  if (!a->email().isEmpty()) {
+    name = KPIM::quoteNameIfNecessary( name );
+    name += " <" + a->email() + ">";
+  }
+  mNameEdit->setText(name);
+  mUid = a->uid();
+  mRoleCombo->setCurrentItem(a->role());
+  mStatusCombo->setCurrentItem(a->status());
+  mRsvpButton->setChecked(a->RSVP());
+
+  mDisableItemUpdate = false;
+  setEnableAttendeeInput( true );
+
+  if ( a->status() == Attendee::Delegated ) {
+    if ( !a->delegate().isEmpty() )
+      mDelegateLabel->setText( i18n( "Delegated to %1" ).arg( a->delegate() ) );
+    else if ( !a->delegator().isEmpty() )
+      mDelegateLabel->setText( i18n( "Delegated from %1" ).arg( a->delegator() ) );
+    else
+      mDelegateLabel->setText( i18n( "Not delegated" ) );
+  }
+}
+
+void KOAttendeeEditor::updateAttendeeInput()
+{
+  setEnableAttendeeInput(!mNameEdit->text().isEmpty());
+  Attendee* a = currentAttendee();
+  if ( a ) {
+    fillAttendeeInput( a );
+  } else {
+    clearAttendeeInput();
+  }
+}
+
+void KOAttendeeEditor::cancelAttendeeEvent( KCal::Incidence *incidence )
+{
+  incidence->clearAttendees();
+  Attendee * att;
+  for (att=mdelAttendees.first();att;att=mdelAttendees.next()) {
+    incidence->addAttendee(new Attendee(*att));
+  }
+  mdelAttendees.clear();
+}
+
+void KOAttendeeEditor::acceptForMe()
+{
+  changeStatusForMe( Attendee::Accepted );
+}
+
+void KOAttendeeEditor::declineForMe()
+{
+  changeStatusForMe( Attendee::Declined );
+}
+
+bool KOAttendeeEditor::eventFilter(QObject *watched, QEvent *ev)
+{
+  if ( watched && watched == mNameEdit && ev->type() == QEvent::FocusIn &&
+       currentAttendee() == 0 ) {
+    addNewAttendee();
+  }
+
+  return QWidget::eventFilter( watched, ev );
+}
+
+#include "koattendeeeditor.moc"
Index: korganizer/koeditorgeneraltodo.cpp
===================================================================
--- korganizer/koeditorgeneraltodo.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneraltodo.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -160,6 +160,10 @@
 
   // some more layouting
   layoutTimeBox->setColStretch(3,1);
+
+  QBoxLayout *secLayout = new QHBoxLayout();
+  layoutTimeBox->addLayout( secLayout, 0, 4 );
+  initSecrecy( timeBoxFrame, secLayout );
 }
 
 
@@ -262,9 +266,9 @@
   mCompletedCombo->setCurrentItem(0);
 }
 
-void KOEditorGeneralTodo::readTodo(Todo *todo)
+void KOEditorGeneralTodo::readTodo(Todo *todo, Calendar *calendar)
 {
-  KOEditorGeneral::readIncidence(todo);
+  KOEditorGeneral::readIncidence(todo, calendar);
 
   QDateTime dueDT;
 
@@ -559,7 +563,7 @@
     break;
   case KOGlobals::UNKNOWN_MODIFIED: // fall through
   default:
-    readTodo( todo );
+    readTodo( todo, 0 );
     break;
   }
 }
Index: korganizer/korganizer_configtime.desktop
===================================================================
--- korganizer/korganizer_configtime.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configtime.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 Name[da]=Tid & Dato
 Name[de]=Zeit & Datum
 Name[el]=ŒèœÅŒ± & ŒóŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒ±
+Name[eo]=Tempo & Dato
 Name[es]=Fecha y hora
 Name[et]=Aeg
 Name[eu]=Ordua eta data
@@ -45,7 +46,7 @@
 Name[lt]=Laikas ir data
 Name[mk]=–î–∞—Ç—É–º–∏ –∏ –≤—Ä–µ–º–∏—ö–∞
 Name[ms]=Waktu & Tarikh
-Name[nb]=Dato og tid
+Name[nb]=Dato og klokkeslett
 Name[nds]=Tiet & Datum
 Name[ne]=‡§Æ‡§ø‡§§‡§ø ‡§∞ ‡§∏‡§Æ‡§Ø
 Name[nl]=Datum & tijd
@@ -80,6 +81,7 @@
 Comment[da]=KOrganizer tidsindstilling
 Comment[de]=Zeitliche Vorgaben f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œéœÅŒ±œÇ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo-tempagordo
 Comment[es]=Configuraci√≥n de la hora de KOrganizer
 Comment[et]=KOrganizeri ajaseadistused
 Comment[eu]=KOrganizer-en ordu/data konfigurazioa
@@ -131,6 +133,7 @@
 Keywords[da]=korganizer,tid
 Keywords[de]=KOrganizer,Zeit
 Keywords[el]=korganizer,œéœÅŒ±
+Keywords[eo]=korganizilo,tempo
 Keywords[es]=korganizer,hora
 Keywords[et]=korganizer,aeg
 Keywords[eu]=korganizer,ordua,data
Index: korganizer/agendaview.cpp
===================================================================
--- korganizer/agendaview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/agendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,28 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "agendaview.h"
+
+using namespace KOrg;
+
+AgendaView::AgendaView(Calendar * cal, QWidget * parent, const char * name) :
+    KOEventView( cal, parent, name )
+{
+}
+
+#include "agendaview.moc"
Index: korganizer/koeditorgeneral.cpp
===================================================================
--- korganizer/koeditorgeneral.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneral.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -41,6 +41,7 @@
 #include <qwhatsthis.h>
 
 #include <kglobal.h>
+#include <kdialog.h>
 #include <kdebug.h>
 #include <klocale.h>
 #include <kiconloader.h>
@@ -62,10 +63,12 @@
 
 #include "koeditorgeneral.h"
 #include "koeditoralarms.h"
+#include "koeditorattachments.h"
 #include "koeditorgeneral.moc"
+#include "kohelper.h"
 
 KOEditorGeneral::KOEditorGeneral(QObject* parent, const char* name) :
-  QObject( parent, name )
+  QObject( parent, name ), mAttachments(0)
 {
   mAlarmList.setAutoDelete( true );
 }
@@ -91,9 +94,11 @@
 }
 
 
-void KOEditorGeneral::initHeader(QWidget *parent,QBoxLayout *topLayout)
+void KOEditorGeneral::initHeader( QWidget *parent,QBoxLayout *topLayout)
 {
-  QGridLayout *headerLayout = new QGridLayout(topLayout);
+  QGridLayout *headerLayout = new QGridLayout();
+  headerLayout->setSpacing( topLayout->spacing() );
+  topLayout->addLayout( headerLayout );
 
 #if 0
   mOwnerLabel = new QLabel(i18n("Owner:"),parent);
@@ -101,48 +106,55 @@
 #endif
 
   QString whatsThis = i18n("Sets the Title of this event or to-do.");
-  QLabel *summaryLabel = new QLabel(i18n("T&itle:"),parent);
+  QLabel *summaryLabel = new QLabel( i18n("T&itle:"), parent );
   QWhatsThis::add( summaryLabel, whatsThis );
   QFont f = summaryLabel->font();
   f.setBold( true );
   summaryLabel->setFont(f);
   headerLayout->addWidget(summaryLabel,1,0);
 
-  mSummaryEdit = new FocusLineEdit(parent);
+  mSummaryEdit = new FocusLineEdit( parent );
   QWhatsThis::add( mSummaryEdit, whatsThis );
   connect( mSummaryEdit, SIGNAL( focusReceivedSignal() ),
            SIGNAL( focusReceivedSignal() ) );
   headerLayout->addWidget(mSummaryEdit,1,1);
   summaryLabel->setBuddy( mSummaryEdit );
 
+  mAttendeeSummaryLabel = new QLabel( parent );
+  updateAttendeeSummary( 0 );
+  headerLayout->addWidget( mAttendeeSummaryLabel, 1, 2 );
+
   whatsThis = i18n("Sets where the event or to-do will take place.");
-  QLabel *locationLabel = new QLabel(i18n("&Location:"),parent);
+  QLabel *locationLabel = new QLabel( i18n("&Location:"), parent );
   QWhatsThis::add( locationLabel, whatsThis );
   headerLayout->addWidget(locationLabel,2,0);
 
-  mLocationEdit = new QLineEdit(parent);
+  mLocationEdit = new QLineEdit( parent );
   QWhatsThis::add( mLocationEdit, whatsThis );
-  headerLayout->addWidget(mLocationEdit,2,1);
+  headerLayout->addMultiCellWidget( mLocationEdit, 2, 2, 1, 2 );
   locationLabel->setBuddy( mLocationEdit );
-}
 
-void KOEditorGeneral::initCategories(QWidget *parent, QBoxLayout *topLayout)
-{
-  QBoxLayout *categoriesLayout = new QHBoxLayout( topLayout );
+  QBoxLayout *thirdLineLayout = new QHBoxLayout();
+  headerLayout->addMultiCellLayout( thirdLineLayout, 3, 3, 0, 2 );
 
-  QString whatsThis = i18n("Allows you to select the categories that this "
-		  	   "event or to-do belongs to.");
+  mResourceLabel = new QLabel( parent );
+  mResourceLabel->hide();
+  thirdLineLayout->addWidget( mResourceLabel );
 
-  mCategoriesButton = new QPushButton(parent);
-  mCategoriesButton->setText(i18n("Select Cate&gories..."));
+  whatsThis = i18n("Allows you to select the categories that this event or to-do belongs to.");
+  QLabel *categoriesLabel = new QLabel( i18n("Categories:"), parent );
+  QWhatsThis::add( categoriesLabel, whatsThis );
+  thirdLineLayout->addWidget( categoriesLabel );
+  mCategoriesLabel = new KSqueezedTextLabel( parent );
+  QWhatsThis::add( mCategoriesLabel, whatsThis );
+  mCategoriesLabel->setFrameStyle(QFrame::Panel|QFrame::Sunken);
+  thirdLineLayout->addWidget( mCategoriesLabel );
+
+  mCategoriesButton = new QPushButton( parent );
+  mCategoriesButton->setText(i18n("&Select..."));
   QWhatsThis::add( mCategoriesButton, whatsThis );
   connect(mCategoriesButton,SIGNAL(clicked()),SLOT(selectCategories()));
-  categoriesLayout->addWidget(mCategoriesButton);
-
-  mCategoriesLabel = new KSqueezedTextLabel(parent);
-  QWhatsThis::add( mCategoriesLabel, whatsThis );
-  mCategoriesLabel->setFrameStyle(QFrame::Panel|QFrame::Sunken);
-  categoriesLayout->addWidget(mCategoriesLabel,1);
+  thirdLineLayout->addWidget( mCategoriesButton );
 }
 
 void KOEditorGeneral::initSecrecy(QWidget *parent, QBoxLayout *topLayout)
@@ -180,7 +192,7 @@
   mDescriptionEdit->setOverwriteMode(false);
   mDescriptionEdit->setWordWrap( KTextEdit::WidgetWidth );
   mDescriptionEdit->setTabChangesFocus( true );;
-  topLayout->addWidget(mDescriptionEdit);
+  topLayout->addWidget(mDescriptionEdit, 4);
 }
 
 void KOEditorGeneral::initAlarm(QWidget *parent,QBoxLayout *topLayout)
@@ -231,6 +243,28 @@
 
 }
 
+void KOEditorGeneral::initAttachments(QWidget *parent,QBoxLayout *topLayout)
+{
+  mAttachments = new KOEditorAttachments( KDialog::spacingHint(), parent );
+  connect( mAttachments, SIGNAL( openURL( const KURL & ) ) ,
+           this, SIGNAL( openURL( const KURL & ) ) );
+  topLayout->addWidget( mAttachments, 1 );
+}
+
+void KOEditorGeneral::addAttachments( const QStringList &attachments,
+                                      const QStringList &mimeTypes,
+                                      bool inlineAttachments )
+{
+  QStringList::ConstIterator it;
+  uint i = 0;
+  for ( it = attachments.begin(); it != attachments.end(); ++it, ++i ) {
+    QString mimeType;
+    if ( mimeTypes.count() > i )
+      mimeType = mimeTypes[ i ];
+    mAttachments->addAttachment( *it, mimeType, !inlineAttachments );
+  }
+}
+
 void KOEditorGeneral::selectCategories()
 {
   KPIM::CategorySelectDialog *categoryDialog = new KPIM::CategorySelectDialog( KOPrefs::instance(), mCategoriesButton	 );
@@ -238,6 +272,7 @@
   categoryDialog->setSelected( mCategories );
 
   connect(categoryDialog, SIGNAL(editCategories()), this, SIGNAL(openCategoryDialog()));
+  connect(this, SIGNAL(updateCategoryConfig()), categoryDialog, SLOT(updateCategoryConfig()));
 
   if ( categoryDialog->exec() ) {
     setCategories( categoryDialog->selectedCategories() );
@@ -286,6 +321,7 @@
   updateAlarmWidgets();
 
   mSecrecyCombo->setCurrentItem(Incidence::SecrecyPublic);
+  mAttachments->setDefaults();
 }
 
 void KOEditorGeneral::updateDefaultAlarmTime()
@@ -345,7 +381,7 @@
   }
 }
 
-void KOEditorGeneral::readIncidence(Incidence *event)
+void KOEditorGeneral::readIncidence(Incidence *event, Calendar *calendar)
 {
   mSummaryEdit->setText(event->summary());
   mLocationEdit->setText(event->location());
@@ -372,6 +408,14 @@
   updateAlarmWidgets();
 
   setCategories(event->categories());
+
+  mAttachments->readIncidence( event );
+
+  QString resLabel = KOHelper::resourceLabel( calendar, event );
+  if ( !resLabel.isEmpty() ) {
+    mResourceLabel->setText( i18n( "Calendar: %1" ).arg( resLabel ) );
+    mResourceLabel->show();
+  }
 }
 
 Alarm *KOEditorGeneral::alarmFromSimplePage() const
@@ -420,6 +464,7 @@
       event->addAlarm( al );
     }
   }
+  mAttachments->writeIncidence( event );
 }
 
 void KOEditorGeneral::setSummary( const QString &text )
@@ -436,3 +481,11 @@
 {
   return mSummaryEdit;
 }
+
+void KOEditorGeneral::updateAttendeeSummary(int count)
+{
+  if ( count <= 0 )
+    mAttendeeSummaryLabel->setText( "No attendees" );
+  else
+    mAttendeeSummaryLabel->setText( i18n( "One attendee", "%n attendees", count ) );
+}
Index: korganizer/koprefs.h
===================================================================
--- korganizer/koprefs.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koprefs.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -85,6 +85,7 @@
 
     void setCategoryColor( const QString &cat, const QColor &color );
     QColor *categoryColor( const QString &cat );
+    bool hasCategoryColor( const QString &cat ) const;
 
     void setResourceColor ( const QString &, const QColor & );
     QColor* resourceColor( const QString & );
Index: korganizer/koeventeditor.cpp
===================================================================
--- korganizer/koeventeditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeventeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,7 +25,6 @@
 
 #include <qtooltip.h>
 #include <qframe.h>
-#include <qguardedptr.h>
 #include <qpixmap.h>
 #include <qlayout.h>
 #include <qwidgetstack.h>
@@ -37,7 +36,7 @@
 #include <kmessagebox.h>
 #include <libkcal/calendarresources.h>
 #include <libkcal/resourcecalendar.h>
-
+#include <libkcal/incidenceformatter.h>
 #include <libkcal/calendarlocal.h>
 
 #include "koprefs.h"
@@ -45,7 +44,6 @@
 #include "koeditoralarms.h"
 #include "koeditorrecurrence.h"
 #include "koeditordetails.h"
-#include "koeditorattachments.h"
 #include "koeditorfreebusy.h"
 #include "kogroupware.h"
 #include "kodialogmanager.h"
@@ -55,7 +53,7 @@
 
 KOEventEditor::KOEventEditor( Calendar *calendar, QWidget *parent )
   : KOIncidenceEditor( QString::null, calendar, parent ),
-    mEvent( 0 ), mGeneral( 0 ), mRecurrence( 0 ), mFreeBusy( 0 )
+    mEvent( 0 ), mCalendar( 0 ), mGeneral( 0 ), mRecurrence( 0 ), mFreeBusy( 0 )
 {
 }
 
@@ -69,13 +67,9 @@
   setupGeneral();
 //  setupAlarmsTab();
   setupRecurrence();
-  setupAttendeesTab();
   setupFreeBusy();
-  setupAttachmentsTab();
   setupDesignerTabs( "event" );
 
-  mDetails->setFreeBusyWidget( mFreeBusy );
-
   // Propagate date time settings to recurrence tab
   connect( mGeneral, SIGNAL( dateTimesChanged( const QDateTime &, const QDateTime & ) ),
            mRecurrence, SLOT( setDateTimes( const QDateTime &, const QDateTime &) ) );
@@ -95,13 +89,28 @@
 
   connect( mGeneral, SIGNAL( openCategoryDialog() ),
            SIGNAL( editCategories() ) );
+  connect( this, SIGNAL( updateCategoryConfig() ),
+           mGeneral, SIGNAL( updateCategoryConfig() ) );
+
+  connect( mFreeBusy, SIGNAL(updateAttendeeSummary(int)),
+           mGeneral, SLOT(updateAttendeeSummary(int)) );
+
+  connect( mGeneral, SIGNAL(editRecurrence()),
+           mRecurrenceDialog, SLOT(show()) );
+  connect( mRecurrenceDialog, SIGNAL(okClicked()),
+           SLOT(updateRecurrenceSummary()) );
+
+  connect( mGeneral, SIGNAL(acceptInvitation()),
+           mFreeBusy, SLOT(acceptForMe()) );
+  connect( mGeneral, SIGNAL(declineInvitation()),
+           mFreeBusy, SLOT(declineForMe()) );
 }
 
 void KOEventEditor::reload()
 {
   kdDebug(5850) << "KOEventEditor::reload()" << endl;
 
-  if ( mEvent ) readEvent( mEvent );
+  if ( mEvent ) readEvent( mEvent, mCalendar );
 }
 
 void KOEventEditor::setupGeneral()
@@ -117,12 +126,11 @@
     QBoxLayout *topLayout = new QVBoxLayout(topFrame);
     topLayout->setSpacing(spacingHint());
 
-    mGeneral->initHeader(topFrame,topLayout);
+    mGeneral->initHeader( topFrame, topLayout );
     mGeneral->initTime(topFrame,topLayout);
 //    QBoxLayout *alarmLineLayout = new QHBoxLayout(topLayout);
     mGeneral->initAlarm(topFrame,topLayout);
     mGeneral->enableAlarm( false );
-    mGeneral->initCategories( topFrame, topLayout );
 
     topLayout->addStretch( 1 );
 
@@ -143,16 +151,15 @@
     QBoxLayout *topLayout = new QVBoxLayout(topFrame);
     topLayout->setSpacing(spacingHint());
 
-    mGeneral->initHeader(topFrame,topLayout);
+    mGeneral->initInvitationBar( topFrame, topLayout );
+    mGeneral->initHeader( topFrame, topLayout );
     mGeneral->initTime(topFrame,topLayout);
-    QBoxLayout *alarmLineLayout = new QHBoxLayout(topLayout);
-    mGeneral->initAlarm(topFrame,alarmLineLayout);
-    alarmLineLayout->addStretch( 1 );
-    mGeneral->initClass(topFrame,alarmLineLayout);
     mGeneral->initDescription(topFrame,topLayout);
-    QBoxLayout *detailsLayout = new QHBoxLayout(topLayout);
-    mGeneral->initCategories( topFrame, detailsLayout );
-    mGeneral->initSecrecy( topFrame, detailsLayout );
+    mGeneral->initAttachments(topFrame,topLayout);
+    connect( mGeneral, SIGNAL( openURL( const KURL& ) ),
+             this, SLOT( openURL( const KURL& ) ) );
+    connect( this, SIGNAL( signalAddAttachments( const QStringList&, const QStringList&, bool ) ),
+             mGeneral, SLOT( addAttachments( const QStringList&, const QStringList&, bool ) ) );
   }
 
   mGeneral->finishSetup();
@@ -167,6 +174,7 @@
 
 void KOEventEditor::setupRecurrence()
 {
+#if 0
   QFrame *topFrame = addPage( i18n("Rec&urrence") );
 
   QWhatsThis::add( topFrame,
@@ -177,29 +185,34 @@
 
   mRecurrence = new KOEditorRecurrence( topFrame );
   topLayout->addWidget( mRecurrence );
+#endif
+  mRecurrenceDialog = new KOEditorRecurrenceDialog( this );
+  mRecurrenceDialog->hide();
+  mRecurrence = mRecurrenceDialog->editor();
 }
 
 void KOEventEditor::setupFreeBusy()
 {
-  QFrame *freeBusyPage = addPage( i18n("&Free/Busy") );
+  QFrame *freeBusyPage = addPage( i18n("&Attendees") );
   QWhatsThis::add( freeBusyPage,
         i18n("The Free/Busy tab allows you to see whether "
        "other attendees are free or busy during your event.") );
 
   QBoxLayout *topLayout = new QVBoxLayout( freeBusyPage );
 
-  mFreeBusy = new KOEditorFreeBusy( spacingHint(), freeBusyPage );
+  mAttendeeEditor = mFreeBusy = new KOEditorFreeBusy( spacingHint(), freeBusyPage );
   topLayout->addWidget( mFreeBusy );
 }
 
-void KOEventEditor::editIncidence( Incidence *incidence )
+void KOEventEditor::editIncidence( Incidence *incidence, Calendar *calendar )
 {
   Event*event = dynamic_cast<Event*>(incidence);
   if ( event ) {
     init();
 
     mEvent = event;
-    readEvent(mEvent);
+    mCalendar = calendar;
+    readEvent( mEvent, mCalendar );
   }
 
   setCaption( i18n("Edit Event") );
@@ -216,8 +229,6 @@
 void KOEventEditor::setDates( const QDateTime &from, const QDateTime &to, bool allDay )
 {
   mGeneral->setDefaults( from, to, allDay );
-  mDetails->setDefaults();
-  mAttachments->setDefaults();
   mRecurrence->setDefaults( from, to, allDay );
   if( mFreeBusy ) {
     if ( allDay )
@@ -273,7 +284,7 @@
       kdDebug(5850) << "Event changed\n";
       //IncidenceChanger::assignIncidence( mEvent, event );
       writeEvent( mEvent );
-      mChanger->changeIncidence( oldEvent, mEvent );
+      mChanger->changeIncidence( oldEvent, mEvent, -1, mIsCounter );
     }
     delete event;
     delete oldEvent;
@@ -283,6 +294,7 @@
     mEvent->setOrganizer( Person( KOPrefs::instance()->fullName(),
                           KOPrefs::instance()->email() ) );
     writeEvent( mEvent );
+    // NOTE: triggered by addIncidence, the kolab resource might open a non-modal dialog (parent is not available in the resource) to select a resource folder. Thus the user can close this dialog before addIncidence() returns.
     if ( !mChanger->addIncidence( mEvent, this ) ) {
       delete mEvent;
       mEvent = 0;
@@ -300,6 +312,7 @@
   kdDebug(5850) << "KOEventEditor::processCancel()" << endl;
 
   if ( mFreeBusy ) mFreeBusy->cancelReload();
+  if ( mIsCounter ) deleteEvent();
 }
 
 void KOEventEditor::deleteEvent()
@@ -312,12 +325,10 @@
   reject();
 }
 
-void KOEventEditor::readEvent( Event *event, bool tmpl )
+void KOEventEditor::readEvent( Event *event, Calendar *calendar, bool tmpl )
 {
-  mGeneral->readEvent( event, tmpl );
-  mDetails->readEvent( event );
+  mGeneral->readEvent( event, calendar, tmpl );
   mRecurrence->readIncidence( event );
-  mAttachments->readIncidence( event );
 //  mAlarms->readIncidence( event );
   if ( mFreeBusy ) {
     mFreeBusy->readEvent( event );
@@ -331,8 +342,8 @@
 void KOEventEditor::writeEvent( Event *event )
 {
   mGeneral->writeEvent( event );
-  mDetails->writeEvent( event );
-  mAttachments->writeIncidence( event );
+  if ( mFreeBusy )
+    mFreeBusy->writeEvent( event );
 
   cancelRemovedAttendees( event );
 
@@ -365,7 +376,7 @@
         i18n("Template does not contain a valid event.") );
   } else {
     kdDebug(5850) << "KOEventEditor::slotLoadTemplate(): readTemplate" << endl;
-    readEvent( events.first(), true );
+    readEvent( events.first(), 0, true );
   }
 }
 
@@ -387,4 +398,12 @@
   return mGeneral->typeAheadReceiver();
 }
 
+void KOEventEditor::updateRecurrenceSummary()
+{
+  Event *ev =  new Event();
+  writeEvent( ev );
+  mGeneral->updateRecurrenceSummary( IncidenceFormatter::recurrenceString( ev ) );
+  delete ev;
+}
+
 #include "koeventeditor.moc"
Index: korganizer/koeditorfreebusy.cpp
===================================================================
--- korganizer/koeditorfreebusy.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorfreebusy.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,6 +27,7 @@
 #include <qlabel.h>
 #include <qcombobox.h>
 #include <qpushbutton.h>
+#include <qvaluevector.h>
 #include <qwhatsthis.h>
 
 #include <kdebug.h>
@@ -34,11 +35,21 @@
 #include <kiconloader.h>
 #include <kmessagebox.h>
 
+#ifndef KORG_NOKABC
+#include <kabc/addresseedialog.h>
+#include <kabc/vcardconverter.h>
+#include <libkdepim/addressesdialog.h>
+#include <libkdepim/addresseelineedit.h>
+#include <libkdepim/distributionlist.h>
+#include <kabc/stdaddressbook.h>
+#endif
+
 #include <libkcal/event.h>
 #include <libkcal/freebusy.h>
 
 #include <kdgantt/KDGanttView.h>
 #include <kdgantt/KDGanttViewTaskItem.h>
+#include <kdgantt/KDGanttViewSubwidgets.h>
 
 #include "koprefs.h"
 #include "koglobals.h"
@@ -48,14 +59,16 @@
 
 #include "koeditorfreebusy.h"
 
-
+// The FreeBusyItem is the whole line for a given attendee.
+// Individual "busy" periods are created as sub-items of this item.
+//
 // We can't use the CustomListViewItem base class, since we need a
 // different inheritance hierarchy for supporting the Gantt view.
 class FreeBusyItem : public KDGanttViewTaskItem
 {
   public:
     FreeBusyItem( Attendee *attendee, KDGanttView *parent ) :
-      KDGanttViewTaskItem( parent ), mAttendee( attendee ), mTimerID( 0 ),
+      KDGanttViewTaskItem( parent, parent->lastItem() ), mAttendee( attendee ), mTimerID( 0 ),
       mIsDownloading( false )
     {
       Q_ASSERT( attendee );
@@ -115,14 +128,27 @@
 
 void FreeBusyItem::updateItem()
 {
-  setListViewText( 0, mAttendee->name() );
-  setListViewText( 1, mAttendee->email() );
-  setListViewText( 2, mAttendee->roleStr() );
-  setListViewText( 3, mAttendee->statusStr() );
-  if ( mAttendee->RSVP() && !mAttendee->email().isEmpty() )
-    setPixmap( 4, KOGlobals::self()->smallIcon( "mailappt" ) );
-  else
-    setPixmap( 4, KOGlobals::self()->smallIcon( "nomailappt" ) );
+  setListViewText( 0, mAttendee->fullName() );
+  switch ( mAttendee->status() ) {
+    case Attendee::Accepted:
+      setPixmap( 0, KOGlobals::self()->smallIcon( "ok" ) );
+      break;
+    case Attendee::Declined:
+      setPixmap( 0, KOGlobals::self()->smallIcon( "no" ) );
+      break;
+    case Attendee::NeedsAction:
+    case Attendee::InProcess:
+      setPixmap( 0, KOGlobals::self()->smallIcon( "help" ) );
+      break;
+    case Attendee::Tentative:
+      setPixmap( 0, KOGlobals::self()->smallIcon( "apply" ) );
+      break;
+    case Attendee::Delegated:
+      setPixmap( 0, KOGlobals::self()->smallIcon( "mail_forward" ) );
+      break;
+    default:
+      setPixmap( 0, QPixmap() );
+  }
 }
 
 
@@ -142,6 +168,13 @@
       newSubItem->setStartTime( (*it).start() );
       newSubItem->setEndTime( (*it).end() );
       newSubItem->setColors( Qt::red, Qt::red, Qt::red );
+      QString toolTip;
+      if ( !(*it).summary().isEmpty() )
+        toolTip += "<b>" + (*it).summary() + "</b><br/>";
+      if ( !(*it).location().isEmpty() )
+        toolTip += i18n( "Location: %1" ).arg( (*it).location() );
+      if ( !toolTip.isEmpty() )
+        newSubItem->setTooltipText( toolTip );
     }
     setFreeBusy( fb );
     setShowNoInformation( false );
@@ -167,14 +200,17 @@
   mIsDownloading = false;
 }
 
+////
 
 KOEditorFreeBusy::KOEditorFreeBusy( int spacing, QWidget *parent,
                                     const char *name )
-  : QWidget( parent, name )
+  : KOAttendeeEditor( parent, name )
 {
   QVBoxLayout *topLayout = new QVBoxLayout( this );
   topLayout->setSpacing( spacing );
 
+  initOrganizerWidgets( this, topLayout );
+
   // Label for status summary information
   // Uses the tooltip palette to highlight it
   mIsOrganizer = false; // Will be set later. This is just valgrind silencing
@@ -252,11 +288,7 @@
   topLayout->addWidget( mGanttView );
   // Remove the predefined "Task Name" column
   mGanttView->removeColumn( 0 );
-  mGanttView->addColumn( i18n("Name"), 180 );
-  mGanttView->addColumn( i18n("Email"), 180 );
-  mGanttView->addColumn( i18n("Role"), 60 );
-  mGanttView->addColumn( i18n("Status"), 100 );
-  mGanttView->addColumn( i18n("RSVP"), 35 );
+  mGanttView->addColumn( i18n("Attendee") );
   if ( KOPrefs::instance()->mCompactDialogs ) {
     mGanttView->setFixedHeight( 78 );
   }
@@ -279,18 +311,39 @@
     mGanttView->setHourFormat( KDGanttView::Hour_12 );
   else
     mGanttView->setHourFormat( KDGanttView::Hour_24_FourDigit );
+
+  // mEventRectangle is the colored rectangle representing the event being modified
+  mEventRectangle = new KDIntervalColorRectangle( mGanttView );
+  mEventRectangle->setColor( Qt::magenta );
+  mGanttView->addIntervalBackgroundColor( mEventRectangle );
+
   connect( mGanttView, SIGNAL ( timeIntervalSelected( const QDateTime &,
                                                       const QDateTime & ) ),
            mGanttView, SLOT( zoomToSelection( const QDateTime &,
                                               const  QDateTime & ) ) );
   connect( mGanttView, SIGNAL( lvItemDoubleClicked( KDGanttViewItem * ) ),
            SLOT( editFreeBusyUrl( KDGanttViewItem * ) ) );
+  connect( mGanttView, SIGNAL( intervalColorRectangleMoved( const QDateTime&, const QDateTime& ) ),
+           this, SLOT( slotIntervalColorRectangleMoved( const QDateTime&, const QDateTime& ) ) );
 
+  connect( mGanttView, SIGNAL(lvSelectionChanged(KDGanttViewItem*)),
+          this, SLOT(updateAttendeeInput()) );
+  connect( mGanttView, SIGNAL(lvItemLeftClicked(KDGanttViewItem*)),
+           this, SLOT(showAttendeeStatusMenu()) );
+  connect( mGanttView, SIGNAL(lvItemRightClicked(KDGanttViewItem*)),
+           this, SLOT(showAttendeeStatusMenu()) );
+  connect( mGanttView, SIGNAL(lvMouseButtonClicked(int, KDGanttViewItem*, const QPoint&, int)),
+           this, SLOT(listViewClicked(int, KDGanttViewItem*)) );
+
   FreeBusyManager *m = KOGroupware::instance()->freeBusyManager();
   connect( m, SIGNAL( freeBusyRetrieved( KCal::FreeBusy *, const QString & ) ),
            SLOT( slotInsertFreeBusy( KCal::FreeBusy *, const QString & ) ) );
 
   connect( &mReloadTimer, SIGNAL( timeout() ), SLOT( autoReload() ) );
+
+  initEditWidgets( this, topLayout );
+  connect( mRemoveButton, SIGNAL(clicked()),
+           SLOT(removeAttendee()) );
 }
 
 KOEditorFreeBusy::~KOEditorFreeBusy()
@@ -318,24 +371,14 @@
   FreeBusyItem* item = new FreeBusyItem( attendee, mGanttView );
   if ( readFBList )
     updateFreeBusyData( item );
+  else {
+    clearSelection();
+    mGanttView->setSelected( item, true );
+  }
   updateStatusSummary();
+  emit updateAttendeeSummary( mGanttView->childCount() );
 }
 
-void KOEditorFreeBusy::updateAttendee( Attendee *attendee )
-{
-  FreeBusyItem *anItem =
-      static_cast<FreeBusyItem *>( mGanttView->firstChild() );
-  while( anItem ) {
-    if( anItem->attendee() == attendee ) {
-      anItem->updateItem();
-      updateFreeBusyData( anItem );
-      updateStatusSummary();
-      break;
-    }
-    anItem = static_cast<FreeBusyItem *>( anItem->nextSibling() );
-  }
-}
-
 void KOEditorFreeBusy::clearAttendees()
 {
   mGanttView->clear();
@@ -355,11 +398,27 @@
 
 void KOEditorFreeBusy::readEvent( Event *event )
 {
+  bool block = updateEnabled();
+  setUpdateEnabled( false );
+  clearAttendees();
+
   setDateTimes( event->dtStart(), event->dtEnd() );
   mIsOrganizer = KOPrefs::instance()->thatIsMe( event->organizer().email() );
   updateStatusSummary();
+  clearSelection();
+  KOAttendeeEditor::readEvent( event );
+
+  setUpdateEnabled( block );
+  emit updateAttendeeSummary( mGanttView->childCount() );
 }
 
+void KOEditorFreeBusy::slotIntervalColorRectangleMoved( const QDateTime& start, const QDateTime& end )
+{
+  kdDebug() << k_funcinfo << "slotIntervalColorRectangleMoved " << start << "," << end << endl;
+  mDtStart = start;
+  mDtEnd = end;
+  emit dateTimesChanged( start, end );
+}
 
 void KOEditorFreeBusy::setDateTimes( const QDateTime &start, const QDateTime &end )
 {
@@ -447,8 +506,7 @@
   QDateTime horizonStart = QDateTime( dtFrom.addDays( -15 ).date() );
   mGanttView->setHorizonStart( horizonStart  );
   mGanttView->setHorizonEnd( dtTo.addDays( 15 ) );
-  mGanttView->clearBackgroundColor();
-  mGanttView->setIntervalBackgroundColor( dtFrom, dtTo, Qt::magenta );
+  mEventRectangle->setDateTimes( dtFrom, dtTo );
   mGanttView->setUpdateEnabled( block );
   mGanttView->centerTimelineAfterShow( dtFrom );
 }
@@ -669,4 +727,140 @@
   dialog.exec();
 }
 
+void KOEditorFreeBusy::writeEvent(KCal::Event * event)
+{
+  event->clearAttendees();
+  QValueVector<FreeBusyItem*> toBeDeleted;
+  for ( FreeBusyItem *item = static_cast<FreeBusyItem *>( mGanttView->firstChild() ); item;
+        item = static_cast<FreeBusyItem*>( item->nextSibling() ) )
+  {
+    Attendee *attendee = item->attendee();
+    Q_ASSERT( attendee );
+    /* Check if the attendee is a distribution list and expand it */
+    if ( attendee->email().isEmpty() ) {
+      KPIM::DistributionList list =
+        KPIM::DistributionList::findByName( KABC::StdAddressBook::self(), attendee->name() );
+      if ( !list.isEmpty() ) {
+        toBeDeleted.push_back( item ); // remove it once we are done expanding
+        KPIM::DistributionList::Entry::List entries = list.entries( KABC::StdAddressBook::self() );
+        KPIM::DistributionList::Entry::List::Iterator it( entries.begin() );
+        while ( it != entries.end() ) {
+          KPIM::DistributionList::Entry &e = ( *it );
+          ++it;
+          // this calls insertAttendee, which appends
+          insertAttendeeFromAddressee( e.addressee, attendee );
+          // TODO: duplicate check, in case it was already added manually
+        }
+      }
+    } else {
+      bool skip = false;
+      if ( attendee->email().endsWith( "example.net" ) ) {
+        if ( KMessageBox::warningYesNo( this, i18n("%1 does not look like a valid email address. "
+                "Are you sure you want to invite this participant?").arg( attendee->email() ),
+              i18n("Invalid email address") ) != KMessageBox::Yes ) {
+          skip = true;
+        }
+      }
+      if ( !skip ) {
+        event->addAttendee( new Attendee( *attendee ) );
+      }
+    }
+  }
+
+  KOAttendeeEditor::writeEvent( event );
+
+  // cleanup
+  QValueVector<FreeBusyItem*>::iterator it;
+  for( it = toBeDeleted.begin(); it != toBeDeleted.end(); ++it ) {
+    delete *it;
+  }
+}
+
+KCal::Attendee * KOEditorFreeBusy::currentAttendee() const
+{
+  KDGanttViewItem *item = mGanttView->selectedItem();
+  FreeBusyItem *aItem = static_cast<FreeBusyItem*>( item );
+  if ( !aItem )
+    return 0;
+  return aItem->attendee();
+}
+
+void KOEditorFreeBusy::updateCurrentItem()
+{
+  FreeBusyItem* item = static_cast<FreeBusyItem*>( mGanttView->selectedItem() );
+  if ( item ) {
+    item->updateItem();
+    updateFreeBusyData( item );
+    updateStatusSummary();
+  }
+}
+
+void KOEditorFreeBusy::removeAttendee()
+{
+  FreeBusyItem *item = static_cast<FreeBusyItem*>( mGanttView->selectedItem() );
+  if ( !item )
+    return;
+
+  Attendee *delA = new Attendee( item->attendee()->name(), item->attendee()->email(),
+                                 item->attendee()->RSVP(), item->attendee()->status(),
+                                 item->attendee()->role(), item->attendee()->uid() );
+  mdelAttendees.append( delA );
+  delete item;
+
+  updateStatusSummary();
+  updateAttendeeInput();
+  emit updateAttendeeSummary( mGanttView->childCount() );
+}
+
+void KOEditorFreeBusy::clearSelection() const
+{
+  KDGanttViewItem *item = mGanttView->selectedItem();
+  if ( item )
+    mGanttView->setSelected( item, false );
+  mGanttView->repaint();
+  item->repaint();
+}
+
+void KOEditorFreeBusy::changeStatusForMe(KCal::Attendee::PartStat status)
+{
+  const QStringList myEmails = KOPrefs::instance()->allEmails();
+  for ( FreeBusyItem *item = static_cast<FreeBusyItem *>( mGanttView->firstChild() ); item;
+        item = static_cast<FreeBusyItem*>( item->nextSibling() ) )
+  {
+    for ( QStringList::ConstIterator it2( myEmails.begin() ), end( myEmails.end() ); it2 != end; ++it2 ) {
+      if ( item->attendee()->email() == *it2 ) {
+        item->attendee()->setStatus( status );
+        item->updateItem();
+      }
+    }
+  }
+}
+
+void KOEditorFreeBusy::showAttendeeStatusMenu()
+{
+  if ( mGanttView->mapFromGlobal( QCursor::pos() ).x() > 22 )
+    return;
+  QPopupMenu popup;
+  popup.insertItem( SmallIcon( "help" ), Attendee::statusName( Attendee::NeedsAction ), Attendee::NeedsAction );
+  popup.insertItem( KOGlobals::self()->smallIcon( "ok" ), Attendee::statusName( Attendee::Accepted ), Attendee::Accepted );
+  popup.insertItem( KOGlobals::self()->smallIcon( "no" ), Attendee::statusName( Attendee::Declined ), Attendee::Declined );
+  popup.insertItem( KOGlobals::self()->smallIcon( "apply" ), Attendee::statusName( Attendee::Tentative ), Attendee::Tentative );
+  popup.insertItem( KOGlobals::self()->smallIcon( "mail_forward" ), Attendee::statusName( Attendee::Delegated ), Attendee::Delegated );
+  popup.insertItem( Attendee::statusName( Attendee::Completed ), Attendee::Completed );
+  popup.insertItem( KOGlobals::self()->smallIcon( "help" ), Attendee::statusName( Attendee::InProcess ), Attendee::InProcess );
+  popup.setItemChecked( currentAttendee()->status(), true );
+  int status = popup.exec( QCursor::pos() );
+  if ( status >= 0 ) {
+    currentAttendee()->setStatus( (Attendee::PartStat)status );
+    updateCurrentItem();
+    updateAttendeeInput();
+  }
+}
+
+void KOEditorFreeBusy::listViewClicked(int button, KDGanttViewItem * item)
+{
+  if ( button == Qt::LeftButton && item == 0 )
+    addNewAttendee();
+}
+
 #include "koeditorfreebusy.moc"
Index: korganizer/koattendeeeditor.h
===================================================================
--- korganizer/koattendeeeditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/koattendeeeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,123 @@
+/*
+    Copyright (c) 2000,2001 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (C) 2003-2004 Reinhold Kainhofer <reinhold@kainhofer.com>
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+        This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KOATTENDEEEDITOR_H
+#define KOATTENDEEEDITOR_H
+
+#include <qwidget.h>
+#include <libkcal/attendee.h>
+
+class QBoxLayout;
+class QComboBox;
+class QCheckBox;
+class QLabel;
+class QPushButton;
+class QHBox;
+
+namespace KPIM {
+  class AddresseeLineEdit;
+}
+
+namespace KABC {
+  class Addressee;
+}
+
+namespace KCal {
+  class Incidence;
+}
+
+/**
+  Common base class for attendee editor and free busy view.
+*/
+class KOAttendeeEditor : public QWidget
+{
+  Q_OBJECT
+  public:
+    KOAttendeeEditor( QWidget *parent, const char *name = 0 );
+
+    virtual void insertAttendee( KCal::Attendee* attendee, bool fetchFB = true ) = 0;
+
+    virtual void readEvent( KCal::Incidence *incidence );
+    virtual void writeEvent( KCal::Incidence *incidence );
+
+    /** return a clone of the event with attendees to be canceld*/
+    void cancelAttendeeEvent( KCal::Incidence *incidence );
+
+  public slots:
+    void acceptForMe();
+    void declineForMe();
+
+  signals:
+    void updateAttendeeSummary( int count );
+
+  protected:
+    void initOrganizerWidgets( QWidget *parent, QBoxLayout *layout );
+    void initEditWidgets( QWidget *parent, QBoxLayout *layout );
+
+    /** Reads values from a KABC::Addressee and inserts a new Attendee
+     * item into the listview with those items. Used when adding attendees
+     * from the addressbook and expanding distribution lists.
+     * The optional Attendee parameter can be used to pass in default values
+     * to be used by the new Attendee. */
+    void insertAttendeeFromAddressee( const KABC::Addressee &a, const KCal::Attendee* at=0 );
+
+    void fillOrganizerCombo();
+
+    virtual KCal::Attendee* currentAttendee() const = 0;
+    virtual void updateCurrentItem() = 0;
+
+    virtual void changeStatusForMe( KCal::Attendee::PartStat status ) = 0;
+
+    virtual bool eventFilter( QObject *, QEvent *);
+
+  protected slots:
+    void addNewAttendee();
+    void openAddressBook();
+
+    void setEnableAttendeeInput( bool enabled );
+    void updateAttendeeInput();
+    void clearAttendeeInput();
+    void fillAttendeeInput( KCal::Attendee *a );
+    void updateAttendee();
+
+  protected:
+    KPIM::AddresseeLineEdit *mNameEdit;
+    QString mUid;
+    QComboBox* mRoleCombo;
+    QCheckBox* mRsvpButton;
+    QComboBox* mStatusCombo;
+
+    QHBox* mOrganizerHBox;
+    QComboBox *mOrganizerCombo; // either we organize it (combo shown)
+    QLabel *mOrganizerLabel; // or someone else does (just a label is shown)
+
+    QLabel* mDelegateLabel;
+
+    QPushButton* mAddButton;
+    QPushButton* mRemoveButton;
+    QPushButton* mAddressBookButton;
+
+    QPtrList<KCal::Attendee> mdelAttendees;
+
+  private:
+    bool mDisableItemUpdate;
+};
+
+#endif
Index: korganizer/kohelper.cpp
===================================================================
--- korganizer/kohelper.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kohelper.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -62,3 +62,23 @@
   }
   return resourceColor;
 }
+
+QString KOHelper::resourceLabel(KCal::Calendar * calendar, KCal::Incidence * incidence)
+{
+  KCal::CalendarResources *calendarResource = dynamic_cast<KCal::CalendarResources*>( calendar );
+  if ( !calendarResource || ! incidence )
+    return QString();
+
+  KCal::ResourceCalendar *resourceCalendar = calendarResource->resource( incidence );
+  if( resourceCalendar ) {
+    if ( !resourceCalendar->subresources().isEmpty() ) {
+      QString subRes = resourceCalendar->subresourceIdentifier( incidence );
+      if ( subRes.isEmpty() )
+        return resourceCalendar->resourceName();
+      return resourceCalendar->labelForSubresource( subRes );
+    }
+    return resourceCalendar->resourceName();
+  }
+
+  return QString();
+}
Index: korganizer/incidencechanger.h
===================================================================
--- korganizer/incidencechanger.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/incidencechanger.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -38,16 +38,12 @@
   bool endChange( Incidence *incidence );
 
   bool addIncidence( Incidence *incidence, QWidget *parent = 0 );
-  bool changeIncidence( Incidence *oldinc, Incidence *newinc, int action = -1 );
+  bool changeIncidence( Incidence *oldinc, Incidence *newinc, int action = -1, bool counter = false );
   bool deleteIncidence( Incidence *incidence );
-  
+
   bool cutIncidence( Incidence *incidence );
   static bool incidencesEqual( Incidence *inc1, Incidence *inc2 );
-  // FIXME: Assigning an incidence to another one (provided they are the same 
-  //        type) doesn't work. It just copies pointers to recurrence, so when
-  //        the first one is deleted, the other one has a stale pointer and will
-  //        crash...
-//  static bool assignIncidence( Incidence *inc1, Incidence *inc2 );
+  static bool assignIncidence( Incidence *inc1, Incidence *inc2 );
 public slots:
   void cancelAttendees( Incidence *incidence );
 
Index: korganizer/agendaview.h
===================================================================
--- korganizer/agendaview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/agendaview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,41 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KORG_AGENDAVIEW_H
+#define KORG_AGENDAVIEW_H
+
+#include "koeventview.h"
+
+namespace KOrg {
+
+/** Base class for single/multi agenda views. */
+class AgendaView : public KOEventView
+{
+  Q_OBJECT
+  public:
+    AgendaView( Calendar *cal,QWidget *parent=0,const char *name=0 );
+
+    virtual void setTypeAheadReceiver( QObject * ) = 0;
+
+  public slots:
+    virtual void finishTypeAhead() = 0;
+};
+
+}
+
+#endif
Index: korganizer/koeditorgeneral.h
===================================================================
--- korganizer/koeditorgeneral.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneral.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -37,9 +37,12 @@
 class QComboBox;
 class KTextEdit;
 class KSqueezedTextLabel;
+class KURL;
+class KOEditorAttachments;
 
 namespace KCal {
 class Incidence;
+class Calendar;
 }
 using namespace KCal;
 
@@ -66,16 +69,16 @@
     KOEditorGeneral (QObject* parent=0,const char* name=0);
     virtual ~KOEditorGeneral();
 
-    void initHeader(QWidget *,QBoxLayout *);
+    void initHeader( QWidget *parent,QBoxLayout *topLayout );
     void initDescription(QWidget *,QBoxLayout *);
     void initSecrecy(QWidget *,QBoxLayout *);
-    void initCategories(QWidget *,QBoxLayout *);
     void initAlarm(QWidget *,QBoxLayout *);
+    void initAttachments(QWidget *,QBoxLayout *);
 
     /** Set widgets to default values */
     void setDefaults(bool allDay);
     /** Read event object and setup widgets accordingly */
-    void readIncidence(Incidence *);
+    void readIncidence(Incidence *event, Calendar *calendar);
     /** Write event settings to event object */
     void writeIncidence(Incidence *);
 
@@ -92,21 +95,28 @@
   public slots:
     void setCategories(const QStringList &categories);
     void selectCategories();
+    void addAttachments( const QStringList &attachments,
+                         const QStringList& mimeTypes = QStringList(),
+                         bool inlineAttachment = false );
 
+
   protected slots:
     void editAlarms();
     void updateAlarmWidgets();
     void updateDefaultAlarmTime();
+    void updateAttendeeSummary( int count );
 
   signals:
     void openCategoryDialog();
+    void updateCategoryConfig();
     void focusReceivedSignal();
-
+    void openURL( const KURL & );
   protected:
     Alarm *alarmFromSimplePage() const;
 
     QLineEdit               *mSummaryEdit;
     QLineEdit               *mLocationEdit;
+    QLabel                  *mAttendeeSummaryLabel;
     QLabel                  *mAlarmBell;
     QWidgetStack            *mAlarmStack;
     QLabel                  *mAlarmInfoLabel;
@@ -119,6 +129,8 @@
     QComboBox               *mSecrecyCombo;
     QPushButton             *mCategoriesButton;
     KSqueezedTextLabel      *mCategoriesLabel;
+    KOEditorAttachments     *mAttachments;
+    QLabel                  *mResourceLabel;
 
     enum AlarmStackPages { SimpleAlarmPage, AdvancedAlarmLabel };
 
Index: korganizer/korganizerifaceimpl.cpp
===================================================================
--- korganizer/korganizerifaceimpl.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizerifaceimpl.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -89,3 +89,15 @@
 {
   return mActionManager->addIncidence( ical );
 }
+
+void KOrganizerIfaceImpl::loadProfile( const QString& path )
+{
+    mActionManager->loadProfile( path );
+}
+
+void KOrganizerIfaceImpl::saveToProfile( const QString& path ) const
+{
+    mActionManager->saveToProfile( path );
+}
+
+
Index: korganizer/timelineitem.cpp
===================================================================
--- korganizer/timelineitem.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/timelineitem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,159 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "timelineitem.h"
+
+#include "kohelper.h"
+
+#define protected public
+#include <kdgantt/KDGanttViewSubwidgets.h>
+#undef public
+
+#include <libkcal/calendar.h>
+#include <libkcal/incidenceformatter.h>
+#include <libkcal/resourcecalendar.h>
+
+using namespace KOrg;
+using namespace KCal;
+
+TimelineItem::TimelineItem( const QString &label, KDGanttView * parent) :
+    KDGanttViewTaskItem( parent )
+{
+  setListViewText( 0, label );
+  setDisplaySubitemsAsGroup( true );
+  if ( listView() )
+    listView()->setRootIsDecorated( false );
+}
+
+void TimelineItem::insertIncidence(KCal::Incidence * incidence, const QDateTime & _start, const QDateTime & _end)
+{
+  QDateTime start = incidence->dtStart(), end = incidence->dtEnd();
+  if ( _start.isValid() )
+    start = _start;
+  if ( _end.isValid() )
+    end = _end;
+  if ( incidence->doesFloat() )
+    end = end.addDays( 1 );
+
+  typedef QValueList<TimelineSubItem*> ItemList;
+  ItemList list = mItemMap[incidence];
+  for ( ItemList::ConstIterator it = list.constBegin(); it != list.constEnd(); ++it )
+    if ( (*it)->startTime() == start && (*it)->endTime() == end )
+      return;
+
+  TimelineSubItem * item = new TimelineSubItem( incidence, this );
+  QColor c1, c2, c3;
+  colors( c1, c2, c3 );
+  item->setColors( c1, c2, c3 );
+
+  item->setStartTime( start );
+  item->setOriginalStart( start );
+  item->setEndTime( end );
+
+  mItemMap[incidence].append( item );
+}
+
+void TimelineItem::removeIncidence(KCal::Incidence * incidence)
+{
+  typedef QValueList<TimelineSubItem*> ItemList;
+  ItemList list = mItemMap[incidence];
+  for ( ItemList::ConstIterator it = list.constBegin(); it != list.constEnd(); ++it )
+    delete *it;
+  mItemMap.remove( incidence );
+}
+
+void TimelineItem::moveItems(KCal::Incidence * incidence, int delta, int duration)
+{
+  typedef QValueList<TimelineSubItem*> ItemList;
+  ItemList list = mItemMap[incidence];
+  for ( ItemList::ConstIterator it = list.constBegin(); it != list.constEnd(); ++it ) {
+    QDateTime start = (*it)->originalStart();
+    start = start.addSecs( delta );
+    (*it)->setStartTime( start );
+    (*it)->setOriginalStart( start );
+    (*it)->setEndTime( start.addSecs( duration ) );
+  }
+}
+
+
+TimelineSubItem::TimelineSubItem(KCal::Incidence * incidence, TimelineItem * parent) :
+    KDGanttViewTaskItem( parent ),
+    mIncidence( incidence ),
+    mLeft( 0 ),
+    mRight( 0 ),
+    mMarkerWidth( 0 )
+{
+  setTooltipText( IncidenceFormatter::toolTipString( incidence ) );
+  if ( !incidence->isReadOnly() ) {
+    setMoveable( true );
+    setResizeable( true );
+  }
+}
+
+TimelineSubItem::~TimelineSubItem()
+{
+  delete mLeft;
+  delete mRight;
+}
+
+void TimelineSubItem::showItem(bool show, int coordY)
+{
+  KDGanttViewTaskItem::showItem( show, coordY );
+  int y;
+  if ( coordY != 0 )
+    y = coordY;
+  else
+    y = getCoordY();
+  int startX = myGanttView->myTimeHeader->getCoordX(myStartTime);
+  int endX = myGanttView->myTimeHeader->getCoordX(myEndTime);
+
+  const int mw = QMAX( 1, QMIN( 4, endX - startX ) );
+  if ( !mLeft || mw != mMarkerWidth ) {
+    if ( !mLeft ) {
+      mLeft = new KDCanvasPolygon( myGanttView->myTimeTable, this, Type_is_KDGanttViewItem );
+      mLeft->setBrush( Qt::black );
+    }
+    QPointArray a = QPointArray( 4 );
+    a.setPoint( 0, 0, -mw -myItemSize/2 - 2 );
+    a.setPoint( 1, mw, -myItemSize/2 - 2 );
+    a.setPoint( 2, mw, myItemSize/2 + 2 );
+    a.setPoint( 3, 0, myItemSize/2 + mw + 2 );
+    mLeft->setPoints( a );
+  }
+  if ( !mRight || mw != mMarkerWidth ) {
+    if ( !mRight ) {
+      mRight = new KDCanvasPolygon( myGanttView->myTimeTable, this, Type_is_KDGanttViewItem );
+      mRight->setBrush( Qt::black );
+    }
+    QPointArray a = QPointArray( 4 );
+    a.setPoint( 0, -mw, -myItemSize/2 - 2 );
+    a.setPoint( 1, 0, -myItemSize/2 - mw - 2 );
+    a.setPoint( 2, 0, myItemSize/2 + mw + 2 );
+    a.setPoint( 3, -mw, myItemSize/2 + 2 );
+    mRight->setPoints( a );
+  }
+  mMarkerWidth = mw;
+  mLeft->setX( startX );
+  mLeft->setY( y );
+  mLeft->setZ( startShape->z() - 1 );
+  mLeft->show();
+  mRight->setX( endX );
+  mRight->setY( y );
+  mRight->setZ( startShape->z() - 1 );
+  mRight->show();
+}
Index: korganizer/koeventeditor.h
===================================================================
--- korganizer/koeventeditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeventeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -29,6 +29,7 @@
 
 class KOEditorGeneralEvent;
 class KOEditorRecurrence;
+class KOEditorRecurrenceDialog;
 class KOEditorFreeBusy;
 
 class SaveTemplateDialog;
@@ -63,17 +64,17 @@
       Clear event win for new event
     */
     void newEvent();
-    
+
     /**
-      Sets the given summary and description. If description is empty and the 
-      summary contains multiple lines, the summary will be used as description 
+      Sets the given summary and description. If description is empty and the
+      summary contains multiple lines, the summary will be used as description
       and only the first line of summary will be used as the summary.
     */
     void setTexts( const QString &summary, const QString &description = QString::null );
     /**
       Edit an existing event.
     */
-    void editIncidence( Incidence * );
+    void editIncidence( Incidence *incidence, Calendar *calendar );
 
     /**
       Set widgets to the given date/time values
@@ -84,7 +85,7 @@
       Read event object and setup widgets accordingly. If tmpl is true, the
       event is read as template, i.e. the time and date information isn't set.
     */
-    void readEvent( Event *, bool tmpl = false );
+    void readEvent( Event *event, Calendar *calendar, bool tmpl = false );
     /**
       Write event settings to event object
     */
@@ -100,6 +101,7 @@
     void deleteEvent();
 
     void slotSaveTemplate( const QString & );
+    void updateRecurrenceSummary();
 
   protected:
     QString type() { return "Event"; }
@@ -119,8 +121,10 @@
 
   private:
     Event *mEvent;
+    Calendar* mCalendar;
 
     KOEditorGeneralEvent *mGeneral;
+    KOEditorRecurrenceDialog *mRecurrenceDialog;
     KOEditorRecurrence   *mRecurrence;
     KOEditorFreeBusy     *mFreeBusy;
 };
Index: korganizer/koagendaitem.h
===================================================================
--- korganizer/koagendaitem.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koagendaitem.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -157,6 +157,7 @@
     void paintFrame(QPainter *p, const QColor &color);
     void paintEventIcon(QPainter *p, int &x, int ft);
     void paintTodoIcon(QPainter *p, int &x, int ft);
+    void paintAlarmIcon(QPainter *p, int &x, int ft);
 
     // paint all visible icons
     void paintIcons(QPainter *p, int &x, int ft);
Index: korganizer/actionmanager.cpp
===================================================================
--- korganizer/actionmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/actionmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,9 +50,12 @@
 #include <libkcal/htmlexport.h>
 #include <libkcal/htmlexportsettings.h>
 
+#include <libkmime/kmime_message.h>
+
 #include <dcopclient.h>
 #include <kaction.h>
 #include <kfiledialog.h>
+#include <kiconloader.h>
 #include <kio/netaccess.h>
 #include <kkeydialog.h>
 #include <kpopupmenu.h>
@@ -67,6 +70,7 @@
 #include <kactionclasses.h>
 
 #include <qapplication.h>
+#include <qcursor.h>
 #include <qtimer.h>
 #include <qlabel.h>
 
@@ -342,7 +346,7 @@
                             mCalendarView->viewManager(),
                             SLOT( showNextXView() ),
                             mACollection, "view_nextx" );
-  mNextXDays->setText( i18n( "&Next Day", "&Next %n Days",
+  mNextXDays->setText( i18n( "&Next Day", "Ne&xt %n Days",
                              KOPrefs::instance()->mNextXDays ) );
   new KAction( i18n("W&ork Week"),
                KOGlobals::self()->smallIcon( "5days" ), 0,
@@ -368,6 +372,10 @@
                KOGlobals::self()->smallIcon( "journal" ), 0,
                mCalendarView->viewManager(), SLOT( showJournalView() ),
                mACollection, "view_journal" );
+  new KAction( i18n("&Timeline View"),
+               KOGlobals::self()->smallIcon( "timeline" ), 0,
+               mCalendarView->viewManager(), SLOT( showTimelineView() ),
+               mACollection, "view_timeline" );
 
   //~~~~~~~~~~~~~~~~~~~~~~~~~~~ FILTERS ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   new KAction( i18n("&Refresh"), 0,
@@ -525,6 +533,11 @@
   connect( mCalendarView,SIGNAL( groupEventsSelected( bool ) ),
            action,SLOT( setEnabled( bool ) ) );
 
+  mForwardEvent = new KAction( i18n("&Send as iCalendar..."), "mail_forward", 0,
+                               mCalendarView, SLOT(schedule_forward()),
+                               mACollection, "schedule_forward" );
+  mForwardEvent->setEnabled( false );
+
   action = new KAction( i18n("&Mail Free Busy Information..."), 0,
                         mCalendarView, SLOT( mailFreeBusy() ),
                         mACollection, "mail_freebusy" );
@@ -1476,6 +1489,7 @@
   mCopyAction->setEnabled( enabled );
   mDeleteAction->setEnabled( enabled );
   mPublishEvent->setEnabled( enabled );
+  mForwardEvent->setEnabled( enabled );
 }
 
 void ActionManager::keyBindings()
@@ -1531,6 +1545,101 @@
   mCalendarView->newEvent( summary, description, attachment, attendees );
 }
 
+void ActionManager::openEventEditor( const QString & summary,
+                                     const QString & description,
+                                     const QString & uri,
+                                     const QString & file,
+                                     const QStringList & attendees,
+                                     const QString & attachmentMimetype )
+{
+  int action = KOPrefs::instance()->defaultEmailAttachMethod();
+  if ( attachmentMimetype != "message/rfc822" ) {
+    action = KOPrefs::Link;
+  } else if ( KOPrefs::instance()->defaultEmailAttachMethod() == KOPrefs::Ask ) {
+    KPopupMenu *menu = new KPopupMenu( 0 );
+    menu->insertItem( i18n("Attach as &link"), KOPrefs::Link );
+    menu->insertItem( i18n("Attach &inline"), KOPrefs::InlineFull );
+    menu->insertItem( i18n("Attach inline &without attachments"), KOPrefs::InlineBody );
+    menu->insertSeparator();
+    menu->insertItem( SmallIcon("cancel"), i18n("C&ancel"), KOPrefs::Ask );
+    action = menu->exec( QCursor::pos(), 0 );
+    delete menu;
+  }
+
+  QString attData;
+  KTempFile tf;
+  tf.setAutoDelete( true );
+  switch ( action ) {
+    case KOPrefs::Ask:
+      return;
+    case KOPrefs::Link:
+      attData = uri;
+      break;
+    case KOPrefs::InlineFull:
+      attData = file;
+      break;
+    case KOPrefs::InlineBody:
+    {
+      QFile f( file );
+      if ( !f.open( IO_ReadOnly ) )
+        return;
+      KMime::Message *msg = new KMime::Message();
+      msg->setContent( QCString( f.readAll() ) );
+      QCString head = msg->head();
+      msg->parse();
+      if ( msg == msg->textContent() || msg->textContent() == 0 ) { // no attachments
+        attData = file;
+      } else {
+        if ( KMessageBox::warningContinueCancel( 0,
+              i18n("Removing attachments from an email might invalidate its signature."),
+              i18n("Remove Attachments"), KStdGuiItem::cont(), "BodyOnlyInlineAttachment" )
+              != KMessageBox::Continue )
+          return;
+        // due to kmime shortcomings in KDE3, we need to assemble the result manually
+        int begin = 0;
+        int end = head.find( '\n' );
+        bool skipFolded = false;
+        while ( end >= 0 && end > begin ) {
+          if ( head.find( "Content-Type:", begin, false ) != begin &&
+                head.find( "Content-Transfer-Encoding:", begin, false ) != begin &&
+                !(skipFolded && (head[begin] == ' ' || head[end] == '\t')) ) {
+            QCString line = head.mid( begin, end - begin );
+            tf.file()->writeBlock( line.data(), line.length() );
+            tf.file()->writeBlock( "\n", 1 );
+            skipFolded = false;
+          } else {
+            skipFolded = true;
+          }
+
+          begin = end + 1;
+          end = head.find( '\n', begin );
+          if ( end < 0 && begin < (int)head.length() )
+            end = head.length() - 1;
+        }
+        QCString cte = msg->textContent()->contentTransferEncoding()->as7BitString();
+        if ( !cte.stripWhiteSpace().isEmpty() ) {
+          tf.file()->writeBlock( cte.data(), cte.length() );
+          tf.file()->writeBlock( "\n", 1 );
+        }
+        QCString ct = msg->textContent()->contentType()->as7BitString();
+        if ( !ct.stripWhiteSpace().isEmpty() )
+          tf.file()->writeBlock( ct.data(), ct.length() );
+        tf.file()->writeBlock( "\n", 1 );
+        tf.file()->writeBlock( msg->textContent()->body() );
+        attData = tf.name();
+      }
+      tf.close();
+      delete msg;
+      break;
+    }
+    default:
+      // menu could have been closed by cancel, if so, do nothing
+      return;
+  }
+
+  mCalendarView->newEvent( summary, description, attData, attendees, attachmentMimetype, action != KOPrefs::Link );
+}
+
 void ActionManager::openTodoEditor( const QString& text )
 {
   mCalendarView->newTodo( text );
@@ -1551,6 +1660,44 @@
   mCalendarView->newTodo( summary, description, attachment, attendees );
 }
 
+void ActionManager::openTodoEditor(const QString & summary,
+                                   const QString & description,
+                                   const QString & uri,
+                                   const QString & file,
+                                   const QStringList & attendees,
+                                   const QString & attachmentMimetype)
+{
+  int action = KOPrefs::instance()->defaultTodoAttachMethod();
+  if ( attachmentMimetype != "message/rfc822" ) {
+    action = KOPrefs::TodoAttachLink;
+  } else if ( KOPrefs::instance()->defaultTodoAttachMethod() == KOPrefs::TodoAttachAsk ) {
+    KPopupMenu *menu = new KPopupMenu( 0 );
+    menu->insertItem( i18n("Attach as &link"), KOPrefs::TodoAttachLink );
+    menu->insertItem( i18n("Attach &inline"), KOPrefs::TodoAttachInlineFull );
+    menu->insertSeparator();
+    menu->insertItem( SmallIcon("cancel"), i18n("C&ancel"), KOPrefs::TodoAttachAsk );
+    action = menu->exec( QCursor::pos(), 0 );
+    delete menu;
+  }
+
+  QString attData;
+  switch ( action ) {
+    case KOPrefs::TodoAttachAsk:
+      return;
+    case KOPrefs::TodoAttachLink:
+      attData = uri;
+      break;
+    case KOPrefs::TodoAttachInlineFull:
+      attData = file;
+      break;
+    default:
+      // menu could have been closed by cancel, if so, do nothing
+      return;
+  }
+
+  mCalendarView->newTodo( summary, description, attData, attendees, attachmentMimetype, action != KOPrefs::Link );
+}
+
 void ActionManager::openJournalEditor( const QDate& date )
 {
   mCalendarView->newJournal( date );
@@ -1600,6 +1747,12 @@
   goDate( KGlobal::locale()->readDate( date ) );
 }
 
+void ActionManager::showDate(const QDate & date)
+{
+  mCalendarView->showDate( date );
+}
+
+
 void ActionManager::updateUndoAction( const QString &text )
 {
   if ( text.isNull() ) {
@@ -1755,6 +1908,46 @@
   slotAutoArchivingSettingsModified();
 }
 
+void ActionManager::loadProfile( const QString & path )
+{
+  KOPrefs::instance()->writeConfig();
+  KConfig* const cfg = KOPrefs::instance()->config();
+
+  const KConfig profile( path+"/korganizerrc", /*read-only=*/false, /*useglobals=*/false );
+  const QStringList groups = profile.groupList();
+  for ( QStringList::ConstIterator it = groups.begin(), end = groups.end(); it != end; ++it )
+  {
+    cfg->setGroup( *it );
+    typedef QMap<QString, QString> StringMap;
+    const StringMap entries = profile.entryMap( *it );
+    for ( StringMap::ConstIterator it2 = entries.begin(), end = entries.end(); it2 != end; ++it2 )
+    {
+      cfg->writeEntry( it2.key(), it2.data() );
+    }
+  }
+
+  cfg->sync();
+  KOPrefs::instance()->readConfig();
+}
+
+namespace {
+    void copyConfigEntry( KConfig* source, KConfig* dest, const QString& group, const QString& key, const QString& defaultValue=QString() )
+    {
+        source->setGroup( group );
+        dest->setGroup( group );
+        dest->writeEntry( key, source->readEntry( key, defaultValue ) );
+    }
+}
+
+void ActionManager::saveToProfile( const QString & path ) const
+{
+  KOPrefs::instance()->writeConfig();
+  KConfig* const cfg = KOPrefs::instance()->config();
+
+  KConfig profile( path+"/korganizerrc", /*read-only=*/false, /*useglobals=*/false );
+  ::copyConfigEntry( cfg, &profile, "Views", "Agenda View Calendar Display" );
+}
+
 QWidget *ActionManager::dialogParent()
 {
   return mCalendarView->topLevelWidget();
Index: korganizer/calendarview.h
===================================================================
--- korganizer/calendarview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/calendarview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -280,7 +280,8 @@
       attendees list
     */
     void newEvent( const QString &summary, const QString &description = QString::null,
-                   const QStringList &attachment = QStringList(), const QStringList &attendees = QStringList() );
+                   const QStringList &attachment = QStringList(), const QStringList &attendees = QStringList(),
+                   const QStringList &attachmentMimetypes = QStringList(), bool inlineAttachment = false );
     void newFloatingEvent();
 
     /** Create a read-only viewer dialog for the supplied incidence. It calls the correct showXXX method*/
@@ -333,7 +334,8 @@
     void newSubTodo( Todo * );
 
     void newTodo( const QString &summary, const QString &description = QString::null,
-                  const QStringList &attachments = QStringList(), const QStringList &attendees = QStringList() );
+                  const QStringList &attachments = QStringList(), const QStringList &attendees = QStringList(),
+                  const QStringList &attachmentMimetypes = QStringList(), bool inlineAttachment = false );
 
     void newJournal();
     void newJournal( const QDate &date );
@@ -463,6 +465,7 @@
     void schedule_reply( Incidence *incidence = 0 );
     void schedule_counter( Incidence *incidence = 0 );
     void schedule_declinecounter( Incidence *incidence = 0 );
+    void schedule_forward( Incidence *incidence = 0 );
     void mailFreeBusy( int daysToPublish = 30 );
     void uploadFreeBusy();
 
@@ -481,6 +484,9 @@
     /** Move the current view date to the specified date */
     void goDate( const QDate& date );
 
+    /** Show the given date without changing date selection length. */
+    void showDate( const QDate &date );
+
     /** Move the current view date to today */
     void goToday();
 
Index: korganizer/kogroupware.h
===================================================================
--- korganizer/kogroupware.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kogroupware.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
   Requires the Qt and KDE widget libraries, available at no cost at
   http://www.trolltech.com and http://www.kde.org respectively
 
-  Copyright (c) 2002-2004 Klar‰lvdalens Datakonsult AB
+  Copyright (c) 2002-2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
   This program is free software; you can redistribute it and/or modify
@@ -88,6 +88,8 @@
 
     /** Updates some slot connections when the view incidence changer changes */
     void slotViewNewIncidenceChanger( IncidenceChangerBase* changer );
+
+    void initialCheckForChanges();
   protected:
     KOGroupware( CalendarView*, KCal::CalendarResources* );
 
Index: korganizer/koeditorgeneralevent.cpp
===================================================================
--- korganizer/koeditorgeneralevent.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneralevent.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -46,6 +46,7 @@
 #include <ktextedit.h>
 
 #include <libkcal/event.h>
+#include <libkcal/incidenceformatter.h>
 
 #include "ktimeedit.h"
 #include <libkdepim/kdateedit.h>
@@ -76,8 +77,8 @@
   QWidget::setTabOrder( mStartDateEdit, mStartTimeEdit );
   QWidget::setTabOrder( mStartTimeEdit, mEndDateEdit );
   QWidget::setTabOrder( mEndDateEdit, mEndTimeEdit );
-  QWidget::setTabOrder( mEndTimeEdit, mTimeAssociateButton );
-  QWidget::setTabOrder( mTimeAssociateButton, mAlarmButton );
+  QWidget::setTabOrder( mEndTimeEdit, mAlldayEventCheckbox );
+  QWidget::setTabOrder( mAlldayEventCheckbox, mAlarmButton );
   QWidget::setTabOrder( mAlarmButton, mAlarmTimeEdit );
   QWidget::setTabOrder( mAlarmTimeEdit, mAlarmIncrCombo );
 //   QWidget::setTabOrder( mAlarmIncrCombo, mAlarmSoundButton );
@@ -106,10 +107,10 @@
 
   QFrame *timeBoxFrame = new QFrame(timeGroupBox);
 
-  QGridLayout *layoutTimeBox = new QGridLayout(timeBoxFrame,2,3);
+  QGridLayout *layoutTimeBox = new QGridLayout( timeBoxFrame );
   layoutTimeBox->setSpacing(topLayout->spacing());
+  layoutTimeBox->setColStretch( 3, 1 );
 
-
   mStartDateLabel = new QLabel(i18n("&Start:"),timeBoxFrame);
   layoutTimeBox->addWidget(mStartDateLabel,0,0);
 
@@ -131,21 +132,13 @@
   mEndTimeEdit = new KTimeEdit(timeBoxFrame);
   layoutTimeBox->addWidget(mEndTimeEdit,1,2);
 
-  QHBoxLayout *flagsBox = new QHBoxLayout();
+  mAlldayEventCheckbox = new QCheckBox(i18n("All-&day"),timeBoxFrame);
+  layoutTimeBox->addWidget( mAlldayEventCheckbox, 0, 3 );
+  connect(mAlldayEventCheckbox, SIGNAL(toggled(bool)),SLOT(associateTime(bool)));
 
-  mTimeAssociateButton = new QCheckBox(i18n("T&ime associated"),timeBoxFrame);
-  flagsBox->addWidget(mTimeAssociateButton);
-  connect(mTimeAssociateButton, SIGNAL(toggled(bool)),SLOT(associateTime(bool)));
-
   mDurationLabel = new QLabel( timeBoxFrame );
-  if ( KOPrefs::instance()->mCompactDialogs ) {
-    layoutTimeBox->addMultiCellWidget( mDurationLabel, 3, 3, 0, 3 );
-  } else {
-    flagsBox->addWidget( mDurationLabel, 0, 2 );
-  }
+  layoutTimeBox->addWidget( mDurationLabel, 1, 3 );
 
-  layoutTimeBox->addMultiCellLayout( flagsBox, 2, 2, 0, 3 );
-
   // time widgets are checked if they contain a valid time
   connect(mStartTimeEdit, SIGNAL(timeChanged(QTime)),
           this, SLOT(startTimeChanged(QTime)));
@@ -157,6 +150,30 @@
           this, SLOT(startDateChanged(const QDate&)));
   connect(mEndDateEdit, SIGNAL(dateChanged(const QDate&)),
           this, SLOT(endDateChanged(const QDate&)));
+
+  QBoxLayout *recLayout = new QHBoxLayout();
+  layoutTimeBox->addMultiCellLayout( recLayout, 2, 2, 1, 4 );
+  mRecurrenceSummary = new QLabel( QString(), timeBoxFrame );
+  recLayout->addWidget( mRecurrenceSummary );
+  QPushButton *recEditButton = new QPushButton( i18n("Edit..."), timeBoxFrame );
+  recLayout->addWidget( recEditButton );
+  connect( recEditButton, SIGNAL(clicked()), SIGNAL(editRecurrence()) );
+  recLayout->addStretch( 1 );
+
+  QLabel *label = new QLabel( i18n("Reminder:"), timeBoxFrame );
+  layoutTimeBox->addWidget( label, 3, 0 );
+  QBoxLayout *alarmLineLayout = new QHBoxLayout();
+  layoutTimeBox->addMultiCellLayout( alarmLineLayout, 3, 3, 1, 4 );
+  initAlarm( timeBoxFrame, alarmLineLayout );
+  alarmLineLayout->addStretch( 1 );
+
+  QBoxLayout *secLayout = new QHBoxLayout();
+  layoutTimeBox->addLayout( secLayout, 0, 4 );
+  initSecrecy( timeBoxFrame, secLayout );
+
+  QBoxLayout *classLayout = new QHBoxLayout();
+  layoutTimeBox->addLayout( classLayout, 1, 4 );
+  initClass( timeBoxFrame, classLayout );
 }
 
 void KOEditorGeneralEvent::initClass(QWidget *parent,QBoxLayout *topLayout)
@@ -177,6 +194,30 @@
   freeTimeLabel->setBuddy( mFreeTimeCombo );
 }
 
+void KOEditorGeneralEvent::initInvitationBar(QWidget * parent, QBoxLayout * layout)
+{
+  QBoxLayout *topLayout = new QHBoxLayout( layout );
+  mInvitationBar = new QFrame( parent );
+  mInvitationBar->setPaletteBackgroundColor( KGlobalSettings::alternateBackgroundColor() );
+  topLayout->addWidget( mInvitationBar );
+
+  QBoxLayout *barLayout = new QHBoxLayout( mInvitationBar );
+  barLayout->setSpacing( layout->spacing() );
+  QLabel *label = new QLabel( i18n("You have not yet definitely responded to this invitation." ), mInvitationBar );
+  barLayout->addWidget( label );
+  barLayout->addStretch( 1 );
+  QPushButton *button = new QPushButton( i18n("Accept"), mInvitationBar );
+  connect( button, SIGNAL(clicked()), SIGNAL(acceptInvitation()) );
+  connect( button, SIGNAL(clicked()), mInvitationBar, SLOT(hide()) );
+  barLayout->addWidget( button );
+  button = new QPushButton( i18n("Decline"), mInvitationBar );
+  connect( button, SIGNAL(clicked()), SIGNAL(declineInvitation()) );
+  connect( button, SIGNAL(clicked()), mInvitationBar, SLOT(hide()) );
+  barLayout->addWidget( button );
+
+  mInvitationBar->hide();
+}
+
 void KOEditorGeneralEvent::timeStuffDisable(bool disable)
 {
   mStartTimeEdit->setEnabled( !disable );
@@ -188,9 +229,9 @@
 
 void KOEditorGeneralEvent::associateTime(bool time)
 {
-  timeStuffDisable(!time);
+  timeStuffDisable(time);
   //if(alarmButton->isChecked()) alarmStuffDisable(noTime);
-  allDayChanged(!time);
+  allDayChanged(time);
 }
 
 void KOEditorGeneralEvent::setDateTimes( const QDateTime &start, const QDateTime &end )
@@ -270,17 +311,17 @@
 {
   KOEditorGeneral::setDefaults(allDay);
 
-  mTimeAssociateButton->setChecked(!allDay);
+  mAlldayEventCheckbox->setChecked(allDay);
   timeStuffDisable(allDay);
 
   setDateTimes(from,to);
 }
 
-void KOEditorGeneralEvent::readEvent( Event *event, bool tmpl )
+void KOEditorGeneralEvent::readEvent( Event *event, Calendar *calendar, bool tmpl )
 {
   QString tmpStr;
 
-  mTimeAssociateButton->setChecked(!event->doesFloat());
+  mAlldayEventCheckbox->setChecked(event->doesFloat());
   timeStuffDisable(event->doesFloat());
 
   if ( !tmpl ) {
@@ -297,7 +338,17 @@
     break;
   }
 
-  readIncidence(event);
+  mRecurrenceSummary->setText( IncidenceFormatter::recurrenceString( event ) );
+
+  Attendee *me = event->attendeeByMails( KOPrefs::instance()->allEmails() );
+  if ( me && (me->status() == Attendee::NeedsAction || me->status() == Attendee::Tentative ||
+       me->status() == Attendee::InProcess) ) {
+    mInvitationBar->show();
+  } else {
+    mInvitationBar->hide();
+  }
+
+  readIncidence(event, calendar);
 }
 
 void KOEditorGeneralEvent::writeEvent(Event *event)
@@ -313,7 +364,7 @@
   // temp. until something better happens.
   QString tmpStr;
 
-  if (!mTimeAssociateButton->isChecked()) {
+  if (mAlldayEventCheckbox->isChecked()) {
     event->setFloats(true);
     // need to change this.
     tmpDate = mStartDateEdit->date();
@@ -360,7 +411,7 @@
   // any duration if this happens
   if(mCurrEndDateTime >= mCurrStartDateTime) {
 
-    if (!mTimeAssociateButton->isChecked()) {
+    if (mAlldayEventCheckbox->isChecked()) {
       int daydiff = mCurrStartDateTime.date().daysTo(mCurrEndDateTime.date()) + 1;
       tmpStr = i18n("Duration: ");
       tmpStr.append(i18n("1 Day","%n Days",daydiff));
@@ -402,7 +453,7 @@
   KLocale *l = KGlobal::locale();
 
   QString from,to;
-  if (!mTimeAssociateButton->isChecked()) {
+  if (mAlldayEventCheckbox->isChecked()) {
     from = l->formatDate(mCurrStartDateTime.date());
     to = l->formatDate(mCurrEndDateTime.date());
   } else {
@@ -420,7 +471,7 @@
 {
 //  kdDebug(5850) << "KOEditorGeneralEvent::validateInput()" << endl;
 
-  if (mTimeAssociateButton->isChecked()) {
+  if (!mAlldayEventCheckbox->isChecked()) {
     if (!mStartTimeEdit->inputIsValid()) {
       KMessageBox::sorry( 0,
           i18n("Please specify a valid start time, for example '%1'.")
@@ -453,7 +504,7 @@
   QDateTime startDt,endDt;
   startDt.setDate(mStartDateEdit->date());
   endDt.setDate(mEndDateEdit->date());
-  if (mTimeAssociateButton->isChecked()) {
+  if (!mAlldayEventCheckbox->isChecked()) {
     startDt.setTime(mStartTimeEdit->getTime());
     endDt.setTime(mEndTimeEdit->getTime());
   }
@@ -466,3 +517,8 @@
 
   return KOEditorGeneral::validateInput();
 }
+
+void KOEditorGeneralEvent::updateRecurrenceSummary(const QString & summary)
+{
+  mRecurrenceSummary->setText( summary );
+}
Index: korganizer/koeditorattachments.h
===================================================================
--- korganizer/koeditorattachments.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorattachments.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -33,8 +33,12 @@
 class Attachment;
 }
 
-class QListViewItem;
-class KListView;
+class QIconViewItem;
+class AttachmentIconView;
+class QMimeSource;
+class QPushButton;
+class QPopupMenu;
+class KAction;
 
 class KOEditorAttachments : public QWidget
 {
@@ -44,8 +48,8 @@
                          const char *name = 0 );
     ~KOEditorAttachments();
 
-    void addAttachment( const QString &uri,
-                        const QString &mimeType = QString::null );
+    void addAttachment( const KURL &uri,
+                        const QString &mimeType = QString::null, bool asUri = true );
     void addAttachment( KCal::Attachment *attachment );
 
     /** Set widgets to default values */
@@ -58,18 +62,30 @@
     bool hasAttachments();
 
   protected slots:
-    void showAttachment( QListViewItem *item );
+    void showAttachment( QIconViewItem *item );
     void slotAdd();
+    void slotAddData();
     void slotEdit();
     void slotRemove();
     void slotShow();
     void dragEnterEvent( QDragEnterEvent *event );
     void dropEvent( QDropEvent *event );
+    void slotCopy();
+    void slotCut();
+    void slotPaste();
+    void selectionChanged();
+    void contextMenu( QIconViewItem* item, const QPoint &pos );
   signals:
     void openURL( const KURL &url );
 
   private:
-    KListView *mAttachments;
+    friend class AttachmentIconView;
+    void handlePasteOrDrop( QMimeSource* source );
+
+    AttachmentIconView *mAttachments;
+    QPushButton *mRemoveBtn;
+    QPopupMenu *mContextMenu, *mAddMenu;
+    KAction *mOpenAction, *mCopyAction, *mCutAction;
 };
 
 #endif
Index: korganizer/kcalendariface.h
===================================================================
--- korganizer/kcalendariface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kcalendariface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -45,7 +45,7 @@
   k_dcop:
 
     /** This is a struct.
-     * 
+     *
      */
     struct ResourceRequestReply {
         bool vCalInOK;
@@ -66,6 +66,12 @@
                                   const QString& description,
                                   const QString& attachment,
                                   const QStringList& attendees ) = 0;
+    virtual void openEventEditor( const QString& summary,
+                                  const QString& description,
+                                  const QString& uri,
+                                  const QString& file,
+                                  const QStringList& attendees,
+                                  const QString& attachmentMimetype ) = 0;
 
     virtual void openTodoEditor( const QString& text ) = 0;
     virtual void openTodoEditor( const QString& summary,
@@ -75,6 +81,12 @@
                                  const QString& description,
                                  const QString& attachment,
                                  const QStringList& attendees ) = 0;
+    virtual void openTodoEditor( const QString& summary,
+                                 const QString& description,
+                                 const QString& uri,
+                                 const QString& file,
+                                 const QStringList& attendees,
+                                 const QString& attachmentMimetype ) = 0;
 
     virtual void openJournalEditor( const QDate& date ) = 0;
     virtual void openJournalEditor( const QString& text,
@@ -91,6 +103,8 @@
 
     virtual void goDate( const QDate& date ) = 0;
     virtual void goDate( const QString& date ) = 0;
+
+    virtual void showDate( const QDate &date ) = 0;
 };
 
 inline QDataStream& operator<<( QDataStream& str, const KCalendarIface::ResourceRequestReply& reply )
Index: korganizer/korgac/alarmdialog.h
===================================================================
--- korganizer/korgac/alarmdialog.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/alarmdialog.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -38,6 +38,8 @@
 class KOEventViewer;
 class QSpinBox;
 class KComboBox;
+class KListView;
+class AlarmListItem;
 
 class AlarmDialog : public KDialogBase {
     Q_OBJECT
@@ -45,33 +47,40 @@
     AlarmDialog( QWidget *parent = 0, const char *name = 0 );
     virtual ~AlarmDialog();
 
-    void setIncidence( Incidence *incidence );
-    void setRemindAt( QDateTime dt );
+    void addIncidence( Incidence *incidence, const QDateTime &reminderAt );
     void eventNotification();
-    void wakeUp();
 
   public slots:
     void slotOk();
     void slotUser1();
     void slotUser2();
+    void slotUser3();
     void slotSave();
+    void wakeUp();
     void show();
+    void suspend();
+    void suspendAll();
+    void dismissAll();
 
   signals:
-    void finishedSignal( AlarmDialog* );
+    void reminderCount( int count );
 
+  private slots:
+    void updateButtons();
+    void showDetails();
+
   private:
     bool startKOrganizer();
-    void setTimer( int seconds );
+    void setTimer();
+    int activeCount();
+    QValueList<AlarmListItem*> selectedItems() const;
 
-    KOEventViewer *mEventViewer;
+    KListView *mIncidenceListView;
+    KOEventViewer *mDetailView;
 
-    Incidence *mIncidence;
-
     QSpinBox *mSuspendSpin;
     KComboBox *mSuspendUnit;
     QTimer mSuspendTimer;
-    QDateTime mRemindAt;
 };
 
 #endif
Index: korganizer/korgac/testalarmdlg.cpp
===================================================================
--- korganizer/korgac/testalarmdlg.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/testalarmdlg.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -50,7 +50,7 @@
 
   AlarmDialog dlg;
   app.setMainWidget( &dlg );
-  dlg.appendIncidence( e );
+  dlg.addIncidence( e, QDateTime::currentDateTime() );
   dlg.show();
   dlg.eventNotification();
     
Index: korganizer/korgac/koalarmclient.cpp
===================================================================
--- korganizer/korgac/koalarmclient.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/koalarmclient.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -40,7 +40,7 @@
 #include <qpushbutton.h>
 
 KOAlarmClient::KOAlarmClient( QObject *parent, const char *name )
-  : DCOPObject( "ac" ), QObject( parent, name )
+  : DCOPObject( "ac" ), QObject( parent, name ), mDialog( 0 )
 {
   kdDebug(5890) << "KOAlarmClient::KOAlarmClient()" << endl;
 
@@ -94,6 +94,7 @@
 {
   delete mCalendar;
   delete mDocker;
+  delete mDialog;
 }
 
 void KOAlarmClient::checkAlarms()
@@ -123,17 +124,17 @@
   if ( !incidence )
     return;
 
-  AlarmDialog *dialog = new AlarmDialog();
-  dialog->setIncidence( incidence );
-  dialog->setRemindAt( dt );
-  connect( dialog, SIGNAL( finishedSignal( AlarmDialog *) ), SLOT( slotRemove( AlarmDialog *) ) );
-  connect( mDocker, SIGNAL( suspendAllSignal() ), dialog, SLOT( slotUser1() ) );
-  connect( mDocker, SIGNAL( dismissAllSignal() ), dialog, SLOT( slotOk() ) );
-  connect( this, SIGNAL( saveAllSignal() ), dialog, SLOT( slotSave() ) );
-  dialog->wakeUp();
-  mReminders.append( dialog );
-  emit reminderCount( mReminders.count() );
-  saveLastCheckTime(); 
+  if ( !mDialog ) {
+    mDialog = new AlarmDialog();
+    connect( mDialog, SIGNAL(reminderCount(int)), mDocker, SLOT(slotUpdate(int)) );
+    connect( mDocker, SIGNAL(suspendAllSignal()), mDialog, SLOT(suspendAll()) );
+    connect( mDocker, SIGNAL(dismissAllSignal()), mDialog, SLOT(dismissAll()) );
+    connect( this, SIGNAL( saveAllSignal() ), mDialog, SLOT( slotSave() ) );
+  }
+
+  mDialog->addIncidence( incidence, dt );
+  mDialog->wakeUp();
+  saveLastCheckTime();
 }
 
 void KOAlarmClient::slotQuit()
@@ -156,13 +157,6 @@
   kapp->quit();
 }
 
-void KOAlarmClient::slotRemove( AlarmDialog *d )
-{
-  mReminders.remove( d );
-  delete d;
-  emit reminderCount( mReminders.count() );
-}
-
 bool KOAlarmClient::commitData( QSessionManager& )
 {
   emit saveAllSignal();
Index: korganizer/korgac/koalarmclient.h
===================================================================
--- korganizer/korgac/koalarmclient.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/koalarmclient.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -59,7 +59,6 @@
     void debugShowDialog();
 
   public slots:
-    void slotRemove( AlarmDialog *d );
     void slotQuit();
 
   protected slots:
@@ -74,12 +73,12 @@
     void saveLastCheckTime();
 
     AlarmDockWindow *mDocker;  // the panel icon
-    QValueList<AlarmDialog *> mReminders;
-
     KCal::CalendarResources *mCalendar;
 
     QDateTime mLastChecked;
     QTimer mCheckTimer;
+
+    AlarmDialog *mDialog;
 };
 
 #endif
Index: korganizer/korgac/alarmdialog.cpp
===================================================================
--- korganizer/korgac/alarmdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/alarmdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -33,6 +33,7 @@
 #include <qdatastream.h>
 
 #include <kapplication.h>
+#include <kconfig.h>
 #include <kiconloader.h>
 #include <dcopclient.h>
 #include <klocale.h>
@@ -42,6 +43,7 @@
 #include <kmessagebox.h>
 #include <knotifyclient.h>
 #include <kcombobox.h>
+#include <klistview.h>
 #include <kwin.h>
 #include <klockfile.h>
 
@@ -52,14 +54,36 @@
 #include "alarmdialog.h"
 #include "alarmdialog.moc"
 
+class AlarmListItem : public KListViewItem
+{
+  public:
+    AlarmListItem( Incidence *incidence, QListView *parent ) :
+      KListViewItem( parent ),
+      mIncidence( incidence->clone() ),
+      mNotified( false )
+    {}
+
+    ~AlarmListItem()
+    {
+      delete mIncidence;
+    }
+
+    Incidence *mIncidence;
+    QDateTime mRemindAt;
+    bool mNotified;
+};
+
+typedef QValueList<AlarmListItem*> ItemList;
+
 AlarmDialog::AlarmDialog( QWidget *parent, const char *name )
   : KDialogBase( Plain, WType_TopLevel | WStyle_Customize | WStyle_StaysOnTop |
                  WStyle_DialogBorder,
-                 parent, name, false, i18n("Reminder"), Ok | User1 | User2/* | User3*/, User1/*3*/,
-                 false, i18n("Suspend"), i18n("Edit...") ),
+                 parent, name, false, i18n("Reminder"), Ok | User1 | User2 | User3, User1/*3*/,
+                 false, i18n("Dismiss all"), i18n("Edit..."), i18n("Suspend") ),
                  mSuspendTimer(this)
 {
   KGlobal::iconLoader()->addAppDir( "kdepim" );
+  setButtonOK( i18n( "Dismiss" ) );
 
   QWidget *topBox = plainPage();
   QBoxLayout *topLayout = new QVBoxLayout( topBox );
@@ -69,9 +93,20 @@
                               topBox );
   topLayout->addWidget( label );
 
-  mEventViewer = new KOEventViewer( topBox );
-  topLayout->addWidget( mEventViewer );
+  mIncidenceListView = new KListView( topBox );
+  mIncidenceListView->addColumn( i18n( "Summary" ) );
+  mIncidenceListView->addColumn( i18n( "Due" ) );
+  mIncidenceListView->setAllColumnsShowFocus( true );
+  mIncidenceListView->setSelectionMode( QListView::Extended );
+  topLayout->addWidget( mIncidenceListView );
+  connect( mIncidenceListView, SIGNAL(selectionChanged()), SLOT(updateButtons()) );
+  connect( mIncidenceListView, SIGNAL(doubleClicked(QListViewItem*)), SLOT(slotUser2()) );
+  connect( mIncidenceListView, SIGNAL(currentChanged(QListViewItem*)), SLOT(showDetails()) );
+  connect( mIncidenceListView, SIGNAL(selectionChanged()), SLOT(showDetails()) );
 
+  mDetailView = new KOEventViewer( topBox );
+  topLayout->addWidget( mDetailView );
+
   QHBox *suspendBox = new QHBox( topBox );
   suspendBox->setSpacing( spacingHint() );
   topLayout->addWidget( suspendBox );
@@ -86,6 +121,7 @@
   mSuspendUnit->insertItem( i18n("hour(s)") );
   mSuspendUnit->insertItem( i18n("day(s)") );
   mSuspendUnit->insertItem( i18n("week(s)") );
+  connect( &mSuspendTimer, SIGNAL(timeout()), SLOT(wakeUp()) );
 
   // showButton( User2/*3*/, false );
 
@@ -94,27 +130,55 @@
 
 AlarmDialog::~AlarmDialog()
 {
-  delete mIncidence;
+  mIncidenceListView->clear();
 }
 
-void AlarmDialog::setIncidence( Incidence *incidence )
+void AlarmDialog::addIncidence( Incidence *incidence, const QDateTime &reminderAt )
 {
-  mIncidence = incidence->clone();
-  mEventViewer->appendIncidence( mIncidence );
+  AlarmListItem *item = new AlarmListItem( incidence, mIncidenceListView );
+  item->setText( 0, incidence->summary() );
+  item->mRemindAt = reminderAt;
+  Todo *todo;
+  if ( dynamic_cast<Event*>( incidence ) ) {
+    item->setPixmap( 0, SmallIcon( "appointment" ) );
+    if ( incidence->doesRecur() ) {
+      QDateTime nextStart = incidence->recurrence()->getNextDateTime( reminderAt );
+      if ( nextStart.isValid() )
+        item->setText( 1, KGlobal::locale()->formatDateTime( nextStart ) );
+    }
+    if ( item->text( 1 ).isEmpty() )
+      item->setText( 1, incidence->dtStartStr() );
+  } else if ( (todo = dynamic_cast<Todo*>( incidence )) ) {
+    item->setPixmap( 0, SmallIcon( "todo" ) );
+    item->setText( 1, todo->dtDueStr() );
+  }
+  if ( activeCount() == 1 ) {// previously empty
+    mIncidenceListView->clearSelection();
+    item->setSelected( true );
+  }
+  showDetails();
 }
 
-void AlarmDialog::setRemindAt( QDateTime dt )
+void AlarmDialog::slotOk()
 {
-  mRemindAt = dt;
+  ItemList selection = selectedItems();
+  for ( ItemList::Iterator it = selection.begin(); it != selection.end(); ++it )
+    delete *it;
+  if ( activeCount() == 0 )
+    accept();
+  else {
+    updateButtons();
+    showDetails();
+  }
+  emit reminderCount( activeCount() );
 }
 
-void AlarmDialog::slotOk()
+void AlarmDialog::slotUser1()
 {
-  accept();
-  emit finishedSignal( this );
+  dismissAll();
 }
 
-void AlarmDialog::slotUser1()
+void AlarmDialog::suspend()
 {
   if ( !isVisible() )
     return;
@@ -133,20 +197,50 @@
       break;
   }
 
-  setTimer( unit * mSuspendSpin->value() );
-  accept();
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem * item = static_cast<AlarmListItem*>( it.current() );
+    if ( item->isSelected() && item->isVisible() ) {
+      item->setVisible( false );
+      item->setSelected( false );
+      item->mRemindAt = QDateTime::currentDateTime().addSecs( unit * mSuspendSpin->value() );
+      item->mNotified = false;
+    }
+  }
+
+  setTimer();
+  if ( activeCount() == 0 )
+    accept();
+  else {
+    updateButtons();
+    showDetails();
+  }
+  emit reminderCount( activeCount() );
 }
 
-void AlarmDialog::setTimer( int seconds )
+void AlarmDialog::setTimer()
 {
-  connect( &mSuspendTimer, SIGNAL( timeout() ), SLOT( show() ) );
-  mSuspendTimer.start( 1000 * seconds, true );
-  mRemindAt = QDateTime::currentDateTime();
-  mRemindAt = mRemindAt.addSecs( seconds );
+  int nextReminderAt = -1;
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem * item = static_cast<AlarmListItem*>( it.current() );
+    if ( item->mRemindAt > QDateTime::currentDateTime() ) {
+      int secs = QDateTime::currentDateTime().secsTo( item->mRemindAt );
+      nextReminderAt = nextReminderAt <= 0 ? secs : QMIN( nextReminderAt, secs );
+    }
+  }
+
+  if ( nextReminderAt >= 0 ) {
+    mSuspendTimer.stop();
+    mSuspendTimer.start( 1000 * (nextReminderAt + 1), true );
+  }
 }
 
 void AlarmDialog::slotUser2()
 {
+  ItemList selection = selectedItems();
+  if ( selection.count() != 1 )
+    return;
+  Incidence *incidence = selection.first()->mIncidence;
+
   if ( !kapp->dcopClient()->isApplicationRegistered( "korganizer" ) ) {
     if ( kapp->startServiceByDesktopName( "korganizer", QString::null ) )
       KMessageBox::error( 0, i18n("Could not start KOrganizer.") );
@@ -154,7 +248,7 @@
 
   kapp->dcopClient()->send( "korganizer", "KOrganizerIface",
                             "editIncidence(QString)",
-                             mIncidence->uid() );
+                             incidence->uid() );
 
   // get desktop # where korganizer (or kontact) runs
   QByteArray replyData;
@@ -181,6 +275,24 @@
   }
 }
 
+void AlarmDialog::slotUser3()
+{
+  suspend();
+}
+
+void AlarmDialog::dismissAll()
+{
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem *item = static_cast<AlarmListItem*>( it.current() );
+    if ( !item->isVisible() )
+      continue;
+    delete item;
+  }
+  setTimer();
+  accept();
+  emit reminderCount( activeCount() );
+}
+
 void AlarmDialog::show()
 {
   KDialogBase::show();
@@ -191,36 +303,60 @@
 
 void AlarmDialog::eventNotification()
 {
-  bool beeped = false;
-  Alarm::List alarms = mIncidence->alarms();
-  Alarm::List::ConstIterator it;
-  for ( it = alarms.begin(); it != alarms.end(); ++it ) {
-    Alarm *alarm = *it;
-// FIXME: Check whether this should be done for all multiple alarms
-    if (alarm->type() == Alarm::Procedure) {
-// FIXME: Add a message box asking whether the procedure should really be executed
-      kdDebug(5890) << "Starting program: '" << alarm->programFile() << "'" << endl;
-      KProcess proc;
-      proc << QFile::encodeName(alarm->programFile());
-      proc.start(KProcess::DontCare);
+  bool beeped = false, found = false;
+
+  QValueList<AlarmListItem*> list;
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem *item = static_cast<AlarmListItem*>( it.current() );
+    if ( !item->isVisible() || item->mNotified )
+      continue;
+    found = true;
+    item->mNotified = true;
+    Alarm::List alarms = item->mIncidence->alarms();
+    Alarm::List::ConstIterator it;
+    for ( it = alarms.begin(); it != alarms.end(); ++it ) {
+      Alarm *alarm = *it;
+      // FIXME: Check whether this should be done for all multiple alarms
+      if (alarm->type() == Alarm::Procedure) {
+        // FIXME: Add a message box asking whether the procedure should really be executed
+        kdDebug(5890) << "Starting program: '" << alarm->programFile() << "'" << endl;
+        KProcess proc;
+        proc << QFile::encodeName(alarm->programFile());
+        proc.start(KProcess::DontCare);
+      }
+      else if (alarm->type() == Alarm::Audio) {
+        beeped = true;
+        KAudioPlayer::play(QFile::encodeName(alarm->audioFile()));
+      }
     }
-    else if (alarm->type() == Alarm::Audio) {
-      beeped = true;
-      KAudioPlayer::play(QFile::encodeName(alarm->audioFile()));
-    }
   }
 
-  if ( !beeped ) {
+  if ( !beeped && found ) {
     KNotifyClient::beep();
   }
 }
 
 void AlarmDialog::wakeUp()
 {
-  if ( mRemindAt <= QDateTime::currentDateTime() )
+  bool activeReminders = false;
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem * item = static_cast<AlarmListItem*>( it.current() );
+    if ( item->mRemindAt <= QDateTime::currentDateTime() ) {
+      if ( !item->isVisible() ) {
+        item->setVisible( true );
+        item->setSelected( false );
+      }
+      activeReminders = true;
+    } else {
+      item->setVisible( false );
+    }
+  }
+
+  if ( activeReminders )
     show();
-  else
-    setTimer( QDateTime::currentDateTime().secsTo( mRemindAt ) );
+  setTimer();
+  showDetails();
+  emit reminderCount( activeCount() );
 }
 
 void AlarmDialog::slotSave()
@@ -232,12 +368,66 @@
 
   config->setGroup( "General" );
   int numReminders = config->readNumEntry("Reminders", 0);
-  config->writeEntry( "Reminders", ++numReminders );
 
-  config->setGroup( QString("Incidence-%1").arg(numReminders) );
-  config->writeEntry( "UID", mIncidence->uid() );
-  config->writeEntry( "RemindAt", mRemindAt );
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem * item = static_cast<AlarmListItem*>( it.current() );
+    config->setGroup( QString("Incidence-%1").arg(numReminders) );
+    config->writeEntry( "UID", item->mIncidence->uid() );
+    config->writeEntry( "RemindAt", item->mRemindAt );
+    ++numReminders;
+  }
+
+  config->setGroup( "General" );
+  config->writeEntry( "Reminders", numReminders );
   config->sync();
   lock.data()->unlock();
 }
 
+void AlarmDialog::updateButtons()
+{
+  ItemList selection = selectedItems();
+  enableButton( User2, selection.count() == 1 );
+  enableButton( Ok, selection.count() > 0 );
+  enableButton( User3, selection.count() > 0 );
+}
+
+QValueList< AlarmListItem * > AlarmDialog::selectedItems() const
+{
+  QValueList<AlarmListItem*> list;
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    if ( it.current()->isSelected() )
+      list.append( static_cast<AlarmListItem*>( it.current() ) );
+  }
+  return list;
+}
+
+int AlarmDialog::activeCount()
+{
+  int count = 0;
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    AlarmListItem * item = static_cast<AlarmListItem*>( it.current() );
+    if ( item->isVisible() )
+      ++count;
+  }
+  return count;
+}
+
+void AlarmDialog::suspendAll()
+{
+  mIncidenceListView->clearSelection();
+  for ( QListViewItemIterator it( mIncidenceListView ) ; it.current() ; ++it ) {
+    if ( it.current()->isVisible() )
+      it.current()->setSelected( true );
+  }
+  suspend();
+}
+
+void AlarmDialog::showDetails()
+{
+  mDetailView->clearEvents( true );
+  mDetailView->clear();
+  AlarmListItem *item = static_cast<AlarmListItem*>( mIncidenceListView->currentItem() );
+  if ( !item || !item->isVisible() )
+    return;
+  mDetailView->appendIncidence( item->mIncidence );
+}
Index: korganizer/korgac/korgac.desktop
===================================================================
--- korganizer/korgac/korgac.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korgac/korgac.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -10,6 +10,7 @@
 Name[da]=KOrganizer-p√•mindelsesklient
 Name[de]=KOrganizer Erinnerungsfunktion
 Name[el]=Œ†ŒµŒªŒ¨œÑŒ∑œÇ œÖœÄŒµŒΩŒ∏œçŒºŒπœÉŒ∑œÇ œÑŒøœÖ KOrganizer
+Name[eo]=Alarmilo por Organizilo
 Name[es]=Cliente de recordatorio para KOrganizer
 Name[et]=KOrganizeri meeldetuletuse klientprogramm
 Name[eu]=KOrganizer-en oroigarrien bezeroa
@@ -55,6 +56,7 @@
 GenericName[da]=KOrganizer-p√•mindelsesklient
 GenericName[de]=Hintergrund-Erinnerungsfunktion f√ºr KOrganizer
 GenericName[el]=ŒîŒ±ŒØŒºŒøŒΩŒ±œÇ œÄŒµŒªŒ¨œÑŒ∑ œÖœÄŒµŒΩŒ∏œçŒºŒπœÉŒ∑œÇ œÑŒøœÖ KOrganizer
+GenericName[eo]=Kliento por la alarmo-demono de Organizilo
 GenericName[es]=Cliente del daemon de recordatorio para KOrganizer
 GenericName[et]=KOrganizeri meeldetuletusdeemoni klientprogramm
 GenericName[eu]=KOrganizer-en oroigarrien deabruaren bezeroa
Index: korganizer/multiagendaview.cpp
===================================================================
--- korganizer/multiagendaview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/multiagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,282 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#include "multiagendaview.h"
+
+#include "koagendaview.h"
+
+#include <libkcal/calendarresources.h>
+
+#include <qlayout.h>
+#include <qvbox.h>
+#include <qobjectlist.h>
+
+#define FOREACH_VIEW(av) \
+for(QValueList<KOAgendaView*>::ConstIterator it = mAgendaViews.constBegin(); \
+  it != mAgendaViews.constEnd();) \
+  for(KOAgendaView* av = (it != mAgendaViews.constEnd() ? (*it) : 0); \
+      it != mAgendaViews.constEnd(); ++it, av = (*it)  )
+
+using namespace KOrg;
+
+MultiAgendaView::MultiAgendaView(Calendar * cal, QWidget * parent, const char *name ) :
+    AgendaView( cal, parent, name )
+{
+  QBoxLayout *topLevelLayout = new QHBoxLayout( this );
+  mScrollView = new QScrollView( this );
+  mScrollView->setResizePolicy( QScrollView::Manual );
+  mScrollView->setVScrollBarMode( QScrollView::AlwaysOff );
+  mScrollView->setFrameShape( QFrame::NoFrame );
+  topLevelLayout->addWidget( mScrollView );
+  mTopBox = new QHBox( mScrollView->viewport() );
+  mScrollView->addChild( mTopBox );
+  recreateViews();
+}
+
+void MultiAgendaView::recreateViews()
+{
+  deleteViews();
+
+  CalendarResources *calres = dynamic_cast<CalendarResources*>( calendar() );
+  if ( !calres ) {
+    // fallback to single-agenda
+    KOAgendaView* av = new KOAgendaView( calendar(), mTopBox );
+    mAgendaViews.append( av );
+    mAgendaWidgets.append( av );
+    av->show();
+  } else {
+    CalendarResourceManager *manager = calres->resourceManager();
+    for ( CalendarResourceManager::ActiveIterator it = manager->activeBegin(); it != manager->activeEnd(); ++it ) {
+      if ( (*it)->canHaveSubresources() ) {
+        QStringList subResources = (*it)->subresources();
+        for ( QStringList::ConstIterator subit = subResources.constBegin(); subit != subResources.constEnd(); ++subit ) {
+          QString type = (*it)->subresourceType( *subit );
+          if ( !(*it)->subresourceActive( *subit ) || (!type.isEmpty() && type != "event") )
+            continue;
+          addView( (*it)->labelForSubresource( *subit ), *it, *subit );
+        }
+      } else {
+        addView( (*it)->resourceName(), *it );
+      }
+    }
+  }
+  setupViews();
+  resizeScrollView( size() );
+}
+
+void MultiAgendaView::deleteViews()
+{
+  for ( QValueList<QWidget*>::ConstIterator it = mAgendaWidgets.constBegin();
+        it != mAgendaWidgets.constEnd(); ++it ) {
+    delete *it;
+  }
+  mAgendaViews.clear();
+  mAgendaWidgets.clear();
+}
+
+void MultiAgendaView::setupViews()
+{
+  FOREACH_VIEW( agenda ) {
+    connect( agenda, SIGNAL( newEventSignal() ),
+             SIGNAL( newEventSignal() ) );
+    connect( agenda, SIGNAL( editIncidenceSignal( Incidence * ) ),
+             SIGNAL( editIncidenceSignal( Incidence * ) ) );
+    connect( agenda, SIGNAL( showIncidenceSignal( Incidence * ) ),
+             SIGNAL( showIncidenceSignal( Incidence * ) ) );
+    connect( agenda, SIGNAL( deleteIncidenceSignal( Incidence * ) ),
+             SIGNAL( deleteIncidenceSignal( Incidence * ) ) );
+    connect( agenda, SIGNAL( startMultiModify( const QString & ) ),
+             SIGNAL( startMultiModify( const QString & ) ) );
+    connect( agenda, SIGNAL( endMultiModify() ),
+             SIGNAL( endMultiModify() ) );
+
+    connect( agenda, SIGNAL( incidenceSelected( Incidence * ) ),
+             SIGNAL( incidenceSelected( Incidence * ) ) );
+
+    connect( agenda, SIGNAL(cutIncidenceSignal(Incidence*)),
+             SIGNAL(cutIncidenceSignal(Incidence*)) );
+    connect( agenda, SIGNAL(copyIncidenceSignal(Incidence*)),
+             SIGNAL(copyIncidenceSignal(Incidence*)) );
+    connect( agenda, SIGNAL(toggleAlarmSignal(Incidence*)),
+             SIGNAL(toggleAlarmSignal(Incidence*)) );
+    connect( agenda, SIGNAL(dissociateOccurrenceSignal(Incidence*, const QDate&)),
+             SIGNAL(dissociateOccurrenceSignal(Incidence*, const QDate&)) );
+    connect( agenda, SIGNAL(dissociateFutureOccurrenceSignal(Incidence*, const QDate&)),
+             SIGNAL(dissociateFutureOccurrenceSignal(Incidence*, const QDate&)) );
+
+    connect( agenda, SIGNAL(newEventSignal(const QDate&)),
+             SIGNAL(newEventSignal(const QDate&)) );
+    connect( agenda, SIGNAL(newEventSignal(const QDateTime&)),
+             SIGNAL(newEventSignal(const QDateTime&)) );
+    connect( agenda, SIGNAL(newEventSignal(const QDateTime&, const QDateTime&)),
+             SIGNAL(newEventSignal(const QDateTime&, const QDateTime&)) );
+    connect( agenda, SIGNAL(newTodoSignal(const QDate&)),
+             SIGNAL(newTodoSignal(const QDate&)) );
+
+    connect( agenda, SIGNAL(incidenceSelected(Incidence*)),
+             SLOT(slotSelectionChanged()) );
+
+    connect( agenda, SIGNAL(timeSpanSelectionChanged()),
+             SLOT(slotClearTimeSpanSelection()) );
+
+  }
+
+  FOREACH_VIEW( agenda ) {
+    agenda->readSettings();
+  }
+}
+
+MultiAgendaView::~ MultiAgendaView()
+{
+}
+
+Incidence::List MultiAgendaView::selectedIncidences()
+{
+  Incidence::List list;
+  FOREACH_VIEW(agendaView) {
+    list += agendaView->selectedIncidences();
+  }
+  return list;
+}
+
+DateList MultiAgendaView::selectedDates()
+{
+  DateList list;
+  FOREACH_VIEW(agendaView) {
+    list += agendaView->selectedDates();
+  }
+  return list;
+}
+
+int MultiAgendaView::currentDateCount()
+{
+  FOREACH_VIEW( agendaView )
+    return agendaView->currentDateCount();
+  return 0;
+}
+
+void MultiAgendaView::showDates(const QDate & start, const QDate & end)
+{
+  kdDebug() << k_funcinfo << endl;
+  recreateViews();
+  FOREACH_VIEW( agendaView )
+    agendaView->showDates( start, end );
+}
+
+void MultiAgendaView::showIncidences(const Incidence::List & incidenceList)
+{
+  FOREACH_VIEW( agendaView )
+    agendaView->showIncidences( incidenceList );
+}
+
+void MultiAgendaView::updateView()
+{
+  kdDebug() << k_funcinfo << endl;
+  recreateViews();
+  FOREACH_VIEW( agendaView )
+    agendaView->updateView();
+}
+
+void MultiAgendaView::changeIncidenceDisplay(Incidence * incidence, int mode)
+{
+  FOREACH_VIEW( agendaView )
+    agendaView->changeIncidenceDisplay( incidence, mode );
+}
+
+int MultiAgendaView::maxDatesHint()
+{
+  FOREACH_VIEW( agendaView )
+    return agendaView->maxDatesHint();
+  return 0;
+}
+
+void MultiAgendaView::slotSelectionChanged()
+{
+  FOREACH_VIEW( agenda ) {
+    if ( agenda != sender() )
+      agenda->clearSelection();
+  }
+}
+
+bool MultiAgendaView::eventDurationHint(QDateTime & startDt, QDateTime & endDt, bool & allDay)
+{
+  FOREACH_VIEW( agenda ) {
+    bool valid = agenda->eventDurationHint( startDt, endDt, allDay );
+    if ( valid )
+      return true;
+  }
+  return false;
+}
+
+void MultiAgendaView::slotClearTimeSpanSelection()
+{
+  FOREACH_VIEW( agenda ) {
+    if ( agenda != sender() )
+      agenda->clearTimeSpanSelection();
+  }
+}
+
+void MultiAgendaView::setTypeAheadReceiver(QObject * o)
+{
+  FOREACH_VIEW( agenda )
+    agenda->setTypeAheadReceiver( o );
+}
+
+void MultiAgendaView::finishTypeAhead()
+{
+  FOREACH_VIEW( agenda )
+    agenda->finishTypeAhead();
+}
+
+void MultiAgendaView::addView( const QString &label, KCal::ResourceCalendar * res, const QString & subRes )
+{
+  QVBox *box = new QVBox( mTopBox );
+  QLabel *l = new QLabel( label, box );
+  l->setAlignment( AlignVCenter | AlignHCenter );
+  KOAgendaView* av = new KOAgendaView( calendar(), box );
+  av->setResource( res, subRes );
+  av->setIncidenceChanger( mChanger );
+  mAgendaViews.append( av );
+  mAgendaWidgets.append( box );
+  box->show();
+}
+
+void MultiAgendaView::resizeEvent(QResizeEvent * ev)
+{
+  resizeScrollView( ev->size() );
+  AgendaView::resizeEvent( ev );
+}
+
+void MultiAgendaView::resizeScrollView(const QSize & size)
+{
+  int width = QMAX( mTopBox->sizeHint().width(), size.width() );
+  int height = size.height();
+  if ( width > size.width() )
+    height -= mScrollView->horizontalScrollBar()->height();
+  mScrollView->resizeContents( width, height );
+  mTopBox->resize( width, height );
+}
+
+void MultiAgendaView::setIncidenceChanger(IncidenceChangerBase * changer)
+{
+  AgendaView::setIncidenceChanger( changer );
+  FOREACH_VIEW( agenda )
+    agenda->setIncidenceChanger( changer );
+}
+
+#include "multiagendaview.moc"
Index: korganizer/Makefile.am
===================================================================
--- korganizer/Makefile.am	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -47,7 +47,7 @@
 timezone_COMPILE_FIRST = koprefs_base.h
 
 lib_LTLIBRARIES = libkorganizer_eventviewer.la \
-                  libkorganizer_calendar.la libkorganizer.la 
+                  libkorganizer_calendar.la libkorganizer.la
 
 libkorganizer_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -version-info 1:0
 libkorganizer_la_LIBADD  = \
@@ -61,6 +61,7 @@
 	$(top_builddir)/kdgantt/libkdgantt.la \
 	$(top_builddir)/libemailfunctions/libemailfunctions.la \
 	$(top_builddir)/libkholidays/libkholidays.la \
+	$(top_builddir)/libkmime/libkmime.la \
 	$(LIB_KPARTS) $(LIB_KFILE) $(LIB_KNEWSTUFF) \
 	-lkdeprint -lkabc -lkutils
 
@@ -104,7 +105,11 @@
 	freebusymanager.cpp freebusyurldialog.cpp \
 	eventarchiver.cpp koidentitymanager.cpp \
 	exportwebdialog.cpp kocorehelper.cpp incidencechanger.cpp \
-  template_management_dialog_base.ui templatemanagementdialog.cpp
+	template_management_dialog_base.ui templatemanagementdialog.cpp \
+	agendaview.cpp multiagendaview.cpp \
+	timelineitem.cpp \
+	kotimelineview.cpp \
+	koattendeeeditor.cpp
 
 
 libkorganizer_eventviewer_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) \
@@ -118,7 +123,7 @@
                                     -no-undefined -version-info 1:0
 libkorganizer_calendar_la_LIBADD  = $(LIB_KPARTS) \
                                     $(top_builddir)/libkdepim/libkdepim.la \
-                                    $(top_builddir)/libkcal/libkcal.la 
+                                    $(top_builddir)/libkcal/libkcal.la
 libkorganizer_calendar_la_SOURCES = stdcalendar.cpp
 
 
@@ -173,7 +178,7 @@
 	$(XGETTEXT) `find . -name "*.cpp" -o -name "*.h"` -o $(podir)/korganizer.pot
 	rm -f tips.cpp
 
-xdg_apps_DATA = korganizer.desktop 
+xdg_apps_DATA = korganizer.desktop
 
 kde_kcfg_DATA = korganizer.kcfg
 
@@ -194,7 +199,7 @@
 DOXYGEN_REFERENCES=libkcal kdeui
 include $(top_srcdir)/admin/Doxyfile.am
 
-install-data-local: 
+install-data-local:
 	$(mkinstalldirs) $(DESTDIR)$(kde_servicesdir)
 	$(mkinstalldirs) $(DESTDIR)$(kde_servicesdir)/korganizer
 	$(INSTALL_DATA) $(srcdir)/uninstall.desktop $(DESTDIR)$(kde_servicesdir)/korganizer_configgroupautomation.desktop
Index: korganizer/koeventpopupmenu.h
===================================================================
--- korganizer/koeventpopupmenu.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeventpopupmenu.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -58,6 +58,7 @@
     void popupAlarm();
     void dissociateOccurrence();
     void dissociateFutureOccurrence();
+    void forward();
 
   signals:
     void editIncidenceSignal(Incidence *);
Index: korganizer/kotodoview.cpp
===================================================================
--- korganizer/kotodoview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kotodoview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -853,9 +853,8 @@
 void KOTodoView::printTodo()
 {
 #ifndef KORG_NOPRINTER
-  Calendar *cal;
   KOCoreHelper helper;
-  CalPrinter printer( this, cal, &helper );
+  CalPrinter printer( this, BaseView::calendar(), &helper );
   connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
 
   Incidence::List selectedIncidences;
Index: korganizer/interfaces/korganizer/incidencechangerbase.h
===================================================================
--- korganizer/interfaces/korganizer/incidencechangerbase.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/interfaces/korganizer/incidencechangerbase.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -37,19 +37,19 @@
 {
 Q_OBJECT
 public:
-  IncidenceChangerBase( Calendar*cal, QObject *parent = 0 ) : 
+  IncidenceChangerBase( Calendar*cal, QObject *parent = 0 ) :
         QObject( parent ), mCalendar( cal ) {}
   virtual ~IncidenceChangerBase() {}
 
-  virtual bool sendGroupwareMessage( Incidence *incidence, 
+  virtual bool sendGroupwareMessage( Incidence *incidence,
           KCal::Scheduler::Method method, bool deleting = false ) = 0;
 
   virtual bool beginChange( Incidence * incidence ) = 0;
   virtual bool endChange( Incidence *incidence ) = 0;
 
   virtual bool addIncidence( Incidence *incidence, QWidget *parent = 0 ) = 0;
-  virtual bool changeIncidence( Incidence *newinc, Incidence *oldinc, 
-                                int action = -1 ) = 0;
+  virtual bool changeIncidence( Incidence *newinc, Incidence *oldinc,
+                                int action = -1, bool counter = false ) = 0;
   virtual bool deleteIncidence( Incidence *incidence ) = 0;
   virtual bool cutIncidence( Incidence *incidence ) = 0;
 
@@ -63,7 +63,7 @@
   void incidenceChanged( Incidence *oldInc, Incidence *newInc );
   void incidenceToBeDeleted( Incidence * );
   void incidenceDeleted( Incidence * );
-  
+
   void schedule( Scheduler::Method method, Incidence *incidence );
 protected:
   Calendar *mCalendar;
Index: korganizer/kotodoeditor.cpp
===================================================================
--- korganizer/kotodoeditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kotodoeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -56,6 +56,7 @@
   KOIncidenceEditor( QString::null, calendar, parent )
 {
   mTodo = 0;
+  mCalendar = 0;
   mRelatedTodo = 0;
 }
 
@@ -70,7 +71,7 @@
   setupGeneral();
   setupRecurrence();
   setupAttendeesTab();
-  setupAttachmentsTab();
+//  setupAttachmentsTab();
 
   connect( mGeneral, SIGNAL( dateTimeStrChanged( const QString & ) ),
            mRecurrence, SLOT( setDateTimeStr( const QString & ) ) );
@@ -79,11 +80,14 @@
 
   connect( mGeneral, SIGNAL( openCategoryDialog() ),
            SIGNAL( editCategories() ) );
+
+  connect( mDetails, SIGNAL(updateAttendeeSummary(int)),
+           mGeneral, SLOT(updateAttendeeSummary(int)) );
 }
 
 void KOTodoEditor::reload()
 {
-  if ( mTodo ) readTodo( mTodo );
+  if ( mTodo ) readTodo( mTodo, mCalendar );
 }
 
 void KOTodoEditor::setupGeneral()
@@ -97,11 +101,10 @@
     topLayout->setMargin(marginHint());
     topLayout->setSpacing(spacingHint());
 
-    mGeneral->initHeader(topFrame,topLayout);
+    mGeneral->initHeader( topFrame, topLayout );
     mGeneral->initTime(topFrame,topLayout);
     QHBoxLayout *priorityLayout = new QHBoxLayout( topLayout );
     mGeneral->initPriority(topFrame,priorityLayout);
-    mGeneral->initCategories( topFrame, topLayout );
     topLayout->addStretch(1);
 
     QFrame *topFrame2 = addPage(i18n("Details"));
@@ -124,16 +127,19 @@
     QBoxLayout *topLayout = new QVBoxLayout(topFrame);
     topLayout->setSpacing(spacingHint());
 
-    mGeneral->initHeader(topFrame,topLayout);
+    mGeneral->initHeader( topFrame, topLayout );
     mGeneral->initTime(topFrame,topLayout);
     mGeneral->initStatus(topFrame,topLayout);
     QBoxLayout *alarmLineLayout = new QHBoxLayout(topLayout);
     mGeneral->initAlarm(topFrame,alarmLineLayout);
+    mGeneral->enableAlarm( false );
     alarmLineLayout->addStretch( 1 );
     mGeneral->initDescription(topFrame,topLayout);
-    QBoxLayout *detailsLayout = new QHBoxLayout(topLayout);
-    mGeneral->initCategories( topFrame, detailsLayout );
-    mGeneral->initSecrecy( topFrame, detailsLayout );
+    mGeneral->initAttachments(topFrame,topLayout);
+    connect( mGeneral, SIGNAL( openURL( const KURL& ) ),
+             this, SLOT( openURL( const KURL& ) ) );
+    connect( this, SIGNAL( signalAddAttachments( const QStringList&, const QStringList&, bool ) ),
+             mGeneral, SLOT( addAttachments( const QStringList&, const QStringList&, bool ) ) );
   }
   // By default, the To-do has no time associated and
   // neither a start nor end time.
@@ -156,7 +162,7 @@
           mRecurrence, SLOT( setEnabled( bool ) ) );
 }
 
-void KOTodoEditor::editIncidence(Incidence *incidence)
+void KOTodoEditor::editIncidence(Incidence *incidence, Calendar *calendar)
 {
   kdDebug(5850) << k_funcinfo << endl;
   Todo *todo=dynamic_cast<Todo*>(incidence);
@@ -165,7 +171,8 @@
     init();
 
     mTodo = todo;
-    readTodo(mTodo);
+    mCalendar = calendar;
+    readTodo( mTodo, mCalendar );
   }
 
   setCaption( i18n("Edit To-do") );
@@ -176,6 +183,7 @@
   kdDebug(5850) << k_funcinfo << endl;
   init();
   mTodo = 0;
+  mCalendar = 0;
   setCaption( i18n("New To-do") );
 }
 
@@ -270,19 +278,17 @@
     mRecurrence->setDefaults( mTodo->dtStart(), due, false );
   else
     mRecurrence->setDefaults( QDateTime::currentDateTime(), due, false );
-  mAttachments->setDefaults();
 }
 
-void KOTodoEditor::readTodo( Todo *todo )
+void KOTodoEditor::readTodo( Todo *todo, Calendar *calendar )
 {
   if ( !todo ) return;
 //   mRelatedTodo = todo->relatedTo();
   kdDebug(5850)<<"read todo"<<endl;
-  mGeneral->readTodo( todo );
+  mGeneral->readTodo( todo, calendar );
   mDetails->readEvent( todo );
 //  mAlarms->readIncidence( todo );
   mRecurrence->readIncidence( todo );
-  mAttachments->readIncidence( todo );
 
   createEmbeddedURLPages( todo );
   readDesignerFields( todo );
@@ -295,7 +301,6 @@
   mRecurrence->writeIncidence( todo );
   mGeneral->writeTodo( todo );
   mDetails->writeEvent( todo );
-  mAttachments->writeIncidence( todo );
 
   if ( *(oldIncidence->recurrence()) != *(todo->recurrence() ) ) {
     todo->setDtDue( todo->dtDue(), true );
@@ -341,7 +346,7 @@
     KMessageBox::error( this,
         i18n("Template does not contain a valid to-do.") );
   } else {
-    readTodo( todos.first() );
+    readTodo( todos.first(), 0 );
   }
 }
 
Index: korganizer/koagendaview.h
===================================================================
--- korganizer/koagendaview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koagendaview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -28,8 +28,10 @@
 #include <qscrollview.h>
 #include <qlabel.h>
 
-#include "koeventview.h"
+#include "calprinter.h"
 
+#include "agendaview.h"
+
 class QHBox;
 class QPushButton;
 class QBoxLayout;
@@ -38,6 +40,14 @@
 class KOAgendaItem;
 class KConfig;
 
+namespace KCal {
+  class ResourceCalendar;
+}
+
+namespace KOrg {
+  class IncidenceChangerBase;
+}
+
 class TimeLabels : public QScrollView
 {
     Q_OBJECT
@@ -133,10 +143,10 @@
 };
 
 /**
-  KOAgendaView is the agenda-like view used to display events in an one or
+  KOAgendaView is the agenda-like view used to display events in a single one or
   multi-day view.
 */
-class KOAgendaView : public KOEventView
+class KOAgendaView : public KOrg::AgendaView
 {
     Q_OBJECT
   public:
@@ -163,7 +173,7 @@
     /** Remove all events from view */
     void clearView();
 
-    CalPrinterBase::PrintType printType();
+    KOrg::CalPrinterBase::PrintType printType();
 
     /** start-datetime of selection */
     QDateTime selectionStart() { return mTimeSpanBegin; }
@@ -178,6 +188,9 @@
 
     void setTypeAheadReceiver( QObject * );
 
+    /** Show only incidences from the given resource. */
+    void setResource( KCal::ResourceCalendar *res, const QString &subResource = QString::null );
+
   public slots:
     virtual void updateView();
     virtual void updateConfig();
@@ -206,7 +219,7 @@
     void slotTodoDropped( Todo *, const QPoint &, bool );
 
     void enableAgendaUpdate( bool enable );
-    void setIncidenceChanger( IncidenceChangerBase *changer );
+    void setIncidenceChanger( KOrg::IncidenceChangerBase *changer );
 
     void zoomInHorizontally( const QDate& date=QDate() );
     void zoomOutHorizontally( const QDate& date=QDate() );
@@ -216,10 +229,14 @@
 
     void zoomView( const int delta, const QPoint &pos,
       const Qt::Orientation orient=Qt::Horizontal );
+
+    void clearTimeSpanSelection();
   signals:
     void toggleExpand();
     void zoomViewHorizontally(const QDate &, int count );
 
+    void timeSpanSelectionChanged();
+
   protected:
     /** Fill agenda beginning with date startDate */
     void fillAgenda( const QDate &startDate );
@@ -261,6 +278,9 @@
     void newTimeSpanSelectedAllDay( const QPoint &start, const QPoint &end );
 
   private:
+    bool filterByResource( Incidence *incidence );
+
+  private:
     // view widgets
     QFrame *mDayLabels;
     QHBox *mDayLabelsFrame;
@@ -296,6 +316,9 @@
     bool mAllowAgendaUpdate;
 
     Incidence *mUpdateItem;
+
+    KCal::ResourceCalendar *mResource;
+    QString mSubResource;
 };
 
 #endif
Index: korganizer/koeditordetails.cpp
===================================================================
--- korganizer/koeditordetails.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditordetails.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -43,6 +43,7 @@
 #include <qvgroupbox.h>
 #include <qwhatsthis.h>
 #include <qwidgetstack.h>
+#include <qvaluevector.h>
 
 #include <kdebug.h>
 #include <klocale.h>
@@ -53,7 +54,7 @@
 #include <kabc/vcardconverter.h>
 #include <libkdepim/addressesdialog.h>
 #include <libkdepim/addresseelineedit.h>
-#include <kabc/distributionlist.h>
+#include <libkdepim/distributionlist.h>
 #include <kabc/stdaddressbook.h>
 #endif
 #include <libkdepim/kvcarddrag.h>
@@ -85,6 +86,8 @@
     setPixmap(4,KOGlobals::self()->smallIcon("mailappt"));
   else
     setPixmap(4,KOGlobals::self()->smallIcon("nomailappt"));
+  setText(5, mData->delegate());
+  setText(6, mData->delegator());
 }
 
 KOAttendeeListView::KOAttendeeListView ( QWidget *parent, const char *name )
@@ -179,36 +182,12 @@
 
 KOEditorDetails::KOEditorDetails( int spacing, QWidget *parent,
                                   const char *name )
-  : QWidget( parent, name), mDisableItemUpdate( false ), mFreeBusy( 0 )
+  : KOAttendeeEditor( parent, name), mDisableItemUpdate( false )
 {
-  QGridLayout *topLayout = new QGridLayout( this );
+  QBoxLayout *topLayout = new QVBoxLayout( this );
   topLayout->setSpacing( spacing );
 
-  mOrganizerHBox = new QHBox( this );
-  // If creating a new event, then the user is the organizer -> show the
-  // identity combo
-  // readEvent will delete it and set another label text instead, if the user
-  // isn't the organizer.
-  // Note that the i18n text below is duplicated in readEvent
-  QString whatsThis = i18n("Sets the identity corresponding to "
-		  	   "the organizer of this to-do or event. "
-			   "Identities can be set in the 'Personal' "
-			   "section of the KOrganizer configuration, or in the "
-			   "'Security & Privacy'->'Password & User Account' "
-			   "section of the KDE Control Center. In addition, "
-			   "identities are gathered from your KMail settings "
-			   "and from your address book. If you choose "
-			   "to set it globally for KDE in the Control Center, "
-			   "be sure to check 'Use email settings from "
-			   "Control Center' in the 'Personal' section of the "
-			   "KOrganizer configuration.");
-  mOrganizerLabel = new QLabel( i18n( "Identity as organizer:" ),
-                                mOrganizerHBox );
-  mOrganizerCombo = new QComboBox( mOrganizerHBox );
-  QWhatsThis::add( mOrganizerLabel, whatsThis );
-  QWhatsThis::add( mOrganizerCombo, whatsThis );
-  fillOrganizerCombo();
-  mOrganizerHBox->setStretchFactor( mOrganizerCombo, 100 );
+  initOrganizerWidgets( this, topLayout );
 
   mListView = new KOAttendeeListView( this, "mListView" );
   QWhatsThis::add( mListView,
@@ -221,9 +200,11 @@
 			"from the attendee.") );
   mListView->addColumn( i18n("Name"), 200 );
   mListView->addColumn( i18n("Email"), 200 );
-  mListView->addColumn( i18n("Role"), 60 );
+  mListView->addColumn( i18n("Role"), 80 );
   mListView->addColumn( i18n("Status"), 100 );
-  mListView->addColumn( i18n("RSVP"), 35 );
+  mListView->addColumn( i18n("RSVP"), 55 );
+  mListView->addColumn( i18n("Delegated to"), 120 );
+  mListView->addColumn( i18n("Delegated from" ), 120 );
   mListView->setResizeMode( QListView::LastColumn );
   if ( KOPrefs::instance()->mCompactDialogs ) {
     mListView->setFixedHeight( 78 );
@@ -233,110 +214,14 @@
            SLOT( updateAttendeeInput() ) );
 #ifndef KORG_NODND
   connect( mListView, SIGNAL( dropped( Attendee * ) ),
-           SLOT( insertAttendee( Attendee * ) ) );
+           SLOT( slotInsertAttendee( Attendee * ) ) );
 #endif
+  topLayout->addWidget( mListView );
 
-  whatsThis = i18n("Edits the name of the attendee selected in the list "
-  		   "above, or adds a new attendee if there are no attendees"
-		   "in the list.");
-  QLabel *attendeeLabel = new QLabel( this );
-  QWhatsThis::add( attendeeLabel, whatsThis );
-  attendeeLabel->setText( i18n("Na&me:") );
+  initEditWidgets( this, topLayout );
 
-  mNameEdit = new KPIM::AddresseeLineEdit( this );
-  QWhatsThis::add( mNameEdit, whatsThis );
-  mNameEdit->setClickMessage( i18n("Click to add a new attendee") );
-  attendeeLabel->setBuddy( mNameEdit );
-  mNameEdit->installEventFilter( this );
-  connect( mNameEdit, SIGNAL( textChanged( const QString & ) ),
-           SLOT( updateAttendeeItem() ) );
+  connect( mRemoveButton, SIGNAL(clicked()), SLOT(removeAttendee()) );
 
-  whatsThis = i18n("Edits the role of the attendee selected "
-  		   "in the list above.");
-  QLabel *attendeeRoleLabel = new QLabel( this );
-  QWhatsThis::add( attendeeRoleLabel, whatsThis );
-  attendeeRoleLabel->setText( i18n("Ro&le:") );
-
-  mRoleCombo = new QComboBox( false, this );
-  QWhatsThis::add( mRoleCombo, whatsThis );
-  mRoleCombo->insertStringList( Attendee::roleList() );
-  attendeeRoleLabel->setBuddy( mRoleCombo );
-  connect( mRoleCombo, SIGNAL( activated( int ) ),
-           SLOT( updateAttendeeItem() ) );
-
-  whatsThis = i18n("Edits the current attendance status of the attendee "
-  		   "selected in the list above.");
-  QLabel *statusLabel = new QLabel( this );
-  QWhatsThis::add( statusLabel, whatsThis );
-  statusLabel->setText( i18n("Stat&us:") );
-
-  mStatusCombo = new QComboBox( false, this );
-  QWhatsThis::add( mStatusCombo, whatsThis );
-  mStatusCombo->insertStringList( Attendee::statusList() );
-  statusLabel->setBuddy( mStatusCombo );
-  connect( mStatusCombo, SIGNAL( activated( int ) ),
-           SLOT( updateAttendeeItem() ) );
-
-  mRsvpButton = new QCheckBox( this );
-  QWhatsThis::add( mRsvpButton,
-		   i18n("Edits whether to send an email to the attendee "
-			"selected in the list above to request "
-			"a response concerning attendance.") );
-  mRsvpButton->setText( i18n("Re&quest response") );
-  connect( mRsvpButton, SIGNAL( clicked() ), SLOT( updateAttendeeItem() ) );
-
-  QWidget *buttonBox = new QWidget( this );
-  QVBoxLayout *buttonLayout = new QVBoxLayout( buttonBox );
-
-  QPushButton *newButton = new QPushButton( i18n("&New"), buttonBox );
-  QWhatsThis::add( newButton,
-		   i18n("Adds a new attendee to the list. Once the "
-		   	"attendee is added, you will be able to "
-			"edit the attendee's name, role, attendance "
-			"status, and whether or not the attendee is required "
-			"to respond to the invitation. To select an attendee "
-			"from your addressbook, click the 'Select Addressee' "
-			"button instead.") );
-  buttonLayout->addWidget( newButton );
-  connect( newButton, SIGNAL( clicked() ), SLOT( addNewAttendee() ) );
-
-  mRemoveButton = new QPushButton( i18n("&Remove"), buttonBox );
-  QWhatsThis::add( mRemoveButton,
-		   i18n("Removes the attendee selected in "
-		   	"the list above.") );
-  buttonLayout->addWidget( mRemoveButton );
-  connect( mRemoveButton, SIGNAL( clicked() ), SLOT( removeAttendee() ) );
-
-  mAddressBookButton = new QPushButton( i18n("Select Addressee..."),
-                                        buttonBox );
-  QWhatsThis::add( mAddressBookButton,
-		   i18n("Opens your address book, allowing you to select "
-			"new attendees from it.") );
-  buttonLayout->addWidget( mAddressBookButton );
-  connect( mAddressBookButton, SIGNAL( clicked() ), SLOT( openAddressBook() ) );
-
-  topLayout->addMultiCellWidget( mOrganizerHBox, 0, 0, 0, 5 );
-  topLayout->addMultiCellWidget( mListView, 1, 1, 0, 5 );
-  topLayout->addWidget( attendeeLabel, 2, 0 );
-  topLayout->addMultiCellWidget( mNameEdit, 2, 2, 1, 1 );
-//  topLayout->addWidget( emailLabel, 3, 0 );
-  topLayout->addWidget( attendeeRoleLabel, 3, 0 );
-  topLayout->addWidget( mRoleCombo, 3, 1 );
-#if 0
-  topLayout->setColStretch( 2, 1 );
-  topLayout->addWidget( statusLabel, 3, 3 );
-  topLayout->addWidget( mStatusCombo, 3, 4 );
-#else
-  topLayout->addWidget( statusLabel, 4, 0 );
-  topLayout->addWidget( mStatusCombo, 4, 1 );
-#endif
-  topLayout->addMultiCellWidget( mRsvpButton, 5, 5, 0, 1 );
-  topLayout->addMultiCellWidget( buttonBox, 2, 4, 5, 5 );
-
-#ifdef KORG_NOKABC
-  mAddressBookButton->hide();
-#endif
-
   updateAttendeeInput();
 }
 
@@ -349,16 +234,6 @@
   return mListView->childCount() > 0;
 }
 
-bool KOEditorDetails::eventFilter( QObject *watched, QEvent *ev)
-{
-  if ( watched && watched == mNameEdit && ev->type() == QEvent::FocusIn &&
-       mListView->childCount() == 0 ) {
-    addNewAttendee();
-  }
-
-  return QWidget::eventFilter( watched, ev );
-}
-
 void KOEditorDetails::removeAttendee()
 {
   AttendeeListItem *aItem =
@@ -370,82 +245,22 @@
                                  aItem->data()->role(), aItem->data()->uid() );
   mdelAttendees.append( delA );
 
-  if ( mFreeBusy ) mFreeBusy->removeAttendee( aItem->data() );
   delete aItem;
 
   updateAttendeeInput();
+  emit updateAttendeeSummary( mListView->childCount() );
 }
 
 
-void KOEditorDetails::openAddressBook()
-{
-#ifndef KORG_NOKABC
-  KPIM::AddressesDialog *dia = new KPIM::AddressesDialog( this, "adddialog" );
-  dia->setShowCC( false );
-  dia->setShowBCC( false );
-  if ( dia->exec() ) {
-    KABC::Addressee::List aList = dia->allToAddressesNoDuplicates();
-    for ( KABC::Addressee::List::iterator itr = aList.begin();
-          itr != aList.end(); ++itr ) {
-      KABC::Addressee a = (*itr);
-      bool myself = KOPrefs::instance()->thatIsMe( a.preferredEmail() );
-      bool sameAsOrganizer = mOrganizerCombo && 
-        KPIM::compareEmail( a.preferredEmail(), mOrganizerCombo->currentText(), false );
-      KCal::Attendee::PartStat partStat;
-      if ( myself && sameAsOrganizer ) 
-        partStat = KCal::Attendee::Accepted;
-      else 
-        partStat = KCal::Attendee::NeedsAction;
-      insertAttendee( new Attendee( a.realName(), a.preferredEmail(),
-                                    !myself, partStat,
-                                    KCal::Attendee::ReqParticipant, a.uid() ),
-                      true );
-    }
-  }
-  delete dia;
-  return;
-#if 0
-    // old code
-    KABC::Addressee a = KABC::AddresseeDialog::getAddressee(this);
-    if (!a.isEmpty()) {
-        // If this is myself, I don't want to get a response but instead
-        // assume I will be available
-        bool myself = KOPrefs::instance()->thatIsMe( a.preferredEmail() );
-        KCal::Attendee::PartStat partStat =
-            myself ? KCal::Attendee::Accepted : KCal::Attendee::NeedsAction;
-        insertAttendee( new Attendee( a.realName(), a.preferredEmail(),
-                                      !myself, partStat,
-                                      KCal::Attendee::ReqParticipant, a.uid() ) );
-    }
-#endif
-#endif
-}
-
-
-void KOEditorDetails::addNewAttendee()
-{
-  Attendee *a = new Attendee( i18n("Firstname Lastname"),
-                              i18n("name") + "@example.net", true );
-  insertAttendee( a, false );
-  // We don't want the hint again
-  mNameEdit->setClickMessage( "" );
-  mNameEdit->setFocus();
-  QTimer::singleShot( 0, mNameEdit, SLOT( selectAll() ) );
-}
-
-
-void KOEditorDetails::insertAttendee( Attendee *a )
-{
-  insertAttendee( a, true );
-}
-
 void KOEditorDetails::insertAttendee( Attendee *a, bool goodEmailAddress )
 {
+  Q_UNUSED( goodEmailAddress );
+
   // lastItem() is O(n), but for n very small that should be fine
   AttendeeListItem *item = new AttendeeListItem( a, mListView,
       static_cast<KListViewItem*>( mListView->lastItem() ) );
   mListView->setSelected( item, true );
-  if( mFreeBusy ) mFreeBusy->insertAttendee( a, goodEmailAddress );
+  emit updateAttendeeSummary( mListView->childCount() );
 }
 
 void KOEditorDetails::setDefaults()
@@ -455,78 +270,63 @@
 
 void KOEditorDetails::readEvent( Incidence *event )
 {
-  // Stop flickering in the free/busy view (not sure if this is necessary)
-  bool block = false;
-  if( mFreeBusy ) {
-    block = mFreeBusy->updateEnabled();
-    mFreeBusy->setUpdateEnabled( false );
-    mFreeBusy->clearAttendees();
-  }
-
   mListView->clear();
-  mdelAttendees.clear();
-  Attendee::List al = event->attendees();
-  Attendee::List::ConstIterator it;
-  for( it = al.begin(); it != al.end(); ++it )
-    insertAttendee( new Attendee( **it ), true );
+  KOAttendeeEditor::readEvent( event );
 
   mListView->setSelected( mListView->firstChild(), true );
 
-  if ( KOPrefs::instance()->thatIsMe( event->organizer().email() ) ) {
-    if ( !mOrganizerCombo ) {
-      mOrganizerCombo = new QComboBox( mOrganizerHBox );
-      fillOrganizerCombo();
-    }
-    mOrganizerLabel->setText( i18n( "Identity as organizer:" ) );
-
-    int found = -1;
-    QString fullOrganizer = event->organizer().fullName();
-    for ( int i = 0 ; i < mOrganizerCombo->count(); ++i ) {
-      if ( mOrganizerCombo->text( i ) == fullOrganizer ) {
-        found = i;
-        mOrganizerCombo->setCurrentItem( i );
-        break;
-      }
-    }
-    if ( found < 0 ) {
-      mOrganizerCombo->insertItem( fullOrganizer, 0 );
-      mOrganizerCombo->setCurrentItem( 0 );
-    }
-  } else { // someone else is the organizer
-    if ( mOrganizerCombo ) {
-      delete mOrganizerCombo;
-      mOrganizerCombo = 0;
-    }
-    mOrganizerLabel->setText( i18n( "Organizer: %1" ).arg( event->organizer().fullName() ) );
-  }
-
-  // Reinstate free/busy view updates
-  if( mFreeBusy ) mFreeBusy->setUpdateEnabled( block );
+  emit updateAttendeeSummary( mListView->childCount() );
 }
 
 void KOEditorDetails::writeEvent(Incidence *event)
 {
   event->clearAttendees();
+  QValueVector<QListViewItem*> toBeDeleted;
   QListViewItem *item;
   AttendeeListItem *a;
   for (item = mListView->firstChild(); item;
        item = item->nextSibling()) {
     a = (AttendeeListItem *)item;
-    event->addAttendee(new Attendee(*(a->data())));
+    Attendee *attendee = a->data();
+    Q_ASSERT( attendee );
+    /* Check if the attendee is a distribution list and expand it */
+    if ( attendee->email().isEmpty() ) {
+      KPIM::DistributionList list =
+        KPIM::DistributionList::findByName( KABC::StdAddressBook::self(), attendee->name() );
+      if ( !list.isEmpty() ) {
+        toBeDeleted.push_back( item ); // remove it once we are done expanding
+        KPIM::DistributionList::Entry::List entries = list.entries( KABC::StdAddressBook::self() );
+        KPIM::DistributionList::Entry::List::Iterator it( entries.begin() );
+        while ( it != entries.end() ) {
+          KPIM::DistributionList::Entry &e = ( *it );
+          ++it;
+          // this calls insertAttendee, which appends
+          insertAttendeeFromAddressee( e.addressee, attendee );
+          // TODO: duplicate check, in case it was already added manually
+        }
+      }
+    } else {
+      bool skip = false;
+      if ( attendee->email().endsWith( "example.net" ) ) {
+        if ( KMessageBox::warningYesNo( this, i18n("%1 does not look like a valid email address. "
+                "Are you sure you want to invite this participant?").arg( attendee->email() ),
+              i18n("Invalid email address") ) != KMessageBox::Yes ) {
+          skip = true;
+        }
+      }
+      if ( !skip ) {
+        event->addAttendee( new Attendee( *attendee ) );
+      }
+    }
   }
-  if ( mOrganizerCombo ) {
-    event->setOrganizer( mOrganizerCombo->currentText() );
-  }
-}
 
-void KOEditorDetails::cancelAttendeeEvent(Incidence *event)
-{
-  event->clearAttendees();
-  Attendee * att;
-  for (att=mdelAttendees.first();att;att=mdelAttendees.next()) {
-    event->addAttendee(new Attendee(*att));
+  KOAttendeeEditor::writeEvent( event );
+
+  // cleanup
+  QValueVector<QListViewItem*>::iterator it;
+  for( it = toBeDeleted.begin(); it != toBeDeleted.end(); ++it ) {
+    delete *it;
   }
-  mdelAttendees.clear();
 }
 
 bool KOEditorDetails::validateInput()
@@ -534,117 +334,39 @@
   return true;
 }
 
-void KOEditorDetails::updateAttendeeInput()
+KCal::Attendee * KOEditorDetails::currentAttendee() const
 {
-  setEnableAttendeeInput(!mNameEdit->text().isEmpty());
   QListViewItem *item = mListView->selectedItem();
   AttendeeListItem *aItem = static_cast<AttendeeListItem *>( item );
-  if (aItem) {
-    fillAttendeeInput( aItem );
-  } else {
-    clearAttendeeInput();
-  }
+  if ( !aItem )
+    return 0;
+  return aItem->data();
 }
 
-void KOEditorDetails::clearAttendeeInput()
+void KOEditorDetails::updateCurrentItem()
 {
-  mNameEdit->setText("");
-  mUid = QString::null;
-  mRoleCombo->setCurrentItem(0);
-  mStatusCombo->setCurrentItem(0);
-  mRsvpButton->setChecked(true);
-  setEnableAttendeeInput( false );
+  AttendeeListItem *item = static_cast<AttendeeListItem*>( mListView->selectedItem() );
+  if ( item )
+    item->updateItem();
 }
 
-void KOEditorDetails::fillAttendeeInput( AttendeeListItem *aItem )
+void KOEditorDetails::slotInsertAttendee(Attendee * a)
 {
-  Attendee *a = aItem->data();
-  mDisableItemUpdate = true;
-  QString name = a->name();
-  if (!a->email().isEmpty()) {
-    name = KPIM::quoteNameIfNecessary( name );
-    name += " <" + a->email() + ">";
-  }
-  mNameEdit->setText(name);
-  mUid = a->uid();
-  mRoleCombo->setCurrentItem(a->role());
-  mStatusCombo->setCurrentItem(a->status());
-  mRsvpButton->setChecked(a->RSVP());
-
-  mDisableItemUpdate = false;
-
-  setEnableAttendeeInput( true );
+  insertAttendee( a );
 }
 
-void KOEditorDetails::setEnableAttendeeInput( bool enabled )
+void KOEditorDetails::changeStatusForMe(Attendee::PartStat status)
 {
-  //mNameEdit->setEnabled( enabled );
-  mRoleCombo->setEnabled( enabled );
-  mStatusCombo->setEnabled( enabled );
-  mRsvpButton->setEnabled( enabled );
-
-  mRemoveButton->setEnabled( enabled );
-}
-
-void KOEditorDetails::updateAttendeeItem()
-{
-  if (mDisableItemUpdate) return;
-
-  QListViewItem *item = mListView->selectedItem();
-  AttendeeListItem *aItem = static_cast<AttendeeListItem *>( item );
-  if ( !aItem ) return;
-
-  Attendee *a = aItem->data();
-
-  QString name;
-  QString email;
-  KPIM::getNameAndMail(mNameEdit->text(), name, email);
-
-  bool iAmTheOrganizer = mOrganizerCombo &&
-    KOPrefs::instance()->thatIsMe( mOrganizerCombo->currentText() );
-  if ( iAmTheOrganizer ) {
-    bool myself =
-      KPIM::compareEmail( email, mOrganizerCombo->currentText(), false );
-    bool wasMyself = 
-      KPIM::compareEmail( a->email(), mOrganizerCombo->currentText(), false );
-    if ( myself ) {
-      mStatusCombo->setCurrentItem( KCal::Attendee::Accepted );
-      mRsvpButton->setChecked( false );
-      mRsvpButton->setEnabled( false );
-    } else if ( wasMyself ) {
-      // this was me, but is no longer, reset
-      mStatusCombo->setCurrentItem( KCal::Attendee::NeedsAction );
-      mRsvpButton->setChecked( true );
-      mRsvpButton->setEnabled( true );
+  const QStringList myEmails = KOPrefs::instance()->allEmails();
+  for ( QListViewItemIterator it( mListView ); it.current(); ++it ) {
+    AttendeeListItem *item = static_cast<AttendeeListItem*>( it.current() );
+    for ( QStringList::ConstIterator it2( myEmails.begin() ), end( myEmails.end() ); it2 != end; ++it2 ) {
+      if ( item->data()->email() == *it2 ) {
+        item->data()->setStatus( status );
+        item->updateItem();
+      }
     }
   }
-  a->setName( name );
-  a->setUid( mUid );
-  a->setEmail( email );
-  a->setRole( Attendee::Role( mRoleCombo->currentItem() ) );
-  a->setStatus( Attendee::PartStat( mStatusCombo->currentItem() ) );
-  a->setRSVP( mRsvpButton->isChecked() );
-  aItem->updateItem();
-  if ( mFreeBusy ) mFreeBusy->updateAttendee( a );
 }
 
-void KOEditorDetails::setFreeBusyWidget( KOEditorFreeBusy *v )
-{
-  mFreeBusy = v;
-}
-
-void KOEditorDetails::fillOrganizerCombo()
-{
-  Q_ASSERT( mOrganizerCombo );
-  // Get all emails from KOPrefs (coming from various places),
-  // and insert them - removing duplicates
-  const QStringList lst = KOPrefs::instance()->fullEmails();
-  QStringList uniqueList;
-  for( QStringList::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
-    if ( uniqueList.find( *it ) == uniqueList.end() )
-      uniqueList << *it;
-  }
-  mOrganizerCombo->insertStringList( uniqueList );
-}
-
 #include "koeditordetails.moc"
Index: korganizer/koeditorfreebusy.h
===================================================================
--- korganizer/koeditorfreebusy.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorfreebusy.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,10 +24,13 @@
 #ifndef KOEDITORFREEBUSY_H
 #define KOEDITORFREEBUSY_H
 
+#include "koattendeeeditor.h"
+
 #include <qwidget.h>
 #include <qdatetime.h>
 #include <qtimer.h>
 
+class KDIntervalColorRectangle;
 class QLabel;
 class KDGanttView;
 class KDGanttViewItem;
@@ -39,7 +42,7 @@
 }
 
 
-class KOEditorFreeBusy : public QWidget
+class KOEditorFreeBusy : public KOAttendeeEditor
 {
     Q_OBJECT
   public:
@@ -50,12 +53,12 @@
     void setUpdateEnabled( bool enabled );
     bool updateEnabled() const;
 
-    void insertAttendee( KCal::Attendee *, bool readFBList );
+    void insertAttendee( KCal::Attendee *, bool readFBList = true );
     void removeAttendee( KCal::Attendee * );
-    void updateAttendee( KCal::Attendee * );
     void clearAttendees();
 
     void readEvent( KCal::Event * );
+    void writeEvent( KCal::Event *event );
 
     void triggerReload();
     void cancelReload();
@@ -76,14 +79,23 @@
     void slotCenterOnStart() ;
     void slotZoomToTime();
     void slotPickDate();
+    void showAttendeeStatusMenu();
 
     // Force the download of FB informations
     void manualReload();
     // Only download FB if the auto-download option is set in config
     void autoReload();
+    void slotIntervalColorRectangleMoved( const QDateTime& start, const QDateTime& end );
 
+    void removeAttendee();
+    void listViewClicked( int button, KDGanttViewItem* item );
+
   protected:
     void timerEvent( QTimerEvent* );
+    KCal::Attendee* currentAttendee() const;
+    void updateCurrentItem();
+    void clearSelection() const;
+    void changeStatusForMe( KCal::Attendee::PartStat status );
 
   private:
     void updateFreeBusyData( FreeBusyItem * );
@@ -95,6 +107,7 @@
     void updateStatusSummary();
     void reload();
     KDGanttView *mGanttView;
+    KDIntervalColorRectangle* mEventRectangle;
     QLabel *mStatusSummaryLabel;
     bool mIsOrganizer;
     QComboBox *scaleCombo;
Index: korganizer/koeditorrecurrence.cpp
===================================================================
--- korganizer/koeditorrecurrence.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorrecurrence.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -248,7 +248,7 @@
   QWhatsThis::add( mByDayRadio,
                    i18n("Sets a specific day of the month on which "
                         "this event or to-do should recur.") );
-  
+
   buttonLayout->addWidget( mByDayRadio, 0, 0 );
 
   QString whatsThis = i18n("The day of the month on which this event or to-do "
@@ -489,7 +489,7 @@
 
   mByDaySpin = new QSpinBox( 1, 366, 1, buttonGroup );
   QWhatsThis::add( mByDaySpin, whatsThis );
-  
+
   dayLayout->addWidget( mByDaySpin );
 
   QString ofTheYear( i18n("part after NNN of 'Recur on day #NNN of the year'", " of the &year"));
@@ -1120,17 +1120,17 @@
   mWeekly->setDateTimes( start, end );
   mMonthly->setDateTimes( start, end );
   mYearly->setDateTimes( start, end );
-  
+
   // Now set the defaults for all unused types, use the start time for it
   bool enabled = mEnabledCheck->isChecked();
   int type = mRecurrenceChooser->type();
-  
+
   if ( !enabled || type != RecurrenceChooser::Weekly ) {
     QBitArray days( 7 );
     days.fill( 0 );
     days.setBit( (start.date().dayOfWeek()+6) % 7 );
     mWeekly->setDays( days );
-  } 
+  }
   if ( !enabled || type != RecurrenceChooser::Monthly ) {
     mMonthly->setByPos( ( start.date().day() - 1 ) / 7 + 1, start.date().dayOfWeek() - 1 );
     mMonthly->setByDay( start.date().day() );
@@ -1340,7 +1340,7 @@
     r->setWeekly( mWeekly->frequency(), mWeekly->days() );
   } else if ( recurrenceType == RecurrenceChooser::Monthly ) {
     r->setMonthly( mMonthly->frequency() );
-    
+
     if ( mMonthly->byPos() ) {
       int pos = mMonthly->count();
 
@@ -1373,7 +1373,7 @@
     }
   } // end "Yearly"
 
-  if ( duration > 0 ) 
+  if ( duration > 0 )
     r->setDuration( duration );
   else if ( duration == 0 )
     r->setEndDate( endDate );
@@ -1437,3 +1437,11 @@
 {
   return mEnabledCheck->isChecked();
 }
+
+
+KOEditorRecurrenceDialog::KOEditorRecurrenceDialog(QWidget * parent) :
+    KDialogBase( parent, 0, false, i18n("Recurrence"), Ok )
+{
+  mRecurrence = new KOEditorRecurrence( this );
+  setMainWidget( mRecurrence );
+}
Index: korganizer/kotimelineview.h
===================================================================
--- korganizer/kotimelineview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/kotimelineview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,85 @@
+/*
+    This file is part of KOrganizer.
+
+    Copyright (c) 2007 Till Adam <adam@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+#ifndef KOTIMELINEVIEW_H
+#define KOTIMELINEVIEW_H
+
+#include <koeventview.h>
+#include <kdgantt/KDGanttView.h>
+#include <qmap.h>
+
+class KDGanttViewItem;
+
+namespace KCal {
+  class ResourceCalendar;
+}
+
+namespace KOrg {
+  class TimelineItem;
+}
+
+/**
+  This class provides a view ....
+*/
+class KOTimelineView : public KOEventView
+{
+    Q_OBJECT
+  public:
+    KOTimelineView(Calendar *calendar, QWidget *parent = 0,
+                    const char *name = 0);
+    ~KOTimelineView();
+
+    virtual KCal::ListBase<KCal::Incidence> selectedIncidences();
+    virtual KCal::DateList selectedDates();
+    virtual int currentDateCount();
+    virtual void showDates(const QDate&, const QDate&);
+    virtual void showIncidences(const KCal::ListBase<KCal::Incidence>&);
+    virtual void updateView();
+    virtual void changeIncidenceDisplay(KCal::Incidence* incidence, int mode);
+    virtual int maxDatesHint() { return 0; }
+
+    virtual bool eventDurationHint(QDateTime &startDt, QDateTime &endDt, bool &allDay);
+
+  private:
+    KOrg::TimelineItem* calendarItemForIncidence( KCal::Incidence* incidence );
+    void insertIncidence( KCal::Incidence* incidence );
+    void insertIncidence( KCal::Incidence* incidence, const QDate &day );
+    void removeIncidence( KCal::Incidence* incidence );
+
+  private slots:
+    void itemSelected( KDGanttViewItem *item );
+    void itemDoubleClicked( KDGanttViewItem *item );
+    void itemRightClicked( KDGanttViewItem *item );
+    void itemMoved( KDGanttViewItem *item );
+    void overscale( KDGanttView::Scale scale );
+    void newEventWithHint( const QDateTime & );
+
+  private:
+    KDGanttView* mGantt;
+    QMap<KCal::ResourceCalendar*, QMap<QString, KOrg::TimelineItem*> > mCalendarItemMap;
+    KOEventPopupMenu *mEventPopup;
+    QDate mStartDate, mEndDate;
+    QDateTime mHintDate;
+};
+
+#endif
Index: korganizer/plugins/datenums/datenums.desktop
===================================================================
--- korganizer/plugins/datenums/datenums.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/datenums/datenums.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Name[da]=Datonumre-plugin for kalendere
 Name[de]=Kalendertag-Modul f√ºr Kalender
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø Œ±œÅŒπŒ∏ŒºŒøœç Œ∑ŒºŒµœÅœéŒΩ Œ≥ŒπŒ± ŒóŒºŒµœÅŒøŒªœåŒ≥ŒπŒ±
+Name[eo]=Datnumera kromaƒµo por Kalendaro
 Name[es]=Accesorio de n√∫meros de fecha para calendarios
 Name[et]=Kuup√§eva nummerdamise plugin kalendritele
 Name[eu]=Egutegientzako data zenbakiak
Index: korganizer/plugins/projectview/projectview.desktop
===================================================================
--- korganizer/plugins/projectview/projectview.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/projectview/projectview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -34,7 +34,7 @@
 Name[lt]=Projekto per≈æi≈´ros priedas, skirtas KOrganizer
 Name[lv]=Projekta Skatƒ´juma Iespraudnis KOrganaizeram
 Name[ms]=Plugin Paparan Projek untuk KOrganizer
-Name[nb]=Programtilllegg for prosjektvisning i KOrganizer
+Name[nb]=Programtillegg for prosjektvisning i KOrganizer
 Name[nds]=Projektkieker-Moduul f√∂r KOrganizer
 Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Name[nl]=Projectenweergaveplugin voor KOrganizer
Index: korganizer/plugins/exchange/exchange.desktop
===================================================================
--- korganizer/plugins/exchange/exchange.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/exchange/exchange.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Name[da]=Microsoft Exchange 2000-plugin for KOrganizer
 Name[de]=Microsoft Exchange 2000-Modul f√ºr KOrganizer
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø Microsoft Exchange 2000 œÑŒøœÖ KOrganizer
+Name[eo]=Microsoft Exchange 2000-kromaƒµo por Organizilo
 Name[es]=Accesorio de Microsoft Exchange 2000 para KOrganizer
 Name[et]=Microsoft Exchange 2000 plugin KOrganizeri jaoks
 Name[eu]=KOrganizer-en Microsoft Exchange 2000 plugin-a
Index: korganizer/plugins/printing/year/yearprint.desktop
===================================================================
--- korganizer/plugins/printing/year/yearprint.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/printing/year/yearprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Yearly udskriftsstil
 Name[de]=Jahres-Druckstil
 Name[el]=Œ£œÑœÖŒª ŒµœÑŒÆœÉŒπŒ±œÇ ŒµŒ∫œÑœçœÄœâœÉŒ∑œÇ
+Name[eo]=Pojara Presostilo
 Name[es]=Estilo de impresi√≥n del diario
 Name[et]=Aastakalendri tr√ºkkimise stiil
 Name[fa]=ÿ≥ÿ®⁄© ⁄ÜÿßŸæ ŸÜÿ¥ÿ±€åŸá
Index: korganizer/plugins/printing/whatsnext/whatsnextprint.desktop
===================================================================
--- korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/printing/whatsnext/whatsnextprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Hvad er det n√¶ste-udskriftsstil
 Name[de]=Was-kommt-als-n√§chstes Druckstil
 Name[el]=Œ£œÑœÖŒª ŒµŒ∫œÑœçœÄœâœÉŒ∑œÇ 'Œ§ŒØ ŒΩŒ≠Œø œÖœÄŒ¨œÅœáŒµŒπ'
+Name[eo]="Kio postsekvas"-Presostilo
 Name[es]=Estilo de impresi√≥n de ¬´Qu√© es lo siguiente¬ª
 Name[et]="Mis j√§rgmiseks?" tr√ºkkimise stiil
 Name[eu]="Zer da hurrengoa" inprimatzeko estiloa
Index: korganizer/plugins/printing/journal/journalprint.desktop
===================================================================
--- korganizer/plugins/printing/journal/journalprint.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/printing/journal/journalprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Journal udskriftsstil
 Name[de]=Journal Druckstil
 Name[el]=Œ£œÑœÖŒª ŒµŒ∫œÑœçœÄœâœÉŒ∑œÇ œáœÅŒøŒΩŒπŒ∫Œøœç
+Name[eo]=ƒ¥urnal-Presostilo
 Name[es]=Estilo de impresi√≥n del diario
 Name[et]=P√§eviku tr√ºkkimise stiil
 Name[eu]=Egunkariak inprimatzeko estiloa
Index: korganizer/plugins/printing/list/listprint.desktop
===================================================================
--- korganizer/plugins/printing/list/listprint.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/printing/list/listprint.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Listeudskriftsstil
 Name[de]=Listen Druckstil
 Name[el]=Œ£œÑœÖŒª ŒµŒ∫œÑœçœÄœâœÉŒ∑œÇ ŒªŒØœÉœÑŒ±œÇ
+Name[eo]=List-Presostilo
 Name[es]=Estilo de impresi√≥n de la lista
 Name[et]=Nimekirja tr√ºkkimise stiil
 Name[eu]=Zerrenda inprimatzeko estiloa
Index: korganizer/plugins/timespanview/timespanview.desktop
===================================================================
--- korganizer/plugins/timespanview/timespanview.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/timespanview/timespanview.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -8,6 +8,7 @@
 Name[da]=Timespan-visning-plugin for KOrganizer
 Name[de]=Zeitspannenansicht-Modul f√ºr KOrganizer
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø œÄœÅŒøŒ≤ŒøŒªŒÆœÇ ŒµœÅŒ≥Œ±œÉŒπœéŒΩ œÑŒøœÖ KOrganizer
+Name[eo]=Tempgamrigardo-kromaƒµo por Organizilo
 Name[es]=Extensi√≥n de visor de Timespan para KOrganizer
 Name[et]=KOrganizeri perioodivaate plugin
 Name[eu]=KOrganizer-rako denbora-barruti ukuspegi plugin-a
@@ -24,7 +25,7 @@
 Name[km]=·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏‚Äã·ûá·üÜ·ûì·ûΩ·ûô‚Äã·ûë·û∑·ûä·üí·ûã·ûó·û∂·ûñ‚Äã·ûö·ûô·üà·ûñ·üÅ·ûõ‚Äã·ûü·ûò·üí·ûö·û∂·ûî·üã KOrganizer
 Name[lt]=Laiko tarpsnio vaizdo KOrganizer priedas
 Name[ms]=Plugin Paparan Kitar Waktu untuk KOrganizer
-Name[nb]=Programtilllegg for periodevisning i KOrganizer
+Name[nb]=Programtillegg for periodevisning i KOrganizer
 Name[nds]=Tietbruuk-Moduul f√∂r KOrganizer
 Name[ne]=‡§ï‡•á‡§°‡•Ä‡§à ‡§Ü‡§Ø‡•ã‡§ú‡§ï‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§∏‡§Æ‡§Ø‡§æ‡§µ‡§ß‡§ø ‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡•ç‡§≤‡§ó‡§á‡§®
 Name[nl]=Tijdspanneplugin voor KOrganizer
Index: korganizer/plugins/hebrew/hebrew.desktop
===================================================================
--- korganizer/plugins/hebrew/hebrew.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/plugins/hebrew/hebrew.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -11,6 +11,7 @@
 Name[da]=J√∏disk kalender-plugin
 Name[de]=Modul f√ºr j√ºdischen Kalender
 Name[el]=Œ†œÅœåœÉŒ∏ŒµœÑŒø ŒµŒ≤œÅŒ±œäŒ∫Œøœç Œ∑ŒºŒµœÅŒøŒªŒøŒ≥ŒØŒøœÖ
+Name[eo]=Judkalendar-kromaƒµo
 Name[es]=Accesorio de calendario jud√≠o
 Name[et]=Juudi kalendri plugin
 Name[eu]=Egutegi judutar plugin-a
Index: korganizer/korganizer.kcfg
===================================================================
--- korganizer/korganizer.kcfg	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer.kcfg	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -204,13 +204,45 @@
       <whatsthis>Check this box if you want to show seconds on the current-time line.</whatsthis>
       <default>true</default>
     </entry>
-    <entry type="Bool" key="Agenda View Uses Resource Color">
-      <label>Agenda view uses resource colors</label>
-      <whatsthis>Check this box to make the agenda view use the resource colors of an item.</whatsthis>
-      <default>true</default>
+
+    <entry type="Enum" key="AgendaViewColors">
+      <label>Colors used in agenda view</label>
+      <whatsthis>Choose the colors of the agenda view items.</whatsthis>
+      <choices>
+        <choice name="CategoryInsideResourceOutside">
+          <label>Category inside, calendar outside</label>
+        </choice>
+        <choice name="ResourceInsideCategoryOutside">
+          <label>Calendar inside, category outside</label>
+        </choice>
+        <choice name="CategoryOnly">
+          <label>Only category</label>
+        </choice>
+        <choice name="ResourceOnly">
+          <label>Only calendar</label>
+        </choice>
+      </choices>
+      <default>ResourceInsideCategoryOutside</default>
     </entry>
 
+    <entry type="Enum" name="Agenda View Calendar Display">
+      <label>Agenda View Calendar Display</label>
+      <choices>
+        <choice name="CalendarsMerged">
+            <label>Merge all calendars into one view</label>
+        </choice>
+        <choice name="CalendarsSideBySide">
+            <label>Show calendars side by side</label>
+        </choice>
+        <choice name="AllCalendarViews">
+            <label>Switch between views with tabs</label>
+        </choice>
+      </choices>
+      <default>CalendarsMerged</default>
+    </entry>
 
+
+
     <entry type="DateTime" name="DayBegins">
       <label>Day begins at</label>
       <whatsthis>Enter the start time for events here. This time should be the earliest time that you use for events, as it will be displayed at the top.</whatsthis>
@@ -248,7 +280,6 @@
       <default>true</default>
     </entry>
 
-
     <entry type="Bool" key="Full View Month">
       <label>Month view uses full window</label>
       <whatsthis>Check this box to use the full KOrganizer window when displaying the month view. If this box is checked, you will gain some space for the monthly view, but other widgets, such as the date navigator, the item details and the resources list, will not be displayed.</whatsthis>
@@ -343,7 +374,7 @@
     <entry type="Color" key="WorkingHoursColor">
       <label>Working hours color</label>
       <whatsthis>Select the working hours color for the agenda view here.</whatsthis>
-      <default>225, 225, 255</default>
+      <default>255, 235, 154</default>
     </entry>
     <entry type="Color" key="Todo due today Color" name="TodoDueTodayColor">
       <label>To-do due today color</label>
@@ -360,6 +391,17 @@
       <whatsthis>Select the default event color here. The default event color will be used for events categories in your agenda. Note that you can specify a separate color for each event category below.</whatsthis>
       <default>151, 235, 121</default>
     </entry>
+
+    <entry type="Bool" key="AssignDefaultResourceColors">
+      <default>true</default>
+    </entry>
+    <entry type="Int" key="DefaultResourceColorSeed">
+      <default>0</default>
+    </entry>
+    <entry type="StringList" key="DefaultResourceColors">
+        <default>#c1d4e7,#d0e7c1,#e3e7c1,#e7c1e6,#a1b1c1</default>
+    </entry>
+
   </group>
 
   <group name="Fonts">
@@ -415,6 +457,12 @@
       <default>false</default>
     </entry>
 
+    <entry type="Bool" name="FreeBusyCheckHostname">
+      <label>Check whether hostname and retrieval email address match</label>
+      <whatsthis>With this setting you can configure whether the domain part of the free/busy url has to match the domain part of the user id you are looking for. For example if this option is 'true' then looking for the free/busy data of joe@mydomain.com on the server www.yourdomain.com won't work.</whatsthis>
+      <default>true</default>
+    </entry>
+
     <entry type="Bool" name="FreeBusyFullDomainRetrieval">
       <label>Use full email address for retrieval</label>
       <whatsthis>With this setting, you can change the filename that will be fetched from the server. With this checked, it will download a free/busy file called user@domain.ifb, for example nn@kde.org.ifb. Without this set, it will download user.ifb, for example nn.ifb.</whatsthis>
@@ -436,4 +484,42 @@
     </entry>
 
   </group>
+
+  <group name="Kontact">
+    <entry type="Enum" name="DefaultEmailAttachMethod">
+      <label>Default email attachment method</label>
+      <whatsthis>The default way of attaching dropped emails to an event</whatsthis>
+      <choices>
+        <choice name="Ask">
+          <label>Always ask</label>
+        </choice>
+        <choice name="Link">
+          <label>Only attach link to message</label>
+        </choice>
+        <choice name="InlineFull">
+          <label>Attach complete message</label>
+        </choice>
+        <choice name="InlineBody">
+          <label>Attach message without attachments</label>
+        </choice>
+      </choices>
+      <default>Ask</default>
+    </entry>
+    <entry type="Enum" name="DefaultTodoAttachMethod">
+      <label>Default todo attachment method</label>
+      <whatsthis>The default way of attaching dropped emails to a task</whatsthis>
+      <choices>
+        <choice name="TodoAttachAsk">
+          <label>Always ask</label>
+        </choice>
+        <choice name="TodoAttachLink">
+          <label>Only attach link to message</label>
+        </choice>
+        <choice name="TodoAttachInlineFull">
+          <label>Attach complete message</label>
+        </choice>
+      </choices>
+      <default>TodoAttachInlineFull</default>
+    </entry>
+  </group>
 </kcfg>
Index: korganizer/kotodoeditor.h
===================================================================
--- korganizer/kotodoeditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kotodoeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -54,18 +54,18 @@
     void newTodo();
 
     /**
-      Sets the given summary and description. If description is empty and the 
-      summary contains multiple lines, the summary will be used as description 
+      Sets the given summary and description. If description is empty and the
+      summary contains multiple lines, the summary will be used as description
       and only the first line of summary will be used as the summary.
     */
     void setTexts( const QString &summary, const QString &description = QString::null );
     /** Edit an existing todo. */
-    void editIncidence(Incidence *);
+    void editIncidence(Incidence *incidence, Calendar* calendar);
 
     /** Set widgets to default values */
     void setDates( const QDateTime &due, bool allDay = true, Todo *relatedTodo = 0 );
     /** Read event object and setup widgets accordingly */
-    void readTodo(Todo *);
+    void readTodo(Todo *todo, Calendar *calendar);
     /** Write event settings to event object */
     void writeTodo(Todo *);
 
@@ -93,6 +93,7 @@
 
   private:
     Todo *mTodo;
+    Calendar *mCalendar;
 
     Todo *mRelatedTodo;
 
Index: korganizer/kohelper.h
===================================================================
--- korganizer/kohelper.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kohelper.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -43,6 +43,11 @@
     */
     static QColor resourceColor( KCal::Calendar*calendar, KCal::Incidence*incidence );
 
+    /**
+      Returns the resource label the given incidence belongs to.
+    */
+    static QString resourceLabel( KCal::Calendar *calendar, KCal::Incidence *incidence );
+
 };
 
 #endif
Index: korganizer/kojournaleditor.h
===================================================================
--- korganizer/kojournaleditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kojournaleditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -63,13 +63,13 @@
     void newJournal();
 
     /**
-      Sets the given summary and description. If description is empty and the 
-      summary contains multiple lines, the summary will be used as description 
+      Sets the given summary and description. If description is empty and the
+      summary contains multiple lines, the summary will be used as description
       and only the first line of summary will be used as the summary.
     */
     void setTexts( const QString &summary, const QString &description = QString::null );
     /** Edit an existing Journal. */
-    void editIncidence(Incidence *);
+    void editIncidence(Incidence *, Calendar *);
 
     /** Set widgets to default values */
     void setDate( const QDate &date );
Index: korganizer/koagendaitem.cpp
===================================================================
--- korganizer/koagendaitem.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koagendaitem.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -558,13 +558,13 @@
   if ( !( name.isEmpty() && email.isEmpty() ) ) {
     mIncidence->addAttendee(new Attendee(name,email));
     KMessageBox::information( this, i18n("Attendee \"%1\" added to the calendar item \"%2\"").arg(KPIM::normalizedAddress(name, email, QString())).arg(text()), i18n("Attendee added"), "AttendeeDroppedAdded" );
-  } 
- 
+  }
+
 }
 
 void KOAgendaItem::dropEvent( QDropEvent *e )
 {
-  // TODO: Organize this better: First check for attachment (not only file, also any other url!), then if it's a vcard, otherwise check for attendees, then if the data is binary, add a binary attachment. 
+  // TODO: Organize this better: First check for attachment (not only file, also any other url!), then if it's a vcard, otherwise check for attendees, then if the data is binary, add a binary attachment.
 #ifndef KORG_NODND
   QString text;
 
@@ -686,11 +686,23 @@
   conditionalPaint( p, b, x, ft, completedPxmp );
 }
 
+void KOAgendaItem::paintAlarmIcon( QPainter *p, int &x, int ft )
+{
+  if (!mIconAlarm) return;
+  int y = ft;
+  // if we can't fit it all, bottom align it, more or less, so
+  // it can be guessed better, visually
+  if ( visibleRect().height() - ft < alarmPxmp->height() )
+      y -= ( alarmPxmp->height() - visibleRect().height() - ft );
+  p->drawPixmap( x, y, *alarmPxmp );
+  x += alarmPxmp->width() + ft;
+}
+
 void KOAgendaItem::paintIcons( QPainter *p, int &x, int ft )
 {
   paintEventIcon( p, x, ft );
   paintTodoIcon( p, x, ft );
-  conditionalPaint( p, mIconAlarm,          x, ft, *alarmPxmp );
+  paintAlarmIcon( p, x, ft );
   conditionalPaint( p, mIconRecur,          x, ft, *recurPxmp );
   conditionalPaint( p, mIconReadonly,       x, ft, *readonlyPxmp );
   conditionalPaint( p, mIconReply,          x, ft, *replyPxmp );
@@ -699,7 +711,7 @@
   conditionalPaint( p, mIconOrganizer,      x, ft, *organizerPxmp );
 }
 
-void KOAgendaItem::paintEvent( QPaintEvent * )
+void KOAgendaItem::paintEvent( QPaintEvent *ev )
 {
   //HACK
   // to reproduce a crash:
@@ -709,6 +721,15 @@
   // the following check
   if ( !mIncidence )return;
 
+  QRect visRect = visibleRect();
+  // when scrolling horizontally in the side-by-side view, the repainted area is clipped
+  // to the newly visible area, which is a problem since the content changes when visRect
+  // changes, so repaint the full item in that case
+  if ( ev->rect() != visRect && visRect.isValid() && ev->rect().isValid() ) {
+    repaint( visRect );
+    return;
+  }
+
   QPainter p( this );
   const int ft = 2; // frame thickness for layout, see paintFrame()
   const int margin = 1 + ft; // frame + space between frame and content
@@ -737,26 +758,44 @@
       bgColor = KOPrefs::instance()->todoDueTodayColor();
   }
 
+  QColor categoryColor;
+  QStringList categories = mIncidence->categories();
+  QString cat = categories.first();
+  if (cat.isEmpty())
+    categoryColor = KOPrefs::instance()->mEventColor;
+  else
+    categoryColor = *(KOPrefs::instance()->categoryColor(cat));
+
+  QColor resourceColor = mResourceColor;
+  if ( !resourceColor.isValid() )
+    resourceColor = categoryColor;
+
+  if (!KOPrefs::instance()->hasCategoryColor(cat))
+      categoryColor = resourceColor;
+
+  QColor frameColor;
+  if ( KOPrefs::instance()->agendaViewColors() == KOPrefs::ResourceOnly ||
+       KOPrefs::instance()->agendaViewColors() == KOPrefs::CategoryInsideResourceOutside ) {
+    frameColor = bgColor.isValid() ? bgColor : resourceColor;
+  } else {
+    frameColor = bgColor.isValid() ? bgColor : categoryColor;
+  }
+
   if ( !bgColor.isValid() ) {
-    QStringList categories = mIncidence->categories();
-    QString cat = categories.first();
-    if (cat.isEmpty())
-      bgColor = KOPrefs::instance()->mEventColor;
-    else
-      bgColor = *(KOPrefs::instance()->categoryColor(cat));
+    if ( KOPrefs::instance()->agendaViewColors() == KOPrefs::ResourceOnly ||
+         KOPrefs::instance()->agendaViewColors() == KOPrefs::ResourceInsideCategoryOutside ) {
+      bgColor = resourceColor;
+    } else {
+      bgColor = categoryColor;
+    }
   }
-  QColor frameColor;
-  if ( KOPrefs::instance()->agendaViewUsesResourceColor()
-    && mResourceColor.isValid() ) {
-     frameColor = mSelected ? QColor( 85 + mResourceColor.red() * 2/3,
-                                      85 + mResourceColor.green() * 2/3,
-                                      85 + mResourceColor.blue() * 2/3 )
-                                : mResourceColor;
+
+  if ( mSelected ) {
+    frameColor = QColor( 85 + frameColor.red() * 2/3,
+                        85 + frameColor.green() * 2/3,
+                        85 + frameColor.blue() * 2/3 );
   } else {
-    frameColor = mSelected ? QColor( 85 + bgColor.red() * 2/3,
-                                     85 + bgColor.green() * 2/3,
-                                     85 + bgColor.blue() * 2/3 )
-                                : bgColor.dark(115);
+    frameColor = frameColor.dark( 115 );
   }
   QColor textColor = getTextColor(bgColor);
   p.setPen( textColor );
@@ -813,9 +852,6 @@
     return;
   }
 
-  // Used for multi-day events to make sure the summary is on screen
-  QRect visRect=visibleRect();
-
   // case 2: draw a single line when no more space
   if ( (2 * singleLineHeight) > (height() - 2 * margin) ) {
     int x = margin, txtWidth;
Index: korganizer/kodialogmanager.h
===================================================================
--- korganizer/kodialogmanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kodialogmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -40,7 +40,7 @@
 class SearchDialog;
 class ArchiveDialog;
 class FilterEditDialog;
-class KOAgendaView;
+namespace KOrg { class AgendaView; }
 
 using namespace KCal;
 
@@ -67,7 +67,7 @@
 
     void updateSearchDialog();
 
-    void connectTypeAhead( KOEventEditor *editor, KOAgendaView *agenda );
+    void connectTypeAhead( KOEventEditor *editor, KOrg::AgendaView *agenda );
 
     static void errorSaveIncidence( QWidget *parent, Incidence *incidence );
 
@@ -81,7 +81,7 @@
   private:
     class DialogManagerVisitor;
     class EditorDialogVisitor;
-    
+
     CalendarView *mMainView;
 
     KCMultiDialog *mOptionsDialog;
Index: korganizer/korganizerifaceimpl.h
===================================================================
--- korganizer/korganizerifaceimpl.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizerifaceimpl.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -61,6 +61,12 @@
   /** @reimp from KOrganizerIface::addIncidence() */
   bool addIncidence( const QString &iCal );
 
+  /** @reimp from KOrganizerIface::loadProfile() */
+  void loadProfile( const QString& path );
+
+  /** @reimp from KOrganizerIface::saveToProfile() */
+  void saveToProfile( const QString& path ) const;
+
 private:
   ActionManager* mActionManager;
 };
Index: korganizer/timelineitem.h
===================================================================
--- korganizer/timelineitem.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/timelineitem.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,81 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KORG_TIMELINEITEM_H
+#define KORG_TIMELINEITEM_H
+
+#define private protected
+#include <kdgantt/KDGanttViewTaskItem.h>
+#undef protected
+
+#include <qmap.h>
+#include <qvaluelist.h>
+
+class KDGanttView;
+class KDCanvasPolygon;
+
+namespace KCal {
+  class Calendar;
+  class ResourceCalendar;
+  class Incidence;
+}
+
+namespace KOrg {
+
+class TimelineSubItem;
+
+class TimelineItem : public KDGanttViewTaskItem
+{
+  public:
+    TimelineItem( const QString &label, KDGanttView* parent );
+
+    void insertIncidence( KCal::Incidence *incidence,
+                          const QDateTime &start = QDateTime(),
+                          const QDateTime &end = QDateTime() );
+    void removeIncidence( KCal::Incidence *incidence );
+
+    void moveItems( KCal::Incidence* incidence, int delta, int duration );
+
+  private:
+    QMap<KCal::Incidence*, QValueList<TimelineSubItem*> > mItemMap;
+};
+
+class TimelineSubItem : public KDGanttViewTaskItem
+{
+  public:
+    TimelineSubItem( KCal::Incidence *incidence, TimelineItem *parent );
+    ~TimelineSubItem();
+
+    KCal::Incidence* incidence() const { return mIncidence; }
+
+    QDateTime originalStart() const { return mStart; }
+    void setOriginalStart( const QDateTime &dt ) { mStart = dt; }
+
+  private:
+    void showItem( bool show = true, int coordY = 0 );
+
+  private:
+    KCal::Incidence *mIncidence;
+    QDateTime mStart;
+    KDCanvasPolygon *mLeft, *mRight;
+    int mMarkerWidth;
+};
+
+}
+
+#endif
Index: korganizer/version.h
===================================================================
--- korganizer/version.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/version.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,6 +53,6 @@
     3.2 alpha1
 */
 
-static const char korgVersion[] = "3.5.7";
+static const char korgVersion[] = "3.5.8";
 
 #endif
Index: korganizer/koeditordetails.h
===================================================================
--- korganizer/koeditordetails.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditordetails.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -26,7 +26,10 @@
 
 #include <klistview.h>
 #include "customlistviewitem.h"
+#include "koattendeeeditor.h"
 
+#include <libkcal/attendee.h>
+
 class QPushButton;
 class QCheckBox;
 class QLineEdit;
@@ -41,7 +44,7 @@
 class Incidence;
 }
 using namespace KCal;
-    
+
 namespace KPIM {
 class AddresseeLineEdit;
 }
@@ -72,7 +75,7 @@
 };
 
 
-class KOEditorDetails : public QWidget
+class KOEditorDetails : public KOAttendeeEditor
 {
     Q_OBJECT
   public:
@@ -86,56 +89,29 @@
     /** Write event settings to event object */
     void writeEvent(Incidence *);
 
-    /** return a clone of the event with attendees to be canceld*/
-    void cancelAttendeeEvent(Incidence *);
     /** Check if the input is valid. */
     bool validateInput();
 
-    /** Set the gantt view */
-    void setFreeBusyWidget( KOEditorFreeBusy * );
-
     /** Returns whether at least one attendee was added */
     bool hasAttendees();
 
-  public slots:
-    void insertAttendee(Attendee *);
+    void insertAttendee( Attendee*, bool goodEmailAddress = true );
 
   protected slots:
-    void addNewAttendee();
     void removeAttendee();
-    void openAddressBook();
-    void updateAttendeeInput();
-    void clearAttendeeInput();
-    void fillAttendeeInput(AttendeeListItem *);
-    void updateAttendeeItem();
-    void setEnableAttendeeInput(bool);
+    void slotInsertAttendee( Attendee *a );
 
   protected:
-    virtual bool eventFilter( QObject *, QEvent *);
-    void fillOrganizerCombo();
+    void changeStatusForMe( Attendee::PartStat status );
 
-    void insertAttendee( Attendee*, bool goodEmailAddress );
+    KCal::Attendee* currentAttendee() const;
+    void updateCurrentItem();
 
   private:
     bool mDisableItemUpdate;
 
-    KPIM::AddresseeLineEdit *mNameEdit;
-    QString mUid;
     KListView *mListView;
-    QComboBox* mRoleCombo;
-    QCheckBox* mRsvpButton;
-    QComboBox* mStatusCombo;
-    QHBox* mOrganizerHBox;
-    QComboBox *mOrganizerCombo; // either we organize it (combo shown)
-    QLabel *mOrganizerLabel; // or someone else does (just a label is shown)
-
-    QPushButton* mAddButton;
-    QPushButton* mRemoveButton;
-    QPushButton* mAddressBookButton;
-
-    QPtrList<Attendee> mdelAttendees;
-
-    KOEditorFreeBusy *mFreeBusy;
+//     KOEditorFreeBusy *mFreeBusy;
 };
 
 #endif
Index: korganizer/korganizerui.rc
===================================================================
--- korganizer/korganizerui.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizerui.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="korganizer" version="42">
+<kpartgui name="korganizer" version="44">
 
   <MenuBar>
     <Menu name="file"><text>&amp;File</text>
@@ -36,6 +36,7 @@
       <Action name="view_workweek"/>
       <Action name="view_week"/>
       <Action name="view_month"/>
+      <Action name="view_timeline"/>
       <Separator/>
       <Action name="view_list"/>
       <Action name="view_todo"/>
@@ -83,6 +84,7 @@
       <Action name="schedule_cancel"/>
       <Action name="schedule_refresh"/>
       <Action name="schedule_counter"/>
+      <Action name="schedule_forward"/>
       <Separator/>
       <Action name="mail_freebusy"/>
       <Action name="upload_freebusy"/>
@@ -135,6 +137,7 @@
     <Action name="view_week"/>
     <Action name="view_nextx"/>
     <Action name="view_month"/>
+    <Action name="view_timeline"/>
     <Action name="view_todo"/>
     <Action name="view_journal"/>
     <Merge/>
Index: korganizer/kotimelineview.cpp
===================================================================
--- korganizer/kotimelineview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/kotimelineview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,355 @@
+/*
+    This file is part of KOrganizer.
+
+    Copyright (c) 2007 Till Adam <adam@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+
+    As a special exception, permission is given to link this program
+    with any edition of Qt, and distribute the resulting executable,
+    without including the source code for Qt in the source distribution.
+*/
+
+
+#include <libkcal/calendar.h>
+#include <libkcal/calendarresources.h>
+
+#include <qlayout.h>
+
+#include <kdgantt/KDGanttViewTaskItem.h>
+#include <kdgantt/KDGanttViewSubwidgets.h>
+
+#include "koeventpopupmenu.h"
+#include "koglobals.h"
+#include "koprefs.h"
+#include "timelineitem.h"
+
+#include "kotimelineview.h"
+
+using namespace KOrg;
+using namespace KCal;
+
+KOTimelineView::KOTimelineView(Calendar *calendar, QWidget *parent,
+                                 const char *name)
+  : KOEventView(calendar, parent, name),
+  mEventPopup( 0 )
+{
+    QVBoxLayout* vbox = new QVBoxLayout(this);
+    mGantt = new KDGanttView(this);
+    mGantt->setCalendarMode( true );
+    mGantt->setShowLegendButton( false );
+    mGantt->setFixedHorizon( true );
+    mGantt->removeColumn( 0 );
+    mGantt->addColumn( i18n("Calendar") );
+    mGantt->setHeaderVisible( true );
+    if ( KGlobal::locale()->use12Clock() )
+      mGantt->setHourFormat( KDGanttView::Hour_12 );
+    else
+      mGantt->setHourFormat( KDGanttView::Hour_24_FourDigit );
+
+
+    vbox->addWidget( mGantt );
+
+    connect( mGantt, SIGNAL(gvCurrentChanged(KDGanttViewItem*)),
+             SLOT(itemSelected(KDGanttViewItem*)) );
+    connect( mGantt, SIGNAL(itemDoubleClicked(KDGanttViewItem*)),
+             SLOT(itemDoubleClicked(KDGanttViewItem*)) );
+    connect( mGantt, SIGNAL(itemRightClicked(KDGanttViewItem*)),
+             SLOT(itemRightClicked(KDGanttViewItem*)) );
+    connect( mGantt, SIGNAL(gvItemMoved(KDGanttViewItem*)),
+             SLOT(itemMoved(KDGanttViewItem*)) );
+    connect( mGantt, SIGNAL(rescaling(KDGanttView::Scale)),
+             SLOT(overscale(KDGanttView::Scale)) );
+    connect( mGantt, SIGNAL( dateTimeDoubleClicked( const QDateTime& ) ),
+             SLOT( newEventWithHint( const QDateTime& ) ) );
+}
+
+KOTimelineView::~KOTimelineView()
+{
+  delete mEventPopup;
+}
+
+/*virtual*/
+KCal::ListBase<KCal::Incidence> KOTimelineView::selectedIncidences()
+{
+    return KCal::ListBase<KCal::Incidence>();
+}
+
+/*virtual*/
+KCal::DateList KOTimelineView::selectedDates()
+{
+    return KCal::DateList();
+}
+
+/*virtual*/
+int KOTimelineView::currentDateCount()
+{
+    return 0;
+}
+
+/*virtual*/
+void KOTimelineView::showDates(const QDate& start, const QDate& end)
+{
+  mStartDate = start;
+  mEndDate = end;
+  mHintDate = QDateTime();
+  mGantt->setHorizonStart( QDateTime(start) );
+  mGantt->setHorizonEnd( QDateTime(end.addDays(1)) );
+  mGantt->setMinorScaleCount( 1 );
+  mGantt->setScale( KDGanttView::Hour );
+  mGantt->setMinimumScale( KDGanttView::Hour );
+  mGantt->setMaximumScale( KDGanttView::Hour );
+  mGantt->zoomToFit();
+
+  mGantt->setUpdateEnabled( false );
+  mGantt->clear();
+
+  // item for every calendar
+  TimelineItem *item = 0;
+  CalendarResources *calres = dynamic_cast<CalendarResources*>( calendar() );
+  if ( !calres ) {
+    item = new TimelineItem( i18n("Calendar"), mGantt );
+    mCalendarItemMap[0][QString()] = item;
+  } else {
+    CalendarResourceManager *manager = calres->resourceManager();
+    for ( CalendarResourceManager::ActiveIterator it = manager->activeBegin(); it != manager->activeEnd(); ++it ) {
+      QColor resourceColor = *KOPrefs::instance()->resourceColor( (*it)->identifier() );
+      if ( (*it)->canHaveSubresources() ) {
+        QStringList subResources = (*it)->subresources();
+        for ( QStringList::ConstIterator subit = subResources.constBegin(); subit != subResources.constEnd(); ++subit ) {
+          QString type = (*it)->subresourceType( *subit );
+          if ( !(*it)->subresourceActive( *subit ) || (!type.isEmpty() && type != "event") )
+            continue;
+          item = new TimelineItem( (*it)->labelForSubresource( *subit ), mGantt );
+          resourceColor = *KOPrefs::instance()->resourceColor( (*it)->identifier() );
+          QColor subrescol = *KOPrefs::instance()->resourceColor( *subit );
+          if ( subrescol.isValid() )
+            resourceColor = subrescol;
+          if ( resourceColor.isValid() )
+            item->setColors( resourceColor, resourceColor, resourceColor );
+          mCalendarItemMap[*it][*subit] = item;
+        }
+      } else {
+        item = new TimelineItem( (*it)->resourceName(), mGantt );
+        if ( resourceColor.isValid() )
+          item->setColors( resourceColor, resourceColor, resourceColor );
+        mCalendarItemMap[*it][QString()] = item;
+      }
+    }
+  }
+
+  // add incidences
+  Event::List events;
+  for ( QDate day = start; day <= end; day = day.addDays( 1 ) ) {
+    events = calendar()->events( day, EventSortStartDate, SortDirectionAscending );
+    for ( Event::List::ConstIterator it = events.constBegin(); it != events.constEnd(); ++it ) {
+      insertIncidence( *it, day );
+    }
+  }
+
+  mGantt->setUpdateEnabled( true );
+}
+
+/*virtual*/
+void KOTimelineView::showIncidences(const KCal::ListBase<KCal::Incidence>&)
+{
+}
+
+/*virtual*/
+void KOTimelineView::updateView()
+{
+  if ( mStartDate.isValid() && mEndDate.isValid() )
+    showDates( mStartDate, mEndDate );
+}
+
+/*virtual*/
+void KOTimelineView::changeIncidenceDisplay(KCal::Incidence* incidence, int mode)
+{
+  kdDebug() << k_funcinfo << incidence << " " << mode << endl;
+  switch ( mode ) {
+    case KOGlobals::INCIDENCEADDED:
+      insertIncidence( incidence );
+      break;
+    case KOGlobals::INCIDENCEEDITED:
+      removeIncidence( incidence );
+      insertIncidence( incidence );
+      break;
+    case KOGlobals::INCIDENCEDELETED:
+      removeIncidence( incidence );
+      break;
+    default:
+      updateView();
+  }
+}
+
+void KOTimelineView::itemSelected( KDGanttViewItem *item )
+{
+  TimelineSubItem *tlitem = dynamic_cast<TimelineSubItem*>( item );
+  if ( tlitem )
+    emit incidenceSelected( tlitem->incidence() );
+}
+
+void KOTimelineView::itemDoubleClicked( KDGanttViewItem *item )
+{
+  TimelineSubItem *tlitem = dynamic_cast<TimelineSubItem*>( item );
+  if ( tlitem )
+    emit editIncidenceSignal( tlitem->incidence() );
+}
+
+void KOTimelineView::itemRightClicked( KDGanttViewItem *item )
+{
+  mHintDate = mGantt->getDateTimeForCoordX( QCursor::pos().x(), true );
+  TimelineSubItem *tlitem = dynamic_cast<TimelineSubItem*>( item );
+  if ( !tlitem ) {
+    showNewEventPopup();
+    return;
+  }
+  if ( !mEventPopup )
+    mEventPopup = eventPopup();
+  mEventPopup->showIncidencePopup( tlitem->incidence(), QDate() );
+}
+
+bool KOTimelineView::eventDurationHint(QDateTime & startDt, QDateTime & endDt, bool & allDay)
+{
+  startDt = mHintDate;
+  endDt = mHintDate.addSecs( 2 * 60 * 60 );
+  allDay = false;
+  return mHintDate.isValid();
+}
+
+//slot
+void KOTimelineView::newEventWithHint( const QDateTime& dt )
+{
+  mHintDate = dt;
+  emit newEventSignal( dt );
+}
+
+TimelineItem * KOTimelineView::calendarItemForIncidence(KCal::Incidence * incidence)
+{
+  CalendarResources *calres = dynamic_cast<CalendarResources*>( calendar() );
+  TimelineItem *item = 0;
+  if ( !calres ) {
+    item = mCalendarItemMap[0][QString()];
+  } else {
+    ResourceCalendar *res = calres->resource( incidence );
+    if ( !res )
+      return 0;
+    if ( res->canHaveSubresources() ) {
+      QString subRes = res->subresourceIdentifier( incidence );
+      item = mCalendarItemMap[res][subRes];
+    } else {
+      item = mCalendarItemMap[res][QString()];
+    }
+  }
+  return item;
+}
+
+void KOTimelineView::insertIncidence(KCal::Incidence * incidence, const QDate &day )
+{
+  TimelineItem *item = calendarItemForIncidence( incidence );
+  if ( !item ) {
+    kdWarning() << k_funcinfo << "Help! Something is really wrong here!" << endl;
+    return;
+  }
+
+  if ( incidence->doesRecur() ) {
+    QValueList<QDateTime> l = incidence->startDateTimesForDate( day );
+    if ( l.isEmpty() ) {
+      // strange, but seems to happen for some recurring events...
+      item->insertIncidence( incidence, QDateTime( day, incidence->dtStart().time() ),
+                              QDateTime( day, incidence->dtEnd().time() ) );
+    } else {
+      for ( QValueList<QDateTime>::ConstIterator it = l.constBegin();
+            it != l.constEnd(); ++it ) {
+        item->insertIncidence( incidence, *it, incidence->endDateForStart( *it ) );
+      }
+    }
+  } else {
+    if ( incidence->dtStart().date() == day || incidence->dtStart().date() < mStartDate )
+      item->insertIncidence( incidence );
+  }
+}
+
+void KOTimelineView::insertIncidence(KCal::Incidence * incidence)
+{
+  KCal::Event *event = dynamic_cast<KCal::Event*>( incidence );
+  if ( !event )
+    return;
+  if ( incidence->doesRecur() )
+    insertIncidence( incidence, QDate() );
+  for ( QDate day = mStartDate; day <= mEndDate; day = day.addDays( 1 ) ) {
+    Event::List events = calendar()->events( day, EventSortStartDate, SortDirectionAscending );
+    for ( Event::List::ConstIterator it = events.constBegin(); it != events.constEnd(); ++it ) {
+      if ( events.contains( event ) )
+        insertIncidence( *it, day );
+    }
+  }
+}
+
+void KOTimelineView::removeIncidence(KCal::Incidence * incidence)
+{
+  TimelineItem *item = calendarItemForIncidence( incidence );
+  if ( item ) {
+    item->removeIncidence( incidence );
+  } else {
+    // try harder, the incidence might already be removed from the resource
+    typedef QMap<QString, KOrg::TimelineItem*> M2_t;
+    typedef QMap<KCal::ResourceCalendar*, M2_t> M1_t;
+    for ( M1_t::ConstIterator it1 = mCalendarItemMap.constBegin(); it1 != mCalendarItemMap.constEnd(); ++it1 ) {
+      for ( M2_t::ConstIterator it2 = it1.data().constBegin(); it2 != it1.data().constEnd(); ++it2 ) {
+        if ( it2.data() ) {
+          it2.data()->removeIncidence( incidence );
+        }
+      }
+    }
+  }
+}
+
+void KOTimelineView::itemMoved(KDGanttViewItem * item)
+{
+  TimelineSubItem *tlit = dynamic_cast<TimelineSubItem*>( item );
+  if ( !tlit )
+    return;
+  Incidence *i = tlit->incidence();
+  mChanger->beginChange( i );
+  QDateTime newStart = tlit->startTime();
+  if ( i->doesFloat() )
+    newStart = QDateTime( newStart.date() );
+  int delta = tlit->originalStart().secsTo( newStart );
+  i->setDtStart( i->dtStart().addSecs( delta ) );
+  int duration = tlit->startTime().secsTo( tlit->endTime() );
+  int allDayOffset = 0;
+  if ( i->doesFloat() ) {
+    duration /= (60*60*24);
+    duration *= (60*60*24);
+    allDayOffset = (60*60*24);
+    duration -= allDayOffset;
+    if ( duration < 0 ) duration = 0;
+  }
+  i->setDuration( duration );
+  TimelineItem *parent = static_cast<TimelineItem*>( tlit->parent() );
+  parent->moveItems( i, tlit->originalStart().secsTo( newStart ), duration + allDayOffset );
+  mChanger->endChange( i );
+}
+
+void KOTimelineView::overscale(KDGanttView::Scale scale)
+{
+  Q_UNUSED( scale );
+  mGantt->setZoomFactor( 1, false );
+  mGantt->setScale( KDGanttView::Hour );
+  mGantt->setMinorScaleCount( 12 );
+}
+
+#include "kotimelineview.moc"
Index: korganizer/journalentry.cpp
===================================================================
--- korganizer/journalentry.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/journalentry.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -280,9 +280,8 @@
 #ifndef KORG_NOPRINTER
   writeJournal();
   if ( mJournal ) {
-    Calendar *cal;
     KOCoreHelper helper;
-    CalPrinter printer( this, cal, &helper );
+    CalPrinter printer( this, 0, &helper );
     connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
 
     Incidence::List selectedIncidences;
Index: korganizer/korganizer_configfreebusy.desktop
===================================================================
--- korganizer/korganizer_configfreebusy.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configfreebusy.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,7 @@
 Name[cy]=Rhydd/Prysur
 Name[da]=Fri/Optaget
 Name[de]=Frei/Besch√§ftigt
+Name[eo]=Libera/Okupita
 Name[es]=Libre/Ocupado
 Name[et]=Vaba/h√µivatud
 Name[eu]=Libre/Lanpetuta
@@ -71,6 +72,7 @@
 Comment[da]=KOrganizer Fri/Optaget-indstilling
 Comment[de]=Frei/Besch√§ftigt-Festlegung f√ºr KOrganizer
 Comment[el]=Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ KOrganizer Free/Busy
+Comment[eo]=KOrganizilo Agordo pri libero/okupito
 Comment[es]=Configuraci√≥n de libre/ocupado de KOrganizer
 Comment[et]=KOrganizeri vaba/h√µivatuse seadistused
 Comment[eu]=KOrganizer-en Libre/Lanpetuta konfigurazioa
Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -73,7 +73,7 @@
 Name=KOrganizer
 Name[af]=Korganizer
 Name[cy]=KTrefnydd
-Name[eo]=Organizilo
+Name[eo]=KOrganizilo
 Name[hi]=‡§ï‡•á-‡§Ü‡§∞‡•ç‡§ó‡•á‡§®‡§æ‡§á‡§ú‡§º‡§∞
 Name[lv]=KOrganaizers
 Name[mk]=–ö–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä
@@ -97,6 +97,7 @@
 GenericName[de]=Pers√∂nliche Daten organisieren
 GenericName[el]=Œ†œÅŒøœÉœâœÄŒπŒ∫œåœÇ ŒøœÅŒ≥Œ±ŒΩœâœÑŒÆœÇ
 GenericName[en_GB]=Personal Organiser
+GenericName[eo]=Persona Organizilo
 GenericName[es]=Organizador personal
 GenericName[et]=Personaalne ajaarvestus
 GenericName[eu]=Antolatzaile pertsonala
Index: korganizer/koeditorrecurrence.h
===================================================================
--- korganizer/koeditorrecurrence.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorrecurrence.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -338,4 +338,15 @@
     QDateTime mEventStartDt;
 };
 
+class KOEditorRecurrenceDialog : public KDialogBase
+{
+  Q_OBJECT
+  public:
+    KOEditorRecurrenceDialog( QWidget *parent );
+    KOEditorRecurrence* editor() const { return mRecurrence; }
+
+  private:
+    KOEditorRecurrence *mRecurrence;
+};
+
 #endif
Index: korganizer/calendarview.cpp
===================================================================
--- korganizer/calendarview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/calendarview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -62,6 +62,8 @@
 #include "incidencechanger.h"
 #include "kholidays.h"
 #include "mailscheduler.h"
+#include "komailclient.h"
+#include "multiagendaview.h"
 
 #include <libkcal/vcaldrag.h>
 #include <libkcal/icaldrag.h>
@@ -596,6 +598,15 @@
   mNavigator->selectDate( date );
 }
 
+void CalendarView::showDate(const QDate & date)
+{
+  int dateCount = mNavigator->datesCount();
+  if ( dateCount == 7 )
+    mNavigator->selectWeek( date );
+  else
+    mNavigator->selectDates( date, dateCount );
+}
+
 void CalendarView::goToday()
 {
   mNavigator->selectToday();
@@ -648,6 +659,18 @@
     }
   }
   emit configChanged();
+
+  // force reload and handle agenda view type switch
+  const bool showMerged = KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::CalendarsMerged;
+  const bool showSideBySide = KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::CalendarsSideBySide;
+  KOrg::BaseView *view = mViewManager->currentView();
+  mViewManager->showAgendaView();
+  if ( view == mViewManager->agendaView() && showSideBySide )
+    view = mViewManager->multiAgendaView();
+  else if ( view == mViewManager->multiAgendaView() && showMerged )
+    view = mViewManager->agendaView();
+  mViewManager->showView( view );
+
   // To make the "fill window" configurations work
   mViewManager->raiseCurrentView();
 }
@@ -940,7 +963,7 @@
   eventEditor->newEvent();
   connectIncidenceEditor( eventEditor );
   eventEditor->setDates( startDt, endDt, allDay );
-  mDialogManager->connectTypeAhead( eventEditor, viewManager()->agendaView() );
+  mDialogManager->connectTypeAhead( eventEditor, dynamic_cast<KOrg::AgendaView*>(viewManager()->currentView()) );
   return eventEditor;
 }
 
@@ -972,28 +995,30 @@
 }
 
 void CalendarView::newEvent( const QString &summary, const QString &description,
-                             const QStringList &attachments, const QStringList &attendees )
+                             const QStringList &attachments, const QStringList &attendees,
+                             const QStringList &attachmentMimetypes, bool inlineAttachment )
 {
   KOEventEditor *eventEditor = newEventEditor();
   eventEditor->setTexts( summary, description );
   // if attach or attendee list is empty, these methods don't do anything, so
   // it's save to call them in every case
-  eventEditor->addAttachments( attachments );
+  eventEditor->addAttachments( attachments, attachmentMimetypes, inlineAttachment );
   eventEditor->addAttendees( attendees );
   eventEditor->show();
 }
 
 void CalendarView::newTodo( const QString &summary, const QString &description,
-                            const QStringList &attachments, const QStringList &attendees )
+                            const QStringList &attachments, const QStringList &attendees,
+                            const QStringList &attachmentMimetypes, bool inlineAttachment )
 {
   kdDebug(5850) << k_funcinfo << endl;
   KOTodoEditor *todoEditor = mDialogManager->getTodoEditor();
   connectIncidenceEditor( todoEditor );
   todoEditor->newTodo();
+  todoEditor->setDates( QDateTime(), false );
   todoEditor->setTexts( summary, description );
-  todoEditor->addAttachments( attachments );
+  todoEditor->addAttachments( attachments, attachmentMimetypes, inlineAttachment );
   todoEditor->addAttendees( attendees );
-  todoEditor->setDates( QDateTime(), false );
   todoEditor->show();
 }
 
@@ -1347,6 +1372,33 @@
   schedule(Scheduler::Declinecounter,incidence);
 }
 
+void CalendarView::schedule_forward(Incidence * incidence)
+{
+  if (incidence == 0)
+    incidence = selectedIncidence();
+
+  if (!incidence) {
+    KMessageBox::information( this, i18n("No item selected."),
+                              "ForwardNoEventSelected" );
+    return;
+  }
+
+  PublishDialog publishdlg;
+  if ( publishdlg.exec() == QDialog::Accepted ) {
+    QString recipients = publishdlg.addresses();
+    ICalFormat format;
+    QString messageText = format.createScheduleMessage( incidence, Scheduler::Request );
+    KOMailClient mailer;
+    if ( mailer.mailTo( incidence, recipients, messageText ) ) {
+
+      KMessageBox::information( this, i18n("The item information was successfully sent."),
+                                i18n("Forwarding"), "IncidenceForwardSuccess" );
+    } else {
+      KMessageBox::error( this, i18n("Unable to forward the item '%1'").arg( incidence->summary() ) );
+    }
+  }
+}
+
 void CalendarView::mailFreeBusy( int daysToPublish )
 {
   QDateTime start = QDateTime::currentDateTime();
@@ -1872,7 +1924,7 @@
   connectIncidenceEditor( incidenceEditor );
 
   mDialogList.insert( incidence, incidenceEditor );
-  incidenceEditor->editIncidence( incidence );
+  incidenceEditor->editIncidence( incidence, mCalendar );
   incidenceEditor->show();
   return true;
 }
Index: korganizer/koviewmanager.h
===================================================================
--- korganizer/koviewmanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koviewmanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -26,6 +26,8 @@
 #define KOVIEWMANAGER_H
 
 #include <qobject.h>
+class QWidget;
+class QTabWidget;
 
 class CalendarView;
 
@@ -35,8 +37,12 @@
 class KOTodoView;
 class KOWhatsNextView;
 class KOJournalView;
+class KOTimelineView;
 
-namespace KOrg { class BaseView; }
+namespace KOrg {
+  class BaseView;
+  class MultiAgendaView;
+}
 using namespace KCal;
 
 /**
@@ -77,6 +83,7 @@
     QDate currentSelectionDate();
 
     KOAgendaView *agendaView() const { return mAgendaView; }
+    KOrg::MultiAgendaView *multiAgendaView() const { return mAgendaSideBySideView; }
     KOTodoView   *todoView() const { return mTodoView; }
 
   public slots:
@@ -89,6 +96,7 @@
     void showNextXView();
     void showMonthView();
     void showTodoView();
+    void showTimelineView();
     void showJournalView();
 
     void showEventView();
@@ -99,22 +107,25 @@
     void zoomOutHorizontally();
     void zoomInVertically();
     void zoomOutVertically();
-
+  private slots:
+    void currentAgendaViewTabChanged( QWidget* );
   private:
+    QWidget* widgetForView( KOrg::BaseView* ) const;
     CalendarView *mMainView;
 
     KOAgendaView    *mAgendaView;
+    MultiAgendaView *mAgendaSideBySideView;
     KOListView      *mListView;
     KOMonthView     *mMonthView;
     KOTodoView      *mTodoView;
     KOWhatsNextView *mWhatsNextView;
     KOJournalView   *mJournalView;
+    KOTimelineView  *mTimelineView;
 
     KOrg::BaseView *mCurrentView;
 
     KOrg::BaseView *mLastEventView;
-
-    int mAgendaViewMode;
+    QTabWidget *mAgendaViewTabs;
 };
 
 #endif
Index: korganizer/koeditoralarms_base.ui
===================================================================
--- korganizer/koeditoralarms_base.ui	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditoralarms_base.ui	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -53,9 +53,6 @@
                                     <verstretch>0</verstretch>
                                 </sizepolicy>
                             </property>
-                            <property name="maxValue">
-                                <number>999999999</number>
-                            </property>
                         </widget>
                         <widget class="QComboBox">
                             <item>
Index: korganizer/dcopcalendar.desktop
===================================================================
--- korganizer/dcopcalendar.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/dcopcalendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -15,6 +15,7 @@
 Comment[de]=Organizer mit DCOP-Schnittstelle
 Comment[el]=Organizer ŒºŒµ œÄŒµœÅŒπŒ≤Œ¨ŒªŒªŒøŒΩ œáœÅŒÆœÉŒ∑œÇ DCOP
 Comment[en_GB]=Organiser with a DCOP interface
+Comment[eo]=Organizilo kun DCOP-interfaco
 Comment[es]=Organizador con un interfaz DCOP
 Comment[et]=KOrganizer DCOP-liidesega
 Comment[eu]=DCOP interfazedun antolatzailea
Index: korganizer/koeditorgeneraltodo.h
===================================================================
--- korganizer/koeditorgeneraltodo.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorgeneraltodo.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -54,7 +54,7 @@
     /** Set widgets to default values */
     void setDefaults( const QDateTime &due, bool allDay );
     /** Read todo object and setup widgets accordingly */
-    void readTodo(Todo *);
+    void readTodo(Todo *todo, Calendar *calendar);
     /** Write todo settings to event object */
     void writeTodo(Todo *);
 
@@ -96,7 +96,7 @@
     QLabel                  *mCompletedLabel;
     QLabel                  *mPriorityLabel;
     QComboBox               *mPriorityCombo;
-    
+
     KDateEdit               *mCompletionDateEdit;
     KTimeEdit               *mCompletionTimeEdit;
 
Index: korganizer/koprefs.cpp
===================================================================
--- korganizer/koprefs.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koprefs.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -163,11 +163,6 @@
       << i18n("Holiday") << i18n("Vacation") << i18n("Special Occasion")
       << i18n("Personal") << i18n("Travel") << i18n("Miscellaneous")
       << i18n("Birthday");
-
-  QStringList::Iterator it;
-  for (it = mCustomCategories.begin();it != mCustomCategories.end();++it ) {
-    setCategoryColor(*it,mDefaultCategoryColor);
-  }
 }
 
 
@@ -193,7 +188,9 @@
   QValueList<QColor>::Iterator it2;
   for (it = mCustomCategories.begin(), it2 = oldCategoryColors.begin();
        it != mCustomCategories.end(); ++it, ++it2 ) {
-    setCategoryColor(*it,config()->readColorEntry(*it, &*it2));
+      QColor c = config()->readColorEntry(*it, &*it2);
+      if ( c != mDefaultCategoryColor )
+          setCategoryColor(*it,c);
   }
 
   config()->setGroup( "Resources Colors" );
@@ -277,6 +274,12 @@
   else return &mDefaultCategoryColor;
 }
 
+
+bool KOPrefs::hasCategoryColor( const QString& cat ) const
+{
+    return mCategoryColors[ cat ];
+}
+
 void KOPrefs::setResourceColor ( const QString &cal, const QColor &color )
 {
   kdDebug(5850)<<"KOPrefs::setResourceColor: " << cal << " color: "<<
@@ -289,6 +292,23 @@
   QColor *color=0;
   if( !cal.isEmpty() ) color = mResourceColors[cal];
 
+  // assign default color if enabled
+  if ( !cal.isEmpty() && !color && assignDefaultResourceColors() ) {
+    QColor defColor( 0x37, 0x7A, 0xBC );
+    if ( defaultResourceColorSeed() > 0 && defaultResourceColorSeed() - 1 < (int)defaultResourceColors().size() ) {
+        defColor = QColor( defaultResourceColors()[defaultResourceColorSeed()-1] );
+    } else {
+        int h, s, v;
+        defColor.getHsv( h, s, v );
+        h = ( defaultResourceColorSeed() % 12 ) * 30;
+        s -= s * ( (defaultResourceColorSeed() / 12) % 2 ) * 0.5;
+        defColor.setHsv( h, s, v );
+    }
+    setDefaultResourceColorSeed( defaultResourceColorSeed() + 1 );
+    setResourceColor( cal, defColor );
+    color = mResourceColors[cal];
+  }
+
   if (color && color->isValid() )
     return color;
   else
Index: korganizer/korganizer_configcolors.desktop
===================================================================
--- korganizer/korganizer_configcolors.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configcolors.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -93,6 +93,7 @@
 Comment[de]=Farbenfestlegung f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œáœÅœâŒºŒ¨œÑœâŒΩ œÑŒøœÖ KOrganizer
 Comment[en_GB]=KOrganizer Colours Configuration
+Comment[eo]=KOrganizilo Kolor-agordo
 Comment[es]=Configuraci√≥n de los colores de KOrganizer
 Comment[et]=KOrganizeri v√§rvide seadistamine
 Comment[eu]=KOrganizer-en koloreen konfigurazioa
@@ -145,6 +146,7 @@
 Keywords[de]=KOrganizer,Farben
 Keywords[el]=korganizer,œáœÅœéŒºŒ±œÑŒ±
 Keywords[en_GB]=korganizer,colours
+Keywords[eo]=korganizilo, koloroj
 Keywords[es]=korganizer,colores
 Keywords[et]=korganizer,v√§rvid
 Keywords[eu]=korganizer,koloreak
Index: korganizer/kojournaleditor.cpp
===================================================================
--- korganizer/kojournaleditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kojournaleditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -94,7 +94,7 @@
   mGeneral->finishSetup();
 }
 
-void KOJournalEditor::editIncidence( Incidence *incidence )
+void KOJournalEditor::editIncidence( Incidence *incidence, Calendar * )
 {
   Journal *journal=dynamic_cast<Journal*>(incidence);
   if (journal)
Index: korganizer/koeditorattachments.cpp
===================================================================
--- korganizer/koeditorattachments.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeditorattachments.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -27,24 +27,44 @@
 
 #include <libkcal/incidence.h>
 #include <libkdepim/kpimurlrequesterdlg.h>
+#include <libkdepim/kfileio.h>
 
 #include <klocale.h>
 #include <kdebug.h>
+#include <kmdcodec.h>
 #include <kmessagebox.h>
-#include <klistview.h>
+#include <kiconview.h>
+#include <krun.h>
 #include <kurldrag.h>
+#include <ktempfile.h>
+#include <ktempdir.h>
+#include <kio/netaccess.h>
+#include <kmimetype.h>
+#include <kiconloader.h>
+#include <kfiledialog.h>
+#include <kstdaction.h>
+#include <kactioncollection.h>
+#include <kpopupmenu.h>
 
+#include <qfile.h>
+#include <qlabel.h>
 #include <qlayout.h>
 #include <qlistview.h>
 #include <qpushbutton.h>
 #include <qdragobject.h>
+#include <qtooltip.h>
 #include <qwhatsthis.h>
+#include <qapplication.h>
+#include <qclipboard.h>
 
-class AttachmentListItem : public KListViewItem
+#include <cassert>
+#include <set>
+
+class AttachmentListItem : public KIconViewItem
 {
   public:
-    AttachmentListItem( KCal::Attachment*att, QListView *parent ) :
-        KListViewItem( parent )
+    AttachmentListItem( KCal::Attachment*att, QIconView *parent ) :
+        KIconViewItem( parent )
     {
       if ( att ) {
         mAttachment = new KCal::Attachment( *att );
@@ -52,6 +72,7 @@
         mAttachment = new KCal::Attachment( QString::null );
       }
       readAttachment();
+      setDragEnabled( true );
     }
     ~AttachmentListItem() { delete mAttachment; }
     KCal::Attachment *attachment() const { return mAttachment; }
@@ -71,70 +92,161 @@
       mAttachment->setMimeType( mime );
       readAttachment();
     }
+    void setLabel( const QString &label )
+    {
+      mAttachment->setLabel( label );
+      readAttachment();
+    }
 
     void readAttachment()
     {
       if ( mAttachment->isUri() )
-        setText( 0, mAttachment->uri() );
-      else
-        setText( 0, i18n("[Binary data]") );
-      setText( 1, mAttachment->mimeType() );
+        setText( mAttachment->uri() );
+      else {
+        if ( mAttachment->label().isEmpty() )
+          setText( i18n("[Binary data]") );
+        else
+          setText( mAttachment->label() );
+      }
+      KMimeType::Ptr mt = KMimeType::mimeType( mAttachment->mimeType() );
+      if ( mt ) {
+          const QString iconName( mt->icon( QString(), false ) );
+          QPixmap pix = KGlobal::iconLoader( )->loadIcon( iconName, KIcon::Small );
+          if ( pix.isNull() )
+            pix = KGlobal::iconLoader( )->loadIcon( "unknown", KIcon::Small );
+            if ( !pix.isNull() )
+              setPixmap( pix );
+      }
     }
 
   private:
     KCal::Attachment *mAttachment;
 };
 
+class AttachmentIconView : public KIconView
+{
+    friend class KOEditorAttachments;
+    public:
+        AttachmentIconView( KOEditorAttachments* parent=0 )
+            :KIconView( parent ),
+             mParent( parent )
+        {
+            setAcceptDrops( true );
+            setSelectionMode( QIconView::Extended );
+            setMode( KIconView::Select );
+            setItemTextPos( QIconView::Right );
+            setArrangement( QIconView::LeftToRight );
+            setMaxItemWidth( QMAX(maxItemWidth(), 250) );
+            setMinimumHeight( QMAX(fontMetrics().height(), 16) + 12 );
+        }
+        ~AttachmentIconView()
+        {
+            for ( std::set<KTempDir*>::iterator it = mTempDirs.begin() ; it != mTempDirs.end() ; ++it ) {
+                delete *it;
+            }
+        }
+    protected:
+        QDragObject * dragObject()
+        {
+            KURL::List urls;
+            for ( QIconViewItem *it = firstItem( ); it; it = it->nextItem( ) ) {
+                if ( !it->isSelected() ) continue;
+                AttachmentListItem * item = dynamic_cast<AttachmentListItem*>( it );
+                if ( !item ) return 0;
+                KCal::Attachment * att = item->attachment();
+                assert( att );
+                KURL url;
+                if ( att->isUri() ) {
+                    url.setPath( att->uri() );
+                } else {
+                    KTempDir * tempDir = new KTempDir(); // will be deleted on editor close
+                    tempDir->setAutoDelete( true );
+                    mTempDirs.insert( tempDir );
+                    QByteArray encoded;
+                    encoded.duplicate( att->data(), strlen(att->data()) );
+                    QByteArray decoded;
+                    KCodecs::base64Decode( encoded, decoded );
+                    const QString fileName = tempDir->name( ) + "/" + att->label();
+                    KPIM::kByteArrayToFile( decoded, fileName, false, false, false );
+                    url.setPath( fileName );
+                }
+                urls << url;
+            }
+            KURLDrag *drag  = new KURLDrag( urls, this );
+            return drag;
+        }
+        void contentsDropEvent( QDropEvent* event )
+        {
+          mParent->handlePasteOrDrop( event );
+        }
+    private:
+        std::set<KTempDir*> mTempDirs;
+        KOEditorAttachments* mParent;
+};
+
 KOEditorAttachments::KOEditorAttachments( int spacing, QWidget *parent,
                                           const char *name )
   : QWidget( parent, name )
 {
-  QBoxLayout *topLayout = new QVBoxLayout( this );
+  QBoxLayout *topLayout = new QHBoxLayout( this );
   topLayout->setSpacing( spacing );
 
-  mAttachments = new KListView( this );
+  QLabel *label = new QLabel( i18n("Attachments:"), this );
+  topLayout->addWidget( label );
+
+  mAttachments = new AttachmentIconView( this );
   QWhatsThis::add( mAttachments,
                    i18n("Displays a list of current items (files, mail, etc.) "
-                        "that have been associated with this event or to-do. "
-                        "The URI column displays the location of the file.") );
-  mAttachments->addColumn( i18n("URI") );
-  mAttachments->addColumn( i18n("MIME Type") );
+                        "that have been associated with this event or to-do. ") );
   topLayout->addWidget( mAttachments );
-  connect( mAttachments, SIGNAL( doubleClicked( QListViewItem * ) ),
-           SLOT( showAttachment( QListViewItem * ) ) );
+  connect( mAttachments, SIGNAL( doubleClicked( QIconViewItem * ) ),
+           SLOT( showAttachment( QIconViewItem * ) ) );
+  connect( mAttachments, SIGNAL(selectionChanged()),
+           SLOT(selectionChanged()) );
+  connect( mAttachments, SIGNAL(contextMenuRequested(QIconViewItem*,const QPoint&)),
+           SLOT(contextMenu(QIconViewItem*,const QPoint&)) );
 
-  QBoxLayout *buttonLayout = new QHBoxLayout( topLayout );
+  mAddMenu = new KPopupMenu( this );
+  mContextMenu = new KPopupMenu( this );
 
-  QPushButton *button = new QPushButton( i18n("&Add..."), this );
-  QWhatsThis::add( button,
-                   i18n("Shows a dialog used to select an attachment "
-                        "to add to this event or to-do.") );
-  buttonLayout->addWidget( button );
-  connect( button, SIGNAL( clicked() ), SLOT( slotAdd() ) );
+  KActionCollection* ac = new KActionCollection( this, this );
 
-  button = new QPushButton( i18n("&Edit..."), this );
-  QWhatsThis::add( button,
-                   i18n("Shows a dialog used to edit the attachment "
-                        "currently selected in the list above.") );
-  buttonLayout->addWidget( button );
-  connect( button, SIGNAL( clicked() ), SLOT( slotEdit() ) );
+  mOpenAction = new KAction( i18n("View"), 0, this, SLOT(slotShow()), ac );
+  mOpenAction->plug( mContextMenu );
+  mContextMenu->insertSeparator();
 
-  button = new QPushButton( i18n("&Remove"), this );
-  QWhatsThis::add( button,
+  mCopyAction = KStdAction::copy(this, SLOT(slotCopy( ) ), ac );
+  mCopyAction->plug( mContextMenu );
+  mCutAction = KStdAction::cut(this, SLOT(slotCut( ) ), ac );
+  mCutAction->plug( mContextMenu );
+  KAction *action = KStdAction::paste(this, SLOT(slotPaste( ) ), ac );
+  action->plug( mContextMenu );
+
+  action = new KAction( i18n("&Attach File..."), 0, this, SLOT(slotAddData()), ac );
+  action->setWhatsThis( i18n("Shows a dialog used to select an attachment "
+                        "to add to this event or to-do as link as inline data.") );
+  action->plug( mAddMenu );
+  action = new KAction( i18n("Attach &Link..."), 0, this, SLOT(slotAdd()), ac );
+  action->setWhatsThis( i18n("Shows a dialog used to select an attachment "
+                        "to add to this event or to-do as link.") );
+  action->plug( mAddMenu );
+
+  QPushButton *addButton = new QPushButton( this );
+  addButton->setIconSet( SmallIconSet( "add" ) );
+  addButton->setPopup( mAddMenu );
+  topLayout->addWidget( addButton );
+
+  mRemoveBtn = new QPushButton( this );
+  mRemoveBtn->setIconSet( SmallIconSet( "remove" ) );
+  QToolTip::add( mRemoveBtn, i18n("&Remove") );
+  QWhatsThis::add( mRemoveBtn,
                    i18n("Removes the attachment selected in the list above "
                         "from this event or to-do.") );
-  buttonLayout->addWidget( button );
-  connect( button, SIGNAL( clicked() ), SLOT( slotRemove() ) );
+  topLayout->addWidget( mRemoveBtn );
+  connect( mRemoveBtn, SIGNAL( clicked() ), SLOT( slotRemove() ) );
 
-  button = new QPushButton( i18n("&Show"), this );
-  QWhatsThis::add( button,
-                   i18n("Opens the attachment selected in the list above "
-                        "in the viewer that is associated with it in your "
-                        "KDE preferences.") );
-  buttonLayout->addWidget( button );
-  connect( button, SIGNAL( clicked() ), SLOT( slotShow() ) );
-
-  setAcceptDrops( TRUE );
+  selectionChanged();
+  setAcceptDrops( true );
 }
 
 KOEditorAttachments::~KOEditorAttachments()
@@ -143,30 +255,39 @@
 
 bool KOEditorAttachments::hasAttachments()
 {
-  return mAttachments->childCount() > 0;
+  return mAttachments->count() != 0;
 }
 
-void KOEditorAttachments::dragEnterEvent( QDragEnterEvent* event ) {
+void KOEditorAttachments::dragEnterEvent( QDragEnterEvent* event )
+{
   event->accept( KURLDrag::canDecode( event ) | QTextDrag::canDecode( event ) );
 }
 
-void KOEditorAttachments::dropEvent( QDropEvent* event ) {
+void KOEditorAttachments::handlePasteOrDrop( QMimeSource* source )
+{
   KURL::List urls;
   QString text;
-  if ( KURLDrag::decode( event, urls ) ) {
+  if ( KURLDrag::decode( source, urls ) ) {
+    const bool asUri = KMessageBox::questionYesNo( this,
+            i18n("Do you want to link to the attachments, or include them in the event?"),
+            i18n("Attach as link?"), i18n("As Link"), i18n("As File") ) == KMessageBox::Yes;
     for ( KURL::List::ConstIterator it = urls.begin(); it != urls.end(); ++it ) {
-      addAttachment( (*it).url() );
+      addAttachment( (*it).url(), QString::null, asUri );
     }
-  } else if ( QTextDrag::decode( event, text ) ) {
+  } else if ( QTextDrag::decode( source, text ) ) {
     QStringList lst = QStringList::split( '\n', text );
     for ( QStringList::ConstIterator it = lst.begin(); it != lst.end(); ++it ) {
       addAttachment( (*it)  );
     }
   }
+}
 
+void KOEditorAttachments::dropEvent( QDropEvent* event )
+{
+    handlePasteOrDrop( event );
 }
 
-void KOEditorAttachments::showAttachment( QListViewItem *item )
+void KOEditorAttachments::showAttachment( QIconViewItem *item )
 {
   AttachmentListItem *attitem = static_cast<AttachmentListItem*>(item);
   if ( !attitem || !attitem->attachment() ) return;
@@ -175,27 +296,41 @@
   if ( att->isUri() ) {
     emit openURL( att->uri() );
   } else {
-    // FIXME: Handle binary attachments
+    KTempFile f;
+    if ( !f.file() )
+      return;
+    QByteArray encoded;
+    encoded.duplicate( att->data(), strlen(att->data()) );
+    QByteArray decoded;
+    KCodecs::base64Decode( encoded, decoded );
+    f.file()->writeBlock( decoded );
+    f.file()->close();
+    KRun::runURL( f.name(), att->mimeType(), true, false );
   }
 }
 
-
-
 void KOEditorAttachments::slotAdd()
 {
   KURL uri = KPimURLRequesterDlg::getURL( QString::null, i18n(
          "URL (e.g. a web page) or file to be attached (only "
          "the link will be attached, not the file itself):"), this,
                                        i18n("Add Attachment") );
-  // TODO: Implement adding binary attachments
   if ( !uri.isEmpty() ) {
-    addAttachment( uri.url() );
+    addAttachment( uri );
   }
 }
 
+void KOEditorAttachments::slotAddData()
+{
+  KURL uri = KFileDialog::getOpenFileName( QString(), QString(), this, i18n("Add Attachment") );
+  if ( !uri.isEmpty() ) {
+    addAttachment( uri, QString::null, false );
+  }
+}
+
 void KOEditorAttachments::slotEdit()
 {
-  QListViewItem *item = mAttachments->currentItem();
+  QIconViewItem *item = mAttachments->currentItem();
   AttachmentListItem *attitem = static_cast<AttachmentListItem*>(item);
   if ( !attitem || !attitem->attachment() ) return;
 
@@ -209,24 +344,53 @@
     if ( !uri.isEmpty() )
       attitem->setUri( uri.url() );
   } else {
-    // FIXME: Handle binary attachments
+    KURL uri = KPimURLRequesterDlg::getURL( QString::null, i18n(
+         "File to be attached:"), this, i18n("Add Attachment") );
+    if ( !uri.isEmpty() ) {
+          QString tmpFile;
+      if ( KIO::NetAccess::download( uri, tmpFile, this ) ) {
+        QFile f( tmpFile );
+        if ( !f.open( IO_ReadOnly ) )
+          return;
+        QByteArray data = f.readAll();
+        f.close();
+        attitem->setData( KCodecs::base64Encode( data ) );
+        attitem->setMimeType( KIO::NetAccess::mimetype( uri, this ) );
+        QString label = uri.fileName();
+        if ( label.isEmpty() )
+          label = uri.prettyURL();
+        attitem->setLabel( label );
+        KIO::NetAccess::removeTempFile( tmpFile );
+      }
+    }
   }
 }
 
 void KOEditorAttachments::slotRemove()
 {
-  QListViewItem *item = mAttachments->currentItem();
-  if ( !item ) return;
+    QValueList<QIconViewItem*> selected;
+    for ( QIconViewItem *it = mAttachments->firstItem( ); it; it = it->nextItem( ) ) {
+        if ( !it->isSelected() ) continue;
+        selected << it;
+    }
+    if ( selected.isEmpty() || KMessageBox::warningContinueCancel(this,
+                    selected.count() == 1?i18n("This item will be permanently deleted."):
+                    i18n("The selected items will be permanently deleted."),
+                    i18n("KOrganizer Confirmation"),KStdGuiItem::del()) != KMessageBox::Continue )
+        return;
 
-  if ( KMessageBox::warningContinueCancel(this,
-        i18n("This item will be permanently deleted."),
-  i18n("KOrganizer Confirmation"),KStdGuiItem::del()) == KMessageBox::Continue )
-    delete item;
+    for ( QValueList<QIconViewItem*>::iterator it( selected.begin() ), end( selected.end() ); it != end ; ++it ) {
+        delete *it;
+    }
 }
 
 void KOEditorAttachments::slotShow()
 {
-  showAttachment( mAttachments->currentItem() );
+  for ( QIconViewItem *it = mAttachments->firstItem(); it; it = it->nextItem() ) {
+    if ( !it->isSelected() )
+      continue;
+    showAttachment( it );
+  }
 }
 
 void KOEditorAttachments::setDefaults()
@@ -234,12 +398,33 @@
   mAttachments->clear();
 }
 
-void KOEditorAttachments::addAttachment( const QString &uri,
-                                         const QString &mimeType )
+void KOEditorAttachments::addAttachment( const KURL &uri,
+                                         const QString &mimeType, bool asUri )
 {
   AttachmentListItem *item = new AttachmentListItem( 0, mAttachments );
-  item->setUri( uri );
-  if ( !mimeType.isEmpty() ) item->setMimeType( mimeType );
+  if ( asUri ) {
+    item->setUri( uri.url() );
+    if ( !mimeType.isEmpty() ) item->setMimeType( mimeType );
+  } else {
+    QString tmpFile;
+    if ( KIO::NetAccess::download( uri, tmpFile, this ) ) {
+      QFile f( tmpFile );
+      if ( !f.open( IO_ReadOnly ) )
+        return;
+      QByteArray data = f.readAll();
+      f.close();
+      item->setData( KCodecs::base64Encode( data ) );
+      if ( !mimeType.isEmpty() )
+        item->setMimeType( mimeType );
+      else
+        item->setMimeType( KIO::NetAccess::mimetype( uri, this ) );
+      QString label = uri.fileName();
+      if ( label.isEmpty() )
+        label = uri.prettyURL();
+      item->setLabel( label );
+      KIO::NetAccess::removeTempFile( tmpFile );
+    }
+  }
 }
 
 
@@ -257,19 +442,60 @@
   for( it = attachments.begin(); it != attachments.end(); ++it ) {
     addAttachment( (*it) );
   }
+  if ( mAttachments->count() > 0 ) {
+    QTimer::singleShot( 0, mAttachments, SLOT(arrangeItemsInGrid()) );
+  }
 }
 
 void KOEditorAttachments::writeIncidence( KCal::Incidence *i )
 {
   i->clearAttachments();
 
-  QListViewItem *item;
+  QIconViewItem *item;
   AttachmentListItem *attitem;
-  for( item = mAttachments->firstChild(); item; item = item->nextSibling() ) {
+  for( item = mAttachments->firstItem(); item; item = item->nextItem() ) {
     attitem = static_cast<AttachmentListItem*>(item);
     if ( attitem )
       i->addAttachment( new KCal::Attachment( *(attitem->attachment() ) ) );
   }
 }
 
+
+void KOEditorAttachments::slotCopy()
+{
+    QApplication::clipboard()->setData( mAttachments->dragObject(), QClipboard::Clipboard );
+}
+
+void KOEditorAttachments::slotCut()
+{
+    slotCopy();
+    slotRemove();
+}
+
+void KOEditorAttachments::slotPaste()
+{
+    handlePasteOrDrop( QApplication::clipboard()->data() );
+}
+
+void KOEditorAttachments::selectionChanged()
+{
+  bool selected = false;
+  for ( QIconViewItem *item = mAttachments->firstItem(); item; item = item->nextItem() ) {
+    if ( item->isSelected() ) {
+      selected = true;
+      break;
+    }
+  }
+  mRemoveBtn->setEnabled( selected );
+}
+
+void KOEditorAttachments::contextMenu(QIconViewItem * item, const QPoint & pos)
+{
+  const bool enable = item != 0;
+  mOpenAction->setEnabled( enable );
+  mCopyAction->setEnabled( enable );
+  mCutAction->setEnabled( enable );
+  mContextMenu->exec( pos );
+}
+
 #include "koeditorattachments.moc"
Index: korganizer/koincidenceeditor.cpp
===================================================================
--- korganizer/koincidenceeditor.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koincidenceeditor.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -49,7 +49,6 @@
 #include "koprefs.h"
 #include "koglobals.h"
 #include "koeditordetails.h"
-#include "koeditorattachments.h"
 #include "koeditoralarms.h"
 #include "urihandler.h"
 #include "koincidenceeditor.h"
@@ -59,7 +58,7 @@
                                       Calendar *calendar, QWidget *parent )
   : KDialogBase( Tabbed, caption, Ok | Apply | Cancel | Default, Ok,
                  parent, 0, false, false ),
-    mDetails( 0 ), mAttachments( 0 )
+    mAttendeeEditor( 0 ), mIsCounter( false )
 {
   // Set this to be the group leader for all subdialogs - this means
   // modal subdialogs will only affect this dialog, not the other windows
@@ -91,26 +90,10 @@
 
   QBoxLayout *topLayout = new QVBoxLayout( topFrame );
 
-  mDetails = new KOEditorDetails( spacingHint(), topFrame );
+  mAttendeeEditor = mDetails = new KOEditorDetails( spacingHint(), topFrame );
   topLayout->addWidget( mDetails );
 }
 
-void KOIncidenceEditor::setupAttachmentsTab()
-{
-  QFrame *topFrame = addPage( i18n("Attach&ments") );
-  QWhatsThis::add( topFrame,
-                   i18n("The Attachments tab allows you to add or remove "
-                        "files, emails, contacts, and other items "
-                        "associated with this event or to-do.") );
-
-  QBoxLayout *topLayout = new QVBoxLayout( topFrame );
-
-  mAttachments = new KOEditorAttachments( spacingHint(), topFrame );
-  connect( mAttachments, SIGNAL( openURL( const KURL & ) ) ,
-           this, SLOT( openURL( const KURL & ) ) );
-  topLayout->addWidget( mAttachments );
-}
-
 void KOIncidenceEditor::slotApply()
 {
   processInput();
@@ -118,17 +101,13 @@
 
 void KOIncidenceEditor::slotOk()
 {
-  // "this" can be deleted before processInput() returns (processInput() opens 
+  // "this" can be deleted before processInput() returns (processInput() opens
   // a non-modal dialog when Kolab is used). So accept should only be executed
   // when "this" is still valid
   QGuardedPtr<QWidget> ptr( this );
   if ( processInput() && ptr ) accept();
 }
 
-void KOIncidenceEditor::updateCategoryConfig()
-{
-}
-
 void KOIncidenceEditor::slotCancel()
 {
   processCancel();
@@ -144,7 +123,7 @@
   if ( KOPrefs::instance()->thatIsMe( incidence->organizer().email() ) ) {
     Incidence *ev = incidence->clone();
     ev->registerObserver( 0 );
-    mDetails->cancelAttendeeEvent( ev );
+    mAttendeeEditor->cancelAttendeeEvent( ev );
     if ( ev->attendeeCount() > 0 ) {
       emit deleteAttendee( ev );
     }
@@ -373,12 +352,11 @@
   UriHandler::process( uri );
 }
 
-void KOIncidenceEditor::addAttachments( const QStringList &attachments )
+void KOIncidenceEditor::addAttachments( const QStringList &attachments,
+                                        const QStringList &mimeTypes,
+                                        bool inlineAttachments )
 {
-  QStringList::ConstIterator it;
-  for ( it = attachments.begin(); it != attachments.end(); ++it ) {
-    mAttachments->addAttachment( *it );
-  }
+    emit signalAddAttachments( attachments, mimeTypes, inlineAttachments );
 }
 
 void KOIncidenceEditor::addAttendees( const QStringList &attendees )
@@ -387,10 +365,19 @@
   for ( it = attendees.begin(); it != attendees.end(); ++it ) {
     QString name, email;
     KABC::Addressee::parseEmailAddress( *it, name, email );
-    mDetails->insertAttendee( new Attendee( name, email ) );
+    mAttendeeEditor->insertAttendee( new Attendee( name, email ) );
   }
 }
 
+void KOIncidenceEditor::selectInvitationCounterProposal(bool enable)
+{
+  mIsCounter = enable;
+  if ( mIsCounter ) {
+    setCaption( i18n( "Counter proposal" ) );
+    setButtonOK( i18n( "Counter proposal" ) );
+    enableButtonApply( false );
+  }
+}
 
 
 #include "koincidenceeditor.moc"
Index: korganizer/resourceview.cpp
===================================================================
--- korganizer/resourceview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/resourceview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -32,17 +32,20 @@
 #include <kdebug.h>
 #include <kglobal.h>
 #include <kmessagebox.h>
+#include <kinputdialog.h>
+#include <kiconloader.h>
 #include <kresources/resource.h>
 #include <kresources/configdialog.h>
-#include <kinputdialog.h>
 #include <libkcal/calendarresources.h>
 
 #include <qhbox.h>
+#include <qheader.h>
 #include <qlayout.h>
 #include <qlabel.h>
 #include <qpainter.h>
 #include <qpushbutton.h>
 #include <qpopupmenu.h>
+#include <qtooltip.h>
 #include <qwhatsthis.h>
 
 #include "koprefs.h"
@@ -113,6 +116,7 @@
                                              mView, this );
       QColor resourceColor = *KOPrefs::instance()->resourceColor( *it );
       item->setResourceColor( resourceColor );
+      item->update();
     }
   }
   mSubItemsCreated = true;
@@ -216,29 +220,18 @@
 {
   QBoxLayout *topLayout = new QVBoxLayout( this, 0, KDialog::spacingHint() );
 
-  mListView = new KListView( this );
-  QWhatsThis::add( mListView,
-                   i18n( "<qt><p>Select on this list the active KOrganizer "
-                         "resources. Check the resource box to make it "
-                         "active. Press the \"Add...\" button below to add new "
-                         "resources to the list.</p>"
-                         "<p>Events, journal entries and to-dos are retrieved "
-                         "and stored on resources. Available "
-                         "resources include groupware servers, local files, "
-                         "journal entries as blogs on a server, etc...</p>"
-                         "<p>If you have more than one active resource, "
-                         "when creating incidents you will either automatically "
-                         "use the default resource or be prompted "
-                         "to select the resource to use.</p></qt>" ) );
-  mListView->addColumn( i18n("Calendar") );
-  mListView->setResizeMode( QListView::LastColumn );
-  topLayout->addWidget( mListView );
-
-  QHBox *buttonBox = new QHBox( this );
+  QHBoxLayout *buttonBox = new QHBoxLayout();
   buttonBox->setSpacing( KDialog::spacingHint() );
-  topLayout->addWidget( buttonBox );
+  topLayout->addLayout( buttonBox );
 
-  mAddButton = new QPushButton( i18n("Add..."), buttonBox, "add" );
+  QLabel *calLabel = new QLabel( i18n( "Calendar" ), this );
+  buttonBox->addWidget( calLabel );
+  buttonBox->addStretch( 1 );
+
+  mAddButton = new QPushButton( this, "add" );
+  mAddButton->setIconSet( SmallIconSet( "add" ) );
+  buttonBox->addWidget( mAddButton );
+  QToolTip::add( mAddButton, i18n( "Add calendar" ) );
   QWhatsThis::add( mAddButton,
                    i18n( "<qt><p>Press this button to add a resource to "
                          "KOrganizer.</p>"
@@ -250,17 +243,42 @@
                          "when creating incidents you will either automatically "
                          "use the default resource or be prompted "
                          "to select the resource to use.</p></qt>" ) );
-  mEditButton = new QPushButton( i18n("Edit..."), buttonBox, "edit" );
+  mEditButton = new QPushButton( this, "edit" );
+  mEditButton->setIconSet( SmallIconSet( "edit" ) );
+  buttonBox->addWidget( mEditButton );
+  QToolTip::add( mEditButton, i18n( "Edit calendar settings" ) );
   QWhatsThis::add( mEditButton,
                    i18n( "Press this button to edit the resource currently "
                          "selected on the KOrganizer resources list above." ) );
-  mDeleteButton = new QPushButton( i18n("Remove"), buttonBox, "del" );
+  mDeleteButton = new QPushButton( this, "del" );
+  mDeleteButton->setIconSet( SmallIconSet( "remove" ) );
+  buttonBox->addWidget( mDeleteButton );
+  QToolTip::add( mDeleteButton, i18n( "Remove calendar" ) );
   QWhatsThis::add( mDeleteButton,
                    i18n( "Press this button to delete the resource currently "
                          "selected on the KOrganizer resources list above." ) );
   mDeleteButton->setDisabled( true );
   mEditButton->setDisabled( true );
 
+  mListView = new KListView( this );
+  mListView->header()->hide();
+  QWhatsThis::add( mListView,
+                   i18n( "<qt><p>Select on this list the active KOrganizer "
+                         "resources. Check the resource box to make it "
+                         "active. Press the \"Add...\" button below to add new "
+                         "resources to the list.</p>"
+                         "<p>Events, journal entries and to-dos are retrieved "
+                         "and stored on resources. Available "
+                         "resources include groupware servers, local files, "
+                         "journal entries as blogs on a server, etc...</p>"
+                         "<p>If you have more than one active resource, "
+                         "when creating incidents you will either automatically "
+                         "use the default resource or be prompted "
+                         "to select the resource to use.</p></qt>" ) );
+  mListView->addColumn( i18n("Calendar") );
+  mListView->setResizeMode( QListView::LastColumn );
+  topLayout->addWidget( mListView );
+
   connect( mListView, SIGNAL( clicked( QListViewItem * ) ),
            SLOT( currentChanged( QListViewItem * ) ) );
   connect( mAddButton, SIGNAL( clicked() ), SLOT( addResource() ) );
@@ -301,11 +319,25 @@
 
 void ResourceView::addResource()
 {
+  bool ok = false;
   KCal::CalendarResourceManager *manager = mCalendar->resourceManager();
+  ResourceItem *i = static_cast<ResourceItem*>( mListView->selectedItem() );
+  if ( i && ( i->isSubresource() || i->resource()->canHaveSubresources() ) ) {
+    const QString folderName = KInputDialog::getText( i18n( "Add Subresource" ),
+            i18n( "Please enter a name for the new subresource" ), QString::null,
+            &ok, this );
+    if ( !ok )
+      return;
+    const QString parentId = i->isSubresource() ? i->resourceIdentifier() : QString:: null;
+    if ( !i->resource()->addSubresource( folderName, parentId ) ) {
+      KMessageBox::error( this, i18n("<qt>Unable to create subresource <b>%1</b>.</qt>")
+                                .arg( folderName ) );
+    }
+    return;
+  }
 
   QStringList types = manager->resourceTypeNames();
   QStringList descs = manager->resourceTypeDescriptions();
-  bool ok = false;
   QString desc = KInputDialog::getItem( i18n( "Resource Configuration" ),
       i18n( "Please select type of the new resource:" ), descs, 0, false, &ok,
             this );
@@ -329,6 +361,10 @@
 
   if ( dlg && dlg->exec() ) {
     resource->setTimeZoneId( KOPrefs::instance()->mTimeZoneId );
+    if ( resource->isActive() ) {
+      resource->open();
+      resource->load();
+    }
     manager->add( resource );
     // we have to call resourceAdded manually, because for in-process changes
     // the dcop signals are not connected, so the resource's signals would not
@@ -351,6 +387,7 @@
 
   resourceColor= *KOPrefs::instance()->resourceColor(resource->identifier());
   item->setResourceColor(resourceColor);
+  item->update();
 
   connect( resource, SIGNAL( signalSubresourceAdded( ResourceCalendar *,
                                                      const QString &,
@@ -359,7 +396,7 @@
            SLOT( slotSubresourceAdded( ResourceCalendar *, const QString &,
                                        const QString &, const QString & ) ) );
 
- connect( resource, SIGNAL( signalSubresourceRemoved( ResourceCalendar *,
+  connect( resource, SIGNAL( signalSubresourceRemoved( ResourceCalendar *,
                                                        const QString &,
                                                        const QString & ) ),
            SLOT( slotSubresourceRemoved( ResourceCalendar *, const QString &,
@@ -383,9 +420,12 @@
     // Not found
     return;
 
+  if ( findItemByIdentifier( resource ) ) return;
+
   ResourceItem *item = static_cast<ResourceItem *>( i );
-  ( void )new ResourceItem( calendar, resource, label, this, item );
-  emitResourcesChanged();
+  ResourceItem *newItem = new ResourceItem( calendar, resource, label, this, item );
+  QColor resourceColor = *KOPrefs::instance()->resourceColor( resource );
+  newItem->setResourceColor( resourceColor );
 }
 
 // Remove an entry
@@ -425,9 +465,14 @@
   ResourceItem *item = currentItem();
   if ( !item ) return;
 
-  int km = KMessageBox::warningContinueCancel( this,
-        i18n("<qt>Do you really want to delete the resource <b>%1</b>?</qt>")
-        .arg( item->text( 0 ) ), "", KStdGuiItem::del() );
+  const QString warningMsg = item->isSubresource() ?
+        i18n("<qt>Do you really want to remove the subresource <b>%1</b>? "
+              "Note that its contents will be completely deleted. This "
+              "operation cannot be undone. </qt>").arg( item->text( 0 ) ) :
+        i18n("<qt>Do you really want to remove the resource <b>%1</b>?</qt>").arg( item->text( 0 ) );
+
+  int km = KMessageBox::warningContinueCancel( this, warningMsg, "",
+        KGuiItem( i18n("&Remove" ), "editdelete") );
   if ( km == KMessageBox::Cancel ) return;
 
 // Don't be so restricitve
@@ -439,12 +484,19 @@
   }
 #endif
   if ( item->isSubresource() ) {
-    // FIXME delete the folder in KMail
+    if ( !item->resource()->removeSubresource( item->resourceIdentifier() ) )
+      KMessageBox::sorry( this,
+              i18n ("<qt>Failed to remove the subresource <b>%1</b>. The "
+                  "reason could be that it is a built-in one which cannot "
+                  "be removed, or that the removal of the underlying storage "
+                  "folder failed.</qt>").arg( item->resource()->name() ) );
+      return;
   } else {
     mCalendar->resourceManager()->remove( item->resource() );
+  }
     mListView->takeItem( item );
     delete item;
-  }
+
   updateResourceList();
   emit resourcesChanged();
 }
@@ -521,7 +573,7 @@
 
     menu->insertItem( i18n("Show &Info"), this, SLOT( showInfo() ) );
     //FIXME: This is better on the resource dialog
-    if ( KOPrefs::instance()->agendaViewUsesResourceColor() ) {
+    if ( KOPrefs::instance()->agendaViewColors() != KOPrefs::CategoryOnly ) {
       QPopupMenu *assignMenu= new QPopupMenu( menu );
       assignMenu->insertItem( i18n( "&Assign Color" ), this, SLOT( assignColor() ) );
       if ( item->resourceColor().isValid() )
Index: korganizer/korganizer_part.rc
===================================================================
--- korganizer/korganizer_part.rc	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_part.rc	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui>
-<kpartgui name="korganizer" version="40">
+<kpartgui name="korganizer" version="42">
 
   <MenuBar>
     <Menu name="file"><text>&amp;File</text>
@@ -49,6 +49,7 @@
       <Action name="view_workweek"/>
       <Action name="view_week"/>
       <Action name="view_month"/>
+      <Action name="view_timeline"/>
       <Separator/>
       <Action name="view_list"/>
       <Action name="view_todo"/>
@@ -98,6 +99,7 @@
       <Action name="schedule_cancel"/>
       <Action name="schedule_refresh"/>
       <Action name="schedule_counter"/>
+      <Action name="schedule_forward"/>
       <Separator/>
       <Action name="mail_freebusy"/>
       <Action name="upload_freebusy"/>
@@ -143,6 +145,7 @@
     <Action name="view_week"/>
     <Action name="view_nextx"/>
     <Action name="view_month"/>
+    <Action name="view_timeline"/>
     <Action name="view_todo"/>
     <Action name="view_journal"/>
     <Merge/>
Index: korganizer/koeventpopupmenu.cpp
===================================================================
--- korganizer/koeventpopupmenu.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koeventpopupmenu.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,9 +24,11 @@
 
 #include <qcursor.h>
 
+#include <kactioncollection.h>
 #include <klocale.h>
 #include <kdebug.h>
 #include <kiconloader.h>
+#include <kurl.h>
 
 #include <libkcal/event.h>
 
@@ -36,6 +38,7 @@
 #include "koeventpopupmenu.h"
 #include "koeventpopupmenu.moc"
 #include "kocorehelper.h"
+#include "actionmanager.h"
 #ifndef KORG_NOPRINTER
 #include "calprinter.h"
 #endif
@@ -77,6 +80,10 @@
   mRecurrenceItems.append(
     insertItem( i18n("&Dissociate Future Occurrences"),
                 this, SLOT( dissociateFutureOccurrence() ) ) );
+
+  insertSeparator();
+  insertItem( KOGlobals::self()->smallIcon("mail_forward"), i18n( "Send as iCalendar..."),
+              this, SLOT(forward()) );
 }
 
 void KOEventPopupMenu::showIncidencePopup( Incidence *incidence, const QDate &qd )
@@ -124,9 +131,8 @@
 void KOEventPopupMenu::print()
 {
 #ifndef KORG_NOPRINTER
-  Calendar *cal;
   KOCoreHelper helper;
-  CalPrinter printer( this, cal, &helper );
+  CalPrinter printer( this, 0, &helper );
   connect( this, SIGNAL(configChanged()), &printer, SLOT(updateConfig()) );
 
   Incidence::List selectedIncidences;
@@ -169,3 +175,13 @@
   if ( mCurrentIncidence )
     emit dissociateFutureOccurrenceSignal( mCurrentIncidence, mCurrentDate );
 }
+
+void KOEventPopupMenu::forward()
+{
+  KOrg::MainWindow *w = ActionManager::findInstance( KURL() );
+  if ( !w || !mCurrentIncidence )
+    return;
+  KActionCollection *ac = w->getActionCollection();
+  KAction *action = ac->action( "schedule_forward" );
+  action->activate();
+}
Index: korganizer/freebusymanager.h
===================================================================
--- korganizer/freebusymanager.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/freebusymanager.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,7 +4,7 @@
   Requires the Qt and KDE widget libraries, available at no cost at
   http://www.trolltech.com and http://www.kde.org respectively
 
-  Copyright (c) 2002-2004 Klar‰lvdalens Datakonsult AB
+  Copyright (c) 2002-2004 Klar√§lvdalens Datakonsult AB
         <info@klaralvdalens-datakonsult.se>
 
   This program is free software; you can redistribute it and/or modify
@@ -66,7 +66,8 @@
     void slotData(  KIO::Job *, const QByteArray &data );
 
   signals:
-    void freeBusyDownloaded( KCal::FreeBusy *, const QString& );
+    void freeBusyDownloaded( KCal::FreeBusy *, const QString& email );
+    void freeBusyDownloadError( const QString& email );
 
   private:
     FreeBusyManager *mManager;
@@ -159,6 +160,7 @@
 
   private slots:
     void slotUploadFreeBusyResult( KIO::Job * );
+    void slotFreeBusyDownloadError( const QString& email );
 
   private:
     KCal::Calendar *mCalendar;
Index: korganizer/multiagendaview.h
===================================================================
--- korganizer/multiagendaview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 0)
+++ korganizer/multiagendaview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -0,0 +1,86 @@
+/*
+    Copyright (c) 2007 Volker Krause <vkrause@kde.org>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KORG_MULTIAGENDAVIEW_H_H
+#define KORG_MULTIAGENDAVIEW_H_H
+
+#include "agendaview.h"
+
+class QScrollView;
+class QHBox;
+class KOAgendaView;
+
+namespace KCal {
+  class ResourceCalendar;
+}
+
+namespace KOrg {
+
+/**
+  Shows one agenda for every resource side-by-side.
+*/
+class MultiAgendaView : public AgendaView
+{
+  Q_OBJECT
+  public:
+    explicit MultiAgendaView( Calendar* cal, QWidget *parent = 0, const char *name = 0 );
+    ~MultiAgendaView();
+
+    Incidence::List selectedIncidences();
+    DateList selectedDates();
+    int currentDateCount();
+    int maxDatesHint();
+
+    bool eventDurationHint(QDateTime &startDt, QDateTime &endDt, bool &allDay);
+
+    void setTypeAheadReceiver( QObject *o );
+
+  public slots:
+    void showDates( const QDate &start, const QDate &end );
+    void showIncidences( const Incidence::List &incidenceList );
+    void updateView();
+    void changeIncidenceDisplay( Incidence *incidence, int mode );
+
+    void setIncidenceChanger( IncidenceChangerBase *changer );
+
+    void finishTypeAhead();
+
+  protected:
+    void resizeEvent( QResizeEvent *ev );
+
+  private:
+    void addView( const QString &label, KCal::ResourceCalendar *res, const QString &subRes = QString::null );
+    void deleteViews();
+    void recreateViews();
+    void setupViews();
+    void resizeScrollView( const QSize &size );
+
+  private slots:
+    void slotSelectionChanged();
+    void slotClearTimeSpanSelection();
+
+  private:
+    QValueList<KOAgendaView*> mAgendaViews;
+    QValueList<QWidget*> mAgendaWidgets;
+    QHBox *mTopBox;
+    QScrollView *mScrollView;
+};
+
+}
+
+#endif
Index: korganizer/korganizer_configdesignerfields.desktop
===================================================================
--- korganizer/korganizer_configdesignerfields.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configdesignerfields.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -74,6 +74,7 @@
 Comment[da]=Indstil de selvvalgte sider
 Comment[de]=Einstellungen f√ºr benutzerdefinierte Seiten
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œÑœâŒΩ œÄœÅŒøœÉŒ±œÅŒºŒøœÉŒºŒ≠ŒΩœâŒΩ œÉŒµŒªŒØŒ¥œâŒΩ
+Comment[eo]=Agordi la proprajn paƒùojn
 Comment[es]=Configura las p√°ginas personalizadas
 Comment[et]=Omaloodud lehek√ºlgede seadistamine
 Comment[eu]=Konfiguratu orri pertsonalizatuak
Index: korganizer/koviewmanager.cpp
===================================================================
--- korganizer/koviewmanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koviewmanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 */
 
 #include <qwidgetstack.h>
+#include <qtabwidget.h>
 
 #include <kconfig.h>
 #include <kglobal.h>
@@ -36,9 +37,11 @@
 #include "kolistview.h"
 #include "kowhatsnextview.h"
 #include "kojournalview.h"
+#include "kotimelineview.h"
 #include "koprefs.h"
 #include "koglobals.h"
 #include "navigatorbar.h"
+#include "multiagendaview.h"
 
 #include "koviewmanager.h"
 #include "koviewmanager.moc"
@@ -53,9 +56,12 @@
   mWhatsNextView = 0;
   mTodoView = 0;
   mAgendaView = 0;
+  mAgendaSideBySideView = 0;
   mMonthView = 0;
   mListView = 0;
   mJournalView = 0;
+  mTimelineView = 0;
+  mAgendaViewTabs = 0;
 }
 
 KOViewManager::~KOViewManager()
@@ -78,6 +84,7 @@
   else if (view == "List") showListView();
   else if (view == "Journal") showJournalView();
   else if (view == "Todo") showTodoView();
+  else if (view == "Timeline") showTimelineView();
   else showAgendaView();
 }
 
@@ -91,6 +98,7 @@
   else if (mCurrentView == mListView) view = "List";
   else if (mCurrentView == mJournalView) view = "Journal";
   else if (mCurrentView == mTodoView) view = "Todo";
+  else if (mCurrentView == mTimelineView) view = "Timeline";
   else view = "Agenda";
 
   config->writeEntry("Current View",view);
@@ -140,7 +148,7 @@
     mMainView->showLeftFrame( true );
     mMainView->navigatorBar()->hide();
   }
-  mMainView->viewStack()->raiseWidget(mCurrentView);
+  mMainView->viewStack()->raiseWidget( widgetForView( mCurrentView  ) );
 }
 
 void KOViewManager::updateView()
@@ -276,9 +284,21 @@
 
 void KOViewManager::showAgendaView()
 {
-  if (!mAgendaView) {
-    mAgendaView = new KOAgendaView(mMainView->calendar(), mMainView->viewStack(), "KOViewManager::AgendaView");
+  const bool showBoth = KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::AllCalendarViews;
+  const bool showMerged = showBoth || KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::CalendarsMerged;
+  const bool showSideBySide = showBoth || KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::CalendarsSideBySide;
 
+  QWidget *parent = mMainView->viewStack();
+  if ( !mAgendaViewTabs && showBoth ) {
+    mAgendaViewTabs = new QTabWidget( mMainView->viewStack() );
+    connect( mAgendaViewTabs, SIGNAL( currentChanged( QWidget* ) ),
+             this, SLOT( currentAgendaViewTabChanged( QWidget* ) ) );
+    parent = mAgendaViewTabs;
+  }
+
+  if ( !mAgendaView && showMerged ) {
+    mAgendaView = new KOAgendaView(mMainView->calendar(), parent, "KOViewManager::AgendaView");
+
     addView(mAgendaView);
 
     connect(mAgendaView, SIGNAL( toggleExpand() ),
@@ -287,11 +307,44 @@
             mAgendaView, SLOT( setExpandedButton( bool ) ) );
 
     connect( mAgendaView,SIGNAL( zoomViewHorizontally(const QDate &, int )),
-      mMainView->dateNavigator(),SLOT( selectDates( const QDate &, int ) ) );
+             mMainView->dateNavigator(),SLOT( selectDates( const QDate &, int ) ) );
     mAgendaView->readSettings();
   }
 
-  showView(mAgendaView);
+  if ( !mAgendaSideBySideView && showSideBySide ) {
+    mAgendaSideBySideView =
+      new MultiAgendaView( mMainView->calendar(), parent,
+                        "KOViewManager::AgendaSideBySideView" );
+
+    addView(mAgendaSideBySideView);
+
+/*    connect(mAgendaSideBySideView, SIGNAL( toggleExpand() ),
+            mMainView, SLOT( toggleExpand() ) );
+    connect(mMainView, SIGNAL( calendarViewExpanded( bool ) ),
+            mAgendaSideBySideView, SLOT( setExpandedButton( bool ) ) );
+
+    connect( mAgendaSideBySideView,SIGNAL( zoomViewHorizontally(const QDate &, int )),
+             mMainView->dateNavigator(),SLOT( selectDates( const QDate &, int ) ) );*/
+  }
+
+  if ( showBoth && mAgendaViewTabs ) {
+    if ( mAgendaView && mAgendaViewTabs->indexOf( mAgendaView ) < 0 )
+      mAgendaViewTabs->addTab( mAgendaView, i18n("Merged calendar") );
+    if ( mAgendaSideBySideView  && mAgendaViewTabs->indexOf( mAgendaSideBySideView ) < 0 )
+      mAgendaViewTabs->addTab( mAgendaSideBySideView, i18n("Calendars Side by Side") );
+  } else {
+    if ( mAgendaView && mMainView->viewStack()->id( mAgendaView ) < 0 )
+      mMainView->viewStack()->addWidget( mAgendaView );
+    if ( mAgendaSideBySideView && mMainView->viewStack()->id( mAgendaSideBySideView ) < 0 )
+      mMainView->viewStack()->addWidget( mAgendaSideBySideView );
+  }
+
+  if ( mAgendaViewTabs && showBoth )
+    showView( static_cast<KOrg::BaseView*>( mAgendaViewTabs->currentPage() ) );
+  else if ( mAgendaView && showMerged )
+    showView( mAgendaView );
+  else if ( mAgendaSideBySideView && showSideBySide )
+    showView( mAgendaSideBySideView );
 }
 
 void KOViewManager::showDayView()
@@ -356,6 +409,17 @@
   showView(mJournalView);
 }
 
+
+void KOViewManager::showTimelineView()
+{
+  if (!mTimelineView) {
+    mTimelineView = new KOTimelineView(mMainView->calendar(),mMainView->viewStack(),
+                                     "KOViewManager::TimelineView");
+    addView(mTimelineView);
+  }
+  showView(mTimelineView);
+}
+
 void KOViewManager::showEventView()
 {
   if ( mLastEventView ) showView( mLastEventView );
@@ -385,3 +449,19 @@
 {
   if (mTodoView) mTodoView->setDocumentId( id );
 }
+
+
+QWidget* KOViewManager::widgetForView( KOrg::BaseView* view ) const
+{
+  const bool showBoth = KOPrefs::instance()->agendaViewCalendarDisplay() == KOPrefs::AllCalendarViews;
+  if ( (view == mAgendaView || view == mAgendaSideBySideView) && mAgendaViewTabs && showBoth ) {
+    return mAgendaViewTabs;
+  }
+  return view;
+}
+
+
+void KOViewManager::currentAgendaViewTabChanged( QWidget* widget )
+{
+  showView( static_cast<KOrg::BaseView*>( widget ) );
+}
Index: korganizer/kolistview.cpp
===================================================================
--- korganizer/kolistview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/kolistview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -183,17 +183,14 @@
   return true;
 }
 
-bool KOListView::ListItemVisitor::visit( Journal *t )
+bool KOListView::ListItemVisitor::visit(Journal *t)
 {
   static const QPixmap jrnalPxmp = KOGlobals::self()->smallIcon( "journal" );
-  mItem->setPixmap( 0, jrnalPxmp );
-  if ( t->summary().isEmpty() ) {
-    mItem->setText( 0, t->description().section( "\n", 0, 0 ) );
-  } else {
-    mItem->setText( 0, t->summary() );
-  }
+  mItem->setPixmap(0,jrnalPxmp);
+  // Just use the first line
+  mItem->setText( 0, t->description().section( "\n", 0, 0 ) );
   mItem->setText( 3, t->dtStartDateStr() );
-  mItem->setSortKey( 3, t->dtStart().toString( Qt::ISODate ) );
+  mItem->setSortKey( 3, t->dtStart().toString(Qt::ISODate) );
 
   return true;
 }
Index: korganizer/koagendaview.cpp
===================================================================
--- korganizer/koagendaview.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koagendaview.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -414,8 +414,9 @@
 ////////////////////////////////////////////////////////////////////////////
 
 KOAgendaView::KOAgendaView(Calendar *cal,QWidget *parent,const char *name) :
-  KOEventView (cal,parent,name), mExpandButton( 0 ), mAllowAgendaUpdate( true ),
-  mUpdateItem( 0 )
+  KOrg::AgendaView (cal,parent,name), mExpandButton( 0 ), mAllowAgendaUpdate( true ),
+  mUpdateItem( 0 ),
+  mResource( 0 )
 {
   mSelectedDates.append(QDate::currentDate());
 
@@ -573,6 +574,8 @@
 
   connect( agenda, SIGNAL( newStartSelectSignal() ),
            otherAgenda, SLOT( clearSelection() ) );
+  connect( agenda, SIGNAL( newStartSelectSignal() ),
+           SIGNAL( timeSpanSelectionChanged()) );
 
   connect( agenda, SIGNAL( editIncidenceSignal( Incidence * ) ),
                    SIGNAL( editIncidenceSignal( Incidence * ) ) );
@@ -1236,6 +1239,9 @@
 void KOAgendaView::insertIncidence( Incidence *incidence, const QDate &curDate,
                                     int curCol )
 {
+  if ( !filterByResource( incidence ) )
+    return;
+
   // FIXME: Use a visitor here, or some other method to get rid of the dynamic_cast's
   Event *event = dynamic_cast<Event *>( incidence );
   Todo  *todo  = dynamic_cast<Todo  *>( incidence );
@@ -1465,6 +1471,8 @@
 
         if ( ! todo->hasDueDate() ) continue;  // todo shall not be displayed if it has no date
 
+        if ( !filterByResource( todo ) ) continue;
+
         // ToDo items shall be displayed for the day they are due, but only showed today if they are already overdue.
         // Already completed items can be displayed on their original due date
         bool overdue = todo->isOverdue();
@@ -1726,3 +1734,32 @@
   mAgenda->setIncidenceChanger( changer );
   mAllDayAgenda->setIncidenceChanger( changer );
 }
+
+void KOAgendaView::clearTimeSpanSelection()
+{
+  mAgenda->clearSelection();
+  mAllDayAgenda->clearSelection();
+  deleteSelectedDateTime();
+}
+
+void KOAgendaView::setResource(KCal::ResourceCalendar * res, const QString & subResource)
+{
+  mResource = res;
+  mSubResource = subResource;
+}
+
+bool KOAgendaView::filterByResource(Incidence * incidence)
+{
+  if ( !mResource )
+    return true;
+  CalendarResources *calRes = dynamic_cast<CalendarResources*>( calendar() );
+  if ( !calRes )
+    return true;
+  if ( calRes->resource( incidence ) != mResource )
+    return false;
+  if ( !mSubResource.isEmpty() ) {
+    if ( mResource->subresourceIdentifier( incidence ) != mSubResource )
+      return false;
+  }
+  return true;
+}
Index: korganizer/korganizer_configgroupautomation.desktop
===================================================================
--- korganizer/korganizer_configgroupautomation.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configgroupautomation.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -22,6 +22,7 @@
 Name[da]=Gruppeautomation
 Name[de]=Gruppen-Automation
 Name[el]=ŒëœÖœÑŒøŒºŒ±œÑŒπœÉŒºœåœÇ ŒøŒºŒ¨Œ¥Œ±œÇ
+Name[eo]=Grup-a≈≠tomatigo
 Name[es]=Automatizaci√≥n del grupo
 Name[et]=Grupit√∂√∂
 Name[eu]=Talde automatizazioa
@@ -71,6 +72,7 @@
 Comment[da]=KOrganizer gruppeautomation indstilling
 Comment[de]=Einrichtung von Gruppen-Automatismen f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ Œ±œÖœÑŒøŒºŒ±œÑŒπœÉŒºŒøœç ŒøŒºŒ¨Œ¥Œ±œÇ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo Grup-a≈≠tomatiga Agordo
 Comment[es]=Configuraci√≥n del automatizaci√≥n del grupo de KOrganizer
 Comment[et]=KOrganizeri grupit√∂√∂ seadistamine
 Comment[eu]=KOrganizer-en talde automatizazioaren konfigurazioa
@@ -120,6 +122,7 @@
 Keywords[da]=korganizer,gruppe,automation
 Keywords[de]=KOrganizer,Gruppe,Automation
 Keywords[el]=korganizer,ŒøŒºŒ¨Œ¥Œ±,Œ±œÖœÑŒøŒºŒ±œÑŒøœÄŒøŒØŒ∑œÉŒ∑
+Keywords[eo]=korganizilo,grupo,a≈≠tomatigo
 Keywords[es]=korganizer,grupo,automatizaci√≥n
 Keywords[et]=korganizer,grupid,grupit√∂√∂
 Keywords[eu]=korganizer,taldea,automatizazioa
Index: korganizer/korganizer_configviews.desktop
===================================================================
--- korganizer/korganizer_configviews.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configviews.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -25,6 +25,7 @@
 Name[da]=Visninger
 Name[de]=Ansichten
 Name[el]=Œ†œÅŒøŒ≤ŒøŒªŒ≠œÇ
+Name[eo]=Rigardoj
 Name[es]=Vistas
 Name[et]=Vaated
 Name[eu]=Ikuspegiak
@@ -79,6 +80,7 @@
 Comment[da]=KOrganizer visningsindstilling
 Comment[de]=Ansichts-Einstellungen f√ºr KOrganizer
 Comment[el]=Œ°œçŒ∏ŒºŒπœÉŒ∑ œÄœÅŒøŒ≤ŒøŒªŒÆœÇ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo-Rigardagordo
 Comment[es]=Configuraci√≥n de la vista de KOrganizer
 Comment[et]=KOrganizeri vaateseadistused
 Comment[eu]=KOrganizer-en ikuspegi konfigurazioa
@@ -128,6 +130,7 @@
 Keywords[da]=korganizer,visning
 Keywords[de]=KOrganizer,Ansicht
 Keywords[el]=korganizer,œÄœÅŒøŒ≤ŒøŒªŒÆ
+Keywords[eo]=korganizilo,rigardo
 Keywords[es]=korganizer,vista
 Keywords[et]=korganizer,vaade
 Keywords[eu]=korganizer,ikuspegia
Index: korganizer/korganizeriface.h
===================================================================
--- korganizer/korganizeriface.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizeriface.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -51,6 +51,9 @@
                   incidence, only the first is added to KOrganizer's calendar.
     */
     virtual bool addIncidence(const QString &iCal) = 0;
+
+    virtual void loadProfile( const QString& path ) = 0;
+    virtual void saveToProfile( const QString& path ) const = 0;
 };
 
 #endif
Index: korganizer/incidencechanger.cpp
===================================================================
--- korganizer/incidencechanger.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/incidencechanger.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -237,11 +237,11 @@
   return ( v.act( inc1, inc2 ) );
 }
 
-/*bool IncidenceChanger::assignIncidence( Incidence *inc1, Incidence *inc2 )
+bool IncidenceChanger::assignIncidence( Incidence *inc1, Incidence *inc2 )
 {
   AssignmentVisitor v;
   return v.act( inc1, inc2 );
-}*/
+}
 
 bool IncidenceChanger::myAttendeeStatusChanged( Incidence *oldInc, Incidence *newInc )
 {
@@ -254,12 +254,16 @@
 }
 
 bool IncidenceChanger::changeIncidence( Incidence *oldinc, Incidence *newinc,
-                                        int action )
+                                        int action, bool counter )
 {
 kdDebug(5850)<<"IncidenceChanger::changeIncidence for incidence \""<<newinc->summary()<<"\" ( old one was \""<<oldinc->summary()<<"\")"<<endl;
   if( incidencesEqual( newinc, oldinc ) ) {
     // Don't do anything
     kdDebug(5850) << "Incidence not changed\n";
+    if ( counter ) {
+      KCal::MailScheduler scheduler( mCalendar );
+      scheduler.performTransaction( newinc, Scheduler::Reply );
+    }
   } else {
     kdDebug(5850) << "Incidence changed\n";
     bool statusChanged = myAttendeeStatusChanged( oldinc, newinc );
@@ -269,7 +273,8 @@
     //        for group cheduling. Each implementation could then just do what
     //        it wants with the event. If no groupware is used,use the null
     //        pattern...
-    if( !KOPrefs::instance()->mUseGroupwareCommunication ||
+    bool revert = KOPrefs::instance()->mUseGroupwareCommunication;
+    if ( !counter && revert &&
         KOGroupware::instance()->sendICalMessage( 0,
                                                   KCal::Scheduler::Request,
                                                   newinc, false, statusChanged ) ) {
@@ -279,9 +284,25 @@
       } else {
         emit incidenceChanged( oldinc, newinc, action );
       }
-    } else {
-      // FIXME: Revert the changes
-//      assignIncidence( newinc, oldinc );
+      revert = false;
+    }
+    if ( counter && revert ) {
+      // pseudo counter as done by outlook
+      Event *e = dynamic_cast<Event*>( newinc );
+      if ( e ) {
+        Incidence* tmp = oldinc->clone();
+        tmp->setSummary( i18n("Counter proposal: %1").arg( e->summary() ) );
+        tmp->setDescription( e->description() );
+        tmp->addComment( i18n("Proposed new meeting time: %1 - %2").arg( e->dtStartStr() ).arg( e->dtEndStr() ) );
+        KCal::MailScheduler scheduler( mCalendar );
+        scheduler.performTransaction( tmp, Scheduler::Reply );
+      } else {
+        kdWarning(5850) << k_funcinfo << "Counter proposals only supported for events" << endl;
+      }
+    }
+
+    if ( revert ) {
+      assignIncidence( newinc, oldinc );
       return false;
     }
   }
@@ -298,7 +319,7 @@
       kdError() << "sendIcalMessage failed." << endl;
     }
   }
-  // FIXME: This is a nasty hack, since we need to set a parent for the 
+  // FIXME: This is a nasty hack, since we need to set a parent for the
   //        resource selection dialog. However, we don't have any UI methods
   //        in the calendar, only in the CalendarResources::DestinationPolicy
   //        So we need to type-cast it and extract it from the CalendarResources
@@ -310,7 +331,7 @@
   }
   bool success = mCalendar->addIncidence( incidence );
   if ( stdcal ) {
-    // Reset the parent widget, otherwise we'll end up with pointers to deleted 
+    // Reset the parent widget, otherwise we'll end up with pointers to deleted
     // widgets sooner or later
     stdcal->setDialogParentWidget( tmpparent );
   }
Index: korganizer/freebusymanager.cpp
===================================================================
--- korganizer/freebusymanager.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/freebusymanager.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -99,16 +99,17 @@
   kdDebug(5850) << "FreeBusyDownloadJob::slotResult() " << mEmail << endl;
 
   if( job->error() ) {
-    kdDebug(5850) << "FreeBusyDownloadJob::slotResult() job error :-(" << endl;
+    kdDebug(5850) << "FreeBusyDownloadJob::slotResult() job error for " << mEmail << endl;
+    emit freeBusyDownloadError( mEmail );
+  } else {
+    FreeBusy *fb = mManager->iCalToFreeBusy( mFreeBusyData );
+    if ( fb ) {
+      Person p = fb->organizer();
+      p.setEmail( mEmail );
+      mManager->saveFreeBusy( fb, p );
+    }
+    emit freeBusyDownloaded( fb, mEmail );
   }
-
-  FreeBusy *fb = mManager->iCalToFreeBusy( mFreeBusyData );
-  if ( fb ) {
-    Person p = fb->organizer();
-    p.setEmail( mEmail );
-    mManager->saveFreeBusy( fb, p );
-  }
-  emit freeBusyDownloaded( fb, mEmail );
   deleteLater();
 }
 
@@ -345,13 +346,6 @@
   kdDebug(5850) << "FreeBusyManager::retrieveFreeBusy(): " << email << endl;
   if ( email.isEmpty() ) return false;
 
-  if( KOPrefs::instance()->thatIsMe( email ) ) {
-    // Don't download our own free-busy list from the net
-    kdDebug(5850) << "freebusy of owner" << endl;
-    emit freeBusyRetrieved( ownerFreeBusy(), email );
-    return true;
-  }
-
   // Check for cached copy of free/busy list
   KCal::FreeBusy *fb = loadFreeBusy( email );
   if ( fb ) {
@@ -359,8 +353,10 @@
   }
 
   // Don't download free/busy if the user does not want it.
-  if( !KOPrefs::instance()->mFreeBusyRetrieveAuto && !forceDownload)
+  if( !KOPrefs::instance()->mFreeBusyRetrieveAuto && !forceDownload) {
+    slotFreeBusyDownloadError( email ); // fblist
     return false;
+  }
 
   mRetrieveQueue.append( email );
 
@@ -383,6 +379,7 @@
 
   if ( !sourceURL.isValid() ) {
     kdDebug(5850) << "Invalid FB URL\n";
+    slotFreeBusyDownloadError( email );
     return false;
   }
 
@@ -395,9 +392,26 @@
                                             const QString & ) ),
            SLOT( processRetrieveQueue() ) );
 
+  connect( job, SIGNAL( freeBusyDownloadError( const QString& ) ),
+           this, SLOT( slotFreeBusyDownloadError( const QString& ) ) );
+
   return true;
 }
 
+void FreeBusyManager::slotFreeBusyDownloadError( const QString& email )
+{
+  if( KOPrefs::instance()->thatIsMe( email ) ) {
+    // We tried to download our own free-busy list from the net, but it failed
+    // so use local version instead.
+    // The reason we try to download even our own free-busy list is that
+    // this allows to avoid showing as busy the folders that are "fb relevant for nobody"
+    // like shared resources (meeting rooms etc.)
+    kdDebug(5850) << "freebusy of owner, falling back to local list" << endl;
+    emit freeBusyRetrieved( ownerFreeBusy(), email );
+  }
+
+}
+
 void FreeBusyManager::cancelRetrieval()
 {
   mRetrieveQueue.clear();
@@ -456,16 +470,19 @@
   KURL sourceURL;
   sourceURL = KOPrefs::instance()->mFreeBusyRetrieveUrl;
 
-  // Don't try to fetch free/busy data for users not on the specified servers
-  // This tests if the hostnames match, or one is a subset of the other
-  const QString hostDomain = sourceURL.host();
-  if ( hostDomain != emailHost && !hostDomain.endsWith( '.' + emailHost )
-       && !emailHost.endsWith( '.' + hostDomain ) ) {
-    // Host names do not match
-    kdDebug(5850) << "Host '" << sourceURL.host() << "' doesn't match email '"
-      << email << '\'' << endl;
-    return KURL();
-}
+  if ( KOPrefs::instance()->mFreeBusyCheckHostname ) {
+    // Don't try to fetch free/busy data for users not on the specified servers
+    // This tests if the hostnames match, or one is a subset of the other
+    const QString hostDomain = sourceURL.host();
+    if ( hostDomain != emailHost && !hostDomain.endsWith( '.' + emailHost )
+         && !emailHost.endsWith( '.' + hostDomain ) ) {
+      // Host names do not match
+      kdDebug(5850) << "Host '" << sourceURL.host() << "' doesn't match email '"
+        << email << '\'' << endl;
+      return KURL();
+    }
+  }
+
   kdDebug(5850) << "Server FreeBusy url: " << sourceURL << endl;
   if ( KOPrefs::instance()->mFreeBusyFullDomainRetrieval )
     sourceURL.setFileName( email + ".ifb" );
Index: korganizer/koincidenceeditor.h
===================================================================
--- korganizer/koincidenceeditor.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koincidenceeditor.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -39,7 +39,7 @@
 namespace KOrg { class IncidenceChangerBase; }
 
 class KOEditorDetails;
-class KOEditorAttachments;
+class KOAttendeeEditor;
 
 namespace KCal {
 class Calendar;
@@ -68,10 +68,11 @@
 
     virtual void reload() = 0;
 
+    void selectInvitationCounterProposal( bool enable );
+
   public slots:
-    void updateCategoryConfig();
     /** Edit an existing todo. */
-    virtual void editIncidence(Incidence *) = 0;
+    virtual void editIncidence(Incidence *, Calendar *) = 0;
     virtual void setIncidenceChanger( IncidenceChangerBase *changer ) {
         mChanger = changer; }
     /** Initialize editor. This function creates the tab widgets. */
@@ -79,7 +80,9 @@
     /**
       Adds attachments to the editor
     */
-    void addAttachments( const QStringList &attachments );
+    void addAttachments( const QStringList &attachments,
+                         const QStringList& mimeTypes = QStringList(),
+                         bool inlineAttachment = false );
     /**
       Adds attendees to the editor
     */
@@ -90,11 +93,16 @@
     void deleteAttendee( Incidence * );
 
     void editCategories();
+    void updateCategoryConfig();
     void dialogClose( Incidence * );
     void editCanceled( Incidence * );
 
     void deleteIncidenceSignal( Incidence * );
+    void signalAddAttachments( const QStringList &attachments,
+                               const QStringList& mimeTypes = QStringList(),
+                               bool inlineAttachment = false );
 
+
   protected slots:
     void slotApply();
     void slotOk();
@@ -113,7 +121,6 @@
     virtual void loadTemplate( /*const*/ CalendarLocal& ) = 0;
 
     void setupAttendeesTab();
-    void setupAttachmentsTab();
     void setupDesignerTabs( const QString &type );
 
     void saveAsTemplate( Incidence *, const QString &name );
@@ -139,13 +146,14 @@
     Calendar *mCalendar;
 
     KOEditorDetails *mDetails;
-    KOEditorAttachments *mAttachments;
+    KOAttendeeEditor *mAttendeeEditor;
     KOrg::IncidenceChangerBase *mChanger;
 
     QPtrList<KPIM::DesignerFields> mDesignerFields;
     QMap<QWidget*, KPIM::DesignerFields*> mDesignerFieldForWidget;
     QPtrList<QWidget> mEmbeddedURLPages;
     QPtrList<QWidget> mAttachedDesignerFields;
+    bool mIsCounter;
 };
 
 #endif
Index: korganizer/resourceview.h
===================================================================
--- korganizer/resourceview.h	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/resourceview.h	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -133,6 +133,7 @@
     void currentChanged( QListViewItem* );
     void slotSubresourceAdded( ResourceCalendar *, const QString &,
                                const QString &resource,const QString& label );
+
     void slotSubresourceRemoved( ResourceCalendar *, const QString &,
                                  const QString & );
     void closeResource( ResourceCalendar * );
Index: korganizer/koprefsdialog.cpp
===================================================================
--- korganizer/koprefsdialog.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/koprefsdialog.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -112,6 +112,7 @@
 
   addWidBool( KOPrefs::instance()->confirmItem(), topFrame );
   addWidRadios( KOPrefs::instance()->destinationItem(), topFrame);
+  addWidRadios( KOPrefs::instance()->defaultEmailAttachMethodItem(), topFrame );
 
   topTopLayout->addStretch( 1 );
 
@@ -504,10 +505,15 @@
 
       addWidBool( KOPrefs::instance()->selectionStartsEditorItem(), agendaGroup );
 
-      addWidBool( KOPrefs::instance()->agendaViewUsesResourceColorItem(), agendaGroup );
+      addWidCombo( KOPrefs::instance()->agendaViewColorsItem(), agendaGroup );
 
+      addWidCombo( KOPrefs::instance()->agendaViewCalendarDisplayItem(), agendaGroup );
+
       topLayout->addWidget( agendaGroup );
 
+      /*** Month and Todo view groups side by side, to save space. ***/
+      QHBoxLayout *hbox = new QHBoxLayout();
+      topLayout->addLayout( hbox );
 
       /*** Month View Group ***/
       QGroupBox *monthGroup = new QGroupBox( 1, Horizontal,
@@ -518,7 +524,7 @@
       addWidBool( KOPrefs::instance()->monthViewUsesCategoryColorItem(),
                       monthGroup );
       addWidBool( KOPrefs::instance()->monthViewUsesResourceColorItem(), monthGroup );
-      topLayout->addWidget( monthGroup );
+      hbox->addWidget( monthGroup );
 
 
       /*** Todo View Group ***/
@@ -527,7 +533,7 @@
                                             topFrame );
       addWidBool( KOPrefs::instance()->fullViewTodoItem(), todoGroup );
       addWidBool( KOPrefs::instance()->recordTodosInJournalsItem(), todoGroup );
-      topLayout->addWidget( todoGroup );
+      hbox->addWidget( todoGroup );
 
       topLayout->addStretch( 1 );
 
Index: korganizer/korganizer_configmain.desktop
===================================================================
--- korganizer/korganizer_configmain.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ korganizer/korganizer_configmain.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -24,6 +24,7 @@
 Name[da]=Personlig
 Name[de]=Pers√∂nliches
 Name[el]=Œ†œÅŒøœÉœâœÄŒπŒ∫œå
+Name[eo]=Personaƒµoj
 Name[et]=Isiklik
 Name[eu]=Pertsonala
 Name[fa]=ÿ¥ÿÆÿµ€å
@@ -76,6 +77,7 @@
 Comment[da]=KOrganizer hovedindstilling
 Comment[de]=Grundeinrichtung f√ºr KOrganizer
 Comment[el]=ŒöœçœÅŒπŒ± œÅœçŒ∏ŒºŒπœÉŒ∑ œÑŒøœÖ KOrganizer
+Comment[eo]=KOrganizilo-ƒàefagordo
 Comment[es]=Configuraci√≥n principal de KOrganizer
 Comment[et]=KOrganizeri p√µhiseadistused
 Comment[eu]=KOrganizer-en konfigurazio nagusia
Index: konsolekalendar/konsolekalendar.desktop
===================================================================
--- konsolekalendar/konsolekalendar.desktop	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ konsolekalendar/konsolekalendar.desktop	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -4,6 +4,7 @@
 Name[af]=Konsole Kalender
 Name[cs]=Konzolov√Ω kalend√°≈ô
 Name[de]=Konsolen-Kalender
+Name[eo]=KonzolKalendaro
 Name[fy]=Konsole-aginda
 Name[hi]=‡§ï‡§Ç‡§∏‡•ã‡§≤-‡§ï‡•à‡§≤‡•á‡§Ç‡§°‡§∞
 Name[hu]=Konsole-napt√°r
Index: konsolekalendar/main.cpp
===================================================================
--- konsolekalendar/main.cpp	(.../tags/KDE/3.5.8/kdepim)	(wersja 767768)
+++ konsolekalendar/main.cpp	(.../branches/KDE/3.5/kdepim)	(wersja 767768)
@@ -664,7 +664,7 @@
       variables.setCalendarFile( url.path() );
       exists = QFile::exists( variables.getCalendarFile() );
       remote = false;
-    } else if ( !variables.getCalendarFile().contains( '/' ) ) {
+    } else if ( url.protocol().isEmpty() ) {
       QFileInfo info( variables.getCalendarFile() );
       variables.setCalendarFile( info.absFilePath() );
       exists = QFile::exists( variables.getCalendarFile() );

Zmiany atrybut√≥w dla: .
___________________________________________________________________
Nazwa: svnmerge-blocked
   - /branches/kdepim/enterprise/kdepim:703472,703877,703925,704210,704221,704225-704226,704228-704229,704237,704988,704991-704992,704995,705006-705008,705190,705626,705751,705754-705758,705836,705995,706309,706493,706548-706549,706556,706560,706564,706572,706775,706802
   + /branches/kdepim/enterprise/kdepim:703472,703877,703925,704210,704221,704225-704226,704228-704229,704237,704988,704991-704992,704995,705006-705008,705190,705626,705751,705754-705758,705836,705995,706309,706493,706548-706549,706556,706560,706564,706572,706775,706802,767041,767555,767557
Nazwa: svnmerge-integrated
   - /branches/kdepim/enterprise/kdepim:1-703422,703473,703752,703903,703997-704180,709322,717162
   + /branches/kdepim/enterprise/kdepim:1-767022

Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


