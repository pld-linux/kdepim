Index: akregator/ChangeLog
===================================================================
--- akregator/ChangeLog	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/ChangeLog	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,17 @@
-Akregator ChangeLog
+#Akregator ChangeLog
 ===================
 (c) 2004-2006 the Akregator authors.
 
+Changes after 1.2.5:
+-----------------------------
+
+Bug fixes:
+
+ 2006/11/24 Add session management for browser tabs (#100964) Patch by Carsten Pfeiffer <pfeiffer at kde.org> -fo
+ 2006/11/10 Fix crash in Konqueror icon plugin sometimes happening when switching parts (#134929) -fo
+ 2006/10/31 Fix group name encoding bug when adding feeds from commandline (e.g., using the Konq plugin) (#136559)
+            Patch by Andrey Cherepanov.
+
 Changes after 1.2.4:
 -----------------------------
 
Index: akregator/src/librss/loader.h
===================================================================
--- akregator/src/librss/loader.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/librss/loader.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -227,7 +227,7 @@
 	 * 'OutputRetriever' will make it execute the script
 	 * '/home/myself/some-script.py' and assume whatever that script prints to
 	 * stdout is RSS markup. This is e.g. handy for conversion scripts, which
-	 * download a HTML file and convert it's contents into RSS markup.
+	 * download an HTML file and convert it's contents into RSS markup.
 	 *
 	 * No matter what kind of retrieval algorithm you employ, your
 	 * 'slotLoadingComplete' method might look like this:
Index: akregator/src/akregator.desktop
===================================================================
--- akregator/src/akregator.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/akregator.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -23,7 +23,7 @@
 GenericName[hu]=RSS hírolvasó
 GenericName[is]=RSS fréttaforrit
 GenericName[it]=Lettore Fonti RSS
-GenericName[ja]=RSS ニュースリーダ
+GenericName[ja]=RSS ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​មតិព័ត៌មាន RSS
 GenericName[lt]=RSS kanalų skaityklė
 GenericName[ms]= Pembaca Suapan RSS 
Index: akregator/src/tabwidget.cpp
===================================================================
--- akregator/src/tabwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/tabwidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -127,6 +127,19 @@
     return w ? d->frames[w] : 0;
 }
 
+QPtrList<Frame> TabWidget::frames() const
+{
+    QPtrList<Frame> result;
+    QPtrDictIterator<Frame> it(d->frames);
+    while (it.current())
+    {
+        result.append(it.current());
+        ++it;
+    }
+
+    return result;
+}
+
 void TabWidget::slotTabChanged(QWidget *w)
 {
     // FIXME: Don't hardcode the tab position of main frame
Index: akregator/src/main.cpp
===================================================================
--- akregator/src/main.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/main.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -65,7 +65,9 @@
       akr.send("openStandardFeedList");
     }
 
-    QString addFeedGroup = !args->getOption("group").isEmpty() ? args->getOption("group") : i18n("Imported Folder");
+    QString addFeedGroup = !args->getOption("group").isEmpty() 
+         ? QString::fromLocal8Bit(args->getOption("group")) 
+         : i18n("Imported Folder");
 
     QCStringList feeds = args->getOptionList("addfeed");
     QStringList feedsToAdd;
Index: akregator/src/eventsrc
===================================================================
--- akregator/src/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/eventsrc	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -15,7 +15,7 @@
 Name[es]=Origen añadido
 Name[et]=Kanal lisatud
 Name[eu]=Iturria gehituta
-Name[fa]=خوراندن اضافه شده‌
+Name[fa]=خوراندن اضافه‌شده
 Name[fi]=Syöte lisätty
 Name[fr]=Flux ajouté
 Name[ga]=Cuireadh fotha leis
@@ -56,7 +56,7 @@
 Comment[es]=Se ha añadido remotamente un origen a Akregator
 Comment[et]=Akregatorile lisati väljastpoolt uus kanal
 Comment[eu]=Iturri berri bat gehitu da urrunetik Akregator-era
-Comment[fa]=یک خوراندن جدید که به صورت دور به Akregator اضافه شده بود
+Comment[fa]=یک خوراندن جدید که به صورت دور به Akregator اضافه شد
 Comment[fi]=Uusi syöte lisättiin Akregatoriin ulkopuolelta
 Comment[fr]=Un flux a été ajouté à distance à Akregator
 Comment[he]=נוסף ערוץ ל־Akregator מרחוק
@@ -142,7 +142,7 @@
 Comment[es]=Se obtuvieron los artículos nuevos
 Comment[et]=Tõmmati uued artiklid
 Comment[eu]=Artikulu berriak eskuratu dira
-Comment[fa]=مقالات جدید واکشی شده بود
+Comment[fa]=مقالات جدید واکشی شدند
 Comment[fi]=Uutta postia saapunut
 Comment[fr]=Les nouveaux articles ont été relevés
 Comment[ga]=Fuarthas ailt nua
Index: akregator/src/akregator_view.cpp
===================================================================
--- akregator/src/akregator_view.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/akregator_view.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -93,6 +93,7 @@
 #include <qlayout.h>
 #include <qmultilineedit.h>
 #include <qpopupmenu.h>
+#include <qptrlist.h>
 #include <qstylesheet.h>
 #include <qtextstream.h>
 #include <qtimer.h>
@@ -1467,6 +1468,15 @@
         if (selNode)
             m_listTabWidget->activeView()->setSelectedNode(selNode);
     }
+
+    QStringList urls = config->readListEntry("FeedBrowserURLs");
+    QStringList::ConstIterator it = urls.begin();
+    for (; it != urls.end(); ++it)
+    {
+        KURL url = KURL::fromPathOrURL(*it);
+        if (url.isValid())
+            slotOpenNewTab(url, true); // open in background
+    }
 }
 
 void View::saveProperties(KConfig* config)
@@ -1481,6 +1491,25 @@
     {
         config->writeEntry("selectedNodeID", sel->id() );
     }
+
+    // save browser URLs
+    QStringList urls;
+    QPtrList<Frame> frames = m_tabs->frames();
+    QPtrList<Frame>::ConstIterator it = frames.begin();
+    for (; it != frames.end(); ++it)
+    {
+        Frame *frame = *it;
+        KParts::ReadOnlyPart *part = frame->part();
+        PageViewer *pageViewer = dynamic_cast<PageViewer*>(part); // don't save the ArticleViewer
+        if (pageViewer)
+        {
+            KURL url = pageViewer->url();
+            if (url.isValid())
+                urls.append(url.prettyURL());
+        }
+    }
+
+    config->writeEntry("FeedBrowserURLs", urls);
 }
 
 void View::connectToFeedList(FeedList* feedList)
Index: akregator/src/tabwidget.h
===================================================================
--- akregator/src/tabwidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ akregator/src/tabwidget.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -25,6 +25,7 @@
 #ifndef TABWIDGET_H
 #define TABWIDGET_H
 
+#include <qptrlist.h>
 #include <ktabwidget.h>
 
 class QString;
@@ -45,6 +46,7 @@
         void addFrame(Frame *f);
         Frame* currentFrame();
         void removeFrame(Frame *f);
+        QPtrList<Frame> frames() const;
 
     public slots:
 
Index: kmobile/devices/gammu/libkmobile_gammu.desktop
===================================================================
--- kmobile/devices/gammu/libkmobile_gammu.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmobile/devices/gammu/libkmobile_gammu.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -14,7 +14,7 @@
 Name[es]=Teléfono móvil u organizador (gammu)
 Name[et]=Mobiiltelefon või Organizer (gammu)
 Name[eu]=Mugikorra edo antolatzailea (gammu)
-Name[fa]=تلفن همراه یا سازمان دهنده (gammu)
+Name[fa]=تلفن همراه یا سازمان‌دهنده (gammu)
 Name[fi]=Matkapuhelin tai organisaattori (gammu)
 Name[fr]=Téléphone portable ou organiseur (gammu)
 Name[ga]=Fón Póca nó Eagraí (gammu)
Index: kresources/birthdays/resourcekabc.cpp
===================================================================
--- kresources/birthdays/resourcekabc.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kresources/birthdays/resourcekabc.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -270,7 +270,7 @@
     }
 
     Event *ev = new Event();
-      ev->setUid( (*it).uid()+"_KABC_Anniversary");
+      ev->setUid( uid_1+"_KABC_Anniversary" );
 
     ev->setDtStart(anniversary);
     ev->setDtEnd(anniversary);
@@ -281,7 +281,7 @@
 
     ev->setCustomProperty( "KABC", "BIRTHDAY", "YES" );
 
-    ev->setCustomProperty( "KABC", "UID-1", (*it).uid() );
+    ev->setCustomProperty( "KABC", "UID-1", uid_1 );
     ev->setCustomProperty( "KABC", "NAME-1", name_1 );
     ev->setCustomProperty( "KABC", "EMAIL-1", email_1 );
     ev->setCustomProperty( "KABC", "ANNIVERSARY", "YES" );
Index: certmanager/conf/kleopatra_config_appear.desktop
===================================================================
--- certmanager/conf/kleopatra_config_appear.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ certmanager/conf/kleopatra_config_appear.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -124,7 +124,7 @@
 Keywords[es]=color, tipografía, configuración
 Keywords[et]=värv, font, seadistamine
 Keywords[eu]=kolore,letra-tipo, konfigurazioa
-Keywords[fa]=رنگ،قلم،پیکربندی‌
+Keywords[fa]=رنگ، قلم، پیکربندی‌
 Keywords[fi]=värit,kirjasimet,asetukset
 Keywords[fr]=couleur,police,configuration,paramètres,réglages,couleurs,polices
 Keywords[ga]=dath,cló,cumraíocht
Index: certmanager/conf/kleopatra_config_dirserv.desktop
===================================================================
--- certmanager/conf/kleopatra_config_dirserv.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ certmanager/conf/kleopatra_config_dirserv.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -114,7 +114,7 @@
 Keywords[es]=ldap,directorio,servicios
 Keywords[et]=ldap,kataloog,teenused
 Keywords[eu]=Idap, direktorio, zerbitzuak
-Keywords[fa]=ldap،فهرست راهنما،خدمات‌‌
+Keywords[fa]=ldap،فهرست راهنما، خدمات‌‌
 Keywords[fi]=ldap,hakemisto,palvelut
 Keywords[fr]=ldap,dossier,dossiers,service,services
 Keywords[ga]=ldap,eolaire,seirbhísí
Index: certmanager/lib/libkleopatrarc.desktop
===================================================================
--- certmanager/lib/libkleopatrarc.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ certmanager/lib/libkleopatrarc.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -99,7 +99,7 @@
 Name[es]=Clave revocada
 Name[et]=Tühistatud võti
 Name[eu]=Errebokatutako gakoa
-Name[fa]=کلید لغو شده‌
+Name[fa]=کلید لغو‌شده‌
 Name[fi]=Peruutettu avain
 Name[fr]=Clé révoquée
 Name[he]=מפתח לא קביל
@@ -143,7 +143,7 @@
 Name[es]=Certificado raíz de confianza
 Name[et]=Usaldusväärne juursertifikaat
 Name[eu]=Konfidantzazko erro ziurtagiria
-Name[fa]=گواهینامۀ معتبر کاربر ارشد
+Name[fa]=گواهی‌نامۀ معتبر کاربر ارشد
 Name[fi]=Luotettu juurivarmenne
 Name[fr]=Certificat racine de confiance
 Name[hu]=Megbízható gyökértanúsítvány
@@ -186,7 +186,7 @@
 Name[es]=Certificado raíz no de confianza
 Name[et]=Ebausaldusväärne juursertifikaat
 Name[eu]=Konfidantza gabeko erro ziurtagiria
-Name[fa]=گواهینامۀ بدون اعتبار کاربر ارشد
+Name[fa]=گواهی‌نامۀ بدون اعتبار کاربر ارشد
 Name[fi]=Ei-luotettu juurivarmenne
 Name[fr]=Certificat racine non fiable
 Name[hu]=Nem megbízható gyökértanúsítvány
Index: libkmime/kmime_message.cpp
===================================================================
--- libkmime/kmime_message.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkmime/kmime_message.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -62,6 +62,10 @@
   if( (h=to(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //Cc
+  if( (h=cc(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Reply-To
   if( (h=replyTo(false))!=0 )
     newHead+=h->as7BitString()+"\n";
@@ -78,6 +82,10 @@
   if( (h=organization(false))!=0 )
     newHead+=h->as7BitString()+"\n";
 
+  //UserAgent
+  if( (h=userAgent(false))!=0 )
+    newHead+=h->as7BitString()+"\n";
+
   //Mime-Version
   newHead+="MIME-Version: 1.0\n";
 
Index: libkmime/kmime_headers_obs.h
===================================================================
--- libkmime/kmime_headers_obs.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkmime/kmime_headers_obs.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -166,6 +166,8 @@
 
     void addAddress(const AddressField &a);
     void emails(QStrList *l);
+    void names(QStringList *l);
+    void displayNames(QStringList *l);
 
   protected:
     ObsAddressList *a_ddrList;
Index: libkmime/kmime_newsarticle.h
===================================================================
--- libkmime/kmime_newsarticle.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkmime/kmime_newsarticle.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -43,7 +43,6 @@
   virtual KMime::Headers::Newsgroups* newsgroups(bool create=true)      { KMime::Headers::Newsgroups *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::FollowUpTo* followUpTo(bool create=true)      { KMime::Headers::FollowUpTo *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::Lines* lines(bool create=true)                { if(!create && l_ines.isEmpty()) return 0; return &l_ines; }
-  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
 
 
 protected:
Index: libkmime/kmime_message.h
===================================================================
--- libkmime/kmime_message.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkmime/kmime_message.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -51,6 +51,7 @@
   virtual KMime::Headers::CC* cc(bool create=true)                      { KMime::Headers::CC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::BCC* bcc(bool create=true)                    { KMime::Headers::BCC *p=0; return getHeaderInstance(p, create); }
   virtual KMime::Headers::References* references(bool create=true)      { KMime::Headers::References *p=0; return getHeaderInstance(p, create); }
+  virtual KMime::Headers::UserAgent* userAgent(bool create=true)        { KMime::Headers::UserAgent *p=0; return getHeaderInstance(p, create); }
   
 protected:
   //hardcoded headers
Index: libkmime/kmime_headers.cpp
===================================================================
--- libkmime/kmime_headers.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkmime/kmime_headers.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -257,7 +257,7 @@
   QString maybeDotAtom;
   if ( !parseDotAtom( scursor, send, maybeDotAtom, isCRLF ) )
     return false;
-  
+
   mDotAtom = maybeDotAtom;
 
   eatCFWS( scursor, send, isCRLF );
@@ -298,7 +298,7 @@
 
   //
   // type
-  // 
+  //
 
   QPair<const char*,int> maybeMimeType;
   if ( !parseToken( scursor, send, maybeMimeType, false /* no 8Bit */ ) )
@@ -328,10 +328,10 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return true; // no parameters
-  
+
   if ( *scursor != ';' ) return false;
   scursor++;
-  
+
   if ( !parseParameterList( scursor, send, mParameterHash, isCRLF ) )
     return false;
 
@@ -356,7 +356,7 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return false;
-  
+
   QPair<const char*,int> maybeToken;
   if ( !parseToken( scursor, send, maybeToken, false /* no 8Bit */ ) )
     return false;
@@ -369,10 +369,10 @@
 
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return true; // no parameters
-  
+
   if ( *scursor != ';' ) return false;
   scursor++;
-  
+
   if ( !parseParameterList( scursor, send, mParameterHash, isCRLF ) )
     return false;
 
@@ -445,7 +445,7 @@
 //-----<ReturnPath>-------------------------
 
 bool ReturnPath::parse( const char* & scursor, const char * const send, bool isCRLF ) {
-  
+
   eatCFWS( scursor, send, isCRLF );
   if ( scursor == send ) return false;
 
@@ -460,7 +460,7 @@
     eatCFWS( scursor, send, isCRLF );
     if ( scursor == send || *scursor != '>' ) return false;
     scursor++;
-    
+
     // prepare a Null mailbox:
     AddrSpec emptyAddrSpec;
     maybeMailbox.displayName = QString::null;
@@ -604,7 +604,7 @@
         pos1=pos2+1;
         pos2=s.find('>', pos1);
         if(pos2!=-1)
-          e_mail=s.mid(pos1, pos2-pos1);
+          e_mail=s.mid(pos1, pos2-pos1).stripWhiteSpace();
       }
       else return;
     break;
@@ -922,6 +922,23 @@
       l->append( it->email() );
 }
 
+void To::names(QStringList *l)
+{
+    l->clear();
+
+    for (AddressField *it=a_ddrList->first(); it != 0 ; it=a_ddrList->next() )
+        if( it->hasName() )
+            l->append( it->name() );
+}
+
+void To::displayNames(QStringList *l)
+{
+    l->clear();
+
+    for (AddressField *it=a_ddrList->first(); it != 0 ; it=a_ddrList->next() )
+            l->append( it->asUnicodeString() );
+}
+
 //-----</To>-----------------------------------
 #endif
 
Index: karm/taskview.h
===================================================================
--- karm/taskview.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/taskview.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -10,6 +10,7 @@
 #include "desktoplist.h"
 #include "resourcecalendar.h"
 #include "karmstorage.h"
+#include "mainwindow.h"
 #include "reportcriteria.h"
 #include <qtimer.h>
 //#include "desktoptracker.h"
@@ -96,6 +97,9 @@
     /** Stop all running timers.  */
     void stopAllTimers();
 
+    /** Stop all running timers as if it was qdt */
+    void stopAllTimersAt(QDateTime qdt);
+
     /** Calls newTask dialog with caption "New Task".  */
     void newTask();
 
@@ -179,6 +183,9 @@
     /** Copy totals for current and all sub tasks to clipboard. */
     void clipTotals();
 
+    /** Copy session times for current and all sub tasks to clipboard */
+    void clipSession();
+
     /** Copy history for current and all sub tasks to clipboard. */
     void clipHistory();
 
@@ -188,6 +195,7 @@
     void timersActive();
     void timersInactive();
     void tasksChanged( QPtrList<Task> activeTasks );
+    void setStatusBar( QString );
 
   private: // member variables
     IdleTimeDetector *_idleTimeDetector;
Index: karm/idletimedetector.cpp
===================================================================
--- karm/idletimedetector.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/idletimedetector.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -8,7 +8,9 @@
 #include <klocale.h>    // i18n
 
 IdleTimeDetector::IdleTimeDetector(int maxIdle)
+// Trigger a warning after maxIdle minutes
 {
+  kdDebug(5970) << "IdleTimeDetector::IdleTimeDetector" << endl;
   _maxIdle = maxIdle;
 
 #ifdef HAVE_LIBXSS
@@ -35,6 +37,7 @@
 
 void IdleTimeDetector::check()
 {
+  kdDebug(5970) << "Entering IdleTimeDetector::check" << endl;
 #ifdef HAVE_LIBXSS
   if (_idleDetectionPossible)
   {
@@ -76,8 +79,9 @@
 
   if (id == 0) {
     // Revert And Stop
-    emit(extractTime(idleMinutes+diff));
-    emit(stopAllTimers());
+    kdDebug(5970) << "Now it is " << KGlobal::locale()->formatTime(QDateTime::currentDateTime().time()).ascii() << endl;
+    kdDebug(5970) << "Reverting timer to " << KGlobal::locale()->formatTime(idleStart.time()).ascii() << endl;
+    emit(stopAllTimersAt(idleStart));
   }
   else if (id == 1) {
     // Revert and Continue
@@ -93,7 +97,9 @@
 
 void IdleTimeDetector::startIdleDetection()
 {
+  kdDebug(5970) << "Entering IdleTimeDetector::startIdleDetection" << endl; 
 #ifdef HAVE_LIBXSS
+  kdDebug(5970) << "Starting Timer" << endl;
   if (!_timer->isActive())
     _timer->start(testInterval);
 #endif //HAVE_LIBXSS
Index: karm/taskview.cpp
===================================================================
--- karm/taskview.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/taskview.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -81,8 +81,8 @@
   _idleTimeDetector = new IdleTimeDetector( _preferences->idlenessTimeout() );
   connect( _idleTimeDetector, SIGNAL( extractTime(int) ),
            this, SLOT( extractTime(int) ));
-  connect( _idleTimeDetector, SIGNAL( stopAllTimers() ),
-           this, SLOT( stopAllTimers() ));
+  connect( _idleTimeDetector, SIGNAL( stopAllTimersAt(QDateTime) ),
+           this, SLOT( stopAllTimersAt(QDateTime) ));
   connect( _preferences, SIGNAL( idlenessTimeout(int) ),
            _idleTimeDetector, SLOT( setMaxIdle(int) ));
   connect( _preferences, SIGNAL( detectIdleness(bool) ),
@@ -352,38 +352,20 @@
 
 void TaskView::scheduleSave()
 {
-    _manualSaveTimer->start( 10, true /*single-shot*/ );
+  kdDebug(5970) << "Entering TaskView::scheduleSave" << endl;
+  // save changes a little while after they happen
+  _manualSaveTimer->start( 10, true /*single-shot*/ );
 }
 
 Preferences* TaskView::preferences() { return _preferences; }
 
 QString TaskView::save()
+// This saves the not-running tasks.
 {
-    // DF: this code created a new event for the running task(s),
-    // at every call (very frequent with autosave) !!!
-    // -> if one wants autosave to save the current event, then
-    // Task needs to store the "current event" and we need to update
-    // it before calling save.
-#if 0
-  // Stop then start all timers so history entries are written.  This is
-  // inefficient if more than one task running, but it is correct.  It is
-  // inefficient because the iCalendar file is saved every time a task's
-  // setRunning(false, ...) is called.  For a big ics file, this could be a
-  // drag.  However, it does ensure that the data will be consistent.  And
-  // if the most common use case is that one task is running most of the time,
-  // it won't make any difference.
-  for (unsigned int i = 0; i < activeTasks.count(); i++)
-  {
-    activeTasks.at(i)->setRunning(false, _storage);
-    activeTasks.at(i)->setRunning(true, _storage);
-  }
-
-  // If there was an active task, the iCal file has already been saved.
-  if (activeTasks.count() == 0)
-#endif
-  {
-    return _storage->save(this);
-  }
+  kdDebug(5970) << "Entering TaskView::save" << endl;
+  QString err = _storage->save(this);
+  emit(setStatusBar(err));
+  return err;
 }
 
 void TaskView::startCurrentTimer()
@@ -419,6 +401,7 @@
 
 void TaskView::stopAllTimers()
 {
+  kdDebug(5970) << "Entering TaskView::stopAllTimers()" << endl;
   for ( unsigned int i = 0; i < activeTasks.count(); i++ )
     activeTasks.at(i)->setRunning(false, _storage);
 
@@ -426,9 +409,27 @@
   activeTasks.clear();
   emit updateButtons();
   emit timersInactive();
-  emit tasksChanged( activeTasks);
+  emit tasksChanged( activeTasks );
 }
 
+void TaskView::stopAllTimersAt(QDateTime qdt)
+// stops all timers for the time qdt. This makes sense, if the idletimedetector detected
+// the last work has been done 50 minutes ago.
+{
+  kdDebug(5970) << "Entering TaskView::stopAllTimersAt" << endl;
+  for ( unsigned int i = 0; i < activeTasks.count(); i++ )
+  {
+    activeTasks.at(i)->setRunning(false, _storage, qdt, qdt);
+    kdDebug() << activeTasks.at(i)->name() << endl;
+  }
+
+  _idleTimeDetector->stopIdleDetection();
+  activeTasks.clear();
+  emit updateButtons();
+  emit timersInactive();
+  emit tasksChanged( activeTasks );
+}
+
 void TaskView::startNewSession()
 {
   QListViewItemIterator item( first_child());
@@ -449,6 +450,7 @@
 
 void TaskView::stopTimerFor(Task* task)
 {
+  kdDebug(5970) << "Entering stopTimerFor. task = " << task->name() << endl;
   if ( task != 0 && activeTasks.findRef(task) != -1 ) {
     activeTasks.removeRef(task);
     task->setRunning(false, _storage);
@@ -690,6 +692,7 @@
 
 void TaskView::extractTime(int minutes)
 {
+  kdDebug(5970) << "Entering extractTime" << endl;
   addTimeToActiveTasks(-minutes);
 }
 
@@ -794,18 +797,42 @@
         i18n("Copy totals for just this task and its subtasks, or copy totals for all tasks?"),
         i18n("Copy Totals to Clipboard"),
         i18n("Copy This Task"), i18n("Copy All Tasks") );
+    if (response == KMessageBox::Yes) // This task only
+    {
+      KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::TotalTime));
+    }
+    else // All tasks
+    {
+      KApplication::clipboard()->setText(t.totalsAsText(this, false, TimeKard::TotalTime));
+    }
+  }
+  else
+  {
+    KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::TotalTime));
+  }
+}
+
+void TaskView::clipSession()
+{
+  TimeKard t;
+  if (current_item() && current_item()->isRoot())
+  {
+    int response = KMessageBox::questionYesNo( 0,
+        i18n("Copy session time for just this task and its subtasks, or copy session time for all tasks?"),
+        i18n("Copy Session Time to Clipboard"),
+        i18n("Copy This Task"), i18n("Copy All Tasks") );
     if (response == KMessageBox::Yes) // this task only
     {
-      KApplication::clipboard()->setText(t.totalsAsText(this));
+      KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::SessionTime));
     }
     else // only task
     {
-      KApplication::clipboard()->setText(t.totalsAsText(this, false));
+      KApplication::clipboard()->setText(t.totalsAsText(this, false, TimeKard::SessionTime));
     }
   }
   else
   {
-    KApplication::clipboard()->setText(t.totalsAsText(this));
+    KApplication::clipboard()->setText(t.totalsAsText(this, true, TimeKard::SessionTime));
   }
 }
 
Index: karm/karmui.rc
===================================================================
--- karm/karmui.rc	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/karmui.rc	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,4 +1,4 @@
-<!DOCTYPE kpartgui ><kpartgui name="karm" version="4" >
+<!DOCTYPE kpartgui ><kpartgui name="karm" version="5" >
 <MenuBar>
   <Menu name="file" >
     <text>&amp;File</text>
@@ -63,6 +63,7 @@
   <Separator />
   <Action name="clip_totals" />
   <Action name="clip_history" />
+  <Action name="clip_session" />
 </Menu>
 
 <State name="readonly">
Index: karm/mainwindow.cpp
===================================================================
--- karm/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -63,6 +63,8 @@
            this, SLOT(slotSelectionChanged()));
   connect( _taskView, SIGNAL( updateButtons() ),
            this, SLOT(slotSelectionChanged()));
+  connect( _taskView, SIGNAL( setStatusBar( QString ) ),
+           this, SLOT(setStatusBar( QString )));
 
   loadGeometry();
 
@@ -132,6 +134,11 @@
 //  actionAddComment->setEnabled( on );
 //}
 
+void MainWindow::setStatusBar(QString qs)
+{
+  statusBar()->message(i18n(qs.ascii()));
+}
+
 bool MainWindow::save()
 {
   kdDebug(5970) << "Saving time data to disk." << endl;
@@ -329,6 +336,14 @@
       SLOT( clipTotals() ),
       actionCollection(),
       "clip_totals");
+  // actionClipTotals will never be used again, overwrite it
+  actionClipTotals = new KAction( i18n("&Copy Session Time to Clipboard"),
+      QString::fromLatin1("klipper"),
+      0,
+      _taskView,
+      SLOT( clipSession() ),
+      actionCollection(),
+      "clip_session");
   actionClipHistory = new KAction( i18n("Copy &History to Clipboard"),
       QString::fromLatin1("klipper"),
       CTRL+ALT+Key_C,
Index: karm/idletimedetector.h
===================================================================
--- karm/idletimedetector.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/idletimedetector.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -3,6 +3,8 @@
 
 #include <qobject.h>
 #include "config.h"     // HAVE_LIBXSS
+#include <qdatetime.h>
+#include <kdebug.h>
 
 class QTimer;
 
@@ -50,11 +52,12 @@
   **/
   void extractTime(int minutes);
 
-  /**
-      Tells the listener to stop timing
-   **/
+  /** Tells the listener to stop timing **/
   void stopAllTimers();
 
+  /** Tells the listener to stop timing for QDateTime **/
+  void stopAllTimersAt(QDateTime qdt);
+
 public slots:
   /**
      Sets the maximum allowed idle.
Index: karm/timekard.cpp
===================================================================
--- karm/timekard.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/timekard.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -45,8 +45,10 @@
 
 const QString cr = QString::fromLatin1("\n");
 
-QString TimeKard::totalsAsText(TaskView* taskview, bool justThisTask)
+QString TimeKard::totalsAsText(TaskView* taskview, bool justThisTask, WhichTime which)
+// Print the total Times as text. If justThisTask, use activeTask, else, all tasks
 {
+  kdDebug(5970) << "Entering TimeKard::totalsAsText" << endl;
   QString retval;
   QString line;
   QString buf;
@@ -71,18 +73,20 @@
     if (justThisTask)
     {
       // a task's total time includes the sum of all subtask times
-      sum = taskview->current_item()->totalTime();
-      printTask(taskview->current_item(), retval, 0);
+      sum = which == TotalTime ? taskview->current_item()->totalTime() : taskview->current_item()->sessionTime();
+      printTask(taskview->current_item(), retval, 0, which);
     }
     else
     {
       sum = 0;
-      for (Task* task= taskview->current_item(); task;
+      for (Task* task= taskview->item_at_index(0); task;
           task= task->nextSibling())
       {
-        sum += task->totalTime();
-        if ( task->totalTime() )
-          printTask(task, retval, 0);
+        kdDebug(5970) << "Copying task " << task->name() << endl;
+        int time = which == TotalTime ? task->totalTime() : task->totalSessionTime();
+        sum += time;
+        if ( time || task->firstChild() )
+                printTask(task, retval, 0, which);
       }
     }
 
@@ -100,13 +104,13 @@
 }
 
 // Print out "<indent for level> <task total> <task>", for task and subtasks. Used by totalsAsText.
-void TimeKard::printTask(Task *task, QString &s, int level)
+void TimeKard::printTask(Task *task, QString &s, int level, WhichTime which)
 {
   QString buf;
 
   s += buf.fill(' ', level);
   s += QString(QString::fromLatin1("%1    %2"))
-    .arg(formatTime(task->totalTime()), timeWidth)
+    .arg(formatTime(which == TotalTime?task->totalTime():task->totalSessionTime()), timeWidth)
     .arg(task->name());
   s += cr;
 
@@ -114,8 +118,9 @@
       subTask;
       subTask = subTask->nextSibling())
   {
-    if ( subTask->totalTime() ) // to avoid 00:00 entries
-      printTask(subTask, s, level+1);
+    int time = which == TotalTime ? subTask->totalTime() : subTask->totalSessionTime();
+    if (time)
+      printTask(subTask, s, level+1, which);
   }
 }
 
Index: karm/task.cpp
===================================================================
--- karm/task.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/task.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -94,8 +94,10 @@
   delete _timer;
 }
 
-void Task::setRunning( bool on, KarmStorage* storage, QDateTime whenStarted  )
+void Task::setRunning( bool on, KarmStorage* storage, QDateTime whenStarted, QDateTime whenStopped  )
+// Sets a task running or stopped. If the task is to be stopped, whenStarted is not evaluated.
 {
+  kdDebug(5970) << "Entering Task::setRunning" << endl;
   if ( on ) {
     if (isComplete()) return; // don't start if its marked complete
     if (!_timer->isActive()) {
@@ -110,7 +112,7 @@
     if (_timer->isActive()) {
       _timer->stop();
       if ( ! _removing ) {
-        storage->stopTimer(this);
+        storage->stopTimer(this, whenStopped);
         setPixmap(1, UserIcon(QString::fromLatin1("empty-watch.xpm")));
       }
     }
Index: karm/mainwindow.h
===================================================================
--- karm/mainwindow.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -75,15 +75,20 @@
     /** @reimp from KarmDCOPIface::getError */
     QString getError( int karmErrorNumber ) const;
     int totalMinutesForTaskId( const QString& taskId );
+    /** start the timer for taskname */
     QString starttimerfor( const QString &taskname );
+    /** stop the timer for taskname */
     QString stoptimerfor( const QString &taskname );
     QString deletetodo();
+    /** shall there be a "really delete" question */
     bool    getpromptdelete();
+    /** set if there will be a "really delete" question */
     QString setpromptdelete( bool prompt );
     QString exportcsvfile( QString filename, QString from, QString to, int type, bool decimalMinutes, bool allTasks, QString delimiter, QString quote );
     QString importplannerfile( QString filename );
 
   public slots:
+    void setStatusBar( QString );
     void quit();
 
   protected slots:
Index: karm/karmstorage.h
===================================================================
--- karm/karmstorage.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/karmstorage.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -150,7 +150,7 @@
      */
     QString report( TaskView *taskview, const ReportCriteria &rc );
 
-    /*
+    /**
      * Log the change in a task's time.
      *
      * We create an iCalendar event to store each change.  The event start
@@ -229,7 +229,7 @@
      *
      * @param task   The task the timer was stopped for.
      */
-    void stopTimer(const Task* task);
+    void stopTimer(const Task* task, QDateTime when=QDateTime::currentDateTime());
 
     /**
      * Log a new comment for this task.
Index: karm/test/example.ics
===================================================================
--- karm/test/example.ics	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ karm/test/example.ics	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -0,0 +1,173 @@
+BEGIN:VCALENDAR
+PRODID:-//K Desktop Environment//NONSGML libkcal 3.5//EN
+VERSION:2.0
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:0
+X-KDE-karm-totalTaskTime:0
+CREATED:20061118T183926Z
+UID:libkcal-1156600660.458
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:customer foo
+CLASS:PUBLIC
+PRIORITY:3
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:0
+X-KDE-karm-totalTaskTime:0
+CREATED:20061118T183934Z
+UID:libkcal-1923273586.967
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:documenting
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:90
+X-KDE-karm-totalTaskTime:90
+CREATED:20061118T184032Z
+UID:libkcal-61950406.193
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:analysis
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:184
+X-KDE-karm-totalTaskTime:184
+CREATED:20061118T184044Z
+UID:libkcal-1755408865.833
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+RELATED-TO:libkcal-1156600660.458
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VTODO
+DTSTAMP:20061125T204432Z
+ORGANIZER;CN=root:MAILTO:
+X-KDE-karm-totalSessionTime:156
+X-KDE-karm-totalTaskTime:156
+CREATED:20061118T184054Z
+UID:libkcal-1177224330.526
+SEQUENCE:0
+LAST-MODIFIED:20061125T204432Z
+SUMMARY:phone with mother
+CLASS:PUBLIC
+PRIORITY:3
+PERCENT-COMPLETE:0
+END:VTODO
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:9360
+CREATED:20061118T184102Z
+UID:libkcal-733807033.405
+SEQUENCE:0
+LAST-MODIFIED:20061118T184102Z
+SUMMARY:phone with mother
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1177224330.526
+DTSTART:20061118T184054Z
+DTEND:20061118T211654Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:5400
+CREATED:20061118T184114Z
+UID:libkcal-552065854.752
+SEQUENCE:0
+LAST-MODIFIED:20061118T184114Z
+SUMMARY:analysis
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-61950406.193
+DTSTART:20061118T184032Z
+DTEND:20061118T201032Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:10920
+CREATED:20061118T184125Z
+UID:libkcal-691043213.294
+SEQUENCE:0
+LAST-MODIFIED:20061118T184125Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1755408865.833
+DTSTART:20061118T184044Z
+DTEND:20061118T214244Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:2
+CREATED:20061118T183930Z
+UID:libkcal-251324967.864
+SEQUENCE:0
+LAST-MODIFIED:20061118T183930Z
+SUMMARY:cr
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1156600660.458
+DTSTART:20061118T183928Z
+DTEND:20061118T183930Z
+TRANSP:OPAQUE
+END:VEVENT
+
+BEGIN:VEVENT
+DTSTAMP:20061125T204432Z
+ORGANIZER:MAILTO:
+X-KDE-karm-duration:95
+CREATED:20061118T184306Z
+UID:libkcal-729762004.89
+SEQUENCE:0
+LAST-MODIFIED:20061118T184306Z
+SUMMARY:programming
+CLASS:PUBLIC
+PRIORITY:3
+CATEGORIES:KArm
+RELATED-TO:libkcal-1755408865.833
+DTSTART:20061118T184130Z
+DTEND:20061118T184305Z
+TRANSP:OPAQUE
+END:VEVENT
+
+END:VCALENDAR
+
Index: karm/timekard.h
===================================================================
--- karm/timekard.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/timekard.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -87,6 +87,8 @@
   public:
     TimeKard() {};
 
+    enum WhichTime { TotalTime, SessionTime };
+
     /**
      * Generates ascii text of task totals, for current task on down.
      *
@@ -99,7 +101,7 @@
      * print the task subtree for a root task and when they want to print
      * all tasks.
      */
-    QString totalsAsText(TaskView* taskview, bool justThisTask = true);
+    QString totalsAsText(TaskView* taskview, bool justThisTask, WhichTime which);
 
     /**
      * Generates ascii text of weekly task history, for current task on down.
@@ -110,7 +112,7 @@
         const QDate& to, bool justThisTask, bool perWeek, bool totalsOnly);
 
 private:
-    void printTask(Task *t, QString &s, int level);
+    void printTask(Task *t, QString &s, int level, WhichTime which);
 
     void printTaskHistory(const Task *t, const QMap<QString, long>& datamap,
                           QMap<QString, long>& daytotals,
Index: karm/task.h
===================================================================
--- karm/task.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/task.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -183,7 +183,7 @@
 				    been changed by another program and being reloaded
  				    the task is set to running with another start date
        */
-      void setRunning( bool on, KarmStorage* storage, QDateTime whenStarted= QDateTime::currentDateTime());
+      void setRunning( bool on, KarmStorage* storage, QDateTime whenStarted=QDateTime::currentDateTime(), QDateTime whenStopped=QDateTime::currentDateTime());
 
       /** return the state of a task - if it's running or not
        *  @return         true or false depending on whether the task is running
Index: karm/karmstorage.cpp
===================================================================
--- karm/karmstorage.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/karmstorage.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -273,7 +273,7 @@
   // restart tasks that have been running with their start times
   for ( int i=0; i<view->count(); i++)
   {
-    for ( int n=0; n<runningTasks.size(); n++)
+    for ( unsigned int n=0; n<runningTasks.size(); n++)
     {
       if ( runningTasks[n] == view->item_at_index(i)->uid() )
       {
@@ -1043,9 +1043,10 @@
   return err;
 }
 
-void KarmStorage::stopTimer(const Task* task)
+void KarmStorage::stopTimer(const Task* task, QDateTime when)
 {
-  long delta = task->startTime().secsTo(QDateTime::currentDateTime());
+  kdDebug(5970) << "Entering KarmStorage::stopTimer" << endl;
+  long delta = task->startTime().secsTo(when);
   changeTime(task, delta);
 }
 
@@ -1071,6 +1072,7 @@
 
 void KarmStorage::changeTime(const Task* task, const long deltaSeconds)
 {
+  kdDebug(5970) << "Entering KarmStorage::changeTime ( " << task->name() << "," << deltaSeconds <<  " )" << endl;
   KCal::Event* e;
   QDateTime end;
 
@@ -1211,6 +1213,12 @@
 {
   kdDebug(5970) << "KarmStorage::saveCalendar" << endl;
 
+  Event::List evl=_calendar->rawEvents();
+  kdDebug(5970) << "summary - dtStart - dtEnd" << endl;
+  for (unsigned int i=0; i<evl.count(); i++) 
+  {
+    kdDebug() << evl[i]->summary() << evl[i]->dtStart() << evl[i]->dtEnd() << endl;
+  }
   KABC::Lock *lock = _calendar->lock();
   if ( !lock || !lock->lock() )
     return false;
Index: karm/support/karm.desktop
===================================================================
--- karm/support/karm.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ karm/support/karm.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -27,7 +27,7 @@
 GenericName[es]=Cronómetro personal
 GenericName[et]=Personaalne ajaarvestus
 GenericName[eu]=Kronometro pertsonala
-GenericName[fa]=ردیاب زمان شخصی 
+GenericName[fa]=ردیاب شخصی زمان 
 GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
 GenericName[fr]=Chronomètre individuel de tâches
 GenericName[gl]=Xestor Persoal de Proxectos
Index: kmail/kmfilterdlg.cpp
===================================================================
--- kmail/kmfilterdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmfilterdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -226,6 +226,7 @@
       gl->addMultiCellWidget( keyButtonLabel, 7, 7, 2, 2 );
       mKeyButton = new KKeyButton( adv_w, "FilterShortcutSelector" );
       gl->addMultiCellWidget( mKeyButton, 7, 7, 3, 3 );
+      mKeyButton->setEnabled( false );
       mConfigureToolbar = new QCheckBox( i18n("Additionally add this filter to the toolbar"), adv_w );
       gl->addMultiCellWidget( mConfigureToolbar, 8, 8, 0, 3 );
       mConfigureToolbar->setEnabled( false );
@@ -497,6 +498,7 @@
 {
   if ( mFilter ) {
     mFilter->setConfigureShortcut( aChecked );
+    mKeyButton->setEnabled( aChecked );
     mConfigureToolbar->setEnabled( aChecked );
     mFilterActionIconButton->setEnabled( aChecked );
     mFilterActionLabel->setEnabled( aChecked );
Index: kmail/kmail.antispamrc
===================================================================
--- kmail/kmail.antispamrc	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmail.antispamrc	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,5 +1,5 @@
 [General]
-tools=10
+tools=11
 
 [Spamtool #1]
 Ident=spamassassin
@@ -210,3 +210,23 @@
 ScoreType=Decimal
 ScoreValueRegexp=([\d\.]+)\s*
 ScoreConfidenceRegexp=([\d\.]+)\s*
+
+[Spamtool #11]
+Ident=crm114
+Version=1
+Priority=65
+VisibleName=CRM114
+Executeable=crm -v | grep "CRM114"
+URL=http://crm114.sourceforge.net
+PipeFilterName=CRM114 Check
+PipeCmdDetect=crm -u $HOME/.crm114 mailreaver.crm
+ExecCmdSpam=crm -u $HOME/.crm114 mailreaver.crm --spam
+ExecCmdHam=crm -u $HOME/.crm114 mailreaver.crm --good
+DetectionHeader=X-CRM114-Status
+DetectionPattern=SPAM
+DetectionPattern2=UNSURE
+DetectionOnly=0
+UseRegExp=0
+SupportsBayes=1
+SupportsUnsure=1
+
Index: kmail/expirejob.cpp
===================================================================
--- kmail/expirejob.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/expirejob.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -125,7 +125,7 @@
     const KMMsgBase *mb = storage->getMsgBase( mCurrentIndex );
     if (mb == 0)
       continue;
-    if ( mb->isImportant()
+    if ( ( mb->isImportant() || mb->isTodo() )
       && GlobalSettings::self()->excludeImportantMailFromExpiry() )
        continue;
 
Index: kmail/profiles/profile-html-rc.desktop
===================================================================
--- kmail/profiles/profile-html-rc.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/profiles/profile-html-rc.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -17,7 +17,7 @@
 Comment[es]=Perfil estándar con las vista HTML activada - menos seguro
 Comment[et]=Standardprofiil HTML-i eelvaatlusega - pole nii turvaline!
 Comment[eu]=HTML aurrebista gaituta duen profil estandarra - sekuritate gutxiago du
-Comment[fa]=profile استاندارد با پیش‌نمایش زنگام فعال شده - با ایمنی کمتر!
+Comment[fa]=profile استاندارد با پیش‌نمایش زنگام فعال‌شده - با ایمنی کمتر!
 Comment[fi]=Normaali profiili HTML-esikatselua käyttäville - vähemmän turvallinen.
 Comment[fr]=Profil standard avec l'aperçu HTML activé - Moins sécurisé !
 Comment[gl]=Perfil estándar con previsualización HTML activada - menos seguro!
Index: kmail/application_octetstream.desktop
===================================================================
--- kmail/application_octetstream.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/application_octetstream.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -39,7 +39,7 @@
 Comment[es]=Un accesorio de formato para el cuerpo de application/octet-stream
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile application/octet-stream)
 Comment[eu]=Gorputz-zati formateatzaile plugin bat aplikazio/zortikote-jarioentzat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای کاربرد/octet-stream
+Comment[fa]=یک وصلۀ قالب‌دهندۀ بخش بدنه برای کاربرد/octet-stream
 Comment[fi]=Muokkainliitännäinen application/octet-stream-muodolle
 Comment[fr]=Un module formateur de corps pour application (flux d'octets)
 Comment[hu]=Formázómodul application/octet-stream típusú adatfolyamokhoz
Index: kmail/kmmsgpart.cpp
===================================================================
--- kmail/kmmsgpart.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmmsgpart.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -386,8 +386,19 @@
 {
   QCString mimeType( mType + "/" + mSubtype );
   KPIM::kAsciiToLower( mimeType.data() );
+
   QString fileName =
     KMimeType::mimeType( mimeType )->icon( QString::null, false );
+  if ( fileName.isEmpty() )
+  { 
+    fileName = this->fileName(); 
+    if ( fileName.isEmpty() ) fileName = this->name(); 
+    if ( !fileName.isEmpty() )
+    {
+      fileName = KMimeType::findByPath( "/tmp/"+fileName, 0, true )->icon( QString::null, true );
+    }
+  } 
+
   fileName =
     KGlobal::instance()->iconLoader()->iconPath( fileName, KIcon::Desktop );
   return fileName;
Index: kmail/kmpopfiltercnfrmdlg.cpp
===================================================================
--- kmail/kmpopfiltercnfrmdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmpopfiltercnfrmdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -266,13 +266,9 @@
 QString KMPopHeadersViewItem::key(int col, bool) const
 {
   if (col == 3) return KMMsgBase::skipKeyword(text(col).lower());
-  if (col == 5) return text(7);
-  if (col == 6)
-  {
-    QString st = text(col);
-    while (st.length() < 10) st = "0" + st;
-    return st;
-  }
+  if (col == 6) return text(8);
+  if (col == 7)
+    return text(col).rightJustify( 10, '0', false);
   return text(col);
 }
 
Index: kmail/kmail_config_composer.desktop
===================================================================
--- kmail/kmail_config_composer.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmail_config_composer.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Composer
+Name[ar]=المحرر
 Name[bg]=Редактор
 Name[br]=Skridaozer
 Name[bs]=Sastavljač
@@ -70,7 +71,7 @@
 Comment[es]=Frases y comportamiento general
 Comment[et]=Väljendid ja üldine käitumine
 Comment[eu]=Esaldiak eta portamolde orokorra
-Comment[fa]=عبارات و رفتار کلی
+Comment[fa]=عبارات و رفتار عمومی
 Comment[fi]=Ilmaukset ja yleiset asetukset
 Comment[fr]=Phrases et comportement général
 Comment[gl]=Frases e comportamento xeral
Index: kmail/kmreaderwin.cpp
===================================================================
--- kmail/kmreaderwin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmreaderwin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1096,7 +1096,7 @@
     }
     else {
       QStringList encodings = mSelectEncodingAction->items();
-      int i = 0;
+      uint i = 0;
       for ( QStringList::const_iterator it = encodings.begin(), end = encodings.end(); it != end; ++it, ++i ) {
         if ( KGlobal::charsets()->encodingForName( *it ) == encoding ) {
           mSelectEncodingAction->setCurrentItem( i );
@@ -2080,16 +2080,18 @@
   } else {
     htmlWriter()->begin( mCSSHelper->cssDefinitions( isFixedFont() ) );
     htmlWriter()->queue( mCSSHelper->htmlHead( isFixedFont() ) );
+    htmlWriter()->queue( "<pre>" );
 
     QString str = aMsgPart->bodyDecoded();
     // A QString cannot handle binary data. So if it's shorter than the
     // attachment, we assume the attachment is binary:
     if( str.length() < (unsigned) aMsgPart->decodedSize() ) {
-      str += QString::fromLatin1("\n") + i18n("[KMail: Attachment contains binary data. Trying to show first character.]",
+      str.prepend( i18n("[KMail: Attachment contains binary data. Trying to show first character.]",
           "[KMail: Attachment contains binary data. Trying to show first %n characters.]",
-          str.length());
+          str.length()) + QChar('\n') );
     }
-    htmlWriter()->write( QStyleSheet::escape( str ) );
+    htmlWriter()->queue( QStyleSheet::escape( str ) );
+    htmlWriter()->queue( "</pre>" );
     htmlWriter()->queue("</body></html>");
     htmlWriter()->flush();
     mMainWindow->setCaption(i18n("View Attachment: %1").arg(pname));
Index: kmail/kmmessage.cpp
===================================================================
--- kmail/kmmessage.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmmessage.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1790,7 +1790,8 @@
 //-----------------------------------------------------------------------------
 QString KMMessage::to() const
 {
-  return KPIM::normalizeAddressesAndDecodeIDNs( headerField("To") );
+  // handle To same as Cc below, bug 80747 
+  return KPIM::normalizeAddressesAndDecodeIDNs( headerFields( "To" ).join( ", " ) ); 
 }
 
 
Index: kmail/kmail_config_identity.desktop
===================================================================
--- kmail/kmail_config_identity.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmail_config_identity.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Identities
+Name[ar]=الهويات
 Name[be]=Увасабленьні
 Name[bg]=Самоличност
 Name[br]=Anvelezhioù
@@ -60,6 +61,7 @@
 Name[zh_CN]=身份
 Name[zh_TW]=身份
 Comment=Manage Identities
+Comment[ar]=تدبير الهويات
 Comment[be]=Кіраваньне увасабленьнямі
 Comment[bg]=Настройки на самоличността
 Comment[br]=Merañ an anvelezhioù
Index: kmail/kmcommands.cpp
===================================================================
--- kmail/kmcommands.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmcommands.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -811,22 +811,28 @@
     assert( idx >= 0 );
     msg = p->getMsg(idx);
 
-    if (msg->transferInProgress()) {
-      QByteArray data = QByteArray();
-      mJob->sendAsyncData( data );
-    }
-    msg->setTransferInProgress( true );
-    if (msg->isComplete() ) {
-      slotMessageRetrievedForSaving(msg);
-    } else {
+    if ( msg ) {
+      if ( msg->transferInProgress() ) {
+        QByteArray data = QByteArray();
+        mJob->sendAsyncData( data );
+      }
+      msg->setTransferInProgress( true );
+      if (msg->isComplete() ) {
+        slotMessageRetrievedForSaving( msg );
+      } else {
       // retrieve Message first
-      if (msg->parent()  && !msg->isComplete() ) {
-        FolderJob *job = msg->parent()->createJob(msg);
-        job->setCancellable( false );
-        connect(job, SIGNAL(messageRetrieved(KMMessage*)),
-            this, SLOT(slotMessageRetrievedForSaving(KMMessage*)));
-        job->start();
+        if ( msg->parent()  && !msg->isComplete() ) {
+          FolderJob *job = msg->parent()->createJob( msg );
+          job->setCancellable( false );
+          connect(job, SIGNAL( messageRetrieved( KMMessage* ) ),
+                  this, SLOT( slotMessageRetrievedForSaving( KMMessage* ) ) );
+          job->start();
+        }
       }
+    } else {
+      mJob->slotError( KIO::ERR_ABORTED,
+                       i18n("The message was removed while saving it. "
+                            "It has not been saved.") );
     }
   } else {
     if ( mStandAloneMessage ) {
Index: kmail/kmatmlistview.cpp
===================================================================
--- kmail/kmatmlistview.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmatmlistview.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,147 +1,30 @@
 // -*- mode: C++; c-file-style: "gnu" -*-
-// kmcomposewin.cpp
+// kmatmlistview.cpp
 // Author: Markus Wuebben <markus.wuebben@kde.org>
 // This code is published under the GPL.
 
 #include <config.h>
 
 #include "kmatmlistview.h"
-
-#include "kmmainwin.h"
-#include "kmreadermainwin.h"
-#include "messagesender.h"
-#include "kmmsgpartdlg.h"
-#include <kpgpblock.h>
-#include <kaddrbook.h>
-#include "kmaddrbook.h"
-#include "kmmsgdict.h"
-#include "kmfolderimap.h"
-#include "kmfoldermgr.h"
-#include "kmfoldercombobox.h"
-#include "kmtransport.h"
-#include "kmcommands.h"
-#include "kcursorsaver.h"
-#include "partNode.h"
-#include "attachmentlistview.h"
-#include "transportmanager.h"
-using KMail::AttachmentListView;
-#include "dictionarycombobox.h"
-using KMail::DictionaryComboBox;
-#include "addressesdialog.h"
-using KPIM::AddressesDialog;
-#include "addresseeemailselection.h"
-using KPIM::AddresseeEmailSelection;
-using KPIM::AddresseeSelectorDialog;
-#include <maillistdrag.h>
-using KPIM::MailListDrag;
-#include "recentaddresses.h"
-using KRecentAddress::RecentAddresses;
-#include "kleo_util.h"
-#include "stl_util.h"
-#include "recipientseditor.h"
-
-#include "attachmentcollector.h"
-#include "objecttreeparser.h"
-
-#include "kmfoldermaildir.h"
-
-#include <libkpimidentities/identitymanager.h>
-#include <libkpimidentities/identitycombo.h>
-#include <libkpimidentities/identity.h>
-#include <libkdepim/kfileio.h>
-#include <libemailfunctions/email.h>
-#include <kleo/cryptobackendfactory.h>
-#include <kleo/exportjob.h>
-#include <ui/progressdialog.h>
-#include <ui/keyselectiondialog.h>
-
-#include <gpgmepp/context.h>
-#include <gpgmepp/key.h>
-
-#include <kabc/vcardconverter.h>
-#include <libkdepim/kvcarddrag.h>
-#include <kio/netaccess.h>
-
-
-#include "klistboxdialog.h"
-
-#include "messagecomposer.h"
-
-#include <kcharsets.h>
-#include <kcompletionbox.h>
-#include <kcursor.h>
-#include <kcombobox.h>
-#include <kstdaccel.h>
-#include <kpopupmenu.h>
-#include <kedittoolbar.h>
-#include <kkeydialog.h>
-#include <kdebug.h>
-#include <kfiledialog.h>
-#include <kwin.h>
-#include <kinputdialog.h>
-#include <kmessagebox.h>
-#include <kurldrag.h>
-#include <kio/scheduler.h>
-#include <ktempfile.h>
-#include <klocale.h>
-#include <kapplication.h>
-#include <kstatusbar.h>
-#include <kaction.h>
-#include <kstdaction.h>
-#include <kdirwatch.h>
-#include <kstdguiitem.h>
-#include <kiconloader.h>
-#include <kpushbutton.h>
-#include <kuserprofile.h>
-#include <krun.h>
-#include <ktempdir.h>
-//#include <keditlistbox.h>
-#include "globalsettings.h"
-#include "replyphrases.h"
-
-#include <kspell.h>
-#include <kspelldlg.h>
-#include <spellingfilter.h>
-#include <ksyntaxhighlighter.h>
-#include <kcolordialog.h>
-#include <kzip.h>
-#include <ksavefile.h>
-
-#include <qtabdialog.h>
-#include <qregexp.h>
-#include <qbuffer.h>
-#include <qtooltip.h>
-#include <qtextcodec.h>
+#include <qcheckbox.h>
 #include <qheader.h>
-#include <qwhatsthis.h>
-#include <qfontdatabase.h>
 
-#include <mimelib/mimepp.h>
-
-#include <algorithm>
-
-#include <sys/stat.h>
-#include <sys/types.h>
-#include <stdlib.h>
-#include <unistd.h>
-#include <errno.h>
-#include <fcntl.h>
-#include <assert.h>
-
-KMAtmListViewItem::KMAtmListViewItem(QListView *parent)
+KMAtmListViewItem::KMAtmListViewItem( QListView *parent )
   : QObject(),
-    QListViewItem( parent ),
-    mListview( parent ),
-    mCBSignEnabled( false ),
-    mCBEncryptEnabled( false )
+    QListViewItem( parent )
 {
-  mCBEncrypt = new QCheckBox( mListview->viewport() );
-  mCBSign = new QCheckBox( mListview->viewport() );
-  mCBCompress = new QCheckBox( mListview->viewport() );
-  connect( mCBCompress, SIGNAL( clicked() ), this, SLOT( slotCompress() ) );
+  mCBCompress = new QCheckBox( listView()->viewport() );
+  mCBEncrypt = new QCheckBox( listView()->viewport() );
+  mCBSign = new QCheckBox( listView()->viewport() );
+  mCBCompress->setShown( true );
+  updateAllCheckBoxes();
 
-  mCBEncrypt->hide();
-  mCBSign->hide();
+  connect( mCBCompress, SIGNAL( clicked() ), this, SLOT( slotCompress() ) );
+  connect( listView()->header(), SIGNAL( sizeChange(int, int, int) ),
+           SLOT( slotHeaderChange( int, int, int ) ) );
+  connect( listView()->header(), SIGNAL( indexChange(int, int, int) ),
+           SLOT( slotHeaderChange( int, int, int ) ) );
+  connect( listView()->header(), SIGNAL( clicked( int ) ), SLOT( slotHeaderClick( int ) ) );
 }
 
 KMAtmListViewItem::~KMAtmListViewItem()
@@ -154,118 +37,110 @@
   mCBCompress = 0;
 }
 
-void KMAtmListViewItem::paintCell( QPainter * p, const QColorGroup & cg,
-                                  int column, int width, int align )
+void KMAtmListViewItem::updateCheckBox( int headerSection, QCheckBox *cb )
 {
-  // this is also called for the encrypt/sign columns to assure that the
-  // background is cleared
-  QListViewItem::paintCell( p, cg, column, width, align );
-  if ( 4 == column ) {
-    QRect r = mListview->itemRect( this );
-    if ( !r.size().isValid() ) {
-        mListview->ensureItemVisible( this );
-        mListview->repaintContents( FALSE );
-        r = mListview->itemRect( this );
-    }
-    int colWidth = mListview->header()->sectionSize( column );
-    r.setX( mListview->header()->sectionPos( column )
-            - mListview->header()->offset()
-            + colWidth / 2
-            - r.height() / 2
-            - 1 );
-    r.setY( r.y() + 1 );
-    r.setWidth(  r.height() - 2 );
-    r.setHeight( r.height() - 2 );
-    r = QRect( mListview->viewportToContents( r.topLeft() ), r.size() );
+  //Calculate some values to determine the x-position where the checkbox
+  //will be drawn
+  int sectionWidth = listView()->header()->sectionSize( headerSection );
+  int sectionPos = listView()->header()->sectionPos( headerSection );
+  int sectionOffset = sectionWidth / 2 - height() / 4;
 
-    mCBCompress->resize( r.size() );
-    mListview->moveChild( mCBCompress, r.x(), r.y() );
+  //Resize and move the checkbox
+  cb->resize( sectionWidth - sectionOffset - 1, height() - 2 );
+  listView()->moveChild( cb, sectionPos + sectionOffset, itemPos() + 1 );
 
-    QColor bg;
-    if (isSelected())
-      bg = cg.highlight();
-    else
-      bg = cg.base();
-
-    mCBCompress->setPaletteBackgroundColor(bg);
-    mCBCompress->show();
+  //Set the correct background color
+  QColor bg;
+  if ( isSelected() ) {
+    bg = listView()->colorGroup().highlight();
+  } else {
+    bg = listView()->colorGroup().base();
   }
-  if( 5 == column || 6 == column ) {
-    QRect r = mListview->itemRect( this );
-    if ( !r.size().isValid() ) {
-        mListview->ensureItemVisible( this );
-        mListview->repaintContents( FALSE );
-        r = mListview->itemRect( this );
-    }
-    int colWidth = mListview->header()->sectionSize( column );
-    r.setX( mListview->header()->sectionPos( column )
-            + colWidth / 2
-            - r.height() / 2
-            - 1 );
-    r.setY( r.y() + 1 );
-    r.setWidth(  r.height() - 2 );
-    r.setHeight( r.height() - 2 );
-    r = QRect( mListview->viewportToContents( r.topLeft() ), r.size() );
+  cb->setPaletteBackgroundColor( bg );
+}
 
-    QCheckBox* cb = (5 == column) ? mCBEncrypt : mCBSign;
-    cb->resize( r.size() );
-    mListview->moveChild( cb, r.x(), r.y() );
+void KMAtmListViewItem::updateAllCheckBoxes()
+{
+  updateCheckBox( 4, mCBCompress );
+  updateCheckBox( 5, mCBEncrypt );
+  updateCheckBox( 6, mCBSign );
+}
 
-    QColor bg;
-    if (isSelected())
-      bg = cg.highlight();
-    else
-      bg = cg.base();
-
-    bool enabled = (5 == column) ? mCBEncryptEnabled : mCBSignEnabled;
-    cb->setPaletteBackgroundColor(bg);
-    if (enabled) cb->show();
+// Each time a cell is about to be painted, the item's checkboxes are updated
+// as well. This is necessary to keep the positions of the checkboxes
+// up-to-date. The signals which are, in the constructor of this class,
+// connected to the update slots are not sufficent because unfortunatly,
+// Qt does not provide a signal for changed item positions, e.g. during
+// deleting or adding items. The problem with this is that this function does
+// not catch updates which are off-screen, which means under some circumstances
+// checkboxes have invalid positions. This should not happen anymore, but was
+// the cause of bug 113458. Therefore, both the signals connected in the
+// constructor and this function are necessary to keep the checkboxes'
+// positions in sync, and hopefully is enough.
+void KMAtmListViewItem::paintCell ( QPainter * p, const QColorGroup &cg,
+                                    int column, int width, int align )
+{
+  switch ( column ) {
+    case 4: updateCheckBox( 4, mCBCompress ); break;
+    case 5: updateCheckBox( 5, mCBEncrypt ); break;
+    case 6: updateCheckBox( 6, mCBSign ); break;
   }
+
+  QListViewItem::paintCell( p, cg, column, width, align );
 }
 
-void KMAtmListViewItem::enableCryptoCBs(bool on)
+int KMAtmListViewItem::compare( QListViewItem *i, int col, bool ascending ) const
 {
-  if( mCBEncrypt ) {
-    mCBEncryptEnabled = on;
-    mCBEncrypt->setEnabled( on );
-    mCBEncrypt->setShown( on );
+  if ( col != 1 ) {
+    return QListViewItem::compare( i, col, ascending );
   }
-  if( mCBSign ) {
-    mCBSignEnabled = on;
-    mCBSign->setEnabled( on );
-    mCBSign->setShown( on );
-  }
+
+  return mAttachmentSize -
+    (static_cast<KMAtmListViewItem*>(i))->mAttachmentSize;
 }
 
-void KMAtmListViewItem::setEncrypt(bool on)
+void KMAtmListViewItem::enableCryptoCBs( bool on )
 {
-  if( mCBEncrypt )
+  // Show/Hide the appropriate checkboxes.
+  // This should not be necessary because the caller hides the columns
+  // containing the checkboxes anyway.
+  mCBEncrypt->setShown( on );
+  mCBSign->setShown( on );
+}
+
+void KMAtmListViewItem::setEncrypt( bool on )
+{
+  if ( mCBEncrypt ) {
     mCBEncrypt->setChecked( on );
+  }
 }
 
 bool KMAtmListViewItem::isEncrypt()
 {
-  if( mCBEncrypt )
+  if ( mCBEncrypt ) {
     return mCBEncrypt->isChecked();
-  else
+  } else {
     return false;
+  }
 }
 
-void KMAtmListViewItem::setSign(bool on)
+void KMAtmListViewItem::setSign( bool on )
 {
-  if( mCBSign )
+  if ( mCBSign ) {
     mCBSign->setChecked( on );
+  }
 }
 
 bool KMAtmListViewItem::isSign()
 {
-  if( mCBSign )
+  if ( mCBSign ) {
     return mCBSign->isChecked();
-  else
+  } else {
     return false;
+  }
 }
 
-void KMAtmListViewItem::setCompress(bool on)
+void KMAtmListViewItem::setCompress( bool on )
 {
   mCBCompress->setChecked( on );
 }
@@ -277,10 +152,24 @@
 
 void KMAtmListViewItem::slotCompress()
 {
-    if ( mCBCompress->isChecked() )
-        emit compress( itemPos() );
-    else
-        emit uncompress( itemPos() );
+  if ( mCBCompress->isChecked() ) {
+    emit compress( itemPos() );
+  } else {
+    emit uncompress( itemPos() );
+  }
 }
 
+// Update the item's checkboxes when the position of those change
+// due to different column positions
+void KMAtmListViewItem::slotHeaderChange ( int, int, int )
+{
+  updateAllCheckBoxes();
+}
+
+//Update the item's checkboxes when the list is being sorted
+void KMAtmListViewItem::slotHeaderClick( int )
+{
+  updateAllCheckBoxes();
+}
+
 #include "kmatmlistview.moc"
Index: kmail/kmfoldercachedimap.cpp
===================================================================
--- kmail/kmfoldercachedimap.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmfoldercachedimap.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -75,6 +75,7 @@
 #include <globalsettings.h>
 
 #define UIDCACHE_VERSION 1
+#define MAIL_LOSS_DEBUGGING 0
 
 static QString incidencesForToString( KMFolderCachedImap::IncidencesFor r ) {
   switch (r) {
@@ -146,6 +147,7 @@
     mIsSelected( false ),
     mCheckFlags( true ), mReadOnly( false ), mAccount( NULL ), uidMapDirty( true ),
     uidWriteTimer( -1 ), mLastUid( 0 ), mTentativeHighestUid( 0 ),
+    mFoundAnIMAPDigest( false ),
     mUserRights( 0 ), mSilentUpload( false ),
     mFolderRemoved( false ),
     /*mHoldSyncs( false ),*/ mRecurse( true ),
@@ -153,7 +155,18 @@
     mIncidencesForChanged( false ), mPersonalNamespacesCheckDone( true )
 {
   setUidValidity("");
-  readUidCache();
+  // if we fail to read a uid file but there is one, nuke it
+  if ( readUidCache() == -1 ) {
+    if ( QFile::exists( uidCacheLocation() ) ) {
+        KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be read. There "
+              "could be a problem with file system permission, or it is corrupted."
+              ).arg( folder->prettyURL() ) );
+        // try to unlink it, in case it was corruped. If it couldn't be read
+        // because of permissions, this will fail, which is fine
+        unlink( QFile::encodeName( uidCacheLocation() ) );
+    }
+  }
 
   mProgress = 0;
 }
@@ -306,7 +319,7 @@
   if( uidValidity().isEmpty() || uidValidity() == "INVALID" ) {
     // No info from the server yet, remove the file.
     if( QFile::exists( uidCacheLocation() ) )
-      unlink( QFile::encodeName( uidCacheLocation() ) );
+      return unlink( QFile::encodeName( uidCacheLocation() ) );
     return 0;
   }
 
@@ -317,17 +330,23 @@
     str << uidValidity() << endl;
     str << lastUid() << endl;
     uidcache.flush();
-    fsync( uidcache.handle() ); /* this is probably overkill */
-    uidcache.close();
-    return 0;
-  } else {
-    return errno; /* does QFile set errno? */
+    if ( uidcache.status() == IO_Ok ) {
+      fsync( uidcache.handle() ); /* this is probably overkill */
+      uidcache.close();
+      if ( uidcache.status() == IO_Ok )
+        return 0;
+    }
   }
+  KMessageBox::error( 0,
+        i18n( "The UID cache file for folder %1 could not be written. There "
+              "could be a problem with file system permission." ).arg( folder()->prettyURL() ) );
+
+  return -1;
 }
 
 void KMFolderCachedImap::reloadUidMap()
 {
-  kdDebug(5006) << "Reloading Uid Map " << endl;
+  //kdDebug(5006) << "Reloading Uid Map " << endl;
   uidMap.clear();
   open();
   for( int i = 0; i < count(); ++i ) {
@@ -448,7 +467,8 @@
 {
   killTimer( uidWriteTimer );
   uidWriteTimer = -1;
-  writeUidCache();
+  if ( writeUidCache() == -1 )
+    unlink( QFile::encodeName( uidCacheLocation() ) );
 }
 
 ulong KMFolderCachedImap::lastUid()
@@ -467,10 +487,22 @@
   QMap<ulong,int>::Iterator it = uidMap.find( uid );
   if( it != uidMap.end() ) {
     KMMsgBase *msg = getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
+    kdDebug(5006) << "UID " << uid << " is supposed to be in the map" << endl;
+    kdDebug(5006) << "UID's index is to be " << *it << endl;
+    kdDebug(5006) << "There is a message there? " << (msg != 0) << endl;
+    if ( msg ) {
+      kdDebug(5006) << "Its UID is: " << msg->UID() << endl;
+    }
+#endif
+
     if( msg && msg->UID() == uid )
       return msg;
+    kdDebug(5006) << "########## Didn't find uid: " << uid << "in cache athough it's supposed to be there!" << endl;
   } else {
+#if MAIL_LOSS_DEBUGGING
     kdDebug(5006) << "Didn't find uid: " << uid << "in cache!" << endl;
+#endif
   }
   // Not found by now
  // if( mapReloaded )
@@ -482,8 +514,10 @@
   if( it != uidMap.end() )
     // Since the uid map is just rebuilt, no need for the sanity check
     return getMsgBase( *it );
+#if MAIL_LOSS_DEBUGGING
   else
     kdDebug(5006) << "Reloaded, but stil didn't find uid: " << uid << endl;
+#endif
   // Then it's not here
   return 0;
 }
@@ -841,9 +875,14 @@
            to be deleted on the server has been deleted, adjust our local notion of the
            highes uid seen thus far. */
         slotUpdateLastUid();
-        if( mLastUid == 0 && uidWriteTimer == -1 )
+        if( mLastUid == 0 && uidWriteTimer == -1 ) {
           // This is probably a new and empty folder. Write the UID cache
-          writeUidCache();
+          if ( writeUidCache() == -1 ) {
+            resetSyncState();
+            emit folderComplete( this, false );
+            return;
+          }
+        }
       }
     }
 
@@ -1209,9 +1248,10 @@
 void KMFolderCachedImap::slotImapStatusChanged(KMFolder* folder, const QString&, bool cont)
 {
   if ( mSyncState == SYNC_STATE_INITIAL ){
-      kdDebug(5006) << "IMAP status changed but reset " << endl;
+      //kdDebug(5006) << "IMAP status changed but reset " << endl;
       return; // we were reset
   }
+  //kdDebug(5006) << "IMAP status changed for folder: " << folder->prettyURL() << endl;
   if ( folder->storage() == this ) {
     --mStatusFlagsJobs;
     if ( mStatusFlagsJobs == 0 || !cont ) // done or aborting
@@ -1220,6 +1260,7 @@
     if ( mStatusFlagsJobs == 0 && cont ) {
       mProgress += 5;
       serverSyncInternal();
+      //kdDebug(5006) << "Proceeding with mailcheck." << endl;
     }
   }
 }
@@ -1288,15 +1329,24 @@
   // them one by one because the index list can get resized under
   // us. So use msg pointers instead
 
+  QStringList uids;
   QMap<ulong,int>::const_iterator it = uidMap.constBegin();
   for( ; it != uidMap.end(); it++ ) {
     ulong uid ( it.key() );
-    if( uid!=0 && !uidsOnServer.find( uid ) )
+    if( uid!=0 && !uidsOnServer.find( uid ) ) {
+      uids << QString::number( uid );
       msgsForDeletion.append( getMsg( *it ) );
+    }
   }
 
   if( !msgsForDeletion.isEmpty() ) {
-    removeMsg( msgsForDeletion );
+#if MAIL_LOSS_DEBUGGING
+      if ( KMessageBox::warningYesNo(
+             0, i18n( "<qt><p>Mails on the server in folder <b>%1</b> were deleted. "
+                 "Do you want to delete them locally?<br>UIDs: %2</p></qt>" )
+             .arg( folder()->prettyURL() ).arg( uids.join(",") ) ) == KMessageBox::Yes )
+#endif
+        removeMsg( msgsForDeletion );
   }
 
   /* Delete messages from the server that we dont have anymore */
@@ -1370,6 +1420,8 @@
   uidsForDeletionOnServer.clear();
   mMsgsForDownload.clear();
   mUidsForDownload.clear();
+  // listing is only considered successful if saw a syntactically correct imapdigest
+  mFoundAnIMAPDigest = false;
 
   CachedImapJob* job = new CachedImapJob( FolderJob::tListMessages, this );
   connect( job, SIGNAL( result(KMail::FolderJob *) ),
@@ -1415,6 +1467,7 @@
       setReadOnly( access == "Read only" );
     }
     (*it).cdata.remove(0, pos);
+    mFoundAnIMAPDigest = true;
   }
   pos = (*it).cdata.find("\r\n--IMAPDIGEST", 1);
   // Start with something largish when rebuilding the cache
@@ -1432,7 +1485,7 @@
       if( uid != 0 ) {
         if ( uidsOnServer.count() == uidsOnServer.size() ) {
           uidsOnServer.resize( KMail::nextPrime( uidsOnServer.size() * 2 ) );
-          kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
+          //kdDebug( 5006 ) << "Resizing to: " << uidsOnServer.size() << endl;
         }
         uidsOnServer.insert( uid, &v );
       }
@@ -1451,7 +1504,9 @@
         KMMsgBase *existingMessage = findByUID(uid);
         if( !existingMessage ) {
           if ( mUserRights <= 0 || ( mUserRights & KMail::ACLJobs::Delete ) ) {
-            // kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#if MAIL_LOSS_DEBUGGING
+            kdDebug(5006) << "message with uid " << uid << " is gone from local cache. Must be deleted on server!!!" << endl;
+#endif
             uidsForDeletionOnServer << uid;
           } else {
             redownload = true;
@@ -1490,6 +1545,13 @@
 void KMFolderCachedImap::getMessagesResult( KMail::FolderJob *job, bool lastSet )
 {
   mProgress += 10;
+  if ( !job->error() && !mFoundAnIMAPDigest ) {
+      kdWarning(5006) << "######## Folderlisting did not complete, but there was no error! "
+          "Aborting sync of folder: " << folder()->prettyURL() << endl;
+#if MAIL_LOSS_DEBUGGING
+      kmkernel->emergencyExit( i18n("Folder listing failed in interesting ways." ) );
+#endif
+  }
   if( job->error() ) { // error listing messages but the user chose to continue
     mContentState = imapNoInformation;
     mSyncState = SYNC_STATE_HANDLE_INBOX; // be sure not to continue in this folder
@@ -1741,7 +1803,7 @@
   KMFolderNode *node;
   bool root = ( this == mAccount->rootFolder() );
   if ( root && !mAccount->hasInbox() ) {
-    kdDebug(5006) << "check INBOX" << endl;
+    //kdDebug(5006) << "check INBOX" << endl;
     // create the INBOX
     for (node = folder()->child()->first(); node; node = folder()->child()->next())
       if (!node->isDir() && node->name() == "INBOX") break;
@@ -2216,7 +2278,9 @@
 void
 KMFolderCachedImap::slotAnnotationChanged( const QString& entry, const QString& attribute, const QString& value )
 {
-  kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
+  Q_UNUSED( attribute );
+  Q_UNUSED( value );
+  //kdDebug(5006) << k_funcinfo << entry << " " << attribute << " " << value << endl;
   if ( entry == KOLAB_FOLDERTYPE )
     mAnnotationFolderTypeChanged = false;
   else if ( entry == KOLAB_INCIDENCESFOR ) {
Index: kmail/eventsrc
===================================================================
--- kmail/eventsrc	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/eventsrc	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -9,6 +9,7 @@
 
 [new-mail-arrived]
 Name=New Mail Arrived
+Name[ar]=وصل بريد جديد
 Name[bg]=Имате ново писмо
 Name[br]=Deuet eo ur postel nevez
 Name[bs]=Stigla vam je nova pošta
@@ -55,6 +56,7 @@
 Name[zh_CN]=新邮件到达
 Name[zh_TW]=您有新郵件
 Comment=New mail arrived
+Comment[ar]=وصل بريد جديد
 Comment[bg]=Имате ново писмо
 Comment[br]=Deuet eo ur postel nevez
 Comment[bs]=Stigla vam je nova pošta
Index: kmail/kmkernel.cpp
===================================================================
--- kmail/kmkernel.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmkernel.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -192,6 +192,7 @@
 bool KMKernel::handleCommandLine( bool noArgsOpensReader )
 {
   QString to, cc, bcc, subj, body;
+  QCStringList customHeaders;
   KURL messageFile;
   KURL::List attachURLs;
   bool mailto = false;
@@ -252,6 +253,8 @@
          attachURLs += KURL( QString::fromLocal8Bit( *it ) );
   }
 
+  customHeaders = args->getOptionList("header");
+
   if (args->isSet("composer"))
     mailto = true;
 
@@ -302,7 +305,7 @@
     viewMessage( messageFile );
   else
     action( mailto, checkMail, to, cc, bcc, subj, body, messageFile,
-            attachURLs );
+            attachURLs, customHeaders );
   return true;
 }
 
@@ -366,7 +369,8 @@
                             const QString &bcc, const QString &subject,
                             const QString &body, int hidden,
                             const KURL &messageFile,
-                            const KURL::List &attachURLs)
+                            const KURL::List &attachURLs,
+                            const QCStringList &customHeaders)
 {
   kdDebug(5006) << "KMKernel::openComposer called" << endl;
   KMMessage *msg = new KMMessage;
@@ -389,6 +393,23 @@
   else if (!body.isEmpty())
     msg->setBody(body.utf8());
 
+  if (!customHeaders.isEmpty())
+  {
+    for ( QCStringList::ConstIterator it = customHeaders.begin() ; it != customHeaders.end() ; ++it )
+      if ( !(*it).isEmpty() )
+      {
+        const int pos = (*it).find( ':' );
+        if ( pos > 0 )
+        {
+          QCString header, value;
+          header = (*it).left( pos ).stripWhiteSpace();
+          value = (*it).mid( pos+1 ).stripWhiteSpace();
+          if ( !header.isEmpty() && !value.isEmpty() )
+            msg->setHeaderField( header, value );
+        }
+      }
+  }
+
   KMail::Composer * cWin = KMail::makeComposer( msg );
   cWin->setCharset("", TRUE);
   for ( KURL::List::ConstIterator it = attachURLs.begin() ; it != attachURLs.end() ; ++it )
@@ -1802,14 +1823,15 @@
                       const QString &cc, const QString &bcc,
                       const QString &subj, const QString &body,
                       const KURL &messageFile,
-                      const KURL::List &attachURLs)
+                      const KURL::List &attachURLs,
+                      const QCStringList &customHeaders)
 {
-  if (mailto)
-    openComposer (to, cc, bcc, subj, body, 0, messageFile, attachURLs);
+  if ( mailto )
+    openComposer( to, cc, bcc, subj, body, 0, messageFile, attachURLs, customHeaders );
   else
     openReader( check );
 
-  if (check)
+  if ( check )
     checkMail();
   //Anything else?
 }
@@ -2247,9 +2269,15 @@
   if ( !Wallet::isEnabled() || walletOpenFailed )
     return 0;
 
+  // find an appropriate parent window for the wallet dialog
+  WId window = 0;
+  if ( qApp->activeWindow() )
+    window = qApp->activeWindow()->winId();
+  else if ( getKMMainWidget() )
+    window = getKMMainWidget()->topLevelWidget()->winId();
+
   delete mWallet;
-  mWallet = Wallet::openWallet( Wallet::NetworkWallet(),
-        getKMMainWidget() ? getKMMainWidget()->topLevelWidget()->winId() : 0 );
+  mWallet = Wallet::openWallet( Wallet::NetworkWallet(), window );
 
   if ( !mWallet ) {
     walletOpenFailed = true;
Index: kmail/headerstyle.cpp
===================================================================
--- kmail/headerstyle.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/headerstyle.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -527,6 +527,40 @@
       userHTML = "&nbsp;";
     }
 
+    if( photoURL.isEmpty() ) {
+      // no photo, look for a Face header
+      QString faceheader = message->headerField( "Face" );
+      if ( !faceheader.isEmpty() ) {
+        QImage faceimage;
+
+        kdDebug( 5006 ) << "Found Face: header" << endl;
+
+        QCString facestring = faceheader.utf8();
+        // Spec says header should be less than 998 bytes
+        // Face: is 5 characters
+        if ( facestring.length() < 993 ) {
+          QByteArray facearray;
+          KCodecs::base64Decode(facestring, facearray);
+    
+          QImage faceimage;
+          if ( faceimage.loadFromData( facearray, "png" ) ) {
+            // Spec says image must be 48x48 pixels
+            if ( (48 == faceimage.width()) && (48 == faceimage.height()) ) {
+              photoURL = imgToDataUrl( faceimage );
+              photoWidth = 48;
+              photoHeight = 48;
+            } else {
+              kdDebug( 5006 ) << "Face: header image is" << faceimage.width() << "by" << faceimage.height() <<"not 48x48 Pixels" << endl;
+            }
+          } else {
+            kdDebug( 5006 ) << "Failed to load decoded png from Face: header" << endl;
+          }
+        } else {
+          kdDebug( 5006 ) << "Face: header too long at " << facestring.length() << endl;
+        }
+      }
+    }
+
     if( photoURL.isEmpty() )
     {
       // no photo, look for a X-Face header
Index: kmail/kmfoldercachedimap.h
===================================================================
--- kmail/kmfoldercachedimap.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmfoldercachedimap.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -445,6 +445,11 @@
       mLastUid. See above for details. */
   ulong mTentativeHighestUid;
 
+  /** Used to determine whether listing messages yielded a sensible result.
+   * Only then is the deletion o messages (which relies on succesful
+   * listing) attempted, during the sync.  */
+  bool mFoundAnIMAPDigest;
+
   int mUserRights;
   ACLList mACLList;
 
Index: kmail/kmmainwidget.cpp
===================================================================
--- kmail/kmmainwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmmainwidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -846,6 +846,10 @@
     }
   }
 
+  // update folder menus in case some mail got filtered to trash/current folder
+  // and we can enable "empty trash/move all to trash" action etc.
+  updateFolderMenu();
+
   if ( !showNotification )
     return;
 
@@ -1013,6 +1017,10 @@
     BroadcastStatus::instance()->setStatusMsg(i18n("Moved all messages to the trash"));
 
   updateMessageActions();
+
+  // Disable empty trash/move all to trash action - we've just deleted/moved all folder
+  // contents.
+  mEmptyFolderAction->setEnabled( false );
 }
 
 
@@ -2601,12 +2609,6 @@
   mToggleTodoAction->setCheckedState( i18n("Remove &To-do Message Mark") );
   mStatusMenu->insert( mToggleTodoAction );
 
-  mToggleSentAction = new KToggleAction(i18n("Mark Message as &Sent"), "kmmsgsent",
-                                 0, this, SLOT(slotSetMsgStatusSent()),
-                                 actionCollection(), "status_sent");
-  mToggleSentAction->setCheckedState( i18n("Remove &Sent Mark") );
-
-
   //----- "Mark Thread" submenu
   mThreadStatusMenu = new KActionMenu ( i18n( "Mark &Thread" ),
                                        actionCollection(), "thread_status" );
@@ -3008,7 +3010,6 @@
 
     if (mFolder && mHeaders && mHeaders->currentMsg()) {
       mToggleTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
-      mToggleSentAction->setChecked(mHeaders->currentMsg()->isSent());
       mToggleFlagAction->setChecked(mHeaders->currentMsg()->isImportant());
       if (thread_actions) {
         mToggleThreadTodoAction->setChecked(mHeaders->currentMsg()->isTodo());
Index: kmail/kmcomposewin.h
===================================================================
--- kmail/kmcomposewin.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmcomposewin.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -398,8 +398,8 @@
   void slotAttachRemove();
   void slotAttachSave();
   void slotAttachProperties();
+  void slotAttachOpenWith();
 
-
   /**
    * Select an email from the addressbook and add it to the line
    * the pressed button belongs to.
@@ -546,9 +546,9 @@
   virtual bool queryExit ();
 
   /**
-   * Open the attachment with the given index.
+   * Open the attachment with the given index and with ("Open with")
    */
-  void openAttach( int index );
+  void openAttach( int index, bool with );
 
   /**
    * View the attachment with the given index.
@@ -649,6 +649,14 @@
    */
   static bool validateAddresses( QWidget * parent, const QString & addresses );
 
+  /**
+   * Sets the transport combobox to @p transport. If @p transport is empty
+   * then the combobox remains unchanged. If @p transport is neither a known transport
+   * nor a custom transport then the combobox is set to the default transport.
+   * @param transport the transport the combobox should be set to
+   */
+  void setTransport( const QString & transport );
+
 private slots:
    /**
     * Compress an attachemnt with the given index
@@ -688,7 +696,7 @@
   QPtrList<QListViewItem> mAtmItemList;
   QPtrList<KMMessagePart> mAtmList;
   QPopupMenu *mAttachMenu;
-  int mOpenId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
+  int mOpenId, mOpenWithId, mViewId, mRemoveId, mSaveAsId, mPropertiesId;
   bool mAutoDeleteMsg;
   bool mSigningAndEncryptionExplicitlyDisabled;
   bool mLastSignActionState, mLastEncryptActionState;
Index: kmail/recipientseditor.h
===================================================================
--- kmail/recipientseditor.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/recipientseditor.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -158,6 +158,7 @@
     void slotTypeModified();
 
   private:
+    friend class RecipientsView;
     QComboBox *mCombo;
     RecipientLineEdit *mEdit;
     QPushButton *mRemoveButton;
@@ -206,6 +207,7 @@
     int setFirstColumnWidth( int );
 
   public slots:
+    void setCompletionMode( KGlobalSettings::Completion );
     RecipientLine *addLine();
 
     void setFocus();
@@ -217,6 +219,7 @@
     void focusUp();
     void focusDown();
     void focusRight();
+    void completionModeChanged( KGlobalSettings::Completion );
 
   protected:
     void viewportResizeEvent( QResizeEvent * );
@@ -237,6 +240,7 @@
     int mLineHeight;
     int mFirstColumnWidth;
     bool mModified;
+    KGlobalSettings::Completion mCompletionMode;
 };
 
 class RecipientsToolTip : public QToolTip
@@ -328,6 +332,11 @@
       */
     int setFirstColumnWidth( int );
 
+    /**
+      * Set completion mode for all lines
+      */
+    void setCompletionMode( KGlobalSettings::Completion );
+
   public slots:
     void setFocus();
     void setFocusTop();
@@ -339,6 +348,7 @@
   signals:
     void focusUp();
     void focusDown();
+    void completionModeChanged( KGlobalSettings::Completion );
 
   protected slots:
     void slotPickedRecipient( const Recipient & );
Index: kmail/kmcomposewin.cpp
===================================================================
--- kmail/kmcomposewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmcomposewin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -255,6 +255,9 @@
     //mBtnFrom = 0;
 
     mRecipientsEditor = new RecipientsEditor( mMainWidget );
+    connect( mRecipientsEditor,
+             SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+             SLOT( slotCompletionModeChanged( KGlobalSettings::Completion ) ) );
 
     mRecipientsEditor->setFocus();
   }
@@ -333,7 +336,7 @@
 
   connect( mAtmListView,
            SIGNAL( doubleClicked( QListViewItem* ) ),
-           SLOT( slotAttachProperties() ) );
+           SLOT( slotAttachOpen() ) );
   connect( mAtmListView,
            SIGNAL( rightButtonPressed( QListViewItem*, const QPoint&, int ) ),
            SLOT( slotAttachPopupMenu( QListViewItem*, const QPoint&, int ) ) );
@@ -581,6 +584,8 @@
     mEdtCc->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
     mEdtBcc->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
   }
+  else
+    mRecipientsEditor->setCompletionMode( (KGlobalSettings::Completion)GlobalSettings::self()->completionMode() );
 
   readColorConfig();
 
@@ -620,18 +625,11 @@
   while ( transportHistory.count() > (uint)GlobalSettings::self()->maxTransportEntries() )
     transportHistory.remove( transportHistory.last() );
   mTransport->insertStringList( transportHistory );
-  if (mBtnTransport->isChecked() && !currentTransport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == currentTransport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( currentTransport );
+  mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+  if ( mBtnTransport->isChecked() ) {
+    setTransport( currentTransport );
   }
 
-  if ( !mBtnTransport->isChecked() ) {
-    mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
-  }
-
   QString fccName = "";
   if ( mBtnFcc->isChecked() ) {
     fccName = GlobalSettings::self()->previousFcc();
@@ -1659,6 +1657,37 @@
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::setTransport( const QString & transport )
+{
+  kdDebug(5006) << "KMComposeWin::setTransport( \"" << transport << "\" )" << endl;
+  // Don't change the transport combobox if transport is empty
+  if ( transport.isEmpty() )
+    return;
+
+  bool transportFound = false;
+  for ( int i = 0; i < mTransport->count(); ++i ) {
+    if ( mTransport->text(i) == transport ) {
+      transportFound = true;
+      mTransport->setCurrentItem(i);
+      kdDebug(5006) << "transport found, it's no. " << i << " in the list" << endl;
+      break;
+    }
+  }
+  if ( !transportFound ) { // unknown transport
+    kdDebug(5006) << "unknown transport \"" << transport << "\"" << endl;
+    if ( transport.startsWith("smtp://") || transport.startsWith("smtps://") ||
+         transport.startsWith("file://") ) {
+      // set custom transport
+      mTransport->setEditText( transport );
+    }
+    else {
+      // neither known nor custom transport -> use default transport
+      mTransport->setCurrentText( GlobalSettings::self()->defaultTransport() );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 void KMComposeWin::setMsg(KMMessage* newMsg, bool mayAutoSign,
                           bool allowDecryption, bool isModified)
 {
@@ -1778,12 +1807,7 @@
 
   QString transport = newMsg->headerField("X-KMail-Transport");
   if (!mBtnTransport->isChecked() && !transport.isEmpty())
-  {
-    for (int i = 0; i < mTransport->count(); i++)
-      if (mTransport->text(i) == transport)
-        mTransport->setCurrentItem(i);
-    mTransport->setEditText( transport );
-  }
+    setTransport( transport );
 
   if (!mBtnFcc->isChecked())
   {
@@ -2254,6 +2278,7 @@
   lvi->setText(1, KIO::convertSize( msgPart->decodedSize()));
   lvi->setText(2, msgPart->contentTransferEncodingStr());
   lvi->setText(3, prettyMimeType(msgPart->typeStr() + "/" + msgPart->subtypeStr()));
+  lvi->setAttachmentSize(msgPart->decodedSize());
 
   if ( loadDefaults ) {
     if( canSignEncryptAttachments() ) {
@@ -2898,6 +2923,8 @@
 
      mOpenId = mAttachMenu->insertItem(i18n("to open", "Open"), this,
                              SLOT(slotAttachOpen()));
+     mOpenWithId = mAttachMenu->insertItem(i18n("Open with..."), this,
+                             SLOT(slotAttachOpenWith()));
      mViewId = mAttachMenu->insertItem(i18n("to view", "View"), this,
                              SLOT(slotAttachView()));
      mRemoveId = mAttachMenu->insertItem(i18n("Remove"), this, SLOT(slotAttachRemove()));
@@ -3142,12 +3169,23 @@
   int i = 0;
   for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
     if ( (*it)->isSelected() ) {
-      openAttach( i );
+      openAttach( i, false );
     }
   }
 }
 
 //-----------------------------------------------------------------------------
+void KMComposeWin::slotAttachOpenWith()
+{
+  int i = 0;
+  for ( QPtrListIterator<QListViewItem> it(mAtmItemList); *it; ++it, ++i ) {
+    if ( (*it)->isSelected() ) {
+      openAttach( i, true );
+    }
+  }
+}
+
+//-----------------------------------------------------------------------------
 bool KMComposeWin::inlineSigningEncryptionSelected() {
   if ( !mSignAction->isChecked() && !mEncryptAction->isChecked() )
     return false;
@@ -3175,7 +3213,7 @@
 }
 
 //-----------------------------------------------------------------------------
-void KMComposeWin::openAttach( int index )
+void KMComposeWin::openAttach( int index, bool with )
 {
   KMMessagePart* msgPart = mAtmList.at(index);
   const QString contentTypeStr =
@@ -3202,7 +3240,7 @@
   KService::Ptr offer =
     KServiceTypeProfile::preferredService( mimetype->name(), "Application" );
 
-  if ( !offer || mimetype->name() == "application/octet-stream" ) {
+  if ( with || !offer || mimetype->name() == "application/octet-stream" ) {
     if ( ( !KRun::displayOpenWithDialog( url, autoDelete ) ) && autoDelete ) {
       QFile::remove(url.path());
     }
@@ -4280,24 +4318,11 @@
     if ( transp.isEmpty() )
     {
       mMsg->removeHeaderField("X-KMail-Transport");
-      transp = mTransport->text(0);
+      transp = GlobalSettings::self()->defaultTransport();
     }
     else
       mMsg->setHeaderField("X-KMail-Transport", transp);
-    bool found = false;
-    int i;
-    for (i = 0; i < mTransport->count(); i++) {
-      if (mTransport->text(i) == transp) {
-        found = true;
-        mTransport->setCurrentItem(i);
-        break;
-      }
-    }
-    if (found == false) {
-      if (i == mTransport->maxCount()) mTransport->setMaxCount(i + 1);
-      mTransport->insertItem(transp,i);
-      mTransport->setCurrentItem(i);
-    }
+    setTransport( transp );
   }
 
   mDictionaryCombo->setCurrentByDictionary( ident.dictionary() );
@@ -4494,7 +4519,8 @@
     mEdtTo->setCompletionMode( mode );
     mEdtCc->setCompletionMode( mode );
     mEdtBcc->setCompletionMode( mode );
-  }
+  }else
+    mRecipientsEditor->setCompletionMode( mode );
 }
 
 void KMComposeWin::slotConfigChanged()
Index: kmail/configuredialog.cpp
===================================================================
--- kmail/configuredialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/configuredialog.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -841,6 +841,8 @@
   QListViewItem *item = mTransportList->selectedItem();
   if ( !item ) return;
 
+  const QString& originalTransport = item->text(0);
+
   QPtrListIterator<KMTransportInfo> it( mTransportInfoList );
   for ( it.toFirst() ; it.current() ; ++it )
     if ( (*it)->name == item->text(0) ) break;
@@ -869,6 +871,24 @@
   // and insert the new name at the position of the old in the list of
   // strings; then broadcast the new list:
   transportNames.insert( transportNames.at( entryLocation ), (*it)->name );
+  const QString& newTransportName = (*it)->name;
+
+  QStringList changedIdents;
+  KPIM::IdentityManager * im = kmkernel->identityManager();
+  for ( KPIM::IdentityManager::Iterator it = im->modifyBegin(); it != im->modifyEnd(); ++it ) {
+    if ( originalTransport == (*it).transport() ) {
+      (*it).setTransport( newTransportName );
+      changedIdents += (*it).identityName();
+    }
+  }
+
+  if ( !changedIdents.isEmpty() ) {
+    QString information = i18n( "This identity has been changed to use the modified transport:",
+                          "These %n identities have been changed to use the modified transport:",
+                          changedIdents.count() );
+    KMessageBox::informationList( this, information, changedIdents );
+  }
+
   emit transportListChanged( transportNames );
   emit changed( true );
 }
@@ -2299,7 +2319,7 @@
   encodings.prepend( i18n( "Auto" ) );
   QStringList::Iterator it( encodings.begin() );
   QStringList::Iterator end( encodings.end() );
-  int i = 0;
+  uint i = 0;
   for( ; it != end; ++it)
   {
     if( KGlobal::charsets()->encodingForName(*it) == currentOverrideEncoding )
Index: kmail/popaccount.cpp
===================================================================
--- kmail/popaccount.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/popaccount.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -489,12 +489,12 @@
     mUidlFinished = TRUE;
 
     if ( mLeaveOnServer && mUidForIdMap.isEmpty() &&
-         mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
-      KMessageBox::sorry(0, i18n("Your POP3 server does not support the UIDL "
-      "command: this command is required to determine, in a reliable way, "
-      "which of the mails on the server KMail has already seen before;\n"
-      "the feature to leave the mails on the server will therefore not "
-      "work properly."));
+        mUidsOfNextSeenMsgsDict.isEmpty() && !idsOfMsgs.isEmpty() ) {
+      KMessageBox::sorry(0, i18n("Your POP3 server (Account: %1) does not support "
+      "the UIDL command: this command is required to determine, in a reliable way, " 
+      "which of the mails on the server KMail has already seen before;\n" 
+      "the feature to leave the mails on the server will therefore not " 
+      "work properly.").arg(NetworkAccount::name()) );
       // An attempt to work around buggy pop servers, these seem to be popular.
       mUidsOfNextSeenMsgsDict = mUidsOfSeenMsgsDict;
     }
Index: kmail/kmfolder.cpp
===================================================================
--- kmail/kmfolder.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmfolder.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -700,6 +700,7 @@
 {
   if (units >= expireNever && units < expireMaxUnits)
     mUnreadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 void KMFolder::setReadExpireAge( int age )
@@ -714,6 +715,7 @@
 {
   if (units >= expireNever && units <= expireMaxUnits)
     mReadExpireUnits = units;
+    mStorage->writeConfig();
 }
 
 
Index: kmail/kmatmlistview.h
===================================================================
--- kmail/kmatmlistview.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmatmlistview.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,5 +1,5 @@
 /* -*- mode: C++; c-file-style: "gnu" -*-
- * KMComposeWin Header File
+ * KMAtmListViewItem Header File
  * Author: Markus Wuebben <markus.wuebben@kde.org>
  */
 #ifndef __KMAIL_KMATMLISTVIEW_H__
@@ -15,48 +15,57 @@
 class KMAtmListViewItem : public QObject, public QListViewItem
 {
   Q_OBJECT
-  friend class ::KMComposeWin;
-  friend class ::MessageComposer;
 
 public:
-  KMAtmListViewItem(QListView * parent);
+  KMAtmListViewItem( QListView *parent );
   virtual ~KMAtmListViewItem();
-  virtual void paintCell( QPainter * p, const QColorGroup & cg,
-                          int column, int width, int align );
 
+  //A custom compare function is needed because the size column is
+  //human-readable and therefore doesn't sort correctly.
+  virtual int compare( QListViewItem *i, int col, bool ascending ) const;
+
+  virtual void paintCell ( QPainter * p, const QColorGroup & cg, int column, int width, int align );
+
   void setUncompressedMimeType( const QCString & type, const QCString & subtype ) {
     mType = type; mSubtype = subtype;
   }
+  void setAttachmentSize( int numBytes ) {
+    mAttachmentSize = numBytes;
+  }
   void uncompressedMimeType( QCString & type, QCString & subtype ) const {
     type = mType; subtype = mSubtype;
   }
-  void setUncompressedCodec( const QCString & codec ) { mCodec = codec; }
+  void setUncompressedCodec( const QCString &codec ) { mCodec = codec; }
   QCString uncompressedCodec() const { return mCodec; }
 
+  void enableCryptoCBs( bool on );
+  void setEncrypt( bool on );
+  bool isEncrypt();
+  void setSign( bool on );
+  bool isSign();
+  void setCompress( bool on );
+  bool isCompress();
+
 signals:
   void compress( int );
   void uncompress( int );
 
-protected:
-  void enableCryptoCBs(bool on);
-  void setEncrypt(bool on);
-  bool isEncrypt();
-  void setSign(bool on);
-  bool isSign();
-  void setCompress(bool on);
-  bool isCompress();
-
 private slots:
   void slotCompress();
+  void slotHeaderChange( int, int, int );
+  void slotHeaderClick( int );
 
+protected:
+
+  void updateCheckBox( int headerSection, QCheckBox *cb );
+  void updateAllCheckBoxes();
+
 private:
-  QListView* mListview;
-  QCheckBox* mCBEncrypt;
-  QCheckBox* mCBSign;
-  QCheckBox* mCBCompress;
-  bool mCBSignEnabled, mCBEncryptEnabled;
+  QCheckBox *mCBEncrypt;
+  QCheckBox *mCBSign;
+  QCheckBox *mCBCompress;
   QCString mType, mSubtype, mCodec;
+  int mAttachmentSize;
 };
 
-
 #endif // __KMAIL_KMATMLISTVIEW_H__
Index: kmail/recipientseditor.cpp
===================================================================
--- kmail/recipientseditor.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/recipientseditor.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -321,6 +321,7 @@
   : QScrollView( parent ), mCurDelLine( 0 ), mModified( false ),
     mFirstColumnWidth( 0 ), mLineHeight( 0 )
 {
+  mCompletionMode = KGlobalSettings::completionMode();
   setHScrollBarMode( AlwaysOff );
   setLineWidth( 0 );
 
@@ -348,6 +349,7 @@
 {
   RecipientLine *line = new RecipientLine( viewport() );
   addChild( line, 0, mLines.count() * mLineHeight );
+  line->mEdit->setCompletionMode( mCompletionMode );
   line->show();
   connect( line, SIGNAL( returnPressed( RecipientLine * ) ),
     SLOT( slotReturnPressed( RecipientLine * ) ) );
@@ -361,6 +363,8 @@
   connect( line, SIGNAL( countChanged() ), SLOT( calculateTotal() ) );
   connect( line, SIGNAL( typeModified( RecipientLine * ) ),
     SLOT( slotTypeModified( RecipientLine * ) ) );
+  connect( line->mEdit, SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+    SLOT( setCompletionMode( KGlobalSettings::Completion ) ) );
 
   if ( mLines.last() ) {
     if ( mLines.count() == 1 ) {
@@ -574,6 +578,23 @@
   return recipients;
 }
 
+void RecipientsView::setCompletionMode ( KGlobalSettings::Completion mode )
+{
+  if ( mCompletionMode == mode )
+    return;
+  mCompletionMode = mode;
+
+  QPtrListIterator<RecipientLine> it( mLines );
+  RecipientLine *line;
+  while( ( line = it.current() ) ) {
+    line->mEdit->blockSignals( true );
+    line->mEdit->setCompletionMode( mode );
+    line->mEdit->blockSignals( false );
+    ++it;
+  }
+  emit completionModeChanged( mode ); //report change to RecipientsEditor
+}
+
 void RecipientsView::removeRecipient( const QString & recipient,
                                       Recipient::Type type )
 {
@@ -804,6 +825,8 @@
   topLayout->addWidget( mRecipientsView );
   connect( mRecipientsView, SIGNAL( focusUp() ), SIGNAL( focusUp() ) );
   connect( mRecipientsView, SIGNAL( focusDown() ), SIGNAL( focusDown() ) );
+  connect( mRecipientsView, SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ),
+    SIGNAL( completionModeChanged( KGlobalSettings::Completion ) ) );
 
   mSideWidget = new SideWidget( mRecipientsView, this );
   topLayout->addWidget( mSideWidget );
@@ -944,4 +967,8 @@
   mSideWidget->pickRecipient();
 }
 
+void RecipientsEditor::setCompletionMode( KGlobalSettings::Completion mode )
+{
+  mRecipientsView->setCompletionMode( mode );
+}
 #include "recipientseditor.moc"
Index: kmail/kmkernel.h
===================================================================
--- kmail/kmkernel.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmkernel.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -96,10 +96,19 @@
   /** returns id of composer if more are opened */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
-                    const KURL &messageFile, const KURL::List &attachURLs);
+                    const KURL &messageFile, const KURL::List &attachURLs,
+                    const QCStringList &customHeaders);
   /** For backward compatibility */
   int openComposer (const QString &to, const QString &cc, const QString &bcc,
                     const QString &subject, const QString &body, int hidden,
+                    const KURL &messageFile, const KURL::List &attachURLs)
+  {
+    QCStringList noCustomHeaders;
+    return openComposer(to, cc, bcc, subject, body, hidden, messageFile, attachURLs, noCustomHeaders);
+  }
+  /** For backward compatibility */
+  int openComposer (const QString &to, const QString &cc, const QString &bcc,
+                    const QString &subject, const QString &body, int hidden,
                     const KURL &messageFile, const KURL& attachURL)
   {
     return openComposer(to, cc, bcc, subject, body, hidden, messageFile, KURL::List(attachURL));
@@ -245,7 +254,8 @@
   void setFirstInstance(bool value) { the_firstInstance = value; }
   void action (bool mailto, bool check, const QString &to, const QString &cc,
                const QString &bcc, const QString &subj, const QString &body,
-	       const KURL &messageFile, const KURL::List &attach);
+               const KURL &messageFile, const KURL::List &attach,
+               const QCStringList &customHeaders);
   void byteArrayToRemoteFile(const QByteArray&, const KURL&,
 			     bool overwrite = FALSE);
   bool folderIsDraftOrOutbox(const KMFolder *);
Index: kmail/Mainpage.dox
===================================================================
--- kmail/Mainpage.dox	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/Mainpage.dox	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -793,7 +793,7 @@
 
   - @em BodyPartFormatter
 	the formatter interface. Contains a single method format()
-	that takes a BodyPart to process and a HTMLWriter to write the
+	that takes a BodyPart to process and an HTMLWriter to write the
 	generated HTML to and returns a result code with which it can
 	request more information or delegate the formatting back to
 	some default processor. BodyPartFormatters are meant to be
Index: kmail/kmmainwidget.h
===================================================================
--- kmail/kmmainwidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmmainwidget.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -428,7 +428,6 @@
   KToggleAction *mToggleThreadTodoAction;
   KToggleAction *mToggleThreadFlagAction;
   KToggleAction *mToggleTodoAction;
-  KToggleAction *mToggleSentAction;
   KToggleAction *mToggleFlagAction;
 
   KToggleAction *mWatchThreadAction, *mIgnoreThreadAction;
Index: kmail/objecttreeparser.cpp
===================================================================
--- kmail/objecttreeparser.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/objecttreeparser.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1734,6 +1734,7 @@
 
     QString comment = msgPart->contentDescription();
     comment = KMMessage::quoteHtmlChars( comment, true );
+    if ( label == comment ) comment = QString::null;
 
     QString fileName = mReader->writeMessagePartToTempFile( msgPart, partNum );
 
Index: kmail/kmail_config_accounts.desktop
===================================================================
--- kmail/kmail_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kmail/kmail_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KMail
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
@@ -61,6 +62,7 @@
 Name[zh_CN]=账户
 Name[zh_TW]=帳號
 Comment=Setup for Sending and Receiving Messages
+Comment[ar]=تعيينات إرسال و إستقبال الرسائل
 Comment[bg]=Настройки на мрежата, сървърите и сметките
 Comment[bs]=Postavke za slanje i prijem poruka
 Comment[ca]=Configuració per enviar i rebre missatges
Index: knode/articlewidget.h
===================================================================
--- knode/articlewidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ knode/articlewidget.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -145,7 +145,7 @@
       FancyFormatting = 2,
       AllowROT13 = 4
     };
-    /// convert the given string into a HTML string
+    /// convert the given string into an HTML string
     QString toHtmlString( const QString &line, int flags = ParseURL );
     /// convert the given image into a data:/ URL
     static QString imgToDataUrl( const QImage &image, const char* fmt );
Index: knode/knode_config_accounts.desktop
===================================================================
--- knode/knode_config_accounts.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ knode/knode_config_accounts.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -13,6 +13,7 @@
 X-KDE-CfgDlgHierarchy=KNode
 
 Name=Accounts
+Name[ar]=الحسابات
 Name[be]=Рахункі
 Name[bg]=Сметки
 Name[br]=Kontoù
Index: knode/KNode.desktop
===================================================================
--- knode/KNode.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ knode/KNode.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -42,7 +42,7 @@
 GenericName[id]=Pembaca Berita
 GenericName[is]=Fréttaforrit
 GenericName[it]=Lettore newsgroup
-GenericName[ja]=ニュースリーダ
+GenericName[ja]=ニュースリーダー
 GenericName[km]=កម្មវិធី​អាន​ព័ត៌មាន
 GenericName[lt]=Naujienų skaityklė
 GenericName[lv]=Ziņu Lasītājs
Index: kioslaves/sieve/draft-showalter-sieve-vacation-04.txt
===================================================================
--- kioslaves/sieve/draft-showalter-sieve-vacation-04.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-showalter-sieve-vacation-04.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,396 +1 @@
-
-
-
-
-
-
-Network Working Group                                       T. Showalter
-Internet Draft: Sieve: Vacation Extension                      Mirapoint
-Document: draft-showalter-sieve-vacation-04.txt           August 8, 2000
-Expire in six months
-
-
-                       Sieve: Vacation Extension
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is in full conformance with
-   all provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as Internet-
-   Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six months
-   and may be updated, replaced, or obsoleted by other documents at any
-   time.  It is inappropriate to use Internet-Drafts as reference
-   material or to cite them other than as "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/ietf/1id-abstracts.txt
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-Copyright
-
-   Copyright (C) The Internet Society 2000.  All Rights Reserved.
-
-Abstract
-
-   This document describes an extension to the Sieve mail filtering
-   language for an autoresponder similar to that of the Unix "vacation"
-   command for replying to messages with certain safety features to
-   prevent problems.
-
-
-
-
-
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 1]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-0. Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-0.1. Discussion
-
-   This draft is intended to be an extension to the Sieve mail filtering
-   language, avaliable from the Internet-Drafts repository as
-   <ftp://ftp.ietf.org/internet-drafts/draft-showalter-sieve-10.txt>
-   (where 10 is the version number, which is currently 10).
-
-   This draft and the Sieve language itself are being discussed on the
-   MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-   requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-   email message with the word "subscribe" in the body).  More
-   information on the mailing list along with a WWW archive of back
-   messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-1. Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE] for
-   notification that messages will not be immediately answered.
-
-   Conventions for notations are as in [SIEVE] section 1.1.
-
-   The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", "CAN", and
-   "MAY" in this document are to be interpreted as defined in
-   [KEYWORDS].
-
-2. Capability Identifier
-
-   Sieve implementations that implement vacation have an identifier of
-   "vacation" for use with the capability mechanism.
-
-3. Vacation Action
-
-   Syntax:   vacation [":days" number] [":addresses" string-list]
-             [":subject" string] [":mime"] <reason: string>
-
-   The "vacation" action implements a vacation autoresponder similar to
-   the vacation command  available under many versions of Unix.  Its
-   purpose is to provide correspondents with notification that the user
-   is away for an extended period of time and that they should not
-   expect quick responses.
-
-   "Vacation" is used to respond to a message with another message.
-   Vacation's messages are always addressed to the Return-Path address
-
-
-
-Showalter                 Expire in Six Months                  [Page 2]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   (that is, the envelope from address) of the message being responded
-   to.
-
-3.1. Days Parameter
-
-   The ":days" argument is used to specify the period in which addresses
-   are kept and are not responded to, and is always specified in days.
-   The minimum value used for this parameter is 1.  Sites MAY define a
-   different minimum value.  Sites MAY also define a maximum days value,
-   which MUST be greater than 7, and SHOULD be greater than 30.
-
-   If ":days" is omitted, the default value is either 7 or the minimum
-   value (as defined above), whichever is greater.
-
-   If the parameter given to ":days" is less than the minimum value,
-   then the minimum value is used instead.
-
-   If ":days" exceeds the site-defined maximum, the site-defined maximum
-   is used instead.
-
-3.2. Previous Response Tracking
-
-   "Vacation" keeps track of all of the addresses that it has responded
-   to in some period (as specified by the :days optional argument).  If
-   vacation has not previously responded to this address within that
-   time period, it sends the "reason" argument to the Return-Path
-   address of the message that is being responded to.
-
-   Vacation responses are not just per address, but are per address per
-   vacation command.  For instance, If coyote@desert sends mail to
-   roadrunner@acme, once with the subject "Cyrus bug" and once with the
-   subject "come over for dinner", and roadrunner@acme has the script
-   below, coyote@desert would receive two responses, once with the first
-   message, once with the second.
-
-   Example:  require "vacation";
-             if subject :contains "cyrus" {
-                        vacation "I'm out -- send mail to cyrus-bugs";
-             } else {
-                        vacation "I'm out -- call me at 304 555 1212";
-             }
-
-
-   Note that coyote@desert gets the second message despite having gotten
-   the first one because separate vacation responses have been
-   triggered.  This behavior is REQUIRED.
-
-   If a sieve script changes, implementations MAY reset the records of
-
-
-
-Showalter                 Expire in Six Months                  [Page 3]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   who has been responded to and when they have been responded to.
-   Alternatively, implementations can store records of who has received
-   which message, perhaps by storing a hash of the message and the
-   recipient.
-
-3.3. Subject Parameter
-
-   Users can specify the subject of the reply with the ":subject"
-   parameter.  If the :subject parameter is not supplied, then the
-   subject is generated as follows: The subject is set to the characters
-   "Re: " followed by the original subject with all leading occurrence
-   of the characters "Re: " stripped off.
-
-3.4. MIME Parameter
-
-   The ":mime" parameter, if supplied, specifies that the reason string
-   is, in fact, a MIME part, including MIME headers (see section 2.4.2.4
-   of [SIEVE]).
-
-   If the optional :mime parameter is not supplied, the reason string is
-   considered to be a UTF-8 string.
-
-3.5. In-Reply-To
-
-   Replies MUST have the In-Reply-To field set to the Message-ID of the
-   original message.
-
-3.6. Address Parameter and Limiting Replies to Personal Messages
-
-   "Vacation" MUST NOT respond to a message unless the user's email
-   address is in the "To", "Cc", or "Bcc" line of the original message.
-   Implementations are assumed to know the user's email address, but
-   users may have additional addresses beyond the control of the local
-   mail system.
-
-   Users can supply additional mail addresses that are theirs with the
-   ":addresses" argument, which takes a string-list listing additional
-   addresses that a user might have.  These addresses are considered in
-   addition to the addresses that the implementation knows.
-
-3.7. Restricting Replies to Automated Processes and Mailing Lists
-
-   Implementations MUST have a list of addresses that "vacation" MUST
-   NOT send mail to.  However, the contents of this list are
-   implementation defined.  The purpose of this list is to stop mail
-   from going to addresses used by system daemons that would not care if
-   the user is actually reading her mail.
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 4]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-   Implementations are encouraged, however, to include well-known
-   addresses like "MAILER-DAEMON", "LISTSERV", "majordomo", and other
-   addresses typically used only by automated systems.  Additionally,
-   addresses ending in "-request" or beginning in "owner-", i.e.,
-   reserved for mailing list software, are also suggested.
-
-   Implementors may take guidance from [MAILBOXNAMES], but should be
-   careful.  Some addresses, like "POSTMASTER", are generally actually
-   managed by people, and people do care if the user is going to be
-   unavailable.
-
-   Implementations SHOULD NOT not to respond to any message with a
-   header that begins with "List-".
-
-3.8. Interaction with Other Sieve Actions
-
-   Vacation does not affect the implicit keep.
-
-   Vacation can only be executed once per script.  If vacation  is  used
-   with another vacation, the script fails.
-
-   Implementations MUST NOT consider vacation used with  discard,  keep,
-   fileinto, or redirect an error.
-
-3.9. Examples
-
-   Here is a simple use of vacation.
-
-   Example:  require "vacation";
-             vacation :days 23
-                :addresses                           ["tjs@example.edu",
-                "ts4z@landru.example.edu"]
-                "I'm away until October 19.
-                If it's an emergency, call 911, I guess." ;
-
-   By mingling vacation with other rules, users can  do  something  more
-   selective.
-
-   Example:  require "vacation";
-             if header :contains "from" "boss@example.edu" {
-                redirect "pleeb@isp.example.org";
-             } else {
-                vacation "Sorry, I'm away, I'll read your message
-                   when I get around to it.";
-             }
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 5]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-4. Security Considerations
-   It is critical that implementations correctly implement the
-   limitations described above.  Replies MUST NOT be sent out in
-   response to messages not sent directly to the user, and replies MUST
-   NOT be sent out more often than the :days argument states.
-
-5. Author's Address
-
-   Tim Showalter
-   Mirapoint, Inc.
-   909 Hermosa Court
-   Sunnyvale, CA 94085
-
-   E-Mail: tjs@mirapoint.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 6]
-
-Internet DRAFT         Sieve: Vacation Extension          August 8, 2000
-
-
-Appendix A.  References
-
-   [IMAIL] Crocker, D., "Standard for the Format of ARPA  Internet  Text
-   Messages", STD 11, RFC 822, University of Delaware, August 1982.
-
-   [KEYWORDS] Bradner, S., "Key  words  for  use  in  RFCs  to  Indicate
-   Requirement Levels", RFC 2119, Harvard University, March 1997.
-
-   [MAILBOXNAMES] Crocker, D. "Mailbox Names for Common Services, Roles,
-   and Functions", RFC 2142, Internet Mail Consortium, May, 1997.
-
-   [MIME] Freed, N., and  N.  Borenstein,  "Multipurpose  Internet  Mail
-   Extensions  (MIME)  Part One: Format of Internet Message Bodies", RFC
-   2045, Innosoft and First Virtual, November 1996.
-
-   [SIEVE]  Showalter,  T.,   "Sieve:  A   Mail   Filtering   Language",
-   Mirapoint, Inc., Work in Progress.
-
-Appendix B. Full Copyright Statement
-
-   Copyright (C) The Internet Society 2000. All Rights Reserved.
-
-   This document and translations of it may be copied and  furnished  to
-   others,  and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be  prepared,  copied,  published
-   and  distributed,  in  whole  or  in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included  on  all  such  copies  and derivative works.  However, this
-   document itself may not be modified in any way, such as  by  removing
-   the  copyright  notice or references to the Internet Society or other
-   Internet  organizations,  except  as  needed  for  the   purpose   of
-   developing  Internet  standards  in  which  case  the  procedures for
-   copyrights  defined  in  the  Internet  Standards  process  must   be
-   followed,  or  as  required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will  not  be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on  an
-   "AS  IS"  basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS  OR  IMPLIED,  INCLUDING
-   BUT  NOT  LIMITED  TO  ANY  WARRANTY  THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS  OR  ANY  IMPLIED  WARRANTIES  OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-Showalter                 Expire in Six Months                  [Page 7]
-
-
+http://ktown.kde.org/~dirk/sieve/draft-showalter-sieve-vacation-04.txt
Index: kioslaves/sieve/draft-murchison-sieve-regex-06.txt
===================================================================
--- kioslaves/sieve/draft-murchison-sieve-regex-06.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-murchison-sieve-regex-06.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,452 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                        K. Murchison
-Document: draft-murchison-sieve-regex-06.txt           Oceana Matrix Ltd.
-Expires January 5, 2003                                      30 June 2002
-
-
-                    Sieve -- Regular Expression Extension
-
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are working
-    documents of the Internet Engineering Task Force (IETF), its areas,
-    and its working groups.  Note that other groups may also distribute
-    working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six months
-    and may be updated, replaced, or obsoleted by other documents at any
-    time.  It is inappropriate to use Internet-Drafts as reference
-    material or to cite them other than as "work in progress."
-
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-Copyright Notice
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-
-Abstract
-
-    In some cases, it is desirable to have a string matching mechanism
-    which is more powerful than a simple exact match, a substring match
-    or a glob-style wildcard match.  The regular expression matching
-    mechanism defined in this draft should allow users to isolate just
-    about any string or address in a message header or envelope.
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 1]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Copyright Notice . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-0.     Meta-information on this draft  . . . . . . . . . . . . . . .   3
-
-0.1.   Discussion  . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.   Noted Changes . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.1  since -05 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.2  since -04 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.3.   Open Issues . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   4
-
-3.     Regex Match Type  . . . . . . . . . . . . . . . . . . . . . .   4
-
-4.     Security Considerations . . . . . . . . . . . . . . . . . . .   6
-
-5.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   6
-
-6.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix A.  References  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix B.  Full Copyright Statement  . . . . . . . . . . . . . . .   8
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 2]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-
-0.     Meta-information on this draft
-
-    This information is intended to facilitate discussion.  It will be
-    removed when this document leaves the Internet-Draft stage.
-
-
-0.1.   Discussion
-
-    This draft is intended to be an extension to the Sieve mail filtering
-    language, available from the RFC repository as
-    <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-    This draft and the Sieve language itself are being discussed on the
-    MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-    requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-    email message with the word "subscribe" in the body).  More
-    information on the mailing list along with a WWW archive of back
-    messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.   Noted Changes
-
-
-0.2.1  since -05
-
-    Added open issue regarding localization/internationalization.
-
-    Added that implementations SHOULD reject regexes not supported by
-    this extension.
-
-    Editorial changes.
-
-
-0.2.2  since -04
-
-    Editorial changes.
-
-
-0.3.   Open Issues
-
-    The major open issue with this draft is what to do, if anything,
-    about localization/internationalization.  Are [POSIX.2] collating
-    sequences and character equivalents sufficient?
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 3]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-1.  Introduction
-
-    This is an extension to the Sieve language defined by [SIEVE] for
-    comparing strings to regular expressions.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "regex".
-
-
-3.  Regex Match Type
-
-    Commands that support matching may take the optional tagged argument
-    ":regex" to specify that a regular expression match should be
-    performed.  The ":regex" match type is subject to the same rules and
-    restrictions as the standard match types defined in [SIEVE].  For
-    convenience, the "MATCH-TYPE" syntax element defined in [SIEVE] is
-    augmented here as follows:
-
-         MATCH-TYPE  =/  ":regex"
-
-    Example:
-
-          require "regex";
-
-          # Try to catch unsolicited email.
-          if anyof (
-            # if a message is not to me (with optional +detail),
-            not address :regex ["to", "cc", "bcc"]
-              "me(\\+.*)?@company\\.com",
-
-            # or the subject is all uppercase (no lowercase)
-            header :regex :comparator "i;octet" "subject"
-              "^[^:lower:]+$" ) {
-
-            discard;     # junk it
-          }
-
-    The ":regex" match type is compatible with both the "i;octet" and
-    "i;ascii-casemap" comparators and may be used with them.
-
-    Implementations MUST support extended regular expressions (EREs) as
-    defined by [POSIX.2].  Any regular expression not defined by
-
-
-
-Expires January 5, 2003       Murchison                         [Page 4]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-    [POSIX.2], as well as [POSIX.2] basic regular expressions, word
-    boundaries and backreferences are not supported by this extension.
-    Implementations SHOULD reject regular expressions that are
-    unsupported by this specification as a syntax error.
-
-    The following table provides a brief summary of the regular
-    expressions that MUST be supported.  This table is presented here
-    only as a guideline.  [POSIX.2] should be used as the definitive
-    reference.
-
-
-    +------------+-----------------------------------------------------+
-    | Expression |  Pattern                                            |
-    +------------+-----------------------------------------------------+
-    |                Items to match a single character                 |
-    +------------+-----------------------------------------------------+
-    |     .      |  Match any single character except newline.         |
-    |    [ ]     |  Bracket expression.  Match any one of the enclosed |
-    |            |  characters.  A hypen (-) indicates a range of      |
-    |            |  consecutive characters.                            |
-    |   [^  ]    |  Negated bracket expression.  Match any one         |
-    |            |  character NOT in the enclosed list.  A hypen (-)   |
-    |            |  indicates a range of consecutive characters.       |
-    |    \\      |  Escape the following special character (match      |
-    |            |  the literal character).  Undefined for other       |
-    |            |  characters.                                        |
-    |            |  NOTE: Unlike [POSIX.2], a double-backslash is      |
-    |            |  required as per section 2.4.2 of [SIEVE].          |
-    +------------+-----------------------------------------------------+
-    |   Items to be used within a bracket expression (localization)    |
-    +------------+-----------------------------------------------------+
-    |   [: :]    |  Character class (alnum, alpha, blank, cntrl,       |
-    |            |  digit, graph, lower, print, punct, space,          |
-    |            |  upper, xdigit).                                    |
-    |   [= =]    |  Character equivalents.                             |
-    |   [. .]    |  Collating sequence.                                |
-    +------------+-----------------------------------------------------+
-    |  Quantifiers - Items to count the preceding regular expression   |
-    +------------+-----------------------------------------------------+
-    |     ?      |  Match zero or one instances.                       |
-    |     *      |  Match zero or more instances.                      |
-    |     +      |  Match one or more instances.                       |
-    |   {n,m}    |  Match any number of instances between              |
-    |            |  n and m (inclusive).  {n} matches exactly n        |
-    |            |  instances.  {n,} matches n or more instances.      |
-    +------------+-----------------------------------------------------+
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 5]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-    +------------+-----------------------------------------------------+
-    | Expression |  Pattern                                            |
-    +------------+-----------------------------------------------------+
-    |              Anchoring - Items to match positions                |
-    +------------+-----------------------------------------------------+
-    |     ^      |  Match the beginning of the line or string.         |
-    |     $      |  Match the end of the line or string.               |
-    +------------+-----------------------------------------------------+
-    |                        Other constructs                          |
-    +------------+-----------------------------------------------------+
-    |     |      |  Alternation.  Match either of the separated        |
-    |            |  regular expressions.                               |
-    |    ( )     |  Group the enclosed regular expression(s).          |
-    +------------+-----------------------------------------------------+
-
-
-4.  Security Considerations
-
-    Security considerations are discussed in [SIEVE].  It is believed
-    that this extension doesn't introduce any additional security
-    concerns.
-
-    However, a poor implementation COULD introduce security problems
-    ranging from degradation of performance to denial of service.  If an
-    implementation uses a third-party regular expression library, that
-    library should be checked for potentially problematic regular
-    expressions, such as "(.*)*".
-
-
-5.  Acknowledgments
-
-    Thanks to Tim Showalter, Alexey Melnikov, Tony Hansen, Phil Pennock
-    and Jutta Degener for their help with this document.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 6]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-6.  Author's Address
-
-    Kenneth Murchison
-    Oceana Matrix Ltd.
-    21 Princeton Place
-    Orchard Park, NY 14127
-
-    Phone: (716) 662-8973
-    EMail: ken@oceana.com
-
-
-Appendix A.  References
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-         Requirement Levels", Harvard University, RFC 2119, March, 1997.
-
-
-     [SIEVE] Showalter, T., "Sieve: A Mail Filtering Language", Mira
-         point, Inc., RFC 3028, January 2001.
-
-
-     [POSIX.2], "Portable Operating System Interface (POSIX). Part 2,
-         Shell and utilities", National Institute of Standards and Tech
-         nology (U.S.).
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 7]
-
-Internet Draft          Sieve -- Regex Extension           June 30, 2003
-
-
-
-Appendix B.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of develop-
-    ing Internet standards in which case the procedures for copyrights
-    defined in the Internet Standards process must be followed, or as
-    required to translate it into languages other than English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/draft-murchison-sieve-regex-06.txt
Index: kioslaves/sieve/draft-degener-sieve-editheader.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-editheader.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-degener-sieve-editheader.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,287 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: October 2003                                          April 2003
-
-
-                      Sieve -- "editheader" extension
-		  <draft-degener-sieve-editheader-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines three new actions for the "sieve"
-   language that add, delete, and change e-mail header fields.
-
-
-1. Introduction
-
-   Email headers are a flexible and easy to understand means
-   of communication between email processors.
-   This extension enables sieve scripts to interact with other
-   components that consume or produce header fields by allowing
-   the script to delete, modify, and add header fields itself.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "editheader".
-
-
-3. Action addheader
-
-   Syntax:
-   	"addheader" <name: string> <value: string>
-
-   The addheader action appends a header field to the existing
-   message header.  The name MUST be a valid 7-bit US-ASCII header
-   field name as described by RFC 2822 "field-name" nonterminal.
-
-   If the specified field value does not match the RFC 2822
-   "unstructured" nonterminal or exceeds a length limit set by
-   the implementation, the implementation MUST either flag an
-   error or encode the field using folding white space and the
-   encodings described in RFC 2047 or RFC 2231 to be compliant
-   with RFC 2822.
-
-   The header field MUST be added at the end of the existing
-   header.
-
-   An implementation MAY impose a length limit onto the size of
-   the encoded header field; such a limit MUST NOT be less
-   than 998 characters, not including the terminating CRLF
-   supplied by the implementation.
-
-   Example:
-	/* Don't redirect if we already redirected */
-	if not header :contains "X-Sieve-Filtered"
-		["<kim@job.tld>", "<kim@home.tld>"]
-	{
-   		addheader "X-Sieve-Filtered" "<kim@job.tld>";
-		redirect "kim@home.tld";
-	}
-
-
-4. Action deleteheader
-
-   Syntax:
-   	"deleteheader"
-		[":index" <fieldno: number> [":last"]]
-		[COMPARATOR] [MATCH-TYPE]
-		<field-name: string>
-		[<value-patterns: string-list>]
-
-   By default, the deleteheader action deletes all occurrences
-   of the named header field.
-
-   The field-name is mandatory and always matched as a
-   case-insensitive us-ascii string.  The value-patterns,
-   if specified, are matched according to the match type and
-   comparator.  If none are specified, all values match.
-
-   The field-name MUST be a valid 7-bit header field name as
-   described by the RFC 2822 "field-name" nonterminal.
-
-   If :index <fieldno> is specified, the attempts to match 
-   a value are limited to the header field <fieldno> (beginning
-   at 1, the first named header field).  If :last is specified,
-   the count is backwards; 1 denotes the last named header field,
-   2 the second to last, and so on.  The counting happens
-   before the <value-patterns> match, if any;
-   
-   	deleteheader :index 2 :contains "Received" "via carrier-pigeon"
-
-   deletes the second "Received:" header field if it contains
-   the string "via carrier-pigeon" (not the second Received: field
-   that contains "via carrier-pigeon").
-
-
-5. Action replaceheader
-
-   Syntax:
-   	"replaceheader" 
-		[":index" <fieldno: number> [":last"]]
-		[":newname" <newname: string>]
-		[":newvalue" <newvalue: string>]
-		[COMPARATOR] [MATCH-TYPE] <field-name: string>
-		[<value-patterns: string-list>]
-
-   The replaceheader action replaces all or parts of a header
-   field, in some or all occurrences of that header field.
-
-   If :index <fieldno> is specified, the attempts to match 
-   a value are limited to the named header field <fieldno> (beginning
-   at 1, the first named header field).  If :last is specified,
-   the count is backwards; 1 denotes the last named header field,
-   2 the second to last, and so on.  As with "deleteheader",
-   the counting happens before the <value-patterns> match, if any.
-
-   The header field names in the field-name and in the ":newname"
-   argument, if specified, MUST be valid 7-bit header field names
-   as described by the RFC 2822 "field-name" nonterminal.
-
-   The field-name is mandatory and always matched as a
-   case-insensitive us-ascii string.  The value-patterns,
-   if specified, are matched according to the match type and
-   comparator.   (If no value-patterns are specified, they
-   always match.)
-
-   If :newname <newname> is specified, the action changes the
-   name of all matching header fields to <newname>.
-
-   If :newvalue <newvalue> is specified, the action changes the
-   value of all matching header fields to to <newvalue>.
-   If the [VARIABLES] extension is present and the MATCH-TYPE
-   is a type that interacts with the [VARIABLES] extension,
-   variable references to ${1}...${N} in the replacement string
-   following ":newvalue" are evaluated according to the matched
-   substring in the header field that is being replaced.
-
-   For example,
-
-   	replaceheader :newvalue "[ADV] ${1}" :matches "Subject" "*";
-
-   would insert an "[ADV]" tag before the value of the
-   "Subject" header field, changing
-   	
-	Subject: Make Money Fast!!
-  to 	Subject: [ADV] Make Money Fast!!
-
-   If neither :newname nor :newvalue are specified, the operation
-   still matches its argument and, in the presence of the
-   [VARIABLES] extension and a match type that interacts with it,
-   sets the ${1}...${N} variables to the last header matched.
-
-
-6. Interaction with Other Sieve Extensions
-
-   Tests and actions such as "exist" or "header" that examine
-   headers MUST examine the current state of a header as modified
-   by any actions that have taken place so far.
-
-   Actions that create messages in storage or in transport to
-   MTAs MUST store and send messages with the current set of
-   header fields.
-
-
-7. Security Considerations
-
-   Someone with write access to a user's script storage may use this
-   extension to generate headers that a user would otherwise be
-   shielded from (by a gateway MTA that removes them).
-
-   A sieve filter that removes headers may unwisely destroy
-   evidence about the path a header has taken.
-
-   Any change in a message content may interfere with digital
-   signature mechanisms that include the header in the signed
-   material.
-
-   Any decision mechanism in a user's filter that is based
-   on headers is vulnerable to header spoofing.  For example,
-   if the user adds an APPROVED header or tag, a malicious sender
-   may add that tag or header themselves.  One way to guard against
-   this is to delete or rename any such headers or stamps prior
-   to processing the message.
-
-
-8. Acknowledgments
-
-   Thanks to Eric Allman, Philip Guenther, Will Lee, Chris Markle,
-   Randall Schwartz, and Rand Wacker for extensive corrections
-   and suggestions.
-
-
-9. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-10. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-Appendices
-
-Appendix A.  References
-
-   [SIEVE]     Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-               January 2001.
-
-   [KEYWORDS]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", RFC 2119, March 1997.
-
-   [VARIABLES] Homme, K.T., "Sieve -- Variables Extension",
-               draft-homme-sieve-variables-01.txt, April 2003.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-editheader.txt
Index: kioslaves/sieve/draft-daboo-sieve-include.txt
===================================================================
--- kioslaves/sieve/draft-daboo-sieve-include.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-daboo-sieve-include.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,514 +1 @@
-Network Working Group                                          C. Daboo
-Internet Draft: SIEVE Include Extension
-Document: draft-daboo-sieve-include-01.txt                 October 2003
-
-                        SIEVE Include Extension
-    
-Status of this Memo
-    
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.
-    
-    Internet-Drafts are working documents of the Internet Engineering
-    Task Force (IETF), its areas, and its working groups.  Note that
-    other groups may also distribute working documents as
-    Internet-Drafts.
-    
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet-Drafts as
-    reference material or to cite them other than as "work in progress."
-    
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt.
-    
-    The list of Internet- Draft Shadow Directories can be accessed at
-    http://www.ietf.org/shadow.html.
-    
-    
-Copyright Notice
-    
-     Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 1]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    Abstract
-    
-    The SIEVE [SIEVE] "include" extension permits users to include one
-    SIEVE script inside another.  This can make managing large scripts
-    or multiple sets of scripts much easier, as well as supporting
-    common 'libraries' of scripts.  Users are able to include their own
-    personal scripts or site-wide scripts provided by the local SIEVE
-    implementation.
-    
-Change History (to be removed prior to publication as an RFC)
-    
-    Changes from -00 to -01:
-    1   Added IPR boiler plate.
-    2   Re-ordered sections at start to conform to RFC style.
-    3   Moved recursion comment into General Considerations section.
-    4   Switched to using optional parameter to indicate personal vs
-        global.
-    5   Explicitly state that an error occurs when a missing script is
-        included.
-        
-        
-                           Table of Contents
-     1  Introduction and Overview . . . . . . . . . . . . . . . . . .  2
-     2  Conventions Used in This Document  . . . . . . . . . . . . . . 2
-     3  SIEVE Include Extension . . . . . . . . . . . . . . . . . . .  3
-       3.1  General Considerations . . . . . . . . . . . . . . . . . . 3
-       3.2  Control Structure Include . . . . . . . . . . . . . . . .  3
-       3.3  Control Structure Return . . . . . . . . . . . . . . . . . 6
-     4  Security Considerations . . . . . . . . . . . . . . . . . . .  7
-     5  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 7
-       5.1  include registration  . . . . . . . . . . . . . . . . . .  7
-     6  Normative References . . . . . . . . . . . . . . . . . . . . . 7
-     7  Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .  7
-     8  Author's Address . . . . . . . . . . . . . . . . . . . . . . . 8
-     9  Intellectual Property Rights Statement  . . . . . . . . . . .  8
-    10  Full Copyright Statement . . . . . . . . . . . . . . . . . . . 8
-        
-1 Introduction and Overview
-    
-    Its convenient to be able to break SIEVE scripts down into smaller
-    components which can be reused in a variety of different
-    circumstances.  For example, users may want to have a default script
-    and a special 'vacation' script, the later being activated when the
-    user goes on vacation.  In that case the default actions should
-    continue to be run, but a vacation command should be executed first.
-    One option is to edit the default script to add or remove the
-    vacation command as needed.  Another is to have a vacation script
-    that simply has a vacation command and then includes the default
-    script.
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 2]
-Internet Draft           SIEVE Include Extension           October 2003
-
-2 Conventions Used in This Document
-    
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-    
-3 SIEVE Include Extension
-    
-3.1 General Considerations
-    
-    SIEVE implementations that implement the "include" and "return"
-    control structures described below have an identifier of "include"
-    for use with the capability mechanism.  If either of the "include"
-    or "return" control structures are used in a script, the "include"
-    capability MUST be listed in the "require" statement in that script.
-    
-    SIEVE implementations must track the use of actions in included
-    scripts so that implicit "keep" behaviour can be properly determined
-    based on whether any actions have executed in any script.
-    
-    SIEVE implementations are allowed to limit the total number of
-    nested included scripts, but MUST provide for a total of at least
-    three levels of nested scripts including the top-level script.  An
-    error MUST be generated either when the script is uploaded to the
-    SIEVE repository, or when the script is executed, if any nesting
-    limit is exceeded.  If such an error is detected whilst processing a
-    SIEVE script, an implicit "keep" action MUST be executed to prevent
-    loss of any messages.
-    
-    SIEVE implementations MUST ensure that recursive includes are not
-    possible. i.e. if script "A" includes script "B", and script "B"
-    includes script "A" an error MUST be generated either when the
-    script is uploaded to the SIEVE repository, or when the script is
-    executed.  If such an error is detected whilst processing a SIEVE
-    script, an implicit "keep" action MUST be executed to prevent loss
-    of any messages.
-    
-    SIEVE implementations MUST handle missing scripts being referenced
-    via an includes in an existing script.  An error MUST be generated
-    when a missing included script is descovered during execution.  If
-    such an error is detected an implicit "keep" action MUST be executed
-    to prevent loss of any messages.
-    
-3.2 Control Structure Include
-    
-        Syntax: include [LOCATION] <value: string>
-    
-    The "include" control structure includes an optional parameter, and
-    a single string argument representing the name of the script to
-    include in the main script at that point.
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 3]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    [LOCATION] is an optional parameter that has one of two values:
-    
-   Syntax:
-   	  ":personal"
-	/ ":global"
-
-   If the [LOCATION] parameter is not present, the location defaults to :personal.
-    
-    The location has the following meanings:
-    
-        :personal
-            Indicates that the named script is stored in the user's own
-            personal (private) SIEVE repository.
-            
-        :global
-            Indicates that the named script is stored in a site-wide
-            SIEVE repository, accessible to all users of the SIEVE
-            system.
-    
-    The included script MUST be a valid SIEVE script, including having
-    necessary "require" statements for all optional capabilities used by
-    the script.  The scope of a "require" statement in an included
-    script is for that script only, not the including script. e.g. if
-    script "A" includes script "B", and script "B" uses the "fileinto"
-    extension, script "B" must have a "require" statement for
-    "fileinto", irrespective of whether script "A" has one.  In
-    addition, if script "A" does not have a "require" statement for
-    "fileinto", "fileinto" cannot be used anywhere in script "A", even
-    after inclusion of script "B".
-    
-    A "stop" control statement in an included script MUST stop all
-    script processing, including the processing of the scripts that
-    include the current one.  The "return" control statement (described
-    below) stops processing of the current script only, and allows the
-    scripts that include it to continue.
-    
-    Examples:
-    
-    In the examples below, script content is indicated by a '|' as the
-    first non-space character on a line for clarity.  The '|' characters
-    are not part of the script itself.
-    
-    The user has four scripts stored in their personal repository:
-    
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 4]
-Internet Draft           SIEVE Include Extension           October 2003
-
-        "default"
-
-        This is the default active script that includes several others.
-            
-		|   require ["include"];
-	    |   
-		|   include :personal "always_allow";
-		|   include :global "spam_tests";
-		|   include :personal "my_spam_tests";
-		|   include :personal "mailing_lists";
-            
-        "always_allow"
-
-        This script special cases some correspondent email addresses and
-        makes sure any message containing those addresses are always
-        kept.
-            
-		|   if header :is "From" "boss@example.com"
-		|   {
-		|   	keep;
-		|   }
-		|   elsif header :is "From" "ceo@example.com"
-		|   {
-		|   	keep;
-		|   }
-            
-        "my_spam_tests"
-
-        This script does some user-specific spam tests to catch spam
-        messages not caught by the site-wide spam tests.
-            
-		|   require ["reject"];
-	    |   
-		|   if header :contains "Subject" "XXXX"
-		|   {
-		|   	reject;
-		|   }
-		|   elsif header :is "From" "money@example.com"
-		|   {
-		|   	reject;
-		|   }
-            
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 5]
-Internet Draft           SIEVE Include Extension           October 2003
-
-        "mailing_lists"
-
-        This script looks for messages from different mailing lists and
-        files each into a mailbox specific to the mailing list.
-            
-		|   require ["fileinto"];
-	    |   
-		|   if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-		|   {
-		|   	fileinto "lists.sieve";
-		|   }
-		|   elsif header :is "Sender" "owner-ietf-imapext@imc.org"
-		|   {
-		|   	fileinto "lists.imapext";
-		|   }
-            
-    There is one script stored in the global repository:
-    
-        "spam_tests"
-
-        This script does some site-wide spam tests which any user at the
-        site can include in their own scripts at a suitable point.  The
-        script content is kept up to date by the site administrator.
-            
-		|   require ["reject"];
-	    |   
-		|   if anyof (header :contains "Subject" "$$",
-		|   		  header :contains "Subject" "Make money")
-		|   {
-		|   	reject;
-		|   }
-            
-    The "include" control structure may appear anywhere in the script
-    where a control structure is legal.
-    
-    Example:
-    
-		|   require ["include"];
-	    |   
-		|   if anyof (header :contains "Subject" "$$",
-		|   		  header :contains "Subject" "Make money")
-		|   {
-		|       include "my_reject_script";
-		|   }
-    
-3.3 Control Structure Return
-    
-        Syntax: return
-    
-    The "return" control structure stops processing of the currently
-    included script only and returns processing control to the script
-    which includes it.  If used in the main script (i.e. not in an
-
-
-Daboo                    Expires April 2004                    [Page 6]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    included script), it has the same effect as the "stop" control
-    structure, including the appropriate "keep" action if no other
-    actions have been executed up to that point.
-    
-4 Security Considerations
-    
-    SIEVE implementations MUST ensure adequate security for the global
-    script repository to prevent unauthorized changes to global scripts.
-    
-    Beyond that, the "include" extension does not raise any security
-    considerations that are not present in the base [SIEVE] protocol,
-    and these issues are discussed in [SIEVE].
-    
-    
-5 IANA Considerations
-    
-    The following template specifies the IANA registration of the Sieve
-    extension specified in this document:
-    
-5.1 include registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: include
-    Capability keyword: include
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780,
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-    
-6 Normative References
-    
-    [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-    Requirement Levels", RFC 2119, March 1997.
-    
-    [SIEVE] Showalter, "Sieve:  A Mail Filtering Language", RFC 3028,
-    January 2001.
-    
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 7]
-Internet Draft           SIEVE Include Extension           October 2003
-
-7 Acknowledgments
-    
-    Thanks to Ken Murchison, Rob Siemborski, Alexey Melnikov, Marc Mutz
-    and Kjetil Torgrim Homme for comments and corrections.
-    
-    
-8 Author's Address
-    
-    Cyrus Daboo
-    Cyrusoft International, Inc.
-    5001 Baum Blvd., Suite 780,
-    Pittsburgh, PA 15213
-    U.S.A.
-
-    <mailto:daboo@cyrusoft.com>
-    
-9 Intellectual Property Rights Statement
-    
-    The IETF takes no position regarding the validity or scope of any
-    intellectual property or other rights that might be claimed to
-    pertain to the implementation or use of the technology described in
-    this document or the extent to which any license under such rights
-    might or might not be available; neither does it represent that it
-    has made any effort to identify any such rights.  Information on the
-    IETF's procedures with respect to rights in standards-track and
-    standards-related documentation can be found in BCP-11.  Copies of
-    claims of rights made available for publication and any assurances
-    of licenses to be made available, or the result of an attempt made
-    to obtain a general license or permission for the use of such
-    proprietary rights by implementors or users of this specification
-    can be obtained from the IETF Secretariat.
-    
-    
-10 Full Copyright Statement
-    
-    Copyright (C) The Internet Society 2003.  All Rights Reserved.
-    
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 8]
-Internet Draft           SIEVE Include Extension           October 2003
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-    
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 9]
\ No newline at end of file
+http://ktown.kde.org/~dirk/sieve/draft-daboo-sieve-include.txt
Index: kioslaves/sieve/draft-homme-sieve-variables.txt
===================================================================
--- kioslaves/sieve/draft-homme-sieve-variables.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-homme-sieve-variables.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,594 +1 @@
-
-
-
-
-
-
-Network Working Group                                        K. T. Homme
-Document: draft-homme-sieve-variables-01.txt          University of Oslo
-Expires October 17, 2003                                     17 Apr 2003
-
-
-
-                      Sieve -- Variables Extension
-
-
-
-Status of this Memo
-
-
-   This document is an Internet-Draft and is subject to all provisions
-   of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as Internet-
-   Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six months
-   and may be updated, replaced, or obsoleted by other documents at any
-   time.  It is inappropriate to use Internet-Drafts as reference mate
-   rial or to cite them other than as "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/ietf/1id-abstracts.txt
-
-   To view the list Internet-Draft Shadow Directories, see
-   http://www.ietf.org/shadow.html.
-
-   Distribution of this memo is unlimited.
-
-
-Abstract
-
-   In advanced filtering rule sets, it is useful to keep state or con
-   figuration details across rules.  This extension adds an action to
-   store data in variables, an action to retrieve the current time,
-   changes the interpolation of strings, and supplies a new test so that
-   the value of a string can be examined.
-
-
-0.  Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-
-0.1.  Discussion
-
-   This draft is intended to be an extension to the Sieve mail filtering
-   language, available from the RFC repository as
-
-
-
-Homme                                                           [Page 1]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-   <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-   This draft and the Sieve language itself are being discussed on the
-   MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-   requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-   email message with the word "subscribe" in the body).  More informa
-   tion on the mailing list along with a WWW archive of back messages is
-   available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.  Noted Changes
-
-0.2.1.  Changes since -00
-
-a)   allow generic time zone names, without requiring implementations to
-     support it.  added a "${timezone}" variable so that the user can
-     check if the implementation does support the time zone name he
-     wants.  the default time zone was changed to localtime again.
-
-b)   allow back references from :matches as well as :regex.
-
-c)   added a section on implementation limits.
-
-d)   clarified global scope so that it spans include.
-
-e)   clarified that this draft only affects scripts which require "vari
-     ables".
-
-f)   changed modifiers into being tagged arguments for SET, added prece
-     dence table.
-
-g)   added optional COMPARATOR to SET to solve the internationalisation
-     problem with :lower etc.
-
-h)   the name of the variable being SET is passed in a string to conform
-     with overall Sieve grammar.  this string is explicitly disallowed
-     from containing variable references.
-
-
-0.3.  Open Issues
-
-a)   should we include more predefined variables to access the time?
-     (weekday, week number (US, EU and/or ISO?), name of month, name of
-     weekday, ...)  could use strftime(3c) as a list of what to offer,
-     but the names should be in English.
-
-b)   this extension is particularily useful if fileinto creates new
-     folders on demand.  [SIEVE] doesn't prohibit this, and currently
-     some implementations will create new folders automatically, others
-     won't.
-
-c)   the NOTIFY draft has variables, too.  it would be nice if the syn
-     tax for the two extensions agreed.  a changed NOTIFY can be used on
-     its own without the variables extension, the user simply won't be
-
-
-
-Homme                                                           [Page 2]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-     able to configure the notification message to include different
-     snippets from the message.
-
-
-1.  Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE].  It
-   adds support for storing and referencing data in string variables.
-   The mechanisms detailed in this document will only apply to Sieve
-   scripts which include a require clause for the "variables" extension.
-   The require clauses themselves are not affected by this extension.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-   The capability string associated with the extension defined in this
-   document is "variables".
-
-
-3.  Interpretation of strings
-
-   This extension changes the semantics of quoted-string, multi-line-
-   literal and multi-line-dotstuff found in [SIEVE] to enable the inclu
-   sion of the value of variables.  The syntax follows [ABNF].
-
-      variable-ref        =  "${" variable-name "}"
-      variable-name       =  num-variable / identifier
-      num-variable        =  1*DIGIT
-
-   When the string is evaluated, substrings matching variable-ref shall
-   be replaced by the value of variable-name.  Only one pass through the
-   string shall be done.  Variable names are case insensitive.  Unknown
-   variables are replaced by the empty string.  As per the grammar,
-   illegal variable names leaves the would-be variable-ref verbatim,
-   since it doesn't match the variable-ref syntax.
-
-   Examples:
-      "&%${}!"     => unchanged, as the empty string is an illegal
-                      identifier
-      "${doh!}"    => unchanged, as "!" is illegal in identifiers
-
-      The variable company holds the value "ACME".  No other variables
-      are set.
-
-         "${full}"    => the empty string
-         "${company}" => "ACME"
-         "${President, ${Company} Inc.}"
-                      => "${President, ACME Inc.}"
-
-   The expanded string MUST use the variable values which are current
-   when control reaches the statement the string is part of.
-
-
-
-Homme                                                           [Page 3]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-3.1.  Quoting
-
-   The semantics of quoting using backslash are not changed: backslash
-   quoting is resolved before doing variable substitution.
-
-   Examples:
-      "${fo\o}"  => ${foo}  => the expansion of variable foo.
-      "${fo\\o}" => ${fo\o} => illegal identifier => left verbatim.
-      "\${foo}"  => ${foo}  => the expansion of variable foo.
-      "\\${foo}" => \${foo} => a backslash character followed by the
-                               expansion of variable foo.
-
-   If it is required to include a character sequence such as "${beep}"
-   verbatim in a text literal, the user can define a variable to circum
-   vent expansion to the empty string.
-
-   Example:
-      set dollar "$"
-      set text "regarding ${dollar}{beep}"
-
-
-3.2.  Numeric variables
-
-   The decimal value of the numeric variable name will index the list of
-   matching strings from the most recently evaluated match of type
-   ":matches" or ":regex".  The list is empty if the match was unsuc
-   cessful.
-
-   For ":matches", the list will contain one string for each wildcard in
-   the match pattern.  Each string holds what the corresponding wildcard
-   expands to, possibly the empty string.  The wildcards expand greed
-   ily.
-
-   For ":regex", the list will contain the strings corresponding to the
-   group operators.  The groups are ordered by the position of the open
-   ing parenthesis, from left to right.
-
-   The first string in the list has index 1.  If the index is out of
-   range, the empty string will be substituted.  Index 0 returns the
-   number of strings in the list.
-
-   Example:
-      require [ "fileinto", "regex", "variables" ];
-
-      if header :regex "List-ID" "<(.*)@" {
-          fileinto "lists.${1}"; stop;
-      }
-
-      # this is equivalent to the above:
-      if header :matches "List-ID" "<*@" {
-          fileinto "lists.${1}"; stop;
-      }
-
-      if header :matches [ "To", "Cc" ] "coyote@**.com" {
-
-
-
-Homme                                                           [Page 4]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-          # ${0} is always "2", and ${2} is always the empty string.
-          fileinto "business.${1}"; stop;
-      } else {
-          # ${0} is always "0"
-          stop;
-      }
-
-
-4.  Action Commands
-
-   This extension defines two actions, "set" and "setdate", both of
-   which MUST be supported by an implementation of this extension.
-
-
-4.1.  Action set
-
-   Syntax:   set [MODIFIER] [COMPARATOR] <name: string> <value: string>
-
-   The "set" action stores the specified value in the variable called
-   name.  name MUST be a constant string without variable references.
-   The contents of name MUST conform to the syntax of identifier.  An
-   illegal name MUST cause a syntax error.
-
-   The default comparator is "i;ascii-casemap".
-
-   All variables have global scope: they are visible until processing
-   stops.  Variable names are case insensitive.
-
-   Example:
-      set "honorific"  "Mr";
-      set "first_name" "Wile";
-      set "last_name"  "Coyote";
-      set "vacation" text:
-      Dear ${HONORIFIC} ${last_name},
-      I'm out, please leave a message after the meep.
-      .
-      ;
-
-   "set" does not affect the implicit keep.
-
-
-4.1.1.  Modifiers
-
-   Modifiers are applied on value before it is stored in the variable.
-   Modifier names are case insensitive.  Unknown modifiers MUST yield a
-   syntax error.  More than one modifier can be specified, in which case
-   they are applied according to this precedence list, highest value
-   first:
-
-
-
-
-
-
-
-
-
-Homme                                                           [Page 5]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-                        Precedence     Modifier
-                       -----------------------------
-                            1          :length
-                       -----------------------------
-                            2          :lowerfirst
-                                       :upperfirst
-                       -----------------------------
-                            3          :lower
-                                       :upper
-
-
-   If two or more modifiers of the same precedence are used, they can be
-   applied in any order.
-
-   Examples:
-      set "var" "juMBlEd lETteRS"           => "juMBlEd lETteRS"
-      set :length "var" "${var}"            => "15"
-      set :lower "var" "${var}"             => "jumbled letters"
-      set :upperfirst "var" "${var}"        => "JuMBlEd lETteRS"
-      set :upperfirst :lower "var" "{$var}" => "Jumbled letters"
-
-
-4.1.1.1.  Modifier ":length"
-
-   The value is the decimal number of letters in the expansion, con
-   verted to a string.
-
-
-4.1.1.2.  Case modifiers
-
-   These modifiers change the letters of the text from upper to lower
-   case or vice versa.  The implementation MUST support US-ASCII, but is
-   not required to handle the entire Unicode repertoire.  The comparator
-   specified SHOULD be consulted to establish which locale to use.
-
-
-4.1.1.2.1.  Modifier ":upper"
-
-   All lower case letters are converted to their upper case counterpart.
-
-
-4.1.1.2.2.  Modifier ":lower"
-
-   All upper case letters are converted to their lower case counterpart.
-
-
-4.1.1.2.3.  Modifier ":upperfirst"
-
-   The first character of the string is converted to upper case if it is
-   a letter and set in lower case.  The rest of the string is left
-   unchanged.
-
-
-
-
-
-
-Homme                                                           [Page 6]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-4.1.1.2.4.  Modifier ":lowerfirst"
-
-   The first character of the string is converted to lower case if it is
-   a letter and set in upper case.  The rest of the string is left
-   unchanged.
-
-
-4.2.  Action setdate
-
-   Syntax: setdate [ <time-zone: string> ]
-
-   The value of time-zone SHOULD be a well-known name, or an offset rel
-   ative to UTC.  All implementations MUST support the time-offset syn
-   tax
-
-           time-offset  =  ( "+" / "-" ) 4DIGIT
-
-   time-offset should be interpreted the same way as "zone" in [IMAIL].
-
-
-     Note: There is currently no registry for time zones.  If IETF
-     establishes one, its names SHOULD be used.  In the absence of
-     such a registry, [TZ] is the most widespread collection of
-     time zone definitions and its use as a reference is RECOM
-     MENDED.
-
-   If the time-zone is left out or not recognised, the local time zone
-   SHOULD be used.
-
-   The action setdate initialises a few variables:
-
-      ${year}     => the current year, "0000" .. "9999"
-      ${month}    => the current month, "01" .. "12"
-      ${day}      => the current day, "01" .. "31"
-      ${hour}     => the current hour, "00" .. "23"
-      ${minute}   => the current hour, "00" .. "59"
-      ${second}   => the current second, "00" .. "59"
-      ${timezone} => the time zone in use.  If the user specified a
-                     time zone which was recognised, ${timezone} will
-                     contain the name given.  Otherwise, the value
-                     MUST be the server's default time zone in offset
-                     format.
-
-   These variables SHOULD reference the time when execution of the Sieve
-   script reaches the statement.  All calls to setdate MUST refer to the
-   same point in time.
-
-   "setdate" does not affect the implicit keep.
-
-
-5.  Test string
-
-   Syntax: string [MATCH-TYPE] [COMPARATOR]
-           <source: string-list> <key-list: string-list>
-
-
-
-Homme                                                           [Page 7]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-   The "string" test evaluates to true if any of the strings matches any
-   key.  The type of match defaults to ":is".
-
-
-6.  Implementation Limits
-
-   An implementation of this draft MUST support at least 128 distinct
-   variables.  The supported length of variable names MUST be at least
-   32 characters.  Each variable MUST be able to hold at least 4000
-   characters.  Attempts to set the variable to a value larger than what
-   the implementation supports MUST be treated as an error.
-
-   Numeric variables ${1} through ${9} MUST be supported.  Referencing
-   higher indices than is supported is a syntax error which MUST be dis
-   covered at compile-time.  If the string matching a wildcard or a
-   regex group operator exceeds the maximum variable size, the implemen
-   tation SHOULD truncate it and MUST NOT treat it as an error.
-
-
-7.  Security Considerations
-
-   When combined with the regex extension, strings can contain arbitrary
-   values controlled by the sender of the e-mail if the author of the
-   script isn't careful.
-
-   The introduction of variables makes advanced decision making easier
-   to write, but since no looping construct is provided, all Sieve
-   scripts will terminate orderly.
-
-
-8.  Acknowledgments
-
-   Thanks to Jutta Degener, Ned Freed, Lawrence Greenfield, Peder Stray
-   and Nigel Swinson for valuable feedback.
-
-
-9.  Author's Address
-
-   Kjetil T. Homme
-   Frydens g 5B
-   0564 Oslo, Norway
-
-   Phone: +47 9366 0091
-   E-mail: kjetilho@ifi.uio.no
-
-
-Appendix A.  References
-
-
-     [ABNF]     D. Crocker, Ed., "Augmented BNF for Syntax Specifica
-                tions: ABNF", Internet Mail Consortium, RFC 2234, Novem
-                ber 1997
-
-
-
-
-
-Homme                                                           [Page 8]
-
-
-
-
-
-Internet Draft        Sieve -- Variables Extension           17 Apr 2003
-
-
-     [IMAIL]    P. Resnick, Ed., "Internet Message Format", QUALCOMM
-                Incorporated, April 2001.
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-                Requirement Levels", Harvard University, RFC 2119, March
-                1997.
-
-     [SIEVE]    Showalter, T., "Sieve: A Mail Filtering Language", Mira
-                point, RFC 3028, January 2001.
-
-     [TZ]       Olson, A.D., et al, Time zone code and data,
-                ftp://elsie.nci.nih.gov/pub/, updated periodically.
-
-
-
-Appendix B.  Full Copyright Statement
-
-   Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this doc
-   ument itself may not be modified in any way, such as by removing the
-   copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of develop
-   ing Internet standards in which case the procedures for copyrights
-   defined in the Internet Standards process must be followed, or as
-   required to translate it into languages other than English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF MER
-   CHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Homme                                                           [Page 9]
-
-
+http://ktown.kde.org/~dirk/sieve/draft-homme-sieve-variables.txt
Index: kioslaves/sieve/draft-martin-sieve-notify-01.txt
===================================================================
--- kioslaves/sieve/draft-martin-sieve-notify-01.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-martin-sieve-notify-01.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,457 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                         Tim Martin
-Document: draft-martin-sieve-notify-01.txt            Wolfgang Segmuller
-Expires December 6, 2001                                     1 June 2001
-
-
-         Sieve -- An extension for providing instant notifications
-
-                      <draft-ietf-sieve-notify-01.txt>
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are
-    working documents of the Internet Engineering Task Force (IETF), its
-    areas, and its working groups.  Note that other groups may also
-    distribute working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet- Drafts as
-    reference material or to cite them other than as "work in progress."
-
-   
-     The list of current Internet-Drafts can be accessed at
-     http://www.ietf.org/1id-abstracts.html
-
-     The list of Internet-Draft Shadow Directories can be accessed at
-     http://www.ietf.org/shadow.html.
-
-
-    Distribution of this memo is unlimited.
-
-
-Abstract
-
-    Users go to great lengths to be notified as quickly as possible that
-    they have received new mail. Most of these methods involve polling
-    to check for new messages periodically. A push method handled by the
-    final delivery agent gives users quicker notifications and saves
-    server resources. This document does not specify the notification
-    method but is expected that using existing instant messaging
-    infrastructure such as Zephyr, ICQ, or SMS messages will be popular.
-    This draft describes an extension to the Sieve mail filtering
-    language that allows users to give specific preferences for
-    notification of Sieve actions.
-
-
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 1]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-                           TTaabbllee ooff CCoonntteennttss
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.1.   Conventions Used in This Document . . . . . . . . . . . . . .   3
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   3
-
-3.     Actions . . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-3.1.   Notify action . . . . . . . . . . . . . . . . . . . . . . . .   3
-3.2.   Denotify Action . . . . . . . . . . . . . . . . . . . . . . .   5
-
-4.     Interaction with Other Sieve Actions  . . . . . . . . . . . .   6
-
-5.     Security Considerations . . . . . . . . . . . . . . . . . . .   7
-
-6.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   7
-
-7.     Copyright . . . . . . . . . . . . . . . . . . . . . . . . . .   7
-
-8.     References  . . . . . . . . . . . . . . . . . . . . . . . . .   8
-
-9.     Author's Addresses  . . . . . . . . . . . . . . . . . . . . .   8
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 2]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-1.  Introduction
-
-    This is an extension to the Sieve language defined by [SIEVE] for
-    providing instant notifications of sieve actions that have been
-    preformed. It defines the new action "notify".
-
-    This document does not dictate the notification method used.
-    Examples of possible notification methods are Zephyr and ICQ. The
-    method shall be site-defined.
-
-    Sieve interpreters for which notifications are impractical or is not
-    possible SHOULD ignore this extension.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-1.1.  Conventions Used in This Document
-    The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-    "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
-    document are to be interpreted as described in [KEYWORDS].
-
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "notify".
-
-
-
-3.  Actions
-
-
-
-
-3.1.  Notify action
-
-    Syntax:   notify [":method" string]
-               [":id" string]
-               [":options" 1*(string-list / number)]
-               [<":low" / ":normal" / ":high">]
-               ["message:" string]
-
-    The Notify action specifies that a notification should be sent to
-    the user upon successful handling of this message.
-
-    The format of the notification is implementation-defined. However,
-
-
-
-Expires December 6, 2001        Martin                          [Page 3]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    all content specified in the notify action, including Sieve actions
-    taken on the message, SHOULD be included. If errors occurred in
-    another action they SHOULD be reported in the notification. In
-    addition, if the notification method does not provide a timestamp,
-    one SHOULD be appended to the notification. Implementations SHOULD
-    NOT include extraneous information.
-
-    The :method tag identifies the notification method that will be
-    used. If the :method tag is not specified, the default
-    implementation defined notification method MUST be used.  The
-    possible values of this will be site-specific.  If a method is
-    specified that the implementation does not support, the notification
-    MUST be ignored. An implementation treats this as a warning
-    condition and execution of the sieve script MUST continue.
-
-    The :id tag can be used to give the notify action an unique
-    identifier. This identifier can be used later in the script to
-    cancel the specific notify. The string may have any value and SHOULD
-    NOT be included in the notification.
-
-    The :options tag is used to send parameters to the notification
-    method. This might be the phone number for an SMS message or a
-    user's ICQ identifier.
-
-    The priority parameter specifies the importance of the notification.
-    The priority parameter has the following values: ":high" (very
-    important), ":normal", and ":low" (not very important). If no
-    priority is given, a default priority of ":normal" SHOULD be
-    assumed. Some notification methods allow users to specify their
-    state of activity (for example "busy" or "away from keyboard"). If
-    the notification method provides this information it SHOULD be used
-    to selectively send notifications.  If, for example, the user marks
-    herself as "busy", an implementation SHOULD NOT send a notification
-    for a new mailing list message with a priority of :low, however the
-    user should be notified of a high priority action.  If the
-    notification method allows users to filter messages based upon
-    certain parameters in the message, users should be able to filter
-    based upon priority. If the notification method does not support
-    priority, then this parameter MUST be ignored.
-
-    The :message tag specifies the message data to be included in the
-    notification. The entirety of the string SHOULD be sent but
-    implementations MAY shorten the message for technical or aesthetic
-    reasons. Message may include the message variables defined below. If
-    the message parameter is absent, a default message of "$from$:
-    $subject$" will be used.
-
-         $from$     - the display name or address of the RFC 822 from
-
-
-
-Expires December 6, 2001        Martin                          [Page 4]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-         $env-from$ - the address of the RFC 821 from
-
-         $subject$  - the subject of the message
-
-         $text$     - the first text/* part
-
-         $text[n]$  - the first n bytes of the first text/* part
-
-    If there are errors sending the notification, the Sieve interpreter
-    SHOULD ignore the notification and not retry indefinitely.
-
-    This action MUST NOT cancel the implicit keep.
-
-    Example:
-         require ["notify","fileinto"];
-
-            if header :contains "from" "boss@example.org" {
-                notify :high "This is probably very important";
-            }
-
-            if header :contains "to" "sievemailinglist@example.org" {
-                notify :low "[SIEVE] $from$: $subject$";
-                fileinto "INBOX.sieve";
-            }
-
-
-
-
-3.2.  Denotify Action
-
-    Syntax: denotify [MATCH-TYPE string] [<":low" / ":normal" /
-    ":high">]
-
-    The denotify action can be used to cancel a previous notification.
-    If the priority, ":low" / ":normal" / ":high", is specified, then
-    only cancel those notifications with the specified priority.  If a
-    MATCH-TYPE with a string is specified, then only those notifications
-    whose :id tag matches the specified string using the match-type
-    operator are canceled.  The ascii-casemap comparator MUST be used.
-
-    If no notifications exist that match the search criteria, then the
-    denotify has no effect.  A denotify only cancels notifications that
-    have already been requested.  It is not possible to preemptively
-    cancel a notification.
-
-    The sequence:
-
-      denotify;
-
-
-
-Expires December 6, 2001        Martin                          [Page 5]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-      notify;
-
-    will still generate a notification.  The denotify does not cancel
-    the notify.
-
-    The following table shows which notifies would get cancelled:
-
-                                        # what is cancelled
-      denotify                          # all notifications
-      denotify :matches "*"             # all notifications with :id tag
-      denotify :high                    # all high priority notifications
-      denotify :is "foobar"             # all notifications with id "foobar"
-      denotify :matches "foo*" :normal  # all normal priority notifications
-                                        #   with id that starts with "foo"
-
-    Example:
-             require "notify";
-
-             notify :method "sms" :options "408-555-1212" :id "foobar";
-             if header :contains "from" "boss@example.org" {
-                notify :method "sms" :options "408-555-1212" :id "foobar" :high
-                       :message "BOSS: $subject$";
-             }
-
-             if header :contains "to" "sievemailinglist@example.org" {
-                denotify :is "foobar";
-             }
-
-             if header :contains "subject" "FYI:" {
-                # don't need high priority notification for
-                # a 'for your information'
-                denotify :is "foobar" :high;
-             }
-
-
-
-
-4.  Interaction with Other Sieve Actions
-
-    Notifications MUST be sent in all cases, unless a reject action is
-    also executed. Users may wish to be notified of a message being
-    discarded, for example. The reject action is given an exception
-    because implementations may wish to restrict users from seeing the
-    contents of a rejected message. However, notifications MAY be
-    modified to not include any data from the original rejected message.
-
-    The notify action MUST NOT cancel the implicit keep.
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 6]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    The denotify action MUST NOT affect any actions other than the
-    notify action.
-
-    Failures of other actions MAY be reported in the notification.
-
-
-
-
-
-5.  Security Considerations
-
-    Security considerations are discussed in [SIEVE]. Additionally
-    implementations must be careful to follow the security
-    considerations of the specific notification methods. It is believed
-    that this extension does not introduce any additional security
-    concerns.
-
-    The notify action is potentially very dangerous.  The path the
-    notification takes through the network may not be secure.  An error
-    in the options string may cause the message to be transmitted to
-    someone it was not intended for.
-
-    Just because a notification is received doesn't mean it was sent by
-    the sieve implementation.  It might be possible to forge
-    notifications with some notification methods.
-
-
-6.  Acknowledgments
-
-    Thanks to Larry Greenfield, Sarah Robeson, Tim Showalter, and Barry
-    Leiba for help with this document.
-
-
-
-7.  Copyright
-
-    Copyright (C) The Internet Society 1999. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-
-
-
-Expires December 6, 2001        Martin                          [Page 7]
-
-Internet Draft      Sieve -- Notifications extension        June 1, 2001
-
-
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-8.  References
-
-    [ABNF] Crocker, Overell, "Augmented BNF for Syntax Specifications:
-    ABNF", RFC 2234, Internet Mail Consortium, Demon Internet Ltd,
-    November 1997.
-
-    [SIEVE]; Showalter, T.; "Sieve: A Mail Filtering Language"; RFC
-    3028; Mirapoint, Inc.; January 2001
-
-
-9.  Author's Addresses
-
-    Tim Martin
-    Mirapoint Inc.
-    909 Hermosa Court
-    Sunnyvale, CA 94085
-
-    Phone: (408) 720-3835
-    EMail: tmartin@mirapoint.com
-
-    Wolfgang Segmuller
-    IBM T.J. Watson Research Center
-    30 Saw Mill River Rd
-    Hawthorne, NY  10532
-
-    Phone: (914) 784-7408
-    Email: whs@watson.ibm.com
-
-
-
-
-
-
-
-
-
-Expires December 6, 2001        Martin                          [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/draft-martin-sieve-notify-01.txt
Index: kioslaves/sieve/rfc3431.txt
===================================================================
--- kioslaves/sieve/rfc3431.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/rfc3431.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,451 +1 @@
-
-
-
-
-
-
-Network Working Group                                       W. Segmuller
-Request for Comment: 3431                IBM T.J. Watson Research Center
-Category: Standards Track                                  December 2002
-
-
-                   Sieve Extension: Relational Tests
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2002).  All Rights Reserved.
-
-Abstract
-
-   This document describes the RELATIONAL extension to the Sieve mail
-   filtering language defined in RFC 3028.  This extension extends
-   existing conditional tests in Sieve to allow relational operators.
-   In addition to testing their content, it also allows for testing of
-   the number of entities in header and envelope fields.
-
-1 Introduction
-
-   Sieve [SIEVE] is a language for filtering e-mail messages at the time
-   of final delivery.  It is designed to be implementable on either a
-   mail client or mail server.  It is meant to be extensible, simple,
-   and independent of access protocol, mail architecture, and operating
-   system.  It is suitable for running on a mail server where users may
-   not be allowed to execute arbitrary programs, such as on black box
-   Internet Messages Access Protocol (IMAP) servers, as it has no
-   variables, loops, nor the ability to shell out to external programs.
-
-   The RELATIONAL extension provides relational operators on the
-   address, envelope, and header tests.  This extension also provides a
-   way of counting the entities in a message header or address field.
-
-   With this extension, the sieve script may now determine if a field is
-   greater than or less than a value instead of just equivalent.  One
-   use is for the x-priority field: move messages with a priority
-   greater than 3 to the "work on later" folder.  Mail could also be
-   sorted by the from address.  Those userids that start with 'a'-'m' go
-   to one folder, and the rest go to another folder.
-
-
-
-Segmuller                   Standards Track                     [Page 1]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-   The sieve script can also determine the number of fields in the
-   header, or the number of addresses in a recipient field.  For
-   example:  are there more than 5 addresses in the to and cc fields.
-
-2 Conventions used in this document
-
-   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-   "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this
-   document are to be interpreted as described in BCP 14, RFC 2119.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   the use of [KEYWORDS] and "Syntax:" label for the definition of
-   action and tagged arguments syntax, and the use of [ABNF].
-
-   The capability string associated with extension defined in this
-   document is "relational".
-
-3 Comparators
-
-   This document does not define any comparators or exempt any
-   comparators from the require clause.  Any comparator used, other than
-   "i;octet" and "i;ascii-casemap", MUST be declared a require clause as
-   defined in [SIEVE].
-
-   The "i;ascii-numeric" comparator, as defined in [ACAP], MUST be
-   supported for any implementation of this extension.  The comparator
-   "i;ascii-numeric" MUST support at least 32 bit unsigned integers.
-
-   Larger integers MAY be supported.  Note: the "i;ascii-numeric"
-   comparator does not support negative numbers.
-
-4 Match Type
-
-   This document defines two new match types.  They are the VALUE match
-   type and the COUNT match type.
-
-     The syntax is:
-
-        MATCH-TYPE =/ COUNT / VALUE
-
-        COUNT = ":count" relational-match
-
-        VALUE = ":value" relational-match
-
-        relational-match = DQUOTE ( "gt" / "ge" / "lt"
-                                    / "le" / "eq" / "ne" ) DQUOTE
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 2]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-4.1  Match Type Value
-
-   The VALUE match type does a relational comparison between strings.
-
-   The VALUE match type may be used with any comparator which returns
-   sort information.
-
-   Leading and trailing white space MUST be removed from the value of
-   the message for the comparison.  White space is defined as
-
-                             SP / HTAB / CRLF
-
-   A value from the message is considered the left side of the relation.
-   A value from the test expression, the key-list for address, envelope,
-   and header tests, is the right side of the relation.
-
-   If there are multiple values on either side or both sides, the test
-   is considered true, if any pair is true.
-
-4.2  Match Type Count
-
-   The COUNT match type first determines the number of the specified
-   entities in the message and does a relational comparison of the
-   number of entities to the values specified in the test expression.
-
-   The COUNT match type SHOULD only be used with numeric comparators.
-
-   The Address Test counts the number of recipients in the specified
-   fields.  Group names are ignored.
-
-   The Envelope Test counts the number of recipients in the specified
-   envelope parts.  The envelope "to" will always have only one entry,
-   which is the address of the user for whom the sieve script is
-   running.  There is no way a sieve script can determine if the message
-   was actually sent to someone else using this test.  The envelope
-   "from" will be 0 if the MAIL FROM is blank, or 1 if MAIL FROM is not
-   blank.
-
-   The Header Test counts the total number of instances of the specified
-   fields.  This does not count individual addresses in the "to", "cc",
-   and other recipient fields.
-
-   In all cases, if more than one field name is specified, the counts
-   for all specified fields are added together to obtain the number for
-   comparison.  Thus, specifying ["to", "cc"] in an address COUNT test,
-   comparing the total number of "to" and "cc" addresses; if separate
-   counts are desired, they must be done in two comparisons, perhaps
-   joined by "allof" or "anyof".
-
-
-
-Segmuller                   Standards Track                     [Page 3]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-5 Security Considerations
-
-   Security considerations are discussed in [SIEVE].
-
-   An implementation MUST ensure that the test for envelope "to" only
-   reflects the delivery to the current user.  It MUST not be possible
-   for a user to determine if this message was delivered to someone else
-   using this test.
-
-6 Example
-
-   Using the message:
-
-      received: ...
-      received: ...
-      subject: example
-      to: foo@example.com.invalid, baz@example.com.invalid
-      cc: qux@example.com.invalid
-
-   The test:
-
-        address :count "ge" :comparator "i;ascii-numeric" ["to", "cc"]
-      ["3"]
-
-      would be true and the test
-
-         anyof ( address :count "ge" :comparator "i;ascii-numeric"
-                         ["to"] ["3"],
-                 address :count "ge" :comparator "i;ascii-numeric"
-                         ["cc"] ["3"] )
-
-      would be false.
-
-      To check the number of received fields in the header, the
-      following test may be used:
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                        ["received"] ["3"]
-
-      This would return false.  But
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                          ["received", "subject"] ["3"]
-
-      would return true.
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 4]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-   The test:
-
-         header :count "ge" :comparator "i;ascii-numeric"
-                       ["to", "cc"] ["3"]
-
-   will always return false on an RFC 2822 compliant message [RFC2822],
-   since a message can have at most one "to" field and at most one "cc"
-   field.  This test counts the number of fields, not the number of
-   addresses.
-
-7 Extended Example
-
-   require ["relational", "comparator-i;ascii-numeric"];
-
-   if header :value "lt" :comparator "i;ascii-numeric"
-             ["x-priority"] ["3"]
-   {
-      fileinto "Priority";
-   }
-
-   elseif address :count "gt" :comparator "i;ascii-numeric"
-              ["to"] ["5"]
-   {
-      # everything with more than 5 recipients in the "to" field
-      # is considered SPAM
-      fileinto "SPAM";
-   }
-
-   elseif address :value "gt" :all :comparator "i;ascii-casemap"
-              ["from"] ["M"]
-   {
-      fileinto "From N-Z";
-   } else {
-      fileinto "From A-M";
-   }
-
-   if allof ( address :count "eq" :comparator "i;ascii-numeric"
-                      ["to", "cc"] ["1"] ,
-              address :all :comparator "i;ascii-casemap"
-                      ["to", "cc"] ["me@foo.example.com.invalid"]
-   {
-      fileinto "Only me";
-   }
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 5]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-8 IANA Considerations
-
-   The following template specifies the IANA registration of the Sieve
-   extension specified in this document:
-
-   To: iana@iana.org
-   Subject: Registration of new Sieve extension
-
-   Capability name: RELATIONAL
-   Capability keyword: relational
-   Capability arguments: N/A
-   Standards Track/IESG-approved experimental RFC number: this RFC
-   Person and email address to contact for further information:
-    Wolfgang Segmuller
-    IBM T.J. Watson Research Center
-    30 Saw Mill River Rd
-    Hawthorne, NY 10532
-
-    Email: whs@watson.ibm.com
-
-   This information should be added to the list of sieve extensions
-   given on http://www.iana.org/assignments/sieve-extensions.
-
-9 References
-
-9.1 Normative References
-
-   [SIEVE]     Showalter, T., "Sieve: A Mail Filtering Language", RFC
-               3028, January 2001.
-
-   [Keywords]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", BCP 14, RFC 2119, March 1997.
-
-   [ABNF]      Crocker, D., "Augmented BNF for Syntax Specifications:
-               ABNF", RFC 2234, November 1997.
-
-   [RFC2822]   Resnick, P., "Internet Message Format", RFC 2822, April
-               2001.
-
-9.2 Non-Normative References
-
-   [ACAP]      Newman, C. and J. G. Myers, "ACAP -- Application
-               Configuration Access Protocol", RFC 2244, November 1997.
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 6]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-10 Author's Address
-
-   Wolfgang Segmuller
-   IBM T.J. Watson Research Center
-   30 Saw Mill River Rd
-   Hawthorne, NY  10532
-
-   EMail: whs@watson.ibm.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 7]
-
-RFC 3431           Sieve Extension: Relational Tests       December 2002
-
-
-11 Full Copyright Statement
-
-   Copyright (C) The Internet Society (2002).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Segmuller                   Standards Track                     [Page 8]
-
+http://ktown.kde.org/~dirk/sieve/rfc3431.txt
Index: kioslaves/sieve/rfc3028.txt
===================================================================
--- kioslaves/sieve/rfc3028.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/rfc3028.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,2019 +1 @@
-
-
-
-
-
-
-Network Working Group                                       T. Showalter
-Request for Comments: 3028                               Mirapoint, Inc.
-Category: Standards Track                                   January 2001
-
-
-                    Sieve: A Mail Filtering Language
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2001).  All Rights Reserved.
-
-Abstract
-
-   This document describes a language for filtering e-mail messages at
-   time of final delivery.  It is designed to be implementable on either
-   a mail client or mail server.  It is meant to be extensible, simple,
-   and independent of access protocol, mail architecture, and operating
-   system.  It is suitable for running on a mail server where users may
-   not be allowed to execute arbitrary programs, such as on black box
-   Internet Message Access Protocol (IMAP) servers, as it has no
-   variables, loops, or ability to shell out to external programs.
-
-Table of Contents
-
-   1.      Introduction ...........................................   3
-   1.1.     Conventions Used in This Document .....................   4
-   1.2.     Example mail messages .................................   4
-   2.      Design .................................................   5
-   2.1.     Form of the Language ..................................   5
-   2.2.     Whitespace ............................................   5
-   2.3.     Comments ..............................................   6
-   2.4.     Literal Data ..........................................   6
-   2.4.1.   Numbers ...............................................   6
-   2.4.2.   Strings ...............................................   7
-   2.4.2.1. String Lists ..........................................   7
-   2.4.2.2. Headers ...............................................   8
-   2.4.2.3. Addresses .............................................   8
-   2.4.2.4. MIME Parts ............................................   9
-   2.5.     Tests .................................................   9
-   2.5.1.   Test Lists ............................................   9
-
-
-
-Showalter                   Standards Track                     [Page 1]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   2.6.     Arguments .............................................   9
-   2.6.1.   Positional Arguments ..................................   9
-   2.6.2.   Tagged Arguments ......................................  10
-   2.6.3.   Optional Arguments ....................................  10
-   2.6.4.   Types of Arguments ....................................  10
-   2.7.     String Comparison .....................................  11
-   2.7.1.   Match Type ............................................  11
-   2.7.2.   Comparisons Across Character Sets .....................  12
-   2.7.3.   Comparators ...........................................  12
-   2.7.4.   Comparisons Against Addresses .........................  13
-   2.8.     Blocks ................................................  14
-   2.9.     Commands ..............................................  14
-   2.10.    Evaluation ............................................  15
-   2.10.1.  Action Interaction ....................................  15
-   2.10.2.  Implicit Keep .........................................  15
-   2.10.3.  Message Uniqueness in a Mailbox .......................  15
-   2.10.4.  Limits on Numbers of Actions ..........................  16
-   2.10.5.  Extensions and Optional Features ......................  16
-   2.10.6.  Errors ................................................  17
-   2.10.7.  Limits on Execution ...................................  17
-   3.      Control Commands .......................................  17
-   3.1.     Control Structure If ..................................  18
-   3.2.     Control Structure Require .............................  19
-   3.3.     Control Structure Stop ................................  19
-   4.      Action Commands ........................................  19
-   4.1.     Action reject .........................................  20
-   4.2.     Action fileinto .......................................  20
-   4.3.     Action redirect .......................................  21
-   4.4.     Action keep ...........................................  21
-   4.5.     Action discard ........................................  22
-   5.      Test Commands ..........................................  22
-   5.1.     Test address ..........................................  23
-   5.2.     Test allof ............................................  23
-   5.3.     Test anyof ............................................  24
-   5.4.     Test envelope .........................................  24
-   5.5.     Test exists ...........................................  25
-   5.6.     Test false ............................................  25
-   5.7.     Test header ...........................................  25
-   5.8.     Test not ..............................................  26
-   5.9.     Test size .............................................  26
-   5.10.    Test true .............................................  26
-   6.      Extensibility ..........................................  26
-   6.1.     Capability String .....................................  27
-   6.2.     IANA Considerations ...................................  28
-   6.2.1.   Template for Capability Registrations .................  28
-   6.2.2.   Initial Capability Registrations ......................  28
-   6.3.     Capability Transport ..................................  29
-   7.      Transmission ...........................................  29
-
-
-
-Showalter                   Standards Track                     [Page 2]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   8.      Parsing ................................................  30
-   8.1.     Lexical Tokens ........................................  30
-   8.2.     Grammar ...............................................  31
-   9.      Extended Example .......................................  32
-   10.     Security Considerations ................................  34
-   11.     Acknowledgments ........................................  34
-   12.     Author's Address .......................................  34
-   13.     References .............................................  34
-   14.     Full Copyright Statement ...............................  36
-
-1.      Introduction
-
-   This memo documents a language that can be used to create filters for
-   electronic mail.  It is not tied to any particular operating system or
-   mail architecture.  It requires the use of [IMAIL]-compliant
-   messages, but should otherwise generalize to many systems.
-
-   The language is powerful enough to be useful but limited in order to
-   allow for a safe server-side filtering system.  The intention is to
-   make it impossible for users to do anything more complex (and
-   dangerous) than write simple mail filters, along with facilitating
-   the use of GUIs for filter creation and manipulation.  The language is
-   not Turing-complete: it provides no way to write a loop or a function
-   and variables are not provided.
-
-   Scripts written in Sieve are executed during final delivery, when the
-   message is moved to the user-accessible mailbox.  In systems where
-   the MTA does final delivery, such as traditional Unix mail, it is
-   reasonable to sort when the MTA deposits mail into the user's
-   mailbox.
-
-   There are a number of reasons to use a filtering system.  Mail
-   traffic for most users has been increasing due to increased usage of
-   e-mail, the emergence of unsolicited email as a form of advertising,
-   and increased usage of mailing lists.
-
-   Experience at Carnegie Mellon has shown that if a filtering system is
-   made available to users, many will make use of it in order to file
-   messages from specific users or mailing lists.  However, many others
-   did not make use of the Andrew system's FLAMES filtering language
-   [FLAMES] due to difficulty in setting it up.
-
-   Because of the expectation that users will make use of filtering if
-   it is offered and easy to use, this language has been made simple
-   enough to allow many users to make use of it, but rich enough that it
-   can be used productively.  However, it is expected that GUI-based
-   editors will be the preferred way of editing filters for a large
-   number of users.
-
-
-
-Showalter                   Standards Track                     [Page 3]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-1.1.     Conventions Used in This Document
-
-   In the sections of this document that discuss the requirements of
-   various keywords and operators, the following conventions have been
-   adopted.
-
-   The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and
-   "MAY" in this document are to be interpreted as defined in
-   [KEYWORDS].
-
-   Each section on a command (test, action, or control structure) has a
-   line labeled "Syntax:".  This line describes the syntax of the
-   command, including its name and its arguments.  Required arguments
-   are listed inside angle brackets ("<" and ">").  Optional arguments
-   are listed inside square brackets ("[" and "]").  Each argument is
-   followed by its type, so "<key: string>" represents an argument
-   called "key" that is a string.  Literal strings are represented with
-   double-quoted strings.  Alternatives are separated with slashes, and
-   parenthesis are used for grouping, similar to [ABNF].
-
-   In the "Syntax" line, there are three special pieces of syntax that
-   are frequently repeated, MATCH-TYPE, COMPARATOR, and ADDRESS-PART.
-   These are discussed in sections 2.7.1, 2.7.3, and 2.7.4,
-   respectively.
-
-   The formal grammar for these commands in section 10 and is the
-   authoritative reference on how to construct commands, but the formal
-   grammar does not specify the order, semantics, number or types of
-   arguments to commands, nor the legal command names.  The intent is to
-   allow for extension without changing the grammar.
-
-1.2.     Example mail messages
-
-   The following mail messages will be used throughout this document in
-   examples.
-
-   Message A
-   -----------------------------------------------------------
-   Date: Tue, 1 Apr 1997 09:06:31 -0800 (PST)
-   From: coyote@desert.example.org
-   To: roadrunner@acme.example.com
-   Subject: I have a present for you
-
-   Look, I'm sorry about the whole anvil thing, and I really
-   didn't mean to try and drop it on you from the top of the
-   cliff.  I want to try to make it up to you.  I've got some
-   great birdseed over here at my place--top of the line
-
-
-
-
-Showalter                   Standards Track                     [Page 4]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   stuff--and if you come by, I'll have it all wrapped up
-   for you.  I'm really sorry for all the problems I've caused
-   for you over the years, but I know we can work this out.
-   --
-   Wile E. Coyote   "Super Genius"   coyote@desert.example.org
-   -----------------------------------------------------------
-
-   Message B
-   -----------------------------------------------------------
-   From: youcouldberich!@reply-by-postal-mail.invalid
-   Sender: b1ff@de.res.example.com
-   To: rube@landru.example.edu
-   Date:  Mon, 31 Mar 1997 18:26:10 -0800
-   Subject: $$$ YOU, TOO, CAN BE A MILLIONAIRE! $$$
-
-   YOU MAY HAVE ALREADY WON TEN MILLION DOLLARS, BUT I DOUBT
-   IT!  SO JUST POST THIS TO SIX HUNDRED NEWSGROUPS!  IT WILL
-   GUARANTEE THAT YOU GET AT LEAST FIVE RESPONSES WITH MONEY!
-   MONEY! MONEY! COLD HARD CASH!  YOU WILL RECEIVE OVER
-   $20,000 IN LESS THAN TWO MONTHS!  AND IT'S LEGAL!!!!!!!!!
-   !!!!!!!!!!!!!!!!!!111111111!!!!!!!11111111111!!1  JUST
-   SEND $5 IN SMALL, UNMARKED BILLS TO THE ADDRESSES BELOW!
-   -----------------------------------------------------------
-
-2.      Design
-
-2.1.     Form of the Language
-
-   The language consists of a set of commands.  Each command consists of
-   a set of tokens delimited by whitespace.  The command identifier is
-   the first token and it is followed by zero or more argument tokens.
-   Arguments may be literal data, tags, blocks of commands, or test
-   commands.
-
-   The language is represented in UTF-8, as specified in [UTF-8].
-
-   Tokens in the ASCII range are considered case-insensitive.
-
-2.2.     Whitespace
-
-   Whitespace is used to separate tokens.  Whitespace is made up of
-   tabs, newlines (CRLF, never just CR or LF), and the space character.
-   The amount of whitespace used is not significant.
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                     [Page 5]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.3.     Comments
-
-   Two types of comments are offered.  Comments are semantically
-   equivalent to whitespace and can be used anyplace that whitespace is
-   (with one exception in multi-line strings, as described in the
-   grammar).
-
-   Hash comments begin with a "#" character that is not contained within
-   a string and continue until the next CRLF.
-
-   Example:  if size :over 100K { # this is a comment
-                discard;
-             }
-
-   Bracketed comments begin with the token "/*" and end with "*/" outside
-   of a string.  Bracketed comments may span multiple lines. Bracketed
-   comments do not nest.
-
-   Example:  if size :over 100K { /* this is a comment
-                this is still a comment */ discard /* this is a comment
-                */ ;
-             }
-
-2.4.     Literal Data
-
-   Literal data means data that is not executed, merely evaluated "as
-   is", to be used as arguments to commands.  Literal data is limited to
-   numbers and strings.
-
-2.4.1.   Numbers
-
-   Numbers are given as ordinary decimal numbers.  However, those
-   numbers that have a tendency to be fairly large, such as message
-   sizes, MAY have a "K", "M", or "G" appended to indicate a multiple of
-   a power of two.  To be comparable with the power-of-two-based
-   versions of SI units that computers frequently use, K specifies
-   kibi-, or 1,024 (2^10) times the value of the number; M specifies
-   mebi-, or 1,048,576 (2^20) times the value of the number; and G
-   specifies tebi-, or 1,073,741,824 (2^30) times the value of the
-   number [BINARY-SI].
-
-   Implementations MUST provide 31 bits of magnitude in numbers, but MAY
-   provide more.
-
-   Only positive integers are permitted by this specification.
-
-
-
-
-
-
-Showalter                   Standards Track                     [Page 6]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.4.2.   Strings
-
-   Scripts involve large numbers of strings as they are used for pattern
-   matching, addresses, textual bodies, etc.  Typically, short quoted
-   strings suffice for most uses, but a more convenient form is provided
-   for longer strings such as bodies of messages.
-
-   A quoted string starts and ends with a single double quote (the <">
-   character, ASCII 34).  A backslash ("\", ASCII 92) inside of a quoted
-   string is followed by either another backslash or a double quote.
-   This two-character sequence represents a single backslash or double-
-   quote within the string, respectively.
-
-   No other characters should be escaped with a single backslash.
-
-   An undefined escape sequence (such as "\a" in a context where "a" has
-   no special meaning) is interpreted as if there were no backslash (in
-   this case, "\a" is just "a").
-
-   Non-printing characters such as tabs, CR and LF, and control
-   characters are permitted in quoted strings.  Quoted strings MAY span
-   multiple lines.  NUL (ASCII 0) is not allowed in strings.
-
-   For entering larger amounts of text, such as an email message, a
-   multi-line form is allowed.  It starts with the keyword "text:",
-   followed by a CRLF, and ends with the sequence of a CRLF, a single
-   period, and another CRLF.  In order to allow the message to contain
-   lines with a single-dot, lines are dot-stuffed.  That is, when
-   composing a message body, an extra `.' is added before each line
-   which begins with a `.'.  When the server interprets the script,
-   these extra dots are removed.  Note that a line that begins with a
-   dot followed by a non-dot character is not interpreted dot-stuffed;
-   that is, ".foo" is interpreted as ".foo".  However, because this is
-   potentially ambiguous, scripts SHOULD be properly dot-stuffed so such
-   lines do not appear.
-
-   Note that a hashed comment or whitespace may occur in between the
-   "text:" and the CRLF, but not within the string itself.  Bracketed
-   comments are not allowed here.
-
-2.4.2.1. String Lists
-
-   When matching patterns, it is frequently convenient to match against
-   groups of strings instead of single strings.  For this reason, a list
-   of strings is allowed in many tests, implying that if the test is
-   true using any one of the strings, then the test is true.
-   Implementations are encouraged to use short-circuit evaluation in
-   these cases.
-
-
-
-Showalter                   Standards Track                     [Page 7]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   For instance, the test `header :contains ["To", "Cc"]
-   ["me@example.com", "me00@landru.example.edu"]' is true if either the
-   To header or Cc header of the input message contains either of the
-   e-mail addresses "me@example.com" or "me00@landru.example.edu".
-
-   Conversely, in any case where a list of strings is appropriate, a
-   single string is allowed without being a member of a list: it is
-   equivalent to a list with a single member.  This means that the test
-   `exists "To"' is equivalent to the test `exists ["To"]'.
-
-2.4.2.2. Headers
-
-   Headers are a subset of strings.  In the Internet Message
-   Specification [IMAIL] [RFC1123], each header line is allowed to have
-   whitespace nearly anywhere in the line, including after the field
-   name and before the subsequent colon.  Extra spaces between the
-   header name and the ":" in a header field are ignored.
-
-   A header name never contains a colon.  The "From" header refers to a
-   line beginning "From:" (or "From   :", etc.).  No header will match
-   the string "From:" due to the trailing colon.
-
-   Folding of long header lines (as described in [IMAIL] 3.4.8) is
-   removed prior to interpretation of the data.  The folding syntax (the
-   CRLF that ends a line plus any leading whitespace at the beginning of
-   the next line that indicates folding) are interpreted as if they were
-   a single space.
-
-2.4.2.3. Addresses
-
-   A number of commands call for email addresses, which are also a
-   subset of strings.  When these addresses are used in outbound
-   contexts, addresses must be compliant with [IMAIL], but are further
-   constrained.  Using the symbols defined in [IMAIL], section 6.1, the
-   syntax of an address is:
-
-   sieve-address = addr-spec                ; simple address
-                 / phrase "<" addr-spec ">" ; name & addr-spec
-
-   That is, routes and group syntax are not permitted.  If multiple
-   addresses are required, use a string list.  Named groups are not used
-   here.
-
-   Implementations MUST ensure that the addresses are syntactically
-   valid, but need not ensure that they actually identify an email
-   recipient.
-
-
-
-
-
-Showalter                   Standards Track                     [Page 8]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.4.2.4. MIME Parts
-
-   In a few places, [MIME] body parts are represented as strings.  These
-   parts include MIME headers and the body.  This provides a way of
-   embedding typed data within a Sieve script so that, among other
-   things, character sets other than UTF-8 can be used for output
-   messages.
-
-2.5.     Tests
-
-   Tests are given as arguments to commands in order to control their
-   actions.  In this document, tests are given to if/elsif/else to
-   decide which block of code is run.
-
-   Tests MUST NOT have side effects.  That is, a test cannot affect the
-   state of the filter or message.  No tests in this specification have
-   side effects, and side effects are forbidden in extension tests as
-   well.
-
-   The rationale for this is that tests with side effects impair
-   readability and maintainability and are difficult to represent in a
-   graphic interface for generating scripts.  Side effects are confined
-   to actions where they are clearer.
-
-2.5.1.   Test Lists
-
-   Some tests ("allof" and "anyof", which implement logical "and" and
-   logical "or", respectively) may require more than a single test as an
-   argument.  The test-list syntax element provides a way of grouping
-   tests.
-
-   Example:  if anyof (not exists ["From", "Date"],
-                   header :contains "from" "fool@example.edu") {
-                discard;
-             }
-
-2.6.     Arguments
-
-   In order to specify what to do, most commands take arguments.  There
-   are three types of arguments: positional, tagged, and optional.
-
-2.6.1.   Positional Arguments
-
-   Positional arguments are given to a command which discerns their
-   meaning based on their order.  When a command takes positional
-   arguments, all positional arguments must be supplied and must be in
-   the order prescribed.
-
-
-
-
-Showalter                   Standards Track                     [Page 9]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.6.2.   Tagged Arguments
-
-   This document provides for tagged arguments in the style of
-   CommonLISP.  These are also similar to flags given to commands in
-   most command-line systems.
-
-   A tagged argument is an argument for a command that begins with ":"
-   followed by a tag naming the argument, such as ":contains".  This
-   argument means that zero or more of the next tokens have some
-   particular meaning depending on the argument.  These next tokens may
-   be numbers or strings but they are never blocks.
-
-   Tagged arguments are similar to positional arguments, except that
-   instead of the meaning being derived from the command, it is derived
-   from the tag.
-
-   Tagged arguments must appear before positional arguments, but they
-   may appear in any order with other tagged arguments.  For simplicity
-   of the specification, this is not expressed in the syntax definitions
-   with commands, but they still may be reordered arbitrarily provided
-   they appear before positional arguments.  Tagged arguments may be
-   mixed with optional arguments.
-
-   To simplify this specification, tagged arguments SHOULD NOT take
-   tagged arguments as arguments.
-
-2.6.3.   Optional Arguments
-
-   Optional arguments are exactly like tagged arguments except that they
-   may be left out, in which case a default value is implied.  Because
-   optional arguments tend to result in shorter scripts, they have been
-   used far more than tagged arguments.
-
-   One particularly noteworthy case is the ":comparator" argument, which
-   allows the user to specify which [ACAP] comparator will be used to
-   compare two strings, since different languages may impose different
-   orderings on UTF-8 [UTF-8] characters.
-
-2.6.4.   Types of Arguments
-
-   Abstractly, arguments may be literal data, tests, or blocks of
-   commands.  In this way, an "if" control structure is merely a command
-   that happens to take a test and a block as arguments and may execute
-   the block of code.
-
-   However, this abstraction is ambiguous from a parsing standpoint.
-   The grammar in section 9.2 presents a parsable version of this:
-   Arguments are string-lists, numbers, and tags, which may be followed
-
-
-
-Showalter                   Standards Track                    [Page 10]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   by a test or a test-list, which may be followed by a block of
-   commands.  No more than one test or test list, nor more than one
-   block of commands, may be used, and commands that end with blocks of
-   commands do not end with semicolons.
-
-2.7.     String Comparison
-
-   When matching one string against another, there are a number of ways
-   of performing the match operation.  These are accomplished with three
-   types of matches: an exact match, a substring match, and a wildcard
-   glob-style match.  These are described below.
-
-   In order to provide for matches between character sets and case
-   insensitivity, Sieve borrows ACAP's comparator registry.
-
-   However, when a string represents the name of a header, the
-   comparator is never user-specified.  Header comparisons are always
-   done with the "i;ascii-casemap" operator, i.e., case-insensitive
-   comparisons, because this is the way things are defined in the
-   message specification [IMAIL].
-
-2.7.1.   Match Type
-
-   There are three match types describing the matching used in this
-   specification:  ":is", ":contains", and ":matches".  Match type
-   arguments are supplied to those commands which allow them to specify
-   what kind of match is to be performed.
-
-   These are used as tagged arguments to tests that perform string
-   comparison.
-
-   The ":contains" match type describes a substring match.  If the value
-   argument contains the key argument as a substring, the match is true.
-   For instance, the string "frobnitzm" contains "frob" and "nit", but
-   not "fbm".  The null key ("") is contained in all values.
-
-   The ":is" match type describes an absolute match; if the contents of
-   the first string are absolutely the same as the contents of the
-   second string, they match.  Only the string "frobnitzm" is the string
-   "frobnitzm".  The null key ":is" and only ":is" the null value.
-
-   The ":matches" version specifies a wildcard match using the
-   characters "*" and "?".  "*" matches zero or more characters, and "?"
-   matches a single character.  "?" and "*" may be escaped as "\\?" and
-   "\\*" in strings to match against themselves.  The first backslash
-   escapes the second backslash; together, they escape the "*".  This is
-   awkward, but it is commonplace in several programming languages that
-   use globs and regular expressions.
-
-
-
-Showalter                   Standards Track                    [Page 11]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   In order to specify what type of match is supposed to happen,
-   commands that support matching take optional tagged arguments
-   ":matches", ":is", and ":contains".  Commands default to using ":is"
-   matching if no match type argument is supplied.  Note that these
-   modifiers may interact with comparators; in particular, some
-   comparators are not suitable for matching with ":contains" or
-   ":matches".  It is an error to use a comparator with ":contains" or
-   ":matches" that is not compatible with it.
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-   For convenience, the "MATCH-TYPE" syntax element is defined  here  as
-   follows:
-
-   Syntax:   ":is" / ":contains" / ":matches"
-
-2.7.2.   Comparisons Across Character Sets
-
-   All Sieve scripts are represented in UTF-8, but messages may involve
-   a number of character sets.  In order for comparisons to work across
-   character sets, implementations SHOULD implement the following
-   behavior:
-
-      Implementations decode header charsets to UTF-8.  Two strings are
-      considered equal if their UTF-8 representations are identical.
-      Implementations should decode charsets represented in the forms
-      specified by [MIME] for both message headers and bodies.
-      Implementations must be capable of decoding US-ASCII, ISO-8859-1,
-      the ASCII subset of ISO-8859-* character sets, and UTF-8.
-
-   If implementations fail to support the above behavior, they MUST
-   conform to the following:
-
-      No two strings can be considered equal if one contains octets
-      greater than 127.
-
-2.7.3.   Comparators
-
-   In order to allow for language-independent, case-independent matches,
-   the match type may be coupled with a comparator name.  Comparators
-   are described for [ACAP]; a registry is defined for ACAP, and this
-   specification uses that registry.
-
-   ACAP defines multiple comparator types.  Only equality types are used
-   in this specification.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 12]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   All implementations MUST support the "i;octet" comparator (simply
-   compares octets) and the "i;ascii-casemap" comparator (which treats
-   uppercase and lowercase characters in the ASCII subset of UTF-8 as
-   the same).  If left unspecified, the default is "i;ascii-casemap".
-
-   Some comparators may not be usable with substring matches; that is,
-   they may only work with ":is".  It is an error to try and use a
-   comparator with ":matches" or ":contains" that is not compatible with
-   it.
-
-   A comparator is specified by the ":comparator" option with commands
-   that support matching.  This option is followed by a string providing
-   the name of the comparator to be used.  For convenience, the syntax
-   of a comparator is abbreviated to "COMPARATOR", and (repeated in
-   several tests) is as follows:
-
-   Syntax:   ":comparator" <comparator-name: string>
-
-   So in this example,
-
-   Example:  if header :contains :comparator "i;octet" "Subject"
-                "MAKE MONEY FAST" {
-                   discard;
-             }
-
-   would discard any message with subjects like "You can MAKE MONEY
-   FAST", but not "You can Make Money Fast", since the comparator used
-   is case-sensitive.
-
-   Comparators other than i;octet and i;ascii-casemap must be declared
-   with require, as they are extensions.  If a comparator declared with
-   require is not known, it is an error, and execution fails.  If the
-   comparator is not declared with require, it is also an error, even if
-   the comparator is supported.  (See 2.10.5.)
-
-   Both ":matches" and ":contains" match types are compatible with the
-   "i;octet" and "i;ascii-casemap" comparators and may be used with
-   them.
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-2.7.4.   Comparisons Against Addresses
-
-   Addresses are one of the most frequent things represented as strings.
-   These are structured, and being able to compare against the local-
-   part or the domain of an address is useful, so some tests that act
-
-
-
-
-Showalter                   Standards Track                    [Page 13]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   exclusively on addresses take an additional optional argument that
-   specifies what the test acts on.
-
-   These optional arguments are ":localpart", ":domain", and ":all",
-   which act on the local-part (left-side), the domain part (right-
-   side), and the whole address.
-
-   The kind of comparison done, such as whether or not the test done is
-   case-insensitive, is specified as a comparator argument to the test.
-
-   If an optional address-part is omitted, the default is ":all".
-
-   It is an error to give more than one of these arguments to a given
-   command.
-
-   For convenience, the "ADDRESS-PART" syntax element is defined here as
-   follows:
-
-   Syntax:   ":localpart" / ":domain" / ":all"
-
-2.8.     Blocks
-
-   Blocks are sets of commands enclosed within curly braces.  Blocks are
-   supplied to commands so that the commands can implement control
-   commands.
-
-   A control structure is a command that happens to take a test and a
-   block as one of its arguments; depending on the result of the test
-   supplied as another argument, it runs the code in the block some
-   number of times.
-
-   With the commands supplied in this memo, there are no loops.  The
-   control structures supplied--if, elsif, and else--run a block either
-   once or not at all.  So there are two arguments, the test and the
-   block.
-
-2.9.     Commands
-
-   Sieve scripts are sequences of commands.  Commands can take any of
-   the tokens above as arguments, and arguments may be either tagged or
-   positional arguments.  Not all commands take all arguments.
-
-   There are three kinds of commands: test commands, action commands,
-   and control commands.
-
-   The simplest is an action command.  An action command is an
-   identifier followed by zero or more arguments, terminated by a
-   semicolon.  Action commands do not take tests or blocks as arguments.
-
-
-
-Showalter                   Standards Track                    [Page 14]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   A control command is similar, but it takes a test as an argument, and
-   ends with a block instead of a semicolon.
-
-   A test command is used as part of a control command.  It is used to
-   specify whether or not the block of code given to the control command
-   is executed.
-
-2.10.    Evaluation
-
-2.10.1.  Action Interaction
-
-   Some actions cannot be used with other actions because the result
-   would be absurd.  These restrictions are noted throughout this memo.
-
-   Extension actions MUST state how they interact with actions defined
-   in this specification.
-
-2.10.2.  Implicit Keep
-
-   Previous experience with filtering systems suggests that cases tend
-   to be missed in scripts.  To prevent errors, Sieve has an "implicit
-   keep".
-
-   An implicit keep is a keep action (see 4.4) performed in absence of
-   any action that cancels the implicit keep.
-
-   An implicit keep is performed if a message is not written to a
-   mailbox, redirected to a new address, or explicitly thrown out.  That
-   is, if a fileinto, a keep, a redirect, or a discard is performed, an
-   implicit keep is not.
-
-   Some actions may be defined to not cancel the implicit keep.  These
-   actions may not directly affect the delivery of a message, and are
-   used for their side effects.  None of the actions specified in this
-   document meet that criteria, but extension actions will.
-
-   For instance, with any of the short messages offered above, the
-   following script produces no actions.
-
-   Example:  if size :over 500K { discard; }
-
-   As a result, the implicit keep is taken.
-
-2.10.3.  Message Uniqueness in a Mailbox
-
-   Implementations SHOULD NOT deliver a message to the same folder more
-   than once, even if a script explicitly asks for a message to be
-   written to a mailbox twice.
-
-
-
-Showalter                   Standards Track                    [Page 15]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   The test for equality of two messages is implementation-defined.
-
-   If a script asks for a message to be written to a mailbox twice, it
-   MUST NOT be treated as an error.
-
-2.10.4.  Limits on Numbers of Actions
-
-   Site policy MAY limit numbers of actions taken and MAY impose
-   restrictions on which actions can be used together.  In the event
-   that a script hits a policy limit on the number of actions taken for
-   a particular message, an error occurs.
-
-   Implementations MUST prohibit more than one reject.
-
-   Implementations MUST allow at least one keep or one fileinto.  If
-   fileinto is not implemented, implementations MUST allow at least one
-   keep.
-
-   Implementations SHOULD prohibit reject when used with other actions.
-
-2.10.5.  Extensions and Optional Features
-
-   Because of the differing capabilities of many mail systems, several
-   features of this specification are optional.  Before any of these
-   extensions can be executed, they must be declared with the "require"
-   action.
-
-   If an extension is not enabled with "require", implementations MUST
-   treat it as if they did not support it at all.
-
-   If a script does not understand an extension declared with require,
-   the script must not be used at all.  Implementations MUST NOT execute
-   scripts which require unknown capability names.
-
-   Note: The reason for this restriction is that prior experiences with
-         languages such as LISP and Tcl suggest that this is a workable
-         way of noting that a given script uses an extension.
-
-         Experience with PostScript suggests that mechanisms that allow
-         a script to work around missing extensions are not used in
-         practice.
-
-   Extensions which define actions MUST state how they interact with
-   actions discussed in the base specification.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 16]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-2.10.6.  Errors
-
-   In any programming language, there are compile-time and run-time
-   errors.
-
-   Compile-time errors are ones in syntax that are detectable if a
-   syntax check is done.
-
-   Run-time errors are not detectable until the script is run.  This
-   includes transient failures like disk full conditions, but also
-   includes issues like invalid combinations of actions.
-
-   When an error occurs in a Sieve script, all processing stops.
-
-   Implementations MAY choose to do a full parse, then evaluate the
-   script, then do all actions.  Implementations might even go so far as
-   to ensure that execution is atomic (either all actions are executed
-   or none are executed).
-
-   Other implementations may choose to parse and run at the same time.
-   Such implementations are simpler, but have issues with partial
-   failure (some actions happen, others don't).
-
-   Implementations might even go so far as to ensure that scripts can
-   never execute an invalid set of actions (e.g., reject + fileinto)
-   before execution, although this could involve solving the Halting
-   Problem.
-
-   This specification allows any of these approaches.  Solving the
-   Halting Problem is considered extra credit.
-
-   When an error happens, implementations MUST notify the user that an
-   error occurred, which actions (if any) were taken, and do an implicit
-   keep.
-
-2.10.7.  Limits on Execution
-
-   Implementations may limit certain constructs.  However, this
-   specification places a lower bound on some of these limits.
-
-   Implementations MUST support fifteen levels of nested blocks.
-
-   Implementations MUST support fifteen levels of nested test lists.
-
-3.      Control Commands
-
-   Control structures are needed to allow for multiple and conditional
-   actions.
-
-
-
-Showalter                   Standards Track                    [Page 17]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-3.1.     Control Structure If
-
-   There are three pieces to if: "if", "elsif", and "else".  Each is
-   actually a separate command in terms of the grammar.  However, an
-   elsif MUST only follow an if, and an else MUST follow only either an
-   if or an elsif.  An error occurs if these conditions are not met.
-
-   Syntax:   if <test1: test> <block1: block>
-
-   Syntax:   elsif <test2: test> <block2: block>
-
-   Syntax:   else <block>
-
-   The semantics are similar to those of any of the many other
-   programming languages these control commands appear in.  When the
-   interpreter sees an "if", it evaluates the test associated with it.
-   If the test is true, it executes the block associated with it.
-
-   If the test of the "if" is false, it evaluates the test of the first
-   "elsif" (if any).  If the test of "elsif" is true, it runs the
-   elsif's block.  An elsif may be followed by an elsif, in which case,
-   the interpreter repeats this process until it runs out of elsifs.
-
-   When the interpreter runs out of elsifs, there may be an "else" case.
-   If there is, and none of the if or elsif tests were true, the
-   interpreter runs the else case.
-
-   This provides a way of performing exactly one of the blocks in the
-   chain.
-
-   In the following example, both Message A and B are dropped.
-
-   Example:  require "fileinto";
-             if header :contains "from" "coyote" {
-                discard;
-             } elsif header :contains ["subject"] ["$$$"] {
-                discard;
-             } else {
-                fileinto "INBOX";
-             }
-
-
-   When the script below is run over message A, it redirects the message
-   to  acm@example.edu;  message B, to postmaster@example.edu; any other
-   message is redirected to field@example.edu.
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 18]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Example:  if header :contains ["From"] ["coyote"] {
-                redirect "acm@example.edu";
-             } elsif header :contains "Subject" "$$$" {
-                redirect "postmaster@example.edu";
-             } else {
-                redirect "field@example.edu";
-             }
-
-   Note that this definition prohibits the "... else if ..." sequence
-   used by C.  This is intentional, because this construct produces a
-   shift-reduce conflict.
-
-3.2.     Control Structure Require
-
-   Syntax:   require <capabilities: string-list>
-
-   The require action notes that a script makes use of a certain
-   extension.  Such a declaration is required to use the extension, as
-   discussed in section 2.10.5.  Multiple capabilities can be declared
-   with a single require.
-
-   The require command, if present, MUST be used before anything other
-   than a require can be used.  An error occurs if a require appears
-   after a command other than require.
-
-   Example:  require ["fileinto", "reject"];
-
-   Example:  require "fileinto";
-             require "vacation";
-
-3.3.     Control Structure Stop
-
-   Syntax:   stop
-
-   The "stop" action ends all processing.  If no actions have been
-   executed, then the keep action is taken.
-
-4.      Action Commands
-
-   This document supplies five actions that may be taken on a message:
-   keep, fileinto, redirect, reject, and discard.
-
-   Implementations MUST support the "keep", "discard", and "redirect"
-   actions.
-
-   Implementations SHOULD support "reject" and "fileinto".
-
-
-
-
-
-Showalter                   Standards Track                    [Page 19]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Implementations MAY limit the number of certain actions taken (see
-   section 2.10.4).
-
-4.1.     Action reject
-
-   Syntax:   reject <reason: string>
-
-   The optional "reject" action refuses delivery of a message by sending
-   back an [MDN] to the sender.  It resends the message to the sender,
-   wrapping it in a "reject" form, noting that it was rejected by the
-   recipient.  In the following script, message A is rejected and
-   returned to the sender.
-
-   Example:  if header :contains "from" "coyote@desert.example.org" {
-                reject "I am not taking mail from you, and I don't want
-                your birdseed, either!";
-             }
-
-   A reject message MUST take the form of a failure MDN as specified  by
-   [MDN].    The  human-readable  portion  of  the  message,  the  first
-   component of the MDN, contains the human readable message  describing
-   the  error,  and  it  SHOULD  contain  additional  text  alerting the
-   original sender that mail was refused by a filter.  This part of  the
-   MDN might appear as follows:
-
-   ------------------------------------------------------------
-   Message was refused by recipient's mail filtering program.  Reason
-   given was as follows:
-
-   I am not taking mail from you, and I don't want your birdseed,
-   either!
-   ------------------------------------------------------------
-
-   The MDN action-value field as defined in the MDN specification MUST
-   be "deleted" and MUST have the MDN-sent-automatically and automatic-
-   action modes set.
-
-   Because some implementations can not or will not implement the reject
-   command, it is optional.  The capability string to be used with the
-   require command is "reject".
-
-4.2.     Action fileinto
-
-   Syntax:   fileinto <folder: string>
-
-   The "fileinto" action delivers the message into the specified folder.
-   Implementations SHOULD support fileinto, but in some environments
-   this may be impossible.
-
-
-
-Showalter                   Standards Track                    [Page 20]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   The capability string for use with the require command is "fileinto".
-
-   In the following script, message A is filed into folder
-   "INBOX.harassment".
-
-   Example:  require "fileinto";
-             if header :contains ["from"] "coyote" {
-                fileinto "INBOX.harassment";
-             }
-
-4.3.     Action redirect
-
-   Syntax:   redirect <address: string>
-
-   The "redirect" action is used to send the message to another user at
-   a supplied address, as a mail forwarding feature does.  The
-   "redirect" action makes no changes to the message body or existing
-   headers, but it may add new headers.  The "redirect" modifies the
-   envelope recipient.
-
-   The redirect command performs an MTA-style "forward"--that is, what
-   you get from a .forward file using sendmail under UNIX.  The address
-   on the SMTP envelope is replaced with the one on the redirect command
-   and the message is sent back out.  (This is not an MUA-style forward,
-   which creates a new message with a different sender and message ID,
-   wrapping the old message in a new one.)
-
-   A simple script can be used for redirecting all mail:
-
-   Example:  redirect "bart@example.edu";
-
-   Implementations SHOULD take measures to implement loop control,
-   possibly including adding headers to the message or counting received
-   headers.  If an implementation detects a loop, it causes an error.
-
-4.4.     Action keep
-
-   Syntax:   keep
-
-   The "keep" action is whatever action is taken in lieu of all other
-   actions, if no filtering happens at all; generally, this simply means
-   to file the message into the user's main mailbox.  This command
-   provides a way to execute this action without needing to know the
-   name of the user's main mailbox, providing a way to call it without
-   needing to understand the user's setup, or the underlying mail
-   system.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 21]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   For instance, in an implementation where the IMAP server is running
-   scripts on behalf of the user at time of delivery, a keep command is
-   equivalent to a fileinto "INBOX".
-
-   Example:  if size :under 1M { keep; } else { discard; }
-
-   Note that the above script is identical to the one below.
-
-   Example:  if not size :under 1M { discard; }
-
-4.5.     Action discard
-
-   Syntax:   discard
-
-   Discard is used to silently throw away the message.  It does so by
-   simply canceling the implicit keep.  If discard is used with other
-   actions, the other actions still happen.  Discard is compatible with
-   all other actions.  (For instance fileinto+discard is equivalent to
-   fileinto.)
-
-   Discard MUST be silent; that is, it MUST NOT return a non-delivery
-   notification of any kind ([DSN], [MDN], or otherwise).
-
-   In the following script, any mail from "idiot@example.edu" is thrown
-   out.
-
-   Example:  if header :contains ["from"] ["idiot@example.edu"] {
-                discard;
-             }
-
-   While an important part of this language, "discard" has the potential
-   to create serious problems for users: Students who leave themselves
-   logged in to an unattended machine in a public computer lab may find
-   their script changed to just "discard".  In order to protect users in
-   this situation (along with similar situations), implementations MAY
-   keep messages destroyed by a script for an indefinite period, and MAY
-   disallow scripts that throw out all mail.
-
-5.      Test Commands
-
-   Tests are used in conditionals to decide which part(s) of the
-   conditional to execute.
-
-   Implementations MUST support these tests: "address", "allof",
-   "anyof", "exists", "false", "header", "not", "size", and "true".
-
-   Implementations SHOULD support the "envelope" test.
-
-
-
-
-Showalter                   Standards Track                    [Page 22]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-5.1.     Test address
-
-   Syntax:   address [ADDRESS-PART] [COMPARATOR] [MATCH-TYPE]
-             <header-list: string-list> <key-list: string-list>
-
-   The address test matches Internet addresses in structured headers
-   that contain addresses.  It returns true if any header contains any
-   key in the specified part of the address, as modified by the
-   comparator and the match keyword.
-
-   Like envelope and header, this test returns true if any combination
-   of the header-list and key-list arguments match.
-
-   Internet email addresses [IMAIL] have the somewhat awkward
-   characteristic that the local-part to the left of the at-sign is
-   considered case sensitive, and the domain-part to the right of the
-   at-sign is case insensitive.  The "address" command does not deal
-   with this itself, but provides the ADDRESS-PART argument for allowing
-   users to deal with it.
-
-   The address primitive never acts on the phrase part of an email
-   address, nor on comments within that address.  It also never acts on
-   group names, although it does act on the addresses within the group
-   construct.
-
-   Implementations MUST restrict the address test to headers that
-   contain addresses, but MUST include at least From, To, Cc, Bcc,
-   Sender, Resent-From, Resent-To, and SHOULD include any other header
-   that utilizes an "address-list" structured header body.
-
-   Example:  if address :is :all "from" "tim@example.com" {
-                discard;
-
-5.2.     Test allof
-
-   Syntax:   allof <tests: test-list>
-
-   The allof test performs a logical AND on the tests supplied to it.
-
-   Example:  allof (false, false)  =>   false
-             allof (false, true)   =>   false
-             allof (true,  true)   =>   true
-
-   The allof test takes as its argument a test-list.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 23]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-5.3.     Test anyof
-
-   Syntax:   anyof <tests: test-list>
-
-   The anyof test performs a logical OR on the tests supplied to it.
-
-   Example:  anyof (false, false)  =>   false
-             anyof (false, true)   =>   true
-             anyof (true,  true)   =>   true
-
-5.4.     Test envelope
-
-   Syntax:   envelope [COMPARATOR] [ADDRESS-PART] [MATCH-TYPE]
-             <envelope-part: string-list> <key-list: string-list>
-
-   The "envelope" test is true if the specified part of the SMTP (or
-   equivalent) envelope matches the specified key.
-
-   If one of the envelope-part strings is (case insensitive) "from",
-   then matching occurs against the FROM address used in the SMTP MAIL
-   command.
-
-   If one of the envelope-part strings is (case insensitive) "to", then
-   matching occurs against the TO address used in the SMTP RCPT command
-   that resulted in this message getting delivered to this user.  Note
-   that only the most recent TO is available, and only the one relevant
-   to this user.
-
-   The envelope-part is a string list and may contain more than one
-   parameter, in which case all of the strings specified in the key-list
-   are matched against all parts given in the envelope-part list.
-
-   Like address and header, this test returns true if any combination of
-   the envelope-part and key-list arguments is true.
-
-   All tests against envelopes MUST drop source routes.
-
-   If the SMTP transaction involved several RCPT commands, only the data
-   from the RCPT command that caused delivery to this user is available
-   in the "to" part of the envelope.
-
-   If a protocol other than SMTP is used for message transport,
-   implementations are expected to adapt this command appropriately.
-
-   The envelope command is optional.  Implementations SHOULD support it,
-   but the necessary information may not be available in all cases.
-
-
-
-
-
-Showalter                   Standards Track                    [Page 24]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Example:  require "envelope";
-             if envelope :all :is "from" "tim@example.com" {
-                discard;
-             }
-
-5.5.     Test exists
-
-   Syntax:   exists <header-names: string-list>
-
-   The "exists" test is true if the headers listed in the header-names
-   argument exist within the message.  All of the headers must exist or
-   the test is false.
-
-   The following example throws out mail that doesn't have a From header
-   and a Date header.
-
-   Example:  if not exists ["From","Date"] {
-                discard;
-             }
-
-5.6.     Test false
-
-   Syntax:   false
-
-   The "false" test always evaluates to false.
-
-5.7.     Test header
-
-   Syntax:   header [COMPARATOR] [MATCH-TYPE]
-             <header-names: string-list> <key-list: string-list>
-
-   The "header" test evaluates to true if any header name matches any
-   key.  The type of match is specified by the optional match argument,
-   which defaults to ":is" if not specified, as specified in section
-   2.6.
-
-   Like address and envelope, this test returns true if any combination
-   of the string-list and key-list arguments match.
-
-   If a header listed in the header-names argument exists, it contains
-   the null key ("").  However, if the named header is not present, it
-   does not contain the null key.  So if a message contained the header
-
-           X-Caffeine: C8H10N4O2
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 25]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   these tests on that header evaluate as follows:
-
-           header :is ["X-Caffeine"] [""]         => false
-           header :contains ["X-Caffeine"] [""]   => true
-
-5.8.     Test not
-
-   Syntax:   not <test>
-
-   The "not" test takes some other test as an argument, and yields the
-   opposite result.  "not false" evaluates to "true" and "not true"
-   evaluates to "false".
-
-5.9.     Test size
-
-   Syntax:   size <":over" / ":under"> <limit: number>
-
-   The "size" test deals with the size of a message.  It takes either a
-   tagged argument of ":over" or ":under", followed by a number
-   representing the size of the message.
-
-   If the argument is ":over", and the size of the message is greater
-   than the number provided, the test is true; otherwise, it is false.
-
-   If the argument is ":under", and the size of the message is less than
-   the number provided, the test is true; otherwise, it is false.
-
-   Exactly one of ":over" or ":under" must be specified, and anything
-   else is an error.
-
-   The size of a message is defined to be the number of octets from the
-   initial header until the last character in the message body.
-
-   Note that for a message that is exactly 4,000 octets, the message is
-   neither ":over" 4000 octets or ":under" 4000 octets.
-
-5.10.    Test true
-
-   Syntax:   true
-
-   The "true" test always evaluates to true.
-
-6.      Extensibility
-
-   New control structures, actions, and tests can be added to the
-   language.  Sites must make these features known to their users; this
-   document does not define a way to discover the list of extensions
-   supported by the server.
-
-
-
-Showalter                   Standards Track                    [Page 26]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Any extensions to this language MUST define a capability string that
-   uniquely identifies that extension.  If a new version of an extension
-   changes the functionality of a previously defined extension, it MUST
-   use a different name.
-
-   In a situation where there is a submission protocol and an extension
-   advertisement mechanism aware of the details of this language,
-   scripts submitted can be checked against the mail server to prevent
-   use of an extension that the server does not support.
-
-   Extensions MUST state how they interact with constraints defined in
-   section 2.10, e.g., whether they cancel the implicit keep, and which
-   actions they are compatible and incompatible with.
-
-6.1.     Capability String
-
-   Capability strings are typically short strings describing what
-   capabilities are supported by the server.
-
-   Capability strings beginning with "vnd." represent vendor-defined
-   extensions.  Such extensions are not defined by Internet standards or
-   RFCs, but are still registered with IANA in order to prevent
-   conflicts.  Extensions starting with "vnd." SHOULD be followed by the
-   name of the vendor and product, such as "vnd.acme.rocket-sled".
-
-   The following capability strings are defined by this document:
-
-   envelope    The string "envelope" indicates that the implementation
-               supports the "envelope" command.
-
-   fileinto    The string "fileinto" indicates that the implementation
-               supports the "fileinto" command.
-
-   reject      The string "reject" indicates that the implementation
-               supports the "reject" command.
-
-   comparator- The string "comparator-elbonia" is provided if the
-               implementation supports the "elbonia" comparator.
-               Therefore, all implementations have at least the
-               "comparator-i;octet" and "comparator-i;ascii-casemap"
-               capabilities.  However, these comparators may be used
-               without being declared with require.
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 27]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-6.2.     IANA Considerations
-
-   In order to provide a standard set of extensions, a registry is
-   provided by IANA.  Capability names may be registered on a first-
-   come, first-served basis.  Extensions designed for interoperable use
-   SHOULD be defined as standards track or IESG approved experimental
-   RFCs.
-
-6.2.1.     Template for Capability Registrations
-
-   The following template is to be used for registering new Sieve
-   extensions with IANA.
-
-   To: iana@iana.org
-   Subject: Registration of new Sieve extension
-
-   Capability name:
-   Capability keyword:
-   Capability arguments:
-   Standards Track/IESG-approved experimental RFC number:
-   Person and email address to contact for further information:
-
-6.2.2.     Initial Capability Registrations
-
-   The following are to be added to the IANA registry for Sieve
-   extensions as the initial contents of the capability registry.
-
-   Capability name:        fileinto
-   Capability keyword:     fileinto
-   Capability arguments:   fileinto <folder: string>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-   Capability name:        reject
-   Capability keyword:     reject
-   Capability arguments:   reject <reason: string>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 28]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   Capability name:        envelope
-   Capability keyword:     envelope
-   Capability arguments:
-           envelope [COMPARATOR] [ADDRESS-PART] [MATCH-TYPE]
-           <envelope-part: string-list> <key-list: string-list>
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028 (Sieve base spec)
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-   Capability name:        comparator-*
-   Capability keyword:
-           comparator-* (anything starting with "comparator-")
-   Capability arguments:   (none)
-   Standards Track/IESG-approved experimental RFC number:
-           RFC 3028, Sieve, by reference of
-           RFC 2244, Application Configuration Access Protocol
-   Person and email address to contact for further information:
-           Tim Showalter
-           tjs@mirapoint.com
-
-6.3.     Capability Transport
-
-   As the range of mail systems that this document is intended to apply
-   to is quite varied, a method of advertising which capabilities an
-   implementation supports is difficult due to the wide range of
-   possible implementations.  Such a mechanism, however, should have
-   property that the implementation can advertise the complete set of
-   extensions that it supports.
-
-7.      Transmission
-
-   The MIME type for a Sieve script is "application/sieve".
-
-   The registration of this type for RFC 2048 requirements is as
-   follows:
-
-    Subject: Registration of MIME media type application/sieve
-
-    MIME media type name: application
-    MIME subtype name: sieve
-    Required parameters: none
-    Optional parameters: none
-    Encoding considerations: Most sieve scripts will be textual,
-       written in UTF-8.  When non-7bit characters are used,
-       quoted-printable is appropriate for transport systems
-       that require 7bit encoding.
-
-
-
-Showalter                   Standards Track                    [Page 29]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-    Security considerations: Discussed in section 10 of RFC 3028.
-    Interoperability considerations: Discussed in section 2.10.5
-       of RFC 3028.
-    Published specification: RFC 3028.
-    Applications which use this media type: sieve-enabled mail servers
-    Additional information:
-      Magic number(s):
-      File extension(s): .siv
-      Macintosh File Type Code(s):
-    Person & email address to contact for further information:
-       See the discussion list at ietf-mta-filters@imc.org.
-    Intended usage:
-       COMMON
-    Author/Change controller:
-       See Author information in RFC 3028.
-
-8.      Parsing
-
-   The Sieve grammar is separated into tokens and a separate grammar as
-   most programming languages are.
-
-8.1.     Lexical Tokens
-
-   Sieve scripts are encoded in UTF-8.  The following assumes a valid
-   UTF-8 encoding; special characters in Sieve scripts are all ASCII.
-
-   The following are tokens in Sieve:
-
-           - identifiers
-           - tags
-           - numbers
-           - quoted strings
-           - multi-line strings
-           - other separators
-
-   Blanks, horizontal tabs, CRLFs, and comments ("white space") are
-   ignored except as they separate tokens.  Some white space is required
-   to separate otherwise adjacent tokens and in specific places in the
-   multi-line strings.
-
-   The other separators are single individual characters, and are
-   mentioned explicitly in the grammar.
-
-   The lexical structure of sieve is defined in the following BNF (as
-   described in [ABNF]):
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 30]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   bracket-comment = "/*" *(CHAR-NOT-STAR / ("*" CHAR-NOT-SLASH)) "*/"
-           ;; No */ allowed inside a comment.
-           ;; (No * is allowed unless it is the last character,
-           ;; or unless it is followed by a character that isn't a
-           ;; slash.)
-
-   CHAR-NOT-DOT = (%x01-09 / %x0b-0c / %x0e-2d / %x2f-ff)
-           ;; no dots, no CRLFs
-
-   CHAR-NOT-CRLF = (%x01-09 / %x0b-0c / %x0e-ff)
-
-   CHAR-NOT-SLASH = (%x00-57 / %x58-ff)
-
-   CHAR-NOT-STAR = (%x00-51 / %x53-ff)
-
-   comment = bracket-comment / hash-comment
-
-   hash-comment = ( "#" *CHAR-NOT-CRLF CRLF )
-
-   identifier = (ALPHA / "_") *(ALPHA DIGIT "_")
-
-   tag = ":" identifier
-
-   number = 1*DIGIT [QUANTIFIER]
-
-   QUANTIFIER = "K" / "M" / "G"
-
-   quoted-string = DQUOTE *CHAR DQUOTE
-           ;; in general, \ CHAR inside a string maps to CHAR
-           ;; so \" maps to " and \\ maps to \
-           ;; note that newlines and other characters are all allowed
-           ;; strings
-
-   multi-line          = "text:" *(SP / HTAB) (hash-comment / CRLF)
-                         *(multi-line-literal / multi-line-dotstuff)
-                         "." CRLF
-   multi-line-literal  = [CHAR-NOT-DOT *CHAR-NOT-CRLF] CRLF
-   multi-line-dotstuff = "." 1*CHAR-NOT-CRLF CRLF
-           ;; A line containing only "." ends the multi-line.
-           ;; Remove a leading '.' if followed by another '.'.
-
-   white-space = 1*(SP / CRLF / HTAB) / comment
-
-8.2.     Grammar
-
-   The following is the grammar of Sieve after it has been lexically
-   interpreted.  No white space or comments appear below.  The start
-   symbol is "start".
-
-
-
-Showalter                   Standards Track                    [Page 31]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   argument = string-list / number / tag
-
-   arguments = *argument [test / test-list]
-
-   block = "{" commands "}"
-
-   command = identifier arguments ( ";" / block )
-
-   commands = *command
-
-   start = commands
-
-   string = quoted-string / multi-line
-
-   string-list = "[" string *("," string) "]" / string         ;; if
-   there is only a single string, the brackets are optional
-
-   test = identifier arguments
-
-   test-list = "(" test *("," test) ")"
-
-9.      Extended Example
-
-   The following is an extended example of a Sieve script.  Note that it
-   does not make use of the implicit keep.
-
-    #
-    # Example Sieve Filter
-    # Declare any optional features or extension used by the script
-    #
-    require ["fileinto", "reject"];
-
-    #
-    # Reject any large messages (note that the four leading dots get
-    # "stuffed" to three)
-    #
-    if size :over 1M
-            {
-            reject text:
-    Please do not send me large attachments.
-    Put your file on a server and send me the URL.
-    Thank you.
-    .... Fred
-    .
-    ;
-            stop;
-            }
-    #
-
-
-
-Showalter                   Standards Track                    [Page 32]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-    # Handle messages from known mailing lists
-    # Move messages from IETF filter discussion list to filter folder
-    #
-    if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-            {
-            fileinto "filter";  # move to "filter" folder
-            }
-    #
-    # Keep all messages to or from people in my company
-    #
-    elsif address :domain :is ["From", "To"] "example.com"
-            {
-            keep;               # keep in "In" folder
-            }
-
-    #
-    # Try and catch unsolicited email.  If a message is not to me,
-    # or it contains a subject known to be spam, file it away.
-    #
-    elsif anyof (not address :all :contains
-                   ["To", "Cc", "Bcc"] "me@example.com",
-                 header :matches "subject"
-                   ["*make*money*fast*", "*university*dipl*mas*"])
-            {
-            # If message header does not contain my address,
-            # it's from a list.
-            fileinto "spam";   # move to "spam" folder
-            }
-    else
-            {
-            # Move all other (non-company) mail to "personal"
-            # folder.
-            fileinto "personal";
-            }
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 33]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-10.     Security Considerations
-
-   Users must get their mail.  It is imperative that whatever method
-   implementations use to store the user-defined filtering scripts be
-   secure.
-
-   It is equally important that implementations sanity-check the user's
-   scripts, and not allow users to create on-demand mailbombs.  For
-   instance, an implementation that allows a user to reject or redirect
-   multiple times to a single message might also allow a user to create
-   a mailbomb triggered by mail from a specific user.  Site- or
-   implementation-defined limits on actions are useful for this.
-
-   Several commands, such as "discard", "redirect", and "fileinto" allow
-   for actions to be taken that are potentially very dangerous.
-
-   Implementations SHOULD take measures to prevent languages from
-   looping.
-
-11.     Acknowledgments
-
-   I am very thankful to Chris Newman for his support and his ABNF
-   syntax checker, to John Myers and Steve Hole for outlining the
-   requirements for the original drafts, to Larry Greenfield for nagging
-   me about the grammar and finally fixing it, to Greg Sereda for
-   repeatedly fixing and providing examples, to Ned Freed for fixing
-   everything else, to Rob Earhart for an early implementation and a
-   great deal of help, and to Randall Gellens for endless amounts of
-   proofreading.  I am grateful to Carnegie Mellon University where most
-   of the work on this document was done.  I am also indebted to all of
-   the readers of the ietf-mta-filters@imc.org mailing list.
-
-12.     Author's Address
-
-   Tim Showalter
-   Mirapoint, Inc.
-   909 Hermosa Court
-   Sunnyvale, CA 94085
-
-   EMail: tjs@mirapoint.com
-
-13.  References
-
-   [ABNF]      Crocker, D. and P. Overell, "Augmented BNF for Syntax
-               Specifications: ABNF", RFC 2234, November 1997.
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 34]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-   [ACAP]      Newman, C. and J. G. Myers, "ACAP -- Application
-               Configuration Access Protocol", RFC 2244, November 1997.
-
-   [BINARY-SI] "Standard IEC 60027-2: Letter symbols to be used in
-               electrical technology - Part 2: Telecommunications and
-               electronics", January 1999.
-
-   [DSN]       Moore, K. and G. Vaudreuil, "An Extensible Message Format
-               for Delivery Status Notifications", RFC 1894, January
-               1996.
-
-   [FLAMES]    Borenstein, N, and C. Thyberg, "Power, Ease of Use, and
-               Cooperative Work in a Practical Multimedia Message
-               System", Int. J.  of Man-Machine Studies, April, 1991.
-               Reprinted in Computer-Supported Cooperative Work and
-               Groupware, Saul Greenberg, editor, Harcourt Brace
-               Jovanovich, 1991.  Reprinted in Readings in Groupware and
-               Computer-Supported Cooperative Work, Ronald Baecker,
-               editor, Morgan Kaufmann, 1993.
-
-   [KEYWORDS]  Bradner, S., "Key words for use in RFCs to Indicate
-               Requirement Levels", BCP 14, RFC 2119, March 1997.
-
-   [IMAP]      Crispin, M., "Internet Message Access Protocol - version
-               4rev1", RFC 2060, December 1996.
-
-   [IMAIL]     Crocker, D., "Standard for the Format of ARPA Internet
-               Text Messages", STD 11, RFC 822, August 1982.
-
-   [MIME]      Freed, N. and N. Borenstein, "Multipurpose Internet Mail
-               Extensions (MIME) Part One: Format of Internet Message
-               Bodies", RFC 2045, November 1996.
-
-   [MDN]       Fajman, R., "An Extensible Message Format for Message
-               Disposition Notifications", RFC 2298, March 1998.
-
-   [RFC1123]   Braden, R., "Requirements for Internet Hosts --
-               Application and Support", STD 3, RFC 1123, November 1989.
-
-   [SMTP]      Postel, J., "Simple Mail Transfer Protocol", STD 10, RFC
-               821, August 1982.
-
-   [UTF-8]     Yergeau, F., "UTF-8, a transformation format of Unicode
-               and ISO 10646", RFC 2044, October 1996.
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 35]
-
-RFC 3028            Sieve: A Mail Filtering Language        January 2001
-
-
-14. Full Copyright Statement
-
-   Copyright (C) The Internet Society (2001).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Showalter                   Standards Track                    [Page 36]
-
+http://ktown.kde.org/~dirk/sieve/rfc3028.txt
Index: kioslaves/sieve/draft-degener-sieve-copy.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-copy.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-degener-sieve-copy.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,176 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: October 2003                                          April 2003
-
-
-                      Sieve -- "copy" extension
-		  <draft-degener-sieve-copy-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines a new keyword parameter, ":copy", to
-   be used with the sieve "fileinto" and "redirect" actions.
-   The new parameter prevents cancellation of the implicit keep.
-
-
-1. Introduction
-
-   Some users have the notion of forwarding a copy of a message
-   for safekeeping to another e-mail address, or of saving a copy
-   in a folder -- in addition to the regular message delivery,
-   which shouldn't be affected by the copy.
-
-   If saving an extra copy is all the user wanted to do, 
-   
-   	fileinto "unfiltered";
-	keep;
-
-   would do the job.  But the explicit "keep" is a poor substitute
-   for the implicit keep when more processing follows:
-
-   	fileinto "unfiltered";
-	keep;
-
-	if header "Subject" "MAKE MONEY FAST!!!"
-	{
-		discard;
-	}
-
-   In this example, the "discard" is ineffective against the
-   explicit "keep"; the discarded message still ends up in
-   the user's inbox.
-
-   It is possibly to generate sieve code that perfectly
-   expresses a user's wishes, but such code quickly grows
-   unwieldy because it needs to keep track of the state
-   the implicit keep would have had without the fileinto
-   or redirect command.
-
-   This extension tries to make life easier for user interface
-   designers and script writers by allowing them to express
-   the "copy" semantics directly.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "copy".
-
-
-3. ":copy" extension to the "fileinto" and "redirect" command.
-
-   Syntax:
-   	"fileinto" [:copy] <folder: string>
-   	"redirect" [:copy] <folder: string>
-
-   If the optional :copy keyword is specified with "fileinto"
-   or "redirect", the tagged command does not cancel the
-   implicit keep.  Instead, it merely files or redirects a
-   copy in addition to whatever else is happening to the
-   message.
-
-
-4. Security Considerations
-
-   The "copy" extension makes it easier to eavesdrop on a user's
-   message stream without the user noticing.
-
-
-5. Acknowledgments
-
-   Thanks to Eric Allman, Will Lee, and Rand Wacker for
-   corrections and comments.
-
-
-6. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-7. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-
-Appendices
-
-Appendix A.  References
-
-   [KEYWORDS] 	Bradner, S., "Key words for use in RFCs to Indicate
-   		Requirement Levels", RFC 2119, March 1997.
-
-   [SIEVE] 	Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-		January 2001.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-copy.txt
Index: kioslaves/sieve/draft-degener-sieve-body-00.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-body-00.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-degener-sieve-body-00.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,323 +1 @@
-
-Network Working Group                                       Jutta Degener
-Internet Draft					           Sendmail, Inc.
-Expires: December 2002                                          June 2002
-
-
-                      Sieve -- "body" extension
-		  <draft-degener-sieve-body-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines a new primitive for the "sieve" language
-   that tests for the occurrence of one or more strings in the body
-   of an e-mail message.
-
-
-1. Introduction
-
-   The proposed "body" test checks for the occurrence of one
-   or more strings in the body of an e-mail message.
-   Such a test was initially discussed for the [SIEVE] base
-   document, but was subsequently removed because it was
-   thought to be too costly to implement.
-
-   Nevertheless, several server vendors have implemented
-   some form of the "body" test.
-
-   This document reintroduces the "body" test as an extension,
-   and specifies it syntax and semantics.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   The capability string associated with extension defined in this
-   document is "body".
-
-
-3. Test body
-
-   Syntax:
-   	"body" [COMPARATOR] [MATCH-TYPE] [BODY-TRANSFORM]
-   		<key-list: string-list>
-
-   The body test matches text in the body of an e-mail message,
-   that is, anything following the first empty line after the header.
-   (The empty line itself, if present, is not considered to be part
-   of the body.)
-
-   The COMPARATOR and MATCH-TYPE keyword parameters are defined
-   in [SIEVE].  The BODY-TRANSFORM is a keyword parameter
-   discussed in section 4, below.
-
-   If a message consists of a header only, not followed by an empty
-   line, all "body" tests fail, including that for an empty string.
-
-   If a message consists of a header followed only by an empty
-   line with no body lines following it, the message is considered
-   to have an empty string as a body.
-
-
-4. Body Transform
-
-   Prior to matching text in a message body, "transformations"
-   can be applied that filter and decode certain parts of the body.
-   These transformations are selected by a "BODY-TRANSFORM"
-   keyword parameter.
-
-   Syntax:
-   	  ":raw"
-	/ ":content" <content-types: string-list>
-	/ ":text"
-
-
-4.1 Body Transform ":raw"
-
-   The ":raw" transform is intended to match against the undecoded
-   body of a message.
-
-   If the specified body-transform is ":raw", the MIME structure of
-   the body is irrelevant.  The implementation MUST NOT remove any
-   transfer encoding from the message, MUST NOT refuse to filter
-   messages with syntactic errors (unless the environment it is part
-   of rejects them outright), and MUST NOT interpret or skip MIME
-   headers of enclosed body parts.
-
-   Example:
-
-   	require "body";
-
-	# This will match a message containing the words "MAKE MONEY FAST"
-	# in body or MIME headers other than the outermost RFC 822 header,
-	# but will not match a message containing the words in a
-	# content-transfer-encoded body.
-
-	if body :raw :contains "MAKE MONEY FAST" {
-		reject;
-	}
-
-
-
-4.2 Body Transform ":content_type"
-
-   If the body transform is ":content_type", only MIME parts that have
-   the specified content-types are selected for matching.
-
-   If an individual content type contains a '/' (slash), it
-   specifies a full <type>/<subtype> pair, and matches only
-   that specific content type.  Otherwise, it specifies a
-   <type> only, and any subtype matches it.
-
-   The search for MIME parts is recursive and automatically
-   descends into multipart and message MIME parts.
-
-   MIME parts encoded in a content transfer encoding must be decoded,
-   and text MIME parts in charsets other than UTF-8 MUST be converted
-   to UTF-8 prior to the match.
-
-   Search expressions MUST NOT match across MIME part boundaries.
-   MIME headers of the containing text MUST NOT be included in the
-   data.
-
-   Example:
-   	require ["body", "fileinto"];
-
-	# Save any message with any text MIME part that contains the
-	# worlds "missile" or "coordinates" in the "secrets" folder. 
-	
-	if body :content_type "text" :contains ["missile", "coordinates"] {
-		fileinto "secrets";
-	}
-
-	# Save any message with an audio/mp3 MIME part in
-	# the "jukebox" folder.
-
-	if body :content_type "audio/mp3" :contains "" {
-		fileinto "jukebox";
-	}
-
-
-4.3 Body Transform ":text"
-
-   The ":text" body transform matches against the results of 
-   an implementation's best effort at extracting text from a message.
-
-   In simple implementations, :text MAY be a macro that stands
-   for :content_type "text".
-
-   Sophisticated implementations MAY strip mark-up from the text
-   prior to matching, and MAY convert media types other than text
-   to text prior to matching.
-   
-   (For example, they may be able to convert proprietary text
-   editor formats to text or apply optical character recognition
-   algorithms to image data.)
-
-
-5. Interaction with Other Sieve Extensions
-
-   Any extension that extends the grammar for the COMPARATOR or
-   MATCH-TYPE nonterminals will also affect the implementation of
-   "body".
-   
-   The [REGEX] extension can place a considerable load on a system
-   when applied to whole bodies of messages, especially when
-   implemented naively or used maliciously.
-
-
-6. Security Considerations
-
-   The system MUST be sized and restricted in such a manner that
-   even malicious use of body matching does not deny service to
-   other users of the host system.
-
-   Filters relying on string matches in the raw body of an e-mail
-   message may be more general than intended.  Text matches are no
-   replacement for a virus or spam filtering system.
-
-
-7. Acknowledgments
-
-   This document has been revised in part based on comments and
-   discussions that took place on and off the SIEVE mailing list.
-   Thanks to Cyrus Daboo, Simon Josefsson, Chris Markle, Greg Shapiro,
-   Tim Showalter, Nigel Swinson, and Dowson Tong for taking the time
-   to review this draft and make suggestions.
-
-
-8. Author's Address
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-
-   Email: jutta@sendmail.com
-
-
-9. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-9.1 Consensus
- 
-   A "body" operation is being used for mail filtering.
-   Some systems implement it in something similar to sieve,
-   some systems implement a body or x_body operations within sieve.
-
-   The implementations do not process the body contents.
-   They do not strip content-transfer encodings and do not convert
-   text to UTF-8 prior to comparison.
-
-   There is a strong feeling that this behavior is unworthy of
-   standardization, that body is a "valuable piece of real-estate"
-   that one should get right, and that users will expect a "body"
-   test to at least be capable of reaching inside encodings.
-
-
-9.2 Open Issues
-
-9.2.1 Body Transformations
-
-   This document names three possible transformations
-   (one of which, ":raw", does nothing) to apply to the
-   body before matching.  Are there important others that
-   are missing?  Are three too many?  Which ones should
-   be dropped?
-
-
-9.2.2 Default Transformation
-
-   If none of the transformations is specified, what should
-   be the default?  Should there be a default, or should it
-   be an error?
-
-   I'd like there to be a default, so that existing scripts
-   that use an undocumented "body" extensions just work.
-
-   The default should probably be :raw or :text.
-   It should be ":raw", because that's what current implementations do.
-   It should be ":text", because that's what we believe users expect.
-
-   I'd like this to be implementation-defined, allowing for a
-   gradual migration from the current behavior to something closer
-   to user expectations.
-
-
-Appendices
-
-Appendix A.  References
-
-   [SIEVE] Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-   January 2001.
-
-   [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-   Requirement Levels", RFC 2119, March 1997.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-body-00.txt
Index: kioslaves/sieve/draft-daboo-sieve-spamtest.txt
===================================================================
--- kioslaves/sieve/draft-daboo-sieve-spamtest.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-daboo-sieve-spamtest.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,514 +1 @@
-Network Working Group                                          C. Daboo
-Internet Draft: SIEVE Spamtest and Virustest Extensions
-Document: draft-daboo-sieve-spamtest-04.txt                October 2003
-
-                SIEVE Spamtest and Virustest Extensions
-    
-Status of this Memo
-    
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.
-    
-    Internet-Drafts are working documents of the Internet Engineering
-    Task Force (IETF), its areas, and its working groups.  Note that
-    other groups may also distribute working documents as
-    Internet-Drafts.
-    
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet-Drafts as
-    reference material or to cite them other than as "work in progress."
-    
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt.
-    
-    The list of Internet- Draft Shadow Directories can be accessed at
-    http://www.ietf.org/shadow.html.
-    
-    
-Copyright Notice
-    
-     Copyright (C) The Internet Society 2003. All Rights Reserved.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 1]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-Abstract
-    
-    The SIEVE mail filtering language [SIEVE] "spamtest" and "virustest"
-    extensions permit users to use simple, portable commands for spam
-    and virus tests on email messages.  Each extension provides a new
-    test using matches against numeric 'scores'.  It is the
-    responsibility of the underlying SIEVE implementation to do the
-    actual checks that result in values returned by the tests.
-    
-Change History (to be removed prior to publication as an RFC)
-    
-    Changes from -03 to -04:
-    1   Added IPR boiler plate.
-    2   Re-ordered sections at start to conform to RFC style.
-    3   Eliminated the use of "NIL" for untested value.
-    4   Expanded virus test ranges to indicate additional state.
-    5   Added security consideration requiring admins to keep virus
-        tools up to date
-        
-    Changes from -02 to -03:
-    1   Changed test values to be arbitrary strings with numeric value
-        as first token.
-    2   Changed 'virii' to 'viruses'.
-        
-    Changes from -01 to -02:
-    1   Fixed syntax in examples.
-    2   Updated references section to normative/informative.
-        
-    Changes from -00 to -01:
-    1   Changed so that tests use standard SIEVE syntax.
-    2   Added requirement for relation extension for numeric
-        comparisons.
-    3   Changed spamtest numeric range to 0->10.
-        
-        
-Table of Contents
-        
-     1  Introduction and Overview . . . . . . . . . . . . . . . . . .  3
-     2  Conventions Used in This Document  . . . . . . . . . . . . . . 3
-     3  SIEVE Extensions  . . . . . . . . . . . . . . . . . . . . . .  4
-       3.1  General Considerations . . . . . . . . . . . . . . . . . . 4
-       3.2  Test spamtest . . . . . . . . . . . . . . . . . . . . . .  4
-       3.3  Test virustest . . . . . . . . . . . . . . . . . . . . . . 5
-     4  Security Considerations . . . . . . . . . . . . . . . . . . .  6
-     5  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 6
-       5.1  spamtest registration . . . . . . . . . . . . . . . . . .  7
-       5.2  virustest registration . . . . . . . . . . . . . . . . . . 7
-     6  References  . . . . . . . . . . . . . . . . . . . . . . . . .  7
-       6.1  Normative References . . . . . . . . . . . . . . . . . . . 7
-       6.2  Non-Normative References  . . . . . . . . . . . . . . . .  8
-     7  Acknowledgments  . . . . . . . . . . . . . . . . . . . . . . . 8
-     8  Author's Address  . . . . . . . . . . . . . . . . . . . . . .  8
-
-
-Daboo                    Expires April 2004                    [Page 2]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-     9  Intellectual Property Rights Statement . . . . . . . . . . . . 8
-    10  Full Copyright Statement  . . . . . . . . . . . . . . . . . .  8
-        
-        
-1 Introduction and Overview
-    
-    SIEVE scripts are frequently being used to do spam and virus
-    filtering based on either implicit script tests (e.g. tests for
-    'black-listed' senders directly encoded in the SIEVE script), or via
-    testing messages modified by some external spam or virus checker
-    that handled the message prior to SIEVE.  The use of third-party
-    spam and virus checker tools poses a problem since each tool has its
-    own way of indicating the result of its checks.  These usually take
-    the form of a header added to the message, the content of which
-    indicates the status using some syntax defined by the particular
-    tool.  Each user has to then create their own SIEVE scripts to match
-    the contents of these headers to do filtering.  This requires the
-    script to stay in synchronisation with the third party tool as it
-    gets updated or perhaps replaced with another.  Thus scripts become
-    tied to specific environments, and lose portability.
-    
-    The purpose of this document is to introduce two SIEVE tests that
-    can be used to implement 'generic' tests for spam and viruses in
-    messages processed via SIEVE scripts.  These tests return a string
-    containing a range of numeric values that indicate the severity of
-    spam or viruses in a message, or a string that indicates the message
-    has not passed through any spam or virus checking tools.  The spam
-    and virus checks themselves are handled by the underlying SIEVE
-    implementation in whatever manner is appropriate, and the
-    implementation maps the results of these checks into the numeric
-    ranges defined by the new tests.  Thus a SIEVE implementation can
-    have a spam test that implicitly checks for third-party spam tool
-    headers and determines how those map into the spamtest numeric
-    range.
-    
-    In order to do numeric comparisons against the returned strings,
-    server implementations MUST also support the SIEVE relational
-    [RELATIONAL] extension, in addition to the extensions described
-    here.  All examples below assume the relational extension is
-    present.
-    
-    
-2 Conventions Used in This Document
-    
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-    
-    The term 'spam' is used in this document to refer to unsolicited or
-    unwanted email messages.  This document does not attempt to define
-    what exactly constitutes spam, or how it should be identified, or
-    what actions should be taken when detected.
-    
-
-
-Daboo                    Expires April 2004                    [Page 3]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    The term 'virus' is used in this document to refer to any type of
-    message whose content can cause malicious damage.  This document
-    does not attempt to define what exactly constitutes a virus, or how
-    it should be identified, or what actions should be taken when
-    detected.
-    
-    
-3 SIEVE Extensions
-    
-3.1 General Considerations
-    
-    The "spamtest" and "virustest" tests described below both return a
-    string that starts with a numeric value, followed by an optional
-    space (%x20) character and optional arbitrary text.  The numeric
-    value can be compared to specific values using the SIEVE relational
-    [RELATIONAL] extension in conjunction with the "i;ascii-numeric"
-    comparator [ACAP], which will test for the presence of a numeric
-    value at the start of the string, ignoring any additional text in
-    the string.  The additional text can be used to carry implementation
-    specific details about the tests performed and descriptive comments
-    about the result.  Tests can be done using standard string
-    comparators against this text if it helps to refine behaviour,
-    however this will break portability of the script as the text will
-    likely be specific to a particular implementation.
-    
-3.2 Test spamtest
-    
-        Syntax: spamtest [COMPARATOR] [MATCH-TYPE] <value: string>
-    
-    SIEVE implementations that implement the "spamtest" test have an
-    identifier of "spamtest" for use with the capability mechanism.
-    
-    The "spamtest" test evaluates to true if the spamtest result matches
-    the value.  The type of match is specified by the optional match
-    argument, which defaults to ":is" if not specified.
-    
-    The spamtest result is a string starting with a numeric value in the
-    range "0" (zero) through "10", with meanings summarised below:
-    
-        spamtest    interpretation
-        value
-
-		 0          message was not tested for spam
-		 1          message was tested and is clear of spam
-		 2 - 9      message was tested and has a varying likelihood of
-		            containing spam in increasing order
-		 10         message was tested and definitely contains spam
-    
-    The underlying SIEVE implementation will map whatever spam check is
-    done into this numeric range, as appropriate.
-    
-
-
-
-Daboo                    Expires April 2004                    [Page 4]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    Examples:
-    
-        require ["spamtest", "fileinto",
-                 "relational", "comparator-i;ascii-numeric"];
-
-        if spamtest :value "eq" :comparator "i;ascii-numeric" "0"
-        {
-            fileinto "INBOX.unclassified";
-        }
-        elsif spamtest :value "ge" :comparator "i;ascii-numeric" "3"
-        {
-            fileinto "INBOX.spam-trap";
-        }
-    
-    In this example, any message that has not passed through a spam
-    check tool will be filed into the mailbox "INBOX.unclassified".  Any
-    message with a spamtest value greater than or equal to "3" is filed
-    into a mailbox called "INBOX.spam-trap" in the user's mailstore.
-    
-3.3 Test virustest
-    
-        Syntax: virustest [COMPARATOR] [MATCH-TYPE] <value: string>
-    
-    SIEVE implementations that implement the "virustest" test have an
-    identifier of "virustest" for use with the capability mechanism.
-    
-    The "virustest" test evaluates to true if the virustest result
-    matches the value.  The type of match is specified by the optional
-    match argument, which defaults to ":is" if not specified.
-    
-    The virustest result is a string starting with a numeric value in
-    the range "0" (zero) through "5", with meanings summarised below:
-    
-        virustest   interpretation
-        value
-
-		 0          message was not tested for viruses
-		 1          message was tested and contains no known viruses
-		 2          message was tested and contained a known virus which
-		            was replaced with harmless content
-		 3          message was tested and contained a known virus which
-		            was "cured" such that it is now harmless
-		 4          message was tested and possibly contains a known virus
-		 5          message was tested and definately contains a known virus
-    
-    The underlying SIEVE implementation will map whatever virus checks
-    are done into this numeric range, as appropriate.  If the message
-    has not been categorised by any virus checking tools, then the
-    virustest result is "0".
-    
-
-
-
-
-Daboo                    Expires April 2004                    [Page 5]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    Example:
-    
-	    require ["virustest", "fileinto",
-	             "relational", "comparator-i;ascii-numeric"];
-
-	    if virustest :value "eq" :comparator "i;ascii-numeric" "0"
-	    {
-	        fileinto "INBOX.unclassified";
-	    }
-	    if virustest :value "eq" :comparator "i;ascii-numeric" "4"
-	    {
-	        fileinto "INBOX.quarantine";
-    	}
-	    elsif virustest :value "eq" :comparator "i;ascii-numeric" "5"
-	    {
-	        discard;
-	    }
-    
-    In this example, any message that has not passed through a virus
-    check tool will be filed into the mailbox "INBOX.unclassified".  Any
-    message with a virustest value equal to "4" is filed into a mailbox
-    called "INBOX.quarantine" in the user's mailstore.  Any message with
-    a virustest value equal to "5" is discarded (removed) and not
-    delivered to the user's mailstore.
-    
-    
-4 Security Considerations
-    
-    SIEVE implementations SHOULD ensure that "spamtest" and "virustest"
-    tests can only occur for messages that have gone through a
-    legitimate spam or virus check process.  If such checks rely on the
-    addition of special headers to messages, it is the responsibility of
-    the implementation to ensure that such headers cannot be spoofed by
-    the sender, to prevent the implementation from being tricked into
-    returning the wrong result for the test.
-    
-    Server administrators MUST ensure that the virus checking tools are
-    kept up to date, to provide reasonable protection for users using
-    the "virustest" test.  Users should be made aware of the fact that
-    the "virustest" test does not provide a 100% reliable way to remove
-    all viruses, and they should continue to exercise caution when
-    dealing with messages of unknown content and origin.
-    
-    Beyond that, the "spamtest" and "virustest" extensions do not raise
-    any security considerations that are not present in the base [SIEVE]
-    protocol, and these issues are discussed in [SIEVE].
-    
-    
-5 IANA Considerations
-    
-    The following templates specify the IANA registration of the Sieve
-    extensions specified in this document:
-
-
-Daboo                    Expires April 2004                    [Page 6]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-5.1 spamtest registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: spamtest
-    Capability keyword: spamtest
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780, 
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-5.2 virustest registration
-    
-    To: iana@iana.org
-    Subject: Registration of new Sieve extension
-
-    Capability name: virustest
-    Capability keyword: virustest
-    Capability arguments: N/A
-    Standards Track/IESG-approved experimental RFC number: this RFC
-    Person and email address to contact for further information:
-
-      Cyrus Daboo
-      Cyrusoft International, Inc.
-      5001 Baum Blvd., Suite 780, 
-      Pittsburgh, PA 15213
-      U.S.A.
-
-      <mailto:daboo@cyrusoft.com>
-
-    This information should be added to the list of sieve extensions
-    given on http://www.iana.org/assignments/sieve-extensions.
-    
-    
-6 References
-    
-6.1 Normative References
-    
-    [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-    Requirement Levels", RFC 2119, March 1997.
-    
-
-
-Daboo                    Expires April 2004                    [Page 7]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    [RELATIONAL] Segmuller, W. "Sieve Extension:  Relational Tests", RFC
-    3431, December 2002.
-    
-    [SIEVE] Showalter, "Sieve:  A Mail Filtering Language", RFC 3028,
-    January 2001.
-    
-6.2 Non-Normative References
-    
-    [ACAP] Newman, C. and J. G. Myers, "ACAP -- Application
-    Configuration Access Protocol", RFC 2244, November 1997.
-    
-    
-7 Acknowledgments
-    
-    Thanks to Tony Hansen, Jutta Degener, Ned Freed, Ashish Gawarikar
-    and Nigel Swinson for comments and corrections.
-    
-    
-8 Author's Address
-    
-    Cyrus Daboo
-    Cyrusoft International, Inc.
-    5001 Baum Blvd., Suite 780,
-    Pittsburgh, PA 15213
-    U.S.A.
-
-    <mailto:daboo@cyrusoft.com>
-    
-    
-9 Intellectual Property Rights Statement
-    
-    The IETF takes no position regarding the validity or scope of any
-    intellectual property or other rights that might be claimed to
-    pertain to the implementation or use of the technology described in
-    this document or the extent to which any license under such rights
-    might or might not be available; neither does it represent that it
-    has made any effort to identify any such rights.  Information on the
-    IETF's procedures with respect to rights in standards-track and
-    standards-related documentation can be found in BCP-11.  Copies of
-    claims of rights made available for publication and any assurances
-    of licenses to be made available, or the result of an attempt made
-    to obtain a general license or permission for the use of such
-    proprietary rights by implementors or users of this specification
-    can be obtained from the IETF Secretariat.
-    
-    
-10 Full Copyright Statement
-    
-    Copyright (C) The Internet Society 2003.  All Rights Reserved.
-    
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-
-
-Daboo                    Expires April 2004                    [Page 8]
-Internet Draft   SIEVE Spamtest and Virustest Extensions   October 2003
-
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-    
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-    
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Daboo                    Expires April 2004                    [Page 9]
\ No newline at end of file
+http://ktown.kde.org/~dirk/sieve/draft-daboo-sieve-spamtest.txt
Index: kioslaves/sieve/draft-martin-managesieve-04.txt
===================================================================
--- kioslaves/sieve/draft-martin-managesieve-04.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-martin-managesieve-04.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,1180 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                         Tim Martin
-Document: draft-ietf-managesieve-03.txt                   Mirapoint Inc.
-Expires January 21, 2003                                    16 July 2002
-
-
-               A Protocol for Remotely Managing Sieve Scripts
-
-                      <draft-martin-managesieve-04.txt>
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are
-    working documents of the Internet Engineering Task Force (IETF), its
-    areas, and its working groups.  Note that other groups may also
-    distribute working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six
-    months and may be updated, replaced, or obsoleted by other documents
-    at any time.  It is inappropriate to use Internet- Drafts as
-    reference material or to cite them other than as "work in progress."
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-
-Abstract
-
-    Sieve scripts allow users to filter incoming email. Message stores
-    are commonly sealed servers so users cannot log into them, yet users
-    must be able to update their scripts on them.  This document
-    describes a protocol "sieve" for securely managing Sieve scripts on
-    a remote server.  This protocol allows a user to have multiple
-    scripts, and also alerts a user to syntactically flawed scripts.
-
-    This an interim measure as it is hoped that eventually Sieve scripts
-    will be stored on ACAP. This document is intended to proceed on the
-    experimental track.
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 1]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.1.   Changes . . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-1.2.   Conventions Used in the Document  . . . . . . . . . . . . . .   4
-1.3.   Syntax  . . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-1.4.   Response Codes  . . . . . . . . . . . . . . . . . . . . . . .   5
-1.5.   Active Script . . . . . . . . . . . . . . . . . . . . . . . .   6
-1.6.   Quotas  . . . . . . . . . . . . . . . . . . . . . . . . . . .   7
-1.7.   Script Names  . . . . . . . . . . . . . . . . . . . . . . . .   7
-1.8.   Capabilities  . . . . . . . . . . . . . . . . . . . . . . . .   7
-
-2.     Commands  . . . . . . . . . . . . . . . . . . . . . . . . . .   8
-2.1.   AUTHENTICATE Command  . . . . . . . . . . . . . . . . . . . .   8
-2.2.   STARTTLS Command  . . . . . . . . . . . . . . . . . . . . . .  10
-2.3.   LOGOUT Command  . . . . . . . . . . . . . . . . . . . . . . .  10
-2.4.   CAPABILITY Command  . . . . . . . . . . . . . . . . . . . . .  11
-2.5.   HAVESPACE Command . . . . . . . . . . . . . . . . . . . . . .  11
-2.6.   PUTSCRIPT Command . . . . . . . . . . . . . . . . . . . . . .  11
-2.7.   LISTSCRIPTS Command . . . . . . . . . . . . . . . . . . . . .  13
-2.8.   SETACTIVE Command . . . . . . . . . . . . . . . . . . . . . .  13
-2.9.   GETSCRIPT Command . . . . . . . . . . . . . . . . . . . . . .  13
-2.10.   DELETESCRIPT Command . . . . . . . . . . . . . . . . . . . .  14
-
-3.     Sieve URL Scheme  . . . . . . . . . . . . . . . . . . . . . .  14
-
-4.     Formal Syntax . . . . . . . . . . . . . . . . . . . . . . . .  15
-
-5.     Security Considerations . . . . . . . . . . . . . . . . . . .  18
-
-6.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .  18
-
-7.     Copyright . . . . . . . . . . . . . . . . . . . . . . . . . .  18
-
-8.     References  . . . . . . . . . . . . . . . . . . . . . . . . .  19
-
-9.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .  19
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 2]
-
-Internet Draft             Managing Sieve Scripts            July 16, 2002
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 3]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-1.  Introduction
-
-
-
-1.1.  Changes
-
-    Changes since 03
-
-    -Add referals and Sieve URLs
-
-    -Lots of spelling/grammer fixes
-
-    -Don't give capabilities after successful STARTTLS. This is because
-    it isn't consistant with AUTHENTICATE. There is language specifying
-    that a client should re-issue a CAPABILITY command after
-    AUTHENTICATE/STARTTLS.
-
-    -Putting a script of length 0 doesn't remove the script. If this
-    functionality is desired, the DELETESCRIPT command should be used.
-
-    Changes since 02
-
-    -add BYE response
-
-    -typo on line 588
-
-    -allow ANONYMOUS access for sieve script verification
-
-    -updated SIEVE spec reference
-
-    Changes since 01
-
-    -changed contact info
-
-    Changes since 00
-
-    -added response codes (from ACAP)
-
-    -removed special-ok response from authenticate command (response
-    codes obsolete it)
-
-    -changed service name to "sieve"
-
-    -ABNF fixes
-
-    -Alexey's wording changes
-
-    -Eliminated lame PLAIN paragraph
-
-
-
-Expires January 21, 2003        Martin                          [Page 3]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    Changes since PRE
-
-    -dropped synchronized literals. added HAVESPACE command
-
-    -changed capability response syntax. added CAPABILITY command
-
-    -allowed pipelining
-
-    - "sieve" -> "Sieve". Other minor fixes
-
-    -made script names more flexible
-
-    -added starttls support
-
-
-
-
-1.2.  Conventions Used in the Document
-
-    The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
-    "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
-    document are to be interpreted as described in [KEYWORDS].
-
-    In examples, "C:" and "S:" indicate lines sent by the client and
-    server respectively. Line breaks that do not start a new "C:" or
-    "S:" exist for editorial reasons.
-
-
-
-
-1.3.  Syntax
-
-    This a line oriented protocol much like [IMAP4rev1] or [ACAP]. There
-    are three types: ATOMS, numbers and strings. Strings may be quoted
-    or literal. See [ACAP] for detailed descriptions of these types.
-
-    Each command consists of an atom followed by zero or more strings
-    and numbers terminated by a newline.
-
-    All client queries are replied to with either an OK, NO, or BYE
-    response. Each response may be followed by a response code (see
-    response codes section) and by a string consisting of human readable
-    text in the local language. The contents of the string SHOULD be
-    shown to the user and implementations MUST NOT attempt to parse the
-    message for meaning.
-
-    The BYE command may be used if the server wishes to close the
-    connection. A server may wish to do this because the client was idle
-
-
-
-Expires January 21, 2003        Martin                          [Page 4]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    too long or there were too many failed authentication attempts. This
-    command can be issued at any time and should be immediately followed
-    by a server hang-up of the connection. If a server has a inactivity
-    timeout resulting in client autologout it MUST be no less than 30
-    minutes.
-
-    IANA registration is pending. Current implementations generally use
-    port number 2000.
-
-
-
-1.4.  Response Codes
-
-    An OK, NO, or BYE response from the server MAY contain a response
-    code to describe the event in a more detailed machine parsable
-    fashion. A response code consists of data inside parentheses in the
-    form of an atom, possibly followed by a space and arguments.
-    Response codes are defined when there is a specific action that a
-    client can take based upon the additional information. In order to
-    support future extension, the response code is represented as a
-    slash-separated hierarchy with each level of hierarchy representing
-    increasing detail about the error. Clients MUST tolerate additional
-    hierarchical response code detail which they don't understand.
-
-    The currently defined response codes are:
-
-    AUTH-TOO-WEAK
-
-    This response code is returned on a tagged NO result from an
-    AUTHENTICATE command. It indicates that site security policy forbids
-    the use of the requested mechanism for the specified authentication
-    identity.
-
-    ENCRYPT-NEEDED
-
-    This response code is returned on NO result from an AUTHENTICATE
-    command. It indicates that site security policy requires the use of
-    a strong encryption mechanism for the specified authentication
-    identity and mechanism.
-
-    QUOTA
-
-    The command would have placed the user above the site-defined quota
-    constraints.
-
-    REFERRAL
-
-    This response code may be returned with a BYE result from any
-
-
-
-Expires January 21, 2003        Martin                          [Page 5]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    command, and includes a mandatory parameter that indicates what
-    server to access to manage this user's sieve scripts.  The server
-    will be specified by a Sieve URL (see "Sieve URL Scheme" section).
-    The scriptname portion of the URL MUST NOT be specified. The client
-    should authenticate to the specified server and use it for all
-    further commands in the current session.
-
-    SASL
-
-    This response code can occur in the OK response to a successful
-    AUTHENTICATE command and includes the optional final server response
-    data from the server as specified by [SASL].
-
-    TRANSITION-NEEDED
-
-    This response code occurs on a NO response to an AUTHENTICATE
-    command. It indicates that the user name is valid, but the entry in
-    the authentication database needs to be updated in order to permit
-    authentication with the specified mechanism. This can happen if a
-    user has an entry in a system authentication database such as Unix
-    /etc/passwd, but does not have credentials suitable for use by the
-    specified mechanism.
-
-
-    TRYLATER
-
-    A command failed due to a temporary server failure. The client MAY
-    continue using local information and try the command later.
-
-    Client implementations MUST tolerate response codes that they do not
-    recognize.
-
-
-
-1.5.  Active Script
-
-    A user may have multiple Sieve scripts on the server, yet only one
-    script may be used for filtering of incoming messages. This is the
-    active script. Users may have zero or one active scripts and MUST
-    use the SETACTIVE command described below for changing the active
-    script or disabling Sieve processing. For example, a user may have
-    an everyday script they normally use and a special script they use
-    when they go on vacation. Users can change which script is being
-    used without having to download and upload a script stored somewhere
-    else.
-
-
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 6]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-1.6.  Quotas
-
-    Servers SHOULD impose quotas to prevent malicious users from
-    overflowing available storage. If a command would place a user over
-    a quota setting, servers MUST reply with a NO response. Client
-    implementations MUST be able to handle commands failing because of
-    quota restrictions.
-
-
-
-1.7.  Script Names
-
-    Sieve script names may contain any valid UTF8 characters, but names
-    must be at least one octet long. Script names zero octets in length
-    have special meaning. (see SETACTIVE command section) Servers MUST
-    allow names of up to 128 UTF8 octets in length, and may allow longer
-    names.
-
-
-
-1.8.  Capabilities
-
-    Server capabilities are sent by the server upon a client connection.
-    Clients may request the capabilities at a later time by issuing the
-    CAPABILITY command described later. The capabilities consist of a
-    series of lines each with one or two strings. The first string is
-    the name of the capability. The second optional string is the value
-    associated with that capability.
-
-    The following capabilities are defined here:
-
-    IMPLEMENTATION - Name of implementation and version
-
-    SASL - List of SASL mechanisms supported by the server, each
-    separated by a space
-
-    SIEVE - List of space separated Sieve extensions supported
-
-    STARTTLS - If TLS[TLS] is supported by this implementation
-
-    A client implementation MUST ignore any other capabilities given
-    that it does not understand.
-
-    Example:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-
-
-
-Expires January 21, 2003        Martin                          [Page 7]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    S: "STARTTLS"
-    S: OK
-
-
-
-2.  Commands
-
-    The following commands are valid. Prior to successful authentication
-    only the AUTHENTICATE, CAPABILITY, STARTTLS, and LOGOUT commands are
-    valid. Servers MUST reject all other commands with a NO response.
-    Clients may pipeline commands (send more than one command at a time
-    without waiting for completion of the first command ). However, a
-    group of commands sent together MUST NOT have a HAVESPACE command
-    anywhere but the last command in the list.
-
-
-
-2.1.  AUTHENTICATE Command
-
-    Arguments:
-         String - mechanism
-         String - initial data (optional)
-
-    The AUTHENTICATE command indicates a SASL [SASL] authentication
-    mechanism to the server.  If the server supports the requested
-    authentication mechanism, it performs an authentication protocol
-    exchange to authenticate and identify the user.  Optionally, it also
-    negotiates a security layer for subsequent protocol interactions.
-    If the requested authentication mechanism is not supported, the
-    server rejects the AUTHENTICATE command by sending a NO response.
-
-    The authentication protocol exchange consists of a series of server
-    challenges and client answers that are specific to the
-    authentication mechanism.  A server challenge consists of a string
-    followed by an endline. The contents of the string is a base-64
-    encoding of the SASL data. The client answer consists of a string
-    with the base-64 encoding of the SASL data followed by an endline.
-    If the mechanism dictates that the final response be sent by the
-    server this data MAY be placed within the data portion of the SASL
-    response code to save a round trip.
-
-    The optional initial-response argument to the AUTHENTICATE command
-    is used to save a round trip when using authentication mechanisms
-    that are defined to send no data in the initial challenge.  When the
-    initial-response argument is used with such a mechanism, the initial
-    empty challenge is not sent to the client and the server uses the
-    data in the initial-response argument as if it were sent in response
-    to the empty challenge.  If the initial-response argument to the
-
-
-
-Expires January 21, 2003        Martin                          [Page 8]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    AUTHENTICATE command is used with a mechanism that sends data in the
-    initial challenge, the server rejects the AUTHENTICATE command by
-    sending a tagged NO response.
-
-    The service name specified by this protocol's profile of SASL is
-    "sieve"
-
-    If a security layer is negotiated through the SASL authentication
-    exchange, it takes effect immediately following the CRLF that
-    concludes the authentication exchange for the client, and the CRLF
-    of the OK response for the server.
-
-    Implementations MAY advertise the ANONYMOUS SASL mechanism [SASL-
-    ANON]. This indicates that the server supports ANONYMOUS sieve
-    script syntax verification. Only the CAPABILITY, PUTSCRIPT and
-    LOGOUT commands are available to the anonymous user. All other
-    commands MUST give NO responses. Furthermore the PUTSCRIPT command
-    SHOULD NOT store any data. In this mode a positive response to the
-    PUTSCRIPT command indicates that the given script does not have any
-    syntax errors.
-
-    Server implementations SHOULD support authorization so that an
-    administrator can administer a user's scripts. Authorization is when
-    a user authenticates as himself but logs in as another user.
-
-    If an AUTHENTICATE command fails with a NO response, the client may
-    try another authentication mechanism by issuing another AUTHENTICATE
-    command.  In other words, the client may request authentication
-    types in decreasing order of preference.
-
-
-
-    Examples:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-    S: "STARTTLS"
-    S: OK
-    C: Authenticate "KERBEROS_V4"
-    S: "6UM4Ig=="
-    C: "BAYBQU5EUkVXLkNNVS5FRFUAOCjDCH77GOzSSOF1Df2Kb0zzPe
-    QJIrweAPyo6Q1T9xuYtCGylDqRYlbUFa77esDOtBJdDE5qRXcwHXQE5Dg
-    amqj0LqecZtKUCc8g2xpcqxn1fc/CH6QdZLOAGVpHTN1AX2Y="
-    S: "cmnEYo1x6wc="
-    C: "kjuaMkUeg2okQh+we2uiJw=="
-    S: OK
-
-
-
-
-Expires January 21, 2003        Martin                          [Page 9]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    C: Authenticate "PLAIN" "QJIrweAPyo6Q1T9xu"
-    S: BYE "Too many failed authentication attempts"
-    Server closes connection
-
-
-
-2.2.  STARTTLS Command
-
-    The STARTTLS command requests to commencement of a TLS negotiation.
-    The negotiation begins immediately after the CRLF in the OK
-    response. After a client issues a STARTTLS command, it MUST NOT
-    issue further commands until a server response is seen and the TLS
-    negotiation is complete.
-
-     The STARTTLS command is only valid in non-authenticated state. The
-    server remains in non-authenticated state, even if client
-    credentials are supplied during the TLS negotiation. The SASL [SASL]
-    EXTERNAL mechanism MAY be used to authenticate once TLS clie nt
-    credentials are successfully exchanged, but servers supporting the
-    STARTTLS command are not required to support the EXTERNAL mechanism.
-
-    After the TLS layer is established, the server MUST re-issue the
-    capability results. This is necessary to protect against man-in-the-
-    middle attacks which alter the capabilities list prior to STARTTLS.
-    The client MUST discard cached capability information and replace it
-    with the new information. The server MAY advertise different
-    capabilities after STARTTLS.
-
-    Example:
-
-    C: STARTTLS
-    S: OK
-    <TLS negotiation, further commands are under TLS layer>
-
-
-
-2.3.  LOGOUT Command
-
-    The client sends the LOGOUT command when it is finished with a
-    connection and wishes to terminate it. The server MUST reply with an
-    OK response and terminate the connection. The server MUST ignore
-    commands issued by the client after the LOGOUT command.
-
-    Example:
-
-    C: Logout
-    S: OK
-    <connection terminated>
-
-
-
-Expires January 21, 2003        Martin                         [Page 10]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-2.4.  CAPABILITY Command
-
-    The CAPABILITY command requests the server capabilities as described
-    earlier in this document. While the capabilities are sent upon
-    connection, they may change during authentication. The client SHOULD
-    issue a CAPABILITY command after successful authentication or after
-    negotiating a security layer using STARTTLS.
-
-
-    Example:
-
-    S: "IMPLEMENTATION" "CMU Cyrus Sieved v001"
-    S: "SASL" "PLAIN KERBEROS_V4 GSSAPI"
-    S: "SIEVE" "FILEINTO VACATION"
-    S: "STARTTLS"
-    S: OK
-
-
-
-
-2.5.  HAVESPACE Command
-
-    Arguments:
-         String - name
-         Number - size
-
-    The HAVESPACE command is used to query the server for available
-    space. Clients specify the name they wish to save the script as and
-    it's size in octets. Servers respond with an NO if storing a script
-    with that name and size would fail or OK otherwise. Clients should
-    issue this command before attempting to place a script on the
-    server.
-
-    Example:
-
-    C: HAVESPACE "myscript" 999999
-    S: NO "Quota exceeded"
-
-    C: HAVESPACE "foobar" 435
-    S: OK
-
-
-
-
-2.6.  PUTSCRIPT Command
-
-    Arguments:
-         String - Script name
-
-
-
-Expires January 21, 2003        Martin                         [Page 11]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-         String - Script content
-
-    The PUTSCRIPT command is used by the client to submit a Sieve script
-    to the server.
-
-    If the script already exists upon success the old script will be
-    overwritten. The old script MUST NOT be overwritten if PUTSCRIPT
-    fails in any way. A script of zero length SHOULD be disallowed.
-
-    This command places the script on the server. It does not affect
-    whether the script is processed on incoming mail. The SETACTIVE
-    command is used to mark a script as active.
-
-    When submitting large scripts clients SHOULD use the HAVESPACE
-    command beforehand to query if the server is willing to accept a
-    script of that size.
-
-    The server MUST check the submitted script for syntactic validity.
-    If the script fails this test the server MUST reply with a NO
-    response. Any script that fails the validity test MUST NOT be stored
-    on the server. The message given with a NO response MUST be human
-    readable and SHOULD contain a specific error message giving line
-    number of the first error. Implementors should strive to produce
-    helpful error messages similar to those given by programming
-    language compilers. Client implementations should note that this may
-    be a multiline literal string with more than one error message
-    separated by newlines.
-
-    Example:
-
-    C: Putscript "foo" {31+}
-    C: #comment
-    C: InvalidSieveCommand
-    C:
-    S: NO "line 2: Syntax error"
-
-    C: Putscript "mysievescript" {110+}
-    C: require ["fileinto"];
-    C:
-    C: if envelope :contains "to" "tmartin+sent" {
-    C:   fileinto "INBOX.sent";
-    C: }
-    S: OK
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 12]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-2.7.  LISTSCRIPTS Command
-
-    This command lists the scripts the user has on the server. Upon
-    success a list of linebreak separated script names is returned
-    followed by an OK response. If there exists an active script the
-    atom ACTIVE is appended to the line of that script. The ACTIVE
-    string MUST NOT appear on more than one response line.
-
-    Example:
-
-    C: Listscripts
-    S: "summer_script"
-    S: "vacation_script"
-    S: "main_script" ACTIVE
-    S: OK
-
-
-
-2.8.  SETACTIVE Command
-
-    Arguments:
-         String - script name
-
-    This command sets a script active. If the script name is the empty
-    string (i.e. "") then any active script is disabled. If the script
-    does not exist on the server then the server MUST reply with a NO
-    response.
-
-    Examples:
-
-    C: Setactive "vacationscript"
-    S: Ok
-
-    C: Setactive ""
-    S: Ok
-
-    C: Setactive "baz"
-    S: No "There is no script by that name"
-
-
-
-2.9.  GETSCRIPT Command
-
-    Arguments:
-         String - Script name
-
-    This command gets the contents of the specified script. If the
-    script does not exist the server MUST reply with a NO response. Upon
-
-
-
-Expires January 21, 2003        Martin                         [Page 13]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    success a string with the contents of the script is returned
-    followed by a OK response.
-
-    Example:
-
-    C: Getscript "myscript"
-    S: {48+}
-    S: #this is my wonderful script
-    S: reject "I reject all";
-    S:
-    S: OK
-
-
-
-
-2.10.  DELETESCRIPT Command
-
-    Parameters:
-         sieve-name - Script name
-
-    This command is used to delete a user's Sieve script. Servers MUST
-    reply with a NO response if the script does not exist. The server
-    MUST NOT allow the client to delete an active script and reply with
-    a NO response if attempted. If a client wishes to delete an active
-    script it should use the SETACTIVE command to disable the script
-    first.
-
-    Example:
-
-    C: Deletescript "foo"
-    S: Ok
-
-    C: Deletescript "baz"
-    S: No "You may not delete an active script"
-
-
-
-3.  Sieve URL Scheme
-
-    URL scheme name: "sieve"
-
-    URL scheme syntax:
-
-      Described using ABNF [RFC 2234] and ABNF entities from RFC 2396.
-
-      sieveurl = "sieve://" [ hostport ] "/" scriptname
-
-      scriptname = *pchar
-
-
-
-Expires January 21, 2003        Martin                         [Page 14]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-      Character encoding considerations: The script name, if present,
-      is in UTF-8.  Non-ASCII characters must be escaped as described
-      in RFC 2396.
-
-    Intended usage: A sieve URL identifies a sieve server or a sieve
-      script on a sieve server.  The latter always have the
-      application/sieve MIME type.
-
-    Applications and/or protocols which use this URL scheme name:
-      The protocol is described in this document.
-
-    Interoperability considerations:  None.
-
-    Security considerations:  None.
-
-    Relevant publications:  This document and RFC 3028.
-
-    Person & email address to contact for further information:
-      Author of this document.
-
-    Author/Change controller:  Author of this document.
-
-
-
-4.  Formal Syntax
-
-    The following syntax specification uses the augmented Backus-Naur
-    Form (BNF) notation as specified in [ABNF]. This uses the ABNF core
-    rules as specified in Appendix A of the ABNF specification [ABNF].
-
-    Except as noted otherwise, all alphabetic characters are case-
-    insensitive. The use of upper or lower case characters to define
-    token strings is for editorial clarity only. Implementations MUST
-    accept these strings in a case-insensitive fashion.
-
-
-    SAFE-CHAR             = %x01-09 / %x0B-0C / %x0E-21 / %x23-5B / %x5D-7F
-                            ;; any TEXT-CHAR except QUOTED-SPECIALS
-
-    QUOTED-CHAR           = SAFE-UTF8-CHAR / "\" QUOTED-SPECIALS
-
-    QUOTED-SPECIALS       = <"> / "\"
-
-    SAFE-UTF8-CHAR        = SAFE-CHAR / UTF8-2 / UTF8-3 / UTF8-4 /
-                            UTF8-5 / UTF8-6
-
-    UTF8-1                = %x80-BF
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 15]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    UTF8-2                = %xC0-DF UTF8-1
-
-    UTF8-3                = %xE0-EF 2UTF8-1
-
-    UTF8-4                = %xF0-F7 3UTF8-1
-
-    UTF8-5                = %xF8-FB 4UTF8-1
-
-    UTF8-6                = %xFC-FD 5UTF8-1
-
-    auth-type             = <"> auth-type-name <">
-
-    auth-type-name        = iana-token
-                            ;; as defined in SASL [SASL]
-
-    command               = command-authenticate / command-logout / command-getscript /
-                            command-setactive / command-listscripts / command-deletescript /
-                            command-putscript / command-capability / command-havespace /
-                            command-starttls
-
-    command-authenticate  = "AUTHENTICATE" SP auth-type [SP string]  *(CRLF string)
-
-    command-capability    = "CAPABILITY" CRLF
-
-    command-deletescript  = "DELETESCRIPT" SP sieve-name CRLF
-
-    command-getscript     = "GETSCRIPT" SP sieve-name CRLF
-
-    command-havespace     = "HAVESPACE" SP sieve-name SP number CRLF
-
-    command-listscripts   = "LISTSCRIPTS" CRLF
-
-    command-logout        = "LOGOUT" CRLF
-
-    command-putscript     = "PUTSCRIPT" SP sieve-name SP string CRLF
-
-    command-setactive     = "SETACTIVE" SP sieve-name CRLF
-
-    command-starttls      = "STARTTLS" CRLF
-
-    literal               = "{" number  "+}" CRLF *OCTET
-                            ;; The number represents the number of octets
-                            ;; MUST be literal-utf8 except for values
-
-    number                = *DIGIT
-                            ;; A 32-bit unsigned number.
-                            ;; (0 <= n < 4,294,967,296)
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 16]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    quoted                = <"> *QUOTED-CHAR <">
-                            ;; limited to 1024 octets between the <">s
-
-    resp-code             = "AUTH-TOO-WEAK" / "ENCRYPT-NEEDED" /
-                            "QUOTA" / resp-code-sasl / resp-code-referral
-                            "TRANSITION-NEEDED" / "TRYLATER" /
-                            resp-code-ext
-
-    resp-code-referral   = "REFERRAL" SP sieveurl
-
-    resp-code-sasl        = "SASL" SP string
-
-    resp-code-ext         = iana-token [SP extension-data]
-                            ;; unknown codes MUST be tolerated by the client
-
-    response              = response-authenticate / response-logout / response-getscript /
-                            response-setactive / response-listscripts / response-deletescript /
-                            response-putscript / response-capability / response-havespace /
-                            response-starttls
-
-    response-authenticate = *(string CRLF) (response-oknobye)
-
-    response-capability   = *(string [SP string] CRLF) response-oknobye
-
-    response-deletescript = response-oknobye
-
-    response-getscript    = [string CRLF] response-oknobye
-
-    response-havespace    = response-oknobye
-
-    response-listscripts  = *(sieve-name [SP "ACTIVE"] CRLF) response-oknobye
-                   ;; ACTIVE may only occur with one sieve-name
-
-    response-logout       = response-oknobye
-
-    response-oknobye      = ("OK" / "NO" / "BYE") [SP "(" resp-code ")"] [SP string] CRLF
-
-    response-putscript    = response-oknobye
-
-    response-setactive    = response-oknobye
-
-    response-starttls     = response-oknobye
-
-    sieve-name            = string
-
-    string                = quoted / literal
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 17]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-5.  Security Considerations
-
-    The AUTHENTICATE command uses SASL [SASL] and TLS [TLS] to provide
-    basic authentication, authorization, integrity and privacy services.
-    When a SASL mechanism is used the security considerations for that
-    mechanism apply.
-
-    This protocol transactions are susceptible to passive observers or
-    man in the middle attacks which alter the data, unless the optional
-    encryption and integrity services of the AUTHENTICATE command are
-    enabled, or an external security mechanism is used for protection.
-    It may be useful to allow configuration of both clients and servers
-    to refuse to transfer sensitive information in the absence of strong
-    encryption.
-
-
-6.  Acknowledgments
-
-    Thanks to Simon Josefsson, Larry Greenfield, Allen Johnson, Chris
-    Newman, Lyndon Nerenberg, Alexey Melnikov, Tim Showalter, Sarah
-    Robeson, and Walter Wong for help with this document.
-
-
-
-7.  Copyright
-
-    Copyright (C) The Internet Society 1999. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-
-
-
-Expires January 21, 2003        Martin                         [Page 18]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-8.  References
-
-     [KEYWORDS] S. Bradner, "Key words for use in RFCs to Indicate
-         Requirement Levels", RFC 2119, March 1997
-
-         <ftp://ftp.isi.edu/in-notes/rfc2119.txt>
-
-
-[ABNF] Crocker, Overell, "Augmented BNF for Syntax Specifications:
-ABNF", RFC 2234, Internet Mail Consortium, Demon Internet Ltd, November
-1997.
-
-[ACAP] Newman, Myers, "ACAP -- Application Configuration Access Proto-
-col", RFC 2244, Innosoft, Netscape, November 1997.
-
-[IMAP4rev1] Crispin, M., "Internet Message Access Protocol - Version
-4rev1", RFC 2060, October 1996.
-
-[IMAP-URL] Newman, C.; "IMAP URL Scheme"; RFC 2192; Innosoft; September,
-1997
-
-[PLAIN] Newman, C. "Using TLS with IMAP, POP3 and ACAP", RFC 2595,
-Innosoft, June 1999.
-
-[SASL] Myers, J., "Simple Authentication and Security Layer (SASL)", RFC
-2222, Netscape Communications, October 1997.
-
-[SASL-ANON] Newman, C., "Anonymous SASL Mechanism", RFC 2245, November
-1997.
-
-[SIEVE] Showalter, T.; "Sieve: A Mail Filtering Language"; RFC 3028;
-Mirapoint, Inc.; January 2001
-
-[TLS] Dierks, T. and C. Allen, "The TLS Protocol Version 1.0", RFC 2246,
-January 1999.
-
-
-9.  Author's Address
-
-    Tim Martin
-    Mirapoint Inc.
-    909 Hermosa Court
-    Sunnyvale, CA 94085
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 19]
-
-Internet Draft           Managing Sieve Scripts            July 16, 2002
-
-
-    Phone: (408) 720-3835
-    EMail: tmartin@mirapoint.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Expires January 21, 2003        Martin                         [Page 20]
-
+http://ktown.kde.org/~dirk/sieve/draft-martin-managesieve-04.txt
Index: kioslaves/sieve/draft-melnikov-sieve-imapflags.txt
===================================================================
--- kioslaves/sieve/draft-melnikov-sieve-imapflags.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-melnikov-sieve-imapflags.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,504 +1 @@
-Network Working Group                                       
-Internet Draft: Sieve -- IMAP flag Extension                 A. Melnikov
-Document: draft-melnikov-sieve-imapflags-05.txt            Isode Limited
-Expires: December 2003                                         June 2003
-
-
-                      Sieve -- IMAP flag Extension
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is in full conformance with
-   all provisions of Section 10 of RFC2026.  Internet-Drafts are
-   working documents of the Internet Engineering Task Force (IETF), its
-   areas, and its working groups.  Note that other groups may also
-   distribute working documents as Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other documents
-   at any time.  It is inappropriate to use Internet- Drafts as
-   reference material or to cite them other than as "work in progress."
-
-   To learn the current status of any Internet-Draft, please check the
-   ``1id-abstracts.txt''  listing  contained  in  the  Internet-Drafts
-   Shadow   Directories   on   ftp.is.co.za   (Africa),  ftp.nordu.net
-   (Europe),  munnari.oz.au (Pacific Rim),  ds.internic.net  (US  East
-   Coast), or ftp.isi.edu (US West Coast).
-
-   The protocol discussed in this document is experimental and subject
-   to change.  Persons planning on either implementing or  using  this
-   protocol  are STRONGLY URGED to get in touch with the author before
-   embarking on such a project.
-
-Copyright
-
-   Copyright (C) The Internet Society 2000-2003.  All Rights Reserved.
-
-Abstract
-
-   Recent discussions have shown that it is desirable to set different
-   [IMAP] flags on message delivery.  This can be done, for example,
-   by a Sieve interpreter that works as a part of a Mail Delivery
-   Agent.
-
-   This document describes an extension to the Sieve mail filtering
-   language for setting [IMAP] flags. The extension allows to set both
-   [IMAP] system flags and [IMAP] keywords.
-
-
-0. Meta-information on this draft
-
-   This information is intended to facilitate discussion.  It will be
-   removed when this document leaves the Internet-Draft stage.
-
-   Editorial comments are marked with << and >>.
-
-
-0.1. Discussion
-
-   This draft defines an extension to the Sieve mail filtering
-   language (RFC 3028) being  discussed  on the MTA Filters
-   mailing list at <ietf-mta-filters@imc.org>.  Subscription  requests
-   can  be  sent  to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body). More information on
-   the  mailing  list  along  with  a  WWW archive of back messages is
-   available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2. Open issues
-
-   1. There is no way to specify which flags to set on implicit keep.
-      Is this an issue?
-
-
-0.3. Changes from the version submitted to the Sieve mailing list
-
-   1. Added addflag and removeflag actions
-
-   2. Changed the semantics of setflag (setflag is not additive any
-      more)
-
-   3. Corrected section "Interaction with Other Sieve Actions".
-      Removed incorrect reference to the forward action as to an
-      action that prohibits setflag.
-
-   4. Added paragraph about the mutual order of "fileinto"/"keep" and
-      "setflag"/"addflag"/"removeflag" actions.
-
-
-0.4. Changes from the revision 00
-
-   1. Corrected Capability Identifier section (Section 2)
-
-   2. Corrected "Interaction with Other Sieve Actions" section
-      (Section 4)
-
-   3. Examples were updated to be compatible with Sieve-07 draft
-
-   4. Added "mark" and "unmark" actions
-
-
-0.5. Changes from the revision 01
-
-   1. Some language fixes based on Tony Hansen comments
-
-   2. Clarified that the extension allows to set both IMAP System
-      Flags and Keywords
-
-
-0.6. Changes from the revision 02
-
-   1. BugFix: all backslashes must be escaped
-
-   2. Added extended example and more detailed description of
-      "addflag"/"removeflag" additivity.
-
-   3. Minor example bugfixes
-
-
-0.7. Changes from the revision 03
-
-   1. Added second way to specify flags to be set (via optional tagged
-      arguments). [Tim Showalter]
-
-   2. Rules for using Reject with imapflags relaxed. [Randall Gellens]
- 
-   3. Removed ABNF section completely, added syntax description to
-      action definition. [Tim Showalter]
-
-   4. Cleaned up the example. [Ken Murchison]
-
-   5. Added FM (Flag Manupulation) acronym.
-
-   6. Clarified "mark"/"unmark" bahavior. [Randall Gellens]
-
-
-0.8. Changes from the revision 04
-
-   1. "Interaction with Other Sieve Actions" was simplified based on
-      comments from Tim Showalter.  Added sentence saying that
-      imapflags doesn't change an implicit keep.
-
-   2. Several editorial comments from Tim Showalter.
-
-0.9. Changes from the revision 05
-
-   1. Updated copyright, author address, section numbers and references.
-
-   2. Several editorial comments from Matthew Elvey.
-
-   3. Removed "mark" and "unmark" actions.
-
-   4. Removed "setflag" action.
-
-   5. Added "hasflag" test.
-
-
-1. Introduction
-
-   This is an extension to the Sieve language defined by [SIEVE] for
-   setting [IMAP] flags. It adds a new tagged argument to "keep" and
-   "fileinto" that describes the list of flags that have to be set
-   when the message is delivered to the specified mailbox. It also
-   adds several actions to help manipulate list of flags and a test
-   to check if a flag belongs to a list.
-
-   This extension depends on the presence of "variables" extension
-   [Variables].
-
-   Sieve interpreters that don't support integration with IMAP SHOULD
-   ignore this extension.
-
-   The capability string associated with extension defined in this
-   document is "imapflags".
-
-<<Change extension name?>>
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-
-3. Actions
-
-   All actions described in this specification (addflag, removeflag)
-   operate on string variables that contain a set of [IMAP] flags.
-   On variable substitution a set of flags is represented as a string
-   containing space separated list of flag names.
-   The "addflag" action adds flags to an existing set. The "removeflag"
-   action removes flags from an existing set. The "set" action defined in
-   [Variables] can be used to replaces an existing set of flags with a
-   new set. The :flags tagged argument is used to associate a set of flags
-   referenced by a variable with the current message.
-
-<<Keep setflags as list to string converter operation?>>
-
-3.1. Addflag action
-
-   Syntax:   addflag <variablename: string> <list-of-flags: string-list>
-
-   Addflag is used to add flags to a list of [IMAP] flags. It doesn't
-   replace any previously set flags. This means that multiple occurrences
-   of addflag are treated additively. The order of the flags MAY NOT
-   be preserved and duplicates are allowed.
-
-   Addflag SHOULD check the list of flags for validity as described by
-   [IMAP] ABNF. In particular non-ASCII characters are not allowed in
-   flag names. However spaces MUST be always allowed and multiple spaces
-   between flag names MUST be treated as a single space character. The
-   last requirement is to simplify amalgamation of multiple flag lists.
-
-   For example, the following two actions
-
-      addflag "flagvar" "\\Deleted";
-      addflag "flagvar" "\\Answered";
-
-   produce the same result as the single action
-
-      addflag "flagvar" ["\\Deleted", "\\Answered"];
-
-   or
-
-      addflag "flagvar" "\\Deleted \\Answered";
-
-   or
-
-      addflag "flagvar" "\\Answered   \\Deleted";
-
-
-3.2. Removeflag Action
-
-   Syntax:   removeflag <variablename: string> <list-of-flags: string-list>
-
-   Removeflag is used to remove flags from a list of [IMAP] flags.
-   Removeflag clears flags previously set by "set"/"addflag". Calling
-   removeflag with a flag that wasn't set before is not an error and
-   is ignored. Multiple occurrences of removeflag are treated additively.
-
-   Removeflag SHOULD check the list of flags for validity as described by
-   [IMAP] ABNF. In particular non-ASCII characters are not allowed in
-   flag names. However spaces MUST be always allowed and multiple spaces
-   between flag names MUST be treated as a single space character.
-
-      Example:
-        if header :contains "Disposition-Notification-To" "mel@example.com" {
-            addflag "flagvar" "$MDNRequired";
-        }
-        if header :contains "from" "imap@cac.washington.edu" {
-            removeflag "flagvar" "$MDNRequired";
-            fileinto :globalflags "INBOX.imap-list";
-        }
-
-
-4.  Test hasflag
-
-   Syntax: hasflag [MATCH-TYPE]
-           <variable-list: string-list> <flag-list: string-list>
-
-   The "hasflag" test evaluates to true if any of the variables matches any
-   flag name.  The type of match defaults to ":is".
-
-   Flagname comparisons is always done with the "i;ascii-casemap" operator,
-   i.e., case-insensitive comparisons, as defined in [IMAP].
-
-   Note, that if an implementation automatically performs flags reordering
-   and/or duplicate elimination, it MUST perform it on both variable-list
-   values and flag-list values. This is required so that, when the variable
-   "flags" has the value "A B", the following test
-
-    hasflag :is "flags" "b A"
-
-   evaluates to true as expected.
-
-
-5. Tagged argument - :flags
-
-   This specification adds a new optional tagged argument ":flags" that
-   alter the behavior of actions "keep" and "fileinto".
-
-   The :flags tagged argument specifies that the flags provided in the
-   subsequent argument should be set when fileinto/keep deliver the message
-   to the target mailbox/user's main mailbox. If the :flags tagged argument
-   is not specified, "keep" or "fileinto" will not set any flag when they
-   deliver the message to the mailbox.
-
-   Syntax:   ":flags" <list-of-flags: string-list>
-
-   The copy of the message filed into mailbox will have only flags
-   listed after ":flags".
-
-   The Sieve interpreter MUST check that all flag names are valid [IMAP] flag
-   names and MUST signal a script execution error if they are not. The Sieve
-   interpreter MUST ignore all flags that it can't store
-   permanently. This means that the interpreter must not treat failure
-   to store any flag as a runtime failure to execute the Sieve
-   script. For example, if the mailbox "INBOX.From Boss" can't store any
-   flags, then
-
-     fileinto :flags "\\Deleted" "INBOX.From Boss";
-
-   and
-
-     fileinto "INBOX.From Boss";
-
-   are equivalent.
-
-   This document doesn't dictate how the Sieve interpreter will set
-   the [IMAP] flags. In particular, the Sieve interpreter may work as
-   an IMAP client, or may have direct access to the mailstore.
-
-<<If we propose using a string list, we have to tell that "" are ignored.
-Also, deprecate spaces in flag names? However, if we change the
-parameter to be a space separated string of flags, we don't have
-these issues.>>
-
-
-6. Implementation Notes
-
-   "Addflag <variable> <flaglist>" can be implemented as several actions
-   "set <variable> "${variable} <flag>", where <flag> is a flag in flaglist.
-
-   A script interpreter MAY reorder flags and remove duplicates from the list.
-   A SIEVE script write MUST NOT assume that the order or duplicates will be
-   preserved.
-
-<<Describe how removeflag and hasflag can be implemented using [Variables]>>
-
-
-7. Interaction with Other Sieve Actions
-
-   This extension work only on the message that is currently being
-   processed by Sieve, it doesn't affect another message generated
-   as a side affect of any action.
-
-   The extension decribed in this document doesn't change an implicit
-   keep (see section 2.10.2 of [SIEVE]).
-
-
-8. Other Considerations
-
-   This extension intentionally doesn't allow setting [IMAP] flags on
-   an arbitrary message in the [IMAP] message store.
-
-
-9. Security Considerations
-
-   Security considerations are discussed in the [IMAP] and [SIEVE].
-   It is belived that this extension doesn't introduce any additional
-   security concerns.
-
-
-10. Extended example
-
-   #
-   # Example Sieve Filter
-   # Declare any optional features or extension used by the script
-   #
-   require ["fileinto", "imapflags", "variables"];
-
-   #
-   # Move large messages to special mailbox
-   #
-   if size :over 1M
-           {
-           add "flags" "Big";
-           if header :is "From" "boss@company.com"
-                      {
-   # The message will be marked as "\Flagged Big" when filed into 
-   # mailbox "Big messages"
-                      add "flags" "\\Flagged";
-                      }
-           fileinto :flags "${flags}" "Big messages";
-           }
-
-   if header :is "From" "grandma@example.net"
-           {
-           add "flags" ["\\Answered", "$MDNSent"];
-   # If the message is bigger than 1Mb it will be marked as 
-   # "Big \Answered $MDNSent" when filed into mailbox "grandma". 
-   # If the message is shorter than 1Mb it will be marked as
-   # "\Answered $MDNSent"
-           fileinto :flags "${flags}" "GrandMa";  # move to "GrandMa" folder
-           }
-
-   #
-   # Handle messages from known mailing lists
-   # Move messages from IETF filter discussion list to filter folder
-   #
-   if header :is "Sender" "owner-ietf-mta-filters@imc.org"
-           {
-           set "flags" "\\Flagged $Work";
-   # Message will have both "\Flagged" and $Work flags
-           keep :flags "${flags}";
-           }
-
-   #
-   # Keep all messages to or from people in my company
-   #
-   elsif anyof address :domain :is ["From", "To"] "company.com"
-           {
-           keep :flags "${flags}";               # keep in "Inbox" folder
-           }
-   #
-   # Try and catch unsolicited email.  If a message is not to me,
-   # or it contains a subject known to be spam, file it away.
-   #
-   elsif anyof (not address :all :contains
-                  ["To", "Cc"] "me@company.com",
-                header :matches "subject"
-                  ["*make*money*fast*", "*university*dipl*mas*"])
-           {
-           remove "flags" "\\Flagged";
-           # If message header does not contain my address,
-           # it's from a list.
-           fileinto :flags "${flags}" "spam";   # move to "spam" folder
-           }
-   else
-           {
-           # Move all other (non-company) mail to "personal"
-           # folder.
-           fileinto :flags "${flags}" "personal";
-           }
-
-
-11.  Acknowledgments
-
-    This document has been revised in part based on comments and
-    discussions which took place on and off the Sieve mailing list.
- 
-    The help of those who took the time to review the draft and make
-    suggestions is appreciated, especially that of Tim Showalter,
-    Barry Leiba, Randall Gellens, Ken Murchison, Cyrus Daboo,
-    Matthew Elvey, Jutta Degener, Ned Freed, Marc Mutz and
-    Kjetil Torgrim Homme.
-
-    Special thanks to Tony Hansen, David Lamb and
-    Roman Migal for helping me explain better the concept.
-
-
-12. Author's Address
-
-    Alexey Melnikov
-    Isode
-    28 Gloucester Road,
-    Teddington, Middlesex
-    United Kingdom, TW11 0NU
-
-    Email: mel@isode.com
-
-
-13.  Normative References
-
-    [SIEVE] Showalter, T.,  "Sieve: A Mail Filtering Language", Mirapoint,
-    RFC 3028, January 2001.
-
-    [ABNF] Crocker, D.,  "Augmented BNF for Syntax Specifications: ABNF",
-    Internet Mail Consortium, RFC 2234, November, 1997.
-
-    [KEYWORDS] Bradner, S., "Key  words  for  use  in  RFCs  to  Indicate
-    Requirement Levels", Harvard University, RFC 2119, March 1997.
-
-    [IMAP] Crispin, M., "INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1",
-    University of Washington, RFC 3501, March 2003.
-
-    [Variables] Homme, K. T., "Sieve -- Variables Extension", University of
-    Oslo, work in progress, draft-homme-sieve-variables-XX.txt
-
-
-14.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2000-2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
+http://ktown.kde.org/~dirk/sieve/draft-melnikov-sieve-imapflags.txt
Index: kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt
===================================================================
--- kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-murchison-sieve-subaddress-05.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,396 +1 @@
-
-
-
-
-
-
-
-Network Working Group                                        K. Murchison
-Document: draft-murchison-sieve-subaddress-05.txt      Oceana Matrix Ltd.
-Expires January 5, 2003                                      30 June 2002
-
-
-                        Sieve -- Subaddress Extension
-
-
-Status of this Memo
-
-    This document is an Internet-Draft and is in full conformance with
-    all provisions of Section 10 of RFC2026.  Internet-Drafts are working
-    documents of the Internet Engineering Task Force (IETF), its areas,
-    and its working groups.  Note that other groups may also distribute
-    working documents as Internet-Drafts.
-
-    Internet-Drafts are draft documents valid for a maximum of six months
-    and may be updated, replaced, or obsoleted by other documents at any
-    time.  It is inappropriate to use Internet-Drafts as reference
-    material or to cite them other than as "work in progress."
-
-    The list of current Internet-Drafts can be accessed at
-    http://www.ietf.org/ietf/1id-abstracts.txt
-
-    To view the list Internet-Draft Shadow Directories, see
-    http://www.ietf.org/shadow.html.
-
-    Distribution of this memo is unlimited.
-
-Copyright Notice
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-
-Abstract
-
-    On email systems that allow for "subaddressing" or "detailed
-    addressing" (eg, "ken+sieve@example.org"), it is sometimes desirable
-    to make comparisons against these sub-parts of addresses.  This draft
-    defines an extension to the Sieve mail filtering language that allows
-    users to compare against the user and detail parts of an address.
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 1]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-                           Table of Contents
-
-
-
-Status of this Memo  . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Copyright Notice . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-Abstract . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .   1
-
-0.     Meta-information on this draft  . . . . . . . . . . . . . . .   3
-
-0.1.   Discussion  . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.   Noted Changes . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.1  since -04 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.2  since -03 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.3  since -02 . . . . . . . . . . . . . . . . . . . . . . . . . .   3
-
-0.2.4  since -01 . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-0.2.5  since -00 . . . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-1.     Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   4
-
-2.     Capability Identifier . . . . . . . . . . . . . . . . . . . .   4
-
-3.     Subaddress Comparisons  . . . . . . . . . . . . . . . . . . .   5
-
-4.     Security Considerations . . . . . . . . . . . . . . . . . . .   6
-
-5.     Acknowledgments . . . . . . . . . . . . . . . . . . . . . . .   6
-
-6.     Author's Address  . . . . . . . . . . . . . . . . . . . . . .   6
-
-Appendix A.  References  . . . . . . . . . . . . . . . . . . . . . .   7
-
-Appendix B.  Full Copyright Statement  . . . . . . . . . . . . . . .   7
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 2]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-
-0.     Meta-information on this draft
-
-    This information is intended to facilitate discussion.  It will be
-    removed when this document leaves the Internet-Draft stage.
-
-
-0.1.   Discussion
-
-    This draft is intended to be an extension to the Sieve mail filtering
-    language, available from the RFC repository as
-    <ftp://ftp.ietf.org/rfc/rfc3028.txt>.
-
-    This draft and the Sieve language itself are being discussed on the
-    MTA Filters mailing list at <ietf-mta-filters@imc.org>.  Subscription
-    requests can be sent to <ietf-mta-filters-request@imc.org> (send an
-    email message with the word "subscribe" in the body).  More
-    information on the mailing list along with a WWW archive of back
-    messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-0.2.   Noted Changes
-
-
-0.2.1  since -04
-
-    Non-existent ":detail" sub-part causes test to fail.
-
-    Editorial changes.
-
-
-0.2.2  since -03
-
-    Editorial changes.
-
-
-0.2.3  since -02
-
-    Decided on :user and :detail as sub-parts (removed Known Issues).
-
-    Noted that separator character MUST match the one used by the mail
-    system.
-
-    Editorial changes.
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 3]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-
-0.2.4  since -01
-
-    Added description of subaddressing inspired by Randy Gellens.
-
-    Added discussion of handling different separator characters.
-
-    Editorial changes.
-
-
-0.2.5  since -00
-
-    Added augmented ADDRESS-PART syntax element.
-
-    Editorial changes.
-
-
-1.  Introduction
-
-    Subaddressing is the practice of appending some "detail" information
-    to the local-part of an [IMAIL] address to indicate that the message
-    should be delivered to the set of messages specified by the "detail"
-    information.  The "detail" information is prefixed with a special
-    "separator character" (typically "+") which forms the boundary
-    between the "user" (original local-part) and the "detail" sub-parts
-    of the address, much like the "@" character forms the boundary
-    between the local-part and domain.
-
-    Typical uses of subaddressing might be:
-
-    - A message addressed to "ken+sieve@example.org" is delivered into a
-    mailbox called "sieve" belonging to the user "ken".
-
-    - A message addressed to "5551212#123@example.org" is delivered to
-    the voice mailbox number "123" at phone number "5551212".
-
-    This document describes an extension to the Sieve language defined by
-    [SIEVE] for comparing against the "user" and "detail" sub-parts of an
-    address.
-
-    Conventions for notations are as in [SIEVE] section 1.1, including
-    use of [KEYWORDS].
-
-
-2.  Capability Identifier
-
-    The capability string associated with the extension defined in this
-    document is "subaddress".
-
-
-
-Expires January 5, 2003       Murchison                         [Page 4]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-3.  Subaddress Comparisons
-
-    Commands that act exclusively on addresses may take the optional
-    tagged arguments ":user"  and ":detail" to specify what sub-part of
-    the local-part of the address will be acted upon.
-
-    NOTE: In most cases, the envelope "to" address is the prefered
-    address to examine for subaddress information when the desire is to
-    sort messages based on how they were addressed so as to get to a
-    specific recipient.  The envelope address is, after all, the reason a
-    given message is being processed by a given sieve script for a given
-    user.  This is particularly true when mailing lists, aliases, and
-    "virtual domains" are involved since the envelope may be the only
-    source of detail information for the specific recipient.
-
-    The ":user" argument specifies that sub-part of the local-part which
-    lies to the left of the separator character (eg, "ken" in
-    "ken+sieve@example.org").  If no separator character exists, then
-    ":user" specifies the entire left-side of the address (equivalent to
-    ":localpart").
-
-    The ":detail" argument specifies that sub-part of the local-part
-    which lies to the right of the separator character (eg, "sieve" in
-    "ken+sieve@example.org").  If no separator characater exists, the the
-    test evaluates to false.  If nothing lies to the right of the
-    separator character, then ":detail" ":is" the null key ("").
-    Otherwise, the ":detail" sub-part contains the null key.
-
-    Implementations MUST make sure that the separator character matches
-    that which is used and/or allowed by the encompassing mail system,
-    otherwise unexpected results might occur.  Implementations SHOULD
-    allow the separator character to be configurable so that they may be
-    used with a variety of mail systems.
-
-    The ":user" and ":detail" address parts are subject to the same rules
-    and restrictions as the standard address parts defined in [SIEVE].
-    For convenience, the "ADDRESS-PART" syntax element defined in [SIEVE]
-    is augmented here as follows:
-
-         ADDRESS-PART  =/  ":user" / ":detail"
-
-
-    A diagram showing the ADDRESS-PARTs of a email address utilizing a
-    separator character of '+' is shown below:
-
-           :user "+" :detail  "@" :domain
-          `-----------------'
-              :local-part
-
-
-
-Expires January 5, 2003       Murchison                         [Page 5]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-    Example:
-
-          require "subaddress";
-
-          # File mailing list messages (subscribed as "ken+mta-filters").
-          if envelope :detail "to" "mta-filters" {
-            fileinto "inbox.ietf-mta-filters";
-          }
-
-          # If a message is not to me (ignoring +detail), junk it.
-          if not allof (address :user ["to", "cc", "bcc"] "ken",
-               address :domain ["to", "cc", "bcc"] "example.org") {
-            discard;
-          }
-
-          # Redirect all mail sent to +foo.
-          if envelope :detail ["to", "cc", "bcc"] "foo" {
-            redirect "ken@example.edu";
-          }
-
-
-4.  Security Considerations
-
-    Security considerations are discussed in [SIEVE].  It is believed
-    that this extension doesn't introduce any additional security
-    concerns.
-
-
-5.  Acknowledgments
-
-    Thanks to Tim Showalter, Alexey Melnikov, Michael Salmon, Randall
-    Gellens, Philip Guenther and Jutta Degener for their help with this
-    document.
-
-
-6.  Author's Address
-
-    Kenneth Murchison
-    Oceana Matrix Ltd.
-    21 Princeton Place
-    Orchard Park, NY 14127
-
-    Phone: (716) 662-8973
-    EMail: ken@oceana.com
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 6]
-
-Internet Draft        Sieve -- Subaddress Extension        June 30, 2003
-
-
-Appendix A.  References
-
-     [IMAIL] Resnick, P., Ed., "Internet Message Format", QUALCOMM
-         Incorporated, RFC 2822, April 2001.
-
-
-     [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
-         Requirement Levels", Harvard University, RFC 2119, March 1997.
-
-
-     [SIEVE] Showalter, T., "Sieve: A Mail Filtering Language", Mira
-         point, Inc., RFC 3028, January 2001.
-
-
-Appendix B.  Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of develop-
-    ing Internet standards in which case the procedures for copyrights
-    defined in the Internet Standards process must be followed, or as
-    required to translate it into languages other than English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-
-
-
-
-
-
-
-
-
-
-Expires January 5, 2003       Murchison                         [Page 7]
-
+http://ktown.kde.org/~dirk/sieve/draft-murchison-sieve-subaddress-05.txt
Index: kioslaves/sieve/draft-degener-sieve-multiscript.txt
===================================================================
--- kioslaves/sieve/draft-degener-sieve-multiscript.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kioslaves/sieve/draft-degener-sieve-multiscript.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,244 +1 @@
-Network Working Group                                       Jutta Degener
-Internet Draft					              Rand Wacker
-Expires: October 2003                                          April 2003
-
-
-              Sieve -- Sequential Execution of Multiple Scripts
-		  <draft-degener-sieve-multiscript-00.txt>
-
-
-Status of this memo
-
-   This document is an Internet-Draft and is subject to all
-   provisions of Section 10 of RFC2026.
-
-   Internet-Drafts are working documents of the Internet Engineering
-   Task Force (IETF), its areas, and its working groups.  Note that
-   other groups may also distribute working documents as
-   Internet-Drafts.
-
-   Internet-Drafts are draft documents valid for a maximum of six
-   months and may be updated, replaced, or obsoleted by other
-   documents at any time.  It is inappropriate to use Internet-
-   Drafts as reference material or to cite them other than as
-   "work in progress."
-
-   The list of current Internet-Drafts can be accessed at
-   http://www.ietf.org/1id-abstracts.html
-
-   The list of Internet-Draft Shadow Directories can be accessed at
-   http://www.ietf.org/shadow.html
-
-
-Abstract
-
-   This document defines sieve behavior relevant when multiple
-   scripts are executed sequentially on the same message.
-
-
-1. Introduction
-
-   E-mail messages frequently are processed by multiple agents
-   that implement nested layers of corporate policies.
-
-   For example, a provider may offer access to services that
-   perform spam- and virus filtering; a single corporation
-   may restrict e-mail to certain subdomains, or filter for
-   keywords; individual divisions within a corporation may
-   implement even more intrusive handling of e-mail messages,
-   for example by keeping a copy of all correspondence.
-   Amidst all of this, of course, users may still use sieve
-   filters to presort, redirect, or notify other accounts
-   as in the classic sieve use scenario.
-
-   In this context, it is desirable to specify an execution
-   model for sieve scripts when executed in series.  This
-   allows each layer of the mail filtering hierarchy to use
-   a separate sieve script to express its policies.
-
-
-2. Conventions used.
-
-   Conventions for notations are as in [SIEVE] section 1.1, including
-   use of [KEYWORDS] and "Syntax:" label for the definition of action
-   and tagged arguments syntax.
-
-   This document defines no sieve extensions and no capability string.
-
-
-3. Sequential Script Execution Model
-
-   When multiple scripts are executed for a message, they
-   are executed in a specific order.
-
-   Within this order, this document defines that trailing
-   scripts will be executed as long as the message is being
-   "kept", that is, as long as either an implicit or explicit
-   "keep" is in effect.
-
-   In other words, for every script but the last, "keep"
-   doesn't mean "file this message into INBOX", it means
-   "process this message with the next sieve script."
-
-
-4. Locality of script actions
-
-   This document strongly limits the effects of scripts
-   on each other.
-
-   The "require" clauses at the beginning of a script
-   only apply to this particular script, not to following
-   ones.   Different stages in the script processing
-   may support different "require" areas.  For example,
-   it is conceivable that "fileinto" is not supported
-   for a stage other than a user's private script.
-
-   The "stop;" command ends the execution of its single
-   containing script, not of scripts in general.
-
-   After one script terminates, the next script is executed
-   if an implicit or explicit "keep" is in effect.
-   (To end all script execution, a script should execute
-   "discard; stop;".)
-
-   For sieve engines that implement the "variables" extension,
-   variable state is not carried over between scripts.
-
-   For sieve engines that implement the "notify" extension,
-   the "denotify" action in one script can only cancel
-   "notify" actions from that same script.
-
-   However, if a sequence of script executions results in
-   the same message sent to the same recipient, or filed to
-   the same destination folder, more than once, an implementation
-   MAY only produce a single message, even if the commands
-   executed stem from multiple scripts.
-
-   If a sieve implementation enforces the incompatibility
-   of "reject" with other actions (a SHOULD in [SIEVE]),
-   it MUST only enforce it within one script; an action
-   in a preceding script MUST be compatible with a "reject"
-   in a later script.
-
-
-5. Script Errors
-
-   When an error occurs during processing of any of the
-   scripts, all message processing stops, and the message
-   is treated as if the final script had executed a "keep;".
-
-
-6. Security Considerations
-
-   A script executed before another script can prevent the
-   trailing script from running (by executing "discard; stop;"
-   or by encountering an error.)  This is deliberate.
-
-   Corporate filtering of employee e-mail may violate the
-   privacy expectations of employees.  However, since these
-   instances are the ones running the software that handles
-   employee e-mail to begin with, they already have the
-   technical capability to do this.
-
-
-7. Acknowledgments
-
-   Thanks to Eric Allman, Will Lee, Dowson Tong, and Chris Markle for comments.
-
-
-8. Authors' Addresses
-
-   Jutta Degener
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-   Email: jutta@sendmail.com
-
-   Rand Wacker
-   Sendmail, Inc.
-   6425 Christie Ave, 4th Floor
-   Emeryville, CA 94608
-   Email: rand@sendmail.com
-
-
-9. Discussion
-
-   This section will be removed when this document leaves the
-   Internet-Draft stage.
-
-   This draft is intended as an extension to the Sieve mail filtering
-   language.  Sieve extensions are discussed on the MTA Filters mailing
-   list at <ietf-mta-filters@imc.org>.  Subscription  requests can
-   be sent to <ietf-mta-filters-request@imc.org> (send an email
-   message with the word "subscribe" in the body).
-
-   More information on the mailing list along with a WWW archive of
-   back messages is available at <http://www.imc.org/ietf-mta-filters/>.
-
-
-9.1 Comparison to draft-daboo-sieve-include-00
-
-   The "include" sieve extension describes a mechanism for
-   naming and combining multiple scripts.  This document doesn't
-   do that; how the sequence of scripts to be executed on a
-   message is determined is left up to the environment and likely
-   out of control of the script owner.
-
-   The "include" sieve extension creates a hierarchical
-   tree of nested scripts; this extension describes sequential,
-   not hierarchical execution.
-
-   The "include" sieve extension defines the semantics of
-   "stop" to stop all sieve execution, not just that of the
-   innermost containing script.  It adds a new "return" command
-   to explicitly end execution of a single script.
-   This document specifies that "stop" just stops a single script, 
-   and uses the redefined meaning of "keep" to regulate the
-   flow of messages through scripts.
-
-
-9.2 "require" keyword
-
-   This draft started out with a "require" keyword, "multiscript",
-   but since what it describes lies outside the domain of strict
-   sieve language behavior, I'm not sure it needs one.
-
-
-Appendices
-
-Appendix A.  References
-
-   [KEYWORDS] 	Bradner, S., "Key words for use in RFCs to Indicate
-   		Requirement Levels", RFC 2119, March 1997.
-
-   [SIEVE] 	Showalter, T.,  "Sieve: A Mail Filtering Language", RFC 3028,
-		January 2001.
-
-
-Appendix B. Full Copyright Statement
-
-    Copyright (C) The Internet Society 2002,2003. All Rights Reserved.
-
-    This document and translations of it may be copied and furnished to
-    others, and derivative works that comment on or otherwise explain it
-    or assist in its implementation may be prepared, copied, published
-    and distributed, in whole or in part, without restriction of any
-    kind, provided that the above copyright notice and this paragraph
-    are included on all such copies and derivative works.  However, this
-    document itself may not be modified in any way, such as by removing
-    the copyright notice or references to the Internet Society or other
-    Internet organizations, except as needed for the purpose of
-    developing Internet standards in which case the procedures for
-    copyrights defined in the Internet Standards process must be
-    followed, or as required to translate it into languages other than
-    English.
-
-    The limited permissions granted above are perpetual and will not be
-    revoked by the Internet Society or its successors or assigns.
-
-    This document and the information contained herein is provided on an
-    "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-    TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-    BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-    HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
+http://ktown.kde.org/~dirk/sieve/draft-degener-sieve-multiscript.txt
Index: doc/kleopatra/index.docbook
===================================================================
--- doc/kleopatra/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ doc/kleopatra/index.docbook	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -7,46 +7,49 @@
   <!ENTITY gpgconf "<application>GpgConf</application>">
   <!ENTITY kappname "&kleopatra;">
   <!ENTITY package "kdepim">
+  <!ENTITY smime "<acronym>S/MIME</acronym>">
   <!ENTITY % addindex "IGNORE">
   <!ENTITY % English "INCLUDE">
 
   <!ENTITY dn "<acronym>DN</acronym>">
   <!ENTITY ca "<acronym>CA</acronym>">
 
-  <!-- FILE menu -->
+  <!-- Expanded all entities to make them translatable - lueck
+    FILE menu 
   <!ENTITY file-new-key-pair "<menuchoice><guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice>">
   <!ENTITY file-export-certificates "<menuchoice><guimenu>File</guimenu><guimenuitem>Export Certificates...</guimenuitem></menuchoice>">
   <!ENTITY file-export-secret-key "<menuchoice><guimenu>File</guimenu><guimenuitem>Export Secret key...</guimenuitem></menuchoice>">
   <!ENTITY file-import-certificates "<menuchoice><guimenu>File</guimenu><guimenuitem>Import Certificates...</guimenuitem></menuchoice>">
   <!ENTITY file-import-crls "<menuchoice><guimenu>File</guimenu><guimenuitem>Import CRLs...</guimenuitem></menuchoice>">
-  <!ENTITY file-quit "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>Q</keycap></keycombo></shortcut><guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice>">
+  <!ENTITY file-quit "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo></shortcut><guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice>">
 
-  <!-- VIEW menu -->
-  <!ENTITY view-redisplay "<menuchoice><shortcut><keycombo action='simul'><keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice>">
-  <!ENTITY view-stop-operation "<menuchoice><shortcut><keycombo action='simul'><keycap>Esc</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice>">
+   VIEW menu
+  <!ENTITY view-redisplay "<menuchoice><shortcut><keycombo action="simul"><keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice>">
+  <!ENTITY view-stop-operation "<menuchoice><shortcut><keycombo action="simul"><keycap>Esc</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice>">
   <!ENTITY view-certificate-details "<menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice>">
   <!ENTITY view-hierarchical-key-list "<menuchoice><guimenu>View</guimenu><guimenuitem>Hierarchical Key List</guimenuitem></menuchoice>">
-  <!ENTITY view-expand-all "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>.</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice>">
-  <!ENTITY view-collapse-all "<menuchoice><shortcut><keycombo action='simul'>&Ctrl;<keycap>,</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice>">
+  <!ENTITY view-expand-all "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>.</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice>">
+  <!ENTITY view-collapse-all "<menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>,</keycap></keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice>">
 
-  <!-- CERTIFICATES menu -->
- <!ENTITY certificates-validate "<menuchoice><shortcut><keycombo action='simul'>&Shift;<keycap>F5</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice>">
+   CERTIFICATES menu 
+ <!ENTITY certificates-validate "<menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice>">
   <!ENTITY certificates-refresh-crls "<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice>">
-  <!ENTITY certificates-delete "<menuchoice><shortcut><keycombo action='simul'><keycap>Delete</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice>">
+  <!ENTITY certificates-delete "<menuchoice><shortcut><keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut><guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice>">
   <!ENTITY certificates-download "<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice>">
 
-  <!-- CRLS menu -->
+   CRLS menu
   <!ENTITY crls-clear-crl-cache "<menuchoice><guimenu>CRLs</guimenu><guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice>">
   <!ENTITY crls-dump-crl-cache "<menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice>">
 
-  <!-- TOOLS menu -->
+   TOOLS menu 
   <!ENTITY tools-gnupg-log-viewer "<menuchoice><guimenu>Tools</guimenu><guimenuitem>GnuPG Log Viewer...</guimenuitem></menuchoice>">
 
-  <!-- SETTINGS menu -->
+   SETTINGS menu 
   <!ENTITY settings-show-statusbar "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Show Statusbar</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-shortcuts "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure Shortcuts...</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-kleopatra "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice>">
   <!ENTITY settings-configure-gpgme-backend "<menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice>">
+   -->
 
   <!-- Command line options -->
   <!ENTITY commandline-option-external "<option>--external</option>">
@@ -76,10 +79,9 @@
 
 <othercredit role="developer">
 <firstname>Steffen</firstname>
-<othername></othername>
 <surname>Hansen</surname>
 <affiliation>
-<address><email>steffen@klaralvdalens-datakonsult.se</email></address>
+<address>&Steffen.Hansen.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -94,7 +96,7 @@
 <firstname>Jesper</firstname>
 <surname>Pedersen</surname>
 <affiliation>
-<address><email>blackie@kde.org</email></address>
+<address>&Jesper.Pedersen.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -102,7 +104,7 @@
 <firstname>Daniel</firstname>
 <surname>Molkentin</surname>
 <affiliation>
-<address><email>molkentin@kde.org</email></address>
+<address>&Daniel.Molkentin.mail;</address>
 </affiliation>
 <contrib>Developer</contrib>
 </othercredit>
@@ -139,7 +141,7 @@
 the &gpgsm; keybox and for retrieving certificates from
 <acronym>LDAP</acronym> servers.</para>
 
-<para>&kleopatra; can be started from KMail's <guimenu>Tools</guimenu>
+<para>&kleopatra; can be started from &kmail;'s <guimenu>Tools</guimenu>
 menu, as well as from the command line. The &kleopatra; executable is
 named <userinput><command>kleopatra</command></userinput>.</para>
 
@@ -166,12 +168,12 @@
 
 <para>The main window is divided into the large key listing area, the
 menubar and the <link linkend="functions-search">search bar</link> on
-top, and a statusbar at the bottom.</para>
+top, and a status bar at the bottom.</para>
 
 <para>Each line in the key list corresponds to one certificate,
 identified by the so-called <guilabel>Subject &dn;</guilabel>. &dn; is
 an acronym for <quote>Distinguished Name</quote>, a hierarchical
-identifier, much like a filesystem path with an unusual syntax, that is
+identifier, much like a file system path with an unusual syntax, that is
 supposed to globally uniquely identify a given certificate.</para>
 
 <para>To be valid, and thus usable, (public) keys need to be signed by
@@ -180,7 +182,7 @@
 <quote>(public) key</quote> are used interchangeably, and we will not
 distinguish between them in this manual either, except when explicitly
 noted. The name of the &ca; which issued the certificate (its &dn;)
-is shown in the <guilabel>Issuer DN</guilabel> column.</para>
+is shown in the <guilabel>Issuer &dn;</guilabel> column.</para>
 
 <para>&ca;s must in turn be signed by other &ca;s to be valid. Of
 course, this must end somewhere, so the top-level &ca; (root-&ca;)
@@ -193,24 +195,33 @@
 
 <para>To see which of the certificates are root certificates, you can
 either compare <guilabel>Subject &dn;</guilabel> and <guilabel>Issuer
-&dn;</guilabel>, or you switch to hierarchical keylist mode with <xref
-linkend="view-hierarchical-key-list"/>.</para>
+&dn;</guilabel>, or you switch to hierarchical keylist mode with <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link>.</para>
 
 <para>You can see the details of any certificate by double-clicking it
-or using <xref linkend="view-certificate-details"/>. This opens a
+or using <link linkend="view-certificate-details"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Certificate Details...</guimenuitem></menuchoice></link>. This opens a
 dialog that shows the most common properties of the certificate, its
 certificate chain (&ie; the chain of issuers up to the root-&ca;), and
 a dump of all information the backend is able to extract from the
 certificate.</para>
 
 <para>If you change the keybox without using &kleopatra; (&eg; using
-&gpgsm;'s command line interface), you can refresh the view with <xref
-linkend="view-redisplay"/>.</para>
+&gpgsm;'s command line interface), you can refresh the view with <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>.</para>
 
 <para>Since validating a key may take some time (&eg; CRLs might need
 to be fetched), the normal keylisting does not attempt to check the
-validity of keys. For this, <xref linkend="certificates-validate"/>, a
-special variant of <xref linkend="view-redisplay"/>, is provided. It
+validity of keys. For this, <link linkend="certificates-validate">
+<menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo>
+</shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></link>, a
+special variant of <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>, is provided. It
 either checks the selected certificates, or all keys if none are
 selected.</para>
 
@@ -234,8 +245,10 @@
 you want the certificate for) into the line edit, and click on the
 <guilabel>Find</guilabel> icon. The results will be displayed in the
 key list below the search bar, where you can select certificates to
-either look at them with <xref linkend="view-certificate-details"/> or
-download them with <xref linkend="certificates-download"/> into the
+either look at them with <link linkend="view-certificate-details">
+<menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice></link> or
+download them with <link linkend="certificates-download">
+<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice></link> into the
 local keybox. Note that you can also download the certificate from the
 details dialog, using the <guilabel>Import to Local</guilabel>
 button.</para>
@@ -245,8 +258,9 @@
 Services</guilabel></link> page of &kleopatra;'s <link
 linkend="configuration">configure dialog</link>.</para>
 
-<para>If you received the certificate as a file, try <xref
-linkend="file-import-certificates"/>. &gpgsm; needs to understand the
+<para>If you received the certificate as a file, try <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>. &gpgsm; needs to understand the
 format of the certificate file; please refer to &gpgsm;'s manual for a
 list of supported file formats.</para>
 
@@ -257,19 +271,22 @@
 linkend="commandline-option-import-certificate"><userinput><command>kleopatra
 &commandline-option-import-certificate;
 <filename>filename</filename></command></userinput></link> or from
-within &kleopatra; with <xref linkend="file-import-certificates"/>,
+within &kleopatra; with <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>,
 just as you would to for <quote>normal</quote> certificates.</para>
 
 </sect1>
 
 <sect1 id="functions-newkey"><title>Creating New Key Pairs</title>
 
-<para>The menu item <xref linkend="file-new-key-pair"/> starts the
+<para>The menu item <link linkend="file-new-key-pair"><menuchoice>
+<guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice></link> starts the
 certificate-request-creating wizard which will guide you through a
 number of steps to create a certificate request; this request can, on the 
-last page of the wizard, either be sent to a certificate authority (CA)
+last page of the wizard, either be sent to a certificate authority (&ca;)
 to be signed or saved to a file (for example to a floppy, so it can be
-shipped to the CA).</para> <para>Whenever you are done with a step in
+shipped to the &ca;).</para> <para>Whenever you are done with a step in
 the wizard, press <guibutton>Next</guibutton> to go to the next step
 (or <guibutton>Back</guibutton> to review steps that are already
 completed). The certificate request creation can be canceled at any
@@ -304,7 +321,7 @@
 </itemizedlist>
 </para><para>
 The next step in the wizard is to select whether to store the
-certificate in a file or send it directly to a CA. You will have to
+certificate in a file or send it directly to a &ca;. You will have to
 specify the filename or email address to send the certificate request to.
 </para></sect1>
 
@@ -319,10 +336,15 @@
 keybox.</para>
 
 <para>These functions include deleting certificates from the local
-keybox with <xref linkend="certificates-delete"/>, as well as manual
-handling of CRLs (<xref linkend="certificates-refresh-crls"/>, <xref
-linkend="crls-clear-crl-cache"/>, <xref
-linkend="crls-dump-crl-cache"/>).</para>
+keybox with <link linkend="certificates-delete"><menuchoice><shortcut>
+<keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut>
+<guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice></link>, as well 
+as manual handling of CRLs (<link linkend="certificates-refresh-crls">
+<menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem>
+</menuchoice></link>, <link linkend="crls-clear-crl-cache"><menuchoice><guimenu>CRLs</guimenu>
+<guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice></link>, <link
+linkend="crls-dump-crl-cache"><menuchoice><guimenu>CRLs</guimenu>
+<guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice></link>).</para>
 
 </sect1>
 
@@ -335,12 +357,12 @@
 <variablelist>
 
 <varlistentry id="file-new-key-pair">
-<term>&file-new-key-pair;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>New Key Pair...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Creates a new key pair (public and private)</action> and
 allows to send the public part to a certification authority
-(<acronym>CA</acronym>) for signing. The resulting certificate is then
+(&ca;) for signing. The resulting certificate is then
 sent back to you, or stored in an LDAP server for you to download into
 your local keybox, where you can use it to sign and decrypt
 mails.</para>
@@ -349,20 +371,21 @@
 generation</quote>, since all keys are created locally. &kleopatra;
 (and &gpgsm;) do not support <quote>centralized key generation</quote>
 directly, but you can import the public/secret key bundle that you
-receive from the CA in PKCS#12 format via
-&file-import-certificates;.</para>
+receive from the &ca; in PKCS#12 format via <menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice>.</para>
 </listitem>
 </varlistentry>
 
 
 <varlistentry id="file-export-certificates">
-<term>&file-export-certificates;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Export Certificates...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Exports the selected certificates</action> into a file.</para>
 
 <note><para>This exports only the public keys, even if the
-secret key is available. Use &file-export-secret-key; to export both
+secret key is available. Use <menuchoice><guimenu>File</guimenu><guimenuitem>Export 
+Secret key...</guimenuitem></menuchoice> to export both
 public and secret keys into a file, but note that this is almost
 always a bad idea.</para></note>
 </listitem>
@@ -370,7 +393,7 @@
 
 
 <varlistentry id="file-export-secret-key">
-<term>&file-export-secret-key;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Export Secret key...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Exports both the public and the secret key to a
@@ -386,7 +409,7 @@
 
 
 <varlistentry id="file-import-certificates">
-<term>&file-import-certificates;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Import Certificates...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Imports certificates and/or secret keys from files into
@@ -400,7 +423,7 @@
 
 
 <varlistentry id="file-import-crls">
-<term>&file-import-crls;</term>
+<term><menuchoice><guimenu>File</guimenu><guimenuitem>Import CRLs...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Lets you manually import CRLs from
@@ -417,7 +440,8 @@
 <application>dirmngr</application>.</para></note>
 
 <para>You can view the contents of the local CRL cache from the menu
-item &crls-dump-crl-cache;. This will display a dialog with
+item <menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem>
+</menuchoice>. This will display a dialog with
 information about the CRLs in the cache and the fingerprints of the
 certificates in each CRL.
 </para>
@@ -426,7 +450,8 @@
 
 
 <varlistentry id="file-quit">
-<term>&file-quit;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>Q</keycap></keycombo></shortcut>
+<guimenu>File</guimenu><guimenuitem>Quit</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Terminates &kleopatra;.</action></para>
@@ -444,7 +469,8 @@
 <variablelist>
 
 <varlistentry id="view-redisplay">
-<term>&view-redisplay;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>F5</keycap></keycombo>
+</shortcut><guimenu>View</guimenu><guimenuitem>Redisplay</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Redisplays the selected certificates or refreshes the
@@ -468,7 +494,8 @@
 
 
 <varlistentry id="view-stop-operation">
-<term>&view-stop-operation;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>Esc</keycap></keycombo></shortcut>
+<guimenu>View</guimenu><guimenuitem>Stop Operation</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Stops (cancels) all pending operations,</action> &eg; a
@@ -483,7 +510,7 @@
 
 
 <varlistentry id="view-certificate-details">
-<term>&view-certificate-details;</term>
+<term><menuchoice><guimenu>View</guimenu><guimenuitem>Certificate Details...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Shows the details of the currently selected
@@ -498,7 +525,7 @@
 
 
 <varlistentry id="view-hierarchical-key-list">
-<term>&view-hierarchical-key-list;</term>
+<term><menuchoice><guimenu>View</guimenu><guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action> Toggles between hierarchical and flat keylist mode.
@@ -519,11 +546,13 @@
 
 
 <varlistentry id="view-expand-all">
-<term>&view-expand-all;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>.</keycap>
+</keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Expand All</guimenuitem></menuchoice></term>
 
 <listitem>
-<para>(This function is only available when <xref
-linkend="view-hierarchical-key-list"/> is on.)</para>
+<para>(This function is only available when <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> is on.)</para>
 
 <para><action>Expands all list items in the certificate list
 view,</action> &ie; makes all items visible.</para>
@@ -539,11 +568,13 @@
 
 
 <varlistentry id="view-collapse-all">
-<term>&view-collapse-all;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Ctrl;<keycap>,</keycap>
+</keycombo></shortcut><guimenu>View</guimenu><guimenuitem>Collapse All</guimenuitem></menuchoice></term>
 
 <listitem>
-<para>(This function is only available when <xref
-linkend="view-hierarchical-key-list"/> is on.)</para>
+<para>(This function is only available when <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> is on.)</para>
 
 <para><action>Collapses all list items in the certificate list
 view,</action> &ie; hides all but the top-level items.</para>
@@ -562,12 +593,16 @@
 <variablelist>
 
 <varlistentry id="certificates-validate">
-<term>&certificates-validate;</term>
+<term><menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo>
+</shortcut><guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Validates selected (or all) keys.</action></para>
 
-<para>This is similar to <xref linkend="view-redisplay"/>, but
+<para>This is similar to <link
+linkend="view-redisplay"><menuchoice><shortcut><keycombo action="simul">
+<keycap>F5</keycap></keycombo></shortcut><guimenu>View</guimenu>
+<guimenuitem>Redisplay</guimenuitem></menuchoice></link>, but
 performs a validation of the (selected) keys. Validation here means
 that all relevant CRLs are fetched, and the certificate chain is
 checked for correctness. As a result, invalid or expired keys will be
@@ -588,7 +623,7 @@
 
 
 <varlistentry id="certificates-refresh-crls">
-<term>&certificates-refresh-crls;</term>
+<term><menuchoice><guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Fetches the current CRLs for all selected keys,</action>
@@ -616,7 +651,8 @@
 
 
 <varlistentry id="certificates-delete">
-<term>&certificates-delete;</term>
+<term><menuchoice><shortcut><keycombo action="simul"><keycap>Delete</keycap></keycombo></shortcut>
+<guimenu>Certificates</guimenu><guimenuitem>Delete</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Deletes selected certificate(s)</action> from the local keyring.</para>
@@ -626,8 +662,9 @@
 emails, verifying an email might result in the key just removed to pop
 back into the local keybox. So it is probably best to avoid using this
 function as much as possible. When you are lost, use the <link
-linkend="functions-search">search bar</link> or the <xref
-linkend="view-hierarchical-key-list"/> function to regain control over
+linkend="functions-search">search bar</link> or the <link
+linkend="view-hierarchical-key-list"><menuchoice><guimenu>View</guimenu>
+<guimenuitem>Hierarchical Key List</guimenuitem></menuchoice></link> function to regain control over
 the lot of certificates.</para>
 </listitem>
 </varlistentry>
@@ -635,7 +672,7 @@
 
 
 <varlistentry id="certificates-download">
-<term>&certificates-download;</term>
+<term><menuchoice><guimenu>Certificates</guimenu><guimenuitem>Download</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Downloads the selected certificate(s) from the LDAP to the local keybox.</action></para>
@@ -653,19 +690,19 @@
 <variablelist>
 
 <varlistentry id="crls-clear-crl-cache">
-<term>&crls-clear-crl-cache;</term>
+<term><menuchoice><guimenu>CRLs</guimenu><guimenuitem>Clear CRL Cache...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Clears the &gpgsm; CRL cache.</action></para>
 
 <para>You probably never need this. You can force a refresh of the CRL
-cache by selecting all certificates and using <xref
-linkend="certificates-refresh-crls"/> instead.</para>
+cache by selecting all certificates and using <link linkend="certificates-refresh-crls"><menuchoice>
+<guimenu>Certificates</guimenu><guimenuitem>Refresh CRLs</guimenuitem></menuchoice></link> instead.</para>
 </listitem>
 </varlistentry>
 
 <varlistentry id="crls-dump-crl-cache">
-<term>&crls-dump-crl-cache;</term>
+<term><menuchoice><guimenu>CRLs</guimenu><guimenuitem>Dump CRL Cache...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Shows the detailed contents of the &gpgsm; CRL
@@ -682,7 +719,7 @@
 <variablelist>
 
 <varlistentry id="tools-gnupg-log-viewer">
-<term>&tools-gnupg-log-viewer;</term>
+<term><menuchoice><guimenu>Tools</guimenu><guimenuitem>GnuPG Log Viewer...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Starts <ulink url="help:/kwatchgnupg/index.html">&kwatchgnupg;</ulink></action></para>
@@ -698,7 +735,7 @@
 <variablelist>
 
 <varlistentry id="settings-show-statusbar">
-<term>&settings-show-statusbar;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Show Statusbar</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Toggles the visibility of the bottom status bar.</action></para>
@@ -706,7 +743,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-shortcuts">
-<term>&settings-configure-shortcuts;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure Shortcuts...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens the standard &kde; shortcut configuration dialog,
@@ -716,7 +753,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-kleopatra">
-<term>&settings-configure-kleopatra;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens &kleopatra;'s configure dialog.</action></para>
@@ -726,7 +763,7 @@
 </varlistentry>
 
 <varlistentry id="settings-configure-gpgme-backend">
-<term>&settings-configure-gpgme-backend;</term>
+<term><menuchoice><guimenu>Settings</guimenu><guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice></term>
 
 <listitem>
 <para><action>Opens a dialog that allows you to configure every aspect of
@@ -789,8 +826,9 @@
 <para><action>Specifies a file or URL from which to import
 certificates (or secret keys) from.</action></para>
 
-<para>This is the command line equivalent of <xref
-linkend="file-import-certificates"/>.</para>
+<para>This is the command line equivalent of <link
+linkend="file-import-certificates"><menuchoice><guimenu>File</guimenu>
+<guimenuitem>Import Certificates...</guimenuitem></menuchoice></link>.</para>
 </listitem>
 </varlistentry>
 
@@ -800,8 +838,9 @@
 
 <chapter id="configuration"><title>Configuring &kleopatra;</title>
 
-<para>&kleopatra;'s configure dialog can be accessed via <xref
-linkend="settings-configure-kleopatra"/>.</para>
+<para>&kleopatra;'s configure dialog can be accessed via <link
+linkend="settings-configure-kleopatra"><menuchoice><guimenu>Settings</guimenu>
+<guimenuitem>Configure &kleopatra;...</guimenuitem></menuchoice></link>.</para>
 
 <para>Each of its pages is described in the sections below.</para>
 
@@ -810,13 +849,14 @@
 <para>On this page, you can configure which LDAP servers to use for
 certificate searches. You can also configure their order, as well as
 some selected LDAP-related settings from the dynamic backend
-configuration dialog, available via <xref
-linkend="settings-configure-gpgme-backend"/>.</para>
+configuration dialog, available via <link
+linkend="settings-configure-gpgme-backend"><menuchoice><guimenu>Settings</guimenu>
+<guimenuitem>Configure GpgME Backend...</guimenuitem></menuchoice></link>.</para>
 
 <para>To add a new server, click on the <guilabel>Add
 Service...</guilabel> button. In the dialog that appears, you can set
 the <guilabel>Server name</guilabel>, the <guilabel>Port</guilabel>
-(preset to the default LDAP port), the <guilabel>Base DN</guilabel>
+(preset to the default LDAP port), the <guilabel>Base &dn;</guilabel>
 (sometimes referred to as the search root or search base), and the
 usual <guilabel>User name</guilabel> and
 <guilabel>Password</guilabel>, both of which are only needed if the
@@ -898,7 +938,7 @@
 
 </sect1>
 
-<sect1 id="configuration-dn-order"><title>Configuring the Order DN Attributes are Shown</title>
+<sect1 id="configuration-dn-order"><title>Configuring the Order &dn; Attributes are Shown</title>
 
 <para>Although &dn;s are hierarchical, the order of the individual
 components (called relative &dn;s (RDNs), or &dn; attributes) is not
@@ -908,7 +948,7 @@
 
 <note><para>This setting does not only apply to &kleopatra;, but to all
 applications using &kleopatra; Technology. At the time of this
-writing, these include KMail, KAddressBook, as well as &kleopatra;
+writing, these include &kmail;, &kaddressbook;, as well as &kleopatra;
 itself, of course.</para></note>
 
 <para>This configuration page basically consists of two lists, one for
@@ -984,11 +1024,11 @@
 <chapter id="admin"><title>Administrator's Guide</title>
 
 <para>This Administrator's Guide describes ways to customize &kleopatra; that
-are not accessible via the GUI, but only via config files.</para>
+are not accessible via the &GUI;, but only via config files.</para>
 
 <para>It is assumed that the reader is familiar with the technology
 used for &kde; application configuration, including layout,
-filesystem location and cascading of &kde; config files, as well as
+file system location and cascading of &kde; config files, as well as
 the KIOSK framework.</para>
 
 <sect1 id="admin-certificate-request-wizard"><title>Customization of the Certificate-Creation Wizard</title>
@@ -1200,7 +1240,7 @@
 	      <entry>boolean</entry>
 	      <entry>
 		the key has been disabled (marked for not using) by
-		the user. Ignored for S/MIME keys.
+		the user. Ignored for &smime; keys.
 	      </entry>
 	    </row>
 	    <row>
@@ -1253,15 +1293,16 @@
 	      <entry>boolean</entry>
 	      <entry>
 		the key is an OpenPGP key (<literal>true</literal>),
-		or an S/MIME key (<literal>false</literal>).
+		or an &smime; key (<literal>false</literal>).
 	      </entry>
 	    </row>
 	    <row>
 	      <entry><varname>was-validated</varname></entry>
 	      <entry>boolean</entry>
 	      <entry>
-		the key has been validated (see <xref
-		linkend="certificates-validate"/>).
+		the key has been validated (see <link
+		linkend="certificates-validate"><menuchoice><shortcut><keycombo action="simul">&Shift;<keycap>F5</keycap></keycombo></shortcut>
+		<guimenu>Certificates</guimenu><guimenuitem>Validate</guimenuitem></menuchoice></link>).
 	      </entry>
 	    </row>
 	    <row>
@@ -1368,36 +1409,37 @@
 <chapter id="credits-and-license">
 <title>Credits and License</title>
 
-<para>&kleopatra; copyright 2002 Steffen Hansen, Matthias Kalle Dalheimer
-and Jesper Pedersen., copyright 2004 Daniel Molkentin, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
+<para>&kleopatra; copyright 2002 &Steffen.Hansen;, &Matthias.Kalle.Dalheimer;
+and &Jesper.Pedersen;., copyright 2004 &Daniel.Molkentin;, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
 
-<para>Documentation copyright 2002 Steffen Hansen, copyright 2004
-Daniel Molkentin, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
+<para>Documentation copyright 2002 &Steffen.Hansen;, copyright 2004
+&Daniel.Molkentin;, copyright 2004 Klar&auml;lvdalens Datakonsult AB</para>
 
 <itemizedlist>
 <title>Contributors</title>
 <listitem>
-<para>Marc Mutz <email>mutz@kde.org</email></para>
+<para>&Marc.Mutz; &Marc.Mutz.mail;</para>
 </listitem>
 <listitem>
-<para>David Faure <email>faure@kde.org</email></para>
+<para>&David.Faure; &David.Faure.mail;</para>
 </listitem>
 <listitem>
-<para>Steffen Hansen <email>hansen@kde.org</email></para>
+<para>&Steffen.Hansen; <email>hansen@kde.org</email></para>
 </listitem>
 <listitem>
-<para>Matthias Kalle Dalheimer <email>kalle@kde.org</email></para>
+<para>&Matthias.Kalle.Dalheimer; &Matthias.Kalle.Dalheimer.mail;</para>
 </listitem>
 <listitem>
-<para>Jesper Pedersen <email>blackie@kde.org</email></para>
+<para>&Jesper.Pedersen; &Jesper.Pedersen.mail;</para>
 </listitem>
 <listitem>
-<para>Daniel Molkentin <email>molkentin@kde.org</email></para>
+<para>&Daniel.Molkentin; &Daniel.Molkentin.mail;</para>
 </listitem>
 </itemizedlist>
 
+<!-- TRANS:CREDIT_FOR_TRANSLATORS -->
+&underFDL;
 &underGPL;
-&underFDL;
 </chapter>
 
 &documentation.index; 
Index: doc/kalarm/mainwindow.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: doc/kalarm/editwindow.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: doc/kalarm/index.docbook
===================================================================
--- doc/kalarm/index.docbook	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ doc/kalarm/index.docbook	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,5 +1,5 @@
 <?xml version="1.0" ?>
-<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.1.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
+<!DOCTYPE book PUBLIC "-//KDE//DTD DocBook XML V4.2-Based Variant V1.1//EN" "dtd/kdex.dtd" [
   <!ENTITY kappname "&kalarm;">
   <!ENTITY package "kdepim">
   <!ENTITY % addindex "IGNORE">
@@ -16,7 +16,6 @@
 <authorgroup>
 <author>
 <firstname>David</firstname>
-<othername></othername>
 <surname>Jarvie</surname>
 <affiliation>
 <address><email>software@astrojar.org.uk</email></address>
@@ -42,8 +41,8 @@
 
 <!-- Don't change format of date and version of the documentation -->
 
-<date>2006-04-09</date>
-<releaseinfo>1.04.03</releaseinfo>
+<date>2006-10-21</date>
+<releaseinfo>1.04.06</releaseinfo>
 
 <abstract>
 <para>&kalarm; is a personal alarm message, command and email scheduler for &kde;.</para>
@@ -617,7 +616,7 @@
 <guimenuitem>Import Alarms...</guimenuitem></menuchoice>. The
 import function scans the selected calendar file for events containing
 alarms, and copies them (with new unique IDs) into &kalarm;'s calendar.
-Events without alarms, and other types of calendar entry, are
+Events without alarms, and calendar entries other than events, are
 ignored.</para>
 
 <warning><para>If you import alarms from calendar files which were
@@ -734,17 +733,15 @@
 
 <itemizedlist>
 <listitem>
-<para>The <guilabel>Confirm acknowledgment</guilabel> checkbox lets
-you specify whether you will be prompted for confirmation when you
-close the alarm message window. This may be used as a safeguard
-against accidental acknowledgment of alarms.</para>
-</listitem>
+<para>The <guilabel>Sound</guilabel> option allows you to select
+whether an audible alarm should sound when the alarm message is
+displayed. Choose:</para>
 
+<itemizedlist>
 <listitem>
-<para>Check <guilabel>Sound</guilabel> if you want an audible alarm
-to sound when the alarm message is displayed. Choose:</para>
+<para><guilabel>None</guilabel> to display the alarm silently.</para>
+</listitem>
 
-<itemizedlist>
 <listitem>
 <para><guilabel>Beep</guilabel> to sound a beep.</para>
 </listitem>
@@ -758,11 +755,11 @@
 </listitem>
 
 <listitem>
-<para><guilabel>File</guilabel> to play an audio file. Use the button
-on the right to display the Sound File dialog which lets you select a
-file to play and set volume and repetition options. If you hover the
-mouse over the button, a tooltip will display the audio file currently
-selected.</para>
+<para><guilabel>Sound file</guilabel> to play an audio file. Use the
+button on the right to display the Sound File dialog which lets you
+select a file to play and set volume and repetition options. If you
+hover the mouse over the button, a tooltip will display the audio file
+currently selected.</para>
 
 <note><para>&kalarm; uses the &arts; sound server for repetition and
 volume control. If &kalarm; has been built without &arts; support,
@@ -817,25 +814,6 @@
 </listitem>
 
 <listitem>
-<para>Check <guilabel>Reminder</guilabel> if you want to display a
-reminder in advance of the main alarm and of each of its recurrences
-(if any). Enter how long in advance using the edit controls beside
-the checkbox.</para>
-
-<note><para>You can only display a reminder before each repetition of
-an alarm if the repetitions are set up using the
-<guilabel>Recurrence</guilabel> tab. If the
-<guibutton>Simple Repetition</guibutton> button is used instead, a
-reminder will be displayed before the first occurrence
-only.</para></note>
-
-<para>If the alarm recurs, check <guilabel>Reminder for first
-recurrence only</guilabel> if you only want a reminder before the
-alarm's first recurrence. If this is not checked, the reminder period
-is limited to being less than the recurrence interval.</para>
-</listitem>
-
-<listitem>
 <para>Select the background color for the alarm message window.
 (The color selection list can be configured in the
 <link linkend="preferences-fontcolour">Preferences dialog</link>.)</para>
@@ -1029,6 +1007,28 @@
 </sect2>
 
 <sect2>
+<title>Reminder</title>
+
+<para>For a display alarm, check <guilabel>Reminder</guilabel> if you
+want to display a reminder in advance of the main alarm and of each of
+its recurrences (if any). Enter how long in advance using the edit
+controls beside the checkbox.</para>
+
+<note><para>You can only display a reminder before each repetition of
+an alarm if the repetitions are set up using the
+<guilabel>Recurrence</guilabel> tab. If the
+<guibutton>Simple Repetition</guibutton> button is used instead, a
+reminder will be displayed before the first occurrence
+only.</para></note>
+
+<para>If the alarm recurs, check <guilabel>Reminder for first
+recurrence only</guilabel> if you only want a reminder before the
+alarm's first recurrence. If this is not checked, the reminder period
+is limited to being less than the recurrence interval.</para>
+
+</sect2>
+
+<sect2>
 <title>Cancelation</title>
 
 <para>The late-cancelation options determine how an alarm is treated
@@ -1236,6 +1236,12 @@
 <sect2>
 <title>Other controls</title>
 
+<para>For display alarms, the
+<guilabel>Confirm acknowledgment</guilabel> checkbox lets you specify
+whether you will be prompted for confirmation when you close the alarm
+message window. This may be used as a safeguard against accidental
+acknowledgment of alarms.</para>
+
 <para>Select <guilabel>Show in &korganizer;</guilabel> to add the
 alarm to &korganizer;'s active calendar, where it will appear as an
 event without an alarm. This option allows you to track alarms in
@@ -1701,22 +1707,6 @@
 &kalarm;'s overall behavior:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
-This starts alarm monitoring at KDE session login, by starting the
-<application>alarm daemon</application>. Note that in order for alarms
-to be activated, you also need to select appropriate options in the
-<guilabel>Run Mode</guilabel> group box.</para>
-
-<warning><para>This option should always be checked unless you intend
-to discontinue use of &kalarm;.</para></warning>
-
-<note><para>This option is automatically reselected whenever &kalarm;
-is run. So if you have unchecked this option and want to continue to
-prevent the <application>alarm daemon</application> from running at
-login, you need to uncheck this option again each time you run
-&kalarm;.</para></note>
-</listitem>
-
 <listitem><para><guilabel>Run Mode</guilabel> group box: These options
 control &kalarm;'s system tray icon, and also allow some control over
 &kalarm;'s use of system resources by specifying whether or not to run
@@ -1730,6 +1720,13 @@
 monitors the alarm list and triggers alarms.</para>
 
 <itemizedlist>
+<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
+is run only when an alarm is triggered, if you run it manually, or
+while its system tray icon is displayed. In this mode the system tray
+icon can still be displayed, but closing the system tray icon has no
+effect on any &kalarm; windows.</para>
+</listitem>
+
 <listitem><para><guilabel>Run continuously in system tray</guilabel>:
 &kalarm; runs continuously and the system tray icon is always
 displayed while it is running. In this mode, closing the system tray
@@ -1738,10 +1735,6 @@
 are:</para>
 
 <itemizedlist>
-<listitem><para><guilabel>Autostart at login</guilabel>: This starts
-&kalarm; at &kde; session login, ensuring that &kalarm; runs at all
-times unless you manually quit.</para>
-</listitem>
 <listitem><para><guilabel>Disable alarms while not running</guilabel>:
 Selecting this option has the effect that alarms will be disabled
 whenever &kalarm;'s system tray icon is not visible.</para>
@@ -1759,22 +1752,37 @@
 </listitem>
 </itemizedlist>
 
+<!--
 <para>In this mode, if no system tray exists, &kalarm; runs
 continuously in the background and alarms are always enabled.</para>
+-->
 </listitem>
 
-<listitem><para><guilabel>Run only on demand</guilabel>: &kalarm;
-is run only when an alarm is triggered, if you run it manually, or
-while its system tray icon is displayed. In this mode the system tray
-icon can still be displayed, but closing the system tray icon has no
-effect on any &kalarm; windows.</para>
+<listitem><para><guilabel>Autostart at login</guilabel>: In continuous
+mode, this starts &kalarm; at &kde; session login, ensuring that
+&kalarm; runs at all times unless you manually quit.</para>
+</listitem>
 
-<itemizedlist>
 <listitem><para><guilabel>Autostart system tray icon at
-login</guilabel>: This displays &kalarm;'s system tray icon at login.
-&kalarm; will run until the system tray icon is closed.</para>
+login</guilabel>: In on-demand mode, this displays &kalarm;'s system
+tray icon at login. &kalarm; will run until the system tray icon is
+closed.</para>
 </listitem>
-</itemizedlist>
+
+<listitem><para><guilabel>Start alarm monitoring at login</guilabel>:
+This starts alarm monitoring at KDE session login, by starting the
+<application>alarm daemon</application>. Note that in order for alarms
+to be activated, you also need to select appropriate options in the
+<guilabel>Run Mode</guilabel> group box.</para>
+
+<warning><para>This option should always be checked unless you intend
+to discontinue use of &kalarm;.</para></warning>
+
+<note><para>This option is automatically reselected whenever &kalarm;
+is run. So if you have unchecked this option and want to continue to
+prevent the <application>alarm daemon</application> from running at
+login, you need to uncheck this option again each time you run
+&kalarm;.</para></note>
 </listitem>
 </itemizedlist>
 </listitem>
@@ -1823,17 +1831,20 @@
 options control the storage of expired alarms.</para>
 <itemizedlist>
 <listitem><para><guilabel>Keep alarms after expiry</guilabel>:
-Select this option to store expired alarms. Deselect it to keep no
-record of alarms once they have expired.</para>
+Select this option to store expired and deleted alarms. Deselect it
+to keep no record of alarms once they cease to be active. Note that
+deleted alarms are only stored if they have previously been
+triggered. If you delete an alarm before it ever triggers, it is
+discarded.</para>
 </listitem>
 
 <listitem><para><guilabel>Discard expired alarms after</guilabel>:
-Set the number of days to store expired alarms after their last
-activation.</para>
+Set the number of days to store expired and deleted alarms, after which
+they are permanently deleted.</para>
 </listitem>
 
 <listitem><para><guibutton>Clear expired alarms</guibutton>: This
-button discards all currently stored  expired alarms. This has no
+button discards all currently stored expired alarms. This has no
 effect on alarms which subsequently expire; they will continue to be
 stored according to the selected options.</para>
 </listitem>
@@ -2149,9 +2160,8 @@
 </listitem>
 
 <listitem><para>Set the default sound options. Note that a default
-sound file may be specified even if <guilabel>Sound</guilabel> is
-unchecked, or if <guilabel>Beep</guilabel> or
-<guilabel>Speak</guilabel> is checked.</para>
+sound file may be specified even if the sound type is not set to
+<guilabel>Sound file</guilabel>.</para>
 </listitem>
 </itemizedlist>
 
@@ -4030,16 +4040,16 @@
 
 <!-- TRANS:CREDIT_FOR_TRANSLATORS -->
 
+&underFDL;               <!-- FDL: do not remove -->
+
+&underGPL;        	 <!-- GPL License -->
+
 <para>Thanks go to the author of the &kde; 1 KAlarm application,
 Stefan Nikolaus <email>stefan.nikolaus@stuco.uni-oldenburg.de</email>,
 who kindly agreed to allow the name &kalarm; to be used by this
 &kde; 2 / &kde; 3 application.
 </para>
 
-&underFDL;               <!-- FDL: do not remove -->
-
-&underGPL;        	 <!-- GPL License -->
-
 </chapter>
 
 <appendix id="installation">
Index: kalarm/kamail.cpp
===================================================================
--- kalarm/kamail.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/kamail.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  kamail.cpp  -  email functions
  *  Program:  kalarm
- *  Copyright (c) 2002 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002-2005 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -168,7 +168,7 @@
 				command += KShellProcess::quote(data.bcc);
 			}
 
-			command += " ";
+			command += ' ';
 			command += event.emailAddresses(" "); // locally provided, okay
 		}
 
@@ -954,7 +954,7 @@
   QString maybeLocalPart;
   QString tmp;
 
-  while ( scursor != send ) {
+  if ( scursor != send ) {
     // first, eat any whitespace
     eatCFWS( scursor, send, isCRLF );
 
Index: kalarm/alarmevent.cpp
===================================================================
--- kalarm/alarmevent.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/alarmevent.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -379,7 +379,7 @@
 			case KAAlarm::DEFERRED_REMINDER_DATE__ALARM:
 			case KAAlarm::DEFERRED_DATE__ALARM:
 				mDeferral = (data.type == KAAlarm::DEFERRED_REMINDER_DATE__ALARM) ? REMINDER_DEFERRAL : NORMAL_DEFERRAL;
-				mDeferralTime.set(data.dateTime, false);
+				mDeferralTime.set(data.dateTime, true);
 				break;
 			case KAAlarm::DEFERRED_REMINDER_TIME__ALARM:
 			case KAAlarm::DEFERRED_TIME__ALARM:
@@ -530,7 +530,7 @@
 			if (!alarm.programArguments().isEmpty())
 			{
 				if (!data.commandScript)
-					data.cleanText += " ";
+					data.cleanText += ' ';
 				data.cleanText += alarm.programArguments();
 			}
 			break;
@@ -834,16 +834,17 @@
 	DateTime dt = mNextMainDateTime;
 	if (mRepeatCount)
 	{
-		// N.B. This is coded to avoid 32-bit integer overflow which occurs
-		//      in QDateTime::secsTo() for large enough time differences.
 		QDateTime now = QDateTime::currentDateTime();
 		if (now > mNextMainDateTime)
 		{
+			// Find the next repetition > current date/time.
+			// N.B. This is coded to avoid 32-bit integer overflow which occurs
+			//      in QDateTime::secsTo() for large enough time differences.
 			dt = mainEndRepeatTime();    // get the last repetition time
 			if (dt > now)
 			{
 				int repeatSecs = mRepeatInterval * 60;
-				int repetition = (mNextMainDateTime.secsTo(now) + repeatSecs - 1) / repeatSecs;
+				int repetition = mNextMainDateTime.secsTo(now) / repeatSecs + 1;
 				dt = mNextMainDateTime.addSecs(repetition * repeatSecs);
 			}
 		}
@@ -3147,7 +3148,7 @@
 
 		result += (*it).email();
 		if (quote)
-			result += ">";
+			result += '>';
 	}
 	return result;
 }
Index: kalarm/messagewin.cpp
===================================================================
--- kalarm/messagewin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/messagewin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1437,18 +1437,18 @@
 		if (AlarmCalendar::activeCalendar()->event(mEventID))
 		{
 			// The old alarm hasn't expired yet, so replace it
-			status = KAlarm::modifyEvent(mEvent, event, 0);
+			status = KAlarm::modifyEvent(mEvent, event, 0, &editDlg);
 			Undo::saveEdit(mEvent, event);
 		}
 		else
 		{
 			// The old event has expired, so simply create a new one
-			status = KAlarm::addEvent(event, 0);
+			status = KAlarm::addEvent(event, 0, &editDlg);
 			Undo::saveAdd(event);
 		}
 
 		if (status == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_MODIFY, 1);
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
 
 		// Close the alarm window
@@ -1524,7 +1524,7 @@
 			KAEvent event(*kcalEvent);
 			bool repeat = event.defer(dateTime, (mAlarmType & KAAlarm::REMINDER_ALARM), true);
 			event.setDeferDefaultMinutes(delayMins);
-			KAlarm::updateEvent(event, 0, true, !repeat);
+			KAlarm::updateEvent(event, 0, mDeferDlg, true, !repeat);
 		}
 		else
 		{
@@ -1546,7 +1546,7 @@
 			event.setDeferDefaultMinutes(delayMins);
 			// Add the event back into the calendar file, retaining its ID
 			// and not updating KOrganizer
-			KAlarm::addEvent(event, 0, true, false);
+			KAlarm::addEvent(event, 0, mDeferDlg, true, false);
 			if (kcalEvent)
 			{
 				event.setUid(KAEvent::EXPIRED);
Index: kalarm/undo.cpp
===================================================================
--- kalarm/undo.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/undo.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -57,7 +57,7 @@
 		virtual UndoItem* restore() = 0;
 		virtual bool      deleteID(const QString& /*id*/)  { return false; }
 
-		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_EXPIRED };
+		enum Error   { ERR_NONE, ERR_PROG, ERR_NOT_FOUND, ERR_CREATE, ERR_TEMPLATE, ERR_EXPIRED };
 		enum Warning { WARN_NONE, WARN_KORG_ADD, WARN_KORG_MODIFY, WARN_KORG_DELETE };
 		static int        mLastId;
 		static Error      mRestoreError;         // error code valid only if restore() returns 0
@@ -337,7 +337,7 @@
 	{
 		case UndoItem::ERR_NONE:
 		{
-			KAlarm::UpdateError errcode;
+			KAlarm::KOrgUpdateError errcode;
 			switch (UndoItem::mRestoreWarning)
 			{
 				case UndoItem::WARN_KORG_ADD:     errcode = KAlarm::KORG_ERR_ADD;  break;
@@ -352,6 +352,7 @@
 		}
 		case UndoItem::ERR_NOT_FOUND:  err = i18n("Alarm not found");  break;
 		case UndoItem::ERR_CREATE:     err = i18n("Error recreating alarm");  break;
+		case UndoItem::ERR_TEMPLATE:   err = i18n("Error recreating alarm template");  break;
 		case UndoItem::ERR_EXPIRED:    err = i18n("Cannot reactivate expired alarm");  break;
 		case UndoItem::ERR_PROG:       err = i18n("Program error");  break;
 		default:                       err = i18n("Unknown error");  break;
@@ -733,14 +734,24 @@
 			if (setArchive)
 				event.setArchive();
 			// Archive it if it has already triggered
-			if (KAlarm::deleteEvent(event, true) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::deleteEvent(event, true))
 			{
-				mRestoreWarning = WARN_KORG_DELETE;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_DELETE;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::deleteTemplate(event);
+			if (KAlarm::deleteTemplate(event) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // redoing the deletion of an expired alarm
 			KAlarm::deleteEvent(event);
@@ -814,14 +825,24 @@
 	switch (calendar())
 	{
 		case KAEvent::ACTIVE:
-			if (KAlarm::modifyEvent(newEvent, *mOldEvent, 0) == KAlarm::UPDATE_KORG_ERR)
+			switch (KAlarm::modifyEvent(newEvent, *mOldEvent, 0))
 			{
-				mRestoreWarning = WARN_KORG_MODIFY;
-				++mRestoreWarningCount;
+				case KAlarm::UPDATE_ERROR:
+				case KAlarm::UPDATE_FAILED:
+				case KAlarm::SAVE_FAILED:
+					mRestoreError = ERR_CREATE;
+					break;
+				case KAlarm::UPDATE_KORG_ERR:
+					mRestoreWarning = WARN_KORG_MODIFY;
+					++mRestoreWarningCount;
+					break;
+				default:
+					break;
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			KAlarm::updateTemplate(*mOldEvent, 0);
+			if (KAlarm::updateTemplate(*mOldEvent, 0) != KAlarm::UPDATE_OK)
+				mRestoreError = ERR_TEMPLATE;
 			break;
 		case KAEvent::EXPIRED:    // editing of expired events is not allowed
 		default:
@@ -890,6 +911,8 @@
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_EXPIRED;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -898,13 +921,15 @@
 			}
 			else
 			{
-				switch (KAlarm::addEvent(*mEvent, 0, true))
+				switch (KAlarm::addEvent(*mEvent, 0, 0, true))
 				{
 					case KAlarm::UPDATE_KORG_ERR:
 						mRestoreWarning = WARN_KORG_ADD;
 						++mRestoreWarningCount;
 						break;
 					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
 						mRestoreError = ERR_CREATE;
 						return 0;
 					case KAlarm::UPDATE_OK:
@@ -913,7 +938,7 @@
 			}
 			break;
 		case KAEvent::TEMPLATE:
-			if (!KAlarm::addTemplate(*mEvent, 0))
+			if (KAlarm::addTemplate(*mEvent, 0) != KAlarm::UPDATE_OK)
 			{
 				mRestoreError = ERR_CREATE;
 				return 0;
Index: kalarm/preferences.h
===================================================================
--- kalarm/preferences.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/preferences.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  preferences.h  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -60,7 +60,6 @@
 		static const QFont&      messageFont()                    { return mMessageFont; }
 		static const QTime&      startOfDay()                     { return mStartOfDay; }
 		static bool              hasStartOfDayChanged()           { return mStartOfDayChanged; }
-		static bool              autostartDaemon()                { return mAutostartDaemon; }
 		static bool              runInSystemTray()                { return mRunInSystemTray; }
 		static bool              disableAlarmsIfStopped()         { return mDisableAlarmsIfStopped; }
 		static bool              quitWarn()                       { return notifying(QUIT_WARN); }
@@ -90,7 +89,6 @@
 		static QColor            disabledColour()                 { return mDisabledColour; }
 		static QColor            expiredColour()                  { return mExpiredColour; }
 		static int               expiredKeepDays()                { return mExpiredKeepDays; }
-		static bool              defaultSound()                   { return mDefaultSound; }
 		static SoundPicker::Type defaultSoundType()               { return mDefaultSoundType; }
 		static const QString&    defaultSoundFile()               { return mDefaultSoundFile; }
 		static float             defaultSoundVolume()             { return mDefaultSoundVolume; }
@@ -123,7 +121,6 @@
 		static const QColor                     default_defaultFgColour;
 		static const QFont&                     default_messageFont()  { return mDefault_messageFont; };
 		static const QTime                      default_startOfDay;
-		static const bool                       default_autostartDaemon;
 		static const bool                       default_runInSystemTray;
 		static const bool                       default_disableAlarmsIfStopped;
 		static const bool                       default_quitWarn;
@@ -154,7 +151,6 @@
 		static const int                        default_defaultLateCancel;
 		static const bool                       default_defaultAutoClose;
 		static const bool                       default_defaultCopyToKOrganizer;
-		static const bool                       default_defaultSound;
 		static const SoundPicker::Type          default_defaultSoundType;
 		static const bool                       default_defaultSoundRepeat;
 		static const bool                       default_defaultConfirmAck;
@@ -201,7 +197,6 @@
 		static QColor              mDefaultBgColour;
 		static QFont               mMessageFont;
 		static QTime               mStartOfDay;
-		static bool                mAutostartDaemon;
 		static bool                mRunInSystemTray;
 		static bool                mDisableAlarmsIfStopped;
 		static bool                mAutostartTrayIcon;
@@ -229,7 +224,6 @@
 		static int                 mDefaultLateCancel;
 		static bool                mDefaultAutoClose;
 		static bool                mDefaultCopyToKOrganizer;
-		static bool                mDefaultSound;
 		static SoundPicker::Type   mDefaultSoundType;
 		static bool                mDefaultSoundRepeat;
 		static bool                mDefaultConfirmAck;
@@ -245,7 +239,6 @@
 		// Change tracking
 		static QTime               mOldStartOfDay;       // previous start-of-day time
 		static bool                mStartOfDayChanged;   // start-of-day check value doesn't tally with mStartOfDay
-		static bool                mOldAutostartDaemon;  // previous daemon autostart value
 };
 
 #endif // PREFERENCES_H
Index: kalarm/editdlg.cpp
===================================================================
--- kalarm/editdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/editdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -163,7 +163,7 @@
  */
 EditAlarmDlg::EditAlarmDlg(bool Template, const QString& caption, QWidget* parent, const char* name,
                            const KAEvent* event, bool readOnly)
-	: KDialogBase(parent, name, true, caption,
+	: KDialogBase(parent, (name ? name : Template ? "TemplEditDlg" : "EditDlg"), true, caption,
 	              (readOnly ? Cancel|Try : Template ? Ok|Cancel|Try : Ok|Cancel|Try|Default),
 	              (readOnly ? Cancel : Ok)),
 	  mMainPageShown(false),
@@ -225,8 +225,9 @@
 	mActionGroup = new ButtonGroup(i18n("Action"), mainPage, "actionGroup");
 	connect(mActionGroup, SIGNAL(buttonSet(int)), SLOT(slotAlarmTypeChanged(int)));
 	topLayout->addWidget(mActionGroup, 1);
-	QGridLayout* grid = new QGridLayout(mActionGroup, 3, 5, marginHint(), spacingHint());
-	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
+	QBoxLayout* layout = new QVBoxLayout(mActionGroup, marginHint(), spacingHint());
+	layout->addSpacing(fontMetrics().lineSpacing()/2);
+	QGridLayout* grid = new QGridLayout(layout, 1, 5);
 
 	// Message radio button
 	mMessageRadio = new RadioButton(i18n("Te&xt"), mActionGroup, "messageButton");
@@ -260,14 +261,11 @@
 	grid->addWidget(mEmailRadio, 1, 6);
 
 	initDisplayAlarms(mActionGroup);
+	layout->addWidget(mDisplayAlarmsFrame);
 	initCommand(mActionGroup);
+	layout->addWidget(mCommandFrame);
 	initEmail(mActionGroup);
-	mAlarmTypeStack = new QWidgetStack(mActionGroup);
-	grid->addMultiCellWidget(mAlarmTypeStack, 2, 2, 0, 6);
-	grid->setRowStretch(2, 1);
-	mAlarmTypeStack->addWidget(mDisplayAlarmsFrame, 0);
-	mAlarmTypeStack->addWidget(mCommandFrame, 1);
-	mAlarmTypeStack->addWidget(mEmailFrame, 2);
+	layout->addWidget(mEmailFrame);
 
 	// Deferred date/time: visible only for a deferred recurring event.
 	mDeferGroup = new QGroupBox(1, Qt::Vertical, i18n("Deferred Alarm"), mainPage, "deferGroup");
@@ -282,7 +280,7 @@
 	QWhatsThis::add(mDeferChangeButton, i18n("Change the alarm's deferred time, or cancel the deferral"));
 	mDeferGroup->addSpace(0);
 
-	QBoxLayout* layout = new QHBoxLayout(topLayout);
+	layout = new QHBoxLayout(topLayout);
 
 	// Date and time entry
 	if (mTemplate)
@@ -367,7 +365,6 @@
 	      i18n("How often the alarm recurs.\nThe times shown are those configured in the Recurrence tab and in the Simple Repetition dialog."));
 	box->setFixedHeight(box->sizeHint().height());
 	layout->addWidget(box);
-	layout->addStretch();
 
 	// Simple repetition button
 	mSimpleRepetition = new RepetitionButton(i18n("Simple Repetition"), true, mainPage);
@@ -390,13 +387,21 @@
 	mLateCancel = new LateCancelSelector(true, mainPage);
 	topLayout->addWidget(mLateCancel, 0, Qt::AlignAuto);
 
+	// Acknowledgement confirmation required - default = no confirmation
+	layout = new QHBoxLayout(topLayout, 0);
+	mConfirmAck = createConfirmAckCheckbox(mainPage);
+	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
+	layout->addWidget(mConfirmAck);
+	layout->addSpacing(2*spacingHint());
+	layout->addStretch();
+
 	if (theApp()->korganizerEnabled())
 	{
 		// Show in KOrganizer checkbox
 		mShowInKorganizer = new CheckBox(i18n_ShowInKOrganizer(), mainPage);
 		mShowInKorganizer->setFixedSize(mShowInKorganizer->sizeHint());
 		QWhatsThis::add(mShowInKorganizer, i18n("Check to copy the alarm into KOrganizer's calendar"));
-		topLayout->addWidget(mShowInKorganizer);
+		layout->addWidget(mShowInKorganizer);
 	}
 
 	setButtonWhatsThis(Ok, i18n("Schedule the alarm at the specified time."));
@@ -458,7 +463,7 @@
 	mBgColourChoose->setFixedSize(mBgColourChoose->sizeHint());
 	connect(mBgColourChoose, SIGNAL(highlighted(const QColor&)), SLOT(slotBgColourSelected(const QColor&)));
 	layout->addWidget(box);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	// Font and colour choice drop-down list
@@ -468,16 +473,11 @@
 	layout->addWidget(mFontColourButton);
 
 	// Sound checkbox and file selector
+	layout = new QHBoxLayout(frameLayout);
 	mSoundPicker = new SoundPicker(mDisplayAlarmsFrame);
 	mSoundPicker->setFixedSize(mSoundPicker->sizeHint());
-	frameLayout->addWidget(mSoundPicker, 0, Qt::AlignAuto);
-
-	// Acknowledgement confirmation required - default = no confirmation
-	layout = new QHBoxLayout(frameLayout);
-	mConfirmAck = createConfirmAckCheckbox(mDisplayAlarmsFrame);
-	mConfirmAck->setFixedSize(mConfirmAck->sizeHint());
-	layout->addWidget(mConfirmAck);
-	layout->addSpacing(2*KDialog::spacingHint());
+	layout->addWidget(mSoundPicker);
+	layout->addSpacing(2*spacingHint());
 	layout->addStretch();
 
 	if (ShellProcess::authorised())    // don't display if shell commands not allowed (e.g. kiosk mode)
@@ -789,11 +789,12 @@
 		mSimpleRepetition->set(event->repeatInterval(), event->repeatCount());
 		mRecurrenceText->setText(recurText(*event));
 		mRecurrenceEdit->set(*event);   // must be called after mTimeWidget is set up, to ensure correct date-only enabling
-		SoundPicker::Type soundType = event->speak()                                ? SoundPicker::SPEAK
-		                            : event->beep() || event->audioFile().isEmpty() ? SoundPicker::BEEP
-		                            :                                                 SoundPicker::PLAY_FILE;
-		mSoundPicker->set((soundType != SoundPicker::BEEP || event->beep()), soundType, event->audioFile(),
-		                  event->soundVolume(), event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
+		SoundPicker::Type soundType = event->speak()                ? SoundPicker::SPEAK
+		                            : event->beep()                 ? SoundPicker::BEEP
+		                            : !event->audioFile().isEmpty() ? SoundPicker::PLAY_FILE
+		                            :                                 SoundPicker::NONE;
+		mSoundPicker->set(soundType, event->audioFile(), event->soundVolume(),
+		                  event->fadeVolume(), event->fadeSeconds(), event->repeatSound());
 		CmdLogType logType = event->commandXterm()       ? EXEC_IN_TERMINAL
 		                   : !event->logFile().isEmpty() ? LOG_TO_FILE
 		                   :                               DISCARD_OUTPUT;
@@ -843,7 +844,7 @@
 		slotRecurFrequencyChange();      // update the Recurrence text
 		mReminder->setMinutes(0, false);
 		mReminder->enableOnceOnly(mRecurrenceEdit->isTimedRepeatType());   // must be called after mRecurrenceEdit is set up
-		mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+		mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 		                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 		mCmdTypeScript->setChecked(Preferences::defaultCmdScript());
 		mCmdLogFileEdit->setText(Preferences::defaultCmdLogFile());    // set file name before setting radio button
@@ -1031,8 +1032,7 @@
 		mSavedTemplateAfterTime = mTemplateTimeAfter->value();
 	}
 	mSavedTypeRadio        = mActionGroup->selected();
-	mSavedSound            = mSoundPicker->sound();
-	mSavedSoundType        = mSoundPicker->type();
+	mSavedSoundType        = mSoundPicker->sound();
 	mSavedSoundFile        = mSoundPicker->file();
 	mSavedSoundVolume      = mSoundPicker->volume(mSavedSoundFadeVolume, mSavedSoundFadeSeconds);
 	mSavedRepeatSound      = mSoundPicker->repeat();
@@ -1106,7 +1106,7 @@
 		return true;
 	if (mMessageRadio->isOn()  ||  mFileRadio->isOn())
 	{
-		if (mSavedSound      != mSoundPicker->sound()
+		if (mSavedSoundType  != mSoundPicker->sound()
 		||  mSavedConfirmAck != mConfirmAck->isChecked()
 		||  mSavedFont       != mFontColourButton->font()
 		||  mSavedFgColour   != mFontColourButton->fgColour()
@@ -1121,24 +1121,19 @@
 			||  mSavedPostAction != mSpecialActionsButton->postAction())
 				return true;
 		}
-		if (mSavedSound)
+		if (mSavedSoundType == SoundPicker::PLAY_FILE)
 		{
-			if (mSavedSoundType != mSoundPicker->type())
+			if (mSavedSoundFile != mSoundPicker->file())
 				return true;
-			if (mSavedSoundType == SoundPicker::PLAY_FILE)
+			if (!mSavedSoundFile.isEmpty())
 			{
-				if (mSavedSoundFile != mSoundPicker->file())
+				float fadeVolume;
+				int   fadeSecs;
+				if (mSavedRepeatSound != mSoundPicker->repeat()
+				||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
+				||  mSavedSoundFadeVolume != fadeVolume
+				||  mSavedSoundFadeSeconds != fadeSecs)
 					return true;
-				if (!mSavedSoundFile.isEmpty())
-				{
-					float fadeVolume;
-					int   fadeSecs;
-					if (mSavedRepeatSound != mSoundPicker->repeat()
-					||  mSavedSoundVolume != mSoundPicker->volume(fadeVolume, fadeSecs)
-					||  mSavedSoundFadeVolume != fadeVolume
-					||  mSavedSoundFadeSeconds != fadeSecs)
-						return true;
-				}
 			}
 		}
 	}
@@ -1297,8 +1292,8 @@
 	bool displayAlarm = mMessageRadio->isOn() || mFileRadio->isOn();
 	bool cmdAlarm     = mCommandRadio->isOn();
 	bool emailAlarm   = mEmailRadio->isOn();
-	return (displayAlarm && mSoundPicker->beep()                                 ? KAEvent::BEEP : 0)
-	     | (displayAlarm && mSoundPicker->speak()                                ? KAEvent::SPEAK : 0)
+	return (displayAlarm && mSoundPicker->sound() == SoundPicker::BEEP           ? KAEvent::BEEP : 0)
+	     | (displayAlarm && mSoundPicker->sound() == SoundPicker::SPEAK          ? KAEvent::SPEAK : 0)
 	     | (displayAlarm && mSoundPicker->repeat()                               ? KAEvent::REPEAT_SOUND : 0)
 	     | (displayAlarm && mConfirmAck->isChecked()                             ? KAEvent::CONFIRM_ACK : 0)
 	     | (displayAlarm && mLateCancel->isAutoClose()                           ? KAEvent::AUTO_CLOSE : 0)
@@ -1599,7 +1594,7 @@
 
 	bool deferred = mDeferDateTime.isValid();
 	DeferAlarmDlg deferDlg(i18n("Defer Alarm"), (deferred ? mDeferDateTime : DateTime(now.addSecs(60))),
-	                       deferred, this, "deferDlg");
+	                       deferred, this, "EditDeferDlg");
 	if (limit)
 	{
 		// Don't allow deferral past the next recurrence
@@ -1832,10 +1827,13 @@
 		mFilePadding->hide();
 		mTextMessageEdit->show();
 		mFontColourButton->show();
+		mSoundPicker->showSpeak(true);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(true);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the alarm message now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		focus = mTextMessageEdit;
 		displayAlarm = true;
 	}
@@ -1845,27 +1843,36 @@
 		mFileBox->show();
 		mFilePadding->show();
 		mFontColourButton->hide();
+		mSoundPicker->showSpeak(false);
+		mDisplayAlarmsFrame->show();
+		mCommandFrame->hide();
+		mEmailFrame->hide();
 		mReminder->show();
-		mSoundPicker->showSpeak(false);
+		mConfirmAck->show();
 		setButtonWhatsThis(Try, i18n("Display the file now"));
-		mAlarmTypeStack->raiseWidget(mDisplayAlarmsFrame);
 		mFileMessageEdit->setNoSelect();
 		focus = mFileMessageEdit;
 		displayAlarm = true;
 	}
 	else if (mCommandRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->show();
+		mEmailFrame->hide();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Execute the specified command now"));
-		mAlarmTypeStack->raiseWidget(mCommandFrame);
 		mCmdCommandEdit->setNoSelect();
 		focus = mCmdCommandEdit;
 	}
 	else if (mEmailRadio->isOn())
 	{
+		mDisplayAlarmsFrame->hide();
+		mCommandFrame->hide();
+		mEmailFrame->show();
 		mReminder->hide();
+		mConfirmAck->hide();
 		setButtonWhatsThis(Try, i18n("Send the email to the specified addressees now"));
-		mAlarmTypeStack->raiseWidget(mEmailFrame);
 		mEmailToEdit->setNoSelect();
 		focus = mEmailToEdit;
 	}
Index: kalarm/functions.h
===================================================================
--- kalarm/functions.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/functions.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -45,14 +45,20 @@
 
 /** Return codes from fileType() */
 enum FileType { Unknown, TextPlain, TextFormatted, TextApplication, Image };
-/** Return codes from calendar update functions */
+/** Return codes from calendar update functions.
+ *  The codes are ordered by severity.
+ */
 enum UpdateStatus {
 	UPDATE_OK,          // update succeeded
-	UPDATE_ERROR,       // update failed completely
-	UPDATE_KORG_ERR     // update succeeded, but KOrganizer update failed
+	UPDATE_KORG_ERR,    // update succeeded, but KOrganizer update failed
+	UPDATE_ERROR,       // update failed partially
+	UPDATE_FAILED,      // update failed completely
+	SAVE_FAILED         // calendar was updated in memory, but save failed
 };
+/** Error codes supplied as parameter to displayUpdateError() */
+enum UpdateError { ERR_ADD, ERR_REACTIVATE, ERR_TEMPLATE };
 /** Error codes supplied as parameter to displayKOrgUpdateError() */
-enum UpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
+enum KOrgUpdateError { KORG_ERR_ADD, KORG_ERR_MODIFY, KORG_ERR_DELETE };
 
 
 /** Display a main window with the specified event selected */
@@ -88,18 +94,19 @@
 QString             runKMail(bool minimise);
 bool                runProgram(const QCString& program, const QCString& windowName, QCString& dcopName, QString& errorMessage);
 
-UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false, bool allowKOrgUpdate = true);
+UpdateStatus        addEvent(KAEvent&, AlarmListView* selectionView, QWidget* errmsgParent = 0, bool useEventID = false, bool allowKOrgUpdate = true);
 bool                addExpiredEvent(KAEvent&);
-bool                addTemplate(KAEvent&, TemplateListView* selectionView);
-UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView);
-void                updateEvent(KAEvent&, AlarmListView* selectionView, bool archiveOnDelete = true, bool incRevision = true);
-void                updateTemplate(const KAEvent&, TemplateListView* selectionView);
-UpdateStatus        deleteEvent(KAEvent&, bool archive = true);
-void                deleteTemplate(const KAEvent&);
+UpdateStatus        addTemplate(KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        updateEvent(KAEvent&, AlarmListView* selectionView, QWidget* errmsgParent = 0, bool archiveOnDelete = true, bool incRevision = true);
+UpdateStatus        updateTemplate(const KAEvent&, TemplateListView* selectionView, QWidget* errmsgParent = 0);
+UpdateStatus        deleteEvent(KAEvent&, bool archive = true, QWidget* errmsgParent = 0);
+UpdateStatus        deleteTemplate(const KAEvent&);
 void                deleteDisplayEvent(const QString& eventID);
 UpdateStatus        reactivateEvent(KAEvent&, AlarmListView* selectionView, bool useEventID = false);
-void                enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
-void                displayKOrgUpdateError(QWidget* parent, UpdateError, int nAlarms);
+UpdateStatus        enableEvent(KAEvent&, AlarmListView* selectionView, bool enable);
+void                displayUpdateError(QWidget* parent, UpdateStatus, UpdateError, int nAlarms);
+void                displayKOrgUpdateError(QWidget* parent, KOrgUpdateError, int nAlarms);
 
 QString             stripAccel(const QString&);
 
Index: kalarm/alarmcalendar.h
===================================================================
--- kalarm/alarmcalendar.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/alarmcalendar.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -43,16 +43,16 @@
 		bool                  open();
 		int                   load();
 		bool                  reload();
-		void                  save();
+		bool                  save();
 		void                  close();
 		void                  startUpdate();
-		void                  endUpdate();
+		bool                  endUpdate();
 		KCal::Event*          event(const QString& uniqueID);
 		KCal::Event::List     events();
 		KCal::Event::List     eventsWithAlarms(const QDateTime& from, const QDateTime& to);
 		KCal::Event*          addEvent(KAEvent&, bool useEventID = false);
 		void                  updateEvent(const KAEvent&);
-		void                  deleteEvent(const QString& eventID, bool save = false);
+		bool                  deleteEvent(const QString& eventID, bool save = false);
 		void                  emitEmptyStatus();
 		void                  purgeAll()                          { purge(0); }
 		void                  setPurgeDays(int days);
Index: kalarm/soundpicker.h
===================================================================
--- kalarm/soundpicker.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/soundpicker.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.h  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,10 +25,9 @@
 #include <qstring.h>
 #include <kurl.h>
 
-class ButtonGroup;
-class CheckBox;
+class QHBox;
+class ComboBox;
 class PushButton;
-class RadioButton;
 
 
 class SoundPicker : public QFrame
@@ -36,19 +35,19 @@
 		Q_OBJECT
 	public:
 		/** Sound options which can be selected for when the alarm is displayed.
+		 *  @li NONE      - silence.
 		 *  @li BEEP      - a beep will be sounded.
-		 *  @li SPEAK     - the message will be spoken.
 		 *  @li PLAY_FILE - a sound file will be played.
+		 *  @li SPEAK     - the message text will be spoken.
 		 */
-		enum Type { BEEP = 1, SPEAK, PLAY_FILE };
+		enum Type { NONE = 0, BEEP, PLAY_FILE, SPEAK };
 		/** Constructor.
 		 *  @param parent The parent object of this widget.
 		 *  @param name The name of this widget.
 		 */
 		SoundPicker(QWidget* parent, const char* name = 0);
 		/** Initialises the widget's state.
-		 *  @param sound    True to enable sound.
-		 *  @param defaultType The default option to select when sound is enabled.
+		 *  @param type     The option to select.
 		 *  @param filename The full path or URL of the sound file to select. If the 'file' option is
 		 *                  not initially selected, @p filename provides the default should 'file'
 		 *                  later be selected by the user.
@@ -65,7 +64,7 @@
 		 *                  selected, @p repeat provides the default should 'file' later be selected by
 		 *                  the user.
 		 */
-		void           set(bool sound, Type defaultType, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
+		void           set(Type type, const QString& filename, float volume, float fadeVolume, int fadeSeconds, bool repeat);
 		/** Returns true if the widget is read only for the user. */
 		bool           isReadOnly() const          { return mReadOnly; }
 		/** Sets whether the widget can be changed the user.
@@ -76,14 +75,8 @@
 		 *  If it is to be hidden and it is currently selected, sound is turned off.
 		 */
 		void           showSpeak(bool show);
-		/** Returns true if sound is selected. */
-		bool           sound() const;
 		/** Returns the selected option. */
-		Type           type() const;
-		/** Returns true if 'beep' is selected. */
-		bool           beep() const;
-		/** Returns true if 'speak' is selected. */
-		bool           speak() const;
+		Type           sound() const;
 		/** If the 'file' option is selected, returns the URL of the chosen file.
 		 *  Otherwise returns a null string.
 		 */
@@ -112,28 +105,21 @@
 		 */
 		static QString browseFile(QString& initialDir, const QString& initialFile = QString::null);
 
-		static QString i18n_Sound();       // plain text of Sound checkbox
-		static QString i18n_s_Sound();     // text of Sound checkbox, with 'S' shortcut
-		static QString i18n_Beep();        // plain text of Beep radio button
-		static QString i18n_b_Beep();      // text of Beep radio button, with 'B' shortcut
-		static QString i18n_Speak();       // plain text of Speak radio button
-		static QString i18n_p_Speak();     // text of Speak radio button, with 'P' shortcut
-		static QString i18n_File();        // plain text of File radio button
+		static QString i18n_Sound();       // plain text of Sound label
+		static QString i18n_None();        // plain text of None combo box item
+		static QString i18n_Beep();        // plain text of Beep combo box item
+		static QString i18n_Speak();       // plain text of Speak combo box item
+		static QString i18n_File();        // plain text of File combo box item
 
 
 	private slots:
-		void           slotSoundToggled(bool on);
-		void           slotTypeChanged(int id);
+		void           slotTypeSelected(int id);
 		void           slotPickFile();
-		void           setLastType();
 
 	private:
 
-		CheckBox*      mCheckbox;
-		ButtonGroup*   mTypeGroup;
-		RadioButton*   mBeepRadio;
-		RadioButton*   mSpeakRadio;
-		RadioButton*   mFileRadio;
+		ComboBox*      mTypeCombo;
+		QHBox*         mTypeBox;
 		PushButton*    mFilePicker;
 		QString        mDefaultDir;
 		QString        mFile;         // sound file to play when alarm is triggered
@@ -141,7 +127,7 @@
 		float          mFadeVolume;   // initial volume for file, or < 0 for no fading
 		int            mFadeSeconds;  // fade interval in seconds
 		Type           mLastType;     // last selected sound option
-		bool           mRevertType;   // reverting to last selected sound option
+		bool           mSpeakShowing; // Speak option is shown in combo box
 		bool           mRepeat;       // repeat the sound file
 		bool           mReadOnly;
 };
Index: kalarm/preferences.cpp
===================================================================
--- kalarm/preferences.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/preferences.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  preferences.cpp  -  program preference settings
  *  Program:  kalarm
- *  Copyright (C) 2001 - 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -46,7 +46,6 @@
 const QColor                     Preferences::default_defaultFgColour(Qt::black);
 QFont                            Preferences::mDefault_messageFont;    // initialised in constructor
 const QTime                      Preferences::default_startOfDay(0, 0);
-const bool                       Preferences::default_autostartDaemon         = true;
 const bool                       Preferences::default_runInSystemTray         = true;
 const bool                       Preferences::default_disableAlarmsIfStopped  = true;
 const bool                       Preferences::default_quitWarn                = true;
@@ -72,7 +71,6 @@
 const int                        Preferences::default_defaultLateCancel       = 0;
 const bool                       Preferences::default_defaultAutoClose        = false;
 const bool                       Preferences::default_defaultCopyToKOrganizer = false;
-const bool                       Preferences::default_defaultSound            = false;
 const bool                       Preferences::default_defaultSoundRepeat      = false;
 const SoundPicker::Type          Preferences::default_defaultSoundType        = SoundPicker::BEEP;
 const bool                       Preferences::default_defaultConfirmAck       = false;
@@ -99,7 +97,6 @@
 QColor                     Preferences::mDefaultBgColour;
 QFont                      Preferences::mMessageFont;
 QTime                      Preferences::mStartOfDay;
-bool                       Preferences::mAutostartDaemon;
 bool                       Preferences::mRunInSystemTray;
 bool                       Preferences::mDisableAlarmsIfStopped;
 bool                       Preferences::mAutostartTrayIcon;
@@ -130,7 +127,6 @@
 int                        Preferences::mDefaultLateCancel;
 bool                       Preferences::mDefaultAutoClose;
 bool                       Preferences::mDefaultCopyToKOrganizer;
-bool                       Preferences::mDefaultSound;
 SoundPicker::Type          Preferences::mDefaultSoundType;
 bool                       Preferences::mDefaultSoundRepeat;
 bool                       Preferences::mDefaultConfirmAck;
@@ -145,7 +141,6 @@
 // Change tracking
 QTime                      Preferences::mOldStartOfDay;
 bool                       Preferences::mStartOfDayChanged;
-bool                       Preferences::mOldAutostartDaemon;
 
 
 static const QString defaultFeb29RecurType    = QString::fromLatin1("Mar1");
@@ -186,7 +181,6 @@
 static const QString DEF_AUTO_CLOSE           = QString::fromLatin1("DefAutoClose");
 static const QString DEF_CONFIRM_ACK          = QString::fromLatin1("DefConfirmAck");
 static const QString DEF_COPY_TO_KORG         = QString::fromLatin1("DefCopyKOrg");
-static const QString DEF_SOUND                = QString::fromLatin1("DefSound");
 static const QString DEF_SOUND_TYPE           = QString::fromLatin1("DefSoundType");
 static const QString DEF_SOUND_FILE           = QString::fromLatin1("DefSoundFile");
 static const QString DEF_SOUND_VOLUME         = QString::fromLatin1("DefSoundVolume");
@@ -199,10 +193,6 @@
 static const QString DEF_REMIND_UNITS         = QString::fromLatin1("DefRemindUnits");
 static const QString DEF_PRE_ACTION           = QString::fromLatin1("DefPreAction");
 static const QString DEF_POST_ACTION          = QString::fromLatin1("DefPostAction");
-// Obsolete - compatibility with pre-1.2.1
-static const QString EMAIL_ADDRESS            = QString::fromLatin1("EmailAddress");
-static const QString EMAIL_USE_CONTROL_CENTRE = QString::fromLatin1("EmailUseControlCenter");
-static const QString EMAIL_BCC_USE_CONTROL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
 
 // Values for EmailFrom entry
 static const QString FROM_CONTROL_CENTRE      = QString::fromLatin1("@ControlCenter");
@@ -329,9 +319,8 @@
 	mDefaultAutoClose         = config->readBoolEntry(DEF_AUTO_CLOSE, default_defaultAutoClose);
 	mDefaultConfirmAck        = config->readBoolEntry(DEF_CONFIRM_ACK, default_defaultConfirmAck);
 	mDefaultCopyToKOrganizer  = config->readBoolEntry(DEF_COPY_TO_KORG, default_defaultCopyToKOrganizer);
-	mDefaultSound             = config->readBoolEntry(DEF_SOUND, default_defaultSound);
 	int soundType             = config->readNumEntry(DEF_SOUND_TYPE, default_defaultSoundType);
-	mDefaultSoundType         = (soundType < SoundPicker::BEEP || soundType > SoundPicker::PLAY_FILE)
+	mDefaultSoundType         = (soundType < 0 || soundType > SoundPicker::SPEAK)
 	                          ? default_defaultSoundType : (SoundPicker::Type)soundType;
 	mDefaultSoundVolume       = static_cast<float>(config->readDoubleNumEntry(DEF_SOUND_VOLUME, default_defaultSoundVolume));
 #ifdef WITHOUT_ARTS
@@ -356,8 +345,6 @@
 	                          ? default_defaultReminderUnits : (TimePeriod::Units)reminderUnits;
 	mDefaultPreAction         = config->readEntry(DEF_PRE_ACTION, default_defaultPreAction);
 	mDefaultPostAction        = config->readEntry(DEF_POST_ACTION, default_defaultPostAction);
-	mAutostartDaemon          = Daemon::autoStart(default_autostartDaemon);
-	mOldAutostartDaemon       = mAutostartDaemon;
 	mInstance->emitPreferencesChanged();
 	mStartOfDayChanged = (mStartOfDay != mOldStartOfDay);
 	if (mStartOfDayChanged)
@@ -409,7 +396,6 @@
 	config->writeEntry(DEF_AUTO_CLOSE, mDefaultAutoClose);
 	config->writeEntry(DEF_CONFIRM_ACK, mDefaultConfirmAck);
 	config->writeEntry(DEF_COPY_TO_KORG, mDefaultCopyToKOrganizer);
-	config->writeEntry(DEF_SOUND, mDefaultSound);
 	config->writeEntry(DEF_SOUND_TYPE, mDefaultSoundType);
 	config->writePathEntry(DEF_SOUND_FILE, mDefaultSoundFile);
 	config->writeEntry(DEF_SOUND_VOLUME, static_cast<double>(mDefaultSoundVolume));
@@ -425,12 +411,6 @@
 	config->writeEntry(DEF_POST_ACTION, mDefaultPostAction);
 	if (syncToDisc)
 		config->sync();
-	if (mAutostartDaemon != mOldAutostartDaemon)
-	{
-		// The alarm daemon autostart setting has changed.
-		Daemon::enableAutoStart(mAutostartDaemon);
-		mOldAutostartDaemon = mAutostartDaemon;
-	}
 	mInstance->emitPreferencesChanged();
 	if (mStartOfDay != mOldStartOfDay)
 	{
@@ -565,42 +545,55 @@
 	KConfig* config = KGlobal::config();
 	config->setGroup(GENERAL_SECTION);
 	int version = KAlarm::getVersionNumber(config->readEntry(VERSION_NUM));
-	if (version >= KAlarm::Version(1,3,0))
+	if (version >= KAlarm::Version(1,4,6))
 		return;     // config format is up to date
 
-	bool sync = false;
-	QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
-	if (entries.find(EMAIL_FROM) == entries.end()
-	&&  entries.find(EMAIL_USE_CONTROL_CENTRE) != entries.end())
-	{
-		// Preferences were written by KAlarm pre-1.2.1
-		config->setGroup(GENERAL_SECTION);
-		bool useCC = false;
-		bool bccUseCC = false;
-		const bool default_emailUseControlCentre    = true;
-		const bool default_emailBccUseControlCentre = true;
-		useCC = config->readBoolEntry(EMAIL_USE_CONTROL_CENTRE, default_emailUseControlCentre);
-		// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
-		bccUseCC = config->hasKey(EMAIL_BCC_USE_CONTROL_CENTRE)
-		         ? config->readBoolEntry(EMAIL_BCC_USE_CONTROL_CENTRE, default_emailBccUseControlCentre)
-			 : useCC;
-		config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
-		config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
-		config->deleteEntry(EMAIL_ADDRESS);
-		config->deleteEntry(EMAIL_BCC_USE_CONTROL_CENTRE);
-		config->deleteEntry(EMAIL_USE_CONTROL_CENTRE);
-		sync = true;
-	}
-	// Convert KAlarm 1.2 preferences
-	static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
+	// Convert KAlarm 1.4.5 preferences
+	static const QString DEF_SOUND = QString::fromLatin1("DefSound");
 	config->setGroup(DEFAULTS_SECTION);
-	if (config->hasKey(DEF_CMD_XTERM))
+	bool sound = config->readBoolEntry(DEF_SOUND, false);
+	if (!sound)
+		config->writeEntry(DEF_SOUND_TYPE, SoundPicker::NONE);
+	config->deleteEntry(DEF_SOUND);
+
+	if (version < KAlarm::Version(1,3,0))
 	{
-		config->writeEntry(DEF_CMD_LOG_TYPE,
-			(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
-		config->deleteEntry(DEF_CMD_XTERM);
-		sync = true;
+		// Convert KAlarm pre-1.3 preferences
+		static const QString EMAIL_ADDRESS             = QString::fromLatin1("EmailAddress");
+		static const QString EMAIL_USE_CTRL_CENTRE     = QString::fromLatin1("EmailUseControlCenter");
+		static const QString EMAIL_BCC_USE_CTRL_CENTRE = QString::fromLatin1("EmailBccUseControlCenter");
+		QMap<QString, QString> entries = config->entryMap(GENERAL_SECTION);
+		if (entries.find(EMAIL_FROM) == entries.end()
+		&&  entries.find(EMAIL_USE_CTRL_CENTRE) != entries.end())
+		{
+			// Preferences were written by KAlarm pre-1.2.1
+			config->setGroup(GENERAL_SECTION);
+			bool useCC = false;
+			bool bccUseCC = false;
+			const bool default_emailUseControlCentre    = true;
+			const bool default_emailBccUseControlCentre = true;
+			useCC = config->readBoolEntry(EMAIL_USE_CTRL_CENTRE, default_emailUseControlCentre);
+			// EmailBccUseControlCenter was missing in preferences written by KAlarm pre-0.9.5
+			bccUseCC = config->hasKey(EMAIL_BCC_USE_CTRL_CENTRE)
+			         ? config->readBoolEntry(EMAIL_BCC_USE_CTRL_CENTRE, default_emailBccUseControlCentre)
+				 : useCC;
+			config->writeEntry(EMAIL_FROM, (useCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_ADDRESS)));
+			config->writeEntry(EMAIL_BCC_ADDRESS, (bccUseCC ? FROM_CONTROL_CENTRE : config->readEntry(EMAIL_BCC_ADDRESS)));
+			config->deleteEntry(EMAIL_ADDRESS);
+			config->deleteEntry(EMAIL_BCC_USE_CTRL_CENTRE);
+			config->deleteEntry(EMAIL_USE_CTRL_CENTRE);
+		}
+		// Convert KAlarm 1.2 preferences
+		static const QString DEF_CMD_XTERM = QString::fromLatin1("DefCmdXterm");
+		config->setGroup(DEFAULTS_SECTION);
+		if (config->hasKey(DEF_CMD_XTERM))
+		{
+			config->writeEntry(DEF_CMD_LOG_TYPE,
+				(config->readBoolEntry(DEF_CMD_XTERM, false) ? EditAlarmDlg::EXEC_IN_TERMINAL : EditAlarmDlg::DISCARD_OUTPUT));
+			config->deleteEntry(DEF_CMD_XTERM);
+		}
 	}
-	if (sync)
-		config->sync();
+	config->setGroup(GENERAL_SECTION);
+	config->writeEntry(VERSION_NUM, KALARM_VERSION);
+	config->sync();
 }
Index: kalarm/templatedlg.cpp
===================================================================
--- kalarm/templatedlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/templatedlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  templatedlg.cpp  -  dialogue to create, edit and delete alarm templates
  *  Program:  kalarm
- *  Copyright (c) 2004-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -144,14 +144,14 @@
 */
 void TemplateDlg::createTemplate(const KAEvent* event, QWidget* parent, TemplateListView* view)
 {
-	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, "editDlg", event);
+	EditAlarmDlg editDlg(true, i18n("New Alarm Template"), parent, 0, event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent event;
 		editDlg.getEvent(event);
 
 		// Add the template to the displayed lists and to the calendar file
-		KAlarm::addTemplate(event, view);
+		KAlarm::addTemplate(event, view, &editDlg);
 		Undo::saveAdd(event);
 	}
 }
@@ -166,7 +166,7 @@
 	if (item)
 	{
 		KAEvent event = item->event();
-		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, "editDlg", &event);
+		EditAlarmDlg editDlg(true, i18n("Edit Alarm Template"), this, 0, &event);
 		if (editDlg.exec() == QDialog::Accepted)
 		{
 			KAEvent newEvent;
@@ -175,7 +175,7 @@
 			newEvent.setEventID(id);
 
 			// Update the event in the displays and in the calendar file
-			KAlarm::updateTemplate(newEvent, mTemplateList);
+			KAlarm::updateTemplate(newEvent, mTemplateList, &editDlg);
 			Undo::saveEdit(event, newEvent);
 		}
 	}
@@ -195,16 +195,29 @@
 		    != KMessageBox::Continue)
 		return;
 
+	int warnErr = 0;
+	KAlarm::UpdateStatus status = KAlarm::UPDATE_OK;
 	QValueList<KAEvent> events;
 	AlarmCalendar::templateCalendar()->startUpdate();    // prevent multiple saves of the calendar until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
 	{
 		TemplateListViewItem* item = (TemplateListViewItem*)(*it);
 		events.append(item->event());
-		KAlarm::deleteTemplate(item->event());
+		KAlarm::UpdateStatus st = KAlarm::deleteTemplate(item->event());
+		if (st != KAlarm::UPDATE_OK)
+		{
+			status = st;
+			++warnErr;
+		}
 	}
-	AlarmCalendar::templateCalendar()->endUpdate();    // save the calendar now
+	if (!AlarmCalendar::templateCalendar()->endUpdate())    // save the calendar now
+	{
+		status = KAlarm::SAVE_FAILED;
+		warnErr = items.count();
+	}
 	Undo::saveDeletes(events);
+	if (warnErr)
+		displayUpdateError(this, status, KAlarm::ERR_TEMPLATE, warnErr);
 }
 
 /******************************************************************************
Index: kalarm/kalarm.h
===================================================================
--- kalarm/kalarm.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/kalarm.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -26,7 +26,7 @@
 #include <config.h>
 #endif
 
-#define KALARM_VERSION "1.4.5"
+#define KALARM_VERSION "1.4.6"
 #define KALARM_NAME "KAlarm"
 
 #include <kdeversion.h>
Index: kalarm/mainwindow.cpp
===================================================================
--- kalarm/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -114,7 +114,7 @@
 }
 
 MainWindow::MainWindow(bool restored)
-	: MainWindowBase(0, 0, WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
+	: MainWindowBase(0, "MainWin", WGroupLeader | WStyle_ContextHelp | WDestructiveClose),
 	  mMinuteTimerActive(false),
 	  mHiddenTrayParent(false),
 	  mShowExpired(Preferences::showExpiredAlarms()),
@@ -567,7 +567,7 @@
 */
 void MainWindow::executeNew(MainWindow* win, const KAEvent* evnt, KAEvent::Action action, const AlarmText& text)
 {
-	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, "editDlg", evnt);
+	EditAlarmDlg editDlg(false, i18n("New Alarm"), win, 0, evnt);
 	if (!text.isEmpty())
 		editDlg.setAction(action, text);
 	if (editDlg.exec() == QDialog::Accepted)
@@ -576,8 +576,8 @@
 		editDlg.getEvent(event);
 
 		// Add the alarm to the displayed lists and to the calendar file
-		if (KAlarm::addEvent(event, (win ? win->mListView : 0)) == KAlarm::UPDATE_KORG_ERR)
-			KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_ADD, 1);
+		if (KAlarm::addEvent(event, (win ? win->mListView : 0), &editDlg) == KAlarm::UPDATE_KORG_ERR)
+			KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_ADD, 1);
 		Undo::saveAdd(event);
 
 		KAlarm::outputAlarmWarnings(&editDlg, &event);
@@ -637,7 +637,7 @@
 */
 void MainWindow::executeEdit(KAEvent& event, MainWindow* win)
 {
-	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, "editDlg", &event);
+	EditAlarmDlg editDlg(false, i18n("Edit Alarm"), win, 0, &event);
 	if (editDlg.exec() == QDialog::Accepted)
 	{
 		KAEvent newEvent;
@@ -648,12 +648,13 @@
 		if (changeDeferral)
 		{
 			// The only change has been to an existing deferral
-			KAlarm::updateEvent(newEvent, view, true, false);   // keep the same event ID
+			if (KAlarm::updateEvent(newEvent, view, &editDlg, true, false) != KAlarm::UPDATE_OK)   // keep the same event ID
+				return;   // failed to save event
 		}
 		else
 		{
-			if (KAlarm::modifyEvent(event, newEvent, view) == KAlarm::UPDATE_KORG_ERR)
-				KAlarm::displayKOrgUpdateError(win, KAlarm::KORG_ERR_MODIFY, 1);
+			if (KAlarm::modifyEvent(event, newEvent, view, &editDlg) == KAlarm::UPDATE_KORG_ERR)
+				KAlarm::displayKOrgUpdateError(&editDlg, KAlarm::KORG_ERR_MODIFY, 1);
 		}
 		Undo::saveEdit(event, newEvent);
 
@@ -671,9 +672,9 @@
 	if (item)
 	{
 		KAEvent event = item->event();
-		EditAlarmDlg editDlg(false, (event.expired() ? i18n("Expired Alarm") + " [" + i18n("read-only") + "]"
+		EditAlarmDlg editDlg(false, (event.expired() ? i18n("Expired Alarm") + " [" + i18n("read-only") + ']'
 		                                             : i18n("View Alarm")),
-		                     this, "editDlg", &event, true);
+		                     this, 0, &event, true);
 		editDlg.exec();
 	}
 }
@@ -697,6 +698,7 @@
 			return;
 	}
 
+	int warnErr = 0;
 	int warnKOrg = 0;
 	QValueList<KAEvent> events;
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
@@ -708,14 +710,28 @@
 
 		// Delete the event from the calendar and displays
 		events.append(event);
-		if (KAlarm::deleteEvent(event) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::deleteEvent(event))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveDeletes(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_DELETE, warnKOrg);
 }
 
@@ -725,6 +741,7 @@
 */
 void MainWindow::slotReactivate()
 {
+	int warnErr = 0;
 	int warnKOrg = 0;
 	QValueList<KAEvent> events;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
@@ -737,14 +754,28 @@
 		AlarmListViewItem* item = (AlarmListViewItem*)(*it);
 		KAEvent event = item->event();
 		events.append(event);
-		if (KAlarm::reactivateEvent(event, mListView, true) == KAlarm::UPDATE_KORG_ERR)
-			++warnKOrg;
+		switch (KAlarm::reactivateEvent(event, mListView, true))
+		{
+			case KAlarm::UPDATE_ERROR:
+			case KAlarm::UPDATE_FAILED:
+			case KAlarm::SAVE_FAILED:
+				++warnErr;
+				break;
+			case KAlarm::UPDATE_KORG_ERR:
+				++warnKOrg;
+				break;
+			default:
+				break;
+		}
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
 	AlarmCalendar::expiredCalendar()->endUpdate();
 	Undo::saveReactivates(events);
 
-	if (warnKOrg)
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_REACTIVATE, warnErr);
+	else if (warnKOrg)
 		KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 }
 
@@ -755,6 +786,7 @@
 void MainWindow::slotEnable()
 {
 	bool enable = mActionEnableEnable;    // save since changed in response to KAlarm::enableEvent()
+	int warnErr = 0;
 	QValueList<EventListViewItemBase*> items = mListView->selectedItems();
 	AlarmCalendar::activeCalendar()->startUpdate();    // prevent multiple saves of the calendars until we're finished
 	for (QValueList<EventListViewItemBase*>::Iterator it = items.begin();  it != items.end();  ++it)
@@ -763,9 +795,13 @@
 		KAEvent event = item->event();
 
 		// Enable the alarm in the displayed lists and in the calendar file
-		KAlarm::enableEvent(event, mListView, enable);
+		if (KAlarm::enableEvent(event, mListView, enable) != KAlarm::UPDATE_OK)
+			++warnErr;
 	}
-	AlarmCalendar::activeCalendar()->endUpdate();      // save the calendars now
+	if (!AlarmCalendar::activeCalendar()->endUpdate())      // save the calendars now
+		warnErr = items.count();
+	if (warnErr)
+		KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
 }
 
 /******************************************************************************
@@ -830,14 +866,28 @@
 		if (events.count())
 		{
 			mListView->clearSelection();
+			int warnErr = 0;
 			int warnKOrg = 0;
 			for (QValueList<KAEvent>::Iterator ev = events.begin();  ev != events.end();  ++ev)
 			{
 				// Add alarm to the displayed lists and to the calendar file
-				if (KAlarm::addEvent(*ev, mListView) == KAlarm::UPDATE_KORG_ERR)
-					++warnKOrg;
+				switch (KAlarm::addEvent(*ev, mListView))
+				{
+					case KAlarm::UPDATE_ERROR:
+					case KAlarm::UPDATE_FAILED:
+					case KAlarm::SAVE_FAILED:
+						++warnErr;
+						break;
+					case KAlarm::UPDATE_KORG_ERR:
+						++warnKOrg;
+						break;
+					default:
+						break;
+				}
 			}
-			if (warnKOrg)
+			if (warnErr)
+				KAlarm::displayUpdateError(this, KAlarm::UPDATE_FAILED, KAlarm::ERR_ADD, warnErr);
+			else if (warnKOrg)
 				KAlarm::displayKOrgUpdateError(this, KAlarm::KORG_ERR_ADD, warnKOrg);
 			KAlarm::outputAlarmWarnings(&dlg);
 		}
Index: kalarm/editdlg.h
===================================================================
--- kalarm/editdlg.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/editdlg.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  editdlg.h  -  dialogue to create or modify an alarm or alarm template
  *  Program:  kalarm
- *  Copyright (c) 2001-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -233,7 +233,6 @@
 		int                 mSavedTemplateAfterTime; // mTemplateAfterTime value
 		QButton*            mSavedTypeRadio;      // mMessageRadio, etc
 		SoundPicker::Type   mSavedSoundType;      // mSoundPicker sound type
-		bool                mSavedSound;          // mSoundPicker sound status
 		bool                mSavedRepeatSound;    // mSoundPicker repeat status
 		QString             mSavedSoundFile;      // mSoundPicker sound file
 		float               mSavedSoundVolume;    // mSoundPicker volume
Index: kalarm/prefdlg.h
===================================================================
--- kalarm/prefdlg.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/prefdlg.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  prefdlg.h  -  program preferences dialog
  *  Program:  kalarm
- *  Copyright (c) 2001-2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2001-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -28,6 +28,7 @@
 
 #include "preferences.h"
 #include "recurrenceedit.h"
+#include "soundpicker.h"
 
 class QButtonGroup;
 class QCheckBox;
@@ -126,8 +127,7 @@
 		QRadioButton*  mRunOnDemand;
 		QCheckBox*     mDisableAlarmsIfStopped;
 		QCheckBox*     mQuitWarn;
-		QCheckBox*     mAutostartTrayIcon1;
-		QCheckBox*     mAutostartTrayIcon2;
+		QCheckBox*     mAutostartTrayIcon;
 		QCheckBox*     mConfirmAlarmDeletion;
 		QCheckBox*     mKeepExpired;
 		QCheckBox*     mPurgeExpired;
@@ -192,8 +192,6 @@
 		void         slotBrowseSoundFile();
 
 	private:
-		void         setSoundType(SoundPicker::Type);
-
 		QCheckBox*      mAutoClose;
 		QCheckBox*      mConfirmAck;
 		QComboBox*      mReminderUnits;
@@ -201,10 +199,7 @@
 		QCheckBox*      mCmdScript;
 		QCheckBox*      mCmdXterm;
 		QCheckBox*      mEmailBcc;
-		QRadioButton*   mBeep;
-		QRadioButton*   mSpeak;
-		QRadioButton*   mFile;
-		QCheckBox*      mSound;
+		QComboBox*      mSound;
 		QLabel*         mSoundFileLabel;
 		QLineEdit*      mSoundFile;
 		QPushButton*    mSoundFileBrowse;
@@ -214,6 +209,7 @@
 		QComboBox*      mRecurPeriod;
 		QButtonGroup*   mFeb29;
 
+		static int soundIndex(SoundPicker::Type);
 		static int recurIndex(RecurrenceEdit::RepeatType);
 };
 
Index: kalarm/Changelog
===================================================================
--- kalarm/Changelog	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/Changelog	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,5 +1,13 @@
 KAlarm
 
+=== Version 1.4.6 --- 19 November 2006 ===
+Fix "Start alarm monitoring at login" value shown in preferences dialogue.
+Fix deselecting "Start alarm monitoring at login" when daemon not running.
+Fix editing of 29th February alarm options for non-leap years.
+Tidy up preferences dialogue Run mode options.
+Tidy up alarm edit/preferences dialogue sound type options into a combo box.
+Add context help for sound file fade options.
+
 === Version 1.4.5 (KDE 3.5.5) --- 29 September 2006 ===
 Improve edit dialogue layout (Reminder controls moved to below Time box).
 
Index: kalarm/daemon.h
===================================================================
--- kalarm/daemon.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/daemon.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -46,7 +46,7 @@
 		static bool      reregister()            { return registerWith(true); }
 		static bool      reset();
 		static bool      stop();
-		static bool      autoStart(bool defaultSetting);
+		static bool      autoStart();
 		static void      enableAutoStart(bool enable);
 		static void      setAlarmsEnabled()      { mInstance->setAlarmsEnabled(true); }
 		static void      checkStatus()           { checkIfRunning(); }
Index: kalarm/calendarcompat.cpp
===================================================================
--- kalarm/calendarcompat.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/calendarcompat.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -86,7 +86,7 @@
 	{
 		// Older versions used KAlarm's translated name in the product ID, which
 		// could have created problems using a calendar in different locales.
-		progname = QString(" ") + kapp->aboutData()->programName() + " ";
+		progname = QString(" ") + kapp->aboutData()->programName() + ' ';
 		i = prodid.find(progname, 0, false);
 		if (i < 0)
 			return 0;    // calendar wasn't created by KAlarm
@@ -119,7 +119,7 @@
 	if (!file.open(IO_ReadOnly))
 		return false;
 	QTextStream ts(&file);
-	ts.setEncoding(QTextStream::UnicodeUTF8);
+	ts.setEncoding(QTextStream::Latin1);
 	QString text = ts.read();
 	file.close();
 
Index: kalarm/karecurrence.h
===================================================================
--- kalarm/karecurrence.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/karecurrence.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  karecurrence.h  -  recurrence with special yearly February 29th handling
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -65,6 +65,8 @@
 		QDateTime   endDateTime() const;
 		QDate       endDate() const;
 		bool        recursOn(const QDate&) const;
+		QDateTime   getNextDateTime(const QDateTime& preDateTime) const;
+		QDateTime   getPreviousDateTime(const QDateTime& afterDateTime) const;
 		int         longestInterval() const;
 		Type        type() const;
 		static Type type(const KCal::RecurrenceRule*);
Index: kalarm/sounddlg.cpp
===================================================================
--- kalarm/sounddlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/sounddlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  sounddlg.cpp  -  sound file selection and configuration dialog
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -134,7 +134,7 @@
 	label->setBuddy(mFadeTime);
 	label = new QLabel(i18n("seconds"), mFadeBox);
 	label->setFixedSize(label->sizeHint());
-	QWhatsThis::add(box, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
+	QWhatsThis::add(mFadeBox, i18n("Enter how many seconds to fade the sound before reaching the set volume."));
 
 	// Fade slider
 	mFadeVolumeBox = new QHBox(group);
@@ -147,7 +147,7 @@
 	mFadeSlider->setTickInterval(10);
 	mFadeSlider->setSizePolicy(QSizePolicy(QSizePolicy::Expanding, QSizePolicy::Fixed));
 	label->setBuddy(mFadeSlider);
-	QWhatsThis::add(box, i18n("Choose the initial volume for playing the sound file."));
+	QWhatsThis::add(mFadeVolumeBox, i18n("Choose the initial volume for playing the sound file."));
 
 	// Restore the dialogue size from last time
 	QSize s;
Index: kalarm/prefdlg.cpp
===================================================================
--- kalarm/prefdlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/prefdlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -48,6 +48,7 @@
 
 #include "alarmcalendar.h"
 #include "alarmtimewidget.h"
+#include "daemon.h"
 #include "editdlg.h"
 #include "fontcolour.h"
 #include "functions.h"
@@ -91,7 +92,7 @@
 =============================================================================*/
 
 KAlarmPrefDlg::KAlarmPrefDlg()
-	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, 0, true, true)
+	: KDialogBase(IconList, i18n("Preferences"), Help | Default | Ok | Apply | Cancel, Ok, 0, "PrefDlg", true, true)
 {
 	setIconListAllVisible(true);
 
@@ -225,26 +226,25 @@
 	// Get alignment to use in QGridLayout (AlignAuto doesn't work correctly there)
 	int alignment = QApplication::reverseLayout() ? Qt::AlignRight : Qt::AlignLeft;
 
-	// Autostart alarm daemon
-	QHBox* itemBox = new QHBox(mPage);   // this is to allow left adjustment
-	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), itemBox, "startDaemon");
-	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
-	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
-	QWhatsThis::add(mAutostartDaemon,
-	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
-	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
-	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
-	itemBox->setStretchFactor(new QWidget(itemBox), 1);    // left adjust the controls
-
 	QGroupBox* group = new QButtonGroup(i18n("Run Mode"), mPage, "modeGroup");
-	QGridLayout* grid = new QGridLayout(group, 6, 3, KDialog::marginHint(), KDialog::spacingHint());
+	QGridLayout* grid = new QGridLayout(group, 6, 2, KDialog::marginHint(), KDialog::spacingHint());
 	grid->setColStretch(2, 1);
 	grid->addColSpacing(0, indentWidth());
 	grid->addColSpacing(1, indentWidth());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	int row = 1;
 
-	// Run-in-system-tray radio button has an ID of 0
+	// Run-on-demand radio button
+	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
+	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
+	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
+	QWhatsThis::add(mRunOnDemand,
+	      i18n("Check to run KAlarm only when required.\n\n"
+	           "Notes:\n"
+	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
+	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
+	grid->addMultiCellWidget(mRunOnDemand, 1, 1, 0, 2, alignment);
+
+	// Run-in-system-tray radio button
 	mRunInSystemTray = new QRadioButton(i18n("Run continuously in system &tray"), group, "runTray");
 	mRunInSystemTray->setFixedSize(mRunInSystemTray->sizeHint());
 	connect(mRunInSystemTray, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
@@ -254,58 +254,42 @@
 	           "1. With this option selected, closing the system tray icon will quit KAlarm.\n"
 	           "2. You do not need to select this option in order for alarms to be displayed, since alarm monitoring is done by the alarm daemon."
 	           " Running in the system tray simply provides easy access and a status indication."));
-	grid->addMultiCellWidget(mRunInSystemTray, row, row, 0, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mRunInSystemTray, 2, 2, 0, 2, alignment);
 
-	mAutostartTrayIcon1 = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
-	mAutostartTrayIcon1->setFixedSize(mAutostartTrayIcon1->sizeHint());
-#ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon1, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
-#endif
-	QWhatsThis::add(mAutostartTrayIcon1,
-	      i18n("Check to run KAlarm whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon1, row, row, 1, 2, alignment);
-	++row;
-
+	// Run continuously options
 	mDisableAlarmsIfStopped = new QCheckBox(i18n("Disa&ble alarms while not running"), group, "disableAl");
 	mDisableAlarmsIfStopped->setFixedSize(mDisableAlarmsIfStopped->sizeHint());
 	connect(mDisableAlarmsIfStopped, SIGNAL(toggled(bool)), SLOT(slotDisableIfStoppedToggled(bool)));
 	QWhatsThis::add(mDisableAlarmsIfStopped,
 	      i18n("Check to disable alarms whenever KAlarm is not running. Alarms will only appear while the system tray icon is visible."));
-	grid->addMultiCellWidget(mDisableAlarmsIfStopped, row, row, 1, 2, alignment);
-	++row;
+	grid->addMultiCellWidget(mDisableAlarmsIfStopped, 3, 3, 1, 2, alignment);
 
 	mQuitWarn = new QCheckBox(i18n("Warn before &quitting"), group, "disableAl");
 	mQuitWarn->setFixedSize(mQuitWarn->sizeHint());
 	QWhatsThis::add(mQuitWarn,
 	      i18n("Check to display a warning prompt before quitting KAlarm."));
-	grid->addWidget(mQuitWarn, row, 2, alignment);
-	++row;
+	grid->addWidget(mQuitWarn, 4, 2, alignment);
 
-	// Run-on-demand radio button has an ID of 3
-	mRunOnDemand = new QRadioButton(i18n("&Run only on demand"), group, "runDemand");
-	mRunOnDemand->setFixedSize(mRunOnDemand->sizeHint());
-	connect(mRunOnDemand, SIGNAL(toggled(bool)), SLOT(slotRunModeToggled(bool)));
-	QWhatsThis::add(mRunOnDemand,
-	      i18n("Check to run KAlarm only when required.\n\n"
-	           "Notes:\n"
-	           "1. Alarms are displayed even when KAlarm is not running, since alarm monitoring is done by the alarm daemon.\n"
-	           "2. With this option selected, the system tray icon can be displayed or hidden independently of KAlarm."));
-	grid->addMultiCellWidget(mRunOnDemand, row, row, 0, 2, alignment);
-	++row;
-
-	mAutostartTrayIcon2 = new QCheckBox(i18n("Autostart system tray &icon at login"), group, "autoRun");
-	mAutostartTrayIcon2->setFixedSize(mAutostartTrayIcon2->sizeHint());
+	mAutostartTrayIcon = new QCheckBox(i18n("Autostart at &login"), group, "autoTray");
 #ifdef AUTOSTART_BY_KALARMD
-	connect(mAutostartTrayIcon2, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
+	connect(mAutostartTrayIcon, SIGNAL(toggled(bool)), SLOT(slotAutostartToggled(bool)));
 #endif
-	QWhatsThis::add(mAutostartTrayIcon2,
-	      i18n("Check to display the system tray icon whenever you start KDE."));
-	grid->addMultiCellWidget(mAutostartTrayIcon2, row, row, 1, 2, alignment);
+	grid->addMultiCellWidget(mAutostartTrayIcon, 5, 5, 0, 2, alignment);
+
+	// Autostart alarm daemon
+	mAutostartDaemon = new QCheckBox(i18n("Start alarm monitoring at lo&gin"), group, "startDaemon");
+	mAutostartDaemon->setFixedSize(mAutostartDaemon->sizeHint());
+	connect(mAutostartDaemon, SIGNAL(clicked()), SLOT(slotAutostartDaemonClicked()));
+	QWhatsThis::add(mAutostartDaemon,
+	      i18n("Automatically start alarm monitoring whenever you start KDE, by running the alarm daemon (%1).\n\n"
+	           "This option should always be checked unless you intend to discontinue use of KAlarm.")
+	          .arg(QString::fromLatin1(DAEMON_APP_NAME)));
+	grid->addMultiCellWidget(mAutostartDaemon, 6, 6, 0, 2, alignment);
+
 	group->setFixedHeight(group->sizeHint().height());
 
 	// Start-of-day time
-	itemBox = new QHBox(mPage);
+	QHBox* itemBox = new QHBox(mPage);
 	QHBox* box = new QHBox(itemBox);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	QLabel* label = new QLabel(i18n("&Start of day for date-only alarms:"), box);
@@ -370,7 +354,7 @@
 	      i18n("Choose which application to use when a command alarm is executed in a terminal window"));
 	grid = new QGridLayout(group, 1, 3, KDialog::marginHint(), KDialog::spacingHint());
 	grid->addRowSpacing(0, fontMetrics().lineSpacing()/2);
-	row = 0;
+	int row = 0;
 
 	mXtermType = new QButtonGroup(group);
 	mXtermType->hide();
@@ -413,14 +397,13 @@
 
 void MiscPrefTab::restore()
 {
-	mAutostartDaemon->setChecked(Preferences::mAutostartDaemon);
+	mAutostartDaemon->setChecked(Daemon::autoStart());
 	bool systray = Preferences::mRunInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::mDisableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::quitWarn());
-	mAutostartTrayIcon1->setChecked(Preferences::mAutostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::mAutostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::mAutostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::confirmAlarmDeletion());
 	mStartOfDay->setValue(Preferences::mStartOfDay);
 	setExpiredControls(Preferences::mExpiredKeepDays);
@@ -468,12 +451,14 @@
 	Preferences::mDisableAlarmsIfStopped = mDisableAlarmsIfStopped->isChecked();
 	if (mQuitWarn->isEnabled())
 		Preferences::setQuitWarn(mQuitWarn->isChecked());
-	Preferences::mAutostartTrayIcon = systray ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
+	Preferences::mAutostartTrayIcon = mAutostartTrayIcon->isChecked();
 #ifdef AUTOSTART_BY_KALARMD
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
+	bool newAutostartDaemon = mAutostartDaemon->isChecked() || Preferences::mAutostartTrayIcon;
 #else
-	Preferences::mAutostartDaemon = mAutostartDaemon->isChecked();
+	bool newAutostartDaemon = mAutostartDaemon->isChecked();
 #endif
+	if (newAutostartDaemon != Daemon::autoStart())
+		Daemon::enableAutoStart(newAutostartDaemon);
 	Preferences::setConfirmAlarmDeletion(mConfirmAlarmDeletion->isChecked());
 	int sod = mStartOfDay->value();
 	Preferences::mStartOfDay.setHMS(sod/60, sod%60, 0);
@@ -485,14 +470,13 @@
 
 void MiscPrefTab::setDefaults()
 {
-	mAutostartDaemon->setChecked(Preferences::default_autostartDaemon);
+	mAutostartDaemon->setChecked(true);
 	bool systray = Preferences::default_runInSystemTray;
 	mRunInSystemTray->setChecked(systray);
 	mRunOnDemand->setChecked(!systray);
 	mDisableAlarmsIfStopped->setChecked(Preferences::default_disableAlarmsIfStopped);
 	mQuitWarn->setChecked(Preferences::default_quitWarn);
-	mAutostartTrayIcon1->setChecked(Preferences::default_autostartTrayIcon);
-	mAutostartTrayIcon2->setChecked(Preferences::default_autostartTrayIcon);
+	mAutostartTrayIcon->setChecked(Preferences::default_autostartTrayIcon);
 	mConfirmAlarmDeletion->setChecked(Preferences::default_confirmAlarmDeletion);
 	mStartOfDay->setValue(Preferences::default_startOfDay);
 	setExpiredControls(Preferences::default_expiredKeepDays);
@@ -513,9 +497,10 @@
 
 void MiscPrefTab::slotRunModeToggled(bool)
 {
-	bool systray = (mRunInSystemTray->isOn());
-	mAutostartTrayIcon2->setEnabled(!systray);
-	mAutostartTrayIcon1->setEnabled(systray);
+	bool systray = mRunInSystemTray->isOn();
+	mAutostartTrayIcon->setText(systray ? i18n("Autostart at &login") : i18n("Autostart system tray &icon at login"));
+	QWhatsThis::add(mAutostartTrayIcon, (systray ? i18n("Check to run KAlarm whenever you start KDE.")
+	                                             : i18n("Check to display the system tray icon whenever you start KDE.")));
 	mDisableAlarmsIfStopped->setEnabled(systray);
 	slotDisableIfStoppedToggled(true);
 }
@@ -527,8 +512,7 @@
 void MiscPrefTab::slotAutostartToggled(bool)
 {
 #ifdef AUTOSTART_BY_KALARMD
-	bool autostart = mRunInSystemTray->isChecked() ? mAutostartTrayIcon1->isChecked() : mAutostartTrayIcon2->isChecked();
-	mAutostartDaemon->setEnabled(!autostart);
+	mAutostartDaemon->setEnabled(!mAutostartTrayIcon->isChecked());
 #endif
 }
 
@@ -926,37 +910,25 @@
 	layout = new QVBoxLayout(bgroup, KDialog::marginHint(), KDialog::spacingHint());
 	layout->addSpacing(groupTopMargin);
 
-	mSound = new QCheckBox(SoundPicker::i18n_s_Sound(), bgroup, "defSound");
+	QBoxLayout* hlayout = new QHBoxLayout(layout, KDialog::spacingHint());
+	mSound = new QComboBox(false, bgroup, "defSound");
+	mSound->insertItem(SoundPicker::i18n_None());         // index 0
+	mSound->insertItem(SoundPicker::i18n_Beep());         // index 1
+	mSound->insertItem(SoundPicker::i18n_File());         // index 2
+	if (theApp()->speechEnabled())
+		mSound->insertItem(SoundPicker::i18n_Speak());  // index 3
 	mSound->setMinimumSize(mSound->sizeHint());
 	QWhatsThis::add(mSound, defsetting.arg(SoundPicker::i18n_Sound()));
-	layout->addWidget(mSound, 0, Qt::AlignAuto);
+	hlayout->addWidget(mSound);
+	hlayout->addStretch(1);
 
-	box = new QHBox(bgroup);
-	box->setSpacing(KDialog::spacingHint());
-	layout->addWidget(box, 0, Qt::AlignAuto);
+#ifndef WITHOUT_ARTS
+	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
+	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
+	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
+	hlayout->addWidget(mSoundRepeat);
+#endif
 
-	mBeep = new QRadioButton(SoundPicker::i18n_b_Beep(), box, "defBeep");
-	bgroup->insert(mBeep);
-	mBeep->setMinimumSize(mBeep->sizeHint());
-	QWhatsThis::add(mBeep,
-	      soundSetting.arg(SoundPicker::i18n_Beep()).arg(SoundPicker::i18n_Sound()));
-	mFile = new QRadioButton(SoundPicker::i18n_File(), box, "defFile");
-	bgroup->insert(mFile);
-	mFile->setMinimumSize(mFile->sizeHint());
-	QWhatsThis::add(mFile,
-	      soundSetting.arg(SoundPicker::i18n_File()).arg(SoundPicker::i18n_Sound()));
-	if (theApp()->speechEnabled())
-	{
-		mSpeak = new QRadioButton(SoundPicker::i18n_Speak(), box, "defSpeak");
-		mSpeak->setMinimumSize(mSpeak->sizeHint());
-		QWhatsThis::add(mSpeak,
-		      soundSetting.arg(SoundPicker::i18n_Speak()).arg(SoundPicker::i18n_Sound()));
-		bgroup->insert(mSpeak);
-	}
-	else
-		mSpeak = 0;
-	box->setStretchFactor(new QWidget(box), 1);    // left adjust the controls
-
 	box = new QHBox(bgroup);   // this is to control the QWhatsThis text display area
 	box->setSpacing(KDialog::spacingHint());
 	mSoundFileLabel = new QLabel(i18n("Sound &file:"), box);
@@ -972,13 +944,6 @@
 	      i18n("Enter the default sound file to use in the alarm edit dialog."));
 	box->setFixedHeight(box->sizeHint().height());
 	layout->addWidget(box);
-
-#ifndef WITHOUT_ARTS
-	mSoundRepeat = new QCheckBox(i18n("Repea&t sound file"), bgroup, "defRepeatSound");
-	mSoundRepeat->setMinimumSize(mSoundRepeat->sizeHint());
-	QWhatsThis::add(mSoundRepeat, i18n("sound file \"Repeat\" checkbox", "The default setting for sound file \"%1\" in the alarm edit dialog.").arg(SoundDlg::i18n_Repeat()));
-	layout->addWidget(mSoundRepeat, 0, Qt::AlignAuto);
-#endif
 	bgroup->setFixedHeight(bgroup->sizeHint().height());
 
 	// COMMAND ALARMS
@@ -1076,8 +1041,7 @@
 	mConfirmAck->setChecked(Preferences::mDefaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::mDefaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::mDefaultPreAction, Preferences::mDefaultPostAction);
-	mSound->setChecked(Preferences::mDefaultSound);
-	setSoundType(Preferences::mDefaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::mDefaultSoundType));
 	mSoundFile->setText(Preferences::mDefaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::mDefaultSoundRepeat);
@@ -1098,11 +1062,15 @@
 	Preferences::mDefaultReminderUnits    = static_cast<TimePeriod::Units>(mReminderUnits->currentItem());
 	Preferences::mDefaultPreAction        = mSpecialActionsButton->preAction();
 	Preferences::mDefaultPostAction       = mSpecialActionsButton->postAction();
-	Preferences::mDefaultSound            = mSound->isChecked();
+	switch (mSound->currentItem())
+	{
+		case 3:  Preferences::mDefaultSoundType = SoundPicker::SPEAK;      break;
+		case 2:  Preferences::mDefaultSoundType = SoundPicker::PLAY_FILE;  break;
+		case 1:  Preferences::mDefaultSoundType = SoundPicker::BEEP;       break;
+		case 0:
+		default: Preferences::mDefaultSoundType = SoundPicker::NONE;       break;
+	}
 	Preferences::mDefaultSoundFile        = mSoundFile->text();
-	Preferences::mDefaultSoundType        = mSpeak && mSpeak->isOn() ? SoundPicker::SPEAK
-	                                      : mFile->isOn()            ? SoundPicker::PLAY_FILE
-	                                      :                            SoundPicker::BEEP;
 #ifndef WITHOUT_ARTS
 	Preferences::mDefaultSoundRepeat      = mSoundRepeat->isChecked();
 #endif
@@ -1133,8 +1101,7 @@
 	mConfirmAck->setChecked(Preferences::default_defaultConfirmAck);
 	mReminderUnits->setCurrentItem(Preferences::default_defaultReminderUnits);
 	mSpecialActionsButton->setActions(Preferences::default_defaultPreAction, Preferences::default_defaultPostAction);
-	mSound->setChecked(Preferences::default_defaultSound);
-	setSoundType(Preferences::default_defaultSoundType);
+	mSound->setCurrentItem(soundIndex(Preferences::default_defaultSoundType));
 	mSoundFile->setText(Preferences::default_defaultSoundFile);
 #ifndef WITHOUT_ARTS
 	mSoundRepeat->setChecked(Preferences::default_defaultSoundRepeat);
@@ -1156,6 +1123,18 @@
 		mSoundFile->setText(url);
 }
 
+int EditPrefTab::soundIndex(SoundPicker::Type type)
+{
+	switch (type)
+	{
+		case SoundPicker::SPEAK:      return 3;
+		case SoundPicker::PLAY_FILE:  return 2;
+		case SoundPicker::BEEP:       return 1;
+		case SoundPicker::NONE:
+		default:                      return 0;
+	}
+}
+
 int EditPrefTab::recurIndex(RecurrenceEdit::RepeatType type)
 {
 	switch (type)
@@ -1171,30 +1150,9 @@
 	}
 }
 
-void EditPrefTab::setSoundType(SoundPicker::Type type)
-{
-	switch (type)
-	{
-		case SoundPicker::PLAY_FILE:
-			mFile->setChecked(true);
-			break;
-		case SoundPicker::SPEAK:
-			if (mSpeak)
-			{
-				mSpeak->setChecked(true);
-				break;
-			}
-			// fall through to BEEP
-		case SoundPicker::BEEP:
-		default:
-			mBeep->setChecked(true);
-			break;
-	}
-}
-
 QString EditPrefTab::validate()
 {
-	if (mFile->isOn()  &&  mSoundFile->text().isEmpty())
+	if (mSound->currentItem() == SoundPicker::PLAY_FILE  &&  mSoundFile->text().isEmpty())
 	{
 		mSoundFile->setFocus();
 		return i18n("You must enter a sound file when %1 is selected as the default sound type").arg(SoundPicker::i18n_File());;
Index: kalarm/daemon.cpp
===================================================================
--- kalarm/daemon.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/daemon.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -374,24 +374,23 @@
 	// Tell the alarm daemon in case it is running.
 	AlarmDaemonIface_stub s(DAEMON_APP_NAME, DAEMON_DCOP_OBJECT);
 	s.enableAutoStart(enable);
-	if (!s.ok())
-	{
-		// Failure - the daemon probably isn't running, so rewrite its config file for it
-		KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
-		adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-		adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
-		adconfig.sync();
-	}
+
+	// The return status doesn't report failure even if the daemon isn't running,
+	// so in case of failure, rewrite the config file in any case.
+	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
+	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
+	adconfig.writeEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), enable);
+	adconfig.sync();
 }
 
 /******************************************************************************
 * Read the alarm daemon's autostart-at-login setting.
 */
-bool Daemon::autoStart(bool defaultAutoStart)
+bool Daemon::autoStart()
 {
 	KConfig adconfig(locate("config", DAEMON_APP_NAME"rc"));
 	adconfig.setGroup(QString::fromLatin1(DAEMON_AUTOSTART_SECTION));
-	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), defaultAutoStart);
+	return adconfig.readBoolEntry(QString::fromLatin1(DAEMON_AUTOSTART_KEY), true);
 }
 
 /******************************************************************************
Index: kalarm/recurrenceedit.cpp
===================================================================
--- kalarm/recurrenceedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/recurrenceedit.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1476,6 +1476,7 @@
 		checked[(*it) - 1] = true;
 	for (int i = 0;  i < 12;  ++i)
 		mMonthBox[i]->setChecked(checked[i]);
+	enableFeb29();
 }
 
 /******************************************************************************
Index: kalarm/traywindow.cpp
===================================================================
--- kalarm/traywindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/traywindow.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -292,7 +292,7 @@
 	for (iit = items.begin();  iit != items.end();  ++iit)
 	{
 		kdDebug(5950) << "-- " << (count+1) << ") " << (*iit).text << endl;
-		text += "\n";
+		text += '\n';
 		text += (*iit).text;
 		if (++count == maxCount)
 			break;
Index: kalarm/functions.cpp
===================================================================
--- kalarm/functions.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/functions.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -127,27 +127,37 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, bool useEventID, bool allowKOrgUpdate)
+UpdateStatus addEvent(KAEvent& event, AlarmListView* selectionView, QWidget* errmsgParent, bool useEventID, bool allowKOrgUpdate)
 {
 	kdDebug(5950) << "KAlarm::addEvent(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 	if (!theApp()->checkCalendarDaemon())    // ensure calendar is open and daemon started
-		return UPDATE_ERROR;
-
-	// Save the event details in the calendar file, and get the new event ID
-	AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-	cal->addEvent(event, useEventID);
-	cal->save();
-
-	UpdateStatus ret = UPDATE_OK;
-	if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		return UPDATE_FAILED;
+	else
 	{
-		if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-			ret = UPDATE_KORG_ERR;
+		// Save the event details in the calendar file, and get the new event ID
+		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
+		if (!cal->addEvent(event, useEventID))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
 	}
+	if (status == UPDATE_OK)
+	{
+		if (allowKOrgUpdate  &&  event.copyToKOrganizer())
+		{
+			if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
+				status = UPDATE_KORG_ERR;
+		}
 
-	// Update the window lists
-	AlarmListView::addEvent(event, selectionView);
-	return ret;
+		// Update the window lists
+		AlarmListView::addEvent(event, selectionView);
+		return status;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -181,21 +191,29 @@
 * event in that listView instance.
 * 'event' is updated with the actual event ID.
 */
-bool addTemplate(KAEvent& event, TemplateListView* selectionView)
+UpdateStatus addTemplate(KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::addTemplate(): " << event.id() << endl;
+	UpdateStatus status = UPDATE_OK;
 
 	// Add the template to the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (!cal)
-		return false;
-	cal->addEvent(event);
-	cal->save();
-	cal->emitEmptyStatus();
+	if (!cal  ||  !cal->addEvent(event))
+		status = UPDATE_FAILED;
+	else if (!cal->save())
+		status = SAVE_FAILED;
+	else
+	{
+		cal->emitEmptyStatus();
 
-	// Update the window lists
-	TemplateListView::addEvent(event, selectionView);
-	return true;
+		// Update the window lists
+		TemplateListView::addEvent(event, selectionView);
+		return UPDATE_OK;
+	}
+
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -205,15 +223,18 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * modified event in that listView instance.
 */
-UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView)
+UpdateStatus modifyEvent(KAEvent& oldEvent, const KAEvent& newEvent, AlarmListView* selectionView, QWidget* errmsgParent)
 {
 	kdDebug(5950) << "KAlarm::modifyEvent(): '" << oldEvent.id() << endl;
 
+	UpdateStatus status = UPDATE_OK;
 	if (!newEvent.valid())
-		return deleteEvent(oldEvent, true);
+	{
+		deleteEvent(oldEvent, true);
+		status = UPDATE_FAILED;
+	}
 	else
 	{
-		UpdateStatus ret = UPDATE_OK;
 		if (oldEvent.copyToKOrganizer())
 		{
 			// Tell KOrganizer to delete its old event.
@@ -224,20 +245,28 @@
 
 		// Update the event in the calendar file, and get the new event ID
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(oldEvent.id());
-		cal->addEvent(const_cast<KAEvent&>(newEvent), true);
-		cal->save();
+		if (!cal->deleteEvent(oldEvent.id())
+		||  !cal->addEvent(const_cast<KAEvent&>(newEvent), true))
+			status = UPDATE_FAILED;
+		else if (!cal->save())
+			status = SAVE_FAILED;
+		if (status == UPDATE_OK)
+		{
+			if (newEvent.copyToKOrganizer())
+			{
+				if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
+					status = UPDATE_KORG_ERR;
+			}
 
-		if (newEvent.copyToKOrganizer())
-		{
-			if (!sendToKOrganizer(newEvent))    // tell KOrganizer to show the new event
-				ret = UPDATE_KORG_ERR;
+			// Update the window lists
+			AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
+			return status;
 		}
+	}
 
-		// Update the window lists
-		AlarmListView::modifyEvent(oldEvent.id(), newEvent, selectionView);
-		return ret;
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, status, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
@@ -249,7 +278,7 @@
 * The event is not updated in KOrganizer, since this function is called when an
 * existing alarm is rescheduled (due to recurrence or deferral).
 */
-void updateEvent(KAEvent& event, AlarmListView* selectionView, bool archiveOnDelete, bool incRevision)
+UpdateStatus updateEvent(KAEvent& event, AlarmListView* selectionView, QWidget* errmsgParent, bool archiveOnDelete, bool incRevision)
 {
 	kdDebug(5950) << "KAlarm::updateEvent(): " << event.id() << endl;
 
@@ -262,11 +291,17 @@
 			event.incrementRevision();    // ensure alarm daemon sees the event has changed
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+		{
+			if (errmsgParent)
+				displayUpdateError(errmsgParent, SAVE_FAILED, ERR_ADD, 1);
+			return SAVE_FAILED;
+		}
 
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -274,23 +309,34 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void updateTemplate(const KAEvent& event, TemplateListView* selectionView)
+UpdateStatus updateTemplate(const KAEvent& event, TemplateListView* selectionView, QWidget* errmsgParent)
 {
+	UpdateStatus status = UPDATE_OK;
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
+	if (!cal)
+		status = UPDATE_FAILED;
+	else
 	{
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			status = SAVE_FAILED;
+		else
+		{
+			TemplateListView::modifyEvent(event.id(), event, selectionView);
+			return UPDATE_OK;
+		}
+	}
 
-		TemplateListView::modifyEvent(event.id(), event, selectionView);
-	}
+	if (errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_TEMPLATE, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete an alarm from the calendar file and from every main window instance.
 * If the event is archived, the event's ID is changed to an expired ID if necessary.
 */
-UpdateStatus deleteEvent(KAEvent& event, bool archive)
+UpdateStatus deleteEvent(KAEvent& event, bool archive, QWidget* errmsgParent)
 {
 	QString id = event.id();
 	kdDebug(5950) << "KAlarm::deleteEvent(): " << id << endl;
@@ -298,14 +344,15 @@
 	// Update the window lists
 	AlarmListView::deleteEvent(id);
 
-	UpdateStatus ret = UPDATE_OK;
+	UpdateStatus status = UPDATE_OK;
+	AlarmCalendar* cal;
 
 	// Delete the event from the calendar file
 	if (KAEvent::uidStatus(id) == KAEvent::EXPIRED)
 	{
-		AlarmCalendar* cal = AlarmCalendar::expiredCalendarOpen();
-		if (cal)
-			cal->deleteEvent(id, true);   // save calendar after deleting
+		cal = AlarmCalendar::expiredCalendarOpen();
+		if (!cal)
+			status = UPDATE_FAILED;
 	}
 	else
 	{
@@ -315,33 +362,40 @@
 			// delete it. Note that an error could occur if the user
 			// manually deleted it from KOrganizer since it was set up.
 			if (!deleteFromKOrganizer(event.id()))
-				ret = UPDATE_KORG_ERR;
+				status = UPDATE_KORG_ERR;
 		}
 		if (archive  &&  event.toBeArchived())
 			addExpiredEvent(event);     // this changes the event ID to an expired ID
-		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-		cal->deleteEvent(id, true);    // save calendar after deleting
+		cal = AlarmCalendar::activeCalendar();
 	}
-	return ret;
+	if (status != UPDATE_FAILED)
+	{
+		if (!cal->deleteEvent(id, true))   // save calendar after deleting
+			status = SAVE_FAILED;
+	}
+	if (status > UPDATE_KORG_ERR  &&  errmsgParent)
+		displayUpdateError(errmsgParent, SAVE_FAILED, ERR_ADD, 1);
+	return status;
 }
 
 /******************************************************************************
 * Delete a template from the calendar file and from every template list view.
 */
-void deleteTemplate(const KAEvent& event)
+UpdateStatus deleteTemplate(const KAEvent& event)
 {
 	QString id = event.id();
 
 	// Delete the template from the calendar file
 	AlarmCalendar* cal = AlarmCalendar::templateCalendarOpen();
-	if (cal)
-	{
-		cal->deleteEvent(id, true);    // save calendar after deleting
-		cal->emitEmptyStatus();
-	}
+	if (!cal)
+		return UPDATE_FAILED;
+	if (!cal->deleteEvent(id, true))    // save calendar after deleting
+		return SAVE_FAILED;
+	cal->emitEmptyStatus();
 
 	// Update the window lists
 	TemplateListView::deleteEvent(id);
+	return UPDATE_OK;
 }
 
 /******************************************************************************
@@ -382,14 +436,16 @@
 
 			// Save the event details in the calendar file, and get the new event ID
 			AlarmCalendar* cal = AlarmCalendar::activeCalendar();
-			cal->addEvent(event, useEventID);
-			cal->save();
+			if (!cal->addEvent(event, useEventID))
+				return UPDATE_FAILED;
+			if (!cal->save())
+				return SAVE_FAILED;
 
-			UpdateStatus ret = UPDATE_OK;
+			UpdateStatus status = UPDATE_OK;
 			if (event.copyToKOrganizer())
 			{
 				if (!sendToKOrganizer(event))    // tell KOrganizer to show the event
-					ret = UPDATE_KORG_ERR;
+					status = UPDATE_KORG_ERR;
 			}
 
 			// Update the window lists
@@ -398,10 +454,10 @@
 			cal = AlarmCalendar::expiredCalendarOpen();
 			if (cal)
 				cal->deleteEvent(id, true);   // save calendar after deleting
-			return ret;
+			return status;
 		}
 	}
-	return UPDATE_ERROR;
+	return UPDATE_FAILED;
 }
 
 /******************************************************************************
@@ -410,7 +466,7 @@
 * If 'selectionView' is non-null, the selection highlight is moved to the
 * updated event in that listView instance.
 */
-void enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
+UpdateStatus enableEvent(KAEvent& event, AlarmListView* selectionView, bool enable)
 {
 	kdDebug(5950) << "KAlarm::enableEvent(" << enable << "): " << event.id() << endl;
 
@@ -421,7 +477,8 @@
 		// Update the event in the calendar file
 		AlarmCalendar* cal = AlarmCalendar::activeCalendar();
 		cal->updateEvent(event);
-		cal->save();
+		if (!cal->save())
+			return SAVE_FAILED;
 
 		// If we're disabling a display alarm, close any message window
 		if (!enable  &&  event.displayAction())
@@ -433,12 +490,36 @@
 		// Update the window lists
 		AlarmListView::modifyEvent(event, selectionView);
 	}
+	return UPDATE_OK;
 }
 
 /******************************************************************************
+* Display an error message about an error saving an event.
+*/
+void displayUpdateError(QWidget* parent, UpdateStatus, UpdateError code, int nAlarms)
+{
+	QString errmsg;
+	switch (code)
+	{
+		case ERR_ADD:
+			errmsg = (nAlarms > 1) ? i18n("Error saving alarms")
+			                       : i18n("Error saving alarm");
+			break;
+		case ERR_REACTIVATE:
+			errmsg = (nAlarms > 1) ? i18n("Error saving reactivated alarms")
+			                       : i18n("Error saving reactivated alarm");
+			break;
+		case ERR_TEMPLATE:
+			errmsg = i18n("Error saving alarm template");
+			break;
+	}
+	KMessageBox::error(parent, errmsg);
+}
+
+/******************************************************************************
 * Display an error message corresponding to a specified alarm update error code.
 */
-void displayKOrgUpdateError(QWidget* parent, UpdateError code, int nAlarms)
+void displayKOrgUpdateError(QWidget* parent, KOrgUpdateError code, int nAlarms)
 {
 	QString errmsg;
 	switch (code)
Index: kalarm/karecurrence.cpp
===================================================================
--- kalarm/karecurrence.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/karecurrence.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  karecurrence.cpp  -  recurrence with special yearly February 29th handling
  *  Program:  kalarm
- *  Copyright (c) 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2005,2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -31,7 +31,23 @@
 
 using namespace KCal;
 
+/*=============================================================================
+= Class KARecurrence
+= The purpose of this class is to represent the restricted range of recurrence
+= types which are handled by KAlarm, and to translate between these and the
+= libkcal Recurrence class. In particular, it handles yearly recurrences on
+= 29th February specially:
+=
+= KARecurrence allows annual 29th February recurrences to fall on 28th
+= February or 1st March, or not at all, in non-leap years. It allows such
+= 29th February recurrences to be combined with the 29th of other months in
+= a simple way, represented simply as the 29th of multiple months including
+= February. For storage in the libkcal calendar, the 29th day of the month
+= recurrence for other months is combined with a last-day-of-February or a
+= 60th-day-of-the-year recurrence rule, thereby conforming to RFC2445.
+=============================================================================*/
 
+
 KARecurrence::Feb29Type KARecurrence::mDefaultFeb29 = KARecurrence::FEB29_FEB29;
 
 
@@ -125,11 +141,13 @@
 		if (!QDate::leapYear(year)
 		&&  startdt.date().dayOfYear() == (feb29Type == FEB29_MAR1 ? 60 : 59))
 		{
-			// The event start date is February 28th or March 1st, but it
-			// is a recurrence on February 29th (recurring on February 28th
-			// or March 1st in non-leap years). Adjust the start date to
-			// be on February 29th in the last previous leap year.
-//#warning Is this necessary now?
+			/* The event start date is February 28th or March 1st, but it
+			 * is a recurrence on February 29th (recurring on February 28th
+			 * or March 1st in non-leap years). Adjust the start date to
+			 * be on February 29th in the last previous leap year.
+			 * This is necessary because KARecurrence represents all types
+			 * of 29th February recurrences by a simple 29th February.
+			 */
 			while (!QDate::leapYear(--year)) ;
 			startdt.setDate(QDate(year, 2, 29));
 		}
@@ -333,6 +351,44 @@
 }
 
 /******************************************************************************
+* Get the next time the recurrence occurs, strictly after a specified time.
+*/
+QDateTime KARecurrence::getNextDateTime(const QDateTime& preDateTime) const
+{
+	switch (type())
+	{
+		case ANNUAL_DATE:
+		case ANNUAL_POS:
+		{
+			Recurrence recur;
+			writeRecurrence(recur);
+			return recur.getNextDateTime(preDateTime);
+		}
+		default:
+			return Recurrence::getNextDateTime(preDateTime);
+	}
+}
+
+/******************************************************************************
+* Get the previous time the recurrence occurred, strictly before a specified time.
+*/
+QDateTime KARecurrence::getPreviousDateTime(const QDateTime& afterDateTime) const
+{
+	switch (type())
+	{
+		case ANNUAL_DATE:
+		case ANNUAL_POS:
+		{
+			Recurrence recur;
+			writeRecurrence(recur);
+			return recur.getPreviousDateTime(afterDateTime);
+		}
+		default:
+			return Recurrence::getPreviousDateTime(afterDateTime);
+	}
+}
+
+/******************************************************************************
 * Initialise a KCal::Recurrence to be the same as this instance.
 * Additional recurrence rules are created as necessary if it recurs on Feb 29th.
 */
@@ -613,7 +669,7 @@
 	// Get the date of the next occurrence after the end of the earlier ending rule
 	RecurrenceRule rr(*rr1);
 	rr.setDuration(-1);
-	QDateTime next1 = rr.getNextDate(end1).date();
+	QDateTime next1(rr.getNextDate(end1).date());
 	if (!next1.isValid())
 		end = end1.date();
 	else
Index: kalarm/alarmcalendar.cpp
===================================================================
--- kalarm/alarmcalendar.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/alarmcalendar.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -578,26 +578,30 @@
 * Flag the end of a group of calendar update calls.
 * The calendar is saved if appropriate.
 */
-void AlarmCalendar::endUpdate()
+bool AlarmCalendar::endUpdate()
 {
 	if (mUpdateCount > 0)
 		--mUpdateCount;
 	if (!mUpdateCount)
 	{
 		if (mUpdateSave)
-			saveCal();
+			return saveCal();
 	}
+	return true;
 }
 
 /******************************************************************************
 * Save the calendar, or flag it for saving if in a group of calendar update calls.
 */
-void AlarmCalendar::save()
+bool AlarmCalendar::save()
 {
 	if (mUpdateCount)
+	{
 		mUpdateSave = true;
+		return true;
+	}
 	else
-		saveCal();
+		return saveCal();
 }
 
 #if 0
@@ -780,7 +784,7 @@
 * Delete the specified event from the calendar, if it exists.
 * The calendar is then optionally saved.
 */
-void AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
+bool AlarmCalendar::deleteEvent(const QString& eventID, bool saveit)
 {
 	if (mOpen)
 	{
@@ -791,12 +795,13 @@
 			if (mType == KAEvent::ACTIVE)
 				Daemon::savingEvent(eventID);
 			if (saveit)
-				save();
-			return;
+				return save();
+			return true;
 		}
 	}
 	if (mType == KAEvent::ACTIVE)
 		Daemon::eventHandled(eventID, false);
+	return false;
 }
 
 /******************************************************************************
Index: kalarm/soundpicker.cpp
===================================================================
--- kalarm/soundpicker.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/soundpicker.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  soundpicker.cpp  -  widget to select a sound file or a beep
  *  Program:  kalarm
- *  Copyright (C) 2002, 2004, 2005 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002,2004-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -18,13 +18,13 @@
  *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  */
 
-#include <config.h>
 #include "kalarm.h"
 
 #include <qlayout.h>
 #include <qregexp.h>
 #include <qtooltip.h>
 #include <qtimer.h>
+#include <qlabel.h>
 #include <qhbox.h>
 #include <qwhatsthis.h>
 
@@ -38,12 +38,10 @@
 #endif
 #include <kdebug.h>
 
-#include "buttongroup.h"
-#include "checkbox.h"
+#include "combobox.h"
 #include "functions.h"
 #include "kalarmapp.h"
 #include "pushbutton.h"
-#include "radiobutton.h"
 #include "sounddlg.h"
 #include "soundpicker.moc"
 
@@ -51,75 +49,46 @@
 // Collect these widget labels together to ensure consistent wording and
 // translations across different modules.
 QString SoundPicker::i18n_Sound()       { return i18n("An audio sound", "Sound"); }
-QString SoundPicker::i18n_s_Sound()     { return i18n("An audio sound", "&Sound"); }
+QString SoundPicker::i18n_None()        { return i18n("None"); }
 QString SoundPicker::i18n_Beep()        { return i18n("Beep"); }
-QString SoundPicker::i18n_b_Beep()      { return i18n("&Beep"); }
 QString SoundPicker::i18n_Speak()       { return i18n("Speak"); }
-QString SoundPicker::i18n_p_Speak()     { return i18n("S&peak"); }
-QString SoundPicker::i18n_File()        { return i18n("File"); }
+QString SoundPicker::i18n_File()        { return i18n("Sound file"); }
 
 
 SoundPicker::SoundPicker(QWidget* parent, const char* name)
-	: QFrame(parent, name),
-	  mRevertType(false)
+	: QFrame(parent, name)
 {
-	// Sound checkbox
 	setFrameStyle(QFrame::NoFrame);
-	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, 2*KDialog::spacingHint());
-	soundLayout->setAlignment(Qt::AlignVCenter);
-	mCheckbox = new CheckBox(i18n_s_Sound(), this);
-	mCheckbox->setFixedSize(mCheckbox->sizeHint());
-	connect(mCheckbox, SIGNAL(toggled(bool)), SLOT(slotSoundToggled(bool)));
-	QWhatsThis::add(mCheckbox,
-	      i18n("Check to enable sound when the message is displayed. Select the type of sound from the displayed options."));
-	soundLayout->addWidget(mCheckbox);
+	QHBoxLayout* soundLayout = new QHBoxLayout(this, 0, KDialog::spacingHint());
+	mTypeBox = new QHBox(this);    // this is to control the QWhatsThis text display area
+	mTypeBox->setSpacing(KDialog::spacingHint());
 
-	// Sound type
-	mTypeGroup = new ButtonGroup(this);
-	mTypeGroup->hide();
-	connect(mTypeGroup, SIGNAL(buttonSet(int)), SLOT(slotTypeChanged(int)));
+	QLabel* label = new QLabel(i18n("An audio sound", "&Sound:"), mTypeBox);
+	label->setFixedSize(label->sizeHint());
 
-	// Beep radio button
-	mBeepRadio = new RadioButton(i18n_Beep(), this, "beepButton");
-	mBeepRadio->setFixedSize(mBeepRadio->sizeHint());
-	QWhatsThis::add(mBeepRadio, i18n("If checked, a beep will sound when the alarm is displayed."));
-	mTypeGroup->insert(mBeepRadio, BEEP);
-	soundLayout->addWidget(mBeepRadio);
+	// Sound type combo box
+	// The order of combo box entries must correspond with the 'Type' enum.
+	mTypeCombo = new ComboBox(false, mTypeBox);
+	mTypeCombo->insertItem(i18n_None());     // index NONE
+	mTypeCombo->insertItem(i18n_Beep());     // index BEEP
+	mTypeCombo->insertItem(i18n_File());     // index PLAY_FILE
+	mSpeakShowing = !theApp()->speechEnabled();
+	showSpeak(!mSpeakShowing);              // index SPEAK (only displayed if appropriate)
+	connect(mTypeCombo, SIGNAL(activated(int)), SLOT(slotTypeSelected(int)));
+	label->setBuddy(mTypeCombo);
+	soundLayout->addWidget(mTypeBox);
 
-	// File radio button
-	QHBox* box = new QHBox(this);
-	mFileRadio = new RadioButton(i18n_File(), box, "audioFileButton");
-	mFileRadio->setFixedSize(mFileRadio->sizeHint());
-	QWhatsThis::add(mFileRadio, i18n("If checked, a sound file will be played when the alarm is displayed."));
-	mTypeGroup->insert(mFileRadio, PLAY_FILE);
-
 	// Sound file picker button
-	mFilePicker = new PushButton(box);
+	mFilePicker = new PushButton(this);
 	mFilePicker->setPixmap(SmallIcon("playsound"));
 	mFilePicker->setFixedSize(mFilePicker->sizeHint());
 	connect(mFilePicker, SIGNAL(clicked()), SLOT(slotPickFile()));
 	QWhatsThis::add(mFilePicker, i18n("Configure a sound file to play when the alarm is displayed."));
-	box->setFixedSize(box->sizeHint());
-	soundLayout->addWidget(box);
-	box->setFocusProxy(mFileRadio);
+	soundLayout->addWidget(mFilePicker);
 
-	// Speak radio button
-	mSpeakRadio = new RadioButton(i18n_p_Speak(), this, "speakButton");
-	mSpeakRadio->setFixedSize(mSpeakRadio->sizeHint());
-	QWhatsThis::add(mSpeakRadio, i18n("If checked, the message will be spoken when the alarm is displayed."));
-	mTypeGroup->insert(mSpeakRadio, SPEAK);
-	soundLayout->addWidget(mSpeakRadio);
-
-	if (!theApp()->speechEnabled())
-		mSpeakRadio->hide();     // speech capability is not installed
-
-	setTabOrder(mCheckbox, mBeepRadio);
-	setTabOrder(mBeepRadio, mFileRadio);
-	setTabOrder(mFileRadio, mFilePicker);
-	setTabOrder(mFilePicker, mSpeakRadio);
-
 	// Initialise the file picker button state and tooltip
-	slotSoundToggled(false);
+	mTypeCombo->setCurrentItem(NONE);
+	mFilePicker->setEnabled(false);
 }
 
 /******************************************************************************
@@ -127,13 +96,10 @@
 */
 void SoundPicker::setReadOnly(bool readOnly)
 {
-	mCheckbox->setReadOnly(readOnly);
-	mBeepRadio->setReadOnly(readOnly);
-	mFileRadio->setReadOnly(readOnly);
+	mTypeCombo->setReadOnly(readOnly);
 #ifdef WITHOUT_ARTS
 	mFilePicker->setReadOnly(readOnly);
 #endif
-	mSpeakRadio->setReadOnly(readOnly);
 	mReadOnly = readOnly;
 }
 
@@ -143,58 +109,40 @@
 void SoundPicker::showSpeak(bool show)
 {
 	if (!theApp()->speechEnabled())
-		return;     // speech capability is not installed
-
-	bool shown = !mSpeakRadio->isHidden();
-	if (show  &&  !shown)
-		mSpeakRadio->show();
-	else if (!show  &&  shown)
+		show = false;    // speech capability is not installed
+	if (show == mSpeakShowing)
+		return;    // no change
+	QString whatsThis = "<p>" + i18n("Choose a sound to play when the message is displayed.")
+	                  + "<br>" + i18n("%1: the message is displayed silently.").arg("<b>" + i18n_None() + "</b>")
+	                  + "<br>" + i18n("%1: a simple beep is sounded.").arg("<b>" + i18n_Beep() + "</b>")
+	                  + "<br>" + i18n("%1: an audio file is played. You will be prompted to choose the file and set play options.").arg("<b>" + i18n_File() + "</b>");
+	if (!show  &&  mTypeCombo->currentItem() == SPEAK)
+		mTypeCombo->setCurrentItem(NONE);
+	mTypeCombo->removeItem(SPEAK);    // precaution in case of mix-ups
+	if (show)
 	{
-		if (mSpeakRadio->isOn())
-			mCheckbox->setChecked(false);
-		mSpeakRadio->hide();
+		mTypeCombo->insertItem(i18n_Speak());
+		whatsThis += "<br>" + i18n("%1: the message text is spoken.").arg("<b>" + i18n_Speak() + "</b>") + "</p>";
 	}
+	QWhatsThis::add(mTypeBox, whatsThis + "</p>");
+	mSpeakShowing = show;
 }
 
 /******************************************************************************
-* Return whether sound is selected.
-*/
-bool SoundPicker::sound() const
-{
-	return mCheckbox->isChecked();
-}
-
-/******************************************************************************
 * Return the currently selected option.
 */
-SoundPicker::Type SoundPicker::type() const
+SoundPicker::Type SoundPicker::sound() const
 {
-	return static_cast<SoundPicker::Type>(mTypeGroup->selectedId());
+	return static_cast<SoundPicker::Type>(mTypeCombo->currentItem());
 }
 
 /******************************************************************************
-* Return whether beep is selected.
+* Return the selected sound file, if the File option is selected.
+* Returns null string if File is not currently selected.
 */
-bool SoundPicker::beep() const
-{
-	return mCheckbox->isChecked()  &&  mBeepRadio->isOn();
-}
-
-/******************************************************************************
-* Return whether speech is selected.
-*/
-bool SoundPicker::speak() const
-{
-	return mCheckbox->isChecked()  &&  !mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn();
-}
-
-/******************************************************************************
-* Return the selected sound file, if the main checkbox is checked.
-* Returns null string if beep is currently selected.
-*/
 QString SoundPicker::file() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() ? mFile : QString::null;
+	return (mTypeCombo->currentItem() == PLAY_FILE) ? mFile : QString::null;
 }
 
 /******************************************************************************
@@ -203,7 +151,7 @@
 */
 float SoundPicker::volume(float& fadeVolume, int& fadeSeconds) const
 {
-	if (mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty())
+	if (mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty())
 	{
 		fadeVolume  = mFadeVolume;
 		fadeSeconds = mFadeSeconds;
@@ -223,49 +171,34 @@
 */
 bool SoundPicker::repeat() const
 {
-	return mCheckbox->isChecked() && mFileRadio->isOn() && !mFile.isEmpty() && mRepeat;
+	return mTypeCombo->currentItem() == PLAY_FILE  &&  !mFile.isEmpty()  &&  mRepeat;
 }
 
 /******************************************************************************
 * Initialise the widget's state.
 */
-void SoundPicker::set(bool sound, SoundPicker::Type defaultType, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
+void SoundPicker::set(SoundPicker::Type type, const QString& f, float volume, float fadeVolume, int fadeSeconds, bool repeat)
 {
-	if (defaultType == PLAY_FILE  &&  f.isEmpty())
-		defaultType = BEEP;
-	mLastType    = static_cast<Type>(0);
+	if (type == PLAY_FILE  &&  f.isEmpty())
+		type = BEEP;
 	mFile        = f;
 	mVolume      = volume;
 	mFadeVolume  = fadeVolume;
 	mFadeSeconds = fadeSeconds;
 	mRepeat      = repeat;
 	QToolTip::add(mFilePicker, mFile);
-	mCheckbox->setChecked(sound);
-	mTypeGroup->setButton(defaultType);
+	mTypeCombo->setCurrentItem(type);  // this doesn't trigger slotTypeSelected()
+	mFilePicker->setEnabled(type == PLAY_FILE);
+	mLastType = type;
 }
 
 /******************************************************************************
-* Called when the sound checkbox is toggled.
-*/
-void SoundPicker::slotSoundToggled(bool on)
-{
-	mBeepRadio->setEnabled(on);
-	mSpeakRadio->setEnabled(on);
-	mFileRadio->setEnabled(on);
-	mFilePicker->setEnabled(on && mFileRadio->isOn());
-	if (on  &&  mSpeakRadio->isHidden()  &&  mSpeakRadio->isOn())
-		mBeepRadio->setChecked(true);
-	if (on)
-		mBeepRadio->setFocus();
-}
-
-/******************************************************************************
 * Called when the sound option is changed.
 */
-void SoundPicker::slotTypeChanged(int id)
+void SoundPicker::slotTypeSelected(int id)
 {
 	Type newType = static_cast<Type>(id);
-	if (newType == mLastType  ||  mRevertType)
+	if (newType == mLastType)
 		return;
 	if (mLastType == PLAY_FILE)
 		mFilePicker->setEnabled(false);
@@ -277,7 +210,7 @@
 			if (mFile.isEmpty())
 				return;    // revert to previously selected type
 		}
-		mFilePicker->setEnabled(mCheckbox->isChecked());
+		mFilePicker->setEnabled(true);
 	}
 	mLastType = newType;
 }
@@ -317,23 +250,12 @@
 	QToolTip::add(mFilePicker, mFile);
 	if (mFile.isEmpty())
 	{
-		// No audio file is selected, so revert to 'beep'.
-		// But wait a moment until setting the radio button, or it won't work.
-		mRevertType = true;   // prevent sound dialogue popping up twice
-		QTimer::singleShot(0, this, SLOT(setLastType()));
+		// No audio file is selected, so revert to previously selected option
+		mTypeCombo->setCurrentItem(mLastType);
 	}
 }
 
 /******************************************************************************
-* Select the previously selected sound type.
-*/
-void SoundPicker::setLastType()
-{
-	mTypeGroup->setButton(mLastType);
-	mRevertType = false;
-}
-
-/******************************************************************************
 * Display a dialogue to choose a sound file, initially highlighting any
 * specified file. 'initialFile' must be a full path name or URL.
 * 'defaultDir' is updated to the directory containing the chosen file.
@@ -351,7 +273,8 @@
 #ifdef WITHOUT_ARTS
 	QString filter = QString::fromLatin1("*.wav *.mp3 *.ogg|%1\n*|%2").arg(i18n("Sound Files")).arg(i18n("All Files"));
 #else
-	QString filter = KDE::PlayObjectFactory::mimeTypes().join(" ");
+	QStringList filters = KDE::PlayObjectFactory::mimeTypes();
+	QString filter = filters.join(" ");
 #endif
 	return KAlarm::browseFile(i18n("Choose Sound File"), defaultDir, initialFile, filter, KFile::ExistingOnly, 0, "pickSoundFile");
 }
Index: kalarm/birthdaydlg.cpp
===================================================================
--- kalarm/birthdaydlg.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kalarm/birthdaydlg.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,7 +1,7 @@
 /*
  *  birthdaydlg.cpp  -  dialog to pick birthdays from address book
  *  Program:  kalarm
- *  Copyright (c) 2002-2006 by David Jarvie <software@astrojar.org.uk>
+ *  Copyright © 2002-2006 by David Jarvie <software@astrojar.org.uk>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -71,7 +71,7 @@
 
 
 BirthdayDlg::BirthdayDlg(QWidget* parent)
-	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent),
+	: KDialogBase(KDialogBase::Plain, i18n("Import Birthdays From KAddressBook"), Ok|Cancel, Ok, parent, "BirthdayDlg"),
 	  mSpecialActionsButton(0)
 {
 	QWidget* topWidget = plainPage();
@@ -194,7 +194,7 @@
 	mBgColourChoose->setColour(Preferences::defaultBgColour());     // set colour before setting alarm type buttons
 	mLateCancel->setMinutes(Preferences::defaultLateCancel(), true, TimePeriod::DAYS);
 	mConfirmAck->setChecked(Preferences::defaultConfirmAck());
-	mSoundPicker->set(Preferences::defaultSound(), Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
+	mSoundPicker->set(Preferences::defaultSoundType(), Preferences::defaultSoundFile(),
 	                  Preferences::defaultSoundVolume(), -1, 0, Preferences::defaultSoundRepeat());
 	if (mSpecialActionsButton)
 		mSpecialActionsButton->setActions(Preferences::defaultPreAction(), Preferences::defaultPostAction());
@@ -352,11 +352,11 @@
 	config->writeEntry(QString::fromLatin1("BirthdaySuffix"), mSuffix->text());
 	config->sync();
 
-	mFlags = (mSoundPicker->beep()             ? KAEvent::BEEP : 0)
-	       | (mSoundPicker->repeat()           ? KAEvent::REPEAT_SOUND : 0)
-	       | (mConfirmAck->isChecked()         ? KAEvent::CONFIRM_ACK : 0)
-	       | (mFontColourButton->defaultFont() ? KAEvent::DEFAULT_FONT : 0)
-	       |                                     KAEvent::ANY_TIME;
+	mFlags = (mSoundPicker->sound() == SoundPicker::BEEP ? KAEvent::BEEP : 0)
+	       | (mSoundPicker->repeat()                     ? KAEvent::REPEAT_SOUND : 0)
+	       | (mConfirmAck->isChecked()                   ? KAEvent::CONFIRM_ACK : 0)
+	       | (mFontColourButton->defaultFont()           ? KAEvent::DEFAULT_FONT : 0)
+	       |                                               KAEvent::ANY_TIME;
 	KDialogBase::slotOk();
 }
 
Index: libemailfunctions/tests/testemail.cpp
===================================================================
--- libemailfunctions/tests/testemail.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libemailfunctions/tests/testemail.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -323,7 +323,7 @@
   // escape a quote to many to see if it makes it invalid
   checkIsValidEmailAddress( "\"testing, \\\"testing\\\" <matt@fruitsalad.org>", "UnbalancedQuote" );
 
-  // escape a parens and thus make a comma appear 
+  // escape a parens and thus make a comma appear
   checkIsValidEmailAddress( "Matt (jongel, fibbel\\\) <matt@fruitsalad.org>", "UnbalancedParens" );
 
   // several errors inside doublequotes
@@ -365,11 +365,12 @@
   checkIsValidEmailAddress( "|matt@fruitsalad.org", "AddressOk" );
   checkIsValidEmailAddress( "}matt@fruitsalad.org", "AddressOk" );
   checkIsValidEmailAddress( "~matt@fruitsalad.org", "AddressOk" );
+  checkIsValidEmailAddress( "matt%matt@fruitsalad.org", "AddressOk" );
 
   //bug 105405
   checkIsValidEmailAddress( "[foobar] <matt@fruitsalad.org>", "InvalidDisplayName" );
   checkIsValidEmailAddress( "matt \"[foobar]\" Douhan <matt@fruitsalad.org>", "AddressOk" );
- 
+
   checkIsValidEmailAddress( "Matt Douhan <matt\"@@\"fruitsalad.org>", "TooFewAts" );
 
 
Index: kaddressbook/xxport/samples/rfc2849.ldif
===================================================================
--- kaddressbook/xxport/samples/rfc2849.ldif	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kaddressbook/xxport/samples/rfc2849.ldif	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,148 +0,0 @@
-i# Examples of LDAP Data Interchange Format
-
-# Example 1: An simple LDAP file with two entries
-
-version: 1
-dn: cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Barbara Jensen
-cn: Barbara J Jensen
-cn: Babs Jensen
-sn: Jensen
-uid: bjensen
-telephonenumber: +1 408 555 1212
-description: A big sailing fan.
-
-dn: cn=Bjorn Jensen, ou=Accounting, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Bjorn Jensen
-sn: Jensen
-telephonenumber: +1 408 555 1212
-
-Example 2: A file containing an entry with a folded attribute value
-
-version: 1
-dn:cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass:top
-objectclass:person
-objectclass:organizationalPerson
-cn:Barbara Jensen
-cn:Barbara J Jensen
-cn:Babs Jensen
-sn:Jensen
-uid:bjensen
-telephonenumber:+1 408 555 1212
-description:Babs is a big sailing fan, and travels extensively in sea
- rch of perfect sailing conditions.
-title:Product Manager, Rod and Reel Division
-
-Example 3: A file containing a base-64-encoded value
-
-version: 1
-dn: cn=Gern Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Gern Jensen
-cn: Gern O Jensen
-sn: Jensen
-uid: gernj
-telephonenumber: +1 408 555 1212
-description:: V2hhdCBhIGNhcmVmdWwgcmVhZGVyIHlvdSBhcmUhICBUaGlzIHZhbHVl
-IGlzIGJhc2UtNjQtZW5jb2RlZCBiZWNhdXNlIGl0IGhhcyBhIGNvbnRyb2wgY2hhcmFjdG
-VyIGluIGl0IChhIENSKS4NICBCeSB0aGUgd2F5LCB5b3Ugc2hvdWxkIHJlYWxseSBnZXQg
-b3V0IG1vcmUu
-
-Example 4: A file containing an entries with UTF-8-encoded attribute
-values, including language tags.  Comments indicate the contents
-of UTF-8-encoded attributes and distinguished names.
-
-version: 1
-dn:: b3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: ou=<JapaneseOU>,o=Airius
-objectclass: top
-objectclass: organizationalUnit
-ou:: 5Za25qWt6YOo
-# ou:: <JapaneseOU>
-ou;lang-ja:: 5Za25qWt6YOo
-# ou;lang-ja:: <JapaneseOU>
-ou;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2
-
-# ou;lang-ja:: <JapaneseOU_in_phonetic_representation>
-ou;lang-en: Sales
-description: Japanese office
-
-dn:: dWlkPXJvZ2FzYXdhcmEsb3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: uid=<uid>,ou=<JapaneseOU>,o=Airius
-userpassword: {SHA}O3HSv1MusyL4kTjP+HKI5uxuNoM=
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-objectclass: inetOrgPerson
-uid: rogasawara
-mail: rogasawara@airius.co.jp
-givenname;lang-ja:: 44Ot44OJ44OL44O8
-# givenname;lang-ja:: <JapaneseGivenname>
-sn;lang-ja:: 5bCP56yg5Y6f
-# sn;lang-ja:: <JapaneseSn>
-cn;lang-ja:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn;lang-ja:: <JapaneseCn>
-title;lang-ja:: 5Za25qWt6YOoIOmDqOmVtw==
-# title;lang-ja:: <JapaneseTitle>
-preferredlanguage: ja
-givenname:: 44Ot44OJ44OL44O8
-# givenname:: <JapaneseGivenname>
-sn:: 5bCP56yg5Y6f
-# sn:: <JapaneseSn>
-cn:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn:: <JapaneseCn>
-title:: 5Za25qWt6YOoIOmDqOmVtw==
-# title:: <JapaneseTitle>
-givenname;lang-ja;phonetic:: 44KN44Gp44Gr44O8
-# givenname;lang-ja;phonetic::
-<JapaneseGivenname_in_phonetic_representation_kana>
-sn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJ
-# sn;lang-ja;phonetic:: <JapaneseSn_in_phonetic_representation_kana>
-cn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJIOOCjeOBqeOBq+ODvA==
-# cn;lang-ja;phonetic:: <JapaneseCn_in_phonetic_representation_kana>
-title;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2IOOBtuOBoeOCh+OBhg==
-# title;lang-ja;phonetic::
-# <JapaneseTitle_in_phonetic_representation_kana>
-givenname;lang-en: Rodney
-sn;lang-en: Ogasawara
-cn;lang-en: Rodney Ogasawara
-title;lang-en: Sales, Director
-
-Example 5: A file containing a reference to an external file
-
-version: 1
-dn: cn=Horatio Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Horatio Jensen
-
-cn: Horatio N Jensen
-sn: Jensen
-uid: hjensen
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/hjensen.jpg
-
-Example 6: A file containing a series of change records and comments
-
-version: 1
-# Add a new entry
-dn: cn=Fiona Jensen, ou=Marketing, dc=airius, dc=com
-changetype: add
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Fiona Jensen
-sn: Jensen
-uid: fiona
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/fiona.jpg
Index: kaddressbook/xxport/samples/rfc2849.txt
===================================================================
--- kaddressbook/xxport/samples/rfc2849.txt	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kaddressbook/xxport/samples/rfc2849.txt	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,787 +1 @@
-
-
-
-
-
-
-Network Working Group                                             G. Good
-Request for Comments: 2849                   iPlanet e-commerce Solutions
-Category: Standards Track                                       June 2000
-
-
-   The LDAP Data Interchange Format (LDIF) - Technical Specification
-
-Status of this Memo
-
-   This document specifies an Internet standards track protocol for the
-   Internet community, and requests discussion and suggestions for
-   improvements.  Please refer to the current edition of the "Internet
-   Official Protocol Standards" (STD 1) for the standardization state
-   and status of this protocol.  Distribution of this memo is unlimited.
-
-Copyright Notice
-
-   Copyright (C) The Internet Society (2000).  All Rights Reserved.
-
-Abstract
-
-   This document describes a file format suitable for describing
-   directory information or modifications made to directory information.
-   The file format, known as LDIF, for LDAP Data Interchange Format, is
-   typically used to import and export directory information between
-   LDAP-based directory servers, or to describe a set of changes which
-   are to be applied to a directory.
-
-Background and Intended Usage
-
-   There are a number of situations where a common interchange format is
-   desirable.  For example, one might wish to export a copy of the
-   contents of a directory server to a file, move that file to a
-   different machine, and import the contents into a second directory
-   server.
-
-   Additionally, by using a well-defined interchange format, development
-   of data import tools from legacy systems is facilitated.  A fairly
-   simple set of tools written in awk or perl can, for example, convert
-   a database of personnel information into an LDIF file. This file can
-   then be imported into a directory server, regardless of the internal
-   database representation the target directory server uses.
-
-   The LDIF format was originally developed and used in the University
-   of Michigan LDAP implementation.  The first use of LDIF was in
-   describing directory entries.  Later, the format was expanded to
-   allow representation of changes to directory entries.
-
-
-
-
-Good                        Standards Track                     [Page 1]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-   Relationship to the application/directory MIME content-type:
-
-   The application/directory MIME content-type [1] is a general
-   framework and format for conveying directory information, and is
-   independent of any particular directory service.  The LDIF format is
-   a simpler format which is perhaps easier to create, and may also be
-   used, as noted, to describe a set of changes to be applied to a
-   directory.
-
-   The key words "MUST", "MUST NOT", "MAY", "SHOULD", and "SHOULD NOT"
-   used in this document are to be interpreted as described in [7].
-
-Definition of the LDAP Data Interchange Format
-
-   The LDIF format is used to convey directory information, or a
-   description of a set of changes made to directory entries.  An LDIF
-   file consists of a series of records separated by line separators.  A
-   record consists of a sequence of lines describing a directory entry,
-   or a sequence of lines describing a set of changes to a directory
-   entry.  An LDIF file specifies a set of directory entries, or a set
-   of changes to be applied to directory entries, but not both.
-
-   There is a one-to-one correlation between LDAP operations that modify
-   the directory (add, delete, modify, and modrdn), and the types of
-   changerecords described below ("add", "delete", "modify", and
-   "modrdn" or "moddn").  This correspondence is intentional, and
-   permits a straightforward translation from LDIF changerecords to
-   protocol operations.
-
-Formal Syntax Definition of LDIF
-
-   The following definition uses the augmented Backus-Naur Form
-   specified in RFC 2234 [2].
-
-ldif-file                = ldif-content / ldif-changes
-
-ldif-content             = version-spec 1*(1*SEP ldif-attrval-record)
-
-ldif-changes             = version-spec 1*(1*SEP ldif-change-record)
-
-ldif-attrval-record      = dn-spec SEP 1*attrval-spec
-
-ldif-change-record       = dn-spec SEP *control changerecord
-
-version-spec             = "version:" FILL version-number
-
-
-
-
-
-
-Good                        Standards Track                     [Page 2]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-version-number           = 1*DIGIT
-                           ; version-number MUST be "1" for the
-                           ; LDIF format described in this document.
-
-dn-spec                  = "dn:" (FILL distinguishedName /
-                                  ":" FILL base64-distinguishedName)
-
-distinguishedName        = SAFE-STRING
-                           ; a distinguished name, as defined in [3]
-
-base64-distinguishedName = BASE64-UTF8-STRING
-                           ; a distinguishedName which has been base64
-                           ; encoded (see note 10, below)
-
-rdn                      = SAFE-STRING
-                           ; a relative distinguished name, defined as
-                           ; <name-component> in [3]
-
-base64-rdn               = BASE64-UTF8-STRING
-                           ; an rdn which has been base64 encoded (see
-                           ; note 10, below)
-
-control                  = "control:" FILL ldap-oid        ; controlType
-                           0*1(1*SPACE ("true" / "false")) ; criticality
-                           0*1(value-spec)                ; controlValue
-                           SEP
-                           ; (See note 9, below)
-
-ldap-oid                 = 1*DIGIT 0*1("." 1*DIGIT)
-                           ; An LDAPOID, as defined in [4]
-
-attrval-spec             = AttributeDescription value-spec SEP
-
-value-spec               = ":" (    FILL 0*1(SAFE-STRING) /
-                                ":" FILL (BASE64-STRING) /
-                                "<" FILL url)
-                           ; See notes 7 and 8, below
-
-url                      = <a Uniform Resource Locator,
-                            as defined in [6]>
-                                   ; (See Note 6, below)
-
-AttributeDescription     = AttributeType [";" options]
-                           ; Definition taken from [4]
-
-AttributeType            = ldap-oid / (ALPHA *(attr-type-chars))
-
-options                  = option / (option ";" options)
-
-
-
-Good                        Standards Track                     [Page 3]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-option                   = 1*opt-char
-
-attr-type-chars          = ALPHA / DIGIT / "-"
-
-opt-char                 = attr-type-chars
-
-changerecord             = "changetype:" FILL
-                           (change-add / change-delete /
-                            change-modify / change-moddn)
-
-change-add               = "add"                SEP 1*attrval-spec
-
-change-delete            = "delete"             SEP
-
-change-moddn             = ("modrdn" / "moddn") SEP
-                            "newrdn:" (    FILL rdn /
-                                       ":" FILL base64-rdn) SEP
-                            "deleteoldrdn:" FILL ("0" / "1")  SEP
-                            0*1("newsuperior:"
-                            (    FILL distinguishedName /
-                             ":" FILL base64-distinguishedName) SEP)
-
-change-modify            = "modify"             SEP *mod-spec
-
-mod-spec                 = ("add:" / "delete:" / "replace:")
-                           FILL AttributeDescription SEP
-                           *attrval-spec
-                           "-" SEP
-
-SPACE                    = %x20
-                           ; ASCII SP, space
-
-FILL                     = *SPACE
-
-SEP                      = (CR LF / LF)
-
-CR                       = %x0D
-                           ; ASCII CR, carriage return
-
-LF                       = %x0A
-                           ; ASCII LF, line feed
-
-ALPHA                    = %x41-5A / %x61-7A
-                           ; A-Z / a-z
-
-DIGIT                    = %x30-39
-                           ; 0-9
-
-
-
-
-Good                        Standards Track                     [Page 4]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-UTF8-1                   = %x80-BF
-
-UTF8-2                   = %xC0-DF UTF8-1
-
-UTF8-3                   = %xE0-EF 2UTF8-1
-
-UTF8-4                   = %xF0-F7 3UTF8-1
-
-UTF8-5                   = %xF8-FB 4UTF8-1
-
-UTF8-6                   = %xFC-FD 5UTF8-1
-
-SAFE-CHAR                = %x01-09 / %x0B-0C / %x0E-7F
-                           ; any value <= 127 decimal except NUL, LF,
-                           ; and CR
-
-SAFE-INIT-CHAR           = %x01-09 / %x0B-0C / %x0E-1F /
-                           %x21-39 / %x3B / %x3D-7F
-                           ; any value <= 127 except NUL, LF, CR,
-                           ; SPACE, colon (":", ASCII 58 decimal)
-                           ; and less-than ("<" , ASCII 60 decimal)
-
-SAFE-STRING              = [SAFE-INIT-CHAR *SAFE-CHAR]
-
-UTF8-CHAR                = SAFE-CHAR / UTF8-2 / UTF8-3 /
-                           UTF8-4 / UTF8-5 / UTF8-6
-
-UTF8-STRING              = *UTF8-CHAR
-
-BASE64-UTF8-STRING       = BASE64-STRING
-                           ; MUST be the base64 encoding of a
-                           ; UTF8-STRING
-
-BASE64-CHAR              = %x2B / %x2F / %x30-39 / %x3D / %x41-5A /
-                           %x61-7A
-                           ; +, /, 0-9, =, A-Z, and a-z
-                           ; as specified in [5]
-
-BASE64-STRING            = [*(BASE64-CHAR)]
-
-
-   Notes on LDIF Syntax
-
-      1)  For the LDIF format described in this document, the version
-          number MUST be "1". If the version number is absent,
-          implementations MAY choose to interpret the contents as an
-          older LDIF file format, supported by the University of
-          Michigan ldap-3.3 implementation [8].
-
-
-
-Good                        Standards Track                     [Page 5]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-      2)  Any non-empty line, including comment lines, in an LDIF file
-          MAY be folded by inserting a line separator (SEP) and a SPACE.
-          Folding MUST NOT occur before the first character of the line.
-          In other words, folding a line into two lines, the first of
-          which is empty, is not permitted. Any line that begins with a
-          single space MUST be treated as a continuation of the previous
-          (non-empty) line. When joining folded lines, exactly one space
-          character at the beginning of each continued line must be
-          discarded. Implementations SHOULD NOT fold lines in the middle
-          of a multi-byte UTF-8 character.
-
-      3)  Any line that begins with a pound-sign ("#", ASCII 35) is a
-          comment line, and MUST be ignored when parsing an LDIF file.
-
-      4)  Any dn or rdn that contains characters other than those
-          defined as "SAFE-UTF8-CHAR", or begins with a character other
-          than those defined as "SAFE-INIT-UTF8-CHAR", above, MUST be
-          base-64 encoded.  Other values MAY be base-64 encoded.  Any
-          value that contains characters other than those defined as
-          "SAFE-CHAR", or begins with a character other than those
-          defined as "SAFE-INIT-CHAR", above, MUST be base-64 encoded.
-          Other values MAY be base-64 encoded.
-
-      5)  When a zero-length attribute value is to be included directly
-          in an LDIF file, it MUST be represented as
-          AttributeDescription ":" FILL SEP.  For example, "seeAlso:"
-          followed by a newline represents a zero-length "seeAlso"
-          attribute value.  It is also permissible for the value
-          referred to by a URL to be of zero length.
-
-      6) When a URL is specified in an attrval-spec, the following
-          conventions apply:
-
-         a) Implementations SHOULD support the file:// URL format.  The
-            contents of the referenced file are to be included verbatim
-            in the interpreted output of the LDIF file.
-         b) Implementations MAY support other URL formats.  The
-            semantics associated with each supported URL will be
-            documented in an associated Applicability Statement.
-
-      7)  Distinguished names, relative distinguished names, and
-          attribute values of DirectoryString syntax MUST be valid UTF-8
-          strings.  Implementations that read LDIF MAY interpret files
-          in which these entities are stored in some other character set
-          encoding, but implementations MUST NOT generate LDIF content
-          which does not contain valid UTF-8 data.
-
-
-
-
-
-Good                        Standards Track                     [Page 6]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-      8)  Values or distinguished names that end with SPACE SHOULD be
-          base-64 encoded.
-
-      9)  When controls are included in an LDIF file, implementations
-          MAY choose to ignore some or all of them. This may be
-          necessary if the changes described in the LDIF file are being
-          sent on an LDAPv2 connection (LDAPv2 does not support
-          controls), or the particular controls are not supported by the
-          remote server. If the criticality of a control is "true", then
-          the implementation MUST either include the control, or MUST
-          NOT send the operation to a remote server.
-
-      10) When an attrval-spec, distinguishedName, or rdn is base64-
-          encoded, the encoding rules specified in [5] are used with the
-          following exceptions:  a) The requirement that base64 output
-          streams must be represented as lines of no more than 76
-          characters is removed. Lines in LDIF files may only be folded
-          according to the folding rules described in note 2, above.  b)
-          Base64 strings in [5] may contain characters other than those
-          defined in BASE64-CHAR, and are ignored. LDIF does not permit
-          any extraneous characters, other than those used for line
-          folding.
-
-Examples of LDAP Data Interchange Format
-
-Example 1: An simple LDAP file with two entries
-
-version: 1
-dn: cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Barbara Jensen
-cn: Barbara J Jensen
-cn: Babs Jensen
-sn: Jensen
-uid: bjensen
-telephonenumber: +1 408 555 1212
-description: A big sailing fan.
-
-dn: cn=Bjorn Jensen, ou=Accounting, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Bjorn Jensen
-sn: Jensen
-telephonenumber: +1 408 555 1212
-
-
-
-
-Good                        Standards Track                     [Page 7]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Example 2: A file containing an entry with a folded attribute value
-
-version: 1
-dn:cn=Barbara Jensen, ou=Product Development, dc=airius, dc=com
-objectclass:top
-objectclass:person
-objectclass:organizationalPerson
-cn:Barbara Jensen
-cn:Barbara J Jensen
-cn:Babs Jensen
-sn:Jensen
-uid:bjensen
-telephonenumber:+1 408 555 1212
-description:Babs is a big sailing fan, and travels extensively in sea
- rch of perfect sailing conditions.
-title:Product Manager, Rod and Reel Division
-
-Example 3: A file containing a base-64-encoded value
-
-version: 1
-dn: cn=Gern Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Gern Jensen
-cn: Gern O Jensen
-sn: Jensen
-uid: gernj
-telephonenumber: +1 408 555 1212
-description:: V2hhdCBhIGNhcmVmdWwgcmVhZGVyIHlvdSBhcmUhICBUaGlzIHZhbHVl
-IGlzIGJhc2UtNjQtZW5jb2RlZCBiZWNhdXNlIGl0IGhhcyBhIGNvbnRyb2wgY2hhcmFjdG
-VyIGluIGl0IChhIENSKS4NICBCeSB0aGUgd2F5LCB5b3Ugc2hvdWxkIHJlYWxseSBnZXQg
-b3V0IG1vcmUu
-
-Example 4: A file containing an entries with UTF-8-encoded attribute
-values, including language tags.  Comments indicate the contents
-of UTF-8-encoded attributes and distinguished names.
-
-version: 1
-dn:: b3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: ou=<JapaneseOU>,o=Airius
-objectclass: top
-objectclass: organizationalUnit
-ou:: 5Za25qWt6YOo
-# ou:: <JapaneseOU>
-ou;lang-ja:: 5Za25qWt6YOo
-# ou;lang-ja:: <JapaneseOU>
-ou;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2
-
-
-
-Good                        Standards Track                     [Page 8]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-# ou;lang-ja:: <JapaneseOU_in_phonetic_representation>
-ou;lang-en: Sales
-description: Japanese office
-
-dn:: dWlkPXJvZ2FzYXdhcmEsb3U95Za25qWt6YOoLG89QWlyaXVz
-# dn:: uid=<uid>,ou=<JapaneseOU>,o=Airius
-userpassword: {SHA}O3HSv1MusyL4kTjP+HKI5uxuNoM=
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-objectclass: inetOrgPerson
-uid: rogasawara
-mail: rogasawara@airius.co.jp
-givenname;lang-ja:: 44Ot44OJ44OL44O8
-# givenname;lang-ja:: <JapaneseGivenname>
-sn;lang-ja:: 5bCP56yg5Y6f
-# sn;lang-ja:: <JapaneseSn>
-cn;lang-ja:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn;lang-ja:: <JapaneseCn>
-title;lang-ja:: 5Za25qWt6YOoIOmDqOmVtw==
-# title;lang-ja:: <JapaneseTitle>
-preferredlanguage: ja
-givenname:: 44Ot44OJ44OL44O8
-# givenname:: <JapaneseGivenname>
-sn:: 5bCP56yg5Y6f
-# sn:: <JapaneseSn>
-cn:: 5bCP56yg5Y6fIOODreODieODi+ODvA==
-# cn:: <JapaneseCn>
-title:: 5Za25qWt6YOoIOmDqOmVtw==
-# title:: <JapaneseTitle>
-givenname;lang-ja;phonetic:: 44KN44Gp44Gr44O8
-# givenname;lang-ja;phonetic::
-<JapaneseGivenname_in_phonetic_representation_kana>
-sn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJ
-# sn;lang-ja;phonetic:: <JapaneseSn_in_phonetic_representation_kana>
-cn;lang-ja;phonetic:: 44GK44GM44GV44KP44KJIOOCjeOBqeOBq+ODvA==
-# cn;lang-ja;phonetic:: <JapaneseCn_in_phonetic_representation_kana>
-title;lang-ja;phonetic:: 44GI44GE44GO44KH44GG44G2IOOBtuOBoeOCh+OBhg==
-# title;lang-ja;phonetic::
-# <JapaneseTitle_in_phonetic_representation_kana>
-givenname;lang-en: Rodney
-sn;lang-en: Ogasawara
-cn;lang-en: Rodney Ogasawara
-title;lang-en: Sales, Director
-
-
-
-
-
-
-
-Good                        Standards Track                     [Page 9]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Example 5: A file containing a reference to an external file
-
-version: 1
-dn: cn=Horatio Jensen, ou=Product Testing, dc=airius, dc=com
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Horatio Jensen
-
-cn: Horatio N Jensen
-sn: Jensen
-uid: hjensen
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/hjensen.jpg
-
-Example 6: A file containing a series of change records and comments
-
-version: 1
-# Add a new entry
-dn: cn=Fiona Jensen, ou=Marketing, dc=airius, dc=com
-changetype: add
-objectclass: top
-objectclass: person
-objectclass: organizationalPerson
-cn: Fiona Jensen
-sn: Jensen
-uid: fiona
-telephonenumber: +1 408 555 1212
-jpegphoto:< file:///usr/local/directory/photos/fiona.jpg
-
-# Delete an existing entry
-dn: cn=Robert Jensen, ou=Marketing, dc=airius, dc=com
-changetype: delete
-
-# Modify an entry's relative distinguished name
-dn: cn=Paul Jensen, ou=Product Development, dc=airius, dc=com
-changetype: modrdn
-newrdn: cn=Paula Jensen
-deleteoldrdn: 1
-
-# Rename an entry and move all of its children to a new location in
-# the directory tree (only implemented by LDAPv3 servers).
-dn: ou=PD Accountants, ou=Product Development, dc=airius, dc=com
-changetype: modrdn
-newrdn: ou=Product Development Accountants
-deleteoldrdn: 0
-newsuperior: ou=Accounting, dc=airius, dc=com
-
-
-
-
-Good                        Standards Track                    [Page 10]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-# Modify an entry: add an additional value to the postaladdress
-# attribute, completely delete the description attribute, replace
-# the telephonenumber attribute with two values, and delete a specific
-# value from the facsimiletelephonenumber attribute
-dn: cn=Paula Jensen, ou=Product Development, dc=airius, dc=com
-changetype: modify
-add: postaladdress
-postaladdress: 123 Anystreet $ Sunnyvale, CA $ 94086
--
-
-delete: description
--
-replace: telephonenumber
-telephonenumber: +1 408 555 1234
-telephonenumber: +1 408 555 5678
--
-delete: facsimiletelephonenumber
-facsimiletelephonenumber: +1 408 555 9876
--
-
-# Modify an entry: replace the postaladdress attribute with an empty
-# set of values (which will cause the attribute to be removed), and
-# delete the entire description attribute. Note that the first will
-# always succeed, while the second will only succeed if at least
-# one value for the description attribute is present.
-dn: cn=Ingrid Jensen, ou=Product Support, dc=airius, dc=com
-changetype: modify
-replace: postaladdress
--
-delete: description
--
-
-Example 7: An LDIF file containing a change record with a control
-version: 1
-# Delete an entry. The operation will attach the LDAPv3
-# Tree Delete Control defined in [9]. The criticality
-# field is "true" and the controlValue field is
-# absent, as required by [9].
-dn: ou=Product Development, dc=airius, dc=com
-control: 1.2.840.113556.1.4.805 true
-changetype: delete
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 11]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Security Considerations
-
-   Given typical directory applications, an LDIF file is likely to
-   contain sensitive personal data.  Appropriate measures should be
-   taken to protect the privacy of those persons whose data is contained
-   in an LDIF file.
-
-   Since ":<" directives can cause external content to be included when
-   processing an LDIF file, one should be cautious of accepting LDIF
-   files from external sources.  A "trojan" LDIF file could name a file
-   with sensitive contents and cause it to be included in a directory
-   entry, which a hostile entity could read via LDAP.
-
-   LDIF does not provide any method for carrying authentication
-   information with an LDIF file.  Users of LDIF files must take care to
-   verify the integrity of an LDIF file received from an external
-   source.
-
-Acknowledgments
-
-   The LDAP Interchange Format was developed as part of the University
-   of Michigan LDAP reference implementation, and was developed by Tim
-   Howes, Mark Smith, and Gordon Good.  It is based in part upon work
-   supported by the National Science Foundation under Grant No.  NCR-
-   9416667.
-
-   Members of the IETF LDAP Extensions Working group provided many
-   helpful suggestions. In particular, Hallvard B. Furuseth of the
-   University of Oslo made many significant contributions to this
-   document, including a thorough review and rewrite of the BNF.
-
-References
-
-   [1]  Howes, T. and M. Smith, "A MIME Content-Type for Directory
-        Information", RFC 2425, September 1998.
-
-   [2]  Crocker, D., and P. Overell, "Augmented BNF for Syntax
-        Specifications: ABNF", RFC 2234, November 1997.
-
-   [3]  Wahl, M., Kille, S. and T. Howes, "A String Representation of
-        Distinguished Names", RFC 2253, December 1997.
-
-   [4]  Wahl, M., Howes, T. and S. Kille, "Lightweight Directory Access
-        Protocol (v3)", RFC 2251, July 1997.
-
-   [5]  Freed, N. and N. Borenstein, "Multipurpose Internet Mail
-        Extensions (MIME) Part One: Format of Internet Message Bodies",
-        RFC 2045, November 1996.
-
-
-
-Good                        Standards Track                    [Page 12]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-   [6]  Berners-Lee,  T., Masinter, L. and M. McCahill, "Uniform
-        Resource Locators (URL)", RFC 1738, December 1994.
-
-   [7]  Bradner, S., "Key Words for use in RFCs to Indicate Requirement
-        Levels", BCP 14, RFC 2119, March 1997.
-
-   [8]  The SLAPD and SLURPD Administrators Guide.  University of
-        Michigan, April 1996.  <URL:
-        http://www.umich.edu/~dirsvcs/ldap/doc/guides/slapd/toc.html>
-
-   [9]  M. P. Armijo, "Tree Delete Control", Work in Progress.
-
-Author's Address
-
-   Gordon Good
-   iPlanet e-commerce Solutions
-   150 Network Circle
-   Mailstop USCA17-201
-   Santa Clara, CA 95054, USA
-
-   Phone: +1 408 276 4351
-   EMail:  ggood@netscape.com
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 13]
-
-RFC 2849              LDAP Data Interchange Format             June 2000
-
-
-Full Copyright Statement
-
-   Copyright (C) The Internet Society (2000).  All Rights Reserved.
-
-   This document and translations of it may be copied and furnished to
-   others, and derivative works that comment on or otherwise explain it
-   or assist in its implementation may be prepared, copied, published
-   and distributed, in whole or in part, without restriction of any
-   kind, provided that the above copyright notice and this paragraph are
-   included on all such copies and derivative works.  However, this
-   document itself may not be modified in any way, such as by removing
-   the copyright notice or references to the Internet Society or other
-   Internet organizations, except as needed for the purpose of
-   developing Internet standards in which case the procedures for
-   copyrights defined in the Internet Standards process must be
-   followed, or as required to translate it into languages other than
-   English.
-
-   The limited permissions granted above are perpetual and will not be
-   revoked by the Internet Society or its successors or assigns.
-
-   This document and the information contained herein is provided on an
-   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
-   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
-   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION
-   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
-   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
-
-Acknowledgement
-
-   Funding for the RFC Editor function is currently provided by the
-   Internet Society.
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-Good                        Standards Track                    [Page 14]
-
+http://www.rfc-editor.org/rfc/rfc2849.txt
Index: kaddressbook/features/distributionlistwidget.cpp
===================================================================
--- kaddressbook/features/distributionlistwidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kaddressbook/features/distributionlistwidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -327,6 +327,7 @@
 #else
   KABC::DistributionList *list = mManager->list( oldName );
   list->setName( newName );
+  mManager->save();
   updateNameCombo();
 #endif
 
Index: libkholidays/holidays/holiday_se
===================================================================
--- libkholidays/holidays/holiday_se	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkholidays/holidays/holiday_se	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,22 +1,28 @@
 :
-: Swedish holiday file. Copy to ~/.holiday for private changes or tip
-: wedberg@mednet.gu.se if things are missing.
+: Swedish holiday file.
 :
 weekend "Nyårsdagen" weekend on 1.1
 black "Trett.d.afton" black on 5.1
 weekend "Trett.d. Jul" weekend on 6.1
 black "Alla hjärtans dag" on 14.2
+black "Fettisdagen" on easter minus 47 days
+black "Askonsdagen" on easter minus 46 days
 blue "Sommartid" on last sunday in march
+black "Skärtorsdagen" black on easter minus 3
+weekend "Långfredagen" weekend on easter minus 2
 black "Påskafton" black on easter minus 1
 weekend "Påskdagen" weekend on easter
-weekend "Långfredagen" weekend on easter minus 2
 weekend "Annandag påsk" weekend on easter plus 1
-black "Pingstafton" black on easter plus 48 days 
-weekend "Pingstdagen" weekend on easter plus 49 days 
-weekend "Annandag Pingst" weekend on easter plus 50 days 
+black "Pingstafton" black on easter plus 48 days
+weekend "Pingstdagen" weekend on easter plus 49 days
+:Before 2005
+:weekend "Annandag Pingst" weekend on easter plus 50 days
+black "Annandag Pingst" black on easter plus 50 days
 weekend "Kristi Him.f." weekend on easter plus 39 days
 weekend "Första Maj" weekend on 1.5
-black "Nationaldagen" black on 6.6
+:Before 2005
+:black "Nationaldagen" black on 6.6
+weekend "Nationaldagen" weekend on 6.6
 black "Midsommarafton" black on friday before 26.6
 weekend "Midsommardagen" weekend on saturday before 27.6
 blue "Vintertid" on last sunday in october
Index: libkholidays/holidays/holiday_gr
===================================================================
--- libkholidays/holidays/holiday_gr	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ libkholidays/holidays/holiday_gr	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -0,0 +1,309 @@
+:
+: Greek holiday file.
+:
+: Author: capthookb (praktoreio2002@yahoo.gr)
+:
+: "weekend" or "red" indicate a "proper" holiday (i.e. you do not work)
+:  Other colours (black, green, yellow, blue, magenta, cyan, white)
+: can be used to distinguish between minor anniversaries or not-so-real
+: holidays, when you go working anyway.
+: "small" holidays are not as "invasive" in the month view in KOrganizer,
+: and do not take as much space.
+
+: Ονομαστικές εορτές
+
+small black "Βασίλης, Βασιλική, Βασιλεία, Βίβιαν" on 1.1
+small black "Συλβέστρος" on 2.1
+small black "Θεώνη" on 5.1
+small black "Άγια Θεοφάνεια (Αργία)" on 6.1
+small black "Φώτης, Φωτεινή, Θεοφάνης, Θεοφανία, Φανή, Ιορδάνης, Θεανώ, Ουρανία, Θεοπούλα" on 6.1
+small black "Ιωάννης, Ιωάννα, Πρόδρομος" on 7.1
+small black "Αγάθων, Δομινίκη, Παρθένα, Κύρος" on 8.1
+small black "Θεοδόσης, Θεοδοσία" on 11.1
+small black "Τατιάνα, Τατιανή" on 12.1
+small black "Αντώνης, Αντωνία" on 17.1
+small black "Αθανάσιος, Αθανασία, Κύριλλος" on 18.1
+small black "Μακάριος" on 19.1
+small black "Ευθύμης, Ευθυμία, Φαβιανός" on 20.1
+small black "Αγνή, Μάξιμος, Νεόφυτος, Πάτροκλος" on 21.1
+small black "Τιμόθεος, Αναστάσιος, Αναστασία" on 22.1
+small black "Αγαθάγγελος" on 23.1
+small black "Ξένη, Φίλωνας, Ζωσιμάς" on 24.1
+small black "Γρηγόρης, Γρηγορία, Μαργαρίτα" on 25.1
+small black "Ξενοφών" on 26.1
+small black "Χάρις, Παλλάδιος" on 28.1
+small black "Μαύρος, Χρυσή, Τριών Ιεραρχών (Σχολική Αργία)" on 30.1
+small black "Ευδοξία, Κύρος" on 31.1
+small black "Τρύφωνας" on 1.2
+small black "Υπαπαντή" on 2.2
+small black "Σταμάτ-ης/ία, Συμεώ-ν/νή, Σιμώνη, Ασημάκης, Ασημίνα, Μαλαματή" on 3.2
+small black "Ισίδωρος, Ιάσιμος, Ιασίμη" on 4.2
+small black "Αγαθή" on 5.2
+small black "Φώτης" on 6.2
+small black "Παρθένιος, Παρθενία" on 7.2
+small black "Ζαχαρίας, Ζαχαρούλα" on 8.2
+small black "Μάρκελος, Νικηφόρος, Νίκη" on 9.2
+small black "Χαράλαμπος, Χαραλαμπία, Χαρίκλεια, Χαρίλαος, Χαρούλα" on 10.2
+small black "Βλάσης, Βλασία, Θοδωρής, Θοδώρα, Αυγή " on 11.2
+small black "Μελέτης, Πλωτίνος" on 12.2
+small black "Πρίσκιλλα" on 13.2
+small black "Βαλεντίνος, Βαλεντίνη, Παγκόσμια Ημέρα Ερωτευμένων" on 14.2
+small black "Ευσέβιος, Ευσεβία" on 15.2
+small black "Πάμφιλος, Παμφίλη, Σέλευκος, Σελεύκη" on 16.2
+small black "Λέων, Αγαπητός" on 18.2
+small black "Φιλοθέη, Χλόη" on 19.2
+small black "Ανθούσα" on 22.2
+small black "Πολύκαρπος" on 23.2
+small black "Πορφύρης, Φωτεινή" on 26.2
+small black "Μαριάννα, Ασκληπιός" on 28.2
+small black "Ευδοκία, Χαρίσιος" on 1.3
+small black "Ευθαλία" on 2.3
+small black "Κλεόνικος, Κλεονίκη" on 3.3
+small black "Αρχέλαος, Eυλόγιος" on 5.3
+small black "Ησύχιος" on 6.3
+small black "Ευγένιος, Ευγενία" on 7.3
+small black "Ερμής, Θεοφύλακτος, Παγκόσμια Ημέρα της Γυναίκας" on 8.3
+small black "Σμάραγδος, Σμαράγδα, Ηλιάνα, Λεόντιος, Λεοντία, Λυσίμαχος Λυσιμαχη" on 9.3
+small black "Ξάνθος, Ξανθούλα, Σαράντης Σαραντούλα, Φιλοκτήμων" on 9.3
+small black "Θεόδωρος Θεοδώρα, Θώδος, Θώδη, Θαλλής, Θάλεια, Σωφρόνιος, Σωφρονία" on 11.3
+small black "Λωξάντρα, Ρωξάνη, Oρθοδόξης," on 12.3
+small black "Λέανδρος" on 13.3
+small black "Βενέδικτος, Βενεδίκτη" on 14.3
+small black "Αγάπιος" on 15.3
+small black "Χριστόδουλος, Ιουλιανός" on 16.3
+small black "Αλέξιος, Αλεξία" on 17.3
+small black "Χρύσανθος, Χρυσάνθη" on 19.3
+small black "Δρόσος, Δροσούλα" on 22.3
+small black "Ευαγγελισμός της Θεοτόκου " on 25.3
+small black "Ευάγγελος, Ευαγγελία" on 25.3
+small black "Πούλιος, Σύλας, Σύλια" on 26.3
+small black "Λυδία, Μακεδόνιος, Μακεδονούλα" on 27.3
+small black "Ευτύχιος, Ευτυχία" on 6.4
+small black "Ιωσήφ, Ιωσηφίνα" on 9.4
+small black "Δημοσθένης, Ηρακλής, Μιλτιάδης, Περικλής, Σοφοκλής, Επαμεινώνδας" on 10.4
+small black "Όμηρος, Πελοπίδας, Παρμενίων, Πολύβιος, Αναξιμένης, Φοιλοποίμην, Φίλης" on 10.4
+small black "Αρίσταρχος, Θωμαΐς" on 14.4
+small black "Λεωνίδας, Λάζαρος" on 15.4
+small black "Βάϊος, Βάϊα, Δάφνη, Γαλήνη, Χιονία" on 16.4
+small black "Ναθαναήλ, Νέαρχος, Νιάρχος" on 22.4
+small black "Αναστάσιος, Αναστασία, Λάμπρος, Λαμπρινή, Πασχάλης " on 23.4
+small black "Γεώργιος, Γεωργία, Ελισάβετ, Αχιλλέας" on 24.4
+small black "Μάρκος, Νίκη, Ραφαήλ" on 25.4
+small black "Ζωή, Πηγή" on 28.4
+small black "Ιάσωνας" on 29.4
+small black "Ιάκωβος, Θωμάς, Θωμαή, Ασημίνα" on 30.4
+weekend "Ιερεμίας" on 1.5
+small black "Έσπερος, Εσπέρια" on 2.5
+small black "Ροδόπη" on 3.5
+small black "Ειρήνη, Eιρηναίος, Ευφραίμ" on 5.5
+small black "Μυροφόρα" on 7.5
+small black "Θεολόγος" on 8.5
+small black "Χριστόφορος, Ησαΐας" on 9.5
+small black "Σίμων" on 10.5
+small black "Aρμόδιος,Μεθόδιος, Ολυμπία" on 11.5
+small black "Επιφάνειος" on 12.5
+small black "Γλυκερία" on 13.5
+small black "Γιορτή της Μητέρας, Αριστοτέλης" on 14.5
+small black "Καλή" on 15.5
+small black "Ανδρόνικος, Ανδρονίκη, Ιουνία" on 17.5
+small black "Ιουλία, Γαλάτεια" on 18.5
+small black "Θεόκτιστος, Μαγδαληνή, Πατρίκιος" on 19.5
+small black "Λυδία" on 20.5
+small black "Κωνσταντίνος, Κωνσταντίνα, Ελένη" on 21.5
+small black "Αιμίλιος, Αιμιλία, Έμυ" on 22.5
+small black "Μαρκιανή" on 24.5
+small black "Θεοδοσία" on 29.5
+small black "Πύρρος, Νεφέλη, Ιουστίνος, Ανάληψη" on 1.6
+small black "Νικηφόρος, Μαρίνος" on 2.6
+small black "Υπάτιος, Υπατία" on 3.6
+small black "Μάρθα" on 4.6
+small black "Aπόλλων, Δωρόθεος, Δωροθέα, Σελήνη, Νίκανδρος" on 5.6
+small black "Καλλιόπη" on 8.6
+small black "Ροδάνθη" on 9.6
+small black "Βαρθολομαίος, Βαρνάβας" on 11.6
+small black "Ονούφριος, Ζήνων,Κορίνα, Αγίου Πνεύματος" on 12.6
+small black "Ελισαίος" on 14.6
+small black "Αυγουστίνος, Αυγούστα, Ιερώνυμος, Μόνικα, Ορτανσία" on 15.6
+small black "Γιορτή του πατέρα" on 16.6
+small black "Έρασμος, Ερασμία, Aγίων Πάντων" on 18.6
+small black "Παΐσιος, Ζωσιμάς, Ζήσης" on 19.6
+small black "Ευσέβιος, Ευσεβία" on 22.6
+small black "Αριστοκλής" on 23.6
+small black "Φεβρωνία, Έρωτας" on 25.6
+small black "Γερμανός" on 28.6
+small black "Πέτρος, Πέτρα, Παύλος, Παυλίνα" on 29.6
+small black "Απόστολος, Αποστολία, Μελίτων" on 30.6
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.7
+small black "Υάκινθος, Ζουμπουλία" on 3.7
+small black "Λουκία" on 4.7
+small black "Λυκίας, Λύκιος, Λυκία, " on 6.7
+small black "Κυριακή" on 7.7
+small black "Θεόφιλος, Προκόπιος" on 8.7
+small black "Ευφημία, Όλγα" on 11.7
+small black "Βερονίκη, Βερενίκη " on 12.7
+small black "Σάρα" on 13.7
+small black "Ακύλας, Νικόδημος" on 14.7
+small black "Βλαδίμηρος, Ιουλίττα, Κήρυκος" on 15.7
+small black "Μαρίνα" on 17.7
+small black "Αιμίλιος, Αιμιλία" on 18.7
+small black "Ηλίας, Ηλιάνα" on 20.7
+small black "Μαγδαληνή, Μαρκέλλα, Μαριλένα" on 22.7
+small black "Φωκάς" on 23.7
+small black "Αθηναγόρας" on 24.7
+small black "Άννα, Ολυμπία" on 25.7
+small black "Παρασκευή, Παρασκευάς, Έρση" on 26.7
+small black "Παντελής" on 27.7
+small black "Ειρήνη, Χρυσοβαλάντης, Βαλάντης, Χρυσοβαλάντου, Ακάκιος" on 28.7
+small black "Καλλίνικος" on 29.7
+small black "Ανδρόνικος, Ανδρονίκη" on 30.7
+small black "Ιωσήφ, Ιωσηφίνα" on 31.7
+small black "Μάρκελος" on 1.8
+small black "Σωτήρης, Σωτηρία, Ευμορφία, Έμμυ, Μορφούλα" on 6.8
+small black "Αστέριος, Αστερία" on 7.8
+small black "Τριαντάφυλλος, Τριανταφυλλιά" on 8.8
+small black "Ρωμανός" on 9.8
+small black "Λαυρέντης, Λαυρεντία, Ευλαμπία, Ιππόλυτος, Ηρώ " on 10.8
+weekend "Κοίμηση της Θεοτόκου (Αργία)" on 15.8
+weekend "Μαρία, Μάριος, Παναγιώτης, Παναγιώτα, Δέσποινα, Θεοτόκης" on 15.8
+small black "Γεράσιμος, Αλκιβιάδης, Διομήδης, Σαράντης" on 16.8
+small black "Λευκοθέα, Μύρων, Μίρκα" on 17.8
+small black "Φλώρα" on 18.8
+small black "Σαμουήλ, Θεοχάρης" on 20.8
+small black "Aγαθόνικος" on 22.8
+small black "Κοσμάς" on 24.8
+small black "Βαρθολομαίος, Τίτος" on 25.8
+small black "Ναταλία, Ανδριανός, Ανδριανή" on 26.8
+small black "Φανούριος, Φανουρία, Αρκαδία" on 27.8
+small black "Θεοπίστη" on 29.8
+small black "Αλέξανδρος" on 30.8
+small black "Αδαμάντιος, Αδαμαντία, Αθηνά, Αντιγόνη, Ασπασία, Αφροδίτη, Δωδώνη" on 1.9
+small black "Ελπινίκη, Ερασμία, Ερατώ, Ευτέρπη, Θάλεια, Θεανώ, Καλλίστη, Κλειώ, Κλεονίκη" on 1.9
+small black "Κλεοπάτρα, Κοραλία, Μαργαρίτα, Μαριάνθη, Μελέτιος, Μελπομένη, Ουρανία" on 1.9
+small black "Πανδώρα, Πηνελόπη, Πολυμνία, Πολυνίκη, Σαπφώ, Συμεών, Τερψιχόρη, Χάιδω" on 1.9
+small black "Άνθιμος, Πολύδωρος, Φοίβη" on 3.9
+small black "Ερμιόνη, Μωυσής" on 4.9
+small black "Ζαχαρίας" on 5.9
+small black "Κασσιανή, Σώζων" on 7.9
+small black "Ιωακείμ" on 9.9
+small black "Εράστη, Εράστος, Μητροδώρα, Πουλχερία" on 10.9
+small black "Ευανθία" on 11.9
+small black "Αριστείδης, Κορνήλιος" on 13.9
+small black "Σταύρος, Σταυρούλα" on 14.9
+small black "Νικήτας, Βησσαρίων" on 15.9
+small black "Ευφημία" on 16.9
+small black "Σοφία, Ελπίδα, Αγάπη, Πίστη, Σόνια" on 17.9
+small black "Αριάδνη" on 18.9
+small black "Ευστάθιος, Ευσταθία" on 20.9
+small black "Ίωνας" on 21.9
+small black "Φωκάς, Ζωγραφιά" on 22.9
+small black "Πολυξένη, Ξανθίππη, Ξάνθιππος" on 23.9
+small black "Θέκλα, Μυρσίνη, Μυρτώ" on 24.9
+small black "Ευφροσύνη" on 25.9
+small black "Ζήνων" on 27.9
+small black "Κυριάκος, Κυριακή" on 29.9
+small black "Θηρεσία" on 1.10
+small black "Κυπριανός" on 2.10
+small black "Διονύσης, Διονυσία" on 3.10
+small black "Ιερόθεος, Φραγκίσκος" on 4.10
+small black "Χαριτινή" on 5.10
+small black "Σέργιος, Πολυχρόνης, Χρόνης" on 7.10
+small black "Πελαγία" on 8.10
+small black "Ευλάμπιος, Ευλαμπία" on 10.10
+small black "Ανδρομάχη, Ανδρόμαχος" on 12.10
+small black "Αγαθονίκη, Φλωρέντιος, Φλωρεντία" on 13.10
+small black "Λουκιανός" on 15.10
+small black "Λουκάς" on 18.10
+small black "Γεράσιμος, Αρτέμιος" on 20.10
+small black "Σωκράτης, Χριστόδουλος, Όυρσουλα" on 21.10
+small black "Αβέρκιος" on 22.10
+small black "Ιάκωβος" on 23.10
+small black "Χρυσάφης" on 25.10
+small black "Δημήτριος, Δήμητρα, Δανάη" on 26.10
+small black "Νέστορας" on 27.10
+small black "Ζηνοβία, Κλεόπας, Μαρκιανός" on 30.10
+small black "Αριστόβουλος" on 31.10
+small black "Αργύρης, Αργυρώ, Κοσμάς, Δαμιανός, Ανάργυρος" on 1.11
+small black "Αφθόνιος, Αφθονία" on 2.11
+small black "Ιωαννίκη" on 4.11
+small black "Λίνος" on 5.11
+small black "Λεονάρδος" on 6.11
+small black "Αθηνόδωρος" on 7.11
+small black "Σταμάτιος, Σταματία, Μιχάλης, Γαβριήλ, Γαβριέλα" on 8.11
+small black "Ταξιάρχης, Άγγελος, Αγγελική, Ματίνα, Σεραφείμ" on 8.11
+small black "Νεκτάριος, Νεκταρία" on 9.11
+small black "Ορέστης" on 10.11
+small black "Μηνάς, Mήνα, Βίκτωρ, Βικτωρία" on 11.11
+small black "Χρυσόστομος" on 13.11
+small black "Φίλιππος" on 14.11
+small black "Ματθαίος, Ιφιγένεια" on 16.11
+small black "Πλάτωνας" on 18.11
+small black "Μαρία, Μάριος" on 21.11
+small black "Φιλήμων" on 22.11
+small black "Μερώπη" on 23.11
+small black "Κατερίνα, Μερκούριος" on 25.11
+small black "Στέλιος, Στέλλα, Στέργιος" on 26.11
+small black "Φαίδρα" on 29.11
+small black "Ανδρέας, Ανδριάνα" on 30.11
+small black "Θεόκλητος, Ιακώβ" on 1.12
+small black "Βαρβάρα, Δαμασκηνός" on 4.12
+small black "Σάββας, Σαββούλα, Διογένης" on 5.12
+small black "Νίκος, Νικολέττα" on 6.12
+small black "Αμβρόσιος" on 7.12
+small black "Άννα" on 9.12
+small black "Ααρών, Αδάμ, Δαυίδ, Δανάη, Εύα, Ισαάκ, Ιώβ, Ραχήλ, Ρουμπίνη" on 11.12
+small black "Σπύρος, Σπυριδούλα" on 12.12
+small black "Ευστράτιος, Λουκάς, Λουκία, Άρης" on 13.12
+small black "Ελευθέριος, Ελευθερία, Ανθή, Σύλβια" on 15.12
+small black "Διονύσης, Διονυσία, Δανιήλ, Ρεβέκα, Σεβαστιανός, Σεβαστή" on 17.12
+small black "Ααρών, Αδάμ, Ισαάκ, Ραχήλ, Σάρα" on 17.12
+small black "Αγλαΐα" on 19.12
+small black "Ιγνάτιος" on 20.12
+small black "Θεμιστοκλής, Ιουλία" on 21.12
+small black "Αναστασία" on 22.12
+small black "Ευγένιος, Ευγενία" on 24.12
+small black "Χρήστος, Χριστίνα, Χρύσα" on 25.12
+weekend "Σύναξις Θεοτόκου (Αργία)" on 26.12
+weekend "Μανώλης, Εμμανουέλα, Δαβίδ" on 26.12
+small black "Στέφανος, Στεφανία" on 27.12
+small black "Δόμνα" on 28.12
+small black "Ιωσήφ" on 30.12
+weekend "Χριστούγεννα (Αργία)" on 25.12
+
+
+: Αργίες - Επέτειοι
+weekend "Πρωτοχρονιά (Αργία)" on 1.1
+weekend "Πρωτομαγιά (Αργία)" on 1.5
+weekend "Επέτειος του ΟΧΙ (Αργία)" 28.10
+weekend "Επέτειος της επανάστασης του 1821 (Αργία)" on 25.3
+small black "Εξέγερση του Πολυτεχνείου (Σχολική Αργία)" on 17.11
+
+: Κινητές εορτές
+
+small black "Τελώνου και Φαρισαίου - Αρχή Τριωδίου" on easter minus 70 days
+small black "Του Ασώτου" on easter minus 63 days
+small black "Τσικνοπέμπτη" on easter minus 59 days
+small black "Κυριακή των Απόκρεω" on easter minus 56 days
+small black "Τυροφάγου" on easter minus 49 days
+small black "Καθαρή Δευτέρα (Αργία)" on easter minus 48 days
+small black "Θεόδωρος, Θεοδώρα, Δώρα, Θώδης, Θώδος, Δώρης" on easter minus 43 days
+small black "Κυριακή της Ορθοδοξίας" on easter minus 42 days
+small black "Σάββατο του Λαζάρου" on easter minus 8 days
+small black "Κυριακή των Βαΐων" on easter minus 7 days
+small black "Μεγάλη Δευτέρα" on easter minus 6 days
+small black "Μεγάλη Τρίτη" on easter minus 5 days
+small black "Μεγάλη Τετάρτη" on easter minus 4 days
+small black "Μεγάλη Πέμπτη" on easter minus 3 days
+weekend "Μεγάλη Παρασκευή (Αργία)" on easter minus 2 days
+weekend "Μεγάλο Σάββατο" on easter minus 1 days
+weekend "Το Άγιον Πάσχα" on easter
+weekend "Δευτέρα του Πάσχα (Αργία)" on easter plus 1 days
+small black "Πηγή, Ζήσης, Ζησούλα, Ζήσιμος, Ζωή, Ζώης" on easter plus 5 days
+small black "Του Θωμά" on easter plus 7 days
+small black "Ανάληψη του Χριστού" on easter plus 39 days
+small black "Πεντηκοστή" on easter plus 49 days
+small black "Αγ. Πνεύματος" on easter plus 50 days
+small black "Αγ. Πάντων" on easter plus 56 days
+
+: Αλλαγή ώρας
+small black "Αλλαγή ώρας (1 ώρα πίσω)" on last sunday in october
+small black "Αλλαγή ώρας (1 ώρα μπροστά) " on last sunday in march
Index: libkholidays/holidays/Makefile.am
===================================================================
--- libkholidays/holidays/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkholidays/holidays/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,13 +5,13 @@
                 holiday_ca holiday_catalan holiday_co \
                 holiday_ch holiday_cz holiday_de holiday_dk holiday_ee \
                 holiday_es holiday_fi holiday_fr holiday_frswiss holiday_gb \
-                holiday_gt \
+                holiday_gr holiday_gt \
                 holiday_hu holiday_is holiday_il holiday_it holiday_ja \
                 holiday_lt holiday_mx \
                 holiday_nl \
                 holiday_no holiday_nz holiday_pl holiday_pt holiday_py \
                 holiday_quebec \
-                holiday_ro holiday_ru \ 
+                holiday_ro holiday_ru \
 		holiday_se holiday_si holiday_th holiday_us \
                 holiday_uy holiday_ie \
                 holiday_Suedtirol
Index: plugins/kmail/bodypartformatter/text_calendar.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_calendar.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ plugins/kmail/bodypartformatter/text_calendar.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -39,7 +39,7 @@
 Comment[es]=Un accesorio de formato para el cuerpo de text/calendar
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/calendar)
 Comment[eu]=Testu/egutegientzako gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/تقویم
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/تقویم
 Comment[fi]=Muokkausliitännäinen text/calendar-muodolle
 Comment[fr]=Module de formatage pour le text/calendar
 Comment[hu]=Formázómodul text/calendar adatfolyamok kezeléséhez
Index: plugins/kmail/bodypartformatter/text_vcard.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_vcard.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ plugins/kmail/bodypartformatter/text_vcard.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -40,7 +40,7 @@
 Comment[es]=Un accesorio de formato para el cuerpo de text/vcard
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/vcard)
 Comment[eu]=Testu/vcard-en gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/vcard
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/vcard
 Comment[fi]=Muokkausliitännäinen text/vcard-muodolle
 Comment[fr]=Un formateur de partie de corps pour text/vcard
 Comment[hu]=Formázómodul text/vcard adatfolyamok kezeléséhez
Index: plugins/kmail/bodypartformatter/text_xdiff.desktop
===================================================================
--- plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ plugins/kmail/bodypartformatter/text_xdiff.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -38,7 +38,7 @@
 Comment[es]=Una extensión de formato para el cuerpo de text/x-diff
 Comment[et]=Põhiosa vormindamisplugin (MIME tüübile text/x-diff)
 Comment[eu]=Testu/x-diff-en gorputz-zati formateatzaile bat
-Comment[fa]=یک وصلۀ قالب دهندۀ بخش بدنه برای متن/x-diff
+Comment[fa]=یک وصلۀ قالب دهندۀ جزء بدنه برای متن/x-diff
 Comment[fi]=Muokkausliitännäinen text/x-diff-muodolle
 Comment[fr]=Un formateur de partie de corps pour text/x-diff
 Comment[hu]=Formázómodul text/x-diff adatok kezeléséhez
Index: kitchensync/libkonnector2/filters/calendarfilter.desktop
===================================================================
--- kitchensync/libkonnector2/filters/calendarfilter.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kitchensync/libkonnector2/filters/calendarfilter.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -63,7 +63,7 @@
 Comment[he]=מסנן אירועים ומטלות בלוח השנה
 Comment[hu]=Szűrő a naptár eseményeihez és feladataihoz
 Comment[is]=Síar atburði og verkþætti í dagatali
-Comment[it]=Fltra gli eventi e le cose da fare in un calendario
+Comment[it]=Filtra gli eventi e le cose da fare in un calendario
 Comment[ja]=カレンダーのイベントとTo-doをフィルタ
 Comment[km]=ត្រង​ព្រឹត្តិការណ៍ និង ការងារ​ត្រូវ​ធ្វើ នៅ​ក្នុង​ប្រតិទិន​មួយ
 Comment[lt]=Filtruoja įvykius ir užduotis kalendoriuje
Index: libkdepim/addresseelineedit.h
===================================================================
--- libkdepim/addresseelineedit.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkdepim/addresseelineedit.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -35,7 +35,7 @@
 #include <kabc/addressee.h>
 
 #include "clicklineedit.h"
-#include "kcompletion.h"
+#include "kmailcompletion.h"
 #include <dcopobject.h>
 #include <kdepimmacros.h>
 
@@ -108,6 +108,7 @@
   private slots:
     void slotCompletion();
     void slotPopupCompletion( const QString& );
+    void slotReturnPressed( const QString& );
     void slotStartLDAPLookup();
     void slotLDAPSearchData( const KPIM::LdapResultList& );
     void slotEditCompletionOrder();
@@ -120,9 +121,10 @@
     void stopLDAPLookup();
 
     void setCompletedItems( const QStringList& items, bool autoSuggest );
-    void addCompletionItem( const QString& string, int weight, int source );
+    void addCompletionItem( const QString& string, int weight, int source, const QStringList * keyWords=0 );
     QString completionSearchText( QString& );
     const QStringList getAdjustedCompletionItems( bool fullSearch );
+    void updateSearchString();
 
     QString m_previousAddresses;
     QString m_searchString;
@@ -130,11 +132,13 @@
     bool m_completionInitialized;
     bool m_smartPaste;
     bool m_addressBookConnected;
+    bool m_lastSearchMode;
+    bool m_searchExtended; //has \" been added?
 
     //QMap<QString, KABC::Addressee> m_contactMap;
 
     static bool s_addressesDirty;
-    static KCompletion *s_completion;
+    static KMailCompletion *s_completion;
     static CompletionItemsMap* s_completionItemMap;
     static QTimer *s_LDAPTimer;
     static KPIM::LdapSearch *s_LDAPSearch;
@@ -144,6 +148,20 @@
 
     class AddresseeLineEditPrivate;
     AddresseeLineEditPrivate *d;
+
+    //until MenuID moves into protected in KLineEdit, we keep a copy here
+    //Constants that represent the ID's of the popup menu.
+      enum MenuID
+      {
+        Default = 42,
+        NoCompletion,
+        AutoCompletion,
+        ShellCompletion,
+        PopupCompletion,
+        ShortAutoCompletion,
+        PopupAutoCompletion
+      };
+
 };
 
 }
Index: libkdepim/categoryeditdialog.cpp
===================================================================
--- libkdepim/categoryeditdialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkdepim/categoryeditdialog.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -76,6 +76,7 @@
   }
   mWidget->mButtonRemove->setEnabled( categoriesExist );
   mWidget->mCategories->setSelected( mWidget->mCategories->firstChild(), true );
+  mWidget->mEdit->setText( mWidget->mCategories->currentItem()->text( 0 ) );
 }
 
 void CategoryEditDialog::slotTextChanged(const QString &text)
Index: libkdepim/kmailcompletion.h
===================================================================
--- libkdepim/kmailcompletion.h	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ libkdepim/kmailcompletion.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -0,0 +1,78 @@
+/*
+    This file is part of libkdepim.
+
+    Copyright (c) 2006 Christian Schaarschmidt <schaarsc@gmx.de>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#ifndef KPIM_KMAILCOMPLETION_H
+#define KPIM_KMAILCOMPLETION_H
+
+#include <qmap.h>
+#include <qstringlist.h>
+#include "kcompletion.h"
+
+
+namespace KPIM {
+
+/**
+ * KMailCompletion allows lookup of email addresses by keyword.
+ * Typically a keywods would be firstname, lastname, nickname or domain. 
+ */
+class KMailCompletion : public KCompletion
+{
+  Q_OBJECT
+
+  public:
+    KMailCompletion();
+
+    /**
+     * Clears internal keyword map and calls KCompletion::clear.
+     */
+    virtual void clear();
+
+    /**
+     * Uses KCompletion::makeCompletion to find email addresses which starts with string.
+     * ignores keywords.
+     *
+     * @returns email address
+     */
+    QString makeCompletion( const QString &string );
+
+    /**
+     * Specify keywords for email.
+     *
+     * Items may be added with KCompletion::addItem, those will only be returned as match if they
+     * are in one of these formats:
+     * \li contains localpart@domain 
+     * \li contains <email>
+     * or if they have also been added with this function.
+     */
+    void addItemWithKeys( const QString& email, int weight, const QStringList * keyWords);
+
+    /**
+     * Use internal map to replace all keywords in pMatches whith corrsesponding email addresses.
+     */
+    virtual void postProcessMatches( QStringList * pMatches )const;
+
+  private:
+    QMap< QString, QStringList > m_keyMap;
+};
+
+}
+
+#endif
Index: libkdepim/kmailcompletion.cpp
===================================================================
--- libkdepim/kmailcompletion.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ libkdepim/kmailcompletion.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -0,0 +1,103 @@
+/*
+    This file is part of libkdepim.
+
+    Copyright (c) 2006 Christian Schaarschmidt <schaarsc@gmx.de>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#include "kmailcompletion.h"
+#include <kdebug.h>
+
+#include <qregexp.h>
+
+using namespace KPIM;
+
+KMailCompletion::KMailCompletion()
+{
+	setIgnoreCase( true );
+}
+
+void KMailCompletion::clear()
+{
+  m_keyMap.clear();
+  KCompletion::clear();
+}
+
+QString KMailCompletion::makeCompletion( const QString &string )
+{
+  QString match = KCompletion::makeCompletion( string );
+
+  // this should be in postProcessMatch, but postProcessMatch is const and will not allow nextMatch
+  if ( !match.isEmpty() ){
+    const QString firstMatch( match );
+    while ( match.find( QRegExp( "(@)|(<.*>)" ) ) == -1 ) {
+      /* local email do not require @domain part, if match is an address we'll find
+       * last+first <match> in m_keyMap and we'll know that match is already a valid email.
+       *
+       * Distribution list do not have last+first <match> entry, they will be in mailAddr
+       */
+      const QStringList &mailAddr = m_keyMap[ match ]; //get all mailAddr for this keyword
+      bool isEmail = false;
+      for ( QStringList::ConstIterator sit ( mailAddr.begin() ), sEnd( mailAddr.end() ); sit != sEnd; ++sit )
+        if ( (*sit).find( "<" + match + ">" ) != -1 || (*sit) == match ) {
+          isEmail = true;
+          break;
+        }
+
+      if ( !isEmail ) {
+        // match is a keyword, skip it and try to find match <email@domain>
+        match = nextMatch();
+        if ( firstMatch == match ){
+          match = QString::null;
+          break;
+        }
+      } else
+        break;
+    }
+  }
+  return match;
+}
+
+void KMailCompletion::addItemWithKeys( const QString& email, int weight, const QStringList*  keyWords)
+{
+  Q_ASSERT( keyWords != 0 );
+  for ( QStringList::ConstIterator it( keyWords->begin() ); it != keyWords->end(); ++it ) {
+    QStringList &emailList = m_keyMap[ (*it) ];      //lookup email-list for given keyword
+    if ( emailList.find( email ) == emailList.end() ) //add email if not there
+      emailList.append( email );
+    addItem( (*it),weight );                         //inform KCompletion about keyword
+    }
+}
+
+void KMailCompletion::postProcessMatches( QStringList * pMatches )const
+{
+  Q_ASSERT( pMatches != 0 );
+  if ( pMatches->isEmpty() )
+    return;
+
+  //KCompletion has found the keywords for us, we can now map them to mail-addr
+  QMap< QString, bool > mailAddrDistinct; 
+  for ( QStringList::ConstIterator sit ( pMatches->begin() ), sEnd( pMatches->end() ); sit != sEnd; ++sit ) {
+    const QStringList &mailAddr = m_keyMap[ (*sit) ]; //get all mailAddr for this keyword
+    for ( QStringList::ConstIterator sit ( mailAddr.begin() ), sEnd( mailAddr.end() ); sit != sEnd; ++sit ) {
+      mailAddrDistinct[ (*sit) ] = true;  //store mailAddr, QMap will make them unique
+    }
+  }
+  pMatches->clear();                      //delete keywords
+  (*pMatches) += mailAddrDistinct.keys(); //add emailAddr
+}
+#include "kmailcompletion.moc"
Index: libkdepim/Makefile.am
===================================================================
--- libkdepim/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkdepim/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -35,7 +35,7 @@
   embeddedurlpage.cpp kincidencechooser.cpp \
   groupwarejob.cpp pimemoticons.kcfgc \
   krsqueezedtextlabel.cpp csshelper.cpp distributionlist.cpp \
-  kpimurlrequesterdlg.cpp sendsmsdialog.cpp
+  kpimurlrequesterdlg.cpp sendsmsdialog.cpp kmailcompletion.cpp
 
 MailTransportServiceIface_DCOPIDLNG = true
 MailTransportServiceIface_DIR = $(srcdir)/interfaces
Index: libkdepim/addresseelineedit.cpp
===================================================================
--- libkdepim/addresseelineedit.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkdepim/addresseelineedit.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -61,7 +61,7 @@
 
 using namespace KPIM;
 
-KCompletion * AddresseeLineEdit::s_completion = 0L;
+KMailCompletion * AddresseeLineEdit::s_completion = 0L;
 KPIM::CompletionItemsMap* AddresseeLineEdit::s_completionItemMap = 0L;
 QStringList* AddresseeLineEdit::s_completionSources = 0L;
 bool AddresseeLineEdit::s_addressesDirty = false;
@@ -70,7 +70,7 @@
 QString* AddresseeLineEdit::s_LDAPText = 0L;
 AddresseeLineEdit* AddresseeLineEdit::s_LDAPLineEdit = 0L;
 
-static KStaticDeleter<KCompletion> completionDeleter;
+static KStaticDeleter<KMailCompletion> completionDeleter;
 static KStaticDeleter<KPIM::CompletionItemsMap> completionItemsDeleter;
 static KStaticDeleter<QTimer> ldapTimerDeleter;
 static KStaticDeleter<KPIM::LdapSearch> ldapSearchDeleter;
@@ -110,7 +110,7 @@
 void AddresseeLineEdit::init()
 {
   if ( !s_completion ) {
-    completionDeleter.setObject( s_completion, new KCompletion() );
+    completionDeleter.setObject( s_completion, new KMailCompletion() );
     s_completion->setOrder( completionOrder() );
     s_completion->setIgnoreCase( true );
 
@@ -138,6 +138,8 @@
       setCompletionObject( s_completion, false );
       connect( this, SIGNAL( completion( const QString& ) ),
           this, SLOT( slotCompletion() ) );
+      connect( this, SIGNAL( returnPressed( const QString& ) ),
+          this, SLOT( slotReturnPressed( const QString& ) ) );
 
       KCompletionBox *box = completionBox();
       connect( box, SIGNAL( highlighted( const QString& ) ),
@@ -177,12 +179,15 @@
   bool accept = false;
 
   if ( KStdAccel::shortcut( KStdAccel::SubstringCompletion ).contains( KKey( e ) ) ) {
+    //TODO: add LDAP substring lookup, when it becomes available in KPIM::LDAPSearch
+    updateSearchString();
     doCompletion( true );
     accept = true;
   } else if ( KStdAccel::shortcut( KStdAccel::TextCompletion ).contains( KKey( e ) ) ) {
     int len = text().length();
 
     if ( len == cursorPosition() ) { // at End?
+      updateSearchString();
       doCompletion( true );
       accept = true;
     }
@@ -192,11 +197,17 @@
     KLineEdit::keyPressEvent( e );
 
   if ( e->isAccepted() ) {
+    updateSearchString();
+    QString searchString( m_searchString );
+    //LDAP does not know about our string manipulation, remove it
+    if ( m_searchExtended )
+        searchString = m_searchString.mid( 1 );
+
     if ( m_useCompletion && s_LDAPTimer != NULL ) {
-      if ( *s_LDAPText != text() || s_LDAPLineEdit != this )
+      if ( *s_LDAPText != searchString || s_LDAPLineEdit != this )
         stopLDAPLookup();
 
-      *s_LDAPText = text();
+      *s_LDAPText = searchString;
       s_LDAPLineEdit = this;
       s_LDAPTimer->start( 500, true );
     }
@@ -350,7 +361,11 @@
 
 void AddresseeLineEdit::doCompletion( bool ctrlT )
 {
-  if ( !m_useCompletion )
+  m_lastSearchMode = ctrlT;
+
+  KGlobalSettings::Completion  mode = completionMode();
+
+  if ( mode == KGlobalSettings::CompletionNone  )
     return;
 
   if ( s_addressesDirty ) {
@@ -370,10 +385,10 @@
     setCompletedItems( completions, true ); // this makes sure the completion popup is closed if no matching items were found
 
     cursorAtEnd();
+    setCompletionMode( mode ); //set back to previous mode
     return;
   }
 
-  KGlobalSettings::Completion  mode = completionMode();
 
   switch ( mode ) {
     case KGlobalSettings::CompletionPopupAuto:
@@ -385,15 +400,7 @@
     case KGlobalSettings::CompletionPopup:
     {
       const QStringList items = getAdjustedCompletionItems( true );
-      bool autoSuggest = !items.isEmpty() && (mode != KGlobalSettings::CompletionPopupAuto);
-      setCompletedItems( items, autoSuggest );
-
-      if ( !autoSuggest ) {
-        int index = items.first().find( m_searchString );
-        QString newText = m_previousAddresses + items.first().mid( index ).stripWhiteSpace();
-        setUserSelection( false );
-        setCompletedText( newText, true );
-      }
+      setCompletedItems( items, false );
       break;
     }
 
@@ -411,14 +418,51 @@
     case KGlobalSettings::CompletionMan: // Short-Auto in fact
     case KGlobalSettings::CompletionAuto:
     {
+      //force autoSuggest in KLineEdit::keyPressed or setCompletedText will have no effect
+      setCompletionMode( completionMode() );
+
       if ( !m_searchString.isEmpty() ) {
+        
+        //if only our \" is left, remove it since user has not typed it either
+        if ( m_searchExtended && m_searchString == "\"" ){
+          m_searchExtended = false;
+          m_searchString = QString::null;
+          setText( m_previousAddresses );
+          break;
+        }
+
         QString match = s_completion->makeCompletion( m_searchString );
-        if ( !match.isNull() && match != m_searchString ) {
-          QString adds = m_previousAddresses + match;
-          setCompletedText( adds );
+
+        if ( !match.isEmpty() ) {
+          if ( match != m_searchString ) {
+            QString adds = m_previousAddresses + match;
+            setCompletedText( adds );
+          } 
+        } else {
+          if ( !m_searchString.startsWith( "\"" ) ) {
+            //try with quoted text, if user has not type one already
+            match = s_completion->makeCompletion( "\"" + m_searchString );
+            if ( !match.isEmpty() && match != m_searchString ) {
+              m_searchString = "\"" + m_searchString;
+              m_searchExtended = true;
+              setText( m_previousAddresses + m_searchString );
+              setCompletedText( m_previousAddresses + match );
+            }
+          } else if ( m_searchExtended ) {
+            //our added \" does not work anymore, remove it
+            m_searchString = m_searchString.mid( 1 );
+            m_searchExtended = false;
+            setText( m_previousAddresses + m_searchString );
+            //now try again
+            match = s_completion->makeCompletion( m_searchString );
+            if ( !match.isEmpty() && match != m_searchString ) {
+              QString adds = m_previousAddresses + match;
+              setCompletedText( adds );
+            }
+          }
         }
-        break;
       }
+      break;
     }
 
     case KGlobalSettings::CompletionNone:
@@ -434,6 +478,14 @@
 //  slotMatched( m_previousAddresses + completion );
 }
 
+void AddresseeLineEdit::slotReturnPressed( const QString& item )
+{
+  Q_UNUSED( item );
+  QListBoxItem* i = completionBox()->selectedItem();
+  if ( i != 0 )
+    slotPopupCompletion( i->text() );
+}
+
 void AddresseeLineEdit::loadContacts()
 {
   s_completion->clear();
@@ -486,7 +538,14 @@
   QStringList::const_iterator listIt;
   int idx = addCompletionSource( i18n( "Distribution Lists" ) );
   for ( listIt = distLists.begin(); listIt != distLists.end(); ++listIt ) {
+
+    //for KGlobalSettings::CompletionAuto
     addCompletionItem( (*listIt).simplifyWhiteSpace(), weight, idx );
+
+    //for CompletionShell, CompletionPopup
+    QStringList sl( (*listIt).simplifyWhiteSpace() );
+    addCompletionItem( (*listIt).simplifyWhiteSpace(), weight, idx, &sl );
+
   }
 #endif
 
@@ -503,7 +562,14 @@
 #ifdef KDEPIM_NEW_DISTRLISTS
   if ( KPIM::DistributionList::isDistributionList( addr ) ) {
     //kdDebug(5300) << "AddresseeLineEdit::addContact() distribution list \"" << addr.formattedName() << "\" weight=" << weight << endl;
+ 
+    //for CompletionAuto
     addCompletionItem( addr.formattedName(), weight, source );
+
+    //for CompletionShell, CompletionPopup
+    QStringList sl( addr.formattedName() );
+    addCompletionItem( addr.formattedName(), weight, idx, &sl );
+
     return;
   }
 #endif
@@ -511,18 +577,63 @@
   const QStringList emails = addr.emails();
   QStringList::ConstIterator it;
   for ( it = emails.begin(); it != emails.end(); ++it ) {
+    //TODO: highlight preferredEmail 
+    const QString email( (*it) );
+    const QString givenName = addr.givenName();
+    const QString familyName= addr.familyName();
+    const QString nickName  = addr.nickName();
+    const QString fullEmail = addr.fullEmail( email );
+    const QString domain    = email.mid( email.find( '@' ) + 1 );
+    //TODO: let user decide what fields to use in lookup, e.g. company, city, ...
 
-    if ( addr.givenName().isEmpty() && addr.familyName().isEmpty() ) {
-      addCompletionItem( addr.fullEmail( (*it) ), weight, source ); // use whatever is there
+    //for CompletionAuto
+    if ( givenName.isEmpty() && familyName.isEmpty() ) {
+      addCompletionItem( fullEmail, weight, source ); // use whatever is there
     } else {
-      const QString byFirstName= KPIM::quoteNameIfNecessary( addr.givenName() + " " + addr.familyName() ) + " <" + (*it) + ">";
-      const QString byLastName= "\"" + addr.familyName() + ", " + addr.givenName() + "\" "  + "<" + (*it) + ">";
-      const QString byEmail= (*it) + " (" + KPIM::quoteNameIfNecessary( addr.realName() ) + ")";
+      const QString byFirstName=  "\"" + givenName + " " + familyName + "\" <" + email + ">";
+      const QString byLastName =  "\"" + familyName + ", " + givenName + "\" <" + email + ">";
       addCompletionItem( byFirstName, weight, source );
       addCompletionItem( byLastName, weight, source );
-      addCompletionItem( byEmail, weight, source );
     }
 
+    addCompletionItem( email, weight, source );
+
+    if ( !nickName.isEmpty() ){
+      const QString byNick     =  "\"" + nickName + "\" <" + email + ">";
+      addCompletionItem( byNick, weight, source );
+    }
+
+    if ( !domain.isEmpty() ){
+      const QString byDomain   =  "\"" + domain + " " + familyName + " " + givenName + "\" <" + email + ">";
+      addCompletionItem( byDomain, weight, source );
+    }
+    
+    //for CompletionShell, CompletionPopup
+    QStringList keyWords;
+    const QString realName  = addr.realName();
+
+    if ( !givenName.isEmpty() && !familyName.isEmpty() ) {
+      keyWords.append( givenName  + " "  + familyName );
+      keyWords.append( familyName + " "  + givenName );
+      keyWords.append( familyName + ", " + givenName);
+    }else if ( !givenName.isEmpty() )
+      keyWords.append( givenName );
+    else if ( !familyName.isEmpty() )
+      keyWords.append( familyName );
+
+    if ( !nickName.isEmpty() )
+      keyWords.append( nickName );
+
+    if ( !realName.isEmpty() )
+      keyWords.append( realName );
+
+    if ( !domain.isEmpty() )
+      keyWords.append( domain );
+
+    keyWords.append( email );
+
+    addCompletionItem( fullEmail, weight, source, &keyWords );
+
 #if 0
     int len = (*it).length();
     if ( len == 0 ) continue;
@@ -574,7 +685,7 @@
   }
 }
 
-void AddresseeLineEdit::addCompletionItem( const QString& string, int weight, int completionItemSource )
+void AddresseeLineEdit::addCompletionItem( const QString& string, int weight, int completionItemSource, const QStringList * keyWords )
 {
   // Check if there is an exact match for item already, and use the max weight if so.
   // Since there's no way to get the information from KCompletion, we have to keep our own QMap
@@ -585,7 +696,10 @@
   } else {
     s_completionItemMap->insert( string, qMakePair( weight, completionItemSource ) );
   }
-  s_completion->addItem( string, weight );
+  if ( keyWords == 0 )
+    s_completion->addItem( string, weight );
+  else
+    s_completion->addItemWithKeys( string, weight, keyWords );
 }
 
 void AddresseeLineEdit::slotStartLDAPLookup()
@@ -636,9 +750,12 @@
     addContact( addr, (*it).completionWeight, (*it ).clientNumber  );
   }
 
-  if ( hasFocus() || completionBox()->hasFocus() )
-    if ( completionMode() != KGlobalSettings::CompletionNone )
-      doCompletion( false );
+  if ( (hasFocus() || completionBox()->hasFocus() )
+       && completionMode() != KGlobalSettings::CompletionNone 
+       && completionMode() != KGlobalSettings::CompletionShell) {
+    setText( m_previousAddresses + m_searchString );
+    doCompletion( m_lastSearchMode );
+  }
 }
 
 void AddresseeLineEdit::setCompletedItems( const QStringList& items, bool autoSuggest )
@@ -648,25 +765,11 @@
     if ( !items.isEmpty() &&
          !(items.count() == 1 && m_searchString == items.first()) )
     {
-        if ( completionBox->isVisible() )
-        {
-          bool wasSelected = completionBox->isSelected( completionBox->currentItem() );
-          const QString currentSelection = completionBox->currentText();
-          completionBox->setItems( items );
-          QListBoxItem* item = completionBox->findItem( currentSelection, Qt::ExactMatch );
-          if ( item )
-          {
-            completionBox->blockSignals( true );
-            completionBox->setCurrentItem( item );
-            completionBox->setSelected( item, wasSelected );
-            completionBox->blockSignals( false );
-          }
-        }
-        else // completion box not visible yet -> show it
-        {
+        completionBox->setItems( items );
+
+        if ( !completionBox->isVisible() ) {
           if ( !m_searchString.isEmpty() )
             completionBox->setCancelledText( m_searchString );
-          completionBox->setItems( items );
           completionBox->popup();
           // we have to install the event filter after popup(), since that 
           // calls show(), and that's where KCompletionBox installs its filter.
@@ -675,6 +778,14 @@
             qApp->installEventFilter( this );
         }
 
+        QListBoxItem* item = completionBox->item( 1 );
+        if ( item )
+        {
+          completionBox->blockSignals( true );
+          completionBox->setSelected( item, true );
+          completionBox->blockSignals( false );
+        }
+
         if ( autoSuggest )
         {
             int index = items.first().find( m_searchString );
@@ -687,6 +798,7 @@
     {
         if ( completionBox && completionBox->isVisible() ) {
             completionBox->hide();
+            completionBox->setItems( QStringList() );
         }
     }
 }
@@ -697,9 +809,12 @@
   if ( !menu )
     return 0;
 
-  if ( m_useCompletion )
+  if ( m_useCompletion ){
+    menu->setItemVisible( ShortAutoCompletion, false );
+    menu->setItemVisible( PopupAutoCompletion, false );
     menu->insertItem( i18n( "Configure Completion Order..." ),
                       this, SLOT( slotEditCompletionOrder() ) );
+  }
   return menu;
 }
 
@@ -720,12 +835,11 @@
 {
   if ( s_LDAPSearch && s_LDAPLineEdit == this )
     stopLDAPLookup();
-  userCancelled( cancelText ); // in KLineEdit
+  userCancelled( m_previousAddresses + cancelText ); // in KLineEdit
 }
 
-void KPIM::AddresseeLineEdit::slotCompletion()
+void AddresseeLineEdit::updateSearchString()
 {
-  // Called by KLineEdit's keyPressEvent -> new text, update search string
   m_searchString = text();
   int n = m_searchString.findRev(',');
   if ( n >= 0 ) {
@@ -744,6 +858,13 @@
   {
     m_previousAddresses = QString::null;
   }
+}
+
+void KPIM::AddresseeLineEdit::slotCompletion()
+{
+  // Called by KLineEdit's keyPressEvent for CompletionModes Auto,Popup -> new text, update search string
+  // not called for CompletionShell, this is been taken care of in AddresseeLineEdit::keyPressEvent
+  updateSearchString();
   if ( completionBox() )
     completionBox()->setCancelledText( m_searchString );
   doCompletion( false );
@@ -821,7 +942,7 @@
       // to ignore. If so, go one further
       QListBoxItem *itemAbove = completionBox()->item( currentIndex - 1 );
       if ( itemAbove && !itemAbove->text().startsWith( s_completionItemIndentString ) ) {
-        // there is a header above is, check if there is even further up
+        // there is a header above us, check if there is even further up
         // and if so go one up, so it'll be selected
         if ( currentIndex > 1 && completionBox()->item( currentIndex - 2 ) ) {
           //kdDebug() << "EVENTFILTER: Key_Up -> skipping " << currentIndex - 1 << endl;
@@ -831,6 +952,7 @@
             // nothing to skip to, let's stay where we are, but make sure the
             // first header becomes visible, if we are the first real entry
             completionBox()->ensureVisible( 0, 0 );
+            completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
@@ -845,9 +967,14 @@
           completionBox()->setSelected( currentIndex + 2, true );
         } else {
           // nothing to skip to, let's stay where we are
+          completionBox()->setSelected( currentIndex, true );
         }
         return true;
       }
+      // special case of the last and only item in the list needing selection
+      if ( !itemBelow && currentIndex == 1 ) {
+        completionBox()->setSelected( currentIndex, true );
+      }
       // special case of the initial selection, which is unfortunately a header.
       // Setting it to selected tricks KCompletionBox into not treating is special
       // and selecting making it current, instead of the one below.
@@ -865,15 +992,7 @@
   QStringList items = fullSearch ?
     s_completion->allMatches( m_searchString )
     : s_completion->substringCompletion( m_searchString );
-  if ( fullSearch )
-    items += s_completion->allMatches( "\"" + m_searchString );
-  unsigned int beforeDollarCompletionCount = items.count();
-
-  if ( fullSearch && m_searchString.find( ' ' ) == -1 ) // one word, possibly given name
-    items += s_completion->allMatches( "$$" + m_searchString );
-
-  // kdDebug(5300) << "     AddresseeLineEdit::doCompletion() found: " << items.join(" AND ") << endl;
-
+ 
   int lastSourceIndex = -1;
   unsigned int i = 0;
   QMap<int, QStringList> sections;
@@ -894,13 +1013,6 @@
     }
     sections[idx].append( *it );
 
-      if ( i > beforeDollarCompletionCount ) { 
-      // remove the '$$whatever$' part
-      int pos = (*it).find( '$', 2 );
-      if ( pos < 0 ) // ???
-        continue;
-      (*it) = (*it).mid( pos + 1 );
-    }
     if ( s_completion->order() == KCompletion::Sorted ) {
       sortedItems.append( *it );
     }
Index: libkdepim/linklocator.cpp
===================================================================
--- libkdepim/linklocator.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkdepim/linklocator.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -96,8 +96,8 @@
     {
       ++mPos;
     }
-    /* some URLs really end with:  # / &     */
-    const QString allowedSpecialChars = QString("#/&");
+    /* some URLs really end with:  # / & - _    */
+    const QString allowedSpecialChars = QString("#/&-_");
     while(mPos > start && mText[mPos-1].isPunct() &&
 		    allowedSpecialChars.find(mText[mPos-1]) == -1 )
     {
Index: libkcal/localdir.desktop
===================================================================
--- libkcal/localdir.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/localdir.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -34,7 +34,7 @@
 Name[pt]=Calendário numa Directoria Local
 Name[pt_BR]=Calendário em Diretório Local
 Name[ro]=Calendar în director local
-Name[ru]=Календарь в локальном каталоге
+Name[ru]=Календарь в локальной папке
 Name[sk]=Kalendár v lokálnom priečinku
 Name[sl]=Koledar v krajevnem imeniku
 Name[sr]=Календар у локалном директоријуму
Index: libkcal/filestorage.cpp
===================================================================
--- libkcal/filestorage.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/filestorage.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -136,7 +136,7 @@
     calendar()->setModified( false );
   } else {
     if ( !format->exception() ) {
-      kdDebug(5800) << "FileStorage::save(): Error. There should be set an expection."
+      kdDebug(5800) << "FileStorage::save(): Error. There should be set an exception."
                 << endl;
     } else {
       kdDebug(5800) << "FileStorage::save(): " << format->exception()->message()
Index: libkcal/calendarresources.cpp
===================================================================
--- libkcal/calendarresources.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/calendarresources.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -106,6 +106,8 @@
 {
   close();
   delete mManager;
+  delete mStandardPolicy;
+  delete mAskPolicy;
 }
 
 void CalendarResources::readConfig( KConfig *config )
Index: libkcal/libical/src/libical/sspm.c
===================================================================
--- libkcal/libical/src/libical/sspm.c	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/libical/src/libical/sspm.c	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1171,7 +1171,7 @@
 			     char *src,
 			     size_t *size)
 {
-    int cc;
+    int cc = 0;
     char buf[4] = {0,0,0,0};  
     int p = 0;
     int valid_data = 0;
Index: libkcal/icalformatimpl.cpp
===================================================================
--- libkcal/icalformatimpl.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/icalformatimpl.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -192,17 +192,16 @@
     icaltimetype end;
     if (event->doesFloat()) {
 //      kdDebug(5800) << " Event " << event->summary() << " floats." << endl;
-//      if (event->dtEnd().date() != event->dtStart().date()) {
-        // +1 day because end date is non-inclusive.
-        end = writeICalDate( event->dtEnd().date().addDays( 1 ) );
-//      }
+      // +1 day because end date is non-inclusive.
+      end = writeICalDate( event->dtEnd().date().addDays( 1 ) );
+      icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
     } else {
 //      kdDebug(5800) << " Event " << event->summary() << " has time." << endl;
       if (event->dtEnd() != event->dtStart()) {
         end = writeICalDateTime(event->dtEnd());
+        icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
       }
     }
-    icalcomponent_add_property(vevent,icalproperty_new_dtend(end));
   }
 
 // TODO: resources
@@ -950,6 +949,8 @@
   QStringList categories;
   icalproperty_transp transparency;
 
+  bool dtEndProcessed = false;
+
   while (p) {
     icalproperty_kind kind = icalproperty_isa(p);
     switch (kind) {
@@ -968,6 +969,7 @@
           event->setDtEnd(readICalDateTime(icaltime, tz));
           event->setFloats( false );
         }
+        dtEndProcessed = true;
         break;
 
       case ICAL_RELATEDTO_PROPERTY:  // related event (parent)
@@ -993,6 +995,12 @@
     p = icalcomponent_get_next_property(vevent,ICAL_ANY_PROPERTY);
   }
 
+  // according to rfc2445 the dtend shouldn't be written when it equals
+  // start date. so assign one equal to start date.
+  if ( !dtEndProcessed && !event->hasDuration() ) {
+    event->setDtEnd( event->dtStart() );
+  }
+
   QString msade = event->nonKDECustomProperty("X-MICROSOFT-CDO-ALLDAYEVENT");
   if (!msade.isNull()) {
     bool floats = (msade == QString::fromLatin1("TRUE"));
@@ -1173,19 +1181,26 @@
 
 Attachment *ICalFormatImpl::readAttachment(icalproperty *attach)
 {
-  icalattach *a = icalproperty_get_attach(attach);
-
   Attachment *attachment = 0;
 
-  int isurl = icalattach_get_is_url (a);
-  if (isurl == 0)
-    attachment = new Attachment((const char*)icalattach_get_data(a));
-  else {
-    attachment = new Attachment(QString(icalattach_get_url(a)));
+  icalvalue_kind value_kind = icalvalue_isa(icalproperty_get_value(attach));
+
+  if ( value_kind == ICAL_ATTACH_VALUE ) {
+    icalattach *a = icalproperty_get_attach(attach);
+
+    int isurl = icalattach_get_is_url (a);
+    if (isurl == 0)
+      attachment = new Attachment((const char*)icalattach_get_data(a));
+    else {
+      attachment = new Attachment(QString(icalattach_get_url(a)));
+    }
   }
+  else if ( value_kind == ICAL_URI_VALUE ) {
+    attachment = new Attachment(QString(icalvalue_get_uri(icalproperty_get_value(attach))));
+  }
 
   icalparameter *p = icalproperty_get_first_parameter(attach, ICAL_FMTTYPE_PARAMETER);
-  if (p)
+  if (p && attachment)
     attachment->setMimeType(QString(icalparameter_get_fmttype(p)));
 
   return attachment;
Index: libkcal/todo.cpp
===================================================================
--- libkcal/todo.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/todo.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -275,11 +275,17 @@
 
     if ( ( r->duration() == -1 || ( nextDate.isValid() && endDateTime.isValid()
            && nextDate <= endDateTime ) ) ) {
-      setDtDue( nextDate );
-      while ( !recursAt( dtDue() ) || dtDue() <= QDateTime::currentDateTime() ) {
-        setDtDue( r->getNextDateTime( dtDue() ) );
+
+      while ( !recursAt( nextDate ) || nextDate <= QDateTime::currentDateTime() ) {
+
+        if ( !nextDate.isValid() || nextDate > endDateTime ) {
+          return false;
+        }
+
+        nextDate = r->getNextDateTime( nextDate );
       }
 
+      setDtDue( nextDate );
       setCompleted( false );
       setRevision( revision() + 1 );
 
Index: libkcal/htmlexport.h
===================================================================
--- libkcal/htmlexport.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/htmlexport.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -37,7 +37,7 @@
 namespace KCal {
 
 /**
-  This class provides the functions to export a calendar as a HTML page.
+  This class provides the functions to export a calendar as an HTML page.
 */
 class KDE_EXPORT HtmlExport
 {
Index: libkcal/icalformat.cpp
===================================================================
--- libkcal/icalformat.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ libkcal/icalformat.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -126,6 +126,7 @@
   file.file()->writeBlock( textUtf8.data(), textUtf8.size() - 1 );
 
   if ( !file.close() ) {
+    kdDebug(5800) << "KSaveFile: close: status was " << file.status() << ". See errno.h." << endl;
     setException(new ErrorFormat(ErrorFormat::SaveError,
                  i18n("Could not save '%1'").arg(fileName)));
     return false;
Index: kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui
===================================================================
--- kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/sysinfoconduit/sysinfo-setup_dialog.ui	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -99,7 +99,7 @@
                                     <bool>true</bool>
                                 </property>
                                 <property name="whatsThis" stdset="0">
-                                    <string>&lt;qt&gt;Select this option to output the system information data as a HTML document.&lt;/qt&gt;</string>
+                                    <string>&lt;qt&gt;Select this option to output the system information data as an HTML document.&lt;/qt&gt;</string>
                                 </property>
                             </widget>
                             <widget class="QRadioButton" row="1" column="0" rowspan="1" colspan="2">
Index: kpilot/conduits/notepadconduit/notepad-conduit.desktop
===================================================================
--- kpilot/conduits/notepadconduit/notepad-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/notepadconduit/notepad-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -32,7 +32,7 @@
 Comment[fr]=Ce conduit sauvegarde les dessins (Notes) dans un dossier local
 Comment[hu]=Bővítőmodul NotePad-rajzok helyi könyvtárba való lementéséhez.
 Comment[is]=Þessi rás afritar NotePad teikningar í staðbundna möppu.
-Comment[it]=Questo conduit archivia i disegni NotePad drawings in una cartella locale.
+Comment[it]=Questo conduit archivia i disegni NotePad in una cartella locale.
 Comment[ja]=このコンジットは NotePad の絵をローカルのフォルダにバックアップします。
 Comment[km]=បំពង់​នេះ​អាច​បម្រុង​ទុក​គំនូរ NotePad ទៅ​ថត​មូលដ្ឋាន ។
 Comment[lt]=Šis kanalas padaro NotePad piešinių atsargines kopijas į vietinį aplanką.
Index: kpilot/conduits/memofileconduit/memofile-conduit.desktop
===================================================================
--- kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/memofileconduit/memofile-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -47,7 +47,7 @@
 Comment[es]=Este conducto sincroniza las notas de su agenda electrónica con el directorio local.
 Comment[et]=See kanal sünkroniseerib pihuarvutis ja arvutis olevad memod.
 Comment[eu]=Kanal honek zure agendako oharrak direktorio lokal batekin sinkronizatzen ditu.
-Comment[fa]=این لوله، memo‌های دستی خود را با یک فهرست راهنمای محلی همگام‌سازی کنید.
+Comment[fa]=این لوله، memo‌های دستی خود را با یک فهرست راهنمای محلی همگام‌سازی می‌کند.
 Comment[fi]=Tämä yhdyskäytävä synkronoi taskutietokoneen muistiot paikalliseen kansioon.
 Comment[fr]=Ce canal synchronise les mémos du Palm avec ceux de KDE.
 Comment[hu]=Ezzel a csatolóval egy kézi számítógép memóit lehet szinkronizálni a helyi címjegyzékkel.
Index: kpilot/conduits/docconduit/doc_conduit.desktop
===================================================================
--- kpilot/conduits/docconduit/doc_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/docconduit/doc_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -17,7 +17,7 @@
 Comment[hu]=Szöveges fájlok hozzáadása a kézi számítógéphez, DOC-olvasók számára.
 Comment[is]=Bætir textaskrám, sem hægt er að lesa í DOC lesara, við lófatölvuna þína.
 Comment[it]=Aggiunge file di testo al tuo Pilot, adatti per lettori DOC.
-Comment[ja]=テキストファイルを DOC リーダに適した形式でハンドヘルドに追加します。
+Comment[ja]=テキストファイルを DOC リーダーに適した形式でハンドヘルドに追加します。
 Comment[km]=បន្ថែម​ឯកសារ​អត្ថបទ​ទៅ​ឧបករណ៍​យួរ​ដៃ​របស់​អ្នក (សមស្រប​សម្រាប់​កម្មវិធី​អាន DOC) ។
 Comment[lt]=Prideda teksto bylas prie Jūsų nešiojamos knygelės, tinka DOC skaityklėms.
 Comment[ms]=Menambah fail teks ke komputer telapak, sesuai dengan pembaca DOC.
Index: kpilot/conduits/malconduit/mal_conduit.desktop
===================================================================
--- kpilot/conduits/malconduit/mal_conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/malconduit/mal_conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -55,7 +55,7 @@
 Comment[es]=Sincroniza AvantGo (o más genéricamente, el contenido de un servidor MAL) con la agenda electrónica. Le permite ver páginas web en la agenda electrónica sin estar conectado, como la programación de televisión o la cartelera de cine, o cualquier otra página web.
 Comment[et]=See kanal sünkroniseerib AvantGo (või üldisemalt MAL serveri sisu) pihuarvutiga. See võimaldab vaadata veebilehekülgi pihuseadmelt ilma võrguühendusega, näiteks uurida kino- või telekava või mis tahes muud huvipakkuvat veebilehekülge.
 Comment[eu]=Sinkronizatu AvantGo (edo orokorrean MAL zerbitzariaren edukina) agenda elektronikora. Honek web-orriak agendan konexio gabe ikusteko aukera ematen dizu, zure zine edo TB antolatzailean bezala, edo beste web orri bat bezala.
-Comment[fa]=همگام‌سازی AvantGo (یا عموماً یک محتوای کارساز MAL) با دستی. به شما اجازه می‌دهد که صفحات وب برون خطی روی دستی، مانند برنامۀ سینما یا تلویزیون شما، یا هر صفحه وب دیگری را مشاهده کنید. 
+Comment[fa]=همگام‌سازی AvantGo (یا عموماً یک محتوای کارساز MAL) با دستی. به شما اجازه می‌دهد که صفحات وب برون خطی روی دستی، مانند برنامۀ سینما یا تلویزیون شما، یا هر صفحه وب دیگری را مشاهده کنید.
 Comment[fi]=Synkronoi AvantGo (tai yleisesti MAL-palvelimen sisältö) taskutietokoneeseen. Tämä mahdollistaa web-sivujen lukemisen offline-tilassa (esim. elokuva- tai tv-ohjelmasivujen).
 Comment[fr]=Synchronise AvantGo (ou plus généralement tout serveur MAL) avec votre Palm. Ceci vous permet de consulter des pages Web hors ligne sur votre Palm, comme des programmes TV, Cinéma ou n'importe quelle page Web.
 Comment[hu]=AvantGo (vagy MAL-kiszolgáló) adatainak szinkronizálása a kézi számítógéppel. Lehetővé teszi weboldalak offline módban való megtekintését, például a mozi- vagy tévéműsort, vagy bármi mást.
Index: kpilot/conduits/vcalconduit/todo-conduit.desktop
===================================================================
--- kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/conduits/vcalconduit/todo-conduit.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -54,7 +54,7 @@
 Name[es]=Tareas pendientes (KOrganizer)
 Name[et]=Ülesanded (KOrganizer)
 Name[eu]=Egitekoak (KOrganizer)
-Name[fa]=کارهایی که باید انجام شوند (KOrganizer)
+Name[fa]=کارهای انجامی (KOrganizer)
 Name[fi]=Tehtävät (KOrganizer)
 Name[fr]=Tâches (KOrganizer)
 Name[ga]=Tascanna (KOrganizer)
Index: kpilot/kpilot/kpilot_config.desktop
===================================================================
--- kpilot/kpilot/kpilot_config.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/kpilot/kpilot_config.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -108,7 +108,7 @@
 Keywords[es]=kpilot,principal
 Keywords[et]=kpilot,peamine
 Keywords[eu]=kpilot,nagusia
-Keywords[fa]=kpilot،اصلی
+Keywords[fa]=kpilot ،اصلی
 Keywords[fi]=kpilot
 Keywords[fr]=kpilot,principal
 Keywords[ga]=kpilot,príomh
Index: kpilot/lib/options.h
===================================================================
--- kpilot/lib/options.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kpilot/lib/options.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -62,9 +62,9 @@
 // of to the KDE debugging facility (it does lose some niftiness then).
 //
 #ifndef DEBUG
-// #define DEBUG			(1)
+#define DEBUG			(1)
 #endif
-// #define DEBUG_CERR			(1)
+#define DEBUG_CERR			(1)
 
 #ifdef HAVE_CONFIG_H
 #include "config.h"
@@ -199,7 +199,7 @@
 #define FUNCTIONSETUPL(a) const int fname = a; Q_UNUSED(fname);
 #endif
 
-#define KPILOT_VERSION	"4.6.0 (blivit)"
+#define KPILOT_VERSION	"4.6.7 (tijdelijk)"
 
 
 // Function to expand newlines in rich text to <br>\n
Index: knotes/knote.cpp
===================================================================
--- knotes/knote.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ knotes/knote.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -167,29 +167,32 @@
     KXMLGUIFactory factory( &builder, this );
     factory.addClient( this );
 
-    m_menu = static_cast<KPopupMenu*>(factory.container( "note_context", this ));
-    m_edit_menu = static_cast<KPopupMenu*>(factory.container( "note_edit", this ));
-    m_tool = static_cast<KToolBar*>(factory.container( "note_tool", this ));
-    m_tool->setIconSize( 10 );
-    m_tool->setFixedHeight( 16 );
-    m_tool->setIconText( KToolBar::IconOnly );
+    m_menu = dynamic_cast<KPopupMenu*>(factory.container( "note_context", this ));
+    m_edit_menu = dynamic_cast<KPopupMenu*>(factory.container( "note_edit", this ));
+    m_tool = dynamic_cast<KToolBar*>(factory.container( "note_tool", this ));
 
-    // if there was just a way of making KComboBox adhere the toolbar height...
-    QObjectList *list = m_tool->queryList( "KComboBox" );
-    QObjectListIt it( *list );
-    while ( it.current() != 0 )
-    {
-        KComboBox *combo = (KComboBox *)it.current();
-        QFont font = combo->font();
-        font.setPointSize( 7 );
-        combo->setFont( font );
-        combo->setFixedHeight( 14 );
-        ++it;
+    if ( m_tool ) {
+      m_tool->setIconSize( 10 );
+      m_tool->setFixedHeight( 16 );
+      m_tool->setIconText( KToolBar::IconOnly );
+
+      // if there was just a way of making KComboBox adhere the toolbar height...
+      QObjectList *list = m_tool->queryList( "KComboBox" );
+      QObjectListIt it( *list );
+      while ( it.current() != 0 )
+      {
+          KComboBox *combo = (KComboBox *)it.current();
+          QFont font = combo->font();
+          font.setPointSize( 7 );
+          combo->setFont( font );
+          combo->setFixedHeight( 14 );
+          ++it;
+      }
+      delete list;
+
+      m_tool->hide();
     }
-    delete list;
 
-    m_tool->hide();
-
     setFocusProxy( m_editor );
 
     // create the resize handle
@@ -413,7 +416,10 @@
 void KNote::saveConfig() const
 {
     m_config->setWidth( width() );
-    m_config->setHeight( height() - (m_tool->isHidden() ? 0 : m_tool->height()) );
+    if ( m_tool )
+      m_config->setHeight( height() - (m_tool->isHidden() ? 0 : m_tool->height()) );
+    else
+      m_config->setHeight( 0 );
     m_config->setPosition( pos() );
 
     NETWinInfo wm_client( qt_xdisplay(), winId(), qt_xrootwin(), NET::WMDesktop );
@@ -1033,13 +1039,13 @@
 
         if ( !m_editor->isReadOnly() )
         {
-            if ( m_tool->isHidden() && m_editor->textFormat() == QTextEdit::RichText )
+            if ( m_tool && m_tool->isHidden() && m_editor->textFormat() == QTextEdit::RichText )
             {
                 m_tool->show();
                 setGeometry( x(), y(), width(), height() + m_tool->height() );
             }
         }
-        else if ( !m_tool->isHidden() )
+        else if ( m_tool && !m_tool->isHidden() )
         {
             m_tool->hide();
             setGeometry( x(), y(), width(), height() - m_tool->height() );
@@ -1053,7 +1059,7 @@
         m_button->hide();
         m_editor->cornerWidget()->hide();
 
-        if ( !m_tool->isHidden() )
+        if ( m_tool && !m_tool->isHidden() )
         {
             m_tool->hide();
             setGeometry( x(), y(), width(), height() - m_tool->height() );
@@ -1189,22 +1195,24 @@
         QPoint( contentsRect().x(),
                 contentsRect().y() + headerHeight + s_ppOffset ),
         QPoint( contentsRect().right(),
-                contentsRect().bottom() - (m_tool->isHidden() ? 0 : m_tool->height()) )
+                contentsRect().bottom() - ( m_tool ? (m_tool->isHidden() ? 0 : m_tool->height()) : 0 ) )
     ) );
 
-    m_tool->setGeometry(
-        contentsRect().x(),
-        contentsRect().bottom() - m_tool->height() + 1,
-        contentsRect().width(),
-        m_tool->height()
-    );
+    if( m_tool ) {
+      m_tool->setGeometry(
+          contentsRect().x(),
+          contentsRect().bottom() - m_tool->height() + 1,
+          contentsRect().width(),
+          m_tool->height()
+      );
+    }
 
     if ( s_ppOffset )
         m_fold->move( width() - 15, height() - 15 );
 
     setMinimumSize(
         m_editor->cornerWidget()->width() + margin*2,
-        headerHeight + s_ppOffset + (m_tool->isHidden() ? 0 : m_tool->height()) +
+        headerHeight + s_ppOffset + ( m_tool ? (m_tool->isHidden() ? 0 : m_tool->height() ) : 0 ) +
                 m_editor->cornerWidget()->height() + margin*2
     );
 
Index: kontact/plugins/test/kptestplugin.desktop
===================================================================
--- kontact/plugins/test/kptestplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/test/kptestplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkptestplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 
 X-KDE-PluginInfo-Name=kptestplugin
 X-KDE-PluginInfo-Version=0.1
Index: kontact/plugins/akregator/akregator_plugin.h
===================================================================
--- kontact/plugins/akregator/akregator_plugin.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/akregator/akregator_plugin.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -64,6 +64,8 @@
     virtual QStringList configModules() const;
     virtual QStringList invisibleToolbarActions() const;
     virtual bool isRunningStandalone();
+    virtual void readProperties( KConfig *config );
+    virtual void saveProperties( KConfig *config );
 
   private slots:
     void showPart();
Index: kontact/plugins/akregator/akregatorplugin.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/akregator/akregatorplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_akregator
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libakregatorpart
 X-KDE-KontactPartLoadOnStart=false
 
@@ -65,7 +65,7 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
Index: kontact/plugins/akregator/akregatorplugin3.2.desktop
===================================================================
--- kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/akregator/akregatorplugin3.2.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -64,7 +64,7 @@
 Name[es]=Orígenes
 Name[et]=Kanalid
 Name[eu]=Iturriak
-Name[fa]=خوراندن
+Name[fa]=خوراندنها
 Name[fi]=Syötteet
 Name[fr]=Flux
 Name[ga]=Fothaí
Index: kontact/plugins/akregator/akregator_plugin.cpp
===================================================================
--- kontact/plugins/akregator/akregator_plugin.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/akregator/akregator_plugin.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -40,6 +40,7 @@
 #include <plugin.h>
 
 #include <akregator_options.h>
+#include <akregator_part.h>
 #include "akregator_plugin.h"
 namespace Akregator {
 
@@ -114,6 +115,22 @@
     return modules;
 }
 
+void Plugin::readProperties( KConfig *config )
+{
+    if ( part() ) {
+        Akregator::Part *myPart = static_cast<Akregator::Part*>( part() );    
+        myPart->readProperties( config );
+    }
+}
+
+void Plugin::saveProperties( KConfig *config )
+{
+    if ( part() ) {
+        Akregator::Part *myPart = static_cast<Akregator::Part*>( part() );    
+        myPart->saveProperties( config );
+    }
+}
+
 void UniqueAppHandler::loadCommandLineOptions()
 {
     KCmdLineArgs::addCmdLineOptions( akregator_options );
Index: kontact/plugins/kitchensync/kitchensync.desktop
===================================================================
--- kontact/plugins/kitchensync/kitchensync.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/kitchensync/kitchensync.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kitchensync
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkitchensyncpart
 
 X-KDE-PluginInfo-Name=kontact_kitchensync
Index: kontact/plugins/karm/karmplugin.desktop
===================================================================
--- kontact/plugins/karm/karmplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/karm/karmplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_karm
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkarmpart
 
 X-KDE-PluginInfo-Name=kontact_karm
Index: kontact/plugins/summary/summaryplugin.desktop
===================================================================
--- kontact/plugins/summary/summaryplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/summary/summaryplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_summaryplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 
 X-KDE-PluginInfo-Name=kontact_summaryplugin
 X-KDE-PluginInfo-Version=0.1
Index: kontact/plugins/kmail/kmailplugin.desktop
===================================================================
--- kontact/plugins/kmail/kmailplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/kmail/kmailplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kmailplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkmailpart
 X-KDE-KontactPartExecutableName=kmail
 X-KDE-KontactPartLoadOnStart=true
Index: kontact/plugins/weather/weatherplugin.desktop
===================================================================
--- kontact/plugins/weather/weatherplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/weather/weatherplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -7,7 +7,7 @@
 
 X-KDE-Library=libkontact_weatherplugin
 X-KDE-KontactIdentifier=weather
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
Index: kontact/plugins/multisynk/multisynk.desktop
===================================================================
--- kontact/plugins/multisynk/multisynk.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/multisynk/multisynk.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_multisynk
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libmultisynkpart
 
 X-KDE-PluginInfo-Name=kontact_multisynk
Index: kontact/plugins/knode/knodeplugin.desktop
===================================================================
--- kontact/plugins/knode/knodeplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/knode/knodeplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knodeplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libknodepart
 X-KDE-KontactPartExecutableName=knode
 
Index: kontact/plugins/specialdates/specialdatesplugin.desktop
===================================================================
--- kontact/plugins/specialdates/specialdatesplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/specialdates/specialdatesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_specialdatesplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasPart=false
 X-KDE-KontactPluginHasSummary=true
 
Index: kontact/plugins/kpilot/kpilotplugin.desktop
===================================================================
--- kontact/plugins/kpilot/kpilotplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/kpilot/kpilotplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -6,7 +6,7 @@
 
 X-KDE-Library=libkontact_kpilotplugin
 X-KDE-KontactIdentifier=kpilot
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
Index: kontact/plugins/knotes/knotesplugin.desktop
===================================================================
--- kontact/plugins/knotes/knotesplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/knotes/knotesplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_knotesplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 
 X-KDE-PluginInfo-Website=http://pim.kde.org/components/knotes.php
Index: kontact/plugins/korganizer/summarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/summarywidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/summarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -21,20 +21,23 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include <qcursor.h>
 #include <qlabel.h>
 #include <qlayout.h>
+#include <qtooltip.h>
 
 #include <kdialog.h>
 #include <kglobal.h>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kparts/part.h>
+#include <kpopupmenu.h>
 #include <kstandarddirs.h>
 #include <kurllabel.h>
-#include <qtooltip.h>
 #include <libkcal/event.h>
 #include <libkcal/resourcecalendar.h>
 #include <libkcal/resourcelocal.h>
+#include <libkcal/incidenceformatter.h>
 #include <libkdepim/kpimprefs.h>
 
 #include "korganizeriface_stub.h"
@@ -97,20 +100,26 @@
   for ( dt=currentDate;
         dt<=currentDate.addDays( days - 1 );
         dt=dt.addDays(1) ) {
-    KCal::Event::List events = mCalendar->events( dt );
 
     KCal::Event *ev;
-    KCal::Event::List::ConstIterator it;
+
+    KCal::Event::List events_orig = mCalendar->events( dt );
+    KCal::Event::List::ConstIterator it = events_orig.begin();
+
+    KCal::Event::List events;
+    events.setAutoDelete( true );
     QDateTime qdt;
 
-    // Find recurring events, replacing the QDate with the currentDate
-    for ( it=events.begin(); it!=events.end(); ++it ) {
-      ev = *it;
+    // prevent implicitely sharing while finding recurring events
+    // replacing the QDate with the currentDate
+    for ( ; it != events_orig.end(); ++it ) {
+      ev = (*it)->clone();
       if ( ev->recursOn( dt ) ) {
         qdt = ev->dtStart();
         qdt.setDate( dt );
         ev->setDtStart( qdt );
       }
+      events.append( ev );
     }
 
     // sort the events for this date by summary
@@ -194,14 +203,22 @@
         newtext.append( QString(" (%1/%2)").arg( dayof ).arg( span ) );
       }
 
-      KURLLabel *urlLabel = new KURLLabel( ev->uid(), newtext, this );
+      KURLLabel *urlLabel = new KURLLabel( this );
+      urlLabel->setText( newtext );
+      urlLabel->setURL( ev->uid() );
       urlLabel->installEventFilter( this );
       urlLabel->setAlignment( urlLabel->alignment() | Qt::WordBreak );
       mLayout->addWidget( urlLabel, counter, 2 );
       mLabels.append( urlLabel );
 
-      if ( !ev->description().isEmpty() ) {
-        QToolTip::add( urlLabel, ev->description() );
+      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
+               this, SLOT( viewEvent( const QString& ) ) );
+      connect( urlLabel, SIGNAL( rightClickedURL( const QString& ) ),
+               this, SLOT( popupMenu( const QString& ) ) );
+
+      QString tipText( KCal::IncidenceFormatter::toolTipString( ev, true ) );
+      if ( !tipText.isEmpty() ) {
+        QToolTip::add( urlLabel, tipText );
       }
 
       // Fill Event Time Range Field (only for non-floating Events)
@@ -225,9 +242,6 @@
         mLabels.append( label );
       }
 
-      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
-               this, SLOT( selectEvent( const QString& ) ) );
-
       counter++;
     }
   }
@@ -246,13 +260,37 @@
     label->show();
 }
 
-void SummaryWidget::selectEvent( const QString &uid )
+void SummaryWidget::viewEvent( const QString &uid )
 {
   mPlugin->core()->selectPlugin( "kontact_korganizerplugin" ); //ensure loaded
   KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
   iface.editIncidence( uid );
 }
 
+void SummaryWidget::removeEvent( const QString &uid )
+{
+  mPlugin->core()->selectPlugin( "kontact_korganizerplugin" ); //ensure loaded
+  KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
+  iface.deleteIncidence( uid, false );
+}
+
+void SummaryWidget::popupMenu( const QString &uid )
+{
+  KPopupMenu popup( this );
+  popup.insertItem( i18n( "&Edit Appointment..." ), 0 );
+  popup.insertItem( KGlobal::iconLoader()->loadIcon( "editdelete", KIcon::Small),
+                    i18n( "&Delete Appointment" ), 1 );
+
+  switch ( popup.exec( QCursor::pos() ) ) {
+    case 0:
+      viewEvent( uid );
+      break;
+    case 1:
+      removeEvent( uid );
+      break;
+  }
+}
+
 bool SummaryWidget::eventFilter( QObject *obj, QEvent* e )
 {
   if ( obj->inherits( "KURLLabel" ) ) {
Index: kontact/plugins/korganizer/kcmkorgsummary.desktop
===================================================================
--- kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/kcmkorgsummary.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -56,7 +56,7 @@
 Comment[es]=Configuración del resumen de citas y de tareas pendientes
 Comment[et]=Kohtumiste ja ülesannete kokkuvõtte seadistus
 Comment[eu]=Hitzordu eta egitekoen laburpenen konfigurazioa
-Comment[fa]=برپایی خلاصۀ قرارهای ملاقات و کارهایی که باید انجام شوند.
+Comment[fa]=برپایی خلاصۀ قرارهای ملاقات و کارهایی که باید انجام شوند
 Comment[fi]=Tapaamiset ja tehtävät -yhteenvedon asetukset
 Comment[fr]=Configuration du résumé des évènements et des tâches
 Comment[hu]=A találkozók és feladatok áttekintőjének beállítása
Index: kontact/plugins/korganizer/summarywidget.h
===================================================================
--- kontact/plugins/korganizer/summarywidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/summarywidget.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -55,7 +55,9 @@
 
   private slots:
     void updateView();
-    void selectEvent( const QString &uid );
+    void popupMenu( const QString &uid );
+    void viewEvent( const QString &uid );
+    void removeEvent( const QString &uid );
 
   private:
     KOrganizerPlugin *mPlugin;
Index: kontact/plugins/korganizer/todoplugin.desktop
===================================================================
--- kontact/plugins/korganizer/todoplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/todoplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_todoplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
Index: kontact/plugins/korganizer/journalplugin.desktop
===================================================================
--- kontact/plugins/korganizer/journalplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/journalplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin
 
 X-KDE-Library=libkontact_journalplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=false
Index: kontact/plugins/korganizer/korganizerplugin.desktop
===================================================================
--- kontact/plugins/korganizer/korganizerplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/korganizerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_korganizerplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkorganizerpart
 X-KDE-KontactPartExecutableName=korganizer
 X-KDE-KontactPluginHasSummary=true
Index: kontact/plugins/korganizer/todosummarywidget.cpp
===================================================================
--- kontact/plugins/korganizer/todosummarywidget.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/todosummarywidget.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -21,20 +21,23 @@
     without including the source code for Qt in the source distribution.
 */
 
+#include <qcursor.h>
 #include <qlabel.h>
 #include <qlayout.h>
+#include <qtooltip.h>
 
 #include <kdialog.h>
 #include <kglobal.h>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kparts/part.h>
+#include <kpopupmenu.h>
 #include <kstandarddirs.h>
 #include <kurllabel.h>
-#include <qtooltip.h>
 #include <libkcal/resourcecalendar.h>
 #include <libkcal/resourcelocal.h>
 #include <libkcal/todo.h>
+#include <libkcal/incidenceformatter.h>
 #include <libkdepim/kpimprefs.h>
 
 #include "korganizeriface_stub.h"
@@ -44,6 +47,8 @@
 #include "todoplugin.h"
 
 #include "korganizer/stdcalendar.h"
+#include "korganizer/koglobals.h"
+#include "korganizer/incidencechanger.h"
 
 #include "todosummarywidget.h"
 
@@ -151,14 +156,22 @@
       if ( todo->relatedTo() ) { // show parent only, not entire ancestry
         sSummary = todo->relatedTo()->summary() + ":" + todo->summary();
       }
-      KURLLabel *urlLabel = new KURLLabel( todo->uid(), sSummary, this );
+      KURLLabel *urlLabel = new KURLLabel( this );
+      urlLabel->setText( sSummary );
+      urlLabel->setURL( todo->uid() );
       urlLabel->installEventFilter( this );
       urlLabel->setTextFormat( Qt::RichText );
       mLayout->addWidget( urlLabel, counter, 2 );
       mLabels.append( urlLabel );
 
-      if ( !todo->description().isEmpty() ) {
-        QToolTip::add( urlLabel, todo->description() );
+      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
+               this, SLOT( viewTodo( const QString& ) ) );
+      connect( urlLabel, SIGNAL( rightClickedURL( const QString& ) ),
+               this, SLOT( popupMenu( const QString& ) ) );
+
+      QString tipText( KCal::IncidenceFormatter::toolTipString( todo, true ) );
+      if ( !tipText.isEmpty() ) {
+        QToolTip::add( urlLabel, tipText );
       }
 
       label = new QLabel( stateText, this );
@@ -167,9 +180,6 @@
       mLayout->addWidget( label, counter, 3 );
       mLabels.append( label );
 
-      connect( urlLabel, SIGNAL( leftClickedURL( const QString& ) ),
-               this, SLOT( selectEvent( const QString& ) ) );
-
       counter++;
     }
   }
@@ -185,13 +195,59 @@
     label->show();
 }
 
-void TodoSummaryWidget::selectEvent( const QString &uid )
+void TodoSummaryWidget::viewTodo( const QString &uid )
 {
   mPlugin->core()->selectPlugin( "kontact_todoplugin" );//ensure loaded
   KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
   iface.editIncidence( uid );
 }
 
+void TodoSummaryWidget::removeTodo( const QString &uid )
+{
+  mPlugin->core()->selectPlugin( "kontact_todoplugin" );//ensure loaded
+  KOrganizerIface_stub iface( "korganizer", "KOrganizerIface" );
+  iface.deleteIncidence( uid, false );
+}
+
+void TodoSummaryWidget::completeTodo( const QString &uid )
+{
+  KCal::Todo *todo = mCalendar->todo( uid );
+  IncidenceChanger *changer = new IncidenceChanger( mCalendar, this );
+  if ( !todo->isReadOnly() && changer->beginChange( todo ) ) {
+    KCal::Todo *oldTodo = todo->clone();
+    todo->setCompleted( QDateTime::currentDateTime() );
+    changer->changeIncidence( oldTodo, todo, KOGlobals::COMPLETION_MODIFIED );
+    changer->endChange( todo );
+    delete oldTodo;
+    updateView();
+  }
+}
+
+void TodoSummaryWidget::popupMenu( const QString &uid )
+{
+  KPopupMenu popup( this );
+  popup.insertItem( i18n( "&Edit To-do..." ), 0 );
+  popup.insertItem( KGlobal::iconLoader()->loadIcon( "editdelete", KIcon::Small),
+                    i18n( "&Delete To-do" ), 1 );
+  KCal::Todo *todo = mCalendar->todo( uid );
+  if ( !todo->isCompleted() ) {
+    popup.insertItem( KGlobal::iconLoader()->loadIcon( "checkedbox", KIcon::Small),
+                      i18n( "&Mark To-do Completed" ), 2 );
+  }
+
+  switch ( popup.exec( QCursor::pos() ) ) {
+    case 0:
+      viewTodo( uid );
+      break;
+    case 1:
+      removeTodo( uid );
+      break;
+    case 2:
+      completeTodo( uid );
+      break;
+  }
+}
+
 bool TodoSummaryWidget::eventFilter( QObject *obj, QEvent* e )
 {
   if ( obj->inherits( "KURLLabel" ) ) {
Index: kontact/plugins/korganizer/Makefile.am
===================================================================
--- kontact/plugins/korganizer/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -2,6 +2,7 @@
 INCLUDES = -I$(top_srcdir)/kontact/interfaces \
   -I$(top_srcdir)/libkdepim \
   -I$(top_srcdir)/korganizer \
+  -I$(top_srcdir)/korganizer/interfaces \
   -I$(top_srcdir) $(all_includes)
 
 kde_module_LTLIBRARIES = libkontact_korganizerplugin.la \
@@ -27,7 +28,8 @@
 libkontact_todoplugin_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN)
 libkontact_todoplugin_la_LIBADD = libcommon.la \
     $(top_builddir)/kontact/interfaces/libkpinterfaces.la $(LIB_KPARTS) \
-    $(top_builddir)/korganizer/libkorganizer_calendar.la
+    $(top_builddir)/korganizer/libkorganizer_calendar.la \
+    $(top_builddir)/korganizer/libkorganizer.la
 libkontact_todoplugin_la_SOURCES = todoplugin.cpp \
                                    kcalendariface.stub \
                                    todosummarywidget.cpp \
Index: kontact/plugins/korganizer/todosummarywidget.h
===================================================================
--- kontact/plugins/korganizer/todosummarywidget.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/korganizer/todosummarywidget.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -56,7 +56,10 @@
 
   private slots:
     void updateView();
-    void selectEvent( const QString &uid );
+    void popupMenu( const QString &uid );
+    void viewTodo( const QString &uid );
+    void removeTodo( const QString &uid );
+    void completeTodo( const QString &uid );
 
   private:
     TodoPlugin *mPlugin;
Index: kontact/plugins/kaddressbook/kaddressbookplugin.desktop
===================================================================
--- kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/kaddressbook/kaddressbookplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -5,7 +5,7 @@
 ServiceTypes=Kontact/Plugin,KPluginInfo
 
 X-KDE-Library=libkontact_kaddressbookplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPartLibraryName=libkaddressbookpart
 X-KDE-KontactPartExecutableName=kaddressbook
 X-KDE-KontactPluginHasSummary=false
Index: kontact/plugins/newsticker/newstickerplugin.desktop
===================================================================
--- kontact/plugins/newsticker/newstickerplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/plugins/newsticker/newstickerplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -6,7 +6,7 @@
 TryExec=rssservice
 
 X-KDE-Library=libkontact_newstickerplugin
-X-KDE-KontactPluginVersion=4
+X-KDE-KontactPluginVersion=5
 X-KDE-KontactPluginHasSummary=true
 X-KDE-KontactPluginHasPart=false
 
Index: kontact/interfaces/plugin.h
===================================================================
--- kontact/interfaces/plugin.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/interfaces/plugin.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -34,6 +34,7 @@
 class DCOPObject;
 class KAboutData;
 class KAction;
+class KConfig;
 class QWidget;
 namespace KParts { class ReadOnlyPart; }
 
@@ -41,7 +42,7 @@
   Increase this version number whenever you make a change
   in the API.
  */
-#define KONTACT_PLUGIN_VERSION 4
+#define KONTACT_PLUGIN_VERSION 5
 
 namespace Kontact
 {
@@ -231,6 +232,16 @@
     */
     virtual void processDropEvent( QDropEvent * ) {}
 
+    /**
+     * Session management: read properties
+     */
+    virtual void readProperties( KConfig * ) {}
+
+    /**
+     * Session management: save properties
+     */
+    virtual void saveProperties( KConfig * ) {}
+
     Core *core() const;
 
   public slots:
Index: kontact/interfaces/kontactplugin.desktop
===================================================================
--- kontact/interfaces/kontactplugin.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/interfaces/kontactplugin.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -15,7 +15,7 @@
 Name[es]=Plugin Kontact
 Name[et]=Kontacti plugin
 Name[eu]=Kontact plugin-a
-Name[fa]=وصلۀ 
+Name[fa]=وصلۀ Kontact
 Name[fi]=Kontact-liitännäinen
 Name[fr]=Module Kontact
 Name[ga]=Breiseán Kontact
Index: kontact/src/kcmkontact.cpp
===================================================================
--- kontact/src/kcmkontact.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/src/kcmkontact.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -104,6 +104,7 @@
 {
   mItem = item;
   mPluginCombo = new QComboBox( parent );
+  connect( mPluginCombo, SIGNAL( activated( int ) ), SIGNAL( changed() ) );
 }
 
 PluginSelection::~PluginSelection()
@@ -140,12 +141,6 @@
   mItem->setValue( ptr->property("X-KDE-PluginInfo-Name").toString() );
 }
 
-void PluginSelection::itemClicked( QListViewItem *item )
-{
-  if ( item )
-    emit changed();
-}
-
 QValueList<QWidget *> PluginSelection::widgets() const
 {
   QValueList<QWidget *> widgets;
Index: kontact/src/kcmkontact.h
===================================================================
--- kontact/src/kcmkontact.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/src/kcmkontact.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -60,9 +60,6 @@
     QValueList<QWidget *> widgets() const;
     QComboBox *comboBox() const { return mPluginCombo; }
 
-  private slots:
-    void itemClicked( QListViewItem* );
-
   private:
     QComboBox *mPluginCombo;
     QValueList<KService::Ptr> mPluginList;
Index: kontact/src/mainwindow.cpp
===================================================================
--- kontact/src/mainwindow.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/src/mainwindow.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -805,6 +805,46 @@
     new KRun( url, this );
 }
 
+void MainWindow::readProperties( KConfig *config )
+{
+  Core::readProperties( config );
+
+  QStringList activePlugins = config->readListEntry( "ActivePlugins" );
+  QValueList<Plugin*>::ConstIterator it = mPlugins.begin();
+  QValueList<Plugin*>::ConstIterator end = mPlugins.end();
+  for ( ; it != end; ++it ) {
+    Plugin *plugin = *it;
+    if ( !plugin->isRunningStandalone() ) {
+      QStringList::ConstIterator activePlugin = activePlugins.find( plugin->identifier() );
+      if ( activePlugin != activePlugins.end() ) {
+        plugin->readProperties( config );
+      }
+    }
+  }
+}
+
+void MainWindow::saveProperties( KConfig *config )
+{
+  Core::saveProperties( config );
+
+  QStringList activePlugins;
+
+  KPluginInfo::List::Iterator it = mPluginInfos.begin();
+  KPluginInfo::List::Iterator end = mPluginInfos.end();
+  for ( ; it != end; ++it ) {
+    KPluginInfo *info = *it;
+    if ( info->isPluginEnabled() ) {
+      Plugin *plugin = pluginFromInfo( info );
+      if ( plugin ) {
+        activePlugins.append( plugin->identifier() );
+        plugin->saveProperties( config );
+      }
+    }
+  }
+
+  config->writeEntry( "ActivePlugins", activePlugins );
+}
+
 bool MainWindow::queryClose()
 {
   if ( kapp->sessionSaving() || mReallyClose )
Index: kontact/src/mainwindow.h
===================================================================
--- kontact/src/mainwindow.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/src/mainwindow.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -41,6 +41,7 @@
 class QFrame;
 
 class KAction;
+class KConfig;
 class KPluginInfo;
 class KRSqueezedTextLabel;
 class KHTMLPart;
@@ -116,6 +117,8 @@
     void setupActions();
     void showTip( bool );
     virtual bool queryClose();
+    virtual void readProperties( KConfig *config );
+    virtual void saveProperties( KConfig *config );
     void paintAboutScreen( const QString& msg );
     static QString introductionString();
 
Index: kontact/src/main.cpp
===================================================================
--- kontact/src/main.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ kontact/src/main.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -49,14 +49,22 @@
 
 class KontactApp : public KUniqueApplication {
   public:
-    KontactApp() : mMainWindow( 0 ) {}
+    KontactApp() : mMainWindow( 0 ), mSessionRestored( false ) {}
     ~KontactApp() {}
 
     int newInstance();
+    void setMainWindow( Kontact::MainWindow *window ) {
+        mMainWindow = window;
+        setMainWidget( window );
+    }
+    void setSessionRestored( bool restored ) {
+        mSessionRestored = restored;
+    }
 
   private:
     void startKOrgac();
     Kontact::MainWindow *mMainWindow;
+    bool mSessionRestored;
 };
 
 static void listPlugins()
@@ -94,15 +102,7 @@
     moduleName = QString::fromLocal8Bit( args->getOption( "module" ) );
   }
 
-  if ( isRestored() ) {
-    // There can only be one main window
-    if ( KMainWindow::canBeRestored( 1 ) ) {
-      mMainWindow = new Kontact::MainWindow();
-      setMainWidget( mMainWindow );
-      mMainWindow->show();
-      mMainWindow->restore( 1 );
-    }
-  } else {
+  if ( !mSessionRestored ) {
     if ( !mMainWindow ) {
       mMainWindow = new Kontact::MainWindow();
       if ( !moduleName.isEmpty() )
@@ -158,6 +158,17 @@
   }
 
   KontactApp app;
+  if ( app.restoringSession() ) {
+     // There can only be one main window
+    if ( KMainWindow::canBeRestored( 1 ) ) {
+      Kontact::MainWindow *mainWindow = new Kontact::MainWindow();
+      app.setMainWindow( mainWindow );
+      app.setSessionRestored( true );
+      mainWindow->show();
+      mainWindow->restore( 1 );
+    }
+  }
+
   bool ret = app.exec();
   while ( KMainWindow::memberList->first() )
     delete KMainWindow::memberList->first();
Index: ktnef/gui/ktnef.desktop
===================================================================
--- ktnef/gui/ktnef.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ ktnef/gui/ktnef.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -57,7 +57,7 @@
 Comment[es]=A visor/extractor para archivos TNEF
 Comment[et]=TNEF-failide näitaja/ekstraktija
 Comment[eu]=TNEF fitxategien ikustaile/erauzlea
-Comment[fa]=یک مشاهده‌گر/استخراجگر برای پرونده‌های TNEF
+Comment[fa]=یک مشاهده‌گر/استخراج‌گر برای پرونده‌های TNEF
 Comment[fi]=Näytin/purkaja TNEF-tiedostoille
 Comment[fr]=Pour afficher / extraire des fichiers TNEF
 Comment[hi]=टीएनईएफ फ़ाइलों के लिए एक प्रदर्शक/एक्सट्रेक्टर
Index: korganizer/korganizer_configplugins.desktop
===================================================================
--- korganizer/korganizer_configplugins.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configplugins.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -107,7 +107,7 @@
 Keywords[es]=korganizer,extensión,plugin,módulo
 Keywords[et]=korganizer,plugin,moodul
 Keywords[eu]=korganizer,plugin-a,modulua
-Keywords[fa]=korganizer،وصله،پیمانه
+Keywords[fa]=korganizer،وصله، پیمانه
 Keywords[fi]=korganizer,liitännäinen,moduuli
 Keywords[fr]=KOrganizer,module
 Keywords[ga]=korganizer,breiseán,modúl
Index: korganizer/kohelper.cpp
===================================================================
--- korganizer/kohelper.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/kohelper.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -44,18 +44,19 @@
   if ( calendarResource ) {
     KCal::ResourceCalendar *resourceCalendar = calendarResource->resource( incidence );
 
-    QString identifier = resourceCalendar->identifier();
-    resourceColor = *KOPrefs::instance()->resourceColor( identifier );
+    if( resourceCalendar ) {
+      QString identifier = resourceCalendar->identifier();
+      resourceColor = *KOPrefs::instance()->resourceColor( identifier );
 
-    if ( !resourceCalendar->subresources().isEmpty() ) {
-      identifier = resourceCalendar->subresourceIdentifier( incidence );
-      if ( identifier.isEmpty() )
-        identifier = resourceCalendar->identifier();
-      QColor subrescolor( *KOPrefs::instance()->resourceColor( identifier ) );
-      if ( subrescolor.isValid() )
-        resourceColor = subrescolor;
+      if ( !resourceCalendar->subresources().isEmpty() ) {
+        identifier = resourceCalendar->subresourceIdentifier( incidence );
+       if ( identifier.isEmpty() )
+         identifier = resourceCalendar->identifier();
+       QColor subrescolor( *KOPrefs::instance()->resourceColor( identifier ) );
+       if ( subrescolor.isValid() )
+         resourceColor = subrescolor;
+      }
     }
-
 //   } else {
 //     kdDebug(5850) << "resourceColor: Calendar is not a CalendarResources" <<endl;
   }
Index: korganizer/korganizer_configgroupscheduling.desktop
===================================================================
--- korganizer/korganizer_configgroupscheduling.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configgroupscheduling.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -115,7 +115,7 @@
 Keywords[es]=korganizer,grupo,planificación
 Keywords[et]=korganizer,grupid,grupitöö,ajakavad
 Keywords[eu]=korganizer,taldea,antolaketa
-Keywords[fa]=korganizer،گروه،زمان‌بندی
+Keywords[fa]=korganizer،گروه، زمان‌بندی
 Keywords[fi]=korganizer,ryhmä,ajastus
 Keywords[fr]=KOrganizer,groupes,planification
 Keywords[gl]=korganizer,grupo,programar
Index: korganizer/korgac/alarmdialog.cpp
===================================================================
--- korganizer/korgac/alarmdialog.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korgac/alarmdialog.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -73,9 +73,10 @@
   suspendBox->setSpacing( spacingHint() );
   topLayout->addWidget( suspendBox );
 
-  new QLabel( i18n("Suspend duration:"), suspendBox );
+  QLabel *l = new QLabel( i18n("Suspend &duration:"), suspendBox );
   mSuspendSpin = new QSpinBox( 1, 9999, 1, suspendBox );
   mSuspendSpin->setValue( 5 );  // default suspend duration
+  l->setBuddy( mSuspendSpin );
 
   mSuspendUnit = new KComboBox( suspendBox );
   mSuspendUnit->insertItem( i18n("minute(s)") );
@@ -83,10 +84,6 @@
   mSuspendUnit->insertItem( i18n("day(s)") );
   mSuspendUnit->insertItem( i18n("week(s)") );
 
-  connect( mSuspendSpin, SIGNAL( valueChanged(int) ), actionButton(User1), SLOT( setFocus() ) );
-  connect( mSuspendUnit, SIGNAL( activated(int) ), actionButton(User1), SLOT( setFocus() ) );
-  connect( mSuspendUnit, SIGNAL( activated(int) ), actionButton(User2), SLOT( setFocus() ) );
-
   // showButton( User2/*3*/, false );
 
   setMinimumSize( 300, 200 );
Index: korganizer/korgac/korgac.desktop
===================================================================
--- korganizer/korgac/korgac.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korgac/korgac.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -11,7 +11,7 @@
 Name[es]=Cliente de recordatorio para KOrganizer
 Name[et]=KOrganizeri meeldetuletuse klientprogramm
 Name[eu]=KOrganizer-en oroigarrien bezeroa
-Name[fa]=کارخواه یادآوری کنندۀ KOrganizer
+Name[fa]=کارخواه یادآوری‌کنندۀ KOrganizer
 Name[fi]=KOrganizer-hälytysasiakas
 Name[fr]=Client d'alarme de KOrganizer
 Name[hu]=KOrganizer-emlékeztető kliens
Index: korganizer/Makefile.am
===================================================================
--- korganizer/Makefile.am	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/Makefile.am	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -171,7 +171,7 @@
 	$(XGETTEXT) `find . -name "*.cpp" -o -name "*.h"` -o $(podir)/korganizer.pot
 	rm -f tips.cpp
 
-xdg_apps_DATA = korganizer.desktop
+xdg_apps_DATA = korganizer.desktop korganizer-import.desktop
 
 kde_kcfg_DATA = korganizer.kcfg
 
Index: korganizer/kotodoview.cpp
===================================================================
--- korganizer/kotodoview.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/kotodoview.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -925,15 +925,13 @@
 
 void KOTodoView::copyTodoToDate( QDate date )
 {
-  QDateTime dt;
-  dt.setDate( date );
+  QDateTime dt( date );
 
   if ( mActiveItem && mChanger ) {
     Todo *newTodo = mActiveItem->todo()->clone();
     newTodo->recreate();
 
-   if ( date.isNull() )
-     newTodo->setHasDueDate( false );
+   newTodo->setHasDueDate( !date.isNull() );
    newTodo->setDtDue( dt );
    newTodo->setPercentComplete( 0 );
 
Index: korganizer/plugins/exchange/exchange.desktop
===================================================================
--- korganizer/plugins/exchange/exchange.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/plugins/exchange/exchange.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -59,7 +59,7 @@
 Comment[fr]=Ce module permet à KOrganizer de fonctionner avec Microsoft Exchange 2000
 Comment[hu]=Ez a modul lehetővé teszi KOrganizer-felhasználóknak Microsoft Exchange 2000-kiszolgálón tárolt csoportmunka-adatok elérését.
 Comment[is]=Þetta íforrit gerir KOrganizer kleyft að vinna með Microsoft Exchange 2000 hópvinnuþjónum.
-Comment[it]=Questo plugin pemette agli utenti di korganizer di lavorare con i server groupware Microsoft Exchange 2000.
+Comment[it]=Questo plugin permette agli utenti di korganizer di lavorare con i server groupware Microsoft Exchange 2000.
 Comment[ja]=本プラグインにより、korganizer のユーザは Microsoft Exchange 2000 グループウェアサーバとの同期が可能となります。
 Comment[km]=កម្មវិធី​ជំនួយ​នេះ​អនុញ្ញាត​ឲ្យ​អ្នក​ប្រើ​របស់ korganizer ធ្វើការ​ជាមួយ​ម៉ាស៊ីន​បម្រើ​កម្មវិធី​ពហុ​អ្នកប្រើ​របស់​ម៉ៃក្រូសូហ្វ Exchange ២០០០ ។
 Comment[lt]=Šis priedas leidžia korganizer dirbti su Microsoft Exchange 2000 groupware serveriais.
Index: korganizer/plugins/printing/list/listprint.desktop
===================================================================
--- korganizer/plugins/printing/list/listprint.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/plugins/printing/list/listprint.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -48,7 +48,7 @@
 Comment[es]=Esta extensión le permite imprimir eventos y tareas pendientes en forma de lista.
 Comment[et]=See plugin võimaldab trükkida sündmusi ja ülesandeid nimekirjana.
 Comment[eu]=Plugin honek gertaerak eta egitekoak zerrenda moduan inprimatzeko aukera ematen dizu.
-Comment[fa]=این وصله به شما اجازه می‌دهد که رویدادها و کارهایی که باید انجام شوند را در برگۀ فهرست چاپ کنید.
+Comment[fa]=این وصله به شما اجازه می‌دهد که رویدادها و کارهای انجامی را در برگۀ فهرست چاپ کنید.
 Comment[fi]=Tämä liitännäinen mahdollistaa tapahtumien ja tehtävien tulostuksen listana.
 Comment[fr]=Ce module vous permet d'imprimer les évènements et les tâches sous forme de liste
 Comment[hu]=Ezzel a modullal listaként kinyomtathatók a feladatok és események.
Index: korganizer/korganizer.kcfg
===================================================================
--- korganizer/korganizer.kcfg	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer.kcfg	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -74,7 +74,7 @@
 
     <entry type="Bool" key="Html With Save">
       <label>Export to HTML with every save</label>
-      <whatsthis>Check this box to export the calendar to a HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
+      <whatsthis>Check this box to export the calendar to an HTML-file every time you save it. By default, this file will be called calendar.html and placed in the user home folder.</whatsthis>
       <default>false</default>
     </entry>
     <entry type="Enum" key="Destination" name="Destination">
@@ -158,7 +158,7 @@
   <group name="Views">
     <entry type="Int" key="Hour Size">
       <label>Hour size</label>
-      <whatsthis>Select on this spin box the the height of the hour rows in the schedule view.</whatsthis>
+      <whatsthis>Select on this spin box the height of the hour rows in the schedule view.</whatsthis>
       <default>10</default>
       <min>4</min>
       <max>30</max>
@@ -272,7 +272,7 @@
 
     <entry type="Int" key="Next X Days">
       <label>Next x days</label>
-      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
+      <whatsthis>Select on this spin box the number of &quot;x&quot; days to be displayed in the next days view. To access the  the next &quot;x&quot; days view, choose the &quot;Next X Days&quot; menu item from the &quot;View&quot; menu.</whatsthis>
       <default>3</default>
     </entry>
 
@@ -315,7 +315,7 @@
     </entry>
     <entry type="Bool" key="Use Groupware Communication">
       <label>Use Groupware communication</label>
-      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
+      <whatsthis>Check this box to enable automatic generation of mails when creating, updating or deleting events (or to-dos) involving other attendees. You should check this box if you want to use the groupware functionality (e.g. Configuring Kontact as a KDE Kolab client).</whatsthis>
       <default>true</default>
     </entry>
 
Index: korganizer/kotodoeditor.h
===================================================================
--- korganizer/kotodoeditor.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/kotodoeditor.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -95,7 +95,7 @@
   protected:
     void loadTemplate( /*const*/ CalendarLocal& );
     QStringList& templates() const;
-    QString type() { return "ToDo"; }
+    QString type() { return "Todo"; }
     void setupGeneral();
     void setupRecurrence();
     int msgItemDelete();
Index: korganizer/korganizer_configfreebusy.desktop
===================================================================
--- korganizer/korganizer_configfreebusy.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configfreebusy.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -111,7 +111,7 @@
 Keywords[es]=korganizer,libreocupado,planificación
 Keywords[et]=korganizer,vaba,hõivatud,ajakava
 Keywords[eu]=korganizer,libre, lanpetuta,antolaketa
-Keywords[fa]=korganizer،آزاد اشغال،زمان‌بندی
+Keywords[fa]=korganizer،آزاد اشغال، زمان‌بندی
 Keywords[fi]=korganizer,vapaa,varattu,ajastus
 Keywords[fr]=KOrganizer,disponibilité, planification
 Keywords[gl]=korganizer,dispoñibilidade,axenda

Property changes on: korganizer/pixmaps
___________________________________________________________________
Name: svn:ignore
   + Makefile
Makefile.in


Index: korganizer/korganizer.desktop
===================================================================
--- korganizer/korganizer.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -1,6 +1,5 @@
 [Desktop Entry]
 Encoding=UTF-8
-MimeType=text/calendar;text/x-vcalendar;
 Comment=Calendar and Scheduling Program
 Comment[af]=Kalender en Skedulering Program
 Comment[ar]=برنامج الجدولة والتقويم
@@ -61,7 +60,7 @@
 Comment[zh_CN]=日历和日程安排程序
 Comment[zh_TW]=行事曆與排程軟體
 Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
-Exec=korganizer --import %u
+Exec=korganizer
 Icon=korganizer
 Path=
 DocPath=korganizer/index.html
Index: korganizer/kdatenavigator.h
===================================================================
--- korganizer/kdatenavigator.h	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/kdatenavigator.h	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -99,16 +99,14 @@
   private:
     NavigatorBar *mNavigatorBar;
 
-    QLabel *headings[ 7 ];
-    QLabel *weeknos[ 7 ];
+    QLabel *mHeadings[ 7 ];
+    QLabel *mWeeknos[ 7 ];
 
     KODayMatrix *mDayMatrix;
 
     KCal::DateList mSelectedDates;
     QDate mBaseDate;
 
-    const QString *curHeaders;
-
     // Disabling copy constructor and assignment operator
     KDateNavigator( const KDateNavigator & );
     KDateNavigator &operator=( const KDateNavigator & );
Index: korganizer/kdatenavigator.cpp
===================================================================
--- korganizer/kdatenavigator.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/kdatenavigator.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -64,21 +64,21 @@
 
   // Set up the heading fields.
   for( i = 0; i < 7; i++ ) {
-    headings[i] = new QLabel( this );
-    headings[i]->setFont( QFont( generalFont, 10, QFont::Bold ) );
-    headings[i]->setAlignment( AlignCenter );
+    mHeadings[i] = new QLabel( this );
+    mHeadings[i]->setFont( QFont( generalFont, 10, QFont::Bold ) );
+    mHeadings[i]->setAlignment( AlignCenter );
 
-    topLayout->addWidget( headings[i], 1, i + 1 );
+    topLayout->addWidget( mHeadings[i], 1, i + 1 );
   }
 
   // Create the weeknumber labels
   for( i = 0; i < 6; i++ ) {
-    weeknos[i] = new QLabel( this );
-    weeknos[i]->setAlignment( AlignCenter );
-    weeknos[i]->setFont( QFont( generalFont, 10 ) );
-    weeknos[i]->installEventFilter( this );
+    mWeeknos[i] = new QLabel( this );
+    mWeeknos[i]->setAlignment( AlignCenter );
+    mWeeknos[i]->setFont( QFont( generalFont, 10 ) );
+    mWeeknos[i]->installEventFilter( this );
 
-    topLayout->addWidget( weeknos[i], i + 2, 0 );
+    topLayout->addWidget( mWeeknos[i], i + 2, 0 );
   }
 
   mDayMatrix = new KODayMatrix( this, "KDateNavigator::dayMatrix" );
@@ -147,15 +147,14 @@
 
   const KCalendarSystem *calsys = KOGlobals::self()->calendarSystem();
   int m_fstDayOfWkCalsys = calsys->dayOfWeek( dayone );
+  int weekstart = KGlobal::locale()->weekStartDay();
 
   // If month begins on Monday and Monday is first day of week,
   // month should begin on second line. Sunday doesn't have this problem.
-  int nextLine = ( ( m_fstDayOfWkCalsys == 1) &&
-                   ( KGlobal::locale()->weekStartDay() == 1 ) ) ? 7 : 0;
+  int nextLine = m_fstDayOfWkCalsys <= weekstart ? 7 : 0;
 
   // update the matrix dates
-  int index = ( KGlobal::locale()->weekStartDay() == 1 ? 1 : 0 ) -
-              m_fstDayOfWkCalsys - nextLine;
+  int index = weekstart - m_fstDayOfWkCalsys - nextLine;
 
   dayone = dayone.addDays( index );
 
@@ -190,7 +189,7 @@
     } else {
       weeknum.setNum( weeknumstart );
     }
-    weeknos[i]->setText( weeknum );
+    mWeeknos[i]->setText( weeknum );
   }
 
 // each updateDates is followed by an updateView -> repaint is issued there !
@@ -215,18 +214,13 @@
 void KDateNavigator::updateConfig()
 {
   int day;
+  int weekstart = KGlobal::locale()->weekStartDay();
   for( int i = 0; i < 7; i++ ) {
-    // take the first letter of the day name to be the abbreviation
-    if ( KGlobal::locale()->weekStartDay() == 1 ) {
-      day = i + 1;
-    } else {
-      if ( i == 0 ) day = 7;
-      else day = i;
-    }
+    day = weekstart + i <= 7 ? weekstart + i : ( weekstart + i ) % 7;
     QString dayName = KOGlobals::self()->calendarSystem()->weekDayName( day,
                                                                         true );
     if ( KOPrefs::instance()->mCompactDialogs ) dayName = dayName.left( 1 );
-    headings[i]->setText( dayName );
+    mHeadings[i]->setText( dayName );
   }
 
   // FIXME: Use actual config setting here
@@ -237,9 +231,9 @@
 {
   for( int i = 0; i < 6; i++ ) {
     if( enabled )
-      weeknos[i]->show();
+      mWeeknos[i]->show();
     else
-      weeknos[i]->hide();
+      mWeeknos[i]->hide();
   }
 }
 
@@ -270,7 +264,7 @@
   if ( e->type() == QEvent::MouseButtonPress ) {
     int i;
     for( i = 0; i < 6; ++i ) {
-      if ( o == weeknos[ i ] ) {
+      if ( o == mWeeknos[ i ] ) {
         QDate weekstart = mDayMatrix->getDate( i * 7 );
         emit weekClicked( weekstart );
         break;
Index: korganizer/korganizer_configgroupautomation.desktop
===================================================================
--- korganizer/korganizer_configgroupautomation.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configgroupautomation.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -25,7 +25,7 @@
 Name[es]=Automatización del grupo
 Name[et]=Grupitöö
 Name[eu]=Talde automatizazioa
-Name[fa]=خودکار سازی گروه
+Name[fa]=خودکارسازی گروه
 Name[fi]=Ryhmän automatisointi
 Name[fr]=Automatisation des groupes
 Name[gl]=Automatización de Grupo
@@ -113,14 +113,14 @@
 Keywords[es]=korganizer,grupo,automatización
 Keywords[et]=korganizer,grupid,grupitöö
 Keywords[eu]=korganizer,taldea,automatizazioa
-Keywords[fa]=korganizer،گروه،خودکارسازی
+Keywords[fa]=korganizer،گروه، خودکارسازی
 Keywords[fi]=korganizer,ryhmä,automaatio
 Keywords[fr]=KOrganizer,groupes,automatisation
 Keywords[gl]=korganizer,grupo,automatización
 Keywords[hi]=के-आर्गेनाइज़र,समूह,स्वचालन
 Keywords[hu]=korganizer,csoport,csoportmunka
 Keywords[is]=korganizer,hópar,sjálfvirkni
-Keywords[it]=korganizer,grouppi,automazione
+Keywords[it]=korganizer,gruppi,automazione
 Keywords[ja]=korganizer,グループ,自動化
 Keywords[km]=korganizer,ក្រុម,ស្វ័យប្រតិកម្ម
 Keywords[lt]=korganizer,group,automation, grupės,automatizavimas
Index: korganizer/korganizer_configviews.desktop
===================================================================
--- korganizer/korganizer_configviews.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configviews.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -49,7 +49,7 @@
 Name[pt]=Janelas
 Name[pt_BR]=Visões
 Name[ro]=Vizualizări
-Name[ru]=Виды
+Name[ru]=Вид
 Name[se]=Čájeheamit
 Name[sk]=Pohľady
 Name[sl]=Prikazi
Index: korganizer/korganizer-import.desktop
===================================================================
--- korganizer/korganizer-import.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 0)
+++ korganizer/korganizer-import.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -0,0 +1,138 @@
+[Desktop Entry]
+Encoding=UTF-8
+NoDisplay=true
+MimeType=text/calendar;text/x-vcalendar;
+Comment=Calendar and Scheduling Program
+Comment[af]=Kalender en Skedulering Program
+Comment[ar]=برنامج الجدولة والتقويم
+Comment[bg]=Програма за календар и разписание
+Comment[bs]=Kalendar i rokovnik
+Comment[ca]=Un programa de calendari i planificació
+Comment[cs]=Kalendářový a plánovací program
+Comment[cy]=Rhaglen Galendr a Drefnlennu
+Comment[da]=Kalender- og planlægningsprogram
+Comment[de]=Ein Kalender und Zeitplaner
+Comment[el]=Πρόγραμμα ημερολογίου και προγραμματισμού
+Comment[eo]=Kalendara kaj plana programo
+Comment[es]=Calendario y planificador
+Comment[et]=Kalendri ja ajakava haldamise rakendus
+Comment[eu]=Egutegi eta antolaketa progrmaa
+Comment[fa]=تقویم و برنامۀ زمان‌بندی
+Comment[fi]=Kalenteri ja ajanhallintaohjelma
+Comment[fr]=Calendrier et agenda personnel
+Comment[gl]=Programa de Calendario e Axenda
+Comment[he]=תוכניות לוח שנה ותזמון משימות
+Comment[hi]=कैलेन्डर तथा समय-सारणी प्रोग्राम
+Comment[hr]=Kalendar i rokovnik
+Comment[hu]=Határidőnapló és eseményszervező
+Comment[is]=Dagbók og skipulag
+Comment[it]=Programma di calendario e di agenda
+Comment[ja]=カレンダーとスケジュール管理プログラム
+Comment[km]=កម្មវិធី​ប្រតិទិន និង កាលវិភាគ
+Comment[lt]=Kalendoriaus ir planavimo programa
+Comment[lv]=Kalendāra un Plānošanas Programma
+Comment[mk]=Календар и роковник
+Comment[ms]=Kalendar dan Program Penjadualan 
+Comment[mt]=Programm b' kalendarju w skeda
+Comment[nb]=Et kalender- og tidsplanleggingsprogram
+Comment[nds]=Kalenner un Tietplaner
+Comment[nl]=Agenda- en afsprakenprogramma
+Comment[nn]=Kalender- og planleggingsprogram
+Comment[nso]=Lenaneo la Peakanyo ya Tshupamabaka
+Comment[pl]=Kalendarz i terminarz
+Comment[pt]=Calendário e Programa de Escalonamento
+Comment[pt_BR]=Programa de Calendário e Agenda
+Comment[ro]=Program de planificare şi calendar
+Comment[ru]=Календарь и личное расписание
+Comment[se]=Kaleandar- ja plánenprográmma
+Comment[sk]=Kalendár a plánovací program
+Comment[sl]=Program za koledar in razporejanje
+Comment[sr]=Календарски и планерски програм
+Comment[sr@Latn]=Kalendarski i planerski program
+Comment[sv]=Kalender- och schemaläggningsprogram
+Comment[ta]=நாள்காட்டி மற்றும் திட்ட நிரல்
+Comment[tg]=Тақвимот ва ҷадвали шахсӣ
+Comment[th]=โปรแกรมจัดการปฏิทินและตารางการนัดหมาย
+Comment[tr]=Takvim ve Zamanlama Programı
+Comment[uk]=Програма календаря та розкладу
+Comment[uz]=Календар ва режалаштириш дастури
+Comment[ven]=Khalenda na mbekanyamushumo ya u shedula
+Comment[vi]=Chương trình lịch và kế hoạch
+Comment[xh]=Ikhalenda no Dweliso lwenkqubo Yokucwangcisa
+Comment[zh_CN]=日历和日程安排程序
+Comment[zh_TW]=行事曆與排程軟體
+Comment[zu]=Ikhalenda kanye Neprogramu Yokugcina isikhathi
+Exec=korganizer --import %u
+Icon=korganizer
+Path=
+DocPath=korganizer/index.html
+Type=Application
+Terminal=false
+Name=KOrganizer
+Name[af]=Korganizer
+Name[ar]=منظم كيدي
+Name[be]=K Арганізатар
+Name[cy]=KTrefnydd
+Name[eo]=Organizilo
+Name[hi]=के-आर्गेनाइज़र
+Name[lv]=KOrganaizers
+Name[mk]=Организатор
+Name[nso]=KMokopanyi
+Name[pl]=Organizator
+Name[sv]=Korganizer
+Name[ta]=கேஅமைப்பாளர்
+Name[ven]=Mulugisi wa K
+Name[zh_TW]=KOrganizer 行事曆
+GenericName=Personal Organizer
+GenericName[be]=Пэрсанальны арганізатар
+GenericName[bg]=Организатор
+GenericName[bs]=Lični organizer
+GenericName[ca]=Organitzador personal
+GenericName[cs]=Osobní organizér
+GenericName[cy]=Trefnydd Personol
+GenericName[da]=Personlig organisering
+GenericName[de]=Persönliche Daten organisieren
+GenericName[el]=Προσωπικός οργανωτής
+GenericName[en_GB]=Personal Organiser
+GenericName[es]=Organizador personal
+GenericName[et]=Personaalne ajaarvestus
+GenericName[eu]=Antolatzaile pertsonala
+GenericName[fa]=سازمان‌دهندۀ شخصی‌
+GenericName[fi]=Henkilökohtainen ajanhallintaohjelma
+GenericName[fr]=Organiseur personnel
+GenericName[gl]=Organizador Persoal
+GenericName[he]=מנהל זמן אישי
+GenericName[hi]=निजी प्रबंधक
+GenericName[hu]=Határidőnapló
+GenericName[is]=Persónuleg skipulagsbók
+GenericName[it]=Organizzatore personale
+GenericName[ja]=個人向けスケジュール管理
+GenericName[km]=កម្មវិធី​រៀបចំ​ផ្ទាល់​ខ្លួន
+GenericName[lt]=Asmeninės informacijos tvarkyklė
+GenericName[ms]=Penyusun Peribadi
+GenericName[nb]=Personlig planlegger
+GenericName[nds]=Persöönlich Mötenkalenner
+GenericName[nl]=Persoonlijke organizer
+GenericName[nn]=Personleg organiserar
+GenericName[pl]=Osobisty organizator
+GenericName[pt]=Organizador Pessoal
+GenericName[pt_BR]=Organizador Pessoal
+GenericName[ro]=Organizator personal
+GenericName[ru]=Персональный органайзер
+GenericName[sk]=Osobný plánovač
+GenericName[sl]=Osebni organizator
+GenericName[sr]=Лични планер
+GenericName[sr@Latn]=Lični planer
+GenericName[sv]=Filofax
+GenericName[ta]=தனிப்பயன் அமைப்பாளர்
+GenericName[tg]=Органайзери инфиродӣ
+GenericName[tr]=Kişisel Bilgi Yöneticisi
+GenericName[uk]=Персональний тижневик
+GenericName[uz]=Шахсий органайзер
+GenericName[zh_CN]=个人日程安排
+GenericName[zh_TW]=個人行程組織軟體
+ServiceTypes=Browser/View,DCOP/Organizer
+X-KDE-Library=libkorganizerpart
+X-KDE-StartupNotify=true
+X-DCOP-ServiceType=Unique
+X-DCOP-ServiceName=korganizer
Index: korganizer/korganizer_configmain.desktop
===================================================================
--- korganizer/korganizer_configmain.desktop	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ korganizer/korganizer_configmain.desktop	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -119,7 +119,7 @@
 Keywords[es]=korganizer,principal,personal
 Keywords[et]=korganizer,peamine,isiklik
 Keywords[eu]=korganizer,nagusia,pertsonala
-Keywords[fa]=korganizer،اصلی،شخصی
+Keywords[fa]=korganizer،اصلی، شخصی
 Keywords[fi]=korganizer,pää,henkilökohtainen
 Keywords[fr]=KOrganizer,principal,personnel
 Keywords[gl]=korganizer,principal,persoal
Index: mimelib/entity.cpp
===================================================================
--- mimelib/entity.cpp	(.../tags/KDE/3.5.5/kdepim)	(revision 608741)
+++ mimelib/entity.cpp	(.../branches/KDE/3.5/kdepim)	(revision 608741)
@@ -224,7 +224,8 @@
     // DwEntityParser skips the line separating the headers from the
     // body. So it's neither part of DwHeaders, nor of DwBody
     // -> we need to readd it here:
-    mString += DW_EOL;
+    if ( mString != "" )
+      mString += DW_EOL;
 
     mString += aBody.AsString();
     mIsModified = 0;

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


